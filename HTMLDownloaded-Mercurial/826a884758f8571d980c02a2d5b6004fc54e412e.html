<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 28794:826a884758f8571d980c02a2d5b6004fc54e412e</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 826a884758f8571d980c02a2d5b6004fc54e412e" />
<meta property="og:url" content="/comm-central/rev/826a884758f8571d980c02a2d5b6004fc54e412e" />
<meta property="og:description" content="Bug 1603813, pgp changes for composer. r=PatrickBrunschwig" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 826a884758f8571d980c02a2d5b6004fc54e412e 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/826a884758f8571d980c02a2d5b6004fc54e412e">shortlog</a> |
<a href="/comm-central/log/826a884758f8571d980c02a2d5b6004fc54e412e">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/826a884758f8571d980c02a2d5b6004fc54e412e">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/826a884758f8571d980c02a2d5b6004fc54e412e">files</a> |
changeset |
<a href="/comm-central/raw-rev/826a884758f8571d980c02a2d5b6004fc54e412e">raw</a>  | <a href="/comm-central/archive/826a884758f8571d980c02a2d5b6004fc54e412e.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1603813">Bug 1603813</a>, pgp changes for composer. r=PatrickBrunschwig
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#75;&#97;&#105;&#32;&#69;&#110;&#103;&#101;&#114;&#116;&#32;&#60;&#107;&#97;&#105;&#101;&#64;&#107;&#117;&#105;&#120;&#46;&#100;&#101;&#62;</td></tr>
<tr><td></td><td class="date age">Sun, 16 Feb 2020 13:25:57 +0100</td></tr>

<tr>
 <td>changeset 28794</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/826a884758f8571d980c02a2d5b6004fc54e412e">826a884758f8571d980c02a2d5b6004fc54e412e</a></td>
</tr>



<tr>
<td>parent 28793</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/7937d619f3d85df384e55fcea67c8c52750413b2">7937d619f3d85df384e55fcea67c8c52750413b2</a>
</td>
</tr>

<tr>
<td>child 28795</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/e80f11af397574ab1816d0f6982530164d855ce6">e80f11af397574ab1816d0f6982530164d855ce6</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=826a884758f8571d980c02a2d5b6004fc54e412e">17042</a></td></tr>
<tr><td>push user</td><td>kaie@kuix.de</td></tr>
<tr><td>push date</td><td class="date age">Wed, 19 Feb 2020 10:07:42 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@e80f11af3975 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=e80f11af397574ab1816d0f6982530164d855ce6">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=e80f11af397574ab1816d0f6982530164d855ce6&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=e80f11af397574ab1816d0f6982530164d855ce6&newProject=comm-central&newRevision=c14efa91e66c10f64d0c5a4de8231ced0eaa2669&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=e80f11af397574ab1816d0f6982530164d855ce6&newProject=comm-central&newRevision=c14efa91e66c10f64d0c5a4de8231ced0eaa2669&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=e80f11af397574ab1816d0f6982530164d855ce6&newProject=comm-central&newRevision=c14efa91e66c10f64d0c5a4de8231ced0eaa2669&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28PatrickBrunschwig%29&revcount=50">PatrickBrunschwig</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1603813">1603813</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1603813">Bug 1603813</a>, pgp changes for composer. r=PatrickBrunschwig
Additional changes as requested by mkmelin

Differential Revision: <a href="https://phabricator.services.mozilla.com/D63022">https://phabricator.services.mozilla.com/D63022</a></div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/BondOpenPGP.jsm">mail/extensions/openpgp/content/BondOpenPGP.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/BondOpenPGP.jsm">file</a> |
<a href="/comm-central/annotate/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/BondOpenPGP.jsm">annotate</a> |
<a href="/comm-central/diff/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/BondOpenPGP.jsm">diff</a> |
<a href="/comm-central/comparison/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/BondOpenPGP.jsm">comparison</a> |
<a href="/comm-central/log/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/BondOpenPGP.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/compat.jsm">mail/extensions/openpgp/content/modules/compat.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/compat.jsm">file</a> |
<a href="/comm-central/annotate/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/compat.jsm">annotate</a> |
<a href="/comm-central/diff/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/compat.jsm">diff</a> |
<a href="/comm-central/comparison/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/compat.jsm">comparison</a> |
<a href="/comm-central/log/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/compat.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/core.jsm">mail/extensions/openpgp/content/modules/core.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/core.jsm">file</a> |
<a href="/comm-central/annotate/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/core.jsm">annotate</a> |
<a href="/comm-central/diff/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/core.jsm">diff</a> |
<a href="/comm-central/comparison/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/core.jsm">comparison</a> |
<a href="/comm-central/log/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/core.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/cryptoAPI/RNPCryptoAPI.jsm">mail/extensions/openpgp/content/modules/cryptoAPI/RNPCryptoAPI.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/cryptoAPI/RNPCryptoAPI.jsm">file</a> |
<a href="/comm-central/annotate/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/cryptoAPI/RNPCryptoAPI.jsm">annotate</a> |
<a href="/comm-central/diff/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/cryptoAPI/RNPCryptoAPI.jsm">diff</a> |
<a href="/comm-central/comparison/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/cryptoAPI/RNPCryptoAPI.jsm">comparison</a> |
<a href="/comm-central/log/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/cryptoAPI/RNPCryptoAPI.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/encryption.jsm">mail/extensions/openpgp/content/modules/encryption.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/encryption.jsm">file</a> |
<a href="/comm-central/annotate/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/encryption.jsm">annotate</a> |
<a href="/comm-central/diff/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/encryption.jsm">diff</a> |
<a href="/comm-central/comparison/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/encryption.jsm">comparison</a> |
<a href="/comm-central/log/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/encryption.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/gpgAgent.jsm">mail/extensions/openpgp/content/modules/gpgAgent.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/gpgAgent.jsm">file</a> |
<a href="/comm-central/annotate/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/gpgAgent.jsm">annotate</a> |
<a href="/comm-central/diff/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/gpgAgent.jsm">diff</a> |
<a href="/comm-central/comparison/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/gpgAgent.jsm">comparison</a> |
<a href="/comm-central/log/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/gpgAgent.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/keyObj.jsm">mail/extensions/openpgp/content/modules/keyObj.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/keyObj.jsm">file</a> |
<a href="/comm-central/annotate/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/keyObj.jsm">annotate</a> |
<a href="/comm-central/diff/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/keyObj.jsm">diff</a> |
<a href="/comm-central/comparison/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/keyObj.jsm">comparison</a> |
<a href="/comm-central/log/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/keyObj.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/keyRing.jsm">mail/extensions/openpgp/content/modules/keyRing.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/keyRing.jsm">file</a> |
<a href="/comm-central/annotate/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/keyRing.jsm">annotate</a> |
<a href="/comm-central/diff/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/keyRing.jsm">diff</a> |
<a href="/comm-central/comparison/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/keyRing.jsm">comparison</a> |
<a href="/comm-central/log/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/keyRing.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/mimeDecrypt.jsm">mail/extensions/openpgp/content/modules/mimeDecrypt.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/mimeDecrypt.jsm">file</a> |
<a href="/comm-central/annotate/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/mimeDecrypt.jsm">annotate</a> |
<a href="/comm-central/diff/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/mimeDecrypt.jsm">diff</a> |
<a href="/comm-central/comparison/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/mimeDecrypt.jsm">comparison</a> |
<a href="/comm-central/log/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/mimeDecrypt.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/mimeEncrypt.jsm">mail/extensions/openpgp/content/modules/mimeEncrypt.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/mimeEncrypt.jsm">file</a> |
<a href="/comm-central/annotate/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/mimeEncrypt.jsm">annotate</a> |
<a href="/comm-central/diff/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/mimeEncrypt.jsm">diff</a> |
<a href="/comm-central/comparison/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/mimeEncrypt.jsm">comparison</a> |
<a href="/comm-central/log/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/mimeEncrypt.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/mimeVerify.jsm">mail/extensions/openpgp/content/modules/mimeVerify.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/mimeVerify.jsm">file</a> |
<a href="/comm-central/annotate/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/mimeVerify.jsm">annotate</a> |
<a href="/comm-central/diff/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/mimeVerify.jsm">diff</a> |
<a href="/comm-central/comparison/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/mimeVerify.jsm">comparison</a> |
<a href="/comm-central/log/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/mimeVerify.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/pgpmimeHandler.jsm">mail/extensions/openpgp/content/modules/pgpmimeHandler.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/pgpmimeHandler.jsm">file</a> |
<a href="/comm-central/annotate/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/pgpmimeHandler.jsm">annotate</a> |
<a href="/comm-central/diff/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/pgpmimeHandler.jsm">diff</a> |
<a href="/comm-central/comparison/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/pgpmimeHandler.jsm">comparison</a> |
<a href="/comm-central/log/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/pgpmimeHandler.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/rnp.jsm">mail/extensions/openpgp/content/modules/rnp.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/rnp.jsm">file</a> |
<a href="/comm-central/annotate/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/rnp.jsm">annotate</a> |
<a href="/comm-central/diff/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/rnp.jsm">diff</a> |
<a href="/comm-central/comparison/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/rnp.jsm">comparison</a> |
<a href="/comm-central/log/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/rnp.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/rnpLib.jsm">mail/extensions/openpgp/content/modules/rnpLib.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/rnpLib.jsm">file</a> |
<a href="/comm-central/annotate/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/rnpLib.jsm">annotate</a> |
<a href="/comm-central/diff/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/rnpLib.jsm">diff</a> |
<a href="/comm-central/comparison/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/rnpLib.jsm">comparison</a> |
<a href="/comm-central/log/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/rnpLib.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/socks5Proxy.jsm">mail/extensions/openpgp/content/modules/socks5Proxy.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/socks5Proxy.jsm">file</a> |
<a href="/comm-central/annotate/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/socks5Proxy.jsm">annotate</a> |
<a href="/comm-central/diff/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/socks5Proxy.jsm">diff</a> |
<a href="/comm-central/comparison/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/socks5Proxy.jsm">comparison</a> |
<a href="/comm-central/log/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/socks5Proxy.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/stdlib/msgHdrUtils.jsm">mail/extensions/openpgp/content/modules/stdlib/msgHdrUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/stdlib/msgHdrUtils.jsm">file</a> |
<a href="/comm-central/annotate/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/stdlib/msgHdrUtils.jsm">annotate</a> |
<a href="/comm-central/diff/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/stdlib/msgHdrUtils.jsm">diff</a> |
<a href="/comm-central/comparison/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/stdlib/msgHdrUtils.jsm">comparison</a> |
<a href="/comm-central/log/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/stdlib/msgHdrUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/streams.jsm">mail/extensions/openpgp/content/modules/streams.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/streams.jsm">file</a> |
<a href="/comm-central/annotate/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/streams.jsm">annotate</a> |
<a href="/comm-central/diff/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/streams.jsm">diff</a> |
<a href="/comm-central/comparison/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/streams.jsm">comparison</a> |
<a href="/comm-central/log/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/streams.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/subprocess.jsm">mail/extensions/openpgp/content/modules/subprocess.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/subprocess.jsm">file</a> |
<a href="/comm-central/annotate/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/subprocess.jsm">annotate</a> |
<a href="/comm-central/diff/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/subprocess.jsm">diff</a> |
<a href="/comm-central/comparison/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/subprocess.jsm">comparison</a> |
<a href="/comm-central/log/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/subprocess.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/windows.jsm">mail/extensions/openpgp/content/modules/windows.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/windows.jsm">file</a> |
<a href="/comm-central/annotate/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/windows.jsm">annotate</a> |
<a href="/comm-central/diff/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/windows.jsm">diff</a> |
<a href="/comm-central/comparison/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/windows.jsm">comparison</a> |
<a href="/comm-central/log/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/modules/windows.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/strings/enigmail.dtd">mail/extensions/openpgp/content/strings/enigmail.dtd</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/strings/enigmail.dtd">file</a> |
<a href="/comm-central/annotate/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/strings/enigmail.dtd">annotate</a> |
<a href="/comm-central/diff/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/strings/enigmail.dtd">diff</a> |
<a href="/comm-central/comparison/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/strings/enigmail.dtd">comparison</a> |
<a href="/comm-central/log/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/strings/enigmail.dtd">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/ui/enigmailKeyManager.js">mail/extensions/openpgp/content/ui/enigmailKeyManager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/ui/enigmailKeyManager.js">file</a> |
<a href="/comm-central/annotate/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/ui/enigmailKeyManager.js">annotate</a> |
<a href="/comm-central/diff/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/ui/enigmailKeyManager.js">diff</a> |
<a href="/comm-central/comparison/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/ui/enigmailKeyManager.js">comparison</a> |
<a href="/comm-central/log/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/ui/enigmailKeyManager.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/ui/enigmailKeygen.js">mail/extensions/openpgp/content/ui/enigmailKeygen.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/ui/enigmailKeygen.js">file</a> |
<a href="/comm-central/annotate/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/ui/enigmailKeygen.js">annotate</a> |
<a href="/comm-central/diff/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/ui/enigmailKeygen.js">diff</a> |
<a href="/comm-central/comparison/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/ui/enigmailKeygen.js">comparison</a> |
<a href="/comm-central/log/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/ui/enigmailKeygen.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/ui/enigmailKeygen.xhtml">mail/extensions/openpgp/content/ui/enigmailKeygen.xhtml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/ui/enigmailKeygen.xhtml">file</a> |
<a href="/comm-central/annotate/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/ui/enigmailKeygen.xhtml">annotate</a> |
<a href="/comm-central/diff/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/ui/enigmailKeygen.xhtml">diff</a> |
<a href="/comm-central/comparison/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/ui/enigmailKeygen.xhtml">comparison</a> |
<a href="/comm-central/log/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/ui/enigmailKeygen.xhtml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/ui/enigmailMessengerOverlay.js">mail/extensions/openpgp/content/ui/enigmailMessengerOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/ui/enigmailMessengerOverlay.js">file</a> |
<a href="/comm-central/annotate/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/ui/enigmailMessengerOverlay.js">annotate</a> |
<a href="/comm-central/diff/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/ui/enigmailMessengerOverlay.js">diff</a> |
<a href="/comm-central/comparison/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/ui/enigmailMessengerOverlay.js">comparison</a> |
<a href="/comm-central/log/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/ui/enigmailMessengerOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/ui/enigmailMsgBox.xhtml">mail/extensions/openpgp/content/ui/enigmailMsgBox.xhtml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/ui/enigmailMsgBox.xhtml">file</a> |
<a href="/comm-central/annotate/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/ui/enigmailMsgBox.xhtml">annotate</a> |
<a href="/comm-central/diff/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/ui/enigmailMsgBox.xhtml">diff</a> |
<a href="/comm-central/comparison/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/ui/enigmailMsgBox.xhtml">comparison</a> |
<a href="/comm-central/log/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/ui/enigmailMsgBox.xhtml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/ui/enigmailMsgComposeOverlay.js">mail/extensions/openpgp/content/ui/enigmailMsgComposeOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/ui/enigmailMsgComposeOverlay.js">file</a> |
<a href="/comm-central/annotate/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/ui/enigmailMsgComposeOverlay.js">annotate</a> |
<a href="/comm-central/diff/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/ui/enigmailMsgComposeOverlay.js">diff</a> |
<a href="/comm-central/comparison/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/ui/enigmailMsgComposeOverlay.js">comparison</a> |
<a href="/comm-central/log/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/content/ui/enigmailMsgComposeOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/prefs/openpgp-prefs.js">mail/extensions/openpgp/prefs/openpgp-prefs.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/prefs/openpgp-prefs.js">file</a> |
<a href="/comm-central/annotate/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/prefs/openpgp-prefs.js">annotate</a> |
<a href="/comm-central/diff/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/prefs/openpgp-prefs.js">diff</a> |
<a href="/comm-central/comparison/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/prefs/openpgp-prefs.js">comparison</a> |
<a href="/comm-central/log/826a884758f8571d980c02a2d5b6004fc54e412e/mail/extensions/openpgp/prefs/openpgp-prefs.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/extensions/openpgp/content/BondOpenPGP.jsm</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/BondOpenPGP.jsm</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -6,16 +6,19 @@</span>
<a href="#l1.4"></a><span id="l1.4">  * integration ot minimize the amount of code that must be</span>
<a href="#l1.5"></a><span id="l1.5">  * included in files outside the extensions/openpgp directory. */</span>
<a href="#l1.6"></a><span id="l1.6"> </span>
<a href="#l1.7"></a><span id="l1.7"> &quot;use strict&quot;;</span>
<a href="#l1.8"></a><span id="l1.8"> </span>
<a href="#l1.9"></a><span id="l1.9"> const EXPORTED_SYMBOLS = [&quot;BondOpenPGP&quot;];</span>
<a href="#l1.10"></a><span id="l1.10"> </span>
<a href="#l1.11"></a><span id="l1.11"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+var { MailConstants } = ChromeUtils.import(</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+  &quot;resource:///modules/MailConstants.jsm&quot;</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+);</span>
<a href="#l1.15"></a><span id="l1.15"> </span>
<a href="#l1.16"></a><span id="l1.16"> const EnigmailLazy = ChromeUtils.import(</span>
<a href="#l1.17"></a><span id="l1.17">   &quot;chrome://openpgp/content/modules/lazy.jsm&quot;</span>
<a href="#l1.18"></a><span id="l1.18"> ).EnigmailLazy;</span>
<a href="#l1.19"></a><span id="l1.19"> </span>
<a href="#l1.20"></a><span id="l1.20"> const getEnigmailApp = EnigmailLazy.loader(&quot;enigmail/app.jsm&quot;, &quot;EnigmailApp&quot;);</span>
<a href="#l1.21"></a><span id="l1.21"> const getEnigmailCore = EnigmailLazy.loader(</span>
<a href="#l1.22"></a><span id="l1.22">   &quot;enigmail/core.jsm&quot;,</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineat">@@ -42,16 +45,24 @@ var BondOpenPGP = {</span>
<a href="#l1.24"></a><span id="l1.24">     try {</span>
<a href="#l1.25"></a><span id="l1.25">       Services.console.logStringMessage(exc.toString() + &quot;\n&quot; + exc.stack);</span>
<a href="#l1.26"></a><span id="l1.26">     } catch (x) {}</span>
<a href="#l1.27"></a><span id="l1.27">   },</span>
<a href="#l1.28"></a><span id="l1.28"> </span>
<a href="#l1.29"></a><span id="l1.29">   initDone: false,</span>
<a href="#l1.30"></a><span id="l1.30"> </span>
<a href="#l1.31"></a><span id="l1.31">   init() {</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+    if (!MailConstants.MOZ_OPENPGP) {</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+      return;</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+    }</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineplus">+    const engine = Services.prefs.getIntPref(&quot;temp.openpgp.engine&quot;);</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineplus">+    if (!engine) {</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineplus">+      return;</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineplus">+    }</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineplus">+</span>
<a href="#l1.40"></a><span id="l1.40">     if (this.initDone) {</span>
<a href="#l1.41"></a><span id="l1.41">       return;</span>
<a href="#l1.42"></a><span id="l1.42">     }</span>
<a href="#l1.43"></a><span id="l1.43"> </span>
<a href="#l1.44"></a><span id="l1.44">     this.initDone = true;</span>
<a href="#l1.45"></a><span id="l1.45">     console.log(&quot;loading OpenPGP&quot;);</span>
<a href="#l1.46"></a><span id="l1.46">     try {</span>
<a href="#l1.47"></a><span id="l1.47">       getRNP().init({});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/compat.jsm</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/compat.jsm</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -7,68 +7,29 @@</span>
<a href="#l2.4"></a><span id="l2.4"> /**</span>
<a href="#l2.5"></a><span id="l2.5">  *  compatibility Module</span>
<a href="#l2.6"></a><span id="l2.6">  */</span>
<a href="#l2.7"></a><span id="l2.7"> </span>
<a href="#l2.8"></a><span id="l2.8"> var EXPORTED_SYMBOLS = [&quot;EnigmailCompat&quot;];</span>
<a href="#l2.9"></a><span id="l2.9"> </span>
<a href="#l2.10"></a><span id="l2.10"> const XPCOM_APPINFO = &quot;@mozilla.org/xre/app-info;1&quot;;</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-var gTb68OrNewer = null;</span>
<a href="#l2.13"></a><span id="l2.13"> var MailUtils;</span>
<a href="#l2.14"></a><span id="l2.14"> </span>
<a href="#l2.15"></a><span id="l2.15"> MailUtils = ChromeUtils.import(&quot;resource:///modules/MailUtils.jsm&quot;).MailUtils;</span>
<a href="#l2.16"></a><span id="l2.16"> </span>
<a href="#l2.17"></a><span id="l2.17"> var gCompFields, gPgpMimeObj;</span>
<a href="#l2.18"></a><span id="l2.18"> </span>
<a href="#l2.19"></a><span id="l2.19"> var EnigmailCompat = {</span>
<a href="#l2.20"></a><span id="l2.20">   generateQI: function(aCid) {</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineminus">-    if (this.isAtLeastTb68()) {</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineminus">-      // TB &gt; 60</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineminus">-      return ChromeUtils.generateQI(aCid);</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineminus">-    }</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineminus">-    else {</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineminus">-      let XPCOMUtils = ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;).XPCOMUtils;</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineminus">-      return XPCOMUtils.generateQI(aCid);</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineminus">-    }</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineminus">-  },</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineminus">-</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-  getSecurityField: function() {</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineminus">-    if (!gCompFields) {</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineminus">-      gCompFields = Cc[&quot;@mozilla.org/messengercompose/composefields;1&quot;].createInstance(Ci.nsIMsgCompFields);</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineminus">-    }</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineminus">-    return (&quot;securityInfo&quot; in gCompFields ? /* TB &lt; 64 */ &quot;securityInfo&quot; : &quot;composeSecure&quot;);</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+    return ChromeUtils.generateQI(aCid);</span>
<a href="#l2.37"></a><span id="l2.37">   },</span>
<a href="#l2.38"></a><span id="l2.38"> </span>
<a href="#l2.39"></a><span id="l2.39">   getExistingFolder: function(folderUri) {</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineminus">-    if (&quot;getExistingFolder&quot; in MailUtils) {</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineminus">-      // TB &gt;= 65</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineminus">-      return MailUtils.getExistingFolder(folderUri);</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineminus">-    }</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineminus">-    else {</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineminus">-      return MailUtils.getFolderForURI(folderUri, false);</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineminus">-    }</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineminus">-  },</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineminus">-</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineminus">-  isMessageUriInPgpMime: function() {</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineminus">-    if (!gPgpMimeObj) {</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineminus">-      gPgpMimeObj = Cc[&quot;@mozilla.org/mime/pgp-mime-js-decrypt;1&quot;].createInstance(Ci.nsIPgpMimeProxy);</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineminus">-    }</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineminus">-</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineminus">-    return (&quot;messageURI&quot; in gPgpMimeObj);</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineminus">-  },</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineminus">-</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineminus">-  /**</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineminus">-   * return true, if platform is newer than or equal a given version</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineminus">-   */</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineminus">-  isPlatformNewerThan: function(requestedVersion) {</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineminus">-    let vc = Cc[&quot;@mozilla.org/xpcom/version-comparator;1&quot;].getService(Ci.nsIVersionComparator);</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineminus">-    let appVer = Cc[&quot;@mozilla.org/xre/app-info;1&quot;].getService(Ci.nsIXULAppInfo).platformVersion;</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineminus">-</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineminus">-    return vc.compare(appVer, requestedVersion) &gt;= 0;</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineplus">+    return MailUtils.getExistingFolder(folderUri);</span>
<a href="#l2.66"></a><span id="l2.66">   },</span>
<a href="#l2.67"></a><span id="l2.67"> </span>
<a href="#l2.68"></a><span id="l2.68">   /**</span>
<a href="#l2.69"></a><span id="l2.69">    * Get a mail URL from a uriSpec</span>
<a href="#l2.70"></a><span id="l2.70">    *</span>
<a href="#l2.71"></a><span id="l2.71">    * @param uriSpec: String - URI of the desired message</span>
<a href="#l2.72"></a><span id="l2.72">    *</span>
<a href="#l2.73"></a><span id="l2.73">    * @return Object: nsIURL or nsIMsgMailNewsUrl object</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineat">@@ -111,72 +72,32 @@ var EnigmailCompat = {</span>
<a href="#l2.75"></a><span id="l2.75">    */</span>
<a href="#l2.76"></a><span id="l2.76">   copyFileToMailFolder: function(file, destFolder, msgFlags, msgKeywords, listener, msgWindow) {</span>
<a href="#l2.77"></a><span id="l2.77">     let copySvc = Cc[&quot;@mozilla.org/messenger/messagecopyservice;1&quot;].getService(Ci.nsIMsgCopyService);</span>
<a href="#l2.78"></a><span id="l2.78"> </span>
<a href="#l2.79"></a><span id="l2.79">     return copySvc.CopyFileMessage(file, destFolder, null, false, msgFlags, msgKeywords, listener, msgWindow);</span>
<a href="#l2.80"></a><span id="l2.80">   },</span>
<a href="#l2.81"></a><span id="l2.81"> </span>
<a href="#l2.82"></a><span id="l2.82">   /**</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineminus">-   * Determine if Platform is at version 68 or newer</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineminus">-   *</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineminus">-   * @return {Boolean}: true if at TB 68.0a1 or newer found</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineminus">-   */</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineminus">-  isAtLeastTb68: function() {</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineminus">-    if (gTb68OrNewer === null) {</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineminus">-      gTb68OrNewer = this.isPlatformNewerThan(&quot;68.0a1&quot;);</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineminus">-    }</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineminus">-</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineminus">-    return gTb68OrNewer;</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineminus">-  },</span>
<a href="#l2.94"></a><span id="l2.94" class="difflineminus">-</span>
<a href="#l2.95"></a><span id="l2.95" class="difflineminus">-  /**</span>
<a href="#l2.96"></a><span id="l2.96">    * Get functions that wrap the changes on nsITreeView between TB 60 and TB 68</span>
<a href="#l2.97"></a><span id="l2.97">    *</span>
<a href="#l2.98"></a><span id="l2.98">    * @param treeObj</span>
<a href="#l2.99"></a><span id="l2.99">    * @param listViewHolder</span>
<a href="#l2.100"></a><span id="l2.100">    *</span>
<a href="#l2.101"></a><span id="l2.101">    * @return {Object}</span>
<a href="#l2.102"></a><span id="l2.102">    */</span>
<a href="#l2.103"></a><span id="l2.103">   getTreeCompatibleFuncs: function(treeObj, listViewHolder) {</span>
<a href="#l2.104"></a><span id="l2.104" class="difflineminus">-</span>
<a href="#l2.105"></a><span id="l2.105" class="difflineminus">-    if (this.isAtLeastTb68()) {</span>
<a href="#l2.106"></a><span id="l2.106" class="difflineminus">-      return {</span>
<a href="#l2.107"></a><span id="l2.107" class="difflineminus">-        getCellAt: function(x,y) {</span>
<a href="#l2.108"></a><span id="l2.108" class="difflineminus">-          return treeObj.getCellAt(x, y);</span>
<a href="#l2.109"></a><span id="l2.109" class="difflineminus">-        },</span>
<a href="#l2.110"></a><span id="l2.110" class="difflineminus">-        rowCountChanged: function(a, b) {</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineminus">-          return treeObj.rowCountChanged(a, b);</span>
<a href="#l2.112"></a><span id="l2.112" class="difflineminus">-        },</span>
<a href="#l2.113"></a><span id="l2.113" class="difflineminus">-        invalidate: function() {</span>
<a href="#l2.114"></a><span id="l2.114" class="difflineminus">-          return treeObj.invalidate();</span>
<a href="#l2.115"></a><span id="l2.115" class="difflineminus">-        },</span>
<a href="#l2.116"></a><span id="l2.116" class="difflineminus">-        invalidateRow: function(r) {</span>
<a href="#l2.117"></a><span id="l2.117" class="difflineminus">-          return treeObj.invalidateRow(r);</span>
<a href="#l2.118"></a><span id="l2.118" class="difflineminus">-        }</span>
<a href="#l2.119"></a><span id="l2.119" class="difflineminus">-      };</span>
<a href="#l2.120"></a><span id="l2.120" class="difflineminus">-    }</span>
<a href="#l2.121"></a><span id="l2.121" class="difflineminus">-    else {</span>
<a href="#l2.122"></a><span id="l2.122" class="difflineminus">-      return {</span>
<a href="#l2.123"></a><span id="l2.123" class="difflineminus">-        getCellAt: function(x, y) {</span>
<a href="#l2.124"></a><span id="l2.124" class="difflineminus">-            let row = {};</span>
<a href="#l2.125"></a><span id="l2.125" class="difflineminus">-            let col = {};</span>
<a href="#l2.126"></a><span id="l2.126" class="difflineminus">-            let elt = {};</span>
<a href="#l2.127"></a><span id="l2.127" class="difflineminus">-            treeObj.treeBoxObject.getCellAt(x, y, row, col, elt);</span>
<a href="#l2.128"></a><span id="l2.128" class="difflineminus">-</span>
<a href="#l2.129"></a><span id="l2.129" class="difflineminus">-            return {</span>
<a href="#l2.130"></a><span id="l2.130" class="difflineminus">-              row: row.value,</span>
<a href="#l2.131"></a><span id="l2.131" class="difflineminus">-              col: col.value</span>
<a href="#l2.132"></a><span id="l2.132" class="difflineminus">-            };</span>
<a href="#l2.133"></a><span id="l2.133" class="difflineminus">-        },</span>
<a href="#l2.134"></a><span id="l2.134" class="difflineminus">-        rowCountChanged: function(a, b) {</span>
<a href="#l2.135"></a><span id="l2.135" class="difflineminus">-          return listViewHolder.treebox.rowCountChanged(a, b);</span>
<a href="#l2.136"></a><span id="l2.136" class="difflineminus">-        },</span>
<a href="#l2.137"></a><span id="l2.137" class="difflineminus">-        invalidate: function() {</span>
<a href="#l2.138"></a><span id="l2.138" class="difflineminus">-          return listViewHolder.treebox.invalidate();</span>
<a href="#l2.139"></a><span id="l2.139" class="difflineminus">-        },</span>
<a href="#l2.140"></a><span id="l2.140" class="difflineminus">-        invalidateRow: function(r) {</span>
<a href="#l2.141"></a><span id="l2.141" class="difflineminus">-          return listViewHolder.treebox.invalidateRow(r);</span>
<a href="#l2.142"></a><span id="l2.142" class="difflineminus">-        }</span>
<a href="#l2.143"></a><span id="l2.143" class="difflineminus">-      };</span>
<a href="#l2.144"></a><span id="l2.144" class="difflineminus">-    }</span>
<a href="#l2.145"></a><span id="l2.145" class="difflineplus">+    return {</span>
<a href="#l2.146"></a><span id="l2.146" class="difflineplus">+      getCellAt: function(x,y) {</span>
<a href="#l2.147"></a><span id="l2.147" class="difflineplus">+        return treeObj.getCellAt(x, y);</span>
<a href="#l2.148"></a><span id="l2.148" class="difflineplus">+      },</span>
<a href="#l2.149"></a><span id="l2.149" class="difflineplus">+      rowCountChanged: function(a, b) {</span>
<a href="#l2.150"></a><span id="l2.150" class="difflineplus">+        return treeObj.rowCountChanged(a, b);</span>
<a href="#l2.151"></a><span id="l2.151" class="difflineplus">+      },</span>
<a href="#l2.152"></a><span id="l2.152" class="difflineplus">+      invalidate: function() {</span>
<a href="#l2.153"></a><span id="l2.153" class="difflineplus">+        return treeObj.invalidate();</span>
<a href="#l2.154"></a><span id="l2.154" class="difflineplus">+      },</span>
<a href="#l2.155"></a><span id="l2.155" class="difflineplus">+      invalidateRow: function(r) {</span>
<a href="#l2.156"></a><span id="l2.156" class="difflineplus">+        return treeObj.invalidateRow(r);</span>
<a href="#l2.157"></a><span id="l2.157" class="difflineplus">+      }</span>
<a href="#l2.158"></a><span id="l2.158" class="difflineplus">+    };</span>
<a href="#l2.159"></a><span id="l2.159">   },</span>
<a href="#l2.160"></a><span id="l2.160"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/core.jsm</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/core.jsm</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -14,17 +14,17 @@ const {</span>
<a href="#l3.4"></a><span id="l3.4"> Cm.QueryInterface(Ci.nsIComponentRegistrar);</span>
<a href="#l3.5"></a><span id="l3.5"> </span>
<a href="#l3.6"></a><span id="l3.6"> const subprocess = ChromeUtils.import(&quot;chrome://openpgp/content/modules/subprocess.jsm&quot;).subprocess;</span>
<a href="#l3.7"></a><span id="l3.7"> const EnigmailLazy = ChromeUtils.import(&quot;chrome://openpgp/content/modules/lazy.jsm&quot;).EnigmailLazy;</span>
<a href="#l3.8"></a><span id="l3.8"> const EnigmailConstants = ChromeUtils.import(&quot;chrome://openpgp/content/modules/constants.jsm&quot;).EnigmailConstants;</span>
<a href="#l3.9"></a><span id="l3.9"> </span>
<a href="#l3.10"></a><span id="l3.10"> // load all modules lazily to avoid possible cross-reference errors</span>
<a href="#l3.11"></a><span id="l3.11"> const getEnigmailConsole = EnigmailLazy.loader(&quot;enigmail/pipeConsole.jsm&quot;, &quot;EnigmailConsole&quot;);</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-const getEnigmailGpgAgent = EnigmailLazy.loader(&quot;enigmail/gpgAgent.jsm&quot;, &quot;EnigmailGpgAgent&quot;);</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+//const getEnigmailGpgAgent = EnigmailLazy.loader(&quot;enigmail/gpgAgent.jsm&quot;, &quot;EnigmailGpgAgent&quot;);</span>
<a href="#l3.14"></a><span id="l3.14"> const getEnigmailMimeEncrypt = EnigmailLazy.loader(&quot;enigmail/mimeEncrypt.jsm&quot;, &quot;EnigmailMimeEncrypt&quot;);</span>
<a href="#l3.15"></a><span id="l3.15"> const getEnigmailProtocolHandler = EnigmailLazy.loader(&quot;enigmail/protocolHandler.jsm&quot;, &quot;EnigmailProtocolHandler&quot;);</span>
<a href="#l3.16"></a><span id="l3.16"> const getEnigmailFiltersWrapper = EnigmailLazy.loader(&quot;enigmail/filtersWrapper.jsm&quot;, &quot;EnigmailFiltersWrapper&quot;);</span>
<a href="#l3.17"></a><span id="l3.17"> const getEnigmailLog = EnigmailLazy.loader(&quot;enigmail/log.jsm&quot;, &quot;EnigmailLog&quot;);</span>
<a href="#l3.18"></a><span id="l3.18"> const getEnigmailOS = EnigmailLazy.loader(&quot;enigmail/os.jsm&quot;, &quot;EnigmailOS&quot;);</span>
<a href="#l3.19"></a><span id="l3.19"> const getEnigmailLocale = EnigmailLazy.loader(&quot;enigmail/locale.jsm&quot;, &quot;EnigmailLocale&quot;);</span>
<a href="#l3.20"></a><span id="l3.20"> const getEnigmailCommandLine = EnigmailLazy.loader(&quot;enigmail/commandLine.jsm&quot;, &quot;EnigmailCommandLine&quot;);</span>
<a href="#l3.21"></a><span id="l3.21"> const getEnigmailPrefs = EnigmailLazy.loader(&quot;enigmail/prefs.jsm&quot;, &quot;EnigmailPrefs&quot;);</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineat">@@ -117,17 +117,17 @@ var EnigmailCore = {</span>
<a href="#l3.23"></a><span id="l3.23">       for (let fct of this.factories) {</span>
<a href="#l3.24"></a><span id="l3.24">         fct.unregister();</span>
<a href="#l3.25"></a><span id="l3.25">       }</span>
<a href="#l3.26"></a><span id="l3.26">     }</span>
<a href="#l3.27"></a><span id="l3.27"> </span>
<a href="#l3.28"></a><span id="l3.28">     getEnigmailFiltersWrapper().onShutdown();</span>
<a href="#l3.29"></a><span id="l3.29">     getEnigmailVerify().unregisterContentTypeHandler();</span>
<a href="#l3.30"></a><span id="l3.30"> </span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-    getEnigmailGpgAgent().finalize();</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+    //getEnigmailGpgAgent().finalize();</span>
<a href="#l3.33"></a><span id="l3.33">     getEnigmailLocale().shutdown();</span>
<a href="#l3.34"></a><span id="l3.34">     getEnigmailLog().onShutdown();</span>
<a href="#l3.35"></a><span id="l3.35"> </span>
<a href="#l3.36"></a><span id="l3.36">     getEnigmailLog().setLogLevel(3);</span>
<a href="#l3.37"></a><span id="l3.37">     gEnigmailService = null;</span>
<a href="#l3.38"></a><span id="l3.38">   },</span>
<a href="#l3.39"></a><span id="l3.39"> </span>
<a href="#l3.40"></a><span id="l3.40">   version: &quot;&quot;,</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineat">@@ -234,16 +234,18 @@ function initializeSubprocessLogging(env</span>
<a href="#l3.42"></a><span id="l3.42">   if (matches &amp;&amp; matches.length &gt; 1 &amp;&amp; matches[1] &gt; 2) {</span>
<a href="#l3.43"></a><span id="l3.43">     subprocess.registerDebugHandler(function(txt) {</span>
<a href="#l3.44"></a><span id="l3.44">       getEnigmailLog().DEBUG(&quot;subprocess.jsm: &quot; + txt);</span>
<a href="#l3.45"></a><span id="l3.45">     });</span>
<a href="#l3.46"></a><span id="l3.46">   }</span>
<a href="#l3.47"></a><span id="l3.47"> }</span>
<a href="#l3.48"></a><span id="l3.48"> </span>
<a href="#l3.49"></a><span id="l3.49"> function initializeAgentInfo() {</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineplus">+  return;</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+</span>
<a href="#l3.52"></a><span id="l3.52">   if (!getEnigmailOS().isDosLike &amp;&amp; !getEnigmailGpgAgent().isDummy()) {</span>
<a href="#l3.53"></a><span id="l3.53">     EnigmailCore.addToEnvList(&quot;GPG_AGENT_INFO=&quot; + getEnigmailGpgAgent().gpgAgentInfo.envStr);</span>
<a href="#l3.54"></a><span id="l3.54">   }</span>
<a href="#l3.55"></a><span id="l3.55"> }</span>
<a href="#l3.56"></a><span id="l3.56"> </span>
<a href="#l3.57"></a><span id="l3.57"> function failureOn(ex, status) {</span>
<a href="#l3.58"></a><span id="l3.58">   status.initializationError = getEnigmailLocale().getString(&quot;enigmailNotAvailable&quot;);</span>
<a href="#l3.59"></a><span id="l3.59">   getEnigmailLog().ERROR(&quot;core.jsm: Enigmail.initialize: Error - &quot; + status.initializationError + &quot;\n&quot;);</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineat">@@ -342,36 +344,36 @@ Enigmail.prototype = {</span>
<a href="#l3.61"></a><span id="l3.61">     initializeEnvironment(this.environment);</span>
<a href="#l3.62"></a><span id="l3.62"> </span>
<a href="#l3.63"></a><span id="l3.63">     try {</span>
<a href="#l3.64"></a><span id="l3.64">       getEnigmailConsole().write(&quot;Initializing Enigmail service ...\n&quot;);</span>
<a href="#l3.65"></a><span id="l3.65">     } catch (ex) {</span>
<a href="#l3.66"></a><span id="l3.66">       failureOn(ex, this);</span>
<a href="#l3.67"></a><span id="l3.67">     }</span>
<a href="#l3.68"></a><span id="l3.68"> </span>
<a href="#l3.69"></a><span id="l3.69" class="difflineminus">-    getEnigmailGpgAgent().setAgentPath(domWindow, this, gPreferredGpgPath);</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineminus">-    getEnigmailGpgAgent().detectGpgAgent(domWindow, this);</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineplus">+    //getEnigmailGpgAgent().setAgentPath(domWindow, this, gPreferredGpgPath);</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineplus">+    //getEnigmailGpgAgent().detectGpgAgent(domWindow, this);</span>
<a href="#l3.73"></a><span id="l3.73"> </span>
<a href="#l3.74"></a><span id="l3.74" class="difflineminus">-    initializeAgentInfo();</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineplus">+    //initializeAgentInfo();</span>
<a href="#l3.76"></a><span id="l3.76"> </span>
<a href="#l3.77"></a><span id="l3.77" class="difflineminus">-    getEnigmailKeyRefreshService().start(getEnigmailKeyServer());</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineplus">+    //getEnigmailKeyRefreshService().start(getEnigmailKeyServer());</span>
<a href="#l3.79"></a><span id="l3.79"> </span>
<a href="#l3.80"></a><span id="l3.80">     this.initialized = true;</span>
<a href="#l3.81"></a><span id="l3.81"> </span>
<a href="#l3.82"></a><span id="l3.82">     getEnigmailLog().DEBUG(&quot;core.jsm: Enigmail.initialize: END\n&quot;);</span>
<a href="#l3.83"></a><span id="l3.83">   },</span>
<a href="#l3.84"></a><span id="l3.84"> </span>
<a href="#l3.85"></a><span id="l3.85">   reinitialize: function() {</span>
<a href="#l3.86"></a><span id="l3.86">     getEnigmailLog().DEBUG(&quot;core.jsm: Enigmail.reinitialize:\n&quot;);</span>
<a href="#l3.87"></a><span id="l3.87">     this.initialized = false;</span>
<a href="#l3.88"></a><span id="l3.88">     this.initializationAttempted = true;</span>
<a href="#l3.89"></a><span id="l3.89"> </span>
<a href="#l3.90"></a><span id="l3.90">     getEnigmailConsole().write(&quot;Reinitializing Enigmail service ...\n&quot;);</span>
<a href="#l3.91"></a><span id="l3.91">     initializeEnvironment(this.environment);</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineminus">-    getEnigmailGpgAgent().setAgentPath(null, this, gPreferredGpgPath);</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineplus">+    //getEnigmailGpgAgent().setAgentPath(null, this, gPreferredGpgPath);</span>
<a href="#l3.94"></a><span id="l3.94">     this.initialized = true;</span>
<a href="#l3.95"></a><span id="l3.95">   },</span>
<a href="#l3.96"></a><span id="l3.96"> </span>
<a href="#l3.97"></a><span id="l3.97">   perferGpgPath: function(gpgPath) {</span>
<a href="#l3.98"></a><span id="l3.98">     getEnigmailLog().DEBUG(&quot;core.jsm: Enigmail.perferGpgPath = &quot; + gpgPath + &quot;\n&quot;);</span>
<a href="#l3.99"></a><span id="l3.99">     gPreferredGpgPath = gpgPath;</span>
<a href="#l3.100"></a><span id="l3.100">   },</span>
<a href="#l3.101"></a><span id="l3.101"> </span>
<a href="#l3.102"></a><span id="l3.102" class="difflineat">@@ -437,20 +439,22 @@ Enigmail.prototype = {</span>
<a href="#l3.103"></a><span id="l3.103"> </span>
<a href="#l3.104"></a><span id="l3.104">         return null;</span>
<a href="#l3.105"></a><span id="l3.105">       }</span>
<a href="#l3.106"></a><span id="l3.106"> </span>
<a href="#l3.107"></a><span id="l3.107">       const configuredVersion = getEnigmailPrefs().getPref(&quot;configuredVersion&quot;);</span>
<a href="#l3.108"></a><span id="l3.108"> </span>
<a href="#l3.109"></a><span id="l3.109">       getEnigmailLog().DEBUG(&quot;core.jsm: getService: last used version: &quot; + configuredVersion + &quot;\n&quot;);</span>
<a href="#l3.110"></a><span id="l3.110"> </span>
<a href="#l3.111"></a><span id="l3.111" class="difflineplus">+      /*</span>
<a href="#l3.112"></a><span id="l3.112">       if (firstInitialization &amp;&amp; this.initialized &amp;&amp;</span>
<a href="#l3.113"></a><span id="l3.113">         getEnigmailGpgAgent().agentType === &quot;pgp&quot;) {</span>
<a href="#l3.114"></a><span id="l3.114">         getEnigmailDialog().alert(win, getEnigmailLocale().getString(&quot;pgpNotSupported&quot;));</span>
<a href="#l3.115"></a><span id="l3.115">       }</span>
<a href="#l3.116"></a><span id="l3.116" class="difflineplus">+      */</span>
<a href="#l3.117"></a><span id="l3.117"> </span>
<a href="#l3.118"></a><span id="l3.118">       if (this.initialized &amp;&amp; (getEnigmailApp().getVersion() != configuredVersion)) {</span>
<a href="#l3.119"></a><span id="l3.119">         getEnigmailConfigure().configureEnigmail(win, startingPreferences);</span>
<a href="#l3.120"></a><span id="l3.120">       }</span>
<a href="#l3.121"></a><span id="l3.121">     }</span>
<a href="#l3.122"></a><span id="l3.122"> </span>
<a href="#l3.123"></a><span id="l3.123">     return this.initialized ? this : null;</span>
<a href="#l3.124"></a><span id="l3.124">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/cryptoAPI/RNPCryptoAPI.jsm</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/cryptoAPI/RNPCryptoAPI.jsm</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -273,13 +273,17 @@ class RNPCryptoAPI extends CryptoAPI {</span>
<a href="#l4.4"></a><span id="l4.4">   </span>
<a href="#l4.5"></a><span id="l4.5">   async deleteKey(keyFingerprint, deleteSecret) {</span>
<a href="#l4.6"></a><span id="l4.6">     return RNP.deleteKey(keyId, deleteSecret);</span>
<a href="#l4.7"></a><span id="l4.7">   }</span>
<a href="#l4.8"></a><span id="l4.8"> </span>
<a href="#l4.9"></a><span id="l4.9">   async encryptAndOrSign(plaintext, args, resultStatus) {</span>
<a href="#l4.10"></a><span id="l4.10">     return RNP.encryptAndOrSign(plaintext, args, resultStatus);</span>
<a href="#l4.11"></a><span id="l4.11">   }</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+  </span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+  async getPublicKey(id) {</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+    return RNP.getPublicKey(id);</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+  }</span>
<a href="#l4.16"></a><span id="l4.16"> }</span>
<a href="#l4.17"></a><span id="l4.17"> </span>
<a href="#l4.18"></a><span id="l4.18"> function getRNPAPI() {</span>
<a href="#l4.19"></a><span id="l4.19">   return new RNPCryptoAPI();</span>
<a href="#l4.20"></a><span id="l4.20"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/encryption.jsm</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/encryption.jsm</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -258,17 +258,18 @@ var EnigmailEncryption = {</span>
<a href="#l5.4"></a><span id="l5.4">       if (isAscii != ENC_TYPE_ATTACH_BINARY) {</span>
<a href="#l5.5"></a><span id="l5.5">         result.armor = true;</span>
<a href="#l5.6"></a><span id="l5.6">       }</span>
<a href="#l5.7"></a><span id="l5.7">     }</span>
<a href="#l5.8"></a><span id="l5.8">     else if (signMsg) {</span>
<a href="#l5.9"></a><span id="l5.9">       result.sigTypeClear = true;</span>
<a href="#l5.10"></a><span id="l5.10">     }</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-    console.debug(&quot;getCryptParams returning: &quot; + result);</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+    console.debug(`getCryptParams returning:`);</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+    console.debug(result);</span>
<a href="#l5.15"></a><span id="l5.15">     return result;</span>
<a href="#l5.16"></a><span id="l5.16">   },</span>
<a href="#l5.17"></a><span id="l5.17"> </span>
<a href="#l5.18"></a><span id="l5.18"> </span>
<a href="#l5.19"></a><span id="l5.19">   /**</span>
<a href="#l5.20"></a><span id="l5.20">    * Determine if the sender key ID or user ID can be used for signing and/or encryption</span>
<a href="#l5.21"></a><span id="l5.21">    *</span>
<a href="#l5.22"></a><span id="l5.22">    * @param sendFlags:    Number  - the send Flags; need to contain SEND_SIGNED and/or SEND_ENCRYPTED</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineat">@@ -401,18 +402,19 @@ var EnigmailEncryption = {</span>
<a href="#l5.24"></a><span id="l5.24">     if (statusFlagsObj.value &amp; EnigmailConstants.MISSING_PASSPHRASE) {</span>
<a href="#l5.25"></a><span id="l5.25">       EnigmailLog.ERROR(&quot;encryption.jsm: encryptMessageStart: Error - no passphrase supplied\n&quot;);</span>
<a href="#l5.26"></a><span id="l5.26">       errorMsgObj.value = &quot;&quot;;</span>
<a href="#l5.27"></a><span id="l5.27">     }</span>
<a href="#l5.28"></a><span id="l5.28">     */</span>
<a href="#l5.29"></a><span id="l5.29"> </span>
<a href="#l5.30"></a><span id="l5.30">     let resultStatus = {};</span>
<a href="#l5.31"></a><span id="l5.31">     const cApi = EnigmailCryptoAPI();</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+    console.debug(&quot;listener: %o&quot;, listener);</span>
<a href="#l5.33"></a><span id="l5.33">     let encrypted = cApi.sync(cApi.encryptAndOrSign(listener.getInputForEncryption(), encryptArgs, resultStatus));</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineminus">-    console.debug(&quot;encryptAndOrSign returned: &quot; + encrypted);</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineplus">+    console.debug(`encryptAndOrSign returned: ${encrypted}`);</span>
<a href="#l5.36"></a><span id="l5.36"> </span>
<a href="#l5.37"></a><span id="l5.37">     listener.addEncryptedOutput(encrypted);</span>
<a href="#l5.38"></a><span id="l5.38"> </span>
<a href="#l5.39"></a><span id="l5.39">     if (pgpMime &amp;&amp; errorMsgObj.value) {</span>
<a href="#l5.40"></a><span id="l5.40">       EnigmailDialog.alert(win, errorMsgObj.value);</span>
<a href="#l5.41"></a><span id="l5.41">     }</span>
<a href="#l5.42"></a><span id="l5.42"> </span>
<a href="#l5.43"></a><span id="l5.43">     listener.done(resultStatus.exitCode);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/gpgAgent.jsm</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/gpgAgent.jsm</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -112,16 +112,19 @@ var EnigmailGpgAgent = {</span>
<a href="#l6.4"></a><span id="l6.4">   },</span>
<a href="#l6.5"></a><span id="l6.5"> </span>
<a href="#l6.6"></a><span id="l6.6">   resetGpgAgent: function() {</span>
<a href="#l6.7"></a><span id="l6.7">     EnigmailLog.DEBUG(&quot;gpgAgent.jsm: resetGpgAgent\n&quot;);</span>
<a href="#l6.8"></a><span id="l6.8">     gIsGpgAgent = -1;</span>
<a href="#l6.9"></a><span id="l6.9">   },</span>
<a href="#l6.10"></a><span id="l6.10"> </span>
<a href="#l6.11"></a><span id="l6.11">   isCmdGpgAgent: function(pid) {</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+    console.debug(&quot;reaching disabled EnigmailGpgAgent.isCmdGpgAgent()&quot;);</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+    return;</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+</span>
<a href="#l6.15"></a><span id="l6.15">     EnigmailLog.DEBUG(&quot;gpgAgent.jsm: isCmdGpgAgent:\n&quot;);</span>
<a href="#l6.16"></a><span id="l6.16"> </span>
<a href="#l6.17"></a><span id="l6.17">     const environment = Cc[&quot;@mozilla.org/process/environment;1&quot;].getService(Ci.nsIEnvironment);</span>
<a href="#l6.18"></a><span id="l6.18">     let ret = false;</span>
<a href="#l6.19"></a><span id="l6.19"> </span>
<a href="#l6.20"></a><span id="l6.20">     let path = environment.get(&quot;PATH&quot;);</span>
<a href="#l6.21"></a><span id="l6.21">     if (!path || path.length === 0) {</span>
<a href="#l6.22"></a><span id="l6.22">       path = &quot;/bin:/usr/bin:/usr/local/bin&quot;;</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineat">@@ -151,16 +154,19 @@ var EnigmailGpgAgent = {</span>
<a href="#l6.24"></a><span id="l6.24">     }</span>
<a href="#l6.25"></a><span id="l6.25">     catch (ex) {}</span>
<a href="#l6.26"></a><span id="l6.26"> </span>
<a href="#l6.27"></a><span id="l6.27">     return ret;</span>
<a href="#l6.28"></a><span id="l6.28"> </span>
<a href="#l6.29"></a><span id="l6.29">   },</span>
<a href="#l6.30"></a><span id="l6.30"> </span>
<a href="#l6.31"></a><span id="l6.31">   isAgentTypeGpgAgent: function() {</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+    console.debug(&quot;reaching disabled EnigmailGpgAgent.isAgentTypeGpgAgent()&quot;);</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+    return;</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+</span>
<a href="#l6.35"></a><span id="l6.35">     // determine if the used agent is a gpg-agent</span>
<a href="#l6.36"></a><span id="l6.36"> </span>
<a href="#l6.37"></a><span id="l6.37">     EnigmailLog.DEBUG(&quot;gpgAgent.jsm: isAgentTypeGpgAgent:\n&quot;);</span>
<a href="#l6.38"></a><span id="l6.38"> </span>
<a href="#l6.39"></a><span id="l6.39">     // to my knowledge there is no other agent than gpg-agent on Windows</span>
<a href="#l6.40"></a><span id="l6.40">     if (EnigmailOS.getOS() == &quot;WINNT&quot;) return true;</span>
<a href="#l6.41"></a><span id="l6.41"> </span>
<a href="#l6.42"></a><span id="l6.42">     if (gIsGpgAgent &gt;= 0) {</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineat">@@ -210,16 +216,19 @@ var EnigmailGpgAgent = {</span>
<a href="#l6.44"></a><span id="l6.44">       gIsGpgAgent = isAgent ? 1 : 0;</span>
<a href="#l6.45"></a><span id="l6.45">     }</span>
<a href="#l6.46"></a><span id="l6.46">     catch (ex) {}</span>
<a href="#l6.47"></a><span id="l6.47"> </span>
<a href="#l6.48"></a><span id="l6.48">     return isAgent;</span>
<a href="#l6.49"></a><span id="l6.49">   },</span>
<a href="#l6.50"></a><span id="l6.50"> </span>
<a href="#l6.51"></a><span id="l6.51">   getAgentMaxIdle: function() {</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineplus">+    console.debug(&quot;reaching disabled EnigmailGpgAgent.getAgentMaxIdle()&quot;);</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineplus">+    return;</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineplus">+</span>
<a href="#l6.55"></a><span id="l6.55">     EnigmailLog.DEBUG(&quot;gpgAgent.jsm: getAgentMaxIdle:\n&quot;);</span>
<a href="#l6.56"></a><span id="l6.56">     let maxIdle = -1;</span>
<a href="#l6.57"></a><span id="l6.57"> </span>
<a href="#l6.58"></a><span id="l6.58">     if (!EnigmailCore.getService()) return maxIdle;</span>
<a href="#l6.59"></a><span id="l6.59"> </span>
<a href="#l6.60"></a><span id="l6.60">     const DEFAULT = 7;</span>
<a href="#l6.61"></a><span id="l6.61">     const CFGVALUE = 9;</span>
<a href="#l6.62"></a><span id="l6.62">     let outStr = &quot;&quot;;</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineat">@@ -252,16 +261,19 @@ var EnigmailGpgAgent = {</span>
<a href="#l6.64"></a><span id="l6.64"> </span>
<a href="#l6.65"></a><span id="l6.65">         break;</span>
<a href="#l6.66"></a><span id="l6.66">       }</span>
<a href="#l6.67"></a><span id="l6.67">     }</span>
<a href="#l6.68"></a><span id="l6.68">     return maxIdle;</span>
<a href="#l6.69"></a><span id="l6.69">   },</span>
<a href="#l6.70"></a><span id="l6.70"> </span>
<a href="#l6.71"></a><span id="l6.71">   setAgentMaxIdle: function(idleMinutes) {</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineplus">+    console.debug(&quot;reaching disabled EnigmailGpgAgent.setAgentMaxIdle()&quot;);</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineplus">+    return;</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineplus">+</span>
<a href="#l6.75"></a><span id="l6.75">     EnigmailLog.DEBUG(&quot;gpgAgent.jsm: setAgentMaxIdle:\n&quot;);</span>
<a href="#l6.76"></a><span id="l6.76">     if (!EnigmailCore.getService()) return;</span>
<a href="#l6.77"></a><span id="l6.77"> </span>
<a href="#l6.78"></a><span id="l6.78">     const RUNTIME = 8;</span>
<a href="#l6.79"></a><span id="l6.79"> </span>
<a href="#l6.80"></a><span id="l6.80">     const proc = {</span>
<a href="#l6.81"></a><span id="l6.81">       command: EnigmailGpgAgent.gpgconfPath,</span>
<a href="#l6.82"></a><span id="l6.82">       arguments: [&quot;--runtime&quot;, &quot;--change-options&quot;, &quot;gpg-agent&quot;],</span>
<a href="#l6.83"></a><span id="l6.83" class="difflineat">@@ -320,16 +332,18 @@ var EnigmailGpgAgent = {</span>
<a href="#l6.84"></a><span id="l6.84"> </span>
<a href="#l6.85"></a><span id="l6.85">   /**</span>
<a href="#l6.86"></a><span id="l6.86">    * Determine the &quot;gpg home dir&quot;, i.e. the directory where gpg.conf and the keyring are</span>
<a href="#l6.87"></a><span id="l6.87">    * stored using the &quot;additional parameter&quot; and gpgconf.</span>
<a href="#l6.88"></a><span id="l6.88">    *</span>
<a href="#l6.89"></a><span id="l6.89">    * @return String - directory name, or NULL (in case the command did not succeed)</span>
<a href="#l6.90"></a><span id="l6.90">    */</span>
<a href="#l6.91"></a><span id="l6.91">   getGpgHomeDir: function() {</span>
<a href="#l6.92"></a><span id="l6.92" class="difflineplus">+    console.debug(&quot;reaching disabled EnigmailGpgAgent.getGpgHomeDir()&quot;);</span>
<a href="#l6.93"></a><span id="l6.93" class="difflineplus">+    return;</span>
<a href="#l6.94"></a><span id="l6.94"> </span>
<a href="#l6.95"></a><span id="l6.95">     let param = EnigmailPrefs.getPref(&quot;agentAdditionalParam&quot;);</span>
<a href="#l6.96"></a><span id="l6.96"> </span>
<a href="#l6.97"></a><span id="l6.97">     if (param) {</span>
<a href="#l6.98"></a><span id="l6.98">       let hd = getHomedirFromParam(param);</span>
<a href="#l6.99"></a><span id="l6.99"> </span>
<a href="#l6.100"></a><span id="l6.100">       if (hd) return hd;</span>
<a href="#l6.101"></a><span id="l6.101">     }</span>
<a href="#l6.102"></a><span id="l6.102" class="difflineat">@@ -374,16 +388,19 @@ var EnigmailGpgAgent = {</span>
<a href="#l6.103"></a><span id="l6.103">   },</span>
<a href="#l6.104"></a><span id="l6.104"> </span>
<a href="#l6.105"></a><span id="l6.105">   /**</span>
<a href="#l6.106"></a><span id="l6.106">    * @param domWindow:     Object - parent window, may be NULL</span>
<a href="#l6.107"></a><span id="l6.107">    * @param esvc:          Object - Enigmail service object</span>
<a href="#l6.108"></a><span id="l6.108">    * @param preferredPath: String - try to use specific path to locate gpg</span>
<a href="#l6.109"></a><span id="l6.109">    */</span>
<a href="#l6.110"></a><span id="l6.110">   setAgentPath: function(domWindow, esvc, preferredPath) {</span>
<a href="#l6.111"></a><span id="l6.111" class="difflineplus">+    console.debug(&quot;reaching disabled EnigmailGpgAgent.setAgentPath()&quot;);</span>
<a href="#l6.112"></a><span id="l6.112" class="difflineplus">+    return;</span>
<a href="#l6.113"></a><span id="l6.113" class="difflineplus">+</span>
<a href="#l6.114"></a><span id="l6.114">     EnigmailLog.DEBUG(&quot;gpgAgent.jsm: setAgentPath()\n&quot;);</span>
<a href="#l6.115"></a><span id="l6.115">     let agentPath = &quot;&quot;;</span>
<a href="#l6.116"></a><span id="l6.116">     try {</span>
<a href="#l6.117"></a><span id="l6.117">       if (preferredPath) {</span>
<a href="#l6.118"></a><span id="l6.118">         agentPath = preferredPath;</span>
<a href="#l6.119"></a><span id="l6.119">       }</span>
<a href="#l6.120"></a><span id="l6.120">       else {</span>
<a href="#l6.121"></a><span id="l6.121">         agentPath = EnigmailPrefs.getPrefBranch().getCharPref(&quot;agentPath&quot;);</span>
<a href="#l6.122"></a><span id="l6.122" class="difflineat">@@ -539,16 +556,19 @@ var EnigmailGpgAgent = {</span>
<a href="#l6.123"></a><span id="l6.123">   /**</span>
<a href="#l6.124"></a><span id="l6.124">    * Determine the location of the GnuPG executable</span>
<a href="#l6.125"></a><span id="l6.125">    *</span>
<a href="#l6.126"></a><span id="l6.126">    * @param env: Object: nsIEnvironment to use</span>
<a href="#l6.127"></a><span id="l6.127">    *</span>
<a href="#l6.128"></a><span id="l6.128">    * @return Object: nsIFile pointing to gpg, or NULL</span>
<a href="#l6.129"></a><span id="l6.129">    */</span>
<a href="#l6.130"></a><span id="l6.130">   resolveGpgPath: function(env) {</span>
<a href="#l6.131"></a><span id="l6.131" class="difflineplus">+    console.debug(&quot;reaching disabled EnigmailGpgAgent.resolveGpgPath()&quot;);</span>
<a href="#l6.132"></a><span id="l6.132" class="difflineplus">+    return;</span>
<a href="#l6.133"></a><span id="l6.133" class="difflineplus">+</span>
<a href="#l6.134"></a><span id="l6.134">     EnigmailLog.DEBUG(&quot;gpgAgent.jsm: resolveGpgPath()\n&quot;);</span>
<a href="#l6.135"></a><span id="l6.135"> </span>
<a href="#l6.136"></a><span id="l6.136">     let agentName = &quot;&quot;;</span>
<a href="#l6.137"></a><span id="l6.137">     if (EnigmailOS.isDosLike) {</span>
<a href="#l6.138"></a><span id="l6.138">       agentName = &quot;gpg2.exe;gpg.exe&quot;;</span>
<a href="#l6.139"></a><span id="l6.139">     }</span>
<a href="#l6.140"></a><span id="l6.140">     else {</span>
<a href="#l6.141"></a><span id="l6.141">       agentName = &quot;gpg2;gpg&quot;;</span>
<a href="#l6.142"></a><span id="l6.142" class="difflineat">@@ -756,16 +776,19 @@ var EnigmailGpgAgent = {</span>
<a href="#l6.143"></a><span id="l6.143">         domWindow = EnigmailWindows.getBestParentWin();</span>
<a href="#l6.144"></a><span id="l6.144">       }</span>
<a href="#l6.145"></a><span id="l6.145">       getDialog().alert(domWindow, EnigmailLocale.getString(errMsg, homeDir) + &quot;\n\n&quot; + EnigmailLocale.getString(&quot;gpghomedir.notusable&quot;));</span>
<a href="#l6.146"></a><span id="l6.146">       throw Components.results.NS_ERROR_FAILURE;</span>
<a href="#l6.147"></a><span id="l6.147">     }</span>
<a href="#l6.148"></a><span id="l6.148">   },</span>
<a href="#l6.149"></a><span id="l6.149"> </span>
<a href="#l6.150"></a><span id="l6.150">   finalize: function() {</span>
<a href="#l6.151"></a><span id="l6.151" class="difflineplus">+    console.debug(&quot;reaching disabled EnigmailGpgAgent.finalize()&quot;);</span>
<a href="#l6.152"></a><span id="l6.152" class="difflineplus">+    return;</span>
<a href="#l6.153"></a><span id="l6.153" class="difflineplus">+</span>
<a href="#l6.154"></a><span id="l6.154">     if (EnigmailGpgAgent.gpgAgentProcess) {</span>
<a href="#l6.155"></a><span id="l6.155">       EnigmailLog.DEBUG(&quot;gpgAgent.jsm: EnigmailGpgAgent.finalize: stopping gpg-agent\n&quot;);</span>
<a href="#l6.156"></a><span id="l6.156">       try {</span>
<a href="#l6.157"></a><span id="l6.157">         const proc = {</span>
<a href="#l6.158"></a><span id="l6.158">           command: EnigmailGpgAgent.connGpgAgentPath,</span>
<a href="#l6.159"></a><span id="l6.159">           arguments: ['killagent', '/bye'],</span>
<a href="#l6.160"></a><span id="l6.160">           environment: EnigmailCore.getEnvList()</span>
<a href="#l6.161"></a><span id="l6.161">         };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/keyObj.jsm</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/keyObj.jsm</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -276,17 +276,17 @@ class EnigmailKeyObj {</span>
<a href="#l7.4"></a><span id="l7.4">             retVal.reason = EnigmailLocale.getString(&quot;keyRing.pubKeyNotForSigning&quot;, [this.userId, &quot;0x&quot; + this.keyId]);</span>
<a href="#l7.5"></a><span id="l7.5">           }</span>
<a href="#l7.6"></a><span id="l7.6">         } else {</span>
<a href="#l7.7"></a><span id="l7.7">           retVal.keyValid = true;</span>
<a href="#l7.8"></a><span id="l7.8">         }</span>
<a href="#l7.9"></a><span id="l7.9">       }</span>
<a href="#l7.10"></a><span id="l7.10">     }</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-    console.debug(&quot;getSigningValidity retVal: &quot; + retVal);</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+    console.debug(&quot;getSigningValidity retVal: %o&quot;, retVal);</span>
<a href="#l7.14"></a><span id="l7.14">     return retVal;</span>
<a href="#l7.15"></a><span id="l7.15">   }</span>
<a href="#l7.16"></a><span id="l7.16"> </span>
<a href="#l7.17"></a><span id="l7.17">   /**</span>
<a href="#l7.18"></a><span id="l7.18">    * Check whether a key can be used for encryption and return a description of why not</span>
<a href="#l7.19"></a><span id="l7.19">    *</span>
<a href="#l7.20"></a><span id="l7.20">    * @return Object:</span>
<a href="#l7.21"></a><span id="l7.21">    *   - keyValid: Boolean (true if key is valid)</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineat">@@ -335,17 +335,17 @@ class EnigmailKeyObj {</span>
<a href="#l7.23"></a><span id="l7.23">             retVal.reason = EnigmailLocale.getString(&quot;keyRing.pubKeyNotForEncryption&quot;, [this.userId, &quot;0x&quot; + this.keyId]);</span>
<a href="#l7.24"></a><span id="l7.24">           }</span>
<a href="#l7.25"></a><span id="l7.25">         } else {</span>
<a href="#l7.26"></a><span id="l7.26">           retVal.keyValid = true;</span>
<a href="#l7.27"></a><span id="l7.27">         }</span>
<a href="#l7.28"></a><span id="l7.28">       }</span>
<a href="#l7.29"></a><span id="l7.29">     }</span>
<a href="#l7.30"></a><span id="l7.30"> </span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">-    console.debug(&quot;getEncryptionValidity retVal: &quot; + retVal);</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+    console.debug(&quot;getEncryptionValidity retVal: %o&quot;, retVal);</span>
<a href="#l7.33"></a><span id="l7.33">     return retVal;</span>
<a href="#l7.34"></a><span id="l7.34">   }</span>
<a href="#l7.35"></a><span id="l7.35"> </span>
<a href="#l7.36"></a><span id="l7.36">   /**</span>
<a href="#l7.37"></a><span id="l7.37">    * Determine the next expiry date of the key. This is either the public key expiry date,</span>
<a href="#l7.38"></a><span id="l7.38">    * or the maximum expiry date of a signing or encryption subkey. I.e. this returns the next</span>
<a href="#l7.39"></a><span id="l7.39">    * date at which the key cannot be used for signing and/or encryption anymore</span>
<a href="#l7.40"></a><span id="l7.40">    *</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/keyRing.jsm</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/keyRing.jsm</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -13,17 +13,17 @@ const EnigmailLog = ChromeUtils.import(&quot;</span>
<a href="#l8.4"></a><span id="l8.4"> const EnigmailExecution = ChromeUtils.import(&quot;chrome://openpgp/content/modules/execution.jsm&quot;).EnigmailExecution;</span>
<a href="#l8.5"></a><span id="l8.5"> const EnigmailLocale = ChromeUtils.import(&quot;chrome://openpgp/content/modules/locale.jsm&quot;).EnigmailLocale;</span>
<a href="#l8.6"></a><span id="l8.6"> const EnigmailFiles = ChromeUtils.import(&quot;chrome://openpgp/content/modules/files.jsm&quot;).EnigmailFiles;</span>
<a href="#l8.7"></a><span id="l8.7"> const EnigmailGpg = ChromeUtils.import(&quot;chrome://openpgp/content/modules/gpg.jsm&quot;).EnigmailGpg;</span>
<a href="#l8.8"></a><span id="l8.8"> const EnigmailTrust = ChromeUtils.import(&quot;chrome://openpgp/content/modules/trust.jsm&quot;).EnigmailTrust;</span>
<a href="#l8.9"></a><span id="l8.9"> const EnigmailArmor = ChromeUtils.import(&quot;chrome://openpgp/content/modules/armor.jsm&quot;).EnigmailArmor;</span>
<a href="#l8.10"></a><span id="l8.10"> const EnigmailTime = ChromeUtils.import(&quot;chrome://openpgp/content/modules/time.jsm&quot;).EnigmailTime;</span>
<a href="#l8.11"></a><span id="l8.11"> const EnigmailData = ChromeUtils.import(&quot;chrome://openpgp/content/modules/data.jsm&quot;).EnigmailData;</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-const subprocess = ChromeUtils.import(&quot;chrome://openpgp/content/modules/subprocess.jsm&quot;).subprocess;</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+//const subprocess = ChromeUtils.import(&quot;chrome://openpgp/content/modules/subprocess.jsm&quot;).subprocess;</span>
<a href="#l8.14"></a><span id="l8.14"> const EnigmailLazy = ChromeUtils.import(&quot;chrome://openpgp/content/modules/lazy.jsm&quot;).EnigmailLazy;</span>
<a href="#l8.15"></a><span id="l8.15"> const newEnigmailKeyObj = ChromeUtils.import(&quot;chrome://openpgp/content/modules/keyObj.jsm&quot;).newEnigmailKeyObj;</span>
<a href="#l8.16"></a><span id="l8.16"> const EnigmailTimer = ChromeUtils.import(&quot;chrome://openpgp/content/modules/timer.jsm&quot;).EnigmailTimer;</span>
<a href="#l8.17"></a><span id="l8.17"> const Services = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;).Services;</span>
<a href="#l8.18"></a><span id="l8.18"> const EnigmailConstants = ChromeUtils.import(&quot;chrome://openpgp/content/modules/constants.jsm&quot;).EnigmailConstants;</span>
<a href="#l8.19"></a><span id="l8.19"> const EnigmailCryptoAPI = ChromeUtils.import(&quot;chrome://openpgp/content/modules/cryptoAPI.jsm&quot;).EnigmailCryptoAPI;</span>
<a href="#l8.20"></a><span id="l8.20"> </span>
<a href="#l8.21"></a><span id="l8.21"> </span>
<a href="#l8.22"></a><span id="l8.22" class="difflineat">@@ -69,19 +69,22 @@ var EnigmailKeyRing = {</span>
<a href="#l8.23"></a><span id="l8.23">    * @param  win           - optional |object| holding the parent window for displaying error messages</span>
<a href="#l8.24"></a><span id="l8.24">    * @param  sortColumn    - optional |string| containing the column name for sorting. One of:</span>
<a href="#l8.25"></a><span id="l8.25">    *                            userid, keyid, keyidshort, fpr, keytype, validity, trust, expiry</span>
<a href="#l8.26"></a><span id="l8.26">    * @param  sortDirection - |number| 1 = ascending / -1 = descending</span>
<a href="#l8.27"></a><span id="l8.27">    *</span>
<a href="#l8.28"></a><span id="l8.28">    * @return keyListObj    - |object| { keyList, keySortList } (see above)</span>
<a href="#l8.29"></a><span id="l8.29">    */</span>
<a href="#l8.30"></a><span id="l8.30">   getAllKeys: function(win, sortColumn, sortDirection) {</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineplus">+    console.debug(&quot;keyring.getAllKeys&quot;);</span>
<a href="#l8.32"></a><span id="l8.32">     if (gKeyListObj.keySortList.length === 0) {</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineplus">+      console.debug(&quot;keyring.getAllKeys - loadkeylist&quot;);</span>
<a href="#l8.34"></a><span id="l8.34">       loadKeyList(win, sortColumn, sortDirection);</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineminus">-      getWindows().keyManReloadKeys();</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineplus">+      console.debug(&quot;keyring.getAllKeys - keymanreloadkeys&quot;);</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineplus">+//getWindows().keyManReloadKeys();</span>
<a href="#l8.38"></a><span id="l8.38">       /* TODO: do we need something similar with TB's future trust behavior?</span>
<a href="#l8.39"></a><span id="l8.39">       if (!gKeyCheckDone) {</span>
<a href="#l8.40"></a><span id="l8.40">         gKeyCheckDone = true;</span>
<a href="#l8.41"></a><span id="l8.41">         runKeyUsabilityCheck();</span>
<a href="#l8.42"></a><span id="l8.42">       }</span>
<a href="#l8.43"></a><span id="l8.43">       */</span>
<a href="#l8.44"></a><span id="l8.44">     }</span>
<a href="#l8.45"></a><span id="l8.45">     else {</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineat">@@ -252,17 +255,17 @@ var EnigmailKeyRing = {</span>
<a href="#l8.47"></a><span id="l8.47">           }</span>
<a href="#l8.48"></a><span id="l8.48">           else {</span>
<a href="#l8.49"></a><span id="l8.49">             if (key.getVirtualKeySize() &gt; foundKey.getVirtualKeySize())</span>
<a href="#l8.50"></a><span id="l8.50">               foundKey = key;</span>
<a href="#l8.51"></a><span id="l8.51">           }</span>
<a href="#l8.52"></a><span id="l8.52">         }</span>
<a href="#l8.53"></a><span id="l8.53">       }</span>
<a href="#l8.54"></a><span id="l8.54">     }</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineminus">-    console.debug(&quot;getSecretKeyByUserId, foundKey: &quot; + foundKey);</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineplus">+    console.debug(&quot;getSecretKeyByUserId, foundKey: %o&quot;, foundKey);</span>
<a href="#l8.57"></a><span id="l8.57">     return foundKey;</span>
<a href="#l8.58"></a><span id="l8.58">   },</span>
<a href="#l8.59"></a><span id="l8.59"> </span>
<a href="#l8.60"></a><span id="l8.60">   /**</span>
<a href="#l8.61"></a><span id="l8.61">    * get a list of keys for a given set of (sub-) key IDs</span>
<a href="#l8.62"></a><span id="l8.62">    *</span>
<a href="#l8.63"></a><span id="l8.63">    * @param keyIdList: Array of key IDs</span>
<a href="#l8.64"></a><span id="l8.64">                        OR String, with space-separated list of key IDs</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineat">@@ -386,18 +389,44 @@ var EnigmailKeyRing = {</span>
<a href="#l8.66"></a><span id="l8.66">    * @param userId            String   - space or comma separated list of keys to export. Specification by</span>
<a href="#l8.67"></a><span id="l8.67">    *                                     key ID, fingerprint, or userId</span>
<a href="#l8.68"></a><span id="l8.68">    * @param outputFile        String or nsIFile - output file name or Object - or NULL</span>
<a href="#l8.69"></a><span id="l8.69">    * @param exitCodeObj       Object   - o.value will contain exit code</span>
<a href="#l8.70"></a><span id="l8.70">    * @param errorMsgObj       Object   - o.value will contain error message from GnuPG</span>
<a href="#l8.71"></a><span id="l8.71">    *</span>
<a href="#l8.72"></a><span id="l8.72">    * @return String - if outputFile is NULL, the key block data; &quot;&quot; if a file is written</span>
<a href="#l8.73"></a><span id="l8.73">    */</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineminus">-  extractKey: function(includeSecretKey, userId, outputFile, exitCodeObj, errorMsgObj) {</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineminus">-    EnigmailLog.DEBUG(&quot;keyRing.jsm: EnigmailKeyRing.extractKey: &quot; + userId + &quot;\n&quot;);</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineplus">+  extractKey: function(includeSecretKey, id, outputFile, exitCodeObj, errorMsgObj) {</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineplus">+    EnigmailLog.DEBUG(&quot;keyRing.jsm: EnigmailKeyRing.extractKey: &quot; + id + &quot;\n&quot;);</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineplus">+    exitCodeObj.value = -1;</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineplus">+</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineplus">+    console.debug(&quot;keyRing.jsm: EnigmailKeyRing.extractKey: type of parameter id:&quot;);</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineplus">+    console.debug(typeof id);</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineplus">+    console.debug(id);</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineplus">+    </span>
<a href="#l8.84"></a><span id="l8.84" class="difflineplus">+    if (includeSecretKey) {</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineplus">+      throw &quot;extractKey with secret key not implemented&quot;;</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineplus">+    }</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineplus">+    </span>
<a href="#l8.88"></a><span id="l8.88" class="difflineplus">+    if (!id.length) {</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineplus">+        return &quot;&quot;;</span>
<a href="#l8.90"></a><span id="l8.90" class="difflineplus">+    }</span>
<a href="#l8.91"></a><span id="l8.91" class="difflineplus">+    </span>
<a href="#l8.92"></a><span id="l8.92" class="difflineplus">+    if (id.length &gt; 1) {</span>
<a href="#l8.93"></a><span id="l8.93" class="difflineplus">+      throw &quot;keyRing.jsm: EnigmailKeyRing.extractKey: multiple IDs not yet implemented&quot;;</span>
<a href="#l8.94"></a><span id="l8.94" class="difflineplus">+    }</span>
<a href="#l8.95"></a><span id="l8.95" class="difflineplus">+</span>
<a href="#l8.96"></a><span id="l8.96" class="difflineplus">+    const cApi = EnigmailCryptoAPI();</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineplus">+    let keyBlock = cApi.sync(cApi.getPublicKey(id[0]));</span>
<a href="#l8.98"></a><span id="l8.98" class="difflineplus">+    if (!keyBlock) {</span>
<a href="#l8.99"></a><span id="l8.99" class="difflineplus">+      errorMsgObj.value = EnigmailLocale.getString(&quot;failKeyExtract&quot;);</span>
<a href="#l8.100"></a><span id="l8.100" class="difflineplus">+      return &quot;&quot;;</span>
<a href="#l8.101"></a><span id="l8.101" class="difflineplus">+    }</span>
<a href="#l8.102"></a><span id="l8.102" class="difflineplus">+</span>
<a href="#l8.103"></a><span id="l8.103" class="difflineplus">+    /*</span>
<a href="#l8.104"></a><span id="l8.104">     let args = EnigmailGpg.getStandardArgs(true).concat([&quot;-a&quot;, &quot;--export&quot;]);</span>
<a href="#l8.105"></a><span id="l8.105"> </span>
<a href="#l8.106"></a><span id="l8.106">     if (userId) {</span>
<a href="#l8.107"></a><span id="l8.107">       args = args.concat(userId.split(/[ ,\t]+/));</span>
<a href="#l8.108"></a><span id="l8.108">     }</span>
<a href="#l8.109"></a><span id="l8.109"> </span>
<a href="#l8.110"></a><span id="l8.110">     const cmdErrorMsgObj = {};</span>
<a href="#l8.111"></a><span id="l8.111">     let keyBlock = EnigmailExecution.execCmd(EnigmailGpg.agentPath, args, &quot;&quot;, exitCodeObj, {}, {}, cmdErrorMsgObj);</span>
<a href="#l8.112"></a><span id="l8.112" class="difflineat">@@ -440,17 +469,19 @@ var EnigmailKeyRing = {</span>
<a href="#l8.113"></a><span id="l8.113">         }</span>
<a href="#l8.114"></a><span id="l8.114">         else {</span>
<a href="#l8.115"></a><span id="l8.115">           return &quot;&quot;;</span>
<a href="#l8.116"></a><span id="l8.116">         }</span>
<a href="#l8.117"></a><span id="l8.117">       }).join(&quot;\n&quot;);</span>
<a href="#l8.118"></a><span id="l8.118"> </span>
<a href="#l8.119"></a><span id="l8.119">       keyBlock += &quot;\n&quot; + secKeyBlock;</span>
<a href="#l8.120"></a><span id="l8.120">     }</span>
<a href="#l8.121"></a><span id="l8.121" class="difflineplus">+    */</span>
<a href="#l8.122"></a><span id="l8.122"> </span>
<a href="#l8.123"></a><span id="l8.123" class="difflineplus">+    exitCodeObj.value = 0;</span>
<a href="#l8.124"></a><span id="l8.124">     if (outputFile) {</span>
<a href="#l8.125"></a><span id="l8.125">       if (!EnigmailFiles.writeFileContents(outputFile, keyBlock, DEFAULT_FILE_PERMS)) {</span>
<a href="#l8.126"></a><span id="l8.126">         exitCodeObj.value = -1;</span>
<a href="#l8.127"></a><span id="l8.127">         errorMsgObj.value = EnigmailLocale.getString(&quot;fileWriteFailed&quot;, [outputFile]);</span>
<a href="#l8.128"></a><span id="l8.128">       }</span>
<a href="#l8.129"></a><span id="l8.129">       return &quot;&quot;;</span>
<a href="#l8.130"></a><span id="l8.130">     }</span>
<a href="#l8.131"></a><span id="l8.131">     return keyBlock;</span>
<a href="#l8.132"></a><span id="l8.132" class="difflineat">@@ -714,16 +745,18 @@ var EnigmailKeyRing = {</span>
<a href="#l8.133"></a><span id="l8.133">         inputData += &quot;%no-protection\n&quot;;</span>
<a href="#l8.134"></a><span id="l8.134">       }</span>
<a href="#l8.135"></a><span id="l8.135">     }</span>
<a href="#l8.136"></a><span id="l8.136"> </span>
<a href="#l8.137"></a><span id="l8.137">     inputData += &quot;%commit\n%echo done\n&quot;;</span>
<a href="#l8.138"></a><span id="l8.138"> </span>
<a href="#l8.139"></a><span id="l8.139">     let proc = null;</span>
<a href="#l8.140"></a><span id="l8.140"> </span>
<a href="#l8.141"></a><span id="l8.141" class="difflineplus">+    console.debug(&quot;reaching disabled keyRing.generateKey&quot;);</span>
<a href="#l8.142"></a><span id="l8.142" class="difflineplus">+    /*</span>
<a href="#l8.143"></a><span id="l8.143">     try {</span>
<a href="#l8.144"></a><span id="l8.144">       proc = subprocess.call({</span>
<a href="#l8.145"></a><span id="l8.145">         command: EnigmailGpg.agentPath,</span>
<a href="#l8.146"></a><span id="l8.146">         arguments: args,</span>
<a href="#l8.147"></a><span id="l8.147">         environment: EnigmailCore.getEnvList(),</span>
<a href="#l8.148"></a><span id="l8.148">         charset: null,</span>
<a href="#l8.149"></a><span id="l8.149">         stdin: function(pipe) {</span>
<a href="#l8.150"></a><span id="l8.150">           pipe.write(inputData);</span>
<a href="#l8.151"></a><span id="l8.151" class="difflineat">@@ -751,16 +784,17 @@ var EnigmailKeyRing = {</span>
<a href="#l8.152"></a><span id="l8.152">         },</span>
<a href="#l8.153"></a><span id="l8.153">         mergeStderr: false</span>
<a href="#l8.154"></a><span id="l8.154">       });</span>
<a href="#l8.155"></a><span id="l8.155">     }</span>
<a href="#l8.156"></a><span id="l8.156">     catch (ex) {</span>
<a href="#l8.157"></a><span id="l8.157">       EnigmailLog.ERROR(&quot;keyRing.jsm: generateKey: subprocess.call failed with '&quot; + ex.toString() + &quot;'\n&quot;);</span>
<a href="#l8.158"></a><span id="l8.158">       throw ex;</span>
<a href="#l8.159"></a><span id="l8.159">     }</span>
<a href="#l8.160"></a><span id="l8.160" class="difflineplus">+    */</span>
<a href="#l8.161"></a><span id="l8.161"> </span>
<a href="#l8.162"></a><span id="l8.162">     gKeygenProcess = proc;</span>
<a href="#l8.163"></a><span id="l8.163"> </span>
<a href="#l8.164"></a><span id="l8.164">     EnigmailLog.DEBUG(&quot;keyRing.jsm: generateKey: subprocess = &quot; + proc + &quot;\n&quot;);</span>
<a href="#l8.165"></a><span id="l8.165"> </span>
<a href="#l8.166"></a><span id="l8.166">     return proc;</span>
<a href="#l8.167"></a><span id="l8.167">   },</span>
<a href="#l8.168"></a><span id="l8.168"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/mimeDecrypt.jsm</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/mimeDecrypt.jsm</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -132,21 +132,17 @@ function MimeDecryptHandler() {</span>
<a href="#l9.4"></a><span id="l9.4">   this.statusDisplayed = false;</span>
<a href="#l9.5"></a><span id="l9.5">   this.uri = null;</span>
<a href="#l9.6"></a><span id="l9.6">   this.backgroundJob = false;</span>
<a href="#l9.7"></a><span id="l9.7">   this.decryptedHeaders = {};</span>
<a href="#l9.8"></a><span id="l9.8">   this.mimePartNumber = &quot;&quot;;</span>
<a href="#l9.9"></a><span id="l9.9">   this.dataIsBase64 = null;</span>
<a href="#l9.10"></a><span id="l9.10">   this.base64Cache = &quot;&quot;;</span>
<a href="#l9.11"></a><span id="l9.11"> </span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-  if (EnigmailCompat.isMessageUriInPgpMime()) {</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-    this.onDataAvailable = this.onDataAvailable68;</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineminus">-  } else {</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineminus">-    this.onDataAvailable = this.onDataAvailable60;</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineminus">-  }</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+  this.onDataAvailable = this.onDataAvailable68;</span>
<a href="#l9.18"></a><span id="l9.18"> }</span>
<a href="#l9.19"></a><span id="l9.19"> </span>
<a href="#l9.20"></a><span id="l9.20"> MimeDecryptHandler.prototype = {</span>
<a href="#l9.21"></a><span id="l9.21">   inStream: Cc[&quot;@mozilla.org/scriptableinputstream;1&quot;].createInstance(Ci.nsIScriptableInputStream),</span>
<a href="#l9.22"></a><span id="l9.22"> </span>
<a href="#l9.23"></a><span id="l9.23">   onStartRequest: function(request, uri) {</span>
<a href="#l9.24"></a><span id="l9.24">     if (!EnigmailCore.getService()) // Ensure Enigmail is initialized</span>
<a href="#l9.25"></a><span id="l9.25">       return;</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineat">@@ -245,49 +241,16 @@ MimeDecryptHandler.prototype = {</span>
<a href="#l9.27"></a><span id="l9.27">         } else {</span>
<a href="#l9.28"></a><span id="l9.28">           this.cacheData(data);</span>
<a href="#l9.29"></a><span id="l9.29">         }</span>
<a href="#l9.30"></a><span id="l9.30">       }</span>
<a href="#l9.31"></a><span id="l9.31">     }</span>
<a href="#l9.32"></a><span id="l9.32">   },</span>
<a href="#l9.33"></a><span id="l9.33"> </span>
<a href="#l9.34"></a><span id="l9.34">   /**</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineminus">-   * onDataAvailable for TB &lt;= 66</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineminus">-   */</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineminus">-  onDataAvailable60: function(req, dummy, stream, offset, count) {</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineminus">-</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineminus">-    // get data from libmime</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineminus">-    if (!this.initOk) return;</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineminus">-    this.inStream.init(stream);</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineminus">-</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineminus">-    if (count &gt; 0) {</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineminus">-      var data = this.inStream.read(count);</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineminus">-</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineminus">-      if (this.mimePartCount == 0 &amp;&amp; this.dataIsBase64 === null) {</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineminus">-        // try to determine if this could be a base64 encoded message part</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineminus">-        this.dataIsBase64 = this.isBase64Encoding(data);</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineminus">-      }</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineminus">-</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineminus">-      if (!this.dataIsBase64) {</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineminus">-        if (data.search(/[\r\n][^\r\n]+[\r\n]/) &gt;= 0) {</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineminus">-          // process multi-line data line by line</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineminus">-          let lines = data.replace(/\r\n/g, &quot;\n&quot;).split(/\n/);</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineminus">-</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineminus">-          for (let i = 0; i &lt; lines.length; i++) {</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineminus">-            this.processData(lines[i] + &quot;\r\n&quot;);</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineminus">-          }</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineminus">-        } else</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineminus">-          this.processData(data);</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineminus">-      } else {</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineminus">-        this.base64Cache += data;</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineminus">-      }</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineminus">-    }</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineminus">-  },</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineminus">-</span>
<a href="#l9.67"></a><span id="l9.67" class="difflineminus">-  /**</span>
<a href="#l9.68"></a><span id="l9.68">    * onDataAvailable for TB &gt;= 68</span>
<a href="#l9.69"></a><span id="l9.69">    */</span>
<a href="#l9.70"></a><span id="l9.70">   onDataAvailable68: function(req, stream, offset, count) {</span>
<a href="#l9.71"></a><span id="l9.71"> </span>
<a href="#l9.72"></a><span id="l9.72">     // get data from libmime</span>
<a href="#l9.73"></a><span id="l9.73">     if (!this.initOk) return;</span>
<a href="#l9.74"></a><span id="l9.74">     this.inStream.init(stream);</span>
<a href="#l9.75"></a><span id="l9.75"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/mimeEncrypt.jsm</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/mimeEncrypt.jsm</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -39,36 +39,33 @@ const kSmimeComposeSecureCID = &quot;{dd75320</span>
<a href="#l10.4"></a><span id="l10.4"> const maxBufferLen = 102400;</span>
<a href="#l10.5"></a><span id="l10.5"> const MIME_SIGNED = 1;</span>
<a href="#l10.6"></a><span id="l10.6"> const MIME_ENCRYPTED = 2;</span>
<a href="#l10.7"></a><span id="l10.7"> </span>
<a href="#l10.8"></a><span id="l10.8"> var gDebugLogLevel = 0;</span>
<a href="#l10.9"></a><span id="l10.9"> </span>
<a href="#l10.10"></a><span id="l10.10"> function PgpMimeEncrypt(sMimeSecurityInfo) {</span>
<a href="#l10.11"></a><span id="l10.11">   this.wrappedJSObject = this;</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+  console.debug(`in PgpMimeEncrypt: wrappedJSObject:`);</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+  console.debug(this);</span>
<a href="#l10.14"></a><span id="l10.14"> </span>
<a href="#l10.15"></a><span id="l10.15">   // nsIMsgSMIMECompFields</span>
<a href="#l10.16"></a><span id="l10.16">   this.signMessage = false;</span>
<a href="#l10.17"></a><span id="l10.17">   this.requireEncryptMessage = false;</span>
<a href="#l10.18"></a><span id="l10.18"> </span>
<a href="#l10.19"></a><span id="l10.19">   // &quot;securityInfo&quot; variables</span>
<a href="#l10.20"></a><span id="l10.20">   this.sendFlags = 0;</span>
<a href="#l10.21"></a><span id="l10.21">   this.UIFlags = 0;</span>
<a href="#l10.22"></a><span id="l10.22">   this.senderEmailAddr = &quot;&quot;;</span>
<a href="#l10.23"></a><span id="l10.23">   this.recipients = &quot;&quot;;</span>
<a href="#l10.24"></a><span id="l10.24">   this.bccRecipients = &quot;&quot;;</span>
<a href="#l10.25"></a><span id="l10.25">   this.originalSubject = null;</span>
<a href="#l10.26"></a><span id="l10.26">   this.keyMap = {};</span>
<a href="#l10.27"></a><span id="l10.27"> </span>
<a href="#l10.28"></a><span id="l10.28" class="difflineminus">-  if (EnigmailCompat.isMessageUriInPgpMime()) {</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineminus">-    this.onDataAvailable = this.onDataAvailable68;</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineminus">-  }</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineminus">-  else {</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineminus">-    this.onDataAvailable = this.onDataAvailable60;</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineminus">-  }</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineplus">+  this.onDataAvailable = this.onDataAvailable68;</span>
<a href="#l10.35"></a><span id="l10.35"> </span>
<a href="#l10.36"></a><span id="l10.36">   try {</span>
<a href="#l10.37"></a><span id="l10.37">     if (sMimeSecurityInfo) {</span>
<a href="#l10.38"></a><span id="l10.38">       if (&quot;nsIMsgSMIMECompFields&quot; in Ci) {</span>
<a href="#l10.39"></a><span id="l10.39">         sMimeSecurityInfo = sMimeSecurityInfo.QueryInterface(Ci.nsIMsgSMIMECompFields);</span>
<a href="#l10.40"></a><span id="l10.40">       }</span>
<a href="#l10.41"></a><span id="l10.41">       this.signMessage = sMimeSecurityInfo.signMessage;</span>
<a href="#l10.42"></a><span id="l10.42">       this.requireEncryptMessage = sMimeSecurityInfo.requireEncryptMessage;</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineat">@@ -76,28 +73,21 @@ function PgpMimeEncrypt(sMimeSecurityInf</span>
<a href="#l10.44"></a><span id="l10.44">   }</span>
<a href="#l10.45"></a><span id="l10.45">   catch (ex) {}</span>
<a href="#l10.46"></a><span id="l10.46"> }</span>
<a href="#l10.47"></a><span id="l10.47"> </span>
<a href="#l10.48"></a><span id="l10.48"> PgpMimeEncrypt.prototype = {</span>
<a href="#l10.49"></a><span id="l10.49">   classDescription: &quot;Enigmail JS Encryption Handler&quot;,</span>
<a href="#l10.50"></a><span id="l10.50">   classID: PGPMIME_ENCRYPT_CID,</span>
<a href="#l10.51"></a><span id="l10.51">   get contractID() {</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineminus">-    if (Components.classesByID &amp;&amp; Components.classesByID[kSmimeComposeSecureCID]) {</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineminus">-      // hack needed for TB &lt; 62: we overwrite the S/MIME encryption handler</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineminus">-      return SMIME_ENCRYPT_CONTRACTID;</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineminus">-    }</span>
<a href="#l10.56"></a><span id="l10.56" class="difflineminus">-    else {</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineminus">-      return PGPMIME_ENCRYPT_CONTRACTID;</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineminus">-    }</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineplus">+    return PGPMIME_ENCRYPT_CONTRACTID;</span>
<a href="#l10.60"></a><span id="l10.60">   },</span>
<a href="#l10.61"></a><span id="l10.61">   QueryInterface: EnigmailCompat.generateQI([</span>
<a href="#l10.62"></a><span id="l10.62">     &quot;nsIMsgComposeSecure&quot;,</span>
<a href="#l10.63"></a><span id="l10.63">     &quot;nsIStreamListener&quot;,</span>
<a href="#l10.64"></a><span id="l10.64" class="difflineminus">-    &quot;nsIMsgSMIMECompFields&quot; // TB &lt; 64</span>
<a href="#l10.65"></a><span id="l10.65">   ]),</span>
<a href="#l10.66"></a><span id="l10.66"> </span>
<a href="#l10.67"></a><span id="l10.67">   signMessage: false,</span>
<a href="#l10.68"></a><span id="l10.68">   requireEncryptMessage: false,</span>
<a href="#l10.69"></a><span id="l10.69"> </span>
<a href="#l10.70"></a><span id="l10.70">   // private variables</span>
<a href="#l10.71"></a><span id="l10.71"> </span>
<a href="#l10.72"></a><span id="l10.72">   inStream: Cc[&quot;@mozilla.org/scriptableinputstream;1&quot;].createInstance(Ci.nsIScriptableInputStream),</span>
<a href="#l10.73"></a><span id="l10.73" class="difflineat">@@ -165,40 +155,18 @@ PgpMimeEncrypt.prototype = {</span>
<a href="#l10.74"></a><span id="l10.74">     this.useSmime = false;</span>
<a href="#l10.75"></a><span id="l10.75">     this.checkSMime = false;</span>
<a href="#l10.76"></a><span id="l10.76">   },</span>
<a href="#l10.77"></a><span id="l10.77"> </span>
<a href="#l10.78"></a><span id="l10.78">   // nsIMsgComposeSecure interface</span>
<a href="#l10.79"></a><span id="l10.79">   requiresCryptoEncapsulation: function(msgIdentity, msgCompFields) {</span>
<a href="#l10.80"></a><span id="l10.80">     EnigmailLog.DEBUG(&quot;mimeEncrypt.js: requiresCryptoEncapsulation\n&quot;);</span>
<a href="#l10.81"></a><span id="l10.81">     try {</span>
<a href="#l10.82"></a><span id="l10.82" class="difflineminus">-        if (Components.classesByID &amp;&amp; kSmimeComposeSecureCID in Components.classesByID) {</span>
<a href="#l10.83"></a><span id="l10.83" class="difflineminus">-          // TB &lt; 64</span>
<a href="#l10.84"></a><span id="l10.84" class="difflineminus">-          if (this.checkSMime) {</span>
<a href="#l10.85"></a><span id="l10.85" class="difflineminus">-            // Remember to use original CID, not CONTRACTID, to avoid infinite looping!</span>
<a href="#l10.86"></a><span id="l10.86" class="difflineminus">-            this.smimeCompose = Components.classesByID[kSmimeComposeSecureCID].createInstance(Ci.nsIMsgComposeSecure);</span>
<a href="#l10.87"></a><span id="l10.87" class="difflineminus">-            this.useSmime = this.smimeCompose.requiresCryptoEncapsulation(msgIdentity, msgCompFields);</span>
<a href="#l10.88"></a><span id="l10.88" class="difflineminus">-          }</span>
<a href="#l10.89"></a><span id="l10.89" class="difflineminus">-</span>
<a href="#l10.90"></a><span id="l10.90" class="difflineminus">-          if (this.useSmime) return true;</span>
<a href="#l10.91"></a><span id="l10.91" class="difflineminus">-</span>
<a href="#l10.92"></a><span id="l10.92" class="difflineminus">-          if (msgCompFields.securityInfo) {</span>
<a href="#l10.93"></a><span id="l10.93" class="difflineminus">-            let securityInfo = msgCompFields.securityInfo.wrappedJSObject;</span>
<a href="#l10.94"></a><span id="l10.94" class="difflineminus">-            if (!securityInfo) return false;</span>
<a href="#l10.95"></a><span id="l10.95" class="difflineminus">-</span>
<a href="#l10.96"></a><span id="l10.96" class="difflineminus">-            for (let prop of [&quot;sendFlags&quot;, &quot;UIFlags&quot;, &quot;senderEmailAddr&quot;, &quot;recipients&quot;, &quot;bccRecipients&quot;, &quot;originalSubject&quot;, &quot;keyMap&quot;]) {</span>
<a href="#l10.97"></a><span id="l10.97" class="difflineminus">-              this[prop] = securityInfo[prop];</span>
<a href="#l10.98"></a><span id="l10.98" class="difflineminus">-            }</span>
<a href="#l10.99"></a><span id="l10.99" class="difflineminus">-          }</span>
<a href="#l10.100"></a><span id="l10.100" class="difflineminus">-          else return false;</span>
<a href="#l10.101"></a><span id="l10.101" class="difflineminus">-        }</span>
<a href="#l10.102"></a><span id="l10.102" class="difflineminus">-        else {</span>
<a href="#l10.103"></a><span id="l10.103" class="difflineminus">-          // TB &gt;= 64: we are not called for S/MIME</span>
<a href="#l10.104"></a><span id="l10.104" class="difflineminus">-          this.disableSMimeCheck();</span>
<a href="#l10.105"></a><span id="l10.105" class="difflineminus">-        }</span>
<a href="#l10.106"></a><span id="l10.106" class="difflineplus">+        // TB &gt;= 64: we are not called for S/MIME</span>
<a href="#l10.107"></a><span id="l10.107" class="difflineplus">+        this.disableSMimeCheck();</span>
<a href="#l10.108"></a><span id="l10.108"> </span>
<a href="#l10.109"></a><span id="l10.109">         return (this.sendFlags &amp; (EnigmailConstants.SEND_SIGNED |</span>
<a href="#l10.110"></a><span id="l10.110">           EnigmailConstants.SEND_ENCRYPTED |</span>
<a href="#l10.111"></a><span id="l10.111">           EnigmailConstants.SEND_VERBATIM)) !== 0;</span>
<a href="#l10.112"></a><span id="l10.112">     }</span>
<a href="#l10.113"></a><span id="l10.113">     catch (ex) {</span>
<a href="#l10.114"></a><span id="l10.114">       EnigmailLog.writeException(&quot;mimeEncrypt.js&quot;, ex);</span>
<a href="#l10.115"></a><span id="l10.115">       throw (ex);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/mimeVerify.jsm</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/mimeVerify.jsm</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -38,21 +38,17 @@ function MimeVerify(protocol) {</span>
<a href="#l11.4"></a><span id="l11.4">   }</span>
<a href="#l11.5"></a><span id="l11.5"> </span>
<a href="#l11.6"></a><span id="l11.6">   this.protocol = protocol;</span>
<a href="#l11.7"></a><span id="l11.7">   this.verifyEmbedded = false;</span>
<a href="#l11.8"></a><span id="l11.8">   this.partiallySigned = false;</span>
<a href="#l11.9"></a><span id="l11.9">   this.exitCode = null;</span>
<a href="#l11.10"></a><span id="l11.10">   this.inStream = Cc[&quot;@mozilla.org/scriptableinputstream;1&quot;].createInstance(Ci.nsIScriptableInputStream);</span>
<a href="#l11.11"></a><span id="l11.11"> </span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-  if (EnigmailCompat.isMessageUriInPgpMime()) {</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-    this.onDataAvailable = this.onDataAvailable68;</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineminus">-  } else {</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineminus">-    this.onDataAvailable = this.onDataAvailable60;</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineminus">-  }</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineplus">+  this.onDataAvailable = this.onDataAvailable68;</span>
<a href="#l11.18"></a><span id="l11.18"> }</span>
<a href="#l11.19"></a><span id="l11.19"> </span>
<a href="#l11.20"></a><span id="l11.20"> </span>
<a href="#l11.21"></a><span id="l11.21"> var EnigmailVerify = {</span>
<a href="#l11.22"></a><span id="l11.22">   lastMsgWindow: null,</span>
<a href="#l11.23"></a><span id="l11.23">   lastMsgUri: null,</span>
<a href="#l11.24"></a><span id="l11.24">   manualMsgUri: null,</span>
<a href="#l11.25"></a><span id="l11.25"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/pgpmimeHandler.jsm</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/pgpmimeHandler.jsm</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -78,22 +78,17 @@ UnknownProtoHandler.prototype = {</span>
<a href="#l12.4"></a><span id="l12.4">         0: before message</span>
<a href="#l12.5"></a><span id="l12.5">         1: inside message</span>
<a href="#l12.6"></a><span id="l12.6">         2: afer message</span>
<a href="#l12.7"></a><span id="l12.7">     */</span>
<a href="#l12.8"></a><span id="l12.8">     this.readMode = 0;</span>
<a href="#l12.9"></a><span id="l12.9">   },</span>
<a href="#l12.10"></a><span id="l12.10"> </span>
<a href="#l12.11"></a><span id="l12.11">   onDataAvailable: function(p1, p2, p3, p4) {</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-    if (EnigmailCompat.isMessageUriInPgpMime()) {</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineminus">-      this.processData(p1, p2, p3, p4);</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineminus">-    }</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineminus">-    else {</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineminus">-      this.processData(p1, null, p2, p3, p4);</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineminus">-    }</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineplus">+    this.processData(p1, p2, p3, p4);</span>
<a href="#l12.19"></a><span id="l12.19">   },</span>
<a href="#l12.20"></a><span id="l12.20"> </span>
<a href="#l12.21"></a><span id="l12.21">   processData: function (req, stream, offset, count) {</span>
<a href="#l12.22"></a><span id="l12.22">     if (count &gt; 0) {</span>
<a href="#l12.23"></a><span id="l12.23">       inStream.init(stream);</span>
<a href="#l12.24"></a><span id="l12.24">       let data = inStream.read(count);</span>
<a href="#l12.25"></a><span id="l12.25">       let l = data.replace(/\r\n/g, &quot;\n&quot;).split(/\n/);</span>
<a href="#l12.26"></a><span id="l12.26"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/rnp.jsm</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/rnp.jsm</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -612,47 +612,55 @@ var RNP = {</span>
<a href="#l13.4"></a><span id="l13.4">     }</span>
<a href="#l13.5"></a><span id="l13.5"> </span>
<a href="#l13.6"></a><span id="l13.6">     RNPLib.rnp_key_handle_destroy(handle);</span>
<a href="#l13.7"></a><span id="l13.7">     this.saveKeyRings();</span>
<a href="#l13.8"></a><span id="l13.8">   },</span>
<a href="#l13.9"></a><span id="l13.9"> </span>
<a href="#l13.10"></a><span id="l13.10">   getKeyHandleByIdentifier(id) {</span>
<a href="#l13.11"></a><span id="l13.11">     console.debug(&quot;getKeyHandleByIdentifier searching for: &quot; + id);</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+    let key = null;</span>
<a href="#l13.13"></a><span id="l13.13">     </span>
<a href="#l13.14"></a><span id="l13.14">     if (id.startsWith(&quot;&lt;&quot;)) {</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineminus">-      throw &quot;search by email address not yet implemented: &quot; + id;</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineminus">-    }</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineminus">-    if (!id.startsWith(&quot;0x&quot;)) {</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineminus">-      throw &quot;unexpected identifier &quot; + id;</span>
<a href="#l13.19"></a><span id="l13.19" class="difflineminus">-    }</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineminus">-    // remove 0x</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineminus">-    id = id.substring(2);</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineplus">+      //throw &quot;search by email address not yet implemented: &quot; + id;</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineplus">+      if (!id.endsWith(&quot;&gt;&quot;)) {</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineplus">+        throw &quot;if search identifier starts with &lt; then it must end with &gt; : &quot; + id;</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineplus">+      }</span>
<a href="#l13.26"></a><span id="l13.26" class="difflineplus">+      key = this.findKeyByEmail(id);</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineplus">+    } else {</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineplus">+      if (!id.startsWith(&quot;0x&quot;)) {</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineplus">+        throw &quot;unexpected identifier &quot; + id;</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineplus">+      } else {</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineplus">+        // remove 0x</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineplus">+        id = id.substring(2);</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineplus">+      }</span>
<a href="#l13.34"></a><span id="l13.34"> </span>
<a href="#l13.35"></a><span id="l13.35" class="difflineminus">-    let type;</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineminus">-    if (id.length == 16) {</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineminus">-      type = &quot;keyid&quot;;</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineminus">-    } else if (id.length == 40) {</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineminus">-      type = &quot;fingerprint&quot;;</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineminus">-    } else {</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineminus">-      throw &quot;key/fingerprint identifier of unexpected length: &quot; + id;</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineminus">-    }</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineplus">+      let type = null;</span>
<a href="#l13.44"></a><span id="l13.44" class="difflineplus">+      if (id.length == 16) {</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineplus">+        type = &quot;keyid&quot;;</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineplus">+      } else if (id.length == 40) {</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineplus">+        type = &quot;fingerprint&quot;;</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineplus">+      } else {</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineplus">+        throw &quot;key/fingerprint identifier of unexpected length: &quot; + id;</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineplus">+      }</span>
<a href="#l13.51"></a><span id="l13.51"> </span>
<a href="#l13.52"></a><span id="l13.52" class="difflineminus">-    let key = new RNPLib.rnp_key_handle_t;</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineminus">-    if (RNPLib.rnp_locate_key(RNPLib.ffi, type, id, key.address())) {</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineminus">-      throw &quot;rnp_locate_key failed, &quot; + type + &quot;, &quot; + id;</span>
<a href="#l13.55"></a><span id="l13.55" class="difflineplus">+      key = new RNPLib.rnp_key_handle_t;</span>
<a href="#l13.56"></a><span id="l13.56" class="difflineplus">+      if (RNPLib.rnp_locate_key(RNPLib.ffi, type, id, key.address())) {</span>
<a href="#l13.57"></a><span id="l13.57" class="difflineplus">+        throw &quot;rnp_locate_key failed, &quot; + type + &quot;, &quot; + id;</span>
<a href="#l13.58"></a><span id="l13.58" class="difflineplus">+      }</span>
<a href="#l13.59"></a><span id="l13.59">     }</span>
<a href="#l13.60"></a><span id="l13.60">     </span>
<a href="#l13.61"></a><span id="l13.61" class="difflineminus">-    if (!key) {</span>
<a href="#l13.62"></a><span id="l13.62" class="difflineplus">+    if (key.isNull()) {</span>
<a href="#l13.63"></a><span id="l13.63">       console.debug(&quot;getKeyHandleByIdentifier nothing found&quot;);</span>
<a href="#l13.64"></a><span id="l13.64">     } else {</span>
<a href="#l13.65"></a><span id="l13.65">       console.debug(&quot;getKeyHandleByIdentifier found!&quot;);</span>
<a href="#l13.66"></a><span id="l13.66">       let is_subkey = new ctypes.bool;</span>
<a href="#l13.67"></a><span id="l13.67" class="difflineminus">-      if (RNPLib.rnp_key_is_sub(key, is_subkey.address())) {</span>
<a href="#l13.68"></a><span id="l13.68" class="difflineminus">-        throw &quot;rnp_key_is_sub failed&quot;;</span>
<a href="#l13.69"></a><span id="l13.69" class="difflineplus">+      let res = RNPLib.rnp_key_is_sub(key, is_subkey.address());</span>
<a href="#l13.70"></a><span id="l13.70" class="difflineplus">+      if (res) {</span>
<a href="#l13.71"></a><span id="l13.71" class="difflineplus">+        throw &quot;rnp_key_is_sub failed: &quot; + res;</span>
<a href="#l13.72"></a><span id="l13.72">       }</span>
<a href="#l13.73"></a><span id="l13.73">       console.debug(&quot;is_primary? &quot; + !is_subkey.value);</span>
<a href="#l13.74"></a><span id="l13.74">     }</span>
<a href="#l13.75"></a><span id="l13.75">     </span>
<a href="#l13.76"></a><span id="l13.76">     return key;</span>
<a href="#l13.77"></a><span id="l13.77">   },</span>
<a href="#l13.78"></a><span id="l13.78">   </span>
<a href="#l13.79"></a><span id="l13.79">   isKeyUsableFor(key, usage) {</span>
<a href="#l13.80"></a><span id="l13.80" class="difflineat">@@ -706,28 +714,28 @@ var RNP = {</span>
<a href="#l13.81"></a><span id="l13.81"> </span>
<a href="#l13.82"></a><span id="l13.82">     return found_handle;</span>
<a href="#l13.83"></a><span id="l13.83">   },</span>
<a href="#l13.84"></a><span id="l13.84"> </span>
<a href="#l13.85"></a><span id="l13.85">   addSuitableEncryptKey(key, op) {</span>
<a href="#l13.86"></a><span id="l13.86">     let use_sub = null;</span>
<a href="#l13.87"></a><span id="l13.87">     console.debug(&quot;addSuitableEncryptKey&quot;);</span>
<a href="#l13.88"></a><span id="l13.88"> </span>
<a href="#l13.89"></a><span id="l13.89" class="difflineminus">-    /* looks like this will be unnecessary</span>
<a href="#l13.90"></a><span id="l13.90" class="difflineplus">+    // looks like this will be unnecessary ???</span>
<a href="#l13.91"></a><span id="l13.91"> </span>
<a href="#l13.92"></a><span id="l13.92">     if (!this.isKeyUsableFor(key, str_encrypt)) {</span>
<a href="#l13.93"></a><span id="l13.93">       console.debug(&quot;addSuitableEncryptKey primary not usable&quot;);</span>
<a href="#l13.94"></a><span id="l13.94">       use_sub = this.getSuitableSubkey(key, str_encrypt);</span>
<a href="#l13.95"></a><span id="l13.95">       if (!use_sub) {</span>
<a href="#l13.96"></a><span id="l13.96">         throw &quot;no suitable subkey found for &quot; + str_encrypt;</span>
<a href="#l13.97"></a><span id="l13.97">       } else {</span>
<a href="#l13.98"></a><span id="l13.98">         console.debug(&quot;addSuitableEncryptKey using subkey&quot;);</span>
<a href="#l13.99"></a><span id="l13.99">       }</span>
<a href="#l13.100"></a><span id="l13.100">     }</span>
<a href="#l13.101"></a><span id="l13.101" class="difflineminus">-    */</span>
<a href="#l13.102"></a><span id="l13.102" class="difflineplus">+</span>
<a href="#l13.103"></a><span id="l13.103">     if (RNPLib.rnp_op_encrypt_add_recipient(op, (use_sub != null) ? use_sub : key)) {</span>
<a href="#l13.104"></a><span id="l13.104">       throw &quot;rnp_op_encrypt_add_recipient sender failed&quot;;</span>
<a href="#l13.105"></a><span id="l13.105">     }</span>
<a href="#l13.106"></a><span id="l13.106">     if (use_sub) {</span>
<a href="#l13.107"></a><span id="l13.107">       RNPLib.rnp_key_handle_destroy(use_sub);</span>
<a href="#l13.108"></a><span id="l13.108">     }</span>
<a href="#l13.109"></a><span id="l13.109">   },</span>
<a href="#l13.110"></a><span id="l13.110"> </span>
<a href="#l13.111"></a><span id="l13.111" class="difflineat">@@ -902,13 +910,155 @@ var RNP = {</span>
<a href="#l13.112"></a><span id="l13.112"> </span>
<a href="#l13.113"></a><span id="l13.113">     if (args.sign) {</span>
<a href="#l13.114"></a><span id="l13.114">       resultStatus.statusFlags |= EnigmailConstants.SIG_CREATED;</span>
<a href="#l13.115"></a><span id="l13.115">     }</span>
<a href="#l13.116"></a><span id="l13.116">     </span>
<a href="#l13.117"></a><span id="l13.117">     return result;</span>
<a href="#l13.118"></a><span id="l13.118">   },</span>
<a href="#l13.119"></a><span id="l13.119"> </span>
<a href="#l13.120"></a><span id="l13.120" class="difflineplus">+  findKeyByEmail(id) {</span>
<a href="#l13.121"></a><span id="l13.121" class="difflineplus">+    if (!id.startsWith(&quot;&lt;&quot;) || !id.endsWith(&quot;&gt;&quot;)) {</span>
<a href="#l13.122"></a><span id="l13.122" class="difflineplus">+      throw &quot;invalid parameter given to findKeyByEmail&quot;;</span>
<a href="#l13.123"></a><span id="l13.123" class="difflineplus">+    }</span>
<a href="#l13.124"></a><span id="l13.124" class="difflineplus">+</span>
<a href="#l13.125"></a><span id="l13.125" class="difflineplus">+    let keys = [];</span>
<a href="#l13.126"></a><span id="l13.126" class="difflineplus">+    let rv;</span>
<a href="#l13.127"></a><span id="l13.127" class="difflineplus">+</span>
<a href="#l13.128"></a><span id="l13.128" class="difflineplus">+    let iter = new RNPLib.rnp_identifier_iterator_t;</span>
<a href="#l13.129"></a><span id="l13.129" class="difflineplus">+    let grip = new ctypes.char.ptr();</span>
<a href="#l13.130"></a><span id="l13.130" class="difflineplus">+</span>
<a href="#l13.131"></a><span id="l13.131" class="difflineplus">+    rv = RNPLib.rnp_identifier_iterator_create(RNPLib.ffi, iter.address(), &quot;grip&quot;);</span>
<a href="#l13.132"></a><span id="l13.132" class="difflineplus">+    if (rv) {</span>
<a href="#l13.133"></a><span id="l13.133" class="difflineplus">+      return null;</span>
<a href="#l13.134"></a><span id="l13.134" class="difflineplus">+    }</span>
<a href="#l13.135"></a><span id="l13.135" class="difflineplus">+    </span>
<a href="#l13.136"></a><span id="l13.136" class="difflineplus">+    let foundHandle = null;</span>
<a href="#l13.137"></a><span id="l13.137" class="difflineplus">+    while (!foundHandle &amp;&amp; !RNPLib.rnp_identifier_iterator_next(iter, grip.address())) {</span>
<a href="#l13.138"></a><span id="l13.138" class="difflineplus">+      if (grip.isNull()) {</span>
<a href="#l13.139"></a><span id="l13.139" class="difflineplus">+        break;</span>
<a href="#l13.140"></a><span id="l13.140" class="difflineplus">+      }</span>
<a href="#l13.141"></a><span id="l13.141" class="difflineplus">+</span>
<a href="#l13.142"></a><span id="l13.142" class="difflineplus">+      let have_handle = false;</span>
<a href="#l13.143"></a><span id="l13.143" class="difflineplus">+      let handle = new RNPLib.rnp_key_handle_t;</span>
<a href="#l13.144"></a><span id="l13.144" class="difflineplus">+</span>
<a href="#l13.145"></a><span id="l13.145" class="difflineplus">+      try {</span>
<a href="#l13.146"></a><span id="l13.146" class="difflineplus">+        let is_subkey = new ctypes.bool;</span>
<a href="#l13.147"></a><span id="l13.147" class="difflineplus">+        let uid_count = new ctypes.size_t;</span>
<a href="#l13.148"></a><span id="l13.148" class="difflineplus">+</span>
<a href="#l13.149"></a><span id="l13.149" class="difflineplus">+        if (RNPLib.rnp_locate_key(RNPLib.ffi, &quot;grip&quot;, grip, handle.address())) {</span>
<a href="#l13.150"></a><span id="l13.150" class="difflineplus">+          throw &quot;rnp_locate_key failed&quot;;</span>
<a href="#l13.151"></a><span id="l13.151" class="difflineplus">+        }</span>
<a href="#l13.152"></a><span id="l13.152" class="difflineplus">+        have_handle = true;</span>
<a href="#l13.153"></a><span id="l13.153" class="difflineplus">+        if (RNPLib.rnp_key_is_sub(handle, is_subkey.address())) {</span>
<a href="#l13.154"></a><span id="l13.154" class="difflineplus">+          throw &quot;rnp_key_is_sub failed&quot;;</span>
<a href="#l13.155"></a><span id="l13.155" class="difflineplus">+        }</span>
<a href="#l13.156"></a><span id="l13.156" class="difflineplus">+        if (is_subkey.value) {</span>
<a href="#l13.157"></a><span id="l13.157" class="difflineplus">+          continue;</span>
<a href="#l13.158"></a><span id="l13.158" class="difflineplus">+        }</span>
<a href="#l13.159"></a><span id="l13.159" class="difflineplus">+</span>
<a href="#l13.160"></a><span id="l13.160" class="difflineplus">+        let key_revoked = new ctypes.bool;</span>
<a href="#l13.161"></a><span id="l13.161" class="difflineplus">+        if (RNPLib.rnp_key_is_revoked(handle, key_revoked.address())) {</span>
<a href="#l13.162"></a><span id="l13.162" class="difflineplus">+          throw &quot;rnp_key_is_revoked failed&quot;;</span>
<a href="#l13.163"></a><span id="l13.163" class="difflineplus">+        }</span>
<a href="#l13.164"></a><span id="l13.164" class="difflineplus">+</span>
<a href="#l13.165"></a><span id="l13.165" class="difflineplus">+        if (key_revoked.value) {</span>
<a href="#l13.166"></a><span id="l13.166" class="difflineplus">+          continue;</span>
<a href="#l13.167"></a><span id="l13.167" class="difflineplus">+        }</span>
<a href="#l13.168"></a><span id="l13.168" class="difflineplus">+</span>
<a href="#l13.169"></a><span id="l13.169" class="difflineplus">+        if (RNPLib.rnp_key_get_uid_count(handle, uid_count.address())) {</span>
<a href="#l13.170"></a><span id="l13.170" class="difflineplus">+          throw &quot;rnp_key_get_uid_count failed&quot;;</span>
<a href="#l13.171"></a><span id="l13.171" class="difflineplus">+        }</span>
<a href="#l13.172"></a><span id="l13.172" class="difflineplus">+        console.debug(&quot;rnp_key_get_uid_count: &quot; + uid_count.value);</span>
<a href="#l13.173"></a><span id="l13.173" class="difflineplus">+        for (let i = 0; i &lt; uid_count.value; i++) {</span>
<a href="#l13.174"></a><span id="l13.174" class="difflineplus">+          let uid_handle = new RNPLib.rnp_uid_handle_t;</span>
<a href="#l13.175"></a><span id="l13.175" class="difflineplus">+          let is_revoked = new ctypes.bool;</span>
<a href="#l13.176"></a><span id="l13.176" class="difflineplus">+</span>
<a href="#l13.177"></a><span id="l13.177" class="difflineplus">+          if (RNPLib.rnp_key_get_uid_handle_at(handle, i, uid_handle.address())) {</span>
<a href="#l13.178"></a><span id="l13.178" class="difflineplus">+            throw &quot;rnp_key_get_uid_handle_at failed&quot;;</span>
<a href="#l13.179"></a><span id="l13.179" class="difflineplus">+          }</span>
<a href="#l13.180"></a><span id="l13.180" class="difflineplus">+</span>
<a href="#l13.181"></a><span id="l13.181" class="difflineplus">+          if (RNPLib.rnp_uid_is_revoked(uid_handle, is_revoked.address())) {</span>
<a href="#l13.182"></a><span id="l13.182" class="difflineplus">+            throw &quot;rnp_uid_is_revoked failed&quot;;</span>
<a href="#l13.183"></a><span id="l13.183" class="difflineplus">+          }</span>
<a href="#l13.184"></a><span id="l13.184" class="difflineplus">+</span>
<a href="#l13.185"></a><span id="l13.185" class="difflineplus">+          if (!is_revoked.value) {</span>
<a href="#l13.186"></a><span id="l13.186" class="difflineplus">+            let uid_str = new ctypes.char.ptr;</span>
<a href="#l13.187"></a><span id="l13.187" class="difflineplus">+            if (RNPLib.rnp_key_get_uid_at(handle, i, uid_str.address())) {</span>
<a href="#l13.188"></a><span id="l13.188" class="difflineplus">+              throw &quot;rnp_key_get_uid_at failed&quot;;</span>
<a href="#l13.189"></a><span id="l13.189" class="difflineplus">+            }</span>
<a href="#l13.190"></a><span id="l13.190" class="difflineplus">+</span>
<a href="#l13.191"></a><span id="l13.191" class="difflineplus">+            let userId = uid_str.readString();</span>
<a href="#l13.192"></a><span id="l13.192" class="difflineplus">+            </span>
<a href="#l13.193"></a><span id="l13.193" class="difflineplus">+            if (userId.includes(id)) {</span>
<a href="#l13.194"></a><span id="l13.194" class="difflineplus">+              foundHandle = handle;</span>
<a href="#l13.195"></a><span id="l13.195" class="difflineplus">+            }</span>
<a href="#l13.196"></a><span id="l13.196" class="difflineplus">+            </span>
<a href="#l13.197"></a><span id="l13.197" class="difflineplus">+            RNPLib.rnp_buffer_destroy(uid_str);</span>
<a href="#l13.198"></a><span id="l13.198" class="difflineplus">+          }</span>
<a href="#l13.199"></a><span id="l13.199" class="difflineplus">+</span>
<a href="#l13.200"></a><span id="l13.200" class="difflineplus">+          RNPLib.rnp_uid_handle_destroy(uid_handle);</span>
<a href="#l13.201"></a><span id="l13.201" class="difflineplus">+        }</span>
<a href="#l13.202"></a><span id="l13.202" class="difflineplus">+</span>
<a href="#l13.203"></a><span id="l13.203" class="difflineplus">+      } catch (ex) {</span>
<a href="#l13.204"></a><span id="l13.204" class="difflineplus">+        console.log(ex);</span>
<a href="#l13.205"></a><span id="l13.205" class="difflineplus">+      } finally {</span>
<a href="#l13.206"></a><span id="l13.206" class="difflineplus">+        if (!foundHandle &amp;&amp; have_handle) {</span>
<a href="#l13.207"></a><span id="l13.207" class="difflineplus">+          RNPLib.rnp_key_handle_destroy(handle);</span>
<a href="#l13.208"></a><span id="l13.208" class="difflineplus">+        }</span>
<a href="#l13.209"></a><span id="l13.209" class="difflineplus">+      }</span>
<a href="#l13.210"></a><span id="l13.210" class="difflineplus">+    }</span>
<a href="#l13.211"></a><span id="l13.211" class="difflineplus">+</span>
<a href="#l13.212"></a><span id="l13.212" class="difflineplus">+    RNPLib.rnp_identifier_iterator_destroy(iter);</span>
<a href="#l13.213"></a><span id="l13.213" class="difflineplus">+    </span>
<a href="#l13.214"></a><span id="l13.214" class="difflineplus">+    return foundHandle;</span>
<a href="#l13.215"></a><span id="l13.215" class="difflineplus">+  },</span>
<a href="#l13.216"></a><span id="l13.216" class="difflineplus">+</span>
<a href="#l13.217"></a><span id="l13.217" class="difflineplus">+  getPublicKey(id) {</span>
<a href="#l13.218"></a><span id="l13.218" class="difflineplus">+    let result = &quot;&quot;;</span>
<a href="#l13.219"></a><span id="l13.219" class="difflineplus">+    let key = this.getKeyHandleByIdentifier(id);</span>
<a href="#l13.220"></a><span id="l13.220" class="difflineplus">+</span>
<a href="#l13.221"></a><span id="l13.221" class="difflineplus">+    if (key.isNull()) {</span>
<a href="#l13.222"></a><span id="l13.222" class="difflineplus">+      return result;</span>
<a href="#l13.223"></a><span id="l13.223" class="difflineplus">+    }</span>
<a href="#l13.224"></a><span id="l13.224" class="difflineplus">+</span>
<a href="#l13.225"></a><span id="l13.225" class="difflineplus">+    let flags = RNPLib.RNP_KEY_EXPORT_ARMORED | </span>
<a href="#l13.226"></a><span id="l13.226" class="difflineplus">+                RNPLib.RNP_KEY_EXPORT_PUBLIC | </span>
<a href="#l13.227"></a><span id="l13.227" class="difflineplus">+                RNPLib.RNP_KEY_EXPORT_SUBKEYS;</span>
<a href="#l13.228"></a><span id="l13.228" class="difflineplus">+</span>
<a href="#l13.229"></a><span id="l13.229" class="difflineplus">+    let output_to_memory = new RNPLib.rnp_output_t;</span>
<a href="#l13.230"></a><span id="l13.230" class="difflineplus">+    RNPLib.rnp_output_to_memory(output_to_memory.address(), 0);</span>
<a href="#l13.231"></a><span id="l13.231" class="difflineplus">+</span>
<a href="#l13.232"></a><span id="l13.232" class="difflineplus">+    if (RNPLib.rnp_key_export(key, output_to_memory, flags)) {</span>
<a href="#l13.233"></a><span id="l13.233" class="difflineplus">+      throw &quot;rnp_key_export failed&quot;;</span>
<a href="#l13.234"></a><span id="l13.234" class="difflineplus">+    }</span>
<a href="#l13.235"></a><span id="l13.235" class="difflineplus">+</span>
<a href="#l13.236"></a><span id="l13.236" class="difflineplus">+    let result_buf = new ctypes.uint8_t.ptr();</span>
<a href="#l13.237"></a><span id="l13.237" class="difflineplus">+    let result_len = new ctypes.size_t();</span>
<a href="#l13.238"></a><span id="l13.238" class="difflineplus">+    let exitCode = RNPLib.rnp_output_memory_get_buf(</span>
<a href="#l13.239"></a><span id="l13.239" class="difflineplus">+      output_to_memory,</span>
<a href="#l13.240"></a><span id="l13.240" class="difflineplus">+      result_buf.address(),</span>
<a href="#l13.241"></a><span id="l13.241" class="difflineplus">+      result_len.address(),</span>
<a href="#l13.242"></a><span id="l13.242" class="difflineplus">+      false</span>
<a href="#l13.243"></a><span id="l13.243" class="difflineplus">+    );</span>
<a href="#l13.244"></a><span id="l13.244" class="difflineplus">+    console.debug(&quot;decrypt get buffer result code: &quot; + exitCode);</span>
<a href="#l13.245"></a><span id="l13.245" class="difflineplus">+</span>
<a href="#l13.246"></a><span id="l13.246" class="difflineplus">+    if (!exitCode) {</span>
<a href="#l13.247"></a><span id="l13.247" class="difflineplus">+      console.debug(&quot;decrypt result len: &quot; + result_len.value);</span>
<a href="#l13.248"></a><span id="l13.248" class="difflineplus">+</span>
<a href="#l13.249"></a><span id="l13.249" class="difflineplus">+      let char_array = ctypes.cast(</span>
<a href="#l13.250"></a><span id="l13.250" class="difflineplus">+        result_buf,</span>
<a href="#l13.251"></a><span id="l13.251" class="difflineplus">+        ctypes.char.array(result_len.value).ptr</span>
<a href="#l13.252"></a><span id="l13.252" class="difflineplus">+      ).contents;</span>
<a href="#l13.253"></a><span id="l13.253" class="difflineplus">+</span>
<a href="#l13.254"></a><span id="l13.254" class="difflineplus">+      result = char_array.readString();</span>
<a href="#l13.255"></a><span id="l13.255" class="difflineplus">+      console.debug(result);</span>
<a href="#l13.256"></a><span id="l13.256" class="difflineplus">+    }</span>
<a href="#l13.257"></a><span id="l13.257" class="difflineplus">+</span>
<a href="#l13.258"></a><span id="l13.258" class="difflineplus">+    RNPLib.rnp_output_destroy(output_to_memory);</span>
<a href="#l13.259"></a><span id="l13.259" class="difflineplus">+    RNPLib.rnp_key_handle_destroy(key);</span>
<a href="#l13.260"></a><span id="l13.260" class="difflineplus">+    return result;</span>
<a href="#l13.261"></a><span id="l13.261" class="difflineplus">+  },</span>
<a href="#l13.262"></a><span id="l13.262"> };</span>
<a href="#l13.263"></a><span id="l13.263"> </span>
<a href="#l13.264"></a><span id="l13.264"> // exports</span>
<a href="#l13.265"></a><span id="l13.265"> </span>
<a href="#l13.266"></a><span id="l13.266"> const EXPORTED_SYMBOLS = [&quot;RNP&quot;];</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/rnpLib.jsm</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/rnpLib.jsm</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -825,16 +825,25 @@ function enableRNPLibJS() {</span>
<a href="#l14.4"></a><span id="l14.4">     </span>
<a href="#l14.5"></a><span id="l14.5">     rnp_op_encrypt_destroy: librnp.declare(</span>
<a href="#l14.6"></a><span id="l14.6">       &quot;rnp_op_encrypt_destroy&quot;,</span>
<a href="#l14.7"></a><span id="l14.7">       abi,</span>
<a href="#l14.8"></a><span id="l14.8">       rnp_result_t,</span>
<a href="#l14.9"></a><span id="l14.9">       rnp_op_encrypt_t</span>
<a href="#l14.10"></a><span id="l14.10">     ),</span>
<a href="#l14.11"></a><span id="l14.11"> </span>
<a href="#l14.12"></a><span id="l14.12" class="difflineplus">+    rnp_key_export: librnp.declare(</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+      &quot;rnp_key_export&quot;,</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+      abi,</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineplus">+      rnp_result_t,</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineplus">+      rnp_key_handle_t,</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineplus">+      rnp_output_t,</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineplus">+      ctypes.uint32_t</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineplus">+    ),</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineplus">+</span>
<a href="#l14.21"></a><span id="l14.21">     rnp_result_t,</span>
<a href="#l14.22"></a><span id="l14.22">     rnp_ffi_t,</span>
<a href="#l14.23"></a><span id="l14.23">     rnp_password_cb_t,</span>
<a href="#l14.24"></a><span id="l14.24">     rnp_input_t,</span>
<a href="#l14.25"></a><span id="l14.25">     rnp_output_t,</span>
<a href="#l14.26"></a><span id="l14.26">     rnp_key_handle_t,</span>
<a href="#l14.27"></a><span id="l14.27">     rnp_uid_handle_t,</span>
<a href="#l14.28"></a><span id="l14.28">     rnp_identifier_iterator_t,</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineat">@@ -845,15 +854,20 @@ function enableRNPLibJS() {</span>
<a href="#l14.30"></a><span id="l14.30">     </span>
<a href="#l14.31"></a><span id="l14.31">     RNP_LOAD_SAVE_PUBLIC_KEYS: 1,</span>
<a href="#l14.32"></a><span id="l14.32">     </span>
<a href="#l14.33"></a><span id="l14.33">     RNP_LOAD_SAVE_SECRET_KEYS: 2,</span>
<a href="#l14.34"></a><span id="l14.34">     </span>
<a href="#l14.35"></a><span id="l14.35">     RNP_KEY_REMOVE_PUBLIC: 1,</span>
<a href="#l14.36"></a><span id="l14.36">     </span>
<a href="#l14.37"></a><span id="l14.37">     RNP_KEY_REMOVE_SECRET: 2,</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineplus">+    </span>
<a href="#l14.39"></a><span id="l14.39" class="difflineplus">+    RNP_KEY_EXPORT_ARMORED: 1,</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineplus">+    RNP_KEY_EXPORT_PUBLIC: 2,</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineplus">+    RNP_KEY_EXPORT_SECRET: 4,</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineplus">+    RNP_KEY_EXPORT_SUBKEYS: 8,</span>
<a href="#l14.43"></a><span id="l14.43"> </span>
<a href="#l14.44"></a><span id="l14.44">   };</span>
<a href="#l14.45"></a><span id="l14.45"> }</span>
<a href="#l14.46"></a><span id="l14.46"> </span>
<a href="#l14.47"></a><span id="l14.47"> // exports</span>
<a href="#l14.48"></a><span id="l14.48"> </span>
<a href="#l14.49"></a><span id="l14.49"> const EXPORTED_SYMBOLS = [&quot;RNPLibLoader&quot;];</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/socks5Proxy.jsm</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/socks5Proxy.jsm</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -41,28 +41,20 @@ function buildListener(hasFoundTor, isDo</span>
<a href="#l15.4"></a><span id="l15.4">   let listener = {</span>
<a href="#l15.5"></a><span id="l15.5">     onStartRequest: function(request) {},</span>
<a href="#l15.6"></a><span id="l15.6">     onStopRequest: function(request, statusCode) {</span>
<a href="#l15.7"></a><span id="l15.7">       isDoneChecking();</span>
<a href="#l15.8"></a><span id="l15.8">     },</span>
<a href="#l15.9"></a><span id="l15.9">     QueryInterface: EnigmailCompat.generateQI([&quot;nsIRequestObserver&quot;, &quot;nsIStreamListener&quot;])</span>
<a href="#l15.10"></a><span id="l15.10">   };</span>
<a href="#l15.11"></a><span id="l15.11"> </span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-  if (EnigmailCompat.isMessageUriInPgpMime()) {</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineminus">-    // TB &gt;= 67</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineminus">-    listener.onDataAvailable = function(request, inputStream, offset, count) {</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineminus">-      const response = createScriptableInputStream(inputStream).read(count);</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineminus">-      hasFoundTor(response.indexOf(EXPECTED_TOR_EXISTS_RESPONSE) !== -1);</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineminus">-    };</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineminus">-  } else {</span>
<a href="#l15.19"></a><span id="l15.19" class="difflineminus">-    listener.onDataAvailable = function(request, ctxt, inputStream, offset, count) {</span>
<a href="#l15.20"></a><span id="l15.20" class="difflineminus">-      const response = createScriptableInputStream(inputStream).read(count);</span>
<a href="#l15.21"></a><span id="l15.21" class="difflineminus">-      hasFoundTor(response.indexOf(EXPECTED_TOR_EXISTS_RESPONSE) !== -1);</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineminus">-    };</span>
<a href="#l15.23"></a><span id="l15.23" class="difflineminus">-  }</span>
<a href="#l15.24"></a><span id="l15.24" class="difflineplus">+  listener.onDataAvailable = function(request, inputStream, offset, count) {</span>
<a href="#l15.25"></a><span id="l15.25" class="difflineplus">+    const response = createScriptableInputStream(inputStream).read(count);</span>
<a href="#l15.26"></a><span id="l15.26" class="difflineplus">+    hasFoundTor(response.indexOf(EXPECTED_TOR_EXISTS_RESPONSE) !== -1);</span>
<a href="#l15.27"></a><span id="l15.27" class="difflineplus">+  };</span>
<a href="#l15.28"></a><span id="l15.28"> </span>
<a href="#l15.29"></a><span id="l15.29">   return listener;</span>
<a href="#l15.30"></a><span id="l15.30"> }</span>
<a href="#l15.31"></a><span id="l15.31"> </span>
<a href="#l15.32"></a><span id="l15.32"> function getCurrentThread() {</span>
<a href="#l15.33"></a><span id="l15.33">   return Cc[&quot;@mozilla.org/thread-manager;1&quot;].getService(Ci.nsIThreadManager).currentThread;</span>
<a href="#l15.34"></a><span id="l15.34"> }</span>
<a href="#l15.35"></a><span id="l15.35"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/stdlib/msgHdrUtils.jsm</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/stdlib/msgHdrUtils.jsm</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -375,20 +375,18 @@ function createStreamListener(k) {</span>
<a href="#l16.4"></a><span id="l16.4">       }</span>
<a href="#l16.5"></a><span id="l16.5">       catch (e) {</span>
<a href="#l16.6"></a><span id="l16.6">         dump(&quot;Error inside stream listener:\n&quot; + e + &quot;\n&quot;);</span>
<a href="#l16.7"></a><span id="l16.7">       }</span>
<a href="#l16.8"></a><span id="l16.8">     },</span>
<a href="#l16.9"></a><span id="l16.9"> </span>
<a href="#l16.10"></a><span id="l16.10">     // nsIStreamListener</span>
<a href="#l16.11"></a><span id="l16.11">     onDataAvailable: function(aRequest, dummy, aInputStream, aOffset, aCount) {</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-      if (isPlatformNewerThan(&quot;67&quot;)) {</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineminus">-        aInputStream = dummy;</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineminus">-        aCount = aOffset;</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineminus">-      }</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineplus">+      aInputStream = dummy;</span>
<a href="#l16.17"></a><span id="l16.17" class="difflineplus">+      aCount = aOffset;</span>
<a href="#l16.18"></a><span id="l16.18">       if (this._stream == null) {</span>
<a href="#l16.19"></a><span id="l16.19">         this._stream = Cc[&quot;@mozilla.org/scriptableinputstream;1&quot;].createInstance(Ci.nsIScriptableInputStream);</span>
<a href="#l16.20"></a><span id="l16.20">         this._stream.init(aInputStream);</span>
<a href="#l16.21"></a><span id="l16.21">       }</span>
<a href="#l16.22"></a><span id="l16.22">       this._data += this._stream.read(aCount);</span>
<a href="#l16.23"></a><span id="l16.23">     }</span>
<a href="#l16.24"></a><span id="l16.24">   };</span>
<a href="#l16.25"></a><span id="l16.25"> }</span>
<a href="#l16.26"></a><span id="l16.26" class="difflineat">@@ -517,19 +515,8 @@ function msgHdrsModifyRaw(aMsgHdrs, aTra</span>
<a href="#l16.27"></a><span id="l16.27">       toCopy.push({</span>
<a href="#l16.28"></a><span id="l16.28">         tempFile: tempFile,</span>
<a href="#l16.29"></a><span id="l16.29">         msgHdr: msgHdr</span>
<a href="#l16.30"></a><span id="l16.30">       });</span>
<a href="#l16.31"></a><span id="l16.31">       tick();</span>
<a href="#l16.32"></a><span id="l16.32">     }), null, null, false, &quot;&quot;);</span>
<a href="#l16.33"></a><span id="l16.33">   }</span>
<a href="#l16.34"></a><span id="l16.34"> }</span>
<a href="#l16.35"></a><span id="l16.35" class="difflineminus">-</span>
<a href="#l16.36"></a><span id="l16.36" class="difflineminus">-</span>
<a href="#l16.37"></a><span id="l16.37" class="difflineminus">-/**</span>
<a href="#l16.38"></a><span id="l16.38" class="difflineminus">- * return true, if plafform is newer than or equal a given version</span>
<a href="#l16.39"></a><span id="l16.39" class="difflineminus">- */</span>
<a href="#l16.40"></a><span id="l16.40" class="difflineminus">-function isPlatformNewerThan(requestedVersion) {</span>
<a href="#l16.41"></a><span id="l16.41" class="difflineminus">-  let vc = Cc[&quot;@mozilla.org/xpcom/version-comparator;1&quot;].getService(Ci.nsIVersionComparator);</span>
<a href="#l16.42"></a><span id="l16.42" class="difflineminus">-  let appVer = Cc[&quot;@mozilla.org/xre/app-info;1&quot;].getService(Ci.nsIXULAppInfo).platformVersion;</span>
<a href="#l16.43"></a><span id="l16.43" class="difflineminus">-</span>
<a href="#l16.44"></a><span id="l16.44" class="difflineminus">-  return vc.compare(appVer, requestedVersion) &gt;= 0;</span>
<a href="#l16.45"></a><span id="l16.45" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/streams.jsm</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/streams.jsm</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -65,30 +65,21 @@ var EnigmailStreams = {</span>
<a href="#l17.4"></a><span id="l17.4">         var cbData = this.data;</span>
<a href="#l17.5"></a><span id="l17.5"> </span>
<a href="#l17.6"></a><span id="l17.6">         EnigmailTimer.setTimeout(function _cb() {</span>
<a href="#l17.7"></a><span id="l17.7">           cbFunc(cbData);</span>
<a href="#l17.8"></a><span id="l17.8">         });</span>
<a href="#l17.9"></a><span id="l17.9">       }</span>
<a href="#l17.10"></a><span id="l17.10">     };</span>
<a href="#l17.11"></a><span id="l17.11"> </span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-    if (EnigmailCompat.isMessageUriInPgpMime()) {</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineminus">-      // TB &gt;= 67</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineminus">-      listener.onDataAvailable = function(req, stream, offset, count) {</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineminus">-        // EnigmailLog.DEBUG(&quot;enigmailCommon.jsm: stringListener.onDataAvailable: &quot;+count+&quot;\n&quot;);</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineminus">-        this.inStream.setInputStream(stream);</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineminus">-        this.data += this.inStream.readBytes(count);</span>
<a href="#l17.18"></a><span id="l17.18" class="difflineminus">-      };</span>
<a href="#l17.19"></a><span id="l17.19" class="difflineminus">-    } else {</span>
<a href="#l17.20"></a><span id="l17.20" class="difflineminus">-      listener.onDataAvailable = function(req, ctxt, stream, offset, count) {</span>
<a href="#l17.21"></a><span id="l17.21" class="difflineminus">-        // EnigmailLog.DEBUG(&quot;enigmailCommon.jsm: stringListener.onDataAvailable: &quot;+count+&quot;\n&quot;);</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineminus">-        this.inStream.setInputStream(stream);</span>
<a href="#l17.23"></a><span id="l17.23" class="difflineminus">-        this.data += this.inStream.readBytes(count);</span>
<a href="#l17.24"></a><span id="l17.24" class="difflineminus">-      };</span>
<a href="#l17.25"></a><span id="l17.25" class="difflineminus">-    }</span>
<a href="#l17.26"></a><span id="l17.26" class="difflineplus">+    listener.onDataAvailable = function(req, stream, offset, count) {</span>
<a href="#l17.27"></a><span id="l17.27" class="difflineplus">+      // EnigmailLog.DEBUG(&quot;enigmailCommon.jsm: stringListener.onDataAvailable: &quot;+count+&quot;\n&quot;);</span>
<a href="#l17.28"></a><span id="l17.28" class="difflineplus">+      this.inStream.setInputStream(stream);</span>
<a href="#l17.29"></a><span id="l17.29" class="difflineplus">+      this.data += this.inStream.readBytes(count);</span>
<a href="#l17.30"></a><span id="l17.30" class="difflineplus">+    };</span>
<a href="#l17.31"></a><span id="l17.31"> </span>
<a href="#l17.32"></a><span id="l17.32">     return listener;</span>
<a href="#l17.33"></a><span id="l17.33">   },</span>
<a href="#l17.34"></a><span id="l17.34"> </span>
<a href="#l17.35"></a><span id="l17.35">   /**</span>
<a href="#l17.36"></a><span id="l17.36">    * create a nsIInputStream object that is fed with string data</span>
<a href="#l17.37"></a><span id="l17.37">    *</span>
<a href="#l17.38"></a><span id="l17.38">    * @uri:            nsIURI - object representing the URI that will deliver the data</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/subprocess.jsm</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/subprocess.jsm</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -335,18 +335,23 @@ var subprocess = {</span>
<a href="#l18.4"></a><span id="l18.4">         throw (&quot;subprocess.jsm: launch error: &quot; + errStr + 'error: ' +</span>
<a href="#l18.5"></a><span id="l18.5">           error + &quot;\n&quot; + JSON.stringify(error));</span>
<a href="#l18.6"></a><span id="l18.6">       }</span>
<a href="#l18.7"></a><span id="l18.7">     );</span>
<a href="#l18.8"></a><span id="l18.8"> </span>
<a href="#l18.9"></a><span id="l18.9">     return {</span>
<a href="#l18.10"></a><span id="l18.10">       wait: function() {</span>
<a href="#l18.11"></a><span id="l18.11">         let mainThread = Services.tm.mainThread;</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-        while (resolved === null)</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineminus">-          mainThread.processNextEvent(true);</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineplus">+        try {</span>
<a href="#l18.15"></a><span id="l18.15" class="difflineplus">+          while (resolved === null) {</span>
<a href="#l18.16"></a><span id="l18.16" class="difflineplus">+            mainThread.processNextEvent(true);</span>
<a href="#l18.17"></a><span id="l18.17" class="difflineplus">+          }</span>
<a href="#l18.18"></a><span id="l18.18" class="difflineplus">+        } catch(ex) {</span>
<a href="#l18.19"></a><span id="l18.19" class="difflineplus">+          console.log(ex);</span>
<a href="#l18.20"></a><span id="l18.20" class="difflineplus">+        }</span>
<a href="#l18.21"></a><span id="l18.21"> </span>
<a href="#l18.22"></a><span id="l18.22">         return resolved;</span>
<a href="#l18.23"></a><span id="l18.23">       },</span>
<a href="#l18.24"></a><span id="l18.24"> </span>
<a href="#l18.25"></a><span id="l18.25">       kill: function(hard = false) {</span>
<a href="#l18.26"></a><span id="l18.26">         subproc.then(proc =&gt; {</span>
<a href="#l18.27"></a><span id="l18.27">           proc.kill(hard ? 0 : undefined);</span>
<a href="#l18.28"></a><span id="l18.28">           removeProcRef();</span>
<a href="#l18.29"></a><span id="l18.29" class="difflineat">@@ -377,9 +382,9 @@ function DEBUG_LOG(str) {</span>
<a href="#l18.30"></a><span id="l18.30">     gDebugFunction(&quot;subprocess.jsm: &quot; + str + &quot;\n&quot;);</span>
<a href="#l18.31"></a><span id="l18.31">   }</span>
<a href="#l18.32"></a><span id="l18.32"> }</span>
<a href="#l18.33"></a><span id="l18.33"> </span>
<a href="#l18.34"></a><span id="l18.34"> function ERROR_LOG(str) {</span>
<a href="#l18.35"></a><span id="l18.35">   if (gErrorFunction) {</span>
<a href="#l18.36"></a><span id="l18.36">     gErrorFunction(&quot;subprocess.jsm: &quot; + str + &quot;\n&quot;);</span>
<a href="#l18.37"></a><span id="l18.37">   }</span>
<a href="#l18.38"></a><span id="l18.38" class="difflineminus">-}</span>
<a href="#l18.39"></a><span id="l18.39">\ No newline at end of file</span>
<a href="#l18.40"></a><span id="l18.40" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/windows.jsm</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/windows.jsm</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -216,17 +216,17 @@ var EnigmailWindows = {</span>
<a href="#l19.4"></a><span id="l19.4">    */</span>
<a href="#l19.5"></a><span id="l19.5"> </span>
<a href="#l19.6"></a><span id="l19.6">   keyManReloadKeys: function() {</span>
<a href="#l19.7"></a><span id="l19.7">     let windowManager = Cc[APPSHELL_MEDIATOR_CONTRACTID].getService(Ci.nsIWindowMediator);</span>
<a href="#l19.8"></a><span id="l19.8">     const winName = &quot;enigmail:KeyManager&quot;;</span>
<a href="#l19.9"></a><span id="l19.9">     const spec = &quot;chrome://openpgp/content/ui/enigmailKeygen.xhtml&quot;;</span>
<a href="#l19.10"></a><span id="l19.10"> </span>
<a href="#l19.11"></a><span id="l19.11">     let recentWin = null;</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-    for (let thisWin of windowManager.getEnumerator(null) &amp;&amp; !recentWin) {</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+    for (let thisWin of windowManager.getEnumerator(null)) {</span>
<a href="#l19.14"></a><span id="l19.14">       if (thisWin.location.href == spec) {</span>
<a href="#l19.15"></a><span id="l19.15">         recentWin = thisWin;</span>
<a href="#l19.16"></a><span id="l19.16">         break;</span>
<a href="#l19.17"></a><span id="l19.17">       }</span>
<a href="#l19.18"></a><span id="l19.18">       if (thisWin.name &amp;&amp; thisWin.name == winName) {</span>
<a href="#l19.19"></a><span id="l19.19">         let evt = new thisWin.Event(&quot;reload-keycache&quot;, {</span>
<a href="#l19.20"></a><span id="l19.20">           &quot;bubbles&quot;: true,</span>
<a href="#l19.21"></a><span id="l19.21">           &quot;cancelable&quot;: false</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mail/extensions/openpgp/content/strings/enigmail.dtd</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/strings/enigmail.dtd</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -724,8 +724,10 @@</span>
<a href="#l20.4"></a><span id="l20.4"> </span>
<a href="#l20.5"></a><span id="l20.5"> &lt;!ENTITY enigmail.importSetup.dlgTitle               &quot;Restore Settings and Keys&quot;&gt;</span>
<a href="#l20.6"></a><span id="l20.6"> &lt;!ENTITY enigmail.importSetup.topDesc                &quot;Using this dialog, you can restore your settings and keys from an existing Gine-Liam installation. To create a backup of your settings and keys, use the 'Transfer Settings' tab in the Gine-Liam preferences.&quot;&gt;</span>
<a href="#l20.7"></a><span id="l20.7"> &lt;!ENTITY enigmail.importSetup.specifyImportFile      &quot;Please specify the backup file to use for restoring your settings and keys:&quot;&gt;</span>
<a href="#l20.8"></a><span id="l20.8"> &lt;!ENTITY enigmail.importSetup.startRestoreLabel      &quot;Start Restoring&quot;&gt;</span>
<a href="#l20.9"></a><span id="l20.9"> &lt;!ENTITY enigmail.importSetup.importingKeys          &quot;Importing keys in GnuPG. This may take a while ...&quot;&gt;</span>
<a href="#l20.10"></a><span id="l20.10"> &lt;!ENTITY enigmail.importSetup.restoringGnupgSettings &quot;Restoring GnuPG settings ...&quot;&gt;</span>
<a href="#l20.11"></a><span id="l20.11"> &lt;!ENTITY enigmail.importSetup.restoringEnigmail      &quot;Restoring Gine-Liam settings ...&quot;&gt;</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineplus">+</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineplus">+&lt;!ENTITY copyCmd.label            &quot;Copy&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mail/extensions/openpgp/content/ui/enigmailKeyManager.js</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/ui/enigmailKeyManager.js</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -137,20 +137,20 @@ function reloadKeys() {</span>
<a href="#l21.4"></a><span id="l21.4">   if (i &lt; 4) buildKeyList(false);</span>
<a href="#l21.5"></a><span id="l21.5"> }</span>
<a href="#l21.6"></a><span id="l21.6"> </span>
<a href="#l21.7"></a><span id="l21.7"> function buildKeyList(refresh) {</span>
<a href="#l21.8"></a><span id="l21.8">   EnigmailLog.DEBUG(&quot;enigmailKeyManager.js: buildKeyList\n&quot;);</span>
<a href="#l21.9"></a><span id="l21.9"> </span>
<a href="#l21.10"></a><span id="l21.10">   var keyListObj = {};</span>
<a href="#l21.11"></a><span id="l21.11"> </span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-  // if (refresh) {</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineminus">-  //   EnigmailKeyRing.clearCache();</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineminus">-  // }</span>
<a href="#l21.15"></a><span id="l21.15" class="difflineminus">-</span>
<a href="#l21.16"></a><span id="l21.16" class="difflineplus">+  if (refresh) {</span>
<a href="#l21.17"></a><span id="l21.17" class="difflineplus">+    EnigmailKeyRing.clearCache();</span>
<a href="#l21.18"></a><span id="l21.18" class="difflineplus">+  }</span>
<a href="#l21.19"></a><span id="l21.19" class="difflineplus">+  </span>
<a href="#l21.20"></a><span id="l21.20">   keyListObj = EnigmailKeyRing.getAllKeys(window, getSortColumn(), getSortDirection());</span>
<a href="#l21.21"></a><span id="l21.21"> </span>
<a href="#l21.22"></a><span id="l21.22">   if (!keyListObj.keySortList) return;</span>
<a href="#l21.23"></a><span id="l21.23"> </span>
<a href="#l21.24"></a><span id="l21.24">   gKeyList = keyListObj.keyList;</span>
<a href="#l21.25"></a><span id="l21.25">   gKeySortList = keyListObj.keySortList;</span>
<a href="#l21.26"></a><span id="l21.26"> </span>
<a href="#l21.27"></a><span id="l21.27">   gKeyListView.keysRefreshed();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mail/extensions/openpgp/content/ui/enigmailKeygen.js</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/ui/enigmailKeygen.js</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -45,17 +45,17 @@ function enigmailKeygenLoad() {</span>
<a href="#l22.4"></a><span id="l22.4">   gUserIdentityList = document.getElementById(&quot;userIdentity&quot;);</span>
<a href="#l22.5"></a><span id="l22.5">   gUserIdentityListPopup = document.getElementById(&quot;userIdentityPopup&quot;);</span>
<a href="#l22.6"></a><span id="l22.6">   gUseForSigning = document.getElementById(&quot;useForSigning&quot;);</span>
<a href="#l22.7"></a><span id="l22.7"> </span>
<a href="#l22.8"></a><span id="l22.8">   //if (EnigmailGpg.getGpgFeature(&quot;supports-ecc-keys&quot;))</span>
<a href="#l22.9"></a><span id="l22.9">   let eccElem = document.getElementById(&quot;keyType_ecc&quot;);</span>
<a href="#l22.10"></a><span id="l22.10">   eccElem.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l22.11"></a><span id="l22.11">   updateKeySizeSel(eccElem);</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-  document.getElementById(&quot;keyType&quot;).selectedItem = eccElem;</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineplus">+  //document.getElementById(&quot;keyType&quot;).selectedItem = eccElem;</span>
<a href="#l22.14"></a><span id="l22.14"> </span>
<a href="#l22.15"></a><span id="l22.15">   if (gUserIdentityListPopup) {</span>
<a href="#l22.16"></a><span id="l22.16">     fillIdentityListPopup();</span>
<a href="#l22.17"></a><span id="l22.17">   }</span>
<a href="#l22.18"></a><span id="l22.18">   gUserIdentityList.focus();</span>
<a href="#l22.19"></a><span id="l22.19"> </span>
<a href="#l22.20"></a><span id="l22.20">   // restore safe setting, which you ALWAYS explicitly have to overrule,</span>
<a href="#l22.21"></a><span id="l22.21">   // if you don't want them:</span>
<a href="#l22.22"></a><span id="l22.22" class="difflineat">@@ -63,20 +63,22 @@ function enigmailKeygenLoad() {</span>
<a href="#l22.23"></a><span id="l22.23">   var noExpiry = document.getElementById(&quot;noExpiry&quot;);</span>
<a href="#l22.24"></a><span id="l22.24">   noExpiry.checked = false;</span>
<a href="#l22.25"></a><span id="l22.25"> </span>
<a href="#l22.26"></a><span id="l22.26">   var enigmailSvc = GetEnigmailSvc();</span>
<a href="#l22.27"></a><span id="l22.27">   if (!enigmailSvc) {</span>
<a href="#l22.28"></a><span id="l22.28">     EnigAlert(EnigGetString(&quot;accessError&quot;));</span>
<a href="#l22.29"></a><span id="l22.29">   }</span>
<a href="#l22.30"></a><span id="l22.30"> </span>
<a href="#l22.31"></a><span id="l22.31" class="difflineplus">+  /*</span>
<a href="#l22.32"></a><span id="l22.32">   if (EnigmailGpgAgent.agentType != &quot;gpg&quot;) {</span>
<a href="#l22.33"></a><span id="l22.33">     EnigAlert(EnigGetString(&quot;onlyGPG&quot;));</span>
<a href="#l22.34"></a><span id="l22.34">     return;</span>
<a href="#l22.35"></a><span id="l22.35">   }</span>
<a href="#l22.36"></a><span id="l22.36" class="difflineplus">+  */</span>
<a href="#l22.37"></a><span id="l22.37"> }</span>
<a href="#l22.38"></a><span id="l22.38"> </span>
<a href="#l22.39"></a><span id="l22.39"> function updateKeySizeSel(selectedObj) {</span>
<a href="#l22.40"></a><span id="l22.40">   if (selectedObj.id === &quot;keyType_ecc&quot;) {</span>
<a href="#l22.41"></a><span id="l22.41">     document.getElementById(&quot;keySize&quot;).setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l22.42"></a><span id="l22.42">   } else {</span>
<a href="#l22.43"></a><span id="l22.43">     document.getElementById(&quot;keySize&quot;).removeAttribute(&quot;disabled&quot;);</span>
<a href="#l22.44"></a><span id="l22.44">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mail/extensions/openpgp/content/ui/enigmailKeygen.xhtml</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/ui/enigmailKeygen.xhtml</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -52,21 +52,21 @@</span>
<a href="#l23.4"></a><span id="l23.4"> </span>
<a href="#l23.5"></a><span id="l23.5">   &lt;tabpanels flex=&quot;1&quot;&gt;</span>
<a href="#l23.6"></a><span id="l23.6"> </span>
<a href="#l23.7"></a><span id="l23.7">     &lt;hbox&gt; &lt;!-- Basic Tab --&gt;</span>
<a href="#l23.8"></a><span id="l23.8">       &lt;hbox align=&quot;center&quot;&gt;</span>
<a href="#l23.9"></a><span id="l23.9">         &lt;label value=&quot;&amp;enigmail.keyGen.expire.label;&quot; control=&quot;expireInput&quot;/&gt;</span>
<a href="#l23.10"></a><span id="l23.10">       &lt;/hbox&gt;</span>
<a href="#l23.11"></a><span id="l23.11">       &lt;hbox align=&quot;center&quot;&gt;</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-        &lt;html:input id=&quot;expireInput&quot; size=&quot;5&quot; maxlength=&quot;5&quot; value=&quot;5&quot;/&gt;</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineminus">-        &lt;menulist id=&quot;timeScale&quot; label=&quot;&amp;enigmail.keyGen.years.label;&quot; value=&quot;365&quot;&gt;</span>
<a href="#l23.14"></a><span id="l23.14" class="difflineplus">+        &lt;html:input id=&quot;expireInput&quot; size=&quot;5&quot; maxlength=&quot;5&quot; value=&quot;1&quot;/&gt;</span>
<a href="#l23.15"></a><span id="l23.15" class="difflineplus">+        &lt;menulist id=&quot;timeScale&quot; label=&quot;&amp;enigmail.keyGen.months.label;&quot; value=&quot;30&quot;&gt;</span>
<a href="#l23.16"></a><span id="l23.16">           &lt;menupopup id=&quot;timeScalePopup&quot;&gt;</span>
<a href="#l23.17"></a><span id="l23.17" class="difflineminus">-            &lt;menuitem id=&quot;years&quot; value=&quot;365&quot; label=&quot;&amp;enigmail.keyGen.years.label;&quot; selected=&quot;true&quot;/&gt;</span>
<a href="#l23.18"></a><span id="l23.18" class="difflineminus">-            &lt;menuitem id=&quot;months&quot; value=&quot;30&quot; label=&quot;&amp;enigmail.keyGen.months.label;&quot;/&gt;</span>
<a href="#l23.19"></a><span id="l23.19" class="difflineplus">+            &lt;menuitem id=&quot;years&quot; value=&quot;365&quot; label=&quot;&amp;enigmail.keyGen.years.label;&quot;/&gt;</span>
<a href="#l23.20"></a><span id="l23.20" class="difflineplus">+            &lt;menuitem id=&quot;months&quot; value=&quot;30&quot; label=&quot;&amp;enigmail.keyGen.months.label;&quot; selected=&quot;true&quot;/&gt;</span>
<a href="#l23.21"></a><span id="l23.21">             &lt;menuitem id=&quot;days&quot; value=&quot;1&quot; label=&quot;&amp;enigmail.keyGen.days.label;&quot;/&gt;</span>
<a href="#l23.22"></a><span id="l23.22">           &lt;/menupopup&gt;</span>
<a href="#l23.23"></a><span id="l23.23">         &lt;/menulist&gt;</span>
<a href="#l23.24"></a><span id="l23.24">         &lt;checkbox label=&quot;&amp;enigmail.keyGen.noExpiry.label;&quot;</span>
<a href="#l23.25"></a><span id="l23.25">                   id=&quot;noExpiry&quot; oncommand=&quot;onNoExpiry()&quot;/&gt;</span>
<a href="#l23.26"></a><span id="l23.26">       &lt;/hbox&gt;</span>
<a href="#l23.27"></a><span id="l23.27">     &lt;/hbox&gt;</span>
<a href="#l23.28"></a><span id="l23.28"> </span>
<a href="#l23.29"></a><span id="l23.29" class="difflineat">@@ -91,20 +91,20 @@</span>
<a href="#l23.30"></a><span id="l23.30">               &lt;/menulist&gt;</span>
<a href="#l23.31"></a><span id="l23.31">             &lt;/hbox&gt;</span>
<a href="#l23.32"></a><span id="l23.32">           &lt;/row&gt;</span>
<a href="#l23.33"></a><span id="l23.33">           &lt;row&gt;</span>
<a href="#l23.34"></a><span id="l23.34">             &lt;hbox align=&quot;center&quot;&gt;</span>
<a href="#l23.35"></a><span id="l23.35">               &lt;label value=&quot;&amp;enigmail.keyGen.keySize.label;&quot; control=&quot;keySize&quot;/&gt;</span>
<a href="#l23.36"></a><span id="l23.36">             &lt;/hbox&gt;</span>
<a href="#l23.37"></a><span id="l23.37">             &lt;hbox flex=&quot;0&quot;&gt;</span>
<a href="#l23.38"></a><span id="l23.38" class="difflineminus">-              &lt;menulist id=&quot;keySize&quot; label=&quot;4096&quot; value=&quot;4096&quot; &gt;</span>
<a href="#l23.39"></a><span id="l23.39" class="difflineplus">+              &lt;menulist id=&quot;keySize&quot; label=&quot;3072&quot; value=&quot;3072&quot; &gt;</span>
<a href="#l23.40"></a><span id="l23.40">                 &lt;menupopup id=&quot;keySizePopup&quot;&gt;</span>
<a href="#l23.41"></a><span id="l23.41" class="difflineminus">-                  &lt;menuitem id=&quot;keySize_3072&quot; value=&quot;3072&quot; label=&quot;3072&quot;/&gt;</span>
<a href="#l23.42"></a><span id="l23.42" class="difflineminus">-                  &lt;menuitem id=&quot;keySize_4096&quot; value=&quot;4096&quot; label=&quot;4096&quot; selected=&quot;true&quot;/&gt;</span>
<a href="#l23.43"></a><span id="l23.43" class="difflineplus">+                  &lt;menuitem id=&quot;keySize_3072&quot; value=&quot;3072&quot; label=&quot;3072&quot; selected=&quot;true&quot;/&gt;</span>
<a href="#l23.44"></a><span id="l23.44" class="difflineplus">+                  &lt;menuitem id=&quot;keySize_4096&quot; value=&quot;4096&quot; label=&quot;4096&quot;/&gt;</span>
<a href="#l23.45"></a><span id="l23.45">                 &lt;/menupopup&gt;</span>
<a href="#l23.46"></a><span id="l23.46">               &lt;/menulist&gt;</span>
<a href="#l23.47"></a><span id="l23.47">             &lt;/hbox&gt;</span>
<a href="#l23.48"></a><span id="l23.48">           &lt;/row&gt;</span>
<a href="#l23.49"></a><span id="l23.49">         &lt;/rows&gt;</span>
<a href="#l23.50"></a><span id="l23.50">       &lt;/grid&gt;</span>
<a href="#l23.51"></a><span id="l23.51">   &lt;/vbox&gt;</span>
<a href="#l23.52"></a><span id="l23.52">   &lt;/tabpanels&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mail/extensions/openpgp/content/ui/enigmailMessengerOverlay.js</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/ui/enigmailMessengerOverlay.js</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -1833,30 +1833,20 @@ Enigmail.msg = {</span>
<a href="#l24.4"></a><span id="l24.4"> </span>
<a href="#l24.5"></a><span id="l24.5">           callbackArg.data = this.data.substring(start, end + 1);</span>
<a href="#l24.6"></a><span id="l24.6">           EnigmailLog.DEBUG(&quot;enigmailMessengerOverlay.js: data: &gt;&quot; + callbackArg.data.substr(0, 100) + &quot;&lt;\n&quot;);</span>
<a href="#l24.7"></a><span id="l24.7">           Enigmail.msg.msgDirectCallback(callbackArg);</span>
<a href="#l24.8"></a><span id="l24.8">         }</span>
<a href="#l24.9"></a><span id="l24.9">       }</span>
<a href="#l24.10"></a><span id="l24.10">     };</span>
<a href="#l24.11"></a><span id="l24.11"> </span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-    if (EnigmailCompat.isMessageUriInPgpMime()) {</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineminus">-      // TB &gt;= 67</span>
<a href="#l24.14"></a><span id="l24.14" class="difflineminus">-      listener.onDataAvailable = function(req, stream, offset, count) {</span>
<a href="#l24.15"></a><span id="l24.15" class="difflineminus">-        this.inStream.init(stream);</span>
<a href="#l24.16"></a><span id="l24.16" class="difflineminus">-        this.data += this.inStream.read(count);</span>
<a href="#l24.17"></a><span id="l24.17" class="difflineminus">-      };</span>
<a href="#l24.18"></a><span id="l24.18" class="difflineminus">-    }</span>
<a href="#l24.19"></a><span id="l24.19" class="difflineminus">-    else {</span>
<a href="#l24.20"></a><span id="l24.20" class="difflineminus">-      listener.onDataAvailable = function(req, ctxt, stream, offset, count) {</span>
<a href="#l24.21"></a><span id="l24.21" class="difflineminus">-        this.inStream.init(stream);</span>
<a href="#l24.22"></a><span id="l24.22" class="difflineminus">-        this.data += this.inStream.read(count);</span>
<a href="#l24.23"></a><span id="l24.23" class="difflineminus">-      };</span>
<a href="#l24.24"></a><span id="l24.24" class="difflineminus">-    }</span>
<a href="#l24.25"></a><span id="l24.25" class="difflineminus">-</span>
<a href="#l24.26"></a><span id="l24.26" class="difflineplus">+    listener.onDataAvailable = function(req, stream, offset, count) {</span>
<a href="#l24.27"></a><span id="l24.27" class="difflineplus">+      this.inStream.init(stream);</span>
<a href="#l24.28"></a><span id="l24.28" class="difflineplus">+      this.data += this.inStream.read(count);</span>
<a href="#l24.29"></a><span id="l24.29" class="difflineplus">+    };</span>
<a href="#l24.30"></a><span id="l24.30"> </span>
<a href="#l24.31"></a><span id="l24.31">     msgSvc.streamMessage(msgUriSpec,</span>
<a href="#l24.32"></a><span id="l24.32">       listener,</span>
<a href="#l24.33"></a><span id="l24.33">       msgWindow,</span>
<a href="#l24.34"></a><span id="l24.34">       null,</span>
<a href="#l24.35"></a><span id="l24.35">       false,</span>
<a href="#l24.36"></a><span id="l24.36">       null,</span>
<a href="#l24.37"></a><span id="l24.37">       false);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mail/extensions/openpgp/content/ui/enigmailMsgBox.xhtml</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/ui/enigmailMsgBox.xhtml</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -8,18 +8,16 @@</span>
<a href="#l25.4"></a><span id="l25.4"> &lt;?xml-stylesheet href=&quot;chrome://messenger/skin/&quot; type=&quot;text/css&quot;?&gt;</span>
<a href="#l25.5"></a><span id="l25.5"> &lt;?xml-stylesheet href=&quot;chrome://openpgp/skin/enigmail.css&quot; type=&quot;text/css&quot;?&gt;</span>
<a href="#l25.6"></a><span id="l25.6"> </span>
<a href="#l25.7"></a><span id="l25.7"> &lt;!DOCTYPE window [</span>
<a href="#l25.8"></a><span id="l25.8"> &lt;!ENTITY % brandDTD SYSTEM &quot;chrome://branding/locale/brand.dtd&quot; &gt;</span>
<a href="#l25.9"></a><span id="l25.9"> %brandDTD;</span>
<a href="#l25.10"></a><span id="l25.10"> &lt;!ENTITY % enigMailDTD SYSTEM &quot;chrome://openpgp/content/strings/enigmail.dtd&quot; &gt;</span>
<a href="#l25.11"></a><span id="l25.11"> %enigMailDTD;</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-&lt;!ENTITY % utilityDTD SYSTEM &quot;chrome://communicator/locale/utilityOverlay.dtd&quot;&gt;</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineminus">-%utilityDTD;</span>
<a href="#l25.14"></a><span id="l25.14"> ]&gt;</span>
<a href="#l25.15"></a><span id="l25.15"> </span>
<a href="#l25.16"></a><span id="l25.16"> &lt;window title=&quot;&quot;</span>
<a href="#l25.17"></a><span id="l25.17">         xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;</span>
<a href="#l25.18"></a><span id="l25.18">         buttons=&quot;accept,help,cancel,extra1,extra2&quot;</span>
<a href="#l25.19"></a><span id="l25.19">         onload=&quot;onLoad();&quot;</span>
<a href="#l25.20"></a><span id="l25.20">         xmlns:html=&quot;http://www.w3.org/1999/xhtml&quot;&gt;</span>
<a href="#l25.21"></a><span id="l25.21"> &lt;dialog id=&quot;enigmailMsgBox&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/mail/extensions/openpgp/content/ui/enigmailMsgComposeOverlay.js</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/ui/enigmailMsgComposeOverlay.js</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -30,90 +30,64 @@ var EnigmailDialog = ChromeUtils.import(</span>
<a href="#l26.4"></a><span id="l26.4"> var EnigmailTimer = ChromeUtils.import(&quot;chrome://openpgp/content/modules/timer.jsm&quot;).EnigmailTimer;</span>
<a href="#l26.5"></a><span id="l26.5"> var EnigmailWindows = ChromeUtils.import(&quot;chrome://openpgp/content/modules/windows.jsm&quot;).EnigmailWindows;</span>
<a href="#l26.6"></a><span id="l26.6"> var EnigmailKeyRing = ChromeUtils.import(&quot;chrome://openpgp/content/modules/keyRing.jsm&quot;).EnigmailKeyRing;</span>
<a href="#l26.7"></a><span id="l26.7"> var EnigmailURIs = ChromeUtils.import(&quot;chrome://openpgp/content/modules/uris.jsm&quot;).EnigmailURIs;</span>
<a href="#l26.8"></a><span id="l26.8"> var EnigmailConstants = ChromeUtils.import(&quot;chrome://openpgp/content/modules/constants.jsm&quot;).EnigmailConstants;</span>
<a href="#l26.9"></a><span id="l26.9"> var EnigmailPassword = ChromeUtils.import(&quot;chrome://openpgp/content/modules/passwords.jsm&quot;).EnigmailPassword;</span>
<a href="#l26.10"></a><span id="l26.10"> var EnigmailDecryption = ChromeUtils.import(&quot;chrome://openpgp/content/modules/decryption.jsm&quot;).EnigmailDecryption;</span>
<a href="#l26.11"></a><span id="l26.11"> var EnigmailEncryption = ChromeUtils.import(&quot;chrome://openpgp/content/modules/encryption.jsm&quot;).EnigmailEncryption;</span>
<a href="#l26.12"></a><span id="l26.12" class="difflineminus">-var EnigmailRules = ChromeUtils.import(&quot;chrome://openpgp/content/modules/rules.jsm&quot;).EnigmailRules;</span>
<a href="#l26.13"></a><span id="l26.13"> var EnigmailClipboard = ChromeUtils.import(&quot;chrome://openpgp/content/modules/clipboard.jsm&quot;).EnigmailClipboard;</span>
<a href="#l26.14"></a><span id="l26.14"> var EnigmailWkdLookup = ChromeUtils.import(&quot;chrome://openpgp/content/modules/wkdLookup.jsm&quot;).EnigmailWkdLookup;</span>
<a href="#l26.15"></a><span id="l26.15"> var EnigmailAutocrypt = ChromeUtils.import(&quot;chrome://openpgp/content/modules/autocrypt.jsm&quot;).EnigmailAutocrypt;</span>
<a href="#l26.16"></a><span id="l26.16"> var EnigmailMime = ChromeUtils.import(&quot;chrome://openpgp/content/modules/mime.jsm&quot;).EnigmailMime;</span>
<a href="#l26.17"></a><span id="l26.17"> var EnigmailMsgRead = ChromeUtils.import(&quot;chrome://openpgp/content/modules/msgRead.jsm&quot;).EnigmailMsgRead;</span>
<a href="#l26.18"></a><span id="l26.18"> var EnigmailMimeEncrypt = ChromeUtils.import(&quot;chrome://openpgp/content/modules/mimeEncrypt.jsm&quot;).EnigmailMimeEncrypt;</span>
<a href="#l26.19"></a><span id="l26.19"> var jsmime = ChromeUtils.import(&quot;resource:///modules/jsmime.jsm&quot;).jsmime;</span>
<a href="#l26.20"></a><span id="l26.20"> </span>
<a href="#l26.21"></a><span id="l26.21" class="difflineplus">+// Account encryption policy values:</span>
<a href="#l26.22"></a><span id="l26.22" class="difflineplus">+// const kEncryptionPolicy_Never = 0;</span>
<a href="#l26.23"></a><span id="l26.23" class="difflineplus">+// 'IfPossible' was used by ns4.</span>
<a href="#l26.24"></a><span id="l26.24" class="difflineplus">+// const kEncryptionPolicy_IfPossible = 1;</span>
<a href="#l26.25"></a><span id="l26.25" class="difflineplus">+var kEncryptionPolicy_Always = 2;</span>
<a href="#l26.26"></a><span id="l26.26"> </span>
<a href="#l26.27"></a><span id="l26.27"> if (!Enigmail) var Enigmail = {};</span>
<a href="#l26.28"></a><span id="l26.28"> </span>
<a href="#l26.29"></a><span id="l26.29"> const IOSERVICE_CONTRACTID = &quot;@mozilla.org/network/io-service;1&quot;;</span>
<a href="#l26.30"></a><span id="l26.30"> const LOCAL_FILE_CONTRACTID = &quot;@mozilla.org/file/local;1&quot;;</span>
<a href="#l26.31"></a><span id="l26.31"> </span>
<a href="#l26.32"></a><span id="l26.32"> Enigmail.msg = {</span>
<a href="#l26.33"></a><span id="l26.33">   editor: null,</span>
<a href="#l26.34"></a><span id="l26.34" class="difflineminus">-  dirty: null,</span>
<a href="#l26.35"></a><span id="l26.35" class="difflineminus">-  processed: null,</span>
<a href="#l26.36"></a><span id="l26.36" class="difflineminus">-  timeoutId: null,</span>
<a href="#l26.37"></a><span id="l26.37" class="difflineminus">-  sendPgpMime: false,</span>
<a href="#l26.38"></a><span id="l26.38" class="difflineminus">-  sendMode: null, // the current default for sending a message (0, SIGN, ENCRYPT, or SIGN|ENCRYPT)</span>
<a href="#l26.39"></a><span id="l26.39" class="difflineminus">-  sendModeDirty: false, // send mode or final send options changed?</span>
<a href="#l26.40"></a><span id="l26.40" class="difflineminus">-</span>
<a href="#l26.41"></a><span id="l26.41" class="difflineminus">-  // processed reasons for encryption:</span>
<a href="#l26.42"></a><span id="l26.42" class="difflineminus">-  reasonEncrypted: &quot;&quot;,</span>
<a href="#l26.43"></a><span id="l26.43" class="difflineminus">-  reasonSigned: &quot;&quot;,</span>
<a href="#l26.44"></a><span id="l26.44" class="difflineminus">-</span>
<a href="#l26.45"></a><span id="l26.45" class="difflineminus">-  // encrypt/sign/pgpmime according to rules?</span>
<a href="#l26.46"></a><span id="l26.46" class="difflineminus">-  // (1:ENIG_UNDEF(undef/maybe), 0:ENIG_NEVER(never/forceNo), 2:ENIG_ALWAYS(always/forceYes),</span>
<a href="#l26.47"></a><span id="l26.47" class="difflineminus">-  //  22:ENIG_AUTO_ALWAYS, 99:ENIG_CONFLICT(conflict))</span>
<a href="#l26.48"></a><span id="l26.48" class="difflineminus">-  encryptByRules: EnigmailConstants.ENIG_UNDEF,</span>
<a href="#l26.49"></a><span id="l26.49" class="difflineminus">-  signByRules: EnigmailConstants.ENIG_UNDEF,</span>
<a href="#l26.50"></a><span id="l26.50" class="difflineminus">-  pgpmimeByRules: EnigmailConstants.ENIG_UNDEF,</span>
<a href="#l26.51"></a><span id="l26.51" class="difflineminus">-</span>
<a href="#l26.52"></a><span id="l26.52" class="difflineminus">-  // forced to encrypt/sign/pgpmime?</span>
<a href="#l26.53"></a><span id="l26.53" class="difflineminus">-  // (1:ENIG_UNDEF(undef/maybe), 0:ENIG_NEVER(never/forceNo), 2:ENIG_ALWAYS(always/forceYes))</span>
<a href="#l26.54"></a><span id="l26.54" class="difflineminus">-  encryptForced: EnigmailConstants.ENIG_UNDEF,</span>
<a href="#l26.55"></a><span id="l26.55" class="difflineminus">-  signForced: EnigmailConstants.ENIG_UNDEF,</span>
<a href="#l26.56"></a><span id="l26.56" class="difflineminus">-  pgpmimeForced: EnigmailConstants.ENIG_UNDEF,</span>
<a href="#l26.57"></a><span id="l26.57" class="difflineminus">-</span>
<a href="#l26.58"></a><span id="l26.58" class="difflineminus">-  finalSignDependsOnEncrypt: false, // does signing finally depends on encryption mode?</span>
<a href="#l26.59"></a><span id="l26.59" class="difflineminus">-</span>
<a href="#l26.60"></a><span id="l26.60" class="difflineminus">-  // resulting final encrypt/sign/pgpmime mode:</span>
<a href="#l26.61"></a><span id="l26.61" class="difflineminus">-  //  (-1:ENIG_FINAL_UNDEF, 0:ENIG_FINAL_NO, 1:ENIG_FINAL_YES, 10:ENIG_FINAL_FORCENO, 11:ENIG_FINAL_FORCEYES, 99:ENIG_FINAL_CONFLICT)</span>
<a href="#l26.62"></a><span id="l26.62" class="difflineminus">-  statusEncrypted: EnigmailConstants.ENIG_FINAL_UNDEF,</span>
<a href="#l26.63"></a><span id="l26.63" class="difflineminus">-  statusSigned: EnigmailConstants.ENIG_FINAL_UNDEF,</span>
<a href="#l26.64"></a><span id="l26.64" class="difflineminus">-  statusPGPMime: EnigmailConstants.ENIG_FINAL_UNDEF,</span>
<a href="#l26.65"></a><span id="l26.65" class="difflineminus">-  statusEncryptedInStatusBar: null, // last statusEncyrpted when processing status buttons</span>
<a href="#l26.66"></a><span id="l26.66" class="difflineminus">-  // to find possible broken promise of encryption</span>
<a href="#l26.67"></a><span id="l26.67" class="difflineminus">-</span>
<a href="#l26.68"></a><span id="l26.68" class="difflineminus">-  // is OpenPGP encryption possible without displaying the key selection dialog?</span>
<a href="#l26.69"></a><span id="l26.69" class="difflineminus">-  autoPgpEncryption: false,</span>
<a href="#l26.70"></a><span id="l26.70" class="difflineminus">-</span>
<a href="#l26.71"></a><span id="l26.71" class="difflineplus">+  dirty: null, // inconsistent, other places use int. should this be zero ?</span>
<a href="#l26.72"></a><span id="l26.72" class="difflineplus">+               // dirty means: composer contents were modified by this code, right?</span>
<a href="#l26.73"></a><span id="l26.73" class="difflineplus">+  processed: null, // contains information for undo of inline signed/encrypt</span>
<a href="#l26.74"></a><span id="l26.74" class="difflineplus">+  timeoutId: null, // TODO: once set, it's never reset</span>
<a href="#l26.75"></a><span id="l26.75" class="difflineplus">+  sendPgpMime: true,</span>
<a href="#l26.76"></a><span id="l26.76" class="difflineplus">+  //sendMode: null, // the current default for sending a message (0, SIGN, ENCRYPT, or SIGN|ENCRYPT)</span>
<a href="#l26.77"></a><span id="l26.77" class="difflineplus">+  //sendModeDirty: false, // send mode or final send options changed?</span>
<a href="#l26.78"></a><span id="l26.78" class="difflineplus">+</span>
<a href="#l26.79"></a><span id="l26.79" class="difflineplus">+  </span>
<a href="#l26.80"></a><span id="l26.80">   // processed strings to signal final encrypt/sign/pgpmime state:</span>
<a href="#l26.81"></a><span id="l26.81">   statusEncryptedStr: &quot;???&quot;,</span>
<a href="#l26.82"></a><span id="l26.82">   statusSignedStr: &quot;???&quot;,</span>
<a href="#l26.83"></a><span id="l26.83" class="difflineminus">-  statusPGPMimeStr: &quot;???&quot;,</span>
<a href="#l26.84"></a><span id="l26.84" class="difflineminus">-  statusSMimeStr: &quot;???&quot;,</span>
<a href="#l26.85"></a><span id="l26.85" class="difflineminus">-  statusInlinePGPStr: &quot;???&quot;,</span>
<a href="#l26.86"></a><span id="l26.86" class="difflineplus">+  //statusPGPMimeStr: &quot;???&quot;,</span>
<a href="#l26.87"></a><span id="l26.87" class="difflineplus">+  //statusSMimeStr: &quot;???&quot;,</span>
<a href="#l26.88"></a><span id="l26.88" class="difflineplus">+  //statusInlinePGPStr: &quot;???&quot;,</span>
<a href="#l26.89"></a><span id="l26.89">   statusAttachOwnKey: &quot;???&quot;,</span>
<a href="#l26.90"></a><span id="l26.90"> </span>
<a href="#l26.91"></a><span id="l26.91">   sendProcess: false,</span>
<a href="#l26.92"></a><span id="l26.92">   composeBodyReady: false,</span>
<a href="#l26.93"></a><span id="l26.93">   identity: null,</span>
<a href="#l26.94"></a><span id="l26.94" class="difflineminus">-  enableRules: null,</span>
<a href="#l26.95"></a><span id="l26.95">   modifiedAttach: null,</span>
<a href="#l26.96"></a><span id="l26.96">   lastFocusedWindow: null,</span>
<a href="#l26.97"></a><span id="l26.97">   determineSendFlagId: null,</span>
<a href="#l26.98"></a><span id="l26.98">   trustAllKeys: false,</span>
<a href="#l26.99"></a><span id="l26.99">   protectHeaders: false,</span>
<a href="#l26.100"></a><span id="l26.100">   draftSubjectEncrypted: false,</span>
<a href="#l26.101"></a><span id="l26.101">   attachOwnKeyObj: {</span>
<a href="#l26.102"></a><span id="l26.102" class="difflineminus">-    appendAttachment: false,</span>
<a href="#l26.103"></a><span id="l26.103">     attachedObj: null,</span>
<a href="#l26.104"></a><span id="l26.104">     attachedKey: null</span>
<a href="#l26.105"></a><span id="l26.105">   },</span>
<a href="#l26.106"></a><span id="l26.106"> </span>
<a href="#l26.107"></a><span id="l26.107">   keyLookupDone: [],</span>
<a href="#l26.108"></a><span id="l26.108"> </span>
<a href="#l26.109"></a><span id="l26.109">   saveDraftError: 0,</span>
<a href="#l26.110"></a><span id="l26.110">   addrOnChangeTimeout: 250,</span>
<a href="#l26.111"></a><span id="l26.111" class="difflineat">@@ -136,166 +110,148 @@ Enigmail.msg = {</span>
<a href="#l26.112"></a><span id="l26.112">       EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: no gMsgCompose, leaving\n&quot;);</span>
<a href="#l26.113"></a><span id="l26.113">       return;</span>
<a href="#l26.114"></a><span id="l26.114">     }</span>
<a href="#l26.115"></a><span id="l26.115"> </span>
<a href="#l26.116"></a><span id="l26.116">     gMsgCompose.RegisterStateListener(Enigmail.composeStateListener);</span>
<a href="#l26.117"></a><span id="l26.117">     Enigmail.msg.composeBodyReady = false;</span>
<a href="#l26.118"></a><span id="l26.118"> </span>
<a href="#l26.119"></a><span id="l26.119">     // Listen to message sending event</span>
<a href="#l26.120"></a><span id="l26.120" class="difflineminus">-    addEventListener('compose-send-message', Enigmail.msg.sendMessageListener, true);</span>
<a href="#l26.121"></a><span id="l26.121" class="difflineplus">+    addEventListener(&quot;compose-send-message&quot;, Enigmail.msg.sendMessageListener.bind(Enigmail.msg), true);</span>
<a href="#l26.122"></a><span id="l26.122" class="difflineplus">+    addEventListener(&quot;compose-from-changed&quot;, Enigmail.msg.fromChangedListener.bind(Enigmail.msg), true);</span>
<a href="#l26.123"></a><span id="l26.123"> </span>
<a href="#l26.124"></a><span id="l26.124">     // Relabel SMIME button and menu item</span>
<a href="#l26.125"></a><span id="l26.125" class="difflineminus">-    var smimeButton = document.getElementById(&quot;button-security&quot;);</span>
<a href="#l26.126"></a><span id="l26.126" class="difflineminus">-    let toolbar = document.getElementById(&quot;composeToolbar2&quot;);</span>
<a href="#l26.127"></a><span id="l26.127" class="difflineminus">-</span>
<a href="#l26.128"></a><span id="l26.128" class="difflineplus">+    //var smimeButton = document.getElementById(&quot;button-security&quot;);</span>
<a href="#l26.129"></a><span id="l26.129" class="difflineplus">+    //let toolbar = document.getElementById(&quot;composeToolbar2&quot;);</span>
<a href="#l26.130"></a><span id="l26.130" class="difflineplus">+</span>
<a href="#l26.131"></a><span id="l26.131" class="difflineplus">+    /*</span>
<a href="#l26.132"></a><span id="l26.132">     if (smimeButton) {</span>
<a href="#l26.133"></a><span id="l26.133">       smimeButton.setAttribute(&quot;label&quot;, &quot;S/MIME&quot;);</span>
<a href="#l26.134"></a><span id="l26.134">       if (toolbar &amp;&amp; toolbar.getAttribute(&quot;currentset&quot;).length === 0) {</span>
<a href="#l26.135"></a><span id="l26.135">         // remove S/MIME button if the toolbar is displaying the default set</span>
<a href="#l26.136"></a><span id="l26.136">         toolbar.removeChild(smimeButton);</span>
<a href="#l26.137"></a><span id="l26.137">       }</span>
<a href="#l26.138"></a><span id="l26.138">     }</span>
<a href="#l26.139"></a><span id="l26.139" class="difflineplus">+    */</span>
<a href="#l26.140"></a><span id="l26.140"> </span>
<a href="#l26.141"></a><span id="l26.141">     var msgId = document.getElementById(&quot;msgIdentityPopup&quot;);</span>
<a href="#l26.142"></a><span id="l26.142">     if (msgId) {</span>
<a href="#l26.143"></a><span id="l26.143">       msgId.addEventListener(&quot;command&quot;, Enigmail.msg.setIdentityCallback, false);</span>
<a href="#l26.144"></a><span id="l26.144">     }</span>
<a href="#l26.145"></a><span id="l26.145"> </span>
<a href="#l26.146"></a><span id="l26.146">     var subj = document.getElementById(&quot;msgSubject&quot;);</span>
<a href="#l26.147"></a><span id="l26.147">     subj.addEventListener('focus', Enigmail.msg.fireSendFlags, false);</span>
<a href="#l26.148"></a><span id="l26.148"> </span>
<a href="#l26.149"></a><span id="l26.149" class="difflineminus">-    // listen to S/MIME changes to potentially display &quot;conflict&quot; message</span>
<a href="#l26.150"></a><span id="l26.150" class="difflineminus">-    addSecurityListener(&quot;menu_securitySign1&quot;, Enigmail.msg.toggleSMimeSign);</span>
<a href="#l26.151"></a><span id="l26.151" class="difflineminus">-    addSecurityListener(&quot;menu_securitySign2&quot;, Enigmail.msg.toggleSmimeToolbar);</span>
<a href="#l26.152"></a><span id="l26.152" class="difflineminus">-    addSecurityListener(&quot;menu_securityEncryptRequire1&quot;, Enigmail.msg.toggleSMimeEncrypt);</span>
<a href="#l26.153"></a><span id="l26.153" class="difflineminus">-    addSecurityListener(&quot;menu_securityEncryptRequire2&quot;, Enigmail.msg.toggleSmimeToolbar);</span>
<a href="#l26.154"></a><span id="l26.154" class="difflineminus">-</span>
<a href="#l26.155"></a><span id="l26.155">     /*</span>
<a href="#l26.156"></a><span id="l26.156">     let numCerts = EnigmailFuncs.getNumOfX509Certs();</span>
<a href="#l26.157"></a><span id="l26.157">     this.addrOnChangeTimeout = Math.max((numCerts - 250) * 2, 250);</span>
<a href="#l26.158"></a><span id="l26.158">     EnigmailLog.DEBUG(`enigmailMsgComposeOverlay.js: composeStartup: numCerts=${numCerts}; setting timeout to ${this.addrOnChangeTimeout}\n`);</span>
<a href="#l26.159"></a><span id="l26.159">     */</span>
<a href="#l26.160"></a><span id="l26.160"> </span>
<a href="#l26.161"></a><span id="l26.161">     Enigmail.msg.msgComposeReset(false); // false =&gt; not closing =&gt; call setIdentityDefaults()</span>
<a href="#l26.162"></a><span id="l26.162" class="difflineplus">+</span>
<a href="#l26.163"></a><span id="l26.163" class="difflineplus">+    {</span>
<a href="#l26.164"></a><span id="l26.164" class="difflineplus">+      // Use a new pref identityEnigmailPrefsMigrated, default false.</span>
<a href="#l26.165"></a><span id="l26.165" class="difflineplus">+      // Only if we're doing this for the first time for an identity,</span>
<a href="#l26.166"></a><span id="l26.166" class="difflineplus">+      // try to read old prefs and if found, store as new prefs,</span>
<a href="#l26.167"></a><span id="l26.167" class="difflineplus">+      // then set identityEnigmailPrefsMigrated=true</span>
<a href="#l26.168"></a><span id="l26.168" class="difflineplus">+</span>
<a href="#l26.169"></a><span id="l26.169" class="difflineplus">+      if (Enigmail.msg.wasEnigmailAddOnInstalled() &amp;&amp;</span>
<a href="#l26.170"></a><span id="l26.170" class="difflineplus">+          Enigmail.msg.wasEnigmailEnabledForIdentity() &amp;&amp;</span>
<a href="#l26.171"></a><span id="l26.171" class="difflineplus">+          this.identity.getIntAttribute(&quot;mimePreferOpenPGP&quot;) &gt; 0) {</span>
<a href="#l26.172"></a><span id="l26.172" class="difflineplus">+        // migrate old enigmail prefs</span>
<a href="#l26.173"></a><span id="l26.173" class="difflineplus">+        gSendEncrypted = (this.identity.getIntAttribute(&quot;defaultEncryptionPolicy&quot;) &gt; 0);</span>
<a href="#l26.174"></a><span id="l26.174" class="difflineplus">+        gOptionalEncryption = (this.identity.getIntAttribute(&quot;autoSendEncrypted&quot;) &gt; 0);</span>
<a href="#l26.175"></a><span id="l26.175" class="difflineplus">+        gSendSigned = (this.identity.getIntAttribute(&quot;defaultSigningPolicy&quot;) &gt; 0);</span>
<a href="#l26.176"></a><span id="l26.176" class="difflineplus">+        gSelectedTechnologyIsPGP = true;</span>
<a href="#l26.177"></a><span id="l26.177" class="difflineplus">+      } else {</span>
<a href="#l26.178"></a><span id="l26.178" class="difflineplus">+        if (Enigmail.msg.isSmimeEnabled()) {</span>
<a href="#l26.179"></a><span id="l26.179" class="difflineplus">+          gSendEncrypted = (this.identity.getIntAttribute(&quot;encryptionpolicy&quot;) &gt; 0);</span>
<a href="#l26.180"></a><span id="l26.180" class="difflineplus">+          gOptionalEncryption = false;</span>
<a href="#l26.181"></a><span id="l26.181" class="difflineplus">+          gSendSigned = (this.identity.getBoolAttribute(&quot;sign_mail&quot;));</span>
<a href="#l26.182"></a><span id="l26.182" class="difflineplus">+        } else {</span>
<a href="#l26.183"></a><span id="l26.183" class="difflineplus">+          // if the user didn't yet configure s/mime, use PGP mode.</span>
<a href="#l26.184"></a><span id="l26.184" class="difflineplus">+          gSendEncrypted = false;</span>
<a href="#l26.185"></a><span id="l26.185" class="difflineplus">+          gOptionalEncryption = false;</span>
<a href="#l26.186"></a><span id="l26.186" class="difflineplus">+          gSendSigned = false;</span>
<a href="#l26.187"></a><span id="l26.187" class="difflineplus">+          gSelectedTechnologyIsPGP = true;</span>
<a href="#l26.188"></a><span id="l26.188" class="difflineplus">+        }</span>
<a href="#l26.189"></a><span id="l26.189" class="difflineplus">+      }</span>
<a href="#l26.190"></a><span id="l26.190" class="difflineplus">+      </span>
<a href="#l26.191"></a><span id="l26.191" class="difflineplus">+      // TODO: If already migrated, set variables using new pres</span>
<a href="#l26.192"></a><span id="l26.192" class="difflineplus">+    }</span>
<a href="#l26.193"></a><span id="l26.193" class="difflineplus">+</span>
<a href="#l26.194"></a><span id="l26.194" class="difflineplus">+    if (gIsRelatedToEncryptedOriginal) {</span>
<a href="#l26.195"></a><span id="l26.195" class="difflineplus">+      gSendEncrypted = true;</span>
<a href="#l26.196"></a><span id="l26.196" class="difflineplus">+    }</span>
<a href="#l26.197"></a><span id="l26.197" class="difflineplus">+  </span>
<a href="#l26.198"></a><span id="l26.198" class="difflineplus">+    if (!gSelectedTechnologyIsPGP) {</span>
<a href="#l26.199"></a><span id="l26.199" class="difflineplus">+      gSMFields.requireEncryptMessage = gSendEncrypted;</span>
<a href="#l26.200"></a><span id="l26.200" class="difflineplus">+      gSMFields.signMessage = gSendSigned;</span>
<a href="#l26.201"></a><span id="l26.201" class="difflineplus">+    }</span>
<a href="#l26.202"></a><span id="l26.202" class="difflineplus">+</span>
<a href="#l26.203"></a><span id="l26.203" class="difflineplus">+</span>
<a href="#l26.204"></a><span id="l26.204">     Enigmail.msg.composeOpen();</span>
<a href="#l26.205"></a><span id="l26.205" class="difflineminus">-    Enigmail.msg.processFinalState();</span>
<a href="#l26.206"></a><span id="l26.206" class="difflineplus">+    //Enigmail.msg.processFinalState();</span>
<a href="#l26.207"></a><span id="l26.207">     Enigmail.msg.updateStatusBar();</span>
<a href="#l26.208"></a><span id="l26.208">     Enigmail.msg.initialSendFlags();</span>
<a href="#l26.209"></a><span id="l26.209"> </span>
<a href="#l26.210"></a><span id="l26.210" class="difflineminus">-    Enigmail.msg.setFinalSendMode('final-pgpmimeYes');</span>
<a href="#l26.211"></a><span id="l26.211" class="difflineminus">-  },</span>
<a href="#l26.212"></a><span id="l26.212" class="difflineminus">-</span>
<a href="#l26.213"></a><span id="l26.213" class="difflineminus">-  delayedProcessFinalState: function() {</span>
<a href="#l26.214"></a><span id="l26.214" class="difflineminus">-    EnigmailTimer.setTimeout(function _f() {</span>
<a href="#l26.215"></a><span id="l26.215" class="difflineminus">-        Enigmail.msg.processFinalState();</span>
<a href="#l26.216"></a><span id="l26.216" class="difflineminus">-        Enigmail.msg.updateStatusBar();</span>
<a href="#l26.217"></a><span id="l26.217" class="difflineminus">-      },</span>
<a href="#l26.218"></a><span id="l26.218" class="difflineminus">-      100);</span>
<a href="#l26.219"></a><span id="l26.219" class="difflineminus">-  },</span>
<a href="#l26.220"></a><span id="l26.220" class="difflineminus">-</span>
<a href="#l26.221"></a><span id="l26.221" class="difflineminus">-  toggleSmimeToolbar: function(event) {</span>
<a href="#l26.222"></a><span id="l26.222" class="difflineminus">-    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.toggleSmimeToolbar\n&quot;);</span>
<a href="#l26.223"></a><span id="l26.223" class="difflineminus">-</span>
<a href="#l26.224"></a><span id="l26.224" class="difflineminus">-    /* global toggleSignMessage: false, toggleEncryptMessage: false */</span>
<a href="#l26.225"></a><span id="l26.225" class="difflineminus">-    switch (event.target.id) {</span>
<a href="#l26.226"></a><span id="l26.226" class="difflineminus">-      case &quot;menu_securitySign2&quot;:</span>
<a href="#l26.227"></a><span id="l26.227" class="difflineminus">-        toggleSignMessage();</span>
<a href="#l26.228"></a><span id="l26.228" class="difflineminus">-        event.stopPropagation();</span>
<a href="#l26.229"></a><span id="l26.229" class="difflineminus">-        this.toggleSMimeSign();</span>
<a href="#l26.230"></a><span id="l26.230" class="difflineminus">-        break;</span>
<a href="#l26.231"></a><span id="l26.231" class="difflineminus">-      case &quot;menu_securityEncryptRequire2&quot;:</span>
<a href="#l26.232"></a><span id="l26.232" class="difflineminus">-        toggleEncryptMessage();</span>
<a href="#l26.233"></a><span id="l26.233" class="difflineminus">-        event.stopPropagation();</span>
<a href="#l26.234"></a><span id="l26.234" class="difflineminus">-        this.toggleSMimeEncrypt();</span>
<a href="#l26.235"></a><span id="l26.235" class="difflineminus">-    }</span>
<a href="#l26.236"></a><span id="l26.236" class="difflineplus">+    //Enigmail.msg.setFinalSendMode('final-pgpmimeYes');</span>
<a href="#l26.237"></a><span id="l26.237">   },</span>
<a href="#l26.238"></a><span id="l26.238"> </span>
<a href="#l26.239"></a><span id="l26.239" class="difflineminus">-  toggleSMimeEncrypt: function() {</span>
<a href="#l26.240"></a><span id="l26.240" class="difflineminus">-    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.toggleSMimeEncrypt\n&quot;);</span>
<a href="#l26.241"></a><span id="l26.241" class="difflineminus">-</span>
<a href="#l26.242"></a><span id="l26.242" class="difflineminus">-    if (gSMFields &amp;&amp; gSMFields.requireEncryptMessage) {</span>
<a href="#l26.243"></a><span id="l26.243" class="difflineminus">-      this.encryptForced = EnigmailConstants.ENIG_ALWAYS;</span>
<a href="#l26.244"></a><span id="l26.244" class="difflineminus">-      this.pgpmimeForced = EnigmailConstants.ENIG_FORCE_SMIME;</span>
<a href="#l26.245"></a><span id="l26.245" class="difflineminus">-    }</span>
<a href="#l26.246"></a><span id="l26.246" class="difflineminus">-    else {</span>
<a href="#l26.247"></a><span id="l26.247" class="difflineminus">-      //this.encryptForced = EnigmailConstants.ENIG_FINAL_FORCENO;</span>
<a href="#l26.248"></a><span id="l26.248" class="difflineminus">-      this.setFinalSendMode('final-encryptNo');</span>
<a href="#l26.249"></a><span id="l26.249" class="difflineminus">-</span>
<a href="#l26.250"></a><span id="l26.250" class="difflineminus">-      if (!gSMFields.signMessage)</span>
<a href="#l26.251"></a><span id="l26.251" class="difflineminus">-        this.pgpmimeForced = EnigmailConstants.ENIG_UNDEF;</span>
<a href="#l26.252"></a><span id="l26.252" class="difflineminus">-    }</span>
<a href="#l26.253"></a><span id="l26.253" class="difflineminus">-    this.delayedProcessFinalState();</span>
<a href="#l26.254"></a><span id="l26.254" class="difflineplus">+</span>
<a href="#l26.255"></a><span id="l26.255" class="difflineplus">+  // TODO: call this from global compose when options change</span>
<a href="#l26.256"></a><span id="l26.256" class="difflineplus">+  enigmailComposeProcessFinalState: function() {</span>
<a href="#l26.257"></a><span id="l26.257" class="difflineplus">+    //Enigmail.msg.processFinalState();</span>
<a href="#l26.258"></a><span id="l26.258" class="difflineplus">+    Enigmail.msg.updateStatusBar();</span>
<a href="#l26.259"></a><span id="l26.259">   },</span>
<a href="#l26.260"></a><span id="l26.260"> </span>
<a href="#l26.261"></a><span id="l26.261" class="difflineminus">-  toggleSMimeSign: function() {</span>
<a href="#l26.262"></a><span id="l26.262" class="difflineminus">-    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.toggleSMimeSign\n&quot;);</span>
<a href="#l26.263"></a><span id="l26.263" class="difflineminus">-</span>
<a href="#l26.264"></a><span id="l26.264" class="difflineminus">-    if (gSMFields &amp;&amp; gSMFields.signMessage) {</span>
<a href="#l26.265"></a><span id="l26.265" class="difflineminus">-      this.signForced = EnigmailConstants.ENIG_ALWAYS;</span>
<a href="#l26.266"></a><span id="l26.266" class="difflineminus">-      this.pgpmimeForced = EnigmailConstants.ENIG_FORCE_SMIME;</span>
<a href="#l26.267"></a><span id="l26.267" class="difflineminus">-    }</span>
<a href="#l26.268"></a><span id="l26.268" class="difflineminus">-    else {</span>
<a href="#l26.269"></a><span id="l26.269" class="difflineminus">-      this.setFinalSendMode('final-signNo');</span>
<a href="#l26.270"></a><span id="l26.270" class="difflineminus">-</span>
<a href="#l26.271"></a><span id="l26.271" class="difflineminus">-      if (!gSMFields.requireEncryptMessage)</span>
<a href="#l26.272"></a><span id="l26.272" class="difflineminus">-        this.pgpmimeForced = EnigmailConstants.ENIG_UNDEF;</span>
<a href="#l26.273"></a><span id="l26.273" class="difflineminus">-    }</span>
<a href="#l26.274"></a><span id="l26.274" class="difflineminus">-    this.delayedProcessFinalState();</span>
<a href="#l26.275"></a><span id="l26.275" class="difflineminus">-  },</span>
<a href="#l26.276"></a><span id="l26.276" class="difflineminus">-</span>
<a href="#l26.277"></a><span id="l26.277" class="difflineplus">+  /*</span>
<a href="#l26.278"></a><span id="l26.278">   handleClick: function(event, modifyType) {</span>
<a href="#l26.279"></a><span id="l26.279">     EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.handleClick\n&quot;);</span>
<a href="#l26.280"></a><span id="l26.280">     switch (event.button) {</span>
<a href="#l26.281"></a><span id="l26.281">       case 2:</span>
<a href="#l26.282"></a><span id="l26.282">         // do not process the event any futher</span>
<a href="#l26.283"></a><span id="l26.283">         // needed on Windows to prevent displaying the context menu</span>
<a href="#l26.284"></a><span id="l26.284">         event.preventDefault();</span>
<a href="#l26.285"></a><span id="l26.285">         this.doPgpButton();</span>
<a href="#l26.286"></a><span id="l26.286">         break;</span>
<a href="#l26.287"></a><span id="l26.287">       case 0:</span>
<a href="#l26.288"></a><span id="l26.288">         this.doPgpButton(modifyType);</span>
<a href="#l26.289"></a><span id="l26.289">         break;</span>
<a href="#l26.290"></a><span id="l26.290">     }</span>
<a href="#l26.291"></a><span id="l26.291">   },</span>
<a href="#l26.292"></a><span id="l26.292" class="difflineplus">+  */</span>
<a href="#l26.293"></a><span id="l26.293"> </span>
<a href="#l26.294"></a><span id="l26.294"> </span>
<a href="#l26.295"></a><span id="l26.295">   setIdentityCallback: function(elementId) {</span>
<a href="#l26.296"></a><span id="l26.296">     EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.setIdentityCallback: elementId=&quot; + elementId + &quot;\n&quot;);</span>
<a href="#l26.297"></a><span id="l26.297"> </span>
<a href="#l26.298"></a><span id="l26.298">     EnigmailTimer.setTimeout(function _f() {</span>
<a href="#l26.299"></a><span id="l26.299">         Enigmail.msg.setIdentityDefaults();</span>
<a href="#l26.300"></a><span id="l26.300">       },</span>
<a href="#l26.301"></a><span id="l26.301">       100);</span>
<a href="#l26.302"></a><span id="l26.302">   },</span>
<a href="#l26.303"></a><span id="l26.303"> </span>
<a href="#l26.304"></a><span id="l26.304"> </span>
<a href="#l26.305"></a><span id="l26.305">   /* return whether the account specific setting key is enabled or disabled</span>
<a href="#l26.306"></a><span id="l26.306">    */</span>
<a href="#l26.307"></a><span id="l26.307" class="difflineplus">+  /*</span>
<a href="#l26.308"></a><span id="l26.308">   getAccDefault: function(key) {</span>
<a href="#l26.309"></a><span id="l26.309">     //EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.getAccDefault: identity=&quot;+this.identity.key+&quot;(&quot;+this.identity.email+&quot;) key=&quot;+key+&quot;\n&quot;);</span>
<a href="#l26.310"></a><span id="l26.310">     let res = null;</span>
<a href="#l26.311"></a><span id="l26.311">     let mimePreferOpenPGP = this.identity.getIntAttribute(&quot;mimePreferOpenPGP&quot;);</span>
<a href="#l26.312"></a><span id="l26.312" class="difflineminus">-    let isSmimeEnabled = this.isSmimeEnabled();</span>
<a href="#l26.313"></a><span id="l26.313" class="difflineminus">-    let isEnigmailEnabled = this.isEnigmailEnabled();</span>
<a href="#l26.314"></a><span id="l26.314" class="difflineplus">+    let isSmimeEnabled = Enigmail.msg.isSmimeEnabled();</span>
<a href="#l26.315"></a><span id="l26.315" class="difflineplus">+    let wasEnigmailEnabledForIdentity = Enigmail.msg.wasEnigmailEnabledForIdentity();</span>
<a href="#l26.316"></a><span id="l26.316">     let preferSmimeByDefault = false;</span>
<a href="#l26.317"></a><span id="l26.317"> </span>
<a href="#l26.318"></a><span id="l26.318" class="difflineminus">-    if (isSmimeEnabled &amp;&amp; isEnigmailEnabled) {</span>
<a href="#l26.319"></a><span id="l26.319" class="difflineminus">-      if (this.pgpmimeForced === EnigmailConstants.ENIG_FORCE_SMIME) {</span>
<a href="#l26.320"></a><span id="l26.320" class="difflineminus">-        preferSmimeByDefault = true;</span>
<a href="#l26.321"></a><span id="l26.321" class="difflineminus">-      }</span>
<a href="#l26.322"></a><span id="l26.322" class="difflineminus">-      else if (this.pgpmimeForced === EnigmailConstants.ENIG_FORCE_ALWAYS) {</span>
<a href="#l26.323"></a><span id="l26.323" class="difflineminus">-        preferSmimeByDefault = true;</span>
<a href="#l26.324"></a><span id="l26.324" class="difflineminus">-      }</span>
<a href="#l26.325"></a><span id="l26.325" class="difflineminus">-      else {</span>
<a href="#l26.326"></a><span id="l26.326" class="difflineminus">-        preferSmimeByDefault = (mimePreferOpenPGP === 0);</span>
<a href="#l26.327"></a><span id="l26.327" class="difflineminus">-      }</span>
<a href="#l26.328"></a><span id="l26.328" class="difflineplus">+    if (isSmimeEnabled &amp;&amp; wasEnigmailEnabledForIdentity) {</span>
<a href="#l26.329"></a><span id="l26.329">     }</span>
<a href="#l26.330"></a><span id="l26.330"> </span>
<a href="#l26.331"></a><span id="l26.331" class="difflineminus">-    if (isEnigmailEnabled) {</span>
<a href="#l26.332"></a><span id="l26.332" class="difflineplus">+    if (wasEnigmailEnabledForIdentity) {</span>
<a href="#l26.333"></a><span id="l26.333">       switch (key) {</span>
<a href="#l26.334"></a><span id="l26.334">         case 'sign':</span>
<a href="#l26.335"></a><span id="l26.335">           if (preferSmimeByDefault) {</span>
<a href="#l26.336"></a><span id="l26.336">             res = (this.identity.getBoolAttribute(&quot;sign_mail&quot;));</span>
<a href="#l26.337"></a><span id="l26.337">           }</span>
<a href="#l26.338"></a><span id="l26.338">           else {</span>
<a href="#l26.339"></a><span id="l26.339">             res = (this.identity.getIntAttribute(&quot;defaultSigningPolicy&quot;) &gt; 0);</span>
<a href="#l26.340"></a><span id="l26.340">           }</span>
<a href="#l26.341"></a><span id="l26.341" class="difflineat">@@ -309,30 +265,24 @@ Enigmail.msg = {</span>
<a href="#l26.342"></a><span id="l26.342">           }</span>
<a href="#l26.343"></a><span id="l26.343">           break;</span>
<a href="#l26.344"></a><span id="l26.344">         case 'sign-pgp':</span>
<a href="#l26.345"></a><span id="l26.345">           res = (this.identity.getIntAttribute(&quot;defaultSigningPolicy&quot;) &gt; 0);</span>
<a href="#l26.346"></a><span id="l26.346">           break;</span>
<a href="#l26.347"></a><span id="l26.347">         case 'pgpMimeMode':</span>
<a href="#l26.348"></a><span id="l26.348">           res = this.identity.getBoolAttribute(key);</span>
<a href="#l26.349"></a><span id="l26.349">           break;</span>
<a href="#l26.350"></a><span id="l26.350" class="difflineminus">-        case 'signIfNotEnc':</span>
<a href="#l26.351"></a><span id="l26.351" class="difflineminus">-          res = this.identity.getBoolAttribute(&quot;pgpSignPlain&quot;);</span>
<a href="#l26.352"></a><span id="l26.352" class="difflineminus">-          break;</span>
<a href="#l26.353"></a><span id="l26.353" class="difflineminus">-        case 'signIfEnc':</span>
<a href="#l26.354"></a><span id="l26.354" class="difflineminus">-          res = this.identity.getBoolAttribute(&quot;pgpSignEncrypted&quot;);</span>
<a href="#l26.355"></a><span id="l26.355" class="difflineminus">-          break;</span>
<a href="#l26.356"></a><span id="l26.356">         case 'attachPgpKey':</span>
<a href="#l26.357"></a><span id="l26.357">           res = this.identity.getBoolAttribute(key);</span>
<a href="#l26.358"></a><span id="l26.358">           break;</span>
<a href="#l26.359"></a><span id="l26.359">       }</span>
<a href="#l26.360"></a><span id="l26.360">       //EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.getAccDefault:   &quot;+key+&quot;=&quot;+res+&quot;\n&quot;);</span>
<a href="#l26.361"></a><span id="l26.361">       return res;</span>
<a href="#l26.362"></a><span id="l26.362">     }</span>
<a href="#l26.363"></a><span id="l26.363" class="difflineminus">-    else if (this.isSmimeEnabled()) {</span>
<a href="#l26.364"></a><span id="l26.364" class="difflineplus">+    else if (Enigmail.msg.isSmimeEnabled()) {</span>
<a href="#l26.365"></a><span id="l26.365">       switch (key) {</span>
<a href="#l26.366"></a><span id="l26.366">         case 'sign':</span>
<a href="#l26.367"></a><span id="l26.367">           res = this.identity.getBoolAttribute(&quot;sign_mail&quot;);</span>
<a href="#l26.368"></a><span id="l26.368">           break;</span>
<a href="#l26.369"></a><span id="l26.369">         case 'encrypt':</span>
<a href="#l26.370"></a><span id="l26.370">           res = (this.identity.getIntAttribute(&quot;encryptionpolicy&quot;) &gt; 0);</span>
<a href="#l26.371"></a><span id="l26.371">           break;</span>
<a href="#l26.372"></a><span id="l26.372">         default:</span>
<a href="#l26.373"></a><span id="l26.373" class="difflineat">@@ -340,127 +290,137 @@ Enigmail.msg = {</span>
<a href="#l26.374"></a><span id="l26.374">       }</span>
<a href="#l26.375"></a><span id="l26.375">       return res;</span>
<a href="#l26.376"></a><span id="l26.376">     }</span>
<a href="#l26.377"></a><span id="l26.377">     else {</span>
<a href="#l26.378"></a><span id="l26.378">       // every detail is disabled if OpenPGP in general is disabled:</span>
<a href="#l26.379"></a><span id="l26.379">       switch (key) {</span>
<a href="#l26.380"></a><span id="l26.380">         case 'sign':</span>
<a href="#l26.381"></a><span id="l26.381">         case 'encrypt':</span>
<a href="#l26.382"></a><span id="l26.382" class="difflineminus">-        case 'signIfNotEnc':</span>
<a href="#l26.383"></a><span id="l26.383" class="difflineminus">-        case 'signIfEnc':</span>
<a href="#l26.384"></a><span id="l26.384">         case 'pgpMimeMode':</span>
<a href="#l26.385"></a><span id="l26.385">         case 'attachPgpKey':</span>
<a href="#l26.386"></a><span id="l26.386">         case 'sign-pgp':</span>
<a href="#l26.387"></a><span id="l26.387">           return false;</span>
<a href="#l26.388"></a><span id="l26.388">       }</span>
<a href="#l26.389"></a><span id="l26.389">     }</span>
<a href="#l26.390"></a><span id="l26.390"> </span>
<a href="#l26.391"></a><span id="l26.391">     // should not be reached</span>
<a href="#l26.392"></a><span id="l26.392">     EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.getAccDefault:   internal error: invalid key '&quot; + key + &quot;'\n&quot;);</span>
<a href="#l26.393"></a><span id="l26.393">     return null;</span>
<a href="#l26.394"></a><span id="l26.394">   },</span>
<a href="#l26.395"></a><span id="l26.395" class="difflineplus">+  */</span>
<a href="#l26.396"></a><span id="l26.396"> </span>
<a href="#l26.397"></a><span id="l26.397">   /**</span>
<a href="#l26.398"></a><span id="l26.398">    * Determine if any of Enigmail (OpenPGP) or S/MIME encryption is enabled for the account</span>
<a href="#l26.399"></a><span id="l26.399">    */</span>
<a href="#l26.400"></a><span id="l26.400" class="difflineminus">-  getEncryptionEnabled: function() {</span>
<a href="#l26.401"></a><span id="l26.401" class="difflineplus">+  /*</span>
<a href="#l26.402"></a><span id="l26.402" class="difflineplus">+  isAnyEncryptionEnabled: function() {</span>
<a href="#l26.403"></a><span id="l26.403">     let id = getCurrentIdentity();</span>
<a href="#l26.404"></a><span id="l26.404"> </span>
<a href="#l26.405"></a><span id="l26.405">     return ((id.getUnicharAttribute(&quot;encryption_cert_name&quot;) !== &quot;&quot;) ||</span>
<a href="#l26.406"></a><span id="l26.406" class="difflineminus">-      this.isEnigmailEnabled());</span>
<a href="#l26.407"></a><span id="l26.407" class="difflineplus">+      Enigmail.msg.wasEnigmailEnabledForIdentity());</span>
<a href="#l26.408"></a><span id="l26.408">   },</span>
<a href="#l26.409"></a><span id="l26.409" class="difflineplus">+  */</span>
<a href="#l26.410"></a><span id="l26.410"> </span>
<a href="#l26.411"></a><span id="l26.411">   isSmimeEnabled: function() {</span>
<a href="#l26.412"></a><span id="l26.412">     let id = getCurrentIdentity();</span>
<a href="#l26.413"></a><span id="l26.413"> </span>
<a href="#l26.414"></a><span id="l26.414">     return ((id.getUnicharAttribute(&quot;signing_cert_name&quot;) !== &quot;&quot;) ||</span>
<a href="#l26.415"></a><span id="l26.415">       (id.getUnicharAttribute(&quot;encryption_cert_name&quot;) !== &quot;&quot;));</span>
<a href="#l26.416"></a><span id="l26.416">   },</span>
<a href="#l26.417"></a><span id="l26.417"> </span>
<a href="#l26.418"></a><span id="l26.418">   /**</span>
<a href="#l26.419"></a><span id="l26.419">    * Determine if any of Enigmail (OpenPGP) or S/MIME signing is enabled for the account</span>
<a href="#l26.420"></a><span id="l26.420">    */</span>
<a href="#l26.421"></a><span id="l26.421" class="difflineplus">+  /*</span>
<a href="#l26.422"></a><span id="l26.422">   getSigningEnabled: function() {</span>
<a href="#l26.423"></a><span id="l26.423">     let id = getCurrentIdentity();</span>
<a href="#l26.424"></a><span id="l26.424"> </span>
<a href="#l26.425"></a><span id="l26.425">     return ((id.getUnicharAttribute(&quot;signing_cert_name&quot;) !== &quot;&quot;) ||</span>
<a href="#l26.426"></a><span id="l26.426" class="difflineminus">-      this.isEnigmailEnabled());</span>
<a href="#l26.427"></a><span id="l26.427" class="difflineplus">+      Enigmail.msg.wasEnigmailEnabledForIdentity());</span>
<a href="#l26.428"></a><span id="l26.428">   },</span>
<a href="#l26.429"></a><span id="l26.429" class="difflineminus">-</span>
<a href="#l26.430"></a><span id="l26.430" class="difflineplus">+  */</span>
<a href="#l26.431"></a><span id="l26.431" class="difflineplus">+</span>
<a href="#l26.432"></a><span id="l26.432" class="difflineplus">+  /*</span>
<a href="#l26.433"></a><span id="l26.433">   getSmimeSigningEnabled: function() {</span>
<a href="#l26.434"></a><span id="l26.434">     let id = getCurrentIdentity();</span>
<a href="#l26.435"></a><span id="l26.435"> </span>
<a href="#l26.436"></a><span id="l26.436">     if (!id.getUnicharAttribute(&quot;signing_cert_name&quot;)) return false;</span>
<a href="#l26.437"></a><span id="l26.437"> </span>
<a href="#l26.438"></a><span id="l26.438">     return id.getBoolAttribute(&quot;sign_mail&quot;);</span>
<a href="#l26.439"></a><span id="l26.439">   },</span>
<a href="#l26.440"></a><span id="l26.440" class="difflineplus">+  */</span>
<a href="#l26.441"></a><span id="l26.441"> </span>
<a href="#l26.442"></a><span id="l26.442">   setIdentityDefaults: function() {</span>
<a href="#l26.443"></a><span id="l26.443">     EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.setIdentityDefaults\n&quot;);</span>
<a href="#l26.444"></a><span id="l26.444"> </span>
<a href="#l26.445"></a><span id="l26.445">     this.identity = getCurrentIdentity();</span>
<a href="#l26.446"></a><span id="l26.446" class="difflineminus">-    if (!this.isEnigmailEnabled()) {</span>
<a href="#l26.447"></a><span id="l26.447" class="difflineplus">+</span>
<a href="#l26.448"></a><span id="l26.448" class="difflineplus">+    if (!Enigmail.msg.isEnigmailEnabledForIdentity()) {</span>
<a href="#l26.449"></a><span id="l26.449">       // reset status strings in menu to useful defaults</span>
<a href="#l26.450"></a><span id="l26.450">       this.statusEncryptedStr = EnigmailLocale.getString(&quot;encryptNo&quot;);</span>
<a href="#l26.451"></a><span id="l26.451">       this.statusSignedStr = EnigmailLocale.getString(&quot;signNo&quot;, [&quot;&quot;]);</span>
<a href="#l26.452"></a><span id="l26.452" class="difflineminus">-      this.statusPGPMimeStr = EnigmailLocale.getString(&quot;pgpmimeNormal&quot;);</span>
<a href="#l26.453"></a><span id="l26.453" class="difflineminus">-      this.statusInlinePGPStr = EnigmailLocale.getString(&quot;inlinePGPNormal&quot;);</span>
<a href="#l26.454"></a><span id="l26.454" class="difflineminus">-      this.statusSMimeStr = EnigmailLocale.getString(&quot;smimeNormal&quot;);</span>
<a href="#l26.455"></a><span id="l26.455" class="difflineplus">+      //this.statusPGPMimeStr = EnigmailLocale.getString(&quot;pgpmimeNormal&quot;);</span>
<a href="#l26.456"></a><span id="l26.456" class="difflineplus">+      //this.statusInlinePGPStr = EnigmailLocale.getString(&quot;inlinePGPNormal&quot;);</span>
<a href="#l26.457"></a><span id="l26.457" class="difflineplus">+      //this.statusSMimeStr = EnigmailLocale.getString(&quot;smimeNormal&quot;);</span>
<a href="#l26.458"></a><span id="l26.458">       this.statusAttachOwnKey = EnigmailLocale.getString(&quot;attachOwnKeyNo&quot;);</span>
<a href="#l26.459"></a><span id="l26.459">     }</span>
<a href="#l26.460"></a><span id="l26.460"> </span>
<a href="#l26.461"></a><span id="l26.461">     // reset default send settings, unless we have changed them already</span>
<a href="#l26.462"></a><span id="l26.462" class="difflineplus">+</span>
<a href="#l26.463"></a><span id="l26.463" class="difflineplus">+    // instead of sendModeDirty, use gUserTouched*</span>
<a href="#l26.464"></a><span id="l26.464" class="difflineplus">+</span>
<a href="#l26.465"></a><span id="l26.465" class="difflineplus">+    /*</span>
<a href="#l26.466"></a><span id="l26.466">     if (!this.sendModeDirty) {</span>
<a href="#l26.467"></a><span id="l26.467" class="difflineminus">-      this.mimePreferOpenPGP = this.identity.getIntAttribute(&quot;mimePreferOpenPGP&quot;);</span>
<a href="#l26.468"></a><span id="l26.468" class="difflineminus">-      this.processAccountSpecificDefaultOptions();</span>
<a href="#l26.469"></a><span id="l26.469" class="difflineplus">+      //this.mimePreferOpenPGP = this.identity.getIntAttribute(&quot;mimePreferOpenPGP&quot;);</span>
<a href="#l26.470"></a><span id="l26.470" class="difflineplus">+      //this.processAccountSpecificDefaultOptions();</span>
<a href="#l26.471"></a><span id="l26.471">       this.determineSendFlags(); // important to use identity specific settings</span>
<a href="#l26.472"></a><span id="l26.472" class="difflineminus">-      this.processFinalState();</span>
<a href="#l26.473"></a><span id="l26.473" class="difflineplus">+      //this.processFinalState();</span>
<a href="#l26.474"></a><span id="l26.474">       this.updateStatusBar();</span>
<a href="#l26.475"></a><span id="l26.475">     }</span>
<a href="#l26.476"></a><span id="l26.476" class="difflineplus">+    */</span>
<a href="#l26.477"></a><span id="l26.477">   },</span>
<a href="#l26.478"></a><span id="l26.478"> </span>
<a href="#l26.479"></a><span id="l26.479"> </span>
<a href="#l26.480"></a><span id="l26.480" class="difflineplus">+  /*</span>
<a href="#l26.481"></a><span id="l26.481">   // set the current default for sending a message</span>
<a href="#l26.482"></a><span id="l26.482">   // depending on the identity</span>
<a href="#l26.483"></a><span id="l26.483">   processAccountSpecificDefaultOptions: function() {</span>
<a href="#l26.484"></a><span id="l26.484">     EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.processAccountSpecificDefaultOptions\n&quot;);</span>
<a href="#l26.485"></a><span id="l26.485"> </span>
<a href="#l26.486"></a><span id="l26.486">     const SIGN = EnigmailConstants.SEND_SIGNED;</span>
<a href="#l26.487"></a><span id="l26.487">     const ENCRYPT = EnigmailConstants.SEND_ENCRYPTED;</span>
<a href="#l26.488"></a><span id="l26.488"> </span>
<a href="#l26.489"></a><span id="l26.489">     this.sendMode = 0;</span>
<a href="#l26.490"></a><span id="l26.490"> </span>
<a href="#l26.491"></a><span id="l26.491">     if (this.getSmimeSigningEnabled()) {</span>
<a href="#l26.492"></a><span id="l26.492">       this.sendMode |= SIGN;</span>
<a href="#l26.493"></a><span id="l26.493" class="difflineminus">-      this.reasonSigned = EnigmailLocale.getString(&quot;reasonEnabledByDefault&quot;);</span>
<a href="#l26.494"></a><span id="l26.494">     }</span>
<a href="#l26.495"></a><span id="l26.495"> </span>
<a href="#l26.496"></a><span id="l26.496" class="difflineminus">-    if (!this.isEnigmailEnabled()) {</span>
<a href="#l26.497"></a><span id="l26.497" class="difflineplus">+    if (!Enigmail.msg.wasEnigmailEnabledForIdentity()) {</span>
<a href="#l26.498"></a><span id="l26.498">       return;</span>
<a href="#l26.499"></a><span id="l26.499">     }</span>
<a href="#l26.500"></a><span id="l26.500"> </span>
<a href="#l26.501"></a><span id="l26.501">     if (this.getAccDefault(&quot;encrypt&quot;)) {</span>
<a href="#l26.502"></a><span id="l26.502">       this.sendMode |= ENCRYPT;</span>
<a href="#l26.503"></a><span id="l26.503" class="difflineminus">-      this.reasonEncrypted = EnigmailLocale.getString(&quot;reasonEnabledByDefault&quot;);</span>
<a href="#l26.504"></a><span id="l26.504">     }</span>
<a href="#l26.505"></a><span id="l26.505">     if (this.getAccDefault(&quot;sign&quot;)) {</span>
<a href="#l26.506"></a><span id="l26.506">       this.sendMode |= SIGN;</span>
<a href="#l26.507"></a><span id="l26.507" class="difflineminus">-      this.reasonSigned = EnigmailLocale.getString(&quot;reasonEnabledByDefault&quot;);</span>
<a href="#l26.508"></a><span id="l26.508">     }</span>
<a href="#l26.509"></a><span id="l26.509"> </span>
<a href="#l26.510"></a><span id="l26.510" class="difflineminus">-    this.sendPgpMime = this.getAccDefault(&quot;pgpMimeMode&quot;);</span>
<a href="#l26.511"></a><span id="l26.511" class="difflineminus">-    console.debug(&quot;processAccountSpecificDefaultOptions sendPgpMime: &quot; + this.sendPgpMime);</span>
<a href="#l26.512"></a><span id="l26.512" class="difflineminus">-    this.attachOwnKeyObj.appendAttachment = this.getAccDefault(&quot;attachPgpKey&quot;);</span>
<a href="#l26.513"></a><span id="l26.513" class="difflineplus">+    //this.sendPgpMime = this.getAccDefault(&quot;pgpMimeMode&quot;);</span>
<a href="#l26.514"></a><span id="l26.514" class="difflineplus">+    //console.debug(&quot;processAccountSpecificDefaultOptions sendPgpMime: &quot; + this.sendPgpMime);</span>
<a href="#l26.515"></a><span id="l26.515" class="difflineplus">+    gAttachMyPublicPGPKey = this.getAccDefault(&quot;attachPgpKey&quot;);</span>
<a href="#l26.516"></a><span id="l26.516">     this.setOwnKeyStatus();</span>
<a href="#l26.517"></a><span id="l26.517">     this.attachOwnKeyObj.attachedObj = null;</span>
<a href="#l26.518"></a><span id="l26.518">     this.attachOwnKeyObj.attachedKey = null;</span>
<a href="#l26.519"></a><span id="l26.519"> </span>
<a href="#l26.520"></a><span id="l26.520" class="difflineminus">-    this.finalSignDependsOnEncrypt = (this.getAccDefault(&quot;signIfEnc&quot;) || this.getAccDefault(&quot;signIfNotEnc&quot;));</span>
<a href="#l26.521"></a><span id="l26.521" class="difflineplus">+    //this.finalSignDependsOnEncrypt = (this.getAccDefault(&quot;signIfEnc&quot;) || this.getAccDefault(&quot;signIfNotEnc&quot;));</span>
<a href="#l26.522"></a><span id="l26.522">   },</span>
<a href="#l26.523"></a><span id="l26.523" class="difflineplus">+  */</span>
<a href="#l26.524"></a><span id="l26.524"> </span>
<a href="#l26.525"></a><span id="l26.525">   getOriginalMsgUri: function() {</span>
<a href="#l26.526"></a><span id="l26.526">     let draftId = gMsgCompose.compFields.draftId;</span>
<a href="#l26.527"></a><span id="l26.527">     let msgUri = null;</span>
<a href="#l26.528"></a><span id="l26.528"> </span>
<a href="#l26.529"></a><span id="l26.529">     if (typeof(draftId) == &quot;string&quot; &amp;&amp; draftId.length &gt; 0) {</span>
<a href="#l26.530"></a><span id="l26.530">       // original message is draft</span>
<a href="#l26.531"></a><span id="l26.531">       msgUri = draftId.replace(/\?.*$/, &quot;&quot;);</span>
<a href="#l26.532"></a><span id="l26.532" class="difflineat">@@ -530,16 +490,18 @@ Enigmail.msg = {</span>
<a href="#l26.533"></a><span id="l26.533">       stat = String(mimeMsg.headers.get(&quot;x-enigmail-draft-status&quot;).join(&quot;&quot;));</span>
<a href="#l26.534"></a><span id="l26.534">     }</span>
<a href="#l26.535"></a><span id="l26.535">     else {</span>
<a href="#l26.536"></a><span id="l26.536">       return;</span>
<a href="#l26.537"></a><span id="l26.537">     }</span>
<a href="#l26.538"></a><span id="l26.538"> </span>
<a href="#l26.539"></a><span id="l26.539">     EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.setDraftOptions: draftStatus: &quot; + stat + &quot;\n&quot;);</span>
<a href="#l26.540"></a><span id="l26.540"> </span>
<a href="#l26.541"></a><span id="l26.541" class="difflineplus">+    // TODO: rewrite to properly read old draft header information</span>
<a href="#l26.542"></a><span id="l26.542" class="difflineplus">+    /*</span>
<a href="#l26.543"></a><span id="l26.543">     if (stat.substr(0, 1) == &quot;N&quot;) {</span>
<a href="#l26.544"></a><span id="l26.544">       // new style drafts (Enigmail 1.7)</span>
<a href="#l26.545"></a><span id="l26.545"> </span>
<a href="#l26.546"></a><span id="l26.546">       var enc = &quot;final-encryptDefault&quot;;</span>
<a href="#l26.547"></a><span id="l26.547">       switch (Number(stat.substr(1, 1))) {</span>
<a href="#l26.548"></a><span id="l26.548">         case EnigmailConstants.ENIG_NEVER:</span>
<a href="#l26.549"></a><span id="l26.549">           enc = &quot;final-encryptNo&quot;;</span>
<a href="#l26.550"></a><span id="l26.550">           break;</span>
<a href="#l26.551"></a><span id="l26.551" class="difflineat">@@ -577,17 +539,18 @@ Enigmail.msg = {</span>
<a href="#l26.552"></a><span id="l26.552">     else {</span>
<a href="#l26.553"></a><span id="l26.553">       // drafts from older versions of Enigmail</span>
<a href="#l26.554"></a><span id="l26.554">       var flags = Number(stat);</span>
<a href="#l26.555"></a><span id="l26.555">       if (flags &amp; EnigmailConstants.SEND_SIGNED) Enigmail.msg.setFinalSendMode('final-signYes');</span>
<a href="#l26.556"></a><span id="l26.556">       if (flags &amp; EnigmailConstants.SEND_ENCRYPTED) Enigmail.msg.setFinalSendMode('final-encryptYes');</span>
<a href="#l26.557"></a><span id="l26.557">       if (flags &amp; EnigmailConstants.SEND_ATTACHMENT)</span>
<a href="#l26.558"></a><span id="l26.558">         Enigmail.msg.attachOwnKeyObj.appendAttachment = true;</span>
<a href="#l26.559"></a><span id="l26.559">     }</span>
<a href="#l26.560"></a><span id="l26.560" class="difflineminus">-    Enigmail.msg.setOwnKeyStatus();</span>
<a href="#l26.561"></a><span id="l26.561" class="difflineplus">+    //Enigmail.msg.setOwnKeyStatus();</span>
<a href="#l26.562"></a><span id="l26.562" class="difflineplus">+    */</span>
<a href="#l26.563"></a><span id="l26.563">   },</span>
<a href="#l26.564"></a><span id="l26.564"> </span>
<a href="#l26.565"></a><span id="l26.565">   setOriginalSubject: function(subject, forceSetting) {</span>
<a href="#l26.566"></a><span id="l26.566">     const CT = Components.interfaces.nsIMsgCompType;</span>
<a href="#l26.567"></a><span id="l26.567">     let subjElem = document.getElementById(&quot;msgSubject&quot;);</span>
<a href="#l26.568"></a><span id="l26.568">     let prefix = &quot;&quot;;</span>
<a href="#l26.569"></a><span id="l26.569"> </span>
<a href="#l26.570"></a><span id="l26.570">     if (!subjElem) return;</span>
<a href="#l26.571"></a><span id="l26.571" class="difflineat">@@ -657,36 +620,35 @@ Enigmail.msg = {</span>
<a href="#l26.572"></a><span id="l26.572"> </span>
<a href="#l26.573"></a><span id="l26.573">     var msgFlags;</span>
<a href="#l26.574"></a><span id="l26.574">     var msgUri = null;</span>
<a href="#l26.575"></a><span id="l26.575">     var msgIsDraft = false;</span>
<a href="#l26.576"></a><span id="l26.576"> </span>
<a href="#l26.577"></a><span id="l26.577">     this.setupMenuAndToolbar();</span>
<a href="#l26.578"></a><span id="l26.578"> </span>
<a href="#l26.579"></a><span id="l26.579">     this.determineSendFlagId = null;</span>
<a href="#l26.580"></a><span id="l26.580" class="difflineminus">-    this.disableSmime = false;</span>
<a href="#l26.581"></a><span id="l26.581" class="difflineplus">+    //this.disableSmime = false;</span>
<a href="#l26.582"></a><span id="l26.582">     this.saveDraftError = 0;</span>
<a href="#l26.583"></a><span id="l26.583">     this.protectHeaders = (EnigmailPrefs.getPref(&quot;protectedHeaders&quot;) === 2);</span>
<a href="#l26.584"></a><span id="l26.584" class="difflineminus">-    this.enableUndoEncryption(false);</span>
<a href="#l26.585"></a><span id="l26.585" class="difflineplus">+    //this.enableUndoEncryption(false);</span>
<a href="#l26.586"></a><span id="l26.586"> </span>
<a href="#l26.587"></a><span id="l26.587">     this.displayProtectHeadersStatus();</span>
<a href="#l26.588"></a><span id="l26.588"> </span>
<a href="#l26.589"></a><span id="l26.589">     var toobarElem = document.getElementById(&quot;composeToolbar2&quot;);</span>
<a href="#l26.590"></a><span id="l26.590">     if (toobarElem &amp;&amp; (EnigmailOS.getOS() == &quot;Darwin&quot;)) {</span>
<a href="#l26.591"></a><span id="l26.591">       toobarElem.setAttribute(&quot;platform&quot;, &quot;macos&quot;);</span>
<a href="#l26.592"></a><span id="l26.592">     }</span>
<a href="#l26.593"></a><span id="l26.593"> </span>
<a href="#l26.594"></a><span id="l26.594">     /*</span>
<a href="#l26.595"></a><span id="l26.595">     // remove overlay_source from enigmail-bc-sendprocess, which will be inherited to</span>
<a href="#l26.596"></a><span id="l26.596">     // addressCol2 and addressCol1 (those would be removed if Enigmail is uninstalled)</span>
<a href="#l26.597"></a><span id="l26.597">     let bc = document.getElementById(&quot;enigmail-bc-sendprocess&quot;);</span>
<a href="#l26.598"></a><span id="l26.598">     bc.removeAttribute(&quot;overlay_source&quot;);</span>
<a href="#l26.599"></a><span id="l26.599">     */</span>
<a href="#l26.600"></a><span id="l26.600"> </span>
<a href="#l26.601"></a><span id="l26.601" class="difflineminus">-    // check rules for status bar icons on each change of the recipients</span>
<a href="#l26.602"></a><span id="l26.602">     // Thunderbird</span>
<a href="#l26.603"></a><span id="l26.603">     var adrCol = document.getElementById(&quot;addressCol2#1&quot;); // recipients field</span>
<a href="#l26.604"></a><span id="l26.604">     if (adrCol) {</span>
<a href="#l26.605"></a><span id="l26.605">       let attr = adrCol.getAttribute(&quot;oninput&quot;);</span>
<a href="#l26.606"></a><span id="l26.606">       adrCol.setAttribute(&quot;oninput&quot;, attr + &quot;; Enigmail.msg.addressOnChange();&quot;);</span>
<a href="#l26.607"></a><span id="l26.607">       attr = adrCol.getAttribute(&quot;onchange&quot;);</span>
<a href="#l26.608"></a><span id="l26.608">       adrCol.setAttribute(&quot;onchange&quot;, attr + &quot;; Enigmail.msg.addressOnChange();&quot;);</span>
<a href="#l26.609"></a><span id="l26.609">       //adrCol.setAttribute(&quot;observes&quot;, &quot;enigmail-bc-sendprocess&quot;);</span>
<a href="#l26.610"></a><span id="l26.610" class="difflineat">@@ -696,49 +658,54 @@ Enigmail.msg = {</span>
<a href="#l26.611"></a><span id="l26.611">       let attr = adrCol.getAttribute(&quot;oncommand&quot;);</span>
<a href="#l26.612"></a><span id="l26.612">       adrCol.setAttribute(&quot;oncommand&quot;, attr + &quot;; Enigmail.msg.addressOnChange();&quot;);</span>
<a href="#l26.613"></a><span id="l26.613">       //adrCol.setAttribute(&quot;observes&quot;, &quot;enigmail-bc-sendprocess&quot;);</span>
<a href="#l26.614"></a><span id="l26.614">     }</span>
<a href="#l26.615"></a><span id="l26.615"> </span>
<a href="#l26.616"></a><span id="l26.616">     var draftId = gMsgCompose.compFields.draftId;</span>
<a href="#l26.617"></a><span id="l26.617">     let selectedElement = document.activeElement;</span>
<a href="#l26.618"></a><span id="l26.618"> </span>
<a href="#l26.619"></a><span id="l26.619" class="difflineminus">-    if (EnigmailPrefs.getPref(&quot;keepSettingsForReply&quot;) &amp;&amp; (!(this.sendMode &amp; ENCRYPT)) || (typeof(draftId) == &quot;string&quot; &amp;&amp; draftId.length &gt; 0)) {</span>
<a href="#l26.620"></a><span id="l26.620" class="difflineplus">+    //if (EnigmailPrefs.getPref(&quot;keepSettingsForReply&quot;) &amp;&amp; (!(this.sendMode &amp; ENCRYPT)) || (typeof(draftId) == &quot;string&quot; &amp;&amp; draftId.length &gt; 0)) {</span>
<a href="#l26.621"></a><span id="l26.621" class="difflineplus">+    if (typeof(draftId) == &quot;string&quot; &amp;&amp; draftId.length &gt; 0) {</span>
<a href="#l26.622"></a><span id="l26.622"> </span>
<a href="#l26.623"></a><span id="l26.623">       /* global gEncryptedURIService: false */</span>
<a href="#l26.624"></a><span id="l26.624" class="difflineplus">+      /*</span>
<a href="#l26.625"></a><span id="l26.625">       if (gEncryptedURIService &amp;&amp; gEncryptedURIService.isEncrypted(gMsgCompose.originalMsgURI)) {</span>
<a href="#l26.626"></a><span id="l26.626">         // Enable S/MIME encryption if original is known as encrypted.</span>
<a href="#l26.627"></a><span id="l26.627" class="difflineminus">-        this.setFinalSendMode('final-encryptYes');</span>
<a href="#l26.628"></a><span id="l26.628" class="difflineplus">+        //this.setFinalSendMode('final-encryptYes');</span>
<a href="#l26.629"></a><span id="l26.629">       }</span>
<a href="#l26.630"></a><span id="l26.630" class="difflineplus">+      */</span>
<a href="#l26.631"></a><span id="l26.631">       msgUri = this.getOriginalMsgUri();</span>
<a href="#l26.632"></a><span id="l26.632"> </span>
<a href="#l26.633"></a><span id="l26.633">       if (typeof(draftId) == &quot;string&quot; &amp;&amp; draftId.length &gt; 0) {</span>
<a href="#l26.634"></a><span id="l26.634">         // original message is draft</span>
<a href="#l26.635"></a><span id="l26.635">         msgIsDraft = true;</span>
<a href="#l26.636"></a><span id="l26.636">       }</span>
<a href="#l26.637"></a><span id="l26.637"> </span>
<a href="#l26.638"></a><span id="l26.638">       if (msgUri) {</span>
<a href="#l26.639"></a><span id="l26.639">         msgFlags = this.getMsgProperties(msgIsDraft);</span>
<a href="#l26.640"></a><span id="l26.640">         if (!msgIsDraft) {</span>
<a href="#l26.641"></a><span id="l26.641">           if (msgFlags &amp; EnigmailConstants.DECRYPTION_OKAY) {</span>
<a href="#l26.642"></a><span id="l26.642">             EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.composeOpen: has encrypted originalMsgUri\n&quot;);</span>
<a href="#l26.643"></a><span id="l26.643">             EnigmailLog.DEBUG(&quot;originalMsgURI=&quot; + gMsgCompose.originalMsgURI + &quot;\n&quot;);</span>
<a href="#l26.644"></a><span id="l26.644" class="difflineminus">-            this.setFinalSendMode('final-encryptYes');</span>
<a href="#l26.645"></a><span id="l26.645" class="difflineplus">+            //this.setFinalSendMode('final-encryptYes');</span>
<a href="#l26.646"></a><span id="l26.646" class="difflineplus">+            gIsRelatedToEncryptedOriginal = true;</span>
<a href="#l26.647"></a><span id="l26.647"> </span>
<a href="#l26.648"></a><span id="l26.648">             this.identity = getCurrentIdentity();</span>
<a href="#l26.649"></a><span id="l26.649">             if (this.identity.getBoolAttribute(&quot;pgpSignEncrypted&quot;)) {</span>
<a href="#l26.650"></a><span id="l26.650" class="difflineminus">-              this.setFinalSendMode('final-signYes');</span>
<a href="#l26.651"></a><span id="l26.651" class="difflineplus">+              //this.setFinalSendMode('final-signYes');</span>
<a href="#l26.652"></a><span id="l26.652">             }</span>
<a href="#l26.653"></a><span id="l26.653"> </span>
<a href="#l26.654"></a><span id="l26.654" class="difflineminus">-            this.disableSmime = true;</span>
<a href="#l26.655"></a><span id="l26.655" class="difflineplus">+            //this.disableSmime = true;</span>
<a href="#l26.656"></a><span id="l26.656">           }</span>
<a href="#l26.657"></a><span id="l26.657">           else if (msgFlags &amp; (EnigmailConstants.GOOD_SIGNATURE |</span>
<a href="#l26.658"></a><span id="l26.658">               EnigmailConstants.BAD_SIGNATURE |</span>
<a href="#l26.659"></a><span id="l26.659">               EnigmailConstants.UNVERIFIED_SIGNATURE)) {</span>
<a href="#l26.660"></a><span id="l26.660" class="difflineminus">-            this.setSendMode('sign');</span>
<a href="#l26.661"></a><span id="l26.661" class="difflineplus">+            //this.setSendMode('sign');</span>
<a href="#l26.662"></a><span id="l26.662" class="difflineplus">+            gIsRelatedToSignedOriginal = true;</span>
<a href="#l26.663"></a><span id="l26.663">           }</span>
<a href="#l26.664"></a><span id="l26.664">         }</span>
<a href="#l26.665"></a><span id="l26.665">         this.removeAttachedKey();</span>
<a href="#l26.666"></a><span id="l26.666">       }</span>
<a href="#l26.667"></a><span id="l26.667">     }</span>
<a href="#l26.668"></a><span id="l26.668"> </span>
<a href="#l26.669"></a><span id="l26.669">     // check for attached signature files and remove them</span>
<a href="#l26.670"></a><span id="l26.670">     var bucketList = document.getElementById(&quot;attachmentBucket&quot;);</span>
<a href="#l26.671"></a><span id="l26.671" class="difflineat">@@ -768,17 +735,17 @@ Enigmail.msg = {</span>
<a href="#l26.672"></a><span id="l26.672">     }</span>
<a href="#l26.673"></a><span id="l26.673"> </span>
<a href="#l26.674"></a><span id="l26.674">     try {</span>
<a href="#l26.675"></a><span id="l26.675">       // TB only</span>
<a href="#l26.676"></a><span id="l26.676">       UpdateAttachmentBucket(bucketList.hasChildNodes());</span>
<a href="#l26.677"></a><span id="l26.677">     }</span>
<a href="#l26.678"></a><span id="l26.678">     catch (ex) {}</span>
<a href="#l26.679"></a><span id="l26.679"> </span>
<a href="#l26.680"></a><span id="l26.680" class="difflineminus">-    this.processFinalState();</span>
<a href="#l26.681"></a><span id="l26.681" class="difflineplus">+    //this.processFinalState();</span>
<a href="#l26.682"></a><span id="l26.682">     this.updateStatusBar();</span>
<a href="#l26.683"></a><span id="l26.683">     if (selectedElement) selectedElement.focus();</span>
<a href="#l26.684"></a><span id="l26.684">   },</span>
<a href="#l26.685"></a><span id="l26.685"> </span>
<a href="#l26.686"></a><span id="l26.686">   // check if an signature is related to another attachment</span>
<a href="#l26.687"></a><span id="l26.687">   findRelatedAttachment: function(bucketList, node) {</span>
<a href="#l26.688"></a><span id="l26.688"> </span>
<a href="#l26.689"></a><span id="l26.689">     // check if filename ends with .sig</span>
<a href="#l26.690"></a><span id="l26.690" class="difflineat">@@ -798,90 +765,60 @@ Enigmail.msg = {</span>
<a href="#l26.691"></a><span id="l26.691">   initialSendFlags: function() {</span>
<a href="#l26.692"></a><span id="l26.692">     EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.initialSendFlags\n&quot;);</span>
<a href="#l26.693"></a><span id="l26.693">     this.fireSendFlags();</span>
<a href="#l26.694"></a><span id="l26.694"> </span>
<a href="#l26.695"></a><span id="l26.695">     EnigmailTimer.setTimeout(function _f() {</span>
<a href="#l26.696"></a><span id="l26.696">       EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay: re-determine send flags\n&quot;);</span>
<a href="#l26.697"></a><span id="l26.697">       try {</span>
<a href="#l26.698"></a><span id="l26.698">         this.determineSendFlags();</span>
<a href="#l26.699"></a><span id="l26.699" class="difflineminus">-        this.processFinalState();</span>
<a href="#l26.700"></a><span id="l26.700" class="difflineplus">+        //this.processFinalState();</span>
<a href="#l26.701"></a><span id="l26.701">         this.updateStatusBar();</span>
<a href="#l26.702"></a><span id="l26.702">       }</span>
<a href="#l26.703"></a><span id="l26.703">       catch (ex) {</span>
<a href="#l26.704"></a><span id="l26.704">         EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay: re-determine send flags - ERROR: &quot; + ex.toString() + &quot;\n&quot;);</span>
<a href="#l26.705"></a><span id="l26.705">       }</span>
<a href="#l26.706"></a><span id="l26.706">     }.bind(Enigmail.msg), 1500);</span>
<a href="#l26.707"></a><span id="l26.707">   },</span>
<a href="#l26.708"></a><span id="l26.708"> </span>
<a href="#l26.709"></a><span id="l26.709"> </span>
<a href="#l26.710"></a><span id="l26.710">   msgComposeClose: function() {</span>
<a href="#l26.711"></a><span id="l26.711">     EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.msgComposeClose\n&quot;);</span>
<a href="#l26.712"></a><span id="l26.712"> </span>
<a href="#l26.713"></a><span id="l26.713" class="difflineminus">-    var ioServ;</span>
<a href="#l26.714"></a><span id="l26.714" class="difflineminus">-    try {</span>
<a href="#l26.715"></a><span id="l26.715" class="difflineminus">-      // we should delete the original temporary files of the encrypted or signed</span>
<a href="#l26.716"></a><span id="l26.716" class="difflineminus">-      // inline PGP attachments (the rest is done automatically)</span>
<a href="#l26.717"></a><span id="l26.717" class="difflineminus">-      if (this.modifiedAttach) {</span>
<a href="#l26.718"></a><span id="l26.718" class="difflineminus">-        ioServ = Components.classes[IOSERVICE_CONTRACTID].getService(Components.interfaces.nsIIOService);</span>
<a href="#l26.719"></a><span id="l26.719" class="difflineminus">-        if (!ioServ)</span>
<a href="#l26.720"></a><span id="l26.720" class="difflineminus">-          return;</span>
<a href="#l26.721"></a><span id="l26.721" class="difflineminus">-</span>
<a href="#l26.722"></a><span id="l26.722" class="difflineminus">-        for (var i in this.modifiedAttach) {</span>
<a href="#l26.723"></a><span id="l26.723" class="difflineminus">-          if (this.modifiedAttach[i].origTemp) {</span>
<a href="#l26.724"></a><span id="l26.724" class="difflineminus">-            EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.msgComposeClose: deleting &quot; + this.modifiedAttach[i].origUrl + &quot;\n&quot;);</span>
<a href="#l26.725"></a><span id="l26.725" class="difflineminus">-            var fileUri = ioServ.newURI(this.modifiedAttach[i].origUrl, null, null);</span>
<a href="#l26.726"></a><span id="l26.726" class="difflineminus">-            var fileHandle = Components.classes[LOCAL_FILE_CONTRACTID].createInstance(Components.interfaces.nsIFile);</span>
<a href="#l26.727"></a><span id="l26.727" class="difflineminus">-            fileHandle.initWithPath(fileUri.path);</span>
<a href="#l26.728"></a><span id="l26.728" class="difflineminus">-            if (fileHandle.exists()) fileHandle.remove(false);</span>
<a href="#l26.729"></a><span id="l26.729" class="difflineminus">-          }</span>
<a href="#l26.730"></a><span id="l26.730" class="difflineminus">-        }</span>
<a href="#l26.731"></a><span id="l26.731" class="difflineminus">-        this.modifiedAttach = null;</span>
<a href="#l26.732"></a><span id="l26.732" class="difflineminus">-      }</span>
<a href="#l26.733"></a><span id="l26.733" class="difflineminus">-    }</span>
<a href="#l26.734"></a><span id="l26.734" class="difflineminus">-    catch (ex) {</span>
<a href="#l26.735"></a><span id="l26.735" class="difflineminus">-      EnigmailLog.ERROR(&quot;enigmailMsgComposeOverlay.js: ECSL.ComposeProcessDone: could not delete all files:\n&quot; + ex.toString() + &quot;\n&quot;);</span>
<a href="#l26.736"></a><span id="l26.736" class="difflineminus">-    }</span>
<a href="#l26.737"></a><span id="l26.737" class="difflineminus">-</span>
<a href="#l26.738"></a><span id="l26.738">     this.msgComposeReset(true); // true =&gt; closing =&gt; don't call setIdentityDefaults()</span>
<a href="#l26.739"></a><span id="l26.739">   },</span>
<a href="#l26.740"></a><span id="l26.740"> </span>
<a href="#l26.741"></a><span id="l26.741"> </span>
<a href="#l26.742"></a><span id="l26.742">   msgComposeReset: function(closing) {</span>
<a href="#l26.743"></a><span id="l26.743">     EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.msgComposeReset\n&quot;);</span>
<a href="#l26.744"></a><span id="l26.744"> </span>
<a href="#l26.745"></a><span id="l26.745">     this.dirty = 0;</span>
<a href="#l26.746"></a><span id="l26.746">     this.processed = null;</span>
<a href="#l26.747"></a><span id="l26.747">     this.timeoutId = null;</span>
<a href="#l26.748"></a><span id="l26.748"> </span>
<a href="#l26.749"></a><span id="l26.749">     this.modifiedAttach = null;</span>
<a href="#l26.750"></a><span id="l26.750" class="difflineminus">-    this.sendMode = 0;</span>
<a href="#l26.751"></a><span id="l26.751" class="difflineminus">-    this.sendModeDirty = false;</span>
<a href="#l26.752"></a><span id="l26.752" class="difflineminus">-    this.reasonEncrypted = &quot;&quot;;</span>
<a href="#l26.753"></a><span id="l26.753" class="difflineminus">-    this.reasonSigned = &quot;&quot;;</span>
<a href="#l26.754"></a><span id="l26.754" class="difflineminus">-    this.encryptByRules = EnigmailConstants.ENIG_UNDEF;</span>
<a href="#l26.755"></a><span id="l26.755" class="difflineminus">-    this.signByRules = EnigmailConstants.ENIG_UNDEF;</span>
<a href="#l26.756"></a><span id="l26.756" class="difflineminus">-    this.pgpmimeByRules = EnigmailConstants.ENIG_UNDEF;</span>
<a href="#l26.757"></a><span id="l26.757" class="difflineminus">-    this.signForced = EnigmailConstants.ENIG_UNDEF;</span>
<a href="#l26.758"></a><span id="l26.758" class="difflineminus">-    this.encryptForced = EnigmailConstants.ENIG_UNDEF;</span>
<a href="#l26.759"></a><span id="l26.759" class="difflineminus">-    this.pgpmimeForced = EnigmailConstants.ENIG_UNDEF;</span>
<a href="#l26.760"></a><span id="l26.760" class="difflineminus">-    this.finalSignDependsOnEncrypt = false;</span>
<a href="#l26.761"></a><span id="l26.761" class="difflineminus">-    this.statusSigned = EnigmailConstants.ENIG_FINAL_UNDEF;</span>
<a href="#l26.762"></a><span id="l26.762" class="difflineminus">-    this.statusEncrypted = EnigmailConstants.ENIG_FINAL_UNDEF;</span>
<a href="#l26.763"></a><span id="l26.763" class="difflineminus">-    this.statusPGPMime = EnigmailConstants.ENIG_FINAL_UNDEF;</span>
<a href="#l26.764"></a><span id="l26.764" class="difflineplus">+    //this.sendMode = 0;</span>
<a href="#l26.765"></a><span id="l26.765" class="difflineplus">+    //this.sendModeDirty = false;</span>
<a href="#l26.766"></a><span id="l26.766" class="difflineplus">+</span>
<a href="#l26.767"></a><span id="l26.767" class="difflineplus">+    // here ???</span>
<a href="#l26.768"></a><span id="l26.768" class="difflineplus">+    gSendSigned = false;</span>
<a href="#l26.769"></a><span id="l26.769" class="difflineplus">+    gSendEncrypted = false;</span>
<a href="#l26.770"></a><span id="l26.770" class="difflineplus">+    gOptionalEncryption = false;</span>
<a href="#l26.771"></a><span id="l26.771" class="difflineplus">+    gIsRelatedToEncryptedOriginal = false;</span>
<a href="#l26.772"></a><span id="l26.772" class="difflineplus">+    gIsRelatedToSignedOriginal = false;</span>
<a href="#l26.773"></a><span id="l26.773" class="difflineplus">+</span>
<a href="#l26.774"></a><span id="l26.774">     this.statusEncryptedStr = &quot;???&quot;;</span>
<a href="#l26.775"></a><span id="l26.775">     this.statusSignedStr = &quot;???&quot;;</span>
<a href="#l26.776"></a><span id="l26.776" class="difflineminus">-    this.statusPGPMimeStr = &quot;???&quot;;</span>
<a href="#l26.777"></a><span id="l26.777" class="difflineminus">-    this.statusInlinePGPStr = &quot;???&quot;;</span>
<a href="#l26.778"></a><span id="l26.778" class="difflineplus">+    //this.statusPGPMimeStr = &quot;???&quot;;</span>
<a href="#l26.779"></a><span id="l26.779" class="difflineplus">+    //this.statusInlinePGPStr = &quot;???&quot;;</span>
<a href="#l26.780"></a><span id="l26.780">     this.statusAttachOwnKey = &quot;???&quot;;</span>
<a href="#l26.781"></a><span id="l26.781" class="difflineminus">-    this.enableRules = true;</span>
<a href="#l26.782"></a><span id="l26.782">     this.identity = null;</span>
<a href="#l26.783"></a><span id="l26.783">     this.sendProcess = false;</span>
<a href="#l26.784"></a><span id="l26.784">     this.trustAllKeys = false;</span>
<a href="#l26.785"></a><span id="l26.785" class="difflineminus">-    this.mimePreferOpenPGP = 0;</span>
<a href="#l26.786"></a><span id="l26.786" class="difflineplus">+    //this.mimePreferOpenPGP = 0;</span>
<a href="#l26.787"></a><span id="l26.787">     this.keyLookupDone = [];</span>
<a href="#l26.788"></a><span id="l26.788"> </span>
<a href="#l26.789"></a><span id="l26.789">     if (!closing) {</span>
<a href="#l26.790"></a><span id="l26.790">       this.setIdentityDefaults();</span>
<a href="#l26.791"></a><span id="l26.791">     }</span>
<a href="#l26.792"></a><span id="l26.792">   },</span>
<a href="#l26.793"></a><span id="l26.793"> </span>
<a href="#l26.794"></a><span id="l26.794"> </span>
<a href="#l26.795"></a><span id="l26.795" class="difflineat">@@ -895,106 +832,105 @@ Enigmail.msg = {</span>
<a href="#l26.796"></a><span id="l26.796">     if (prefValue &gt;= optionIds.length)</span>
<a href="#l26.797"></a><span id="l26.797">       return;</span>
<a href="#l26.798"></a><span id="l26.798"> </span>
<a href="#l26.799"></a><span id="l26.799">     var menuItem = document.getElementById(&quot;enigmail_&quot; + optionIds[prefValue]);</span>
<a href="#l26.800"></a><span id="l26.800">     if (menuItem)</span>
<a href="#l26.801"></a><span id="l26.801">       menuItem.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l26.802"></a><span id="l26.802">   },</span>
<a href="#l26.803"></a><span id="l26.803"> </span>
<a href="#l26.804"></a><span id="l26.804" class="difflineminus">-</span>
<a href="#l26.805"></a><span id="l26.805">   tempTrustAllKeys: function() {</span>
<a href="#l26.806"></a><span id="l26.806">     this.trustAllKeys = !this.trustAllKeys;</span>
<a href="#l26.807"></a><span id="l26.807">   },</span>
<a href="#l26.808"></a><span id="l26.808"> </span>
<a href="#l26.809"></a><span id="l26.809" class="difflineplus">+  /*</span>
<a href="#l26.810"></a><span id="l26.810">   toggleAttachOwnKey: function() {</span>
<a href="#l26.811"></a><span id="l26.811">     EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.toggleAttachOwnKey\n&quot;);</span>
<a href="#l26.812"></a><span id="l26.812">     EnigmailCore.getService(window); // make sure Enigmail is loaded and working</span>
<a href="#l26.813"></a><span id="l26.813"> </span>
<a href="#l26.814"></a><span id="l26.814" class="difflineminus">-    this.attachOwnKeyObj.appendAttachment = !this.attachOwnKeyObj.appendAttachment;</span>
<a href="#l26.815"></a><span id="l26.815" class="difflineminus">-</span>
<a href="#l26.816"></a><span id="l26.816" class="difflineminus">-    this.setOwnKeyStatus();</span>
<a href="#l26.817"></a><span id="l26.817" class="difflineplus">+    gAttachMyPublicPGPKey = !gAttachMyPublicPGPKey;</span>
<a href="#l26.818"></a><span id="l26.818" class="difflineplus">+</span>
<a href="#l26.819"></a><span id="l26.819" class="difflineplus">+    //this.setOwnKeyStatus();</span>
<a href="#l26.820"></a><span id="l26.820">   },</span>
<a href="#l26.821"></a><span id="l26.821" class="difflineminus">-</span>
<a href="#l26.822"></a><span id="l26.822" class="difflineplus">+  */</span>
<a href="#l26.823"></a><span id="l26.823" class="difflineplus">+</span>
<a href="#l26.824"></a><span id="l26.824" class="difflineplus">+  /*</span>
<a href="#l26.825"></a><span id="l26.825">   toggleProtectHeaders: function() {</span>
<a href="#l26.826"></a><span id="l26.826">     EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.toggleProtectHeaders\n&quot;);</span>
<a href="#l26.827"></a><span id="l26.827">     EnigmailCore.getService(window); // make sure Enigmail is loaded and working</span>
<a href="#l26.828"></a><span id="l26.828"> </span>
<a href="#l26.829"></a><span id="l26.829">     this.protectHeaders = !this.protectHeaders;</span>
<a href="#l26.830"></a><span id="l26.830"> </span>
<a href="#l26.831"></a><span id="l26.831">     this.displayProtectHeadersStatus();</span>
<a href="#l26.832"></a><span id="l26.832">   },</span>
<a href="#l26.833"></a><span id="l26.833" class="difflineplus">+  */</span>
<a href="#l26.834"></a><span id="l26.834"> </span>
<a href="#l26.835"></a><span id="l26.835">   displayProtectHeadersStatus: function() {</span>
<a href="#l26.836"></a><span id="l26.836">     return;</span>
<a href="#l26.837"></a><span id="l26.837" class="difflineplus">+    /*</span>
<a href="#l26.838"></a><span id="l26.838">     let bc = document.getElementById(&quot;enigmail-bc-protectHdr&quot;);</span>
<a href="#l26.839"></a><span id="l26.839"> </span>
<a href="#l26.840"></a><span id="l26.840">     if (this.protectHeaders) {</span>
<a href="#l26.841"></a><span id="l26.841">       bc.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l26.842"></a><span id="l26.842">       bc.setAttribute(&quot;tooltiptext&quot;, EnigmailLocale.getString(&quot;msgCompose.protectSubject.tooltip&quot;));</span>
<a href="#l26.843"></a><span id="l26.843">     }</span>
<a href="#l26.844"></a><span id="l26.844">     else {</span>
<a href="#l26.845"></a><span id="l26.845">       bc.removeAttribute(&quot;checked&quot;);</span>
<a href="#l26.846"></a><span id="l26.846">       bc.setAttribute(&quot;tooltiptext&quot;, EnigmailLocale.getString(&quot;msgCompose.noSubjectProtection.tooltip&quot;));</span>
<a href="#l26.847"></a><span id="l26.847">     }</span>
<a href="#l26.848"></a><span id="l26.848" class="difflineplus">+    */</span>
<a href="#l26.849"></a><span id="l26.849">   },</span>
<a href="#l26.850"></a><span id="l26.850"> </span>
<a href="#l26.851"></a><span id="l26.851">   /***</span>
<a href="#l26.852"></a><span id="l26.852">    * set broadcaster to display whether the own key is attached or not</span>
<a href="#l26.853"></a><span id="l26.853">    */</span>
<a href="#l26.854"></a><span id="l26.854"> </span>
<a href="#l26.855"></a><span id="l26.855" class="difflineplus">+  /*</span>
<a href="#l26.856"></a><span id="l26.856">   setOwnKeyStatus: function() {</span>
<a href="#l26.857"></a><span id="l26.857">     return;</span>
<a href="#l26.858"></a><span id="l26.858">     let bc = document.getElementById(&quot;enigmail-bc-attach&quot;);</span>
<a href="#l26.859"></a><span id="l26.859">     let attachIcon = document.getElementById(&quot;button-enigmail-attach&quot;);</span>
<a href="#l26.860"></a><span id="l26.860"> </span>
<a href="#l26.861"></a><span id="l26.861">     if (this.allowAttachOwnKey() === 0) {</span>
<a href="#l26.862"></a><span id="l26.862">       this.statusAttachOwnKey = EnigmailLocale.getString(&quot;attachOwnKeyDisabled&quot;);</span>
<a href="#l26.863"></a><span id="l26.863">     }</span>
<a href="#l26.864"></a><span id="l26.864">     else {</span>
<a href="#l26.865"></a><span id="l26.865" class="difflineminus">-      if (this.attachOwnKeyObj.appendAttachment) {</span>
<a href="#l26.866"></a><span id="l26.866" class="difflineplus">+      if (gAttachMyPublicPGPKey) {</span>
<a href="#l26.867"></a><span id="l26.867">         bc.setAttribute(&quot;addPubkey&quot;, &quot;true&quot;);</span>
<a href="#l26.868"></a><span id="l26.868">         bc.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l26.869"></a><span id="l26.869">         this.statusAttachOwnKey = EnigmailLocale.getString(&quot;attachOwnKeyYes&quot;);</span>
<a href="#l26.870"></a><span id="l26.870">       }</span>
<a href="#l26.871"></a><span id="l26.871">       else {</span>
<a href="#l26.872"></a><span id="l26.872">         bc.setAttribute(&quot;addPubkey&quot;, &quot;false&quot;);</span>
<a href="#l26.873"></a><span id="l26.873">         bc.removeAttribute(&quot;checked&quot;);</span>
<a href="#l26.874"></a><span id="l26.874">         this.statusAttachOwnKey = EnigmailLocale.getString(&quot;attachOwnKeyNo&quot;);</span>
<a href="#l26.875"></a><span id="l26.875">       }</span>
<a href="#l26.876"></a><span id="l26.876">     }</span>
<a href="#l26.877"></a><span id="l26.877"> </span>
<a href="#l26.878"></a><span id="l26.878">     if (attachIcon)</span>
<a href="#l26.879"></a><span id="l26.879">       attachIcon.setAttribute(&quot;tooltiptext&quot;, this.statusAttachOwnKey);</span>
<a href="#l26.880"></a><span id="l26.880"> </span>
<a href="#l26.881"></a><span id="l26.881">   },</span>
<a href="#l26.882"></a><span id="l26.882" class="difflineminus">-</span>
<a href="#l26.883"></a><span id="l26.883" class="difflineminus">-  attachOwnKey: function() {</span>
<a href="#l26.884"></a><span id="l26.884" class="difflineminus">-    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.attachOwnKey:\n&quot;);</span>
<a href="#l26.885"></a><span id="l26.885" class="difflineminus">-</span>
<a href="#l26.886"></a><span id="l26.886" class="difflineminus">-    var userIdValue;</span>
<a href="#l26.887"></a><span id="l26.887" class="difflineminus">-</span>
<a href="#l26.888"></a><span id="l26.888" class="difflineminus">-    if (this.identity.getIntAttribute(&quot;pgpKeyMode&quot;) &gt; 0) {</span>
<a href="#l26.889"></a><span id="l26.889" class="difflineminus">-      userIdValue = this.identity.getCharAttribute(&quot;pgpkeyId&quot;);</span>
<a href="#l26.890"></a><span id="l26.890" class="difflineminus">-</span>
<a href="#l26.891"></a><span id="l26.891" class="difflineminus">-      if (this.attachOwnKeyObj.attachedKey &amp;&amp; (this.attachOwnKeyObj.attachedKey != userIdValue)) {</span>
<a href="#l26.892"></a><span id="l26.892" class="difflineminus">-        // remove attached key if user ID changed</span>
<a href="#l26.893"></a><span id="l26.893" class="difflineminus">-        this.removeAttachedKey();</span>
<a href="#l26.894"></a><span id="l26.894" class="difflineplus">+  */</span>
<a href="#l26.895"></a><span id="l26.895" class="difflineplus">+</span>
<a href="#l26.896"></a><span id="l26.896" class="difflineplus">+  attachOwnKey: function(id) {</span>
<a href="#l26.897"></a><span id="l26.897" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.attachOwnKey: &quot; + id + &quot;\n&quot;);</span>
<a href="#l26.898"></a><span id="l26.898" class="difflineplus">+    console.debug(&quot;Enigmail.msg.attachOwnKey &quot; + id);</span>
<a href="#l26.899"></a><span id="l26.899" class="difflineplus">+</span>
<a href="#l26.900"></a><span id="l26.900" class="difflineplus">+    if (this.attachOwnKeyObj.attachedKey &amp;&amp; (this.attachOwnKeyObj.attachedKey != id)) {</span>
<a href="#l26.901"></a><span id="l26.901" class="difflineplus">+      // remove attached key if user ID changed</span>
<a href="#l26.902"></a><span id="l26.902" class="difflineplus">+      this.removeAttachedKey();</span>
<a href="#l26.903"></a><span id="l26.903" class="difflineplus">+    }</span>
<a href="#l26.904"></a><span id="l26.904" class="difflineplus">+</span>
<a href="#l26.905"></a><span id="l26.905" class="difflineplus">+    if (!this.attachOwnKeyObj.attachedKey) {</span>
<a href="#l26.906"></a><span id="l26.906" class="difflineplus">+      var attachedObj = this.extractAndAttachKey([id], true);</span>
<a href="#l26.907"></a><span id="l26.907" class="difflineplus">+      if (attachedObj) {</span>
<a href="#l26.908"></a><span id="l26.908" class="difflineplus">+        this.attachOwnKeyObj.attachedObj = attachedObj;</span>
<a href="#l26.909"></a><span id="l26.909" class="difflineplus">+        this.attachOwnKeyObj.attachedKey = id;</span>
<a href="#l26.910"></a><span id="l26.910">       }</span>
<a href="#l26.911"></a><span id="l26.911" class="difflineminus">-</span>
<a href="#l26.912"></a><span id="l26.912" class="difflineminus">-      if (!this.attachOwnKeyObj.attachedKey) {</span>
<a href="#l26.913"></a><span id="l26.913" class="difflineminus">-        var attachedObj = this.extractAndAttachKey([userIdValue], true);</span>
<a href="#l26.914"></a><span id="l26.914" class="difflineminus">-        if (attachedObj) {</span>
<a href="#l26.915"></a><span id="l26.915" class="difflineminus">-          this.attachOwnKeyObj.attachedObj = attachedObj;</span>
<a href="#l26.916"></a><span id="l26.916" class="difflineminus">-          this.attachOwnKeyObj.attachedKey = userIdValue;</span>
<a href="#l26.917"></a><span id="l26.917" class="difflineminus">-        }</span>
<a href="#l26.918"></a><span id="l26.918" class="difflineminus">-      }</span>
<a href="#l26.919"></a><span id="l26.919" class="difflineminus">-    }</span>
<a href="#l26.920"></a><span id="l26.920" class="difflineminus">-    else {</span>
<a href="#l26.921"></a><span id="l26.921" class="difflineminus">-      EnigmailLog.ERROR(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.attachOwnKey: trying to attach unknown own key!\n&quot;);</span>
<a href="#l26.922"></a><span id="l26.922">     }</span>
<a href="#l26.923"></a><span id="l26.923">   },</span>
<a href="#l26.924"></a><span id="l26.924"> </span>
<a href="#l26.925"></a><span id="l26.925">   attachKey: function() {</span>
<a href="#l26.926"></a><span id="l26.926">     EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.attachKey: \n&quot;);</span>
<a href="#l26.927"></a><span id="l26.927"> </span>
<a href="#l26.928"></a><span id="l26.928">     var resultObj = {};</span>
<a href="#l26.929"></a><span id="l26.929">     var inputObj = {};</span>
<a href="#l26.930"></a><span id="l26.930" class="difflineat">@@ -1037,17 +973,17 @@ Enigmail.msg = {</span>
<a href="#l26.931"></a><span id="l26.931">     }</span>
<a href="#l26.932"></a><span id="l26.932">     tmpFile.append(&quot;key.asc&quot;);</span>
<a href="#l26.933"></a><span id="l26.933">     tmpFile.createUnique(Components.interfaces.nsIFile.NORMAL_FILE_TYPE, 0o600);</span>
<a href="#l26.934"></a><span id="l26.934"> </span>
<a href="#l26.935"></a><span id="l26.935">     // save file</span>
<a href="#l26.936"></a><span id="l26.936">     var exitCodeObj = {};</span>
<a href="#l26.937"></a><span id="l26.937">     var errorMsgObj = {};</span>
<a href="#l26.938"></a><span id="l26.938"> </span>
<a href="#l26.939"></a><span id="l26.939" class="difflineminus">-    EnigmailKeyRing.extractKey(false, uid.join(&quot; &quot;), tmpFile, exitCodeObj, errorMsgObj);</span>
<a href="#l26.940"></a><span id="l26.940" class="difflineplus">+    EnigmailKeyRing.extractKey(false, uid, tmpFile, exitCodeObj, errorMsgObj);</span>
<a href="#l26.941"></a><span id="l26.941">     if (exitCodeObj.value !== 0) {</span>
<a href="#l26.942"></a><span id="l26.942">       if (warnOnError) EnigmailDialog.alert(window, errorMsgObj.value);</span>
<a href="#l26.943"></a><span id="l26.943">       return null;</span>
<a href="#l26.944"></a><span id="l26.944">     }</span>
<a href="#l26.945"></a><span id="l26.945"> </span>
<a href="#l26.946"></a><span id="l26.946">     // create attachment</span>
<a href="#l26.947"></a><span id="l26.947">     var ioServ = Components.classes[IOSERVICE_CONTRACTID].getService(Components.interfaces.nsIIOService);</span>
<a href="#l26.948"></a><span id="l26.948">     var tmpFileURI = ioServ.newFileURI(tmpFile);</span>
<a href="#l26.949"></a><span id="l26.949" class="difflineat">@@ -1075,34 +1011,37 @@ Enigmail.msg = {</span>
<a href="#l26.950"></a><span id="l26.950">     gContentChanged = true;</span>
<a href="#l26.951"></a><span id="l26.951">     return keyAttachment;</span>
<a href="#l26.952"></a><span id="l26.952">   },</span>
<a href="#l26.953"></a><span id="l26.953"> </span>
<a href="#l26.954"></a><span id="l26.954">   addAttachment: function(attachment) {</span>
<a href="#l26.955"></a><span id="l26.955">     AddAttachments([attachment]);</span>
<a href="#l26.956"></a><span id="l26.956">   },</span>
<a href="#l26.957"></a><span id="l26.957"> </span>
<a href="#l26.958"></a><span id="l26.958" class="difflineplus">+  /*</span>
<a href="#l26.959"></a><span id="l26.959">   enableUndoEncryption: function(newStatus) {</span>
<a href="#l26.960"></a><span id="l26.960">     return;</span>
<a href="#l26.961"></a><span id="l26.961">     let eue = document.getElementById(&quot;enigmail_undo_encryption&quot;);</span>
<a href="#l26.962"></a><span id="l26.962"> </span>
<a href="#l26.963"></a><span id="l26.963">     if (newStatus) {</span>
<a href="#l26.964"></a><span id="l26.964">       eue.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l26.965"></a><span id="l26.965">     }</span>
<a href="#l26.966"></a><span id="l26.966">     else</span>
<a href="#l26.967"></a><span id="l26.967">       eue.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l26.968"></a><span id="l26.968">   },</span>
<a href="#l26.969"></a><span id="l26.969" class="difflineplus">+  */</span>
<a href="#l26.970"></a><span id="l26.970"> </span>
<a href="#l26.971"></a><span id="l26.971"> </span>
<a href="#l26.972"></a><span id="l26.972">   /**</span>
<a href="#l26.973"></a><span id="l26.973">    *  undo the encryption or signing; get back the original (unsigned/unencrypted) text</span>
<a href="#l26.974"></a><span id="l26.974">    *</span>
<a href="#l26.975"></a><span id="l26.975">    * useEditorUndo |Number|:   &gt; 0  use undo function of editor |n| times</span>
<a href="#l26.976"></a><span id="l26.976">    *                           0: replace text with original text</span>
<a href="#l26.977"></a><span id="l26.977">    */</span>
<a href="#l26.978"></a><span id="l26.978" class="difflineplus">+  /*</span>
<a href="#l26.979"></a><span id="l26.979">   undoEncryption: function(useEditorUndo) {</span>
<a href="#l26.980"></a><span id="l26.980">     EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.undoEncryption:\n&quot;);</span>
<a href="#l26.981"></a><span id="l26.981">     if (this.processed) {</span>
<a href="#l26.982"></a><span id="l26.982">       if (useEditorUndo) {</span>
<a href="#l26.983"></a><span id="l26.983">         EnigmailTimer.setTimeout(function _f() {</span>
<a href="#l26.984"></a><span id="l26.984">           Enigmail.msg.editor.undo(useEditorUndo);</span>
<a href="#l26.985"></a><span id="l26.985">         }, 10);</span>
<a href="#l26.986"></a><span id="l26.986">       }</span>
<a href="#l26.987"></a><span id="l26.987" class="difflineat">@@ -1114,53 +1053,19 @@ Enigmail.msg = {</span>
<a href="#l26.988"></a><span id="l26.988"> </span>
<a href="#l26.989"></a><span id="l26.989">     }</span>
<a href="#l26.990"></a><span id="l26.990">     else {</span>
<a href="#l26.991"></a><span id="l26.991">       this.decryptQuote(true);</span>
<a href="#l26.992"></a><span id="l26.992">     }</span>
<a href="#l26.993"></a><span id="l26.993"> </span>
<a href="#l26.994"></a><span id="l26.994">     var node;</span>
<a href="#l26.995"></a><span id="l26.995">     var nodeNumber;</span>
<a href="#l26.996"></a><span id="l26.996" class="difflineminus">-    var bucketList = document.getElementById(&quot;attachmentBucket&quot;);</span>
<a href="#l26.997"></a><span id="l26.997" class="difflineminus">-    if (this.modifiedAttach &amp;&amp; bucketList &amp;&amp; bucketList.hasChildNodes()) {</span>
<a href="#l26.998"></a><span id="l26.998" class="difflineminus">-      // undo inline encryption of attachments</span>
<a href="#l26.999"></a><span id="l26.999" class="difflineminus">-      for (var i = 0; i &lt; this.modifiedAttach.length; i++) {</span>
<a href="#l26.1000"></a><span id="l26.1000" class="difflineminus">-        node = bucketList.firstChild;</span>
<a href="#l26.1001"></a><span id="l26.1001" class="difflineminus">-        nodeNumber = -1;</span>
<a href="#l26.1002"></a><span id="l26.1002" class="difflineminus">-        while (node) {</span>
<a href="#l26.1003"></a><span id="l26.1003" class="difflineminus">-          ++nodeNumber;</span>
<a href="#l26.1004"></a><span id="l26.1004" class="difflineminus">-          if (node.attachment.url == this.modifiedAttach[i].newUrl) {</span>
<a href="#l26.1005"></a><span id="l26.1005" class="difflineminus">-            if (this.modifiedAttach[i].encrypted) {</span>
<a href="#l26.1006"></a><span id="l26.1006" class="difflineminus">-              node.attachment.url = this.modifiedAttach[i].origUrl;</span>
<a href="#l26.1007"></a><span id="l26.1007" class="difflineminus">-              node.attachment.name = this.modifiedAttach[i].origName;</span>
<a href="#l26.1008"></a><span id="l26.1008" class="difflineminus">-              node.attachment.temporary = this.modifiedAttach[i].origTemp;</span>
<a href="#l26.1009"></a><span id="l26.1009" class="difflineminus">-              node.attachment.contentType = this.modifiedAttach[i].origCType;</span>
<a href="#l26.1010"></a><span id="l26.1010" class="difflineminus">-            }</span>
<a href="#l26.1011"></a><span id="l26.1011" class="difflineminus">-            else {</span>
<a href="#l26.1012"></a><span id="l26.1012" class="difflineminus">-              node = bucketList.removeChild(node);</span>
<a href="#l26.1013"></a><span id="l26.1013" class="difflineminus">-              // Let's release the attachment object held by the node else it won't go away until the window is destroyed</span>
<a href="#l26.1014"></a><span id="l26.1014" class="difflineminus">-              node.attachment = null;</span>
<a href="#l26.1015"></a><span id="l26.1015" class="difflineminus">-            }</span>
<a href="#l26.1016"></a><span id="l26.1016" class="difflineminus">-            // delete encrypted file</span>
<a href="#l26.1017"></a><span id="l26.1017" class="difflineminus">-            try {</span>
<a href="#l26.1018"></a><span id="l26.1018" class="difflineminus">-              this.modifiedAttach[i].newFile.remove(false);</span>
<a href="#l26.1019"></a><span id="l26.1019" class="difflineminus">-            }</span>
<a href="#l26.1020"></a><span id="l26.1020" class="difflineminus">-            catch (ex) {}</span>
<a href="#l26.1021"></a><span id="l26.1021" class="difflineminus">-</span>
<a href="#l26.1022"></a><span id="l26.1022" class="difflineminus">-            node = null; // next attachment please</span>
<a href="#l26.1023"></a><span id="l26.1023" class="difflineminus">-          }</span>
<a href="#l26.1024"></a><span id="l26.1024" class="difflineminus">-          else {</span>
<a href="#l26.1025"></a><span id="l26.1025" class="difflineminus">-            node = node.nextSibling;</span>
<a href="#l26.1026"></a><span id="l26.1026" class="difflineminus">-          }</span>
<a href="#l26.1027"></a><span id="l26.1027" class="difflineminus">-        }</span>
<a href="#l26.1028"></a><span id="l26.1028" class="difflineminus">-      }</span>
<a href="#l26.1029"></a><span id="l26.1029" class="difflineminus">-    }</span>
<a href="#l26.1030"></a><span id="l26.1030" class="difflineminus">-</span>
<a href="#l26.1031"></a><span id="l26.1031">     this.removeAttachedKey();</span>
<a href="#l26.1032"></a><span id="l26.1032">   },</span>
<a href="#l26.1033"></a><span id="l26.1033" class="difflineplus">+  */</span>
<a href="#l26.1034"></a><span id="l26.1034"> </span>
<a href="#l26.1035"></a><span id="l26.1035"> </span>
<a href="#l26.1036"></a><span id="l26.1036">   removeAttachedKey: function() {</span>
<a href="#l26.1037"></a><span id="l26.1037">     EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.removeAttachedKey: \n&quot;);</span>
<a href="#l26.1038"></a><span id="l26.1038"> </span>
<a href="#l26.1039"></a><span id="l26.1039">     var bucketList = document.getElementById(&quot;attachmentBucket&quot;);</span>
<a href="#l26.1040"></a><span id="l26.1040">     var node = bucketList.firstChild;</span>
<a href="#l26.1041"></a><span id="l26.1041"> </span>
<a href="#l26.1042"></a><span id="l26.1042" class="difflineat">@@ -1187,56 +1092,41 @@ Enigmail.msg = {</span>
<a href="#l26.1043"></a><span id="l26.1043">           ChangeAttachmentBucketVisibility(true);</span>
<a href="#l26.1044"></a><span id="l26.1044">         }</span>
<a href="#l26.1045"></a><span id="l26.1045">         catch (ex) {}</span>
<a href="#l26.1046"></a><span id="l26.1046">       }</span>
<a href="#l26.1047"></a><span id="l26.1047">     }</span>
<a href="#l26.1048"></a><span id="l26.1048">   },</span>
<a href="#l26.1049"></a><span id="l26.1049"> </span>
<a href="#l26.1050"></a><span id="l26.1050">   getSecurityParams: function(compFields = null, doQueryInterface = false) {</span>
<a href="#l26.1051"></a><span id="l26.1051" class="difflineminus">-    if (!compFields)</span>
<a href="#l26.1052"></a><span id="l26.1052" class="difflineplus">+    if (!compFields) {</span>
<a href="#l26.1053"></a><span id="l26.1053">       compFields = gMsgCompose.compFields;</span>
<a href="#l26.1054"></a><span id="l26.1054" class="difflineminus">-</span>
<a href="#l26.1055"></a><span id="l26.1055" class="difflineminus">-    if (&quot;securityInfo&quot; in compFields) {</span>
<a href="#l26.1056"></a><span id="l26.1056" class="difflineminus">-      if (doQueryInterface) {</span>
<a href="#l26.1057"></a><span id="l26.1057" class="difflineminus">-        return compFields.securityInfo.QueryInterface(Components.interfaces.nsIMsgSMIMECompFields);</span>
<a href="#l26.1058"></a><span id="l26.1058" class="difflineminus">-      }</span>
<a href="#l26.1059"></a><span id="l26.1059" class="difflineminus">-      else {</span>
<a href="#l26.1060"></a><span id="l26.1060" class="difflineminus">-        return compFields.securityInfo;</span>
<a href="#l26.1061"></a><span id="l26.1061" class="difflineminus">-      }</span>
<a href="#l26.1062"></a><span id="l26.1062">     }</span>
<a href="#l26.1063"></a><span id="l26.1063" class="difflineminus">-    else {</span>
<a href="#l26.1064"></a><span id="l26.1064" class="difflineminus">-      return compFields.composeSecure;</span>
<a href="#l26.1065"></a><span id="l26.1065" class="difflineminus">-    }</span>
<a href="#l26.1066"></a><span id="l26.1066" class="difflineplus">+</span>
<a href="#l26.1067"></a><span id="l26.1067" class="difflineplus">+    return compFields.composeSecure;</span>
<a href="#l26.1068"></a><span id="l26.1068">   },</span>
<a href="#l26.1069"></a><span id="l26.1069"> </span>
<a href="#l26.1070"></a><span id="l26.1070">   setSecurityParams: function(newSecurityParams) {</span>
<a href="#l26.1071"></a><span id="l26.1071" class="difflineminus">-    if (&quot;securityInfo&quot; in gMsgCompose.compFields) {</span>
<a href="#l26.1072"></a><span id="l26.1072" class="difflineminus">-      // TB &lt; 64</span>
<a href="#l26.1073"></a><span id="l26.1073" class="difflineminus">-      gMsgCompose.compFields.securityInfo = newSecurityParams;</span>
<a href="#l26.1074"></a><span id="l26.1074" class="difflineminus">-    }</span>
<a href="#l26.1075"></a><span id="l26.1075" class="difflineminus">-    else {</span>
<a href="#l26.1076"></a><span id="l26.1076" class="difflineminus">-      gMsgCompose.compFields.composeSecure = newSecurityParams;</span>
<a href="#l26.1077"></a><span id="l26.1077" class="difflineminus">-    }</span>
<a href="#l26.1078"></a><span id="l26.1078" class="difflineplus">+    gMsgCompose.compFields.composeSecure = newSecurityParams;</span>
<a href="#l26.1079"></a><span id="l26.1079">   },</span>
<a href="#l26.1080"></a><span id="l26.1080"> </span>
<a href="#l26.1081"></a><span id="l26.1081" class="difflineminus">-</span>
<a href="#l26.1082"></a><span id="l26.1082" class="difflineplus">+  // Used on send failure, to reset the pre-send modifications</span>
<a href="#l26.1083"></a><span id="l26.1083">   resetUpdatedFields: function() {</span>
<a href="#l26.1084"></a><span id="l26.1084">     this.removeAttachedKey();</span>
<a href="#l26.1085"></a><span id="l26.1085"> </span>
<a href="#l26.1086"></a><span id="l26.1086">     // reset subject</span>
<a href="#l26.1087"></a><span id="l26.1087" class="difflineminus">-    if (EnigmailMimeEncrypt.isEnigmailCompField(Enigmail.msg.getSecurityParams())) {</span>
<a href="#l26.1088"></a><span id="l26.1088" class="difflineminus">-      let si = Enigmail.msg.getSecurityParams().wrappedJSObject;</span>
<a href="#l26.1089"></a><span id="l26.1089" class="difflineplus">+    let p = Enigmail.msg.getSecurityParams();</span>
<a href="#l26.1090"></a><span id="l26.1090" class="difflineplus">+    if (EnigmailMimeEncrypt.isEnigmailCompField(p)) {</span>
<a href="#l26.1091"></a><span id="l26.1091" class="difflineplus">+      let si = p.wrappedJSObject;</span>
<a href="#l26.1092"></a><span id="l26.1092">       if (si.originalSubject) {</span>
<a href="#l26.1093"></a><span id="l26.1093">         gMsgCompose.compFields.subject = si.originalSubject;</span>
<a href="#l26.1094"></a><span id="l26.1094">       }</span>
<a href="#l26.1095"></a><span id="l26.1095">     }</span>
<a href="#l26.1096"></a><span id="l26.1096">   },</span>
<a href="#l26.1097"></a><span id="l26.1097"> </span>
<a href="#l26.1098"></a><span id="l26.1098" class="difflineminus">-</span>
<a href="#l26.1099"></a><span id="l26.1099">   replaceEditorText: function(text) {</span>
<a href="#l26.1100"></a><span id="l26.1100">     EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.replaceEditorText:\n&quot;);</span>
<a href="#l26.1101"></a><span id="l26.1101"> </span>
<a href="#l26.1102"></a><span id="l26.1102">     this.editorSelectAll();</span>
<a href="#l26.1103"></a><span id="l26.1103">     // Overwrite text in clipboard for security</span>
<a href="#l26.1104"></a><span id="l26.1104">     // (Otherwise plaintext will be available in the clipbaord)</span>
<a href="#l26.1105"></a><span id="l26.1105"> </span>
<a href="#l26.1106"></a><span id="l26.1106">     if (this.editor.textLength &gt; 0) {</span>
<a href="#l26.1107"></a><span id="l26.1107" class="difflineat">@@ -1266,99 +1156,99 @@ Enigmail.msg = {</span>
<a href="#l26.1108"></a><span id="l26.1108">     });</span>
<a href="#l26.1109"></a><span id="l26.1109">     this.setIdentityDefaults();</span>
<a href="#l26.1110"></a><span id="l26.1110">   },</span>
<a href="#l26.1111"></a><span id="l26.1111"> </span>
<a href="#l26.1112"></a><span id="l26.1112">   /**</span>
<a href="#l26.1113"></a><span id="l26.1113">    * Determine if Enigmail is enabled for the account</span>
<a href="#l26.1114"></a><span id="l26.1114">    */</span>
<a href="#l26.1115"></a><span id="l26.1115"> </span>
<a href="#l26.1116"></a><span id="l26.1116" class="difflineminus">-  isEnigmailEnabled: function() {</span>
<a href="#l26.1117"></a><span id="l26.1117" class="difflineplus">+  wasEnigmailAddOnInstalled: function() {</span>
<a href="#l26.1118"></a><span id="l26.1118" class="difflineplus">+    return (EnigmailPrefs.getPref(&quot;configuredVersion&quot;) !== &quot;&quot;);</span>
<a href="#l26.1119"></a><span id="l26.1119" class="difflineplus">+  },</span>
<a href="#l26.1120"></a><span id="l26.1120" class="difflineplus">+</span>
<a href="#l26.1121"></a><span id="l26.1121" class="difflineplus">+  wasEnigmailEnabledForIdentity: function() {</span>
<a href="#l26.1122"></a><span id="l26.1122">     return this.identity.getBoolAttribute(&quot;enablePgp&quot;);</span>
<a href="#l26.1123"></a><span id="l26.1123">   },</span>
<a href="#l26.1124"></a><span id="l26.1124"> </span>
<a href="#l26.1125"></a><span id="l26.1125" class="difflineplus">+  // TODO: should we use a different flag for &quot;PGP is enabled in TB78+&quot;?</span>
<a href="#l26.1126"></a><span id="l26.1126" class="difflineplus">+  //       or check in combination with identityEnigmailPrefsMigrated?</span>
<a href="#l26.1127"></a><span id="l26.1127" class="difflineplus">+  isEnigmailEnabledForIdentity: function() {</span>
<a href="#l26.1128"></a><span id="l26.1128" class="difflineplus">+    //return this.identity.getBoolAttribute(&quot;enablePgp&quot;);</span>
<a href="#l26.1129"></a><span id="l26.1129" class="difflineplus">+    return true;</span>
<a href="#l26.1130"></a><span id="l26.1130" class="difflineplus">+  },</span>
<a href="#l26.1131"></a><span id="l26.1131" class="difflineplus">+</span>
<a href="#l26.1132"></a><span id="l26.1132">   /**</span>
<a href="#l26.1133"></a><span id="l26.1133">    * Determine if Autocrypt is enabled for the account</span>
<a href="#l26.1134"></a><span id="l26.1134">    */</span>
<a href="#l26.1135"></a><span id="l26.1135">   isAutocryptEnabled: function() {</span>
<a href="#l26.1136"></a><span id="l26.1136" class="difflineminus">-    if (this.isEnigmailEnabled()) {</span>
<a href="#l26.1137"></a><span id="l26.1137" class="difflineplus">+    return false;</span>
<a href="#l26.1138"></a><span id="l26.1138" class="difflineplus">+    /*</span>
<a href="#l26.1139"></a><span id="l26.1139" class="difflineplus">+    if (Enigmail.msg.wasEnigmailEnabledForIdentity()) {</span>
<a href="#l26.1140"></a><span id="l26.1140">       let srv = this.getCurrentIncomingServer();</span>
<a href="#l26.1141"></a><span id="l26.1141">       return (srv ? srv.getBoolValue(&quot;enableAutocrypt&quot;) : false);</span>
<a href="#l26.1142"></a><span id="l26.1142">     }</span>
<a href="#l26.1143"></a><span id="l26.1143"> </span>
<a href="#l26.1144"></a><span id="l26.1144">     return false;</span>
<a href="#l26.1145"></a><span id="l26.1145" class="difflineplus">+    */</span>
<a href="#l26.1146"></a><span id="l26.1146">   },</span>
<a href="#l26.1147"></a><span id="l26.1147"> </span>
<a href="#l26.1148"></a><span id="l26.1148" class="difflineplus">+  /*</span>
<a href="#l26.1149"></a><span id="l26.1149">   doPgpButton: function(what) {</span>
<a href="#l26.1150"></a><span id="l26.1150">     EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.doPgpButton: what=&quot; + what + &quot;\n&quot;);</span>
<a href="#l26.1151"></a><span id="l26.1151"> </span>
<a href="#l26.1152"></a><span id="l26.1152" class="difflineminus">-    if (this.isEnigmailEnabled()) {</span>
<a href="#l26.1153"></a><span id="l26.1153" class="difflineplus">+    if (Enigmail.msg.wasEnigmailEnabledForIdentity()) {</span>
<a href="#l26.1154"></a><span id="l26.1154">       EnigmailCore.getService(window); // try to access Enigmail to launch the wizard if needed</span>
<a href="#l26.1155"></a><span id="l26.1155">     }</span>
<a href="#l26.1156"></a><span id="l26.1156"> </span>
<a href="#l26.1157"></a><span id="l26.1157">     // ignore settings for this account?</span>
<a href="#l26.1158"></a><span id="l26.1158">     try {</span>
<a href="#l26.1159"></a><span id="l26.1159" class="difflineminus">-      if (!this.getEncryptionEnabled() &amp;&amp; !this.getSigningEnabled()) {</span>
<a href="#l26.1160"></a><span id="l26.1160" class="difflineplus">+      if (!this.isAnyEncryptionEnabled() &amp;&amp; !this.getSigningEnabled()) {</span>
<a href="#l26.1161"></a><span id="l26.1161">         if (EnigmailDialog.confirmDlg(window, EnigmailLocale.getString(&quot;configureNow&quot;),</span>
<a href="#l26.1162"></a><span id="l26.1162">             EnigmailLocale.getString(&quot;msgCompose.button.configure&quot;))) {</span>
<a href="#l26.1163"></a><span id="l26.1163">           // configure account settings for the first time</span>
<a href="#l26.1164"></a><span id="l26.1164">           this.goAccountManager();</span>
<a href="#l26.1165"></a><span id="l26.1165" class="difflineminus">-          if (!this.isEnigmailEnabled()) {</span>
<a href="#l26.1166"></a><span id="l26.1166" class="difflineplus">+          if (!Enigmail.msg.wasEnigmailEnabledForIdentity()) {</span>
<a href="#l26.1167"></a><span id="l26.1167">             return;</span>
<a href="#l26.1168"></a><span id="l26.1168">           }</span>
<a href="#l26.1169"></a><span id="l26.1169">         }</span>
<a href="#l26.1170"></a><span id="l26.1170">         else {</span>
<a href="#l26.1171"></a><span id="l26.1171">           return;</span>
<a href="#l26.1172"></a><span id="l26.1172">         }</span>
<a href="#l26.1173"></a><span id="l26.1173">       }</span>
<a href="#l26.1174"></a><span id="l26.1174">     }</span>
<a href="#l26.1175"></a><span id="l26.1175">     catch (ex) {}</span>
<a href="#l26.1176"></a><span id="l26.1176"> </span>
<a href="#l26.1177"></a><span id="l26.1177">     switch (what) {</span>
<a href="#l26.1178"></a><span id="l26.1178">       case 'sign':</span>
<a href="#l26.1179"></a><span id="l26.1179">       case 'encrypt':</span>
<a href="#l26.1180"></a><span id="l26.1180">         this.setSendMode(what);</span>
<a href="#l26.1181"></a><span id="l26.1181">         break;</span>
<a href="#l26.1182"></a><span id="l26.1182"> </span>
<a href="#l26.1183"></a><span id="l26.1183" class="difflineminus">-        // menu entries:</span>
<a href="#l26.1184"></a><span id="l26.1184" class="difflineminus">-      case 'final-signDefault':</span>
<a href="#l26.1185"></a><span id="l26.1185" class="difflineminus">-      case 'final-signYes':</span>
<a href="#l26.1186"></a><span id="l26.1186" class="difflineminus">-      case 'final-signNo':</span>
<a href="#l26.1187"></a><span id="l26.1187" class="difflineminus">-      case 'final-encryptDefault':</span>
<a href="#l26.1188"></a><span id="l26.1188" class="difflineminus">-      case 'final-encryptYes':</span>
<a href="#l26.1189"></a><span id="l26.1189" class="difflineminus">-      case 'final-encryptNo':</span>
<a href="#l26.1190"></a><span id="l26.1190" class="difflineminus">-      case 'final-pgpmimeDefault':</span>
<a href="#l26.1191"></a><span id="l26.1191" class="difflineminus">-      case 'final-pgpmimeYes':</span>
<a href="#l26.1192"></a><span id="l26.1192" class="difflineminus">-      case 'final-pgpmimeNo':</span>
<a href="#l26.1193"></a><span id="l26.1193" class="difflineminus">-      case 'final-useSmime':</span>
<a href="#l26.1194"></a><span id="l26.1194" class="difflineminus">-      case 'toggle-final-sign':</span>
<a href="#l26.1195"></a><span id="l26.1195" class="difflineminus">-      case 'toggle-final-encrypt':</span>
<a href="#l26.1196"></a><span id="l26.1196" class="difflineminus">-      case 'toggle-final-mime':</span>
<a href="#l26.1197"></a><span id="l26.1197" class="difflineminus">-        this.setFinalSendMode(what);</span>
<a href="#l26.1198"></a><span id="l26.1198" class="difflineminus">-        break;</span>
<a href="#l26.1199"></a><span id="l26.1199" class="difflineminus">-</span>
<a href="#l26.1200"></a><span id="l26.1200">       case 'trustKeys':</span>
<a href="#l26.1201"></a><span id="l26.1201">         this.tempTrustAllKeys();</span>
<a href="#l26.1202"></a><span id="l26.1202">         break;</span>
<a href="#l26.1203"></a><span id="l26.1203"> </span>
<a href="#l26.1204"></a><span id="l26.1204">       case 'nothing':</span>
<a href="#l26.1205"></a><span id="l26.1205">         break;</span>
<a href="#l26.1206"></a><span id="l26.1206"> </span>
<a href="#l26.1207"></a><span id="l26.1207">       case 'displaySecuritySettings':</span>
<a href="#l26.1208"></a><span id="l26.1208">         this.displaySecuritySettings();</span>
<a href="#l26.1209"></a><span id="l26.1209">         break;</span>
<a href="#l26.1210"></a><span id="l26.1210">       default:</span>
<a href="#l26.1211"></a><span id="l26.1211">         this.displaySecuritySettings();</span>
<a href="#l26.1212"></a><span id="l26.1212">     }</span>
<a href="#l26.1213"></a><span id="l26.1213"> </span>
<a href="#l26.1214"></a><span id="l26.1214">   },</span>
<a href="#l26.1215"></a><span id="l26.1215" class="difflineplus">+  */</span>
<a href="#l26.1216"></a><span id="l26.1216"> </span>
<a href="#l26.1217"></a><span id="l26.1217"> </span>
<a href="#l26.1218"></a><span id="l26.1218">   // changes the DEFAULT sendMode</span>
<a href="#l26.1219"></a><span id="l26.1219">   // - also called internally for saved emails</span>
<a href="#l26.1220"></a><span id="l26.1220" class="difflineplus">+  /*</span>
<a href="#l26.1221"></a><span id="l26.1221">   setSendMode: function(sendMode) {</span>
<a href="#l26.1222"></a><span id="l26.1222">     EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.setSendMode: sendMode=&quot; + sendMode + &quot;\n&quot;);</span>
<a href="#l26.1223"></a><span id="l26.1223">     const SIGN = EnigmailConstants.SEND_SIGNED;</span>
<a href="#l26.1224"></a><span id="l26.1224">     const ENCRYPT = EnigmailConstants.SEND_ENCRYPTED;</span>
<a href="#l26.1225"></a><span id="l26.1225"> </span>
<a href="#l26.1226"></a><span id="l26.1226">     var origSendMode = this.sendMode;</span>
<a href="#l26.1227"></a><span id="l26.1227">     switch (sendMode) {</span>
<a href="#l26.1228"></a><span id="l26.1228">       case 'sign':</span>
<a href="#l26.1229"></a><span id="l26.1229" class="difflineat">@@ -1374,528 +1264,110 @@ Enigmail.msg = {</span>
<a href="#l26.1230"></a><span id="l26.1230">     // sendMode changed ?</span>
<a href="#l26.1231"></a><span id="l26.1231">     // - sign and send are internal initializations</span>
<a href="#l26.1232"></a><span id="l26.1232">     if (!this.sendModeDirty &amp;&amp; (this.sendMode != origSendMode) &amp;&amp; sendMode != 'sign' &amp;&amp; sendMode != 'encrypt') {</span>
<a href="#l26.1233"></a><span id="l26.1233">       this.sendModeDirty = true;</span>
<a href="#l26.1234"></a><span id="l26.1234">     }</span>
<a href="#l26.1235"></a><span id="l26.1235">     this.processFinalState();</span>
<a href="#l26.1236"></a><span id="l26.1236">     this.updateStatusBar();</span>
<a href="#l26.1237"></a><span id="l26.1237">   },</span>
<a href="#l26.1238"></a><span id="l26.1238" class="difflineminus">-</span>
<a href="#l26.1239"></a><span id="l26.1239" class="difflineminus">-</span>
<a href="#l26.1240"></a><span id="l26.1240" class="difflineminus">-  // changes the FINAL sendMode</span>
<a href="#l26.1241"></a><span id="l26.1241" class="difflineminus">-  // - triggered by the user interface</span>
<a href="#l26.1242"></a><span id="l26.1242" class="difflineminus">-  setFinalSendMode: function(sendMode) {</span>
<a href="#l26.1243"></a><span id="l26.1243" class="difflineminus">-    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.setFinalSendMode: sendMode=&quot; + sendMode + &quot;\n&quot;);</span>
<a href="#l26.1244"></a><span id="l26.1244" class="difflineminus">-</span>
<a href="#l26.1245"></a><span id="l26.1245" class="difflineminus">-    const SIGN = EnigmailConstants.SEND_SIGNED;</span>
<a href="#l26.1246"></a><span id="l26.1246" class="difflineminus">-    const ENCRYPT = EnigmailConstants.SEND_ENCRYPTED;</span>
<a href="#l26.1247"></a><span id="l26.1247" class="difflineminus">-</span>
<a href="#l26.1248"></a><span id="l26.1248" class="difflineminus">-    switch (sendMode) {</span>
<a href="#l26.1249"></a><span id="l26.1249" class="difflineminus">-</span>
<a href="#l26.1250"></a><span id="l26.1250" class="difflineminus">-      // menu entries for final settings:</span>
<a href="#l26.1251"></a><span id="l26.1251" class="difflineminus">-</span>
<a href="#l26.1252"></a><span id="l26.1252" class="difflineminus">-      case 'final-encryptDefault':</span>
<a href="#l26.1253"></a><span id="l26.1253" class="difflineminus">-        // switch encryption to &quot;use defaults &amp; rules&quot;</span>
<a href="#l26.1254"></a><span id="l26.1254" class="difflineminus">-        if (this.encryptForced != EnigmailConstants.ENIG_UNDEF) { // if encrypt/noencrypt forced</span>
<a href="#l26.1255"></a><span id="l26.1255" class="difflineminus">-          this.encryptForced = EnigmailConstants.ENIG_UNDEF; // back to defaults/rules</span>
<a href="#l26.1256"></a><span id="l26.1256" class="difflineminus">-        }</span>
<a href="#l26.1257"></a><span id="l26.1257" class="difflineminus">-        break;</span>
<a href="#l26.1258"></a><span id="l26.1258" class="difflineminus">-      case 'final-encryptYes':</span>
<a href="#l26.1259"></a><span id="l26.1259" class="difflineminus">-        // switch encryption to &quot;force encryption&quot;</span>
<a href="#l26.1260"></a><span id="l26.1260" class="difflineminus">-        if (this.encryptForced != EnigmailConstants.ENIG_ALWAYS) { // if not forced to encrypt</span>
<a href="#l26.1261"></a><span id="l26.1261" class="difflineminus">-          this.encryptForced = EnigmailConstants.ENIG_ALWAYS; // force to encrypt</span>
<a href="#l26.1262"></a><span id="l26.1262" class="difflineminus">-        }</span>
<a href="#l26.1263"></a><span id="l26.1263" class="difflineminus">-        break;</span>
<a href="#l26.1264"></a><span id="l26.1264" class="difflineminus">-      case 'final-encryptNo':</span>
<a href="#l26.1265"></a><span id="l26.1265" class="difflineminus">-        // switch encryption to &quot;force no to encrypt&quot;</span>
<a href="#l26.1266"></a><span id="l26.1266" class="difflineminus">-        if (this.encryptForced != EnigmailConstants.ENIG_NEVER) { // if not forced not to encrypt</span>
<a href="#l26.1267"></a><span id="l26.1267" class="difflineminus">-          this.encryptForced = EnigmailConstants.ENIG_NEVER; // force not to encrypt</span>
<a href="#l26.1268"></a><span id="l26.1268" class="difflineminus">-        }</span>
<a href="#l26.1269"></a><span id="l26.1269" class="difflineminus">-        break;</span>
<a href="#l26.1270"></a><span id="l26.1270" class="difflineminus">-</span>
<a href="#l26.1271"></a><span id="l26.1271" class="difflineminus">-      case 'final-signDefault':</span>
<a href="#l26.1272"></a><span id="l26.1272" class="difflineminus">-        // switch signing to &quot;use defaults &amp; rules&quot;</span>
<a href="#l26.1273"></a><span id="l26.1273" class="difflineminus">-        if (this.signForced != EnigmailConstants.ENIG_UNDEF) { // if sign/nosign forced</span>
<a href="#l26.1274"></a><span id="l26.1274" class="difflineminus">-          // re-init if signing depends on encryption if this was broken before</span>
<a href="#l26.1275"></a><span id="l26.1275" class="difflineminus">-          this.finalSignDependsOnEncrypt = (this.getAccDefault(&quot;signIfEnc&quot;) || this.getAccDefault(&quot;signIfNotEnc&quot;));</span>
<a href="#l26.1276"></a><span id="l26.1276" class="difflineminus">-          this.signForced = EnigmailConstants.ENIG_UNDEF; // back to defaults/rules</span>
<a href="#l26.1277"></a><span id="l26.1277" class="difflineminus">-        }</span>
<a href="#l26.1278"></a><span id="l26.1278" class="difflineminus">-        break;</span>
<a href="#l26.1279"></a><span id="l26.1279" class="difflineminus">-      case 'final-signYes':</span>
<a href="#l26.1280"></a><span id="l26.1280" class="difflineminus">-        if (this.signForced != EnigmailConstants.ENIG_ALWAYS) { // if not forced to sign</span>
<a href="#l26.1281"></a><span id="l26.1281" class="difflineminus">-          this.signingNoLongerDependsOnEnc();</span>
<a href="#l26.1282"></a><span id="l26.1282" class="difflineminus">-          this.signForced = EnigmailConstants.ENIG_ALWAYS; // force to sign</span>
<a href="#l26.1283"></a><span id="l26.1283" class="difflineminus">-        }</span>
<a href="#l26.1284"></a><span id="l26.1284" class="difflineminus">-        break;</span>
<a href="#l26.1285"></a><span id="l26.1285" class="difflineminus">-      case 'final-signNo':</span>
<a href="#l26.1286"></a><span id="l26.1286" class="difflineminus">-        if (this.signForced != EnigmailConstants.ENIG_NEVER) { // if not forced not to sign</span>
<a href="#l26.1287"></a><span id="l26.1287" class="difflineminus">-          this.signingNoLongerDependsOnEnc();</span>
<a href="#l26.1288"></a><span id="l26.1288" class="difflineminus">-          this.signForced = EnigmailConstants.ENIG_NEVER; // force not to sign</span>
<a href="#l26.1289"></a><span id="l26.1289" class="difflineminus">-        }</span>
<a href="#l26.1290"></a><span id="l26.1290" class="difflineminus">-        break;</span>
<a href="#l26.1291"></a><span id="l26.1291" class="difflineminus">-</span>
<a href="#l26.1292"></a><span id="l26.1292" class="difflineminus">-      case 'final-pgpmimeDefault':</span>
<a href="#l26.1293"></a><span id="l26.1293" class="difflineminus">-        if (this.pgpmimeForced != EnigmailConstants.ENIG_UNDEF) { // if any PGP mode forced</span>
<a href="#l26.1294"></a><span id="l26.1294" class="difflineminus">-          this.pgpmimeForced = EnigmailConstants.ENIG_UNDEF; // back to defaults/rules</span>
<a href="#l26.1295"></a><span id="l26.1295" class="difflineminus">-        }</span>
<a href="#l26.1296"></a><span id="l26.1296" class="difflineminus">-        break;</span>
<a href="#l26.1297"></a><span id="l26.1297" class="difflineminus">-      case 'final-pgpmimeYes':</span>
<a href="#l26.1298"></a><span id="l26.1298" class="difflineminus">-        if (this.pgpmimeForced != EnigmailConstants.ENIG_ALWAYS) { // if not forced to PGP/Mime</span>
<a href="#l26.1299"></a><span id="l26.1299" class="difflineminus">-          this.pgpmimeForced = EnigmailConstants.ENIG_ALWAYS; // force to PGP/Mime</span>
<a href="#l26.1300"></a><span id="l26.1300" class="difflineminus">-        }</span>
<a href="#l26.1301"></a><span id="l26.1301" class="difflineminus">-        break;</span>
<a href="#l26.1302"></a><span id="l26.1302" class="difflineminus">-      case 'final-pgpmimeNo':</span>
<a href="#l26.1303"></a><span id="l26.1303" class="difflineminus">-        if (this.pgpmimeForced != EnigmailConstants.ENIG_NEVER) { // if not forced not to PGP/Mime</span>
<a href="#l26.1304"></a><span id="l26.1304" class="difflineminus">-          this.pgpmimeForced = EnigmailConstants.ENIG_NEVER; // force not to PGP/Mime</span>
<a href="#l26.1305"></a><span id="l26.1305" class="difflineminus">-        }</span>
<a href="#l26.1306"></a><span id="l26.1306" class="difflineminus">-        break;</span>
<a href="#l26.1307"></a><span id="l26.1307" class="difflineminus">-</span>
<a href="#l26.1308"></a><span id="l26.1308" class="difflineminus">-      case 'final-useSmime':</span>
<a href="#l26.1309"></a><span id="l26.1309" class="difflineminus">-        //</span>
<a href="#l26.1310"></a><span id="l26.1310" class="difflineminus">-        this.pgpmimeForced = EnigmailConstants.ENIG_FORCE_SMIME;</span>
<a href="#l26.1311"></a><span id="l26.1311" class="difflineminus">-        break;</span>
<a href="#l26.1312"></a><span id="l26.1312" class="difflineminus">-</span>
<a href="#l26.1313"></a><span id="l26.1313" class="difflineminus">-        // status bar buttons:</span>
<a href="#l26.1314"></a><span id="l26.1314" class="difflineminus">-        // - can only switch to force or not to force sign/enc</span>
<a href="#l26.1315"></a><span id="l26.1315" class="difflineminus">-</span>
<a href="#l26.1316"></a><span id="l26.1316" class="difflineminus">-      case 'toggle-final-sign':</span>
<a href="#l26.1317"></a><span id="l26.1317" class="difflineminus">-        this.signingNoLongerDependsOnEnc();</span>
<a href="#l26.1318"></a><span id="l26.1318" class="difflineminus">-        switch (this.statusSigned) {</span>
<a href="#l26.1319"></a><span id="l26.1319" class="difflineminus">-          case EnigmailConstants.ENIG_FINAL_NO:</span>
<a href="#l26.1320"></a><span id="l26.1320" class="difflineminus">-          case EnigmailConstants.ENIG_FINAL_FORCENO:</span>
<a href="#l26.1321"></a><span id="l26.1321" class="difflineminus">-            this.signForced = EnigmailConstants.ENIG_ALWAYS; // force to sign</span>
<a href="#l26.1322"></a><span id="l26.1322" class="difflineminus">-            break;</span>
<a href="#l26.1323"></a><span id="l26.1323" class="difflineminus">-          case EnigmailConstants.ENIG_FINAL_YES:</span>
<a href="#l26.1324"></a><span id="l26.1324" class="difflineminus">-          case EnigmailConstants.ENIG_FINAL_FORCEYES:</span>
<a href="#l26.1325"></a><span id="l26.1325" class="difflineminus">-            this.signForced = EnigmailConstants.ENIG_NEVER; // force not to sign</span>
<a href="#l26.1326"></a><span id="l26.1326" class="difflineminus">-            break;</span>
<a href="#l26.1327"></a><span id="l26.1327" class="difflineminus">-          case EnigmailConstants.ENIG_FINAL_CONFLICT:</span>
<a href="#l26.1328"></a><span id="l26.1328" class="difflineminus">-            this.signForced = EnigmailConstants.ENIG_NEVER;</span>
<a href="#l26.1329"></a><span id="l26.1329" class="difflineminus">-            break;</span>
<a href="#l26.1330"></a><span id="l26.1330" class="difflineminus">-        }</span>
<a href="#l26.1331"></a><span id="l26.1331" class="difflineminus">-        break;</span>
<a href="#l26.1332"></a><span id="l26.1332" class="difflineminus">-</span>
<a href="#l26.1333"></a><span id="l26.1333" class="difflineminus">-      case 'toggle-final-encrypt':</span>
<a href="#l26.1334"></a><span id="l26.1334" class="difflineminus">-        switch (this.statusEncrypted) {</span>
<a href="#l26.1335"></a><span id="l26.1335" class="difflineminus">-          case EnigmailConstants.ENIG_FINAL_NO:</span>
<a href="#l26.1336"></a><span id="l26.1336" class="difflineminus">-          case EnigmailConstants.ENIG_FINAL_FORCENO:</span>
<a href="#l26.1337"></a><span id="l26.1337" class="difflineminus">-            this.encryptForced = EnigmailConstants.ENIG_ALWAYS; // force to encrypt</span>
<a href="#l26.1338"></a><span id="l26.1338" class="difflineminus">-            break;</span>
<a href="#l26.1339"></a><span id="l26.1339" class="difflineminus">-          case EnigmailConstants.ENIG_FINAL_YES:</span>
<a href="#l26.1340"></a><span id="l26.1340" class="difflineminus">-          case EnigmailConstants.ENIG_FINAL_FORCEYES:</span>
<a href="#l26.1341"></a><span id="l26.1341" class="difflineminus">-            this.encryptForced = EnigmailConstants.ENIG_NEVER; // force not to encrypt</span>
<a href="#l26.1342"></a><span id="l26.1342" class="difflineminus">-            break;</span>
<a href="#l26.1343"></a><span id="l26.1343" class="difflineminus">-          case EnigmailConstants.ENIG_FINAL_CONFLICT:</span>
<a href="#l26.1344"></a><span id="l26.1344" class="difflineminus">-            this.encryptForced = EnigmailConstants.ENIG_NEVER;</span>
<a href="#l26.1345"></a><span id="l26.1345" class="difflineminus">-            break;</span>
<a href="#l26.1346"></a><span id="l26.1346" class="difflineminus">-        }</span>
<a href="#l26.1347"></a><span id="l26.1347" class="difflineminus">-        break;</span>
<a href="#l26.1348"></a><span id="l26.1348" class="difflineminus">-</span>
<a href="#l26.1349"></a><span id="l26.1349" class="difflineminus">-      case 'toggle-final-mime':</span>
<a href="#l26.1350"></a><span id="l26.1350" class="difflineminus">-        switch (this.statusPGPMime) {</span>
<a href="#l26.1351"></a><span id="l26.1351" class="difflineminus">-          case EnigmailConstants.ENIG_FINAL_NO:</span>
<a href="#l26.1352"></a><span id="l26.1352" class="difflineminus">-          case EnigmailConstants.ENIG_FINAL_FORCENO:</span>
<a href="#l26.1353"></a><span id="l26.1353" class="difflineminus">-            this.pgpmimeForced = EnigmailConstants.ENIG_ALWAYS; // force PGP/MIME</span>
<a href="#l26.1354"></a><span id="l26.1354" class="difflineminus">-            break;</span>
<a href="#l26.1355"></a><span id="l26.1355" class="difflineminus">-          case EnigmailConstants.ENIG_FINAL_YES:</span>
<a href="#l26.1356"></a><span id="l26.1356" class="difflineminus">-          case EnigmailConstants.ENIG_FINAL_FORCEYES:</span>
<a href="#l26.1357"></a><span id="l26.1357" class="difflineminus">-            this.pgpmimeForced = EnigmailConstants.ENIG_NEVER; // force Inline-PGP</span>
<a href="#l26.1358"></a><span id="l26.1358" class="difflineminus">-            break;</span>
<a href="#l26.1359"></a><span id="l26.1359" class="difflineminus">-          case EnigmailConstants.ENIG_FINAL_CONFLICT:</span>
<a href="#l26.1360"></a><span id="l26.1360" class="difflineminus">-            this.pgpmimeForced = EnigmailConstants.ENIG_NEVER;</span>
<a href="#l26.1361"></a><span id="l26.1361" class="difflineminus">-            break;</span>
<a href="#l26.1362"></a><span id="l26.1362" class="difflineminus">-        }</span>
<a href="#l26.1363"></a><span id="l26.1363" class="difflineminus">-        break;</span>
<a href="#l26.1364"></a><span id="l26.1364" class="difflineminus">-</span>
<a href="#l26.1365"></a><span id="l26.1365" class="difflineminus">-      default:</span>
<a href="#l26.1366"></a><span id="l26.1366" class="difflineminus">-        EnigmailDialog.alert(window, &quot;Enigmail.msg.setFinalSendMode - unexpected value: &quot; + sendMode);</span>
<a href="#l26.1367"></a><span id="l26.1367" class="difflineminus">-        break;</span>
<a href="#l26.1368"></a><span id="l26.1368" class="difflineminus">-    }</span>
<a href="#l26.1369"></a><span id="l26.1369" class="difflineminus">-</span>
<a href="#l26.1370"></a><span id="l26.1370" class="difflineminus">-    // this is always a send mode change (only toggle effects)</span>
<a href="#l26.1371"></a><span id="l26.1371" class="difflineminus">-    this.sendModeDirty = true;</span>
<a href="#l26.1372"></a><span id="l26.1372" class="difflineminus">-</span>
<a href="#l26.1373"></a><span id="l26.1373" class="difflineminus">-    this.determineSendFlags();</span>
<a href="#l26.1374"></a><span id="l26.1374" class="difflineminus">-    //this.processFinalState();</span>
<a href="#l26.1375"></a><span id="l26.1375" class="difflineminus">-    //this.updateStatusBar();</span>
<a href="#l26.1376"></a><span id="l26.1376" class="difflineminus">-  },</span>
<a href="#l26.1377"></a><span id="l26.1377" class="difflineplus">+  */</span>
<a href="#l26.1378"></a><span id="l26.1378" class="difflineplus">+</span>
<a href="#l26.1379"></a><span id="l26.1379"> </span>
<a href="#l26.1380"></a><span id="l26.1380">   /**</span>
<a href="#l26.1381"></a><span id="l26.1381">     key function to process the final encrypt/sign/pgpmime state from all settings</span>
<a href="#l26.1382"></a><span id="l26.1382">     @param sendFlags: contains the sendFlags if the message is really processed. Optional, can be null</span>
<a href="#l26.1383"></a><span id="l26.1383">       - uses as INPUT:</span>
<a href="#l26.1384"></a><span id="l26.1384">          - this.sendMode</span>
<a href="#l26.1385"></a><span id="l26.1385" class="difflineminus">-         - this.encryptByRules, this.signByRules, pgpmimeByRules</span>
<a href="#l26.1386"></a><span id="l26.1386">          - this.encryptForced, this.encryptSigned</span>
<a href="#l26.1387"></a><span id="l26.1387">       - uses as OUTPUT:</span>
<a href="#l26.1388"></a><span id="l26.1388" class="difflineminus">-         - this.statusEncrypt, this.statusSign, this.statusPGPMime</span>
<a href="#l26.1389"></a><span id="l26.1389" class="difflineplus">+         - this.statusEncrypt, this.statusSign</span>
<a href="#l26.1390"></a><span id="l26.1390"> </span>
<a href="#l26.1391"></a><span id="l26.1391">     no return value</span>
<a href="#l26.1392"></a><span id="l26.1392">   */</span>
<a href="#l26.1393"></a><span id="l26.1393">   processFinalState: function(sendFlags) {</span>
<a href="#l26.1394"></a><span id="l26.1394" class="difflineplus">+    return;</span>
<a href="#l26.1395"></a><span id="l26.1395" class="difflineplus">+    /*</span>
<a href="#l26.1396"></a><span id="l26.1396">     EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.processFinalState()\n&quot;);</span>
<a href="#l26.1397"></a><span id="l26.1397"> </span>
<a href="#l26.1398"></a><span id="l26.1398">     const SIGN = EnigmailConstants.SEND_SIGNED;</span>
<a href="#l26.1399"></a><span id="l26.1399">     const ENCRYPT = EnigmailConstants.SEND_ENCRYPTED;</span>
<a href="#l26.1400"></a><span id="l26.1400"> </span>
<a href="#l26.1401"></a><span id="l26.1401"> </span>
<a href="#l26.1402"></a><span id="l26.1402" class="difflineminus">-    let encFinally = null;</span>
<a href="#l26.1403"></a><span id="l26.1403">     let encReason = &quot;&quot;;</span>
<a href="#l26.1404"></a><span id="l26.1404" class="difflineminus">-    let signFinally = null;</span>
<a href="#l26.1405"></a><span id="l26.1405">     let signReason = &quot;&quot;;</span>
<a href="#l26.1406"></a><span id="l26.1406" class="difflineminus">-    let pgpmimeFinally = null;</span>
<a href="#l26.1407"></a><span id="l26.1407" class="difflineminus">-    let pgpEnabled = this.isEnigmailEnabled();</span>
<a href="#l26.1408"></a><span id="l26.1408" class="difflineminus">-    let smimeEnabled = this.isSmimeEnabled();</span>
<a href="#l26.1409"></a><span id="l26.1409" class="difflineplus">+    let pgpEnabled = Enigmail.msg.wasEnigmailEnabledForIdentity();</span>
<a href="#l26.1410"></a><span id="l26.1410" class="difflineplus">+    let smimeEnabled = Enigmail.msg.isSmimeEnabled();</span>
<a href="#l26.1411"></a><span id="l26.1411"> </span>
<a href="#l26.1412"></a><span id="l26.1412">     // ------ 1. process OpenPGP status ------</span>
<a href="#l26.1413"></a><span id="l26.1413"> </span>
<a href="#l26.1414"></a><span id="l26.1414" class="difflineminus">-    // process resulting encrypt mode</span>
<a href="#l26.1415"></a><span id="l26.1415" class="difflineminus">-    if (this.encryptForced == EnigmailConstants.ENIG_NEVER) { // force not to encrypt?</span>
<a href="#l26.1416"></a><span id="l26.1416" class="difflineminus">-      encFinally = EnigmailConstants.ENIG_FINAL_FORCENO;</span>
<a href="#l26.1417"></a><span id="l26.1417" class="difflineminus">-      encReason = EnigmailLocale.getString(&quot;reasonManuallyForced&quot;);</span>
<a href="#l26.1418"></a><span id="l26.1418" class="difflineminus">-    }</span>
<a href="#l26.1419"></a><span id="l26.1419" class="difflineminus">-    else if (this.encryptForced == EnigmailConstants.ENIG_ALWAYS) { // force to encrypt?</span>
<a href="#l26.1420"></a><span id="l26.1420" class="difflineminus">-      encFinally = EnigmailConstants.ENIG_FINAL_FORCEYES;</span>
<a href="#l26.1421"></a><span id="l26.1421" class="difflineminus">-      encReason = EnigmailLocale.getString(&quot;reasonManuallyForced&quot;);</span>
<a href="#l26.1422"></a><span id="l26.1422" class="difflineminus">-    }</span>
<a href="#l26.1423"></a><span id="l26.1423" class="difflineminus">-    else switch (this.encryptByRules) {</span>
<a href="#l26.1424"></a><span id="l26.1424" class="difflineminus">-      case EnigmailConstants.ENIG_NEVER:</span>
<a href="#l26.1425"></a><span id="l26.1425" class="difflineminus">-        encFinally = EnigmailConstants.ENIG_FINAL_NO;</span>
<a href="#l26.1426"></a><span id="l26.1426" class="difflineminus">-        encReason = EnigmailLocale.getString(&quot;reasonByRecipientRules&quot;);</span>
<a href="#l26.1427"></a><span id="l26.1427" class="difflineminus">-        break;</span>
<a href="#l26.1428"></a><span id="l26.1428" class="difflineminus">-      case EnigmailConstants.ENIG_UNDEF:</span>
<a href="#l26.1429"></a><span id="l26.1429" class="difflineminus">-        if (this.sendMode &amp; ENCRYPT) {</span>
<a href="#l26.1430"></a><span id="l26.1430" class="difflineminus">-          encFinally = EnigmailConstants.ENIG_FINAL_YES;</span>
<a href="#l26.1431"></a><span id="l26.1431" class="difflineminus">-          if (pgpEnabled &amp;&amp; this.getAccDefault(&quot;encrypt&quot;)) {</span>
<a href="#l26.1432"></a><span id="l26.1432" class="difflineminus">-            encReason = EnigmailLocale.getString(&quot;reasonEnabledByDefault&quot;);</span>
<a href="#l26.1433"></a><span id="l26.1433" class="difflineminus">-          }</span>
<a href="#l26.1434"></a><span id="l26.1434" class="difflineminus">-        }</span>
<a href="#l26.1435"></a><span id="l26.1435" class="difflineminus">-        else {</span>
<a href="#l26.1436"></a><span id="l26.1436" class="difflineminus">-          encFinally = EnigmailConstants.ENIG_FINAL_NO;</span>
<a href="#l26.1437"></a><span id="l26.1437" class="difflineminus">-        }</span>
<a href="#l26.1438"></a><span id="l26.1438" class="difflineminus">-        break;</span>
<a href="#l26.1439"></a><span id="l26.1439" class="difflineminus">-      case EnigmailConstants.ENIG_ALWAYS:</span>
<a href="#l26.1440"></a><span id="l26.1440" class="difflineminus">-        encFinally = EnigmailConstants.ENIG_FINAL_YES;</span>
<a href="#l26.1441"></a><span id="l26.1441" class="difflineminus">-        encReason = EnigmailLocale.getString(&quot;reasonByRecipientRules&quot;);</span>
<a href="#l26.1442"></a><span id="l26.1442" class="difflineminus">-        break;</span>
<a href="#l26.1443"></a><span id="l26.1443" class="difflineminus">-      case EnigmailConstants.ENIG_AUTO_ALWAYS:</span>
<a href="#l26.1444"></a><span id="l26.1444" class="difflineminus">-        encFinally = EnigmailConstants.ENIG_FINAL_YES;</span>
<a href="#l26.1445"></a><span id="l26.1445" class="difflineminus">-        encReason = EnigmailLocale.getString(&quot;reasonByAutoEncryption&quot;);</span>
<a href="#l26.1446"></a><span id="l26.1446" class="difflineminus">-        break;</span>
<a href="#l26.1447"></a><span id="l26.1447" class="difflineminus">-      case EnigmailConstants.ENIG_CONFLICT:</span>
<a href="#l26.1448"></a><span id="l26.1448" class="difflineminus">-        encFinally = EnigmailConstants.ENIG_FINAL_CONFLICT;</span>
<a href="#l26.1449"></a><span id="l26.1449" class="difflineminus">-        encReason = EnigmailLocale.getString(&quot;reasonByConflict&quot;);</span>
<a href="#l26.1450"></a><span id="l26.1450" class="difflineminus">-        break;</span>
<a href="#l26.1451"></a><span id="l26.1451" class="difflineminus">-    }</span>
<a href="#l26.1452"></a><span id="l26.1452" class="difflineminus">-    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js:   encrypt=&quot; + ((this.sendMode &amp; ENCRYPT) !== 0) + &quot; encryptByRules=&quot; + this.encryptByRules + &quot; encFinally=&quot; + encFinally + &quot;\n&quot;);</span>
<a href="#l26.1453"></a><span id="l26.1453" class="difflineminus">-    EnigmailLog.DEBUG(&quot;                                encReason=&quot; + encReason + &quot;\n&quot;);</span>
<a href="#l26.1454"></a><span id="l26.1454" class="difflineminus">-</span>
<a href="#l26.1455"></a><span id="l26.1455" class="difflineminus">-    // process resulting sign mode</span>
<a href="#l26.1456"></a><span id="l26.1456" class="difflineminus">-    if (this.signForced == EnigmailConstants.ENIG_NEVER) { // force not to sign?</span>
<a href="#l26.1457"></a><span id="l26.1457" class="difflineminus">-      signFinally = EnigmailConstants.ENIG_FINAL_FORCENO;</span>
<a href="#l26.1458"></a><span id="l26.1458" class="difflineminus">-      signReason = EnigmailLocale.getString(&quot;reasonManuallyForced&quot;);</span>
<a href="#l26.1459"></a><span id="l26.1459" class="difflineminus">-    }</span>
<a href="#l26.1460"></a><span id="l26.1460" class="difflineminus">-    else if (this.signForced == EnigmailConstants.ENIG_ALWAYS) { // force to sign?</span>
<a href="#l26.1461"></a><span id="l26.1461" class="difflineminus">-      signFinally = EnigmailConstants.ENIG_FINAL_FORCEYES;</span>
<a href="#l26.1462"></a><span id="l26.1462" class="difflineminus">-      signReason = EnigmailLocale.getString(&quot;reasonManuallyForced&quot;);</span>
<a href="#l26.1463"></a><span id="l26.1463" class="difflineminus">-    }</span>
<a href="#l26.1464"></a><span id="l26.1464" class="difflineminus">-    else switch (this.signByRules) {</span>
<a href="#l26.1465"></a><span id="l26.1465" class="difflineminus">-      case EnigmailConstants.ENIG_NEVER:</span>
<a href="#l26.1466"></a><span id="l26.1466" class="difflineminus">-        signFinally = EnigmailConstants.ENIG_FINAL_NO;</span>
<a href="#l26.1467"></a><span id="l26.1467" class="difflineminus">-        signReason = EnigmailLocale.getString(&quot;reasonByRecipientRules&quot;);</span>
<a href="#l26.1468"></a><span id="l26.1468" class="difflineminus">-        break;</span>
<a href="#l26.1469"></a><span id="l26.1469" class="difflineminus">-      case EnigmailConstants.ENIG_UNDEF:</span>
<a href="#l26.1470"></a><span id="l26.1470" class="difflineminus">-        if (this.sendMode &amp; SIGN) {</span>
<a href="#l26.1471"></a><span id="l26.1471" class="difflineminus">-          signFinally = EnigmailConstants.ENIG_FINAL_YES;</span>
<a href="#l26.1472"></a><span id="l26.1472" class="difflineminus">-          if (pgpEnabled &amp;&amp; this.getAccDefault(&quot;sign-pgp&quot;)) {</span>
<a href="#l26.1473"></a><span id="l26.1473" class="difflineminus">-            signReason = EnigmailLocale.getString(&quot;reasonEnabledByDefault&quot;);</span>
<a href="#l26.1474"></a><span id="l26.1474" class="difflineminus">-          }</span>
<a href="#l26.1475"></a><span id="l26.1475" class="difflineminus">-        }</span>
<a href="#l26.1476"></a><span id="l26.1476" class="difflineminus">-        else {</span>
<a href="#l26.1477"></a><span id="l26.1477" class="difflineminus">-          signFinally = EnigmailConstants.ENIG_FINAL_NO;</span>
<a href="#l26.1478"></a><span id="l26.1478" class="difflineminus">-        }</span>
<a href="#l26.1479"></a><span id="l26.1479" class="difflineminus">-        break;</span>
<a href="#l26.1480"></a><span id="l26.1480" class="difflineminus">-      case EnigmailConstants.ENIG_ALWAYS:</span>
<a href="#l26.1481"></a><span id="l26.1481" class="difflineminus">-        signFinally = EnigmailConstants.ENIG_FINAL_YES;</span>
<a href="#l26.1482"></a><span id="l26.1482" class="difflineminus">-        signReason = EnigmailLocale.getString(&quot;reasonByRecipientRules&quot;);</span>
<a href="#l26.1483"></a><span id="l26.1483" class="difflineminus">-        break;</span>
<a href="#l26.1484"></a><span id="l26.1484" class="difflineminus">-      case EnigmailConstants.ENIG_CONFLICT:</span>
<a href="#l26.1485"></a><span id="l26.1485" class="difflineminus">-        signFinally = EnigmailConstants.ENIG_FINAL_CONFLICT;</span>
<a href="#l26.1486"></a><span id="l26.1486" class="difflineminus">-        signReason = EnigmailLocale.getString(&quot;reasonByConflict&quot;);</span>
<a href="#l26.1487"></a><span id="l26.1487" class="difflineminus">-        break;</span>
<a href="#l26.1488"></a><span id="l26.1488" class="difflineminus">-    }</span>
<a href="#l26.1489"></a><span id="l26.1489" class="difflineminus">-    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js:   signed=&quot; + ((this.sendMode &amp; SIGN) !== 0) + &quot; signByRules=&quot; + this.signByRules + &quot; signFinally=&quot; + signFinally + &quot;\n&quot;);</span>
<a href="#l26.1490"></a><span id="l26.1490" class="difflineminus">-    EnigmailLog.DEBUG(&quot;                                signReason=&quot; + signReason + &quot;\n&quot;);</span>
<a href="#l26.1491"></a><span id="l26.1491" class="difflineminus">-</span>
<a href="#l26.1492"></a><span id="l26.1492" class="difflineminus">-    // process option to finally sign if encrypted/unencrypted</span>
<a href="#l26.1493"></a><span id="l26.1493" class="difflineminus">-    // (unless rules force not to sign)</span>
<a href="#l26.1494"></a><span id="l26.1494" class="difflineminus">-</span>
<a href="#l26.1495"></a><span id="l26.1495" class="difflineminus">-    if (this.finalSignDependsOnEncrypt &amp;&amp; pgpEnabled) {</span>
<a href="#l26.1496"></a><span id="l26.1496" class="difflineminus">-      if (this.signByRules == EnigmailConstants.ENIG_UNDEF) { // if final sign mode not clear yet</span>
<a href="#l26.1497"></a><span id="l26.1497" class="difflineminus">-        //derivedFromEncMode = true;</span>
<a href="#l26.1498"></a><span id="l26.1498" class="difflineminus">-        switch (encFinally) {</span>
<a href="#l26.1499"></a><span id="l26.1499" class="difflineminus">-          case EnigmailConstants.ENIG_FINAL_YES:</span>
<a href="#l26.1500"></a><span id="l26.1500" class="difflineminus">-          case EnigmailConstants.ENIG_FINAL_FORCEYES:</span>
<a href="#l26.1501"></a><span id="l26.1501" class="difflineminus">-            if (this.getAccDefault(&quot;signIfEnc&quot;)) {</span>
<a href="#l26.1502"></a><span id="l26.1502" class="difflineminus">-              signFinally = EnigmailConstants.ENIG_FINAL_YES;</span>
<a href="#l26.1503"></a><span id="l26.1503" class="difflineminus">-              signReason = EnigmailLocale.getString(&quot;reasonByEncryptionMode&quot;);</span>
<a href="#l26.1504"></a><span id="l26.1504" class="difflineminus">-            }</span>
<a href="#l26.1505"></a><span id="l26.1505" class="difflineminus">-            break;</span>
<a href="#l26.1506"></a><span id="l26.1506" class="difflineminus">-          case EnigmailConstants.ENIG_FINAL_NO:</span>
<a href="#l26.1507"></a><span id="l26.1507" class="difflineminus">-          case EnigmailConstants.ENIG_FINAL_FORCENO:</span>
<a href="#l26.1508"></a><span id="l26.1508" class="difflineminus">-            if (this.getAccDefault(&quot;signIfNotEnc&quot;)) {</span>
<a href="#l26.1509"></a><span id="l26.1509" class="difflineminus">-              signFinally = EnigmailConstants.ENIG_FINAL_YES;</span>
<a href="#l26.1510"></a><span id="l26.1510" class="difflineminus">-              signReason = EnigmailLocale.getString(&quot;reasonByEncryptionMode&quot;);</span>
<a href="#l26.1511"></a><span id="l26.1511" class="difflineminus">-            }</span>
<a href="#l26.1512"></a><span id="l26.1512" class="difflineminus">-            break;</span>
<a href="#l26.1513"></a><span id="l26.1513" class="difflineminus">-          case EnigmailConstants.ENIG_FINAL_CONFLICT:</span>
<a href="#l26.1514"></a><span id="l26.1514" class="difflineminus">-            if (this.getAccDefault(&quot;signIfEnc&quot;) &amp;&amp; this.getAccDefault(&quot;signIfNotEnc&quot;)) {</span>
<a href="#l26.1515"></a><span id="l26.1515" class="difflineminus">-              signFinally = EnigmailConstants.ENIG_FINAL_YES;</span>
<a href="#l26.1516"></a><span id="l26.1516" class="difflineminus">-              signReason = EnigmailLocale.getString(&quot;reasonByEncryptionMode&quot;);</span>
<a href="#l26.1517"></a><span id="l26.1517" class="difflineminus">-            }</span>
<a href="#l26.1518"></a><span id="l26.1518" class="difflineminus">-            else {</span>
<a href="#l26.1519"></a><span id="l26.1519" class="difflineminus">-              signFinally = EnigmailConstants.ENIG_FINAL_CONFLICT;</span>
<a href="#l26.1520"></a><span id="l26.1520" class="difflineminus">-            }</span>
<a href="#l26.1521"></a><span id="l26.1521" class="difflineminus">-            break;</span>
<a href="#l26.1522"></a><span id="l26.1522" class="difflineminus">-        }</span>
<a href="#l26.1523"></a><span id="l26.1523" class="difflineminus">-        EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js:   derived signFinally=&quot; + signFinally + &quot;\n&quot;);</span>
<a href="#l26.1524"></a><span id="l26.1524" class="difflineminus">-        EnigmailLog.DEBUG(&quot;                                signReason=&quot; + signReason + &quot;\n&quot;);</span>
<a href="#l26.1525"></a><span id="l26.1525" class="difflineminus">-      }</span>
<a href="#l26.1526"></a><span id="l26.1526" class="difflineminus">-    }</span>
<a href="#l26.1527"></a><span id="l26.1527" class="difflineminus">-</span>
<a href="#l26.1528"></a><span id="l26.1528" class="difflineminus">-    if (pgpEnabled) {</span>
<a href="#l26.1529"></a><span id="l26.1529" class="difflineminus">-      this.statusPGPMime = EnigmailConstants.ENIG_FINAL_UNDEF;</span>
<a href="#l26.1530"></a><span id="l26.1530" class="difflineminus">-    }</span>
<a href="#l26.1531"></a><span id="l26.1531" class="difflineminus">-    else if (smimeEnabled) {</span>
<a href="#l26.1532"></a><span id="l26.1532" class="difflineminus">-      this.statusPGPMime = EnigmailConstants.ENIG_FINAL_SMIME;</span>
<a href="#l26.1533"></a><span id="l26.1533" class="difflineminus">-    }</span>
<a href="#l26.1534"></a><span id="l26.1534" class="difflineplus">+    //pgpEnabled</span>
<a href="#l26.1535"></a><span id="l26.1535" class="difflineplus">+    //smimeEnabled</span>
<a href="#l26.1536"></a><span id="l26.1536" class="difflineplus">+</span>
<a href="#l26.1537"></a><span id="l26.1537" class="difflineplus">+</span>
<a href="#l26.1538"></a><span id="l26.1538"> </span>
<a href="#l26.1539"></a><span id="l26.1539">     // ------ 2. Process S/MIME status  ------</span>
<a href="#l26.1540"></a><span id="l26.1540">     if (gSMFields) {</span>
<a href="#l26.1541"></a><span id="l26.1541"> </span>
<a href="#l26.1542"></a><span id="l26.1542" class="difflineminus">-      let r = this.tryEnablingSMime(encFinally, signFinally);</span>
<a href="#l26.1543"></a><span id="l26.1543" class="difflineminus">-      if (this.statusPGPMime === EnigmailConstants.ENIG_FINAL_SMIME &amp;&amp;</span>
<a href="#l26.1544"></a><span id="l26.1544" class="difflineminus">-        r.encFinally === EnigmailConstants.ENIG_FINAL_NO &amp;&amp;</span>
<a href="#l26.1545"></a><span id="l26.1545" class="difflineminus">-        (this.identity.getIntAttribute(&quot;encryptionpolicy&quot;) &gt; 0)) {</span>
<a href="#l26.1546"></a><span id="l26.1546" class="difflineminus">-</span>
<a href="#l26.1547"></a><span id="l26.1547" class="difflineminus">-        r.encFinally = EnigmailConstants.ENIG_FINAL_YES;</span>
<a href="#l26.1548"></a><span id="l26.1548" class="difflineminus">-      }</span>
<a href="#l26.1549"></a><span id="l26.1549" class="difflineminus">-</span>
<a href="#l26.1550"></a><span id="l26.1550" class="difflineminus">-      encFinally = r.encFinally;</span>
<a href="#l26.1551"></a><span id="l26.1551" class="difflineminus">-      signFinally = r.signFinally;</span>
<a href="#l26.1552"></a><span id="l26.1552" class="difflineminus">-</span>
<a href="#l26.1553"></a><span id="l26.1553" class="difflineminus">-      // FIXME: check if bug 776 can be fixed here</span>
<a href="#l26.1554"></a><span id="l26.1554" class="difflineminus">-</span>
<a href="#l26.1555"></a><span id="l26.1555" class="difflineminus">-      if (encFinally === EnigmailConstants.ENIG_FINAL_NO &amp;&amp;</span>
<a href="#l26.1556"></a><span id="l26.1556" class="difflineminus">-        this.signByRules === EnigmailConstants.ENIG_UNDEF &amp;&amp;</span>
<a href="#l26.1557"></a><span id="l26.1557" class="difflineminus">-        signFinally !== EnigmailConstants.ENIG_FINAL_FORCEYES &amp;&amp;</span>
<a href="#l26.1558"></a><span id="l26.1558" class="difflineminus">-        signFinally !== EnigmailConstants.ENIG_FINAL_FORCENO) {</span>
<a href="#l26.1559"></a><span id="l26.1559" class="difflineminus">-</span>
<a href="#l26.1560"></a><span id="l26.1560" class="difflineminus">-        if (this.isEnigmailEnabled() &amp;&amp;</span>
<a href="#l26.1561"></a><span id="l26.1561" class="difflineminus">-          !this.identity.getBoolAttribute(&quot;sign_mail&quot;) &amp;&amp;</span>
<a href="#l26.1562"></a><span id="l26.1562" class="difflineminus">-          (this.getAccDefault(&quot;signIfNotEnc&quot;) || this.identity.getIntAttribute(&quot;defaultSigningPolicy&quot;) &gt; 0)) {</span>
<a href="#l26.1563"></a><span id="l26.1563" class="difflineminus">-          signFinally = EnigmailConstants.ENIG_FINAL_YES;</span>
<a href="#l26.1564"></a><span id="l26.1564" class="difflineminus">-          this.statusPGPMime = EnigmailConstants.ENIG_FINAL_UNDEF;</span>
<a href="#l26.1565"></a><span id="l26.1565" class="difflineplus">+        //gSMFields.requireEncryptMessage = false;</span>
<a href="#l26.1566"></a><span id="l26.1566" class="difflineplus">+        //gSMFields.signMessage = false;</span>
<a href="#l26.1567"></a><span id="l26.1567" class="difflineplus">+</span>
<a href="#l26.1568"></a><span id="l26.1568" class="difflineplus">+        if (!encryptSmime) {</span>
<a href="#l26.1569"></a><span id="l26.1569" class="difflineplus">+          if (autoSendEncrypted === 1) {</span>
<a href="#l26.1570"></a><span id="l26.1570" class="difflineplus">+            if (this.isSmimeEncryptionPossible()) {</span>
<a href="#l26.1571"></a><span id="l26.1571" class="difflineplus">+              if (this.mimePreferOpenPGP === 0) {</span>
<a href="#l26.1572"></a><span id="l26.1572" class="difflineplus">+                // S/MIME is preferred and encryption is possible</span>
<a href="#l26.1573"></a><span id="l26.1573" class="difflineplus">+                encryptSmime = true;</span>
<a href="#l26.1574"></a><span id="l26.1574" class="difflineplus">+              }</span>
<a href="#l26.1575"></a><span id="l26.1575" class="difflineplus">+            }</span>
<a href="#l26.1576"></a><span id="l26.1576" class="difflineplus">+          }</span>
<a href="#l26.1577"></a><span id="l26.1577">         }</span>
<a href="#l26.1578"></a><span id="l26.1578" class="difflineminus">-        else if (this.isSmimeEnabled() &amp;&amp;</span>
<a href="#l26.1579"></a><span id="l26.1579" class="difflineminus">-          this.identity.getIntAttribute(&quot;defaultSigningPolicy&quot;) === 0 &amp;&amp;</span>
<a href="#l26.1580"></a><span id="l26.1580" class="difflineminus">-          this.identity.getBoolAttribute(&quot;sign_mail&quot;)) {</span>
<a href="#l26.1581"></a><span id="l26.1581" class="difflineminus">-          signFinally = EnigmailConstants.ENIG_FINAL_YES;</span>
<a href="#l26.1582"></a><span id="l26.1582" class="difflineminus">-          this.statusPGPMime = EnigmailConstants.ENIG_FINAL_SMIME;</span>
<a href="#l26.1583"></a><span id="l26.1583" class="difflineminus">-        }</span>
<a href="#l26.1584"></a><span id="l26.1584" class="difflineminus">-      }</span>
<a href="#l26.1585"></a><span id="l26.1585" class="difflineplus">+        //gSMFields.requireEncryptMessage = true;</span>
<a href="#l26.1586"></a><span id="l26.1586" class="difflineplus">+        //gSMFields.signMessage = true;</span>
<a href="#l26.1587"></a><span id="l26.1587" class="difflineplus">+</span>
<a href="#l26.1588"></a><span id="l26.1588" class="difflineplus">+      // smime policy</span>
<a href="#l26.1589"></a><span id="l26.1589" class="difflineplus">+      //if (this.identity.getIntAttribute(&quot;encryptionpolicy&quot;) &gt; 0)</span>
<a href="#l26.1590"></a><span id="l26.1590"> </span>
<a href="#l26.1591"></a><span id="l26.1591">       // update the S/MIME GUI elements</span>
<a href="#l26.1592"></a><span id="l26.1592">       try {</span>
<a href="#l26.1593"></a><span id="l26.1593">         setSecuritySettings(&quot;1&quot;);</span>
<a href="#l26.1594"></a><span id="l26.1594">       }</span>
<a href="#l26.1595"></a><span id="l26.1595">       catch (ex) {}</span>
<a href="#l26.1596"></a><span id="l26.1596"> </span>
<a href="#l26.1597"></a><span id="l26.1597">       try {</span>
<a href="#l26.1598"></a><span id="l26.1598">         setSecuritySettings(&quot;2&quot;);</span>
<a href="#l26.1599"></a><span id="l26.1599">       }</span>
<a href="#l26.1600"></a><span id="l26.1600">       catch (ex) {}</span>
<a href="#l26.1601"></a><span id="l26.1601">     }</span>
<a href="#l26.1602"></a><span id="l26.1602" class="difflineminus">-</span>
<a href="#l26.1603"></a><span id="l26.1603" class="difflineminus">-    // ------ 3. process final resulting protocol mode (inline-PGP / PGP/MIME / S/MIME) ------</span>
<a href="#l26.1604"></a><span id="l26.1604" class="difflineminus">-</span>
<a href="#l26.1605"></a><span id="l26.1605" class="difflineminus">-    if (this.statusPGPMime !== EnigmailConstants.ENIG_FINAL_SMIME &amp;&amp;</span>
<a href="#l26.1606"></a><span id="l26.1606" class="difflineminus">-      this.statusPGPMime !== EnigmailConstants.ENIG_FINAL_FORCESMIME) {</span>
<a href="#l26.1607"></a><span id="l26.1607" class="difflineminus">-      // process resulting PGP/MIME mode</span>
<a href="#l26.1608"></a><span id="l26.1608" class="difflineminus">-      if (this.pgpmimeForced === EnigmailConstants.ENIG_NEVER) { // force not to PGP/Mime?</span>
<a href="#l26.1609"></a><span id="l26.1609" class="difflineminus">-        pgpmimeFinally = EnigmailConstants.ENIG_FINAL_FORCENO;</span>
<a href="#l26.1610"></a><span id="l26.1610" class="difflineminus">-      }</span>
<a href="#l26.1611"></a><span id="l26.1611" class="difflineminus">-      else if (this.pgpmimeForced === EnigmailConstants.ENIG_ALWAYS) { // force to PGP/Mime?</span>
<a href="#l26.1612"></a><span id="l26.1612" class="difflineminus">-        pgpmimeFinally = EnigmailConstants.ENIG_FINAL_FORCEYES;</span>
<a href="#l26.1613"></a><span id="l26.1613" class="difflineminus">-      }</span>
<a href="#l26.1614"></a><span id="l26.1614" class="difflineminus">-      else switch (this.pgpmimeByRules) {</span>
<a href="#l26.1615"></a><span id="l26.1615" class="difflineminus">-        case EnigmailConstants.ENIG_NEVER:</span>
<a href="#l26.1616"></a><span id="l26.1616" class="difflineminus">-          pgpmimeFinally = EnigmailConstants.ENIG_FINAL_NO;</span>
<a href="#l26.1617"></a><span id="l26.1617" class="difflineminus">-          break;</span>
<a href="#l26.1618"></a><span id="l26.1618" class="difflineminus">-        case EnigmailConstants.ENIG_UNDEF:</span>
<a href="#l26.1619"></a><span id="l26.1619" class="difflineminus">-          pgpmimeFinally = ((this.sendPgpMime || (this.sendMode &amp; EnigmailConstants.SEND_PGP_MIME)) ? EnigmailConstants.ENIG_FINAL_YES : EnigmailConstants.ENIG_FINAL_NO);</span>
<a href="#l26.1620"></a><span id="l26.1620" class="difflineminus">-          break;</span>
<a href="#l26.1621"></a><span id="l26.1621" class="difflineminus">-        case EnigmailConstants.ENIG_ALWAYS:</span>
<a href="#l26.1622"></a><span id="l26.1622" class="difflineminus">-          pgpmimeFinally = EnigmailConstants.ENIG_FINAL_YES;</span>
<a href="#l26.1623"></a><span id="l26.1623" class="difflineminus">-          break;</span>
<a href="#l26.1624"></a><span id="l26.1624" class="difflineminus">-        case EnigmailConstants.ENIG_CONFLICT:</span>
<a href="#l26.1625"></a><span id="l26.1625" class="difflineminus">-          pgpmimeFinally = EnigmailConstants.ENIG_FINAL_CONFLICT;</span>
<a href="#l26.1626"></a><span id="l26.1626" class="difflineminus">-          break;</span>
<a href="#l26.1627"></a><span id="l26.1627" class="difflineminus">-      }</span>
<a href="#l26.1628"></a><span id="l26.1628" class="difflineminus">-      this.statusPGPMime = pgpmimeFinally;</span>
<a href="#l26.1629"></a><span id="l26.1629" class="difflineminus">-    }</span>
<a href="#l26.1630"></a><span id="l26.1630" class="difflineminus">-</span>
<a href="#l26.1631"></a><span id="l26.1631" class="difflineminus">-    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js:   pgpmimeByRules=&quot; + this.pgpmimeByRules + &quot; pgpmimeFinally=&quot; + pgpmimeFinally + &quot;\n&quot;);</span>
<a href="#l26.1632"></a><span id="l26.1632" class="difflineminus">-</span>
<a href="#l26.1633"></a><span id="l26.1633" class="difflineminus">-    this.statusEncrypted = encFinally;</span>
<a href="#l26.1634"></a><span id="l26.1634" class="difflineminus">-    this.statusSigned = signFinally;</span>
<a href="#l26.1635"></a><span id="l26.1635" class="difflineminus">-    this.reasonEncrypted = encReason;</span>
<a href="#l26.1636"></a><span id="l26.1636" class="difflineminus">-    this.reasonSigned = signReason;</span>
<a href="#l26.1637"></a><span id="l26.1637" class="difflineminus">-</span>
<a href="#l26.1638"></a><span id="l26.1638" class="difflineminus">-    switch (this.statusEncrypted) {</span>
<a href="#l26.1639"></a><span id="l26.1639" class="difflineminus">-      case EnigmailConstants.ENIG_FINAL_CONFLICT:</span>
<a href="#l26.1640"></a><span id="l26.1640" class="difflineminus">-      case EnigmailConstants.ENIG_FINAL_FORCENO:</span>
<a href="#l26.1641"></a><span id="l26.1641" class="difflineminus">-      case EnigmailConstants.ENIG_FINAL_YES:</span>
<a href="#l26.1642"></a><span id="l26.1642" class="difflineminus">-        return;</span>
<a href="#l26.1643"></a><span id="l26.1643" class="difflineminus">-    }</span>
<a href="#l26.1644"></a><span id="l26.1644" class="difflineminus">-</span>
<a href="#l26.1645"></a><span id="l26.1645" class="difflineminus">-    switch (this.statusPGPMime) {</span>
<a href="#l26.1646"></a><span id="l26.1646" class="difflineminus">-      case EnigmailConstants.ENIG_FINAL_SMIME:</span>
<a href="#l26.1647"></a><span id="l26.1647" class="difflineminus">-      case EnigmailConstants.ENIG_FINAL_FORCESMIME:</span>
<a href="#l26.1648"></a><span id="l26.1648" class="difflineminus">-        return;</span>
<a href="#l26.1649"></a><span id="l26.1649" class="difflineminus">-    }</span>
<a href="#l26.1650"></a><span id="l26.1650" class="difflineplus">+    */</span>
<a href="#l26.1651"></a><span id="l26.1651">   },</span>
<a href="#l26.1652"></a><span id="l26.1652"> </span>
<a href="#l26.1653"></a><span id="l26.1653" class="difflineminus">-  /**</span>
<a href="#l26.1654"></a><span id="l26.1654" class="difflineminus">-   * Try to enable S/MIME, repsecting the various Enigmail rules</span>
<a href="#l26.1655"></a><span id="l26.1655" class="difflineminus">-   *</span>
<a href="#l26.1656"></a><span id="l26.1656" class="difflineminus">-   * @param encFinally:  Number - &quot;final&quot; encryption status before applying S/MIME</span>
<a href="#l26.1657"></a><span id="l26.1657" class="difflineminus">-   * @param signFinally: Number - &quot;final&quot; signing status before applying S/MIME</span>
<a href="#l26.1658"></a><span id="l26.1658" class="difflineminus">-   *</span>
<a href="#l26.1659"></a><span id="l26.1659" class="difflineminus">-   * @return Object:</span>
<a href="#l26.1660"></a><span id="l26.1660" class="difflineminus">-   *   - encFinally:  Number - new encryption status after trying S/MIME</span>
<a href="#l26.1661"></a><span id="l26.1661" class="difflineminus">-   *   - signFinally: Number - new signing status after trying S/MIME</span>
<a href="#l26.1662"></a><span id="l26.1662" class="difflineminus">-   */</span>
<a href="#l26.1663"></a><span id="l26.1663" class="difflineminus">-</span>
<a href="#l26.1664"></a><span id="l26.1664" class="difflineminus">-  tryEnablingSMime: function(encFinally, signFinally) {</span>
<a href="#l26.1665"></a><span id="l26.1665" class="difflineminus">-    let encryptSmime = false;</span>
<a href="#l26.1666"></a><span id="l26.1666" class="difflineminus">-    let autoSendEncrypted = EnigmailPrefs.getPref(&quot;autoSendEncrypted&quot;);</span>
<a href="#l26.1667"></a><span id="l26.1667" class="difflineminus">-</span>
<a href="#l26.1668"></a><span id="l26.1668" class="difflineminus">-    gSMFields.requireEncryptMessage = false;</span>
<a href="#l26.1669"></a><span id="l26.1669" class="difflineminus">-    gSMFields.signMessage = false;</span>
<a href="#l26.1670"></a><span id="l26.1670" class="difflineminus">-</span>
<a href="#l26.1671"></a><span id="l26.1671" class="difflineminus">-    // do not try S/MIME encryption if one of the following applies:</span>
<a href="#l26.1672"></a><span id="l26.1672" class="difflineminus">-    // - OpenPGP is preferred over S/MIME, and OpenPGP is possible</span>
<a href="#l26.1673"></a><span id="l26.1673" class="difflineminus">-    // - OpenPGP is preferred over S/MIME, and OpenPGP is enabled by rules</span>
<a href="#l26.1674"></a><span id="l26.1674" class="difflineminus">-    // - encryption is disabled by rules and encryption is not manually enabled</span>
<a href="#l26.1675"></a><span id="l26.1675" class="difflineminus">-    // - encryption is manually disabled</span>
<a href="#l26.1676"></a><span id="l26.1676" class="difflineminus">-    if (this.pgpmimeForced === EnigmailConstants.ENIG_FORCE_SMIME) {</span>
<a href="#l26.1677"></a><span id="l26.1677" class="difflineminus">-      encryptSmime = true;</span>
<a href="#l26.1678"></a><span id="l26.1678" class="difflineminus">-    }</span>
<a href="#l26.1679"></a><span id="l26.1679" class="difflineminus">-    else if ((this.mimePreferOpenPGP === 1 &amp;&amp; (this.autoPgpEncryption ||</span>
<a href="#l26.1680"></a><span id="l26.1680" class="difflineminus">-        this.encryptByRules === EnigmailConstants.ENIG_ALWAYS)) ||</span>
<a href="#l26.1681"></a><span id="l26.1681" class="difflineminus">-      (this.encryptByRules === EnigmailConstants.ENIG_NEVER &amp;&amp; encFinally !== EnigmailConstants.ENIG_FINAL_FORCEYES) ||</span>
<a href="#l26.1682"></a><span id="l26.1682" class="difflineminus">-      (this.pgpmimeForced === EnigmailConstants.ENIG_NEVER || this.pgpmimeForced === EnigmailConstants.ENIG_ALWAYS) ||</span>
<a href="#l26.1683"></a><span id="l26.1683" class="difflineminus">-      encFinally === EnigmailConstants.ENIG_FINAL_FORCENO) {</span>
<a href="#l26.1684"></a><span id="l26.1684" class="difflineminus">-      return {</span>
<a href="#l26.1685"></a><span id="l26.1685" class="difflineminus">-        encFinally: encFinally,</span>
<a href="#l26.1686"></a><span id="l26.1686" class="difflineminus">-        signFinally: signFinally</span>
<a href="#l26.1687"></a><span id="l26.1687" class="difflineminus">-      };</span>
<a href="#l26.1688"></a><span id="l26.1688" class="difflineminus">-    }</span>
<a href="#l26.1689"></a><span id="l26.1689" class="difflineminus">-</span>
<a href="#l26.1690"></a><span id="l26.1690" class="difflineminus">-    if (!encryptSmime) {</span>
<a href="#l26.1691"></a><span id="l26.1691" class="difflineminus">-      if (autoSendEncrypted === 1) {</span>
<a href="#l26.1692"></a><span id="l26.1692" class="difflineminus">-        if (this.isSmimeEncryptionPossible()) {</span>
<a href="#l26.1693"></a><span id="l26.1693" class="difflineminus">-          if (this.mimePreferOpenPGP === 0) {</span>
<a href="#l26.1694"></a><span id="l26.1694" class="difflineminus">-            // S/MIME is preferred and encryption is possible</span>
<a href="#l26.1695"></a><span id="l26.1695" class="difflineminus">-            encryptSmime = true;</span>
<a href="#l26.1696"></a><span id="l26.1696" class="difflineminus">-            encFinally = EnigmailConstants.ENIG_FINAL_YES;</span>
<a href="#l26.1697"></a><span id="l26.1697" class="difflineminus">-          }</span>
<a href="#l26.1698"></a><span id="l26.1698" class="difflineminus">-          else if (encFinally === EnigmailConstants.ENIG_FINAL_NO ||</span>
<a href="#l26.1699"></a><span id="l26.1699" class="difflineminus">-            encFinally === EnigmailConstants.ENIG_FINAL_CONFLICT ||</span>
<a href="#l26.1700"></a><span id="l26.1700" class="difflineminus">-            !this.autoPgpEncryption) {</span>
<a href="#l26.1701"></a><span id="l26.1701" class="difflineminus">-            // Enigmail is preferred but not possible; S/MIME enc. is possible</span>
<a href="#l26.1702"></a><span id="l26.1702" class="difflineminus">-            encryptSmime = true;</span>
<a href="#l26.1703"></a><span id="l26.1703" class="difflineminus">-            encFinally = EnigmailConstants.ENIG_FINAL_YES;</span>
<a href="#l26.1704"></a><span id="l26.1704" class="difflineminus">-          }</span>
<a href="#l26.1705"></a><span id="l26.1705" class="difflineminus">-        }</span>
<a href="#l26.1706"></a><span id="l26.1706" class="difflineminus">-      }</span>
<a href="#l26.1707"></a><span id="l26.1707" class="difflineminus">-      else if (encFinally === EnigmailConstants.ENIG_FINAL_FORCEYES) {</span>
<a href="#l26.1708"></a><span id="l26.1708" class="difflineminus">-        if (this.isSmimeEncryptionPossible()) {</span>
<a href="#l26.1709"></a><span id="l26.1709" class="difflineminus">-          if (this.mimePreferOpenPGP === 0 || (!this.autoPgpEncryption)) {</span>
<a href="#l26.1710"></a><span id="l26.1710" class="difflineminus">-            // S/MIME is preferred and encryption is possible</span>
<a href="#l26.1711"></a><span id="l26.1711" class="difflineminus">-            // or PGP/MIME is preferred but impossible</span>
<a href="#l26.1712"></a><span id="l26.1712" class="difflineminus">-            encryptSmime = true;</span>
<a href="#l26.1713"></a><span id="l26.1713" class="difflineminus">-          }</span>
<a href="#l26.1714"></a><span id="l26.1714" class="difflineminus">-        }</span>
<a href="#l26.1715"></a><span id="l26.1715" class="difflineminus">-      }</span>
<a href="#l26.1716"></a><span id="l26.1716" class="difflineminus">-    }</span>
<a href="#l26.1717"></a><span id="l26.1717" class="difflineminus">-</span>
<a href="#l26.1718"></a><span id="l26.1718" class="difflineminus">-    if (encryptSmime) {</span>
<a href="#l26.1719"></a><span id="l26.1719" class="difflineminus">-      if (this.pgpmimeForced === EnigmailConstants.ENIG_FORCE_SMIME) {</span>
<a href="#l26.1720"></a><span id="l26.1720" class="difflineminus">-        this.statusPGPMime = EnigmailConstants.ENIG_FINAL_FORCESMIME;</span>
<a href="#l26.1721"></a><span id="l26.1721" class="difflineminus">-      }</span>
<a href="#l26.1722"></a><span id="l26.1722" class="difflineminus">-      else</span>
<a href="#l26.1723"></a><span id="l26.1723" class="difflineminus">-        this.statusPGPMime = EnigmailConstants.ENIG_FINAL_SMIME;</span>
<a href="#l26.1724"></a><span id="l26.1724" class="difflineminus">-</span>
<a href="#l26.1725"></a><span id="l26.1725" class="difflineminus">-      if (encFinally === EnigmailConstants.ENIG_FINAL_YES ||</span>
<a href="#l26.1726"></a><span id="l26.1726" class="difflineminus">-        encFinally === EnigmailConstants.ENIG_FINAL_FORCEYES) {</span>
<a href="#l26.1727"></a><span id="l26.1727" class="difflineminus">-        gSMFields.requireEncryptMessage = true;</span>
<a href="#l26.1728"></a><span id="l26.1728" class="difflineminus">-      }</span>
<a href="#l26.1729"></a><span id="l26.1729" class="difflineminus">-      if (signFinally === EnigmailConstants.ENIG_FINAL_YES ||</span>
<a href="#l26.1730"></a><span id="l26.1730" class="difflineminus">-        signFinally === EnigmailConstants.ENIG_FINAL_FORCEYES) {</span>
<a href="#l26.1731"></a><span id="l26.1731" class="difflineminus">-        gSMFields.signMessage = true;</span>
<a href="#l26.1732"></a><span id="l26.1732" class="difflineminus">-      }</span>
<a href="#l26.1733"></a><span id="l26.1733" class="difflineminus">-    }</span>
<a href="#l26.1734"></a><span id="l26.1734" class="difflineminus">-    else {</span>
<a href="#l26.1735"></a><span id="l26.1735" class="difflineminus">-      gSMFields.requireEncryptMessage = false;</span>
<a href="#l26.1736"></a><span id="l26.1736" class="difflineminus">-</span>
<a href="#l26.1737"></a><span id="l26.1737" class="difflineminus">-      if ((encFinally === EnigmailConstants.ENIG_FINAL_NO || encFinally === EnigmailConstants.ENIG_FINAL_FORCENO) &amp;&amp;</span>
<a href="#l26.1738"></a><span id="l26.1738" class="difflineminus">-        this.mimePreferOpenPGP === 0 &amp;&amp;</span>
<a href="#l26.1739"></a><span id="l26.1739" class="difflineminus">-        !(this.autoPgpEncryption &amp;&amp; autoSendEncrypted === 1) &amp;&amp;</span>
<a href="#l26.1740"></a><span id="l26.1740" class="difflineminus">-        (signFinally === EnigmailConstants.ENIG_FINAL_YES || signFinally === EnigmailConstants.ENIG_FINAL_FORCEYES)) {</span>
<a href="#l26.1741"></a><span id="l26.1741" class="difflineminus">-        // S/MIME is preferred</span>
<a href="#l26.1742"></a><span id="l26.1742" class="difflineminus">-        this.statusPGPMime = EnigmailConstants.ENIG_FINAL_SMIME;</span>
<a href="#l26.1743"></a><span id="l26.1743" class="difflineminus">-        gSMFields.signMessage = true;</span>
<a href="#l26.1744"></a><span id="l26.1744" class="difflineminus">-      }</span>
<a href="#l26.1745"></a><span id="l26.1745" class="difflineminus">-      else {</span>
<a href="#l26.1746"></a><span id="l26.1746" class="difflineminus">-        gSMFields.signMessage = false;</span>
<a href="#l26.1747"></a><span id="l26.1747" class="difflineminus">-      }</span>
<a href="#l26.1748"></a><span id="l26.1748" class="difflineminus">-    }</span>
<a href="#l26.1749"></a><span id="l26.1749" class="difflineminus">-</span>
<a href="#l26.1750"></a><span id="l26.1750" class="difflineminus">-    return {</span>
<a href="#l26.1751"></a><span id="l26.1751" class="difflineminus">-      encFinally: encFinally,</span>
<a href="#l26.1752"></a><span id="l26.1752" class="difflineminus">-      signFinally: signFinally</span>
<a href="#l26.1753"></a><span id="l26.1753" class="difflineminus">-    };</span>
<a href="#l26.1754"></a><span id="l26.1754" class="difflineminus">-</span>
<a href="#l26.1755"></a><span id="l26.1755" class="difflineminus">-  },</span>
<a href="#l26.1756"></a><span id="l26.1756"> </span>
<a href="#l26.1757"></a><span id="l26.1757">   // process icon/strings of status bar buttons and menu entries according to final encrypt/sign/pgpmime status</span>
<a href="#l26.1758"></a><span id="l26.1758">   // - uses as INPUT:</span>
<a href="#l26.1759"></a><span id="l26.1759" class="difflineminus">-  //   - this.statusEncrypt, this.statusSign, this.statusPGPMime</span>
<a href="#l26.1760"></a><span id="l26.1760" class="difflineplus">+  //   - this.statusEncrypt, this.statusSign</span>
<a href="#l26.1761"></a><span id="l26.1761">   // - uses as OUTPUT:</span>
<a href="#l26.1762"></a><span id="l26.1762">   //   - resulting icon symbols</span>
<a href="#l26.1763"></a><span id="l26.1763">   //   - this.statusEncryptStr, this.statusSignStr, this.statusPGPMimeStr, this.statusInlinePGPStr, this.statusAttachOwnKey</span>
<a href="#l26.1764"></a><span id="l26.1764">   //   - this.statusSMimeStr</span>
<a href="#l26.1765"></a><span id="l26.1765">   updateStatusBar: function() {</span>
<a href="#l26.1766"></a><span id="l26.1766">     return;</span>
<a href="#l26.1767"></a><span id="l26.1767" class="difflineplus">+    /*</span>
<a href="#l26.1768"></a><span id="l26.1768">     EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.updateStatusBar()\n&quot;);</span>
<a href="#l26.1769"></a><span id="l26.1769" class="difflineminus">-    this.statusEncryptedInStatusBar = this.statusEncrypted; // to double check broken promise for encryption</span>
<a href="#l26.1770"></a><span id="l26.1770"> </span>
<a href="#l26.1771"></a><span id="l26.1771">     if (!this.identity) {</span>
<a href="#l26.1772"></a><span id="l26.1772">       this.identity = getCurrentIdentity();</span>
<a href="#l26.1773"></a><span id="l26.1773">     }</span>
<a href="#l26.1774"></a><span id="l26.1774"> </span>
<a href="#l26.1775"></a><span id="l26.1775">     var toolbarTxt = document.getElementById(&quot;enigmail-toolbar-text&quot;);</span>
<a href="#l26.1776"></a><span id="l26.1776">     var encBroadcaster = document.getElementById(&quot;enigmail-bc-encrypt&quot;);</span>
<a href="#l26.1777"></a><span id="l26.1777">     var signBroadcaster = document.getElementById(&quot;enigmail-bc-sign&quot;);</span>
<a href="#l26.1778"></a><span id="l26.1778">     var attachBroadcaster = document.getElementById(&quot;enigmail-bc-attach&quot;);</span>
<a href="#l26.1779"></a><span id="l26.1779"> </span>
<a href="#l26.1780"></a><span id="l26.1780" class="difflineminus">-    let enc = this.getEncryptionEnabled();</span>
<a href="#l26.1781"></a><span id="l26.1781" class="difflineplus">+    let enc = this.isAnyEncryptionEnabled();</span>
<a href="#l26.1782"></a><span id="l26.1782">     let sign = this.getSigningEnabled();</span>
<a href="#l26.1783"></a><span id="l26.1783">     // enigmail disabled for this identity?:</span>
<a href="#l26.1784"></a><span id="l26.1784">     if (!enc) {</span>
<a href="#l26.1785"></a><span id="l26.1785">       // hide icons if enigmail not enabled</span>
<a href="#l26.1786"></a><span id="l26.1786">       encBroadcaster.removeAttribute(&quot;encrypted&quot;);</span>
<a href="#l26.1787"></a><span id="l26.1787">       encBroadcaster.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l26.1788"></a><span id="l26.1788">     }</span>
<a href="#l26.1789"></a><span id="l26.1789">     else {</span>
<a href="#l26.1790"></a><span id="l26.1790" class="difflineat">@@ -1918,120 +1390,30 @@ Enigmail.msg = {</span>
<a href="#l26.1791"></a><span id="l26.1791">         toolbarTxt.removeAttribute(&quot;class&quot;);</span>
<a href="#l26.1792"></a><span id="l26.1792">       }</span>
<a href="#l26.1793"></a><span id="l26.1793">       return;</span>
<a href="#l26.1794"></a><span id="l26.1794">     }</span>
<a href="#l26.1795"></a><span id="l26.1795"> </span>
<a href="#l26.1796"></a><span id="l26.1796">     // process resulting icon symbol and status strings for encrypt mode</span>
<a href="#l26.1797"></a><span id="l26.1797">     var encSymbol = null;</span>
<a href="#l26.1798"></a><span id="l26.1798">     var doEncrypt = false;</span>
<a href="#l26.1799"></a><span id="l26.1799" class="difflineminus">-    var encStr = null;</span>
<a href="#l26.1800"></a><span id="l26.1800" class="difflineminus">-    switch (this.statusEncrypted) {</span>
<a href="#l26.1801"></a><span id="l26.1801" class="difflineminus">-      case EnigmailConstants.ENIG_FINAL_FORCENO:</span>
<a href="#l26.1802"></a><span id="l26.1802" class="difflineminus">-        encSymbol = &quot;forceNo&quot;;</span>
<a href="#l26.1803"></a><span id="l26.1803" class="difflineminus">-        encStr = EnigmailLocale.getString(&quot;encryptMessageNorm&quot;);</span>
<a href="#l26.1804"></a><span id="l26.1804" class="difflineminus">-        break;</span>
<a href="#l26.1805"></a><span id="l26.1805" class="difflineminus">-      case EnigmailConstants.ENIG_FINAL_FORCEYES:</span>
<a href="#l26.1806"></a><span id="l26.1806" class="difflineminus">-        doEncrypt = true;</span>
<a href="#l26.1807"></a><span id="l26.1807" class="difflineminus">-        encSymbol = &quot;forceYes&quot;;</span>
<a href="#l26.1808"></a><span id="l26.1808" class="difflineminus">-        encStr = EnigmailLocale.getString(&quot;encryptMessageNorm&quot;);</span>
<a href="#l26.1809"></a><span id="l26.1809" class="difflineminus">-        break;</span>
<a href="#l26.1810"></a><span id="l26.1810" class="difflineminus">-      case EnigmailConstants.ENIG_FINAL_NO:</span>
<a href="#l26.1811"></a><span id="l26.1811" class="difflineminus">-        encSymbol = &quot;inactiveNone&quot;;</span>
<a href="#l26.1812"></a><span id="l26.1812" class="difflineminus">-        encStr = EnigmailLocale.getString(&quot;encryptMessageAuto&quot;);</span>
<a href="#l26.1813"></a><span id="l26.1813" class="difflineminus">-        break;</span>
<a href="#l26.1814"></a><span id="l26.1814" class="difflineminus">-      case EnigmailConstants.ENIG_FINAL_YES:</span>
<a href="#l26.1815"></a><span id="l26.1815" class="difflineminus">-        doEncrypt = true;</span>
<a href="#l26.1816"></a><span id="l26.1816" class="difflineminus">-        encSymbol = &quot;forceYes&quot;;</span>
<a href="#l26.1817"></a><span id="l26.1817" class="difflineminus">-        encStr = EnigmailLocale.getString(&quot;encryptMessageAuto&quot;);</span>
<a href="#l26.1818"></a><span id="l26.1818" class="difflineminus">-        break;</span>
<a href="#l26.1819"></a><span id="l26.1819" class="difflineminus">-      case EnigmailConstants.ENIG_FINAL_CONFLICT:</span>
<a href="#l26.1820"></a><span id="l26.1820" class="difflineminus">-        encSymbol = &quot;inactiveConflict&quot;;</span>
<a href="#l26.1821"></a><span id="l26.1821" class="difflineminus">-        encStr = EnigmailLocale.getString(&quot;encryptMessageAuto&quot;);</span>
<a href="#l26.1822"></a><span id="l26.1822" class="difflineminus">-        break;</span>
<a href="#l26.1823"></a><span id="l26.1823" class="difflineminus">-    }</span>
<a href="#l26.1824"></a><span id="l26.1824">     var encReasonStr = null;</span>
<a href="#l26.1825"></a><span id="l26.1825" class="difflineminus">-    if (doEncrypt) {</span>
<a href="#l26.1826"></a><span id="l26.1826" class="difflineminus">-      if (this.reasonEncrypted &amp;&amp; this.reasonEncrypted !== &quot;&quot;) {</span>
<a href="#l26.1827"></a><span id="l26.1827" class="difflineminus">-        encReasonStr = EnigmailLocale.getString(&quot;encryptOnWithReason&quot;, [this.reasonEncrypted]);</span>
<a href="#l26.1828"></a><span id="l26.1828" class="difflineminus">-      }</span>
<a href="#l26.1829"></a><span id="l26.1829" class="difflineminus">-      else {</span>
<a href="#l26.1830"></a><span id="l26.1830" class="difflineminus">-        encReasonStr = EnigmailLocale.getString(&quot;encryptOn&quot;);</span>
<a href="#l26.1831"></a><span id="l26.1831" class="difflineminus">-      }</span>
<a href="#l26.1832"></a><span id="l26.1832" class="difflineminus">-    }</span>
<a href="#l26.1833"></a><span id="l26.1833" class="difflineminus">-    else {</span>
<a href="#l26.1834"></a><span id="l26.1834" class="difflineminus">-      if (this.reasonEncrypted &amp;&amp; this.reasonEncrypted !== &quot;&quot;) {</span>
<a href="#l26.1835"></a><span id="l26.1835" class="difflineminus">-        encReasonStr = EnigmailLocale.getString(&quot;encryptOffWithReason&quot;, [this.reasonEncrypted]);</span>
<a href="#l26.1836"></a><span id="l26.1836" class="difflineminus">-      }</span>
<a href="#l26.1837"></a><span id="l26.1837" class="difflineminus">-      else {</span>
<a href="#l26.1838"></a><span id="l26.1838" class="difflineminus">-        encReasonStr = EnigmailLocale.getString(&quot;encryptOff&quot;);</span>
<a href="#l26.1839"></a><span id="l26.1839" class="difflineminus">-      }</span>
<a href="#l26.1840"></a><span id="l26.1840" class="difflineminus">-    }</span>
<a href="#l26.1841"></a><span id="l26.1841" class="difflineminus">-    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js:   encSymbol=&quot; + encSymbol + &quot;  encReasonStr=&quot; + encReasonStr + &quot;\n&quot;);</span>
<a href="#l26.1842"></a><span id="l26.1842"> </span>
<a href="#l26.1843"></a><span id="l26.1843">     // update encrypt icon and tooltip/menu-text</span>
<a href="#l26.1844"></a><span id="l26.1844">     encBroadcaster.setAttribute(&quot;encrypted&quot;, encSymbol);</span>
<a href="#l26.1845"></a><span id="l26.1845">     var encIcon = document.getElementById(&quot;button-enigmail-encrypt&quot;);</span>
<a href="#l26.1846"></a><span id="l26.1846">     if (encIcon) {</span>
<a href="#l26.1847"></a><span id="l26.1847">       encIcon.setAttribute(&quot;tooltiptext&quot;, encReasonStr);</span>
<a href="#l26.1848"></a><span id="l26.1848">     }</span>
<a href="#l26.1849"></a><span id="l26.1849">     this.statusEncryptedStr = encStr;</span>
<a href="#l26.1850"></a><span id="l26.1850">     this.setChecked(&quot;enigmail-bc-encrypt&quot;, doEncrypt);</span>
<a href="#l26.1851"></a><span id="l26.1851"> </span>
<a href="#l26.1852"></a><span id="l26.1852">     // process resulting icon symbol for sign mode</span>
<a href="#l26.1853"></a><span id="l26.1853">     var signSymbol = null;</span>
<a href="#l26.1854"></a><span id="l26.1854">     var doSign = false;</span>
<a href="#l26.1855"></a><span id="l26.1855" class="difflineminus">-    var signStr = &quot;&quot;;</span>
<a href="#l26.1856"></a><span id="l26.1856" class="difflineminus">-    switch (this.statusSigned) {</span>
<a href="#l26.1857"></a><span id="l26.1857" class="difflineminus">-      case EnigmailConstants.ENIG_FINAL_FORCENO:</span>
<a href="#l26.1858"></a><span id="l26.1858" class="difflineminus">-        signSymbol = &quot;forceNo&quot;;</span>
<a href="#l26.1859"></a><span id="l26.1859" class="difflineminus">-        signStr = EnigmailLocale.getString(&quot;signMessageNorm&quot;);</span>
<a href="#l26.1860"></a><span id="l26.1860" class="difflineminus">-        signReasonStr = EnigmailLocale.getString(&quot;signOffWithReason&quot;, [this.reasonSigned]);</span>
<a href="#l26.1861"></a><span id="l26.1861" class="difflineminus">-        break;</span>
<a href="#l26.1862"></a><span id="l26.1862" class="difflineminus">-      case EnigmailConstants.ENIG_FINAL_FORCEYES:</span>
<a href="#l26.1863"></a><span id="l26.1863" class="difflineminus">-        doSign = true;</span>
<a href="#l26.1864"></a><span id="l26.1864" class="difflineminus">-        signSymbol = &quot;forceYes&quot;;</span>
<a href="#l26.1865"></a><span id="l26.1865" class="difflineminus">-        signStr = EnigmailLocale.getString(&quot;signMessageNorm&quot;);</span>
<a href="#l26.1866"></a><span id="l26.1866" class="difflineminus">-        signReasonStr = EnigmailLocale.getString(&quot;signOnWithReason&quot;, [this.reasonSigned]);</span>
<a href="#l26.1867"></a><span id="l26.1867" class="difflineminus">-        break;</span>
<a href="#l26.1868"></a><span id="l26.1868" class="difflineminus">-      case EnigmailConstants.ENIG_FINAL_NO:</span>
<a href="#l26.1869"></a><span id="l26.1869" class="difflineminus">-        signSymbol = &quot;inactiveNone&quot;;</span>
<a href="#l26.1870"></a><span id="l26.1870" class="difflineminus">-        signStr = EnigmailLocale.getString(&quot;signMessageAuto&quot;);</span>
<a href="#l26.1871"></a><span id="l26.1871" class="difflineminus">-        signReasonStr = EnigmailLocale.getString(&quot;signOffWithReason&quot;, [this.reasonSigned]);</span>
<a href="#l26.1872"></a><span id="l26.1872" class="difflineminus">-        break;</span>
<a href="#l26.1873"></a><span id="l26.1873" class="difflineminus">-      case EnigmailConstants.ENIG_FINAL_YES:</span>
<a href="#l26.1874"></a><span id="l26.1874" class="difflineminus">-        doSign = true;</span>
<a href="#l26.1875"></a><span id="l26.1875" class="difflineminus">-        signSymbol = &quot;forceYes&quot;;</span>
<a href="#l26.1876"></a><span id="l26.1876" class="difflineminus">-        signStr = EnigmailLocale.getString(&quot;signMessageAuto&quot;);</span>
<a href="#l26.1877"></a><span id="l26.1877" class="difflineminus">-        signReasonStr = EnigmailLocale.getString(&quot;signOnWithReason&quot;, [this.reasonSigned]);</span>
<a href="#l26.1878"></a><span id="l26.1878" class="difflineminus">-        break;</span>
<a href="#l26.1879"></a><span id="l26.1879" class="difflineminus">-      case EnigmailConstants.ENIG_FINAL_CONFLICT:</span>
<a href="#l26.1880"></a><span id="l26.1880" class="difflineminus">-        signSymbol = &quot;inactiveConflict&quot;;</span>
<a href="#l26.1881"></a><span id="l26.1881" class="difflineminus">-        signStr = EnigmailLocale.getString(&quot;signMessageAuto&quot;);</span>
<a href="#l26.1882"></a><span id="l26.1882" class="difflineminus">-        signReasonStr = EnigmailLocale.getString(&quot;signOffWithReason&quot;, [this.reasonSigned]);</span>
<a href="#l26.1883"></a><span id="l26.1883" class="difflineminus">-        break;</span>
<a href="#l26.1884"></a><span id="l26.1884" class="difflineminus">-    }</span>
<a href="#l26.1885"></a><span id="l26.1885" class="difflineminus">-    var signReasonStr = null;</span>
<a href="#l26.1886"></a><span id="l26.1886" class="difflineminus">-    if (doSign) {</span>
<a href="#l26.1887"></a><span id="l26.1887" class="difflineminus">-      if (this.reasonSigned &amp;&amp; this.reasonSigned !== &quot;&quot;) {</span>
<a href="#l26.1888"></a><span id="l26.1888" class="difflineminus">-        signReasonStr = EnigmailLocale.getString(&quot;signOnWithReason&quot;, [this.reasonSigned]);</span>
<a href="#l26.1889"></a><span id="l26.1889" class="difflineminus">-      }</span>
<a href="#l26.1890"></a><span id="l26.1890" class="difflineminus">-      else {</span>
<a href="#l26.1891"></a><span id="l26.1891" class="difflineminus">-        signReasonStr = signStr;</span>
<a href="#l26.1892"></a><span id="l26.1892" class="difflineminus">-      }</span>
<a href="#l26.1893"></a><span id="l26.1893" class="difflineminus">-    }</span>
<a href="#l26.1894"></a><span id="l26.1894" class="difflineminus">-    else {</span>
<a href="#l26.1895"></a><span id="l26.1895" class="difflineminus">-      if (this.reasonSigned &amp;&amp; this.reasonSigned !== &quot;&quot;) {</span>
<a href="#l26.1896"></a><span id="l26.1896" class="difflineminus">-        signReasonStr = EnigmailLocale.getString(&quot;signOffWithReason&quot;, [this.reasonSigned]);</span>
<a href="#l26.1897"></a><span id="l26.1897" class="difflineminus">-      }</span>
<a href="#l26.1898"></a><span id="l26.1898" class="difflineminus">-      else {</span>
<a href="#l26.1899"></a><span id="l26.1899" class="difflineminus">-        signReasonStr = signStr;</span>
<a href="#l26.1900"></a><span id="l26.1900" class="difflineminus">-      }</span>
<a href="#l26.1901"></a><span id="l26.1901" class="difflineminus">-    }</span>
<a href="#l26.1902"></a><span id="l26.1902" class="difflineminus">-    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js:   signSymbol=&quot; + signSymbol + &quot;  signReasonStr=&quot; + signReasonStr + &quot;\n&quot;);</span>
<a href="#l26.1903"></a><span id="l26.1903"> </span>
<a href="#l26.1904"></a><span id="l26.1904">     // update sign icon and tooltip/menu-text</span>
<a href="#l26.1905"></a><span id="l26.1905">     signBroadcaster.setAttribute(&quot;signed&quot;, signSymbol);</span>
<a href="#l26.1906"></a><span id="l26.1906">     var signIcon = document.getElementById(&quot;button-enigmail-sign&quot;);</span>
<a href="#l26.1907"></a><span id="l26.1907">     if (signIcon) {</span>
<a href="#l26.1908"></a><span id="l26.1908">       signIcon.setAttribute(&quot;tooltiptext&quot;, signReasonStr);</span>
<a href="#l26.1909"></a><span id="l26.1909">     }</span>
<a href="#l26.1910"></a><span id="l26.1910">     this.statusSignedStr = signStr;</span>
<a href="#l26.1911"></a><span id="l26.1911" class="difflineat">@@ -2069,286 +1451,218 @@ Enigmail.msg = {</span>
<a href="#l26.1912"></a><span id="l26.1912">         }</span>
<a href="#l26.1913"></a><span id="l26.1913">       }</span>
<a href="#l26.1914"></a><span id="l26.1914">       else {</span>
<a href="#l26.1915"></a><span id="l26.1915">         toolbarTxt.removeAttribute(&quot;class&quot;);</span>
<a href="#l26.1916"></a><span id="l26.1916">       }</span>
<a href="#l26.1917"></a><span id="l26.1917">     }</span>
<a href="#l26.1918"></a><span id="l26.1918"> </span>
<a href="#l26.1919"></a><span id="l26.1919">     // update pgp mime/inline PGP menu-text</span>
<a href="#l26.1920"></a><span id="l26.1920" class="difflineminus">-    if (this.statusPGPMime == EnigmailConstants.ENIG_FINAL_YES) {</span>
<a href="#l26.1921"></a><span id="l26.1921" class="difflineplus">+    if () {</span>
<a href="#l26.1922"></a><span id="l26.1922">       this.statusPGPMimeStr = EnigmailLocale.getString(&quot;pgpmimeAuto&quot;);</span>
<a href="#l26.1923"></a><span id="l26.1923">     }</span>
<a href="#l26.1924"></a><span id="l26.1924">     else {</span>
<a href="#l26.1925"></a><span id="l26.1925">       this.statusPGPMimeStr = EnigmailLocale.getString(&quot;pgpmimeNormal&quot;);</span>
<a href="#l26.1926"></a><span id="l26.1926">     }</span>
<a href="#l26.1927"></a><span id="l26.1927"> </span>
<a href="#l26.1928"></a><span id="l26.1928" class="difflineminus">-    if (this.statusPGPMime == EnigmailConstants.ENIG_FINAL_NO) {</span>
<a href="#l26.1929"></a><span id="l26.1929" class="difflineplus">+    if () {</span>
<a href="#l26.1930"></a><span id="l26.1930">       this.statusInlinePGPStr = EnigmailLocale.getString(&quot;inlinePGPAuto&quot;);</span>
<a href="#l26.1931"></a><span id="l26.1931">     }</span>
<a href="#l26.1932"></a><span id="l26.1932">     else {</span>
<a href="#l26.1933"></a><span id="l26.1933">       this.statusInlinePGPStr = EnigmailLocale.getString(&quot;inlinePGPNormal&quot;);</span>
<a href="#l26.1934"></a><span id="l26.1934">     }</span>
<a href="#l26.1935"></a><span id="l26.1935"> </span>
<a href="#l26.1936"></a><span id="l26.1936" class="difflineminus">-    if (this.statusPGPMime == EnigmailConstants.ENIG_FINAL_SMIME) {</span>
<a href="#l26.1937"></a><span id="l26.1937" class="difflineplus">+    if () {</span>
<a href="#l26.1938"></a><span id="l26.1938">       this.statusSMimeStr = EnigmailLocale.getString(&quot;smimeAuto&quot;);</span>
<a href="#l26.1939"></a><span id="l26.1939">     }</span>
<a href="#l26.1940"></a><span id="l26.1940">     else {</span>
<a href="#l26.1941"></a><span id="l26.1941">       this.statusSMimeStr = EnigmailLocale.getString(&quot;smimeNormal&quot;);</span>
<a href="#l26.1942"></a><span id="l26.1942">     }</span>
<a href="#l26.1943"></a><span id="l26.1943"> </span>
<a href="#l26.1944"></a><span id="l26.1944">     this.displaySMimeToolbar();</span>
<a href="#l26.1945"></a><span id="l26.1945"> </span>
<a href="#l26.1946"></a><span id="l26.1946">     if (this.allowAttachOwnKey() === 1) {</span>
<a href="#l26.1947"></a><span id="l26.1947">       attachBroadcaster.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l26.1948"></a><span id="l26.1948">     }</span>
<a href="#l26.1949"></a><span id="l26.1949">     else {</span>
<a href="#l26.1950"></a><span id="l26.1950">       attachBroadcaster.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l26.1951"></a><span id="l26.1951">     }</span>
<a href="#l26.1952"></a><span id="l26.1952" class="difflineminus">-</span>
<a href="#l26.1953"></a><span id="l26.1953" class="difflineplus">+    */</span>
<a href="#l26.1954"></a><span id="l26.1954">   },</span>
<a href="#l26.1955"></a><span id="l26.1955"> </span>
<a href="#l26.1956"></a><span id="l26.1956"> </span>
<a href="#l26.1957"></a><span id="l26.1957" class="difflineplus">+  /*</span>
<a href="#l26.1958"></a><span id="l26.1958">   displaySMimeToolbar: function() {</span>
<a href="#l26.1959"></a><span id="l26.1959">     let s = document.getElementById(&quot;signing-status&quot;);</span>
<a href="#l26.1960"></a><span id="l26.1960">     let e = document.getElementById(&quot;encryption-status&quot;);</span>
<a href="#l26.1961"></a><span id="l26.1961"> </span>
<a href="#l26.1962"></a><span id="l26.1962" class="difflineminus">-    switch (this.statusPGPMime) {</span>
<a href="#l26.1963"></a><span id="l26.1963" class="difflineminus">-      case EnigmailConstants.ENIG_FINAL_SMIME:</span>
<a href="#l26.1964"></a><span id="l26.1964" class="difflineminus">-      case EnigmailConstants.ENIG_FINAL_FORCESMIME:</span>
<a href="#l26.1965"></a><span id="l26.1965">         if (s) s.removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l26.1966"></a><span id="l26.1966">         if (e) e.removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l26.1967"></a><span id="l26.1967" class="difflineminus">-        break;</span>
<a href="#l26.1968"></a><span id="l26.1968" class="difflineminus">-      default:</span>
<a href="#l26.1969"></a><span id="l26.1969">         if (s) s.setAttribute(&quot;collapsed&quot;, &quot;true&quot;);</span>
<a href="#l26.1970"></a><span id="l26.1970">         if (e) e.setAttribute(&quot;collapsed&quot;, &quot;true&quot;);</span>
<a href="#l26.1971"></a><span id="l26.1971" class="difflineminus">-    }</span>
<a href="#l26.1972"></a><span id="l26.1972">   },</span>
<a href="#l26.1973"></a><span id="l26.1973" class="difflineplus">+  */</span>
<a href="#l26.1974"></a><span id="l26.1974"> </span>
<a href="#l26.1975"></a><span id="l26.1975">   /**</span>
<a href="#l26.1976"></a><span id="l26.1976">    * determine if own key may be attached.</span>
<a href="#l26.1977"></a><span id="l26.1977">    * @result: Number:</span>
<a href="#l26.1978"></a><span id="l26.1978">    *          -1: account not enabled for Enigmail</span>
<a href="#l26.1979"></a><span id="l26.1979">    *           0: account enabled but key mode set to &quot;by Email address&quot;</span>
<a href="#l26.1980"></a><span id="l26.1980">    *           1: account enabled; key specified</span>
<a href="#l26.1981"></a><span id="l26.1981">    */</span>
<a href="#l26.1982"></a><span id="l26.1982" class="difflineplus">+  /*</span>
<a href="#l26.1983"></a><span id="l26.1983">   allowAttachOwnKey: function() {</span>
<a href="#l26.1984"></a><span id="l26.1984"> </span>
<a href="#l26.1985"></a><span id="l26.1985">     let allow = -1;</span>
<a href="#l26.1986"></a><span id="l26.1986"> </span>
<a href="#l26.1987"></a><span id="l26.1987" class="difflineminus">-    if (this.isEnigmailEnabled()) {</span>
<a href="#l26.1988"></a><span id="l26.1988" class="difflineplus">+    if (Enigmail.msg.isEnigmailEnabledForIdentity()) {</span>
<a href="#l26.1989"></a><span id="l26.1989">       allow = 0;</span>
<a href="#l26.1990"></a><span id="l26.1990">       if (this.identity.getIntAttribute(&quot;pgpKeyMode&quot;) &gt; 0) {</span>
<a href="#l26.1991"></a><span id="l26.1991">         let keyIdValue = this.identity.getCharAttribute(&quot;pgpkeyId&quot;);</span>
<a href="#l26.1992"></a><span id="l26.1992">         if (keyIdValue.search(/^ *(0x)?[0-9a-fA-F]* *$/) === 0) {</span>
<a href="#l26.1993"></a><span id="l26.1993">           allow = 1;</span>
<a href="#l26.1994"></a><span id="l26.1994">         }</span>
<a href="#l26.1995"></a><span id="l26.1995">       }</span>
<a href="#l26.1996"></a><span id="l26.1996">     }</span>
<a href="#l26.1997"></a><span id="l26.1997"> </span>
<a href="#l26.1998"></a><span id="l26.1998">     return allow;</span>
<a href="#l26.1999"></a><span id="l26.1999">   },</span>
<a href="#l26.2000"></a><span id="l26.2000" class="difflineminus">-</span>
<a href="#l26.2001"></a><span id="l26.2001" class="difflineminus">-  /* compute whether to sign/encrypt according to current rules and sendMode</span>
<a href="#l26.2002"></a><span id="l26.2002" class="difflineminus">-   * - without any interaction, just to process resulting status bar icons</span>
<a href="#l26.2003"></a><span id="l26.2003" class="difflineplus">+  */</span>
<a href="#l26.2004"></a><span id="l26.2004" class="difflineplus">+</span>
<a href="#l26.2005"></a><span id="l26.2005" class="difflineplus">+  /* check if encryption is possible (have keys for everyone or not)</span>
<a href="#l26.2006"></a><span id="l26.2006">    */</span>
<a href="#l26.2007"></a><span id="l26.2007">   determineSendFlags: function() {</span>
<a href="#l26.2008"></a><span id="l26.2008">     EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.focusChange: Enigmail.msg.determineSendFlags\n&quot;);</span>
<a href="#l26.2009"></a><span id="l26.2009"> </span>
<a href="#l26.2010"></a><span id="l26.2010">     let detailsObj = {};</span>
<a href="#l26.2011"></a><span id="l26.2011"> </span>
<a href="#l26.2012"></a><span id="l26.2012" class="difflineminus">-    this.statusEncryptedInStatusBar = null; // to double check broken promise for encryption</span>
<a href="#l26.2013"></a><span id="l26.2013" class="difflineminus">-</span>
<a href="#l26.2014"></a><span id="l26.2014">     if (!this.identity) {</span>
<a href="#l26.2015"></a><span id="l26.2015">       this.identity = getCurrentIdentity();</span>
<a href="#l26.2016"></a><span id="l26.2016">     }</span>
<a href="#l26.2017"></a><span id="l26.2017"> </span>
<a href="#l26.2018"></a><span id="l26.2018">     var compFields = gMsgCompose.compFields;</span>
<a href="#l26.2019"></a><span id="l26.2019"> </span>
<a href="#l26.2020"></a><span id="l26.2020">     if (!Enigmail.msg.composeBodyReady) {</span>
<a href="#l26.2021"></a><span id="l26.2021">       compFields = Components.classes[&quot;@mozilla.org/messengercompose/composefields;1&quot;].createInstance(Components.interfaces.nsIMsgCompFields);</span>
<a href="#l26.2022"></a><span id="l26.2022">     }</span>
<a href="#l26.2023"></a><span id="l26.2023">     Recipients2CompFields(compFields);</span>
<a href="#l26.2024"></a><span id="l26.2024">     gMsgCompose.expandMailingLists();</span>
<a href="#l26.2025"></a><span id="l26.2025"> </span>
<a href="#l26.2026"></a><span id="l26.2026" class="difflineminus">-    if (this.isEnigmailEnabled()) {</span>
<a href="#l26.2027"></a><span id="l26.2027" class="difflineplus">+    if (Enigmail.msg.isEnigmailEnabledForIdentity()) {</span>
<a href="#l26.2028"></a><span id="l26.2028">       // process list of to/cc email addresses</span>
<a href="#l26.2029"></a><span id="l26.2029">       // - bcc email addresses are ignored, when processing whether to sign/encrypt</span>
<a href="#l26.2030"></a><span id="l26.2030">       var toAddrList = [];</span>
<a href="#l26.2031"></a><span id="l26.2031">       var arrLen = {};</span>
<a href="#l26.2032"></a><span id="l26.2032">       var recList;</span>
<a href="#l26.2033"></a><span id="l26.2033">       if (compFields.to.length &gt; 0) {</span>
<a href="#l26.2034"></a><span id="l26.2034">         recList = compFields.splitRecipients(compFields.to, true, arrLen);</span>
<a href="#l26.2035"></a><span id="l26.2035">         this.addRecipients(toAddrList, recList);</span>
<a href="#l26.2036"></a><span id="l26.2036">       }</span>
<a href="#l26.2037"></a><span id="l26.2037">       if (compFields.cc.length &gt; 0) {</span>
<a href="#l26.2038"></a><span id="l26.2038">         recList = compFields.splitRecipients(compFields.cc, true, arrLen);</span>
<a href="#l26.2039"></a><span id="l26.2039">         this.addRecipients(toAddrList, recList);</span>
<a href="#l26.2040"></a><span id="l26.2040">       }</span>
<a href="#l26.2041"></a><span id="l26.2041"> </span>
<a href="#l26.2042"></a><span id="l26.2042" class="difflineminus">-      this.encryptByRules = EnigmailConstants.ENIG_UNDEF;</span>
<a href="#l26.2043"></a><span id="l26.2043" class="difflineminus">-      this.signByRules = EnigmailConstants.ENIG_UNDEF;</span>
<a href="#l26.2044"></a><span id="l26.2044" class="difflineminus">-      this.pgpmimeByRules = EnigmailConstants.ENIG_UNDEF;</span>
<a href="#l26.2045"></a><span id="l26.2045" class="difflineminus">-</span>
<a href="#l26.2046"></a><span id="l26.2046" class="difflineminus">-      // process rules</span>
<a href="#l26.2047"></a><span id="l26.2047" class="difflineminus">-      if (toAddrList.length &gt; 0 &amp;&amp; EnigmailPrefs.getPref(&quot;assignKeysByRules&quot;)) {</span>
<a href="#l26.2048"></a><span id="l26.2048" class="difflineminus">-        var matchedKeysObj = {};</span>
<a href="#l26.2049"></a><span id="l26.2049" class="difflineminus">-        var flagsObj = {};</span>
<a href="#l26.2050"></a><span id="l26.2050" class="difflineminus">-        if (EnigmailRules.mapAddrsToKeys(toAddrList.join(&quot;, &quot;),</span>
<a href="#l26.2051"></a><span id="l26.2051" class="difflineminus">-            false, // no interaction if not all addrs have a key</span>
<a href="#l26.2052"></a><span id="l26.2052" class="difflineminus">-            window,</span>
<a href="#l26.2053"></a><span id="l26.2053" class="difflineminus">-            matchedKeysObj, // resulting matching keys</span>
<a href="#l26.2054"></a><span id="l26.2054" class="difflineminus">-            flagsObj)) { // resulting flags (0/1/2/3 for each type)</span>
<a href="#l26.2055"></a><span id="l26.2055" class="difflineminus">-          this.encryptByRules = flagsObj.encrypt;</span>
<a href="#l26.2056"></a><span id="l26.2056" class="difflineminus">-          this.signByRules = flagsObj.sign;</span>
<a href="#l26.2057"></a><span id="l26.2057" class="difflineminus">-          this.pgpmimeByRules = flagsObj.pgpMime;</span>
<a href="#l26.2058"></a><span id="l26.2058" class="difflineminus">-</span>
<a href="#l26.2059"></a><span id="l26.2059" class="difflineminus">-          if (matchedKeysObj.value &amp;&amp; matchedKeysObj.value.length &gt; 0) {</span>
<a href="#l26.2060"></a><span id="l26.2060" class="difflineminus">-            // replace addresses with results from rules</span>
<a href="#l26.2061"></a><span id="l26.2061" class="difflineminus">-            toAddrList = matchedKeysObj.value.split(&quot;, &quot;);</span>
<a href="#l26.2062"></a><span id="l26.2062" class="difflineminus">-          }</span>
<a href="#l26.2063"></a><span id="l26.2063" class="difflineminus">-        }</span>
<a href="#l26.2064"></a><span id="l26.2064" class="difflineminus">-      }</span>
<a href="#l26.2065"></a><span id="l26.2065" class="difflineminus">-</span>
<a href="#l26.2066"></a><span id="l26.2066">       let validKeyList = Enigmail.hlp.validKeysForAllRecipients(toAddrList.join(&quot;, &quot;), detailsObj);</span>
<a href="#l26.2067"></a><span id="l26.2067" class="difflineminus">-</span>
<a href="#l26.2068"></a><span id="l26.2068" class="difflineminus">-      this.autoPgpEncryption = (validKeyList !== null);</span>
<a href="#l26.2069"></a><span id="l26.2069" class="difflineminus">-</span>
<a href="#l26.2070"></a><span id="l26.2070" class="difflineminus">-      // if not clear whether to encrypt yet, check whether automatically-send-encrypted applies</span>
<a href="#l26.2071"></a><span id="l26.2071" class="difflineminus">-      if (toAddrList.length &gt; 0 &amp;&amp; this.encryptByRules == EnigmailConstants.ENIG_UNDEF &amp;&amp; EnigmailPrefs.getPref(&quot;autoSendEncrypted&quot;) == 1) {</span>
<a href="#l26.2072"></a><span id="l26.2072" class="difflineminus">-        if (validKeyList) {</span>
<a href="#l26.2073"></a><span id="l26.2073" class="difflineminus">-          this.encryptByRules = EnigmailConstants.ENIG_AUTO_ALWAYS;</span>
<a href="#l26.2074"></a><span id="l26.2074" class="difflineminus">-        }</span>
<a href="#l26.2075"></a><span id="l26.2075" class="difflineminus">-      }</span>
<a href="#l26.2076"></a><span id="l26.2076" class="difflineminus">-    }</span>
<a href="#l26.2077"></a><span id="l26.2077" class="difflineminus">-    else {</span>
<a href="#l26.2078"></a><span id="l26.2078" class="difflineminus">-      this.encryptByRules = EnigmailConstants.ENIG_UNDEF;</span>
<a href="#l26.2079"></a><span id="l26.2079" class="difflineminus">-      this.signByRules = EnigmailConstants.ENIG_UNDEF;</span>
<a href="#l26.2080"></a><span id="l26.2080" class="difflineminus">-      this.pgpmimeByRules = EnigmailConstants.ENIG_UNDEF;</span>
<a href="#l26.2081"></a><span id="l26.2081" class="difflineminus">-      this.autoPgpEncryption = false;</span>
<a href="#l26.2082"></a><span id="l26.2082" class="difflineplus">+      //this.autoPgpEncryption = (validKeyList !== null);</span>
<a href="#l26.2083"></a><span id="l26.2083">     }</span>
<a href="#l26.2084"></a><span id="l26.2084"> </span>
<a href="#l26.2085"></a><span id="l26.2085">     // process and signal new resulting state</span>
<a href="#l26.2086"></a><span id="l26.2086" class="difflineminus">-    this.processFinalState();</span>
<a href="#l26.2087"></a><span id="l26.2087" class="difflineplus">+    //this.processFinalState();</span>
<a href="#l26.2088"></a><span id="l26.2088">     this.updateStatusBar();</span>
<a href="#l26.2089"></a><span id="l26.2089"> </span>
<a href="#l26.2090"></a><span id="l26.2090">     return detailsObj;</span>
<a href="#l26.2091"></a><span id="l26.2091">   },</span>
<a href="#l26.2092"></a><span id="l26.2092"> </span>
<a href="#l26.2093"></a><span id="l26.2093" class="difflineplus">+  /*</span>
<a href="#l26.2094"></a><span id="l26.2094">   setChecked: function(elementId, checked) {</span>
<a href="#l26.2095"></a><span id="l26.2095">     let elem = document.getElementById(elementId);</span>
<a href="#l26.2096"></a><span id="l26.2096">     if (elem) {</span>
<a href="#l26.2097"></a><span id="l26.2097">       if (checked) {</span>
<a href="#l26.2098"></a><span id="l26.2098">         elem.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l26.2099"></a><span id="l26.2099">       }</span>
<a href="#l26.2100"></a><span id="l26.2100">       else</span>
<a href="#l26.2101"></a><span id="l26.2101">         elem.removeAttribute(&quot;checked&quot;);</span>
<a href="#l26.2102"></a><span id="l26.2102">     }</span>
<a href="#l26.2103"></a><span id="l26.2103">   },</span>
<a href="#l26.2104"></a><span id="l26.2104" class="difflineminus">-</span>
<a href="#l26.2105"></a><span id="l26.2105" class="difflineplus">+  */</span>
<a href="#l26.2106"></a><span id="l26.2106" class="difflineplus">+</span>
<a href="#l26.2107"></a><span id="l26.2107" class="difflineplus">+  /*</span>
<a href="#l26.2108"></a><span id="l26.2108">   setMenuSettings: function(postfix) {</span>
<a href="#l26.2109"></a><span id="l26.2109">     EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.setMenuSettings: postfix=&quot; + postfix + &quot;\n&quot;);</span>
<a href="#l26.2110"></a><span id="l26.2110"> </span>
<a href="#l26.2111"></a><span id="l26.2111" class="difflineminus">-    let enigmailEnabled = this.isEnigmailEnabled();</span>
<a href="#l26.2112"></a><span id="l26.2112" class="difflineminus">-    let smimeEnabled = this.isSmimeEnabled();</span>
<a href="#l26.2113"></a><span id="l26.2113" class="difflineplus">+    let enigmailEnabled = Enigmail.msg.wasEnigmailEnabledForIdentity();</span>
<a href="#l26.2114"></a><span id="l26.2114" class="difflineplus">+    let smimeEnabled = Enigmail.msg.isSmimeEnabled();</span>
<a href="#l26.2115"></a><span id="l26.2115"> </span>
<a href="#l26.2116"></a><span id="l26.2116">     const SIGN = EnigmailConstants.SEND_SIGNED;</span>
<a href="#l26.2117"></a><span id="l26.2117">     const ENCRYPT = EnigmailConstants.SEND_ENCRYPTED;</span>
<a href="#l26.2118"></a><span id="l26.2118"> </span>
<a href="#l26.2119"></a><span id="l26.2119">     var elem = document.getElementById(&quot;enigmail_compose_sign_item&quot; + postfix);</span>
<a href="#l26.2120"></a><span id="l26.2120">     if (elem) {</span>
<a href="#l26.2121"></a><span id="l26.2121">       elem.setAttribute(&quot;label&quot;, this.statusSignedStr);</span>
<a href="#l26.2122"></a><span id="l26.2122" class="difflineminus">-      switch (this.statusSigned) {</span>
<a href="#l26.2123"></a><span id="l26.2123" class="difflineminus">-        case EnigmailConstants.ENIG_FINAL_YES:</span>
<a href="#l26.2124"></a><span id="l26.2124" class="difflineminus">-        case EnigmailConstants.ENIG_FINAL_FORCEYES:</span>
<a href="#l26.2125"></a><span id="l26.2125" class="difflineminus">-          elem.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l26.2126"></a><span id="l26.2126" class="difflineminus">-          break;</span>
<a href="#l26.2127"></a><span id="l26.2127" class="difflineminus">-        default:</span>
<a href="#l26.2128"></a><span id="l26.2128" class="difflineminus">-          elem.setAttribute(&quot;checked&quot;, &quot;false&quot;);</span>
<a href="#l26.2129"></a><span id="l26.2129" class="difflineplus">+      switch (gSendSigned) {</span>
<a href="#l26.2130"></a><span id="l26.2130" class="difflineplus">+          //elem.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l26.2131"></a><span id="l26.2131" class="difflineplus">+          //elem.setAttribute(&quot;checked&quot;, &quot;false&quot;);</span>
<a href="#l26.2132"></a><span id="l26.2132">       }</span>
<a href="#l26.2133"></a><span id="l26.2133">     }</span>
<a href="#l26.2134"></a><span id="l26.2134"> </span>
<a href="#l26.2135"></a><span id="l26.2135">     elem = document.getElementById(&quot;enigmail_compose_encrypt_item&quot; + postfix);</span>
<a href="#l26.2136"></a><span id="l26.2136">     if (elem) {</span>
<a href="#l26.2137"></a><span id="l26.2137">       elem.setAttribute(&quot;label&quot;, this.statusEncryptedStr);</span>
<a href="#l26.2138"></a><span id="l26.2138" class="difflineminus">-      switch (this.statusEncrypted) {</span>
<a href="#l26.2139"></a><span id="l26.2139" class="difflineminus">-        case EnigmailConstants.ENIG_FINAL_YES:</span>
<a href="#l26.2140"></a><span id="l26.2140" class="difflineminus">-        case EnigmailConstants.ENIG_FINAL_FORCEYES:</span>
<a href="#l26.2141"></a><span id="l26.2141" class="difflineminus">-          elem.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l26.2142"></a><span id="l26.2142" class="difflineminus">-          break;</span>
<a href="#l26.2143"></a><span id="l26.2143" class="difflineminus">-        default:</span>
<a href="#l26.2144"></a><span id="l26.2144" class="difflineminus">-          elem.setAttribute(&quot;checked&quot;, &quot;false&quot;);</span>
<a href="#l26.2145"></a><span id="l26.2145" class="difflineplus">+      switch (gSendEncrypted) {</span>
<a href="#l26.2146"></a><span id="l26.2146" class="difflineplus">+          //elem.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l26.2147"></a><span id="l26.2147" class="difflineplus">+          //elem.setAttribute(&quot;checked&quot;, &quot;false&quot;);</span>
<a href="#l26.2148"></a><span id="l26.2148">       }</span>
<a href="#l26.2149"></a><span id="l26.2149">     }</span>
<a href="#l26.2150"></a><span id="l26.2150"> </span>
<a href="#l26.2151"></a><span id="l26.2151">     elem = document.getElementById(&quot;enigmail_compose_pgpmime_item&quot; + postfix);</span>
<a href="#l26.2152"></a><span id="l26.2152">     if (elem) {</span>
<a href="#l26.2153"></a><span id="l26.2153">       elem.setAttribute(&quot;label&quot;, this.statusPGPMimeStr);</span>
<a href="#l26.2154"></a><span id="l26.2154">       if (enigmailEnabled) {</span>
<a href="#l26.2155"></a><span id="l26.2155">         elem.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l26.2156"></a><span id="l26.2156">       }</span>
<a href="#l26.2157"></a><span id="l26.2157">       else {</span>
<a href="#l26.2158"></a><span id="l26.2158">         elem.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l26.2159"></a><span id="l26.2159">       }</span>
<a href="#l26.2160"></a><span id="l26.2160"> </span>
<a href="#l26.2161"></a><span id="l26.2161" class="difflineminus">-      switch (this.statusPGPMime) {</span>
<a href="#l26.2162"></a><span id="l26.2162" class="difflineminus">-        case EnigmailConstants.ENIG_FINAL_YES:</span>
<a href="#l26.2163"></a><span id="l26.2163" class="difflineminus">-        case EnigmailConstants.ENIG_FINAL_FORCEYES:</span>
<a href="#l26.2164"></a><span id="l26.2164" class="difflineminus">-          elem.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l26.2165"></a><span id="l26.2165" class="difflineminus">-          break;</span>
<a href="#l26.2166"></a><span id="l26.2166" class="difflineminus">-        default:</span>
<a href="#l26.2167"></a><span id="l26.2167" class="difflineminus">-          elem.setAttribute(&quot;checked&quot;, &quot;false&quot;);</span>
<a href="#l26.2168"></a><span id="l26.2168" class="difflineminus">-      }</span>
<a href="#l26.2169"></a><span id="l26.2169" class="difflineplus">+          //elem.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l26.2170"></a><span id="l26.2170" class="difflineplus">+          //elem.setAttribute(&quot;checked&quot;, &quot;false&quot;);</span>
<a href="#l26.2171"></a><span id="l26.2171"> </span>
<a href="#l26.2172"></a><span id="l26.2172">       elem = document.getElementById(&quot;enigmail_compose_inline_item&quot; + postfix);</span>
<a href="#l26.2173"></a><span id="l26.2173">       if (elem) {</span>
<a href="#l26.2174"></a><span id="l26.2174">         elem.setAttribute(&quot;label&quot;, this.statusInlinePGPStr);</span>
<a href="#l26.2175"></a><span id="l26.2175">         if (enigmailEnabled) {</span>
<a href="#l26.2176"></a><span id="l26.2176">           elem.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l26.2177"></a><span id="l26.2177">         }</span>
<a href="#l26.2178"></a><span id="l26.2178">         else {</span>
<a href="#l26.2179"></a><span id="l26.2179">           elem.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l26.2180"></a><span id="l26.2180">         }</span>
<a href="#l26.2181"></a><span id="l26.2181"> </span>
<a href="#l26.2182"></a><span id="l26.2182" class="difflineminus">-        switch (this.statusPGPMime) {</span>
<a href="#l26.2183"></a><span id="l26.2183" class="difflineminus">-          case EnigmailConstants.ENIG_FINAL_NO:</span>
<a href="#l26.2184"></a><span id="l26.2184" class="difflineminus">-          case EnigmailConstants.ENIG_FINAL_FORCENO:</span>
<a href="#l26.2185"></a><span id="l26.2185" class="difflineminus">-          case EnigmailConstants.ENIG_FINAL_CONFLICT:</span>
<a href="#l26.2186"></a><span id="l26.2186" class="difflineminus">-          case EnigmailConstants.ENIG_FINAL_UNDEF:</span>
<a href="#l26.2187"></a><span id="l26.2187" class="difflineminus">-            elem.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l26.2188"></a><span id="l26.2188" class="difflineminus">-            break;</span>
<a href="#l26.2189"></a><span id="l26.2189" class="difflineminus">-          default:</span>
<a href="#l26.2190"></a><span id="l26.2190" class="difflineminus">-            elem.setAttribute(&quot;checked&quot;, &quot;false&quot;);</span>
<a href="#l26.2191"></a><span id="l26.2191" class="difflineminus">-        }</span>
<a href="#l26.2192"></a><span id="l26.2192" class="difflineplus">+            //elem.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l26.2193"></a><span id="l26.2193" class="difflineplus">+            //elem.setAttribute(&quot;checked&quot;, &quot;false&quot;);</span>
<a href="#l26.2194"></a><span id="l26.2194">       }</span>
<a href="#l26.2195"></a><span id="l26.2195"> </span>
<a href="#l26.2196"></a><span id="l26.2196">       elem = document.getElementById(&quot;enigmail_compose_smime_item&quot; + postfix);</span>
<a href="#l26.2197"></a><span id="l26.2197">       if (elem) {</span>
<a href="#l26.2198"></a><span id="l26.2198">         elem.setAttribute(&quot;label&quot;, this.statusSMimeStr);</span>
<a href="#l26.2199"></a><span id="l26.2199">         if (smimeEnabled) {</span>
<a href="#l26.2200"></a><span id="l26.2200">           elem.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l26.2201"></a><span id="l26.2201">         }</span>
<a href="#l26.2202"></a><span id="l26.2202">         else {</span>
<a href="#l26.2203"></a><span id="l26.2203">           elem.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l26.2204"></a><span id="l26.2204">         }</span>
<a href="#l26.2205"></a><span id="l26.2205"> </span>
<a href="#l26.2206"></a><span id="l26.2206" class="difflineminus">-        switch (this.statusPGPMime) {</span>
<a href="#l26.2207"></a><span id="l26.2207" class="difflineminus">-          case EnigmailConstants.ENIG_FINAL_SMIME:</span>
<a href="#l26.2208"></a><span id="l26.2208" class="difflineminus">-          case EnigmailConstants.ENIG_FINAL_FORCESMIME:</span>
<a href="#l26.2209"></a><span id="l26.2209" class="difflineminus">-            elem.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l26.2210"></a><span id="l26.2210" class="difflineminus">-            break;</span>
<a href="#l26.2211"></a><span id="l26.2211" class="difflineminus">-          default:</span>
<a href="#l26.2212"></a><span id="l26.2212" class="difflineminus">-            elem.setAttribute(&quot;checked&quot;, &quot;false&quot;);</span>
<a href="#l26.2213"></a><span id="l26.2213" class="difflineminus">-        }</span>
<a href="#l26.2214"></a><span id="l26.2214" class="difflineplus">+            //elem.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l26.2215"></a><span id="l26.2215" class="difflineplus">+            //elem.setAttribute(&quot;checked&quot;, &quot;false&quot;);</span>
<a href="#l26.2216"></a><span id="l26.2216">       }</span>
<a href="#l26.2217"></a><span id="l26.2217"> </span>
<a href="#l26.2218"></a><span id="l26.2218">       elem = document.getElementById(&quot;enigmail_insert_own_key&quot;);</span>
<a href="#l26.2219"></a><span id="l26.2219">       if (elem) {</span>
<a href="#l26.2220"></a><span id="l26.2220">         if (this.identity.getIntAttribute(&quot;pgpKeyMode&quot;) &gt; 0) {</span>
<a href="#l26.2221"></a><span id="l26.2221" class="difflineminus">-          elem.setAttribute(&quot;checked&quot;, this.attachOwnKeyObj.appendAttachment.toString());</span>
<a href="#l26.2222"></a><span id="l26.2222" class="difflineplus">+          elem.setAttribute(&quot;checked&quot;, gAttachMyPublicPGPKey.toString());</span>
<a href="#l26.2223"></a><span id="l26.2223">           elem.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l26.2224"></a><span id="l26.2224">         }</span>
<a href="#l26.2225"></a><span id="l26.2225">         else {</span>
<a href="#l26.2226"></a><span id="l26.2226">           elem.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l26.2227"></a><span id="l26.2227">         }</span>
<a href="#l26.2228"></a><span id="l26.2228">       }</span>
<a href="#l26.2229"></a><span id="l26.2229"> </span>
<a href="#l26.2230"></a><span id="l26.2230">       elem = document.getElementById(&quot;enigmail_encrypt_subject&quot;);</span>
<a href="#l26.2231"></a><span id="l26.2231" class="difflineat">@@ -2356,172 +1670,88 @@ Enigmail.msg = {</span>
<a href="#l26.2232"></a><span id="l26.2232">         if (enigmailEnabled) {</span>
<a href="#l26.2233"></a><span id="l26.2233">           elem.setAttribute(&quot;checked&quot;, this.protectHeaders ? &quot;true&quot; : &quot;false&quot;);</span>
<a href="#l26.2234"></a><span id="l26.2234">           elem.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l26.2235"></a><span id="l26.2235">         }</span>
<a href="#l26.2236"></a><span id="l26.2236">         else {</span>
<a href="#l26.2237"></a><span id="l26.2237">           elem.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l26.2238"></a><span id="l26.2238">         }</span>
<a href="#l26.2239"></a><span id="l26.2239">       }</span>
<a href="#l26.2240"></a><span id="l26.2240" class="difflineminus">-    }</span>
<a href="#l26.2241"></a><span id="l26.2241">   },</span>
<a href="#l26.2242"></a><span id="l26.2242" class="difflineminus">-</span>
<a href="#l26.2243"></a><span id="l26.2243" class="difflineplus">+  */</span>
<a href="#l26.2244"></a><span id="l26.2244" class="difflineplus">+</span>
<a href="#l26.2245"></a><span id="l26.2245" class="difflineplus">+  /*</span>
<a href="#l26.2246"></a><span id="l26.2246">   displaySecuritySettings: function() {</span>
<a href="#l26.2247"></a><span id="l26.2247">     EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.displaySecuritySettings\n&quot;);</span>
<a href="#l26.2248"></a><span id="l26.2248"> </span>
<a href="#l26.2249"></a><span id="l26.2249">     var inputObj = {</span>
<a href="#l26.2250"></a><span id="l26.2250" class="difflineminus">-      statusEncrypted: this.statusEncrypted,</span>
<a href="#l26.2251"></a><span id="l26.2251" class="difflineminus">-      statusSigned: this.statusSigned,</span>
<a href="#l26.2252"></a><span id="l26.2252" class="difflineminus">-      statusPGPMime: this.statusPGPMime,</span>
<a href="#l26.2253"></a><span id="l26.2253" class="difflineplus">+      gSendEncrypted: gSendEncrypted,</span>
<a href="#l26.2254"></a><span id="l26.2254" class="difflineplus">+      gSendSigned: gSendSigned,</span>
<a href="#l26.2255"></a><span id="l26.2255">       success: false,</span>
<a href="#l26.2256"></a><span id="l26.2256">       resetDefaults: false</span>
<a href="#l26.2257"></a><span id="l26.2257">     };</span>
<a href="#l26.2258"></a><span id="l26.2258">     window.openDialog(&quot;chrome://openpgp/content/ui/enigmailEncryptionDlg.xhtml&quot;, &quot;&quot;, &quot;dialog,modal,centerscreen&quot;, inputObj);</span>
<a href="#l26.2259"></a><span id="l26.2259"> </span>
<a href="#l26.2260"></a><span id="l26.2260">     if (!inputObj.success) return; // Cancel pressed</span>
<a href="#l26.2261"></a><span id="l26.2261"> </span>
<a href="#l26.2262"></a><span id="l26.2262">     if (inputObj.resetDefaults) {</span>
<a href="#l26.2263"></a><span id="l26.2263">       // reset everything to defaults</span>
<a href="#l26.2264"></a><span id="l26.2264">       this.encryptForced = EnigmailConstants.ENIG_UNDEF;</span>
<a href="#l26.2265"></a><span id="l26.2265">       this.signForced = EnigmailConstants.ENIG_UNDEF;</span>
<a href="#l26.2266"></a><span id="l26.2266" class="difflineminus">-      this.pgpmimeForced = EnigmailConstants.ENIG_UNDEF;</span>
<a href="#l26.2267"></a><span id="l26.2267" class="difflineminus">-      this.finalSignDependsOnEncrypt = true;</span>
<a href="#l26.2268"></a><span id="l26.2268">     }</span>
<a href="#l26.2269"></a><span id="l26.2269">     else {</span>
<a href="#l26.2270"></a><span id="l26.2270">       if (this.signForced != inputObj.sign) {</span>
<a href="#l26.2271"></a><span id="l26.2271">         this.dirty = 2;</span>
<a href="#l26.2272"></a><span id="l26.2272">         this.signForced = inputObj.sign;</span>
<a href="#l26.2273"></a><span id="l26.2273" class="difflineminus">-        this.finalSignDependsOnEncrypt = false;</span>
<a href="#l26.2274"></a><span id="l26.2274">       }</span>
<a href="#l26.2275"></a><span id="l26.2275"> </span>
<a href="#l26.2276"></a><span id="l26.2276" class="difflineminus">-      if (this.encryptForced != inputObj.encrypt || this.pgpmimeForced != inputObj.pgpmime) {</span>
<a href="#l26.2277"></a><span id="l26.2277">         this.dirty = 2;</span>
<a href="#l26.2278"></a><span id="l26.2278" class="difflineminus">-      }</span>
<a href="#l26.2279"></a><span id="l26.2279"> </span>
<a href="#l26.2280"></a><span id="l26.2280">       this.encryptForced = inputObj.encrypt;</span>
<a href="#l26.2281"></a><span id="l26.2281" class="difflineminus">-      this.pgpmimeForced = inputObj.pgpmime;</span>
<a href="#l26.2282"></a><span id="l26.2282">     }</span>
<a href="#l26.2283"></a><span id="l26.2283"> </span>
<a href="#l26.2284"></a><span id="l26.2284" class="difflineminus">-    this.processFinalState();</span>
<a href="#l26.2285"></a><span id="l26.2285" class="difflineplus">+    //this.processFinalState();</span>
<a href="#l26.2286"></a><span id="l26.2286">     this.updateStatusBar();</span>
<a href="#l26.2287"></a><span id="l26.2287">   },</span>
<a href="#l26.2288"></a><span id="l26.2288" class="difflineminus">-</span>
<a href="#l26.2289"></a><span id="l26.2289" class="difflineminus">-</span>
<a href="#l26.2290"></a><span id="l26.2290" class="difflineminus">-  signingNoLongerDependsOnEnc: function() {</span>
<a href="#l26.2291"></a><span id="l26.2291" class="difflineminus">-    if (this.finalSignDependsOnEncrypt) {</span>
<a href="#l26.2292"></a><span id="l26.2292" class="difflineminus">-      EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.signingNoLongerDependsOnEnc(): unbundle final signing\n&quot;);</span>
<a href="#l26.2293"></a><span id="l26.2293" class="difflineminus">-      this.finalSignDependsOnEncrypt = false;</span>
<a href="#l26.2294"></a><span id="l26.2294" class="difflineminus">-</span>
<a href="#l26.2295"></a><span id="l26.2295" class="difflineminus">-      EnigmailDialog.alertPref(window, EnigmailLocale.getString(&quot;signIconClicked&quot;), &quot;displaySignWarn&quot;);</span>
<a href="#l26.2296"></a><span id="l26.2296" class="difflineminus">-    }</span>
<a href="#l26.2297"></a><span id="l26.2297" class="difflineminus">-  },</span>
<a href="#l26.2298"></a><span id="l26.2298" class="difflineminus">-</span>
<a href="#l26.2299"></a><span id="l26.2299" class="difflineminus">-</span>
<a href="#l26.2300"></a><span id="l26.2300" class="difflineminus">-  confirmBeforeSend: function(toAddrStr, gpgKeys, sendFlags, isOffline) {</span>
<a href="#l26.2301"></a><span id="l26.2301" class="difflineminus">-    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.confirmBeforeSend: sendFlags=&quot; + sendFlags + &quot;\n&quot;);</span>
<a href="#l26.2302"></a><span id="l26.2302" class="difflineminus">-    // get confirmation before sending message</span>
<a href="#l26.2303"></a><span id="l26.2303" class="difflineminus">-</span>
<a href="#l26.2304"></a><span id="l26.2304" class="difflineminus">-    const SIGN = EnigmailConstants.SEND_SIGNED;</span>
<a href="#l26.2305"></a><span id="l26.2305" class="difflineminus">-    const ENCRYPT = EnigmailConstants.SEND_ENCRYPTED;</span>
<a href="#l26.2306"></a><span id="l26.2306" class="difflineminus">-</span>
<a href="#l26.2307"></a><span id="l26.2307" class="difflineminus">-    // get wording for message status (e.g. &quot; SIGNED ENCRYPTED&quot;)</span>
<a href="#l26.2308"></a><span id="l26.2308" class="difflineminus">-    var msgStatus = &quot;&quot;;</span>
<a href="#l26.2309"></a><span id="l26.2309" class="difflineminus">-</span>
<a href="#l26.2310"></a><span id="l26.2310" class="difflineminus">-</span>
<a href="#l26.2311"></a><span id="l26.2311" class="difflineminus">-    if (sendFlags &amp; (ENCRYPT | SIGN)) {</span>
<a href="#l26.2312"></a><span id="l26.2312" class="difflineminus">-      if (this.statusPGPMime === EnigmailConstants.ENIG_FINAL_SMIME ||</span>
<a href="#l26.2313"></a><span id="l26.2313" class="difflineminus">-        this.statusPGPMime === EnigmailConstants.ENIG_FINAL_FORCESMIME) {</span>
<a href="#l26.2314"></a><span id="l26.2314" class="difflineminus">-        msgStatus += &quot; &quot; + EnigmailLocale.getString(&quot;statSMIME&quot;);</span>
<a href="#l26.2315"></a><span id="l26.2315" class="difflineminus">-      }</span>
<a href="#l26.2316"></a><span id="l26.2316" class="difflineminus">-      else if (sendFlags &amp; EnigmailConstants.SEND_PGP_MIME) {</span>
<a href="#l26.2317"></a><span id="l26.2317" class="difflineminus">-        msgStatus += &quot; &quot; + EnigmailLocale.getString(&quot;statPGPMIME&quot;);</span>
<a href="#l26.2318"></a><span id="l26.2318" class="difflineminus">-      }</span>
<a href="#l26.2319"></a><span id="l26.2319" class="difflineminus">-</span>
<a href="#l26.2320"></a><span id="l26.2320" class="difflineminus">-      if (sendFlags &amp; SIGN) {</span>
<a href="#l26.2321"></a><span id="l26.2321" class="difflineminus">-        msgStatus += &quot; &quot; + EnigmailLocale.getString(&quot;statSigned&quot;);</span>
<a href="#l26.2322"></a><span id="l26.2322" class="difflineminus">-      }</span>
<a href="#l26.2323"></a><span id="l26.2323" class="difflineminus">-      if (sendFlags &amp; ENCRYPT) {</span>
<a href="#l26.2324"></a><span id="l26.2324" class="difflineminus">-        msgStatus += &quot; &quot; + EnigmailLocale.getString(&quot;statEncrypted&quot;);</span>
<a href="#l26.2325"></a><span id="l26.2325" class="difflineminus">-      }</span>
<a href="#l26.2326"></a><span id="l26.2326" class="difflineminus">-    }</span>
<a href="#l26.2327"></a><span id="l26.2327" class="difflineminus">-    else {</span>
<a href="#l26.2328"></a><span id="l26.2328" class="difflineminus">-      msgStatus += &quot; &quot; + EnigmailLocale.getString(&quot;statPlain&quot;);</span>
<a href="#l26.2329"></a><span id="l26.2329" class="difflineminus">-    }</span>
<a href="#l26.2330"></a><span id="l26.2330" class="difflineminus">-</span>
<a href="#l26.2331"></a><span id="l26.2331" class="difflineminus">-    // create message</span>
<a href="#l26.2332"></a><span id="l26.2332" class="difflineminus">-    var msgConfirm = &quot;&quot;;</span>
<a href="#l26.2333"></a><span id="l26.2333" class="difflineminus">-    try {</span>
<a href="#l26.2334"></a><span id="l26.2334" class="difflineminus">-      if (isOffline || sendFlags &amp; EnigmailConstants.SEND_LATER) {</span>
<a href="#l26.2335"></a><span id="l26.2335" class="difflineminus">-        msgConfirm = EnigmailLocale.getString(&quot;offlineSave&quot;, [msgStatus, EnigmailFuncs.stripEmail(toAddrStr).replace(/,/g, &quot;, &quot;)]);</span>
<a href="#l26.2336"></a><span id="l26.2336" class="difflineminus">-      }</span>
<a href="#l26.2337"></a><span id="l26.2337" class="difflineminus">-      else {</span>
<a href="#l26.2338"></a><span id="l26.2338" class="difflineminus">-        msgConfirm = EnigmailLocale.getString(&quot;onlineSend&quot;, [msgStatus, EnigmailFuncs.stripEmail(toAddrStr).replace(/,/g, &quot;, &quot;)]);</span>
<a href="#l26.2339"></a><span id="l26.2339" class="difflineminus">-      }</span>
<a href="#l26.2340"></a><span id="l26.2340" class="difflineminus">-    }</span>
<a href="#l26.2341"></a><span id="l26.2341" class="difflineminus">-    catch (ex) {}</span>
<a href="#l26.2342"></a><span id="l26.2342" class="difflineminus">-</span>
<a href="#l26.2343"></a><span id="l26.2343" class="difflineminus">-    // add list of keys</span>
<a href="#l26.2344"></a><span id="l26.2344" class="difflineminus">-    if (sendFlags &amp; ENCRYPT) {</span>
<a href="#l26.2345"></a><span id="l26.2345" class="difflineminus">-      gpgKeys = gpgKeys.replace(/^, /, &quot;&quot;).replace(/, $/, &quot;&quot;);</span>
<a href="#l26.2346"></a><span id="l26.2346" class="difflineminus">-</span>
<a href="#l26.2347"></a><span id="l26.2347" class="difflineminus">-      // make gpg keys unique</span>
<a href="#l26.2348"></a><span id="l26.2348" class="difflineminus">-      let keyList = gpgKeys.split(/[, ]+/).reduce(function _f(p, key) {</span>
<a href="#l26.2349"></a><span id="l26.2349" class="difflineminus">-        if (p.indexOf(key) &lt; 0) p.push(key);</span>
<a href="#l26.2350"></a><span id="l26.2350" class="difflineminus">-        return p;</span>
<a href="#l26.2351"></a><span id="l26.2351" class="difflineminus">-      }, []);</span>
<a href="#l26.2352"></a><span id="l26.2352" class="difflineminus">-</span>
<a href="#l26.2353"></a><span id="l26.2353" class="difflineminus">-      if (this.statusPGPMime !== EnigmailConstants.ENIG_FINAL_SMIME &amp;&amp;</span>
<a href="#l26.2354"></a><span id="l26.2354" class="difflineminus">-        this.statusPGPMime !== EnigmailConstants.ENIG_FINAL_FORCESMIME) {</span>
<a href="#l26.2355"></a><span id="l26.2355" class="difflineminus">-        msgConfirm += &quot;\n\n&quot; + EnigmailLocale.getString(&quot;encryptKeysNote&quot;, [keyList.join(&quot;, &quot;)]);</span>
<a href="#l26.2356"></a><span id="l26.2356" class="difflineminus">-      }</span>
<a href="#l26.2357"></a><span id="l26.2357" class="difflineminus">-    }</span>
<a href="#l26.2358"></a><span id="l26.2358" class="difflineminus">-</span>
<a href="#l26.2359"></a><span id="l26.2359" class="difflineminus">-    return EnigmailDialog.confirmDlg(window, msgConfirm,</span>
<a href="#l26.2360"></a><span id="l26.2360" class="difflineminus">-      EnigmailLocale.getString((isOffline || sendFlags &amp; EnigmailConstants.SEND_LATER) ?</span>
<a href="#l26.2361"></a><span id="l26.2361" class="difflineminus">-        &quot;msgCompose.button.save&quot; : &quot;msgCompose.button.send&quot;));</span>
<a href="#l26.2362"></a><span id="l26.2362" class="difflineminus">-  },</span>
<a href="#l26.2363"></a><span id="l26.2363" class="difflineplus">+  */</span>
<a href="#l26.2364"></a><span id="l26.2364"> </span>
<a href="#l26.2365"></a><span id="l26.2365"> </span>
<a href="#l26.2366"></a><span id="l26.2366">   addRecipients: function(toAddrList, recList) {</span>
<a href="#l26.2367"></a><span id="l26.2367">     for (var i = 0; i &lt; recList.length; i++) {</span>
<a href="#l26.2368"></a><span id="l26.2368">       try {</span>
<a href="#l26.2369"></a><span id="l26.2369">         toAddrList.push(EnigmailFuncs.stripEmail(recList[i].replace(/[&quot;,]/g, &quot;&quot;)));</span>
<a href="#l26.2370"></a><span id="l26.2370">       }</span>
<a href="#l26.2371"></a><span id="l26.2371">       catch (ex) {}</span>
<a href="#l26.2372"></a><span id="l26.2372">     }</span>
<a href="#l26.2373"></a><span id="l26.2373">   },</span>
<a href="#l26.2374"></a><span id="l26.2374"> </span>
<a href="#l26.2375"></a><span id="l26.2375">   setDraftStatus: function(doEncrypt) {</span>
<a href="#l26.2376"></a><span id="l26.2376">     EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.setDraftStatus - enabling draft mode\n&quot;);</span>
<a href="#l26.2377"></a><span id="l26.2377"> </span>
<a href="#l26.2378"></a><span id="l26.2378" class="difflineplus">+    // TODO: rewrite to properly set draft status using new flags</span>
<a href="#l26.2379"></a><span id="l26.2379" class="difflineplus">+    /*</span>
<a href="#l26.2380"></a><span id="l26.2380">     // Draft Status:</span>
<a href="#l26.2381"></a><span id="l26.2381">     // N (for new style) plus String of 4 numbers:</span>
<a href="#l26.2382"></a><span id="l26.2382">     // 1: encryption</span>
<a href="#l26.2383"></a><span id="l26.2383">     // 2: signing</span>
<a href="#l26.2384"></a><span id="l26.2384">     // 3: PGP/MIME</span>
<a href="#l26.2385"></a><span id="l26.2385">     // 4: attach own key</span>
<a href="#l26.2386"></a><span id="l26.2386">     // 5: subject encrypted</span>
<a href="#l26.2387"></a><span id="l26.2387"> </span>
<a href="#l26.2388"></a><span id="l26.2388" class="difflineminus">-    var draftStatus = &quot;N&quot; + this.encryptForced + this.signForced + this.pgpmimeForced +</span>
<a href="#l26.2389"></a><span id="l26.2389" class="difflineminus">-      (this.attachOwnKeyObj.appendAttachment ? &quot;1&quot; : &quot;0&quot;) + (doEncrypt &amp;&amp; this.protectHeaders ? &quot;1&quot; : &quot;0&quot;);</span>
<a href="#l26.2390"></a><span id="l26.2390" class="difflineplus">+    var draftStatus = &quot;N&quot; + </span>
<a href="#l26.2391"></a><span id="l26.2391" class="difflineplus">+      (gSendEncrypted &amp;&amp; !gOptionalEncryption) + </span>
<a href="#l26.2392"></a><span id="l26.2392" class="difflineplus">+      (gSendSigned) + </span>
<a href="#l26.2393"></a><span id="l26.2393" class="difflineplus">+      (gAttachMyPublicPGPKey ? &quot;1&quot; : &quot;0&quot;) + (doEncrypt &amp;&amp; this.protectHeaders ? &quot;1&quot; : &quot;0&quot;);</span>
<a href="#l26.2394"></a><span id="l26.2394"> </span>
<a href="#l26.2395"></a><span id="l26.2395">     this.setAdditionalHeader(&quot;X-Enigmail-Draft-Status&quot;, draftStatus);</span>
<a href="#l26.2396"></a><span id="l26.2396" class="difflineplus">+    */</span>
<a href="#l26.2397"></a><span id="l26.2397">   },</span>
<a href="#l26.2398"></a><span id="l26.2398"> </span>
<a href="#l26.2399"></a><span id="l26.2399">   getForceRecipientDlg: function() {</span>
<a href="#l26.2400"></a><span id="l26.2400" class="difflineminus">-    // force add-rule dialog for each missing key?:</span>
<a href="#l26.2401"></a><span id="l26.2401" class="difflineminus">-    let forceRecipientSettings = false;</span>
<a href="#l26.2402"></a><span id="l26.2402" class="difflineminus">-    // if keys are ONLY assigned by rules, force add-rule dialog for each missing key</span>
<a href="#l26.2403"></a><span id="l26.2403" class="difflineminus">-    if (EnigmailPrefs.getPref(&quot;assignKeysByRules&quot;) &amp;&amp;</span>
<a href="#l26.2404"></a><span id="l26.2404" class="difflineminus">-      !EnigmailPrefs.getPref(&quot;assignKeysByEmailAddr&quot;) &amp;&amp;</span>
<a href="#l26.2405"></a><span id="l26.2405" class="difflineminus">-      !EnigmailPrefs.getPref(&quot;assignKeysManuallyIfMissing&quot;) &amp;&amp;</span>
<a href="#l26.2406"></a><span id="l26.2406" class="difflineminus">-      !EnigmailPrefs.getPref(&quot;assignKeysManuallyAlways&quot;)) {</span>
<a href="#l26.2407"></a><span id="l26.2407" class="difflineminus">-      forceRecipientSettings = true;</span>
<a href="#l26.2408"></a><span id="l26.2408" class="difflineminus">-    }</span>
<a href="#l26.2409"></a><span id="l26.2409" class="difflineminus">-    return forceRecipientSettings;</span>
<a href="#l26.2410"></a><span id="l26.2410" class="difflineplus">+    return false;</span>
<a href="#l26.2411"></a><span id="l26.2411">   },</span>
<a href="#l26.2412"></a><span id="l26.2412"> </span>
<a href="#l26.2413"></a><span id="l26.2413">   getSenderUserId: function() {</span>
<a href="#l26.2414"></a><span id="l26.2414">     var userIdValue = null;</span>
<a href="#l26.2415"></a><span id="l26.2415"> </span>
<a href="#l26.2416"></a><span id="l26.2416">     if (this.identity.getIntAttribute(&quot;pgpKeyMode&quot;) &gt; 0) {</span>
<a href="#l26.2417"></a><span id="l26.2417">       userIdValue = this.identity.getCharAttribute(&quot;pgpkeyId&quot;);</span>
<a href="#l26.2418"></a><span id="l26.2418"> </span>
<a href="#l26.2419"></a><span id="l26.2419" class="difflineat">@@ -2564,27 +1794,26 @@ Enigmail.msg = {</span>
<a href="#l26.2420"></a><span id="l26.2420"> </span>
<a href="#l26.2421"></a><span id="l26.2421">   /* process rules and find keys for passed email addresses</span>
<a href="#l26.2422"></a><span id="l26.2422">    * This is THE core method to prepare sending encryptes emails.</span>
<a href="#l26.2423"></a><span id="l26.2423">    * - it processes the recipient rules (if not disabled)</span>
<a href="#l26.2424"></a><span id="l26.2424">    * - it</span>
<a href="#l26.2425"></a><span id="l26.2425">    *</span>
<a href="#l26.2426"></a><span id="l26.2426">    * @sendFlags:    Longint - all current combined/processed send flags (incl. optSendFlags)</span>
<a href="#l26.2427"></a><span id="l26.2427">    * @optSendFlags: Longint - may only be SEND_ALWAYS_TRUST or SEND_ENCRYPT_TO_SELF</span>
<a href="#l26.2428"></a><span id="l26.2428" class="difflineminus">-   * @gotSendFlags: Longint - initial sendMode of encryptMsg() (0 or SIGN or ENCRYPT or SIGN|ENCRYPT)</span>
<a href="#l26.2429"></a><span id="l26.2429">    * @fromAddr:     String - from email</span>
<a href="#l26.2430"></a><span id="l26.2430">    * @toAddrList:   Array  - both to and cc receivers</span>
<a href="#l26.2431"></a><span id="l26.2431">    * @bccAddrList:  Array  - bcc receivers</span>
<a href="#l26.2432"></a><span id="l26.2432">    * @return:       Object:</span>
<a href="#l26.2433"></a><span id="l26.2433">    *                - sendFlags (Longint)</span>
<a href="#l26.2434"></a><span id="l26.2434">    *                - toAddrStr  comma separated string of unprocessed to/cc emails</span>
<a href="#l26.2435"></a><span id="l26.2435">    *                - bccAddrStr comma separated string of unprocessed to/cc emails</span>
<a href="#l26.2436"></a><span id="l26.2436">    *                or null (cancel sending the email)</span>
<a href="#l26.2437"></a><span id="l26.2437">    */</span>
<a href="#l26.2438"></a><span id="l26.2438" class="difflineminus">-  keySelection: function(enigmailSvc, sendFlags, optSendFlags, gotSendFlags, fromAddr, toAddrList, bccAddrList) {</span>
<a href="#l26.2439"></a><span id="l26.2439" class="difflineplus">+  keySelection: function(enigmailSvc, sendFlags, optSendFlags, fromAddr, toAddrList, bccAddrList) {</span>
<a href="#l26.2440"></a><span id="l26.2440">     EnigmailLog.DEBUG(&quot;=====&gt; keySelection()\n&quot;);</span>
<a href="#l26.2441"></a><span id="l26.2441">     EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.keySelection()\n&quot;);</span>
<a href="#l26.2442"></a><span id="l26.2442"> </span>
<a href="#l26.2443"></a><span id="l26.2443">     const SIGN = EnigmailConstants.SEND_SIGNED;</span>
<a href="#l26.2444"></a><span id="l26.2444">     const ENCRYPT = EnigmailConstants.SEND_ENCRYPTED;</span>
<a href="#l26.2445"></a><span id="l26.2445"> </span>
<a href="#l26.2446"></a><span id="l26.2446">     let toAddrStr = toAddrList.join(&quot;, &quot;);</span>
<a href="#l26.2447"></a><span id="l26.2447">     let bccAddrStr = bccAddrList.join(&quot;, &quot;);</span>
<a href="#l26.2448"></a><span id="l26.2448" class="difflineat">@@ -2592,88 +1821,34 @@ Enigmail.msg = {</span>
<a href="#l26.2449"></a><span id="l26.2449"> </span>
<a href="#l26.2450"></a><span id="l26.2450">     // NOTE: If we only have bcc addresses, we currently do NOT process rules and select keys at all</span>
<a href="#l26.2451"></a><span id="l26.2451">     //       This is GOOD because sending keys for bcc addresses makes bcc addresses visible</span>
<a href="#l26.2452"></a><span id="l26.2452">     //       (thus compromising the concept of bcc)</span>
<a href="#l26.2453"></a><span id="l26.2453">     //       THUS, we disable encryption even though all bcc receivers might want to have it encrypted.</span>
<a href="#l26.2454"></a><span id="l26.2454">     if (toAddrStr.length === 0) {</span>
<a href="#l26.2455"></a><span id="l26.2455">       EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.keySelection(): skip key selection because we neither have \&quot;to\&quot; nor \&quot;cc\&quot; addresses\n&quot;);</span>
<a href="#l26.2456"></a><span id="l26.2456"> </span>
<a href="#l26.2457"></a><span id="l26.2457" class="difflineminus">-      if (this.statusPGPMime == EnigmailConstants.ENIG_FINAL_YES ||</span>
<a href="#l26.2458"></a><span id="l26.2458" class="difflineminus">-        this.statusPGPMime == EnigmailConstants.ENIG_FINAL_FORCEYES) {</span>
<a href="#l26.2459"></a><span id="l26.2459" class="difflineminus">-        sendFlags |= EnigmailConstants.SEND_PGP_MIME;</span>
<a href="#l26.2460"></a><span id="l26.2460" class="difflineminus">-      }</span>
<a href="#l26.2461"></a><span id="l26.2461" class="difflineminus">-      else if (this.statusPGPMime == EnigmailConstants.ENIG_FINAL_NO ||</span>
<a href="#l26.2462"></a><span id="l26.2462" class="difflineminus">-        this.statusPGPMime == EnigmailConstants.ENIG_FINAL_FORCENO ||</span>
<a href="#l26.2463"></a><span id="l26.2463" class="difflineminus">-        this.statusPGPMime == EnigmailConstants.ENIG_FINAL_CONFLICT) {</span>
<a href="#l26.2464"></a><span id="l26.2464" class="difflineminus">-        sendFlags &amp;= ~EnigmailConstants.SEND_PGP_MIME;</span>
<a href="#l26.2465"></a><span id="l26.2465" class="difflineminus">-      }</span>
<a href="#l26.2466"></a><span id="l26.2466" class="difflineplus">+        //sendFlags |= EnigmailConstants.SEND_PGP_MIME;</span>
<a href="#l26.2467"></a><span id="l26.2467" class="difflineplus">+        //sendFlags &amp;= ~EnigmailConstants.SEND_PGP_MIME;</span>
<a href="#l26.2468"></a><span id="l26.2468"> </span>
<a href="#l26.2469"></a><span id="l26.2469">       return {</span>
<a href="#l26.2470"></a><span id="l26.2470">         sendFlags: sendFlags,</span>
<a href="#l26.2471"></a><span id="l26.2471">         toAddrStr: toAddrStr,</span>
<a href="#l26.2472"></a><span id="l26.2472">         bccAddrStr: bccAddrStr,</span>
<a href="#l26.2473"></a><span id="l26.2473">         keyMap: keyMap</span>
<a href="#l26.2474"></a><span id="l26.2474">       };</span>
<a href="#l26.2475"></a><span id="l26.2475">     }</span>
<a href="#l26.2476"></a><span id="l26.2476"> </span>
<a href="#l26.2477"></a><span id="l26.2477">     EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.keySelection(): toAddrStr=\&quot;&quot; + toAddrStr + &quot;\&quot; bccAddrStr=\&quot;&quot; + bccAddrStr + &quot;\&quot;\n&quot;);</span>
<a href="#l26.2478"></a><span id="l26.2478"> </span>
<a href="#l26.2479"></a><span id="l26.2479">     var forceRecipientSettings = this.getForceRecipientDlg();</span>
<a href="#l26.2480"></a><span id="l26.2480"> </span>
<a href="#l26.2481"></a><span id="l26.2481">     // REPEAT 1 or 2 times:</span>
<a href="#l26.2482"></a><span id="l26.2482">     // NOTE: The only way to call this loop twice is to come to the &quot;continue;&quot; statement below,</span>
<a href="#l26.2483"></a><span id="l26.2483">     //       which forces a second iteration (with forceRecipientSettings==true)</span>
<a href="#l26.2484"></a><span id="l26.2484" class="difflineminus">-    var doRulesProcessingAgain;</span>
<a href="#l26.2485"></a><span id="l26.2485" class="difflineminus">-    do {</span>
<a href="#l26.2486"></a><span id="l26.2486" class="difflineminus">-      doRulesProcessingAgain = false;</span>
<a href="#l26.2487"></a><span id="l26.2487" class="difflineminus">-</span>
<a href="#l26.2488"></a><span id="l26.2488" class="difflineminus">-      // process rules if not disabled</span>
<a href="#l26.2489"></a><span id="l26.2489" class="difflineminus">-      // - enableRules: rules not temporarily disabled</span>
<a href="#l26.2490"></a><span id="l26.2490" class="difflineminus">-      // REPLACES email addresses by keys in its result !!!</span>
<a href="#l26.2491"></a><span id="l26.2491" class="difflineminus">-      var refreshKeyList = true;</span>
<a href="#l26.2492"></a><span id="l26.2492" class="difflineminus">-      if (EnigmailPrefs.getPref(&quot;assignKeysByRules&quot;) &amp;&amp; this.enableRules) {</span>
<a href="#l26.2493"></a><span id="l26.2493" class="difflineminus">-        let result = this.processRules(forceRecipientSettings, sendFlags, optSendFlags, toAddrStr, bccAddrStr);</span>
<a href="#l26.2494"></a><span id="l26.2494" class="difflineminus">-        if (!result) {</span>
<a href="#l26.2495"></a><span id="l26.2495" class="difflineminus">-          return null;</span>
<a href="#l26.2496"></a><span id="l26.2496" class="difflineminus">-        }</span>
<a href="#l26.2497"></a><span id="l26.2497" class="difflineminus">-        sendFlags = result.sendFlags;</span>
<a href="#l26.2498"></a><span id="l26.2498" class="difflineminus">-        optSendFlags = result.optSendFlags;</span>
<a href="#l26.2499"></a><span id="l26.2499" class="difflineminus">-        toAddrStr = result.toAddr; // replace email addresses with rules by the corresponding keys</span>
<a href="#l26.2500"></a><span id="l26.2500" class="difflineminus">-        bccAddrStr = result.bccAddr; // replace email addresses with rules by the corresponding keys</span>
<a href="#l26.2501"></a><span id="l26.2501" class="difflineminus">-        refreshKeyList = !result.didRefreshKeyList; // if key list refreshed we don't have to do it again</span>
<a href="#l26.2502"></a><span id="l26.2502" class="difflineminus">-        keyMap = result.keyMap;</span>
<a href="#l26.2503"></a><span id="l26.2503" class="difflineminus">-      }</span>
<a href="#l26.2504"></a><span id="l26.2504" class="difflineminus">-</span>
<a href="#l26.2505"></a><span id="l26.2505" class="difflineminus">-      // if encryption is requested for the email:</span>
<a href="#l26.2506"></a><span id="l26.2506" class="difflineminus">-      // - encrypt test message for default encryption</span>
<a href="#l26.2507"></a><span id="l26.2507" class="difflineminus">-      // - might trigger a second iteration through this loop</span>
<a href="#l26.2508"></a><span id="l26.2508" class="difflineminus">-      //   - if during its dialog for manual key selection &quot;create per-recipient rules&quot; is pressed</span>
<a href="#l26.2509"></a><span id="l26.2509" class="difflineminus">-      //   to force manual settings for missing keys</span>
<a href="#l26.2510"></a><span id="l26.2510" class="difflineminus">-      // LEAVES remaining email addresses not covered by rules as they are</span>
<a href="#l26.2511"></a><span id="l26.2511" class="difflineminus">-      /*</span>
<a href="#l26.2512"></a><span id="l26.2512" class="difflineminus">-      if (sendFlags &amp; ENCRYPT) {</span>
<a href="#l26.2513"></a><span id="l26.2513" class="difflineminus">-        let result = this.encryptTestMessage(enigmailSvc, sendFlags, optSendFlags,</span>
<a href="#l26.2514"></a><span id="l26.2514" class="difflineminus">-          fromAddr, toAddrStr, bccAddrStr, bccAddrList, refreshKeyList);</span>
<a href="#l26.2515"></a><span id="l26.2515" class="difflineminus">-        if (!result) {</span>
<a href="#l26.2516"></a><span id="l26.2516" class="difflineminus">-          return null;</span>
<a href="#l26.2517"></a><span id="l26.2517" class="difflineminus">-        }</span>
<a href="#l26.2518"></a><span id="l26.2518" class="difflineminus">-        sendFlags = result.sendFlags;</span>
<a href="#l26.2519"></a><span id="l26.2519" class="difflineminus">-        toAddrStr = result.toAddrStr;</span>
<a href="#l26.2520"></a><span id="l26.2520" class="difflineminus">-        bccAddrStr = result.bccAddrStr;</span>
<a href="#l26.2521"></a><span id="l26.2521" class="difflineminus">-        if (result.doRulesProcessingAgain) { // start rule processing again ?</span>
<a href="#l26.2522"></a><span id="l26.2522" class="difflineminus">-          doRulesProcessingAgain = true;</span>
<a href="#l26.2523"></a><span id="l26.2523" class="difflineminus">-          if (result.createNewRule) {</span>
<a href="#l26.2524"></a><span id="l26.2524" class="difflineminus">-            forceRecipientSettings = true;</span>
<a href="#l26.2525"></a><span id="l26.2525" class="difflineminus">-          }</span>
<a href="#l26.2526"></a><span id="l26.2526" class="difflineminus">-        }</span>
<a href="#l26.2527"></a><span id="l26.2527" class="difflineminus">-      }</span>
<a href="#l26.2528"></a><span id="l26.2528" class="difflineminus">-      */</span>
<a href="#l26.2529"></a><span id="l26.2529" class="difflineminus">-    } while (doRulesProcessingAgain);</span>
<a href="#l26.2530"></a><span id="l26.2530" class="difflineminus">-</span>
<a href="#l26.2531"></a><span id="l26.2531">     EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.keySelection(): return toAddrStr=\&quot;&quot; + toAddrStr + &quot;\&quot; bccAddrStr=\&quot;&quot; + bccAddrStr + &quot;\&quot;\n&quot;);</span>
<a href="#l26.2532"></a><span id="l26.2532">     EnigmailLog.DEBUG(&quot;  &lt;=== keySelection()\n&quot;);</span>
<a href="#l26.2533"></a><span id="l26.2533">     return {</span>
<a href="#l26.2534"></a><span id="l26.2534">       sendFlags: sendFlags,</span>
<a href="#l26.2535"></a><span id="l26.2535">       toAddrStr: toAddrStr,</span>
<a href="#l26.2536"></a><span id="l26.2536">       bccAddrStr: bccAddrStr,</span>
<a href="#l26.2537"></a><span id="l26.2537">       keyMap: keyMap</span>
<a href="#l26.2538"></a><span id="l26.2538">     };</span>
<a href="#l26.2539"></a><span id="l26.2539" class="difflineat">@@ -2683,16 +1858,17 @@ Enigmail.msg = {</span>
<a href="#l26.2540"></a><span id="l26.2540">    * Determine if S/MIME or OpenPGP should be used</span>
<a href="#l26.2541"></a><span id="l26.2541">    *</span>
<a href="#l26.2542"></a><span id="l26.2542">    * @param sendFlags: Number - input send flags.</span>
<a href="#l26.2543"></a><span id="l26.2543">    *</span>
<a href="#l26.2544"></a><span id="l26.2544">    * @return: Boolean:</span>
<a href="#l26.2545"></a><span id="l26.2545">    *   1: use OpenPGP</span>
<a href="#l26.2546"></a><span id="l26.2546">    *   0: use S/MIME</span>
<a href="#l26.2547"></a><span id="l26.2547">    */</span>
<a href="#l26.2548"></a><span id="l26.2548" class="difflineplus">+  /*</span>
<a href="#l26.2549"></a><span id="l26.2549">   preferPgpOverSmime: function(sendFlags) {</span>
<a href="#l26.2550"></a><span id="l26.2550"> </span>
<a href="#l26.2551"></a><span id="l26.2551">     let si = Enigmail.msg.getSecurityParams(null, true);</span>
<a href="#l26.2552"></a><span id="l26.2552">     let isSmime = !EnigmailMimeEncrypt.isEnigmailCompField(si);</span>
<a href="#l26.2553"></a><span id="l26.2553"> </span>
<a href="#l26.2554"></a><span id="l26.2554">     if (isSmime &amp;&amp;</span>
<a href="#l26.2555"></a><span id="l26.2555">       (sendFlags &amp; (EnigmailConstants.SEND_SIGNED | EnigmailConstants.SEND_ENCRYPTED))) {</span>
<a href="#l26.2556"></a><span id="l26.2556"> </span>
<a href="#l26.2557"></a><span id="l26.2557" class="difflineat">@@ -2705,16 +1881,17 @@ Enigmail.msg = {</span>
<a href="#l26.2558"></a><span id="l26.2558">         else {</span>
<a href="#l26.2559"></a><span id="l26.2559">           return this.mimePreferOpenPGP;</span>
<a href="#l26.2560"></a><span id="l26.2560">         }</span>
<a href="#l26.2561"></a><span id="l26.2561">       }</span>
<a href="#l26.2562"></a><span id="l26.2562">     }</span>
<a href="#l26.2563"></a><span id="l26.2563"> </span>
<a href="#l26.2564"></a><span id="l26.2564">     return 1;</span>
<a href="#l26.2565"></a><span id="l26.2565">   },</span>
<a href="#l26.2566"></a><span id="l26.2566" class="difflineplus">+  */</span>
<a href="#l26.2567"></a><span id="l26.2567"> </span>
<a href="#l26.2568"></a><span id="l26.2568"> </span>
<a href="#l26.2569"></a><span id="l26.2569">   /**</span>
<a href="#l26.2570"></a><span id="l26.2570">    * check if S/MIME encryption can be enabled</span>
<a href="#l26.2571"></a><span id="l26.2571">    *</span>
<a href="#l26.2572"></a><span id="l26.2572">    * @return: Boolean - true: keys for all recipients are available</span>
<a href="#l26.2573"></a><span id="l26.2573">    */</span>
<a href="#l26.2574"></a><span id="l26.2574">   isSmimeEncryptionPossible: function() {</span>
<a href="#l26.2575"></a><span id="l26.2575" class="difflineat">@@ -2741,351 +1918,16 @@ Enigmail.msg = {</span>
<a href="#l26.2576"></a><span id="l26.2576"> </span>
<a href="#l26.2577"></a><span id="l26.2577">     if (missingCount.value === 0) {</span>
<a href="#l26.2578"></a><span id="l26.2578">       return true;</span>
<a href="#l26.2579"></a><span id="l26.2579">     }</span>
<a href="#l26.2580"></a><span id="l26.2580"> </span>
<a href="#l26.2581"></a><span id="l26.2581">     return false;</span>
<a href="#l26.2582"></a><span id="l26.2582">   },</span>
<a href="#l26.2583"></a><span id="l26.2583"> </span>
<a href="#l26.2584"></a><span id="l26.2584" class="difflineminus">-  /**</span>
<a href="#l26.2585"></a><span id="l26.2585" class="difflineminus">-   * try to apply the OpenPGP rules</span>
<a href="#l26.2586"></a><span id="l26.2586" class="difflineminus">-   *</span>
<a href="#l26.2587"></a><span id="l26.2587" class="difflineminus">-   * @forceRecipientSetting: Boolean - force manual selection for each missing key?</span>
<a href="#l26.2588"></a><span id="l26.2588" class="difflineminus">-   * @sendFlags:             Integer - all current combined/processed send flags (incl. optSendFlags)</span>
<a href="#l26.2589"></a><span id="l26.2589" class="difflineminus">-   * @optSendFlags:          Integer - may only be SEND_ALWAYS_TRUST or SEND_ENCRYPT_TO_SELF</span>
<a href="#l26.2590"></a><span id="l26.2590" class="difflineminus">-   * @toAddrStr:             String  - comma separated string of keys and unprocessed to/cc emails</span>
<a href="#l26.2591"></a><span id="l26.2591" class="difflineminus">-   * @bccAddrStr:            String  - comma separated string of keys and unprocessed bcc emails</span>
<a href="#l26.2592"></a><span id="l26.2592" class="difflineminus">-   * @return:       { sendFlags, toAddr, bccAddr }</span>
<a href="#l26.2593"></a><span id="l26.2593" class="difflineminus">-   *                or null (cancel sending the email)</span>
<a href="#l26.2594"></a><span id="l26.2594" class="difflineminus">-   */</span>
<a href="#l26.2595"></a><span id="l26.2595" class="difflineminus">-  processRules: function(forceRecipientSettings, sendFlags, optSendFlags, toAddrStr, bccAddrStr) {</span>
<a href="#l26.2596"></a><span id="l26.2596" class="difflineminus">-    EnigmailLog.DEBUG(&quot;=====&gt; processRules()\n&quot;);</span>
<a href="#l26.2597"></a><span id="l26.2597" class="difflineminus">-    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.processRules(): toAddrStr=\&quot;&quot; + toAddrStr + &quot;\&quot; bccAddrStr=\&quot;&quot; + bccAddrStr + &quot;\&quot; forceRecipientSettings=&quot; +</span>
<a href="#l26.2598"></a><span id="l26.2598" class="difflineminus">-      forceRecipientSettings + &quot;\n&quot;);</span>
<a href="#l26.2599"></a><span id="l26.2599" class="difflineminus">-</span>
<a href="#l26.2600"></a><span id="l26.2600" class="difflineminus">-    // process defaults</span>
<a href="#l26.2601"></a><span id="l26.2601" class="difflineminus">-    const SIGN = EnigmailConstants.SEND_SIGNED;</span>
<a href="#l26.2602"></a><span id="l26.2602" class="difflineminus">-    const ENCRYPT = EnigmailConstants.SEND_ENCRYPTED;</span>
<a href="#l26.2603"></a><span id="l26.2603" class="difflineminus">-    let didRefreshKeyList = false; // return value to signal whether the key list was refreshed</span>
<a href="#l26.2604"></a><span id="l26.2604" class="difflineminus">-</span>
<a href="#l26.2605"></a><span id="l26.2605" class="difflineminus">-    // get keys for to and cc addresses:</span>
<a href="#l26.2606"></a><span id="l26.2606" class="difflineminus">-    // - matchedKeysObj will contain the keys and the remaining toAddrStr elements</span>
<a href="#l26.2607"></a><span id="l26.2607" class="difflineminus">-    let matchedKeysObj = {}; // returned value for matched keys</span>
<a href="#l26.2608"></a><span id="l26.2608" class="difflineminus">-    let details = {};</span>
<a href="#l26.2609"></a><span id="l26.2609" class="difflineminus">-    let keyMap = {};</span>
<a href="#l26.2610"></a><span id="l26.2610" class="difflineminus">-    let flagsObj = {}; // returned value for flags</span>
<a href="#l26.2611"></a><span id="l26.2611" class="difflineminus">-    if (!EnigmailRules.mapAddrsToKeys(toAddrStr,</span>
<a href="#l26.2612"></a><span id="l26.2612" class="difflineminus">-        forceRecipientSettings, // true =&gt; start dialog for addrs without any key</span>
<a href="#l26.2613"></a><span id="l26.2613" class="difflineminus">-        window,</span>
<a href="#l26.2614"></a><span id="l26.2614" class="difflineminus">-        matchedKeysObj,</span>
<a href="#l26.2615"></a><span id="l26.2615" class="difflineminus">-        flagsObj)) {</span>
<a href="#l26.2616"></a><span id="l26.2616" class="difflineminus">-      return null;</span>
<a href="#l26.2617"></a><span id="l26.2617" class="difflineminus">-    }</span>
<a href="#l26.2618"></a><span id="l26.2618" class="difflineminus">-    if (matchedKeysObj.value) {</span>
<a href="#l26.2619"></a><span id="l26.2619" class="difflineminus">-      toAddrStr = matchedKeysObj.value;</span>
<a href="#l26.2620"></a><span id="l26.2620" class="difflineminus">-      EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.processRules(): after mapAddrsToKeys() toAddrStr=\&quot;&quot; + toAddrStr + &quot;\&quot;\n&quot;);</span>
<a href="#l26.2621"></a><span id="l26.2621" class="difflineminus">-</span>
<a href="#l26.2622"></a><span id="l26.2622" class="difflineminus">-      if (matchedKeysObj.addrKeysList) {</span>
<a href="#l26.2623"></a><span id="l26.2623" class="difflineminus">-        for (let i = 0; i &lt; matchedKeysObj.addrKeysList.length; i++) {</span>
<a href="#l26.2624"></a><span id="l26.2624" class="difflineminus">-          keyMap[matchedKeysObj.addrKeysList[i].addr] = matchedKeysObj.addrKeysList[i].keys;</span>
<a href="#l26.2625"></a><span id="l26.2625" class="difflineminus">-        }</span>
<a href="#l26.2626"></a><span id="l26.2626" class="difflineminus">-      }</span>
<a href="#l26.2627"></a><span id="l26.2627" class="difflineminus">-    }</span>
<a href="#l26.2628"></a><span id="l26.2628" class="difflineminus">-    this.encryptByRules = flagsObj.encrypt;</span>
<a href="#l26.2629"></a><span id="l26.2629" class="difflineminus">-    this.signByRules = flagsObj.sign;</span>
<a href="#l26.2630"></a><span id="l26.2630" class="difflineminus">-    this.pgpmimeByRules = flagsObj.pgpMime;</span>
<a href="#l26.2631"></a><span id="l26.2631" class="difflineminus">-</span>
<a href="#l26.2632"></a><span id="l26.2632" class="difflineminus">-    // if not clear whether to encrypt yet, check whether automatically-send-encrypted applies</span>
<a href="#l26.2633"></a><span id="l26.2633" class="difflineminus">-    // - check whether bcc is empty here? if (bccAddrStr.length === 0)</span>
<a href="#l26.2634"></a><span id="l26.2634" class="difflineminus">-    let validKeyList = Enigmail.hlp.validKeysForAllRecipients(toAddrStr, details);</span>
<a href="#l26.2635"></a><span id="l26.2635" class="difflineminus">-    if (validKeyList) {</span>
<a href="#l26.2636"></a><span id="l26.2636" class="difflineminus">-      if (toAddrStr.length &gt; 0 &amp;&amp; this.encryptByRules == EnigmailConstants.ENIG_UNDEF &amp;&amp; EnigmailPrefs.getPref(&quot;autoSendEncrypted&quot;) == 1) {</span>
<a href="#l26.2637"></a><span id="l26.2637" class="difflineminus">-        this.encryptByRules = EnigmailConstants.ENIG_AUTO_ALWAYS;</span>
<a href="#l26.2638"></a><span id="l26.2638" class="difflineminus">-        toAddrStr = validKeyList.join(&quot;, &quot;);</span>
<a href="#l26.2639"></a><span id="l26.2639" class="difflineminus">-      }</span>
<a href="#l26.2640"></a><span id="l26.2640" class="difflineminus">-</span>
<a href="#l26.2641"></a><span id="l26.2641" class="difflineminus">-      for (let i in details.keyMap) {</span>
<a href="#l26.2642"></a><span id="l26.2642" class="difflineminus">-        if (i.search(/^0x[0-9A-F]+$/i) &lt; 0) {</span>
<a href="#l26.2643"></a><span id="l26.2643" class="difflineminus">-          keyMap[i] = details.keyMap[i];</span>
<a href="#l26.2644"></a><span id="l26.2644" class="difflineminus">-        }</span>
<a href="#l26.2645"></a><span id="l26.2645" class="difflineminus">-      }</span>
<a href="#l26.2646"></a><span id="l26.2646" class="difflineminus">-    }</span>
<a href="#l26.2647"></a><span id="l26.2647" class="difflineminus">-</span>
<a href="#l26.2648"></a><span id="l26.2648" class="difflineminus">-    // process final state</span>
<a href="#l26.2649"></a><span id="l26.2649" class="difflineminus">-    this.processFinalState(sendFlags);</span>
<a href="#l26.2650"></a><span id="l26.2650" class="difflineminus">-</span>
<a href="#l26.2651"></a><span id="l26.2651" class="difflineminus">-    // final handling of conflicts:</span>
<a href="#l26.2652"></a><span id="l26.2652" class="difflineminus">-    // - pgpMime conflicts always result into pgpMime = 0/'never'</span>
<a href="#l26.2653"></a><span id="l26.2653" class="difflineminus">-    if (this.statusPGPMime == EnigmailConstants.ENIG_FINAL_CONFLICT) {</span>
<a href="#l26.2654"></a><span id="l26.2654" class="difflineminus">-      this.statusPGPMime = EnigmailConstants.ENIG_FINAL_NO;</span>
<a href="#l26.2655"></a><span id="l26.2655" class="difflineminus">-    }</span>
<a href="#l26.2656"></a><span id="l26.2656" class="difflineminus">-    // - encrypt/sign conflicts result into result 0/'never'</span>
<a href="#l26.2657"></a><span id="l26.2657" class="difflineminus">-    //   with possible dialog to give a corresponding feedback</span>
<a href="#l26.2658"></a><span id="l26.2658" class="difflineminus">-    var conflictFound = false;</span>
<a href="#l26.2659"></a><span id="l26.2659" class="difflineminus">-    if (this.statusEncrypted == EnigmailConstants.ENIG_FINAL_CONFLICT) {</span>
<a href="#l26.2660"></a><span id="l26.2660" class="difflineminus">-      this.statusEncrypted = EnigmailConstants.ENIG_FINAL_NO;</span>
<a href="#l26.2661"></a><span id="l26.2661" class="difflineminus">-      conflictFound = true;</span>
<a href="#l26.2662"></a><span id="l26.2662" class="difflineminus">-    }</span>
<a href="#l26.2663"></a><span id="l26.2663" class="difflineminus">-    if (this.statusSigned == EnigmailConstants.ENIG_FINAL_CONFLICT) {</span>
<a href="#l26.2664"></a><span id="l26.2664" class="difflineminus">-      this.statusSigned = EnigmailConstants.ENIG_FINAL_NO;</span>
<a href="#l26.2665"></a><span id="l26.2665" class="difflineminus">-      conflictFound = true;</span>
<a href="#l26.2666"></a><span id="l26.2666" class="difflineminus">-    }</span>
<a href="#l26.2667"></a><span id="l26.2667" class="difflineminus">-    if (conflictFound) {</span>
<a href="#l26.2668"></a><span id="l26.2668" class="difflineminus">-      if (!Enigmail.hlp.processConflicts(this.statusEncrypted == EnigmailConstants.ENIG_FINAL_YES || this.statusEncrypted == EnigmailConstants.ENIG_FINAL_FORCEYES,</span>
<a href="#l26.2669"></a><span id="l26.2669" class="difflineminus">-          this.statusSigned == EnigmailConstants.ENIG_FINAL_YES || this.statusSigned == EnigmailConstants.ENIG_FINAL_FORCEYES)) {</span>
<a href="#l26.2670"></a><span id="l26.2670" class="difflineminus">-        return null;</span>
<a href="#l26.2671"></a><span id="l26.2671" class="difflineminus">-      }</span>
<a href="#l26.2672"></a><span id="l26.2672" class="difflineminus">-    }</span>
<a href="#l26.2673"></a><span id="l26.2673" class="difflineminus">-</span>
<a href="#l26.2674"></a><span id="l26.2674" class="difflineminus">-    // process final sendMode</span>
<a href="#l26.2675"></a><span id="l26.2675" class="difflineminus">-    //  ENIG_FINAL_CONFLICT no longer possible</span>
<a href="#l26.2676"></a><span id="l26.2676" class="difflineminus">-    switch (this.statusEncrypted) {</span>
<a href="#l26.2677"></a><span id="l26.2677" class="difflineminus">-      case EnigmailConstants.ENIG_FINAL_NO:</span>
<a href="#l26.2678"></a><span id="l26.2678" class="difflineminus">-      case EnigmailConstants.ENIG_FINAL_FORCENO:</span>
<a href="#l26.2679"></a><span id="l26.2679" class="difflineminus">-        sendFlags &amp;= ~ENCRYPT;</span>
<a href="#l26.2680"></a><span id="l26.2680" class="difflineminus">-        break;</span>
<a href="#l26.2681"></a><span id="l26.2681" class="difflineminus">-      case EnigmailConstants.ENIG_FINAL_YES:</span>
<a href="#l26.2682"></a><span id="l26.2682" class="difflineminus">-      case EnigmailConstants.ENIG_FINAL_FORCEYES:</span>
<a href="#l26.2683"></a><span id="l26.2683" class="difflineminus">-        sendFlags |= ENCRYPT;</span>
<a href="#l26.2684"></a><span id="l26.2684" class="difflineminus">-        break;</span>
<a href="#l26.2685"></a><span id="l26.2685" class="difflineminus">-    }</span>
<a href="#l26.2686"></a><span id="l26.2686" class="difflineminus">-    switch (this.statusSigned) {</span>
<a href="#l26.2687"></a><span id="l26.2687" class="difflineminus">-      case EnigmailConstants.ENIG_FINAL_NO:</span>
<a href="#l26.2688"></a><span id="l26.2688" class="difflineminus">-      case EnigmailConstants.ENIG_FINAL_FORCENO:</span>
<a href="#l26.2689"></a><span id="l26.2689" class="difflineminus">-        sendFlags &amp;= ~SIGN;</span>
<a href="#l26.2690"></a><span id="l26.2690" class="difflineminus">-        break;</span>
<a href="#l26.2691"></a><span id="l26.2691" class="difflineminus">-      case EnigmailConstants.ENIG_FINAL_YES:</span>
<a href="#l26.2692"></a><span id="l26.2692" class="difflineminus">-      case EnigmailConstants.ENIG_FINAL_FORCEYES:</span>
<a href="#l26.2693"></a><span id="l26.2693" class="difflineminus">-        sendFlags |= SIGN;</span>
<a href="#l26.2694"></a><span id="l26.2694" class="difflineminus">-        break;</span>
<a href="#l26.2695"></a><span id="l26.2695" class="difflineminus">-    }</span>
<a href="#l26.2696"></a><span id="l26.2696" class="difflineminus">-    switch (this.statusPGPMime) {</span>
<a href="#l26.2697"></a><span id="l26.2697" class="difflineminus">-      case EnigmailConstants.ENIG_FINAL_NO:</span>
<a href="#l26.2698"></a><span id="l26.2698" class="difflineminus">-      case EnigmailConstants.ENIG_FINAL_FORCENO:</span>
<a href="#l26.2699"></a><span id="l26.2699" class="difflineminus">-        sendFlags &amp;= ~EnigmailConstants.SEND_PGP_MIME;</span>
<a href="#l26.2700"></a><span id="l26.2700" class="difflineminus">-        break;</span>
<a href="#l26.2701"></a><span id="l26.2701" class="difflineminus">-      case EnigmailConstants.ENIG_FINAL_YES:</span>
<a href="#l26.2702"></a><span id="l26.2702" class="difflineminus">-      case EnigmailConstants.ENIG_FINAL_FORCEYES:</span>
<a href="#l26.2703"></a><span id="l26.2703" class="difflineminus">-        sendFlags |= EnigmailConstants.SEND_PGP_MIME;</span>
<a href="#l26.2704"></a><span id="l26.2704" class="difflineminus">-        break;</span>
<a href="#l26.2705"></a><span id="l26.2705" class="difflineminus">-    }</span>
<a href="#l26.2706"></a><span id="l26.2706" class="difflineminus">-</span>
<a href="#l26.2707"></a><span id="l26.2707" class="difflineminus">-    // get keys according to rules for bcc addresses:</span>
<a href="#l26.2708"></a><span id="l26.2708" class="difflineminus">-    // - matchedKeysObj will contain the keys and the remaining bccAddrStr elements</span>
<a href="#l26.2709"></a><span id="l26.2709" class="difflineminus">-    // - NOTE: bcc recipients are ignored when in general computing whether to sign or encrypt or pgpMime</span>
<a href="#l26.2710"></a><span id="l26.2710" class="difflineminus">-    if (!EnigmailRules.mapAddrsToKeys(bccAddrStr,</span>
<a href="#l26.2711"></a><span id="l26.2711" class="difflineminus">-        forceRecipientSettings, // true =&gt; start dialog for addrs without any key</span>
<a href="#l26.2712"></a><span id="l26.2712" class="difflineminus">-        window,</span>
<a href="#l26.2713"></a><span id="l26.2713" class="difflineminus">-        matchedKeysObj,</span>
<a href="#l26.2714"></a><span id="l26.2714" class="difflineminus">-        flagsObj)) {</span>
<a href="#l26.2715"></a><span id="l26.2715" class="difflineminus">-      return null;</span>
<a href="#l26.2716"></a><span id="l26.2716" class="difflineminus">-    }</span>
<a href="#l26.2717"></a><span id="l26.2717" class="difflineminus">-    if (matchedKeysObj.value) {</span>
<a href="#l26.2718"></a><span id="l26.2718" class="difflineminus">-      bccAddrStr = matchedKeysObj.value;</span>
<a href="#l26.2719"></a><span id="l26.2719" class="difflineminus">-      EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.processRules(): after mapAddrsToKeys() bccAddrStr=\&quot;&quot; + bccAddrStr + &quot;\&quot;\n&quot;);</span>
<a href="#l26.2720"></a><span id="l26.2720" class="difflineminus">-    }</span>
<a href="#l26.2721"></a><span id="l26.2721" class="difflineminus">-</span>
<a href="#l26.2722"></a><span id="l26.2722" class="difflineminus">-    EnigmailLog.DEBUG(&quot;  &lt;=== processRules()\n&quot;);</span>
<a href="#l26.2723"></a><span id="l26.2723" class="difflineminus">-    return {</span>
<a href="#l26.2724"></a><span id="l26.2724" class="difflineminus">-      sendFlags: sendFlags,</span>
<a href="#l26.2725"></a><span id="l26.2725" class="difflineminus">-      optSendFlags: optSendFlags,</span>
<a href="#l26.2726"></a><span id="l26.2726" class="difflineminus">-      toAddr: toAddrStr,</span>
<a href="#l26.2727"></a><span id="l26.2727" class="difflineminus">-      bccAddr: bccAddrStr,</span>
<a href="#l26.2728"></a><span id="l26.2728" class="difflineminus">-      didRefreshKeyList: didRefreshKeyList,</span>
<a href="#l26.2729"></a><span id="l26.2729" class="difflineminus">-      keyMap: keyMap</span>
<a href="#l26.2730"></a><span id="l26.2730" class="difflineminus">-    };</span>
<a href="#l26.2731"></a><span id="l26.2731" class="difflineminus">-  },</span>
<a href="#l26.2732"></a><span id="l26.2732" class="difflineminus">-</span>
<a href="#l26.2733"></a><span id="l26.2733" class="difflineminus">-</span>
<a href="#l26.2734"></a><span id="l26.2734" class="difflineminus">-  /* encrypt a test message to see whether we have all necessary keys</span>
<a href="#l26.2735"></a><span id="l26.2735" class="difflineminus">-   *</span>
<a href="#l26.2736"></a><span id="l26.2736" class="difflineminus">-   * @sendFlags:    all current combined/processed send flags (incl. optSendFlags)</span>
<a href="#l26.2737"></a><span id="l26.2737" class="difflineminus">-   * @optSendFlags: may only be SEND_ALWAYS_TRUST or SEND_ENCRYPT_TO_SELF</span>
<a href="#l26.2738"></a><span id="l26.2738" class="difflineminus">-   * @fromAddr:     from email</span>
<a href="#l26.2739"></a><span id="l26.2739" class="difflineminus">-   * @toAddrStr:    comma separated string of keys and unprocessed to/cc emails</span>
<a href="#l26.2740"></a><span id="l26.2740" class="difflineminus">-   * @bccAddrStr:   comma separated string of keys and unprocessed bcc emails</span>
<a href="#l26.2741"></a><span id="l26.2741" class="difflineminus">-   * @bccAddrList:  bcc receivers</span>
<a href="#l26.2742"></a><span id="l26.2742" class="difflineminus">-   * @return:       doRulesProcessingAgain: start with rule processing once more</span>
<a href="#l26.2743"></a><span id="l26.2743" class="difflineminus">-   *                or null (cancel sending the email)</span>
<a href="#l26.2744"></a><span id="l26.2744" class="difflineminus">-   */</span>
<a href="#l26.2745"></a><span id="l26.2745" class="difflineminus">-  encryptTestMessage: function(enigmailSvc, sendFlags, optSendFlags, fromAddr, toAddrStr, bccAddrStr, bccAddrList, refresh) {</span>
<a href="#l26.2746"></a><span id="l26.2746" class="difflineminus">-    EnigmailLog.DEBUG(&quot;=====&gt; encryptTestMessage()\n&quot;);</span>
<a href="#l26.2747"></a><span id="l26.2747" class="difflineminus">-</span>
<a href="#l26.2748"></a><span id="l26.2748" class="difflineminus">-    const SIGN = EnigmailConstants.SEND_SIGNED;</span>
<a href="#l26.2749"></a><span id="l26.2749" class="difflineminus">-    const ENCRYPT = EnigmailConstants.SEND_ENCRYPTED;</span>
<a href="#l26.2750"></a><span id="l26.2750" class="difflineminus">-</span>
<a href="#l26.2751"></a><span id="l26.2751" class="difflineminus">-    var testCipher = null;</span>
<a href="#l26.2752"></a><span id="l26.2752" class="difflineminus">-    var testExitCodeObj = {};</span>
<a href="#l26.2753"></a><span id="l26.2753" class="difflineminus">-    var testStatusFlagsObj = {};</span>
<a href="#l26.2754"></a><span id="l26.2754" class="difflineminus">-    var testErrorMsgObj = {};</span>
<a href="#l26.2755"></a><span id="l26.2755" class="difflineminus">-</span>
<a href="#l26.2756"></a><span id="l26.2756" class="difflineminus">-    // get keys for remaining email addresses</span>
<a href="#l26.2757"></a><span id="l26.2757" class="difflineminus">-    // - NOTE: This should not be necessary; however, in GPG there is a problem:</span>
<a href="#l26.2758"></a><span id="l26.2758" class="difflineminus">-    //         Only the first key found for an email is used.</span>
<a href="#l26.2759"></a><span id="l26.2759" class="difflineminus">-    //         If this is invalid, no other keys are tested.</span>
<a href="#l26.2760"></a><span id="l26.2760" class="difflineminus">-    //         Thus, WE make it better here in enigmail until the bug is fixed.</span>
<a href="#l26.2761"></a><span id="l26.2761" class="difflineminus">-    var details = {}; // will contain msgList[] afterwards</span>
<a href="#l26.2762"></a><span id="l26.2762" class="difflineminus">-    if (EnigmailPrefs.getPref(&quot;assignKeysByEmailAddr&quot;)) {</span>
<a href="#l26.2763"></a><span id="l26.2763" class="difflineminus">-      var validKeyList = Enigmail.hlp.validKeysForAllRecipients(toAddrStr, details);</span>
<a href="#l26.2764"></a><span id="l26.2764" class="difflineminus">-      if (validKeyList) {</span>
<a href="#l26.2765"></a><span id="l26.2765" class="difflineminus">-        toAddrStr = validKeyList.join(&quot;, &quot;);</span>
<a href="#l26.2766"></a><span id="l26.2766" class="difflineminus">-      }</span>
<a href="#l26.2767"></a><span id="l26.2767" class="difflineminus">-    }</span>
<a href="#l26.2768"></a><span id="l26.2768" class="difflineminus">-</span>
<a href="#l26.2769"></a><span id="l26.2769" class="difflineminus">-    // encrypt test message for test recipients</span>
<a href="#l26.2770"></a><span id="l26.2770" class="difflineminus">-    var testPlain = &quot;Test Message&quot;;</span>
<a href="#l26.2771"></a><span id="l26.2771" class="difflineminus">-    var testUiFlags = EnigmailConstants.UI_TEST;</span>
<a href="#l26.2772"></a><span id="l26.2772" class="difflineminus">-    var testSendFlags = EnigmailConstants.SEND_TEST | ENCRYPT | optSendFlags;</span>
<a href="#l26.2773"></a><span id="l26.2773" class="difflineminus">-    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.encryptTestMessage(): call encryptMessage() for fromAddr=\&quot;&quot; + fromAddr + &quot;\&quot; toAddrStr=\&quot;&quot; + toAddrStr + &quot;\&quot; bccAddrStr=\&quot;&quot; +</span>
<a href="#l26.2774"></a><span id="l26.2774" class="difflineminus">-      bccAddrStr + &quot;\&quot;\n&quot;);</span>
<a href="#l26.2775"></a><span id="l26.2775" class="difflineminus">-    testCipher = EnigmailEncryption.encryptMessage(window, testUiFlags, testPlain,</span>
<a href="#l26.2776"></a><span id="l26.2776" class="difflineminus">-      fromAddr, toAddrStr, bccAddrStr,</span>
<a href="#l26.2777"></a><span id="l26.2777" class="difflineminus">-      testSendFlags,</span>
<a href="#l26.2778"></a><span id="l26.2778" class="difflineminus">-      testExitCodeObj,</span>
<a href="#l26.2779"></a><span id="l26.2779" class="difflineminus">-      testStatusFlagsObj,</span>
<a href="#l26.2780"></a><span id="l26.2780" class="difflineminus">-      testErrorMsgObj);</span>
<a href="#l26.2781"></a><span id="l26.2781" class="difflineminus">-</span>
<a href="#l26.2782"></a><span id="l26.2782" class="difflineminus">-    if (testStatusFlagsObj.value &amp; (EnigmailConstants.INVALID_RECIPIENT | EnigmailConstants.NO_SECKEY)) {</span>
<a href="#l26.2783"></a><span id="l26.2783" class="difflineminus">-      // check if own key is invalid</span>
<a href="#l26.2784"></a><span id="l26.2784" class="difflineminus">-      EnigmailDialog.alert(window, testErrorMsgObj.value);</span>
<a href="#l26.2785"></a><span id="l26.2785" class="difflineminus">-      return null;</span>
<a href="#l26.2786"></a><span id="l26.2786" class="difflineminus">-    }</span>
<a href="#l26.2787"></a><span id="l26.2787" class="difflineminus">-</span>
<a href="#l26.2788"></a><span id="l26.2788" class="difflineminus">-    // if</span>
<a href="#l26.2789"></a><span id="l26.2789" class="difflineminus">-    // - &quot;always ask/manually&quot; (even if all keys were found) or</span>
<a href="#l26.2790"></a><span id="l26.2790" class="difflineminus">-    // - unless &quot;ask for missing keys&quot;:</span>
<a href="#l26.2791"></a><span id="l26.2791" class="difflineminus">-    //   - we have an invalid recipient or</span>
<a href="#l26.2792"></a><span id="l26.2792" class="difflineminus">-    //   - we could not resolve any/all keys</span>
<a href="#l26.2793"></a><span id="l26.2793" class="difflineminus">-    //     (due to disabled &quot;assignKeysByEmailAddr&quot;&quot; or multiple keys with same trust for a recipient)</span>
<a href="#l26.2794"></a><span id="l26.2794" class="difflineminus">-    // start the dialog for user selected keys</span>
<a href="#l26.2795"></a><span id="l26.2795" class="difflineminus">-    if (EnigmailPrefs.getPref(&quot;assignKeysManuallyAlways&quot;) ||</span>
<a href="#l26.2796"></a><span id="l26.2796" class="difflineminus">-      (((testStatusFlagsObj.value &amp; EnigmailConstants.INVALID_RECIPIENT) ||</span>
<a href="#l26.2797"></a><span id="l26.2797" class="difflineminus">-          toAddrStr.indexOf('@') &gt;= 0) &amp;&amp;</span>
<a href="#l26.2798"></a><span id="l26.2798" class="difflineminus">-        EnigmailPrefs.getPref(&quot;assignKeysManuallyIfMissing&quot;)) ||</span>
<a href="#l26.2799"></a><span id="l26.2799" class="difflineminus">-      (details &amp;&amp; details.errArray &amp;&amp; details.errArray.length &gt; 0)</span>
<a href="#l26.2800"></a><span id="l26.2800" class="difflineminus">-    ) {</span>
<a href="#l26.2801"></a><span id="l26.2801" class="difflineminus">-</span>
<a href="#l26.2802"></a><span id="l26.2802" class="difflineminus">-      // check for invalid recipient keys</span>
<a href="#l26.2803"></a><span id="l26.2803" class="difflineminus">-      var resultObj = {</span>
<a href="#l26.2804"></a><span id="l26.2804" class="difflineminus">-        foundKeys: false</span>
<a href="#l26.2805"></a><span id="l26.2805" class="difflineminus">-      };</span>
<a href="#l26.2806"></a><span id="l26.2806" class="difflineminus">-      var inputObj = {};</span>
<a href="#l26.2807"></a><span id="l26.2807" class="difflineminus">-      inputObj.toAddr = toAddrStr;</span>
<a href="#l26.2808"></a><span id="l26.2808" class="difflineminus">-      inputObj.invalidAddr = Enigmail.hlp.getInvalidAddress(testErrorMsgObj.value);</span>
<a href="#l26.2809"></a><span id="l26.2809" class="difflineminus">-      if (details &amp;&amp; details.errArray &amp;&amp; details.errArray.length &gt; 0) {</span>
<a href="#l26.2810"></a><span id="l26.2810" class="difflineminus">-        inputObj.errArray = details.errArray;</span>
<a href="#l26.2811"></a><span id="l26.2811" class="difflineminus">-      }</span>
<a href="#l26.2812"></a><span id="l26.2812" class="difflineminus">-</span>
<a href="#l26.2813"></a><span id="l26.2813" class="difflineminus">-      // prepare dialog options:</span>
<a href="#l26.2814"></a><span id="l26.2814" class="difflineminus">-      inputObj.options = &quot;multisel&quot;;</span>
<a href="#l26.2815"></a><span id="l26.2815" class="difflineminus">-      if (EnigmailPrefs.getPref(&quot;assignKeysByRules&quot;)) {</span>
<a href="#l26.2816"></a><span id="l26.2816" class="difflineminus">-        inputObj.options += &quot;,rulesOption&quot;; // enable button to create per-recipient rule</span>
<a href="#l26.2817"></a><span id="l26.2817" class="difflineminus">-      }</span>
<a href="#l26.2818"></a><span id="l26.2818" class="difflineminus">-      if (EnigmailPrefs.getPref(&quot;assignKeysManuallyAlways&quot;)) {</span>
<a href="#l26.2819"></a><span id="l26.2819" class="difflineminus">-        inputObj.options += &quot;,noforcedisp&quot;;</span>
<a href="#l26.2820"></a><span id="l26.2820" class="difflineminus">-      }</span>
<a href="#l26.2821"></a><span id="l26.2821" class="difflineminus">-      if (!(sendFlags &amp; SIGN)) {</span>
<a href="#l26.2822"></a><span id="l26.2822" class="difflineminus">-        inputObj.options += &quot;,unsigned&quot;;</span>
<a href="#l26.2823"></a><span id="l26.2823" class="difflineminus">-      }</span>
<a href="#l26.2824"></a><span id="l26.2824" class="difflineminus">-      if (this.trustAllKeys) {</span>
<a href="#l26.2825"></a><span id="l26.2825" class="difflineminus">-        inputObj.options += &quot;,trustallkeys&quot;;</span>
<a href="#l26.2826"></a><span id="l26.2826" class="difflineminus">-      }</span>
<a href="#l26.2827"></a><span id="l26.2827" class="difflineminus">-      if (sendFlags &amp; EnigmailConstants.SEND_LATER) {</span>
<a href="#l26.2828"></a><span id="l26.2828" class="difflineminus">-        let sendLaterLabel = EnigmailLocale.getString(&quot;sendLaterCmd.label&quot;);</span>
<a href="#l26.2829"></a><span id="l26.2829" class="difflineminus">-        inputObj.options += &quot;,sendlabel=&quot; + sendLaterLabel;</span>
<a href="#l26.2830"></a><span id="l26.2830" class="difflineminus">-      }</span>
<a href="#l26.2831"></a><span id="l26.2831" class="difflineminus">-      inputObj.options += &quot;,&quot;;</span>
<a href="#l26.2832"></a><span id="l26.2832" class="difflineminus">-      inputObj.dialogHeader = EnigmailLocale.getString(&quot;recipientsSelectionHdr&quot;);</span>
<a href="#l26.2833"></a><span id="l26.2833" class="difflineminus">-</span>
<a href="#l26.2834"></a><span id="l26.2834" class="difflineminus">-      // perform key selection dialog:</span>
<a href="#l26.2835"></a><span id="l26.2835" class="difflineminus">-      window.openDialog(&quot;chrome://openpgp/content/ui/enigmailKeySelection.xhtml&quot;, &quot;&quot;,</span>
<a href="#l26.2836"></a><span id="l26.2836" class="difflineminus">-        &quot;dialog,modal,centerscreen,resizable&quot;, inputObj, resultObj);</span>
<a href="#l26.2837"></a><span id="l26.2837" class="difflineminus">-</span>
<a href="#l26.2838"></a><span id="l26.2838" class="difflineminus">-      // process result from key selection dialog:</span>
<a href="#l26.2839"></a><span id="l26.2839" class="difflineminus">-      try {</span>
<a href="#l26.2840"></a><span id="l26.2840" class="difflineminus">-        // CANCEL:</span>
<a href="#l26.2841"></a><span id="l26.2841" class="difflineminus">-        if (resultObj.cancelled) {</span>
<a href="#l26.2842"></a><span id="l26.2842" class="difflineminus">-          return null;</span>
<a href="#l26.2843"></a><span id="l26.2843" class="difflineminus">-        }</span>
<a href="#l26.2844"></a><span id="l26.2844" class="difflineminus">-</span>
<a href="#l26.2845"></a><span id="l26.2845" class="difflineminus">-</span>
<a href="#l26.2846"></a><span id="l26.2846" class="difflineminus">-        // repeat checking of rules etc. (e.g. after importing new key)</span>
<a href="#l26.2847"></a><span id="l26.2847" class="difflineminus">-        if (resultObj.repeatEvaluation) {</span>
<a href="#l26.2848"></a><span id="l26.2848" class="difflineminus">-          // THIS is the place that triggers a second iteration</span>
<a href="#l26.2849"></a><span id="l26.2849" class="difflineminus">-          let returnObj = {</span>
<a href="#l26.2850"></a><span id="l26.2850" class="difflineminus">-            doRulesProcessingAgain: true,</span>
<a href="#l26.2851"></a><span id="l26.2851" class="difflineminus">-            createNewRule: false,</span>
<a href="#l26.2852"></a><span id="l26.2852" class="difflineminus">-            sendFlags: sendFlags,</span>
<a href="#l26.2853"></a><span id="l26.2853" class="difflineminus">-            toAddrStr: toAddrStr,</span>
<a href="#l26.2854"></a><span id="l26.2854" class="difflineminus">-            bccAddrStr: bccAddrStr</span>
<a href="#l26.2855"></a><span id="l26.2855" class="difflineminus">-          };</span>
<a href="#l26.2856"></a><span id="l26.2856" class="difflineminus">-</span>
<a href="#l26.2857"></a><span id="l26.2857" class="difflineminus">-          // &quot;Create per recipient rule(s)&quot;:</span>
<a href="#l26.2858"></a><span id="l26.2858" class="difflineminus">-          if (resultObj.perRecipientRules &amp;&amp; this.enableRules) {</span>
<a href="#l26.2859"></a><span id="l26.2859" class="difflineminus">-            // do an extra round because the user wants to set a PGP rule</span>
<a href="#l26.2860"></a><span id="l26.2860" class="difflineminus">-            returnObj.createNewRule = true;</span>
<a href="#l26.2861"></a><span id="l26.2861" class="difflineminus">-          }</span>
<a href="#l26.2862"></a><span id="l26.2862" class="difflineminus">-</span>
<a href="#l26.2863"></a><span id="l26.2863" class="difflineminus">-          return returnObj;</span>
<a href="#l26.2864"></a><span id="l26.2864" class="difflineminus">-        }</span>
<a href="#l26.2865"></a><span id="l26.2865" class="difflineminus">-</span>
<a href="#l26.2866"></a><span id="l26.2866" class="difflineminus">-        // process OK button:</span>
<a href="#l26.2867"></a><span id="l26.2867" class="difflineminus">-        if (resultObj.encrypt) {</span>
<a href="#l26.2868"></a><span id="l26.2868" class="difflineminus">-          sendFlags |= ENCRYPT; // should anyway be set</span>
<a href="#l26.2869"></a><span id="l26.2869" class="difflineminus">-          if (bccAddrList.length &gt; 0) {</span>
<a href="#l26.2870"></a><span id="l26.2870" class="difflineminus">-            toAddrStr = &quot;&quot;;</span>
<a href="#l26.2871"></a><span id="l26.2871" class="difflineminus">-            bccAddrStr = resultObj.userList.join(&quot;, &quot;);</span>
<a href="#l26.2872"></a><span id="l26.2872" class="difflineminus">-          }</span>
<a href="#l26.2873"></a><span id="l26.2873" class="difflineminus">-          else {</span>
<a href="#l26.2874"></a><span id="l26.2874" class="difflineminus">-            toAddrStr = resultObj.userList.join(&quot;, &quot;);</span>
<a href="#l26.2875"></a><span id="l26.2875" class="difflineminus">-            bccAddrStr = &quot;&quot;;</span>
<a href="#l26.2876"></a><span id="l26.2876" class="difflineminus">-          }</span>
<a href="#l26.2877"></a><span id="l26.2877" class="difflineminus">-        }</span>
<a href="#l26.2878"></a><span id="l26.2878" class="difflineminus">-        else {</span>
<a href="#l26.2879"></a><span id="l26.2879" class="difflineminus">-          // encryption explicitely turned off</span>
<a href="#l26.2880"></a><span id="l26.2880" class="difflineminus">-          sendFlags &amp;= ~ENCRYPT;</span>
<a href="#l26.2881"></a><span id="l26.2881" class="difflineminus">-          // counts as forced non-encryption</span>
<a href="#l26.2882"></a><span id="l26.2882" class="difflineminus">-          // (no internal error if different state was processed before)</span>
<a href="#l26.2883"></a><span id="l26.2883" class="difflineminus">-          this.statusEncrypted = EnigmailConstants.ENIG_FINAL_NO;</span>
<a href="#l26.2884"></a><span id="l26.2884" class="difflineminus">-          this.statusEncryptedInStatusBar = EnigmailConstants.ENIG_FINAL_NO;</span>
<a href="#l26.2885"></a><span id="l26.2885" class="difflineminus">-        }</span>
<a href="#l26.2886"></a><span id="l26.2886" class="difflineminus">-        if (resultObj.sign) {</span>
<a href="#l26.2887"></a><span id="l26.2887" class="difflineminus">-          sendFlags |= SIGN;</span>
<a href="#l26.2888"></a><span id="l26.2888" class="difflineminus">-        }</span>
<a href="#l26.2889"></a><span id="l26.2889" class="difflineminus">-        else {</span>
<a href="#l26.2890"></a><span id="l26.2890" class="difflineminus">-          sendFlags &amp;= ~SIGN;</span>
<a href="#l26.2891"></a><span id="l26.2891" class="difflineminus">-        }</span>
<a href="#l26.2892"></a><span id="l26.2892" class="difflineminus">-        testCipher = &quot;ok&quot;;</span>
<a href="#l26.2893"></a><span id="l26.2893" class="difflineminus">-        testExitCodeObj.value = 0;</span>
<a href="#l26.2894"></a><span id="l26.2894" class="difflineminus">-      }</span>
<a href="#l26.2895"></a><span id="l26.2895" class="difflineminus">-      catch (ex) {</span>
<a href="#l26.2896"></a><span id="l26.2896" class="difflineminus">-        // cancel pressed -&gt; don't send mail</span>
<a href="#l26.2897"></a><span id="l26.2897" class="difflineminus">-        return null;</span>
<a href="#l26.2898"></a><span id="l26.2898" class="difflineminus">-      }</span>
<a href="#l26.2899"></a><span id="l26.2899" class="difflineminus">-    }</span>
<a href="#l26.2900"></a><span id="l26.2900" class="difflineminus">-    // If test encryption failed and never ask manually, turn off default encryption</span>
<a href="#l26.2901"></a><span id="l26.2901" class="difflineminus">-    if ((!testCipher || (testExitCodeObj.value !== 0)) &amp;&amp;</span>
<a href="#l26.2902"></a><span id="l26.2902" class="difflineminus">-      !EnigmailPrefs.getPref(&quot;assignKeysManuallyIfMissing&quot;) &amp;&amp;</span>
<a href="#l26.2903"></a><span id="l26.2903" class="difflineminus">-      !EnigmailPrefs.getPref(&quot;assignKeysManuallyAlways&quot;)) {</span>
<a href="#l26.2904"></a><span id="l26.2904" class="difflineminus">-      sendFlags &amp;= ~ENCRYPT;</span>
<a href="#l26.2905"></a><span id="l26.2905" class="difflineminus">-      this.statusEncrypted = EnigmailConstants.ENIG_FINAL_NO;</span>
<a href="#l26.2906"></a><span id="l26.2906" class="difflineminus">-      this.statusEncryptedInStatusBar = EnigmailConstants.ENIG_FINAL_NO;</span>
<a href="#l26.2907"></a><span id="l26.2907" class="difflineminus">-      EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.encryptTestMessage: No default encryption because test failed\n&quot;);</span>
<a href="#l26.2908"></a><span id="l26.2908" class="difflineminus">-    }</span>
<a href="#l26.2909"></a><span id="l26.2909" class="difflineminus">-    EnigmailLog.DEBUG(&quot;  &lt;=== encryptTestMessage()\n&quot;);</span>
<a href="#l26.2910"></a><span id="l26.2910" class="difflineminus">-    return {</span>
<a href="#l26.2911"></a><span id="l26.2911" class="difflineminus">-      doRulesProcessingAgain: false,</span>
<a href="#l26.2912"></a><span id="l26.2912" class="difflineminus">-      createNewRule: false,</span>
<a href="#l26.2913"></a><span id="l26.2913" class="difflineminus">-      sendFlags: sendFlags,</span>
<a href="#l26.2914"></a><span id="l26.2914" class="difflineminus">-      toAddrStr: toAddrStr,</span>
<a href="#l26.2915"></a><span id="l26.2915" class="difflineminus">-      bccAddrStr: bccAddrStr</span>
<a href="#l26.2916"></a><span id="l26.2916" class="difflineminus">-    };</span>
<a href="#l26.2917"></a><span id="l26.2917" class="difflineminus">-  },</span>
<a href="#l26.2918"></a><span id="l26.2918" class="difflineminus">-</span>
<a href="#l26.2919"></a><span id="l26.2919">   /* Manage the wrapping of inline signed mails</span>
<a href="#l26.2920"></a><span id="l26.2920">    *</span>
<a href="#l26.2921"></a><span id="l26.2921">    * @wrapresultObj: Result:</span>
<a href="#l26.2922"></a><span id="l26.2922">    * @wrapresultObj.cancelled, true if send operation is to be cancelled, else false</span>
<a href="#l26.2923"></a><span id="l26.2923">    * @wrapresultObj.usePpgMime, true if message send option was changed to PGP/MIME, else false</span>
<a href="#l26.2924"></a><span id="l26.2924">    */</span>
<a href="#l26.2925"></a><span id="l26.2925"> </span>
<a href="#l26.2926"></a><span id="l26.2926">   wrapInLine: function(wrapresultObj) {</span>
<a href="#l26.2927"></a><span id="l26.2927" class="difflineat">@@ -3186,26 +2028,27 @@ Enigmail.msg = {</span>
<a href="#l26.2928"></a><span id="l26.2928"> </span>
<a href="#l26.2929"></a><span id="l26.2929">   },</span>
<a href="#l26.2930"></a><span id="l26.2930"> </span>
<a href="#l26.2931"></a><span id="l26.2931">   // Save draft message. We do not want most of the other processing for encrypted mails here...</span>
<a href="#l26.2932"></a><span id="l26.2932">   saveDraftMessage: function() {</span>
<a href="#l26.2933"></a><span id="l26.2933">     EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: saveDraftMessage()\n&quot;);</span>
<a href="#l26.2934"></a><span id="l26.2934"> </span>
<a href="#l26.2935"></a><span id="l26.2935"> </span>
<a href="#l26.2936"></a><span id="l26.2936" class="difflineminus">-    let doEncrypt = this.isEnigmailEnabled() &amp;&amp; this.identity.getBoolAttribute(&quot;autoEncryptDrafts&quot;);</span>
<a href="#l26.2937"></a><span id="l26.2937" class="difflineplus">+    let doEncrypt = Enigmail.msg.isEnigmailEnabledForIdentity() &amp;&amp; this.identity.getBoolAttribute(&quot;autoEncryptDrafts&quot;);</span>
<a href="#l26.2938"></a><span id="l26.2938"> </span>
<a href="#l26.2939"></a><span id="l26.2939">     this.setDraftStatus(doEncrypt);</span>
<a href="#l26.2940"></a><span id="l26.2940"> </span>
<a href="#l26.2941"></a><span id="l26.2941">     if (!doEncrypt) {</span>
<a href="#l26.2942"></a><span id="l26.2942">       EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: drafts disabled\n&quot;);</span>
<a href="#l26.2943"></a><span id="l26.2943"> </span>
<a href="#l26.2944"></a><span id="l26.2944">       try {</span>
<a href="#l26.2945"></a><span id="l26.2945" class="difflineminus">-        if (EnigmailMimeEncrypt.isEnigmailCompField(Enigmail.msg.getSecurityParams())) {</span>
<a href="#l26.2946"></a><span id="l26.2946" class="difflineminus">-          Enigmail.msg.getSecurityParams().wrappedJSObject.sendFlags = 0;</span>
<a href="#l26.2947"></a><span id="l26.2947" class="difflineplus">+        let p = Enigmail.msg.getSecurityParams();</span>
<a href="#l26.2948"></a><span id="l26.2948" class="difflineplus">+        if (EnigmailMimeEncrypt.isEnigmailCompField(p)) {</span>
<a href="#l26.2949"></a><span id="l26.2949" class="difflineplus">+          p.wrappedJSObject.sendFlags = 0;</span>
<a href="#l26.2950"></a><span id="l26.2950">         }</span>
<a href="#l26.2951"></a><span id="l26.2951">       }</span>
<a href="#l26.2952"></a><span id="l26.2952">       catch (ex) {}</span>
<a href="#l26.2953"></a><span id="l26.2953"> </span>
<a href="#l26.2954"></a><span id="l26.2954">       return true;</span>
<a href="#l26.2955"></a><span id="l26.2955">     }</span>
<a href="#l26.2956"></a><span id="l26.2956"> </span>
<a href="#l26.2957"></a><span id="l26.2957">     let sendFlags = EnigmailConstants.SEND_PGP_MIME | EnigmailConstants.SEND_ENCRYPTED | EnigmailConstants.SAVE_MESSAGE | EnigmailConstants.SEND_ALWAYS_TRUST;</span>
<a href="#l26.2958"></a><span id="l26.2958" class="difflineat">@@ -3218,17 +2061,17 @@ Enigmail.msg = {</span>
<a href="#l26.2959"></a><span id="l26.2959">     let userIdValue = this.getSenderUserId();</span>
<a href="#l26.2960"></a><span id="l26.2960">     if (userIdValue) {</span>
<a href="#l26.2961"></a><span id="l26.2961">       fromAddr = userIdValue;</span>
<a href="#l26.2962"></a><span id="l26.2962">     }</span>
<a href="#l26.2963"></a><span id="l26.2963"> </span>
<a href="#l26.2964"></a><span id="l26.2964">     let enigmailSvc = EnigmailCore.getService(window);</span>
<a href="#l26.2965"></a><span id="l26.2965">     if (!enigmailSvc) return true;</span>
<a href="#l26.2966"></a><span id="l26.2966"> </span>
<a href="#l26.2967"></a><span id="l26.2967" class="difflineminus">-    if (this.preferPgpOverSmime(sendFlags) === 0) return true; // use S/MIME</span>
<a href="#l26.2968"></a><span id="l26.2968" class="difflineplus">+    //if (this.preferPgpOverSmime(sendFlags) === 0) return true; // use S/MIME</span>
<a href="#l26.2969"></a><span id="l26.2969"> </span>
<a href="#l26.2970"></a><span id="l26.2970">     // Try to save draft</span>
<a href="#l26.2971"></a><span id="l26.2971"> </span>
<a href="#l26.2972"></a><span id="l26.2972">     var testCipher = null;</span>
<a href="#l26.2973"></a><span id="l26.2973">     var testExitCodeObj = {};</span>
<a href="#l26.2974"></a><span id="l26.2974">     var testStatusFlagsObj = {};</span>
<a href="#l26.2975"></a><span id="l26.2975">     var testErrorMsgObj = {};</span>
<a href="#l26.2976"></a><span id="l26.2976"> </span>
<a href="#l26.2977"></a><span id="l26.2977" class="difflineat">@@ -3252,39 +2095,40 @@ Enigmail.msg = {</span>
<a href="#l26.2978"></a><span id="l26.2978">             testErrorMsgObj.value);</span>
<a href="#l26.2979"></a><span id="l26.2979">         }</span>
<a href="#l26.2980"></a><span id="l26.2980">         return false;</span>
<a href="#l26.2981"></a><span id="l26.2981">       }</span>
<a href="#l26.2982"></a><span id="l26.2982">     }</span>
<a href="#l26.2983"></a><span id="l26.2983"> </span>
<a href="#l26.2984"></a><span id="l26.2984">     let secInfo;</span>
<a href="#l26.2985"></a><span id="l26.2985"> </span>
<a href="#l26.2986"></a><span id="l26.2986" class="difflineminus">-    if (EnigmailMimeEncrypt.isEnigmailCompField(Enigmail.msg.getSecurityParams())) {</span>
<a href="#l26.2987"></a><span id="l26.2987" class="difflineminus">-      secInfo = Enigmail.msg.getSecurityParams().wrappedJSObject;</span>
<a href="#l26.2988"></a><span id="l26.2988" class="difflineplus">+    let param = Enigmail.msg.getSecurityParams();</span>
<a href="#l26.2989"></a><span id="l26.2989" class="difflineplus">+    if (EnigmailMimeEncrypt.isEnigmailCompField(param)) {</span>
<a href="#l26.2990"></a><span id="l26.2990" class="difflineplus">+      secInfo = param.wrappedJSObject;</span>
<a href="#l26.2991"></a><span id="l26.2991">     }</span>
<a href="#l26.2992"></a><span id="l26.2992">     else {</span>
<a href="#l26.2993"></a><span id="l26.2993">       try {</span>
<a href="#l26.2994"></a><span id="l26.2994" class="difflineminus">-        secInfo = EnigmailMimeEncrypt.createMimeEncrypt(Enigmail.msg.getSecurityParams());</span>
<a href="#l26.2995"></a><span id="l26.2995" class="difflineplus">+        secInfo = EnigmailMimeEncrypt.createMimeEncrypt(param);</span>
<a href="#l26.2996"></a><span id="l26.2996">         if (secInfo) {</span>
<a href="#l26.2997"></a><span id="l26.2997">           Enigmail.msg.setSecurityParams(secInfo);</span>
<a href="#l26.2998"></a><span id="l26.2998">         }</span>
<a href="#l26.2999"></a><span id="l26.2999">       }</span>
<a href="#l26.3000"></a><span id="l26.3000">       catch (ex) {</span>
<a href="#l26.3001"></a><span id="l26.3001">         EnigmailLog.writeException(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.saveDraftMessage&quot;, ex);</span>
<a href="#l26.3002"></a><span id="l26.3002">         return false;</span>
<a href="#l26.3003"></a><span id="l26.3003">       }</span>
<a href="#l26.3004"></a><span id="l26.3004">     }</span>
<a href="#l26.3005"></a><span id="l26.3005"> </span>
<a href="#l26.3006"></a><span id="l26.3006">     secInfo.sendFlags = sendFlags;</span>
<a href="#l26.3007"></a><span id="l26.3007">     secInfo.UIFlags = 0;</span>
<a href="#l26.3008"></a><span id="l26.3008">     secInfo.senderEmailAddr = fromAddr;</span>
<a href="#l26.3009"></a><span id="l26.3009">     secInfo.recipients = fromAddr;</span>
<a href="#l26.3010"></a><span id="l26.3010">     secInfo.bccRecipients = &quot;&quot;;</span>
<a href="#l26.3011"></a><span id="l26.3011">     secInfo.originalSubject = gMsgCompose.compFields.subject;</span>
<a href="#l26.3012"></a><span id="l26.3012" class="difflineminus">-    this.dirty = true;</span>
<a href="#l26.3013"></a><span id="l26.3013" class="difflineplus">+    this.dirty = true; // inconsistent, other places use int. should this be 1 ?</span>
<a href="#l26.3014"></a><span id="l26.3014"> </span>
<a href="#l26.3015"></a><span id="l26.3015">     if (this.protectHeaders) {</span>
<a href="#l26.3016"></a><span id="l26.3016">       gMsgCompose.compFields.subject = &quot;&quot;;</span>
<a href="#l26.3017"></a><span id="l26.3017">     }</span>
<a href="#l26.3018"></a><span id="l26.3018"> </span>
<a href="#l26.3019"></a><span id="l26.3019">     return true;</span>
<a href="#l26.3020"></a><span id="l26.3020">   },</span>
<a href="#l26.3021"></a><span id="l26.3021"> </span>
<a href="#l26.3022"></a><span id="l26.3022" class="difflineat">@@ -3292,67 +2136,16 @@ Enigmail.msg = {</span>
<a href="#l26.3023"></a><span id="l26.3023">     let newSecurityInfo = EnigmailMimeEncrypt.createMimeEncrypt(Enigmail.msg.getSecurityParams());</span>
<a href="#l26.3024"></a><span id="l26.3024"> </span>
<a href="#l26.3025"></a><span id="l26.3025">     if (!newSecurityInfo)</span>
<a href="#l26.3026"></a><span id="l26.3026">       throw Components.results.NS_ERROR_FAILURE;</span>
<a href="#l26.3027"></a><span id="l26.3027"> </span>
<a href="#l26.3028"></a><span id="l26.3028">     Enigmail.msg.setSecurityParams(newSecurityInfo);</span>
<a href="#l26.3029"></a><span id="l26.3029">   },</span>
<a href="#l26.3030"></a><span id="l26.3030"> </span>
<a href="#l26.3031"></a><span id="l26.3031" class="difflineminus">-  isSendConfirmationRequired: function(sendFlags) {</span>
<a href="#l26.3032"></a><span id="l26.3032" class="difflineminus">-    // process whether final confirmation is necessary</span>
<a href="#l26.3033"></a><span id="l26.3033" class="difflineminus">-</span>
<a href="#l26.3034"></a><span id="l26.3034" class="difflineminus">-    const SIGN = EnigmailConstants.SEND_SIGNED;</span>
<a href="#l26.3035"></a><span id="l26.3035" class="difflineminus">-    const ENCRYPT = EnigmailConstants.SEND_ENCRYPTED;</span>
<a href="#l26.3036"></a><span id="l26.3036" class="difflineminus">-</span>
<a href="#l26.3037"></a><span id="l26.3037" class="difflineminus">-    let confirm = false;</span>
<a href="#l26.3038"></a><span id="l26.3038" class="difflineminus">-    let confPref = EnigmailPrefs.getPref(&quot;confirmBeforeSending&quot;);</span>
<a href="#l26.3039"></a><span id="l26.3039" class="difflineminus">-    switch (confPref) {</span>
<a href="#l26.3040"></a><span id="l26.3040" class="difflineminus">-      case 0: // never</span>
<a href="#l26.3041"></a><span id="l26.3041" class="difflineminus">-        confirm = false;</span>
<a href="#l26.3042"></a><span id="l26.3042" class="difflineminus">-        break;</span>
<a href="#l26.3043"></a><span id="l26.3043" class="difflineminus">-      case 1: // always</span>
<a href="#l26.3044"></a><span id="l26.3044" class="difflineminus">-        confirm = true;</span>
<a href="#l26.3045"></a><span id="l26.3045" class="difflineminus">-        break;</span>
<a href="#l26.3046"></a><span id="l26.3046" class="difflineminus">-      case 2: // if send encrypted</span>
<a href="#l26.3047"></a><span id="l26.3047" class="difflineminus">-        confirm = ((sendFlags &amp; ENCRYPT) == ENCRYPT);</span>
<a href="#l26.3048"></a><span id="l26.3048" class="difflineminus">-        break;</span>
<a href="#l26.3049"></a><span id="l26.3049" class="difflineminus">-      case 3: // if send unencrypted</span>
<a href="#l26.3050"></a><span id="l26.3050" class="difflineminus">-        confirm = ((sendFlags &amp; ENCRYPT) === 0);</span>
<a href="#l26.3051"></a><span id="l26.3051" class="difflineminus">-        break;</span>
<a href="#l26.3052"></a><span id="l26.3052" class="difflineminus">-      case 4: // if encryption changed due to rules</span>
<a href="#l26.3053"></a><span id="l26.3053" class="difflineminus">-        confirm = ((sendFlags &amp; ENCRYPT) != (this.sendMode &amp; ENCRYPT));</span>
<a href="#l26.3054"></a><span id="l26.3054" class="difflineminus">-        break;</span>
<a href="#l26.3055"></a><span id="l26.3055" class="difflineminus">-    }</span>
<a href="#l26.3056"></a><span id="l26.3056" class="difflineminus">-</span>
<a href="#l26.3057"></a><span id="l26.3057" class="difflineminus">-    // double check that no internal error did result in broken promise of encryption</span>
<a href="#l26.3058"></a><span id="l26.3058" class="difflineminus">-    // - if NOT send encrypted</span>
<a href="#l26.3059"></a><span id="l26.3059" class="difflineminus">-    //   - although encryption was</span>
<a href="#l26.3060"></a><span id="l26.3060" class="difflineminus">-    //     - the recent processed resulting encryption status or</span>
<a href="#l26.3061"></a><span id="l26.3061" class="difflineminus">-    //     - was signaled in the status bar but is not the outcome now</span>
<a href="#l26.3062"></a><span id="l26.3062" class="difflineminus">-    if ((sendFlags &amp; ENCRYPT) === 0 &amp;&amp;</span>
<a href="#l26.3063"></a><span id="l26.3063" class="difflineminus">-      this.statusPGPMime !== EnigmailConstants.ENIG_FINAL_SMIME &amp;&amp;</span>
<a href="#l26.3064"></a><span id="l26.3064" class="difflineminus">-      this.statusPGPMime !== EnigmailConstants.ENIG_FINAL_FORCESMIME &amp;&amp;</span>
<a href="#l26.3065"></a><span id="l26.3065" class="difflineminus">-      (this.statusEncrypted == EnigmailConstants.ENIG_FINAL_YES ||</span>
<a href="#l26.3066"></a><span id="l26.3066" class="difflineminus">-        this.statusEncrypted == EnigmailConstants.ENIG_FINAL_FORCEYES ||</span>
<a href="#l26.3067"></a><span id="l26.3067" class="difflineminus">-        this.statusEncryptedInStatusBar == EnigmailConstants.ENIG_FINAL_YES ||</span>
<a href="#l26.3068"></a><span id="l26.3068" class="difflineminus">-        this.statusEncryptedInStatusBar == EnigmailConstants.ENIG_FINAL_FORCEYES)) {</span>
<a href="#l26.3069"></a><span id="l26.3069" class="difflineminus">-      EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.isSendConfirmationRequired: promised encryption did not succeed\n&quot;);</span>
<a href="#l26.3070"></a><span id="l26.3070" class="difflineminus">-      if (!EnigmailDialog.confirmDlg(window,</span>
<a href="#l26.3071"></a><span id="l26.3071" class="difflineminus">-          EnigmailLocale.getString(&quot;msgCompose.internalEncryptionError&quot;),</span>
<a href="#l26.3072"></a><span id="l26.3072" class="difflineminus">-          EnigmailLocale.getString(&quot;msgCompose.button.sendAnyway&quot;))) {</span>
<a href="#l26.3073"></a><span id="l26.3073" class="difflineminus">-        return null; // cancel sending</span>
<a href="#l26.3074"></a><span id="l26.3074" class="difflineminus">-      }</span>
<a href="#l26.3075"></a><span id="l26.3075" class="difflineminus">-      // without canceling sending, force firnal confirmation</span>
<a href="#l26.3076"></a><span id="l26.3076" class="difflineminus">-      confirm = true;</span>
<a href="#l26.3077"></a><span id="l26.3077" class="difflineminus">-    }</span>
<a href="#l26.3078"></a><span id="l26.3078" class="difflineminus">-</span>
<a href="#l26.3079"></a><span id="l26.3079" class="difflineminus">-    return confirm;</span>
<a href="#l26.3080"></a><span id="l26.3080" class="difflineminus">-  },</span>
<a href="#l26.3081"></a><span id="l26.3081" class="difflineminus">-</span>
<a href="#l26.3082"></a><span id="l26.3082">   compileFromAndTo: function() {</span>
<a href="#l26.3083"></a><span id="l26.3083">     EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.compileFromAndTo\n&quot;);</span>
<a href="#l26.3084"></a><span id="l26.3084">     let compFields = gMsgCompose.compFields;</span>
<a href="#l26.3085"></a><span id="l26.3085">     let toAddrList = [];</span>
<a href="#l26.3086"></a><span id="l26.3086">     let recList;</span>
<a href="#l26.3087"></a><span id="l26.3087">     let arrLen = {};</span>
<a href="#l26.3088"></a><span id="l26.3088"> </span>
<a href="#l26.3089"></a><span id="l26.3089">     if (!Enigmail.msg.composeBodyReady) {</span>
<a href="#l26.3090"></a><span id="l26.3090" class="difflineat">@@ -3385,29 +2178,30 @@ Enigmail.msg = {</span>
<a href="#l26.3091"></a><span id="l26.3091">       name: this.identity.fullName</span>
<a href="#l26.3092"></a><span id="l26.3092">     };</span>
<a href="#l26.3093"></a><span id="l26.3093">     return {</span>
<a href="#l26.3094"></a><span id="l26.3094">       from: from,</span>
<a href="#l26.3095"></a><span id="l26.3095">       toAddrList: toAddrList</span>
<a href="#l26.3096"></a><span id="l26.3096">     };</span>
<a href="#l26.3097"></a><span id="l26.3097">   },</span>
<a href="#l26.3098"></a><span id="l26.3098"> </span>
<a href="#l26.3099"></a><span id="l26.3099" class="difflineplus">+  /*</span>
<a href="#l26.3100"></a><span id="l26.3100">   sendSmimeEncrypted: function(msgSendType, sendFlags, isOffline) {</span>
<a href="#l26.3101"></a><span id="l26.3101">     let recList;</span>
<a href="#l26.3102"></a><span id="l26.3102">     let toAddrList = [];</span>
<a href="#l26.3103"></a><span id="l26.3103">     let arrLen = {};</span>
<a href="#l26.3104"></a><span id="l26.3104">     const DeliverMode = Ci.nsIMsgCompDeliverMode;</span>
<a href="#l26.3105"></a><span id="l26.3105"> </span>
<a href="#l26.3106"></a><span id="l26.3106">     switch (msgSendType) {</span>
<a href="#l26.3107"></a><span id="l26.3107">       case DeliverMode.SaveAsDraft:</span>
<a href="#l26.3108"></a><span id="l26.3108">       case DeliverMode.SaveAsTemplate:</span>
<a href="#l26.3109"></a><span id="l26.3109">       case DeliverMode.AutoSaveAsDraft:</span>
<a href="#l26.3110"></a><span id="l26.3110">         break;</span>
<a href="#l26.3111"></a><span id="l26.3111">       default:</span>
<a href="#l26.3112"></a><span id="l26.3112" class="difflineminus">-        if (this.attachOwnKeyObj.appendAttachment) {</span>
<a href="#l26.3113"></a><span id="l26.3113" class="difflineplus">+        if (gAttachMyPublicPGPKey) {</span>
<a href="#l26.3114"></a><span id="l26.3114">           this.attachOwnKey();</span>
<a href="#l26.3115"></a><span id="l26.3115">           Attachments2CompFields(gMsgCompose.compFields); // update list of attachments</span>
<a href="#l26.3116"></a><span id="l26.3116">         }</span>
<a href="#l26.3117"></a><span id="l26.3117">     }</span>
<a href="#l26.3118"></a><span id="l26.3118"> </span>
<a href="#l26.3119"></a><span id="l26.3119">     gSMFields.signMessage = (sendFlags &amp; EnigmailConstants.SEND_SIGNED ? true : false);</span>
<a href="#l26.3120"></a><span id="l26.3120">     gSMFields.requireEncryptMessage = (sendFlags &amp; EnigmailConstants.SEND_ENCRYPTED ? true : false);</span>
<a href="#l26.3121"></a><span id="l26.3121"> </span>
<a href="#l26.3122"></a><span id="l26.3122" class="difflineat">@@ -3440,54 +2234,36 @@ Enigmail.msg = {</span>
<a href="#l26.3123"></a><span id="l26.3123">           if (!this.confirmBeforeSend(toAddrList.join(&quot;, &quot;), &quot;&quot;, sendFlags, isOffline)) {</span>
<a href="#l26.3124"></a><span id="l26.3124">             return false;</span>
<a href="#l26.3125"></a><span id="l26.3125">           }</span>
<a href="#l26.3126"></a><span id="l26.3126">       }</span>
<a href="#l26.3127"></a><span id="l26.3127">     }</span>
<a href="#l26.3128"></a><span id="l26.3128"> </span>
<a href="#l26.3129"></a><span id="l26.3129">     return true;</span>
<a href="#l26.3130"></a><span id="l26.3130">   },</span>
<a href="#l26.3131"></a><span id="l26.3131" class="difflineplus">+  */</span>
<a href="#l26.3132"></a><span id="l26.3132"> </span>
<a href="#l26.3133"></a><span id="l26.3133">   getEncryptionFlags: function(msgSendType) {</span>
<a href="#l26.3134"></a><span id="l26.3134" class="difflineminus">-    let gotSendFlags = this.sendMode;</span>
<a href="#l26.3135"></a><span id="l26.3135" class="difflineminus">-    let sendFlags = 0;</span>
<a href="#l26.3136"></a><span id="l26.3136" class="difflineminus">-</span>
<a href="#l26.3137"></a><span id="l26.3137" class="difflineminus">-    console.debug(`in getEncryptionFlags, statusEnc=${this.statusEncrypted}, statusSign=${this.statusSigned}`);</span>
<a href="#l26.3138"></a><span id="l26.3138" class="difflineminus">-</span>
<a href="#l26.3139"></a><span id="l26.3139" class="difflineminus">-    // here we process the final state:</span>
<a href="#l26.3140"></a><span id="l26.3140" class="difflineminus">-    if (this.statusEncrypted == EnigmailConstants.ENIG_FINAL_YES ||</span>
<a href="#l26.3141"></a><span id="l26.3141" class="difflineminus">-      this.statusEncrypted == EnigmailConstants.ENIG_FINAL_FORCEYES) {</span>
<a href="#l26.3142"></a><span id="l26.3142" class="difflineminus">-      gotSendFlags |= EnigmailConstants.SEND_ENCRYPTED;</span>
<a href="#l26.3143"></a><span id="l26.3143" class="difflineminus">-    }</span>
<a href="#l26.3144"></a><span id="l26.3144" class="difflineminus">-    else if (this.statusEncrypted == EnigmailConstants.ENIG_FINAL_FORCENO) {</span>
<a href="#l26.3145"></a><span id="l26.3145" class="difflineminus">-      gotSendFlags &amp;= ~EnigmailConstants.SEND_ENCRYPTED;</span>
<a href="#l26.3146"></a><span id="l26.3146" class="difflineminus">-    }</span>
<a href="#l26.3147"></a><span id="l26.3147" class="difflineminus">-</span>
<a href="#l26.3148"></a><span id="l26.3148" class="difflineminus">-    if (this.statusSigned == EnigmailConstants.ENIG_FINAL_YES ||</span>
<a href="#l26.3149"></a><span id="l26.3149" class="difflineminus">-      this.statusSigned == EnigmailConstants.ENIG_FINAL_FORCEYES) {</span>
<a href="#l26.3150"></a><span id="l26.3150" class="difflineminus">-      gotSendFlags |= EnigmailConstants.SEND_SIGNED;</span>
<a href="#l26.3151"></a><span id="l26.3151" class="difflineplus">+    let f = 0;</span>
<a href="#l26.3152"></a><span id="l26.3152" class="difflineplus">+</span>
<a href="#l26.3153"></a><span id="l26.3153" class="difflineplus">+    console.debug(`in getEncryptionFlags, gSendEncrypted=${gSendEncrypted}, gSendSigned=${gSendSigned}`);</span>
<a href="#l26.3154"></a><span id="l26.3154" class="difflineplus">+    </span>
<a href="#l26.3155"></a><span id="l26.3155" class="difflineplus">+    if (gSendEncrypted) {</span>
<a href="#l26.3156"></a><span id="l26.3156" class="difflineplus">+      f |= EnigmailConstants.SEND_ENCRYPTED;</span>
<a href="#l26.3157"></a><span id="l26.3157" class="difflineplus">+    } else {</span>
<a href="#l26.3158"></a><span id="l26.3158" class="difflineplus">+      f &amp;= ~EnigmailConstants.SEND_ENCRYPTED;</span>
<a href="#l26.3159"></a><span id="l26.3159">     }</span>
<a href="#l26.3160"></a><span id="l26.3160" class="difflineminus">-    else if (this.statusSigned == EnigmailConstants.ENIG_FINAL_FORCENO) {</span>
<a href="#l26.3161"></a><span id="l26.3161" class="difflineminus">-      gotSendFlags &amp;= ~EnigmailConstants.SEND_SIGNED;</span>
<a href="#l26.3162"></a><span id="l26.3162" class="difflineplus">+    </span>
<a href="#l26.3163"></a><span id="l26.3163" class="difflineplus">+    if (gSendSigned) {</span>
<a href="#l26.3164"></a><span id="l26.3164" class="difflineplus">+      f |= EnigmailConstants.SEND_SIGNED;</span>
<a href="#l26.3165"></a><span id="l26.3165" class="difflineplus">+    } else {</span>
<a href="#l26.3166"></a><span id="l26.3166" class="difflineplus">+      f &amp;= ~EnigmailConstants.SEND_SIGNED;</span>
<a href="#l26.3167"></a><span id="l26.3167">     }</span>
<a href="#l26.3168"></a><span id="l26.3168"> </span>
<a href="#l26.3169"></a><span id="l26.3169" class="difflineminus">-    if (gotSendFlags &amp; EnigmailConstants.SEND_SIGNED)</span>
<a href="#l26.3170"></a><span id="l26.3170" class="difflineminus">-      sendFlags |= EnigmailConstants.SEND_SIGNED;</span>
<a href="#l26.3171"></a><span id="l26.3171" class="difflineminus">-    if (gotSendFlags &amp; EnigmailConstants.SEND_ENCRYPTED)</span>
<a href="#l26.3172"></a><span id="l26.3172" class="difflineminus">-      sendFlags |= EnigmailConstants.SEND_ENCRYPTED;</span>
<a href="#l26.3173"></a><span id="l26.3173" class="difflineminus">-</span>
<a href="#l26.3174"></a><span id="l26.3174" class="difflineminus">-    if (msgSendType === Ci.nsIMsgCompDeliverMode.Later) {</span>
<a href="#l26.3175"></a><span id="l26.3175" class="difflineminus">-      EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.getEncryptionFlags: adding SEND_LATER\n&quot;);</span>
<a href="#l26.3176"></a><span id="l26.3176" class="difflineminus">-      sendFlags |= EnigmailConstants.SEND_LATER;</span>
<a href="#l26.3177"></a><span id="l26.3177" class="difflineminus">-    }</span>
<a href="#l26.3178"></a><span id="l26.3178" class="difflineminus">-</span>
<a href="#l26.3179"></a><span id="l26.3179" class="difflineminus">-    return {</span>
<a href="#l26.3180"></a><span id="l26.3180" class="difflineminus">-      sendFlags: sendFlags,</span>
<a href="#l26.3181"></a><span id="l26.3181" class="difflineminus">-      gotSendFlags: gotSendFlags</span>
<a href="#l26.3182"></a><span id="l26.3182" class="difflineminus">-    };</span>
<a href="#l26.3183"></a><span id="l26.3183" class="difflineplus">+    return f;</span>
<a href="#l26.3184"></a><span id="l26.3184">   },</span>
<a href="#l26.3185"></a><span id="l26.3185"> </span>
<a href="#l26.3186"></a><span id="l26.3186">   resetDirty: function() {</span>
<a href="#l26.3187"></a><span id="l26.3187">     let newSecurityInfo = null;</span>
<a href="#l26.3188"></a><span id="l26.3188"> </span>
<a href="#l26.3189"></a><span id="l26.3189">     if (this.dirty) {</span>
<a href="#l26.3190"></a><span id="l26.3190">       // make sure the sendFlags are reset before the message is processed</span>
<a href="#l26.3191"></a><span id="l26.3191">       // (it may have been set by a previously cancelled send operation!)</span>
<a href="#l26.3192"></a><span id="l26.3192" class="difflineat">@@ -3524,17 +2300,17 @@ Enigmail.msg = {</span>
<a href="#l26.3193"></a><span id="l26.3193">     let promptSvc = EnigmailDialog.getPromptSvc();</span>
<a href="#l26.3194"></a><span id="l26.3194">     let fromAddr = this.identity.email;</span>
<a href="#l26.3195"></a><span id="l26.3195">     let toAddrList = [];</span>
<a href="#l26.3196"></a><span id="l26.3196">     let recList;</span>
<a href="#l26.3197"></a><span id="l26.3197">     let bccAddrList = [];</span>
<a href="#l26.3198"></a><span id="l26.3198">     let arrLen = {};</span>
<a href="#l26.3199"></a><span id="l26.3199">     let splitRecipients;</span>
<a href="#l26.3200"></a><span id="l26.3200"> </span>
<a href="#l26.3201"></a><span id="l26.3201" class="difflineminus">-    if (!this.isEnigmailEnabled()) return true;</span>
<a href="#l26.3202"></a><span id="l26.3202" class="difflineplus">+    if (!Enigmail.msg.isEnigmailEnabledForIdentity()) return true;</span>
<a href="#l26.3203"></a><span id="l26.3203"> </span>
<a href="#l26.3204"></a><span id="l26.3204">     let optSendFlags = 0;</span>
<a href="#l26.3205"></a><span id="l26.3205">     let msgCompFields = gMsgCompose.compFields;</span>
<a href="#l26.3206"></a><span id="l26.3206">     let newsgroups = msgCompFields.newsgroups;</span>
<a href="#l26.3207"></a><span id="l26.3207"> </span>
<a href="#l26.3208"></a><span id="l26.3208">     // request or preference to always accept (even non-authenticated) keys?</span>
<a href="#l26.3209"></a><span id="l26.3209">     if (this.trustAllKeys) {</span>
<a href="#l26.3210"></a><span id="l26.3210">       optSendFlags |= EnigmailConstants.SEND_ALWAYS_TRUST;</span>
<a href="#l26.3211"></a><span id="l26.3211" class="difflineat">@@ -3650,130 +2426,23 @@ Enigmail.msg = {</span>
<a href="#l26.3212"></a><span id="l26.3212">       sendFlags: sendFlags,</span>
<a href="#l26.3213"></a><span id="l26.3213">       optSendFlags: optSendFlags,</span>
<a href="#l26.3214"></a><span id="l26.3214">       fromAddr: fromAddr,</span>
<a href="#l26.3215"></a><span id="l26.3215">       toAddrList: toAddrList,</span>
<a href="#l26.3216"></a><span id="l26.3216">       bccAddrList: bccAddrList</span>
<a href="#l26.3217"></a><span id="l26.3217">     };</span>
<a href="#l26.3218"></a><span id="l26.3218">   },</span>
<a href="#l26.3219"></a><span id="l26.3219"> </span>
<a href="#l26.3220"></a><span id="l26.3220" class="difflineminus">-  appendInlineAttachments: function(sendFlags) {</span>
<a href="#l26.3221"></a><span id="l26.3221" class="difflineminus">-    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: appendInlineAttachments()\n&quot;);</span>
<a href="#l26.3222"></a><span id="l26.3222" class="difflineminus">-</span>
<a href="#l26.3223"></a><span id="l26.3223" class="difflineminus">-    let bucketList = document.getElementById(&quot;attachmentBucket&quot;);</span>
<a href="#l26.3224"></a><span id="l26.3224" class="difflineminus">-    let hasAttachments = ((bucketList &amp;&amp; bucketList.hasChildNodes()) || gMsgCompose.compFields.attachVCard);</span>
<a href="#l26.3225"></a><span id="l26.3225" class="difflineminus">-    let inlineEncAttach = false;</span>
<a href="#l26.3226"></a><span id="l26.3226" class="difflineminus">-</span>
<a href="#l26.3227"></a><span id="l26.3227" class="difflineminus">-    if (hasAttachments &amp;&amp;</span>
<a href="#l26.3228"></a><span id="l26.3228" class="difflineminus">-      (sendFlags &amp; (EnigmailConstants.SEND_ENCRYPTED | EnigmailConstants.SEND_SIGNED)) &amp;&amp;</span>
<a href="#l26.3229"></a><span id="l26.3229" class="difflineminus">-      !(sendFlags &amp; EnigmailConstants.SEND_PGP_MIME)) {</span>
<a href="#l26.3230"></a><span id="l26.3230" class="difflineminus">-</span>
<a href="#l26.3231"></a><span id="l26.3231" class="difflineminus">-      let inputObj = {</span>
<a href="#l26.3232"></a><span id="l26.3232" class="difflineminus">-        pgpMimePossible: true,</span>
<a href="#l26.3233"></a><span id="l26.3233" class="difflineminus">-        inlinePossible: true,</span>
<a href="#l26.3234"></a><span id="l26.3234" class="difflineminus">-        restrictedScenario: false,</span>
<a href="#l26.3235"></a><span id="l26.3235" class="difflineminus">-        reasonForCheck: &quot;&quot;</span>
<a href="#l26.3236"></a><span id="l26.3236" class="difflineminus">-      };</span>
<a href="#l26.3237"></a><span id="l26.3237" class="difflineminus">-      // init reason for dialog to be able to use the right labels</span>
<a href="#l26.3238"></a><span id="l26.3238" class="difflineminus">-      if (sendFlags &amp; EnigmailConstants.SEND_ENCRYPTED) {</span>
<a href="#l26.3239"></a><span id="l26.3239" class="difflineminus">-        if (sendFlags &amp; EnigmailConstants.SEND_SIGNED) {</span>
<a href="#l26.3240"></a><span id="l26.3240" class="difflineminus">-          inputObj.reasonForCheck = &quot;encryptAndSign&quot;;</span>
<a href="#l26.3241"></a><span id="l26.3241" class="difflineminus">-        }</span>
<a href="#l26.3242"></a><span id="l26.3242" class="difflineminus">-        else {</span>
<a href="#l26.3243"></a><span id="l26.3243" class="difflineminus">-          inputObj.reasonForCheck = &quot;encrypt&quot;;</span>
<a href="#l26.3244"></a><span id="l26.3244" class="difflineminus">-        }</span>
<a href="#l26.3245"></a><span id="l26.3245" class="difflineminus">-      }</span>
<a href="#l26.3246"></a><span id="l26.3246" class="difflineminus">-      else {</span>
<a href="#l26.3247"></a><span id="l26.3247" class="difflineminus">-        if (sendFlags &amp; EnigmailConstants.SEND_SIGNED) {</span>
<a href="#l26.3248"></a><span id="l26.3248" class="difflineminus">-          inputObj.reasonForCheck = &quot;sign&quot;;</span>
<a href="#l26.3249"></a><span id="l26.3249" class="difflineminus">-        }</span>
<a href="#l26.3250"></a><span id="l26.3250" class="difflineminus">-      }</span>
<a href="#l26.3251"></a><span id="l26.3251" class="difflineminus">-</span>
<a href="#l26.3252"></a><span id="l26.3252" class="difflineminus">-      // determine if attachments are all local files (currently the only</span>
<a href="#l26.3253"></a><span id="l26.3253" class="difflineminus">-      // supported kind of attachments)</span>
<a href="#l26.3254"></a><span id="l26.3254" class="difflineminus">-      let node = bucketList.firstChild;</span>
<a href="#l26.3255"></a><span id="l26.3255" class="difflineminus">-      while (node) {</span>
<a href="#l26.3256"></a><span id="l26.3256" class="difflineminus">-        if (node.attachment.url.substring(0, 7) != &quot;file://&quot;) {</span>
<a href="#l26.3257"></a><span id="l26.3257" class="difflineminus">-          inputObj.inlinePossible = false;</span>
<a href="#l26.3258"></a><span id="l26.3258" class="difflineminus">-        }</span>
<a href="#l26.3259"></a><span id="l26.3259" class="difflineminus">-        node = node.nextSibling;</span>
<a href="#l26.3260"></a><span id="l26.3260" class="difflineminus">-      }</span>
<a href="#l26.3261"></a><span id="l26.3261" class="difflineminus">-</span>
<a href="#l26.3262"></a><span id="l26.3262" class="difflineminus">-      if (inputObj.pgpMimePossible || inputObj.inlinePossible) {</span>
<a href="#l26.3263"></a><span id="l26.3263" class="difflineminus">-        let resultObj = {</span>
<a href="#l26.3264"></a><span id="l26.3264" class="difflineminus">-          selected: EnigmailPrefs.getPref(&quot;encryptAttachments&quot;)</span>
<a href="#l26.3265"></a><span id="l26.3265" class="difflineminus">-        };</span>
<a href="#l26.3266"></a><span id="l26.3266" class="difflineminus">-</span>
<a href="#l26.3267"></a><span id="l26.3267" class="difflineminus">-        //skip or not</span>
<a href="#l26.3268"></a><span id="l26.3268" class="difflineminus">-        var skipCheck = EnigmailPrefs.getPref(&quot;encryptAttachmentsSkipDlg&quot;);</span>
<a href="#l26.3269"></a><span id="l26.3269" class="difflineminus">-        if (skipCheck == 1) {</span>
<a href="#l26.3270"></a><span id="l26.3270" class="difflineminus">-          if ((resultObj.selected == 2 &amp;&amp; inputObj.pgpMimePossible === false) || (resultObj.selected == 1 &amp;&amp; inputObj.inlinePossible === false)) {</span>
<a href="#l26.3271"></a><span id="l26.3271" class="difflineminus">-            //add var to disable remember box since we're dealing with restricted scenarios...</span>
<a href="#l26.3272"></a><span id="l26.3272" class="difflineminus">-            inputObj.restrictedScenario = true;</span>
<a href="#l26.3273"></a><span id="l26.3273" class="difflineminus">-            resultObj.selected = -1;</span>
<a href="#l26.3274"></a><span id="l26.3274" class="difflineminus">-            window.openDialog(&quot;chrome://openpgp/content/ui/enigmailAttachmentsDialog.xhtml&quot;, &quot;&quot;, &quot;dialog,modal,centerscreen&quot;, inputObj, resultObj);</span>
<a href="#l26.3275"></a><span id="l26.3275" class="difflineminus">-          }</span>
<a href="#l26.3276"></a><span id="l26.3276" class="difflineminus">-        }</span>
<a href="#l26.3277"></a><span id="l26.3277" class="difflineminus">-        else {</span>
<a href="#l26.3278"></a><span id="l26.3278" class="difflineminus">-          resultObj.selected = -1;</span>
<a href="#l26.3279"></a><span id="l26.3279" class="difflineminus">-          window.openDialog(&quot;chrome://openpgp/content/ui/enigmailAttachmentsDialog.xhtml&quot;, &quot;&quot;, &quot;dialog,modal,centerscreen&quot;, inputObj, resultObj);</span>
<a href="#l26.3280"></a><span id="l26.3280" class="difflineminus">-        }</span>
<a href="#l26.3281"></a><span id="l26.3281" class="difflineminus">-        if (resultObj.selected &lt; 0) {</span>
<a href="#l26.3282"></a><span id="l26.3282" class="difflineminus">-          // dialog cancelled</span>
<a href="#l26.3283"></a><span id="l26.3283" class="difflineminus">-          return null;</span>
<a href="#l26.3284"></a><span id="l26.3284" class="difflineminus">-        }</span>
<a href="#l26.3285"></a><span id="l26.3285" class="difflineminus">-        else if (resultObj.selected == 1) {</span>
<a href="#l26.3286"></a><span id="l26.3286" class="difflineminus">-          // encrypt attachments</span>
<a href="#l26.3287"></a><span id="l26.3287" class="difflineminus">-          inlineEncAttach = true;</span>
<a href="#l26.3288"></a><span id="l26.3288" class="difflineminus">-        }</span>
<a href="#l26.3289"></a><span id="l26.3289" class="difflineminus">-        else if (resultObj.selected == 2) {</span>
<a href="#l26.3290"></a><span id="l26.3290" class="difflineminus">-          // send as PGP/MIME</span>
<a href="#l26.3291"></a><span id="l26.3291" class="difflineminus">-          sendFlags |= EnigmailConstants.SEND_PGP_MIME;</span>
<a href="#l26.3292"></a><span id="l26.3292" class="difflineminus">-        }</span>
<a href="#l26.3293"></a><span id="l26.3293" class="difflineminus">-        else if (resultObj.selected == 3) {</span>
<a href="#l26.3294"></a><span id="l26.3294" class="difflineminus">-          // cancel the encryption/signing for the whole message</span>
<a href="#l26.3295"></a><span id="l26.3295" class="difflineminus">-          sendFlags &amp;= ~EnigmailConstants.SEND_ENCRYPTED;</span>
<a href="#l26.3296"></a><span id="l26.3296" class="difflineminus">-          sendFlags &amp;= ~EnigmailConstants.SEND_SIGNED;</span>
<a href="#l26.3297"></a><span id="l26.3297" class="difflineminus">-        }</span>
<a href="#l26.3298"></a><span id="l26.3298" class="difflineminus">-      }</span>
<a href="#l26.3299"></a><span id="l26.3299" class="difflineminus">-      else {</span>
<a href="#l26.3300"></a><span id="l26.3300" class="difflineminus">-        if (sendFlags &amp; EnigmailConstants.SEND_ENCRYPTED) {</span>
<a href="#l26.3301"></a><span id="l26.3301" class="difflineminus">-          if (!EnigmailDialog.confirmDlg(window,</span>
<a href="#l26.3302"></a><span id="l26.3302" class="difflineminus">-              EnigmailLocale.getString(&quot;attachWarning&quot;),</span>
<a href="#l26.3303"></a><span id="l26.3303" class="difflineminus">-              EnigmailLocale.getString(&quot;msgCompose.button.send&quot;)))</span>
<a href="#l26.3304"></a><span id="l26.3304" class="difflineminus">-            return null;</span>
<a href="#l26.3305"></a><span id="l26.3305" class="difflineminus">-        }</span>
<a href="#l26.3306"></a><span id="l26.3306" class="difflineminus">-      }</span>
<a href="#l26.3307"></a><span id="l26.3307" class="difflineminus">-    }</span>
<a href="#l26.3308"></a><span id="l26.3308" class="difflineminus">-</span>
<a href="#l26.3309"></a><span id="l26.3309" class="difflineminus">-    return {</span>
<a href="#l26.3310"></a><span id="l26.3310" class="difflineminus">-      inlineEncAttach: inlineEncAttach</span>
<a href="#l26.3311"></a><span id="l26.3311" class="difflineminus">-    };</span>
<a href="#l26.3312"></a><span id="l26.3312" class="difflineminus">-  },</span>
<a href="#l26.3313"></a><span id="l26.3313" class="difflineminus">-</span>
<a href="#l26.3314"></a><span id="l26.3314">   prepareSending: function(sendFlags, toAddrStr, gpgKeys, isOffline) {</span>
<a href="#l26.3315"></a><span id="l26.3315" class="difflineminus">-    let confirm = this.isSendConfirmationRequired(sendFlags);</span>
<a href="#l26.3316"></a><span id="l26.3316" class="difflineminus">-    if (confirm === null) return false;</span>
<a href="#l26.3317"></a><span id="l26.3317">     // perform confirmation dialog if necessary/requested</span>
<a href="#l26.3318"></a><span id="l26.3318" class="difflineminus">-    if (confirm) {</span>
<a href="#l26.3319"></a><span id="l26.3319" class="difflineminus">-      if (!this.confirmBeforeSend(toAddrStr, gpgKeys, sendFlags, isOffline)) {</span>
<a href="#l26.3320"></a><span id="l26.3320" class="difflineminus">-        if (this.processed) {</span>
<a href="#l26.3321"></a><span id="l26.3321" class="difflineminus">-          this.undoEncryption(0);</span>
<a href="#l26.3322"></a><span id="l26.3322" class="difflineminus">-        }</span>
<a href="#l26.3323"></a><span id="l26.3323" class="difflineminus">-        else {</span>
<a href="#l26.3324"></a><span id="l26.3324" class="difflineminus">-          this.removeAttachedKey();</span>
<a href="#l26.3325"></a><span id="l26.3325" class="difflineminus">-        }</span>
<a href="#l26.3326"></a><span id="l26.3326" class="difflineminus">-        return false;</span>
<a href="#l26.3327"></a><span id="l26.3327" class="difflineminus">-      }</span>
<a href="#l26.3328"></a><span id="l26.3328" class="difflineminus">-    }</span>
<a href="#l26.3329"></a><span id="l26.3329" class="difflineminus">-    else if ((sendFlags &amp; EnigmailConstants.SEND_WITH_CHECK) &amp;&amp;</span>
<a href="#l26.3330"></a><span id="l26.3330" class="difflineminus">-      !this.messageSendCheck()) {</span>
<a href="#l26.3331"></a><span id="l26.3331" class="difflineplus">+    if ((sendFlags &amp; EnigmailConstants.SEND_WITH_CHECK) &amp;&amp;</span>
<a href="#l26.3332"></a><span id="l26.3332" class="difflineplus">+        !this.messageSendCheck()) {</span>
<a href="#l26.3333"></a><span id="l26.3333">       // Abort send</span>
<a href="#l26.3334"></a><span id="l26.3334">       if (this.processed) {</span>
<a href="#l26.3335"></a><span id="l26.3335" class="difflineminus">-        this.undoEncryption(0);</span>
<a href="#l26.3336"></a><span id="l26.3336" class="difflineplus">+        //this.undoEncryption(0);</span>
<a href="#l26.3337"></a><span id="l26.3337">       }</span>
<a href="#l26.3338"></a><span id="l26.3338">       else {</span>
<a href="#l26.3339"></a><span id="l26.3339">         this.removeAttachedKey();</span>
<a href="#l26.3340"></a><span id="l26.3340">       }</span>
<a href="#l26.3341"></a><span id="l26.3341"> </span>
<a href="#l26.3342"></a><span id="l26.3342">       return false;</span>
<a href="#l26.3343"></a><span id="l26.3343">     }</span>
<a href="#l26.3344"></a><span id="l26.3344"> </span>
<a href="#l26.3345"></a><span id="l26.3345" class="difflineat">@@ -3814,38 +2483,35 @@ Enigmail.msg = {</span>
<a href="#l26.3346"></a><span id="l26.3346">     newSecurityInfo.bccRecipients = rcpt.bccAddrStr;</span>
<a href="#l26.3347"></a><span id="l26.3347">     newSecurityInfo.keyMap = keyMap;</span>
<a href="#l26.3348"></a><span id="l26.3348"> </span>
<a href="#l26.3349"></a><span id="l26.3349">     EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.prepareSecurityInfo: securityInfo = &quot; + newSecurityInfo + &quot;\n&quot;);</span>
<a href="#l26.3350"></a><span id="l26.3350">     return newSecurityInfo;</span>
<a href="#l26.3351"></a><span id="l26.3351">   },</span>
<a href="#l26.3352"></a><span id="l26.3352"> </span>
<a href="#l26.3353"></a><span id="l26.3353">   encryptMsg: function(msgSendType) {</span>
<a href="#l26.3354"></a><span id="l26.3354" class="difflineminus">-    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.encryptMsg: msgSendType=&quot; + msgSendType + &quot;, Enigmail.msg.sendMode=&quot; + this.sendMode + &quot;, Enigmail.msg.statusEncrypted=&quot; +</span>
<a href="#l26.3355"></a><span id="l26.3355" class="difflineminus">-      this.statusEncrypted +</span>
<a href="#l26.3356"></a><span id="l26.3356" class="difflineplus">+    // msgSendType: value from nsIMsgCompDeliverMode</span>
<a href="#l26.3357"></a><span id="l26.3357" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.encryptMsg: msgSendType=&quot; + msgSendType + &quot;, gSendSigned=&quot; + gSendSigned + &quot;, gSendEncrypted=&quot; +</span>
<a href="#l26.3358"></a><span id="l26.3358" class="difflineplus">+      gSendEncrypted +</span>
<a href="#l26.3359"></a><span id="l26.3359">       &quot;\n&quot;);</span>
<a href="#l26.3360"></a><span id="l26.3360"> </span>
<a href="#l26.3361"></a><span id="l26.3361">     const SIGN = EnigmailConstants.SEND_SIGNED;</span>
<a href="#l26.3362"></a><span id="l26.3362">     const ENCRYPT = EnigmailConstants.SEND_ENCRYPTED;</span>
<a href="#l26.3363"></a><span id="l26.3363">     const DeliverMode = Components.interfaces.nsIMsgCompDeliverMode;</span>
<a href="#l26.3364"></a><span id="l26.3364">     let promptSvc = EnigmailDialog.getPromptSvc();</span>
<a href="#l26.3365"></a><span id="l26.3365"> </span>
<a href="#l26.3366"></a><span id="l26.3366">     var ioService = Components.classes[&quot;@mozilla.org/network/io-service;1&quot;].getService(Components.interfaces.nsIIOService);</span>
<a href="#l26.3367"></a><span id="l26.3367">     // EnigSend: Handle both plain and encrypted messages below</span>
<a href="#l26.3368"></a><span id="l26.3368">     var isOffline = (ioService &amp;&amp; ioService.offline);</span>
<a href="#l26.3369"></a><span id="l26.3369"> </span>
<a href="#l26.3370"></a><span id="l26.3370" class="difflineminus">-    let {</span>
<a href="#l26.3371"></a><span id="l26.3371" class="difflineminus">-      sendFlags,</span>
<a href="#l26.3372"></a><span id="l26.3372" class="difflineminus">-      gotSendFlags</span>
<a href="#l26.3373"></a><span id="l26.3373" class="difflineminus">-    } = this.getEncryptionFlags(msgSendType);</span>
<a href="#l26.3374"></a><span id="l26.3374" class="difflineminus">-</span>
<a href="#l26.3375"></a><span id="l26.3375" class="difflineminus">-    if (this.statusPGPMime == EnigmailConstants.ENIG_FINAL_SMIME ||</span>
<a href="#l26.3376"></a><span id="l26.3376" class="difflineminus">-      this.statusPGPMime == EnigmailConstants.ENIG_FINAL_FORCESMIME) {</span>
<a href="#l26.3377"></a><span id="l26.3377" class="difflineminus">-</span>
<a href="#l26.3378"></a><span id="l26.3378" class="difflineminus">-      return this.sendSmimeEncrypted(msgSendType, sendFlags, isOffline);</span>
<a href="#l26.3379"></a><span id="l26.3379" class="difflineplus">+    let sendFlags = this.getEncryptionFlags(msgSendType);</span>
<a href="#l26.3380"></a><span id="l26.3380" class="difflineplus">+</span>
<a href="#l26.3381"></a><span id="l26.3381" class="difflineplus">+    // if smime</span>
<a href="#l26.3382"></a><span id="l26.3382" class="difflineplus">+    {</span>
<a href="#l26.3383"></a><span id="l26.3383" class="difflineplus">+      //return this.sendSmimeEncrypted(msgSendType, sendFlags, isOffline);</span>
<a href="#l26.3384"></a><span id="l26.3384">     }</span>
<a href="#l26.3385"></a><span id="l26.3385"> </span>
<a href="#l26.3386"></a><span id="l26.3386">     switch (msgSendType) {</span>
<a href="#l26.3387"></a><span id="l26.3387">       case DeliverMode.SaveAsDraft:</span>
<a href="#l26.3388"></a><span id="l26.3388">       case DeliverMode.SaveAsTemplate:</span>
<a href="#l26.3389"></a><span id="l26.3389">       case DeliverMode.AutoSaveAsDraft:</span>
<a href="#l26.3390"></a><span id="l26.3390">         EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.encryptMsg: detected save draft\n&quot;);</span>
<a href="#l26.3391"></a><span id="l26.3391"> </span>
<a href="#l26.3392"></a><span id="l26.3392" class="difflineat">@@ -3883,17 +2549,16 @@ Enigmail.msg = {</span>
<a href="#l26.3393"></a><span id="l26.3393">       if (EnigmailCore.getEnigmailService() &amp;&amp; EnigmailCore.getEnigmailService().initializationError) {</span>
<a href="#l26.3394"></a><span id="l26.3394">         msg = EnigmailCore.getEnigmailService().initializationError + &quot;\n\n&quot; + msg;</span>
<a href="#l26.3395"></a><span id="l26.3395">       }</span>
<a href="#l26.3396"></a><span id="l26.3396"> </span>
<a href="#l26.3397"></a><span id="l26.3397">       return EnigmailDialog.confirmDlg(window, msg, EnigmailLocale.getString(&quot;msgCompose.button.send&quot;));</span>
<a href="#l26.3398"></a><span id="l26.3398">     }</span>
<a href="#l26.3399"></a><span id="l26.3399"> </span>
<a href="#l26.3400"></a><span id="l26.3400">     try {</span>
<a href="#l26.3401"></a><span id="l26.3401" class="difflineminus">-</span>
<a href="#l26.3402"></a><span id="l26.3402">       this.modifiedAttach = null;</span>
<a href="#l26.3403"></a><span id="l26.3403"> </span>
<a href="#l26.3404"></a><span id="l26.3404">       // fill fromAddr, toAddrList, bcc etc</span>
<a href="#l26.3405"></a><span id="l26.3405">       let rcpt = this.determineMsgRecipients(sendFlags);</span>
<a href="#l26.3406"></a><span id="l26.3406">       if (typeof(rcpt) === &quot;boolean&quot;) {</span>
<a href="#l26.3407"></a><span id="l26.3407">         return rcpt;</span>
<a href="#l26.3408"></a><span id="l26.3408">       }</span>
<a href="#l26.3409"></a><span id="l26.3409">       sendFlags = rcpt.sendFlags;</span>
<a href="#l26.3410"></a><span id="l26.3410" class="difflineat">@@ -3901,43 +2566,38 @@ Enigmail.msg = {</span>
<a href="#l26.3411"></a><span id="l26.3411">       if (this.sendPgpMime) {</span>
<a href="#l26.3412"></a><span id="l26.3412">         // Use PGP/MIME</span>
<a href="#l26.3413"></a><span id="l26.3413">         sendFlags |= EnigmailConstants.SEND_PGP_MIME;</span>
<a href="#l26.3414"></a><span id="l26.3414">       }</span>
<a href="#l26.3415"></a><span id="l26.3415"> </span>
<a href="#l26.3416"></a><span id="l26.3416">       let result = this.keySelection(enigmailSvc,</span>
<a href="#l26.3417"></a><span id="l26.3417">         sendFlags, // all current combined/processed send flags (incl. optSendFlags)</span>
<a href="#l26.3418"></a><span id="l26.3418">         rcpt.optSendFlags, // may only be SEND_ALWAYS_TRUST or SEND_ENCRYPT_TO_SELF</span>
<a href="#l26.3419"></a><span id="l26.3419" class="difflineminus">-        gotSendFlags, // initial sendMode (0 or SIGN or ENCRYPT or SIGN|ENCRYPT)</span>
<a href="#l26.3420"></a><span id="l26.3420">         rcpt.fromAddr, rcpt.toAddrList, rcpt.bccAddrList);</span>
<a href="#l26.3421"></a><span id="l26.3421">       if (!result) {</span>
<a href="#l26.3422"></a><span id="l26.3422">         return false;</span>
<a href="#l26.3423"></a><span id="l26.3423">       }</span>
<a href="#l26.3424"></a><span id="l26.3424"> </span>
<a href="#l26.3425"></a><span id="l26.3425">       sendFlags = result.sendFlags;</span>
<a href="#l26.3426"></a><span id="l26.3426">       let toAddrStr = result.toAddrStr;</span>
<a href="#l26.3427"></a><span id="l26.3427">       let bccAddrStr = result.bccAddrStr;</span>
<a href="#l26.3428"></a><span id="l26.3428">       let keyMap = result.keyMap;</span>
<a href="#l26.3429"></a><span id="l26.3429"> </span>
<a href="#l26.3430"></a><span id="l26.3430" class="difflineminus">-      if (this.attachOwnKeyObj.appendAttachment) {</span>
<a href="#l26.3431"></a><span id="l26.3431" class="difflineminus">-        this.attachOwnKey();</span>
<a href="#l26.3432"></a><span id="l26.3432" class="difflineplus">+      if (gAttachMyPublicPGPKey) {</span>
<a href="#l26.3433"></a><span id="l26.3433" class="difflineplus">+        this.attachOwnKey(rcpt.fromAddr);</span>
<a href="#l26.3434"></a><span id="l26.3434">       }</span>
<a href="#l26.3435"></a><span id="l26.3435"> </span>
<a href="#l26.3436"></a><span id="l26.3436" class="difflineplus">+      /*</span>
<a href="#l26.3437"></a><span id="l26.3437">       if (this.preferPgpOverSmime(sendFlags) === 0) {</span>
<a href="#l26.3438"></a><span id="l26.3438">         // use S/MIME</span>
<a href="#l26.3439"></a><span id="l26.3439">         Attachments2CompFields(gMsgCompose.compFields); // update list of attachments</span>
<a href="#l26.3440"></a><span id="l26.3440">         sendFlags = 0;</span>
<a href="#l26.3441"></a><span id="l26.3441">         return true;</span>
<a href="#l26.3442"></a><span id="l26.3442">       }</span>
<a href="#l26.3443"></a><span id="l26.3443" class="difflineminus">-</span>
<a href="#l26.3444"></a><span id="l26.3444" class="difflineminus">-      let attach = this.appendInlineAttachments(sendFlags);</span>
<a href="#l26.3445"></a><span id="l26.3445" class="difflineminus">-      if (!attach) {</span>
<a href="#l26.3446"></a><span id="l26.3446" class="difflineminus">-        return false;</span>
<a href="#l26.3447"></a><span id="l26.3447" class="difflineminus">-      }</span>
<a href="#l26.3448"></a><span id="l26.3448" class="difflineminus">-      let inlineEncAttach = attach.inlineEncAttach;</span>
<a href="#l26.3449"></a><span id="l26.3449" class="difflineplus">+      */</span>
<a href="#l26.3450"></a><span id="l26.3450"> </span>
<a href="#l26.3451"></a><span id="l26.3451">       var usingPGPMime = (sendFlags &amp; EnigmailConstants.SEND_PGP_MIME) &amp;&amp;</span>
<a href="#l26.3452"></a><span id="l26.3452">         (sendFlags &amp; (ENCRYPT | SIGN));</span>
<a href="#l26.3453"></a><span id="l26.3453"> </span>
<a href="#l26.3454"></a><span id="l26.3454">       if (!this.checkProtectHeaders(sendFlags)) {</span>
<a href="#l26.3455"></a><span id="l26.3455">         return false;</span>
<a href="#l26.3456"></a><span id="l26.3456">       }</span>
<a href="#l26.3457"></a><span id="l26.3457"> </span>
<a href="#l26.3458"></a><span id="l26.3458" class="difflineat">@@ -3955,31 +2615,31 @@ Enigmail.msg = {</span>
<a href="#l26.3459"></a><span id="l26.3459">         }</span>
<a href="#l26.3460"></a><span id="l26.3460">         if (wrapresultObj.cancelled) {</span>
<a href="#l26.3461"></a><span id="l26.3461">           return false;</span>
<a href="#l26.3462"></a><span id="l26.3462">         }</span>
<a href="#l26.3463"></a><span id="l26.3463">       }</span>
<a href="#l26.3464"></a><span id="l26.3464"> </span>
<a href="#l26.3465"></a><span id="l26.3465">       var uiFlags = EnigmailConstants.UI_INTERACTIVE;</span>
<a href="#l26.3466"></a><span id="l26.3466"> </span>
<a href="#l26.3467"></a><span id="l26.3467" class="difflineminus">-      if (usingPGPMime)</span>
<a href="#l26.3468"></a><span id="l26.3468" class="difflineplus">+      if (usingPGPMime) {</span>
<a href="#l26.3469"></a><span id="l26.3469">         uiFlags |= EnigmailConstants.UI_PGP_MIME;</span>
<a href="#l26.3470"></a><span id="l26.3470" class="difflineplus">+      }</span>
<a href="#l26.3471"></a><span id="l26.3471"> </span>
<a href="#l26.3472"></a><span id="l26.3472">       if ((sendFlags &amp; (ENCRYPT | SIGN)) &amp;&amp; usingPGPMime) {</span>
<a href="#l26.3473"></a><span id="l26.3473">         // Use PGP/MIME</span>
<a href="#l26.3474"></a><span id="l26.3474">         newSecurityInfo = this.prepareSecurityInfo(sendFlags, uiFlags, rcpt, newSecurityInfo, keyMap);</span>
<a href="#l26.3475"></a><span id="l26.3475">         newSecurityInfo.recipients = toAddrStr;</span>
<a href="#l26.3476"></a><span id="l26.3476">         newSecurityInfo.bccRecipients = bccAddrStr;</span>
<a href="#l26.3477"></a><span id="l26.3477">       }</span>
<a href="#l26.3478"></a><span id="l26.3478">       else if (!this.processed &amp;&amp; (sendFlags &amp; (ENCRYPT | SIGN))) {</span>
<a href="#l26.3479"></a><span id="l26.3479">         // use inline PGP</span>
<a href="#l26.3480"></a><span id="l26.3480"> </span>
<a href="#l26.3481"></a><span id="l26.3481">         let sendInfo = {</span>
<a href="#l26.3482"></a><span id="l26.3482">           sendFlags: sendFlags,</span>
<a href="#l26.3483"></a><span id="l26.3483" class="difflineminus">-          inlineEncAttach: inlineEncAttach,</span>
<a href="#l26.3484"></a><span id="l26.3484">           fromAddr: rcpt.fromAddr,</span>
<a href="#l26.3485"></a><span id="l26.3485">           toAddr: toAddrStr,</span>
<a href="#l26.3486"></a><span id="l26.3486">           bccAddr: bccAddrStr,</span>
<a href="#l26.3487"></a><span id="l26.3487">           uiFlags: uiFlags,</span>
<a href="#l26.3488"></a><span id="l26.3488">           bucketList: document.getElementById(&quot;attachmentBucket&quot;)</span>
<a href="#l26.3489"></a><span id="l26.3489">         };</span>
<a href="#l26.3490"></a><span id="l26.3490"> </span>
<a href="#l26.3491"></a><span id="l26.3491">         if (!this.encryptInline(sendInfo)) {</span>
<a href="#l26.3492"></a><span id="l26.3492" class="difflineat">@@ -4205,29 +2865,29 @@ Enigmail.msg = {</span>
<a href="#l26.3493"></a><span id="l26.3493">         if ((sendInfo.sendFlags &amp; ENCRYPT) &amp;&amp; charset &amp;&amp;</span>
<a href="#l26.3494"></a><span id="l26.3494">           (charset.search(/^us-ascii$/i) !== 0)) {</span>
<a href="#l26.3495"></a><span id="l26.3495">           // Add Charset armor header for encrypted blocks</span>
<a href="#l26.3496"></a><span id="l26.3496">           cipherText = cipherText.replace(/(-----BEGIN PGP MESSAGE----- *)(\r?\n)/, &quot;$1$2Charset: &quot; + charset + &quot;$2&quot;);</span>
<a href="#l26.3497"></a><span id="l26.3497">         }</span>
<a href="#l26.3498"></a><span id="l26.3498"> </span>
<a href="#l26.3499"></a><span id="l26.3499">         // Decode ciphertext from charset to unicode and overwrite</span>
<a href="#l26.3500"></a><span id="l26.3500">         this.replaceEditorText(EnigmailData.convertToUnicode(cipherText, charset));</span>
<a href="#l26.3501"></a><span id="l26.3501" class="difflineminus">-        this.enableUndoEncryption(true);</span>
<a href="#l26.3502"></a><span id="l26.3502" class="difflineplus">+        //this.enableUndoEncryption(true);</span>
<a href="#l26.3503"></a><span id="l26.3503"> </span>
<a href="#l26.3504"></a><span id="l26.3504">         // Save original text (for undo)</span>
<a href="#l26.3505"></a><span id="l26.3505">         this.processed = {</span>
<a href="#l26.3506"></a><span id="l26.3506">           &quot;origText&quot;: origText,</span>
<a href="#l26.3507"></a><span id="l26.3507">           &quot;charset&quot;: charset</span>
<a href="#l26.3508"></a><span id="l26.3508">         };</span>
<a href="#l26.3509"></a><span id="l26.3509"> </span>
<a href="#l26.3510"></a><span id="l26.3510">       }</span>
<a href="#l26.3511"></a><span id="l26.3511">       else {</span>
<a href="#l26.3512"></a><span id="l26.3512">         // Restore original text</span>
<a href="#l26.3513"></a><span id="l26.3513">         this.replaceEditorText(origText);</span>
<a href="#l26.3514"></a><span id="l26.3514" class="difflineminus">-        this.enableUndoEncryption(false);</span>
<a href="#l26.3515"></a><span id="l26.3515" class="difflineplus">+        //this.enableUndoEncryption(false);</span>
<a href="#l26.3516"></a><span id="l26.3516"> </span>
<a href="#l26.3517"></a><span id="l26.3517">         if (sendInfo.sendFlags &amp; (ENCRYPT | SIGN)) {</span>
<a href="#l26.3518"></a><span id="l26.3518">           // Encryption/signing failed</span>
<a href="#l26.3519"></a><span id="l26.3519"> </span>
<a href="#l26.3520"></a><span id="l26.3520">           /*if (statusFlagsObj.statusMsg) {</span>
<a href="#l26.3521"></a><span id="l26.3521">             // check if own key is invalid</span>
<a href="#l26.3522"></a><span id="l26.3522">             let s = new RegExp(&quot;^(\\[GNUPG:\\] )?INV_(RECP|SGNR) [0-9]+ \\&lt;?&quot; + sendInfo.fromAddr + &quot;\\&gt;?&quot;, &quot;m&quot;);</span>
<a href="#l26.3523"></a><span id="l26.3523">             if (statusFlagsObj.statusMsg.search(s) &gt;= 0) {</span>
<a href="#l26.3524"></a><span id="l26.3524" class="difflineat">@@ -4236,34 +2896,16 @@ Enigmail.msg = {</span>
<a href="#l26.3525"></a><span id="l26.3525">           }*/</span>
<a href="#l26.3526"></a><span id="l26.3526"> </span>
<a href="#l26.3527"></a><span id="l26.3527">           this.sendAborted(window, errorMsgObj);</span>
<a href="#l26.3528"></a><span id="l26.3528">           return false;</span>
<a href="#l26.3529"></a><span id="l26.3529">         }</span>
<a href="#l26.3530"></a><span id="l26.3530">       }</span>
<a href="#l26.3531"></a><span id="l26.3531">     }</span>
<a href="#l26.3532"></a><span id="l26.3532"> </span>
<a href="#l26.3533"></a><span id="l26.3533" class="difflineminus">-    if (sendInfo.inlineEncAttach) {</span>
<a href="#l26.3534"></a><span id="l26.3534" class="difflineminus">-      // encrypt attachments</span>
<a href="#l26.3535"></a><span id="l26.3535" class="difflineminus">-      this.modifiedAttach = [];</span>
<a href="#l26.3536"></a><span id="l26.3536" class="difflineminus">-      exitCode = this.encryptAttachments(sendInfo.bucketList, this.modifiedAttach,</span>
<a href="#l26.3537"></a><span id="l26.3537" class="difflineminus">-        window, sendInfo.uiFlags, sendInfo.fromAddr, sendInfo.toAddr, sendInfo.bccAddr,</span>
<a href="#l26.3538"></a><span id="l26.3538" class="difflineminus">-        sendInfo.sendFlags, errorMsgObj);</span>
<a href="#l26.3539"></a><span id="l26.3539" class="difflineminus">-      if (exitCode !== 0) {</span>
<a href="#l26.3540"></a><span id="l26.3540" class="difflineminus">-        this.modifiedAttach = null;</span>
<a href="#l26.3541"></a><span id="l26.3541" class="difflineminus">-        this.sendAborted(window, errorMsgObj);</span>
<a href="#l26.3542"></a><span id="l26.3542" class="difflineminus">-        if (this.processed) {</span>
<a href="#l26.3543"></a><span id="l26.3543" class="difflineminus">-          this.undoEncryption(0);</span>
<a href="#l26.3544"></a><span id="l26.3544" class="difflineminus">-        }</span>
<a href="#l26.3545"></a><span id="l26.3545" class="difflineminus">-        else {</span>
<a href="#l26.3546"></a><span id="l26.3546" class="difflineminus">-          this.removeAttachedKey();</span>
<a href="#l26.3547"></a><span id="l26.3547" class="difflineminus">-        }</span>
<a href="#l26.3548"></a><span id="l26.3548" class="difflineminus">-        return false;</span>
<a href="#l26.3549"></a><span id="l26.3549" class="difflineminus">-      }</span>
<a href="#l26.3550"></a><span id="l26.3550" class="difflineminus">-    }</span>
<a href="#l26.3551"></a><span id="l26.3551">     return true;</span>
<a href="#l26.3552"></a><span id="l26.3552">   },</span>
<a href="#l26.3553"></a><span id="l26.3553"> </span>
<a href="#l26.3554"></a><span id="l26.3554"> </span>
<a href="#l26.3555"></a><span id="l26.3555">   sendAborted: function(window, errorMsgObj) {</span>
<a href="#l26.3556"></a><span id="l26.3556">     if (errorMsgObj &amp;&amp; errorMsgObj.value) {</span>
<a href="#l26.3557"></a><span id="l26.3557">       var txt = errorMsgObj.value;</span>
<a href="#l26.3558"></a><span id="l26.3558">       var txtLines = txt.split(/\r?\n/);</span>
<a href="#l26.3559"></a><span id="l26.3559" class="difflineat">@@ -4392,44 +3034,45 @@ Enigmail.msg = {</span>
<a href="#l26.3560"></a><span id="l26.3560">       let m = h.replace(r, &quot;&quot;).replace(/(\r\n)+/, &quot;\r\n&quot;);</span>
<a href="#l26.3561"></a><span id="l26.3561">       gMsgCompose.compFields.otherRandomHeaders = m;</span>
<a href="#l26.3562"></a><span id="l26.3562">     }</span>
<a href="#l26.3563"></a><span id="l26.3563">     else {</span>
<a href="#l26.3564"></a><span id="l26.3564">       gMsgCompose.compFields.deleteHeader(hdr);</span>
<a href="#l26.3565"></a><span id="l26.3565">     }</span>
<a href="#l26.3566"></a><span id="l26.3566">   },</span>
<a href="#l26.3567"></a><span id="l26.3567"> </span>
<a href="#l26.3568"></a><span id="l26.3568" class="difflineplus">+  // called just before sending</span>
<a href="#l26.3569"></a><span id="l26.3569">   modifyCompFields: function() {</span>
<a href="#l26.3570"></a><span id="l26.3570" class="difflineminus">-</span>
<a href="#l26.3571"></a><span id="l26.3571">     try {</span>
<a href="#l26.3572"></a><span id="l26.3572"> </span>
<a href="#l26.3573"></a><span id="l26.3573">       if (!this.identity) {</span>
<a href="#l26.3574"></a><span id="l26.3574">         this.identity = getCurrentIdentity();</span>
<a href="#l26.3575"></a><span id="l26.3575">       }</span>
<a href="#l26.3576"></a><span id="l26.3576"> </span>
<a href="#l26.3577"></a><span id="l26.3577" class="difflineminus">-      if (this.isEnigmailEnabled()) {</span>
<a href="#l26.3578"></a><span id="l26.3578" class="difflineplus">+      if (Enigmail.msg.isEnigmailEnabledForIdentity()) {</span>
<a href="#l26.3579"></a><span id="l26.3579">         if (EnigmailPrefs.getPref(&quot;addHeaders&quot;)) {</span>
<a href="#l26.3580"></a><span id="l26.3580">           this.setAdditionalHeader(&quot;X-Enigmail-Version&quot;, EnigmailApp.getVersion());</span>
<a href="#l26.3581"></a><span id="l26.3581">         }</span>
<a href="#l26.3582"></a><span id="l26.3582"> </span>
<a href="#l26.3583"></a><span id="l26.3583" class="difflineminus">-        this.setAutocryptHeader();</span>
<a href="#l26.3584"></a><span id="l26.3584" class="difflineplus">+        //this.setAutocryptHeader();</span>
<a href="#l26.3585"></a><span id="l26.3585">       }</span>
<a href="#l26.3586"></a><span id="l26.3586">     }</span>
<a href="#l26.3587"></a><span id="l26.3587">     catch (ex) {</span>
<a href="#l26.3588"></a><span id="l26.3588">       EnigmailLog.writeException(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.modifyCompFields&quot;, ex);</span>
<a href="#l26.3589"></a><span id="l26.3589">     }</span>
<a href="#l26.3590"></a><span id="l26.3590">   },</span>
<a href="#l26.3591"></a><span id="l26.3591"> </span>
<a href="#l26.3592"></a><span id="l26.3592">   getCurrentIncomingServer: function() {</span>
<a href="#l26.3593"></a><span id="l26.3593">     let currentAccountKey = getCurrentAccountKey();</span>
<a href="#l26.3594"></a><span id="l26.3594">     let account = MailServices.accounts.getAccount(currentAccountKey);</span>
<a href="#l26.3595"></a><span id="l26.3595"> </span>
<a href="#l26.3596"></a><span id="l26.3596">     return account.incomingServer; /* returns nsIMsgIncomingServer */</span>
<a href="#l26.3597"></a><span id="l26.3597">   },</span>
<a href="#l26.3598"></a><span id="l26.3598"> </span>
<a href="#l26.3599"></a><span id="l26.3599" class="difflineplus">+  /*</span>
<a href="#l26.3600"></a><span id="l26.3600">   setAutocryptHeader: function() {</span>
<a href="#l26.3601"></a><span id="l26.3601">     if (!this.isAutocryptEnabled()) return;</span>
<a href="#l26.3602"></a><span id="l26.3602"> </span>
<a href="#l26.3603"></a><span id="l26.3603">     this.identity = getCurrentIdentity();</span>
<a href="#l26.3604"></a><span id="l26.3604">     let fromMail = this.identity.email;</span>
<a href="#l26.3605"></a><span id="l26.3605"> </span>
<a href="#l26.3606"></a><span id="l26.3606">     try {</span>
<a href="#l26.3607"></a><span id="l26.3607">       fromMail = EnigmailFuncs.stripEmail(gMsgCompose.compFields.from);</span>
<a href="#l26.3608"></a><span id="l26.3608" class="difflineat">@@ -4450,45 +3093,104 @@ Enigmail.msg = {</span>
<a href="#l26.3609"></a><span id="l26.3609"> </span>
<a href="#l26.3610"></a><span id="l26.3610">       let k = key.getMinimalPubKey(fromMail);</span>
<a href="#l26.3611"></a><span id="l26.3611">       if (k.exitCode === 0) {</span>
<a href="#l26.3612"></a><span id="l26.3612">         let keyData = &quot; &quot; + k.keyData.replace(/(.{72})/g, &quot;$1\r\n &quot;).replace(/\r\n $/, &quot;&quot;);</span>
<a href="#l26.3613"></a><span id="l26.3613">         this.setAdditionalHeader('Autocrypt', 'addr=' + fromMail + prefMutual + '; keydata=\r\n' + keyData);</span>
<a href="#l26.3614"></a><span id="l26.3614">       }</span>
<a href="#l26.3615"></a><span id="l26.3615">     }</span>
<a href="#l26.3616"></a><span id="l26.3616">   },</span>
<a href="#l26.3617"></a><span id="l26.3617" class="difflineplus">+  */</span>
<a href="#l26.3618"></a><span id="l26.3618" class="difflineplus">+</span>
<a href="#l26.3619"></a><span id="l26.3619" class="difflineplus">+  fromChangedListener: function(event) {</span>
<a href="#l26.3620"></a><span id="l26.3620" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.fromChangedListener\n&quot;);</span>
<a href="#l26.3621"></a><span id="l26.3621" class="difflineplus">+</span>
<a href="#l26.3622"></a><span id="l26.3622" class="difflineplus">+    /* TODO:</span>
<a href="#l26.3623"></a><span id="l26.3623" class="difflineplus">+     * reset gSendSigned, gAttachMyPublicPGPKey, gSendEncrypted, gOptionalEncryption</span>
<a href="#l26.3624"></a><span id="l26.3624" class="difflineplus">+     * to account's default setting, but only if settings haven't been touched</span>
<a href="#l26.3625"></a><span id="l26.3625" class="difflineplus">+     * by the user in this composer windows, i.e. check</span>
<a href="#l26.3626"></a><span id="l26.3626" class="difflineplus">+     * gUserTouchedSendEncrypted, gUserTouchedSendSigned, gUserTouchedAttachMyPubKey</span>
<a href="#l26.3627"></a><span id="l26.3627" class="difflineplus">+     */</span>
<a href="#l26.3628"></a><span id="l26.3628" class="difflineplus">+    return;</span>
<a href="#l26.3629"></a><span id="l26.3629" class="difflineplus">+</span>
<a href="#l26.3630"></a><span id="l26.3630" class="difflineplus">+    /*</span>
<a href="#l26.3631"></a><span id="l26.3631" class="difflineplus">+  if (!gSMFields) {</span>
<a href="#l26.3632"></a><span id="l26.3632" class="difflineplus">+    return;</span>
<a href="#l26.3633"></a><span id="l26.3633" class="difflineplus">+  }</span>
<a href="#l26.3634"></a><span id="l26.3634" class="difflineplus">+</span>
<a href="#l26.3635"></a><span id="l26.3635" class="difflineplus">+  var encryptionPolicy = gCurrentIdentity.getIntAttribute(&quot;encryptionpolicy&quot;);</span>
<a href="#l26.3636"></a><span id="l26.3636" class="difflineplus">+  var useEncryption = false;</span>
<a href="#l26.3637"></a><span id="l26.3637" class="difflineplus">+  if (!gEncryptOptionChanged) {</span>
<a href="#l26.3638"></a><span id="l26.3638" class="difflineplus">+    // Encryption wasn't manually checked.</span>
<a href="#l26.3639"></a><span id="l26.3639" class="difflineplus">+    // Set up the encryption policy from the setting of the new identity.</span>
<a href="#l26.3640"></a><span id="l26.3640" class="difflineplus">+</span>
<a href="#l26.3641"></a><span id="l26.3641" class="difflineplus">+    useEncryption = encryptionPolicy == kEncryptionPolicy_Always;</span>
<a href="#l26.3642"></a><span id="l26.3642" class="difflineplus">+  } else if (encryptionPolicy != kEncryptionPolicy_Always) {</span>
<a href="#l26.3643"></a><span id="l26.3643" class="difflineplus">+    // The encryption policy was manually checked. That means we can get into</span>
<a href="#l26.3644"></a><span id="l26.3644" class="difflineplus">+    // the situation that the new identity doesn't have a cert to encrypt with.</span>
<a href="#l26.3645"></a><span id="l26.3645" class="difflineplus">+    // If it doesn't, don't encrypt.</span>
<a href="#l26.3646"></a><span id="l26.3646" class="difflineplus">+</span>
<a href="#l26.3647"></a><span id="l26.3647" class="difflineplus">+    // Encrypted (policy unencrypted, manually changed).</span>
<a href="#l26.3648"></a><span id="l26.3648" class="difflineplus">+    // Make sure we have a cert for encryption.</span>
<a href="#l26.3649"></a><span id="l26.3649" class="difflineplus">+    useEncryption = !!gCurrentIdentity.getUnicharAttribute(</span>
<a href="#l26.3650"></a><span id="l26.3650" class="difflineplus">+      &quot;encryption_cert_name&quot;</span>
<a href="#l26.3651"></a><span id="l26.3651" class="difflineplus">+    );</span>
<a href="#l26.3652"></a><span id="l26.3652" class="difflineplus">+  }</span>
<a href="#l26.3653"></a><span id="l26.3653" class="difflineplus">+  gSMFields.requireEncryptMessage = useEncryption;</span>
<a href="#l26.3654"></a><span id="l26.3654" class="difflineplus">+  if (useEncryption) {</span>
<a href="#l26.3655"></a><span id="l26.3655" class="difflineplus">+    setEncryptionUI();</span>
<a href="#l26.3656"></a><span id="l26.3656" class="difflineplus">+  } else {</span>
<a href="#l26.3657"></a><span id="l26.3657" class="difflineplus">+    setNoEncryptionUI();</span>
<a href="#l26.3658"></a><span id="l26.3658" class="difflineplus">+  }</span>
<a href="#l26.3659"></a><span id="l26.3659" class="difflineplus">+</span>
<a href="#l26.3660"></a><span id="l26.3660" class="difflineplus">+  var signMessage = gCurrentIdentity.getBoolAttribute(&quot;sign_mail&quot;);</span>
<a href="#l26.3661"></a><span id="l26.3661" class="difflineplus">+  var useSigning = false;</span>
<a href="#l26.3662"></a><span id="l26.3662" class="difflineplus">+  if (!gSignOptionChanged) {</span>
<a href="#l26.3663"></a><span id="l26.3663" class="difflineplus">+    // Signing wasn't manually checked.</span>
<a href="#l26.3664"></a><span id="l26.3664" class="difflineplus">+    // Set up the signing policy from the setting of the new identity.</span>
<a href="#l26.3665"></a><span id="l26.3665" class="difflineplus">+</span>
<a href="#l26.3666"></a><span id="l26.3666" class="difflineplus">+    useSigning = signMessage;</span>
<a href="#l26.3667"></a><span id="l26.3667" class="difflineplus">+  } else if (!signMessage) {</span>
<a href="#l26.3668"></a><span id="l26.3668" class="difflineplus">+    // The signing policy was manually checked. That means we can get into</span>
<a href="#l26.3669"></a><span id="l26.3669" class="difflineplus">+    // the situation that the new identity doesn't have a cert to sign with.</span>
<a href="#l26.3670"></a><span id="l26.3670" class="difflineplus">+    // If it doesn't, don't sign.</span>
<a href="#l26.3671"></a><span id="l26.3671" class="difflineplus">+</span>
<a href="#l26.3672"></a><span id="l26.3672" class="difflineplus">+    // Signed (policy unsigned, manually changed).</span>
<a href="#l26.3673"></a><span id="l26.3673" class="difflineplus">+    // Make sure we have a cert for signing.</span>
<a href="#l26.3674"></a><span id="l26.3674" class="difflineplus">+    useSigning = !!gCurrentIdentity.getUnicharAttribute(&quot;signing_cert_name&quot;);</span>
<a href="#l26.3675"></a><span id="l26.3675" class="difflineplus">+  }</span>
<a href="#l26.3676"></a><span id="l26.3676" class="difflineplus">+  gSMFields.signMessage = useSigning;</span>
<a href="#l26.3677"></a><span id="l26.3677" class="difflineplus">+  if (useSigning) {</span>
<a href="#l26.3678"></a><span id="l26.3678" class="difflineplus">+    setSignatureUI();</span>
<a href="#l26.3679"></a><span id="l26.3679" class="difflineplus">+  } else {</span>
<a href="#l26.3680"></a><span id="l26.3680" class="difflineplus">+    setNoSignatureUI();</span>
<a href="#l26.3681"></a><span id="l26.3681" class="difflineplus">+  }</span>
<a href="#l26.3682"></a><span id="l26.3682" class="difflineplus">+    */</span>
<a href="#l26.3683"></a><span id="l26.3683" class="difflineplus">+</span>
<a href="#l26.3684"></a><span id="l26.3684" class="difflineplus">+  },</span>
<a href="#l26.3685"></a><span id="l26.3685" class="difflineplus">+</span>
<a href="#l26.3686"></a><span id="l26.3686" class="difflineplus">+  /**</span>
<a href="#l26.3687"></a><span id="l26.3687" class="difflineplus">+   * Perform handling of the compose-send-message' event from TB (or SendLater)</span>
<a href="#l26.3688"></a><span id="l26.3688" class="difflineplus">+   */</span>
<a href="#l26.3689"></a><span id="l26.3689"> </span>
<a href="#l26.3690"></a><span id="l26.3690">   /**</span>
<a href="#l26.3691"></a><span id="l26.3691">    * Handle the 'compose-send-message' event from TB</span>
<a href="#l26.3692"></a><span id="l26.3692">    */</span>
<a href="#l26.3693"></a><span id="l26.3693">   sendMessageListener: function(event) {</span>
<a href="#l26.3694"></a><span id="l26.3694" class="difflineplus">+    console.debug(&quot;in Enigmail.msg.sendMessageListener&quot;);</span>
<a href="#l26.3695"></a><span id="l26.3695">     EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.sendMessageListener\n&quot;);</span>
<a href="#l26.3696"></a><span id="l26.3696"> </span>
<a href="#l26.3697"></a><span id="l26.3697" class="difflineminus">-    // Do nothing if a compatible version of the &quot;SendLater&quot; addon is installed.</span>
<a href="#l26.3698"></a><span id="l26.3698" class="difflineminus">-    // SendLater will call handleSendMessageEvent when needed.</span>
<a href="#l26.3699"></a><span id="l26.3699" class="difflineminus">-</span>
<a href="#l26.3700"></a><span id="l26.3700" class="difflineminus">-    try {</span>
<a href="#l26.3701"></a><span id="l26.3701" class="difflineminus">-      if (typeof(Sendlater3Composing.callEnigmail) === &quot;function&quot;) {</span>
<a href="#l26.3702"></a><span id="l26.3702" class="difflineminus">-        return;</span>
<a href="#l26.3703"></a><span id="l26.3703" class="difflineminus">-      }</span>
<a href="#l26.3704"></a><span id="l26.3704" class="difflineplus">+    if (!gSelectedTechnologyIsPGP) {</span>
<a href="#l26.3705"></a><span id="l26.3705" class="difflineplus">+      return;</span>
<a href="#l26.3706"></a><span id="l26.3706">     }</span>
<a href="#l26.3707"></a><span id="l26.3707" class="difflineminus">-    catch (ex) {}</span>
<a href="#l26.3708"></a><span id="l26.3708" class="difflineminus">-</span>
<a href="#l26.3709"></a><span id="l26.3709" class="difflineminus">-    Enigmail.msg.handleSendMessageEvent(event);</span>
<a href="#l26.3710"></a><span id="l26.3710" class="difflineminus">-  },</span>
<a href="#l26.3711"></a><span id="l26.3711" class="difflineminus">-</span>
<a href="#l26.3712"></a><span id="l26.3712" class="difflineminus">-  /**</span>
<a href="#l26.3713"></a><span id="l26.3713" class="difflineminus">-   * Perform handling of the compose-send-message' event from TB (or SendLater)</span>
<a href="#l26.3714"></a><span id="l26.3714" class="difflineminus">-   */</span>
<a href="#l26.3715"></a><span id="l26.3715" class="difflineminus">-  handleSendMessageEvent: function(event) {</span>
<a href="#l26.3716"></a><span id="l26.3716" class="difflineminus">-    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.handleSendMessageEvent\n&quot;);</span>
<a href="#l26.3717"></a><span id="l26.3717" class="difflineplus">+    </span>
<a href="#l26.3718"></a><span id="l26.3718">     let msgcomposeWindow = document.getElementById(&quot;msgcomposeWindow&quot;);</span>
<a href="#l26.3719"></a><span id="l26.3719">     let sendMsgType = Number(msgcomposeWindow.getAttribute(&quot;msgtype&quot;));</span>
<a href="#l26.3720"></a><span id="l26.3720"> </span>
<a href="#l26.3721"></a><span id="l26.3721" class="difflineminus">-    if (!(this.sendProcess &amp;&amp; sendMsgType == Components.interfaces.nsIMsgCompDeliverMode.AutoSaveAsDraft)) {</span>
<a href="#l26.3722"></a><span id="l26.3722" class="difflineplus">+    if (!this.sendProcess || sendMsgType != Components.interfaces.nsIMsgCompDeliverMode.AutoSaveAsDraft) {</span>
<a href="#l26.3723"></a><span id="l26.3723">       this.sendProcess = true;</span>
<a href="#l26.3724"></a><span id="l26.3724">       //let bc = document.getElementById(&quot;enigmail-bc-sendprocess&quot;);</span>
<a href="#l26.3725"></a><span id="l26.3725"> </span>
<a href="#l26.3726"></a><span id="l26.3726">       try {</span>
<a href="#l26.3727"></a><span id="l26.3727">         this.modifyCompFields();</span>
<a href="#l26.3728"></a><span id="l26.3728">         //bc.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l26.3729"></a><span id="l26.3729">         if (!this.encryptMsg(sendMsgType)) {</span>
<a href="#l26.3730"></a><span id="l26.3730">           this.resetUpdatedFields();</span>
<a href="#l26.3731"></a><span id="l26.3731" class="difflineat">@@ -4773,20 +3475,24 @@ Enigmail.msg = {</span>
<a href="#l26.3732"></a><span id="l26.3732">     var plainText = &quot;&quot;;</span>
<a href="#l26.3733"></a><span id="l26.3733"> </span>
<a href="#l26.3734"></a><span id="l26.3734">     plainText = EnigmailDecryption.decryptMessage(window, uiFlags, cipherText,</span>
<a href="#l26.3735"></a><span id="l26.3735">       signatureObj, exitCodeObj, statusFlagsObj,</span>
<a href="#l26.3736"></a><span id="l26.3736">       keyIdObj, userIdObj, sigDetailsObj,</span>
<a href="#l26.3737"></a><span id="l26.3737">       errorMsgObj, blockSeparationObj, encToDetailsObj);</span>
<a href="#l26.3738"></a><span id="l26.3738">     // Decode plaintext from charset to unicode</span>
<a href="#l26.3739"></a><span id="l26.3739">     plainText = EnigmailData.convertToUnicode(plainText, charset).replace(/\r\n/g, &quot;\n&quot;);</span>
<a href="#l26.3740"></a><span id="l26.3740" class="difflineminus">-    if (EnigmailPrefs.getPref(&quot;keepSettingsForReply&quot;)) {</span>
<a href="#l26.3741"></a><span id="l26.3741" class="difflineminus">-      if (statusFlagsObj.value &amp; EnigmailConstants.DECRYPTION_OKAY)</span>
<a href="#l26.3742"></a><span id="l26.3742" class="difflineminus">-        this.setSendMode('encrypt');</span>
<a href="#l26.3743"></a><span id="l26.3743" class="difflineminus">-    }</span>
<a href="#l26.3744"></a><span id="l26.3744" class="difflineplus">+</span>
<a href="#l26.3745"></a><span id="l26.3745" class="difflineplus">+    //if (EnigmailPrefs.getPref(&quot;keepSettingsForReply&quot;)) {</span>
<a href="#l26.3746"></a><span id="l26.3746" class="difflineplus">+      if (statusFlagsObj.value &amp; EnigmailConstants.DECRYPTION_OKAY) {</span>
<a href="#l26.3747"></a><span id="l26.3747" class="difflineplus">+        //this.setSendMode('encrypt');</span>
<a href="#l26.3748"></a><span id="l26.3748" class="difflineplus">+        gIsRelatedToEncryptedOriginal = true;</span>
<a href="#l26.3749"></a><span id="l26.3749" class="difflineplus">+        gSendEncrypted = true;</span>
<a href="#l26.3750"></a><span id="l26.3750" class="difflineplus">+      }</span>
<a href="#l26.3751"></a><span id="l26.3751" class="difflineplus">+    //}</span>
<a href="#l26.3752"></a><span id="l26.3752"> </span>
<a href="#l26.3753"></a><span id="l26.3753">     var exitCode = exitCodeObj.value;</span>
<a href="#l26.3754"></a><span id="l26.3754"> </span>
<a href="#l26.3755"></a><span id="l26.3755">     if (exitCode !== 0) {</span>
<a href="#l26.3756"></a><span id="l26.3756">       // Error processing</span>
<a href="#l26.3757"></a><span id="l26.3757">       var errorMsg = errorMsgObj.value;</span>
<a href="#l26.3758"></a><span id="l26.3758"> </span>
<a href="#l26.3759"></a><span id="l26.3759">       var statusLines = errorMsg.split(/\r?\n/);</span>
<a href="#l26.3760"></a><span id="l26.3760" class="difflineat">@@ -4926,17 +3632,17 @@ Enigmail.msg = {</span>
<a href="#l26.3761"></a><span id="l26.3761">           }</span>
<a href="#l26.3762"></a><span id="l26.3762">       }</span>
<a href="#l26.3763"></a><span id="l26.3763"> </span>
<a href="#l26.3764"></a><span id="l26.3764">       this.editor.selectionController.scrollSelectionIntoView(nsISelectionController.SELECTION_NORMAL,</span>
<a href="#l26.3765"></a><span id="l26.3765">         nsISelectionController.SELECTION_ANCHOR_REGION,</span>
<a href="#l26.3766"></a><span id="l26.3766">         true);</span>
<a href="#l26.3767"></a><span id="l26.3767">     }</span>
<a href="#l26.3768"></a><span id="l26.3768"> </span>
<a href="#l26.3769"></a><span id="l26.3769" class="difflineminus">-    this.processFinalState();</span>
<a href="#l26.3770"></a><span id="l26.3770" class="difflineplus">+    //this.processFinalState();</span>
<a href="#l26.3771"></a><span id="l26.3771">     this.updateStatusBar();</span>
<a href="#l26.3772"></a><span id="l26.3772">   },</span>
<a href="#l26.3773"></a><span id="l26.3773"> </span>
<a href="#l26.3774"></a><span id="l26.3774">   checkInlinePgpReply: function(head, tail) {</span>
<a href="#l26.3775"></a><span id="l26.3775">     const CT = Components.interfaces.nsIMsgCompType;</span>
<a href="#l26.3776"></a><span id="l26.3776">     if (!this.identity) return;</span>
<a href="#l26.3777"></a><span id="l26.3777"> </span>
<a href="#l26.3778"></a><span id="l26.3778">     let hLines = (head.search(/[^\s&gt;]/) &lt; 0 ? 0 : 1);</span>
<a href="#l26.3779"></a><span id="l26.3779" class="difflineat">@@ -5142,17 +3848,17 @@ Enigmail.msg = {</span>
<a href="#l26.3780"></a><span id="l26.3780">       if (r !== subjElem.value) {</span>
<a href="#l26.3781"></a><span id="l26.3781">         subjElem.value = r;</span>
<a href="#l26.3782"></a><span id="l26.3782">         if (typeof subjElem.oninput === &quot;function&quot;) subjElem.oninput();</span>
<a href="#l26.3783"></a><span id="l26.3783">       }</span>
<a href="#l26.3784"></a><span id="l26.3784">     }</span>
<a href="#l26.3785"></a><span id="l26.3785">   },</span>
<a href="#l26.3786"></a><span id="l26.3786"> </span>
<a href="#l26.3787"></a><span id="l26.3787">   fireSearchKeys: function() {</span>
<a href="#l26.3788"></a><span id="l26.3788" class="difflineminus">-    if (this.isEnigmailEnabled()) {</span>
<a href="#l26.3789"></a><span id="l26.3789" class="difflineplus">+    if (Enigmail.msg.isEnigmailEnabledForIdentity()) {</span>
<a href="#l26.3790"></a><span id="l26.3790"> </span>
<a href="#l26.3791"></a><span id="l26.3791">       if (this.searchKeysTimeout) return;</span>
<a href="#l26.3792"></a><span id="l26.3792"> </span>
<a href="#l26.3793"></a><span id="l26.3793">       let self = this;</span>
<a href="#l26.3794"></a><span id="l26.3794"> </span>
<a href="#l26.3795"></a><span id="l26.3795">       this.searchKeysTimeout = EnigmailTimer.setTimeout(function _f() {</span>
<a href="#l26.3796"></a><span id="l26.3796">           self.searchKeysTimeout = null;</span>
<a href="#l26.3797"></a><span id="l26.3797">           Enigmail.msg.findMissingKeys();</span>
<a href="#l26.3798"></a><span id="l26.3798" class="difflineat">@@ -5186,26 +3892,32 @@ Enigmail.msg = {</span>
<a href="#l26.3799"></a><span id="l26.3799">             this.keyLookupDone.push(k);</span>
<a href="#l26.3800"></a><span id="l26.3800">           }</span>
<a href="#l26.3801"></a><span id="l26.3801">         }</span>
<a href="#l26.3802"></a><span id="l26.3802"> </span>
<a href="#l26.3803"></a><span id="l26.3803">         if (lookupList.length &gt; 0) {</span>
<a href="#l26.3804"></a><span id="l26.3804">           try {</span>
<a href="#l26.3805"></a><span id="l26.3805">             let foundKeys;</span>
<a href="#l26.3806"></a><span id="l26.3806"> </span>
<a href="#l26.3807"></a><span id="l26.3807" class="difflineplus">+            /*</span>
<a href="#l26.3808"></a><span id="l26.3808">             if (this.isAutocryptEnabled()) {</span>
<a href="#l26.3809"></a><span id="l26.3809">               foundKeys = await EnigmailAutocrypt.importAutocryptKeys(lookupList, this.encryptForced === EnigmailConstants.ENIG_ALWAYS);</span>
<a href="#l26.3810"></a><span id="l26.3810">               EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: findMissingKeys: got &quot; + foundKeys.length + &quot; autocrypt keys\n&quot;);</span>
<a href="#l26.3811"></a><span id="l26.3811">               if (foundKeys.length &gt; 0) {</span>
<a href="#l26.3812"></a><span id="l26.3812">                 this.determineSendFlags();</span>
<a href="#l26.3813"></a><span id="l26.3813">               }</span>
<a href="#l26.3814"></a><span id="l26.3814">             }</span>
<a href="#l26.3815"></a><span id="l26.3815" class="difflineminus">-</span>
<a href="#l26.3816"></a><span id="l26.3816" class="difflineminus">-            if (EnigmailPrefs.getPref(&quot;autoWkdLookup&quot;) === 0) return;</span>
<a href="#l26.3817"></a><span id="l26.3817" class="difflineminus">-            if (foundKeys.length &gt;= lookupList.length) return;</span>
<a href="#l26.3818"></a><span id="l26.3818" class="difflineplus">+            */</span>
<a href="#l26.3819"></a><span id="l26.3819" class="difflineplus">+</span>
<a href="#l26.3820"></a><span id="l26.3820" class="difflineplus">+            if (EnigmailPrefs.getPref(&quot;autoWkdLookup&quot;) === 0) {</span>
<a href="#l26.3821"></a><span id="l26.3821" class="difflineplus">+              return;</span>
<a href="#l26.3822"></a><span id="l26.3822" class="difflineplus">+            }</span>
<a href="#l26.3823"></a><span id="l26.3823" class="difflineplus">+            </span>
<a href="#l26.3824"></a><span id="l26.3824" class="difflineplus">+            // old buggy: if autocrypt is disabled, foundKeys is still undefined</span>
<a href="#l26.3825"></a><span id="l26.3825" class="difflineplus">+            // if (foundKeys.length &gt;= lookupList.length) return;</span>
<a href="#l26.3826"></a><span id="l26.3826"> </span>
<a href="#l26.3827"></a><span id="l26.3827">             foundKeys = await EnigmailWkdLookup.findKeys(lookupList);</span>
<a href="#l26.3828"></a><span id="l26.3828">             EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: findMissingKeys: wkd got &quot; + foundKeys + &quot;\n&quot;);</span>
<a href="#l26.3829"></a><span id="l26.3829">             if (foundKeys) {</span>
<a href="#l26.3830"></a><span id="l26.3830">               this.determineSendFlags();</span>
<a href="#l26.3831"></a><span id="l26.3831">             }</span>
<a href="#l26.3832"></a><span id="l26.3832">           }</span>
<a href="#l26.3833"></a><span id="l26.3833">           catch (err) {</span>
<a href="#l26.3834"></a><span id="l26.3834" class="difflineat">@@ -5260,17 +3972,17 @@ Enigmail.composeStateListener = {</span>
<a href="#l26.3835"></a><span id="l26.3835">   },</span>
<a href="#l26.3836"></a><span id="l26.3836"> </span>
<a href="#l26.3837"></a><span id="l26.3837">   ComposeProcessDone: function(aResult) {</span>
<a href="#l26.3838"></a><span id="l26.3838">     // Note: called after a mail was sent (or saved)</span>
<a href="#l26.3839"></a><span id="l26.3839">     EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: ECSL.ComposeProcessDone: &quot; + aResult + &quot;\n&quot;);</span>
<a href="#l26.3840"></a><span id="l26.3840"> </span>
<a href="#l26.3841"></a><span id="l26.3841">     if (aResult != Components.results.NS_OK) {</span>
<a href="#l26.3842"></a><span id="l26.3842">       if (Enigmail.msg.processed) {</span>
<a href="#l26.3843"></a><span id="l26.3843" class="difflineminus">-        Enigmail.msg.undoEncryption(4);</span>
<a href="#l26.3844"></a><span id="l26.3844" class="difflineplus">+        //Enigmail.msg.undoEncryption(4);</span>
<a href="#l26.3845"></a><span id="l26.3845">       }</span>
<a href="#l26.3846"></a><span id="l26.3846">       Enigmail.msg.removeAttachedKey();</span>
<a href="#l26.3847"></a><span id="l26.3847">     }</span>
<a href="#l26.3848"></a><span id="l26.3848"> </span>
<a href="#l26.3849"></a><span id="l26.3849">     // ensure that securityInfo is set back to S/MIME flags (especially required if draft was saved)</span>
<a href="#l26.3850"></a><span id="l26.3850">     if (gSMFields) Enigmail.msg.setSecurityParams(gSMFields);</span>
<a href="#l26.3851"></a><span id="l26.3851">   },</span>
<a href="#l26.3852"></a><span id="l26.3852"> </span>
<a href="#l26.3853"></a><span id="l26.3853" class="difflineat">@@ -5281,59 +3993,61 @@ Enigmail.composeStateListener = {</span>
<a href="#l26.3854"></a><span id="l26.3854">       isEditable;</span>
<a href="#l26.3855"></a><span id="l26.3855"> </span>
<a href="#l26.3856"></a><span id="l26.3856">     isEmpty = Enigmail.msg.editor.documentIsEmpty;</span>
<a href="#l26.3857"></a><span id="l26.3857">     isEditable = Enigmail.msg.editor.isDocumentEditable;</span>
<a href="#l26.3858"></a><span id="l26.3858">     Enigmail.msg.composeBodyReady = true;</span>
<a href="#l26.3859"></a><span id="l26.3859"> </span>
<a href="#l26.3860"></a><span id="l26.3860">     EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: ECSL.ComposeBodyReady: isEmpty=&quot; + isEmpty + &quot;, isEditable=&quot; + isEditable + &quot;\n&quot;);</span>
<a href="#l26.3861"></a><span id="l26.3861"> </span>
<a href="#l26.3862"></a><span id="l26.3862" class="difflineplus">+    /*</span>
<a href="#l26.3863"></a><span id="l26.3863">     if (Enigmail.msg.disableSmime) {</span>
<a href="#l26.3864"></a><span id="l26.3864">       if (gMsgCompose &amp;&amp; gMsgCompose.compFields &amp;&amp; Enigmail.msg.getSecurityParams()) {</span>
<a href="#l26.3865"></a><span id="l26.3865">         let si = Enigmail.msg.getSecurityParams(null, true);</span>
<a href="#l26.3866"></a><span id="l26.3866">         si.signMessage = false;</span>
<a href="#l26.3867"></a><span id="l26.3867">         si.requireEncryptMessage = false;</span>
<a href="#l26.3868"></a><span id="l26.3868">       }</span>
<a href="#l26.3869"></a><span id="l26.3869">       else {</span>
<a href="#l26.3870"></a><span id="l26.3870">         EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: ECSL.ComposeBodyReady: could not disable S/MIME\n&quot;);</span>
<a href="#l26.3871"></a><span id="l26.3871">       }</span>
<a href="#l26.3872"></a><span id="l26.3872">     }</span>
<a href="#l26.3873"></a><span id="l26.3873" class="difflineplus">+    */</span>
<a href="#l26.3874"></a><span id="l26.3874"> </span>
<a href="#l26.3875"></a><span id="l26.3875">     if (!isEditable || isEmpty)</span>
<a href="#l26.3876"></a><span id="l26.3876">       return;</span>
<a href="#l26.3877"></a><span id="l26.3877"> </span>
<a href="#l26.3878"></a><span id="l26.3878">     let msgHdr = Enigmail.msg.getMsgHdr();</span>
<a href="#l26.3879"></a><span id="l26.3879">     if (msgHdr) {</span>
<a href="#l26.3880"></a><span id="l26.3880">       Enigmail.msg.setOriginalSubject(msgHdr.subject, true);</span>
<a href="#l26.3881"></a><span id="l26.3881">     }</span>
<a href="#l26.3882"></a><span id="l26.3882">     Enigmail.msg.fixMessageSubject();</span>
<a href="#l26.3883"></a><span id="l26.3883"> </span>
<a href="#l26.3884"></a><span id="l26.3884">     if (!Enigmail.msg.timeoutId &amp;&amp; !Enigmail.msg.dirty) {</span>
<a href="#l26.3885"></a><span id="l26.3885">       Enigmail.msg.timeoutId = EnigmailTimer.setTimeout(function() {</span>
<a href="#l26.3886"></a><span id="l26.3886">           Enigmail.msg.decryptQuote(false);</span>
<a href="#l26.3887"></a><span id="l26.3887">         },</span>
<a href="#l26.3888"></a><span id="l26.3888">         0);</span>
<a href="#l26.3889"></a><span id="l26.3889">     }</span>
<a href="#l26.3890"></a><span id="l26.3890" class="difflineminus">-</span>
<a href="#l26.3891"></a><span id="l26.3891">   },</span>
<a href="#l26.3892"></a><span id="l26.3892"> </span>
<a href="#l26.3893"></a><span id="l26.3893">   SaveInFolderDone: function(folderURI) {</span>
<a href="#l26.3894"></a><span id="l26.3894">     //EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: ECSL.SaveInFolderDone\n&quot;);</span>
<a href="#l26.3895"></a><span id="l26.3895">   }</span>
<a href="#l26.3896"></a><span id="l26.3896"> };</span>
<a href="#l26.3897"></a><span id="l26.3897"> </span>
<a href="#l26.3898"></a><span id="l26.3898"> </span>
<a href="#l26.3899"></a><span id="l26.3899"> /**</span>
<a href="#l26.3900"></a><span id="l26.3900">  * Unload Enigmail for update or uninstallation</span>
<a href="#l26.3901"></a><span id="l26.3901">  */</span>
<a href="#l26.3902"></a><span id="l26.3902"> Enigmail.composeUnload = function _unload_Enigmail() {</span>
<a href="#l26.3903"></a><span id="l26.3903">   window.removeEventListener(&quot;unload-enigmail&quot;, Enigmail.composeUnload, false);</span>
<a href="#l26.3904"></a><span id="l26.3904">   window.removeEventListener(&quot;load-enigmail&quot;, Enigmail.msg.composeStartup, false);</span>
<a href="#l26.3905"></a><span id="l26.3905">   window.removeEventListener(&quot;compose-window-unload&quot;, Enigmail.msg.msgComposeClose, true);</span>
<a href="#l26.3906"></a><span id="l26.3906" class="difflineminus">-  window.removeEventListener('compose-send-message', Enigmail.msg.sendMessageListener, true);</span>
<a href="#l26.3907"></a><span id="l26.3907" class="difflineplus">+  window.removeEventListener(&quot;compose-send-message&quot;, Enigmail.msg.sendMessageListener, true);</span>
<a href="#l26.3908"></a><span id="l26.3908" class="difflineplus">+  window.removeEventListener(&quot;compose-from-changed&quot;, Enigmail.msg.fromChangedListener, true);</span>
<a href="#l26.3909"></a><span id="l26.3909"> </span>
<a href="#l26.3910"></a><span id="l26.3910">   gMsgCompose.UnregisterStateListener(Enigmail.composeStateListener);</span>
<a href="#l26.3911"></a><span id="l26.3911"> </span>
<a href="#l26.3912"></a><span id="l26.3912">   let msgId = document.getElementById(&quot;msgIdentityPopup&quot;);</span>
<a href="#l26.3913"></a><span id="l26.3913">   if (msgId) {</span>
<a href="#l26.3914"></a><span id="l26.3914">     msgId.removeEventListener(&quot;command&quot;, Enigmail.msg.setIdentityCallback, false);</span>
<a href="#l26.3915"></a><span id="l26.3915">   }</span>
<a href="#l26.3916"></a><span id="l26.3916"> </span>
<a href="#l26.3917"></a><span id="l26.3917" class="difflineat">@@ -5354,22 +4068,17 @@ Enigmail.composeUnload = function _unloa</span>
<a href="#l26.3918"></a><span id="l26.3918">     let attr = adrCol.getAttribute(&quot;oncommand&quot;);</span>
<a href="#l26.3919"></a><span id="l26.3919">     adrCol.setAttribute(&quot;oncommand&quot;, attr.replace(rep, &quot;&quot;));</span>
<a href="#l26.3920"></a><span id="l26.3920">   }</span>
<a href="#l26.3921"></a><span id="l26.3921"> </span>
<a href="#l26.3922"></a><span id="l26.3922">   // finally unload Enigmail entirely</span>
<a href="#l26.3923"></a><span id="l26.3923">   Enigmail = undefined;</span>
<a href="#l26.3924"></a><span id="l26.3924"> };</span>
<a href="#l26.3925"></a><span id="l26.3925"> </span>
<a href="#l26.3926"></a><span id="l26.3926" class="difflineminus">-addEventListener(&quot;load&quot;, Enigmail.msg.composeStartup, { capture: false, once: true });</span>
<a href="#l26.3927"></a><span id="l26.3927" class="difflineplus">+addEventListener(&quot;load&quot;, Enigmail.msg.composeStartup.bind(Enigmail.msg), { capture: false, once: true });</span>
<a href="#l26.3928"></a><span id="l26.3928"> </span>
<a href="#l26.3929"></a><span id="l26.3929"> window.addEventListener(&quot;unload-enigmail&quot;,</span>
<a href="#l26.3930"></a><span id="l26.3930">   Enigmail.composeUnload.bind(Enigmail.msg),</span>
<a href="#l26.3931"></a><span id="l26.3931">   false);</span>
<a href="#l26.3932"></a><span id="l26.3932"> </span>
<a href="#l26.3933"></a><span id="l26.3933"> window.addEventListener('compose-window-unload',</span>
<a href="#l26.3934"></a><span id="l26.3934">   Enigmail.msg.msgComposeClose.bind(Enigmail.msg),</span>
<a href="#l26.3935"></a><span id="l26.3935">   true);</span>
<a href="#l26.3936"></a><span id="l26.3936" class="difflineminus">-</span>
<a href="#l26.3937"></a><span id="l26.3937" class="difflineminus">-// Listen to message sending event</span>
<a href="#l26.3938"></a><span id="l26.3938" class="difflineminus">-//window.addEventListener('compose-send-message',</span>
<a href="#l26.3939"></a><span id="l26.3939" class="difflineminus">-//  Enigmail.msg.sendMessageListener.bind(Enigmail.msg),</span>
<a href="#l26.3940"></a><span id="l26.3940" class="difflineminus">-//  true);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/mail/extensions/openpgp/prefs/openpgp-prefs.js</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/mail/extensions/openpgp/prefs/openpgp-prefs.js</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -248,21 +248,18 @@ pref(&quot;temp.openpgp.keyRefreshOn&quot;, false)</span>
<a href="#l27.4"></a><span id="l27.4"> pref(&quot;temp.openpgp.enableExperiments&quot;, false);</span>
<a href="#l27.5"></a><span id="l27.5"> </span>
<a href="#l27.6"></a><span id="l27.6"> </span>
<a href="#l27.7"></a><span id="l27.7"> /*</span>
<a href="#l27.8"></a><span id="l27.8">    Default pref values for the enigmail per-identity</span>
<a href="#l27.9"></a><span id="l27.9">    settings</span>
<a href="#l27.10"></a><span id="l27.10"> */</span>
<a href="#l27.11"></a><span id="l27.11"> </span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-pref(&quot;mail.identity.default.enablePgp&quot;, false);</span>
<a href="#l27.13"></a><span id="l27.13"> pref(&quot;mail.identity.default.pgpkeyId&quot;, &quot;&quot;);</span>
<a href="#l27.14"></a><span id="l27.14"> pref(&quot;mail.identity.default.pgpKeyMode&quot;, 0);</span>
<a href="#l27.15"></a><span id="l27.15" class="difflineminus">-pref(&quot;mail.identity.default.pgpSignPlain&quot;, false);</span>
<a href="#l27.16"></a><span id="l27.16" class="difflineminus">-pref(&quot;mail.identity.default.pgpSignEncrypted&quot;, true);</span>
<a href="#l27.17"></a><span id="l27.17"> pref(&quot;mail.identity.default.defaultSigningPolicy&quot;, 0);</span>
<a href="#l27.18"></a><span id="l27.18"> pref(&quot;mail.identity.default.defaultEncryptionPolicy&quot;, 0);</span>
<a href="#l27.19"></a><span id="l27.19"> pref(&quot;mail.identity.default.openPgpUrlName&quot;, &quot;&quot;);</span>
<a href="#l27.20"></a><span id="l27.20"> pref(&quot;mail.identity.default.pgpMimeMode&quot;, true);</span>
<a href="#l27.21"></a><span id="l27.21"> pref(&quot;mail.identity.default.attachPgpKey&quot;, false);</span>
<a href="#l27.22"></a><span id="l27.22"> pref(&quot;mail.identity.default.autoEncryptDrafts&quot;, true);</span>
<a href="#l27.23"></a><span id="l27.23"> pref(&quot;mail.identity.default.protectSubject&quot;, true);</span>
<a href="#l27.24"></a><span id="l27.24"> pref(&quot;mail.identity.default.warnWeakReply&quot;, false);</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:31Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

