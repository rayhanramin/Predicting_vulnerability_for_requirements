<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 6984:7cad2968cbb72b7d27d0d883630b8029373b668a</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 7cad2968cbb72b7d27d0d883630b8029373b668a" />
<meta property="og:url" content="/comm-central/rev/7cad2968cbb72b7d27d0d883630b8029373b668a" />
<meta property="og:description" content="keep imap offline stores up to date when messages are moved/copied (including fcc/save as draft), r=asuth, sr=standard8 bug 574441" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 7cad2968cbb72b7d27d0d883630b8029373b668a 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/7cad2968cbb72b7d27d0d883630b8029373b668a">shortlog</a> |
<a href="/comm-central/log/7cad2968cbb72b7d27d0d883630b8029373b668a">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/7cad2968cbb72b7d27d0d883630b8029373b668a">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/7cad2968cbb72b7d27d0d883630b8029373b668a">files</a> |
changeset |
<a href="/comm-central/raw-rev/7cad2968cbb72b7d27d0d883630b8029373b668a">raw</a>  | <a href="/comm-central/archive/7cad2968cbb72b7d27d0d883630b8029373b668a.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
keep imap offline stores up to date when messages are moved/copied (including fcc/save as draft), r=asuth, sr=standard8 <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=574441">bug 574441</a>
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#68;&#97;&#118;&#105;&#100;&#32;&#66;&#105;&#101;&#110;&#118;&#101;&#110;&#117;&#32;&#60;&#98;&#105;&#101;&#110;&#118;&#101;&#110;&#117;&#64;&#110;&#118;&#101;&#110;&#116;&#117;&#114;&#101;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 19 Jan 2011 12:32:50 -0800</td></tr>

<tr>
 <td>changeset 6984</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/7cad2968cbb72b7d27d0d883630b8029373b668a">7cad2968cbb72b7d27d0d883630b8029373b668a</a></td>
</tr>



<tr>
<td>parent 6983</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/c903a7fb5e32da8453142ef6b25a08370d330b4b">c903a7fb5e32da8453142ef6b25a08370d330b4b</a>
</td>
</tr>

<tr>
<td>child 6985</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/fefbbf03688aa4c322f3630c072c27f27c9c9f1d">fefbbf03688aa4c322f3630c072c27f27c9c9f1d</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=7cad2968cbb72b7d27d0d883630b8029373b668a">5354</a></td></tr>
<tr><td>push user</td><td>bienvenu@nventure.com</td></tr>
<tr><td>push date</td><td class="date age">Wed, 19 Jan 2011 20:32:10 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@7cad2968cbb7 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=7cad2968cbb72b7d27d0d883630b8029373b668a">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=7cad2968cbb72b7d27d0d883630b8029373b668a&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=7cad2968cbb72b7d27d0d883630b8029373b668a&newProject=comm-central&newRevision=7cad2968cbb72b7d27d0d883630b8029373b668a&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=7cad2968cbb72b7d27d0d883630b8029373b668a&newProject=comm-central&newRevision=7cad2968cbb72b7d27d0d883630b8029373b668a&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=7cad2968cbb72b7d27d0d883630b8029373b668a&newProject=comm-central&newRevision=7cad2968cbb72b7d27d0d883630b8029373b668a&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28asuth%29&revcount=50">asuth</a>, <a href="/comm-central/log?rev=reviewer%28standard8%29&revcount=50">standard8</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=574441">574441</a></td></tr>




</table></div>

<div class="page_body description">keep imap offline stores up to date when messages are moved/copied (including fcc/save as draft), r=asuth, sr=standard8 <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=574441">bug 574441</a></div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/base/public/nsIMsgFolderListener.idl">mailnews/base/public/nsIMsgFolderListener.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/base/public/nsIMsgFolderListener.idl">file</a> |
<a href="/comm-central/annotate/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/base/public/nsIMsgFolderListener.idl">annotate</a> |
<a href="/comm-central/diff/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/base/public/nsIMsgFolderListener.idl">diff</a> |
<a href="/comm-central/comparison/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/base/public/nsIMsgFolderListener.idl">comparison</a> |
<a href="/comm-central/log/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/base/public/nsIMsgFolderListener.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/base/public/nsIMsgFolderNotificationService.idl">mailnews/base/public/nsIMsgFolderNotificationService.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/base/public/nsIMsgFolderNotificationService.idl">file</a> |
<a href="/comm-central/annotate/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/base/public/nsIMsgFolderNotificationService.idl">annotate</a> |
<a href="/comm-central/diff/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/base/public/nsIMsgFolderNotificationService.idl">diff</a> |
<a href="/comm-central/comparison/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/base/public/nsIMsgFolderNotificationService.idl">comparison</a> |
<a href="/comm-central/log/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/base/public/nsIMsgFolderNotificationService.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/base/src/nsMsgFolderNotificationService.cpp">mailnews/base/src/nsMsgFolderNotificationService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/base/src/nsMsgFolderNotificationService.cpp">file</a> |
<a href="/comm-central/annotate/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/base/src/nsMsgFolderNotificationService.cpp">annotate</a> |
<a href="/comm-central/diff/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/base/src/nsMsgFolderNotificationService.cpp">diff</a> |
<a href="/comm-central/comparison/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/base/src/nsMsgFolderNotificationService.cpp">comparison</a> |
<a href="/comm-central/log/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/base/src/nsMsgFolderNotificationService.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/base/test/unit/test_nsIMsgFolderListener.js">mailnews/base/test/unit/test_nsIMsgFolderListener.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/base/test/unit/test_nsIMsgFolderListener.js">file</a> |
<a href="/comm-central/annotate/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/base/test/unit/test_nsIMsgFolderListener.js">annotate</a> |
<a href="/comm-central/diff/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/base/test/unit/test_nsIMsgFolderListener.js">diff</a> |
<a href="/comm-central/comparison/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/base/test/unit/test_nsIMsgFolderListener.js">comparison</a> |
<a href="/comm-central/log/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/base/test/unit/test_nsIMsgFolderListener.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/imap/public/nsIMsgImapMailFolder.idl">mailnews/imap/public/nsIMsgImapMailFolder.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/imap/public/nsIMsgImapMailFolder.idl">file</a> |
<a href="/comm-central/annotate/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/imap/public/nsIMsgImapMailFolder.idl">annotate</a> |
<a href="/comm-central/diff/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/imap/public/nsIMsgImapMailFolder.idl">diff</a> |
<a href="/comm-central/comparison/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/imap/public/nsIMsgImapMailFolder.idl">comparison</a> |
<a href="/comm-central/log/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/imap/public/nsIMsgImapMailFolder.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/imap/src/nsImapIncomingServer.cpp">mailnews/imap/src/nsImapIncomingServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/imap/src/nsImapIncomingServer.cpp">file</a> |
<a href="/comm-central/annotate/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/imap/src/nsImapIncomingServer.cpp">annotate</a> |
<a href="/comm-central/diff/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/imap/src/nsImapIncomingServer.cpp">diff</a> |
<a href="/comm-central/comparison/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/imap/src/nsImapIncomingServer.cpp">comparison</a> |
<a href="/comm-central/log/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/imap/src/nsImapIncomingServer.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/imap/src/nsImapMailFolder.cpp">mailnews/imap/src/nsImapMailFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/imap/src/nsImapMailFolder.cpp">file</a> |
<a href="/comm-central/annotate/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/imap/src/nsImapMailFolder.cpp">annotate</a> |
<a href="/comm-central/diff/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/imap/src/nsImapMailFolder.cpp">diff</a> |
<a href="/comm-central/comparison/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/imap/src/nsImapMailFolder.cpp">comparison</a> |
<a href="/comm-central/log/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/imap/src/nsImapMailFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/imap/src/nsImapMailFolder.h">mailnews/imap/src/nsImapMailFolder.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/imap/src/nsImapMailFolder.h">file</a> |
<a href="/comm-central/annotate/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/imap/src/nsImapMailFolder.h">annotate</a> |
<a href="/comm-central/diff/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/imap/src/nsImapMailFolder.h">diff</a> |
<a href="/comm-central/comparison/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/imap/src/nsImapMailFolder.h">comparison</a> |
<a href="/comm-central/log/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/imap/src/nsImapMailFolder.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/imap/src/nsImapOfflineSync.cpp">mailnews/imap/src/nsImapOfflineSync.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/imap/src/nsImapOfflineSync.cpp">file</a> |
<a href="/comm-central/annotate/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/imap/src/nsImapOfflineSync.cpp">annotate</a> |
<a href="/comm-central/diff/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/imap/src/nsImapOfflineSync.cpp">diff</a> |
<a href="/comm-central/comparison/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/imap/src/nsImapOfflineSync.cpp">comparison</a> |
<a href="/comm-central/log/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/imap/src/nsImapOfflineSync.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/imap/test/unit/test_imapAttachmentSaves.js">mailnews/imap/test/unit/test_imapAttachmentSaves.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/imap/test/unit/test_imapAttachmentSaves.js">file</a> |
<a href="/comm-central/annotate/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/imap/test/unit/test_imapAttachmentSaves.js">annotate</a> |
<a href="/comm-central/diff/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/imap/test/unit/test_imapAttachmentSaves.js">diff</a> |
<a href="/comm-central/comparison/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/imap/test/unit/test_imapAttachmentSaves.js">comparison</a> |
<a href="/comm-central/log/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/imap/test/unit/test_imapAttachmentSaves.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/imap/test/unit/test_nsIMsgFolderListenerIMAP.js">mailnews/imap/test/unit/test_nsIMsgFolderListenerIMAP.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/imap/test/unit/test_nsIMsgFolderListenerIMAP.js">file</a> |
<a href="/comm-central/annotate/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/imap/test/unit/test_nsIMsgFolderListenerIMAP.js">annotate</a> |
<a href="/comm-central/diff/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/imap/test/unit/test_nsIMsgFolderListenerIMAP.js">diff</a> |
<a href="/comm-central/comparison/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/imap/test/unit/test_nsIMsgFolderListenerIMAP.js">comparison</a> |
<a href="/comm-central/log/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/imap/test/unit/test_nsIMsgFolderListenerIMAP.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/local/src/nsRssIncomingServer.cpp">mailnews/local/src/nsRssIncomingServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/local/src/nsRssIncomingServer.cpp">file</a> |
<a href="/comm-central/annotate/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/local/src/nsRssIncomingServer.cpp">annotate</a> |
<a href="/comm-central/diff/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/local/src/nsRssIncomingServer.cpp">diff</a> |
<a href="/comm-central/comparison/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/local/src/nsRssIncomingServer.cpp">comparison</a> |
<a href="/comm-central/log/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/local/src/nsRssIncomingServer.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/test/resources/msgFolderListenerSetup.js">mailnews/test/resources/msgFolderListenerSetup.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/test/resources/msgFolderListenerSetup.js">file</a> |
<a href="/comm-central/annotate/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/test/resources/msgFolderListenerSetup.js">annotate</a> |
<a href="/comm-central/diff/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/test/resources/msgFolderListenerSetup.js">diff</a> |
<a href="/comm-central/comparison/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/test/resources/msgFolderListenerSetup.js">comparison</a> |
<a href="/comm-central/log/7cad2968cbb72b7d27d0d883630b8029373b668a/mailnews/test/resources/msgFolderListenerSetup.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/base/public/nsIMsgFolderListener.idl</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/base/public/nsIMsgFolderListener.idl</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -31,32 +31,33 @@</span>
<a href="#l1.4"></a><span id="l1.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l1.5"></a><span id="l1.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l1.6"></a><span id="l1.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l1.7"></a><span id="l1.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l1.8"></a><span id="l1.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l1.9"></a><span id="l1.9">  *</span>
<a href="#l1.10"></a><span id="l1.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l1.11"></a><span id="l1.11"> #include &quot;nsISupports.idl&quot;</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+#include &quot;MailNewsTypes2.idl&quot;</span>
<a href="#l1.13"></a><span id="l1.13"> </span>
<a href="#l1.14"></a><span id="l1.14"> interface nsIMsgDBHdr;</span>
<a href="#l1.15"></a><span id="l1.15"> interface nsIMsgFolder;</span>
<a href="#l1.16"></a><span id="l1.16"> interface nsIArray;</span>
<a href="#l1.17"></a><span id="l1.17"> </span>
<a href="#l1.18"></a><span id="l1.18"> /**</span>
<a href="#l1.19"></a><span id="l1.19">  * This is similar to nsIFolderListener, but with slightly different semantics,</span>
<a href="#l1.20"></a><span id="l1.20">  * especially w.r.t. moving messages and folders.  Some listeners want to know</span>
<a href="#l1.21"></a><span id="l1.21">  * about moves, instead of getting an itemAdded and itemRemoved notification.</span>
<a href="#l1.22"></a><span id="l1.22">  * Folder listeners also only tend to get called if a view is open on the folder,</span>
<a href="#l1.23"></a><span id="l1.23">  * which is not always the case. I don't want to change nsIFolderListener at this</span>
<a href="#l1.24"></a><span id="l1.24">  * point since there are lots of extensions that rely on it. Eventually,</span>
<a href="#l1.25"></a><span id="l1.25">  * these two interfaces should be combined somehow.</span>
<a href="#l1.26"></a><span id="l1.26">  */</span>
<a href="#l1.27"></a><span id="l1.27"> </span>
<a href="#l1.28"></a><span id="l1.28" class="difflineminus">-[scriptable, uuid(63533aa2-9e03-424c-b308-a3ee5ad47bc5)]</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineplus">+[scriptable, uuid(2f87be72-0565-4e64-a824-0eb9c258f884)]</span>
<a href="#l1.30"></a><span id="l1.30"> interface nsIMsgFolderListener : nsISupports {</span>
<a href="#l1.31"></a><span id="l1.31">   /**</span>
<a href="#l1.32"></a><span id="l1.32">    * Notified immediately after a message is added to a folder. This could be a</span>
<a href="#l1.33"></a><span id="l1.33">    * new incoming message to a local folder, or a new message in an IMAP folder</span>
<a href="#l1.34"></a><span id="l1.34">    * when it is opened.</span>
<a href="#l1.35"></a><span id="l1.35">    *</span>
<a href="#l1.36"></a><span id="l1.36">    * You may want to consider using the msgsClassified notification instead of</span>
<a href="#l1.37"></a><span id="l1.37">    * this notification if any of the following are true:</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineat">@@ -119,30 +120,51 @@ interface nsIMsgFolderListener : nsISupp</span>
<a href="#l1.39"></a><span id="l1.39">   /**</span>
<a href="#l1.40"></a><span id="l1.40">    * Notified after a command to move or copy a group of messages completes. In</span>
<a href="#l1.41"></a><span id="l1.41">    * case of a move, this is before the messages have been deleted from the</span>
<a href="#l1.42"></a><span id="l1.42">    * source folder.</span>
<a href="#l1.43"></a><span id="l1.43">    *</span>
<a href="#l1.44"></a><span id="l1.44">    * @param aMove true if a move, false if a copy</span>
<a href="#l1.45"></a><span id="l1.45">    * @param aSrcMsgs An array of the message headers in the source folder</span>
<a href="#l1.46"></a><span id="l1.46">    * @param aDestFolder The folder these messages were moved to.</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineminus">-   * @param aDestMsgs Present only for local folder moves, it provides the list</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineminus">-   *     of target message headers.</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineplus">+   * @param aDestMsgs This provides the list of target message headers.</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineplus">+                      For imap messages, these will be &quot;pseudo&quot; headers, with</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineplus">+                      a made up UID. When we download the &quot;real&quot; header, we</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineplus">+                      will send a msgKeyChanged notification. Currently, if</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineplus">+                      the imap move/copy happens strictly online (essentially,</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineplus">+                      not user-initiated), then aDestMsgs will be null.</span>
<a href="#l1.55"></a><span id="l1.55">    *</span>
<a href="#l1.56"></a><span id="l1.56">    * @note</span>
<a href="#l1.57"></a><span id="l1.57">    * If messages are moved from a server which uses the IMAP delete model,</span>
<a href="#l1.58"></a><span id="l1.58">    * you'll get aMove = false. That's because the messages are not deleted from</span>
<a href="#l1.59"></a><span id="l1.59">    * the source database, but instead simply marked deleted.</span>
<a href="#l1.60"></a><span id="l1.60">    */</span>
<a href="#l1.61"></a><span id="l1.61">   void msgsMoveCopyCompleted(in boolean aMove,</span>
<a href="#l1.62"></a><span id="l1.62">                              in nsIArray aSrcMsgs,</span>
<a href="#l1.63"></a><span id="l1.63">                              in nsIMsgFolder aDestFolder,</span>
<a href="#l1.64"></a><span id="l1.64">                              in nsIArray aDestMsgs);</span>
<a href="#l1.65"></a><span id="l1.65"> </span>
<a href="#l1.66"></a><span id="l1.66">   /**</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineplus">+   * Notification sent when the msg key for a header may have changed.</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineplus">+   * This is used when we create a header for an offline imap move result,</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineplus">+   * without knowing what the ultimate UID will be. When we download the</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineplus">+   * headers for the new message, we replace the old &quot;pseudo&quot; header with</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineplus">+   * a new header that has the correct UID/message key. The uid of the new hdr</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineplus">+   * may turn out to be the same as aOldKey if we've guessed correctly but</span>
<a href="#l1.73"></a><span id="l1.73" class="difflineplus">+   * the listener can use this notification to know that it can ignore the</span>
<a href="#l1.74"></a><span id="l1.74" class="difflineplus">+   * msgAdded notification that's coming for aNewHdr. We do NOT send a</span>
<a href="#l1.75"></a><span id="l1.75" class="difflineplus">+   * msgsDeleted notification for the pseudo header.</span>
<a href="#l1.76"></a><span id="l1.76" class="difflineplus">+   *</span>
<a href="#l1.77"></a><span id="l1.77" class="difflineplus">+   * @param aOldKey The fake UID. The header with this key has been removed</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineplus">+   *                by the time this is called.</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineplus">+   * @param aNewHdr The header that replaces the header with aOldKey.</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineplus">+   */</span>
<a href="#l1.81"></a><span id="l1.81" class="difflineplus">+  void msgKeyChanged(in nsMsgKey aOldKey, in nsIMsgDBHdr aNewHdr);</span>
<a href="#l1.82"></a><span id="l1.82" class="difflineplus">+</span>
<a href="#l1.83"></a><span id="l1.83" class="difflineplus">+  /**</span>
<a href="#l1.84"></a><span id="l1.84">    * Notified after a folder has been added.</span>
<a href="#l1.85"></a><span id="l1.85">    *</span>
<a href="#l1.86"></a><span id="l1.86">    * @param aFolder The folder that has just been added</span>
<a href="#l1.87"></a><span id="l1.87">    */</span>
<a href="#l1.88"></a><span id="l1.88">   void folderAdded(in nsIMsgFolder aFolder);</span>
<a href="#l1.89"></a><span id="l1.89"> </span>
<a href="#l1.90"></a><span id="l1.90">   /**</span>
<a href="#l1.91"></a><span id="l1.91">    * Notified after a folder has been deleted and its corresponding file(s) deleted from disk.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/base/public/nsIMsgFolderNotificationService.idl</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/base/public/nsIMsgFolderNotificationService.idl</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -31,25 +31,26 @@</span>
<a href="#l2.4"></a><span id="l2.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l2.5"></a><span id="l2.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l2.6"></a><span id="l2.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l2.7"></a><span id="l2.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l2.8"></a><span id="l2.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l2.9"></a><span id="l2.9">  *</span>
<a href="#l2.10"></a><span id="l2.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l2.11"></a><span id="l2.11"> #include &quot;nsISupports.idl&quot;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+#include &quot;MailNewsTypes2.idl&quot;</span>
<a href="#l2.13"></a><span id="l2.13"> </span>
<a href="#l2.14"></a><span id="l2.14"> interface nsIMsgDBHdr;</span>
<a href="#l2.15"></a><span id="l2.15"> interface nsIMsgFolder;</span>
<a href="#l2.16"></a><span id="l2.16"> interface nsIMsgFolderListener;</span>
<a href="#l2.17"></a><span id="l2.17"> interface nsIArray;</span>
<a href="#l2.18"></a><span id="l2.18"> </span>
<a href="#l2.19"></a><span id="l2.19"> typedef unsigned long msgFolderListenerFlag;</span>
<a href="#l2.20"></a><span id="l2.20"> </span>
<a href="#l2.21"></a><span id="l2.21" class="difflineminus">-[scriptable, uuid(45420c55-b460-4a61-bd67-7f763a69a46e)]</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineplus">+[scriptable, uuid(e54a592c-2f23-4771-9670-bdb9d4f5dbbd)]</span>
<a href="#l2.23"></a><span id="l2.23"> interface nsIMsgFolderNotificationService : nsISupports {</span>
<a href="#l2.24"></a><span id="l2.24">   /**</span>
<a href="#l2.25"></a><span id="l2.25">    * @name Notification flags</span>
<a href="#l2.26"></a><span id="l2.26">    * These flags determine which notifications will be sent.</span>
<a href="#l2.27"></a><span id="l2.27">    * @{</span>
<a href="#l2.28"></a><span id="l2.28">    */</span>
<a href="#l2.29"></a><span id="l2.29">   /// nsIMsgFolderListener::msgAdded notification</span>
<a href="#l2.30"></a><span id="l2.30">   const msgFolderListenerFlag msgAdded = 0x1;</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineat">@@ -72,16 +73,20 @@ interface nsIMsgFolderNotificationServic</span>
<a href="#l2.32"></a><span id="l2.32">   /// nsIMsgFolderListener::folderMoveCopyCompleted notification</span>
<a href="#l2.33"></a><span id="l2.33">   const msgFolderListenerFlag folderMoveCopyCompleted = 0x2000;</span>
<a href="#l2.34"></a><span id="l2.34"> </span>
<a href="#l2.35"></a><span id="l2.35">   /// nsIMsgFolderListener::folderRenamed notification</span>
<a href="#l2.36"></a><span id="l2.36">   const msgFolderListenerFlag folderRenamed = 0x4000;</span>
<a href="#l2.37"></a><span id="l2.37"> </span>
<a href="#l2.38"></a><span id="l2.38">   /// nsIMsgFolderListener::itemEvent notification</span>
<a href="#l2.39"></a><span id="l2.39">   const msgFolderListenerFlag itemEvent = 0x1000000;</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+  /// nsIMsgFolderListener::msgKeyChanged notification</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineplus">+  const msgFolderListenerFlag msgKeyChanged = 0x2000000;</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineplus">+</span>
<a href="#l2.44"></a><span id="l2.44">   /** @} */</span>
<a href="#l2.45"></a><span id="l2.45"> </span>
<a href="#l2.46"></a><span id="l2.46">   readonly attribute boolean hasListeners;</span>
<a href="#l2.47"></a><span id="l2.47">   void addListener(in nsIMsgFolderListener aListener,</span>
<a href="#l2.48"></a><span id="l2.48">                    in msgFolderListenerFlag flags);</span>
<a href="#l2.49"></a><span id="l2.49">   void removeListener(in nsIMsgFolderListener aListener);</span>
<a href="#l2.50"></a><span id="l2.50"> </span>
<a href="#l2.51"></a><span id="l2.51">   // message-specific functions</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineat">@@ -91,16 +96,29 @@ interface nsIMsgFolderNotificationServic</span>
<a href="#l2.53"></a><span id="l2.53">                             in boolean aJunkProcessed,</span>
<a href="#l2.54"></a><span id="l2.54">                             in boolean aTraitProcessed);</span>
<a href="#l2.55"></a><span id="l2.55">   void notifyMsgsDeleted(in nsIArray aMsgs);</span>
<a href="#l2.56"></a><span id="l2.56">   void notifyMsgsMoveCopyCompleted(in boolean aMove, </span>
<a href="#l2.57"></a><span id="l2.57">                                    in nsIArray aSrcMsgs, </span>
<a href="#l2.58"></a><span id="l2.58">                                    in nsIMsgFolder aDestFolder,</span>
<a href="#l2.59"></a><span id="l2.59">                                    in nsIArray aDestMsgs);</span>
<a href="#l2.60"></a><span id="l2.60"> </span>
<a href="#l2.61"></a><span id="l2.61" class="difflineplus">+  /**</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineplus">+   * Notify listeners that the msg key for a header has changed. Currently,</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineplus">+   * this is used when we create a header for an offline imap move result,</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineplus">+   * without knowing what the ultimate UID will be. When we download the</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineplus">+   * headers for the new message, we replace the old &quot;pseudo&quot; header with</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineplus">+   * a new header that has the correct UID/message key, by cloning the pseudo</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineplus">+   * header, which maintains all the existing header attributes.</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineplus">+   *</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineplus">+   * @param aOldKey The fake UID. The header with this key has been removed</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineplus">+   *                by the time this is called.</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineplus">+   * @param aNewHdr The header that replaces the header with aOldKey.</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineplus">+   */</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineplus">+  void notifyMsgKeyChanged(in nsMsgKey aOldKey, in nsIMsgDBHdr aNewHdr);</span>
<a href="#l2.74"></a><span id="l2.74">   // folder specific functions</span>
<a href="#l2.75"></a><span id="l2.75">   // single folders, all the time</span>
<a href="#l2.76"></a><span id="l2.76">   void notifyFolderAdded(in nsIMsgFolder aFolder);</span>
<a href="#l2.77"></a><span id="l2.77">   void notifyFolderDeleted(in nsIMsgFolder aFolder);</span>
<a href="#l2.78"></a><span id="l2.78">   void notifyFolderMoveCopyCompleted(in boolean aMove,</span>
<a href="#l2.79"></a><span id="l2.79">                                      in nsIMsgFolder aSrcFolder,</span>
<a href="#l2.80"></a><span id="l2.80">                                      in nsIMsgFolder aDestFolder);</span>
<a href="#l2.81"></a><span id="l2.81">   void notifyFolderRenamed(in nsIMsgFolder aOrigFolder,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/base/src/nsMsgFolderNotificationService.cpp</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgFolderNotificationService.cpp</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -160,16 +160,24 @@ NS_IMETHODIMP nsMsgFolderNotificationSer</span>
<a href="#l3.4"></a><span id="l3.4">     }</span>
<a href="#l3.5"></a><span id="l3.5">   }</span>
<a href="#l3.6"></a><span id="l3.6"> </span>
<a href="#l3.7"></a><span id="l3.7">   NOTIFY_MSGFOLDER_LISTENERS(msgsMoveCopyCompleted, MsgsMoveCopyCompleted,</span>
<a href="#l3.8"></a><span id="l3.8">                              (isReallyMove, aSrcMsgs, aDestFolder, aDestMsgs));</span>
<a href="#l3.9"></a><span id="l3.9">   return NS_OK;</span>
<a href="#l3.10"></a><span id="l3.10"> }</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+nsMsgFolderNotificationService::NotifyMsgKeyChanged(nsMsgKey aOldKey,</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+                                                    nsIMsgDBHdr *aNewHdr)</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+{</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+  NOTIFY_MSGFOLDER_LISTENERS(msgKeyChanged, MsgKeyChanged, (aOldKey, aNewHdr));</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+  return NS_OK;</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+}</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+</span>
<a href="#l3.20"></a><span id="l3.20"> /* void notifyFolderAdded(in nsIMsgFolder aFolder); */</span>
<a href="#l3.21"></a><span id="l3.21"> NS_IMETHODIMP nsMsgFolderNotificationService::NotifyFolderAdded(nsIMsgFolder *aFolder)</span>
<a href="#l3.22"></a><span id="l3.22"> {</span>
<a href="#l3.23"></a><span id="l3.23">   NOTIFY_MSGFOLDER_LISTENERS(folderAdded, FolderAdded, (aFolder));</span>
<a href="#l3.24"></a><span id="l3.24">   return NS_OK;</span>
<a href="#l3.25"></a><span id="l3.25"> }</span>
<a href="#l3.26"></a><span id="l3.26"> </span>
<a href="#l3.27"></a><span id="l3.27"> /* void notifyFolderDeleted(in nsIMsgFolder aFolder); */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/base/test/unit/test_nsIMsgFolderListener.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_nsIMsgFolderListener.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -16,32 +16,32 @@ const nsIMFListener = Ci.nsIMsgFolderLis</span>
<a href="#l4.4"></a><span id="l4.4"> </span>
<a href="#l4.5"></a><span id="l4.5"> </span>
<a href="#l4.6"></a><span id="l4.6"> const gIndividualFlags =</span>
<a href="#l4.7"></a><span id="l4.7"> [</span>
<a href="#l4.8"></a><span id="l4.8">   nsIMFNService.msgAdded,</span>
<a href="#l4.9"></a><span id="l4.9">   nsIMFNService.msgsClassified,</span>
<a href="#l4.10"></a><span id="l4.10">   nsIMFNService.msgsDeleted,</span>
<a href="#l4.11"></a><span id="l4.11">   nsIMFNService.msgsMoveCopyCompleted,</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+  nsIMFNService.msgKeyChanged,</span>
<a href="#l4.13"></a><span id="l4.13">   nsIMFNService.folderAdded,</span>
<a href="#l4.14"></a><span id="l4.14">   nsIMFNService.folderDeleted,</span>
<a href="#l4.15"></a><span id="l4.15">   nsIMFNService.folderMoveCopyCompleted,</span>
<a href="#l4.16"></a><span id="l4.16">   nsIMFNService.folderRenamed,</span>
<a href="#l4.17"></a><span id="l4.17">   nsIMFNService.itemEvent,</span>
<a href="#l4.18"></a><span id="l4.18"> ];</span>
<a href="#l4.19"></a><span id="l4.19"> </span>
<a href="#l4.20"></a><span id="l4.20"> var gMFNService = Cc[mFNSContractID].getService(nsIMFNService);</span>
<a href="#l4.21"></a><span id="l4.21"> </span>
<a href="#l4.22"></a><span id="l4.22"> // Our listener, which captures events.</span>
<a href="#l4.23"></a><span id="l4.23"> function gMFListener() {}</span>
<a href="#l4.24"></a><span id="l4.24"> gMFListener.prototype =</span>
<a href="#l4.25"></a><span id="l4.25"> {</span>
<a href="#l4.26"></a><span id="l4.26">   mReceived: 0,</span>
<a href="#l4.27"></a><span id="l4.27">   mRemoveSelf: false,</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineminus">-</span>
<a href="#l4.29"></a><span id="l4.29">   msgAdded: function (aMsg)</span>
<a href="#l4.30"></a><span id="l4.30">   {</span>
<a href="#l4.31"></a><span id="l4.31">     do_check_eq(this.mReceived &amp; nsIMFNService.msgAdded, 0);</span>
<a href="#l4.32"></a><span id="l4.32">     this.mReceived |= nsIMFNService.msgAdded;</span>
<a href="#l4.33"></a><span id="l4.33">     if (this.mRemoveSelf)</span>
<a href="#l4.34"></a><span id="l4.34">       gMFNService.removeListener(this);</span>
<a href="#l4.35"></a><span id="l4.35">   },</span>
<a href="#l4.36"></a><span id="l4.36"> </span>
<a href="#l4.37"></a><span id="l4.37" class="difflineat">@@ -63,17 +63,25 @@ gMFListener.prototype =</span>
<a href="#l4.38"></a><span id="l4.38"> </span>
<a href="#l4.39"></a><span id="l4.39">   msgsMoveCopyCompleted: function (aMove, aSrcMsgs, aDestFolder, aDestMsgs)</span>
<a href="#l4.40"></a><span id="l4.40">   {</span>
<a href="#l4.41"></a><span id="l4.41">     do_check_eq(this.mReceived &amp; nsIMFNService.msgsMoveCopyCompleted, 0);</span>
<a href="#l4.42"></a><span id="l4.42">     this.mReceived |= nsIMFNService.msgsMoveCopyCompleted;</span>
<a href="#l4.43"></a><span id="l4.43">     if (this.mRemoveSelf)</span>
<a href="#l4.44"></a><span id="l4.44">       gMFNService.removeListener(this);</span>
<a href="#l4.45"></a><span id="l4.45">   },</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineminus">-  </span>
<a href="#l4.47"></a><span id="l4.47" class="difflineplus">+</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineplus">+  msgKeyChanged: function(aOldMsgKey, aNewMsgHdr)</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineplus">+  {</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineplus">+    do_check_eq(this.mReceived &amp; nsIMFNService.msgKeyChanged, 0);</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineplus">+    this.mReceived |= nsIMFNService.msgKeyChanged;</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineplus">+    if (this.mRemoveSelf)</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineplus">+      gMFNService.removeListener(this);</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineplus">+  },</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineplus">+</span>
<a href="#l4.56"></a><span id="l4.56">   folderAdded: function (aFolder)</span>
<a href="#l4.57"></a><span id="l4.57">   {</span>
<a href="#l4.58"></a><span id="l4.58">     do_check_eq(this.mReceived &amp; nsIMFNService.folderAdded, 0);</span>
<a href="#l4.59"></a><span id="l4.59">     this.mReceived |= nsIMFNService.folderAdded;</span>
<a href="#l4.60"></a><span id="l4.60">     if (this.mRemoveSelf)</span>
<a href="#l4.61"></a><span id="l4.61">       gMFNService.removeListener(this);</span>
<a href="#l4.62"></a><span id="l4.62">   },</span>
<a href="#l4.63"></a><span id="l4.63"> </span>
<a href="#l4.64"></a><span id="l4.64" class="difflineat">@@ -111,16 +119,17 @@ gMFListener.prototype =</span>
<a href="#l4.65"></a><span id="l4.65"> };</span>
<a href="#l4.66"></a><span id="l4.66"> </span>
<a href="#l4.67"></a><span id="l4.67"> function NotifyMsgFolderListeners()</span>
<a href="#l4.68"></a><span id="l4.68"> {</span>
<a href="#l4.69"></a><span id="l4.69">   gMFNService.notifyMsgAdded(null);</span>
<a href="#l4.70"></a><span id="l4.70">   gMFNService.notifyMsgsClassified(null, null, null);</span>
<a href="#l4.71"></a><span id="l4.71">   gMFNService.notifyMsgsDeleted(null);</span>
<a href="#l4.72"></a><span id="l4.72">   gMFNService.notifyMsgsMoveCopyCompleted(null, null, null, null);</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineplus">+  gMFNService.notifyMsgKeyChanged(null, null);</span>
<a href="#l4.74"></a><span id="l4.74">   gMFNService.notifyFolderAdded(null);</span>
<a href="#l4.75"></a><span id="l4.75">   gMFNService.notifyFolderDeleted(null);</span>
<a href="#l4.76"></a><span id="l4.76">   gMFNService.notifyFolderMoveCopyCompleted(null, null, null);</span>
<a href="#l4.77"></a><span id="l4.77">   gMFNService.notifyFolderRenamed(null, null);</span>
<a href="#l4.78"></a><span id="l4.78">   gMFNService.notifyItemEvent(null, null, null);</span>
<a href="#l4.79"></a><span id="l4.79"> }</span>
<a href="#l4.80"></a><span id="l4.80"> </span>
<a href="#l4.81"></a><span id="l4.81"> function run_test()</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/imap/public/nsIMsgImapMailFolder.idl</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/imap/public/nsIMsgImapMailFolder.idl</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -74,17 +74,17 @@ interface nsIMsgImapFolderProps : nsISup</span>
<a href="#l5.4"></a><span id="l5.4">     void setQuotaStatus(in AString folderQuotaStatus);</span>
<a href="#l5.5"></a><span id="l5.5"> </span>
<a href="#l5.6"></a><span id="l5.6">     /**</span>
<a href="#l5.7"></a><span id="l5.7">      * Updates the quota data displayed in the Quota tab.</span>
<a href="#l5.8"></a><span id="l5.8">      */</span>
<a href="#l5.9"></a><span id="l5.9">     void setQuotaData(in ACString quotaroot, in unsigned long usedKB, in unsigned long maxKB);</span>
<a href="#l5.10"></a><span id="l5.10"> };</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-[scriptable, uuid(d33884c6-20d5-4a84-880c-02ac56c1119f)]</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+[scriptable, uuid(fea0f455-7adf-4683-bf2f-c95c3fff03df)]</span>
<a href="#l5.14"></a><span id="l5.14"> interface nsIMsgImapMailFolder : nsISupports {</span>
<a href="#l5.15"></a><span id="l5.15">   void removeSubFolder(in nsIMsgFolder folder);</span>
<a href="#l5.16"></a><span id="l5.16">   void createClientSubfolderInfo(in ACString folderName, in char hierarchyDelimiter,</span>
<a href="#l5.17"></a><span id="l5.17">                                  in long flags, in boolean suppressNotification);</span>
<a href="#l5.18"></a><span id="l5.18">   void list();</span>
<a href="#l5.19"></a><span id="l5.19">   void renameLocal(in ACString newname, in nsIMsgFolder parent);</span>
<a href="#l5.20"></a><span id="l5.20">   void prepareToRename();</span>
<a href="#l5.21"></a><span id="l5.21">   void performExpand(in nsIMsgWindow aMsgWindow);</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineat">@@ -93,17 +93,26 @@ interface nsIMsgImapMailFolder : nsISupp</span>
<a href="#l5.23"></a><span id="l5.23"> </span>
<a href="#l5.24"></a><span id="l5.24">   // these are used for offline synchronization</span>
<a href="#l5.25"></a><span id="l5.25">   void storeImapFlags(in long aFlags, in boolean aAddFlags, [array, size_is (aNumKeys)] </span>
<a href="#l5.26"></a><span id="l5.26">       in nsMsgKey aKeysToFlag, in unsigned long aNumKeys, in nsIUrlListener aUrlListener);</span>
<a href="#l5.27"></a><span id="l5.27">   nsIURI setImapFlags(in string uids, in long flags);</span>
<a href="#l5.28"></a><span id="l5.28">   void replayOfflineMoveCopy([array, size_is (numKeys)] in nsMsgKey keys, in unsigned long numKeys, in boolean isMove, in nsIMsgFolder aDstFolder,</span>
<a href="#l5.29"></a><span id="l5.29">                          in nsIUrlListener aUrlListener, in nsIMsgWindow aWindow);</span>
<a href="#l5.30"></a><span id="l5.30">   nsIURI playbackOfflineFolderCreate(in AString folderName, in nsIMsgWindow aWindow);</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineminus">-</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+  /**</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineplus">+   * This is called by the offline sync code to tell the imap folder to</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineplus">+   * remember info about the header with this key (messageId and key) because</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineplus">+   * it's an offline move result header, and we need to generate an</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineplus">+   * nsIMsgFolderListener.msgKeyChanged notification when we download the</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineplus">+   * real header from the imap server.</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineplus">+   *</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineplus">+   * @param aMsgKey msg key of move result pseudo hdr.</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineplus">+   */</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineplus">+  void addMoveResultPseudoKey(in nsMsgKey aMsgKey);</span>
<a href="#l5.42"></a><span id="l5.42">   /**</span>
<a href="#l5.43"></a><span id="l5.43">    * Select this folder on the imap server without doing a sync of flags or</span>
<a href="#l5.44"></a><span id="l5.44">    * headers. This is used for offline playback, where we don't want to</span>
<a href="#l5.45"></a><span id="l5.45">    * download hdrs we don't have, because they may have been offline deleted.</span>
<a href="#l5.46"></a><span id="l5.46">    *</span>
<a href="#l5.47"></a><span id="l5.47">    * @param aUrlListener        url listener, can be null</span>
<a href="#l5.48"></a><span id="l5.48">    * @param aWindow          msg window url is running in, can be null</span>
<a href="#l5.49"></a><span id="l5.49">    */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/imap/src/nsImapIncomingServer.cpp</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapIncomingServer.cpp</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -859,18 +859,27 @@ nsImapIncomingServer::CreateProtocolInst</span>
<a href="#l6.4"></a><span id="l6.4">       break;</span>
<a href="#l6.5"></a><span id="l6.5">   }</span>
<a href="#l6.6"></a><span id="l6.6">   nsIImapProtocol * protocolInstance;</span>
<a href="#l6.7"></a><span id="l6.7">   rv = CallCreateInstance(kImapProtocolCID, &amp;protocolInstance);</span>
<a href="#l6.8"></a><span id="l6.8">   if (NS_SUCCEEDED(rv) &amp;&amp; protocolInstance)</span>
<a href="#l6.9"></a><span id="l6.9">   {</span>
<a href="#l6.10"></a><span id="l6.10">     nsCOMPtr&lt;nsIImapHostSessionList&gt; hostSession =</span>
<a href="#l6.11"></a><span id="l6.11">       do_GetService(kCImapHostSessionListCID, &amp;rv);</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-      rv = protocolInstance-&gt;Initialize(hostSession, this, aEventTarget);</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+    PRInt32 socketType;</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+    if (NS_SUCCEEDED(GetSocketType(&amp;socketType)) &amp;&amp;</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+        socketType == nsMsgSocketType::trySTARTTLS)</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+    {</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineplus">+      PRUint32 capability = kCapabilityUndefined;</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+      hostSession-&gt;GetCapabilityForHost(m_serverKey.get(), capability);</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineplus">+      if (capability &amp; kHasStartTLSCapability)</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+        SetSocketType(nsMsgSocketType::alwaysSTARTTLS);</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineplus">+    }</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineplus">+    rv = protocolInstance-&gt;Initialize(hostSession, this, aEventTarget);</span>
<a href="#l6.25"></a><span id="l6.25">   }</span>
<a href="#l6.26"></a><span id="l6.26"> </span>
<a href="#l6.27"></a><span id="l6.27">   // take the protocol instance and add it to the connectionCache</span>
<a href="#l6.28"></a><span id="l6.28">   if (protocolInstance)</span>
<a href="#l6.29"></a><span id="l6.29">     m_connectionCache.AppendObject(protocolInstance);</span>
<a href="#l6.30"></a><span id="l6.30">   *aImapConnection = protocolInstance; // this is already ref counted.</span>
<a href="#l6.31"></a><span id="l6.31">   return rv;</span>
<a href="#l6.32"></a><span id="l6.32"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -128,16 +128,17 @@</span>
<a href="#l7.4"></a><span id="l7.4"> #include &quot;nsArrayEnumerator.h&quot;</span>
<a href="#l7.5"></a><span id="l7.5"> #include &quot;nsAutoSyncManager.h&quot;</span>
<a href="#l7.6"></a><span id="l7.6"> #include &quot;nsIMsgFilterCustomAction.h&quot;</span>
<a href="#l7.7"></a><span id="l7.7"> #include &quot;nsMsgReadStateTxn.h&quot;</span>
<a href="#l7.8"></a><span id="l7.8"> #include &quot;nsIStringEnumerator.h&quot;</span>
<a href="#l7.9"></a><span id="l7.9"> #include &quot;nsIMsgStatusFeedback.h&quot;</span>
<a href="#l7.10"></a><span id="l7.10"> #include &quot;nsAlgorithm.h&quot;</span>
<a href="#l7.11"></a><span id="l7.11"> #include &quot;nsPrintfCString.h&quot;</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+#include &quot;nsMsgLineBuffer.h&quot;</span>
<a href="#l7.13"></a><span id="l7.13"> </span>
<a href="#l7.14"></a><span id="l7.14"> static NS_DEFINE_CID(kRDFServiceCID, NS_RDFSERVICE_CID);</span>
<a href="#l7.15"></a><span id="l7.15"> static NS_DEFINE_CID(kParseMailMsgStateCID, NS_PARSEMAILMSGSTATE_CID);</span>
<a href="#l7.16"></a><span id="l7.16"> static NS_DEFINE_CID(kCImapHostSessionList, NS_IIMAPHOSTSESSIONLIST_CID);</span>
<a href="#l7.17"></a><span id="l7.17"> </span>
<a href="#l7.18"></a><span id="l7.18"> nsIAtom* nsImapMailFolder::mImapHdrDownloadedAtom = nsnull;</span>
<a href="#l7.19"></a><span id="l7.19"> </span>
<a href="#l7.20"></a><span id="l7.20"> extern PRLogModuleInfo *gAutoSyncLog;</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineat">@@ -2835,33 +2836,29 @@ NS_IMETHODIMP nsImapMailFolder::UpdateIm</span>
<a href="#l7.22"></a><span id="l7.22">     aSpec-&gt;GetBox_flags(&amp;boxFlags);</span>
<a href="#l7.23"></a><span id="l7.23">     FindKeysToDelete(existingKeys, keysToDelete, flagState, boxFlags);</span>
<a href="#l7.24"></a><span id="l7.24">     // if this is the result of an expunge then don't grab headers</span>
<a href="#l7.25"></a><span id="l7.25">     if (!(boxFlags &amp; kJustExpunged))</span>
<a href="#l7.26"></a><span id="l7.26">       FindKeysToAdd(existingKeys, keysToFetch, numNewUnread, flagState);</span>
<a href="#l7.27"></a><span id="l7.27">   }</span>
<a href="#l7.28"></a><span id="l7.28">   if (!keysToDelete.IsEmpty() &amp;&amp; mDatabase)</span>
<a href="#l7.29"></a><span id="l7.29">   {</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineminus">-    PRUint32 total;</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">-</span>
<a href="#l7.32"></a><span id="l7.32">     nsCOMPtr&lt;nsIMutableArray&gt; hdrsToDelete(do_CreateInstance(NS_ARRAY_CONTRACTID));</span>
<a href="#l7.33"></a><span id="l7.33">     MsgGetHeadersFromKeys(mDatabase, keysToDelete, hdrsToDelete);</span>
<a href="#l7.34"></a><span id="l7.34">     // Notify nsIMsgFolderListeners of a mass delete, but only if we actually have headers</span>
<a href="#l7.35"></a><span id="l7.35">     PRUint32 numHdrs;</span>
<a href="#l7.36"></a><span id="l7.36">     hdrsToDelete-&gt;GetLength(&amp;numHdrs);</span>
<a href="#l7.37"></a><span id="l7.37">     if (numHdrs)</span>
<a href="#l7.38"></a><span id="l7.38">     {</span>
<a href="#l7.39"></a><span id="l7.39">       nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l7.40"></a><span id="l7.40">       if (notifier)</span>
<a href="#l7.41"></a><span id="l7.41">         notifier-&gt;NotifyMsgsDeleted(hdrsToDelete);</span>
<a href="#l7.42"></a><span id="l7.42">     }</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineminus">-</span>
<a href="#l7.44"></a><span id="l7.44">     // It would be nice to notify RDF or whoever of a mass delete here.</span>
<a href="#l7.45"></a><span id="l7.45">     mDatabase-&gt;DeleteMessages(keysToDelete.Length(), keysToDelete.Elements(), nsnull);</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineminus">-    total = keysToDelete.Length();</span>
<a href="#l7.47"></a><span id="l7.47">   }</span>
<a href="#l7.48"></a><span id="l7.48">   PRInt32 numUnreadFromServer;</span>
<a href="#l7.49"></a><span id="l7.49">   aSpec-&gt;GetNumUnseenMessages(&amp;numUnreadFromServer);</span>
<a href="#l7.50"></a><span id="l7.50">   </span>
<a href="#l7.51"></a><span id="l7.51">   PRBool partialUIDFetch;</span>
<a href="#l7.52"></a><span id="l7.52">   flagState-&gt;GetPartialUIDFetch(&amp;partialUIDFetch);</span>
<a href="#l7.53"></a><span id="l7.53">   </span>
<a href="#l7.54"></a><span id="l7.54">   // For partial UID fetches, we can only trust the numUnread from the server.</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineat">@@ -3002,17 +2999,17 @@ NS_IMETHODIMP nsImapMailFolder::ParseMsg</span>
<a href="#l7.56"></a><span id="l7.56">       inputStream-&gt;ShareData(msgHdrs, strlen(msgHdrs));</span>
<a href="#l7.57"></a><span id="l7.57">       GetMessageHeader(msgKey, getter_AddRefs(msgHdr));</span>
<a href="#l7.58"></a><span id="l7.58">       if (msgHdr)</span>
<a href="#l7.59"></a><span id="l7.59">         GetMsgPreviewTextFromStream(msgHdr, inputStream);</span>
<a href="#l7.60"></a><span id="l7.60">       continue;</span>
<a href="#l7.61"></a><span id="l7.61">     }</span>
<a href="#l7.62"></a><span id="l7.62">     if (mDatabase &amp;&amp; NS_SUCCEEDED(mDatabase-&gt;ContainsKey(msgKey, &amp;containsKey)) &amp;&amp; containsKey)</span>
<a href="#l7.63"></a><span id="l7.63">     {</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineminus">-      NS_ASSERTION(PR_FALSE, &quot;downloading hdrs for hdr we already have&quot;);</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineplus">+      NS_ERROR(&quot;downloading hdrs for hdr we already have&quot;);</span>
<a href="#l7.66"></a><span id="l7.66">       continue;</span>
<a href="#l7.67"></a><span id="l7.67">     }</span>
<a href="#l7.68"></a><span id="l7.68">     nsresult rv = SetupHeaderParseStream(msgSize, EmptyCString(), nsnull);</span>
<a href="#l7.69"></a><span id="l7.69">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.70"></a><span id="l7.70">     headerInfo-&gt;GetMsgHdrs(&amp;msgHdrs);</span>
<a href="#l7.71"></a><span id="l7.71">     rv = ParseAdoptedHeaderLine(msgHdrs, msgKey);</span>
<a href="#l7.72"></a><span id="l7.72">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.73"></a><span id="l7.73">     rv = NormalEndHeaderParseStream(aProtocol, aImapUrl);</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineat">@@ -3182,18 +3179,33 @@ nsresult nsImapMailFolder::NormalEndHead</span>
<a href="#l7.75"></a><span id="l7.75">           NotifyFolderEvent(mFiltersAppliedAtom);</span>
<a href="#l7.76"></a><span id="l7.76">         }</span>
<a href="#l7.77"></a><span id="l7.77">       }</span>
<a href="#l7.78"></a><span id="l7.78">     }</span>
<a href="#l7.79"></a><span id="l7.79">   }</span>
<a href="#l7.80"></a><span id="l7.80">   // here we need to tweak flags from uid state..</span>
<a href="#l7.81"></a><span id="l7.81">   if (mDatabase &amp;&amp; (!m_msgMovedByFilter || ShowDeletedMessages()))</span>
<a href="#l7.82"></a><span id="l7.82">   {</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineplus">+    // Check if this header corresponds to a pseudo header</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineplus">+    // we have from doing a pseudo-offline move and then downloading</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineplus">+    // the real header from the server. In that case, we notify</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineplus">+    // db/folder listeners that the pseudo-header has become the new</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineplus">+    // header, i.e., the key has changed.</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineplus">+    nsCString newMessageId;</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineplus">+    nsMsgKey pseudoKey = nsMsgKey_None;</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineplus">+    newMsgHdr-&gt;GetMessageId(getter_Copies(newMessageId));</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineplus">+    if (m_pseudoHdrs.IsInitialized())</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineplus">+      m_pseudoHdrs.Get(newMessageId, &amp;pseudoKey);</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineplus">+    if (notifier &amp;&amp; pseudoKey != nsMsgKey_None)</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineplus">+    {</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineplus">+      notifier-&gt;NotifyMsgKeyChanged(pseudoKey, newMsgHdr);</span>
<a href="#l7.97"></a><span id="l7.97" class="difflineplus">+      m_pseudoHdrs.Remove(newMessageId);</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineplus">+    }</span>
<a href="#l7.99"></a><span id="l7.99">     mDatabase-&gt;AddNewHdrToDB(newMsgHdr, PR_TRUE);</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineminus">-    nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l7.101"></a><span id="l7.101">     if (notifier)</span>
<a href="#l7.102"></a><span id="l7.102">       notifier-&gt;NotifyMsgAdded(newMsgHdr);</span>
<a href="#l7.103"></a><span id="l7.103">     // mark the header as not yet reported classified</span>
<a href="#l7.104"></a><span id="l7.104">     OrProcessingFlags(m_curMsgUid, nsMsgProcessingFlags::NotReportedClassified);</span>
<a href="#l7.105"></a><span id="l7.105">   }</span>
<a href="#l7.106"></a><span id="l7.106">   // adjust highestRecordedUID</span>
<a href="#l7.107"></a><span id="l7.107">   if (mDatabase)</span>
<a href="#l7.108"></a><span id="l7.108">   {</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineat">@@ -3891,16 +3903,31 @@ nsImapMailFolder::ReplayOfflineMoveCopy(</span>
<a href="#l7.110"></a><span id="l7.110">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.111"></a><span id="l7.111">     nsCOMPtr &lt;nsIUrlListener&gt; folderListener = do_QueryInterface(aDstFolder);</span>
<a href="#l7.112"></a><span id="l7.112">     if (folderListener)</span>
<a href="#l7.113"></a><span id="l7.113">       mailnewsUrl-&gt;RegisterListener(folderListener);</span>
<a href="#l7.114"></a><span id="l7.114">   }</span>
<a href="#l7.115"></a><span id="l7.115">   return rv;</span>
<a href="#l7.116"></a><span id="l7.116"> }</span>
<a href="#l7.117"></a><span id="l7.117"> </span>
<a href="#l7.118"></a><span id="l7.118" class="difflineplus">+NS_IMETHODIMP nsImapMailFolder::AddMoveResultPseudoKey(nsMsgKey aMsgKey)</span>
<a href="#l7.119"></a><span id="l7.119" class="difflineplus">+{</span>
<a href="#l7.120"></a><span id="l7.120" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; pseudoHdr;</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineplus">+  mDatabase-&gt;GetMsgHdrForKey(aMsgKey, getter_AddRefs(pseudoHdr));</span>
<a href="#l7.122"></a><span id="l7.122" class="difflineplus">+  nsCString messageId;</span>
<a href="#l7.123"></a><span id="l7.123" class="difflineplus">+  pseudoHdr-&gt;GetMessageId(getter_Copies(messageId));</span>
<a href="#l7.124"></a><span id="l7.124" class="difflineplus">+  // err on the side of caution and ignore messages w/o messageid.</span>
<a href="#l7.125"></a><span id="l7.125" class="difflineplus">+  if (messageId.IsEmpty())</span>
<a href="#l7.126"></a><span id="l7.126" class="difflineplus">+    return NS_OK;</span>
<a href="#l7.127"></a><span id="l7.127" class="difflineplus">+  if (!m_pseudoHdrs.IsInitialized())</span>
<a href="#l7.128"></a><span id="l7.128" class="difflineplus">+    m_pseudoHdrs.Init(10);</span>
<a href="#l7.129"></a><span id="l7.129" class="difflineplus">+  m_pseudoHdrs.Put(messageId, aMsgKey);</span>
<a href="#l7.130"></a><span id="l7.130" class="difflineplus">+  return NS_OK;</span>
<a href="#l7.131"></a><span id="l7.131" class="difflineplus">+}</span>
<a href="#l7.132"></a><span id="l7.132" class="difflineplus">+</span>
<a href="#l7.133"></a><span id="l7.133"> NS_IMETHODIMP nsImapMailFolder::StoreImapFlags(PRInt32 flags, PRBool addFlags,</span>
<a href="#l7.134"></a><span id="l7.134">                                                nsMsgKey *keys, PRUint32 numKeys,</span>
<a href="#l7.135"></a><span id="l7.135">                                                nsIUrlListener *aUrlListener)</span>
<a href="#l7.136"></a><span id="l7.136"> {</span>
<a href="#l7.137"></a><span id="l7.137">   nsresult rv;</span>
<a href="#l7.138"></a><span id="l7.138">   if (!WeAreOffline())</span>
<a href="#l7.139"></a><span id="l7.139">   {</span>
<a href="#l7.140"></a><span id="l7.140">     nsCOMPtr&lt;nsIImapService&gt; imapService = do_GetService(NS_IMAPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l7.141"></a><span id="l7.141" class="difflineat">@@ -5701,18 +5728,16 @@ nsImapMailFolder::GetMessageId(nsIImapUr</span>
<a href="#l7.142"></a><span id="l7.142">   }</span>
<a href="#l7.143"></a><span id="l7.143">   return rv;</span>
<a href="#l7.144"></a><span id="l7.144"> }</span>
<a href="#l7.145"></a><span id="l7.145"> </span>
<a href="#l7.146"></a><span id="l7.146"> NS_IMETHODIMP</span>
<a href="#l7.147"></a><span id="l7.147"> nsImapMailFolder::HeaderFetchCompleted(nsIImapProtocol* aProtocol)</span>
<a href="#l7.148"></a><span id="l7.148"> {</span>
<a href="#l7.149"></a><span id="l7.149">   nsCOMPtr &lt;nsIMsgWindow&gt; msgWindow; // we might need this for the filter plugins.</span>
<a href="#l7.150"></a><span id="l7.150" class="difflineminus">-  if (mDatabase)</span>
<a href="#l7.151"></a><span id="l7.151" class="difflineminus">-    mDatabase-&gt;Commit(nsMsgDBCommitType::kLargeCommit);</span>
<a href="#l7.152"></a><span id="l7.152">   if (mBackupDatabase)</span>
<a href="#l7.153"></a><span id="l7.153">     RemoveBackupMsgDatabase();</span>
<a href="#l7.154"></a><span id="l7.154"> </span>
<a href="#l7.155"></a><span id="l7.155">   SetSizeOnDisk(mFolderSize);</span>
<a href="#l7.156"></a><span id="l7.156">   PRInt32 numNewBiffMsgs = 0;</span>
<a href="#l7.157"></a><span id="l7.157">   if (m_performingBiff)</span>
<a href="#l7.158"></a><span id="l7.158">     GetNumNewMessages(PR_FALSE, &amp;numNewBiffMsgs);</span>
<a href="#l7.159"></a><span id="l7.159"> </span>
<a href="#l7.160"></a><span id="l7.160" class="difflineat">@@ -6694,18 +6719,16 @@ nsImapMailFolder::CopyNextStreamMessage(</span>
<a href="#l7.161"></a><span id="l7.161">     nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l7.162"></a><span id="l7.162">     if (notifier)</span>
<a href="#l7.163"></a><span id="l7.163">     {</span>
<a href="#l7.164"></a><span id="l7.164">       PRUint32 numHdrs;</span>
<a href="#l7.165"></a><span id="l7.165">       mailCopyState-&gt;m_messages-&gt;GetLength(&amp;numHdrs);</span>
<a href="#l7.166"></a><span id="l7.166">       if (numHdrs)</span>
<a href="#l7.167"></a><span id="l7.167">         notifier-&gt;NotifyMsgsMoveCopyCompleted(mailCopyState-&gt;m_isMove, mailCopyState-&gt;m_messages, this, nsnull);</span>
<a href="#l7.168"></a><span id="l7.168">     }</span>
<a href="#l7.169"></a><span id="l7.169" class="difflineminus">-</span>
<a href="#l7.170"></a><span id="l7.170" class="difflineminus">-</span>
<a href="#l7.171"></a><span id="l7.171">     if (mailCopyState-&gt;m_isMove)</span>
<a href="#l7.172"></a><span id="l7.172">     {</span>
<a href="#l7.173"></a><span id="l7.173">       nsCOMPtr&lt;nsIMsgFolder&gt; srcFolder(do_QueryInterface(mailCopyState-&gt;m_srcSupport, &amp;rv));</span>
<a href="#l7.174"></a><span id="l7.174">       if (NS_SUCCEEDED(rv) &amp;&amp; srcFolder)</span>
<a href="#l7.175"></a><span id="l7.175">       {</span>
<a href="#l7.176"></a><span id="l7.176">         srcFolder-&gt;DeleteMessages(mailCopyState-&gt;m_messages, nsnull,</span>
<a href="#l7.177"></a><span id="l7.177">           PR_TRUE, PR_TRUE, nsnull, PR_FALSE);</span>
<a href="#l7.178"></a><span id="l7.178">         // we want to send this notification after the source messages have</span>
<a href="#l7.179"></a><span id="l7.179" class="difflineat">@@ -6965,16 +6988,20 @@ nsresult nsImapMailFolder::CopyMessagesO</span>
<a href="#l7.180"></a><span id="l7.180">   srcFolder-&gt;GetDBFolderInfoAndDB(getter_AddRefs(srcDbFolderInfo), getter_AddRefs(sourceMailDB));</span>
<a href="#l7.181"></a><span id="l7.181">   PRBool deleteToTrash = PR_FALSE;</span>
<a href="#l7.182"></a><span id="l7.182">   PRBool deleteImmediately = PR_FALSE;</span>
<a href="#l7.183"></a><span id="l7.183">   PRUint32 srcCount;</span>
<a href="#l7.184"></a><span id="l7.184">   messages-&gt;GetLength(&amp;srcCount);</span>
<a href="#l7.185"></a><span id="l7.185">   nsCOMPtr&lt;nsIImapIncomingServer&gt; imapServer;</span>
<a href="#l7.186"></a><span id="l7.186">   rv = GetImapIncomingServer(getter_AddRefs(imapServer));</span>
<a href="#l7.187"></a><span id="l7.187">   nsCOMPtr&lt;nsIMutableArray&gt; msgHdrsCopied(do_CreateInstance(NS_ARRAY_CONTRACTID));</span>
<a href="#l7.188"></a><span id="l7.188" class="difflineplus">+  nsCOMPtr&lt;nsIMutableArray&gt; destMsgHdrs(do_CreateInstance(NS_ARRAY_CONTRACTID));</span>
<a href="#l7.189"></a><span id="l7.189" class="difflineplus">+</span>
<a href="#l7.190"></a><span id="l7.190" class="difflineplus">+  if (!msgHdrsCopied || !destMsgHdrs)</span>
<a href="#l7.191"></a><span id="l7.191" class="difflineplus">+    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l7.192"></a><span id="l7.192"> </span>
<a href="#l7.193"></a><span id="l7.193">   if (NS_SUCCEEDED(rv) &amp;&amp; imapServer)</span>
<a href="#l7.194"></a><span id="l7.194">   {</span>
<a href="#l7.195"></a><span id="l7.195">     nsMsgImapDeleteModel deleteModel;</span>
<a href="#l7.196"></a><span id="l7.196">     imapServer-&gt;GetDeleteModel(&amp;deleteModel);</span>
<a href="#l7.197"></a><span id="l7.197">     deleteToTrash = (deleteModel == nsMsgImapDeleteModels::MoveToTrash);</span>
<a href="#l7.198"></a><span id="l7.198">     deleteImmediately = (deleteModel == nsMsgImapDeleteModels::DeleteNoTrash);</span>
<a href="#l7.199"></a><span id="l7.199">   }</span>
<a href="#l7.200"></a><span id="l7.200" class="difflineat">@@ -7140,17 +7167,21 @@ nsresult nsImapMailFolder::CopyMessagesO</span>
<a href="#l7.201"></a><span id="l7.201">           {</span>
<a href="#l7.202"></a><span id="l7.202">             NS_ASSERTION(PR_FALSE, &quot;failed to copy hdr&quot;);</span>
<a href="#l7.203"></a><span id="l7.203">             stopit = rv;</span>
<a href="#l7.204"></a><span id="l7.204">           }</span>
<a href="#l7.205"></a><span id="l7.205"> </span>
<a href="#l7.206"></a><span id="l7.206">           if (NS_SUCCEEDED(stopit))</span>
<a href="#l7.207"></a><span id="l7.207">           {</span>
<a href="#l7.208"></a><span id="l7.208">             PRBool hasMsgOffline = PR_FALSE;</span>
<a href="#l7.209"></a><span id="l7.209" class="difflineplus">+</span>
<a href="#l7.210"></a><span id="l7.210" class="difflineplus">+            destMsgHdrs-&gt;AppendElement(newMailHdr, PR_FALSE);</span>
<a href="#l7.211"></a><span id="l7.211">             srcFolder-&gt;HasMsgOffline(originalKey, &amp;hasMsgOffline);</span>
<a href="#l7.212"></a><span id="l7.212" class="difflineplus">+            newMailHdr-&gt;SetUint32Property(&quot;pseudoHdr&quot;, 1);</span>
<a href="#l7.213"></a><span id="l7.213" class="difflineplus">+</span>
<a href="#l7.214"></a><span id="l7.214">             if (inputStream &amp;&amp; hasMsgOffline &amp;&amp; !isLocked)</span>
<a href="#l7.215"></a><span id="l7.215">               CopyOfflineMsgBody(srcFolder, newMailHdr, mailHdr, inputStream,</span>
<a href="#l7.216"></a><span id="l7.216">                                  outputStream);</span>
<a href="#l7.217"></a><span id="l7.217">             else</span>
<a href="#l7.218"></a><span id="l7.218">               mDatabase-&gt;MarkOffline(fakeBase + sourceKeyIndex, PR_FALSE, nsnull);</span>
<a href="#l7.219"></a><span id="l7.219"> </span>
<a href="#l7.220"></a><span id="l7.220">             nsCOMPtr &lt;nsIMsgOfflineImapOperation&gt; destOp;</span>
<a href="#l7.221"></a><span id="l7.221">             mDatabase-&gt;GetOfflineOpForKey(fakeBase + sourceKeyIndex, PR_TRUE, getter_AddRefs(destOp));</span>
<a href="#l7.222"></a><span id="l7.222" class="difflineat">@@ -7232,17 +7263,17 @@ nsresult nsImapMailFolder::CopyMessagesO</span>
<a href="#l7.223"></a><span id="l7.223"> </span>
<a href="#l7.224"></a><span id="l7.224">   // Do this before delete, as it destroys the messages</span>
<a href="#l7.225"></a><span id="l7.225">   PRUint32 numHdrs;</span>
<a href="#l7.226"></a><span id="l7.226">   msgHdrsCopied-&gt;GetLength(&amp;numHdrs);</span>
<a href="#l7.227"></a><span id="l7.227">   if (numHdrs)</span>
<a href="#l7.228"></a><span id="l7.228">   {</span>
<a href="#l7.229"></a><span id="l7.229">     nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l7.230"></a><span id="l7.230">     if (notifier)</span>
<a href="#l7.231"></a><span id="l7.231" class="difflineminus">-      notifier-&gt;NotifyMsgsMoveCopyCompleted(isMove, msgHdrsCopied, this, nsnull);</span>
<a href="#l7.232"></a><span id="l7.232" class="difflineplus">+      notifier-&gt;NotifyMsgsMoveCopyCompleted(isMove, msgHdrsCopied, this, destMsgHdrs);</span>
<a href="#l7.233"></a><span id="l7.233">   }</span>
<a href="#l7.234"></a><span id="l7.234"> </span>
<a href="#l7.235"></a><span id="l7.235">   if (isMove &amp;&amp; (deleteToTrash || deleteImmediately))</span>
<a href="#l7.236"></a><span id="l7.236">     sourceMailDB-&gt;DeleteMessages(keysToDelete.Length(), keysToDelete.Elements(), nsnull);</span>
<a href="#l7.237"></a><span id="l7.237"> </span>
<a href="#l7.238"></a><span id="l7.238">   nsCOMPtr&lt;nsISupports&gt; srcSupport = do_QueryInterface(srcFolder);</span>
<a href="#l7.239"></a><span id="l7.239">   OnCopyCompleted(srcSupport, rv);</span>
<a href="#l7.240"></a><span id="l7.240"> </span>
<a href="#l7.241"></a><span id="l7.241" class="difflineat">@@ -8117,18 +8148,123 @@ nsImapMailFolder::InitCopyState(nsISuppo</span>
<a href="#l7.242"></a><span id="l7.242">   m_copyState-&gt;m_selectedState = selectedState;</span>
<a href="#l7.243"></a><span id="l7.243">   m_copyState-&gt;m_msgWindow = msgWindow;</span>
<a href="#l7.244"></a><span id="l7.244">   if (listener)</span>
<a href="#l7.245"></a><span id="l7.245">     m_copyState-&gt;m_listener = do_QueryInterface(listener, &amp;rv);</span>
<a href="#l7.246"></a><span id="l7.246">   return rv;</span>
<a href="#l7.247"></a><span id="l7.247"> }</span>
<a href="#l7.248"></a><span id="l7.248"> </span>
<a href="#l7.249"></a><span id="l7.249"> nsresult</span>
<a href="#l7.250"></a><span id="l7.250" class="difflineplus">+nsImapMailFolder::CopyFileToOfflineStore(nsILocalFile *srcFile)</span>
<a href="#l7.251"></a><span id="l7.251" class="difflineplus">+{</span>
<a href="#l7.252"></a><span id="l7.252" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l7.253"></a><span id="l7.253" class="difflineplus">+  nsresult rv = GetMsgDatabase(getter_AddRefs(db));</span>
<a href="#l7.254"></a><span id="l7.254" class="difflineplus">+</span>
<a href="#l7.255"></a><span id="l7.255" class="difflineplus">+  if (mDatabase)</span>
<a href="#l7.256"></a><span id="l7.256" class="difflineplus">+  {</span>
<a href="#l7.257"></a><span id="l7.257" class="difflineplus">+    nsMsgKey fakeKey;</span>
<a href="#l7.258"></a><span id="l7.258" class="difflineplus">+    mDatabase-&gt;GetNextFakeOfflineMsgKey(&amp;fakeKey);</span>
<a href="#l7.259"></a><span id="l7.259" class="difflineplus">+    nsCOMPtr&lt;nsIMutableArray&gt; messages(do_CreateInstance(NS_ARRAY_CONTRACTID));</span>
<a href="#l7.260"></a><span id="l7.260" class="difflineplus">+</span>
<a href="#l7.261"></a><span id="l7.261" class="difflineplus">+    nsCOMPtr&lt;nsIMsgOfflineImapOperation&gt; op;</span>
<a href="#l7.262"></a><span id="l7.262" class="difflineplus">+    rv = mDatabase-&gt;GetOfflineOpForKey(fakeKey, PR_TRUE, getter_AddRefs(op));</span>
<a href="#l7.263"></a><span id="l7.263" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; op)</span>
<a href="#l7.264"></a><span id="l7.264" class="difflineplus">+    {</span>
<a href="#l7.265"></a><span id="l7.265" class="difflineplus">+      nsCString destFolderUri;</span>
<a href="#l7.266"></a><span id="l7.266" class="difflineplus">+      GetURI(destFolderUri);</span>
<a href="#l7.267"></a><span id="l7.267" class="difflineplus">+      op-&gt;SetOperation(nsIMsgOfflineImapOperation::kMoveResult);</span>
<a href="#l7.268"></a><span id="l7.268" class="difflineplus">+      op-&gt;SetDestinationFolderURI(destFolderUri.get());</span>
<a href="#l7.269"></a><span id="l7.269" class="difflineplus">+      nsCOMPtr&lt;nsIOutputStream&gt; offlineStore;</span>
<a href="#l7.270"></a><span id="l7.270" class="difflineplus">+      rv = GetOfflineStoreOutputStream(getter_AddRefs(offlineStore));</span>
<a href="#l7.271"></a><span id="l7.271" class="difflineplus">+      SetFlag(nsMsgFolderFlags::OfflineEvents);</span>
<a href="#l7.272"></a><span id="l7.272" class="difflineplus">+</span>
<a href="#l7.273"></a><span id="l7.273" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; offlineStore)</span>
<a href="#l7.274"></a><span id="l7.274" class="difflineplus">+      {</span>
<a href="#l7.275"></a><span id="l7.275" class="difflineplus">+        PRInt64 curOfflineStorePos = 0;</span>
<a href="#l7.276"></a><span id="l7.276" class="difflineplus">+        nsCOMPtr&lt;nsISeekableStream&gt; seekable = do_QueryInterface(offlineStore);</span>
<a href="#l7.277"></a><span id="l7.277" class="difflineplus">+        if (seekable)</span>
<a href="#l7.278"></a><span id="l7.278" class="difflineplus">+          seekable-&gt;Tell(&amp;curOfflineStorePos);</span>
<a href="#l7.279"></a><span id="l7.279" class="difflineplus">+        else</span>
<a href="#l7.280"></a><span id="l7.280" class="difflineplus">+        {</span>
<a href="#l7.281"></a><span id="l7.281" class="difflineplus">+          NS_ERROR(&quot;needs to be a random store!&quot;);</span>
<a href="#l7.282"></a><span id="l7.282" class="difflineplus">+          return NS_ERROR_FAILURE;</span>
<a href="#l7.283"></a><span id="l7.283" class="difflineplus">+        }</span>
<a href="#l7.284"></a><span id="l7.284" class="difflineplus">+</span>
<a href="#l7.285"></a><span id="l7.285" class="difflineplus">+        nsCOMPtr&lt;nsIInputStream&gt; inputStream;</span>
<a href="#l7.286"></a><span id="l7.286" class="difflineplus">+        nsCOMPtr&lt;nsIMsgParseMailMsgState&gt; msgParser =</span>
<a href="#l7.287"></a><span id="l7.287" class="difflineplus">+          do_CreateInstance(NS_PARSEMAILMSGSTATE_CONTRACTID, &amp;rv);</span>
<a href="#l7.288"></a><span id="l7.288" class="difflineplus">+        msgParser-&gt;SetMailDB(mDatabase);</span>
<a href="#l7.289"></a><span id="l7.289" class="difflineplus">+</span>
<a href="#l7.290"></a><span id="l7.290" class="difflineplus">+        rv = NS_NewLocalFileInputStream(getter_AddRefs(inputStream), srcFile);</span>
<a href="#l7.291"></a><span id="l7.291" class="difflineplus">+        if (NS_SUCCEEDED(rv) &amp;&amp; inputStream)</span>
<a href="#l7.292"></a><span id="l7.292" class="difflineplus">+        {</span>
<a href="#l7.293"></a><span id="l7.293" class="difflineplus">+          // now, copy the temp file to the offline store for the cur folder.</span>
<a href="#l7.294"></a><span id="l7.294" class="difflineplus">+          PRInt32 inputBufferSize = 10240;</span>
<a href="#l7.295"></a><span id="l7.295" class="difflineplus">+          nsMsgLineStreamBuffer *inputStreamBuffer =</span>
<a href="#l7.296"></a><span id="l7.296" class="difflineplus">+            new nsMsgLineStreamBuffer(inputBufferSize, PR_TRUE, PR_FALSE);</span>
<a href="#l7.297"></a><span id="l7.297" class="difflineplus">+          PRInt64 fileSize;</span>
<a href="#l7.298"></a><span id="l7.298" class="difflineplus">+          srcFile-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l7.299"></a><span id="l7.299" class="difflineplus">+          PRUint32 bytesWritten;</span>
<a href="#l7.300"></a><span id="l7.300" class="difflineplus">+          rv = NS_OK;</span>
<a href="#l7.301"></a><span id="l7.301" class="difflineplus">+          msgParser-&gt;SetState(nsIMsgParseMailMsgState::ParseHeadersState);</span>
<a href="#l7.302"></a><span id="l7.302" class="difflineplus">+          // set the env pos to fake key so the msg hdr will have that for a key</span>
<a href="#l7.303"></a><span id="l7.303" class="difflineplus">+          msgParser-&gt;SetEnvelopePos(fakeKey);</span>
<a href="#l7.304"></a><span id="l7.304" class="difflineplus">+          PRBool needMoreData = PR_FALSE;</span>
<a href="#l7.305"></a><span id="l7.305" class="difflineplus">+          char * newLine = nsnull;</span>
<a href="#l7.306"></a><span id="l7.306" class="difflineplus">+          PRUint32 numBytesInLine = 0;</span>
<a href="#l7.307"></a><span id="l7.307" class="difflineplus">+          do</span>
<a href="#l7.308"></a><span id="l7.308" class="difflineplus">+          {</span>
<a href="#l7.309"></a><span id="l7.309" class="difflineplus">+            newLine = inputStreamBuffer-&gt;ReadNextLine(inputStream, numBytesInLine, needMoreData);</span>
<a href="#l7.310"></a><span id="l7.310" class="difflineplus">+            if (newLine)</span>
<a href="#l7.311"></a><span id="l7.311" class="difflineplus">+            {</span>
<a href="#l7.312"></a><span id="l7.312" class="difflineplus">+              msgParser-&gt;ParseAFolderLine(newLine, numBytesInLine);</span>
<a href="#l7.313"></a><span id="l7.313" class="difflineplus">+              rv = offlineStore-&gt;Write(newLine, numBytesInLine, &amp;bytesWritten);</span>
<a href="#l7.314"></a><span id="l7.314" class="difflineplus">+              NS_Free(newLine);</span>
<a href="#l7.315"></a><span id="l7.315" class="difflineplus">+            }</span>
<a href="#l7.316"></a><span id="l7.316" class="difflineplus">+          } while (newLine);</span>
<a href="#l7.317"></a><span id="l7.317" class="difflineplus">+</span>
<a href="#l7.318"></a><span id="l7.318" class="difflineplus">+          nsCOMPtr&lt;nsIMsgDBHdr&gt; fakeHdr;</span>
<a href="#l7.319"></a><span id="l7.319" class="difflineplus">+          msgParser-&gt;FinishHeader();</span>
<a href="#l7.320"></a><span id="l7.320" class="difflineplus">+          msgParser-&gt;GetNewMsgHdr(getter_AddRefs(fakeHdr));</span>
<a href="#l7.321"></a><span id="l7.321" class="difflineplus">+          if (fakeHdr)</span>
<a href="#l7.322"></a><span id="l7.322" class="difflineplus">+          {</span>
<a href="#l7.323"></a><span id="l7.323" class="difflineplus">+            if (NS_SUCCEEDED(rv) &amp;&amp; fakeHdr)</span>
<a href="#l7.324"></a><span id="l7.324" class="difflineplus">+            {</span>
<a href="#l7.325"></a><span id="l7.325" class="difflineplus">+              PRUint32 resultFlags;</span>
<a href="#l7.326"></a><span id="l7.326" class="difflineplus">+              fakeHdr-&gt;SetMessageOffset(curOfflineStorePos);</span>
<a href="#l7.327"></a><span id="l7.327" class="difflineplus">+              fakeHdr-&gt;OrFlags(nsMsgMessageFlags::Offline | nsMsgMessageFlags::Read, &amp;resultFlags);</span>
<a href="#l7.328"></a><span id="l7.328" class="difflineplus">+              fakeHdr-&gt;SetOfflineMessageSize(fileSize);</span>
<a href="#l7.329"></a><span id="l7.329" class="difflineplus">+              fakeHdr-&gt;SetUint32Property(&quot;pseudoHdr&quot;, 1);</span>
<a href="#l7.330"></a><span id="l7.330" class="difflineplus">+              mDatabase-&gt;AddNewHdrToDB(fakeHdr, PR_TRUE /* notify */);</span>
<a href="#l7.331"></a><span id="l7.331" class="difflineplus">+              SetFlag(nsMsgFolderFlags::OfflineEvents);</span>
<a href="#l7.332"></a><span id="l7.332" class="difflineplus">+              messages-&gt;AppendElement(fakeHdr, PR_FALSE);</span>
<a href="#l7.333"></a><span id="l7.333" class="difflineplus">+              SetPendingAttributes(messages, PR_FALSE);</span>
<a href="#l7.334"></a><span id="l7.334" class="difflineplus">+            }</span>
<a href="#l7.335"></a><span id="l7.335" class="difflineplus">+          }</span>
<a href="#l7.336"></a><span id="l7.336" class="difflineplus">+          inputStream-&gt;Close();</span>
<a href="#l7.337"></a><span id="l7.337" class="difflineplus">+          inputStream = nsnull;</span>
<a href="#l7.338"></a><span id="l7.338" class="difflineplus">+          delete inputStreamBuffer;</span>
<a href="#l7.339"></a><span id="l7.339" class="difflineplus">+        }</span>
<a href="#l7.340"></a><span id="l7.340" class="difflineplus">+      }</span>
<a href="#l7.341"></a><span id="l7.341" class="difflineplus">+    }</span>
<a href="#l7.342"></a><span id="l7.342" class="difflineplus">+  }</span>
<a href="#l7.343"></a><span id="l7.343" class="difflineplus">+  return rv;</span>
<a href="#l7.344"></a><span id="l7.344" class="difflineplus">+}</span>
<a href="#l7.345"></a><span id="l7.345" class="difflineplus">+</span>
<a href="#l7.346"></a><span id="l7.346" class="difflineplus">+nsresult</span>
<a href="#l7.347"></a><span id="l7.347"> nsImapMailFolder::OnCopyCompleted(nsISupports *srcSupport, nsresult rv)</span>
<a href="#l7.348"></a><span id="l7.348"> {</span>
<a href="#l7.349"></a><span id="l7.349" class="difflineplus">+  // if it's a file, and the copy succeeded, then fcc the offline</span>
<a href="#l7.350"></a><span id="l7.350" class="difflineplus">+  // store, and add a kMoveResult offline op.</span>
<a href="#l7.351"></a><span id="l7.351" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; m_copyState)</span>
<a href="#l7.352"></a><span id="l7.352" class="difflineplus">+  {</span>
<a href="#l7.353"></a><span id="l7.353" class="difflineplus">+    nsCOMPtr&lt;nsILocalFile&gt; srcFile(do_QueryInterface(srcSupport));</span>
<a href="#l7.354"></a><span id="l7.354" class="difflineplus">+    if (srcFile &amp;&amp; (mFlags &amp; nsMsgFolderFlags::Offline) &amp;&amp; !WeAreOffline())</span>
<a href="#l7.355"></a><span id="l7.355" class="difflineplus">+      (void) CopyFileToOfflineStore(srcFile);</span>
<a href="#l7.356"></a><span id="l7.356" class="difflineplus">+  }</span>
<a href="#l7.357"></a><span id="l7.357">   m_copyState = nsnull;</span>
<a href="#l7.358"></a><span id="l7.358">   nsresult result;</span>
<a href="#l7.359"></a><span id="l7.359">   nsCOMPtr&lt;nsIMsgCopyService&gt; copyService = do_GetService(NS_MSGCOPYSERVICE_CONTRACTID, &amp;result);</span>
<a href="#l7.360"></a><span id="l7.360">   NS_ENSURE_SUCCESS(result, result);</span>
<a href="#l7.361"></a><span id="l7.361">   return copyService-&gt;NotifyCompletion(srcSupport, this, rv);</span>
<a href="#l7.362"></a><span id="l7.362"> }</span>
<a href="#l7.363"></a><span id="l7.363"> </span>
<a href="#l7.364"></a><span id="l7.364"> nsresult nsImapMailFolder::CreateBaseMessageURI(const nsACString&amp; aURI)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/imap/src/nsImapMailFolder.h</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapMailFolder.h</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -371,16 +371,17 @@ protected:</span>
<a href="#l8.4"></a><span id="l8.4">                              PRUint16 userFlags, nsCString&amp; keywords);</span>
<a href="#l8.5"></a><span id="l8.5">   nsresult NotifyMessageFlagsFromHdr(nsIMsgDBHdr *dbHdr, nsMsgKey msgKey, PRUint32 flags);</span>
<a href="#l8.6"></a><span id="l8.6"> </span>
<a href="#l8.7"></a><span id="l8.7">   nsresult SetupHeaderParseStream(PRUint32 size, const nsACString&amp; content_type, nsIMailboxSpec *boxSpec);</span>
<a href="#l8.8"></a><span id="l8.8">   nsresult  ParseAdoptedHeaderLine(const char *messageLine, PRUint32 msgKey);</span>
<a href="#l8.9"></a><span id="l8.9">   nsresult  NormalEndHeaderParseStream(nsIImapProtocol *aProtocol, nsIImapUrl *imapUrl);</span>
<a href="#l8.10"></a><span id="l8.10"> </span>
<a href="#l8.11"></a><span id="l8.11">   void EndOfflineDownload();</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+  nsresult CopyFileToOfflineStore(nsILocalFile *srcFile);</span>
<a href="#l8.13"></a><span id="l8.13"> </span>
<a href="#l8.14"></a><span id="l8.14">   nsresult MarkMessagesImapDeleted(nsTArray&lt;nsMsgKey&gt; *keyArray, PRBool deleted, nsIMsgDatabase *db);</span>
<a href="#l8.15"></a><span id="l8.15"> </span>
<a href="#l8.16"></a><span id="l8.16">   // Notifies imap autosync that it should update this folder when it</span>
<a href="#l8.17"></a><span id="l8.17">   // gets a chance.</span>
<a href="#l8.18"></a><span id="l8.18">   void NotifyHasPendingMsgs();</span>
<a href="#l8.19"></a><span id="l8.19">   void UpdatePendingCounts();</span>
<a href="#l8.20"></a><span id="l8.20">   void SetIMAPDeletedFlag(nsIMsgDatabase *mailDB, const nsTArray&lt;nsMsgKey&gt; &amp;msgids, PRBool markDeleted);</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineat">@@ -517,24 +518,26 @@ protected:</span>
<a href="#l8.22"></a><span id="l8.22">   PRUint32     m_aclFlags;</span>
<a href="#l8.23"></a><span id="l8.23">   PRUint32     m_supportedUserFlags;</span>
<a href="#l8.24"></a><span id="l8.24"> </span>
<a href="#l8.25"></a><span id="l8.25">   static nsIAtom* mImapHdrDownloadedAtom;</span>
<a href="#l8.26"></a><span id="l8.26"> </span>
<a href="#l8.27"></a><span id="l8.27">   // offline imap support</span>
<a href="#l8.28"></a><span id="l8.28">   PRBool m_downloadingFolderForOfflineUse;</span>
<a href="#l8.29"></a><span id="l8.29">   PRBool m_filterListRequiresBody;</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineminus">-  </span>
<a href="#l8.31"></a><span id="l8.31" class="difflineplus">+</span>
<a href="#l8.32"></a><span id="l8.32">   // auto-sync (preemptive download) support</span>
<a href="#l8.33"></a><span id="l8.33">   nsRefPtr&lt;nsAutoSyncState&gt; m_autoSyncStateObj;</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineminus">-  </span>
<a href="#l8.35"></a><span id="l8.35" class="difflineplus">+</span>
<a href="#l8.36"></a><span id="l8.36">   // Quota support</span>
<a href="#l8.37"></a><span id="l8.37">   nsCString m_folderQuotaRoot;</span>
<a href="#l8.38"></a><span id="l8.38">   PRUint32 m_folderQuotaUsedKB;</span>
<a href="#l8.39"></a><span id="l8.39">   PRUint32 m_folderQuotaMaxKB;</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineminus">-  </span>
<a href="#l8.41"></a><span id="l8.41" class="difflineplus">+</span>
<a href="#l8.42"></a><span id="l8.42">   // Pseudo-Offline Playback support</span>
<a href="#l8.43"></a><span id="l8.43">   nsPlaybackRequest *m_pendingPlaybackReq;</span>
<a href="#l8.44"></a><span id="l8.44">   nsCOMPtr&lt;nsITimer&gt; m_playbackTimer;</span>
<a href="#l8.45"></a><span id="l8.45">   nsTArray&lt;nsRefPtr&lt;nsImapMoveCopyMsgTxn&gt; &gt; m_pendingOfflineMoves;</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineminus">-</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineplus">+  // hash table of mapping between messageids and message keys</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineplus">+  // for pseudo hdrs.</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineplus">+  nsDataHashtable&lt;nsCStringHashKey, nsMsgKey&gt; m_pseudoHdrs;</span>
<a href="#l8.50"></a><span id="l8.50"> };</span>
<a href="#l8.51"></a><span id="l8.51"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/imap/src/nsImapOfflineSync.cpp</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapOfflineSync.cpp</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -608,39 +608,43 @@ PRBool nsImapOfflineSync::DestFolderOnSa</span>
<a href="#l9.4"></a><span id="l9.4"> </span>
<a href="#l9.5"></a><span id="l9.5">   PRBool sameServer = PR_FALSE;</span>
<a href="#l9.6"></a><span id="l9.6">   if (NS_SUCCEEDED(m_currentFolder-&gt;GetServer(getter_AddRefs(srcServer))) </span>
<a href="#l9.7"></a><span id="l9.7">     &amp;&amp; NS_SUCCEEDED(destFolder-&gt;GetServer(getter_AddRefs(dstServer))))</span>
<a href="#l9.8"></a><span id="l9.8">     dstServer-&gt;Equals(srcServer, &amp;sameServer);</span>
<a href="#l9.9"></a><span id="l9.9">   return sameServer;</span>
<a href="#l9.10"></a><span id="l9.10"> }</span>
<a href="#l9.11"></a><span id="l9.11"> </span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-void nsImapOfflineSync::ProcessCopyOperation(nsIMsgOfflineImapOperation *currentOp)</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+void nsImapOfflineSync::ProcessCopyOperation(nsIMsgOfflineImapOperation *aCurrentOp)</span>
<a href="#l9.14"></a><span id="l9.14"> {</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+  nsCOMPtr&lt;nsIMsgOfflineImapOperation&gt; currentOp = aCurrentOp;</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+</span>
<a href="#l9.17"></a><span id="l9.17">   nsTArray&lt;nsMsgKey&gt; matchingFlagKeys;</span>
<a href="#l9.18"></a><span id="l9.18">   PRUint32 currentKeyIndex = m_KeyIndex;</span>
<a href="#l9.19"></a><span id="l9.19">   nsCString copyDestination;</span>
<a href="#l9.20"></a><span id="l9.20">   currentOp-&gt;GetCopyDestination(0, getter_Copies(copyDestination));</span>
<a href="#l9.21"></a><span id="l9.21">   PRBool copyMatches = PR_TRUE;</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineminus">-  </span>
<a href="#l9.23"></a><span id="l9.23" class="difflineplus">+  nsresult rv;</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineplus">+</span>
<a href="#l9.25"></a><span id="l9.25">   do { // loop for all messsages with the same destination</span>
<a href="#l9.26"></a><span id="l9.26">     if (copyMatches)</span>
<a href="#l9.27"></a><span id="l9.27">     {</span>
<a href="#l9.28"></a><span id="l9.28">       nsMsgKey curKey;</span>
<a href="#l9.29"></a><span id="l9.29">       currentOp-&gt;GetMessageKey(&amp;curKey);</span>
<a href="#l9.30"></a><span id="l9.30">       matchingFlagKeys.AppendElement(curKey);</span>
<a href="#l9.31"></a><span id="l9.31">       currentOp-&gt;SetPlayingBack(PR_TRUE);</span>
<a href="#l9.32"></a><span id="l9.32">       m_currentOpsToClear.AppendObject(currentOp);</span>
<a href="#l9.33"></a><span id="l9.33">     }</span>
<a href="#l9.34"></a><span id="l9.34">     currentOp = nsnull;</span>
<a href="#l9.35"></a><span id="l9.35"> </span>
<a href="#l9.36"></a><span id="l9.36">     if (++currentKeyIndex &lt; m_CurrentKeys.Length())</span>
<a href="#l9.37"></a><span id="l9.37">     {</span>
<a href="#l9.38"></a><span id="l9.38">       nsCString nextDestination;</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineminus">-      nsresult rv = m_currentDB-&gt;GetOfflineOpForKey(m_CurrentKeys[currentKeyIndex], PR_FALSE, &amp;currentOp);</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineplus">+      rv = m_currentDB-&gt;GetOfflineOpForKey(m_CurrentKeys[currentKeyIndex],</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineplus">+                                           PR_FALSE, getter_AddRefs(currentOp));</span>
<a href="#l9.42"></a><span id="l9.42">       copyMatches = PR_FALSE;</span>
<a href="#l9.43"></a><span id="l9.43">       if (NS_SUCCEEDED(rv) &amp;&amp; currentOp)</span>
<a href="#l9.44"></a><span id="l9.44">       {</span>
<a href="#l9.45"></a><span id="l9.45">         nsOfflineImapOperationType opType; </span>
<a href="#l9.46"></a><span id="l9.46">         currentOp-&gt;GetOperation(&amp;opType);</span>
<a href="#l9.47"></a><span id="l9.47">         if (opType &amp; nsIMsgOfflineImapOperation::kMsgCopy)</span>
<a href="#l9.48"></a><span id="l9.48">         {</span>
<a href="#l9.49"></a><span id="l9.49">           currentOp-&gt;GetCopyDestination(0, getter_Copies(nextDestination));</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineat">@@ -658,36 +662,33 @@ void nsImapOfflineSync::ProcessCopyOpera</span>
<a href="#l9.51"></a><span id="l9.51">   // going to fail, so clear them out and move on.</span>
<a href="#l9.52"></a><span id="l9.52">   if (!destFolder)</span>
<a href="#l9.53"></a><span id="l9.53">   {</span>
<a href="#l9.54"></a><span id="l9.54">     NS_ERROR(&quot;trying to playing back copy to non-existent folder&quot;);</span>
<a href="#l9.55"></a><span id="l9.55">     ClearCurrentOps();</span>
<a href="#l9.56"></a><span id="l9.56">     ProcessNextOperation();</span>
<a href="#l9.57"></a><span id="l9.57">     return;</span>
<a href="#l9.58"></a><span id="l9.58">   }</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineminus">-  nsresult rv;</span>
<a href="#l9.60"></a><span id="l9.60">   nsCOMPtr&lt;nsIMsgImapMailFolder&gt; imapFolder = do_QueryInterface(m_currentFolder);</span>
<a href="#l9.61"></a><span id="l9.61">   if (imapFolder &amp;&amp; DestFolderOnSameServer(destFolder))</span>
<a href="#l9.62"></a><span id="l9.62">   {</span>
<a href="#l9.63"></a><span id="l9.63">     rv = imapFolder-&gt;ReplayOfflineMoveCopy(matchingFlagKeys.Elements(), matchingFlagKeys.Length(), PR_FALSE, destFolder,</span>
<a href="#l9.64"></a><span id="l9.64">                    this, m_window);</span>
<a href="#l9.65"></a><span id="l9.65">   }</span>
<a href="#l9.66"></a><span id="l9.66">   else</span>
<a href="#l9.67"></a><span id="l9.67">   {</span>
<a href="#l9.68"></a><span id="l9.68">     nsCOMPtr&lt;nsIMutableArray&gt; messages(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l9.69"></a><span id="l9.69">     if (messages &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l9.70"></a><span id="l9.70">     {</span>
<a href="#l9.71"></a><span id="l9.71">       for (PRUint32 keyIndex = 0; keyIndex &lt; matchingFlagKeys.Length(); keyIndex++)</span>
<a href="#l9.72"></a><span id="l9.72">       {</span>
<a href="#l9.73"></a><span id="l9.73">         nsCOMPtr&lt;nsIMsgDBHdr&gt; mailHdr = nsnull;</span>
<a href="#l9.74"></a><span id="l9.74">         rv = m_currentFolder-&gt;GetMessageHeader(matchingFlagKeys.ElementAt(keyIndex), getter_AddRefs(mailHdr));</span>
<a href="#l9.75"></a><span id="l9.75">         if (NS_SUCCEEDED(rv) &amp;&amp; mailHdr)</span>
<a href="#l9.76"></a><span id="l9.76" class="difflineminus">-        {</span>
<a href="#l9.77"></a><span id="l9.77">           messages-&gt;AppendElement(mailHdr, PR_FALSE);</span>
<a href="#l9.78"></a><span id="l9.78" class="difflineminus">-        }</span>
<a href="#l9.79"></a><span id="l9.79">       }</span>
<a href="#l9.80"></a><span id="l9.80">       nsCOMPtr&lt;nsIMsgCopyService&gt; copyService = do_GetService(NS_MSGCOPYSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l9.81"></a><span id="l9.81">       if (copyService)</span>
<a href="#l9.82"></a><span id="l9.82">         copyService-&gt;CopyMessages(m_currentFolder, messages, destFolder, PR_FALSE, this, m_window, PR_FALSE);</span>
<a href="#l9.83"></a><span id="l9.83">     }</span>
<a href="#l9.84"></a><span id="l9.84">   }</span>
<a href="#l9.85"></a><span id="l9.85"> }</span>
<a href="#l9.86"></a><span id="l9.86"> </span>
<a href="#l9.87"></a><span id="l9.87" class="difflineat">@@ -823,26 +824,33 @@ nsresult nsImapOfflineSync::ProcessNextO</span>
<a href="#l9.88"></a><span id="l9.88">             </span>
<a href="#l9.89"></a><span id="l9.89">             if (opType == nsIMsgOfflineImapOperation::kMoveResult)</span>
<a href="#l9.90"></a><span id="l9.90">             {</span>
<a href="#l9.91"></a><span id="l9.91">               nsMsgKey curKey;</span>
<a href="#l9.92"></a><span id="l9.92">               currentOp-&gt;GetMessageKey(&amp;curKey);</span>
<a href="#l9.93"></a><span id="l9.93">               m_currentDB-&gt;RemoveOfflineOp(currentOp);</span>
<a href="#l9.94"></a><span id="l9.94">               deletedGhostMsgs = PR_TRUE;</span>
<a href="#l9.95"></a><span id="l9.95"> </span>
<a href="#l9.96"></a><span id="l9.96" class="difflineplus">+              // Remember the pseudo headers before we delete them,</span>
<a href="#l9.97"></a><span id="l9.97" class="difflineplus">+              // and when we download new headers, tell listeners about the</span>
<a href="#l9.98"></a><span id="l9.98" class="difflineplus">+              // message key change between the pseudo headers and the real</span>
<a href="#l9.99"></a><span id="l9.99" class="difflineplus">+              // downloaded headers. Note that we're not currently sending</span>
<a href="#l9.100"></a><span id="l9.100" class="difflineplus">+              // a msgsDeleted notifcation for these headers, but the</span>
<a href="#l9.101"></a><span id="l9.101" class="difflineplus">+              // db listeners are notified about the deletion.</span>
<a href="#l9.102"></a><span id="l9.102">               // for imap folders, we should adjust the pending counts, because we</span>
<a href="#l9.103"></a><span id="l9.103">               // have a header that we know about, but don't have in the db.</span>
<a href="#l9.104"></a><span id="l9.104">               nsCOMPtr &lt;nsIMsgImapMailFolder&gt; imapFolder = do_QueryInterface(m_currentFolder);</span>
<a href="#l9.105"></a><span id="l9.105">               if (imapFolder)</span>
<a href="#l9.106"></a><span id="l9.106">               {</span>
<a href="#l9.107"></a><span id="l9.107">                 PRBool hdrIsRead;</span>
<a href="#l9.108"></a><span id="l9.108">                 m_currentDB-&gt;IsRead(curKey, &amp;hdrIsRead);</span>
<a href="#l9.109"></a><span id="l9.109">                 imapFolder-&gt;ChangePendingTotal(1);</span>
<a href="#l9.110"></a><span id="l9.110">                 if (!hdrIsRead)</span>
<a href="#l9.111"></a><span id="l9.111">                   imapFolder-&gt;ChangePendingUnread(1);</span>
<a href="#l9.112"></a><span id="l9.112" class="difflineplus">+                imapFolder-&gt;AddMoveResultPseudoKey(curKey);</span>
<a href="#l9.113"></a><span id="l9.113">               }</span>
<a href="#l9.114"></a><span id="l9.114">               m_currentDB-&gt;DeleteMessage(curKey, nsnull, PR_FALSE);</span>
<a href="#l9.115"></a><span id="l9.115">             }</span>
<a href="#l9.116"></a><span id="l9.116">           }</span>
<a href="#l9.117"></a><span id="l9.117">         }</span>
<a href="#l9.118"></a><span id="l9.118">         </span>
<a href="#l9.119"></a><span id="l9.119">         if (deletedGhostMsgs)</span>
<a href="#l9.120"></a><span id="l9.120">           m_currentFolder-&gt;SummaryChanged();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapAttachmentSaves.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapAttachmentSaves.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -138,18 +138,18 @@ function testDetach()</span>
<a href="#l10.4"></a><span id="l10.4">   // directory.</span>
<a href="#l10.5"></a><span id="l10.5">   let checkFile = gProfileDir.clone();</span>
<a href="#l10.6"></a><span id="l10.6">   checkFile.append(kAttachFileName);</span>
<a href="#l10.7"></a><span id="l10.7">   do_check_true(checkFile.exists());</span>
<a href="#l10.8"></a><span id="l10.8"> </span>
<a href="#l10.9"></a><span id="l10.9">   // The message should now have a detached attachment. Read the message,</span>
<a href="#l10.10"></a><span id="l10.10">   //  and search for &quot;AttachmentDetached&quot; which is added on detachment.</span>
<a href="#l10.11"></a><span id="l10.11"> </span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-  // Get the message header</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-  let msgHdr = firstMsgHdr(gIMAPInbox);</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+  // Get the message header - detached copy has UID 2.</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+  let msgHdr = gIMAPInbox.GetMessageHeader(2);</span>
<a href="#l10.16"></a><span id="l10.16">   do_check_neq(msgHdr, null);</span>
<a href="#l10.17"></a><span id="l10.17">   let messageContent = getContentFromMessage(msgHdr);</span>
<a href="#l10.18"></a><span id="l10.18">   do_check_true(messageContent.indexOf(&quot;AttachmentDetached&quot;) != -1);</span>
<a href="#l10.19"></a><span id="l10.19"> }</span>
<a href="#l10.20"></a><span id="l10.20"> </span>
<a href="#l10.21"></a><span id="l10.21"> // Cleanup</span>
<a href="#l10.22"></a><span id="l10.22"> function endTest()</span>
<a href="#l10.23"></a><span id="l10.23"> {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_nsIMsgFolderListenerIMAP.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_nsIMsgFolderListenerIMAP.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -28,16 +28,19 @@ const gMsgFile4 = do_get_file(&quot;../../../</span>
<a href="#l11.4"></a><span id="l11.4"> const gMsgFile5 = do_get_file(&quot;../../../data/bugmail6&quot;);</span>
<a href="#l11.5"></a><span id="l11.5"> </span>
<a href="#l11.6"></a><span id="l11.6"> // Copied straight from the example files</span>
<a href="#l11.7"></a><span id="l11.7"> const gMsgId1 = &quot;200806061706.m56H6RWT004933@mrapp54.mozilla.org&quot;;</span>
<a href="#l11.8"></a><span id="l11.8"> const gMsgId2 = &quot;200804111417.m3BEHTk4030129@mrapp51.mozilla.org&quot;;</span>
<a href="#l11.9"></a><span id="l11.9"> const gMsgId3 = &quot;4849BF7B.2030800@example.com&quot;;</span>
<a href="#l11.10"></a><span id="l11.10"> const gMsgId4 = &quot;bugmail7.m47LtAEf007542@mrapp51.mozilla.org&quot;;</span>
<a href="#l11.11"></a><span id="l11.11"> const gMsgId5 = &quot;bugmail6.m47LtAEf007542@mrapp51.mozilla.org&quot;;</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+var gMsgWindow = Cc[&quot;@mozilla.org/messenger/msgwindow;1&quot;]</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+                  .createInstance(Components.interfaces.nsIMsgWindow);</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+</span>
<a href="#l11.15"></a><span id="l11.15"> </span>
<a href="#l11.16"></a><span id="l11.16"> function addFolder(parent, folderName, storeIn)</span>
<a href="#l11.17"></a><span id="l11.17"> {</span>
<a href="#l11.18"></a><span id="l11.18">   gExpectedEvents = [[gMFNService.folderAdded, parent, folderName, storeIn]];</span>
<a href="#l11.19"></a><span id="l11.19">   // No copy listener notification for this</span>
<a href="#l11.20"></a><span id="l11.20">   gCurrStatus |= kStatus.onStopCopyDone;</span>
<a href="#l11.21"></a><span id="l11.21">   parent.createSubfolder(folderName, null);</span>
<a href="#l11.22"></a><span id="l11.22">   gCurrStatus |= kStatus.functionCallDone;</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineat">@@ -121,30 +124,32 @@ function addMessagesToServer(messages, m</span>
<a href="#l11.24"></a><span id="l11.24"> </span>
<a href="#l11.25"></a><span id="l11.25"> function copyMessages(messages, isMove, srcFolder, destFolder)</span>
<a href="#l11.26"></a><span id="l11.26"> {</span>
<a href="#l11.27"></a><span id="l11.27">   let array = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l11.28"></a><span id="l11.28">   messages.forEach(function (message)</span>
<a href="#l11.29"></a><span id="l11.29">   {</span>
<a href="#l11.30"></a><span id="l11.30">     array.appendElement(message, false);</span>
<a href="#l11.31"></a><span id="l11.31">   });</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineminus">-  gExpectedEvents = [[gMFNService.msgsMoveCopyCompleted, isMove, messages, destFolder]];</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineplus">+  gExpectedEvents = [[gMFNService.msgsMoveCopyCompleted, isMove, messages, destFolder, true]];</span>
<a href="#l11.34"></a><span id="l11.34">   // We'll also get the msgAdded events when we go and update the destination</span>
<a href="#l11.35"></a><span id="l11.35">   // folder</span>
<a href="#l11.36"></a><span id="l11.36">   messages.forEach(function (message)</span>
<a href="#l11.37"></a><span id="l11.37">   {</span>
<a href="#l11.38"></a><span id="l11.38">     // We can't use the headers directly, because the notifications we'll</span>
<a href="#l11.39"></a><span id="l11.39">     // receive are for message headers in the destination folder</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineplus">+    gExpectedEvents.push([gMFNService.msgKeyChanged,</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineplus">+                          {expectedMessageId: message.messageId}]);</span>
<a href="#l11.42"></a><span id="l11.42">     gExpectedEvents.push([gMFNService.msgAdded,</span>
<a href="#l11.43"></a><span id="l11.43">                           {expectedMessageId: message.messageId}]);</span>
<a href="#l11.44"></a><span id="l11.44">   });</span>
<a href="#l11.45"></a><span id="l11.45">   gExpectedEvents.push([gMFNService.msgsClassified,</span>
<a href="#l11.46"></a><span id="l11.46">                         [hdr.messageId for each (hdr in messages)],</span>
<a href="#l11.47"></a><span id="l11.47">                         false, false]);</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineminus">-  gCopyService.CopyMessages(srcFolder, array, destFolder, isMove, copyListener, null, true);</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineplus">+  gCopyService.CopyMessages(srcFolder, array, destFolder, isMove, copyListener, gMsgWindow, true);</span>
<a href="#l11.50"></a><span id="l11.50">   gCurrStatus |= kStatus.functionCallDone;</span>
<a href="#l11.51"></a><span id="l11.51"> </span>
<a href="#l11.52"></a><span id="l11.52">   gServer.performTest(&quot;COPY&quot;);</span>
<a href="#l11.53"></a><span id="l11.53"> </span>
<a href="#l11.54"></a><span id="l11.54">   gFolderBeingUpdated = destFolder;</span>
<a href="#l11.55"></a><span id="l11.55">   doUpdateFolder(gTest);</span>
<a href="#l11.56"></a><span id="l11.56">   if (gCurrStatus == kStatus.everythingDone)</span>
<a href="#l11.57"></a><span id="l11.57">     resetStatusAndProceed();</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineat">@@ -179,17 +184,17 @@ const gTestArray =</span>
<a href="#l11.59"></a><span id="l11.59">   // Add another couple of messages, this time to another folder on the server</span>
<a href="#l11.60"></a><span id="l11.60">   function testNewMessageArrival2() {</span>
<a href="#l11.61"></a><span id="l11.61">     addMessagesToServer([{file: gMsgFile4, messageId: gMsgId4},</span>
<a href="#l11.62"></a><span id="l11.62">                          {file: gMsgFile5, messageId: gMsgId5}],</span>
<a href="#l11.63"></a><span id="l11.63">                         gIMAPDaemon.getMailbox(&quot;INBOX&quot;), gIMAPInbox);</span>
<a href="#l11.64"></a><span id="l11.64">   },</span>
<a href="#l11.65"></a><span id="l11.65"> </span>
<a href="#l11.66"></a><span id="l11.66">   // Moving/copying messages (this doesn't work right now)</span>
<a href="#l11.67"></a><span id="l11.67" class="difflineminus">-  /* function testCopyMessages1() { copyMessages([gMsgHdrs[0].hdr, gMsgHdrs[1].hdr], false, gIMAPInbox, gIMAPFolder3) } */</span>
<a href="#l11.68"></a><span id="l11.68" class="difflineplus">+  function testCopyMessages1() { copyMessages([gMsgHdrs[0].hdr, gMsgHdrs[1].hdr], false, gIMAPInbox, gIMAPFolder3) }</span>
<a href="#l11.69"></a><span id="l11.69"> ];</span>
<a href="#l11.70"></a><span id="l11.70"> </span>
<a href="#l11.71"></a><span id="l11.71"> function run_test()</span>
<a href="#l11.72"></a><span id="l11.72"> {</span>
<a href="#l11.73"></a><span id="l11.73">   // This is before any of the actual tests, so...</span>
<a href="#l11.74"></a><span id="l11.74">   gTest = 0;</span>
<a href="#l11.75"></a><span id="l11.75"> </span>
<a href="#l11.76"></a><span id="l11.76">   // Add a listener.</span>
<a href="#l11.77"></a><span id="l11.77" class="difflineat">@@ -265,16 +270,17 @@ function doTest(test)</span>
<a href="#l11.78"></a><span id="l11.78">     testFn();</span>
<a href="#l11.79"></a><span id="l11.79">   }</span>
<a href="#l11.80"></a><span id="l11.80">   else</span>
<a href="#l11.81"></a><span id="l11.81">   {</span>
<a href="#l11.82"></a><span id="l11.82">     gMFNService.removeListener(gMFListener);</span>
<a href="#l11.83"></a><span id="l11.83">     // Cleanup, null out everything, close all cached connections and stop the</span>
<a href="#l11.84"></a><span id="l11.84">     // server</span>
<a href="#l11.85"></a><span id="l11.85">     gRootFolder = null;</span>
<a href="#l11.86"></a><span id="l11.86" class="difflineplus">+    gIMAPInbox.msgDatabase = null;</span>
<a href="#l11.87"></a><span id="l11.87">     gIMAPInbox = null;</span>
<a href="#l11.88"></a><span id="l11.88">     gIMAPFolder2 = null;</span>
<a href="#l11.89"></a><span id="l11.89">     gIMAPFolder3 = null;</span>
<a href="#l11.90"></a><span id="l11.90">     gIMAPTrashFolder = null;</span>
<a href="#l11.91"></a><span id="l11.91">     do_timeout(1000, endTest);</span>
<a href="#l11.92"></a><span id="l11.92">   }</span>
<a href="#l11.93"></a><span id="l11.93"> }</span>
<a href="#l11.94"></a><span id="l11.94"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/local/src/nsRssIncomingServer.cpp</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/local/src/nsRssIncomingServer.cpp</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -277,16 +277,22 @@ NS_IMETHODIMP nsRssIncomingServer::MsgsD</span>
<a href="#l12.4"></a><span id="l12.4"> </span>
<a href="#l12.5"></a><span id="l12.5"> NS_IMETHODIMP nsRssIncomingServer::MsgsMoveCopyCompleted(</span>
<a href="#l12.6"></a><span id="l12.6">   PRBool aMove, nsIArray *aSrcMsgs, nsIMsgFolder *aDestFolder,</span>
<a href="#l12.7"></a><span id="l12.7">   nsIArray *aDestMsgs)</span>
<a href="#l12.8"></a><span id="l12.8"> {</span>
<a href="#l12.9"></a><span id="l12.9">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l12.10"></a><span id="l12.10"> }</span>
<a href="#l12.11"></a><span id="l12.11"> </span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+NS_IMETHODIMP nsRssIncomingServer::MsgKeyChanged(nsMsgKey aOldKey,</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+                                                 nsIMsgDBHdr *aNewHdr)</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+{</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineplus">+}</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineplus">+</span>
<a href="#l12.18"></a><span id="l12.18"> NS_IMETHODIMP nsRssIncomingServer::FolderAdded(nsIMsgFolder *aFolder)</span>
<a href="#l12.19"></a><span id="l12.19"> {</span>
<a href="#l12.20"></a><span id="l12.20">   return FolderChanged(aFolder, PR_FALSE);</span>
<a href="#l12.21"></a><span id="l12.21"> }</span>
<a href="#l12.22"></a><span id="l12.22"> </span>
<a href="#l12.23"></a><span id="l12.23"> NS_IMETHODIMP nsRssIncomingServer::FolderDeleted(nsIMsgFolder *aFolder)</span>
<a href="#l12.24"></a><span id="l12.24"> {</span>
<a href="#l12.25"></a><span id="l12.25">   return FolderChanged(aFolder, PR_TRUE);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/test/resources/msgFolderListenerSetup.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/test/resources/msgFolderListenerSetup.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -1,40 +1,21 @@</span>
<a href="#l13.4"></a><span id="l13.4" class="difflineminus">-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l13.5"></a><span id="l13.5" class="difflineminus">-/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l13.6"></a><span id="l13.6" class="difflineminus">- *</span>
<a href="#l13.7"></a><span id="l13.7" class="difflineminus">- * Any copyright is dedicated to the Public Domain.</span>
<a href="#l13.8"></a><span id="l13.8" class="difflineminus">- * http://creativecommons.org/licenses/publicdomain/</span>
<a href="#l13.9"></a><span id="l13.9" class="difflineminus">- *</span>
<a href="#l13.10"></a><span id="l13.10" class="difflineminus">- * ***** END LICENSE BLOCK ***** */</span>
<a href="#l13.11"></a><span id="l13.11" class="difflineminus">-</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-/*</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">- * Setup for nsIMsgFolderListener tests.</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineminus">- *</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineminus">- * To create a test on top of this,</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineminus">- *</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineminus">- * - define a doTest function which accepts the number of the test as an argument.</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineminus">- * - for each test, store the expected events as an array in gExpectedEvents, with</span>
<a href="#l13.19"></a><span id="l13.19" class="difflineminus">- *   format [event, item array] or [event, is move, item array, destination folder].</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineminus">- * - use the copyListener and gMFListener</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineminus">- * - make sure you set the function call flag once your function call is done.</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineminus">- */</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineminus">-</span>
<a href="#l13.24"></a><span id="l13.24"> const nsIMsgDBHdr = Ci.nsIMsgDBHdr;</span>
<a href="#l13.25"></a><span id="l13.25"> const nsIArray = Ci.nsIArray;</span>
<a href="#l13.26"></a><span id="l13.26"> const nsIMsgFolder = Ci.nsIMsgFolder;</span>
<a href="#l13.27"></a><span id="l13.27"> </span>
<a href="#l13.28"></a><span id="l13.28"> const gMFNService = Cc[&quot;@mozilla.org/messenger/msgnotificationservice;1&quot;]</span>
<a href="#l13.29"></a><span id="l13.29">                       .getService(Ci.nsIMsgFolderNotificationService);</span>
<a href="#l13.30"></a><span id="l13.30"> </span>
<a href="#l13.31"></a><span id="l13.31"> const allTestedEvents =</span>
<a href="#l13.32"></a><span id="l13.32">   gMFNService.msgAdded |</span>
<a href="#l13.33"></a><span id="l13.33">   gMFNService.msgsClassified |</span>
<a href="#l13.34"></a><span id="l13.34">   gMFNService.msgsDeleted |</span>
<a href="#l13.35"></a><span id="l13.35">   gMFNService.msgsMoveCopyCompleted |</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineplus">+  gMFNService.msgKeyChanged |</span>
<a href="#l13.37"></a><span id="l13.37">   gMFNService.folderAdded |</span>
<a href="#l13.38"></a><span id="l13.38">   gMFNService.folderDeleted |</span>
<a href="#l13.39"></a><span id="l13.39">   gMFNService.folderMoveCopyCompleted |</span>
<a href="#l13.40"></a><span id="l13.40">   gMFNService.folderRenamed |</span>
<a href="#l13.41"></a><span id="l13.41">   gMFNService.itemEvent;</span>
<a href="#l13.42"></a><span id="l13.42"> </span>
<a href="#l13.43"></a><span id="l13.43"> const gCopyService = Cc[&quot;@mozilla.org/messenger/messagecopyservice;1&quot;]</span>
<a href="#l13.44"></a><span id="l13.44">                       .getService(Ci.nsIMsgCopyService);</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineat">@@ -118,16 +99,27 @@ var gMFListener =</span>
<a href="#l13.46"></a><span id="l13.46">     if (gExpectedEvents.length == 0)</span>
<a href="#l13.47"></a><span id="l13.47">     {</span>
<a href="#l13.48"></a><span id="l13.48">       gCurrStatus |= kStatus.notificationsDone;</span>
<a href="#l13.49"></a><span id="l13.49">       if (gCurrStatus == kStatus.everythingDone)</span>
<a href="#l13.50"></a><span id="l13.50">         resetStatusAndProceed();</span>
<a href="#l13.51"></a><span id="l13.51">     }</span>
<a href="#l13.52"></a><span id="l13.52">   },</span>
<a href="#l13.53"></a><span id="l13.53"> </span>
<a href="#l13.54"></a><span id="l13.54" class="difflineplus">+  msgKeyChanged: function(aOldKey, aNewMsgHdr)</span>
<a href="#l13.55"></a><span id="l13.55" class="difflineplus">+  {</span>
<a href="#l13.56"></a><span id="l13.56" class="difflineplus">+    verify([gMFNService.msgKeyChanged, aOldKey, aNewMsgHdr]);</span>
<a href="#l13.57"></a><span id="l13.57" class="difflineplus">+    if (gExpectedEvents.length == 0)</span>
<a href="#l13.58"></a><span id="l13.58" class="difflineplus">+    {</span>
<a href="#l13.59"></a><span id="l13.59" class="difflineplus">+      gCurrStatus |= kStatus.notificationsDone;</span>
<a href="#l13.60"></a><span id="l13.60" class="difflineplus">+      if (gCurrStatus == kStatus.everythingDone)</span>
<a href="#l13.61"></a><span id="l13.61" class="difflineplus">+        resetStatusAndProceed();</span>
<a href="#l13.62"></a><span id="l13.62" class="difflineplus">+    }</span>
<a href="#l13.63"></a><span id="l13.63" class="difflineplus">+  },</span>
<a href="#l13.64"></a><span id="l13.64" class="difflineplus">+  </span>
<a href="#l13.65"></a><span id="l13.65">   folderAdded: function(aFolder)</span>
<a href="#l13.66"></a><span id="l13.66">   {</span>
<a href="#l13.67"></a><span id="l13.67">     verify([gMFNService.folderAdded, aFolder]);</span>
<a href="#l13.68"></a><span id="l13.68">     if (gExpectedEvents.length == 0)</span>
<a href="#l13.69"></a><span id="l13.69">     {</span>
<a href="#l13.70"></a><span id="l13.70">       gCurrStatus |= kStatus.notificationsDone;</span>
<a href="#l13.71"></a><span id="l13.71">       if (gCurrStatus == kStatus.everythingDone)</span>
<a href="#l13.72"></a><span id="l13.72">         resetStatusAndProceed();</span>
<a href="#l13.73"></a><span id="l13.73" class="difflineat">@@ -312,47 +304,42 @@ function verify(event)</span>
<a href="#l13.74"></a><span id="l13.74">     else { // actual headers</span>
<a href="#l13.75"></a><span id="l13.75">       hasExactlyElements(expected[1], event[1]);</span>
<a href="#l13.76"></a><span id="l13.76">     }</span>
<a href="#l13.77"></a><span id="l13.77">     // aJunkProcessed: was the message processed for junk?</span>
<a href="#l13.78"></a><span id="l13.78">     do_check_eq(expected[2], event[2]);</span>
<a href="#l13.79"></a><span id="l13.79">     // aTraitProcessed: was the message processed for traits?</span>
<a href="#l13.80"></a><span id="l13.80">     do_check_eq(expected[3], event[3]);</span>
<a href="#l13.81"></a><span id="l13.81">     break;</span>
<a href="#l13.82"></a><span id="l13.82" class="difflineplus">+  case gMFNService.msgKeyChanged:</span>
<a href="#l13.83"></a><span id="l13.83" class="difflineplus">+    do_check_eq(expected[1].messageId, event[2].expectedMessageId);</span>
<a href="#l13.84"></a><span id="l13.84" class="difflineplus">+    break;</span>
<a href="#l13.85"></a><span id="l13.85">   case gMFNService.msgsMoveCopyCompleted:</span>
<a href="#l13.86"></a><span id="l13.86">   case gMFNService.folderMoveCopyCompleted:</span>
<a href="#l13.87"></a><span id="l13.87">     // Check: Move or copy as expected.</span>
<a href="#l13.88"></a><span id="l13.88">     do_check_eq(expected[1], event[1]);</span>
<a href="#l13.89"></a><span id="l13.89"> </span>
<a href="#l13.90"></a><span id="l13.90">     // Check: headers match/folder matches.</span>
<a href="#l13.91"></a><span id="l13.91">     hasExactlyElements(expected[2], event[2]);</span>
<a href="#l13.92"></a><span id="l13.92"> </span>
<a href="#l13.93"></a><span id="l13.93">     // Check: destination folder matches.</span>
<a href="#l13.94"></a><span id="l13.94">     do_check_eq(expected[3], event[3]);</span>
<a href="#l13.95"></a><span id="l13.95"> </span>
<a href="#l13.96"></a><span id="l13.96">     if (eventType == gMFNService.folderMoveCopyCompleted)</span>
<a href="#l13.97"></a><span id="l13.97">       break;</span>
<a href="#l13.98"></a><span id="l13.98"> </span>
<a href="#l13.99"></a><span id="l13.99" class="difflineminus">-    // Check: destination headers.  We only expect these in the local folder</span>
<a href="#l13.100"></a><span id="l13.100" class="difflineminus">-    //  case, and in that case, we will not have heard about the headers ahead</span>
<a href="#l13.101"></a><span id="l13.101" class="difflineminus">-    //  of time, so the best we can do is make sure they match up.  To this end,</span>
<a href="#l13.102"></a><span id="l13.102" class="difflineminus">-    //  if null is expected then we check for null.  If true is expected, then</span>
<a href="#l13.103"></a><span id="l13.103" class="difflineplus">+    // Check: destination headers.  We expect these for local and imap folders,</span>
<a href="#l13.104"></a><span id="l13.104" class="difflineplus">+    //  but we will not have heard about the headers ahead of time,</span>
<a href="#l13.105"></a><span id="l13.105" class="difflineplus">+    //  so the best we can do is make sure they match up.  To this end,</span>
<a href="#l13.106"></a><span id="l13.106">     //  we check that the message-id header values match up.</span>
<a href="#l13.107"></a><span id="l13.107" class="difflineminus">-    if (expected[4] == null)</span>
<a href="#l13.108"></a><span id="l13.108" class="difflineplus">+    for (let iMsg = 0; iMsg &lt; event[2].length; iMsg++)</span>
<a href="#l13.109"></a><span id="l13.109">     {</span>
<a href="#l13.110"></a><span id="l13.110" class="difflineminus">-      do_check_eq(null, event[4]);</span>
<a href="#l13.111"></a><span id="l13.111" class="difflineminus">-    }</span>
<a href="#l13.112"></a><span id="l13.112" class="difflineminus">-    else</span>
<a href="#l13.113"></a><span id="l13.113" class="difflineminus">-    {</span>
<a href="#l13.114"></a><span id="l13.114" class="difflineminus">-      for (let iMsg = 0; iMsg &lt; event[2].length; iMsg++)</span>
<a href="#l13.115"></a><span id="l13.115" class="difflineminus">-      {</span>
<a href="#l13.116"></a><span id="l13.116" class="difflineminus">-        let srcHdr = event[2].queryElementAt(iMsg, nsIMsgDBHdr);</span>
<a href="#l13.117"></a><span id="l13.117" class="difflineminus">-        let destHdr = event[4].queryElementAt(iMsg, nsIMsgDBHdr);</span>
<a href="#l13.118"></a><span id="l13.118" class="difflineminus">-        do_check_eq(srcHdr.messageId, destHdr.messageId);</span>
<a href="#l13.119"></a><span id="l13.119" class="difflineminus">-      }</span>
<a href="#l13.120"></a><span id="l13.120" class="difflineplus">+      let srcHdr = event[2].queryElementAt(iMsg, nsIMsgDBHdr);</span>
<a href="#l13.121"></a><span id="l13.121" class="difflineplus">+      let destHdr = event[4].queryElementAt(iMsg, nsIMsgDBHdr);</span>
<a href="#l13.122"></a><span id="l13.122" class="difflineplus">+      do_check_eq(srcHdr.messageId, destHdr.messageId);</span>
<a href="#l13.123"></a><span id="l13.123">     }</span>
<a href="#l13.124"></a><span id="l13.124">     break;</span>
<a href="#l13.125"></a><span id="l13.125">   case gMFNService.folderAdded:</span>
<a href="#l13.126"></a><span id="l13.126">     // Check: parent folder matches</span>
<a href="#l13.127"></a><span id="l13.127">     do_check_eq(event[1].parent, expected[1]);</span>
<a href="#l13.128"></a><span id="l13.128"> </span>
<a href="#l13.129"></a><span id="l13.129">     // Check: folder name matches</span>
<a href="#l13.130"></a><span id="l13.130">     do_check_eq(event[1].prettyName, expected[2]);</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

