<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 25591:96b12a150fe1d827b9be239705e6e94492d36c54</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 96b12a150fe1d827b9be239705e6e94492d36c54" />
<meta property="og:url" content="/comm-central/rev/96b12a150fe1d827b9be239705e6e94492d36c54" />
<meta property="og:description" content="Bug 1518823 - Port bug 1482389: Remove acces via .treeBoxObject and .boxObject. rs=bustage-fix" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 96b12a150fe1d827b9be239705e6e94492d36c54 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/96b12a150fe1d827b9be239705e6e94492d36c54">shortlog</a> |
<a href="/comm-central/log/96b12a150fe1d827b9be239705e6e94492d36c54">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/96b12a150fe1d827b9be239705e6e94492d36c54">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/96b12a150fe1d827b9be239705e6e94492d36c54">files</a> |
changeset |
<a href="/comm-central/raw-rev/96b12a150fe1d827b9be239705e6e94492d36c54">raw</a>  | <a href="/comm-central/archive/96b12a150fe1d827b9be239705e6e94492d36c54.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1518823">Bug 1518823</a> - Port <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1482389">bug 1482389</a>: Remove acces via .treeBoxObject and .boxObject. rs=bustage-fix
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#74;&#111;&#114;&#103;&#32;&#75;&#32;&#60;&#106;&#111;&#114;&#103;&#107;&#64;&#106;&#111;&#114;&#103;&#107;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 15 Jan 2019 10:42:53 +0100</td></tr>

<tr>
 <td>changeset 25591</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/96b12a150fe1d827b9be239705e6e94492d36c54">96b12a150fe1d827b9be239705e6e94492d36c54</a></td>
</tr>



<tr>
<td>parent 25590</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/85114397b4c8277f1f764e1b3826940345b500ec">85114397b4c8277f1f764e1b3826940345b500ec</a>
</td>
</tr>

<tr>
<td>child 25592</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/561033e56bac3a4bf5724ba104d127835db5dfd6">561033e56bac3a4bf5724ba104d127835db5dfd6</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=96b12a150fe1d827b9be239705e6e94492d36c54">15360</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Tue, 15 Jan 2019 10:04:04 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@561033e56bac [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=561033e56bac3a4bf5724ba104d127835db5dfd6">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=561033e56bac3a4bf5724ba104d127835db5dfd6&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=561033e56bac3a4bf5724ba104d127835db5dfd6&newProject=comm-central&newRevision=85114397b4c8277f1f764e1b3826940345b500ec&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=561033e56bac3a4bf5724ba104d127835db5dfd6&newProject=comm-central&newRevision=85114397b4c8277f1f764e1b3826940345b500ec&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=561033e56bac3a4bf5724ba104d127835db5dfd6&newProject=comm-central&newRevision=85114397b4c8277f1f764e1b3826940345b500ec&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28bustage-fix%29&revcount=50">bustage-fix</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1518823">1518823</a>, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1482389">1482389</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1518823">Bug 1518823</a> - Port <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1482389">bug 1482389</a>: Remove acces via .treeBoxObject and .boxObject. rs=bustage-fix</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/96b12a150fe1d827b9be239705e6e94492d36c54/editor/ui/dialogs/content/EdSelectProps.js">editor/ui/dialogs/content/EdSelectProps.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/96b12a150fe1d827b9be239705e6e94492d36c54/editor/ui/dialogs/content/EdSelectProps.js">file</a> |
<a href="/comm-central/annotate/96b12a150fe1d827b9be239705e6e94492d36c54/editor/ui/dialogs/content/EdSelectProps.js">annotate</a> |
<a href="/comm-central/diff/96b12a150fe1d827b9be239705e6e94492d36c54/editor/ui/dialogs/content/EdSelectProps.js">diff</a> |
<a href="/comm-central/comparison/96b12a150fe1d827b9be239705e6e94492d36c54/editor/ui/dialogs/content/EdSelectProps.js">comparison</a> |
<a href="/comm-central/log/96b12a150fe1d827b9be239705e6e94492d36c54/editor/ui/dialogs/content/EdSelectProps.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/96b12a150fe1d827b9be239705e6e94492d36c54/editor/ui/dialogs/content/EditorSaveAsCharset.js">editor/ui/dialogs/content/EditorSaveAsCharset.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/96b12a150fe1d827b9be239705e6e94492d36c54/editor/ui/dialogs/content/EditorSaveAsCharset.js">file</a> |
<a href="/comm-central/annotate/96b12a150fe1d827b9be239705e6e94492d36c54/editor/ui/dialogs/content/EditorSaveAsCharset.js">annotate</a> |
<a href="/comm-central/diff/96b12a150fe1d827b9be239705e6e94492d36c54/editor/ui/dialogs/content/EditorSaveAsCharset.js">diff</a> |
<a href="/comm-central/comparison/96b12a150fe1d827b9be239705e6e94492d36c54/editor/ui/dialogs/content/EditorSaveAsCharset.js">comparison</a> |
<a href="/comm-central/log/96b12a150fe1d827b9be239705e6e94492d36c54/editor/ui/dialogs/content/EditorSaveAsCharset.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/96b12a150fe1d827b9be239705e6e94492d36c54/mail/base/content/SearchDialog.js">mail/base/content/SearchDialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/96b12a150fe1d827b9be239705e6e94492d36c54/mail/base/content/SearchDialog.js">file</a> |
<a href="/comm-central/annotate/96b12a150fe1d827b9be239705e6e94492d36c54/mail/base/content/SearchDialog.js">annotate</a> |
<a href="/comm-central/diff/96b12a150fe1d827b9be239705e6e94492d36c54/mail/base/content/SearchDialog.js">diff</a> |
<a href="/comm-central/comparison/96b12a150fe1d827b9be239705e6e94492d36c54/mail/base/content/SearchDialog.js">comparison</a> |
<a href="/comm-central/log/96b12a150fe1d827b9be239705e6e94492d36c54/mail/base/content/SearchDialog.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/96b12a150fe1d827b9be239705e6e94492d36c54/mail/base/content/folderDisplay.js">mail/base/content/folderDisplay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/96b12a150fe1d827b9be239705e6e94492d36c54/mail/base/content/folderDisplay.js">file</a> |
<a href="/comm-central/annotate/96b12a150fe1d827b9be239705e6e94492d36c54/mail/base/content/folderDisplay.js">annotate</a> |
<a href="/comm-central/diff/96b12a150fe1d827b9be239705e6e94492d36c54/mail/base/content/folderDisplay.js">diff</a> |
<a href="/comm-central/comparison/96b12a150fe1d827b9be239705e6e94492d36c54/mail/base/content/folderDisplay.js">comparison</a> |
<a href="/comm-central/log/96b12a150fe1d827b9be239705e6e94492d36c54/mail/base/content/folderDisplay.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/96b12a150fe1d827b9be239705e6e94492d36c54/mail/base/content/folderPane.js">mail/base/content/folderPane.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/96b12a150fe1d827b9be239705e6e94492d36c54/mail/base/content/folderPane.js">file</a> |
<a href="/comm-central/annotate/96b12a150fe1d827b9be239705e6e94492d36c54/mail/base/content/folderPane.js">annotate</a> |
<a href="/comm-central/diff/96b12a150fe1d827b9be239705e6e94492d36c54/mail/base/content/folderPane.js">diff</a> |
<a href="/comm-central/comparison/96b12a150fe1d827b9be239705e6e94492d36c54/mail/base/content/folderPane.js">comparison</a> |
<a href="/comm-central/log/96b12a150fe1d827b9be239705e6e94492d36c54/mail/base/content/folderPane.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/96b12a150fe1d827b9be239705e6e94492d36c54/mail/base/content/foldersummary.js">mail/base/content/foldersummary.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/96b12a150fe1d827b9be239705e6e94492d36c54/mail/base/content/foldersummary.js">file</a> |
<a href="/comm-central/annotate/96b12a150fe1d827b9be239705e6e94492d36c54/mail/base/content/foldersummary.js">annotate</a> |
<a href="/comm-central/diff/96b12a150fe1d827b9be239705e6e94492d36c54/mail/base/content/foldersummary.js">diff</a> |
<a href="/comm-central/comparison/96b12a150fe1d827b9be239705e6e94492d36c54/mail/base/content/foldersummary.js">comparison</a> |
<a href="/comm-central/log/96b12a150fe1d827b9be239705e6e94492d36c54/mail/base/content/foldersummary.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/96b12a150fe1d827b9be239705e6e94492d36c54/mail/base/content/mailCommands.js">mail/base/content/mailCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/96b12a150fe1d827b9be239705e6e94492d36c54/mail/base/content/mailCommands.js">file</a> |
<a href="/comm-central/annotate/96b12a150fe1d827b9be239705e6e94492d36c54/mail/base/content/mailCommands.js">annotate</a> |
<a href="/comm-central/diff/96b12a150fe1d827b9be239705e6e94492d36c54/mail/base/content/mailCommands.js">diff</a> |
<a href="/comm-central/comparison/96b12a150fe1d827b9be239705e6e94492d36c54/mail/base/content/mailCommands.js">comparison</a> |
<a href="/comm-central/log/96b12a150fe1d827b9be239705e6e94492d36c54/mail/base/content/mailCommands.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/96b12a150fe1d827b9be239705e6e94492d36c54/mail/base/content/mailContextMenus.js">mail/base/content/mailContextMenus.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/96b12a150fe1d827b9be239705e6e94492d36c54/mail/base/content/mailContextMenus.js">file</a> |
<a href="/comm-central/annotate/96b12a150fe1d827b9be239705e6e94492d36c54/mail/base/content/mailContextMenus.js">annotate</a> |
<a href="/comm-central/diff/96b12a150fe1d827b9be239705e6e94492d36c54/mail/base/content/mailContextMenus.js">diff</a> |
<a href="/comm-central/comparison/96b12a150fe1d827b9be239705e6e94492d36c54/mail/base/content/mailContextMenus.js">comparison</a> |
<a href="/comm-central/log/96b12a150fe1d827b9be239705e6e94492d36c54/mail/base/content/mailContextMenus.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/96b12a150fe1d827b9be239705e6e94492d36c54/mail/base/content/mailTabs.js">mail/base/content/mailTabs.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/96b12a150fe1d827b9be239705e6e94492d36c54/mail/base/content/mailTabs.js">file</a> |
<a href="/comm-central/annotate/96b12a150fe1d827b9be239705e6e94492d36c54/mail/base/content/mailTabs.js">annotate</a> |
<a href="/comm-central/diff/96b12a150fe1d827b9be239705e6e94492d36c54/mail/base/content/mailTabs.js">diff</a> |
<a href="/comm-central/comparison/96b12a150fe1d827b9be239705e6e94492d36c54/mail/base/content/mailTabs.js">comparison</a> |
<a href="/comm-central/log/96b12a150fe1d827b9be239705e6e94492d36c54/mail/base/content/mailTabs.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/96b12a150fe1d827b9be239705e6e94492d36c54/mail/base/content/mailWidgets.xml">mail/base/content/mailWidgets.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/96b12a150fe1d827b9be239705e6e94492d36c54/mail/base/content/mailWidgets.xml">file</a> |
<a href="/comm-central/annotate/96b12a150fe1d827b9be239705e6e94492d36c54/mail/base/content/mailWidgets.xml">annotate</a> |
<a href="/comm-central/diff/96b12a150fe1d827b9be239705e6e94492d36c54/mail/base/content/mailWidgets.xml">diff</a> |
<a href="/comm-central/comparison/96b12a150fe1d827b9be239705e6e94492d36c54/mail/base/content/mailWidgets.xml">comparison</a> |
<a href="/comm-central/log/96b12a150fe1d827b9be239705e6e94492d36c54/mail/base/content/mailWidgets.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/96b12a150fe1d827b9be239705e6e94492d36c54/mail/base/content/messageWindow.js">mail/base/content/messageWindow.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/96b12a150fe1d827b9be239705e6e94492d36c54/mail/base/content/messageWindow.js">file</a> |
<a href="/comm-central/annotate/96b12a150fe1d827b9be239705e6e94492d36c54/mail/base/content/messageWindow.js">annotate</a> |
<a href="/comm-central/diff/96b12a150fe1d827b9be239705e6e94492d36c54/mail/base/content/messageWindow.js">diff</a> |
<a href="/comm-central/comparison/96b12a150fe1d827b9be239705e6e94492d36c54/mail/base/content/messageWindow.js">comparison</a> |
<a href="/comm-central/log/96b12a150fe1d827b9be239705e6e94492d36c54/mail/base/content/messageWindow.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/96b12a150fe1d827b9be239705e6e94492d36c54/mail/base/content/msgMail3PaneWindow.js">mail/base/content/msgMail3PaneWindow.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/96b12a150fe1d827b9be239705e6e94492d36c54/mail/base/content/msgMail3PaneWindow.js">file</a> |
<a href="/comm-central/annotate/96b12a150fe1d827b9be239705e6e94492d36c54/mail/base/content/msgMail3PaneWindow.js">annotate</a> |
<a href="/comm-central/diff/96b12a150fe1d827b9be239705e6e94492d36c54/mail/base/content/msgMail3PaneWindow.js">diff</a> |
<a href="/comm-central/comparison/96b12a150fe1d827b9be239705e6e94492d36c54/mail/base/content/msgMail3PaneWindow.js">comparison</a> |
<a href="/comm-central/log/96b12a150fe1d827b9be239705e6e94492d36c54/mail/base/content/msgMail3PaneWindow.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/96b12a150fe1d827b9be239705e6e94492d36c54/mail/base/content/threadPane.js">mail/base/content/threadPane.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/96b12a150fe1d827b9be239705e6e94492d36c54/mail/base/content/threadPane.js">file</a> |
<a href="/comm-central/annotate/96b12a150fe1d827b9be239705e6e94492d36c54/mail/base/content/threadPane.js">annotate</a> |
<a href="/comm-central/diff/96b12a150fe1d827b9be239705e6e94492d36c54/mail/base/content/threadPane.js">diff</a> |
<a href="/comm-central/comparison/96b12a150fe1d827b9be239705e6e94492d36c54/mail/base/content/threadPane.js">comparison</a> |
<a href="/comm-central/log/96b12a150fe1d827b9be239705e6e94492d36c54/mail/base/content/threadPane.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/96b12a150fe1d827b9be239705e6e94492d36c54/mail/components/addrbook/content/abCommon.js">mail/components/addrbook/content/abCommon.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/96b12a150fe1d827b9be239705e6e94492d36c54/mail/components/addrbook/content/abCommon.js">file</a> |
<a href="/comm-central/annotate/96b12a150fe1d827b9be239705e6e94492d36c54/mail/components/addrbook/content/abCommon.js">annotate</a> |
<a href="/comm-central/diff/96b12a150fe1d827b9be239705e6e94492d36c54/mail/components/addrbook/content/abCommon.js">diff</a> |
<a href="/comm-central/comparison/96b12a150fe1d827b9be239705e6e94492d36c54/mail/components/addrbook/content/abCommon.js">comparison</a> |
<a href="/comm-central/log/96b12a150fe1d827b9be239705e6e94492d36c54/mail/components/addrbook/content/abCommon.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/96b12a150fe1d827b9be239705e6e94492d36c54/mail/components/addrbook/content/abContactsPanel.js">mail/components/addrbook/content/abContactsPanel.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/96b12a150fe1d827b9be239705e6e94492d36c54/mail/components/addrbook/content/abContactsPanel.js">file</a> |
<a href="/comm-central/annotate/96b12a150fe1d827b9be239705e6e94492d36c54/mail/components/addrbook/content/abContactsPanel.js">annotate</a> |
<a href="/comm-central/diff/96b12a150fe1d827b9be239705e6e94492d36c54/mail/components/addrbook/content/abContactsPanel.js">diff</a> |
<a href="/comm-central/comparison/96b12a150fe1d827b9be239705e6e94492d36c54/mail/components/addrbook/content/abContactsPanel.js">comparison</a> |
<a href="/comm-central/log/96b12a150fe1d827b9be239705e6e94492d36c54/mail/components/addrbook/content/abContactsPanel.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/96b12a150fe1d827b9be239705e6e94492d36c54/mail/components/extensions/test/browser/browser_ext_menus.js">mail/components/extensions/test/browser/browser_ext_menus.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/96b12a150fe1d827b9be239705e6e94492d36c54/mail/components/extensions/test/browser/browser_ext_menus.js">file</a> |
<a href="/comm-central/annotate/96b12a150fe1d827b9be239705e6e94492d36c54/mail/components/extensions/test/browser/browser_ext_menus.js">annotate</a> |
<a href="/comm-central/diff/96b12a150fe1d827b9be239705e6e94492d36c54/mail/components/extensions/test/browser/browser_ext_menus.js">diff</a> |
<a href="/comm-central/comparison/96b12a150fe1d827b9be239705e6e94492d36c54/mail/components/extensions/test/browser/browser_ext_menus.js">comparison</a> |
<a href="/comm-central/log/96b12a150fe1d827b9be239705e6e94492d36c54/mail/components/extensions/test/browser/browser_ext_menus.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/96b12a150fe1d827b9be239705e6e94492d36c54/mail/components/im/content/chat-messenger.js">mail/components/im/content/chat-messenger.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/96b12a150fe1d827b9be239705e6e94492d36c54/mail/components/im/content/chat-messenger.js">file</a> |
<a href="/comm-central/annotate/96b12a150fe1d827b9be239705e6e94492d36c54/mail/components/im/content/chat-messenger.js">annotate</a> |
<a href="/comm-central/diff/96b12a150fe1d827b9be239705e6e94492d36c54/mail/components/im/content/chat-messenger.js">diff</a> |
<a href="/comm-central/comparison/96b12a150fe1d827b9be239705e6e94492d36c54/mail/components/im/content/chat-messenger.js">comparison</a> |
<a href="/comm-central/log/96b12a150fe1d827b9be239705e6e94492d36c54/mail/components/im/content/chat-messenger.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/96b12a150fe1d827b9be239705e6e94492d36c54/mail/components/preferences/cookies.js">mail/components/preferences/cookies.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/96b12a150fe1d827b9be239705e6e94492d36c54/mail/components/preferences/cookies.js">file</a> |
<a href="/comm-central/annotate/96b12a150fe1d827b9be239705e6e94492d36c54/mail/components/preferences/cookies.js">annotate</a> |
<a href="/comm-central/diff/96b12a150fe1d827b9be239705e6e94492d36c54/mail/components/preferences/cookies.js">diff</a> |
<a href="/comm-central/comparison/96b12a150fe1d827b9be239705e6e94492d36c54/mail/components/preferences/cookies.js">comparison</a> |
<a href="/comm-central/log/96b12a150fe1d827b9be239705e6e94492d36c54/mail/components/preferences/cookies.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/96b12a150fe1d827b9be239705e6e94492d36c54/mail/components/preferences/permissions.js">mail/components/preferences/permissions.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/96b12a150fe1d827b9be239705e6e94492d36c54/mail/components/preferences/permissions.js">file</a> |
<a href="/comm-central/annotate/96b12a150fe1d827b9be239705e6e94492d36c54/mail/components/preferences/permissions.js">annotate</a> |
<a href="/comm-central/diff/96b12a150fe1d827b9be239705e6e94492d36c54/mail/components/preferences/permissions.js">diff</a> |
<a href="/comm-central/comparison/96b12a150fe1d827b9be239705e6e94492d36c54/mail/components/preferences/permissions.js">comparison</a> |
<a href="/comm-central/log/96b12a150fe1d827b9be239705e6e94492d36c54/mail/components/preferences/permissions.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/96b12a150fe1d827b9be239705e6e94492d36c54/mail/test/mozmill/folder-display/test-right-click-middle-click-messages.js">mail/test/mozmill/folder-display/test-right-click-middle-click-messages.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/96b12a150fe1d827b9be239705e6e94492d36c54/mail/test/mozmill/folder-display/test-right-click-middle-click-messages.js">file</a> |
<a href="/comm-central/annotate/96b12a150fe1d827b9be239705e6e94492d36c54/mail/test/mozmill/folder-display/test-right-click-middle-click-messages.js">annotate</a> |
<a href="/comm-central/diff/96b12a150fe1d827b9be239705e6e94492d36c54/mail/test/mozmill/folder-display/test-right-click-middle-click-messages.js">diff</a> |
<a href="/comm-central/comparison/96b12a150fe1d827b9be239705e6e94492d36c54/mail/test/mozmill/folder-display/test-right-click-middle-click-messages.js">comparison</a> |
<a href="/comm-central/log/96b12a150fe1d827b9be239705e6e94492d36c54/mail/test/mozmill/folder-display/test-right-click-middle-click-messages.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/96b12a150fe1d827b9be239705e6e94492d36c54/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">mail/test/mozmill/shared-modules/test-folder-display-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/96b12a150fe1d827b9be239705e6e94492d36c54/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">file</a> |
<a href="/comm-central/annotate/96b12a150fe1d827b9be239705e6e94492d36c54/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">annotate</a> |
<a href="/comm-central/diff/96b12a150fe1d827b9be239705e6e94492d36c54/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">diff</a> |
<a href="/comm-central/comparison/96b12a150fe1d827b9be239705e6e94492d36c54/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">comparison</a> |
<a href="/comm-central/log/96b12a150fe1d827b9be239705e6e94492d36c54/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/96b12a150fe1d827b9be239705e6e94492d36c54/mailnews/addrbook/content/abResultsPane.js">mailnews/addrbook/content/abResultsPane.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/96b12a150fe1d827b9be239705e6e94492d36c54/mailnews/addrbook/content/abResultsPane.js">file</a> |
<a href="/comm-central/annotate/96b12a150fe1d827b9be239705e6e94492d36c54/mailnews/addrbook/content/abResultsPane.js">annotate</a> |
<a href="/comm-central/diff/96b12a150fe1d827b9be239705e6e94492d36c54/mailnews/addrbook/content/abResultsPane.js">diff</a> |
<a href="/comm-central/comparison/96b12a150fe1d827b9be239705e6e94492d36c54/mailnews/addrbook/content/abResultsPane.js">comparison</a> |
<a href="/comm-central/log/96b12a150fe1d827b9be239705e6e94492d36c54/mailnews/addrbook/content/abResultsPane.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/96b12a150fe1d827b9be239705e6e94492d36c54/mailnews/base/content/msgSelectOfflineFolders.js">mailnews/base/content/msgSelectOfflineFolders.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/96b12a150fe1d827b9be239705e6e94492d36c54/mailnews/base/content/msgSelectOfflineFolders.js">file</a> |
<a href="/comm-central/annotate/96b12a150fe1d827b9be239705e6e94492d36c54/mailnews/base/content/msgSelectOfflineFolders.js">annotate</a> |
<a href="/comm-central/diff/96b12a150fe1d827b9be239705e6e94492d36c54/mailnews/base/content/msgSelectOfflineFolders.js">diff</a> |
<a href="/comm-central/comparison/96b12a150fe1d827b9be239705e6e94492d36c54/mailnews/base/content/msgSelectOfflineFolders.js">comparison</a> |
<a href="/comm-central/log/96b12a150fe1d827b9be239705e6e94492d36c54/mailnews/base/content/msgSelectOfflineFolders.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/96b12a150fe1d827b9be239705e6e94492d36c54/mailnews/base/content/msgSynchronize.js">mailnews/base/content/msgSynchronize.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/96b12a150fe1d827b9be239705e6e94492d36c54/mailnews/base/content/msgSynchronize.js">file</a> |
<a href="/comm-central/annotate/96b12a150fe1d827b9be239705e6e94492d36c54/mailnews/base/content/msgSynchronize.js">annotate</a> |
<a href="/comm-central/diff/96b12a150fe1d827b9be239705e6e94492d36c54/mailnews/base/content/msgSynchronize.js">diff</a> |
<a href="/comm-central/comparison/96b12a150fe1d827b9be239705e6e94492d36c54/mailnews/base/content/msgSynchronize.js">comparison</a> |
<a href="/comm-central/log/96b12a150fe1d827b9be239705e6e94492d36c54/mailnews/base/content/msgSynchronize.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/96b12a150fe1d827b9be239705e6e94492d36c54/mailnews/base/content/subscribe.js">mailnews/base/content/subscribe.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/96b12a150fe1d827b9be239705e6e94492d36c54/mailnews/base/content/subscribe.js">file</a> |
<a href="/comm-central/annotate/96b12a150fe1d827b9be239705e6e94492d36c54/mailnews/base/content/subscribe.js">annotate</a> |
<a href="/comm-central/diff/96b12a150fe1d827b9be239705e6e94492d36c54/mailnews/base/content/subscribe.js">diff</a> |
<a href="/comm-central/comparison/96b12a150fe1d827b9be239705e6e94492d36c54/mailnews/base/content/subscribe.js">comparison</a> |
<a href="/comm-central/log/96b12a150fe1d827b9be239705e6e94492d36c54/mailnews/base/content/subscribe.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/96b12a150fe1d827b9be239705e6e94492d36c54/mailnews/base/content/virtualFolderListEdit.js">mailnews/base/content/virtualFolderListEdit.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/96b12a150fe1d827b9be239705e6e94492d36c54/mailnews/base/content/virtualFolderListEdit.js">file</a> |
<a href="/comm-central/annotate/96b12a150fe1d827b9be239705e6e94492d36c54/mailnews/base/content/virtualFolderListEdit.js">annotate</a> |
<a href="/comm-central/diff/96b12a150fe1d827b9be239705e6e94492d36c54/mailnews/base/content/virtualFolderListEdit.js">diff</a> |
<a href="/comm-central/comparison/96b12a150fe1d827b9be239705e6e94492d36c54/mailnews/base/content/virtualFolderListEdit.js">comparison</a> |
<a href="/comm-central/log/96b12a150fe1d827b9be239705e6e94492d36c54/mailnews/base/content/virtualFolderListEdit.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/96b12a150fe1d827b9be239705e6e94492d36c54/mailnews/base/prefs/content/AccountManager.js">mailnews/base/prefs/content/AccountManager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/96b12a150fe1d827b9be239705e6e94492d36c54/mailnews/base/prefs/content/AccountManager.js">file</a> |
<a href="/comm-central/annotate/96b12a150fe1d827b9be239705e6e94492d36c54/mailnews/base/prefs/content/AccountManager.js">annotate</a> |
<a href="/comm-central/diff/96b12a150fe1d827b9be239705e6e94492d36c54/mailnews/base/prefs/content/AccountManager.js">diff</a> |
<a href="/comm-central/comparison/96b12a150fe1d827b9be239705e6e94492d36c54/mailnews/base/prefs/content/AccountManager.js">comparison</a> |
<a href="/comm-central/log/96b12a150fe1d827b9be239705e6e94492d36c54/mailnews/base/prefs/content/AccountManager.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/96b12a150fe1d827b9be239705e6e94492d36c54/mailnews/base/util/jsTreeSelection.js">mailnews/base/util/jsTreeSelection.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/96b12a150fe1d827b9be239705e6e94492d36c54/mailnews/base/util/jsTreeSelection.js">file</a> |
<a href="/comm-central/annotate/96b12a150fe1d827b9be239705e6e94492d36c54/mailnews/base/util/jsTreeSelection.js">annotate</a> |
<a href="/comm-central/diff/96b12a150fe1d827b9be239705e6e94492d36c54/mailnews/base/util/jsTreeSelection.js">diff</a> |
<a href="/comm-central/comparison/96b12a150fe1d827b9be239705e6e94492d36c54/mailnews/base/util/jsTreeSelection.js">comparison</a> |
<a href="/comm-central/log/96b12a150fe1d827b9be239705e6e94492d36c54/mailnews/base/util/jsTreeSelection.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/96b12a150fe1d827b9be239705e6e94492d36c54/mailnews/extensions/newsblog/content/FeedUtils.jsm">mailnews/extensions/newsblog/content/FeedUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/96b12a150fe1d827b9be239705e6e94492d36c54/mailnews/extensions/newsblog/content/FeedUtils.jsm">file</a> |
<a href="/comm-central/annotate/96b12a150fe1d827b9be239705e6e94492d36c54/mailnews/extensions/newsblog/content/FeedUtils.jsm">annotate</a> |
<a href="/comm-central/diff/96b12a150fe1d827b9be239705e6e94492d36c54/mailnews/extensions/newsblog/content/FeedUtils.jsm">diff</a> |
<a href="/comm-central/comparison/96b12a150fe1d827b9be239705e6e94492d36c54/mailnews/extensions/newsblog/content/FeedUtils.jsm">comparison</a> |
<a href="/comm-central/log/96b12a150fe1d827b9be239705e6e94492d36c54/mailnews/extensions/newsblog/content/FeedUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/96b12a150fe1d827b9be239705e6e94492d36c54/mailnews/extensions/newsblog/content/feed-subscriptions.js">mailnews/extensions/newsblog/content/feed-subscriptions.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/96b12a150fe1d827b9be239705e6e94492d36c54/mailnews/extensions/newsblog/content/feed-subscriptions.js">file</a> |
<a href="/comm-central/annotate/96b12a150fe1d827b9be239705e6e94492d36c54/mailnews/extensions/newsblog/content/feed-subscriptions.js">annotate</a> |
<a href="/comm-central/diff/96b12a150fe1d827b9be239705e6e94492d36c54/mailnews/extensions/newsblog/content/feed-subscriptions.js">diff</a> |
<a href="/comm-central/comparison/96b12a150fe1d827b9be239705e6e94492d36c54/mailnews/extensions/newsblog/content/feed-subscriptions.js">comparison</a> |
<a href="/comm-central/log/96b12a150fe1d827b9be239705e6e94492d36c54/mailnews/extensions/newsblog/content/feed-subscriptions.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/96b12a150fe1d827b9be239705e6e94492d36c54/mailnews/extensions/newsblog/content/newsblogOverlay.js">mailnews/extensions/newsblog/content/newsblogOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/96b12a150fe1d827b9be239705e6e94492d36c54/mailnews/extensions/newsblog/content/newsblogOverlay.js">file</a> |
<a href="/comm-central/annotate/96b12a150fe1d827b9be239705e6e94492d36c54/mailnews/extensions/newsblog/content/newsblogOverlay.js">annotate</a> |
<a href="/comm-central/diff/96b12a150fe1d827b9be239705e6e94492d36c54/mailnews/extensions/newsblog/content/newsblogOverlay.js">diff</a> |
<a href="/comm-central/comparison/96b12a150fe1d827b9be239705e6e94492d36c54/mailnews/extensions/newsblog/content/newsblogOverlay.js">comparison</a> |
<a href="/comm-central/log/96b12a150fe1d827b9be239705e6e94492d36c54/mailnews/extensions/newsblog/content/newsblogOverlay.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/editor/ui/dialogs/content/EdSelectProps.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/editor/ui/dialogs/content/EdSelectProps.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -3,17 +3,17 @@</span>
<a href="#l1.4"></a><span id="l1.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l1.5"></a><span id="l1.5"> </span>
<a href="#l1.6"></a><span id="l1.6"> // Global variables</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8"> var hasValue;</span>
<a href="#l1.9"></a><span id="l1.9"> var oldValue;</span>
<a href="#l1.10"></a><span id="l1.10"> var insertNew;</span>
<a href="#l1.11"></a><span id="l1.11"> var itemArray;</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-var treeBoxObject;</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+var theTree;</span>
<a href="#l1.14"></a><span id="l1.14"> var treeSelection;</span>
<a href="#l1.15"></a><span id="l1.15"> var selectElement;</span>
<a href="#l1.16"></a><span id="l1.16"> var currentItem = null;</span>
<a href="#l1.17"></a><span id="l1.17"> var selectedOption = null;</span>
<a href="#l1.18"></a><span id="l1.18"> var selectedOptionCount = 0;</span>
<a href="#l1.19"></a><span id="l1.19"> </span>
<a href="#l1.20"></a><span id="l1.20"> // Utility functions</span>
<a href="#l1.21"></a><span id="l1.21"> </span>
<a href="#l1.22"></a><span id="l1.22" class="difflineat">@@ -89,24 +89,24 @@ optionObject.prototype.cycleCell = funct</span>
<a href="#l1.23"></a><span id="l1.23">   else</span>
<a href="#l1.24"></a><span id="l1.24">   {</span>
<a href="#l1.25"></a><span id="l1.25">     // Different handling for multiselect lists</span>
<a href="#l1.26"></a><span id="l1.26">     if (gDialog.selectMultiple.checked || !selectedOption)</span>
<a href="#l1.27"></a><span id="l1.27">       selectedOptionCount++;</span>
<a href="#l1.28"></a><span id="l1.28">     else if (selectedOption)</span>
<a href="#l1.29"></a><span id="l1.29">     {</span>
<a href="#l1.30"></a><span id="l1.30">       selectedOption.removeAttribute(&quot;selected&quot;);</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-      var column = treeBoxObject.columns[&quot;SelectSelCol&quot;];</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineminus">-      treeBoxObject.invalidateColumn(column);</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+      var column = theTree.columns[&quot;SelectSelCol&quot;];</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+      theTree.invalidateColumn(column);</span>
<a href="#l1.35"></a><span id="l1.35">       selectedOption = null;</span>
<a href="#l1.36"></a><span id="l1.36">     }</span>
<a href="#l1.37"></a><span id="l1.37">     this.element.setAttribute(&quot;selected&quot;, &quot;&quot;);</span>
<a href="#l1.38"></a><span id="l1.38">     selectedOption = this.element;</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineminus">-    var column = treeBoxObject.columns[&quot;SelectSelCol&quot;];</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineminus">-    treeBoxObject.invalidateCell(index, column);</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineplus">+    var column = theTree.columns[&quot;SelectSelCol&quot;];</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineplus">+    theTree.invalidateCell(index, column);</span>
<a href="#l1.43"></a><span id="l1.43">   }</span>
<a href="#l1.44"></a><span id="l1.44">   if (currentItem == this)</span>
<a href="#l1.45"></a><span id="l1.45">     // Also update the deck</span>
<a href="#l1.46"></a><span id="l1.46">     gDialog.optionSelected.setAttribute(&quot;checked&quot;, this.element.hasAttribute(&quot;selected&quot;));</span>
<a href="#l1.47"></a><span id="l1.47">   UpdateSelectMultiple();</span>
<a href="#l1.48"></a><span id="l1.48"> };</span>
<a href="#l1.49"></a><span id="l1.49"> </span>
<a href="#l1.50"></a><span id="l1.50"> optionObject.prototype.onFocus = function onFocus()</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineat">@@ -173,20 +173,20 @@ optionObject.prototype.destroy = functio</span>
<a href="#l1.52"></a><span id="l1.52"> </span>
<a href="#l1.53"></a><span id="l1.53"> optionObject.prototype.moveUp = function moveUp()</span>
<a href="#l1.54"></a><span id="l1.54"> {</span>
<a href="#l1.55"></a><span id="l1.55">   var i;</span>
<a href="#l1.56"></a><span id="l1.56">   var index = treeSelection.currentIndex;</span>
<a href="#l1.57"></a><span id="l1.57">   if (itemArray[index].level &lt; itemArray[index - 1].level + itemArray[index - 1].container)</span>
<a href="#l1.58"></a><span id="l1.58">   {</span>
<a href="#l1.59"></a><span id="l1.59">     // we need to repaint the tree's lines</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineminus">-    treeBoxObject.invalidateRange(getParentIndex(index), index);</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineplus">+    theTree.invalidateRange(getParentIndex(index), index);</span>
<a href="#l1.62"></a><span id="l1.62">     // a) option is just after an optgroup, so it becomes the last child</span>
<a href="#l1.63"></a><span id="l1.63">     itemArray[index].level = 2;</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineminus">-    treeBoxObject.view.selectionChanged();</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineplus">+    theTree.view.selectionChanged();</span>
<a href="#l1.66"></a><span id="l1.66">   }</span>
<a href="#l1.67"></a><span id="l1.67">   else</span>
<a href="#l1.68"></a><span id="l1.68">   {</span>
<a href="#l1.69"></a><span id="l1.69">     // otherwise new option level is now the same as the previous item</span>
<a href="#l1.70"></a><span id="l1.70">     itemArray[index].level = itemArray[index - 1].level;</span>
<a href="#l1.71"></a><span id="l1.71">     // swap the option with the previous item</span>
<a href="#l1.72"></a><span id="l1.72">     itemArray.splice(index, 0, itemArray.splice(--index, 1)[0]);</span>
<a href="#l1.73"></a><span id="l1.73">   }</span>
<a href="#l1.74"></a><span id="l1.74" class="difflineat">@@ -201,20 +201,20 @@ optionObject.prototype.canMoveDown = fun</span>
<a href="#l1.75"></a><span id="l1.75"> </span>
<a href="#l1.76"></a><span id="l1.76"> optionObject.prototype.moveDown = function moveDown()</span>
<a href="#l1.77"></a><span id="l1.77"> {</span>
<a href="#l1.78"></a><span id="l1.78">   var i;</span>
<a href="#l1.79"></a><span id="l1.79">   var index = treeSelection.currentIndex;</span>
<a href="#l1.80"></a><span id="l1.80">   if (index + 1 == itemArray.length || itemArray[index].level &gt; itemArray[index + 1].level)</span>
<a href="#l1.81"></a><span id="l1.81">   {</span>
<a href="#l1.82"></a><span id="l1.82">     // we need to repaint the tree's lines</span>
<a href="#l1.83"></a><span id="l1.83" class="difflineminus">-    treeBoxObject.invalidateRange(getParentIndex(index), index);</span>
<a href="#l1.84"></a><span id="l1.84" class="difflineplus">+    theTree.invalidateRange(getParentIndex(index), index);</span>
<a href="#l1.85"></a><span id="l1.85">     // a) option is last child of an optgroup, so it moves just after</span>
<a href="#l1.86"></a><span id="l1.86">     itemArray[index].level = 1;</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineminus">-    treeBoxObject.view.selectionChanged();</span>
<a href="#l1.88"></a><span id="l1.88" class="difflineplus">+    theTree.view.selectionChanged();</span>
<a href="#l1.89"></a><span id="l1.89">   }</span>
<a href="#l1.90"></a><span id="l1.90">   else</span>
<a href="#l1.91"></a><span id="l1.91">   {</span>
<a href="#l1.92"></a><span id="l1.92">     // level increases if the option was preceding an optgroup</span>
<a href="#l1.93"></a><span id="l1.93">     itemArray[index].level += itemArray[index + 1].container;</span>
<a href="#l1.94"></a><span id="l1.94">     // swap the option with the next item</span>
<a href="#l1.95"></a><span id="l1.95">     itemArray.splice(index, 0, itemArray.splice(++index, 1)[0]);</span>
<a href="#l1.96"></a><span id="l1.96">   }</span>
<a href="#l1.97"></a><span id="l1.97" class="difflineat">@@ -287,17 +287,17 @@ optgroupObject.prototype.moveUp = functi</span>
<a href="#l1.98"></a><span id="l1.98">   var i = index;</span>
<a href="#l1.99"></a><span id="l1.99">   while (itemArray[--index].level &gt; 1);</span>
<a href="#l1.100"></a><span id="l1.100">   var j = gDialog.nextChild(i);</span>
<a href="#l1.101"></a><span id="l1.101">   // Cut out the element, cut the array in two, then join together</span>
<a href="#l1.102"></a><span id="l1.102">   var movedItems = itemArray.splice(i, j - i);</span>
<a href="#l1.103"></a><span id="l1.103">   var endItems = itemArray.splice(index);</span>
<a href="#l1.104"></a><span id="l1.104">   itemArray = itemArray.concat(movedItems).concat(endItems);</span>
<a href="#l1.105"></a><span id="l1.105">   // Repaint the lot</span>
<a href="#l1.106"></a><span id="l1.106" class="difflineminus">-  treeBoxObject.invalidateRange(index, j);</span>
<a href="#l1.107"></a><span id="l1.107" class="difflineplus">+  theTree.invalidateRange(index, j);</span>
<a href="#l1.108"></a><span id="l1.108">   selectTreeIndex(index, true);</span>
<a href="#l1.109"></a><span id="l1.109"> }</span>
<a href="#l1.110"></a><span id="l1.110"> </span>
<a href="#l1.111"></a><span id="l1.111"> optgroupObject.prototype.canMoveDown = function canMoveDown()</span>
<a href="#l1.112"></a><span id="l1.112"> {</span>
<a href="#l1.113"></a><span id="l1.113">   return gDialog.lastChild() &gt; treeSelection.currentIndex;</span>
<a href="#l1.114"></a><span id="l1.114"> }</span>
<a href="#l1.115"></a><span id="l1.115"> </span>
<a href="#l1.116"></a><span id="l1.116" class="difflineat">@@ -307,30 +307,30 @@ optgroupObject.prototype.moveDown = func</span>
<a href="#l1.117"></a><span id="l1.117">   var index = treeSelection.currentIndex;</span>
<a href="#l1.118"></a><span id="l1.118">   var i = gDialog.nextChild(index);</span>
<a href="#l1.119"></a><span id="l1.119">   var j = gDialog.nextChild(i);</span>
<a href="#l1.120"></a><span id="l1.120">   // Cut out the element, cut the array in two, then join together</span>
<a href="#l1.121"></a><span id="l1.121">   var movedItems = itemArray.splice(i, j - 1);</span>
<a href="#l1.122"></a><span id="l1.122">   var endItems = itemArray.splice(index);</span>
<a href="#l1.123"></a><span id="l1.123">   itemArray = itemArray.concat(movedItems).concat(endItems);</span>
<a href="#l1.124"></a><span id="l1.124">   // Repaint the lot</span>
<a href="#l1.125"></a><span id="l1.125" class="difflineminus">-  treeBoxObject.invalidateRange(index, j);</span>
<a href="#l1.126"></a><span id="l1.126" class="difflineplus">+  theTree.invalidateRange(index, j);</span>
<a href="#l1.127"></a><span id="l1.127">   index += j - i;</span>
<a href="#l1.128"></a><span id="l1.128">   selectTreeIndex(index, true);</span>
<a href="#l1.129"></a><span id="l1.129"> }</span>
<a href="#l1.130"></a><span id="l1.130"> </span>
<a href="#l1.131"></a><span id="l1.131"> optgroupObject.prototype.appendOption = function appendOption(child, parent)</span>
<a href="#l1.132"></a><span id="l1.132"> {</span>
<a href="#l1.133"></a><span id="l1.133">   var index = gDialog.nextChild(parent);</span>
<a href="#l1.134"></a><span id="l1.134">   // XXX need to repaint the lines, tree won't do this</span>
<a href="#l1.135"></a><span id="l1.135" class="difflineminus">-  var primaryCol = treeBoxObject.columns.getPrimaryColumn();</span>
<a href="#l1.136"></a><span id="l1.136" class="difflineminus">-  treeBoxObject.invalidateCell(index - 1, primaryCol);</span>
<a href="#l1.137"></a><span id="l1.137" class="difflineplus">+  var primaryCol = theTree.columns.getPrimaryColumn();</span>
<a href="#l1.138"></a><span id="l1.138" class="difflineplus">+  theTree.invalidateCell(index - 1, primaryCol);</span>
<a href="#l1.139"></a><span id="l1.139">   // insert the wrapped object as the last child</span>
<a href="#l1.140"></a><span id="l1.140">   itemArray.splice(index, 0, new optionObject(child, 2));</span>
<a href="#l1.141"></a><span id="l1.141" class="difflineminus">-  treeBoxObject.rowCountChanged(index, 1);</span>
<a href="#l1.142"></a><span id="l1.142" class="difflineplus">+  theTree.rowCountChanged(index, 1);</span>
<a href="#l1.143"></a><span id="l1.143">   selectTreeIndex(index, false);</span>
<a href="#l1.144"></a><span id="l1.144"> };</span>
<a href="#l1.145"></a><span id="l1.145"> </span>
<a href="#l1.146"></a><span id="l1.146"> // dialog initialization code</span>
<a href="#l1.147"></a><span id="l1.147"> </span>
<a href="#l1.148"></a><span id="l1.148"> function Startup()</span>
<a href="#l1.149"></a><span id="l1.149"> {</span>
<a href="#l1.150"></a><span id="l1.150">   var editor = GetCurrentEditor();</span>
<a href="#l1.151"></a><span id="l1.151" class="difflineat">@@ -427,20 +427,20 @@ function Startup()</span>
<a href="#l1.152"></a><span id="l1.152">         this.element.setAttribute(&quot;tabindex&quot;, gDialog.selectTabIndex.value);</span>
<a href="#l1.153"></a><span id="l1.153">       else</span>
<a href="#l1.154"></a><span id="l1.154">         this.element.removeAttribute(&quot;tabindex&quot;);</span>
<a href="#l1.155"></a><span id="l1.155">     },</span>
<a href="#l1.156"></a><span id="l1.156">     appendOption:     function appendOption(child, parent)</span>
<a href="#l1.157"></a><span id="l1.157">     {</span>
<a href="#l1.158"></a><span id="l1.158">       var index = itemArray.length;</span>
<a href="#l1.159"></a><span id="l1.159">       // XXX need to repaint the lines, tree won't do this</span>
<a href="#l1.160"></a><span id="l1.160" class="difflineminus">-      treeBoxObject.invalidateRange(this.lastChild(), index);</span>
<a href="#l1.161"></a><span id="l1.161" class="difflineplus">+      theTree.invalidateRange(this.lastChild(), index);</span>
<a href="#l1.162"></a><span id="l1.162">       // append the wrapped object</span>
<a href="#l1.163"></a><span id="l1.163">       itemArray.push(new optionObject(child, 1));</span>
<a href="#l1.164"></a><span id="l1.164" class="difflineminus">-      treeBoxObject.rowCountChanged(index, 1);</span>
<a href="#l1.165"></a><span id="l1.165" class="difflineplus">+      theTree.rowCountChanged(index, 1);</span>
<a href="#l1.166"></a><span id="l1.166">       selectTreeIndex(index, false);</span>
<a href="#l1.167"></a><span id="l1.167">     },</span>
<a href="#l1.168"></a><span id="l1.168">     canDestroy:       function canDestroy(prompt)</span>
<a href="#l1.169"></a><span id="l1.169">     {</span>
<a href="#l1.170"></a><span id="l1.170">       return false;</span>
<a href="#l1.171"></a><span id="l1.171">     },</span>
<a href="#l1.172"></a><span id="l1.172">     canMoveDown:      function canMoveDown()</span>
<a href="#l1.173"></a><span id="l1.173">     {</span>
<a href="#l1.174"></a><span id="l1.174" class="difflineat">@@ -476,18 +476,18 @@ function Startup()</span>
<a href="#l1.175"></a><span id="l1.175">         if (grandchild.tagName == &quot;OPTION&quot;)</span>
<a href="#l1.176"></a><span id="l1.176">           itemArray.push(new optionObject(grandchild.cloneNode(true), 2));</span>
<a href="#l1.177"></a><span id="l1.177">     }</span>
<a href="#l1.178"></a><span id="l1.178">   }</span>
<a href="#l1.179"></a><span id="l1.179"> </span>
<a href="#l1.180"></a><span id="l1.180">   UpdateSelectMultiple();</span>
<a href="#l1.181"></a><span id="l1.181"> </span>
<a href="#l1.182"></a><span id="l1.182">   // Define a custom view for the tree</span>
<a href="#l1.183"></a><span id="l1.183" class="difflineminus">-  treeBoxObject = gDialog.tree.treeBoxObject;</span>
<a href="#l1.184"></a><span id="l1.184" class="difflineminus">-  treeBoxObject.view = {</span>
<a href="#l1.185"></a><span id="l1.185" class="difflineplus">+  theTree = gDialog.tree;</span>
<a href="#l1.186"></a><span id="l1.186" class="difflineplus">+  theTree.view = {</span>
<a href="#l1.187"></a><span id="l1.187">     QueryInterface: ChromeUtils.generateQI([&quot;nsITreeView&quot;,</span>
<a href="#l1.188"></a><span id="l1.188">                                             &quot;nsISupportsWeakReference&quot;]),</span>
<a href="#l1.189"></a><span id="l1.189">     // useful for debugging</span>
<a href="#l1.190"></a><span id="l1.190">     get wrappedJSObject() { return this; },</span>
<a href="#l1.191"></a><span id="l1.191">     get rowCount() { return itemArray.length; },</span>
<a href="#l1.192"></a><span id="l1.192">     get selection() { return treeSelection; },</span>
<a href="#l1.193"></a><span id="l1.193">     set selection(selection) { return treeSelection = selection; },</span>
<a href="#l1.194"></a><span id="l1.194">     getRowProperties: function getRowProperties(index) { return &quot;&quot;; },</span>
<a href="#l1.195"></a><span id="l1.195" class="difflineat">@@ -623,20 +623,20 @@ function AddOption()</span>
<a href="#l1.196"></a><span id="l1.196">   SetTextboxFocus(gDialog.optionText);</span>
<a href="#l1.197"></a><span id="l1.197"> }</span>
<a href="#l1.198"></a><span id="l1.198"> </span>
<a href="#l1.199"></a><span id="l1.199"> function AddOptGroup()</span>
<a href="#l1.200"></a><span id="l1.200"> {</span>
<a href="#l1.201"></a><span id="l1.201">   var optgroupElement = GetCurrentEditor().createElementWithDefaults(&quot;optgroup&quot;);</span>
<a href="#l1.202"></a><span id="l1.202">   var index = itemArray.length;</span>
<a href="#l1.203"></a><span id="l1.203">   // XXX need to repaint the lines, tree won't do this</span>
<a href="#l1.204"></a><span id="l1.204" class="difflineminus">-  treeBoxObject.invalidateRange(gDialog.lastChild(), index);</span>
<a href="#l1.205"></a><span id="l1.205" class="difflineplus">+  theTree.invalidateRange(gDialog.lastChild(), index);</span>
<a href="#l1.206"></a><span id="l1.206">   // append the wrapped object</span>
<a href="#l1.207"></a><span id="l1.207">   itemArray.push(new optgroupObject(optgroupElement));</span>
<a href="#l1.208"></a><span id="l1.208" class="difflineminus">-  treeBoxObject.rowCountChanged(index, 1);</span>
<a href="#l1.209"></a><span id="l1.209" class="difflineplus">+  theTree.rowCountChanged(index, 1);</span>
<a href="#l1.210"></a><span id="l1.210">   selectTreeIndex(index, false);</span>
<a href="#l1.211"></a><span id="l1.211">   SetTextboxFocus(gDialog.optgroupLabel);</span>
<a href="#l1.212"></a><span id="l1.212"> }</span>
<a href="#l1.213"></a><span id="l1.213"> </span>
<a href="#l1.214"></a><span id="l1.214"> function RemoveElement()</span>
<a href="#l1.215"></a><span id="l1.215"> {</span>
<a href="#l1.216"></a><span id="l1.216">   if (currentItem.canDestroy(true))</span>
<a href="#l1.217"></a><span id="l1.217">   {</span>
<a href="#l1.218"></a><span id="l1.218" class="difflineat">@@ -646,20 +646,20 @@ function RemoveElement()</span>
<a href="#l1.219"></a><span id="l1.219">     // Perform necessary cleanup and remove the wrapper</span>
<a href="#l1.220"></a><span id="l1.220">     itemArray[index].destroy();</span>
<a href="#l1.221"></a><span id="l1.221">     itemArray.splice(index, 1);</span>
<a href="#l1.222"></a><span id="l1.222">     --index;</span>
<a href="#l1.223"></a><span id="l1.223">     // XXX need to repaint the lines, tree won't do this</span>
<a href="#l1.224"></a><span id="l1.224">     if (level == 1) {</span>
<a href="#l1.225"></a><span id="l1.225">       var last = gDialog.lastChild();</span>
<a href="#l1.226"></a><span id="l1.226">       if (index &gt; last)</span>
<a href="#l1.227"></a><span id="l1.227" class="difflineminus">-        treeBoxObject.invalidateRange(last, index);</span>
<a href="#l1.228"></a><span id="l1.228" class="difflineplus">+        theTree.invalidateRange(last, index);</span>
<a href="#l1.229"></a><span id="l1.229">     }</span>
<a href="#l1.230"></a><span id="l1.230">     selectTreeIndex(index, true);</span>
<a href="#l1.231"></a><span id="l1.231" class="difflineminus">-    treeBoxObject.rowCountChanged(++index, -1);</span>
<a href="#l1.232"></a><span id="l1.232" class="difflineplus">+    theTree.rowCountChanged(++index, -1);</span>
<a href="#l1.233"></a><span id="l1.233">   }</span>
<a href="#l1.234"></a><span id="l1.234"> }</span>
<a href="#l1.235"></a><span id="l1.235"> </span>
<a href="#l1.236"></a><span id="l1.236"> // Event handler</span>
<a href="#l1.237"></a><span id="l1.237"> function onTreeKeyUp(event)</span>
<a href="#l1.238"></a><span id="l1.238"> {</span>
<a href="#l1.239"></a><span id="l1.239">   if (event.keyCode == event.DOM_VK_SPACE)</span>
<a href="#l1.240"></a><span id="l1.240">     currentItem.cycleCell();</span>
<a href="#l1.241"></a><span id="l1.241" class="difflineat">@@ -667,51 +667,51 @@ function onTreeKeyUp(event)</span>
<a href="#l1.242"></a><span id="l1.242"> </span>
<a href="#l1.243"></a><span id="l1.243"> function onNameInput()</span>
<a href="#l1.244"></a><span id="l1.244"> {</span>
<a href="#l1.245"></a><span id="l1.245">   var disabled = !gDialog.selectName.value;</span>
<a href="#l1.246"></a><span id="l1.246">   if (gDialog.accept.disabled != disabled)</span>
<a href="#l1.247"></a><span id="l1.247">     gDialog.accept.disabled = disabled;</span>
<a href="#l1.248"></a><span id="l1.248">   gDialog.element.setAttribute(&quot;name&quot;, gDialog.selectName.value);</span>
<a href="#l1.249"></a><span id="l1.249">   // repaint the tree</span>
<a href="#l1.250"></a><span id="l1.250" class="difflineminus">-  var primaryCol = treeBoxObject.columns.getPrimaryColumn();</span>
<a href="#l1.251"></a><span id="l1.251" class="difflineminus">-  treeBoxObject.invalidateCell(treeSelection.currentIndex, primaryCol);</span>
<a href="#l1.252"></a><span id="l1.252" class="difflineplus">+  var primaryCol = theTree.columns.getPrimaryColumn();</span>
<a href="#l1.253"></a><span id="l1.253" class="difflineplus">+  theTree.invalidateCell(treeSelection.currentIndex, primaryCol);</span>
<a href="#l1.254"></a><span id="l1.254"> }</span>
<a href="#l1.255"></a><span id="l1.255"> </span>
<a href="#l1.256"></a><span id="l1.256"> function onLabelInput()</span>
<a href="#l1.257"></a><span id="l1.257"> {</span>
<a href="#l1.258"></a><span id="l1.258">   currentItem.element.setAttribute(&quot;label&quot;, gDialog.optgroupLabel.value);</span>
<a href="#l1.259"></a><span id="l1.259">   // repaint the tree</span>
<a href="#l1.260"></a><span id="l1.260" class="difflineminus">-  var primaryCol = treeBoxObject.columns.getPrimaryColumn();</span>
<a href="#l1.261"></a><span id="l1.261" class="difflineminus">-  treeBoxObject.invalidateCell(treeSelection.currentIndex, primaryCol);</span>
<a href="#l1.262"></a><span id="l1.262" class="difflineplus">+  var primaryCol = theTree.columns.getPrimaryColumn();</span>
<a href="#l1.263"></a><span id="l1.263" class="difflineplus">+  theTree.invalidateCell(treeSelection.currentIndex, primaryCol);</span>
<a href="#l1.264"></a><span id="l1.264"> }</span>
<a href="#l1.265"></a><span id="l1.265"> </span>
<a href="#l1.266"></a><span id="l1.266"> function onTextInput()</span>
<a href="#l1.267"></a><span id="l1.267"> {</span>
<a href="#l1.268"></a><span id="l1.268">   currentItem.element.text = gDialog.optionText.value;</span>
<a href="#l1.269"></a><span id="l1.269">   // repaint the tree</span>
<a href="#l1.270"></a><span id="l1.270">   if (hasValue) {</span>
<a href="#l1.271"></a><span id="l1.271" class="difflineminus">-    var primaryCol = treeBoxObject.columns.getPrimaryColumn();</span>
<a href="#l1.272"></a><span id="l1.272" class="difflineminus">-    treeBoxObject.invalidateCell(treeSelection.currentIndex, primaryCol);</span>
<a href="#l1.273"></a><span id="l1.273" class="difflineplus">+    var primaryCol = theTree.columns.getPrimaryColumn();</span>
<a href="#l1.274"></a><span id="l1.274" class="difflineplus">+    theTree.invalidateCell(treeSelection.currentIndex, primaryCol);</span>
<a href="#l1.275"></a><span id="l1.275">   }</span>
<a href="#l1.276"></a><span id="l1.276">   else</span>
<a href="#l1.277"></a><span id="l1.277">   {</span>
<a href="#l1.278"></a><span id="l1.278">     gDialog.optionValue.value = gDialog.optionText.value;</span>
<a href="#l1.279"></a><span id="l1.279" class="difflineminus">-    treeBoxObject.invalidateRow(treeSelection.currentIndex);</span>
<a href="#l1.280"></a><span id="l1.280" class="difflineplus">+    theTree.invalidateRow(treeSelection.currentIndex);</span>
<a href="#l1.281"></a><span id="l1.281">   }</span>
<a href="#l1.282"></a><span id="l1.282"> }</span>
<a href="#l1.283"></a><span id="l1.283"> </span>
<a href="#l1.284"></a><span id="l1.284"> function onValueInput()</span>
<a href="#l1.285"></a><span id="l1.285"> {</span>
<a href="#l1.286"></a><span id="l1.286">   gDialog.optionHasValue.checked = hasValue = true;</span>
<a href="#l1.287"></a><span id="l1.287">   oldValue = gDialog.optionValue.value;</span>
<a href="#l1.288"></a><span id="l1.288">   currentItem.element.setAttribute(&quot;value&quot;, oldValue);</span>
<a href="#l1.289"></a><span id="l1.289">   // repaint the tree</span>
<a href="#l1.290"></a><span id="l1.290" class="difflineminus">-  var column = treeBoxObject.columns[&quot;SelectValCol&quot;];</span>
<a href="#l1.291"></a><span id="l1.291" class="difflineminus">-  treeBoxObject.invalidateCell(treeSelection.currentIndex, column);</span>
<a href="#l1.292"></a><span id="l1.292" class="difflineplus">+  var column = theTree.columns[&quot;SelectValCol&quot;];</span>
<a href="#l1.293"></a><span id="l1.293" class="difflineplus">+  theTree.invalidateCell(treeSelection.currentIndex, column);</span>
<a href="#l1.294"></a><span id="l1.294"> }</span>
<a href="#l1.295"></a><span id="l1.295"> </span>
<a href="#l1.296"></a><span id="l1.296"> function onHasValueClick()</span>
<a href="#l1.297"></a><span id="l1.297"> {</span>
<a href="#l1.298"></a><span id="l1.298">   hasValue = gDialog.optionHasValue.checked;</span>
<a href="#l1.299"></a><span id="l1.299">   if (hasValue)</span>
<a href="#l1.300"></a><span id="l1.300">   {</span>
<a href="#l1.301"></a><span id="l1.301">     gDialog.optionValue.value = oldValue;</span>
<a href="#l1.302"></a><span id="l1.302" class="difflineat">@@ -719,26 +719,26 @@ function onHasValueClick()</span>
<a href="#l1.303"></a><span id="l1.303">   }</span>
<a href="#l1.304"></a><span id="l1.304">   else</span>
<a href="#l1.305"></a><span id="l1.305">   {</span>
<a href="#l1.306"></a><span id="l1.306">     oldValue = gDialog.optionValue.value;</span>
<a href="#l1.307"></a><span id="l1.307">     gDialog.optionValue.value = gDialog.optionText.value;</span>
<a href="#l1.308"></a><span id="l1.308">     currentItem.element.removeAttribute(&quot;value&quot;);</span>
<a href="#l1.309"></a><span id="l1.309">   }</span>
<a href="#l1.310"></a><span id="l1.310">   // repaint the tree</span>
<a href="#l1.311"></a><span id="l1.311" class="difflineminus">-  var column = treeBoxObject.columns[&quot;SelectValCol&quot;];</span>
<a href="#l1.312"></a><span id="l1.312" class="difflineminus">-  treeBoxObject.invalidateCell(treeSelection.currentIndex, column);</span>
<a href="#l1.313"></a><span id="l1.313" class="difflineplus">+  var column = theTree.columns[&quot;SelectValCol&quot;];</span>
<a href="#l1.314"></a><span id="l1.314" class="difflineplus">+  theTree.invalidateCell(treeSelection.currentIndex, column);</span>
<a href="#l1.315"></a><span id="l1.315"> }</span>
<a href="#l1.316"></a><span id="l1.316"> </span>
<a href="#l1.317"></a><span id="l1.317"> function onSelectMultipleClick()</span>
<a href="#l1.318"></a><span id="l1.318"> {</span>
<a href="#l1.319"></a><span id="l1.319">   // Recalculate the unique selected option if we need it and have lost it</span>
<a href="#l1.320"></a><span id="l1.320">   if (!gDialog.selectMultiple.checked &amp;&amp; selectedOptionCount == 1 &amp;&amp; !selectedOption)</span>
<a href="#l1.321"></a><span id="l1.321">     for (var i = 1; !(selectedOption = itemArray[i].element).hasAttribute(&quot;selected&quot;); i++);</span>
<a href="#l1.322"></a><span id="l1.322"> }</span>
<a href="#l1.323"></a><span id="l1.323"> </span>
<a href="#l1.324"></a><span id="l1.324"> function selectTreeIndex(index, focus)</span>
<a href="#l1.325"></a><span id="l1.325"> {</span>
<a href="#l1.326"></a><span id="l1.326">   treeSelection.select(index);</span>
<a href="#l1.327"></a><span id="l1.327" class="difflineminus">-  treeBoxObject.ensureRowIsVisible(index);</span>
<a href="#l1.328"></a><span id="l1.328" class="difflineplus">+  theTree.ensureRowIsVisible(index);</span>
<a href="#l1.329"></a><span id="l1.329">   if (focus)</span>
<a href="#l1.330"></a><span id="l1.330">     gDialog.tree.focus();</span>
<a href="#l1.331"></a><span id="l1.331"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/editor/ui/dialogs/content/EditorSaveAsCharset.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/editor/ui/dialogs/content/EditorSaveAsCharset.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -99,17 +99,17 @@ function Startup()</span>
<a href="#l2.4"></a><span id="l2.4"> function InitDialog()</span>
<a href="#l2.5"></a><span id="l2.5"> {</span>
<a href="#l2.6"></a><span id="l2.6">   gDialog.TitleInput.value = GetDocumentTitle();</span>
<a href="#l2.7"></a><span id="l2.7"> </span>
<a href="#l2.8"></a><span id="l2.8">   var tree = gDialog.charsetTree;</span>
<a href="#l2.9"></a><span id="l2.9">   var index = gCharsetInfo.map(info =&gt; info.value).indexOf(gCharset);</span>
<a href="#l2.10"></a><span id="l2.10">   if (index &gt;= 0) {</span>
<a href="#l2.11"></a><span id="l2.11">     tree.view.selection.select(index);</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-    tree.treeBoxObject.ensureRowIsVisible(index);</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+    tree.ensureRowIsVisible(index);</span>
<a href="#l2.14"></a><span id="l2.14">   }</span>
<a href="#l2.15"></a><span id="l2.15"> }</span>
<a href="#l2.16"></a><span id="l2.16"> </span>
<a href="#l2.17"></a><span id="l2.17"> </span>
<a href="#l2.18"></a><span id="l2.18"> function onAccept()</span>
<a href="#l2.19"></a><span id="l2.19"> {</span>
<a href="#l2.20"></a><span id="l2.20">   var editor = GetCurrentEditor();</span>
<a href="#l2.21"></a><span id="l2.21">   editor.beginTransaction();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/base/content/SearchDialog.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/base/content/SearchDialog.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -228,17 +228,16 @@ function searchOnLoad() {</span>
<a href="#l3.4"></a><span id="l3.4">   gSearchStopButton.setAttribute(&quot;label&quot;, gSearchBundle.getString(&quot;labelForSearchButton&quot;));</span>
<a href="#l3.5"></a><span id="l3.5">   gSearchStopButton.setAttribute(&quot;accesskey&quot;, gSearchBundle.getString(&quot;labelForSearchButton.accesskey&quot;));</span>
<a href="#l3.6"></a><span id="l3.6"> </span>
<a href="#l3.7"></a><span id="l3.7">   gMessageDisplay = new NeverVisibleMessageDisplayWidget();</span>
<a href="#l3.8"></a><span id="l3.8">   gFolderDisplay = new SearchFolderDisplayWidget(gMessageDisplay);</span>
<a href="#l3.9"></a><span id="l3.9">   gFolderDisplay.messenger = messenger;</span>
<a href="#l3.10"></a><span id="l3.10">   gFolderDisplay.msgWindow = msgWindow;</span>
<a href="#l3.11"></a><span id="l3.11">   gFolderDisplay.tree = document.getElementById(&quot;threadTree&quot;);</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-  gFolderDisplay.treeBox = gFolderDisplay.tree.boxObject;</span>
<a href="#l3.13"></a><span id="l3.13">   gFolderDisplay.view.openSearchView();</span>
<a href="#l3.14"></a><span id="l3.14">   gFolderDisplay.makeActive();</span>
<a href="#l3.15"></a><span id="l3.15"> </span>
<a href="#l3.16"></a><span id="l3.16">   gFolderDisplay.setColumnStates({</span>
<a href="#l3.17"></a><span id="l3.17">     subjectCol: { visible: true },</span>
<a href="#l3.18"></a><span id="l3.18">     correspondentCol: { visible: Services.prefs.getBoolPref(&quot;mail.threadpane.use_correspondents&quot;) },</span>
<a href="#l3.19"></a><span id="l3.19">     senderCol: { visible: !Services.prefs.getBoolPref(&quot;mail.threadpane.use_correspondents&quot;) },</span>
<a href="#l3.20"></a><span id="l3.20">     dateCol: { visible: true },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/base/content/folderDisplay.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/base/content/folderDisplay.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -106,22 +106,16 @@ function FolderDisplayWidget(aTabInfo, a</span>
<a href="#l4.4"></a><span id="l4.4">   this.messageDisplay = aMessageDisplayWidget;</span>
<a href="#l4.5"></a><span id="l4.5">   this.messageDisplay.folderDisplay = this;</span>
<a href="#l4.6"></a><span id="l4.6"> </span>
<a href="#l4.7"></a><span id="l4.7">   /**</span>
<a href="#l4.8"></a><span id="l4.8">    * The XUL tree node, as retrieved by getDocumentElementById.  The caller is</span>
<a href="#l4.9"></a><span id="l4.9">    *  responsible for setting this.</span>
<a href="#l4.10"></a><span id="l4.10">    */</span>
<a href="#l4.11"></a><span id="l4.11">   this.tree = null;</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-  /**</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-   * The nsITreeBoxObject on the XUL tree node, accessible from this.tree as</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-   *  this.tree.boxObject and QueryInterfaced as such.  The caller is</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineminus">-   *  responsible for setting this.</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineminus">-   */</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineminus">-  this.treeBox = null;</span>
<a href="#l4.18"></a><span id="l4.18"> </span>
<a href="#l4.19"></a><span id="l4.19">   /**</span>
<a href="#l4.20"></a><span id="l4.20">    * The nsIMsgWindow corresponding to the window that holds us.  There is only</span>
<a href="#l4.21"></a><span id="l4.21">    *  one of these per tab.  The caller is responsible for setting this.</span>
<a href="#l4.22"></a><span id="l4.22">    */</span>
<a href="#l4.23"></a><span id="l4.23">   this.msgWindow = null;</span>
<a href="#l4.24"></a><span id="l4.24">   /**</span>
<a href="#l4.25"></a><span id="l4.25">    * The nsIMessenger instance that corresponds to our tab/window.  We do not</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineat">@@ -172,29 +166,29 @@ function FolderDisplayWidget(aTabInfo, a</span>
<a href="#l4.27"></a><span id="l4.27"> </span>
<a href="#l4.28"></a><span id="l4.28">   // We care about onselect events, so add a listener for that.</span>
<a href="#l4.29"></a><span id="l4.29">   let self = this;</span>
<a href="#l4.30"></a><span id="l4.30">   domNode.addEventListener(&quot;select&quot;, function() {</span>
<a href="#l4.31"></a><span id="l4.31">     self.view.dbView.selectionChanged();</span>
<a href="#l4.32"></a><span id="l4.32">   });</span>
<a href="#l4.33"></a><span id="l4.33"> </span>
<a href="#l4.34"></a><span id="l4.34">   /**</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineminus">-   * Create a fake tree box object for if/when this folder is in the background.</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+   * Create a fake tree object for if/when this folder is in the background.</span>
<a href="#l4.37"></a><span id="l4.37">    * We need to give it a DOM object to send events to, including the onselect</span>
<a href="#l4.38"></a><span id="l4.38">    * event we care about and for which we added a handler above, and all the</span>
<a href="#l4.39"></a><span id="l4.39">    * other events we don't care about.</span>
<a href="#l4.40"></a><span id="l4.40">    */</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineminus">-  this._fakeTreeBox = new FakeTreeBoxObject(domNode);</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+  this._fakeTree = new FakeTree(domNode);</span>
<a href="#l4.43"></a><span id="l4.43"> </span>
<a href="#l4.44"></a><span id="l4.44">   /**</span>
<a href="#l4.45"></a><span id="l4.45">    * Create a fake tree selection for cases where we have opened a background</span>
<a href="#l4.46"></a><span id="l4.46">    * tab. We'll get rid of this as soon as we've switched to the tab for the</span>
<a href="#l4.47"></a><span id="l4.47">    * first time, and have a real tree selection.</span>
<a href="#l4.48"></a><span id="l4.48">    */</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineminus">-  this._fakeTreeSelection = new JSTreeSelection(this._fakeTreeBox);</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineplus">+  this._fakeTreeSelection = new JSTreeSelection(this._fakeTree);</span>
<a href="#l4.51"></a><span id="l4.51"> </span>
<a href="#l4.52"></a><span id="l4.52">   this._mostRecentSelectionCounts = [];</span>
<a href="#l4.53"></a><span id="l4.53">   this._mostRecentCurrentIndices = [];</span>
<a href="#l4.54"></a><span id="l4.54"> }</span>
<a href="#l4.55"></a><span id="l4.55"> FolderDisplayWidget.prototype = {</span>
<a href="#l4.56"></a><span id="l4.56">   /**</span>
<a href="#l4.57"></a><span id="l4.57">    * @return the currently displayed folder.  This is just proxied from the</span>
<a href="#l4.58"></a><span id="l4.58">    *     view wrapper.</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineat">@@ -827,17 +821,17 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l4.60"></a><span id="l4.60">     //  anything else because closing the view could theoretically propagate</span>
<a href="#l4.61"></a><span id="l4.61">     //  down to the message display and we don't want it doing anything it</span>
<a href="#l4.62"></a><span id="l4.62">     //  doesn't have to do.</span>
<a href="#l4.63"></a><span id="l4.63">     this.messageDisplay._close();</span>
<a href="#l4.64"></a><span id="l4.64"> </span>
<a href="#l4.65"></a><span id="l4.65">     this.view.close();</span>
<a href="#l4.66"></a><span id="l4.66">     this.messenger.setWindow(null, null);</span>
<a href="#l4.67"></a><span id="l4.67">     this.messenger = null;</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineminus">-    this._fakeTreeBox = null;</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineplus">+    this._fakeTree = null;</span>
<a href="#l4.70"></a><span id="l4.70">     this._fakeTreeSelection = null;</span>
<a href="#l4.71"></a><span id="l4.71">   },</span>
<a href="#l4.72"></a><span id="l4.72">   // @}</span>
<a href="#l4.73"></a><span id="l4.73"> </span>
<a href="#l4.74"></a><span id="l4.74">   /*   ===============================   */</span>
<a href="#l4.75"></a><span id="l4.75">   /* ===== IDBViewWrapper Listener ===== */</span>
<a href="#l4.76"></a><span id="l4.76">   /*   ===============================   */</span>
<a href="#l4.77"></a><span id="l4.77"> </span>
<a href="#l4.78"></a><span id="l4.78" class="difflineat">@@ -939,18 +933,18 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l4.79"></a><span id="l4.79">   _activeCreatedView() {</span>
<a href="#l4.80"></a><span id="l4.80">     gDBView = this.view.dbView;</span>
<a href="#l4.81"></a><span id="l4.81"> </span>
<a href="#l4.82"></a><span id="l4.82">     // A change in view may result in changes to sorts, the view menu, etc.</span>
<a href="#l4.83"></a><span id="l4.83">     // Do this before we 'reroot' the dbview.</span>
<a href="#l4.84"></a><span id="l4.84">     this._updateThreadDisplay();</span>
<a href="#l4.85"></a><span id="l4.85"> </span>
<a href="#l4.86"></a><span id="l4.86">     // this creates a new selection object for the view.</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineminus">-    if (this.treeBox)</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineminus">-      this.treeBox.view = this.view.dbView;</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineplus">+    if (this.tree)</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineplus">+      this.tree.view = this.view.dbView;</span>
<a href="#l4.91"></a><span id="l4.91"> </span>
<a href="#l4.92"></a><span id="l4.92">     FolderDisplayListenerManager._fireListeners(&quot;onActiveCreatedView&quot;,</span>
<a href="#l4.93"></a><span id="l4.93">                                                 [this]);</span>
<a href="#l4.94"></a><span id="l4.94"> </span>
<a href="#l4.95"></a><span id="l4.95">     // The data payload used to be viewType + &quot;:&quot; + viewFlags.  We no longer</span>
<a href="#l4.96"></a><span id="l4.96">     //  do this because we already have the implied contract that gDBView is</span>
<a href="#l4.97"></a><span id="l4.97">     //  valid at the time we generate the notification.  In such a case, you</span>
<a href="#l4.98"></a><span id="l4.98">     //  can easily get that information from the gDBView.  (The documentation</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineat">@@ -1631,46 +1625,46 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l4.100"></a><span id="l4.100">       // Make sure said thread pane is visible.  If we do this after we re-root</span>
<a href="#l4.101"></a><span id="l4.101">       //  the tree, the thread pane may not actually replace the account central</span>
<a href="#l4.102"></a><span id="l4.102">       //  pane.  Concerning...</span>
<a href="#l4.103"></a><span id="l4.103">       this._showThreadPane();</span>
<a href="#l4.104"></a><span id="l4.104"> </span>
<a href="#l4.105"></a><span id="l4.105">       // some things only need to happen if we are transitioning from inactive</span>
<a href="#l4.106"></a><span id="l4.106">       //  to active</span>
<a href="#l4.107"></a><span id="l4.107">       if (wasInactive) {</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineminus">-        if (this.treeBox) {</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineplus">+        if (this.tree) {</span>
<a href="#l4.110"></a><span id="l4.110">           // We might have assigned our JS tree selection to</span>
<a href="#l4.111"></a><span id="l4.111" class="difflineminus">-          //  this.view.dbView.selection back in _hookUpFakeTreeBox. If we've</span>
<a href="#l4.112"></a><span id="l4.112" class="difflineplus">+          //  this.view.dbView.selection back in _hookUpFakeTree. If we've</span>
<a href="#l4.113"></a><span id="l4.113">           //  done so, null the selection out so that the line after this</span>
<a href="#l4.114"></a><span id="l4.114">           //  causes a real selection to be created.</span>
<a href="#l4.115"></a><span id="l4.115">           // If we haven't done so, we're fine as selection would be null here</span>
<a href="#l4.116"></a><span id="l4.116">           //  anyway. (The fake tree selection should persist only till the</span>
<a href="#l4.117"></a><span id="l4.117">           //  first time the tab is switched to.)</span>
<a href="#l4.118"></a><span id="l4.118">           if (fakeTreeSelection)</span>
<a href="#l4.119"></a><span id="l4.119">             this.view.dbView.selection = null;</span>
<a href="#l4.120"></a><span id="l4.120"> </span>
<a href="#l4.121"></a><span id="l4.121">           // Setting the 'view' attribute on treeBox results in the following</span>
<a href="#l4.122"></a><span id="l4.122">           //  effective calls, noting that in makeInactive we made sure to null</span>
<a href="#l4.123"></a><span id="l4.123">           //  out its view so that it won't try and clean up any views or their</span>
<a href="#l4.124"></a><span id="l4.124">           //  selections.  (The actual actions happen in</span>
<a href="#l4.125"></a><span id="l4.125">           //  nsTreeBodyFrame::SetView)</span>
<a href="#l4.126"></a><span id="l4.126" class="difflineminus">-          // - this.view.dbView.selection.tree = this.treeBox</span>
<a href="#l4.127"></a><span id="l4.127" class="difflineminus">-          // - this.view.dbView.setTree(this.treeBox)</span>
<a href="#l4.128"></a><span id="l4.128" class="difflineminus">-          // - this.treeBox.view = this.view.dbView (in</span>
<a href="#l4.129"></a><span id="l4.129" class="difflineplus">+          // - this.view.dbView.selection.tree = this.tree</span>
<a href="#l4.130"></a><span id="l4.130" class="difflineplus">+          // - this.view.dbView.setTree(this.tree)</span>
<a href="#l4.131"></a><span id="l4.131" class="difflineplus">+          // - this.tree.view = this.view.dbView (in</span>
<a href="#l4.132"></a><span id="l4.132">           //   nsTreeBodyObject::SetView)</span>
<a href="#l4.133"></a><span id="l4.133" class="difflineminus">-          this.treeBox.view = this.view.dbView;</span>
<a href="#l4.134"></a><span id="l4.134" class="difflineplus">+          this.tree.view = this.view.dbView;</span>
<a href="#l4.135"></a><span id="l4.135"> </span>
<a href="#l4.136"></a><span id="l4.136">           if (fakeTreeSelection) {</span>
<a href="#l4.137"></a><span id="l4.137">             fakeTreeSelection.duplicateSelection(this.view.dbView.selection);</span>
<a href="#l4.138"></a><span id="l4.138">             // Since duplicateSelection will fire a selectionChanged event,</span>
<a href="#l4.139"></a><span id="l4.139">             // which will try to reload the message, we shouldn't do the same.</span>
<a href="#l4.140"></a><span id="l4.140">             dontReloadMessage = true;</span>
<a href="#l4.141"></a><span id="l4.141">           }</span>
<a href="#l4.142"></a><span id="l4.142">           if (this._savedFirstVisibleRow != null)</span>
<a href="#l4.143"></a><span id="l4.143" class="difflineminus">-            this.treeBox.scrollToRow(this._savedFirstVisibleRow);</span>
<a href="#l4.144"></a><span id="l4.144" class="difflineplus">+            this.tree.scrollToRow(this._savedFirstVisibleRow);</span>
<a href="#l4.145"></a><span id="l4.145">         }</span>
<a href="#l4.146"></a><span id="l4.146">       }</span>
<a href="#l4.147"></a><span id="l4.147"> </span>
<a href="#l4.148"></a><span id="l4.148">       // Always restore the column state if we have persisted state.  We restore</span>
<a href="#l4.149"></a><span id="l4.149">       //  state on folder entry, in which case we were probably not inactive.</span>
<a href="#l4.150"></a><span id="l4.150">       this._restoreColumnStates();</span>
<a href="#l4.151"></a><span id="l4.151"> </span>
<a href="#l4.152"></a><span id="l4.152">       // the tab mode knows whether we are folder or message display, which</span>
<a href="#l4.153"></a><span id="l4.153" class="difflineat">@@ -1733,59 +1727,59 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l4.154"></a><span id="l4.154">     this._active = false;</span>
<a href="#l4.155"></a><span id="l4.155"> </span>
<a href="#l4.156"></a><span id="l4.156">     // - (everything after this point doesn't care that we are marked inactive)</span>
<a href="#l4.157"></a><span id="l4.157">     // save the folder pane's state always</span>
<a href="#l4.158"></a><span id="l4.158">     this._folderPaneVisible =</span>
<a href="#l4.159"></a><span id="l4.159">       !document.getElementById(&quot;folderPaneBox&quot;).collapsed;</span>
<a href="#l4.160"></a><span id="l4.160"> </span>
<a href="#l4.161"></a><span id="l4.161">     if (this.view.dbView) {</span>
<a href="#l4.162"></a><span id="l4.162" class="difflineminus">-      if (this.treeBox)</span>
<a href="#l4.163"></a><span id="l4.163" class="difflineminus">-        this._savedFirstVisibleRow = this.treeBox.getFirstVisibleRow();</span>
<a href="#l4.164"></a><span id="l4.164" class="difflineplus">+      if (this.tree)</span>
<a href="#l4.165"></a><span id="l4.165" class="difflineplus">+        this._savedFirstVisibleRow = this.tree.getFirstVisibleRow();</span>
<a href="#l4.166"></a><span id="l4.166"> </span>
<a href="#l4.167"></a><span id="l4.167">       // save the message pane's state only when it is potentially visible</span>
<a href="#l4.168"></a><span id="l4.168">       this.messagePaneCollapsed =</span>
<a href="#l4.169"></a><span id="l4.169">         document.getElementById(&quot;messagepaneboxwrapper&quot;).collapsed;</span>
<a href="#l4.170"></a><span id="l4.170"> </span>
<a href="#l4.171"></a><span id="l4.171" class="difflineminus">-      this.hookUpFakeTreeBox(true);</span>
<a href="#l4.172"></a><span id="l4.172" class="difflineplus">+      this.hookUpFakeTree(true);</span>
<a href="#l4.173"></a><span id="l4.173">     }</span>
<a href="#l4.174"></a><span id="l4.174"> </span>
<a href="#l4.175"></a><span id="l4.175">     this.messageDisplay.makeInactive();</span>
<a href="#l4.176"></a><span id="l4.176">   },</span>
<a href="#l4.177"></a><span id="l4.177">   // @}</span>
<a href="#l4.178"></a><span id="l4.178"> </span>
<a href="#l4.179"></a><span id="l4.179">   /**</span>
<a href="#l4.180"></a><span id="l4.180">    * Called when we want to &quot;disable&quot; the real treeBox for a while and hook up</span>
<a href="#l4.181"></a><span id="l4.181">    * the fake tree box to the db view. This also takes care of our</span>
<a href="#l4.182"></a><span id="l4.182">    * treeSelection object.</span>
<a href="#l4.183"></a><span id="l4.183">    *</span>
<a href="#l4.184"></a><span id="l4.184">    * @param aNullRealTreeBoxView true if we want to null out the real tree box.</span>
<a href="#l4.185"></a><span id="l4.185">    *          We don't want to null out the view if we're opening a background</span>
<a href="#l4.186"></a><span id="l4.186">    *          tab, for example.</span>
<a href="#l4.187"></a><span id="l4.187">    * @private</span>
<a href="#l4.188"></a><span id="l4.188">    */</span>
<a href="#l4.189"></a><span id="l4.189" class="difflineminus">-  hookUpFakeTreeBox(aNullRealTreeBoxView) {</span>
<a href="#l4.190"></a><span id="l4.190" class="difflineplus">+  hookUpFakeTree(aNullRealTreeBoxView) {</span>
<a href="#l4.191"></a><span id="l4.191">     // save off the tree selection object.  the nsTreeBodyFrame will make the</span>
<a href="#l4.192"></a><span id="l4.192">     //  view forget about it when our view is removed, so it's up to us to</span>
<a href="#l4.193"></a><span id="l4.193">     //  save it.</span>
<a href="#l4.194"></a><span id="l4.194">     // We use this.treeSelection instead of this.view.dbView.selection here,</span>
<a href="#l4.195"></a><span id="l4.195">     //  so that we get the fake tree selection if we have it.</span>
<a href="#l4.196"></a><span id="l4.196">     let treeSelection = this.treeSelection;</span>
<a href="#l4.197"></a><span id="l4.197">     // if we want to, make the tree forget about the view right now so we can</span>
<a href="#l4.198"></a><span id="l4.198">     //  tell the db view about its selection object so it can try and keep it</span>
<a href="#l4.199"></a><span id="l4.199">     //  up-to-date even while hidden in the background</span>
<a href="#l4.200"></a><span id="l4.200" class="difflineminus">-    if (aNullRealTreeBoxView &amp;&amp; this.treeBox)</span>
<a href="#l4.201"></a><span id="l4.201" class="difflineminus">-      this.treeBox.view = null;</span>
<a href="#l4.202"></a><span id="l4.202" class="difflineplus">+    if (aNullRealTreeBoxView &amp;&amp; this.tree)</span>
<a href="#l4.203"></a><span id="l4.203" class="difflineplus">+      this.tree.view = null;</span>
<a href="#l4.204"></a><span id="l4.204">     // (and tell the db view about its selection again...)</span>
<a href="#l4.205"></a><span id="l4.205">     this.view.dbView.selection = treeSelection;</span>
<a href="#l4.206"></a><span id="l4.206"> </span>
<a href="#l4.207"></a><span id="l4.207">     // hook the dbview up to the fake tree box</span>
<a href="#l4.208"></a><span id="l4.208" class="difflineminus">-    this._fakeTreeBox.view = this.view.dbView;</span>
<a href="#l4.209"></a><span id="l4.209" class="difflineminus">-    this.view.dbView.setTree(this._fakeTreeBox);</span>
<a href="#l4.210"></a><span id="l4.210" class="difflineminus">-    treeSelection.tree = this._fakeTreeBox;</span>
<a href="#l4.211"></a><span id="l4.211" class="difflineplus">+    this._fakeTree.view = this.view.dbView;</span>
<a href="#l4.212"></a><span id="l4.212" class="difflineplus">+    this.view.dbView.setTree(this._fakeTree);</span>
<a href="#l4.213"></a><span id="l4.213" class="difflineplus">+    treeSelection.tree = this._fakeTree;</span>
<a href="#l4.214"></a><span id="l4.214">   },</span>
<a href="#l4.215"></a><span id="l4.215"> </span>
<a href="#l4.216"></a><span id="l4.216">   /**</span>
<a href="#l4.217"></a><span id="l4.217">    * @name Command Support</span>
<a href="#l4.218"></a><span id="l4.218">    */</span>
<a href="#l4.219"></a><span id="l4.219">   // @{</span>
<a href="#l4.220"></a><span id="l4.220"> </span>
<a href="#l4.221"></a><span id="l4.221">   /**</span>
<a href="#l4.222"></a><span id="l4.222" class="difflineat">@@ -2400,25 +2394,25 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l4.223"></a><span id="l4.223">    * Minimum number of lines to display between the 'focused' message and the</span>
<a href="#l4.224"></a><span id="l4.224">    *  top / bottom of the thread pane.</span>
<a href="#l4.225"></a><span id="l4.225">    */</span>
<a href="#l4.226"></a><span id="l4.226">   get visibleRowPadding() {</span>
<a href="#l4.227"></a><span id="l4.227">     let topPadding, bottomPadding;</span>
<a href="#l4.228"></a><span id="l4.228"> </span>
<a href="#l4.229"></a><span id="l4.229">     // If we can get the height of the folder pane, treat the values as</span>
<a href="#l4.230"></a><span id="l4.230">     //  percentages of that.</span>
<a href="#l4.231"></a><span id="l4.231" class="difflineminus">-    if (this.treeBox) {</span>
<a href="#l4.232"></a><span id="l4.232" class="difflineplus">+    if (this.tree) {</span>
<a href="#l4.233"></a><span id="l4.233">       let topPercentPadding = Services.prefs.getIntPref(</span>
<a href="#l4.234"></a><span id="l4.234">                               &quot;mail.threadpane.padding.top_percent&quot;);</span>
<a href="#l4.235"></a><span id="l4.235">       let bottomPercentPadding = Services.prefs.getIntPref(</span>
<a href="#l4.236"></a><span id="l4.236">                                  &quot;mail.threadpane.padding.bottom_percent&quot;);</span>
<a href="#l4.237"></a><span id="l4.237"> </span>
<a href="#l4.238"></a><span id="l4.238">       // Assume the bottom row is half-visible and should generally be ignored.</span>
<a href="#l4.239"></a><span id="l4.239">       // (We could actually do the legwork to see if there is a partial one...)</span>
<a href="#l4.240"></a><span id="l4.240" class="difflineminus">-      let paneHeight = this.treeBox.getPageLength() - 1;</span>
<a href="#l4.241"></a><span id="l4.241" class="difflineplus">+      let paneHeight = this.tree.getPageLength() - 1;</span>
<a href="#l4.242"></a><span id="l4.242"> </span>
<a href="#l4.243"></a><span id="l4.243">       // Convert from percentages to absolute row counts.</span>
<a href="#l4.244"></a><span id="l4.244">       topPadding = Math.ceil((topPercentPadding / 100) * paneHeight);</span>
<a href="#l4.245"></a><span id="l4.245">       bottomPadding = Math.ceil((bottomPercentPadding / 100) * paneHeight);</span>
<a href="#l4.246"></a><span id="l4.246"> </span>
<a href="#l4.247"></a><span id="l4.247">       // We need one visible row not counted in either padding, for the actual</span>
<a href="#l4.248"></a><span id="l4.248">       //  target message. Also helps correct for rounding errors.</span>
<a href="#l4.249"></a><span id="l4.249">       if (topPadding + bottomPadding &gt; paneHeight) {</span>
<a href="#l4.250"></a><span id="l4.250" class="difflineat">@@ -2456,46 +2450,46 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l4.251"></a><span id="l4.251">     //  change logic gets to run to completion before we run ourselves.</span>
<a href="#l4.252"></a><span id="l4.252">     if (!aBounced) {</span>
<a href="#l4.253"></a><span id="l4.253">       let dis = this;</span>
<a href="#l4.254"></a><span id="l4.254">       window.setTimeout(function() {</span>
<a href="#l4.255"></a><span id="l4.255">           dis.ensureRowIsVisible(aViewIndex, true);</span>
<a href="#l4.256"></a><span id="l4.256">         }, 0);</span>
<a href="#l4.257"></a><span id="l4.257">     }</span>
<a href="#l4.258"></a><span id="l4.258"> </span>
<a href="#l4.259"></a><span id="l4.259" class="difflineminus">-    let treeBox = this.treeBox;</span>
<a href="#l4.260"></a><span id="l4.260" class="difflineminus">-    if (!treeBox || !treeBox.view)</span>
<a href="#l4.261"></a><span id="l4.261" class="difflineplus">+    let tree = this.tree;</span>
<a href="#l4.262"></a><span id="l4.262" class="difflineplus">+    if (!tree || !tree.view)</span>
<a href="#l4.263"></a><span id="l4.263">       return;</span>
<a href="#l4.264"></a><span id="l4.264"> </span>
<a href="#l4.265"></a><span id="l4.265">     // try and trigger a reflow...</span>
<a href="#l4.266"></a><span id="l4.266" class="difflineminus">-    treeBox.height;</span>
<a href="#l4.267"></a><span id="l4.267" class="difflineplus">+    tree.height;</span>
<a href="#l4.268"></a><span id="l4.268"> </span>
<a href="#l4.269"></a><span id="l4.269" class="difflineminus">-    let maxIndex = treeBox.view.rowCount - 1;</span>
<a href="#l4.270"></a><span id="l4.270" class="difflineplus">+    let maxIndex = tree.view.rowCount - 1;</span>
<a href="#l4.271"></a><span id="l4.271"> </span>
<a href="#l4.272"></a><span id="l4.272" class="difflineminus">-    let first = treeBox.getFirstVisibleRow();</span>
<a href="#l4.273"></a><span id="l4.273" class="difflineplus">+    let first = tree.getFirstVisibleRow();</span>
<a href="#l4.274"></a><span id="l4.274">     // Assume the bottom row is half-visible and should generally be ignored.</span>
<a href="#l4.275"></a><span id="l4.275">     // (We could actually do the legwork to see if there is a partial one...)</span>
<a href="#l4.276"></a><span id="l4.276">     const halfVisible = 1;</span>
<a href="#l4.277"></a><span id="l4.277" class="difflineminus">-    let last  = treeBox.getLastVisibleRow() - halfVisible;</span>
<a href="#l4.278"></a><span id="l4.278" class="difflineminus">-    let span = treeBox.getPageLength() - halfVisible;</span>
<a href="#l4.279"></a><span id="l4.279" class="difflineplus">+    let last  = tree.getLastVisibleRow() - halfVisible;</span>
<a href="#l4.280"></a><span id="l4.280" class="difflineplus">+    let span = tree.getPageLength() - halfVisible;</span>
<a href="#l4.281"></a><span id="l4.281">     let [topPadding, bottomPadding] = this.visibleRowPadding;</span>
<a href="#l4.282"></a><span id="l4.282"> </span>
<a href="#l4.283"></a><span id="l4.283">     let target;</span>
<a href="#l4.284"></a><span id="l4.284">     // If the index is after the last visible guy (with padding), move down</span>
<a href="#l4.285"></a><span id="l4.285">     //  so that the target index is padded in 1 from the bottom.</span>
<a href="#l4.286"></a><span id="l4.286">     if (aViewIndex &gt;= (last - bottomPadding))</span>
<a href="#l4.287"></a><span id="l4.287">       target = Math.min(maxIndex, (aViewIndex + bottomPadding)) - span;</span>
<a href="#l4.288"></a><span id="l4.288">     // If the index is before the first visible guy (with padding), move up</span>
<a href="#l4.289"></a><span id="l4.289">     else if (aViewIndex &lt;= (first + topPadding))  // move up</span>
<a href="#l4.290"></a><span id="l4.290">       target = Math.max(0, (aViewIndex - topPadding));</span>
<a href="#l4.291"></a><span id="l4.291">     else // it is already visible</span>
<a href="#l4.292"></a><span id="l4.292">       return;</span>
<a href="#l4.293"></a><span id="l4.293"> </span>
<a href="#l4.294"></a><span id="l4.294">     // this sets the first visible row</span>
<a href="#l4.295"></a><span id="l4.295" class="difflineminus">-    treeBox.scrollToRow(target);</span>
<a href="#l4.296"></a><span id="l4.296" class="difflineplus">+    tree.scrollToRow(target);</span>
<a href="#l4.297"></a><span id="l4.297">   },</span>
<a href="#l4.298"></a><span id="l4.298"> </span>
<a href="#l4.299"></a><span id="l4.299">   /**</span>
<a href="#l4.300"></a><span id="l4.300">    * Ensure that the given range of rows is maximally visible in the thread</span>
<a href="#l4.301"></a><span id="l4.301">    *  pane.  If the range is larger than the number of rows that can be</span>
<a href="#l4.302"></a><span id="l4.302">    *  displayed in the thread pane, we bias towards showing the min row (with</span>
<a href="#l4.303"></a><span id="l4.303">    *  padding).</span>
<a href="#l4.304"></a><span id="l4.304">    *</span>
<a href="#l4.305"></a><span id="l4.305" class="difflineat">@@ -2512,23 +2506,23 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l4.306"></a><span id="l4.306">     //  change logic gets to run to completion before we run ourselves.</span>
<a href="#l4.307"></a><span id="l4.307">     if (!aBounced) {</span>
<a href="#l4.308"></a><span id="l4.308">       let dis = this;</span>
<a href="#l4.309"></a><span id="l4.309">       window.setTimeout(function() {</span>
<a href="#l4.310"></a><span id="l4.310">           dis.ensureRowRangeIsVisible(aMinRow, aMaxRow, true);</span>
<a href="#l4.311"></a><span id="l4.311">         }, 0);</span>
<a href="#l4.312"></a><span id="l4.312">     }</span>
<a href="#l4.313"></a><span id="l4.313"> </span>
<a href="#l4.314"></a><span id="l4.314" class="difflineminus">-    let treeBox = this.treeBox;</span>
<a href="#l4.315"></a><span id="l4.315" class="difflineminus">-    if (!treeBox)</span>
<a href="#l4.316"></a><span id="l4.316" class="difflineplus">+    let tree = this.tree;</span>
<a href="#l4.317"></a><span id="l4.317" class="difflineplus">+    if (!tree)</span>
<a href="#l4.318"></a><span id="l4.318">       return;</span>
<a href="#l4.319"></a><span id="l4.319" class="difflineminus">-    let first = treeBox.getFirstVisibleRow();</span>
<a href="#l4.320"></a><span id="l4.320" class="difflineplus">+    let first = tree.getFirstVisibleRow();</span>
<a href="#l4.321"></a><span id="l4.321">     const halfVisible = 1;</span>
<a href="#l4.322"></a><span id="l4.322" class="difflineminus">-    let last  = treeBox.getLastVisibleRow() - halfVisible;</span>
<a href="#l4.323"></a><span id="l4.323" class="difflineminus">-    let span = treeBox.getPageLength() - halfVisible;</span>
<a href="#l4.324"></a><span id="l4.324" class="difflineplus">+    let last  = tree.getLastVisibleRow() - halfVisible;</span>
<a href="#l4.325"></a><span id="l4.325" class="difflineplus">+    let span = tree.getPageLength() - halfVisible;</span>
<a href="#l4.326"></a><span id="l4.326">     let [topPadding, bottomPadding] = this.visibleRowPadding;</span>
<a href="#l4.327"></a><span id="l4.327"> </span>
<a href="#l4.328"></a><span id="l4.328">     // bail if the range is already visible with padding constraints handled</span>
<a href="#l4.329"></a><span id="l4.329">     if (((first + topPadding) &lt;= aMinRow) &amp;&amp;</span>
<a href="#l4.330"></a><span id="l4.330">         ((last - bottomPadding) &gt;= aMaxRow))</span>
<a href="#l4.331"></a><span id="l4.331">       return;</span>
<a href="#l4.332"></a><span id="l4.332"> </span>
<a href="#l4.333"></a><span id="l4.333">     let target;</span>
<a href="#l4.334"></a><span id="l4.334" class="difflineat">@@ -2538,17 +2532,17 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l4.335"></a><span id="l4.335">       target = Math.max(0, (aMinRow - topPadding));</span>
<a href="#l4.336"></a><span id="l4.336">     } else {</span>
<a href="#l4.337"></a><span id="l4.337">       // So the range must fit, and it's a question of how we want to position</span>
<a href="#l4.338"></a><span id="l4.338">       //  it.  For now, the answer is we try and center it, why not.</span>
<a href="#l4.339"></a><span id="l4.339">       let rowSpan = aMaxRow - aMinRow + 1;</span>
<a href="#l4.340"></a><span id="l4.340">       let halfSpare = Math.floor((span - rowSpan - topPadding - bottomPadding) / 2);</span>
<a href="#l4.341"></a><span id="l4.341">       target = aMinRow - halfSpare - topPadding;</span>
<a href="#l4.342"></a><span id="l4.342">     }</span>
<a href="#l4.343"></a><span id="l4.343" class="difflineminus">-    treeBox.scrollToRow(target);</span>
<a href="#l4.344"></a><span id="l4.344" class="difflineplus">+    tree.scrollToRow(target);</span>
<a href="#l4.345"></a><span id="l4.345">   },</span>
<a href="#l4.346"></a><span id="l4.346"> </span>
<a href="#l4.347"></a><span id="l4.347">   /**</span>
<a href="#l4.348"></a><span id="l4.348">    * Ensure that the selection is visible to the extent possible.</span>
<a href="#l4.349"></a><span id="l4.349">    */</span>
<a href="#l4.350"></a><span id="l4.350">   ensureSelectionIsVisible() {</span>
<a href="#l4.351"></a><span id="l4.351">     let treeSelection = this.treeSelection; // potentially magic getter</span>
<a href="#l4.352"></a><span id="l4.352">     if (!treeSelection || !treeSelection.count)</span>
<a href="#l4.353"></a><span id="l4.353" class="difflineat">@@ -2580,21 +2574,21 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l4.354"></a><span id="l4.354">  * This does not need to exist once we abandon multiplexed tabbing.</span>
<a href="#l4.355"></a><span id="l4.355">  *</span>
<a href="#l4.356"></a><span id="l4.356">  * Sometimes, nsTreeSelection tries to turn us into an nsIBoxObject and then in</span>
<a href="#l4.357"></a><span id="l4.357">  *  turn get the associated element, and then create DOM events on that. The</span>
<a href="#l4.358"></a><span id="l4.358">  *  only event that we care about is onselect, so we get a DOM node here (with</span>
<a href="#l4.359"></a><span id="l4.359">  *  an event listener for onselect already attached), and pass its boxObject in</span>
<a href="#l4.360"></a><span id="l4.360">  *  whenever nsTreeSelection QIs us to nsIBoxObject.</span>
<a href="#l4.361"></a><span id="l4.361">  */</span>
<a href="#l4.362"></a><span id="l4.362" class="difflineminus">-function FakeTreeBoxObject(aDOMNode) {</span>
<a href="#l4.363"></a><span id="l4.363" class="difflineplus">+function FakeTree(aDOMNode) {</span>
<a href="#l4.364"></a><span id="l4.364">   this.domNode = aDOMNode;</span>
<a href="#l4.365"></a><span id="l4.365">   this.view = null;</span>
<a href="#l4.366"></a><span id="l4.366"> }</span>
<a href="#l4.367"></a><span id="l4.367" class="difflineminus">-FakeTreeBoxObject.prototype = {</span>
<a href="#l4.368"></a><span id="l4.368" class="difflineplus">+FakeTree.prototype = {</span>
<a href="#l4.369"></a><span id="l4.369">   view: null,</span>
<a href="#l4.370"></a><span id="l4.370">   ensureRowIsVisible() {</span>
<a href="#l4.371"></a><span id="l4.371">     // NOP</span>
<a href="#l4.372"></a><span id="l4.372">   },</span>
<a href="#l4.373"></a><span id="l4.373">   /**</span>
<a href="#l4.374"></a><span id="l4.374">    * No need to actually invalidate, as when we re-root the view this will</span>
<a href="#l4.375"></a><span id="l4.375">    *  happen.</span>
<a href="#l4.376"></a><span id="l4.376">    */</span>
<a href="#l4.377"></a><span id="l4.377" class="difflineat">@@ -2655,17 +2649,17 @@ FakeTreeBoxObject.prototype = {</span>
<a href="#l4.378"></a><span id="l4.378">   },</span>
<a href="#l4.379"></a><span id="l4.379">   setProperty(propertyName, value) {</span>
<a href="#l4.380"></a><span id="l4.380">     return this.domNode.boxObject.setProperty(propertyName, value);</span>
<a href="#l4.381"></a><span id="l4.381">   },</span>
<a href="#l4.382"></a><span id="l4.382">   removeProperty(propertyName) {</span>
<a href="#l4.383"></a><span id="l4.383">     return this.domNode.boxObject.removeProperty(propertyName);</span>
<a href="#l4.384"></a><span id="l4.384">   },</span>
<a href="#l4.385"></a><span id="l4.385">   QueryInterface: ChromeUtils.generateQI([&quot;nsIBoxObject&quot;,</span>
<a href="#l4.386"></a><span id="l4.386" class="difflineminus">-                                          &quot;nsITreeBoxObject&quot;]),</span>
<a href="#l4.387"></a><span id="l4.387" class="difflineplus">+                                          &quot;XULTreeElement&quot;]),</span>
<a href="#l4.388"></a><span id="l4.388"> };</span>
<a href="#l4.389"></a><span id="l4.389"> /*</span>
<a href="#l4.390"></a><span id="l4.390">  * Provide attribute and function implementations that complain very loudly if</span>
<a href="#l4.391"></a><span id="l4.391">  *  they are used.  Now, XPConnect will return an error to callers if we don't</span>
<a href="#l4.392"></a><span id="l4.392">  *  implement part of the interface signature, but this is unlikely to provide</span>
<a href="#l4.393"></a><span id="l4.393">  *  the visibility we desire.  In fact, since it is a simple nsresult error,</span>
<a href="#l4.394"></a><span id="l4.394">  *  it may make things completely crazy.  So this way we can yell via dump,</span>
<a href="#l4.395"></a><span id="l4.395">  *  throw an exception, etc.</span>
<a href="#l4.396"></a><span id="l4.396" class="difflineat">@@ -2692,26 +2686,26 @@ function FTBO_stubOutMethods(aObj, aMeth</span>
<a href="#l4.397"></a><span id="l4.397">     let myMethodName = methodName;</span>
<a href="#l4.398"></a><span id="l4.398">     aObj[myMethodName] = function() {</span>
<a href="#l4.399"></a><span id="l4.399">       let msg = &quot;Call to stubbed method &quot; + myMethodName;</span>
<a href="#l4.400"></a><span id="l4.400">       dump(msg + &quot;\n&quot;);</span>
<a href="#l4.401"></a><span id="l4.401">       throw new Error(msg);</span>
<a href="#l4.402"></a><span id="l4.402">     };</span>
<a href="#l4.403"></a><span id="l4.403">   }</span>
<a href="#l4.404"></a><span id="l4.404"> }</span>
<a href="#l4.405"></a><span id="l4.405" class="difflineminus">-FTBO_stubOutAttributes(FakeTreeBoxObject.prototype, [</span>
<a href="#l4.406"></a><span id="l4.406" class="difflineplus">+FTBO_stubOutAttributes(FakeTree.prototype, [</span>
<a href="#l4.407"></a><span id="l4.407">   &quot;columns&quot;,</span>
<a href="#l4.408"></a><span id="l4.408">   &quot;focused&quot;,</span>
<a href="#l4.409"></a><span id="l4.409">   &quot;treeBody&quot;,</span>
<a href="#l4.410"></a><span id="l4.410">   &quot;rowHeight&quot;,</span>
<a href="#l4.411"></a><span id="l4.411">   &quot;rowWidth&quot;,</span>
<a href="#l4.412"></a><span id="l4.412">   &quot;horizontalPosition&quot;,</span>
<a href="#l4.413"></a><span id="l4.413">   &quot;selectionRegion&quot;,</span>
<a href="#l4.414"></a><span id="l4.414">   ]);</span>
<a href="#l4.415"></a><span id="l4.415" class="difflineminus">-FTBO_stubOutMethods(FakeTreeBoxObject.prototype, [</span>
<a href="#l4.416"></a><span id="l4.416" class="difflineplus">+FTBO_stubOutMethods(FakeTree.prototype, [</span>
<a href="#l4.417"></a><span id="l4.417">   &quot;getFirstVisibleRow&quot;,</span>
<a href="#l4.418"></a><span id="l4.418">   &quot;getLastVisibleRow&quot;,</span>
<a href="#l4.419"></a><span id="l4.419">   &quot;getPageLength&quot;,</span>
<a href="#l4.420"></a><span id="l4.420">   &quot;ensureCellIsVisible&quot;,</span>
<a href="#l4.421"></a><span id="l4.421">   &quot;scrollToRow&quot;,</span>
<a href="#l4.422"></a><span id="l4.422">   &quot;scrollByLines&quot;,</span>
<a href="#l4.423"></a><span id="l4.423">   &quot;scrollByPages&quot;,</span>
<a href="#l4.424"></a><span id="l4.424">   &quot;scrollToCell&quot;,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/base/content/folderPane.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/base/content/folderPane.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -262,28 +262,27 @@ var gFolderTreeView = {</span>
<a href="#l5.4"></a><span id="l5.4">    * @param event  the double-click event</span>
<a href="#l5.5"></a><span id="l5.5">    */</span>
<a href="#l5.6"></a><span id="l5.6">   onDoubleClick(aEvent) {</span>
<a href="#l5.7"></a><span id="l5.7">     if (aEvent.button != 0 || aEvent.originalTarget.localName == &quot;twisty&quot; ||</span>
<a href="#l5.8"></a><span id="l5.8">         aEvent.originalTarget.localName == &quot;slider&quot; ||</span>
<a href="#l5.9"></a><span id="l5.9">         aEvent.originalTarget.localName == &quot;scrollbarbutton&quot;)</span>
<a href="#l5.10"></a><span id="l5.10">       return;</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-    let row = gFolderTreeView._treeElement.treeBoxObject.getRowAt(aEvent.clientX,</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-                                                                  aEvent.clientY);</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+    let row = gFolderTreeView._treeElement.getRowAt(aEvent.clientX, aEvent.clientY);</span>
<a href="#l5.15"></a><span id="l5.15">     let folderItem = gFolderTreeView._rowMap[row];</span>
<a href="#l5.16"></a><span id="l5.16">     if (folderItem)</span>
<a href="#l5.17"></a><span id="l5.17">       folderItem.command();</span>
<a href="#l5.18"></a><span id="l5.18"> </span>
<a href="#l5.19"></a><span id="l5.19">     // Don't let the double-click toggle the open state of the folder here</span>
<a href="#l5.20"></a><span id="l5.20">     aEvent.stopPropagation();</span>
<a href="#l5.21"></a><span id="l5.21">   },</span>
<a href="#l5.22"></a><span id="l5.22"> </span>
<a href="#l5.23"></a><span id="l5.23">   getFolderAtCoords(aX, aY) {</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineminus">-    let row = gFolderTreeView._treeElement.treeBoxObject.getRowAt(aX, aY);</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineplus">+    let row = gFolderTreeView._treeElement.getRowAt(aX, aY);</span>
<a href="#l5.26"></a><span id="l5.26">     if (row in gFolderTreeView._rowMap)</span>
<a href="#l5.27"></a><span id="l5.27">       return gFolderTreeView._rowMap[row]._folder;</span>
<a href="#l5.28"></a><span id="l5.28">     return null;</span>
<a href="#l5.29"></a><span id="l5.29">   },</span>
<a href="#l5.30"></a><span id="l5.30"> </span>
<a href="#l5.31"></a><span id="l5.31">   /**</span>
<a href="#l5.32"></a><span id="l5.32">    * Toggle displaying the headers of columns in the folder pane.</span>
<a href="#l5.33"></a><span id="l5.33">    * @param aSetup  Set to true if the columns should be set up according</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineat">@@ -569,17 +568,17 @@ var gFolderTreeView = {</span>
<a href="#l5.35"></a><span id="l5.35">         // We don't want to get stuck in an infinite recursion, so pass in false</span>
<a href="#l5.36"></a><span id="l5.36">         return this.selectFolder(aFolder, false);</span>
<a href="#l5.37"></a><span id="l5.37">       }</span>
<a href="#l5.38"></a><span id="l5.38"> </span>
<a href="#l5.39"></a><span id="l5.39">       return false;</span>
<a href="#l5.40"></a><span id="l5.40">     }</span>
<a href="#l5.41"></a><span id="l5.41"> </span>
<a href="#l5.42"></a><span id="l5.42">     this.selection.select(folderIndex);</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineminus">-    this._treeElement.treeBoxObject.ensureRowIsVisible(folderIndex);</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineplus">+    this._treeElement.ensureRowIsVisible(folderIndex);</span>
<a href="#l5.45"></a><span id="l5.45">     return true;</span>
<a href="#l5.46"></a><span id="l5.46">   },</span>
<a href="#l5.47"></a><span id="l5.47"> </span>
<a href="#l5.48"></a><span id="l5.48">   /**</span>
<a href="#l5.49"></a><span id="l5.49">    * Returns the index of a folder in the current display.</span>
<a href="#l5.50"></a><span id="l5.50">    *</span>
<a href="#l5.51"></a><span id="l5.51">    * @param aFolder  the folder whose index should be returned.</span>
<a href="#l5.52"></a><span id="l5.52">    * @returns The index of the folder in the view (a number).</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/base/content/foldersummary.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/base/content/foldersummary.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -201,26 +201,25 @@ class MozFolderTooltip extends MozFolder</span>
<a href="#l6.4"></a><span id="l6.4">     }</span>
<a href="#l6.5"></a><span id="l6.5"> </span>
<a href="#l6.6"></a><span id="l6.6">     let tooltipnode = event.target;</span>
<a href="#l6.7"></a><span id="l6.7">     let asyncResults = {};</span>
<a href="#l6.8"></a><span id="l6.8">     if (tooltipnode.parseFolder(msgFolder, null, asyncResults)) {</span>
<a href="#l6.9"></a><span id="l6.9">       return true;</span>
<a href="#l6.10"></a><span id="l6.10">     }</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-    let row = {}, col = {};</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-    gFolderTreeView._tree.getCellAt(event.clientX, event.clientY, row, col, {});</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-    if (col.value.id == &quot;folderNameCol&quot;) {</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineminus">-      let cropped = gFolderTreeView._tree.isCellCropped(row.value, col.value);</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+    let treeCellInfo = gFolderTreeView._tree.getCellAt(event.clientX, event.clientY);</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+    if (treeCellInfo.col.id == &quot;folderNameCol&quot;) {</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+      let cropped = gFolderTreeView._tree.isCellCropped(treeCellInfo.row, treeCellInfo.col);</span>
<a href="#l6.19"></a><span id="l6.19">       if (this._addLocationInfo(msgFolder, cropped, tooltipnode)) {</span>
<a href="#l6.20"></a><span id="l6.20">         return true;</span>
<a href="#l6.21"></a><span id="l6.21">       }</span>
<a href="#l6.22"></a><span id="l6.22">     }</span>
<a href="#l6.23"></a><span id="l6.23"> </span>
<a href="#l6.24"></a><span id="l6.24" class="difflineminus">-    let counts = gFolderTreeView.getSummarizedCounts(row.value, col.value.id);</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineplus">+    let counts = gFolderTreeView.getSummarizedCounts(treeCellInfo.row, treeCellInfo.col.id);</span>
<a href="#l6.26"></a><span id="l6.26">     return this._addSummarizeExplain(counts, tooltipnode);</span>
<a href="#l6.27"></a><span id="l6.27">   }</span>
<a href="#l6.28"></a><span id="l6.28"> </span>
<a href="#l6.29"></a><span id="l6.29">   /** Handle the popuphiding event. */</span>
<a href="#l6.30"></a><span id="l6.30">   folderpopupHiding(event) {</span>
<a href="#l6.31"></a><span id="l6.31">     let node = event.target;</span>
<a href="#l6.32"></a><span id="l6.32">     while (node.hasChildNodes()) {</span>
<a href="#l6.33"></a><span id="l6.33">       node.lastChild.remove();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mail/base/content/mailCommands.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mail/base/content/mailCommands.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -301,18 +301,17 @@ function ComposeMessage(type, format, fo</span>
<a href="#l7.4"></a><span id="l7.4">       }</span>
<a href="#l7.5"></a><span id="l7.5">   }</span>
<a href="#l7.6"></a><span id="l7.6"> }</span>
<a href="#l7.7"></a><span id="l7.7"> /* eslint-enable complexity */</span>
<a href="#l7.8"></a><span id="l7.8"> </span>
<a href="#l7.9"></a><span id="l7.9"> function NewMessageToSelectedAddresses(type, format, identity) {</span>
<a href="#l7.10"></a><span id="l7.10">   var abSidebarPanel = document.commandDispatcher.focusedWindow;</span>
<a href="#l7.11"></a><span id="l7.11">   var abResultsTree = abSidebarPanel.document.getElementById(&quot;abResultsTree&quot;);</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-  var abResultsBoxObject = abResultsTree.treeBoxObject;</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-  var abView = abResultsBoxObject.view;</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+  var abView = abResultsTree.view;</span>
<a href="#l7.15"></a><span id="l7.15">   abView = abView.QueryInterface(Ci.nsIAbView);</span>
<a href="#l7.16"></a><span id="l7.16">   var addresses = abView.selectedAddresses;</span>
<a href="#l7.17"></a><span id="l7.17">   var params = Cc[&quot;@mozilla.org/messengercompose/composeparams;1&quot;].createInstance(Ci.nsIMsgComposeParams);</span>
<a href="#l7.18"></a><span id="l7.18">   if (params) {</span>
<a href="#l7.19"></a><span id="l7.19">     params.type = type;</span>
<a href="#l7.20"></a><span id="l7.20">     params.format = format;</span>
<a href="#l7.21"></a><span id="l7.21">     params.identity = identity;</span>
<a href="#l7.22"></a><span id="l7.22">     var composeFields = Cc[&quot;@mozilla.org/messengercompose/composefields;1&quot;].createInstance(Ci.nsIMsgCompFields);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mail/base/content/mailContextMenus.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mail/base/content/mailContextMenus.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -29,17 +29,17 @@ function RestoreSelectionWithoutContentL</span>
<a href="#l8.4"></a><span id="l8.4">     view.selection = realSelection;</span>
<a href="#l8.5"></a><span id="l8.5">     // replay any calls to adjustSelection, this handles suppression.</span>
<a href="#l8.6"></a><span id="l8.6">     transientSelection.replayAdjustSelectionLog(realSelection);</span>
<a href="#l8.7"></a><span id="l8.7">     // Avoid possible cycle leaks.</span>
<a href="#l8.8"></a><span id="l8.8">     gRightMouseButtonSavedSelection.view = null;</span>
<a href="#l8.9"></a><span id="l8.9">     gRightMouseButtonSavedSelection = null;</span>
<a href="#l8.10"></a><span id="l8.10"> </span>
<a href="#l8.11"></a><span id="l8.11">     if (tree)</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-      tree.treeBoxObject.invalidate();</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+      tree.invalidate();</span>
<a href="#l8.14"></a><span id="l8.14"> </span>
<a href="#l8.15"></a><span id="l8.15">     UpdateMailToolbar(&quot;RestoreSelectionWithoutContentLoad&quot;);</span>
<a href="#l8.16"></a><span id="l8.16">   }</span>
<a href="#l8.17"></a><span id="l8.17"> }</span>
<a href="#l8.18"></a><span id="l8.18"> </span>
<a href="#l8.19"></a><span id="l8.19"> /**</span>
<a href="#l8.20"></a><span id="l8.20">  * Function to clear out the global nsContextMenu, and in the case when we</span>
<a href="#l8.21"></a><span id="l8.21">  * were a threadpane context menu, restore the selection so that a right-click</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineat">@@ -61,17 +61,17 @@ function mailContextOnPopupHiding(aEvent</span>
<a href="#l8.23"></a><span id="l8.23"> function fillMailContextMenu(event) {</span>
<a href="#l8.24"></a><span id="l8.24">   // If the popupshowing was for a submenu, we don't need to do anything.</span>
<a href="#l8.25"></a><span id="l8.25">   if (event.target != event.currentTarget)</span>
<a href="#l8.26"></a><span id="l8.26">     return true;</span>
<a href="#l8.27"></a><span id="l8.27"> </span>
<a href="#l8.28"></a><span id="l8.28">   // No menu on grouped header row currently, any command would be an implied</span>
<a href="#l8.29"></a><span id="l8.29">   // multiselect.</span>
<a href="#l8.30"></a><span id="l8.30">   if (gFolderDisplay.tree) {</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-    let row = gFolderDisplay.treeBox.getRowAt(event.clientX, event.clientY);</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+    let row = gFolderDisplay.tree.getRowAt(event.clientX, event.clientY);</span>
<a href="#l8.33"></a><span id="l8.33">     if (gFolderDisplay.view.isGroupedByHeaderAtIndex(row)) {</span>
<a href="#l8.34"></a><span id="l8.34">       RestoreSelectionWithoutContentLoad(gFolderDisplay.tree);</span>
<a href="#l8.35"></a><span id="l8.35">       return false;</span>
<a href="#l8.36"></a><span id="l8.36">     }</span>
<a href="#l8.37"></a><span id="l8.37">   }</span>
<a href="#l8.38"></a><span id="l8.38"> </span>
<a href="#l8.39"></a><span id="l8.39">   goUpdateCommand(&quot;cmd_killThread&quot;);</span>
<a href="#l8.40"></a><span id="l8.40">   goUpdateCommand(&quot;cmd_killSubthread&quot;);</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineat">@@ -223,17 +223,17 @@ function OpenMessageByHeader(messageHead</span>
<a href="#l8.42"></a><span id="l8.42">         gDBView.selectMsgByKey(messageHeader.messageKey);</span>
<a href="#l8.43"></a><span id="l8.43">       } catch (e) {</span>
<a href="#l8.44"></a><span id="l8.44">          dump(&quot;select messagekey &quot; + messageHeader.messageKey +</span>
<a href="#l8.45"></a><span id="l8.45">               &quot; failed in folder &quot; + folder.URI);</span>
<a href="#l8.46"></a><span id="l8.46">       }</span>
<a href="#l8.47"></a><span id="l8.47">     }</span>
<a href="#l8.48"></a><span id="l8.48"> </span>
<a href="#l8.49"></a><span id="l8.49">     if (tree &amp;&amp; tree.currentIndex != -1)</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineminus">-      tree.treeBoxObject.ensureRowIsVisible(tree.currentIndex);</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+      tree.ensureRowIsVisible(tree.currentIndex);</span>
<a href="#l8.52"></a><span id="l8.52">   }</span>
<a href="#l8.53"></a><span id="l8.53"> }</span>
<a href="#l8.54"></a><span id="l8.54"> </span>
<a href="#l8.55"></a><span id="l8.55"> // search for message by message id in given folder and its subfolders</span>
<a href="#l8.56"></a><span id="l8.56"> // return message header if message was found</span>
<a href="#l8.57"></a><span id="l8.57"> function SearchForMessageIdInSubFolder(folder, messageId) {</span>
<a href="#l8.58"></a><span id="l8.58">   var messageHeader;</span>
<a href="#l8.59"></a><span id="l8.59">   var subFolders = folder.subFolders;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mail/base/content/mailTabs.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mail/base/content/mailTabs.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -353,17 +353,17 @@ var mailTabType = {</span>
<a href="#l9.4"></a><span id="l9.4">         // we only want to make it active after setting up the view and the message</span>
<a href="#l9.5"></a><span id="l9.5">         //  to avoid generating bogus summarization events.</span>
<a href="#l9.6"></a><span id="l9.6">         if (!background) {</span>
<a href="#l9.7"></a><span id="l9.7">           aTab.folderDisplay.makeActive();</span>
<a href="#l9.8"></a><span id="l9.8">           this.restoreFocus(aTab);</span>
<a href="#l9.9"></a><span id="l9.9">         } else {</span>
<a href="#l9.10"></a><span id="l9.10">           // We don't want to null out the real tree box view, as that</span>
<a href="#l9.11"></a><span id="l9.11">           // corresponds to the _current_ tab, not the new one</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-          aTab.folderDisplay.hookUpFakeTreeBox(false);</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+          aTab.folderDisplay.hookUpFakeTree(false);</span>
<a href="#l9.14"></a><span id="l9.14">         }</span>
<a href="#l9.15"></a><span id="l9.15">       },</span>
<a href="#l9.16"></a><span id="l9.16">       persistTab(aTab) {</span>
<a href="#l9.17"></a><span id="l9.17">         let msgHdr = aTab.folderDisplay.selectedMessage;</span>
<a href="#l9.18"></a><span id="l9.18">         return {</span>
<a href="#l9.19"></a><span id="l9.19">           messageURI: msgHdr.folder.getUriForMsg(msgHdr),</span>
<a href="#l9.20"></a><span id="l9.20">         };</span>
<a href="#l9.21"></a><span id="l9.21">       },</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineat">@@ -494,17 +494,16 @@ var mailTabType = {</span>
<a href="#l9.23"></a><span id="l9.23">     // Set the messagepane as the primary browser for content.</span>
<a href="#l9.24"></a><span id="l9.24">     document.getElementById(&quot;messagepane&quot;).setAttribute(&quot;type&quot;, &quot;content&quot;);</span>
<a href="#l9.25"></a><span id="l9.25">     document.getElementById(&quot;messagepane&quot;).setAttribute(&quot;primary&quot;, &quot;true&quot;);</span>
<a href="#l9.26"></a><span id="l9.26"> </span>
<a href="#l9.27"></a><span id="l9.27">     aTab.messageDisplay = aMessageDisplay;</span>
<a href="#l9.28"></a><span id="l9.28">     aTab.folderDisplay = new FolderDisplayWidget(aTab, aTab.messageDisplay);</span>
<a href="#l9.29"></a><span id="l9.29">     aTab.folderDisplay.msgWindow = msgWindow;</span>
<a href="#l9.30"></a><span id="l9.30">     aTab.folderDisplay.tree = document.getElementById(&quot;threadTree&quot;);</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineminus">-    aTab.folderDisplay.treeBox = aTab.folderDisplay.tree.boxObject;</span>
<a href="#l9.32"></a><span id="l9.32">     aTab.folderDisplay.folderPaneVisible = aFolderPaneVisible;</span>
<a href="#l9.33"></a><span id="l9.33"> </span>
<a href="#l9.34"></a><span id="l9.34">     if (aIsFirstTab) {</span>
<a href="#l9.35"></a><span id="l9.35">       aTab.folderDisplay.messenger = messenger;</span>
<a href="#l9.36"></a><span id="l9.36">     } else {</span>
<a href="#l9.37"></a><span id="l9.37">       // Each tab gets its own messenger instance; this provides each tab with</span>
<a href="#l9.38"></a><span id="l9.38">       // its own undo/redo stack and back/forward navigation history.</span>
<a href="#l9.39"></a><span id="l9.39">       // If this is a foreground tab, folderDisplay.makeActive() is going to</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mail/base/content/mailWidgets.xml</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mail/base/content/mailWidgets.xml</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -1830,20 +1830,19 @@</span>
<a href="#l10.4"></a><span id="l10.4">     &lt;implementation&gt;</span>
<a href="#l10.5"></a><span id="l10.5">       &lt;field name=&quot;tree&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l10.6"></a><span id="l10.6">         document.getAnonymousNodes(this)[0];</span>
<a href="#l10.7"></a><span id="l10.7">       &lt;/field&gt;</span>
<a href="#l10.8"></a><span id="l10.8">       &lt;method name=&quot;updateHover&quot;&gt;</span>
<a href="#l10.9"></a><span id="l10.9">         &lt;parameter name=&quot;event&quot;/&gt;</span>
<a href="#l10.10"></a><span id="l10.10">         &lt;body&gt;</span>
<a href="#l10.11"></a><span id="l10.11">           &lt;![CDATA[</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-            var box = this.tree.treeBoxObject;</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-            if (event.originalTarget == box.treeBody) {</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineminus">-              var index = box.getRowAt(event.clientX, event.clientY);</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineminus">-              box.view.selection.select(index);</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+            if (event.originalTarget == this.tree.treeBody) {</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineplus">+              var index = this.tree.getRowAt(event.clientX, event.clientY);</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineplus">+              this.tree.view.selection.select(index);</span>
<a href="#l10.19"></a><span id="l10.19">               return index;</span>
<a href="#l10.20"></a><span id="l10.20">             }</span>
<a href="#l10.21"></a><span id="l10.21">             return -1;</span>
<a href="#l10.22"></a><span id="l10.22">           ]]&gt;</span>
<a href="#l10.23"></a><span id="l10.23">         &lt;/body&gt;</span>
<a href="#l10.24"></a><span id="l10.24">       &lt;/method&gt;</span>
<a href="#l10.25"></a><span id="l10.25">       &lt;method name=&quot;fire&quot;&gt;</span>
<a href="#l10.26"></a><span id="l10.26">         &lt;body&gt;</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineat">@@ -1865,27 +1864,26 @@</span>
<a href="#l10.28"></a><span id="l10.28">         &lt;/body&gt;</span>
<a href="#l10.29"></a><span id="l10.29">       &lt;/method&gt;</span>
<a href="#l10.30"></a><span id="l10.30">       &lt;field name=&quot;onKeyPressMenuList&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l10.31"></a><span id="l10.31">         &lt;![CDATA[</span>
<a href="#l10.32"></a><span id="l10.32">           ({</span>
<a href="#l10.33"></a><span id="l10.33">             self: this,</span>
<a href="#l10.34"></a><span id="l10.34">             tree: this.tree,</span>
<a href="#l10.35"></a><span id="l10.35">             parentNode: this.parentNode,</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineminus">-            getLastVisibleRow(box) {</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineminus">-              var f = box.getFirstVisibleRow();</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineminus">-              var p = box.getPageLength();</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineminus">-              var l = box.view.rowCount;</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineplus">+            getLastVisibleRow(tree) {</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineplus">+              var f = tree.getFirstVisibleRow();</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineplus">+              var p = tree.getPageLength();</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineplus">+              var l = tree.view.rowCount;</span>
<a href="#l10.44"></a><span id="l10.44">               return (l &lt; f + p ? l : f + p) - 1;</span>
<a href="#l10.45"></a><span id="l10.45">             },</span>
<a href="#l10.46"></a><span id="l10.46">             handleEvent(event) {</span>
<a href="#l10.47"></a><span id="l10.47">               if (event.altKey)</span>
<a href="#l10.48"></a><span id="l10.48">                 return;</span>
<a href="#l10.49"></a><span id="l10.49">               var index;</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineminus">-              var box = this.tree.treeBoxObject;</span>
<a href="#l10.51"></a><span id="l10.51">               if (this.parentNode.hasAttribute(&quot;open&quot;)) {</span>
<a href="#l10.52"></a><span id="l10.52">                 event.stopPropagation();</span>
<a href="#l10.53"></a><span id="l10.53">                 event.preventDefault();</span>
<a href="#l10.54"></a><span id="l10.54">                 switch (event.keyCode) {</span>
<a href="#l10.55"></a><span id="l10.55">                   case event.DOM_VK_ESCAPE:</span>
<a href="#l10.56"></a><span id="l10.56">                     this.self.hidePopup();</span>
<a href="#l10.57"></a><span id="l10.57">                     return;</span>
<a href="#l10.58"></a><span id="l10.58">                   case event.DOM_VK_RETURN:</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineat">@@ -1904,47 +1902,47 @@</span>
<a href="#l10.60"></a><span id="l10.60">               switch (event.keyCode) {</span>
<a href="#l10.61"></a><span id="l10.61">                 case event.DOM_VK_UP:</span>
<a href="#l10.62"></a><span id="l10.62">                   if (index &lt;= 0)</span>
<a href="#l10.63"></a><span id="l10.63">                     return;</span>
<a href="#l10.64"></a><span id="l10.64">                   index--;</span>
<a href="#l10.65"></a><span id="l10.65">                   break;</span>
<a href="#l10.66"></a><span id="l10.66">                 case event.DOM_VK_DOWN:</span>
<a href="#l10.67"></a><span id="l10.67">                   index++;</span>
<a href="#l10.68"></a><span id="l10.68" class="difflineminus">-                  if (index == box.view.rowCount)</span>
<a href="#l10.69"></a><span id="l10.69" class="difflineplus">+                  if (index == this.tree.view.rowCount)</span>
<a href="#l10.70"></a><span id="l10.70">                     return;</span>
<a href="#l10.71"></a><span id="l10.71">                   break;</span>
<a href="#l10.72"></a><span id="l10.72">                 case event.DOM_VK_PAGE_UP:</span>
<a href="#l10.73"></a><span id="l10.73" class="difflineminus">-                  if (index == box.getFirstVisibleRow())</span>
<a href="#l10.74"></a><span id="l10.74" class="difflineminus">-                    box.scrollByPages(-1);</span>
<a href="#l10.75"></a><span id="l10.75" class="difflineminus">-                  index = box.getFirstVisibleRow();</span>
<a href="#l10.76"></a><span id="l10.76" class="difflineplus">+                  if (index == this.tree.getFirstVisibleRow())</span>
<a href="#l10.77"></a><span id="l10.77" class="difflineplus">+                    this.tree.scrollByPages(-1);</span>
<a href="#l10.78"></a><span id="l10.78" class="difflineplus">+                  index = this.tree.getFirstVisibleRow();</span>
<a href="#l10.79"></a><span id="l10.79">                   break;</span>
<a href="#l10.80"></a><span id="l10.80">                 case event.DOM_VK_PAGE_DOWN:</span>
<a href="#l10.81"></a><span id="l10.81" class="difflineminus">-                  if (index == this.getLastVisibleRow(box))</span>
<a href="#l10.82"></a><span id="l10.82" class="difflineminus">-                    box.scrollByPages(1);</span>
<a href="#l10.83"></a><span id="l10.83" class="difflineminus">-                  index = this.getLastVisibleRow(box);</span>
<a href="#l10.84"></a><span id="l10.84" class="difflineplus">+                  if (index == this.getLastVisibleRow(this.tree))</span>
<a href="#l10.85"></a><span id="l10.85" class="difflineplus">+                    this.tree.scrollByPages(1);</span>
<a href="#l10.86"></a><span id="l10.86" class="difflineplus">+                  index = this.getLastVisibleRow(this.tree);</span>
<a href="#l10.87"></a><span id="l10.87">                   break;</span>
<a href="#l10.88"></a><span id="l10.88">                 case event.DOM_VK_HOME:</span>
<a href="#l10.89"></a><span id="l10.89">                   index = 0;</span>
<a href="#l10.90"></a><span id="l10.90">                   break;</span>
<a href="#l10.91"></a><span id="l10.91">                 case event.DOM_VK_END:</span>
<a href="#l10.92"></a><span id="l10.92" class="difflineminus">-                  index = box.view.rowCount - 1;</span>
<a href="#l10.93"></a><span id="l10.93" class="difflineplus">+                  index = this.tree.view.rowCount - 1;</span>
<a href="#l10.94"></a><span id="l10.94">                   break;</span>
<a href="#l10.95"></a><span id="l10.95">                 default:</span>
<a href="#l10.96"></a><span id="l10.96">                   if (event.charCode &gt; 0 &amp;&amp; !event.ctrlKey &amp;&amp; !event.metaKey) {</span>
<a href="#l10.97"></a><span id="l10.97">                     event.preventDefault();</span>
<a href="#l10.98"></a><span id="l10.98">                     index = this.tree.keyNavigate(event);</span>
<a href="#l10.99"></a><span id="l10.99">                     if (index &gt;= 0)</span>
<a href="#l10.100"></a><span id="l10.100">                       break;</span>
<a href="#l10.101"></a><span id="l10.101">                   }</span>
<a href="#l10.102"></a><span id="l10.102">                   return;</span>
<a href="#l10.103"></a><span id="l10.103">               }</span>
<a href="#l10.104"></a><span id="l10.104" class="difflineminus">-              box.view.selection.select(index);</span>
<a href="#l10.105"></a><span id="l10.105" class="difflineplus">+              this.tree.view.selection.select(index);</span>
<a href="#l10.106"></a><span id="l10.106">               if (this.parentNode.hasAttribute(&quot;open&quot;))</span>
<a href="#l10.107"></a><span id="l10.107" class="difflineminus">-                box.ensureRowIsVisible(index);</span>
<a href="#l10.108"></a><span id="l10.108" class="difflineplus">+                this.tree.ensureRowIsVisible(index);</span>
<a href="#l10.109"></a><span id="l10.109">               else</span>
<a href="#l10.110"></a><span id="l10.110">                 this.self.fire();</span>
<a href="#l10.111"></a><span id="l10.111">             },</span>
<a href="#l10.112"></a><span id="l10.112">           })</span>
<a href="#l10.113"></a><span id="l10.113">         ]]&gt;</span>
<a href="#l10.114"></a><span id="l10.114">       &lt;/field&gt;</span>
<a href="#l10.115"></a><span id="l10.115">       &lt;method name=&quot;setInitialSelection&quot;&gt;</span>
<a href="#l10.116"></a><span id="l10.116">         &lt;body&gt;</span>
<a href="#l10.117"></a><span id="l10.117" class="difflineat">@@ -1991,24 +1989,23 @@</span>
<a href="#l10.118"></a><span id="l10.118">       &lt;/destructor&gt;</span>
<a href="#l10.119"></a><span id="l10.119">     &lt;/implementation&gt;</span>
<a href="#l10.120"></a><span id="l10.120">     &lt;handlers&gt;</span>
<a href="#l10.121"></a><span id="l10.121">       &lt;handler event=&quot;mousemove&quot; action=&quot;this.updateHover(event);&quot;/&gt;</span>
<a href="#l10.122"></a><span id="l10.122">       &lt;handler event=&quot;click&quot; button=&quot;0&quot; action=&quot;if (this.updateHover(event) &gt;= 0) this.fire();&quot;/&gt;</span>
<a href="#l10.123"></a><span id="l10.123">       &lt;handler event=&quot;popupshowing&quot;&gt;</span>
<a href="#l10.124"></a><span id="l10.124">         &lt;![CDATA[</span>
<a href="#l10.125"></a><span id="l10.125">           this.parentNode.addEventListener(&quot;blur&quot;, this.onBlurMenuList);</span>
<a href="#l10.126"></a><span id="l10.126" class="difflineminus">-          var box = this.tree.treeBoxObject;</span>
<a href="#l10.127"></a><span id="l10.127" class="difflineminus">-          box.focused = true;</span>
<a href="#l10.128"></a><span id="l10.128" class="difflineplus">+          this.tree.focused = true;</span>
<a href="#l10.129"></a><span id="l10.129">           var index = this.setInitialSelection();</span>
<a href="#l10.130"></a><span id="l10.130" class="difflineminus">-          var height = box.view.rowCount * box.rowHeight;</span>
<a href="#l10.131"></a><span id="l10.131" class="difflineminus">-          height += this.boxObject.height - box.treeBody.boxObject.height;</span>
<a href="#l10.132"></a><span id="l10.132" class="difflineplus">+          var height = this.tree.view.rowCount * this.tree.rowHeight;</span>
<a href="#l10.133"></a><span id="l10.133" class="difflineplus">+          height += this.boxObject.height - this.tree.treeBody.boxObject.height;</span>
<a href="#l10.134"></a><span id="l10.134">           this.height = height;</span>
<a href="#l10.135"></a><span id="l10.135">           if (index &gt;= 0)</span>
<a href="#l10.136"></a><span id="l10.136" class="difflineminus">-            setTimeout(function() { box.ensureRowIsVisible(index); }, 0);</span>
<a href="#l10.137"></a><span id="l10.137" class="difflineplus">+            setTimeout(function() { this.tree.ensureRowIsVisible(index); }, 0);</span>
<a href="#l10.138"></a><span id="l10.138">         ]]&gt;</span>
<a href="#l10.139"></a><span id="l10.139">       &lt;/handler&gt;</span>
<a href="#l10.140"></a><span id="l10.140">       &lt;handler event=&quot;popuphiding&quot;&gt;</span>
<a href="#l10.141"></a><span id="l10.141">         &lt;![CDATA[</span>
<a href="#l10.142"></a><span id="l10.142">           this.parentNode.removeEventListener(&quot;blur&quot;, this.onBlurMenuList);</span>
<a href="#l10.143"></a><span id="l10.143">         ]]&gt;</span>
<a href="#l10.144"></a><span id="l10.144">       &lt;/handler&gt;</span>
<a href="#l10.145"></a><span id="l10.145">     &lt;/handlers&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mail/base/content/messageWindow.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mail/base/content/messageWindow.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -86,28 +86,28 @@ StandaloneFolderDisplayWidget.prototype </span>
<a href="#l11.4"></a><span id="l11.4">              [this.messageDisplay.displayedMessage] : [];</span>
<a href="#l11.5"></a><span id="l11.5">   },</span>
<a href="#l11.6"></a><span id="l11.6"> </span>
<a href="#l11.7"></a><span id="l11.7">   /**</span>
<a href="#l11.8"></a><span id="l11.8">    * We never have a real treeview, so we always want to tell the view about</span>
<a href="#l11.9"></a><span id="l11.9">    *  the fake tree box so it will actually do something in NoteChange.</span>
<a href="#l11.10"></a><span id="l11.10">    */</span>
<a href="#l11.11"></a><span id="l11.11">   onCreatedView() {</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-    this._fakeTreeBox.view = this.view.dbView;</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+    this._fakeTree.view = this.view.dbView;</span>
<a href="#l11.14"></a><span id="l11.14">     // Need to clear out this reference later.</span>
<a href="#l11.15"></a><span id="l11.15">     this._magicTreeSelection.view = this.view.dbView;</span>
<a href="#l11.16"></a><span id="l11.16"> </span>
<a href="#l11.17"></a><span id="l11.17">     // only if we're not dealing with a dummy message (from .eml file /</span>
<a href="#l11.18"></a><span id="l11.18">     //  attachment should we try and hook up the selection object.)  Otherwise</span>
<a href="#l11.19"></a><span id="l11.19">     //  the view will not operate in stand alone message mode.</span>
<a href="#l11.20"></a><span id="l11.20">     // XXX the sequencing here may break re-using a message window that is</span>
<a href="#l11.21"></a><span id="l11.21">     //  showing an .eml file to go to a real message, at least in terms of</span>
<a href="#l11.22"></a><span id="l11.22">     //  having the selection object properly associated with the tree.</span>
<a href="#l11.23"></a><span id="l11.23">     if (!this.messageDisplay.isDummy) {</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineminus">-      this.view.dbView.setTree(this._fakeTreeBox);</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineplus">+      this.view.dbView.setTree(this._fakeTree);</span>
<a href="#l11.26"></a><span id="l11.26">       this.view.dbView.selection = this._magicTreeSelection;</span>
<a href="#l11.27"></a><span id="l11.27">       // This lets the dbView know we don't really have a tree, so it can</span>
<a href="#l11.28"></a><span id="l11.28">       // avoid operating on messages in collapsed threads.</span>
<a href="#l11.29"></a><span id="l11.29">       this._magicTreeSelection.tree = null;</span>
<a href="#l11.30"></a><span id="l11.30">     }</span>
<a href="#l11.31"></a><span id="l11.31">     this.__proto__.__proto__.onCreatedView.call(this);</span>
<a href="#l11.32"></a><span id="l11.32">   },</span>
<a href="#l11.33"></a><span id="l11.33"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mail/base/content/msgMail3PaneWindow.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mail/base/content/msgMail3PaneWindow.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -392,17 +392,17 @@ var MailPrefObserver = {</span>
<a href="#l12.4"></a><span id="l12.4"> </span>
<a href="#l12.5"></a><span id="l12.5">         currentDisplayNameVersion =</span>
<a href="#l12.6"></a><span id="l12.6">             Services.prefs.getIntPref(&quot;mail.displayname.version&quot;);</span>
<a href="#l12.7"></a><span id="l12.7"> </span>
<a href="#l12.8"></a><span id="l12.8">         Services.prefs.setIntPref(&quot;mail.displayname.version&quot;,</span>
<a href="#l12.9"></a><span id="l12.9">                                   ++currentDisplayNameVersion);</span>
<a href="#l12.10"></a><span id="l12.10"> </span>
<a href="#l12.11"></a><span id="l12.11">         // refresh the thread pane</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-        threadTree.treeBoxObject.invalidate();</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+        threadTree.invalidate();</span>
<a href="#l12.14"></a><span id="l12.14">       }</span>
<a href="#l12.15"></a><span id="l12.15">     }</span>
<a href="#l12.16"></a><span id="l12.16">   },</span>
<a href="#l12.17"></a><span id="l12.17"> };</span>
<a href="#l12.18"></a><span id="l12.18"> </span>
<a href="#l12.19"></a><span id="l12.19"> /**</span>
<a href="#l12.20"></a><span id="l12.20">  * Called on startup if there are no accounts.</span>
<a href="#l12.21"></a><span id="l12.21">  */</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineat">@@ -1070,63 +1070,58 @@ function ClearMessagePane() {</span>
<a href="#l12.23"></a><span id="l12.23">  *</span>
<a href="#l12.24"></a><span id="l12.24">  * @param aSingleSelect Should the selection we create be a single selection?</span>
<a href="#l12.25"></a><span id="l12.25">  *     This is relevant if the row being clicked on is already part of the</span>
<a href="#l12.26"></a><span id="l12.26">  *     selection.  If it is part of the selection and !aSingleSelect, then we</span>
<a href="#l12.27"></a><span id="l12.27">  *     leave the selection as is.  If it is part of the selection and</span>
<a href="#l12.28"></a><span id="l12.28">  *     aSingleSelect then we create a transient single-row selection.</span>
<a href="#l12.29"></a><span id="l12.29">  */</span>
<a href="#l12.30"></a><span id="l12.30"> function ChangeSelectionWithoutContentLoad(event, tree, aSingleSelect) {</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineminus">-  var treeBoxObj = tree.treeBoxObject;</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineminus">-  if (!treeBoxObj) {</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineminus">-    event.stopPropagation();</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineminus">-    return;</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineminus">-  }</span>
<a href="#l12.36"></a><span id="l12.36"> </span>
<a href="#l12.37"></a><span id="l12.37" class="difflineminus">-  var treeSelection = treeBoxObj.view.selection;</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineplus">+  var treeSelection = tree.view.selection;</span>
<a href="#l12.39"></a><span id="l12.39"> </span>
<a href="#l12.40"></a><span id="l12.40" class="difflineminus">-  var row = treeBoxObj.getRowAt(event.clientX, event.clientY);</span>
<a href="#l12.41"></a><span id="l12.41" class="difflineplus">+  var row = tree.getRowAt(event.clientX, event.clientY);</span>
<a href="#l12.42"></a><span id="l12.42">   // Only do something if:</span>
<a href="#l12.43"></a><span id="l12.43">   // - the row is valid</span>
<a href="#l12.44"></a><span id="l12.44">   // - it's not already selected (or we want a single selection)</span>
<a href="#l12.45"></a><span id="l12.45">   if (row &gt;= 0 &amp;&amp;</span>
<a href="#l12.46"></a><span id="l12.46">       (aSingleSelect || !treeSelection.isSelected(row))) {</span>
<a href="#l12.47"></a><span id="l12.47">     // Check if the row is exactly the existing selection.  In that case</span>
<a href="#l12.48"></a><span id="l12.48">     //  there is no need to create a bogus selection.</span>
<a href="#l12.49"></a><span id="l12.49">     if (treeSelection.count == 1) {</span>
<a href="#l12.50"></a><span id="l12.50">       let minObj = {};</span>
<a href="#l12.51"></a><span id="l12.51">       treeSelection.getRangeAt(0, minObj, {});</span>
<a href="#l12.52"></a><span id="l12.52">       if (minObj.value == row) {</span>
<a href="#l12.53"></a><span id="l12.53">         event.stopPropagation();</span>
<a href="#l12.54"></a><span id="l12.54">         return;</span>
<a href="#l12.55"></a><span id="l12.55">       }</span>
<a href="#l12.56"></a><span id="l12.56">     }</span>
<a href="#l12.57"></a><span id="l12.57"> </span>
<a href="#l12.58"></a><span id="l12.58" class="difflineminus">-    let transientSelection = new JSTreeSelection(treeBoxObj);</span>
<a href="#l12.59"></a><span id="l12.59" class="difflineplus">+    let transientSelection = new JSTreeSelection(tree);</span>
<a href="#l12.60"></a><span id="l12.60">     transientSelection.logAdjustSelectionForReplay();</span>
<a href="#l12.61"></a><span id="l12.61"> </span>
<a href="#l12.62"></a><span id="l12.62">     gRightMouseButtonSavedSelection = {</span>
<a href="#l12.63"></a><span id="l12.63">       // Need to clear out this reference later.</span>
<a href="#l12.64"></a><span id="l12.64" class="difflineminus">-      view: treeBoxObj.view,</span>
<a href="#l12.65"></a><span id="l12.65" class="difflineplus">+      view: tree.view,</span>
<a href="#l12.66"></a><span id="l12.66">       realSelection: treeSelection,</span>
<a href="#l12.67"></a><span id="l12.67">       transientSelection,</span>
<a href="#l12.68"></a><span id="l12.68">     };</span>
<a href="#l12.69"></a><span id="l12.69"> </span>
<a href="#l12.70"></a><span id="l12.70">     var saveCurrentIndex = treeSelection.currentIndex;</span>
<a href="#l12.71"></a><span id="l12.71"> </span>
<a href="#l12.72"></a><span id="l12.72">     // tell it to log calls to adjustSelection</span>
<a href="#l12.73"></a><span id="l12.73">     // attach it to the view</span>
<a href="#l12.74"></a><span id="l12.74" class="difflineminus">-    treeBoxObj.view.selection = transientSelection;</span>
<a href="#l12.75"></a><span id="l12.75" class="difflineplus">+    tree.view.selection = transientSelection;</span>
<a href="#l12.76"></a><span id="l12.76">     // Don't generate any selection events! (we never set this to false, because</span>
<a href="#l12.77"></a><span id="l12.77">     //  that would generate an event, and we never need one of those from this</span>
<a href="#l12.78"></a><span id="l12.78">     //  selection object.</span>
<a href="#l12.79"></a><span id="l12.79">     transientSelection.selectEventsSuppressed = true;</span>
<a href="#l12.80"></a><span id="l12.80">     transientSelection.select(row);</span>
<a href="#l12.81"></a><span id="l12.81">     transientSelection.currentIndex = saveCurrentIndex;</span>
<a href="#l12.82"></a><span id="l12.82" class="difflineminus">-    treeBoxObj.ensureRowIsVisible(row);</span>
<a href="#l12.83"></a><span id="l12.83" class="difflineplus">+    tree.ensureRowIsVisible(row);</span>
<a href="#l12.84"></a><span id="l12.84">   }</span>
<a href="#l12.85"></a><span id="l12.85">   event.stopPropagation();</span>
<a href="#l12.86"></a><span id="l12.86"> }</span>
<a href="#l12.87"></a><span id="l12.87"> </span>
<a href="#l12.88"></a><span id="l12.88"> function TreeOnMouseDown(event) {</span>
<a href="#l12.89"></a><span id="l12.89">   // Detect right mouse click and change the highlight to the row</span>
<a href="#l12.90"></a><span id="l12.90">   // where the click happened without loading the message headers in</span>
<a href="#l12.91"></a><span id="l12.91">   // the Folder or Thread Pane.</span>
<a href="#l12.92"></a><span id="l12.92" class="difflineat">@@ -1149,21 +1144,18 @@ function FolderPaneOnClick(event) {</span>
<a href="#l12.93"></a><span id="l12.93">   var folderTree = document.getElementById(&quot;folderTree&quot;);</span>
<a href="#l12.94"></a><span id="l12.94"> </span>
<a href="#l12.95"></a><span id="l12.95">   // Middle click on a folder opens the folder in a tab</span>
<a href="#l12.96"></a><span id="l12.96">   if (event.button == 1 &amp;&amp; event.originalTarget.localName != &quot;slider&quot; &amp;&amp;</span>
<a href="#l12.97"></a><span id="l12.97">       event.originalTarget.localName != &quot;scrollbarbutton&quot;) {</span>
<a href="#l12.98"></a><span id="l12.98">     FolderPaneContextMenuNewTab(event);</span>
<a href="#l12.99"></a><span id="l12.99">     RestoreSelectionWithoutContentLoad(folderTree);</span>
<a href="#l12.100"></a><span id="l12.100">   } else if (event.button == 0) {</span>
<a href="#l12.101"></a><span id="l12.101" class="difflineminus">-    var row = {};</span>
<a href="#l12.102"></a><span id="l12.102" class="difflineminus">-    var col = {};</span>
<a href="#l12.103"></a><span id="l12.103" class="difflineminus">-    var elt = {};</span>
<a href="#l12.104"></a><span id="l12.104" class="difflineminus">-    folderTree.treeBoxObject.getCellAt(event.clientX, event.clientY, row, col, elt);</span>
<a href="#l12.105"></a><span id="l12.105" class="difflineminus">-    if (row.value == -1) {</span>
<a href="#l12.106"></a><span id="l12.106" class="difflineplus">+    var treeCellInfo = folderTree.getCellAt(event.clientX, event.clientY);</span>
<a href="#l12.107"></a><span id="l12.107" class="difflineplus">+    if (treeCellInfo.row == -1) {</span>
<a href="#l12.108"></a><span id="l12.108">       if (event.originalTarget.localName == &quot;treecol&quot;) {</span>
<a href="#l12.109"></a><span id="l12.109">         // clicking on the name column in the folder pane should not sort</span>
<a href="#l12.110"></a><span id="l12.110">         event.stopPropagation();</span>
<a href="#l12.111"></a><span id="l12.111">       }</span>
<a href="#l12.112"></a><span id="l12.112">     } else if ((event.originalTarget.localName == &quot;slider&quot;) ||</span>
<a href="#l12.113"></a><span id="l12.113">              (event.originalTarget.localName == &quot;scrollbarbutton&quot;)) {</span>
<a href="#l12.114"></a><span id="l12.114">       event.stopPropagation();</span>
<a href="#l12.115"></a><span id="l12.115">     }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mail/base/content/threadPane.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mail/base/content/threadPane.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -27,55 +27,52 @@ function ThreadPaneOnClick(event) {</span>
<a href="#l13.4"></a><span id="l13.4">   if (t.localName == &quot;treecol&quot;) {</span>
<a href="#l13.5"></a><span id="l13.5">     HandleColumnClick(t.id);</span>
<a href="#l13.6"></a><span id="l13.6">     return;</span>
<a href="#l13.7"></a><span id="l13.7">   }</span>
<a href="#l13.8"></a><span id="l13.8"> </span>
<a href="#l13.9"></a><span id="l13.9">   if (t.localName != &quot;treechildren&quot;)</span>
<a href="#l13.10"></a><span id="l13.10">     return;</span>
<a href="#l13.11"></a><span id="l13.11"> </span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-  let row = {};</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-  let col = {};</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineminus">-  let elt = {};</span>
<a href="#l13.15"></a><span id="l13.15">   let tree = GetThreadTree();</span>
<a href="#l13.16"></a><span id="l13.16"> </span>
<a href="#l13.17"></a><span id="l13.17">   // Figure out what cell the click was in.</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineminus">-  tree.treeBoxObject.getCellAt(event.clientX, event.clientY, row, col, elt);</span>
<a href="#l13.19"></a><span id="l13.19" class="difflineminus">-  if (row.value == -1)</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineplus">+  let treeCellInfo = tree.getCellAt(event.clientX, event.clientY);</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineplus">+  if (treeCellInfo.row == -1)</span>
<a href="#l13.22"></a><span id="l13.22">    return;</span>
<a href="#l13.23"></a><span id="l13.23"> </span>
<a href="#l13.24"></a><span id="l13.24">   // Grouped By Sort dummy header row non cycler column doubleclick toggles the</span>
<a href="#l13.25"></a><span id="l13.25">   // thread's open/close state; tree.xml handles it. Cyclers are not currently</span>
<a href="#l13.26"></a><span id="l13.26">   // implemented in group header rows, a click/doubleclick there should</span>
<a href="#l13.27"></a><span id="l13.27">   // select/toggle thread state.</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineminus">-  if (gFolderDisplay.view.isGroupedByHeaderAtIndex(row.value)) {</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineminus">-    if (!col.value.cycler)</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineplus">+  if (gFolderDisplay.view.isGroupedByHeaderAtIndex(treeCellInfo.row)) {</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineplus">+    if (!treeCellInfo.col.cycler)</span>
<a href="#l13.32"></a><span id="l13.32">       return;</span>
<a href="#l13.33"></a><span id="l13.33"> </span>
<a href="#l13.34"></a><span id="l13.34">     if (event.detail == 1)</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineminus">-      gFolderDisplay.selectViewIndex(row.value);</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineplus">+      gFolderDisplay.selectViewIndex(treeCellInfo.row);</span>
<a href="#l13.37"></a><span id="l13.37">     if (event.detail == 2)</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineminus">-      gFolderDisplay.view.dbView.toggleOpenState(row.value);</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineplus">+      gFolderDisplay.view.dbView.toggleOpenState(treeCellInfo.row);</span>
<a href="#l13.40"></a><span id="l13.40"> </span>
<a href="#l13.41"></a><span id="l13.41">     event.stopPropagation();</span>
<a href="#l13.42"></a><span id="l13.42">     return;</span>
<a href="#l13.43"></a><span id="l13.43">   }</span>
<a href="#l13.44"></a><span id="l13.44"> </span>
<a href="#l13.45"></a><span id="l13.45">   // If the cell is in a cycler column or if the user doubleclicked on the</span>
<a href="#l13.46"></a><span id="l13.46">   // twisty, don't open the message in a new window.</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineminus">-  if (event.detail == 2 &amp;&amp; !col.value.cycler &amp;&amp; elt.value != &quot;twisty&quot;) {</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineplus">+  if (event.detail == 2 &amp;&amp; !treeCellInfo.col.cycler &amp;&amp; treeCellInfo.childElt != &quot;twisty&quot;) {</span>
<a href="#l13.49"></a><span id="l13.49">     ThreadPaneDoubleClick();</span>
<a href="#l13.50"></a><span id="l13.50">     // Doubleclicking should not toggle the open/close state of the thread.</span>
<a href="#l13.51"></a><span id="l13.51">     // This will happen if we don't prevent the event from bubbling to the</span>
<a href="#l13.52"></a><span id="l13.52">     // default handler in tree.xml.</span>
<a href="#l13.53"></a><span id="l13.53">     event.stopPropagation();</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineminus">-  } else if (col.value.id == &quot;junkStatusCol&quot;) {</span>
<a href="#l13.55"></a><span id="l13.55" class="difflineplus">+  } else if (treeCellInfo.col.id == &quot;junkStatusCol&quot;) {</span>
<a href="#l13.56"></a><span id="l13.56">     MsgJunkMailInfo(true);</span>
<a href="#l13.57"></a><span id="l13.57" class="difflineminus">-  } else if (col.value.id == &quot;threadCol&quot; &amp;&amp; !event.shiftKey &amp;&amp; (event.ctrlKey || event.metaKey)) {</span>
<a href="#l13.58"></a><span id="l13.58" class="difflineminus">-    gDBView.ExpandAndSelectThreadByIndex(row.value, true);</span>
<a href="#l13.59"></a><span id="l13.59" class="difflineplus">+  } else if (treeCellInfo.col.id == &quot;threadCol&quot; &amp;&amp; !event.shiftKey &amp;&amp; (event.ctrlKey || event.metaKey)) {</span>
<a href="#l13.60"></a><span id="l13.60" class="difflineplus">+    gDBView.ExpandAndSelectThreadByIndex(treeCellInfo.row, true);</span>
<a href="#l13.61"></a><span id="l13.61">     event.stopPropagation();</span>
<a href="#l13.62"></a><span id="l13.62">   }</span>
<a href="#l13.63"></a><span id="l13.63"> }</span>
<a href="#l13.64"></a><span id="l13.64"> </span>
<a href="#l13.65"></a><span id="l13.65"> function HandleColumnClick(columnID) {</span>
<a href="#l13.66"></a><span id="l13.66">   if (gFolderDisplay.COLUMNS_MAP_NOSORT.has(columnID))</span>
<a href="#l13.67"></a><span id="l13.67">     return;</span>
<a href="#l13.68"></a><span id="l13.68"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mail/components/addrbook/content/abCommon.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mail/components/addrbook/content/abCommon.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -626,17 +626,17 @@ function DirPaneClick(event) {</span>
<a href="#l14.4"></a><span id="l14.4"> }</span>
<a href="#l14.5"></a><span id="l14.5"> </span>
<a href="#l14.6"></a><span id="l14.6"> function DirPaneDoubleClick(event) {</span>
<a href="#l14.7"></a><span id="l14.7">   // We only care about left button events.</span>
<a href="#l14.8"></a><span id="l14.8">   if (event.button != 0)</span>
<a href="#l14.9"></a><span id="l14.9">     return;</span>
<a href="#l14.10"></a><span id="l14.10"> </span>
<a href="#l14.11"></a><span id="l14.11">   // Ignore double clicking on invalid rows.</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-  let row = gDirTree.treeBoxObject.getRowAt(event.clientX, event.clientY);</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+  let row = gDirTree.getRowAt(event.clientX, event.clientY);</span>
<a href="#l14.14"></a><span id="l14.14">   if (row == -1 || row &gt; gDirTree.view.rowCount - 1)</span>
<a href="#l14.15"></a><span id="l14.15">     return;</span>
<a href="#l14.16"></a><span id="l14.16"> </span>
<a href="#l14.17"></a><span id="l14.17">   // Default action for double click is expand/collapse which ships with the tree.</span>
<a href="#l14.18"></a><span id="l14.18">   // For convenience, allow double-click to edit the properties of mailing</span>
<a href="#l14.19"></a><span id="l14.19">   // lists in directory tree.</span>
<a href="#l14.20"></a><span id="l14.20">   if (gDirTree &amp;&amp; gDirTree.view.selection &amp;&amp;</span>
<a href="#l14.21"></a><span id="l14.21">       gDirTree.view.selection.count == 1 &amp;&amp;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mail/components/addrbook/content/abContactsPanel.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mail/components/addrbook/content/abContactsPanel.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -70,17 +70,17 @@ function contactsListOnClick(aEvent) {</span>
<a href="#l15.4"></a><span id="l15.4">   if (target.localName == &quot;treecol&quot; &amp;&amp; aEvent.button == 0) {</span>
<a href="#l15.5"></a><span id="l15.5">     let sortDirection = target.getAttribute(&quot;sortDirection&quot;) == kDefaultDescending ?</span>
<a href="#l15.6"></a><span id="l15.6">                         kDefaultAscending : kDefaultDescending;</span>
<a href="#l15.7"></a><span id="l15.7">     SortAndUpdateIndicators(target.id, sortDirection);</span>
<a href="#l15.8"></a><span id="l15.8">     return;</span>
<a href="#l15.9"></a><span id="l15.9">   }</span>
<a href="#l15.10"></a><span id="l15.10">   // Any click on gAbResultsTree view (rows or blank space).</span>
<a href="#l15.11"></a><span id="l15.11">   if (target.localName == &quot;treechildren&quot;) {</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-    let row = gAbResultsTree.treeBoxObject.getRowAt(aEvent.clientX, aEvent.clientY);</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+    let row = gAbResultsTree.getRowAt(aEvent.clientX, aEvent.clientY);</span>
<a href="#l15.14"></a><span id="l15.14">     if (row &lt; 0 || row &gt;= gAbResultsTree.view.rowCount) {</span>
<a href="#l15.15"></a><span id="l15.15">       // Any click on results tree whitespace.</span>
<a href="#l15.16"></a><span id="l15.16">       if ((aEvent.detail == 1 &amp;&amp; aEvent.button == 0) || aEvent.button == 2) {</span>
<a href="#l15.17"></a><span id="l15.17">         // Single left click or any right click on results tree blank space:</span>
<a href="#l15.18"></a><span id="l15.18">         // Clear selection. This also triggers on the first click of any</span>
<a href="#l15.19"></a><span id="l15.19">         // double-click, but that's ok. MAC OS X doesn't return event.detail==1</span>
<a href="#l15.20"></a><span id="l15.20">         // for single right click, so we also let this trigger for the second</span>
<a href="#l15.21"></a><span id="l15.21">         // click of right double-click.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mail/components/extensions/test/browser/browser_ext_menus.js</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mail/components/extensions/test/browser/browser_ext_menus.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -1,16 +1,16 @@</span>
<a href="#l16.4"></a><span id="l16.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l16.5"></a><span id="l16.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l16.6"></a><span id="l16.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l16.7"></a><span id="l16.7"> </span>
<a href="#l16.8"></a><span id="l16.8"> let gAccount, gFolders;</span>
<a href="#l16.9"></a><span id="l16.9"> </span>
<a href="#l16.10"></a><span id="l16.10"> function treeClick(tree, row, column, event) {</span>
<a href="#l16.11"></a><span id="l16.11" class="difflineminus">-  let coords = tree.treeBoxObject.getCoordsForCellItem(row, tree.columns[column], &quot;cell&quot;);</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineplus">+  let coords = tree.getCoordsForCellItem(row, tree.columns[column], &quot;cell&quot;);</span>
<a href="#l16.13"></a><span id="l16.13">   let treeChildren = tree.lastElementChild;</span>
<a href="#l16.14"></a><span id="l16.14">   EventUtils.synthesizeMouse(</span>
<a href="#l16.15"></a><span id="l16.15">     treeChildren,</span>
<a href="#l16.16"></a><span id="l16.16">     coords.x + (coords.width / 2),</span>
<a href="#l16.17"></a><span id="l16.17">     coords.y + (coords.height / 2),</span>
<a href="#l16.18"></a><span id="l16.18">     event,</span>
<a href="#l16.19"></a><span id="l16.19">     window</span>
<a href="#l16.20"></a><span id="l16.20">   );</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mail/components/im/content/chat-messenger.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mail/components/im/content/chat-messenger.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -477,29 +477,29 @@ var chatHandler = {</span>
<a href="#l17.4"></a><span id="l17.4">       return true;</span>
<a href="#l17.5"></a><span id="l17.5">     }</span>
<a href="#l17.6"></a><span id="l17.6">     // Find the aShouldSelect log and select it.</span>
<a href="#l17.7"></a><span id="l17.7">     let logTime = aShouldSelect.time;</span>
<a href="#l17.8"></a><span id="l17.8">     for (let index = 0; index &lt; treeView._rowMap.length; ++index) {</span>
<a href="#l17.9"></a><span id="l17.9">       if (!treeView.isContainer(index) &amp;&amp;</span>
<a href="#l17.10"></a><span id="l17.10">           treeView._rowMap[index].log.time == logTime) {</span>
<a href="#l17.11"></a><span id="l17.11">         logTree.view.selection.select(index);</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-        logTree.treeBoxObject.ensureRowIsVisible(index);</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+        logTree.ensureRowIsVisible(index);</span>
<a href="#l17.14"></a><span id="l17.14">         return true;</span>
<a href="#l17.15"></a><span id="l17.15">       }</span>
<a href="#l17.16"></a><span id="l17.16">       if (!treeView._rowMap[index].children.some(i =&gt; i.log.time == logTime))</span>
<a href="#l17.17"></a><span id="l17.17">         continue;</span>
<a href="#l17.18"></a><span id="l17.18">       treeView.toggleOpenState(index);</span>
<a href="#l17.19"></a><span id="l17.19">       ++index;</span>
<a href="#l17.20"></a><span id="l17.20">       while (index &lt; treeView._rowMap.length &amp;&amp;</span>
<a href="#l17.21"></a><span id="l17.21">              treeView._rowMap[index].log.time != logTime)</span>
<a href="#l17.22"></a><span id="l17.22">         ++index;</span>
<a href="#l17.23"></a><span id="l17.23">       if (treeView._rowMap[index].log.time == logTime) {</span>
<a href="#l17.24"></a><span id="l17.24">         logTree.view.selection.select(index);</span>
<a href="#l17.25"></a><span id="l17.25" class="difflineminus">-        logTree.treeBoxObject.ensureRowIsVisible(index);</span>
<a href="#l17.26"></a><span id="l17.26" class="difflineplus">+        logTree.ensureRowIsVisible(index);</span>
<a href="#l17.27"></a><span id="l17.27">       }</span>
<a href="#l17.28"></a><span id="l17.28">       return true;</span>
<a href="#l17.29"></a><span id="l17.29">     }</span>
<a href="#l17.30"></a><span id="l17.30">     throw &quot;Couldn't find the log to select among the set of logs passed.&quot;;</span>
<a href="#l17.31"></a><span id="l17.31">   },</span>
<a href="#l17.32"></a><span id="l17.32"> </span>
<a href="#l17.33"></a><span id="l17.33">   onLogSelect() {</span>
<a href="#l17.34"></a><span id="l17.34">     let selection = this._treeView.selection;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mail/components/preferences/cookies.js</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mail/components/preferences/cookies.js</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -32,17 +32,17 @@ var gCookiesWindow = {</span>
<a href="#l18.4"></a><span id="l18.4"> </span>
<a href="#l18.5"></a><span id="l18.5">   uninit() {</span>
<a href="#l18.6"></a><span id="l18.6">     Services.obs.removeObserver(this, &quot;cookie-changed&quot;);</span>
<a href="#l18.7"></a><span id="l18.7">     Services.obs.removeObserver(this, &quot;perm-changed&quot;);</span>
<a href="#l18.8"></a><span id="l18.8">   },</span>
<a href="#l18.9"></a><span id="l18.9"> </span>
<a href="#l18.10"></a><span id="l18.10">   _populateList(aInitialLoad) {</span>
<a href="#l18.11"></a><span id="l18.11">     this._loadCookies();</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-    this._tree.treeBoxObject.view = this._view;</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+    this._tree.view = this._view;</span>
<a href="#l18.14"></a><span id="l18.14">     if (aInitialLoad)</span>
<a href="#l18.15"></a><span id="l18.15">       this.sort(&quot;rawHost&quot;);</span>
<a href="#l18.16"></a><span id="l18.16">     if (this._view.rowCount &gt; 0)</span>
<a href="#l18.17"></a><span id="l18.17">       this._tree.view.selection.select(0);</span>
<a href="#l18.18"></a><span id="l18.18"> </span>
<a href="#l18.19"></a><span id="l18.19">     if (aInitialLoad) {</span>
<a href="#l18.20"></a><span id="l18.20">       if ((&quot;arguments&quot; in window) &amp;&amp; window.arguments[2] &amp;&amp;</span>
<a href="#l18.21"></a><span id="l18.21">           window.arguments[2].filterString) {</span>
<a href="#l18.22"></a><span id="l18.22" class="difflineat">@@ -74,17 +74,17 @@ var gCookiesWindow = {</span>
<a href="#l18.23"></a><span id="l18.23">       else if (aData == &quot;added&quot;)</span>
<a href="#l18.24"></a><span id="l18.24">         this._handleCookieAdded(aCookie, strippedHost);</span>
<a href="#l18.25"></a><span id="l18.25">     } else if (aData == &quot;cleared&quot;) {</span>
<a href="#l18.26"></a><span id="l18.26">       this._hosts = {};</span>
<a href="#l18.27"></a><span id="l18.27">       this._hostOrder = [];</span>
<a href="#l18.28"></a><span id="l18.28"> </span>
<a href="#l18.29"></a><span id="l18.29">       var oldRowCount = this._view._rowCount;</span>
<a href="#l18.30"></a><span id="l18.30">       this._view._rowCount = 0;</span>
<a href="#l18.31"></a><span id="l18.31" class="difflineminus">-      this._tree.treeBoxObject.rowCountChanged(0, -oldRowCount);</span>
<a href="#l18.32"></a><span id="l18.32" class="difflineplus">+      this._tree.rowCountChanged(0, -oldRowCount);</span>
<a href="#l18.33"></a><span id="l18.33">       this._view.selection.clearSelection();</span>
<a href="#l18.34"></a><span id="l18.34">     } else if (aData == &quot;reload&quot;) {</span>
<a href="#l18.35"></a><span id="l18.35">       // first, clear any existing entries</span>
<a href="#l18.36"></a><span id="l18.36">       this.observe(aCookie, aTopic, &quot;cleared&quot;);</span>
<a href="#l18.37"></a><span id="l18.37"> </span>
<a href="#l18.38"></a><span id="l18.38">       // then, reload the list</span>
<a href="#l18.39"></a><span id="l18.39">       this._populateList(false);</span>
<a href="#l18.40"></a><span id="l18.40">     }</span>
<a href="#l18.41"></a><span id="l18.41" class="difflineat">@@ -132,17 +132,17 @@ var gCookiesWindow = {</span>
<a href="#l18.42"></a><span id="l18.42">           currCookie.expires  = changedCookie.expires;</span>
<a href="#l18.43"></a><span id="l18.43">           cookieItem = currCookie;</span>
<a href="#l18.44"></a><span id="l18.44">           break;</span>
<a href="#l18.45"></a><span id="l18.45">         }</span>
<a href="#l18.46"></a><span id="l18.46">       }</span>
<a href="#l18.47"></a><span id="l18.47">     }</span>
<a href="#l18.48"></a><span id="l18.48"> </span>
<a href="#l18.49"></a><span id="l18.49">     // Make sure the tree display is up to date...</span>
<a href="#l18.50"></a><span id="l18.50" class="difflineminus">-    this._tree.treeBoxObject.invalidateRow(rowIndex);</span>
<a href="#l18.51"></a><span id="l18.51" class="difflineplus">+    this._tree.invalidateRow(rowIndex);</span>
<a href="#l18.52"></a><span id="l18.52">     // ... and if the cookie is selected, update the displayed metadata too</span>
<a href="#l18.53"></a><span id="l18.53">     if (cookieItem != null &amp;&amp; this._view.selection.currentIndex == rowIndex)</span>
<a href="#l18.54"></a><span id="l18.54">       this._updateCookieData(cookieItem);</span>
<a href="#l18.55"></a><span id="l18.55">   },</span>
<a href="#l18.56"></a><span id="l18.56"> </span>
<a href="#l18.57"></a><span id="l18.57">   _handleCookieAdded(changedCookie, strippedHost) {</span>
<a href="#l18.58"></a><span id="l18.58">     var rowCountImpact = 0;</span>
<a href="#l18.59"></a><span id="l18.59">     var addedHost = { value: 0 };</span>
<a href="#l18.60"></a><span id="l18.60" class="difflineat">@@ -161,17 +161,17 @@ var gCookiesWindow = {</span>
<a href="#l18.61"></a><span id="l18.61">         this._view._filterSet.push(this._makeCookieObject(strippedHost, changedCookie));</span>
<a href="#l18.62"></a><span id="l18.62">         ++rowCountImpact;</span>
<a href="#l18.63"></a><span id="l18.63">       }</span>
<a href="#l18.64"></a><span id="l18.64">     }</span>
<a href="#l18.65"></a><span id="l18.65">     // Now update the tree display at the end (we could/should re run the sort</span>
<a href="#l18.66"></a><span id="l18.66">     // if any to get the position correct.)</span>
<a href="#l18.67"></a><span id="l18.67">     var oldRowCount = this._rowCount;</span>
<a href="#l18.68"></a><span id="l18.68">     this._view._rowCount += rowCountImpact;</span>
<a href="#l18.69"></a><span id="l18.69" class="difflineminus">-    this._tree.treeBoxObject.rowCountChanged(oldRowCount - 1, rowCountImpact);</span>
<a href="#l18.70"></a><span id="l18.70" class="difflineplus">+    this._tree.rowCountChanged(oldRowCount - 1, rowCountImpact);</span>
<a href="#l18.71"></a><span id="l18.71"> </span>
<a href="#l18.72"></a><span id="l18.72">     document.getElementById(&quot;removeAllCookies&quot;).disabled = this._view._filtered;</span>
<a href="#l18.73"></a><span id="l18.73">   },</span>
<a href="#l18.74"></a><span id="l18.74"> </span>
<a href="#l18.75"></a><span id="l18.75">   _view: {</span>
<a href="#l18.76"></a><span id="l18.76">     _filtered: false,</span>
<a href="#l18.77"></a><span id="l18.77">     _filterSet: [],</span>
<a href="#l18.78"></a><span id="l18.78">     _filterValue: &quot;&quot;,</span>
<a href="#l18.79"></a><span id="l18.79" class="difflineat">@@ -398,18 +398,18 @@ var gCookiesWindow = {</span>
<a href="#l18.80"></a><span id="l18.80">       if (!this._filtered) {</span>
<a href="#l18.81"></a><span id="l18.81">         var item = this._getItemAtIndex(aIndex);</span>
<a href="#l18.82"></a><span id="l18.82">         if (!item) return;</span>
<a href="#l18.83"></a><span id="l18.83">         this._invalidateCache(aIndex);</span>
<a href="#l18.84"></a><span id="l18.84">         var multiplier = item.open ? -1 : 1;</span>
<a href="#l18.85"></a><span id="l18.85">         var delta = multiplier * item.cookies.length;</span>
<a href="#l18.86"></a><span id="l18.86">         this._rowCount += delta;</span>
<a href="#l18.87"></a><span id="l18.87">         item.open = !item.open;</span>
<a href="#l18.88"></a><span id="l18.88" class="difflineminus">-        gCookiesWindow._tree.treeBoxObject.rowCountChanged(aIndex + 1, delta);</span>
<a href="#l18.89"></a><span id="l18.89" class="difflineminus">-        gCookiesWindow._tree.treeBoxObject.invalidateRow(aIndex);</span>
<a href="#l18.90"></a><span id="l18.90" class="difflineplus">+        gCookiesWindow._tree.rowCountChanged(aIndex + 1, delta);</span>
<a href="#l18.91"></a><span id="l18.91" class="difflineplus">+        gCookiesWindow._tree.invalidateRow(aIndex);</span>
<a href="#l18.92"></a><span id="l18.92">       }</span>
<a href="#l18.93"></a><span id="l18.93">     },</span>
<a href="#l18.94"></a><span id="l18.94">     cycleHeader(aColumn) {},</span>
<a href="#l18.95"></a><span id="l18.95">     selectionChanged() {},</span>
<a href="#l18.96"></a><span id="l18.96">     cycleCell(aIndex, aColumn) {},</span>
<a href="#l18.97"></a><span id="l18.97">     isEditable(aIndex, aColumn) {</span>
<a href="#l18.98"></a><span id="l18.98">       return false;</span>
<a href="#l18.99"></a><span id="l18.99">     },</span>
<a href="#l18.100"></a><span id="l18.100" class="difflineat">@@ -603,17 +603,17 @@ var gCookiesWindow = {</span>
<a href="#l18.101"></a><span id="l18.101">     //    v goats.com</span>
<a href="#l18.102"></a><span id="l18.102">     //    //// goats.com /////////// flksjl33 ////</span>
<a href="#l18.103"></a><span id="l18.103">     //         goats.com             sldkkfjl</span>
<a href="#l18.104"></a><span id="l18.104">     //    &gt; atwola.com</span>
<a href="#l18.105"></a><span id="l18.105">     //</span>
<a href="#l18.106"></a><span id="l18.106">     //    Before SelectedIndex: 1   Before RowCount: 4</span>
<a href="#l18.107"></a><span id="l18.107">     //    After  SelectedIndex: 1   After  RowCount: 3</span>
<a href="#l18.108"></a><span id="l18.108">     var seln = this._view.selection;</span>
<a href="#l18.109"></a><span id="l18.109" class="difflineminus">-    var tbo = this._tree.treeBoxObject;</span>
<a href="#l18.110"></a><span id="l18.110" class="difflineplus">+    var tbo = this._tree;</span>
<a href="#l18.111"></a><span id="l18.111"> </span>
<a href="#l18.112"></a><span id="l18.112">     if (seln.count &lt; 1) return;</span>
<a href="#l18.113"></a><span id="l18.113"> </span>
<a href="#l18.114"></a><span id="l18.114">     var nextSelected = 0;</span>
<a href="#l18.115"></a><span id="l18.115">     var rowCountImpact = 0;</span>
<a href="#l18.116"></a><span id="l18.116">     var deleteItems = [];</span>
<a href="#l18.117"></a><span id="l18.117">     if (!this._view._filtered) {</span>
<a href="#l18.118"></a><span id="l18.118">       var ci = seln.currentIndex;</span>
<a href="#l18.119"></a><span id="l18.119" class="difflineat">@@ -725,36 +725,36 @@ var gCookiesWindow = {</span>
<a href="#l18.120"></a><span id="l18.120">       this._view._filterSet.sort(sortByProperty);</span>
<a href="#l18.121"></a><span id="l18.121">       if (!ascending)</span>
<a href="#l18.122"></a><span id="l18.122">         this._view._filterSet.reverse();</span>
<a href="#l18.123"></a><span id="l18.123">     }</span>
<a href="#l18.124"></a><span id="l18.124"> </span>
<a href="#l18.125"></a><span id="l18.125">     this._view._invalidateCache(0);</span>
<a href="#l18.126"></a><span id="l18.126">     this._view.selection.clearSelection();</span>
<a href="#l18.127"></a><span id="l18.127">     this._view.selection.select(0);</span>
<a href="#l18.128"></a><span id="l18.128" class="difflineminus">-    this._tree.treeBoxObject.invalidate();</span>
<a href="#l18.129"></a><span id="l18.129" class="difflineminus">-    this._tree.treeBoxObject.ensureRowIsVisible(0);</span>
<a href="#l18.130"></a><span id="l18.130" class="difflineplus">+    this._tree.invalidate();</span>
<a href="#l18.131"></a><span id="l18.131" class="difflineplus">+    this._tree.ensureRowIsVisible(0);</span>
<a href="#l18.132"></a><span id="l18.132"> </span>
<a href="#l18.133"></a><span id="l18.133">     this._lastSortAscending = ascending;</span>
<a href="#l18.134"></a><span id="l18.134">     this._lastSortProperty = aProperty;</span>
<a href="#l18.135"></a><span id="l18.135">   },</span>
<a href="#l18.136"></a><span id="l18.136"> </span>
<a href="#l18.137"></a><span id="l18.137">   clearFilter() {</span>
<a href="#l18.138"></a><span id="l18.138">     // Revert to single-select in the tree</span>
<a href="#l18.139"></a><span id="l18.139">     this._tree.setAttribute(&quot;seltype&quot;, &quot;single&quot;);</span>
<a href="#l18.140"></a><span id="l18.140"> </span>
<a href="#l18.141"></a><span id="l18.141">     // Clear the Tree Display</span>
<a href="#l18.142"></a><span id="l18.142">     this._view._filtered = false;</span>
<a href="#l18.143"></a><span id="l18.143">     this._view._rowCount = 0;</span>
<a href="#l18.144"></a><span id="l18.144" class="difflineminus">-    this._tree.treeBoxObject.rowCountChanged(0, -this._view._filterSet.length);</span>
<a href="#l18.145"></a><span id="l18.145" class="difflineplus">+    this._tree.rowCountChanged(0, -this._view._filterSet.length);</span>
<a href="#l18.146"></a><span id="l18.146">     this._view._filterSet = [];</span>
<a href="#l18.147"></a><span id="l18.147"> </span>
<a href="#l18.148"></a><span id="l18.148">     // Just reload the list to make sure deletions are respected</span>
<a href="#l18.149"></a><span id="l18.149">     this._loadCookies();</span>
<a href="#l18.150"></a><span id="l18.150" class="difflineminus">-    this._tree.treeBoxObject.view = this._view;</span>
<a href="#l18.151"></a><span id="l18.151" class="difflineplus">+    this._tree.view = this._view;</span>
<a href="#l18.152"></a><span id="l18.152"> </span>
<a href="#l18.153"></a><span id="l18.153">     // Restore sort order</span>
<a href="#l18.154"></a><span id="l18.154">     var sortby = this._lastSortProperty;</span>
<a href="#l18.155"></a><span id="l18.155">     if (sortby == &quot;&quot;) {</span>
<a href="#l18.156"></a><span id="l18.156">       this._lastSortAscending = false;</span>
<a href="#l18.157"></a><span id="l18.157">       this.sort(&quot;rawHost&quot;);</span>
<a href="#l18.158"></a><span id="l18.158">     } else {</span>
<a href="#l18.159"></a><span id="l18.159">       this._lastSortAscending = !this._lastSortAscending;</span>
<a href="#l18.160"></a><span id="l18.160" class="difflineat">@@ -835,20 +835,20 @@ var gCookiesWindow = {</span>
<a href="#l18.161"></a><span id="l18.161">       view._filtered = true;</span>
<a href="#l18.162"></a><span id="l18.162">     }</span>
<a href="#l18.163"></a><span id="l18.163">     // Move to multi-select in the tree</span>
<a href="#l18.164"></a><span id="l18.164">     gCookiesWindow._tree.setAttribute(&quot;seltype&quot;, &quot;multiple&quot;);</span>
<a href="#l18.165"></a><span id="l18.165"> </span>
<a href="#l18.166"></a><span id="l18.166">     // Clear the display</span>
<a href="#l18.167"></a><span id="l18.167">     var oldCount = view._rowCount;</span>
<a href="#l18.168"></a><span id="l18.168">     view._rowCount = 0;</span>
<a href="#l18.169"></a><span id="l18.169" class="difflineminus">-    gCookiesWindow._tree.treeBoxObject.rowCountChanged(0, -oldCount);</span>
<a href="#l18.170"></a><span id="l18.170" class="difflineplus">+    gCookiesWindow._tree.rowCountChanged(0, -oldCount);</span>
<a href="#l18.171"></a><span id="l18.171">     // Set up the filtered display</span>
<a href="#l18.172"></a><span id="l18.172">     view._rowCount = view._filterSet.length;</span>
<a href="#l18.173"></a><span id="l18.173" class="difflineminus">-    gCookiesWindow._tree.treeBoxObject.rowCountChanged(0, view.rowCount);</span>
<a href="#l18.174"></a><span id="l18.174" class="difflineplus">+    gCookiesWindow._tree.rowCountChanged(0, view.rowCount);</span>
<a href="#l18.175"></a><span id="l18.175"> </span>
<a href="#l18.176"></a><span id="l18.176">     // if the view is not empty then select the first item</span>
<a href="#l18.177"></a><span id="l18.177">     if (view.rowCount &gt; 0)</span>
<a href="#l18.178"></a><span id="l18.178">       view.selection.select(0);</span>
<a href="#l18.179"></a><span id="l18.179"> </span>
<a href="#l18.180"></a><span id="l18.180">     document.getElementById(&quot;cookiesIntro&quot;).value = gCookiesWindow._bundle.getString(&quot;cookiesFiltered&quot;);</span>
<a href="#l18.181"></a><span id="l18.181">   },</span>
<a href="#l18.182"></a><span id="l18.182"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mail/components/preferences/permissions.js</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mail/components/preferences/permissions.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -170,23 +170,23 @@ var gPermissionManager = {</span>
<a href="#l19.4"></a><span id="l19.4"> </span>
<a href="#l19.5"></a><span id="l19.5">   _handleCapabilityChange() {</span>
<a href="#l19.6"></a><span id="l19.6">     // Re-do the sort, if the status changed from Block to Allow</span>
<a href="#l19.7"></a><span id="l19.7">     // or vice versa, since if we're sorted on status, we may no</span>
<a href="#l19.8"></a><span id="l19.8">     // longer be in order.</span>
<a href="#l19.9"></a><span id="l19.9">     if (this._lastPermissionSortColumn == &quot;statusCol&quot;) {</span>
<a href="#l19.10"></a><span id="l19.10">       this._resortPermissions();</span>
<a href="#l19.11"></a><span id="l19.11">     }</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-    this._tree.treeBoxObject.invalidate();</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+    this._tree.invalidate();</span>
<a href="#l19.14"></a><span id="l19.14">   },</span>
<a href="#l19.15"></a><span id="l19.15"> </span>
<a href="#l19.16"></a><span id="l19.16">   _addPermission(aPermission) {</span>
<a href="#l19.17"></a><span id="l19.17">     this._addPermissionToList(aPermission);</span>
<a href="#l19.18"></a><span id="l19.18">     ++this._view._rowCount;</span>
<a href="#l19.19"></a><span id="l19.19" class="difflineminus">-    this._tree.treeBoxObject.rowCountChanged(this._view.rowCount - 1, 1);</span>
<a href="#l19.20"></a><span id="l19.20" class="difflineplus">+    this._tree.rowCountChanged(this._view.rowCount - 1, 1);</span>
<a href="#l19.21"></a><span id="l19.21">     // Re-do the sort, since we inserted this new item at the end.</span>
<a href="#l19.22"></a><span id="l19.22">     this._resortPermissions();</span>
<a href="#l19.23"></a><span id="l19.23">   },</span>
<a href="#l19.24"></a><span id="l19.24"> </span>
<a href="#l19.25"></a><span id="l19.25">   _resortPermissions() {</span>
<a href="#l19.26"></a><span id="l19.26">     gTreeUtils.sort(this._tree, this._view, this._permissions,</span>
<a href="#l19.27"></a><span id="l19.27">                     this._lastPermissionSortColumn,</span>
<a href="#l19.28"></a><span id="l19.28">                     this._permissionsComparator,</span>
<a href="#l19.29"></a><span id="l19.29" class="difflineat">@@ -413,18 +413,18 @@ var gPermissionManager = {</span>
<a href="#l19.30"></a><span id="l19.30">   },</span>
<a href="#l19.31"></a><span id="l19.31"> </span>
<a href="#l19.32"></a><span id="l19.32">   _removePermissionFromList(aPrincipal) {</span>
<a href="#l19.33"></a><span id="l19.33">     for (let i = 0; i &lt; this._permissions.length; ++i) {</span>
<a href="#l19.34"></a><span id="l19.34">       // Thunderbird compares origins, not principals here.</span>
<a href="#l19.35"></a><span id="l19.35">       if (this._permissions[i].principal.origin == aPrincipal.origin) {</span>
<a href="#l19.36"></a><span id="l19.36">         this._permissions.splice(i, 1);</span>
<a href="#l19.37"></a><span id="l19.37">         this._view._rowCount--;</span>
<a href="#l19.38"></a><span id="l19.38" class="difflineminus">-        this._tree.treeBoxObject.rowCountChanged(this._view.rowCount - 1, -1);</span>
<a href="#l19.39"></a><span id="l19.39" class="difflineminus">-        this._tree.treeBoxObject.invalidate();</span>
<a href="#l19.40"></a><span id="l19.40" class="difflineplus">+        this._tree.rowCountChanged(this._view.rowCount - 1, -1);</span>
<a href="#l19.41"></a><span id="l19.41" class="difflineplus">+        this._tree.invalidate();</span>
<a href="#l19.42"></a><span id="l19.42">         break;</span>
<a href="#l19.43"></a><span id="l19.43">       }</span>
<a href="#l19.44"></a><span id="l19.44">     }</span>
<a href="#l19.45"></a><span id="l19.45">   },</span>
<a href="#l19.46"></a><span id="l19.46"> </span>
<a href="#l19.47"></a><span id="l19.47">   setOrigin(aOrigin) {</span>
<a href="#l19.48"></a><span id="l19.48">     document.getElementById(&quot;url&quot;).value = aOrigin;</span>
<a href="#l19.49"></a><span id="l19.49">   },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-right-click-middle-click-messages.js</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-right-click-middle-click-messages.js</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -315,22 +315,22 @@ function _middle_click_on_existing_multi</span>
<a href="#l20.4"></a><span id="l20.4">  */</span>
<a href="#l20.5"></a><span id="l20.5"> function _middle_click_on_collapsed_thread_root_helper(aBackground) {</span>
<a href="#l20.6"></a><span id="l20.6">   be_in_folder(threadedFolder);</span>
<a href="#l20.7"></a><span id="l20.7">   make_display_threaded();</span>
<a href="#l20.8"></a><span id="l20.8">   collapse_all_threads();</span>
<a href="#l20.9"></a><span id="l20.9"> </span>
<a href="#l20.10"></a><span id="l20.10">   let folderTab = mc.tabmail.currentTabInfo;</span>
<a href="#l20.11"></a><span id="l20.11"> </span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-  let treeBox = mc.threadTree.treeBoxObject;</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineplus">+  let tree = mc.threadTree;</span>
<a href="#l20.14"></a><span id="l20.14">   // Scroll to the top, then to the bottom</span>
<a href="#l20.15"></a><span id="l20.15" class="difflineminus">-  treeBox.ensureRowIsVisible(0);</span>
<a href="#l20.16"></a><span id="l20.16" class="difflineminus">-  treeBox.scrollByLines(mc.folderDisplay.view.dbView.rowCount);</span>
<a href="#l20.17"></a><span id="l20.17" class="difflineplus">+  tree.ensureRowIsVisible(0);</span>
<a href="#l20.18"></a><span id="l20.18" class="difflineplus">+  tree.scrollByLines(mc.folderDisplay.view.dbView.rowCount);</span>
<a href="#l20.19"></a><span id="l20.19">   // Note the first visible row</span>
<a href="#l20.20"></a><span id="l20.20" class="difflineminus">-  let preFirstRow = treeBox.getFirstVisibleRow();</span>
<a href="#l20.21"></a><span id="l20.21" class="difflineplus">+  let preFirstRow = tree.getFirstVisibleRow();</span>
<a href="#l20.22"></a><span id="l20.22"> </span>
<a href="#l20.23"></a><span id="l20.23">   // Since reflowing a tree (eg when switching tabs) ensures that the current</span>
<a href="#l20.24"></a><span id="l20.24">   // index is brought into view, we need to set the current index so that we</span>
<a href="#l20.25"></a><span id="l20.25">   // don't scroll because of it. So click on the first visible row.</span>
<a href="#l20.26"></a><span id="l20.26">   select_click_row(preFirstRow);</span>
<a href="#l20.27"></a><span id="l20.27"> </span>
<a href="#l20.28"></a><span id="l20.28">   // Middle-click on the root of the collapsed thread, which is also the last</span>
<a href="#l20.29"></a><span id="l20.29">   // row</span>
<a href="#l20.30"></a><span id="l20.30" class="difflineat">@@ -339,41 +339,41 @@ function _middle_click_on_collapsed_thre</span>
<a href="#l20.31"></a><span id="l20.31"> </span>
<a href="#l20.32"></a><span id="l20.32">   if (!aBackground) {</span>
<a href="#l20.33"></a><span id="l20.33">     wait_for_message_display_completion();</span>
<a href="#l20.34"></a><span id="l20.34">     // Switch back to the folder tab</span>
<a href="#l20.35"></a><span id="l20.35">     switch_tab(folderTab);</span>
<a href="#l20.36"></a><span id="l20.36">   }</span>
<a href="#l20.37"></a><span id="l20.37"> </span>
<a href="#l20.38"></a><span id="l20.38">   // Make sure the first visible row is still the same</span>
<a href="#l20.39"></a><span id="l20.39" class="difflineminus">-  if (treeBox.getFirstVisibleRow() != preFirstRow)</span>
<a href="#l20.40"></a><span id="l20.40" class="difflineplus">+  if (tree.getFirstVisibleRow() != preFirstRow)</span>
<a href="#l20.41"></a><span id="l20.41">     throw new Error(&quot;The first visible row should have been &quot; + preFirstRow +</span>
<a href="#l20.42"></a><span id="l20.42" class="difflineminus">-        &quot;, but is actually &quot; + treeBox.getFirstVisibleRow() + &quot;.&quot;);</span>
<a href="#l20.43"></a><span id="l20.43" class="difflineplus">+        &quot;, but is actually &quot; + tree.getFirstVisibleRow() + &quot;.&quot;);</span>
<a href="#l20.44"></a><span id="l20.44"> </span>
<a href="#l20.45"></a><span id="l20.45">   close_tab(tabMessage);</span>
<a href="#l20.46"></a><span id="l20.46"> }</span>
<a href="#l20.47"></a><span id="l20.47"> </span>
<a href="#l20.48"></a><span id="l20.48"> /**</span>
<a href="#l20.49"></a><span id="l20.49">  * Middle-click on the root of an expanded thread, making sure that we don't</span>
<a href="#l20.50"></a><span id="l20.50">  * jump around in the thread tree.</span>
<a href="#l20.51"></a><span id="l20.51">  */</span>
<a href="#l20.52"></a><span id="l20.52"> function _middle_click_on_expanded_thread_root_helper(aBackground) {</span>
<a href="#l20.53"></a><span id="l20.53">   be_in_folder(threadedFolder);</span>
<a href="#l20.54"></a><span id="l20.54">   make_display_threaded();</span>
<a href="#l20.55"></a><span id="l20.55">   expand_all_threads();</span>
<a href="#l20.56"></a><span id="l20.56"> </span>
<a href="#l20.57"></a><span id="l20.57">   let folderTab = mc.tabmail.currentTabInfo;</span>
<a href="#l20.58"></a><span id="l20.58"> </span>
<a href="#l20.59"></a><span id="l20.59" class="difflineminus">-  let treeBox = mc.threadTree.treeBoxObject;</span>
<a href="#l20.60"></a><span id="l20.60" class="difflineplus">+  let tree = mc.threadTree;</span>
<a href="#l20.61"></a><span id="l20.61">   // Scroll to the top, then to near (but not exactly) the bottom</span>
<a href="#l20.62"></a><span id="l20.62" class="difflineminus">-  treeBox.ensureRowIsVisible(0);</span>
<a href="#l20.63"></a><span id="l20.63" class="difflineminus">-  treeBox.scrollToRow(mc.folderDisplay.view.dbView.rowCount -</span>
<a href="#l20.64"></a><span id="l20.64" class="difflineminus">-      treeBox.getPageLength() - (NUM_MESSAGES_IN_THREAD / 2));</span>
<a href="#l20.65"></a><span id="l20.65" class="difflineplus">+  tree.ensureRowIsVisible(0);</span>
<a href="#l20.66"></a><span id="l20.66" class="difflineplus">+  tree.scrollToRow(mc.folderDisplay.view.dbView.rowCount -</span>
<a href="#l20.67"></a><span id="l20.67" class="difflineplus">+      tree.getPageLength() - (NUM_MESSAGES_IN_THREAD / 2));</span>
<a href="#l20.68"></a><span id="l20.68">   // Note the first visible row</span>
<a href="#l20.69"></a><span id="l20.69" class="difflineminus">-  let preFirstRow = treeBox.getFirstVisibleRow();</span>
<a href="#l20.70"></a><span id="l20.70" class="difflineplus">+  let preFirstRow = tree.getFirstVisibleRow();</span>
<a href="#l20.71"></a><span id="l20.71"> </span>
<a href="#l20.72"></a><span id="l20.72">   // Since reflowing a tree (eg when switching tabs) ensures that the current</span>
<a href="#l20.73"></a><span id="l20.73">   // index is brought into view, we need to set the current index so that we</span>
<a href="#l20.74"></a><span id="l20.74">   // don't scroll because of it. So click on the first visible row.</span>
<a href="#l20.75"></a><span id="l20.75">   select_click_row(preFirstRow);</span>
<a href="#l20.76"></a><span id="l20.76"> </span>
<a href="#l20.77"></a><span id="l20.77">   // Middle-click on the root of the expanded thread, which is the row with</span>
<a href="#l20.78"></a><span id="l20.78">   // index (number of rows - number of messages in thread).</span>
<a href="#l20.79"></a><span id="l20.79" class="difflineat">@@ -382,19 +382,19 @@ function _middle_click_on_expanded_threa</span>
<a href="#l20.80"></a><span id="l20.80"> </span>
<a href="#l20.81"></a><span id="l20.81">   if (!aBackground) {</span>
<a href="#l20.82"></a><span id="l20.82">     wait_for_message_display_completion();</span>
<a href="#l20.83"></a><span id="l20.83">     // Switch back to the folder tab</span>
<a href="#l20.84"></a><span id="l20.84">     switch_tab(folderTab);</span>
<a href="#l20.85"></a><span id="l20.85">   }</span>
<a href="#l20.86"></a><span id="l20.86"> </span>
<a href="#l20.87"></a><span id="l20.87">   // Make sure the first visible row is still the same</span>
<a href="#l20.88"></a><span id="l20.88" class="difflineminus">-  if (treeBox.getFirstVisibleRow() != preFirstRow)</span>
<a href="#l20.89"></a><span id="l20.89" class="difflineplus">+  if (tree.getFirstVisibleRow() != preFirstRow)</span>
<a href="#l20.90"></a><span id="l20.90">     throw new Error(&quot;The first visible row should have been &quot; + preFirstRow +</span>
<a href="#l20.91"></a><span id="l20.91" class="difflineminus">-        &quot;, but is actually &quot; + treeBox.getFirstVisibleRow() + &quot;.&quot;);</span>
<a href="#l20.92"></a><span id="l20.92" class="difflineplus">+        &quot;, but is actually &quot; + tree.getFirstVisibleRow() + &quot;.&quot;);</span>
<a href="#l20.93"></a><span id="l20.93"> </span>
<a href="#l20.94"></a><span id="l20.94">   close_tab(tabMessage);</span>
<a href="#l20.95"></a><span id="l20.95"> }</span>
<a href="#l20.96"></a><span id="l20.96"> </span>
<a href="#l20.97"></a><span id="l20.97"> /**</span>
<a href="#l20.98"></a><span id="l20.98">  * Generate background and foreground tests for each middle click test.</span>
<a href="#l20.99"></a><span id="l20.99">  *</span>
<a href="#l20.100"></a><span id="l20.100">  * @param aTests an array of test names</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-folder-display-helpers.js</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-folder-display-helpers.js</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -956,21 +956,21 @@ function _normalize_view_index(aViewInde</span>
<a href="#l21.4"></a><span id="l21.4">  * @param aController  Controller object</span>
<a href="#l21.5"></a><span id="l21.5">  */</span>
<a href="#l21.6"></a><span id="l21.6"> function click_tree_row(aTree, aRowIndex, aController) {</span>
<a href="#l21.7"></a><span id="l21.7">   if (aRowIndex &lt; 0 || aRowIndex &gt;= aTree.view.rowCount)</span>
<a href="#l21.8"></a><span id="l21.8">     throw new Error(&quot;Row &quot; + aRowIndex + &quot; does not exist in the tree &quot; + aTree.id + &quot;!&quot;);</span>
<a href="#l21.9"></a><span id="l21.9"> </span>
<a href="#l21.10"></a><span id="l21.10">   let selection = aTree.view.selection;</span>
<a href="#l21.11"></a><span id="l21.11">   selection.select(aRowIndex);</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-  aTree.treeBoxObject.ensureRowIsVisible(aRowIndex);</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+  aTree.ensureRowIsVisible(aRowIndex);</span>
<a href="#l21.14"></a><span id="l21.14"> </span>
<a href="#l21.15"></a><span id="l21.15">   // get cell coordinates</span>
<a href="#l21.16"></a><span id="l21.16">   let column = aTree.columns[0];</span>
<a href="#l21.17"></a><span id="l21.17" class="difflineminus">-  let coords = aTree.treeBoxObject.getCoordsForCellItem(aRowIndex, column, &quot;text&quot;);</span>
<a href="#l21.18"></a><span id="l21.18" class="difflineplus">+  let coords = aTree.getCoordsForCellItem(aRowIndex, column, &quot;text&quot;);</span>
<a href="#l21.19"></a><span id="l21.19"> </span>
<a href="#l21.20"></a><span id="l21.20">   aController.sleep(0);</span>
<a href="#l21.21"></a><span id="l21.21">   EventUtils.synthesizeMouse(aTree.body, coords.x + 4, coords.y + 4,</span>
<a href="#l21.22"></a><span id="l21.22">                              {}, aTree.ownerDocument.defaultView);</span>
<a href="#l21.23"></a><span id="l21.23">   aController.sleep(0);</span>
<a href="#l21.24"></a><span id="l21.24"> }</span>
<a href="#l21.25"></a><span id="l21.25"> </span>
<a href="#l21.26"></a><span id="l21.26"> /**</span>
<a href="#l21.27"></a><span id="l21.27" class="difflineat">@@ -1093,19 +1093,18 @@ function select_shift_click_row(aViewInd</span>
<a href="#l21.28"></a><span id="l21.28"> }</span>
<a href="#l21.29"></a><span id="l21.29"> </span>
<a href="#l21.30"></a><span id="l21.30"> /**</span>
<a href="#l21.31"></a><span id="l21.31">  * Helper function to click on a row with a given button.</span>
<a href="#l21.32"></a><span id="l21.32">  */</span>
<a href="#l21.33"></a><span id="l21.33"> function _row_click_helper(aController, aTree, aViewIndex, aButton, aExtra) {</span>
<a href="#l21.34"></a><span id="l21.34">   // Force-focus the tree</span>
<a href="#l21.35"></a><span id="l21.35">   aTree.focus();</span>
<a href="#l21.36"></a><span id="l21.36" class="difflineminus">-  let treeBox = aTree.treeBoxObject;</span>
<a href="#l21.37"></a><span id="l21.37">   // very important, gotta be able to see the row</span>
<a href="#l21.38"></a><span id="l21.38" class="difflineminus">-  treeBox.ensureRowIsVisible(aViewIndex);</span>
<a href="#l21.39"></a><span id="l21.39" class="difflineplus">+  aTree.ensureRowIsVisible(aViewIndex);</span>
<a href="#l21.40"></a><span id="l21.40">   // coordinates of the upper left of the entire tree widget (headers included)</span>
<a href="#l21.41"></a><span id="l21.41">   let tx = aTree.boxObject.x, ty = aTree.boxObject.y;</span>
<a href="#l21.42"></a><span id="l21.42">   // coordinates of the row display region of the tree (below the headers)</span>
<a href="#l21.43"></a><span id="l21.43">   let children = aController.e(aTree.id, {tagName: &quot;treechildren&quot;});</span>
<a href="#l21.44"></a><span id="l21.44">   let x = children.boxObject.x, y = children.boxObject.y;</span>
<a href="#l21.45"></a><span id="l21.45">   // Click in the middle of the row by default</span>
<a href="#l21.46"></a><span id="l21.46">   let rowX = children.boxObject.width / 2;</span>
<a href="#l21.47"></a><span id="l21.47">   // For the thread tree, Position our click on the subject column (which cannot</span>
<a href="#l21.48"></a><span id="l21.48" class="difflineat">@@ -1113,22 +1112,22 @@ function _row_click_helper(aController, </span>
<a href="#l21.49"></a><span id="l21.49">   // expand toggler unless that is explicitly requested.</span>
<a href="#l21.50"></a><span id="l21.50">   if (aTree.id == &quot;threadTree&quot;) {</span>
<a href="#l21.51"></a><span id="l21.51">     let subjectCol = aController.e(&quot;subjectCol&quot;);</span>
<a href="#l21.52"></a><span id="l21.52">     rowX = subjectCol.boxObject.x - tx + 8;</span>
<a href="#l21.53"></a><span id="l21.53">     // click on the toggle if so requested</span>
<a href="#l21.54"></a><span id="l21.54">     if (aExtra !== &quot;toggle&quot;)</span>
<a href="#l21.55"></a><span id="l21.55">       rowX += 32;</span>
<a href="#l21.56"></a><span id="l21.56">   }</span>
<a href="#l21.57"></a><span id="l21.57" class="difflineminus">-  let rowY = treeBox.rowHeight * (aViewIndex - treeBox.getFirstVisibleRow()) +</span>
<a href="#l21.58"></a><span id="l21.58" class="difflineminus">-    treeBox.rowHeight / 2;</span>
<a href="#l21.59"></a><span id="l21.59" class="difflineminus">-  if (treeBox.getRowAt(x + rowX, y + rowY) != aViewIndex) {</span>
<a href="#l21.60"></a><span id="l21.60" class="difflineplus">+  let rowY = aTree.rowHeight * (aViewIndex - aTree.getFirstVisibleRow()) +</span>
<a href="#l21.61"></a><span id="l21.61" class="difflineplus">+    aTree.rowHeight / 2;</span>
<a href="#l21.62"></a><span id="l21.62" class="difflineplus">+  if (aTree.getRowAt(x + rowX, y + rowY) != aViewIndex) {</span>
<a href="#l21.63"></a><span id="l21.63">     throw new Error(&quot;Thought we would find row &quot; + aViewIndex + &quot; at &quot; +</span>
<a href="#l21.64"></a><span id="l21.64">                     rowX + &quot;,&quot; + rowY + &quot; but we found &quot; +</span>
<a href="#l21.65"></a><span id="l21.65" class="difflineminus">-                    treeBox.getRowAt(rowX, rowY));</span>
<a href="#l21.66"></a><span id="l21.66" class="difflineplus">+                    aTree.getRowAt(rowX, rowY));</span>
<a href="#l21.67"></a><span id="l21.67">   }</span>
<a href="#l21.68"></a><span id="l21.68">   // Generate a mouse-down for all click types; the transient selection</span>
<a href="#l21.69"></a><span id="l21.69">   // logic happens on mousedown which our tests assume is happening.  (If you</span>
<a href="#l21.70"></a><span id="l21.70">   // are using a keybinding to trigger the event, that will not happen, but</span>
<a href="#l21.71"></a><span id="l21.71">   // we don't test that.)</span>
<a href="#l21.72"></a><span id="l21.72">   EventUtils.synthesizeMouse(aTree, x + rowX - tx, y + rowY - ty,</span>
<a href="#l21.73"></a><span id="l21.73">                              {type: &quot;mousedown&quot;, button: aButton,</span>
<a href="#l21.74"></a><span id="l21.74">                               shiftKey: aExtra === &quot;shift&quot;,</span>
<a href="#l21.75"></a><span id="l21.75" class="difflineat">@@ -1184,20 +1183,20 @@ function middle_click_on_row(aViewIndex)</span>
<a href="#l21.76"></a><span id="l21.76">   return [mc.tabmail.tabInfo[mc.tabmail.tabContainer.childNodes.length - 1],</span>
<a href="#l21.77"></a><span id="l21.77">           msgHdr];</span>
<a href="#l21.78"></a><span id="l21.78"> }</span>
<a href="#l21.79"></a><span id="l21.79"> </span>
<a href="#l21.80"></a><span id="l21.80"> /**</span>
<a href="#l21.81"></a><span id="l21.81">  * Assert that the given row index is currently visible in the thread pane view.</span>
<a href="#l21.82"></a><span id="l21.82">  */</span>
<a href="#l21.83"></a><span id="l21.83"> function assert_row_visible(aViewIndex) {</span>
<a href="#l21.84"></a><span id="l21.84" class="difflineminus">-  let treeBox = mc.threadTree.treeBoxObject;</span>
<a href="#l21.85"></a><span id="l21.85" class="difflineplus">+  let tree = mc.threadTree;</span>
<a href="#l21.86"></a><span id="l21.86"> </span>
<a href="#l21.87"></a><span id="l21.87" class="difflineminus">-  if (treeBox.getFirstVisibleRow() &gt; aViewIndex ||</span>
<a href="#l21.88"></a><span id="l21.88" class="difflineminus">-      treeBox.getLastVisibleRow() &lt; aViewIndex)</span>
<a href="#l21.89"></a><span id="l21.89" class="difflineplus">+  if (tree.getFirstVisibleRow() &gt; aViewIndex ||</span>
<a href="#l21.90"></a><span id="l21.90" class="difflineplus">+      tree.getLastVisibleRow() &lt; aViewIndex)</span>
<a href="#l21.91"></a><span id="l21.91">     throw new Error(&quot;Row &quot; + aViewIndex + &quot; should currently be visible in &quot; +</span>
<a href="#l21.92"></a><span id="l21.92">                     &quot;the thread pane, but isn't.&quot;);</span>
<a href="#l21.93"></a><span id="l21.93"> }</span>
<a href="#l21.94"></a><span id="l21.94"> </span>
<a href="#l21.95"></a><span id="l21.95"> /**</span>
<a href="#l21.96"></a><span id="l21.96">  * Assert that the given folder mode is the current one.</span>
<a href="#l21.97"></a><span id="l21.97">  *</span>
<a href="#l21.98"></a><span id="l21.98">  * @param aMode The expected folder mode.</span>
<a href="#l21.99"></a><span id="l21.99" class="difflineat">@@ -2222,22 +2221,22 @@ var assert_nothing_selected = assert_sel</span>
<a href="#l21.100"></a><span id="l21.100">  * Assert that the given view index or message is visible in the thread pane.</span>
<a href="#l21.101"></a><span id="l21.101">  */</span>
<a href="#l21.102"></a><span id="l21.102"> function assert_visible(aViewIndexOrMessage) {</span>
<a href="#l21.103"></a><span id="l21.103">   let viewIndex;</span>
<a href="#l21.104"></a><span id="l21.104">   if (typeof(aViewIndexOrMessage) == &quot;number&quot;)</span>
<a href="#l21.105"></a><span id="l21.105">     viewIndex = _normalize_view_index(aViewIndexOrMessage);</span>
<a href="#l21.106"></a><span id="l21.106">   else</span>
<a href="#l21.107"></a><span id="l21.107">     viewIndex = mc.dbView.findIndexOfMsgHdr(aViewIndexOrMessage, false);</span>
<a href="#l21.108"></a><span id="l21.108" class="difflineminus">-  let treeBox = mc.threadTree.boxObject;</span>
<a href="#l21.109"></a><span id="l21.109" class="difflineminus">-  if (viewIndex &lt; treeBox.getFirstVisibleRow() ||</span>
<a href="#l21.110"></a><span id="l21.110" class="difflineminus">-      viewIndex &gt; treeBox.getLastVisibleRow())</span>
<a href="#l21.111"></a><span id="l21.111" class="difflineplus">+  let tree = mc.threadTree;</span>
<a href="#l21.112"></a><span id="l21.112" class="difflineplus">+  if (viewIndex &lt; tree.getFirstVisibleRow() ||</span>
<a href="#l21.113"></a><span id="l21.113" class="difflineplus">+      viewIndex &gt; tree.getLastVisibleRow())</span>
<a href="#l21.114"></a><span id="l21.114">     throw new Error(&quot;View index &quot; + viewIndex + &quot; is not visible! (&quot; +</span>
<a href="#l21.115"></a><span id="l21.115" class="difflineminus">-                    treeBox.getFirstVisibleRow() + &quot;-&quot; +</span>
<a href="#l21.116"></a><span id="l21.116" class="difflineminus">-                    treeBox.getLastVisibleRow() + &quot; are visible)&quot;);</span>
<a href="#l21.117"></a><span id="l21.117" class="difflineplus">+                    tree.getFirstVisibleRow() + &quot;-&quot; +</span>
<a href="#l21.118"></a><span id="l21.118" class="difflineplus">+                    tree.getLastVisibleRow() + &quot; are visible)&quot;);</span>
<a href="#l21.119"></a><span id="l21.119"> }</span>
<a href="#l21.120"></a><span id="l21.120"> </span>
<a href="#l21.121"></a><span id="l21.121"> /**</span>
<a href="#l21.122"></a><span id="l21.122">  * Assert that the given message is now shown in the current view.</span>
<a href="#l21.123"></a><span id="l21.123">  */</span>
<a href="#l21.124"></a><span id="l21.124"> function assert_not_shown(aMessages) {</span>
<a href="#l21.125"></a><span id="l21.125">   aMessages.forEach(function(msg) {</span>
<a href="#l21.126"></a><span id="l21.126">     let viewIndex = mc.dbView.findIndexOfMsgHdr(msg, false);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mailnews/addrbook/content/abResultsPane.js</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mailnews/addrbook/content/abResultsPane.js</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -71,17 +71,17 @@ function SetAbView(aURI)</span>
<a href="#l22.4"></a><span id="l22.4"> </span>
<a href="#l22.5"></a><span id="l22.5">   if (!gAbView)</span>
<a href="#l22.6"></a><span id="l22.6">     gAbView = Cc[&quot;@mozilla.org/addressbook/abview;1&quot;]</span>
<a href="#l22.7"></a><span id="l22.7">                 .createInstance(Ci.nsIAbView);</span>
<a href="#l22.8"></a><span id="l22.8"> </span>
<a href="#l22.9"></a><span id="l22.9">   var actualSortColumn = gAbView.setView(directory, GetAbViewListener(),</span>
<a href="#l22.10"></a><span id="l22.10">                                          sortColumn, sortDirection);</span>
<a href="#l22.11"></a><span id="l22.11"> </span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-  gAbResultsTree.treeBoxObject.view =</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineplus">+  gAbResultsTree.view =</span>
<a href="#l22.14"></a><span id="l22.14">     gAbView.QueryInterface(Ci.nsITreeView);</span>
<a href="#l22.15"></a><span id="l22.15"> </span>
<a href="#l22.16"></a><span id="l22.16">   UpdateSortIndicators(actualSortColumn, sortDirection);</span>
<a href="#l22.17"></a><span id="l22.17"> </span>
<a href="#l22.18"></a><span id="l22.18">   // If the selected address book is LDAP and the search box is empty,</span>
<a href="#l22.19"></a><span id="l22.19">   // inform the user of the empty results pane.</span>
<a href="#l22.20"></a><span id="l22.20">   let abResultsTree = document.getElementById(&quot;abResultsTree&quot;);</span>
<a href="#l22.21"></a><span id="l22.21">   let cardViewOuterBox = document.getElementById(&quot;CardViewOuterBox&quot;);</span>
<a href="#l22.22"></a><span id="l22.22" class="difflineat">@@ -284,18 +284,17 @@ function AbResultsPaneOnClick(event)</span>
<a href="#l22.23"></a><span id="l22.23">     // Revert the sort order. If none is set, use Ascending.</span>
<a href="#l22.24"></a><span id="l22.24">     sortDirection = currentDirection == kDefaultAscending ?</span>
<a href="#l22.25"></a><span id="l22.25">                                         kDefaultDescending : kDefaultAscending;</span>
<a href="#l22.26"></a><span id="l22.26"> </span>
<a href="#l22.27"></a><span id="l22.27">     SortAndUpdateIndicators(t.id, sortDirection);</span>
<a href="#l22.28"></a><span id="l22.28">   }</span>
<a href="#l22.29"></a><span id="l22.29">   else if (t.localName == &quot;treechildren&quot;) {</span>
<a href="#l22.30"></a><span id="l22.30">     // figure out what row the click was in</span>
<a href="#l22.31"></a><span id="l22.31" class="difflineminus">-    var row = gAbResultsTree.treeBoxObject.getRowAt(event.clientX,</span>
<a href="#l22.32"></a><span id="l22.32" class="difflineminus">-                                                    event.clientY);</span>
<a href="#l22.33"></a><span id="l22.33" class="difflineplus">+    var row = gAbResultsTree.getRowAt(event.clientX, event.clientY);</span>
<a href="#l22.34"></a><span id="l22.34">     if (row == -1)</span>
<a href="#l22.35"></a><span id="l22.35">       return;</span>
<a href="#l22.36"></a><span id="l22.36"> </span>
<a href="#l22.37"></a><span id="l22.37">     if (event.detail == 2)</span>
<a href="#l22.38"></a><span id="l22.38">       AbResultsPaneDoubleClick(gAbView.getCardFromRow(row));</span>
<a href="#l22.39"></a><span id="l22.39">   }</span>
<a href="#l22.40"></a><span id="l22.40"> }</span>
<a href="#l22.41"></a><span id="l22.41"> </span>
<a href="#l22.42"></a><span id="l22.42" class="difflineat">@@ -349,17 +348,17 @@ function UpdateSortIndicators(colID, sor</span>
<a href="#l22.43"></a><span id="l22.43">       currCol.removeAttribute(&quot;sortDirection&quot;);</span>
<a href="#l22.44"></a><span id="l22.44">     currCol = currCol.nextSibling;</span>
<a href="#l22.45"></a><span id="l22.45">   }</span>
<a href="#l22.46"></a><span id="l22.46"> }</span>
<a href="#l22.47"></a><span id="l22.47"> </span>
<a href="#l22.48"></a><span id="l22.48"> function InvalidateResultsPane()</span>
<a href="#l22.49"></a><span id="l22.49"> {</span>
<a href="#l22.50"></a><span id="l22.50">   if (gAbResultsTree)</span>
<a href="#l22.51"></a><span id="l22.51" class="difflineminus">-    gAbResultsTree.treeBoxObject.invalidate();</span>
<a href="#l22.52"></a><span id="l22.52" class="difflineplus">+    gAbResultsTree.invalidate();</span>
<a href="#l22.53"></a><span id="l22.53"> }</span>
<a href="#l22.54"></a><span id="l22.54"> </span>
<a href="#l22.55"></a><span id="l22.55"> // Controller object for Results Pane</span>
<a href="#l22.56"></a><span id="l22.56"> var ResultsPaneController =</span>
<a href="#l22.57"></a><span id="l22.57"> {</span>
<a href="#l22.58"></a><span id="l22.58">   supportsCommand: function(command)</span>
<a href="#l22.59"></a><span id="l22.59">   {</span>
<a href="#l22.60"></a><span id="l22.60">     switch (command) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mailnews/base/content/msgSelectOfflineFolders.js</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mailnews/base/content/msgSelectOfflineFolders.js</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -63,25 +63,22 @@ var gSelectOffline = {</span>
<a href="#l23.4"></a><span id="l23.4">     }</span>
<a href="#l23.5"></a><span id="l23.5">   },</span>
<a href="#l23.6"></a><span id="l23.6"> </span>
<a href="#l23.7"></a><span id="l23.7">   onClick: function(aEvent) {</span>
<a href="#l23.8"></a><span id="l23.8">     // We only care about button 0 (left click) events.</span>
<a href="#l23.9"></a><span id="l23.9">     if (aEvent.button != 0)</span>
<a href="#l23.10"></a><span id="l23.10">       return;</span>
<a href="#l23.11"></a><span id="l23.11"> </span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-    let row = {};</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineminus">-    let col = {};</span>
<a href="#l23.14"></a><span id="l23.14" class="difflineminus">-    this._treeElement.treeBoxObject</span>
<a href="#l23.15"></a><span id="l23.15" class="difflineminus">-        .getCellAt(aEvent.clientX, aEvent.clientY, row, col, {});</span>
<a href="#l23.16"></a><span id="l23.16" class="difflineplus">+    let treeCellInfo = this._treeElement.getCellAt(aEvent.clientX);</span>
<a href="#l23.17"></a><span id="l23.17"> </span>
<a href="#l23.18"></a><span id="l23.18" class="difflineminus">-    if (row.value == -1 || col.value.id != &quot;syncCol&quot;)</span>
<a href="#l23.19"></a><span id="l23.19" class="difflineplus">+    if (treeCellInfo.row == -1 || treeCellInfo.col.id != &quot;syncCol&quot;)</span>
<a href="#l23.20"></a><span id="l23.20">       return;</span>
<a href="#l23.21"></a><span id="l23.21"> </span>
<a href="#l23.22"></a><span id="l23.22" class="difflineminus">-    this._toggle(row.value);</span>
<a href="#l23.23"></a><span id="l23.23" class="difflineplus">+    this._toggle(treeCellInfo.row);</span>
<a href="#l23.24"></a><span id="l23.24">   },</span>
<a href="#l23.25"></a><span id="l23.25"> </span>
<a href="#l23.26"></a><span id="l23.26">   _toggle: function(aRow) {</span>
<a href="#l23.27"></a><span id="l23.27">     let folder = gFolderTreeView._rowMap[aRow]._folder;</span>
<a href="#l23.28"></a><span id="l23.28"> </span>
<a href="#l23.29"></a><span id="l23.29">     if (folder.isServer)</span>
<a href="#l23.30"></a><span id="l23.30">       return;</span>
<a href="#l23.31"></a><span id="l23.31"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mailnews/base/content/msgSynchronize.js</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mailnews/base/content/msgSynchronize.js</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -123,29 +123,25 @@ function FindInWindow(currentWindow, id)</span>
<a href="#l24.4"></a><span id="l24.4"> </span>
<a href="#l24.5"></a><span id="l24.5"> </span>
<a href="#l24.6"></a><span id="l24.6"> function onSynchronizeClick(event)</span>
<a href="#l24.7"></a><span id="l24.7"> {</span>
<a href="#l24.8"></a><span id="l24.8">     // we only care about button 0 (left click) events</span>
<a href="#l24.9"></a><span id="l24.9">     if (event.button != 0)</span>
<a href="#l24.10"></a><span id="l24.10">       return;</span>
<a href="#l24.11"></a><span id="l24.11"> </span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-    var row = {}</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineminus">-    var col = {}</span>
<a href="#l24.14"></a><span id="l24.14" class="difflineminus">-    var elt = {}</span>
<a href="#l24.15"></a><span id="l24.15" class="difflineminus">-</span>
<a href="#l24.16"></a><span id="l24.16" class="difflineminus">-    gSynchronizeTree.treeBoxObject.getCellAt(event.clientX, event.clientY, row, col, elt);</span>
<a href="#l24.17"></a><span id="l24.17" class="difflineminus">-    if (row.value == -1)</span>
<a href="#l24.18"></a><span id="l24.18" class="difflineplus">+    let treeCellInfo = gSynchronizeTree.getCellAt(event.clientX, event.clientY);</span>
<a href="#l24.19"></a><span id="l24.19" class="difflineplus">+    if (treeCellInfo.row == -1)</span>
<a href="#l24.20"></a><span id="l24.20">       return;</span>
<a href="#l24.21"></a><span id="l24.21"> </span>
<a href="#l24.22"></a><span id="l24.22" class="difflineminus">-    if (elt.value == &quot;twisty&quot;) {</span>
<a href="#l24.23"></a><span id="l24.23" class="difflineminus">-        var folderResource = GetFolderResource(gSynchronizeTree, row.value);</span>
<a href="#l24.24"></a><span id="l24.24" class="difflineplus">+    if (treeCellInfo.childElt == &quot;twisty&quot;) {</span>
<a href="#l24.25"></a><span id="l24.25" class="difflineplus">+        var folderResource = GetFolderResource(gSynchronizeTree, treeCellInfo.row);</span>
<a href="#l24.26"></a><span id="l24.26">         var folder = folderResource.QueryInterface(Ci.nsIMsgFolder);</span>
<a href="#l24.27"></a><span id="l24.27"> </span>
<a href="#l24.28"></a><span id="l24.28" class="difflineminus">-        if (!(gSynchronizeTree.treeBoxObject.view.isContainerOpen(row.value))) {</span>
<a href="#l24.29"></a><span id="l24.29" class="difflineplus">+        if (!(gSynchronizeTree.view.isContainerOpen(treeCellInfo.row))) {</span>
<a href="#l24.30"></a><span id="l24.30">             var serverType = folder.server.type;</span>
<a href="#l24.31"></a><span id="l24.31">             // imap is the only server type that does folder discovery</span>
<a href="#l24.32"></a><span id="l24.32">             if (serverType != &quot;imap&quot;) return;</span>
<a href="#l24.33"></a><span id="l24.33"> </span>
<a href="#l24.34"></a><span id="l24.34">             if (folder.isServer) {</span>
<a href="#l24.35"></a><span id="l24.35">                 var server = folder.server;</span>
<a href="#l24.36"></a><span id="l24.36">                 server.performExpand(gMsgWindow);</span>
<a href="#l24.37"></a><span id="l24.37">             }</span>
<a href="#l24.38"></a><span id="l24.38" class="difflineat">@@ -153,18 +149,18 @@ function onSynchronizeClick(event)</span>
<a href="#l24.39"></a><span id="l24.39">                 var imapFolder = folderResource.QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l24.40"></a><span id="l24.40">                 if (imapFolder) {</span>
<a href="#l24.41"></a><span id="l24.41">                   imapFolder.performExpand(gMsgWindow);</span>
<a href="#l24.42"></a><span id="l24.42">                 }</span>
<a href="#l24.43"></a><span id="l24.43">             }</span>
<a href="#l24.44"></a><span id="l24.44">         }</span>
<a href="#l24.45"></a><span id="l24.45">     }</span>
<a href="#l24.46"></a><span id="l24.46">     else {</span>
<a href="#l24.47"></a><span id="l24.47" class="difflineminus">-      if (col.value.id == &quot;syncCol&quot;) {</span>
<a href="#l24.48"></a><span id="l24.48" class="difflineminus">-        UpdateNode(GetFolderResource(gSynchronizeTree, row.value), row.value);</span>
<a href="#l24.49"></a><span id="l24.49" class="difflineplus">+      if (treeCellInfo.col.id == &quot;syncCol&quot;) {</span>
<a href="#l24.50"></a><span id="l24.50" class="difflineplus">+        UpdateNode(GetFolderResource(gSynchronizeTree, treeCellInfo.row), treeCellInfo.row);</span>
<a href="#l24.51"></a><span id="l24.51">       }</span>
<a href="#l24.52"></a><span id="l24.52">     }</span>
<a href="#l24.53"></a><span id="l24.53"> }</span>
<a href="#l24.54"></a><span id="l24.54"> </span>
<a href="#l24.55"></a><span id="l24.55"> function onSynchronizeTreeKeyPress(event)</span>
<a href="#l24.56"></a><span id="l24.56"> {</span>
<a href="#l24.57"></a><span id="l24.57">     // for now, only do something on space key</span>
<a href="#l24.58"></a><span id="l24.58">     if (event.charCode != KeyEvent.DOM_VK_SPACE)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mailnews/base/content/subscribe.js</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mailnews/base/content/subscribe.js</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -2,27 +2,26 @@</span>
<a href="#l25.4"></a><span id="l25.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l25.5"></a><span id="l25.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l25.6"></a><span id="l25.6"> </span>
<a href="#l25.7"></a><span id="l25.7"> ChromeUtils.import(&quot;resource:///modules/MailUtils.jsm&quot;);</span>
<a href="#l25.8"></a><span id="l25.8"> ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l25.9"></a><span id="l25.9"> </span>
<a href="#l25.10"></a><span id="l25.10"> var gSubscribeTree = null;</span>
<a href="#l25.11"></a><span id="l25.11"> var gSubscribeBody = null;</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-var gSearchTree;</span>
<a href="#l25.13"></a><span id="l25.13"> var okCallback = null;</span>
<a href="#l25.14"></a><span id="l25.14"> var gChangeTable = {};</span>
<a href="#l25.15"></a><span id="l25.15"> var gServerURI = null;</span>
<a href="#l25.16"></a><span id="l25.16"> var gSubscribableServer = null;</span>
<a href="#l25.17"></a><span id="l25.17"> var gNameField = null;</span>
<a href="#l25.18"></a><span id="l25.18"> var gNameFieldLabel = null;</span>
<a href="#l25.19"></a><span id="l25.19"> var gStatusFeedback;</span>
<a href="#l25.20"></a><span id="l25.20"> var gSubscribeDeck = null;</span>
<a href="#l25.21"></a><span id="l25.21"> var gSearchView = null;</span>
<a href="#l25.22"></a><span id="l25.22" class="difflineminus">-var gSearchTreeBoxObject = null;</span>
<a href="#l25.23"></a><span id="l25.23" class="difflineplus">+var gSearchTree = null;</span>
<a href="#l25.24"></a><span id="l25.24"> var gSubscribeBundle;</span>
<a href="#l25.25"></a><span id="l25.25"> </span>
<a href="#l25.26"></a><span id="l25.26"> function Stop()</span>
<a href="#l25.27"></a><span id="l25.27"> {</span>
<a href="#l25.28"></a><span id="l25.28">   if (gSubscribableServer) {</span>
<a href="#l25.29"></a><span id="l25.29">     gSubscribableServer.stopPopulating(msgWindow);</span>
<a href="#l25.30"></a><span id="l25.30">   }</span>
<a href="#l25.31"></a><span id="l25.31"> }</span>
<a href="#l25.32"></a><span id="l25.32" class="difflineat">@@ -143,17 +142,17 @@ function EnableSearchUI()</span>
<a href="#l25.33"></a><span id="l25.33"> </span>
<a href="#l25.34"></a><span id="l25.34"> function SubscribeOnLoad()</span>
<a href="#l25.35"></a><span id="l25.35"> {</span>
<a href="#l25.36"></a><span id="l25.36">   gSubscribeBundle = document.getElementById(&quot;bundle_subscribe&quot;);</span>
<a href="#l25.37"></a><span id="l25.37"> </span>
<a href="#l25.38"></a><span id="l25.38">   gSubscribeTree = document.getElementById(&quot;subscribeTree&quot;);</span>
<a href="#l25.39"></a><span id="l25.39">   gSubscribeBody = document.getElementById(&quot;subscribeTreeBody&quot;);</span>
<a href="#l25.40"></a><span id="l25.40">   gSearchTree = document.getElementById(&quot;searchTree&quot;);</span>
<a href="#l25.41"></a><span id="l25.41" class="difflineminus">-  gSearchTreeBoxObject = document.getElementById(&quot;searchTree&quot;).treeBoxObject;</span>
<a href="#l25.42"></a><span id="l25.42" class="difflineplus">+  gSearchTree = document.getElementById(&quot;searchTree&quot;);</span>
<a href="#l25.43"></a><span id="l25.43">   gNameField = document.getElementById(&quot;namefield&quot;);</span>
<a href="#l25.44"></a><span id="l25.44">   gNameFieldLabel = document.getElementById(&quot;namefieldlabel&quot;);</span>
<a href="#l25.45"></a><span id="l25.45"> </span>
<a href="#l25.46"></a><span id="l25.46">   gSubscribeDeck = document.getElementById(&quot;subscribedeck&quot;);</span>
<a href="#l25.47"></a><span id="l25.47"> </span>
<a href="#l25.48"></a><span id="l25.48">   msgWindow = Cc[&quot;@mozilla.org/messenger/msgwindow;1&quot;]</span>
<a href="#l25.49"></a><span id="l25.49">                 .createInstance(Ci.nsIMsgWindow);</span>
<a href="#l25.50"></a><span id="l25.50">   msgWindow.domWindow = window;</span>
<a href="#l25.51"></a><span id="l25.51" class="difflineat">@@ -265,35 +264,34 @@ function InSearchMode()</span>
<a href="#l25.52"></a><span id="l25.52">   return (gSubscribeDeck.getAttribute(&quot;selectedIndex&quot;) == &quot;1&quot;);</span>
<a href="#l25.53"></a><span id="l25.53"> }</span>
<a href="#l25.54"></a><span id="l25.54"> </span>
<a href="#l25.55"></a><span id="l25.55"> function SearchOnClick(event)</span>
<a href="#l25.56"></a><span id="l25.56"> {</span>
<a href="#l25.57"></a><span id="l25.57">   // we only care about button 0 (left click) events</span>
<a href="#l25.58"></a><span id="l25.58">   if (event.button != 0 || event.originalTarget.localName != &quot;treechildren&quot;) return;</span>
<a href="#l25.59"></a><span id="l25.59"> </span>
<a href="#l25.60"></a><span id="l25.60" class="difflineminus">-  var row = {}, col = {}, childElt = {};</span>
<a href="#l25.61"></a><span id="l25.61" class="difflineminus">-  gSearchTreeBoxObject.getCellAt(event.clientX, event.clientY, row, col, childElt);</span>
<a href="#l25.62"></a><span id="l25.62" class="difflineminus">-  if (row.value == -1 || row.value &gt; gSearchView.rowCount-1)</span>
<a href="#l25.63"></a><span id="l25.63" class="difflineplus">+  let treeCellInfo = gSearchTree.getCellAt(event.clientX, event.clientY);</span>
<a href="#l25.64"></a><span id="l25.64" class="difflineplus">+  if (treeCellInfo.row == -1 || treeCellInfo.row &gt; gSearchView.rowCount-1)</span>
<a href="#l25.65"></a><span id="l25.65">     return;</span>
<a href="#l25.66"></a><span id="l25.66"> </span>
<a href="#l25.67"></a><span id="l25.67" class="difflineminus">-  if (col.value.id == &quot;subscribedColumn2&quot;) {</span>
<a href="#l25.68"></a><span id="l25.68" class="difflineplus">+  if (treeCellInfo.col.id == &quot;subscribedColumn2&quot;) {</span>
<a href="#l25.69"></a><span id="l25.69">     if (event.detail != 2) {</span>
<a href="#l25.70"></a><span id="l25.70">       // single clicked on the check box</span>
<a href="#l25.71"></a><span id="l25.71">       // (in the &quot;subscribedColumn2&quot; column) reverse state</span>
<a href="#l25.72"></a><span id="l25.72">       // if double click, do nothing</span>
<a href="#l25.73"></a><span id="l25.73" class="difflineminus">-      ReverseStateFromRow(row.value);</span>
<a href="#l25.74"></a><span id="l25.74" class="difflineplus">+      ReverseStateFromRow(treeCellInfo.row);</span>
<a href="#l25.75"></a><span id="l25.75">     }</span>
<a href="#l25.76"></a><span id="l25.76">   } else if (event.detail == 2) {</span>
<a href="#l25.77"></a><span id="l25.77">     // double clicked on a row, reverse state</span>
<a href="#l25.78"></a><span id="l25.78" class="difflineminus">-    ReverseStateFromRow(row.value);</span>
<a href="#l25.79"></a><span id="l25.79" class="difflineplus">+    ReverseStateFromRow(treeCellInfo.row);</span>
<a href="#l25.80"></a><span id="l25.80">   }</span>
<a href="#l25.81"></a><span id="l25.81"> </span>
<a href="#l25.82"></a><span id="l25.82">   // invalidate the row</span>
<a href="#l25.83"></a><span id="l25.83" class="difflineminus">-  InvalidateSearchTreeRow(row.value);</span>
<a href="#l25.84"></a><span id="l25.84" class="difflineplus">+  InvalidateSearchTreeRow(treeCellInfo.row);</span>
<a href="#l25.85"></a><span id="l25.85"> }</span>
<a href="#l25.86"></a><span id="l25.86"> </span>
<a href="#l25.87"></a><span id="l25.87"> function ReverseStateFromRow(aRow)</span>
<a href="#l25.88"></a><span id="l25.88"> {</span>
<a href="#l25.89"></a><span id="l25.89">   // To determine if the row is subscribed or not,</span>
<a href="#l25.90"></a><span id="l25.90">   // we get the properties for the &quot;subscribedColumn2&quot; cell in the row</span>
<a href="#l25.91"></a><span id="l25.91">   // and look for the &quot;subscribed&quot; property.</span>
<a href="#l25.92"></a><span id="l25.92">   // If the &quot;subscribed&quot; string is in the list of properties</span>
<a href="#l25.93"></a><span id="l25.93" class="difflineat">@@ -351,34 +349,33 @@ function ReverseStateFromNode(row)</span>
<a href="#l25.94"></a><span id="l25.94"> }</span>
<a href="#l25.95"></a><span id="l25.95"> </span>
<a href="#l25.96"></a><span id="l25.96"> function SubscribeOnClick(event)</span>
<a href="#l25.97"></a><span id="l25.97"> {</span>
<a href="#l25.98"></a><span id="l25.98">   // we only care about button 0 (left click) events</span>
<a href="#l25.99"></a><span id="l25.99">   if (event.button != 0 || event.originalTarget.localName != &quot;treechildren&quot;)</span>
<a href="#l25.100"></a><span id="l25.100">    return;</span>
<a href="#l25.101"></a><span id="l25.101"> </span>
<a href="#l25.102"></a><span id="l25.102" class="difflineminus">-  var row = {}, col = {}, obj = {};</span>
<a href="#l25.103"></a><span id="l25.103" class="difflineminus">-  gSubscribeTree.treeBoxObject.getCellAt(event.clientX, event.clientY, row, col, obj);</span>
<a href="#l25.104"></a><span id="l25.104" class="difflineminus">-  if (row.value == -1 || row.value &gt; (gSubscribeTree.view.rowCount - 1))</span>
<a href="#l25.105"></a><span id="l25.105" class="difflineplus">+  let treeCellInfo = gSubscribeTree.getCellAt(event.clientX, event.clientY);</span>
<a href="#l25.106"></a><span id="l25.106" class="difflineplus">+  if (treeCellInfo.row == -1 || treeCellInfo.row &gt; (gSubscribeTree.view.rowCount - 1))</span>
<a href="#l25.107"></a><span id="l25.107">     return;</span>
<a href="#l25.108"></a><span id="l25.108"> </span>
<a href="#l25.109"></a><span id="l25.109">   if (event.detail == 2) {</span>
<a href="#l25.110"></a><span id="l25.110">     // only toggle subscribed state when double clicking something</span>
<a href="#l25.111"></a><span id="l25.111">     // that isn't a container</span>
<a href="#l25.112"></a><span id="l25.112" class="difflineminus">-    if (!gSubscribeTree.view.isContainer(row.value)) {</span>
<a href="#l25.113"></a><span id="l25.113" class="difflineminus">-      ReverseStateFromNode(row.value);</span>
<a href="#l25.114"></a><span id="l25.114" class="difflineplus">+    if (!gSubscribeTree.view.isContainer(treeCellInfo.row)) {</span>
<a href="#l25.115"></a><span id="l25.115" class="difflineplus">+      ReverseStateFromNode(treeCellInfo.row);</span>
<a href="#l25.116"></a><span id="l25.116">       return;</span>
<a href="#l25.117"></a><span id="l25.117">     }</span>
<a href="#l25.118"></a><span id="l25.118">   }</span>
<a href="#l25.119"></a><span id="l25.119">   else if (event.detail == 1)</span>
<a href="#l25.120"></a><span id="l25.120">   {</span>
<a href="#l25.121"></a><span id="l25.121">     // if the user single clicks on the subscribe check box, we handle it here</span>
<a href="#l25.122"></a><span id="l25.122">     if (col.value.id == &quot;subscribedColumn&quot;)</span>
<a href="#l25.123"></a><span id="l25.123" class="difflineminus">-      ReverseStateFromNode(row.value);</span>
<a href="#l25.124"></a><span id="l25.124" class="difflineplus">+      ReverseStateFromNode(treeCellInfo.row);</span>
<a href="#l25.125"></a><span id="l25.125">   }</span>
<a href="#l25.126"></a><span id="l25.126"> }</span>
<a href="#l25.127"></a><span id="l25.127"> </span>
<a href="#l25.128"></a><span id="l25.128"> function Refresh()</span>
<a href="#l25.129"></a><span id="l25.129"> {</span>
<a href="#l25.130"></a><span id="l25.130">   // clear out the textfield's entry</span>
<a href="#l25.131"></a><span id="l25.131">   gNameField.value = &quot;&quot;;</span>
<a href="#l25.132"></a><span id="l25.132"> </span>
<a href="#l25.133"></a><span id="l25.133" class="difflineat">@@ -407,22 +404,22 @@ function ShowNewGroupsList()</span>
<a href="#l25.134"></a><span id="l25.134">   document.getElementById(&quot;subscribeTabs&quot;).selectedIndex = 1;</span>
<a href="#l25.135"></a><span id="l25.135"> </span>
<a href="#l25.136"></a><span id="l25.136">   // force it to talk to the server and get new groups</span>
<a href="#l25.137"></a><span id="l25.137">   SetUpTree(true, true);</span>
<a href="#l25.138"></a><span id="l25.138"> }</span>
<a href="#l25.139"></a><span id="l25.139"> </span>
<a href="#l25.140"></a><span id="l25.140"> function InvalidateSearchTreeRow(row)</span>
<a href="#l25.141"></a><span id="l25.141"> {</span>
<a href="#l25.142"></a><span id="l25.142" class="difflineminus">-    gSearchTreeBoxObject.invalidateRow(row);</span>
<a href="#l25.143"></a><span id="l25.143" class="difflineplus">+    gSearchTree.invalidateRow(row);</span>
<a href="#l25.144"></a><span id="l25.144"> }</span>
<a href="#l25.145"></a><span id="l25.145"> </span>
<a href="#l25.146"></a><span id="l25.146"> function InvalidateSearchTree()</span>
<a href="#l25.147"></a><span id="l25.147"> {</span>
<a href="#l25.148"></a><span id="l25.148" class="difflineminus">-    gSearchTreeBoxObject.invalidate();</span>
<a href="#l25.149"></a><span id="l25.149" class="difflineplus">+    gSearchTree.invalidate();</span>
<a href="#l25.150"></a><span id="l25.150"> }</span>
<a href="#l25.151"></a><span id="l25.151"> </span>
<a href="#l25.152"></a><span id="l25.152"> function SwitchToNormalView()</span>
<a href="#l25.153"></a><span id="l25.153"> {</span>
<a href="#l25.154"></a><span id="l25.154">   // the first card in the deck is the &quot;normal&quot; view</span>
<a href="#l25.155"></a><span id="l25.155">   gSubscribeDeck.setAttribute(&quot;selectedIndex&quot;,&quot;0&quot;);</span>
<a href="#l25.156"></a><span id="l25.156"> }</span>
<a href="#l25.157"></a><span id="l25.157"> </span>
<a href="#l25.158"></a><span id="l25.158" class="difflineat">@@ -437,17 +434,17 @@ function Search()</span>
<a href="#l25.159"></a><span id="l25.159">   var searchValue = gNameField.value;</span>
<a href="#l25.160"></a><span id="l25.160">   if (searchValue.length &amp;&amp; gSubscribableServer.supportsSubscribeSearch) {</span>
<a href="#l25.161"></a><span id="l25.161">     SwitchToSearchView();</span>
<a href="#l25.162"></a><span id="l25.162">     gSubscribableServer.setSearchValue(searchValue);</span>
<a href="#l25.163"></a><span id="l25.163"> </span>
<a href="#l25.164"></a><span id="l25.164">     if (!gSearchView &amp;&amp; gSubscribableServer) {</span>
<a href="#l25.165"></a><span id="l25.165">     gSearchView = gSubscribableServer.QueryInterface(Ci.nsITreeView);</span>
<a href="#l25.166"></a><span id="l25.166">       gSearchView.selection = null;</span>
<a href="#l25.167"></a><span id="l25.167" class="difflineminus">-    gSearchTreeBoxObject.view = gSearchView;</span>
<a href="#l25.168"></a><span id="l25.168" class="difflineplus">+    gSearchTree.view = gSearchView;</span>
<a href="#l25.169"></a><span id="l25.169">   }</span>
<a href="#l25.170"></a><span id="l25.170">   }</span>
<a href="#l25.171"></a><span id="l25.171">   else {</span>
<a href="#l25.172"></a><span id="l25.172">     SwitchToNormalView();</span>
<a href="#l25.173"></a><span id="l25.173">   }</span>
<a href="#l25.174"></a><span id="l25.174"> }</span>
<a href="#l25.175"></a><span id="l25.175"> </span>
<a href="#l25.176"></a><span id="l25.176"> function CleanUpSearchView()</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/mailnews/base/content/virtualFolderListEdit.js</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/mailnews/base/content/virtualFolderListEdit.js</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -68,24 +68,21 @@ var gSelectVirtual = {</span>
<a href="#l26.4"></a><span id="l26.4">     }</span>
<a href="#l26.5"></a><span id="l26.5">   },</span>
<a href="#l26.6"></a><span id="l26.6"> </span>
<a href="#l26.7"></a><span id="l26.7">   onClick: function(aEvent) {</span>
<a href="#l26.8"></a><span id="l26.8">     // We only care about button 0 (left click) events.</span>
<a href="#l26.9"></a><span id="l26.9">     if (aEvent.button != 0)</span>
<a href="#l26.10"></a><span id="l26.10">       return;</span>
<a href="#l26.11"></a><span id="l26.11"> </span>
<a href="#l26.12"></a><span id="l26.12" class="difflineminus">-    let row = {};</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineminus">-    let col = {};</span>
<a href="#l26.14"></a><span id="l26.14" class="difflineminus">-    this._treeElement.treeBoxObject</span>
<a href="#l26.15"></a><span id="l26.15" class="difflineminus">-                     .getCellAt(aEvent.clientX, aEvent.clientY, row, col, {});</span>
<a href="#l26.16"></a><span id="l26.16" class="difflineminus">-    if (row.value == -1 || col.value.id != &quot;selectedCol&quot;)</span>
<a href="#l26.17"></a><span id="l26.17" class="difflineplus">+    let treeCellInfo = this._treeElement.getCellAt(aEvent.clientX, aEvent.clientY);</span>
<a href="#l26.18"></a><span id="l26.18" class="difflineplus">+    if (treeCellInfo.row == -1 || treeCellInfo.col.id != &quot;selectedCol&quot;)</span>
<a href="#l26.19"></a><span id="l26.19">       return;</span>
<a href="#l26.20"></a><span id="l26.20"> </span>
<a href="#l26.21"></a><span id="l26.21" class="difflineminus">-    this._toggle(row.value);</span>
<a href="#l26.22"></a><span id="l26.22" class="difflineplus">+    this._toggle(treeCellInfo.row);</span>
<a href="#l26.23"></a><span id="l26.23">   },</span>
<a href="#l26.24"></a><span id="l26.24"> </span>
<a href="#l26.25"></a><span id="l26.25">   _toggle: function(aRow) {</span>
<a href="#l26.26"></a><span id="l26.26">     let folder = gFolderTreeView._rowMap[aRow]._folder;</span>
<a href="#l26.27"></a><span id="l26.27">     if (this._selectedList.has(folder))</span>
<a href="#l26.28"></a><span id="l26.28">       this._selectedList.delete(folder);</span>
<a href="#l26.29"></a><span id="l26.29">     else</span>
<a href="#l26.30"></a><span id="l26.30">       this._selectedList.add(folder);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/mailnews/base/prefs/content/AccountManager.js</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/mailnews/base/prefs/content/AccountManager.js</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -192,23 +192,23 @@ function selectServer(server, selectPage</span>
<a href="#l27.4"></a><span id="l27.4">       // ... or one of its children.</span>
<a href="#l27.5"></a><span id="l27.5">       pageToSelect = accountNode.querySelector('[PageTag=&quot;' + selectPageId + '&quot;]');</span>
<a href="#l27.6"></a><span id="l27.6">     }</span>
<a href="#l27.7"></a><span id="l27.7">   }</span>
<a href="#l27.8"></a><span id="l27.8"> </span>
<a href="#l27.9"></a><span id="l27.9">   let accountTree = document.getElementById(&quot;accounttree&quot;);</span>
<a href="#l27.10"></a><span id="l27.10">   let index = accountTree.view.getIndexOfItem(pageToSelect);</span>
<a href="#l27.11"></a><span id="l27.11">   accountTree.view.selection.select(index);</span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-  accountTree.treeBoxObject.ensureRowIsVisible(index);</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineplus">+  accountTree.ensureRowIsVisible(index);</span>
<a href="#l27.14"></a><span id="l27.14"> </span>
<a href="#l27.15"></a><span id="l27.15">   let lastItem = accountNode.lastChild.lastChild;</span>
<a href="#l27.16"></a><span id="l27.16">   if (lastItem.localName == &quot;treeitem&quot;)</span>
<a href="#l27.17"></a><span id="l27.17">     index = accountTree.view.getIndexOfItem(lastItem);</span>
<a href="#l27.18"></a><span id="l27.18"> </span>
<a href="#l27.19"></a><span id="l27.19" class="difflineminus">-  accountTree.treeBoxObject.ensureRowIsVisible(index);</span>
<a href="#l27.20"></a><span id="l27.20" class="difflineplus">+  accountTree.ensureRowIsVisible(index);</span>
<a href="#l27.21"></a><span id="l27.21"> }</span>
<a href="#l27.22"></a><span id="l27.22"> </span>
<a href="#l27.23"></a><span id="l27.23"> function replaceWithDefaultSmtpServer(deletedSmtpServerKey)</span>
<a href="#l27.24"></a><span id="l27.24"> {</span>
<a href="#l27.25"></a><span id="l27.25">   // First we replace the smtpserverkey in every identity.</span>
<a href="#l27.26"></a><span id="l27.26">   let am = MailServices.accounts;</span>
<a href="#l27.27"></a><span id="l27.27">   for (let identity of fixIterator(am.allIdentities,</span>
<a href="#l27.28"></a><span id="l27.28">                                    Ci.nsIMsgIdentity)) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/mailnews/base/util/jsTreeSelection.js</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/mailnews/base/util/jsTreeSelection.js</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -32,31 +32,31 @@ ChromeUtils.import(&quot;resource://gre/modul</span>
<a href="#l28.4"></a><span id="l28.4">  *  documentation tool will copy-down that documentation.</span>
<a href="#l28.5"></a><span id="l28.5">  *</span>
<a href="#l28.6"></a><span id="l28.6">  * This implementation attempts to mimic the behavior of nsTreeSelection.  In</span>
<a href="#l28.7"></a><span id="l28.7">  *  a few cases, this leads to potentially confusing actions.  I attempt to note</span>
<a href="#l28.8"></a><span id="l28.8">  *  when we are doing this and why we do it.</span>
<a href="#l28.9"></a><span id="l28.9">  *</span>
<a href="#l28.10"></a><span id="l28.10">  * Unit test is in mailnews/base/util/test_jsTreeSelection.js</span>
<a href="#l28.11"></a><span id="l28.11">  */</span>
<a href="#l28.12"></a><span id="l28.12" class="difflineminus">-function JSTreeSelection(aTreeBoxObject) {</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineminus">-  this._treeBoxObject = aTreeBoxObject;</span>
<a href="#l28.14"></a><span id="l28.14" class="difflineplus">+function JSTreeSelection(aTree) {</span>
<a href="#l28.15"></a><span id="l28.15" class="difflineplus">+  this._tree = aTree;</span>
<a href="#l28.16"></a><span id="l28.16"> </span>
<a href="#l28.17"></a><span id="l28.17">   this._currentIndex = null;</span>
<a href="#l28.18"></a><span id="l28.18">   this._shiftSelectPivot = null;</span>
<a href="#l28.19"></a><span id="l28.19">   this._ranges = [];</span>
<a href="#l28.20"></a><span id="l28.20">   this._count = 0;</span>
<a href="#l28.21"></a><span id="l28.21"> </span>
<a href="#l28.22"></a><span id="l28.22">   this._selectEventsSuppressed = false;</span>
<a href="#l28.23"></a><span id="l28.23"> }</span>
<a href="#l28.24"></a><span id="l28.24"> JSTreeSelection.prototype = {</span>
<a href="#l28.25"></a><span id="l28.25">   /**</span>
<a href="#l28.26"></a><span id="l28.26" class="difflineminus">-   * The current nsITreeBoxObject, appropriately QueryInterfaced.  May be null.</span>
<a href="#l28.27"></a><span id="l28.27" class="difflineplus">+   * The current XULTreeElement, appropriately QueryInterfaced. May be null.</span>
<a href="#l28.28"></a><span id="l28.28">    */</span>
<a href="#l28.29"></a><span id="l28.29" class="difflineminus">-  _treeBoxObject: null,</span>
<a href="#l28.30"></a><span id="l28.30" class="difflineplus">+  _tree: null,</span>
<a href="#l28.31"></a><span id="l28.31"> </span>
<a href="#l28.32"></a><span id="l28.32">   /**</span>
<a href="#l28.33"></a><span id="l28.33">    * Where the focus rectangle (that little dotted thing) shows up.  Just</span>
<a href="#l28.34"></a><span id="l28.34">    *  because something is focused does not mean it is actually selected.</span>
<a href="#l28.35"></a><span id="l28.35">    */</span>
<a href="#l28.36"></a><span id="l28.36">   _currentIndex: null,</span>
<a href="#l28.37"></a><span id="l28.37">   /**</span>
<a href="#l28.38"></a><span id="l28.38">    * The view index where the shift is anchored when it is not (conceptually)</span>
<a href="#l28.39"></a><span id="l28.39" class="difflineat">@@ -78,20 +78,20 @@ JSTreeSelection.prototype = {</span>
<a href="#l28.40"></a><span id="l28.40">    */</span>
<a href="#l28.41"></a><span id="l28.41">   _count: 0,</span>
<a href="#l28.42"></a><span id="l28.42"> </span>
<a href="#l28.43"></a><span id="l28.43">   // In the case of the stand-alone message window, there's no tree, but</span>
<a href="#l28.44"></a><span id="l28.44">   // there's a view.</span>
<a href="#l28.45"></a><span id="l28.45">   _view: null,</span>
<a href="#l28.46"></a><span id="l28.46"> </span>
<a href="#l28.47"></a><span id="l28.47">   get tree() {</span>
<a href="#l28.48"></a><span id="l28.48" class="difflineminus">-    return this._treeBoxObject;</span>
<a href="#l28.49"></a><span id="l28.49" class="difflineplus">+    return this._tree;</span>
<a href="#l28.50"></a><span id="l28.50">   },</span>
<a href="#l28.51"></a><span id="l28.51" class="difflineminus">-  set tree(aTreeBoxObject) {</span>
<a href="#l28.52"></a><span id="l28.52" class="difflineminus">-    this._treeBoxObject = aTreeBoxObject;</span>
<a href="#l28.53"></a><span id="l28.53" class="difflineplus">+  set tree(aTree) {</span>
<a href="#l28.54"></a><span id="l28.54" class="difflineplus">+    this._tree = aTree;</span>
<a href="#l28.55"></a><span id="l28.55">   },</span>
<a href="#l28.56"></a><span id="l28.56"> </span>
<a href="#l28.57"></a><span id="l28.57">   set view(aView) {</span>
<a href="#l28.58"></a><span id="l28.58">     this._view = aView;</span>
<a href="#l28.59"></a><span id="l28.59">   },</span>
<a href="#l28.60"></a><span id="l28.60">   /**</span>
<a href="#l28.61"></a><span id="l28.61">    * Although the nsITreeSelection documentation doesn't say, what this method</span>
<a href="#l28.62"></a><span id="l28.62">    *  is supposed to do is check if the seltype attribute on the XUL tree is any</span>
<a href="#l28.63"></a><span id="l28.63" class="difflineat">@@ -133,18 +133,18 @@ JSTreeSelection.prototype = {</span>
<a href="#l28.64"></a><span id="l28.64">     this.currentIndex = aViewIndex;</span>
<a href="#l28.65"></a><span id="l28.65"> </span>
<a href="#l28.66"></a><span id="l28.66">     if (this._count == 1 &amp;&amp; this._ranges[0][0] == aViewIndex)</span>
<a href="#l28.67"></a><span id="l28.67">       return;</span>
<a href="#l28.68"></a><span id="l28.68"> </span>
<a href="#l28.69"></a><span id="l28.69">     this._count = 1;</span>
<a href="#l28.70"></a><span id="l28.70">     this._ranges = [[aViewIndex, aViewIndex]];</span>
<a href="#l28.71"></a><span id="l28.71"> </span>
<a href="#l28.72"></a><span id="l28.72" class="difflineminus">-    if (this._treeBoxObject)</span>
<a href="#l28.73"></a><span id="l28.73" class="difflineminus">-      this._treeBoxObject.invalidate();</span>
<a href="#l28.74"></a><span id="l28.74" class="difflineplus">+    if (this._tree)</span>
<a href="#l28.75"></a><span id="l28.75" class="difflineplus">+      this._tree.invalidate();</span>
<a href="#l28.76"></a><span id="l28.76"> </span>
<a href="#l28.77"></a><span id="l28.77">     this._fireSelectionChanged();</span>
<a href="#l28.78"></a><span id="l28.78">   },</span>
<a href="#l28.79"></a><span id="l28.79"> </span>
<a href="#l28.80"></a><span id="l28.80">   timedSelect: function JSTreeSelection_timedSelect(aIndex, aDelay) {</span>
<a href="#l28.81"></a><span id="l28.81">     throw new Error(&quot;We do not implement timed selection.&quot;);</span>
<a href="#l28.82"></a><span id="l28.82">   },</span>
<a href="#l28.83"></a><span id="l28.83"> </span>
<a href="#l28.84"></a><span id="l28.84" class="difflineat">@@ -201,18 +201,18 @@ JSTreeSelection.prototype = {</span>
<a href="#l28.85"></a><span id="l28.85">         }</span>
<a href="#l28.86"></a><span id="l28.86">         // nope, no merge required, just update the range</span>
<a href="#l28.87"></a><span id="l28.87">         this._ranges[iTupe][1] = aIndex;</span>
<a href="#l28.88"></a><span id="l28.88">         break;</span>
<a href="#l28.89"></a><span id="l28.89">       }</span>
<a href="#l28.90"></a><span id="l28.90">       // otherwise we need to keep going</span>
<a href="#l28.91"></a><span id="l28.91">     }</span>
<a href="#l28.92"></a><span id="l28.92"> </span>
<a href="#l28.93"></a><span id="l28.93" class="difflineminus">-    if (this._treeBoxObject)</span>
<a href="#l28.94"></a><span id="l28.94" class="difflineminus">-      this._treeBoxObject.invalidateRow(aIndex);</span>
<a href="#l28.95"></a><span id="l28.95" class="difflineplus">+    if (this._tree)</span>
<a href="#l28.96"></a><span id="l28.96" class="difflineplus">+      this._tree.invalidateRow(aIndex);</span>
<a href="#l28.97"></a><span id="l28.97">     this._fireSelectionChanged();</span>
<a href="#l28.98"></a><span id="l28.98">   },</span>
<a href="#l28.99"></a><span id="l28.99"> </span>
<a href="#l28.100"></a><span id="l28.100">   /**</span>
<a href="#l28.101"></a><span id="l28.101">    * @param aRangeStart If omitted, it implies a shift-selection is happening,</span>
<a href="#l28.102"></a><span id="l28.102">    *     in which case we use _shiftSelectPivot as the start if we have it,</span>
<a href="#l28.103"></a><span id="l28.103">    *     _currentIndex if we don't, and if we somehow didn't have a</span>
<a href="#l28.104"></a><span id="l28.104">    *     _currentIndex, we use the range end.</span>
<a href="#l28.105"></a><span id="l28.105" class="difflineat">@@ -237,18 +237,18 @@ JSTreeSelection.prototype = {</span>
<a href="#l28.106"></a><span id="l28.106">     // enforce our ordering constraint for our ranges</span>
<a href="#l28.107"></a><span id="l28.107">     if (aRangeStart &gt; aRangeEnd)</span>
<a href="#l28.108"></a><span id="l28.108">       [aRangeStart, aRangeEnd] = [aRangeEnd, aRangeStart];</span>
<a href="#l28.109"></a><span id="l28.109"> </span>
<a href="#l28.110"></a><span id="l28.110">     // if we're not augmenting, then this is really easy.</span>
<a href="#l28.111"></a><span id="l28.111">     if (!aAugment) {</span>
<a href="#l28.112"></a><span id="l28.112">       this._count = aRangeEnd - aRangeStart + 1;</span>
<a href="#l28.113"></a><span id="l28.113">       this._ranges = [[aRangeStart, aRangeEnd]];</span>
<a href="#l28.114"></a><span id="l28.114" class="difflineminus">-      if (this._treeBoxObject)</span>
<a href="#l28.115"></a><span id="l28.115" class="difflineminus">-        this._treeBoxObject.invalidate();</span>
<a href="#l28.116"></a><span id="l28.116" class="difflineplus">+      if (this._tree)</span>
<a href="#l28.117"></a><span id="l28.117" class="difflineplus">+        this._tree.invalidate();</span>
<a href="#l28.118"></a><span id="l28.118">       this._fireSelectionChanged();</span>
<a href="#l28.119"></a><span id="l28.119">       return;</span>
<a href="#l28.120"></a><span id="l28.120">     }</span>
<a href="#l28.121"></a><span id="l28.121"> </span>
<a href="#l28.122"></a><span id="l28.122">     // Iterate over our existing set of ranges, finding the 'range' of ranges</span>
<a href="#l28.123"></a><span id="l28.123">     //  that our new range overlaps or simply obviates.</span>
<a href="#l28.124"></a><span id="l28.124">     // Overlap variables track blocks we need to keep some part of, Nuke</span>
<a href="#l28.125"></a><span id="l28.125">     //  variables are for blocks that get spliced out.  For our purposes, all</span>
<a href="#l28.126"></a><span id="l28.126" class="difflineat">@@ -287,18 +287,18 @@ JSTreeSelection.prototype = {</span>
<a href="#l28.127"></a><span id="l28.127">       aRangeEnd = Math.max(aRangeEnd, this._ranges[highOverlap][1]);</span>
<a href="#l28.128"></a><span id="l28.128">     if (lowNuke != null)</span>
<a href="#l28.129"></a><span id="l28.129">       this._ranges.splice(lowNuke, highNuke - lowNuke + 1,</span>
<a href="#l28.130"></a><span id="l28.130">                           [aRangeStart, aRangeEnd]);</span>
<a href="#l28.131"></a><span id="l28.131">     else</span>
<a href="#l28.132"></a><span id="l28.132">       this._ranges.splice(insertionPoint, 0, [aRangeStart, aRangeEnd]);</span>
<a href="#l28.133"></a><span id="l28.133"> </span>
<a href="#l28.134"></a><span id="l28.134">     this._updateCount();</span>
<a href="#l28.135"></a><span id="l28.135" class="difflineminus">-    if (this._treeBoxObject)</span>
<a href="#l28.136"></a><span id="l28.136" class="difflineminus">-      this._treeBoxObject.invalidate();</span>
<a href="#l28.137"></a><span id="l28.137" class="difflineplus">+    if (this._tree)</span>
<a href="#l28.138"></a><span id="l28.138" class="difflineplus">+      this._tree.invalidate();</span>
<a href="#l28.139"></a><span id="l28.139">     this._fireSelectionChanged();</span>
<a href="#l28.140"></a><span id="l28.140">   },</span>
<a href="#l28.141"></a><span id="l28.141"> </span>
<a href="#l28.142"></a><span id="l28.142">   /**</span>
<a href="#l28.143"></a><span id="l28.143">    * This is basically RangedSelect but without insertion of a new range and we</span>
<a href="#l28.144"></a><span id="l28.144">    *  don't need to worry about adjacency.</span>
<a href="#l28.145"></a><span id="l28.145">    * Oddly, nsTreeSelection doesn't fire a selection changed event here...</span>
<a href="#l28.146"></a><span id="l28.146">    */</span>
<a href="#l28.147"></a><span id="l28.147" class="difflineat">@@ -343,32 +343,32 @@ JSTreeSelection.prototype = {</span>
<a href="#l28.148"></a><span id="l28.148">     let args = [lowNuke, highNuke - lowNuke + 1];</span>
<a href="#l28.149"></a><span id="l28.149">     if (lowOverlap != null)</span>
<a href="#l28.150"></a><span id="l28.150">       args.push([this._ranges[lowOverlap][0], aRangeStart - 1]);</span>
<a href="#l28.151"></a><span id="l28.151">     if (highOverlap != null)</span>
<a href="#l28.152"></a><span id="l28.152">       args.push([aRangeEnd + 1, this._ranges[highOverlap][1]]);</span>
<a href="#l28.153"></a><span id="l28.153">     this._ranges.splice.apply(this._ranges, args);</span>
<a href="#l28.154"></a><span id="l28.154"> </span>
<a href="#l28.155"></a><span id="l28.155">     this._updateCount();</span>
<a href="#l28.156"></a><span id="l28.156" class="difflineminus">-    if (this._treeBoxObject)</span>
<a href="#l28.157"></a><span id="l28.157" class="difflineminus">-      this._treeBoxObject.invalidate();</span>
<a href="#l28.158"></a><span id="l28.158" class="difflineplus">+    if (this._tree)</span>
<a href="#l28.159"></a><span id="l28.159" class="difflineplus">+      this._tree.invalidate();</span>
<a href="#l28.160"></a><span id="l28.160">     // note! nsTreeSelection doesn't fire a selection changed event, so neither</span>
<a href="#l28.161"></a><span id="l28.161">     //  do we, but it seems like we should</span>
<a href="#l28.162"></a><span id="l28.162">   },</span>
<a href="#l28.163"></a><span id="l28.163"> </span>
<a href="#l28.164"></a><span id="l28.164">   /**</span>
<a href="#l28.165"></a><span id="l28.165">    * nsTreeSelection always fires a select notification when the range is</span>
<a href="#l28.166"></a><span id="l28.166">    *  cleared, even if there is no effective chance in selection.</span>
<a href="#l28.167"></a><span id="l28.167">    */</span>
<a href="#l28.168"></a><span id="l28.168">   clearSelection: function JSTreeSelection_clearSelection() {</span>
<a href="#l28.169"></a><span id="l28.169">     this._shiftSelectPivot = null;</span>
<a href="#l28.170"></a><span id="l28.170">     this._count = 0;</span>
<a href="#l28.171"></a><span id="l28.171">     this._ranges = [];</span>
<a href="#l28.172"></a><span id="l28.172" class="difflineminus">-    if (this._treeBoxObject)</span>
<a href="#l28.173"></a><span id="l28.173" class="difflineminus">-      this._treeBoxObject.invalidate();</span>
<a href="#l28.174"></a><span id="l28.174" class="difflineplus">+    if (this._tree)</span>
<a href="#l28.175"></a><span id="l28.175" class="difflineplus">+      this._tree.invalidate();</span>
<a href="#l28.176"></a><span id="l28.176">     this._fireSelectionChanged();</span>
<a href="#l28.177"></a><span id="l28.177">   },</span>
<a href="#l28.178"></a><span id="l28.178"> </span>
<a href="#l28.179"></a><span id="l28.179">   /**</span>
<a href="#l28.180"></a><span id="l28.180">    * Not even nsTreeSelection implements this.</span>
<a href="#l28.181"></a><span id="l28.181">    */</span>
<a href="#l28.182"></a><span id="l28.182">   invertSelection: function JSTreeSelection_invertSelection() {</span>
<a href="#l28.183"></a><span id="l28.183">     throw new Error(&quot;Who really was going to use this?&quot;);</span>
<a href="#l28.184"></a><span id="l28.184" class="difflineat">@@ -386,34 +386,34 @@ JSTreeSelection.prototype = {</span>
<a href="#l28.185"></a><span id="l28.185"> </span>
<a href="#l28.186"></a><span id="l28.186">     // no-ops-ville</span>
<a href="#l28.187"></a><span id="l28.187">     if (!rowCount)</span>
<a href="#l28.188"></a><span id="l28.188">       return;</span>
<a href="#l28.189"></a><span id="l28.189"> </span>
<a href="#l28.190"></a><span id="l28.190">     this._count = rowCount;</span>
<a href="#l28.191"></a><span id="l28.191">     this._ranges = [[0, rowCount - 1]];</span>
<a href="#l28.192"></a><span id="l28.192"> </span>
<a href="#l28.193"></a><span id="l28.193" class="difflineminus">-    if (this._treeBoxObject)</span>
<a href="#l28.194"></a><span id="l28.194" class="difflineminus">-      this._treeBoxObject.invalidate();</span>
<a href="#l28.195"></a><span id="l28.195" class="difflineplus">+    if (this._tree)</span>
<a href="#l28.196"></a><span id="l28.196" class="difflineplus">+      this._tree.invalidate();</span>
<a href="#l28.197"></a><span id="l28.197">     this._fireSelectionChanged();</span>
<a href="#l28.198"></a><span id="l28.198">   },</span>
<a href="#l28.199"></a><span id="l28.199"> </span>
<a href="#l28.200"></a><span id="l28.200">   getRangeCount: function JSTreeSelection_getRangeCount() {</span>
<a href="#l28.201"></a><span id="l28.201">     return this._ranges.length;</span>
<a href="#l28.202"></a><span id="l28.202">   },</span>
<a href="#l28.203"></a><span id="l28.203">   getRangeAt: function JSTreeSelection_getRangeAt(aRangeIndex, aMinObj,</span>
<a href="#l28.204"></a><span id="l28.204">                                                   aMaxObj) {</span>
<a href="#l28.205"></a><span id="l28.205">     if (aRangeIndex &lt; 0 || aRangeIndex &gt; this._ranges.length)</span>
<a href="#l28.206"></a><span id="l28.206">       throw new Exception(&quot;Try a real range index next time.&quot;);</span>
<a href="#l28.207"></a><span id="l28.207">     [aMinObj.value, aMaxObj.value] = this._ranges[aRangeIndex];</span>
<a href="#l28.208"></a><span id="l28.208">   },</span>
<a href="#l28.209"></a><span id="l28.209"> </span>
<a href="#l28.210"></a><span id="l28.210">   invalidateSelection: function JSTreeSelection_invalidateSelection() {</span>
<a href="#l28.211"></a><span id="l28.211" class="difflineminus">-    if (this._treeBoxObject)</span>
<a href="#l28.212"></a><span id="l28.212" class="difflineminus">-      this._treeBoxObject.invalidate();</span>
<a href="#l28.213"></a><span id="l28.213" class="difflineplus">+    if (this._tree)</span>
<a href="#l28.214"></a><span id="l28.214" class="difflineplus">+      this._tree.invalidate();</span>
<a href="#l28.215"></a><span id="l28.215">   },</span>
<a href="#l28.216"></a><span id="l28.216"> </span>
<a href="#l28.217"></a><span id="l28.217">   /**</span>
<a href="#l28.218"></a><span id="l28.218">    * Helper method to adjust points in the face of row additions/removal.</span>
<a href="#l28.219"></a><span id="l28.219">    * @param aPoint The point, null if there isn't one, or an index otherwise.</span>
<a href="#l28.220"></a><span id="l28.220">    * @param aDeltaAt The row at which the change is happening.</span>
<a href="#l28.221"></a><span id="l28.221">    * @param aDelta The number of rows added if positive, or the (negative)</span>
<a href="#l28.222"></a><span id="l28.222">    *     number of rows removed.</span>
<a href="#l28.223"></a><span id="l28.223" class="difflineat">@@ -518,18 +518,18 @@ JSTreeSelection.prototype = {</span>
<a href="#l28.224"></a><span id="l28.224">         }</span>
<a href="#l28.225"></a><span id="l28.225">       }</span>
<a href="#l28.226"></a><span id="l28.226">       // now translate everything from iInsert on up</span>
<a href="#l28.227"></a><span id="l28.227">       for (let iTrans = iInsert; iTrans &lt; this._ranges.length; iTrans++) {</span>
<a href="#l28.228"></a><span id="l28.228">         let [low, high] = this._ranges[iTrans];</span>
<a href="#l28.229"></a><span id="l28.229">         this._ranges[iTrans] = [low + aCount, high + aCount];</span>
<a href="#l28.230"></a><span id="l28.230">       }</span>
<a href="#l28.231"></a><span id="l28.231">       // invalidate and fire selection change notice</span>
<a href="#l28.232"></a><span id="l28.232" class="difflineminus">-      if (this._treeBoxObject)</span>
<a href="#l28.233"></a><span id="l28.233" class="difflineminus">-        this._treeBoxObject.invalidate();</span>
<a href="#l28.234"></a><span id="l28.234" class="difflineplus">+      if (this._tree)</span>
<a href="#l28.235"></a><span id="l28.235" class="difflineplus">+        this._tree.invalidate();</span>
<a href="#l28.236"></a><span id="l28.236">       this._fireSelectionChanged();</span>
<a href="#l28.237"></a><span id="l28.237">       return;</span>
<a href="#l28.238"></a><span id="l28.238">     }</span>
<a href="#l28.239"></a><span id="l28.239"> </span>
<a href="#l28.240"></a><span id="l28.240">     // If we are removing rows, we are basically clearing the range that is</span>
<a href="#l28.241"></a><span id="l28.241">     //  getting deleted and translating everyone above the remaining point</span>
<a href="#l28.242"></a><span id="l28.242">     //  downwards.  The one trick is we may have to merge the lowest translated</span>
<a href="#l28.243"></a><span id="l28.243">     //  block.</span>
<a href="#l28.244"></a><span id="l28.244" class="difflineat">@@ -548,18 +548,18 @@ JSTreeSelection.prototype = {</span>
<a href="#l28.245"></a><span id="l28.245">     // we may have to merge the lowest translated block because it may now be</span>
<a href="#l28.246"></a><span id="l28.246">     //  adjacent to the previous block</span>
<a href="#l28.247"></a><span id="l28.247">     if (iTrans &gt; 0 &amp;&amp; iTrans &lt; this._ranges.length &amp;&amp;</span>
<a href="#l28.248"></a><span id="l28.248">         this._ranges[iTrans-1][1] == this_ranges[iTrans][0]) {</span>
<a href="#l28.249"></a><span id="l28.249">       this._ranges[iTrans-1][1] = this._ranges[iTrans][1];</span>
<a href="#l28.250"></a><span id="l28.250">       this._ranges.splice(iTrans, 1);</span>
<a href="#l28.251"></a><span id="l28.251">     }</span>
<a href="#l28.252"></a><span id="l28.252"> </span>
<a href="#l28.253"></a><span id="l28.253" class="difflineminus">-    if (this._treeBoxObject)</span>
<a href="#l28.254"></a><span id="l28.254" class="difflineminus">-      this._treeBoxObject.invalidate();</span>
<a href="#l28.255"></a><span id="l28.255" class="difflineplus">+    if (this._tree)</span>
<a href="#l28.256"></a><span id="l28.256" class="difflineplus">+      this._tree.invalidate();</span>
<a href="#l28.257"></a><span id="l28.257">     this.selectEventsSuppressed = saveSuppress;</span>
<a href="#l28.258"></a><span id="l28.258">   },</span>
<a href="#l28.259"></a><span id="l28.259"> </span>
<a href="#l28.260"></a><span id="l28.260">   get selectEventsSuppressed() {</span>
<a href="#l28.261"></a><span id="l28.261">     return this._selectEventsSuppressed;</span>
<a href="#l28.262"></a><span id="l28.262">   },</span>
<a href="#l28.263"></a><span id="l28.263">   /**</span>
<a href="#l28.264"></a><span id="l28.264">    * Control whether selection events are suppressed.  For consistency with</span>
<a href="#l28.265"></a><span id="l28.265" class="difflineat">@@ -577,18 +577,18 @@ JSTreeSelection.prototype = {</span>
<a href="#l28.266"></a><span id="l28.266">    *  straight to the view.  If you have a tree, you shouldn't be using us,</span>
<a href="#l28.267"></a><span id="l28.267">    *  so this seems aboot right.</span>
<a href="#l28.268"></a><span id="l28.268">    */</span>
<a href="#l28.269"></a><span id="l28.269">   _fireSelectionChanged: function JSTreeSelection__fireSelectionChanged() {</span>
<a href="#l28.270"></a><span id="l28.270">     // don't fire if we are suppressed; we will fire when un-suppressed</span>
<a href="#l28.271"></a><span id="l28.271">     if (this.selectEventsSuppressed)</span>
<a href="#l28.272"></a><span id="l28.272">       return;</span>
<a href="#l28.273"></a><span id="l28.273">     let view;</span>
<a href="#l28.274"></a><span id="l28.274" class="difflineminus">-    if (this._treeBoxObject &amp;&amp; this._treeBoxObject.view)</span>
<a href="#l28.275"></a><span id="l28.275" class="difflineminus">-      view = this._treeBoxObject.view;</span>
<a href="#l28.276"></a><span id="l28.276" class="difflineplus">+    if (this._tree &amp;&amp; this._tree.view)</span>
<a href="#l28.277"></a><span id="l28.277" class="difflineplus">+      view = this._tree.view;</span>
<a href="#l28.278"></a><span id="l28.278">     else</span>
<a href="#l28.279"></a><span id="l28.279">       view = this._view;</span>
<a href="#l28.280"></a><span id="l28.280"> </span>
<a href="#l28.281"></a><span id="l28.281">     // We might not have a view if we're in the middle of setting up things</span>
<a href="#l28.282"></a><span id="l28.282">     if (view) {</span>
<a href="#l28.283"></a><span id="l28.283">       view = view.QueryInterface(Ci.nsITreeView);</span>
<a href="#l28.284"></a><span id="l28.284">       view.selectionChanged();</span>
<a href="#l28.285"></a><span id="l28.285">     }</span>
<a href="#l28.286"></a><span id="l28.286" class="difflineat">@@ -604,18 +604,18 @@ JSTreeSelection.prototype = {</span>
<a href="#l28.287"></a><span id="l28.287">    *  invalidates the tree row if we have a tree.</span>
<a href="#l28.288"></a><span id="l28.288">    * The real selection object would send a DOM event we don't care about.</span>
<a href="#l28.289"></a><span id="l28.289">    */</span>
<a href="#l28.290"></a><span id="l28.290">   set currentIndex(aIndex) {</span>
<a href="#l28.291"></a><span id="l28.291">     if (aIndex == this.currentIndex)</span>
<a href="#l28.292"></a><span id="l28.292">       return;</span>
<a href="#l28.293"></a><span id="l28.293"> </span>
<a href="#l28.294"></a><span id="l28.294">     this._currentIndex = (aIndex != -1) ? aIndex : null;</span>
<a href="#l28.295"></a><span id="l28.295" class="difflineminus">-    if (this._treeBoxObject)</span>
<a href="#l28.296"></a><span id="l28.296" class="difflineminus">-      this._treeBoxObject.invalidateRow(aIndex);</span>
<a href="#l28.297"></a><span id="l28.297" class="difflineplus">+    if (this._tree)</span>
<a href="#l28.298"></a><span id="l28.298" class="difflineplus">+      this._tree.invalidateRow(aIndex);</span>
<a href="#l28.299"></a><span id="l28.299">   },</span>
<a href="#l28.300"></a><span id="l28.300"> </span>
<a href="#l28.301"></a><span id="l28.301">   currentColumn: null,</span>
<a href="#l28.302"></a><span id="l28.302"> </span>
<a href="#l28.303"></a><span id="l28.303">   get shiftSelectPivot() {</span>
<a href="#l28.304"></a><span id="l28.304">     return this._shiftSelectPivot != null ? this._shiftSelectPivot : -1;</span>
<a href="#l28.305"></a><span id="l28.305">   },</span>
<a href="#l28.306"></a><span id="l28.306"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/mailnews/extensions/newsblog/content/FeedUtils.jsm</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/mailnews/extensions/newsblog/content/FeedUtils.jsm</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -863,17 +863,17 @@ var FeedUtils = {</span>
<a href="#l29.4"></a><span id="l29.4">       } else {</span>
<a href="#l29.5"></a><span id="l29.5">         let row = win.gFolderTreeView.getIndexOfFolder(aFolder);</span>
<a href="#l29.6"></a><span id="l29.6">         win.gFolderTreeView._tree.invalidateRow(row);</span>
<a href="#l29.7"></a><span id="l29.7">       }</span>
<a href="#l29.8"></a><span id="l29.8">     }</span>
<a href="#l29.9"></a><span id="l29.9"> </span>
<a href="#l29.10"></a><span id="l29.10">     win = Services.wm.getMostRecentWindow(&quot;Mail:News-BlogSubscriptions&quot;);</span>
<a href="#l29.11"></a><span id="l29.11">     if (win) {</span>
<a href="#l29.12"></a><span id="l29.12" class="difflineminus">-      win.FeedSubscriptions.mView.treeBox.invalidate();</span>
<a href="#l29.13"></a><span id="l29.13" class="difflineplus">+      win.FeedSubscriptions.mView.tree.invalidate();</span>
<a href="#l29.14"></a><span id="l29.14">     }</span>
<a href="#l29.15"></a><span id="l29.15">   },</span>
<a href="#l29.16"></a><span id="l29.16"> </span>
<a href="#l29.17"></a><span id="l29.17">   /**</span>
<a href="#l29.18"></a><span id="l29.18">    * Get the favicon for a feed folder subscription url (first one) or a feed</span>
<a href="#l29.19"></a><span id="l29.19">    * message url. The favicon service caches it in memory if places history is</span>
<a href="#l29.20"></a><span id="l29.20">    * not enabled.</span>
<a href="#l29.21"></a><span id="l29.21">    *</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/mailnews/extensions/newsblog/content/feed-subscriptions.js</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/mailnews/extensions/newsblog/content/feed-subscriptions.js</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -104,17 +104,17 @@ var FeedSubscriptions = {</span>
<a href="#l30.4"></a><span id="l30.4">         }</span>
<a href="#l30.5"></a><span id="l30.5">       } else {</span>
<a href="#l30.6"></a><span id="l30.6">         let url = item.parentFolder == aSelectFolder ? aSelectFeedUrl :</span>
<a href="#l30.7"></a><span id="l30.7">                                                        item.url;</span>
<a href="#l30.8"></a><span id="l30.8">         this.selectFeed({ folder: rootFolder, url }, null);</span>
<a href="#l30.9"></a><span id="l30.9">       }</span>
<a href="#l30.10"></a><span id="l30.10">     }</span>
<a href="#l30.11"></a><span id="l30.11"> </span>
<a href="#l30.12"></a><span id="l30.12" class="difflineminus">-    this.mView.treeBox.ensureRowIsVisible(this.mView.selection.currentIndex);</span>
<a href="#l30.13"></a><span id="l30.13" class="difflineplus">+    this.mView.tree.ensureRowIsVisible(this.mView.selection.currentIndex);</span>
<a href="#l30.14"></a><span id="l30.14">     this.clearStatusInfo();</span>
<a href="#l30.15"></a><span id="l30.15">   },</span>
<a href="#l30.16"></a><span id="l30.16"> </span>
<a href="#l30.17"></a><span id="l30.17">   mView: {</span>
<a href="#l30.18"></a><span id="l30.18">     kRowIndexUndefined: -1,</span>
<a href="#l30.19"></a><span id="l30.19"> </span>
<a href="#l30.20"></a><span id="l30.20">     get currentItem() {</span>
<a href="#l30.21"></a><span id="l30.21">       // Get the current selection, if any.</span>
<a href="#l30.22"></a><span id="l30.22" class="difflineat">@@ -125,26 +125,26 @@ var FeedSubscriptions = {</span>
<a href="#l30.23"></a><span id="l30.23">         item = this.getItemAtIndex(currentSelectionIndex);</span>
<a href="#l30.24"></a><span id="l30.24">       }</span>
<a href="#l30.25"></a><span id="l30.25"> </span>
<a href="#l30.26"></a><span id="l30.26">       return item;</span>
<a href="#l30.27"></a><span id="l30.27">     },</span>
<a href="#l30.28"></a><span id="l30.28"> </span>
<a href="#l30.29"></a><span id="l30.29">     /* nsITreeView */</span>
<a href="#l30.30"></a><span id="l30.30">     /* eslint-disable no-multi-spaces */</span>
<a href="#l30.31"></a><span id="l30.31" class="difflineminus">-    treeBox: null,</span>
<a href="#l30.32"></a><span id="l30.32" class="difflineplus">+    tree: null,</span>
<a href="#l30.33"></a><span id="l30.33"> </span>
<a href="#l30.34"></a><span id="l30.34">     mRowCount: 0,</span>
<a href="#l30.35"></a><span id="l30.35">     get rowCount()               { return this.mRowCount; },</span>
<a href="#l30.36"></a><span id="l30.36"> </span>
<a href="#l30.37"></a><span id="l30.37">     _selection:                  null,</span>
<a href="#l30.38"></a><span id="l30.38">     get selection()              { return this._selection; },</span>
<a href="#l30.39"></a><span id="l30.39">     set selection(val)           { return this._selection = val; },</span>
<a href="#l30.40"></a><span id="l30.40"> </span>
<a href="#l30.41"></a><span id="l30.41" class="difflineminus">-    setTree(aTreebox)            { this.treeBox = aTreebox; },</span>
<a href="#l30.42"></a><span id="l30.42" class="difflineplus">+    setTree(aTree)               { this.tree = aTree; },</span>
<a href="#l30.43"></a><span id="l30.43">     isSeparator(aRow)            { return false; },</span>
<a href="#l30.44"></a><span id="l30.44">     isSorted()                   { return false; },</span>
<a href="#l30.45"></a><span id="l30.45">     isEditable(aRow, aColumn)    { return false; },</span>
<a href="#l30.46"></a><span id="l30.46"> </span>
<a href="#l30.47"></a><span id="l30.47">     getProgressMode(aRow, aCol)  {},</span>
<a href="#l30.48"></a><span id="l30.48">     cycleHeader(aCol)            {},</span>
<a href="#l30.49"></a><span id="l30.49">     cycleCell(aRow, aCol)        {},</span>
<a href="#l30.50"></a><span id="l30.50">     selectionChanged()           {},</span>
<a href="#l30.51"></a><span id="l30.51" class="difflineat">@@ -269,17 +269,17 @@ var FeedSubscriptions = {</span>
<a href="#l30.52"></a><span id="l30.52">         }</span>
<a href="#l30.53"></a><span id="l30.53">       }</span>
<a href="#l30.54"></a><span id="l30.54"> </span>
<a href="#l30.55"></a><span id="l30.55">       // Now remove it from our view.</span>
<a href="#l30.56"></a><span id="l30.56">       FeedSubscriptions.mFeedContainers.splice(aRow, 1);</span>
<a href="#l30.57"></a><span id="l30.57"> </span>
<a href="#l30.58"></a><span id="l30.58">       // Now invalidate the correct tree rows.</span>
<a href="#l30.59"></a><span id="l30.59">       this.mRowCount--;</span>
<a href="#l30.60"></a><span id="l30.60" class="difflineminus">-      this.treeBox.rowCountChanged(aRow, -1);</span>
<a href="#l30.61"></a><span id="l30.61" class="difflineplus">+      this.tree.rowCountChanged(aRow, -1);</span>
<a href="#l30.62"></a><span id="l30.62"> </span>
<a href="#l30.63"></a><span id="l30.63">       // Now update the selection position, unless noSelect (selection is</span>
<a href="#l30.64"></a><span id="l30.64">       // done later or not at all).  If the item is the last child, select the</span>
<a href="#l30.65"></a><span id="l30.65">       // parent.  Otherwise select the next sibling.</span>
<a href="#l30.66"></a><span id="l30.66">       if (!aNoSelect) {</span>
<a href="#l30.67"></a><span id="l30.67">         if (aRow &lt;= FeedSubscriptions.mFeedContainers.length) {</span>
<a href="#l30.68"></a><span id="l30.68">           this.selection.select(hasNextSibling ? aRow : aRow - 1);</span>
<a href="#l30.69"></a><span id="l30.69">         } else {</span>
<a href="#l30.70"></a><span id="l30.70" class="difflineat">@@ -570,17 +570,17 @@ var FeedSubscriptions = {</span>
<a href="#l30.71"></a><span id="l30.71"> </span>
<a href="#l30.72"></a><span id="l30.72">       let delta = multiplier * rowCount;</span>
<a href="#l30.73"></a><span id="l30.73">       this.mRowCount += delta;</span>
<a href="#l30.74"></a><span id="l30.74"> </span>
<a href="#l30.75"></a><span id="l30.75">       item.open = !item.open;</span>
<a href="#l30.76"></a><span id="l30.76">       // Suppress the select event caused by rowCountChanged.</span>
<a href="#l30.77"></a><span id="l30.77">       this.selection.selectEventsSuppressed = true;</span>
<a href="#l30.78"></a><span id="l30.78">       // Add or remove the children from our view.</span>
<a href="#l30.79"></a><span id="l30.79" class="difflineminus">-      this.treeBox.rowCountChanged(aRow, delta);</span>
<a href="#l30.80"></a><span id="l30.80" class="difflineplus">+      this.tree.rowCountChanged(aRow, delta);</span>
<a href="#l30.81"></a><span id="l30.81">       return delta;</span>
<a href="#l30.82"></a><span id="l30.82">     },</span>
<a href="#l30.83"></a><span id="l30.83">   },</span>
<a href="#l30.84"></a><span id="l30.84"> </span>
<a href="#l30.85"></a><span id="l30.85">   makeFolderObject(aFolder, aCurrentLevel) {</span>
<a href="#l30.86"></a><span id="l30.86">     let defaultQuickMode = aFolder.server.getBoolValue(&quot;quickMode&quot;);</span>
<a href="#l30.87"></a><span id="l30.87">     let optionsAcct = aFolder.isServer ? FeedUtils.getOptionsAcct(aFolder.server) :</span>
<a href="#l30.88"></a><span id="l30.88">                                          null;</span>
<a href="#l30.89"></a><span id="l30.89" class="difflineat">@@ -719,18 +719,18 @@ var FeedSubscriptions = {</span>
<a href="#l30.90"></a><span id="l30.90">     let selectIt = aParms &amp;&amp; (&quot;select&quot; in aParms) ? aParms.select : true;</span>
<a href="#l30.91"></a><span id="l30.91">     let openIt = aParms &amp;&amp; (&quot;open&quot; in aParms) ? aParms.open : true;</span>
<a href="#l30.92"></a><span id="l30.92">     let removeIt = aParms &amp;&amp; (&quot;remove&quot; in aParms) ? aParms.remove : false;</span>
<a href="#l30.93"></a><span id="l30.93">     let newFolder = aParms &amp;&amp; (&quot;newFolder&quot; in aParms) ? aParms.newFolder : null;</span>
<a href="#l30.94"></a><span id="l30.94">     let startIndex, startItem;</span>
<a href="#l30.95"></a><span id="l30.95">     let found = false;</span>
<a href="#l30.96"></a><span id="l30.96"> </span>
<a href="#l30.97"></a><span id="l30.97">     let firstVisRow, curFirstVisRow, curLastVisRow;</span>
<a href="#l30.98"></a><span id="l30.98" class="difflineminus">-    if (this.mView.treeBox) {</span>
<a href="#l30.99"></a><span id="l30.99" class="difflineminus">-      firstVisRow = this.mView.treeBox.getFirstVisibleRow();</span>
<a href="#l30.100"></a><span id="l30.100" class="difflineplus">+    if (this.mView.tree) {</span>
<a href="#l30.101"></a><span id="l30.101" class="difflineplus">+      firstVisRow = this.mView.tree.getFirstVisibleRow();</span>
<a href="#l30.102"></a><span id="l30.102">     }</span>
<a href="#l30.103"></a><span id="l30.103"> </span>
<a href="#l30.104"></a><span id="l30.104">     if (parentIndex != null) {</span>
<a href="#l30.105"></a><span id="l30.105">       // Use the parentIndex if given.</span>
<a href="#l30.106"></a><span id="l30.106">       startIndex = parentIndex;</span>
<a href="#l30.107"></a><span id="l30.107">       if (aFolder.isServer) {</span>
<a href="#l30.108"></a><span id="l30.108">         // Fake item for account root folder.</span>
<a href="#l30.109"></a><span id="l30.109">         startItem = { name:     &quot;AccountRoot&quot;,</span>
<a href="#l30.110"></a><span id="l30.110" class="difflineat">@@ -854,23 +854,23 @@ var FeedSubscriptions = {</span>
<a href="#l30.111"></a><span id="l30.111"> </span>
<a href="#l30.112"></a><span id="l30.112">         this.mView.selection.select(index);</span>
<a href="#l30.113"></a><span id="l30.113">         found = true;</span>
<a href="#l30.114"></a><span id="l30.114">         break;</span>
<a href="#l30.115"></a><span id="l30.115">       }</span>
<a href="#l30.116"></a><span id="l30.116">     }</span>
<a href="#l30.117"></a><span id="l30.117"> </span>
<a href="#l30.118"></a><span id="l30.118">     // Ensure tree position does not jump unnecessarily.</span>
<a href="#l30.119"></a><span id="l30.119" class="difflineminus">-    curFirstVisRow = this.mView.treeBox.getFirstVisibleRow();</span>
<a href="#l30.120"></a><span id="l30.120" class="difflineminus">-    curLastVisRow = this.mView.treeBox.getLastVisibleRow();</span>
<a href="#l30.121"></a><span id="l30.121" class="difflineplus">+    curFirstVisRow = this.mView.tree.getFirstVisibleRow();</span>
<a href="#l30.122"></a><span id="l30.122" class="difflineplus">+    curLastVisRow = this.mView.tree.getLastVisibleRow();</span>
<a href="#l30.123"></a><span id="l30.123">     if (firstVisRow &gt;= 0 &amp;&amp;</span>
<a href="#l30.124"></a><span id="l30.124">         this.mView.rowCount - curLastVisRow &gt; firstVisRow - curFirstVisRow) {</span>
<a href="#l30.125"></a><span id="l30.125" class="difflineminus">-      this.mView.treeBox.scrollToRow(firstVisRow);</span>
<a href="#l30.126"></a><span id="l30.126" class="difflineplus">+      this.mView.tree.scrollToRow(firstVisRow);</span>
<a href="#l30.127"></a><span id="l30.127">     } else {</span>
<a href="#l30.128"></a><span id="l30.128" class="difflineminus">-      this.mView.treeBox.ensureRowIsVisible(this.mView.rowCount - 1);</span>
<a href="#l30.129"></a><span id="l30.129" class="difflineplus">+      this.mView.tree.ensureRowIsVisible(this.mView.rowCount - 1);</span>
<a href="#l30.130"></a><span id="l30.130">     }</span>
<a href="#l30.131"></a><span id="l30.131"> </span>
<a href="#l30.132"></a><span id="l30.132">     FeedUtils.log.debug(&quot;selectFolder: curIndex:firstVisRow:&quot; +</span>
<a href="#l30.133"></a><span id="l30.133">                         &quot;curFirstVisRow:curLastVisRow:rowCount - &quot; +</span>
<a href="#l30.134"></a><span id="l30.134">                         this.mView.selection.currentIndex + &quot;:&quot; +</span>
<a href="#l30.135"></a><span id="l30.135">                         firstVisRow + &quot;:&quot; +</span>
<a href="#l30.136"></a><span id="l30.136">                         curFirstVisRow + &quot;:&quot; + curLastVisRow + &quot;:&quot; + this.mView.rowCount);</span>
<a href="#l30.137"></a><span id="l30.137">     return found;</span>
<a href="#l30.138"></a><span id="l30.138" class="difflineat">@@ -900,17 +900,17 @@ var FeedSubscriptions = {</span>
<a href="#l30.139"></a><span id="l30.139"> </span>
<a href="#l30.140"></a><span id="l30.140">     if (this.selectFolder(folder, { parentIndex: aParentIndex })) {</span>
<a href="#l30.141"></a><span id="l30.141">       let seln = this.mView.selection;</span>
<a href="#l30.142"></a><span id="l30.142">       let item = this.mView.currentItem;</span>
<a href="#l30.143"></a><span id="l30.143">       if (item) {</span>
<a href="#l30.144"></a><span id="l30.144">         for (let i = seln.currentIndex + 1; i &lt; this.mView.rowCount; i++) {</span>
<a href="#l30.145"></a><span id="l30.145">           if (this.mView.getItemAtIndex(i).url == aFeed.url) {</span>
<a href="#l30.146"></a><span id="l30.146">             this.mView.selection.select(i);</span>
<a href="#l30.147"></a><span id="l30.147" class="difflineminus">-            this.mView.treeBox.ensureRowIsVisible(i);</span>
<a href="#l30.148"></a><span id="l30.148" class="difflineplus">+            this.mView.tree.ensureRowIsVisible(i);</span>
<a href="#l30.149"></a><span id="l30.149">             found = true;</span>
<a href="#l30.150"></a><span id="l30.150">             break;</span>
<a href="#l30.151"></a><span id="l30.151">           }</span>
<a href="#l30.152"></a><span id="l30.152">         }</span>
<a href="#l30.153"></a><span id="l30.153">       }</span>
<a href="#l30.154"></a><span id="l30.154">     }</span>
<a href="#l30.155"></a><span id="l30.155"> </span>
<a href="#l30.156"></a><span id="l30.156">     return found;</span>
<a href="#l30.157"></a><span id="l30.157" class="difflineat">@@ -1983,30 +1983,30 @@ var FeedSubscriptions = {</span>
<a href="#l30.158"></a><span id="l30.158">                           (parentFolder ? parentFolder.filePath.path : &quot;(null)&quot;));</span>
<a href="#l30.159"></a><span id="l30.159"> </span>
<a href="#l30.160"></a><span id="l30.160">       if (!parentFolder || !this.feedWindow) {</span>
<a href="#l30.161"></a><span id="l30.161">         return;</span>
<a href="#l30.162"></a><span id="l30.162">       }</span>
<a href="#l30.163"></a><span id="l30.163"> </span>
<a href="#l30.164"></a><span id="l30.164">       let feedWindow = this.feedWindow;</span>
<a href="#l30.165"></a><span id="l30.165">       let curSelItem = this.currentSelectedItem;</span>
<a href="#l30.166"></a><span id="l30.166" class="difflineminus">-      let firstVisRow = feedWindow.mView.treeBox.getFirstVisibleRow();</span>
<a href="#l30.167"></a><span id="l30.167" class="difflineplus">+      let firstVisRow = feedWindow.mView.tree.getFirstVisibleRow();</span>
<a href="#l30.168"></a><span id="l30.168">       let indexInView = feedWindow.mView.getItemInViewIndex(parentFolder);</span>
<a href="#l30.169"></a><span id="l30.169">       let open = indexInView != null;</span>
<a href="#l30.170"></a><span id="l30.170"> </span>
<a href="#l30.171"></a><span id="l30.171">       if (aFolder.isServer) {</span>
<a href="#l30.172"></a><span id="l30.172">         if (indexInView != null) {</span>
<a href="#l30.173"></a><span id="l30.173">           // Existing account root folder in the view.</span>
<a href="#l30.174"></a><span id="l30.174">           open = feedWindow.mView.getItemAtIndex(indexInView).open;</span>
<a href="#l30.175"></a><span id="l30.175">         } else {</span>
<a href="#l30.176"></a><span id="l30.176">           // Add the account root folder to the view.</span>
<a href="#l30.177"></a><span id="l30.177">           feedWindow.mFeedContainers.push(feedWindow.makeFolderObject(parentFolder, 0));</span>
<a href="#l30.178"></a><span id="l30.178">           feedWindow.mView.mRowCount++;</span>
<a href="#l30.179"></a><span id="l30.179">           feedWindow.mTree.view = feedWindow.mView;</span>
<a href="#l30.180"></a><span id="l30.180" class="difflineminus">-          feedWindow.mView.treeBox.scrollToRow(firstVisRow);</span>
<a href="#l30.181"></a><span id="l30.181" class="difflineplus">+          feedWindow.mView.tree.scrollToRow(firstVisRow);</span>
<a href="#l30.182"></a><span id="l30.182">           return;</span>
<a href="#l30.183"></a><span id="l30.183">         }</span>
<a href="#l30.184"></a><span id="l30.184">       }</span>
<a href="#l30.185"></a><span id="l30.185"> </span>
<a href="#l30.186"></a><span id="l30.186">       // Rebuild the added folder's parent item in the tree row cache.</span>
<a href="#l30.187"></a><span id="l30.187">       feedWindow.selectFolder(parentFolder, { select: false,</span>
<a href="#l30.188"></a><span id="l30.188">                                               open,</span>
<a href="#l30.189"></a><span id="l30.189">                                               newFolder: parentFolder });</span>
<a href="#l30.190"></a><span id="l30.190" class="difflineat">@@ -2023,17 +2023,17 @@ var FeedSubscriptions = {</span>
<a href="#l30.191"></a><span id="l30.191">       }</span>
<a href="#l30.192"></a><span id="l30.192"> </span>
<a href="#l30.193"></a><span id="l30.193">       if (open) {</span>
<a href="#l30.194"></a><span id="l30.194">         // Close an open parent (or root) folder.</span>
<a href="#l30.195"></a><span id="l30.195">         feedWindow.mView.toggle(parentIndex);</span>
<a href="#l30.196"></a><span id="l30.196">         feedWindow.mView.toggleOpenState(parentIndex);</span>
<a href="#l30.197"></a><span id="l30.197">       }</span>
<a href="#l30.198"></a><span id="l30.198"> </span>
<a href="#l30.199"></a><span id="l30.199" class="difflineminus">-      feedWindow.mView.treeBox.scrollToRow(firstVisRow);</span>
<a href="#l30.200"></a><span id="l30.200" class="difflineplus">+      feedWindow.mView.tree.scrollToRow(firstVisRow);</span>
<a href="#l30.201"></a><span id="l30.201"> </span>
<a href="#l30.202"></a><span id="l30.202">       if (curSelItem.container) {</span>
<a href="#l30.203"></a><span id="l30.203">         feedWindow.selectFolder(curSelItem.folder, { open: curSelItem.open });</span>
<a href="#l30.204"></a><span id="l30.204">       } else {</span>
<a href="#l30.205"></a><span id="l30.205">         feedWindow.selectFeed({ folder: curSelItem.parentFolder,</span>
<a href="#l30.206"></a><span id="l30.206">                                 url: curSelItem.url },</span>
<a href="#l30.207"></a><span id="l30.207">                               parentIndex);</span>
<a href="#l30.208"></a><span id="l30.208">       }</span>
<a href="#l30.209"></a><span id="l30.209" class="difflineat">@@ -2078,17 +2078,17 @@ var FeedSubscriptions = {</span>
<a href="#l30.210"></a><span id="l30.210">                           aOrigFolder.name + &quot;:&quot; + aNewFolder.name);</span>
<a href="#l30.211"></a><span id="l30.211">       if (!this.feedWindow) {</span>
<a href="#l30.212"></a><span id="l30.212">         return;</span>
<a href="#l30.213"></a><span id="l30.213">       }</span>
<a href="#l30.214"></a><span id="l30.214"> </span>
<a href="#l30.215"></a><span id="l30.215">       let feedWindow = this.feedWindow;</span>
<a href="#l30.216"></a><span id="l30.216">       let curSelIndex = this.currentSelectedIndex;</span>
<a href="#l30.217"></a><span id="l30.217">       let curSelItem = this.currentSelectedItem;</span>
<a href="#l30.218"></a><span id="l30.218" class="difflineminus">-      let firstVisRow = feedWindow.mView.treeBox.getFirstVisibleRow();</span>
<a href="#l30.219"></a><span id="l30.219" class="difflineplus">+      let firstVisRow = feedWindow.mView.tree.getFirstVisibleRow();</span>
<a href="#l30.220"></a><span id="l30.220">       let indexInView = feedWindow.mView.getItemInViewIndex(aOrigFolder);</span>
<a href="#l30.221"></a><span id="l30.221">       let open = indexInView != null;</span>
<a href="#l30.222"></a><span id="l30.222"> </span>
<a href="#l30.223"></a><span id="l30.223">       // Rebuild the renamed folder's item in the tree row cache.</span>
<a href="#l30.224"></a><span id="l30.224">       feedWindow.selectFolder(aOrigFolder, { select: false,</span>
<a href="#l30.225"></a><span id="l30.225">                                              open,</span>
<a href="#l30.226"></a><span id="l30.226">                                              newFolder: aNewFolder });</span>
<a href="#l30.227"></a><span id="l30.227"> </span>
<a href="#l30.228"></a><span id="l30.228" class="difflineat">@@ -2104,17 +2104,17 @@ var FeedSubscriptions = {</span>
<a href="#l30.229"></a><span id="l30.229">       let parentIndex = feedWindow.mView.getParentIndex(indexInView);</span>
<a href="#l30.230"></a><span id="l30.230">       if (parentIndex == feedWindow.mView.kRowIndexUndefined) {</span>
<a href="#l30.231"></a><span id="l30.231">         // Root folder is its own parent.</span>
<a href="#l30.232"></a><span id="l30.232">         parentIndex = indexInView;</span>
<a href="#l30.233"></a><span id="l30.233">       }</span>
<a href="#l30.234"></a><span id="l30.234"> </span>
<a href="#l30.235"></a><span id="l30.235">       feedWindow.mView.toggle(parentIndex);</span>
<a href="#l30.236"></a><span id="l30.236">       feedWindow.mView.toggleOpenState(parentIndex);</span>
<a href="#l30.237"></a><span id="l30.237" class="difflineminus">-      feedWindow.mView.treeBox.scrollToRow(firstVisRow);</span>
<a href="#l30.238"></a><span id="l30.238" class="difflineplus">+      feedWindow.mView.tree.scrollToRow(firstVisRow);</span>
<a href="#l30.239"></a><span id="l30.239"> </span>
<a href="#l30.240"></a><span id="l30.240">       if (curSelItem.container) {</span>
<a href="#l30.241"></a><span id="l30.241">         if (curSelItem.folder == aOrigFolder) {</span>
<a href="#l30.242"></a><span id="l30.242">           feedWindow.selectFolder(aNewFolder, { open: curSelItem.open });</span>
<a href="#l30.243"></a><span id="l30.243">         } else if (select) {</span>
<a href="#l30.244"></a><span id="l30.244">           feedWindow.mView.selection.select(indexInView);</span>
<a href="#l30.245"></a><span id="l30.245">         } else {</span>
<a href="#l30.246"></a><span id="l30.246">           feedWindow.selectFolder(curSelItem.folder, { open: curSelItem.open });</span>
<a href="#l30.247"></a><span id="l30.247" class="difflineat">@@ -2134,17 +2134,17 @@ var FeedSubscriptions = {</span>
<a href="#l30.248"></a><span id="l30.248">                           aMove + &quot;:&quot; + aSrcFolder.name + &quot;:&quot; + aDestFolder.name);</span>
<a href="#l30.249"></a><span id="l30.249">       if (!this.feedWindow) {</span>
<a href="#l30.250"></a><span id="l30.250">         return;</span>
<a href="#l30.251"></a><span id="l30.251">       }</span>
<a href="#l30.252"></a><span id="l30.252"> </span>
<a href="#l30.253"></a><span id="l30.253">       let feedWindow = this.feedWindow;</span>
<a href="#l30.254"></a><span id="l30.254">       let curSelIndex = this.currentSelectedIndex;</span>
<a href="#l30.255"></a><span id="l30.255">       let curSelItem = this.currentSelectedItem;</span>
<a href="#l30.256"></a><span id="l30.256" class="difflineminus">-      let firstVisRow = feedWindow.mView.treeBox.getFirstVisibleRow();</span>
<a href="#l30.257"></a><span id="l30.257" class="difflineplus">+      let firstVisRow = feedWindow.mView.tree.getFirstVisibleRow();</span>
<a href="#l30.258"></a><span id="l30.258">       let indexInView = feedWindow.mView.getItemInViewIndex(aSrcFolder);</span>
<a href="#l30.259"></a><span id="l30.259">       let destIndexInView = feedWindow.mView.getItemInViewIndex(aDestFolder);</span>
<a href="#l30.260"></a><span id="l30.260">       let open = indexInView != null || destIndexInView != null;</span>
<a href="#l30.261"></a><span id="l30.261">       let parentIndex = feedWindow.mView.getItemInViewIndex(aDestFolder.parent ||</span>
<a href="#l30.262"></a><span id="l30.262">                                                             aDestFolder);</span>
<a href="#l30.263"></a><span id="l30.263">       let select =</span>
<a href="#l30.264"></a><span id="l30.264">         indexInView == curSelIndex ||</span>
<a href="#l30.265"></a><span id="l30.265">         feedWindow.mView.isIndexChildOfParentIndex(indexInView, curSelIndex);</span>
<a href="#l30.266"></a><span id="l30.266" class="difflineat">@@ -2164,17 +2164,17 @@ var FeedSubscriptions = {</span>
<a href="#l30.267"></a><span id="l30.267"> </span>
<a href="#l30.268"></a><span id="l30.268">         if (!open || !curSelItem) {</span>
<a href="#l30.269"></a><span id="l30.269">           // Folder isn't in the tree view, no need to update the view.</span>
<a href="#l30.270"></a><span id="l30.270">           return;</span>
<a href="#l30.271"></a><span id="l30.271">         }</span>
<a href="#l30.272"></a><span id="l30.272"> </span>
<a href="#l30.273"></a><span id="l30.273">         feedWindow.mView.toggle(parentIndex);</span>
<a href="#l30.274"></a><span id="l30.274">         feedWindow.mView.toggleOpenState(parentIndex);</span>
<a href="#l30.275"></a><span id="l30.275" class="difflineminus">-        feedWindow.mView.treeBox.scrollToRow(firstVisRow);</span>
<a href="#l30.276"></a><span id="l30.276" class="difflineplus">+        feedWindow.mView.tree.scrollToRow(firstVisRow);</span>
<a href="#l30.277"></a><span id="l30.277"> </span>
<a href="#l30.278"></a><span id="l30.278">         if (curSelItem.container) {</span>
<a href="#l30.279"></a><span id="l30.279">           if (curSelItem.folder == aSrcFolder || select) {</span>
<a href="#l30.280"></a><span id="l30.280">             feedWindow.selectFolder(aDestFolder, { open: true });</span>
<a href="#l30.281"></a><span id="l30.281">           } else {</span>
<a href="#l30.282"></a><span id="l30.282">             feedWindow.selectFolder(curSelItem.folder, { open: curSelItem.open });</span>
<a href="#l30.283"></a><span id="l30.283">           }</span>
<a href="#l30.284"></a><span id="l30.284">         } else {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/mailnews/extensions/newsblog/content/newsblogOverlay.js</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/mailnews/extensions/newsblog/content/newsblogOverlay.js</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -272,17 +272,17 @@ var FeedMessageHandler = {</span>
<a href="#l31.4"></a><span id="l31.4"> function openSubscriptionsDialog(aFolder) {</span>
<a href="#l31.5"></a><span id="l31.5">   // Check for an existing feed subscriptions window and focus it.</span>
<a href="#l31.6"></a><span id="l31.6">   let subscriptionsWindow =</span>
<a href="#l31.7"></a><span id="l31.7">     Services.wm.getMostRecentWindow(&quot;Mail:News-BlogSubscriptions&quot;);</span>
<a href="#l31.8"></a><span id="l31.8"> </span>
<a href="#l31.9"></a><span id="l31.9">   if (subscriptionsWindow) {</span>
<a href="#l31.10"></a><span id="l31.10">     if (aFolder) {</span>
<a href="#l31.11"></a><span id="l31.11">       subscriptionsWindow.FeedSubscriptions.selectFolder(aFolder);</span>
<a href="#l31.12"></a><span id="l31.12" class="difflineminus">-      subscriptionsWindow.FeedSubscriptions.mView.treeBox.ensureRowIsVisible(</span>
<a href="#l31.13"></a><span id="l31.13" class="difflineplus">+      subscriptionsWindow.FeedSubscriptions.mView.tree.ensureRowIsVisible(</span>
<a href="#l31.14"></a><span id="l31.14">         subscriptionsWindow.FeedSubscriptions.mView.selection.currentIndex);</span>
<a href="#l31.15"></a><span id="l31.15">     }</span>
<a href="#l31.16"></a><span id="l31.16"> </span>
<a href="#l31.17"></a><span id="l31.17">     subscriptionsWindow.focus();</span>
<a href="#l31.18"></a><span id="l31.18">   } else {</span>
<a href="#l31.19"></a><span id="l31.19">     window.openDialog(&quot;chrome://messenger-newsblog/content/feed-subscriptions.xul&quot;,</span>
<a href="#l31.20"></a><span id="l31.20">                       &quot;&quot;, &quot;centerscreen,chrome,dialog=no,resizable&quot;,</span>
<a href="#l31.21"></a><span id="l31.21">                       { folder: aFolder});</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

