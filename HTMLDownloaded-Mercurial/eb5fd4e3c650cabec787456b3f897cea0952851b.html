<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 29219:eb5fd4e3c650cabec787456b3f897cea0952851b</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ eb5fd4e3c650cabec787456b3f897cea0952851b" />
<meta property="og:url" content="/comm-central/rev/eb5fd4e3c650cabec787456b3f897cea0952851b" />
<meta property="og:description" content="Bug 1546606 - Refactor CalDAV request handling some more. r=Fallen" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / eb5fd4e3c650cabec787456b3f897cea0952851b 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/eb5fd4e3c650cabec787456b3f897cea0952851b">shortlog</a> |
<a href="/comm-central/log/eb5fd4e3c650cabec787456b3f897cea0952851b">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/eb5fd4e3c650cabec787456b3f897cea0952851b">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/eb5fd4e3c650cabec787456b3f897cea0952851b">files</a> |
changeset |
<a href="/comm-central/raw-rev/eb5fd4e3c650cabec787456b3f897cea0952851b">raw</a>  | <a href="/comm-central/archive/eb5fd4e3c650cabec787456b3f897cea0952851b.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1546606">Bug 1546606</a> - Refactor CalDAV request handling some more. r=Fallen
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#80;&#97;&#117;&#108;&#32;&#77;&#111;&#114;&#114;&#105;&#115;&#32;&#60;&#112;&#97;&#117;&#108;&#64;&#116;&#104;&#117;&#110;&#100;&#101;&#114;&#98;&#105;&#114;&#100;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 09 Apr 2020 13:51:31 +0300</td></tr>

<tr>
 <td>changeset 29219</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/eb5fd4e3c650cabec787456b3f897cea0952851b">eb5fd4e3c650cabec787456b3f897cea0952851b</a></td>
</tr>



<tr>
<td>parent 29218</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/eefb833d48f28a41c97cd3ce9e84423201523a01">eefb833d48f28a41c97cd3ce9e84423201523a01</a>
</td>
</tr>

<tr>
<td>child 29220</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/9deaa698c34d732c24ab76e10dd0083e8472739a">9deaa698c34d732c24ab76e10dd0083e8472739a</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=eb5fd4e3c650cabec787456b3f897cea0952851b">17264</a></td></tr>
<tr><td>push user</td><td>mkmelin@iki.fi</td></tr>
<tr><td>push date</td><td class="date age">Thu, 09 Apr 2020 10:54:30 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@7ebcf56c0e59 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=7ebcf56c0e59161b0e8dade8311e95d23b38980e">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=7ebcf56c0e59161b0e8dade8311e95d23b38980e&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=7ebcf56c0e59161b0e8dade8311e95d23b38980e&newProject=comm-central&newRevision=84249ce5084a8b7a0925b5d35c00331870a56a0c&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=7ebcf56c0e59161b0e8dade8311e95d23b38980e&newProject=comm-central&newRevision=84249ce5084a8b7a0925b5d35c00331870a56a0c&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=7ebcf56c0e59161b0e8dade8311e95d23b38980e&newProject=comm-central&newRevision=84249ce5084a8b7a0925b5d35c00331870a56a0c&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28Fallen%29&revcount=50">Fallen</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1546606">1546606</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1546606">Bug 1546606</a> - Refactor CalDAV request handling some more. r=Fallen

- Capitalize names for the new jsm modules
- Prefix exported classes with `CalDav`
- Fix the header iterator in test_caldav_requests.js
- Other small test fixes
- Do a basic checkRedirected function implementation, etc.
- Various edits and updates to satisfy eslint, etc.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/eb5fd4e3c650cabec787456b3f897cea0952851b/calendar/base/src/calCachedCalendar.js">calendar/base/src/calCachedCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/eb5fd4e3c650cabec787456b3f897cea0952851b/calendar/base/src/calCachedCalendar.js">file</a> |
<a href="/comm-central/annotate/eb5fd4e3c650cabec787456b3f897cea0952851b/calendar/base/src/calCachedCalendar.js">annotate</a> |
<a href="/comm-central/diff/eb5fd4e3c650cabec787456b3f897cea0952851b/calendar/base/src/calCachedCalendar.js">diff</a> |
<a href="/comm-central/comparison/eb5fd4e3c650cabec787456b3f897cea0952851b/calendar/base/src/calCachedCalendar.js">comparison</a> |
<a href="/comm-central/log/eb5fd4e3c650cabec787456b3f897cea0952851b/calendar/base/src/calCachedCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/eb5fd4e3c650cabec787456b3f897cea0952851b/calendar/providers/caldav/CalDavCalendar.jsm">calendar/providers/caldav/CalDavCalendar.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/eb5fd4e3c650cabec787456b3f897cea0952851b/calendar/providers/caldav/CalDavCalendar.jsm">file</a> |
<a href="/comm-central/annotate/eb5fd4e3c650cabec787456b3f897cea0952851b/calendar/providers/caldav/CalDavCalendar.jsm">annotate</a> |
<a href="/comm-central/diff/eb5fd4e3c650cabec787456b3f897cea0952851b/calendar/providers/caldav/CalDavCalendar.jsm">diff</a> |
<a href="/comm-central/comparison/eb5fd4e3c650cabec787456b3f897cea0952851b/calendar/providers/caldav/CalDavCalendar.jsm">comparison</a> |
<a href="/comm-central/log/eb5fd4e3c650cabec787456b3f897cea0952851b/calendar/providers/caldav/CalDavCalendar.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/eb5fd4e3c650cabec787456b3f897cea0952851b/calendar/providers/caldav/calDavRequestHandlers.js">calendar/providers/caldav/calDavRequestHandlers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/eb5fd4e3c650cabec787456b3f897cea0952851b/calendar/providers/caldav/calDavRequestHandlers.js">file</a> |
<a href="/comm-central/annotate/eb5fd4e3c650cabec787456b3f897cea0952851b/calendar/providers/caldav/calDavRequestHandlers.js">annotate</a> |
<a href="/comm-central/diff/eb5fd4e3c650cabec787456b3f897cea0952851b/calendar/providers/caldav/calDavRequestHandlers.js">diff</a> |
<a href="/comm-central/comparison/eb5fd4e3c650cabec787456b3f897cea0952851b/calendar/providers/caldav/calDavRequestHandlers.js">comparison</a> |
<a href="/comm-central/log/eb5fd4e3c650cabec787456b3f897cea0952851b/calendar/providers/caldav/calDavRequestHandlers.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/eb5fd4e3c650cabec787456b3f897cea0952851b/calendar/providers/caldav/modules/CalDavRequest.jsm">calendar/providers/caldav/modules/CalDavRequest.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/eb5fd4e3c650cabec787456b3f897cea0952851b/calendar/providers/caldav/modules/CalDavRequest.jsm">file</a> |
<a href="/comm-central/annotate/eb5fd4e3c650cabec787456b3f897cea0952851b/calendar/providers/caldav/modules/CalDavRequest.jsm">annotate</a> |
<a href="/comm-central/diff/eb5fd4e3c650cabec787456b3f897cea0952851b/calendar/providers/caldav/modules/CalDavRequest.jsm">diff</a> |
<a href="/comm-central/comparison/eb5fd4e3c650cabec787456b3f897cea0952851b/calendar/providers/caldav/modules/CalDavRequest.jsm">comparison</a> |
<a href="/comm-central/log/eb5fd4e3c650cabec787456b3f897cea0952851b/calendar/providers/caldav/modules/CalDavRequest.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/eb5fd4e3c650cabec787456b3f897cea0952851b/calendar/providers/caldav/modules/CalDavSession.jsm">calendar/providers/caldav/modules/CalDavSession.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/eb5fd4e3c650cabec787456b3f897cea0952851b/calendar/providers/caldav/modules/CalDavSession.jsm">file</a> |
<a href="/comm-central/annotate/eb5fd4e3c650cabec787456b3f897cea0952851b/calendar/providers/caldav/modules/CalDavSession.jsm">annotate</a> |
<a href="/comm-central/diff/eb5fd4e3c650cabec787456b3f897cea0952851b/calendar/providers/caldav/modules/CalDavSession.jsm">diff</a> |
<a href="/comm-central/comparison/eb5fd4e3c650cabec787456b3f897cea0952851b/calendar/providers/caldav/modules/CalDavSession.jsm">comparison</a> |
<a href="/comm-central/log/eb5fd4e3c650cabec787456b3f897cea0952851b/calendar/providers/caldav/modules/CalDavSession.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/eb5fd4e3c650cabec787456b3f897cea0952851b/calendar/providers/caldav/modules/CalDavUtils.jsm">calendar/providers/caldav/modules/CalDavUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/eb5fd4e3c650cabec787456b3f897cea0952851b/calendar/providers/caldav/modules/CalDavUtils.jsm">file</a> |
<a href="/comm-central/annotate/eb5fd4e3c650cabec787456b3f897cea0952851b/calendar/providers/caldav/modules/CalDavUtils.jsm">annotate</a> |
<a href="/comm-central/diff/eb5fd4e3c650cabec787456b3f897cea0952851b/calendar/providers/caldav/modules/CalDavUtils.jsm">diff</a> |
<a href="/comm-central/comparison/eb5fd4e3c650cabec787456b3f897cea0952851b/calendar/providers/caldav/modules/CalDavUtils.jsm">comparison</a> |
<a href="/comm-central/log/eb5fd4e3c650cabec787456b3f897cea0952851b/calendar/providers/caldav/modules/CalDavUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/eb5fd4e3c650cabec787456b3f897cea0952851b/calendar/providers/caldav/modules/calDavRequest.jsm">calendar/providers/caldav/modules/calDavRequest.jsm</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/eb5fd4e3c650cabec787456b3f897cea0952851b/calendar/providers/caldav/modules/calDavRequest.jsm">diff</a> |
<a href="/comm-central/comparison/eb5fd4e3c650cabec787456b3f897cea0952851b/calendar/providers/caldav/modules/calDavRequest.jsm">comparison</a> |
<a href="/comm-central/log/eb5fd4e3c650cabec787456b3f897cea0952851b/calendar/providers/caldav/modules/calDavRequest.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/eb5fd4e3c650cabec787456b3f897cea0952851b/calendar/providers/caldav/modules/calDavSession.jsm">calendar/providers/caldav/modules/calDavSession.jsm</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/eb5fd4e3c650cabec787456b3f897cea0952851b/calendar/providers/caldav/modules/calDavSession.jsm">diff</a> |
<a href="/comm-central/comparison/eb5fd4e3c650cabec787456b3f897cea0952851b/calendar/providers/caldav/modules/calDavSession.jsm">comparison</a> |
<a href="/comm-central/log/eb5fd4e3c650cabec787456b3f897cea0952851b/calendar/providers/caldav/modules/calDavSession.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/eb5fd4e3c650cabec787456b3f897cea0952851b/calendar/providers/caldav/modules/calDavUtils.jsm">calendar/providers/caldav/modules/calDavUtils.jsm</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/eb5fd4e3c650cabec787456b3f897cea0952851b/calendar/providers/caldav/modules/calDavUtils.jsm">diff</a> |
<a href="/comm-central/comparison/eb5fd4e3c650cabec787456b3f897cea0952851b/calendar/providers/caldav/modules/calDavUtils.jsm">comparison</a> |
<a href="/comm-central/log/eb5fd4e3c650cabec787456b3f897cea0952851b/calendar/providers/caldav/modules/calDavUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/eb5fd4e3c650cabec787456b3f897cea0952851b/calendar/providers/caldav/moz.build">calendar/providers/caldav/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/eb5fd4e3c650cabec787456b3f897cea0952851b/calendar/providers/caldav/moz.build">file</a> |
<a href="/comm-central/annotate/eb5fd4e3c650cabec787456b3f897cea0952851b/calendar/providers/caldav/moz.build">annotate</a> |
<a href="/comm-central/diff/eb5fd4e3c650cabec787456b3f897cea0952851b/calendar/providers/caldav/moz.build">diff</a> |
<a href="/comm-central/comparison/eb5fd4e3c650cabec787456b3f897cea0952851b/calendar/providers/caldav/moz.build">comparison</a> |
<a href="/comm-central/log/eb5fd4e3c650cabec787456b3f897cea0952851b/calendar/providers/caldav/moz.build">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/eb5fd4e3c650cabec787456b3f897cea0952851b/calendar/test/unit/test_caldav_requests.js">calendar/test/unit/test_caldav_requests.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/eb5fd4e3c650cabec787456b3f897cea0952851b/calendar/test/unit/test_caldav_requests.js">file</a> |
<a href="/comm-central/annotate/eb5fd4e3c650cabec787456b3f897cea0952851b/calendar/test/unit/test_caldav_requests.js">annotate</a> |
<a href="/comm-central/diff/eb5fd4e3c650cabec787456b3f897cea0952851b/calendar/test/unit/test_caldav_requests.js">diff</a> |
<a href="/comm-central/comparison/eb5fd4e3c650cabec787456b3f897cea0952851b/calendar/test/unit/test_caldav_requests.js">comparison</a> |
<a href="/comm-central/log/eb5fd4e3c650cabec787456b3f897cea0952851b/calendar/test/unit/test_caldav_requests.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/calendar/base/src/calCachedCalendar.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/calendar/base/src/calCachedCalendar.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -340,17 +340,17 @@ calCachedCalendar.prototype = {</span>
<a href="#l1.4"></a><span id="l1.4">       cal.LOG(&quot;[calCachedCalendar] Doing changelog based sync for calendar &quot; + this.uri.spec);</span>
<a href="#l1.5"></a><span id="l1.5">       let opListener = {</span>
<a href="#l1.6"></a><span id="l1.6">         onResult(operation, result) {</span>
<a href="#l1.7"></a><span id="l1.7">           if (!operation || !operation.isPending) {</span>
<a href="#l1.8"></a><span id="l1.8">             let status = operation ? operation.status : Cr.NS_OK;</span>
<a href="#l1.9"></a><span id="l1.9">             if (!Components.isSuccessCode(status)) {</span>
<a href="#l1.10"></a><span id="l1.10">               cal.ERROR(</span>
<a href="#l1.11"></a><span id="l1.11">                 &quot;[calCachedCalendar] replay action failed: &quot; +</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-                  (operation ? operation.id : &quot;&lt;unknown&gt;&quot;) +</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+                  (operation &amp;&amp; operation.id ? operation.id : &quot;&lt;unknown&gt;&quot;) +</span>
<a href="#l1.14"></a><span id="l1.14">                   &quot;, uri=&quot; +</span>
<a href="#l1.15"></a><span id="l1.15">                   self.uri.spec +</span>
<a href="#l1.16"></a><span id="l1.16">                   &quot;, result=&quot; +</span>
<a href="#l1.17"></a><span id="l1.17">                   result +</span>
<a href="#l1.18"></a><span id="l1.18">                   &quot;, operation=&quot; +</span>
<a href="#l1.19"></a><span id="l1.19">                   operation</span>
<a href="#l1.20"></a><span id="l1.20">               );</span>
<a href="#l1.21"></a><span id="l1.21">             }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/calendar/providers/caldav/CalDavCalendar.jsm</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/calendar/providers/caldav/CalDavCalendar.jsm</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -1,29 +1,35 @@</span>
<a href="#l2.4"></a><span id="l2.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l2.5"></a><span id="l2.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l2.6"></a><span id="l2.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l2.7"></a><span id="l2.7"> </span>
<a href="#l2.8"></a><span id="l2.8"> /* import-globals-from calDavRequestHandlers.js */</span>
<a href="#l2.9"></a><span id="l2.9" class="difflineminus">-/* globals OAUTH_BASE_URI, OAUTH_SCOPE, OAUTH_CLIENT_ID, OAUTH_HASH */</span>
<a href="#l2.10"></a><span id="l2.10" class="difflineplus">+/* globals etagsHandler multigetSyncHandler webDavSyncHandler */</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12"> var EXPORTED_SYMBOLS = [&quot;CalDavCalendar&quot;];</span>
<a href="#l2.13"></a><span id="l2.13"> </span>
<a href="#l2.14"></a><span id="l2.14"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineminus">-var { setTimeout } = ChromeUtils.import(&quot;resource://gre/modules/Timer.jsm&quot;);</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineminus">-</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineminus">-var { OAuth2 } = ChromeUtils.import(&quot;resource:///modules/OAuth2.jsm&quot;);</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineminus">-</span>
<a href="#l2.19"></a><span id="l2.19"> var { cal } = ChromeUtils.import(&quot;resource:///modules/calendar/calUtils.jsm&quot;);</span>
<a href="#l2.20"></a><span id="l2.20"> </span>
<a href="#l2.21"></a><span id="l2.21"> Services.scriptloader.loadSubScript(&quot;resource:///components/calDavRequestHandlers.js&quot;);</span>
<a href="#l2.22"></a><span id="l2.22"> </span>
<a href="#l2.23"></a><span id="l2.23" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/caldav/calDavRequest.jsm&quot;);</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/caldav/calDavSession.jsm&quot;);</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/caldav/calDavUtils.jsm&quot;);</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineplus">+var {</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineplus">+  CalDavGenericRequest,</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineplus">+  CalDavLegacySAXRequest,</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineplus">+  CalDavItemRequest,</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineplus">+  CalDavDeleteItemRequest,</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+  CalDavPropfindRequest,</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+  CalDavHeaderRequest,</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+  CalDavPrincipalPropertySearchRequest,</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+  CalDavOutboxRequest,</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+  CalDavFreeBusyRequest,</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+} = ChromeUtils.import(&quot;resource:///modules/caldav/CalDavRequest.jsm&quot;);</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+var { CalDavSession } = ChromeUtils.import(&quot;resource:///modules/caldav/CalDavSession.jsm&quot;);</span>
<a href="#l2.39"></a><span id="l2.39"> </span>
<a href="#l2.40"></a><span id="l2.40"> var XML_HEADER = '&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;\n';</span>
<a href="#l2.41"></a><span id="l2.41"> var MIME_TEXT_XML = &quot;text/xml; charset=utf-8&quot;;</span>
<a href="#l2.42"></a><span id="l2.42"> </span>
<a href="#l2.43"></a><span id="l2.43"> var cIOL = Ci.calIOperationListener;</span>
<a href="#l2.44"></a><span id="l2.44"> </span>
<a href="#l2.45"></a><span id="l2.45"> function CalDavCalendar() {</span>
<a href="#l2.46"></a><span id="l2.46">   this.initProviderBase();</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineat">@@ -587,17 +593,17 @@ CalDavCalendar.prototype = {</span>
<a href="#l2.48"></a><span id="l2.48"> </span>
<a href="#l2.49"></a><span id="l2.49">     let locationPath = this.getItemLocationPath(parentItem);</span>
<a href="#l2.50"></a><span id="l2.50">     let itemUri = this.makeUri(locationPath);</span>
<a href="#l2.51"></a><span id="l2.51">     cal.LOG(&quot;CalDAV: itemUri.spec = &quot; + itemUri.spec);</span>
<a href="#l2.52"></a><span id="l2.52"> </span>
<a href="#l2.53"></a><span id="l2.53">     let serializedItem = this.getSerializedItem(aItem);</span>
<a href="#l2.54"></a><span id="l2.54"> </span>
<a href="#l2.55"></a><span id="l2.55">     let sendEtag = aIgnoreEtag ? null : &quot;*&quot;;</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineminus">-    let request = new ItemRequest(this.session, this, itemUri, aItem, sendEtag);</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineplus">+    let request = new CalDavItemRequest(this.session, this, itemUri, aItem, sendEtag);</span>
<a href="#l2.58"></a><span id="l2.58"> </span>
<a href="#l2.59"></a><span id="l2.59">     request.commit().then(</span>
<a href="#l2.60"></a><span id="l2.60">       response =&gt; {</span>
<a href="#l2.61"></a><span id="l2.61">         let status = Cr.NS_OK;</span>
<a href="#l2.62"></a><span id="l2.62">         let detail = parentItem;</span>
<a href="#l2.63"></a><span id="l2.63"> </span>
<a href="#l2.64"></a><span id="l2.64">         // Translate the HTTP status code to a status and message for the listener</span>
<a href="#l2.65"></a><span id="l2.65">         if (response.ok) {</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineat">@@ -688,17 +694,17 @@ CalDavCalendar.prototype = {</span>
<a href="#l2.67"></a><span id="l2.67">       aNewItem.recurrenceInfo.modifyException(newItem_, false);</span>
<a href="#l2.68"></a><span id="l2.68">     }</span>
<a href="#l2.69"></a><span id="l2.69">     aNewItem.generation += 1;</span>
<a href="#l2.70"></a><span id="l2.70"> </span>
<a href="#l2.71"></a><span id="l2.71">     let eventUri = this.makeUri(this.mItemInfoCache[aNewItem.id].locationPath);</span>
<a href="#l2.72"></a><span id="l2.72">     let modifiedItemICS = this.getSerializedItem(aNewItem);</span>
<a href="#l2.73"></a><span id="l2.73"> </span>
<a href="#l2.74"></a><span id="l2.74">     let sendEtag = aIgnoreEtag ? null : this.mItemInfoCache[aNewItem.id].etag;</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineminus">-    let request = new ItemRequest(this.session, this, eventUri, aNewItem, sendEtag);</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineplus">+    let request = new CalDavItemRequest(this.session, this, eventUri, aNewItem, sendEtag);</span>
<a href="#l2.77"></a><span id="l2.77"> </span>
<a href="#l2.78"></a><span id="l2.78">     request.commit().then(</span>
<a href="#l2.79"></a><span id="l2.79">       response =&gt; {</span>
<a href="#l2.80"></a><span id="l2.80">         let status = Cr.NS_OK;</span>
<a href="#l2.81"></a><span id="l2.81">         let detail = aNewItem;</span>
<a href="#l2.82"></a><span id="l2.82"> </span>
<a href="#l2.83"></a><span id="l2.83">         let shouldNotify = true;</span>
<a href="#l2.84"></a><span id="l2.84">         if (response.ok) {</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineat">@@ -805,17 +811,17 @@ CalDavCalendar.prototype = {</span>
<a href="#l2.86"></a><span id="l2.86">       return;</span>
<a href="#l2.87"></a><span id="l2.87">     }</span>
<a href="#l2.88"></a><span id="l2.88"> </span>
<a href="#l2.89"></a><span id="l2.89">     if (this.verboseLogging()) {</span>
<a href="#l2.90"></a><span id="l2.90">       cal.LOG(&quot;CalDAV: Deleting &quot; + eventUri.spec);</span>
<a href="#l2.91"></a><span id="l2.91">     }</span>
<a href="#l2.92"></a><span id="l2.92"> </span>
<a href="#l2.93"></a><span id="l2.93">     let sendEtag = aIgnoreEtag ? null : this.mItemInfoCache[aItem.id].etag;</span>
<a href="#l2.94"></a><span id="l2.94" class="difflineminus">-    let request = new DeleteItemRequest(this.session, this, eventUri, sendEtag);</span>
<a href="#l2.95"></a><span id="l2.95" class="difflineplus">+    let request = new CalDavDeleteItemRequest(this.session, this, eventUri, sendEtag);</span>
<a href="#l2.96"></a><span id="l2.96"> </span>
<a href="#l2.97"></a><span id="l2.97">     request.commit().then(</span>
<a href="#l2.98"></a><span id="l2.98">       response =&gt; {</span>
<a href="#l2.99"></a><span id="l2.99">         if (response.ok) {</span>
<a href="#l2.100"></a><span id="l2.100">           if (!aFromInbox) {</span>
<a href="#l2.101"></a><span id="l2.101">             let decodedPath = this.ensureDecodedPath(eventUri.pathQueryRef);</span>
<a href="#l2.102"></a><span id="l2.102">             delete this.mHrefIndex[decodedPath];</span>
<a href="#l2.103"></a><span id="l2.103">             delete this.mItemInfoCache[aItem.id];</span>
<a href="#l2.104"></a><span id="l2.104" class="difflineat">@@ -828,17 +834,17 @@ CalDavCalendar.prototype = {</span>
<a href="#l2.105"></a><span id="l2.105">               // the item from our memory calendar now. The</span>
<a href="#l2.106"></a><span id="l2.106">               // listeners will be notified there.</span>
<a href="#l2.107"></a><span id="l2.107">               this.mOfflineStorage.deleteItem(aItem, aListener);</span>
<a href="#l2.108"></a><span id="l2.108">             }</span>
<a href="#l2.109"></a><span id="l2.109">           }</span>
<a href="#l2.110"></a><span id="l2.110">         } else if (response.conflict) {</span>
<a href="#l2.111"></a><span id="l2.111">           // item has either been modified or deleted by someone else check to see which</span>
<a href="#l2.112"></a><span id="l2.112">           cal.LOG(&quot;CalDAV: Item has been modified on server, checking if it has been deleted&quot;);</span>
<a href="#l2.113"></a><span id="l2.113" class="difflineminus">-          let headrequest = new GenericRequest(this.session, this, &quot;HEAD&quot;, eventUri);</span>
<a href="#l2.114"></a><span id="l2.114" class="difflineplus">+          let headrequest = new CalDavGenericRequest(this.session, this, &quot;HEAD&quot;, eventUri);</span>
<a href="#l2.115"></a><span id="l2.115"> </span>
<a href="#l2.116"></a><span id="l2.116">           return headrequest.commit().then(headresponse =&gt; {</span>
<a href="#l2.117"></a><span id="l2.117">             if (headresponse.notFound) {</span>
<a href="#l2.118"></a><span id="l2.118">               // Nothing to do. Someone else has already deleted it</span>
<a href="#l2.119"></a><span id="l2.119">               notifyListener(Cr.NS_OK, aItem, true);</span>
<a href="#l2.120"></a><span id="l2.120">             } else if (headresponse.serverError) {</span>
<a href="#l2.121"></a><span id="l2.121">               notifyListener(</span>
<a href="#l2.122"></a><span id="l2.122">                 Cr.NS_ERROR_NOT_AVAILABLE,</span>
<a href="#l2.123"></a><span id="l2.123" class="difflineat">@@ -1211,17 +1217,17 @@ CalDavCalendar.prototype = {</span>
<a href="#l2.124"></a><span id="l2.124"> </span>
<a href="#l2.125"></a><span id="l2.125">     // Call getUpdatedItems right away if its the first refresh *OR* if webdav Sync is enabled</span>
<a href="#l2.126"></a><span id="l2.126">     // (It is redundant to send a request to get the collection tag (getctag) on a calendar if</span>
<a href="#l2.127"></a><span id="l2.127">     // it supports webdav sync, the sync request will only return data if something changed).</span>
<a href="#l2.128"></a><span id="l2.128">     if (!this.mCtag || !this.mFirstRefreshDone || this.mHasWebdavSyncSupport) {</span>
<a href="#l2.129"></a><span id="l2.129">       this.getUpdatedItems(this.calendarUri, aChangeLogListener);</span>
<a href="#l2.130"></a><span id="l2.130">       return;</span>
<a href="#l2.131"></a><span id="l2.131">     }</span>
<a href="#l2.132"></a><span id="l2.132" class="difflineminus">-    let request = new PropfindRequest(this.session, this, this.makeUri(), [&quot;CS:getctag&quot;]);</span>
<a href="#l2.133"></a><span id="l2.133" class="difflineplus">+    let request = new CalDavPropfindRequest(this.session, this, this.makeUri(), [&quot;CS:getctag&quot;]);</span>
<a href="#l2.134"></a><span id="l2.134"> </span>
<a href="#l2.135"></a><span id="l2.135">     request.commit().then(response =&gt; {</span>
<a href="#l2.136"></a><span id="l2.136">       cal.LOG(`CalDAV: Status ${response.status} checking ctag for calendar ${this.name}`);</span>
<a href="#l2.137"></a><span id="l2.137"> </span>
<a href="#l2.138"></a><span id="l2.138">       if (response.status == -1) {</span>
<a href="#l2.139"></a><span id="l2.139">         notifyListener(Cr.NS_OK);</span>
<a href="#l2.140"></a><span id="l2.140">         return;</span>
<a href="#l2.141"></a><span id="l2.141">       } else if (response.notFound) {</span>
<a href="#l2.142"></a><span id="l2.142" class="difflineat">@@ -1319,27 +1325,29 @@ CalDavCalendar.prototype = {</span>
<a href="#l2.143"></a><span id="l2.143">       &quot;&lt;D:getcontenttype/&gt;&quot; +</span>
<a href="#l2.144"></a><span id="l2.144">       &quot;&lt;D:resourcetype/&gt;&quot; +</span>
<a href="#l2.145"></a><span id="l2.145">       &quot;&lt;D:getetag/&gt;&quot; +</span>
<a href="#l2.146"></a><span id="l2.146">       &quot;&lt;/D:prop&gt;&quot; +</span>
<a href="#l2.147"></a><span id="l2.147">       &quot;&lt;/D:propfind&gt;&quot;;</span>
<a href="#l2.148"></a><span id="l2.148"> </span>
<a href="#l2.149"></a><span id="l2.149">     let requestUri = this.makeUri(null, aUri);</span>
<a href="#l2.150"></a><span id="l2.150">     let handler = new etagsHandler(this, aUri, aChangeLogListener);</span>
<a href="#l2.151"></a><span id="l2.151" class="difflineminus">-    let request = new LegacySAXRequest(</span>
<a href="#l2.152"></a><span id="l2.152" class="difflineplus">+</span>
<a href="#l2.153"></a><span id="l2.153" class="difflineplus">+    let onSetupChannel = channel =&gt; {</span>
<a href="#l2.154"></a><span id="l2.154" class="difflineplus">+      channel.requestMethod = &quot;PROPFIND&quot;;</span>
<a href="#l2.155"></a><span id="l2.155" class="difflineplus">+      channel.setRequestHeader(&quot;Depth&quot;, &quot;1&quot;, false);</span>
<a href="#l2.156"></a><span id="l2.156" class="difflineplus">+    };</span>
<a href="#l2.157"></a><span id="l2.157" class="difflineplus">+    let request = new CalDavLegacySAXRequest(</span>
<a href="#l2.158"></a><span id="l2.158">       this.session,</span>
<a href="#l2.159"></a><span id="l2.159">       this,</span>
<a href="#l2.160"></a><span id="l2.160">       requestUri,</span>
<a href="#l2.161"></a><span id="l2.161">       queryXml,</span>
<a href="#l2.162"></a><span id="l2.162">       MIME_TEXT_XML,</span>
<a href="#l2.163"></a><span id="l2.163">       handler,</span>
<a href="#l2.164"></a><span id="l2.164" class="difflineminus">-      channel =&gt; {</span>
<a href="#l2.165"></a><span id="l2.165" class="difflineminus">-        channel.requestMethod = &quot;PROPFIND&quot;;</span>
<a href="#l2.166"></a><span id="l2.166" class="difflineminus">-        channel.setRequestHeader(&quot;Depth&quot;, &quot;1&quot;, false);</span>
<a href="#l2.167"></a><span id="l2.167" class="difflineminus">-      }</span>
<a href="#l2.168"></a><span id="l2.168" class="difflineplus">+      onSetupChannel</span>
<a href="#l2.169"></a><span id="l2.169">     );</span>
<a href="#l2.170"></a><span id="l2.170"> </span>
<a href="#l2.171"></a><span id="l2.171">     request.commit().catch(() =&gt; {</span>
<a href="#l2.172"></a><span id="l2.172">       if (aChangeLogListener &amp;&amp; this.isCached) {</span>
<a href="#l2.173"></a><span id="l2.173">         aChangeLogListener.onResult(</span>
<a href="#l2.174"></a><span id="l2.174">           { status: Cr.NS_ERROR_NOT_AVAILABLE },</span>
<a href="#l2.175"></a><span id="l2.175">           Cr.NS_ERROR_NOT_AVAILABLE</span>
<a href="#l2.176"></a><span id="l2.176">         );</span>
<a href="#l2.177"></a><span id="l2.177" class="difflineat">@@ -1388,117 +1396,40 @@ CalDavCalendar.prototype = {</span>
<a href="#l2.178"></a><span id="l2.178">     let asyncprompter = Cc[&quot;@mozilla.org/messenger/msgAsyncPrompter;1&quot;].getService(</span>
<a href="#l2.179"></a><span id="l2.179">       Ci.nsIMsgAsyncPrompter</span>
<a href="#l2.180"></a><span id="l2.180">     );</span>
<a href="#l2.181"></a><span id="l2.181">     asyncprompter.queueAsyncAuthPrompt(self.uri.spec, false, promptlistener);</span>
<a href="#l2.182"></a><span id="l2.182">   },</span>
<a href="#l2.183"></a><span id="l2.183"> </span>
<a href="#l2.184"></a><span id="l2.184">   /**</span>
<a href="#l2.185"></a><span id="l2.185">    * Helper to check if the given response has had its url redirected, and if so prompt the user</span>
<a href="#l2.186"></a><span id="l2.186" class="difflineminus">-   * if they want to adapt the URL</span>
<a href="#l2.187"></a><span id="l2.187" class="difflineplus">+   * if they want to adapt the URL.</span>
<a href="#l2.188"></a><span id="l2.188">    *</span>
<a href="#l2.189"></a><span id="l2.189" class="difflineminus">-   * @param {CalDavResponse} aResponse            The response to check</span>
<a href="#l2.190"></a><span id="l2.190" class="difflineplus">+   * @param {CalDavResponseBase} response         The response to check.</span>
<a href="#l2.191"></a><span id="l2.191">    * @return {Boolean}                            False, if the calendar should be disabled</span>
<a href="#l2.192"></a><span id="l2.192">    */</span>
<a href="#l2.193"></a><span id="l2.193" class="difflineminus">-  setupAuthentication(aChangeLogListener) {</span>
<a href="#l2.194"></a><span id="l2.194" class="difflineminus">-    let self = this;</span>
<a href="#l2.195"></a><span id="l2.195" class="difflineminus">-    function authSuccess() {</span>
<a href="#l2.196"></a><span id="l2.196" class="difflineminus">-      self.checkDavResourceType(aChangeLogListener);</span>
<a href="#l2.197"></a><span id="l2.197" class="difflineminus">-    }</span>
<a href="#l2.198"></a><span id="l2.198" class="difflineminus">-    function authFailed() {</span>
<a href="#l2.199"></a><span id="l2.199" class="difflineminus">-      self.setProperty(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l2.200"></a><span id="l2.200" class="difflineminus">-      self.setProperty(&quot;auto-enabled&quot;, &quot;true&quot;);</span>
<a href="#l2.201"></a><span id="l2.201" class="difflineminus">-      self.completeCheckServerInfo(aChangeLogListener, Cr.NS_ERROR_FAILURE);</span>
<a href="#l2.202"></a><span id="l2.202" class="difflineminus">-    }</span>
<a href="#l2.203"></a><span id="l2.203" class="difflineminus">-    if (this.mUri.host == &quot;apidata.googleusercontent.com&quot;) {</span>
<a href="#l2.204"></a><span id="l2.204" class="difflineminus">-      if (!this.oauth) {</span>
<a href="#l2.205"></a><span id="l2.205" class="difflineminus">-        let sessionId = this.id;</span>
<a href="#l2.206"></a><span id="l2.206" class="difflineminus">-        let pwMgrId = &quot;Google CalDAV v2&quot;;</span>
<a href="#l2.207"></a><span id="l2.207" class="difflineminus">-        let authTitle = cal.l10n.getAnyString(&quot;global&quot;, &quot;commonDialogs&quot;, &quot;EnterUserPasswordFor2&quot;, [</span>
<a href="#l2.208"></a><span id="l2.208" class="difflineminus">-          this.name,</span>
<a href="#l2.209"></a><span id="l2.209" class="difflineminus">-        ]);</span>
<a href="#l2.210"></a><span id="l2.210" class="difflineminus">-        this.oauth = new OAuth2(OAUTH_BASE_URI, OAUTH_SCOPE, OAUTH_CLIENT_ID, OAUTH_HASH);</span>
<a href="#l2.211"></a><span id="l2.211" class="difflineminus">-        this.oauth.requestWindowTitle = authTitle;</span>
<a href="#l2.212"></a><span id="l2.212" class="difflineminus">-        this.oauth.requestWindowFeatures = &quot;chrome,private,centerscreen,width=430,height=750&quot;;</span>
<a href="#l2.213"></a><span id="l2.213" class="difflineminus">-</span>
<a href="#l2.214"></a><span id="l2.214" class="difflineminus">-        Object.defineProperty(this.oauth, &quot;refreshToken&quot;, {</span>
<a href="#l2.215"></a><span id="l2.215" class="difflineminus">-          get() {</span>
<a href="#l2.216"></a><span id="l2.216" class="difflineminus">-            if (!this.mRefreshToken) {</span>
<a href="#l2.217"></a><span id="l2.217" class="difflineminus">-              let pass = { value: null };</span>
<a href="#l2.218"></a><span id="l2.218" class="difflineminus">-              try {</span>
<a href="#l2.219"></a><span id="l2.219" class="difflineminus">-                let origin = &quot;oauth:&quot; + sessionId;</span>
<a href="#l2.220"></a><span id="l2.220" class="difflineminus">-                cal.auth.passwordManagerGet(sessionId, pass, origin, pwMgrId);</span>
<a href="#l2.221"></a><span id="l2.221" class="difflineminus">-              } catch (e) {</span>
<a href="#l2.222"></a><span id="l2.222" class="difflineminus">-                // User might have cancelled the master password prompt, that's ok</span>
<a href="#l2.223"></a><span id="l2.223" class="difflineminus">-                if (e.result != Cr.NS_ERROR_ABORT) {</span>
<a href="#l2.224"></a><span id="l2.224" class="difflineminus">-                  throw e;</span>
<a href="#l2.225"></a><span id="l2.225" class="difflineminus">-                }</span>
<a href="#l2.226"></a><span id="l2.226" class="difflineminus">-              }</span>
<a href="#l2.227"></a><span id="l2.227" class="difflineminus">-              this.mRefreshToken = pass.value;</span>
<a href="#l2.228"></a><span id="l2.228" class="difflineminus">-            }</span>
<a href="#l2.229"></a><span id="l2.229" class="difflineminus">-            return this.mRefreshToken;</span>
<a href="#l2.230"></a><span id="l2.230" class="difflineminus">-          },</span>
<a href="#l2.231"></a><span id="l2.231" class="difflineminus">-          set(val) {</span>
<a href="#l2.232"></a><span id="l2.232" class="difflineminus">-            try {</span>
<a href="#l2.233"></a><span id="l2.233" class="difflineminus">-              let origin = &quot;oauth:&quot; + sessionId;</span>
<a href="#l2.234"></a><span id="l2.234" class="difflineminus">-              if (val) {</span>
<a href="#l2.235"></a><span id="l2.235" class="difflineminus">-                cal.auth.passwordManagerSave(sessionId, val, origin, pwMgrId);</span>
<a href="#l2.236"></a><span id="l2.236" class="difflineminus">-              } else {</span>
<a href="#l2.237"></a><span id="l2.237" class="difflineminus">-                cal.auth.passwordManagerRemove(sessionId, origin, pwMgrId);</span>
<a href="#l2.238"></a><span id="l2.238" class="difflineminus">-              }</span>
<a href="#l2.239"></a><span id="l2.239" class="difflineminus">-            } catch (e) {</span>
<a href="#l2.240"></a><span id="l2.240" class="difflineminus">-              // User might have cancelled the master password prompt, or password saving</span>
<a href="#l2.241"></a><span id="l2.241" class="difflineminus">-              // could be disabled. That is ok, throw for everything else.</span>
<a href="#l2.242"></a><span id="l2.242" class="difflineminus">-              if (e.result != Cr.NS_ERROR_ABORT &amp;&amp; e.result != Cr.NS_ERROR_NOT_AVAILABLE) {</span>
<a href="#l2.243"></a><span id="l2.243" class="difflineminus">-                throw e;</span>
<a href="#l2.244"></a><span id="l2.244" class="difflineminus">-              }</span>
<a href="#l2.245"></a><span id="l2.245" class="difflineminus">-            }</span>
<a href="#l2.246"></a><span id="l2.246" class="difflineminus">-            return (this.mRefreshToken = val);</span>
<a href="#l2.247"></a><span id="l2.247" class="difflineminus">-          },</span>
<a href="#l2.248"></a><span id="l2.248" class="difflineminus">-          enumerable: true,</span>
<a href="#l2.249"></a><span id="l2.249" class="difflineminus">-        });</span>
<a href="#l2.250"></a><span id="l2.250" class="difflineminus">-      }</span>
<a href="#l2.251"></a><span id="l2.251" class="difflineminus">-</span>
<a href="#l2.252"></a><span id="l2.252" class="difflineminus">-      if (this.oauth.accessToken) {</span>
<a href="#l2.253"></a><span id="l2.253" class="difflineminus">-        authSuccess();</span>
<a href="#l2.254"></a><span id="l2.254" class="difflineminus">-      } else {</span>
<a href="#l2.255"></a><span id="l2.255" class="difflineminus">-        // bug 901329: If the calendar window isn't loaded yet the</span>
<a href="#l2.256"></a><span id="l2.256" class="difflineminus">-        // master password prompt will show just the buttons and</span>
<a href="#l2.257"></a><span id="l2.257" class="difflineminus">-        // possibly hang. If we postpone until the window is loaded,</span>
<a href="#l2.258"></a><span id="l2.258" class="difflineminus">-        // all is well.</span>
<a href="#l2.259"></a><span id="l2.259" class="difflineminus">-        setTimeout(function postpone() {</span>
<a href="#l2.260"></a><span id="l2.260" class="difflineminus">-          // eslint-disable-line func-names</span>
<a href="#l2.261"></a><span id="l2.261" class="difflineminus">-          let win = cal.window.getCalendarWindow();</span>
<a href="#l2.262"></a><span id="l2.262" class="difflineminus">-          if (!win || win.document.readyState != &quot;complete&quot;) {</span>
<a href="#l2.263"></a><span id="l2.263" class="difflineminus">-            setTimeout(postpone, 0);</span>
<a href="#l2.264"></a><span id="l2.264" class="difflineminus">-          } else {</span>
<a href="#l2.265"></a><span id="l2.265" class="difflineminus">-            self.oauthConnect(authSuccess, authFailed);</span>
<a href="#l2.266"></a><span id="l2.266" class="difflineminus">-          }</span>
<a href="#l2.267"></a><span id="l2.267" class="difflineminus">-        }, 0);</span>
<a href="#l2.268"></a><span id="l2.268" class="difflineminus">-      }</span>
<a href="#l2.269"></a><span id="l2.269" class="difflineminus">-    } else {</span>
<a href="#l2.270"></a><span id="l2.270" class="difflineminus">-      authSuccess();</span>
<a href="#l2.271"></a><span id="l2.271" class="difflineminus">-    }</span>
<a href="#l2.272"></a><span id="l2.272" class="difflineplus">+  checkRedirect(response) {</span>
<a href="#l2.273"></a><span id="l2.273" class="difflineplus">+    return response.redirected;</span>
<a href="#l2.274"></a><span id="l2.274">   },</span>
<a href="#l2.275"></a><span id="l2.275"> </span>
<a href="#l2.276"></a><span id="l2.276">   /**</span>
<a href="#l2.277"></a><span id="l2.277">    * Checks that the calendar URI exists and is a CalDAV calendar. This is the beginning of a</span>
<a href="#l2.278"></a><span id="l2.278">    * chain of asynchronous calls. This function will, when done, call the next function related to</span>
<a href="#l2.279"></a><span id="l2.279">    * checking resource type, server capabilties, etc.</span>
<a href="#l2.280"></a><span id="l2.280">    *</span>
<a href="#l2.281"></a><span id="l2.281">    * checkDavResourceType                        * You are here</span>
<a href="#l2.282"></a><span id="l2.282">    * checkServerCaps</span>
<a href="#l2.283"></a><span id="l2.283">    * findPrincipalNS</span>
<a href="#l2.284"></a><span id="l2.284">    * checkPrincipalsNameSpace</span>
<a href="#l2.285"></a><span id="l2.285">    * completeCheckServerInfo</span>
<a href="#l2.286"></a><span id="l2.286">    */</span>
<a href="#l2.287"></a><span id="l2.287">   checkDavResourceType(aChangeLogListener) {</span>
<a href="#l2.288"></a><span id="l2.288">     this.ensureTargetCalendar();</span>
<a href="#l2.289"></a><span id="l2.289"> </span>
<a href="#l2.290"></a><span id="l2.290" class="difflineminus">-    let request = new PropfindRequest(this.session, this, this.makeUri(), [</span>
<a href="#l2.291"></a><span id="l2.291" class="difflineplus">+    let request = new CalDavPropfindRequest(this.session, this, this.makeUri(), [</span>
<a href="#l2.292"></a><span id="l2.292">       &quot;D:resourcetype&quot;,</span>
<a href="#l2.293"></a><span id="l2.293">       &quot;D:owner&quot;,</span>
<a href="#l2.294"></a><span id="l2.294">       &quot;D:current-user-principal&quot;,</span>
<a href="#l2.295"></a><span id="l2.295">       &quot;D:supported-report-set&quot;,</span>
<a href="#l2.296"></a><span id="l2.296">       &quot;C:supported-calendar-component-set&quot;,</span>
<a href="#l2.297"></a><span id="l2.297">       &quot;CS:getctag&quot;,</span>
<a href="#l2.298"></a><span id="l2.298">     ]);</span>
<a href="#l2.299"></a><span id="l2.299"> </span>
<a href="#l2.300"></a><span id="l2.300" class="difflineat">@@ -1623,19 +1554,17 @@ CalDavCalendar.prototype = {</span>
<a href="#l2.301"></a><span id="l2.301">           this.checkServerCaps(aChangeLogListener);</span>
<a href="#l2.302"></a><span id="l2.302">         } else if (resourceType.has(&quot;D:collection&quot;)) {</span>
<a href="#l2.303"></a><span id="l2.303">           // Not a CalDAV calendar</span>
<a href="#l2.304"></a><span id="l2.304">           cal.LOG(`CalDAV: ${this.name} points to a DAV resource, but not a CalDAV calendar`);</span>
<a href="#l2.305"></a><span id="l2.305">           this.completeCheckServerInfo(aChangeLogListener, Ci.calIErrors.DAV_DAV_NOT_CALDAV);</span>
<a href="#l2.306"></a><span id="l2.306">         } else {</span>
<a href="#l2.307"></a><span id="l2.307">           // Something else?</span>
<a href="#l2.308"></a><span id="l2.308">           cal.LOG(</span>
<a href="#l2.309"></a><span id="l2.309" class="difflineminus">-            `CalDAV: No resource type received, ${</span>
<a href="#l2.310"></a><span id="l2.310" class="difflineminus">-              this.name</span>
<a href="#l2.311"></a><span id="l2.311" class="difflineminus">-            } doesn't seem to point to a DAV resource`</span>
<a href="#l2.312"></a><span id="l2.312" class="difflineplus">+            `CalDAV: No resource type received, ${this.name} doesn't seem to point to a DAV resource`</span>
<a href="#l2.313"></a><span id="l2.313">           );</span>
<a href="#l2.314"></a><span id="l2.314">           this.completeCheckServerInfo(aChangeLogListener, Ci.calIErrors.DAV_NOT_DAV);</span>
<a href="#l2.315"></a><span id="l2.315">         }</span>
<a href="#l2.316"></a><span id="l2.316">       },</span>
<a href="#l2.317"></a><span id="l2.317">       e =&gt; {</span>
<a href="#l2.318"></a><span id="l2.318">         cal.LOG(`CalDAV: Error during initial PROPFIND for calendar ${this.name}: ${e}`);</span>
<a href="#l2.319"></a><span id="l2.319">         this.completeCheckServerInfo(aChangeLogListener, Ci.calIErrors.DAV_NOT_DAV);</span>
<a href="#l2.320"></a><span id="l2.320">       }</span>
<a href="#l2.321"></a><span id="l2.321" class="difflineat">@@ -1647,17 +1576,17 @@ CalDavCalendar.prototype = {</span>
<a href="#l2.322"></a><span id="l2.322">    *</span>
<a href="#l2.323"></a><span id="l2.323">    * checkDavResourceType</span>
<a href="#l2.324"></a><span id="l2.324">    * checkServerCaps                              * You are here</span>
<a href="#l2.325"></a><span id="l2.325">    * findPrincipalNS</span>
<a href="#l2.326"></a><span id="l2.326">    * checkPrincipalsNameSpace</span>
<a href="#l2.327"></a><span id="l2.327">    * completeCheckServerInfo</span>
<a href="#l2.328"></a><span id="l2.328">    */</span>
<a href="#l2.329"></a><span id="l2.329">   checkServerCaps(aChangeLogListener, calHomeSetUrlRetry) {</span>
<a href="#l2.330"></a><span id="l2.330" class="difflineminus">-    let request = new DAVHeaderRequest(this.session, this, this.makeUri(null, this.mCalHomeSet));</span>
<a href="#l2.331"></a><span id="l2.331" class="difflineplus">+    let request = new CalDavHeaderRequest(this.session, this, this.makeUri(null, this.mCalHomeSet));</span>
<a href="#l2.332"></a><span id="l2.332"> </span>
<a href="#l2.333"></a><span id="l2.333">     request.commit().then(</span>
<a href="#l2.334"></a><span id="l2.334">       response =&gt; {</span>
<a href="#l2.335"></a><span id="l2.335">         if (!response.ok) {</span>
<a href="#l2.336"></a><span id="l2.336">           if (!calHomeSetUrlRetry &amp;&amp; response.notFound) {</span>
<a href="#l2.337"></a><span id="l2.337">             // try again with calendar URL, see https://bugzilla.mozilla.org/show_bug.cgi?id=588799</span>
<a href="#l2.338"></a><span id="l2.338">             cal.LOG(</span>
<a href="#l2.339"></a><span id="l2.339">               &quot;CalDAV: Calendar homeset was not found at parent url of calendar URL&quot; +</span>
<a href="#l2.340"></a><span id="l2.340" class="difflineat">@@ -1704,17 +1633,17 @@ CalDavCalendar.prototype = {</span>
<a href="#l2.341"></a><span id="l2.341">             cal.getFreeBusyService().addProvider(this);</span>
<a href="#l2.342"></a><span id="l2.342">           }</span>
<a href="#l2.343"></a><span id="l2.343">           this.findPrincipalNS(aChangeLogListener);</span>
<a href="#l2.344"></a><span id="l2.344">         } else {</span>
<a href="#l2.345"></a><span id="l2.345">           cal.LOG(&quot;CalDAV: Server does not support CalDAV scheduling.&quot;);</span>
<a href="#l2.346"></a><span id="l2.346">           this.completeCheckServerInfo(aChangeLogListener);</span>
<a href="#l2.347"></a><span id="l2.347">         }</span>
<a href="#l2.348"></a><span id="l2.348">       },</span>
<a href="#l2.349"></a><span id="l2.349" class="difflineminus">-      () =&gt; {</span>
<a href="#l2.350"></a><span id="l2.350" class="difflineplus">+      e =&gt; {</span>
<a href="#l2.351"></a><span id="l2.351">         cal.LOG(`CalDAV: Error checking server capabilities for calendar ${this.name}: ${e}`);</span>
<a href="#l2.352"></a><span id="l2.352">         this.completeCheckServerInfo(aChangeLogListener, Cr.NS_ERROR_FAILURE);</span>
<a href="#l2.353"></a><span id="l2.353">       }</span>
<a href="#l2.354"></a><span id="l2.354">     );</span>
<a href="#l2.355"></a><span id="l2.355">   },</span>
<a href="#l2.356"></a><span id="l2.356"> </span>
<a href="#l2.357"></a><span id="l2.357">   /**</span>
<a href="#l2.358"></a><span id="l2.358">    * Locates the principal namespace. This function should soely be called</span>
<a href="#l2.359"></a><span id="l2.359" class="difflineat">@@ -1729,17 +1658,19 @@ CalDavCalendar.prototype = {</span>
<a href="#l2.360"></a><span id="l2.360">   findPrincipalNS(aChangeLogListener) {</span>
<a href="#l2.361"></a><span id="l2.361">     if (this.principalUrl) {</span>
<a href="#l2.362"></a><span id="l2.362">       // We already have a principal namespace, use it.</span>
<a href="#l2.363"></a><span id="l2.363">       this.checkPrincipalsNameSpace([this.principalUrl], aChangeLogListener);</span>
<a href="#l2.364"></a><span id="l2.364">       return;</span>
<a href="#l2.365"></a><span id="l2.365">     }</span>
<a href="#l2.366"></a><span id="l2.366"> </span>
<a href="#l2.367"></a><span id="l2.367">     let homeSet = this.makeUri(null, this.mCalHomeSet);</span>
<a href="#l2.368"></a><span id="l2.368" class="difflineminus">-    let request = new PropfindRequest(this.session, this, homeSet, [&quot;D:principal-collection-set&quot;]);</span>
<a href="#l2.369"></a><span id="l2.369" class="difflineplus">+    let request = new CalDavPropfindRequest(this.session, this, homeSet, [</span>
<a href="#l2.370"></a><span id="l2.370" class="difflineplus">+      &quot;D:principal-collection-set&quot;,</span>
<a href="#l2.371"></a><span id="l2.371" class="difflineplus">+    ]);</span>
<a href="#l2.372"></a><span id="l2.372"> </span>
<a href="#l2.373"></a><span id="l2.373">     request.commit().then(</span>
<a href="#l2.374"></a><span id="l2.374">       response =&gt; {</span>
<a href="#l2.375"></a><span id="l2.375">         if (response.ok) {</span>
<a href="#l2.376"></a><span id="l2.376">           let pcs = response.firstProps[&quot;D:principal-collection-set&quot;];</span>
<a href="#l2.377"></a><span id="l2.377">           let nsList = pcs ? pcs.map(path =&gt; this.ensureDecodedPath(path)) : [];</span>
<a href="#l2.378"></a><span id="l2.378"> </span>
<a href="#l2.379"></a><span id="l2.379">           this.checkPrincipalsNameSpace(nsList, aChangeLogListener);</span>
<a href="#l2.380"></a><span id="l2.380" class="difflineat">@@ -1799,20 +1730,20 @@ CalDavCalendar.prototype = {</span>
<a href="#l2.381"></a><span id="l2.381">       &quot;C:calendar-home-set&quot;,</span>
<a href="#l2.382"></a><span id="l2.382">       &quot;C:calendar-user-address-set&quot;,</span>
<a href="#l2.383"></a><span id="l2.383">       &quot;C:schedule-inbox-URL&quot;,</span>
<a href="#l2.384"></a><span id="l2.384">       &quot;C:schedule-outbox-URL&quot;,</span>
<a href="#l2.385"></a><span id="l2.385">     ];</span>
<a href="#l2.386"></a><span id="l2.386"> </span>
<a href="#l2.387"></a><span id="l2.387">     let request;</span>
<a href="#l2.388"></a><span id="l2.388">     if (this.mPrincipalUrl) {</span>
<a href="#l2.389"></a><span id="l2.389" class="difflineminus">-      request = new PropfindRequest(this.session, this, requestUri, requestProps);</span>
<a href="#l2.390"></a><span id="l2.390" class="difflineplus">+      request = new CalDavPropfindRequest(this.session, this, requestUri, requestProps);</span>
<a href="#l2.391"></a><span id="l2.391">     } else {</span>
<a href="#l2.392"></a><span id="l2.392">       let homePath = this.ensureEncodedPath(this.mCalHomeSet.spec.replace(/\/$/, &quot;&quot;));</span>
<a href="#l2.393"></a><span id="l2.393" class="difflineminus">-      request = new PrincipalPropertySearchRequest(</span>
<a href="#l2.394"></a><span id="l2.394" class="difflineplus">+      request = new CalDavPrincipalPropertySearchRequest(</span>
<a href="#l2.395"></a><span id="l2.395">         this.session,</span>
<a href="#l2.396"></a><span id="l2.396">         this,</span>
<a href="#l2.397"></a><span id="l2.397">         requestUri,</span>
<a href="#l2.398"></a><span id="l2.398">         homePath,</span>
<a href="#l2.399"></a><span id="l2.399">         &quot;C:calendar-home-set&quot;,</span>
<a href="#l2.400"></a><span id="l2.400">         requestProps</span>
<a href="#l2.401"></a><span id="l2.401">       );</span>
<a href="#l2.402"></a><span id="l2.402">     }</span>
<a href="#l2.403"></a><span id="l2.403" class="difflineat">@@ -2020,17 +1951,17 @@ CalDavCalendar.prototype = {</span>
<a href="#l2.404"></a><span id="l2.404">       aListener.onResult(null, null);</span>
<a href="#l2.405"></a><span id="l2.405">       return;</span>
<a href="#l2.406"></a><span id="l2.406">     }</span>
<a href="#l2.407"></a><span id="l2.407"> </span>
<a href="#l2.408"></a><span id="l2.408">     let organizer = this.calendarUserAddress;</span>
<a href="#l2.409"></a><span id="l2.409">     let recipient = aCalIdParts.join(&quot;:&quot;);</span>
<a href="#l2.410"></a><span id="l2.410">     let fbUri = this.makeUri(null, this.outboxUrl);</span>
<a href="#l2.411"></a><span id="l2.411"> </span>
<a href="#l2.412"></a><span id="l2.412" class="difflineminus">-    let request = new FreeBusyRequest(</span>
<a href="#l2.413"></a><span id="l2.413" class="difflineplus">+    let request = new CalDavFreeBusyRequest(</span>
<a href="#l2.414"></a><span id="l2.414">       this.session,</span>
<a href="#l2.415"></a><span id="l2.415">       this,</span>
<a href="#l2.416"></a><span id="l2.416">       fbUri,</span>
<a href="#l2.417"></a><span id="l2.417">       organizer,</span>
<a href="#l2.418"></a><span id="l2.418">       recipient,</span>
<a href="#l2.419"></a><span id="l2.419">       aRangeStart,</span>
<a href="#l2.420"></a><span id="l2.420">       aRangeEnd</span>
<a href="#l2.421"></a><span id="l2.421">     );</span>
<a href="#l2.422"></a><span id="l2.422" class="difflineat">@@ -2334,17 +2265,17 @@ CalDavCalendar.prototype = {</span>
<a href="#l2.423"></a><span id="l2.423">         return false;</span>
<a href="#l2.424"></a><span id="l2.424">       }</span>
<a href="#l2.425"></a><span id="l2.425">       // work around BUG 351589, the below just removes RSVP:</span>
<a href="#l2.426"></a><span id="l2.426">       aItipItem.setAttendeeStatus(attendee.id, attendee.participationStatus);</span>
<a href="#l2.427"></a><span id="l2.427">     }</span>
<a href="#l2.428"></a><span id="l2.428"> </span>
<a href="#l2.429"></a><span id="l2.429">     for (let item of aItipItem.getItemList()) {</span>
<a href="#l2.430"></a><span id="l2.430">       let requestUri = this.makeUri(null, this.outboxUrl);</span>
<a href="#l2.431"></a><span id="l2.431" class="difflineminus">-      let request = new OutboxRequest(</span>
<a href="#l2.432"></a><span id="l2.432" class="difflineplus">+      let request = new CalDavOutboxRequest(</span>
<a href="#l2.433"></a><span id="l2.433">         this.session,</span>
<a href="#l2.434"></a><span id="l2.434">         this,</span>
<a href="#l2.435"></a><span id="l2.435">         requestUri,</span>
<a href="#l2.436"></a><span id="l2.436">         this.calendarUserAddress,</span>
<a href="#l2.437"></a><span id="l2.437">         aRecipients,</span>
<a href="#l2.438"></a><span id="l2.438">         item</span>
<a href="#l2.439"></a><span id="l2.439">       );</span>
<a href="#l2.440"></a><span id="l2.440"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/calendar/providers/caldav/calDavRequestHandlers.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/calendar/providers/caldav/calDavRequestHandlers.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -1,17 +1,19 @@</span>
<a href="#l3.4"></a><span id="l3.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l3.5"></a><span id="l3.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l3.6"></a><span id="l3.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8" class="difflineplus">+/* globals XML_HEADER MIME_TEXT_XML */</span>
<a href="#l3.9"></a><span id="l3.9" class="difflineplus">+</span>
<a href="#l3.10"></a><span id="l3.10"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l3.11"></a><span id="l3.11"> var { cal } = ChromeUtils.import(&quot;resource:///modules/calendar/calUtils.jsm&quot;);</span>
<a href="#l3.12"></a><span id="l3.12"> var { setTimeout } = ChromeUtils.import(&quot;resource://gre/modules/Timer.jsm&quot;);</span>
<a href="#l3.13"></a><span id="l3.13"> </span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/caldav/calDavRequest.jsm&quot;);</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+var { CalDavLegacySAXRequest } = ChromeUtils.import(&quot;resource:///modules/caldav/CalDavRequest.jsm&quot;);</span>
<a href="#l3.16"></a><span id="l3.16"> </span>
<a href="#l3.17"></a><span id="l3.17"> /**</span>
<a href="#l3.18"></a><span id="l3.18">  * This is a handler for the etag request in calDavCalendar.js' getUpdatedItem.</span>
<a href="#l3.19"></a><span id="l3.19">  * It uses the SAX parser to incrementally parse the items and compose the</span>
<a href="#l3.20"></a><span id="l3.20">  * resulting multiget.</span>
<a href="#l3.21"></a><span id="l3.21">  *</span>
<a href="#l3.22"></a><span id="l3.22">  * @param aCalendar             The (unwrapped) calendar this request belongs to</span>
<a href="#l3.23"></a><span id="l3.23">  * @param aBaseUri              The URI requested (i.e inbox or collection)</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineat">@@ -335,31 +337,33 @@ webDavSyncHandler.prototype = {</span>
<a href="#l3.25"></a><span id="l3.25">       &quot;&lt;/sync-collection&gt;&quot;;</span>
<a href="#l3.26"></a><span id="l3.26"> </span>
<a href="#l3.27"></a><span id="l3.27">     let requestUri = this.calendar.makeUri(null, this.baseUri);</span>
<a href="#l3.28"></a><span id="l3.28"> </span>
<a href="#l3.29"></a><span id="l3.29">     if (this.calendar.verboseLogging()) {</span>
<a href="#l3.30"></a><span id="l3.30">       cal.LOG(&quot;CalDAV: send(&quot; + requestUri.spec + &quot;): &quot; + queryXml);</span>
<a href="#l3.31"></a><span id="l3.31">     }</span>
<a href="#l3.32"></a><span id="l3.32">     cal.LOG(&quot;CalDAV: webdav-sync Token: &quot; + this.calendar.mWebdavSyncToken);</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineminus">-    let request = new LegacySAXRequest(</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+    let onSetupChannel = channel =&gt; {</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+      // The depth header adheres to an older version of the webdav-sync</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+      // spec and has been replaced by the &lt;sync-level&gt; tag above.</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+      // Unfortunately some servers still depend on the depth header,</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+      // therefore we send both (yuck).</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+      channel.setRequestHeader(&quot;Depth&quot;, &quot;1&quot;, false);</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+      channel.requestMethod = &quot;REPORT&quot;;</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineplus">+    };</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+    let request = new CalDavLegacySAXRequest(</span>
<a href="#l3.44"></a><span id="l3.44">       this.calendar.session,</span>
<a href="#l3.45"></a><span id="l3.45">       this.calendar,</span>
<a href="#l3.46"></a><span id="l3.46">       requestUri,</span>
<a href="#l3.47"></a><span id="l3.47">       queryXml,</span>
<a href="#l3.48"></a><span id="l3.48">       MIME_TEXT_XML,</span>
<a href="#l3.49"></a><span id="l3.49">       this,</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineminus">-      channel =&gt; {</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineminus">-        // The depth header adheres to an older version of the webdav-sync</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineminus">-        // spec and has been replaced by the &lt;sync-level&gt; tag above.</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineminus">-        // Unfortunately some servers still depend on the depth header,</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineminus">-        // therefore we send both (yuck).</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineminus">-        channel.setRequestHeader(&quot;Depth&quot;, &quot;1&quot;, false);</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineminus">-        channel.requestMethod = &quot;REPORT&quot;;</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineminus">-      }</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineplus">+      onSetupChannel</span>
<a href="#l3.59"></a><span id="l3.59">     );</span>
<a href="#l3.60"></a><span id="l3.60"> </span>
<a href="#l3.61"></a><span id="l3.61">     request.commit().catch(() =&gt; {</span>
<a href="#l3.62"></a><span id="l3.62">       // Something went wrong with the OAuth token, notify failure</span>
<a href="#l3.63"></a><span id="l3.63">       if (this.calendar.isCached &amp;&amp; this.changeLogListener) {</span>
<a href="#l3.64"></a><span id="l3.64">         this.changeLogListener.onResult(</span>
<a href="#l3.65"></a><span id="l3.65">           { status: Cr.NS_ERROR_NOT_AVAILABLE },</span>
<a href="#l3.66"></a><span id="l3.66">           Cr.NS_ERROR_NOT_AVAILABLE</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineat">@@ -737,27 +741,29 @@ multigetSyncHandler.prototype = {</span>
<a href="#l3.68"></a><span id="l3.68">       &quot;&lt;/D:prop&gt;&quot; +</span>
<a href="#l3.69"></a><span id="l3.69">       hrefString +</span>
<a href="#l3.70"></a><span id="l3.70">       &quot;&lt;/C:calendar-multiget&gt;&quot;;</span>
<a href="#l3.71"></a><span id="l3.71"> </span>
<a href="#l3.72"></a><span id="l3.72">     let requestUri = this.calendar.makeUri(null, this.baseUri);</span>
<a href="#l3.73"></a><span id="l3.73">     if (this.calendar.verboseLogging()) {</span>
<a href="#l3.74"></a><span id="l3.74">       cal.LOG(&quot;CalDAV: send(&quot; + requestUri.spec + &quot;): &quot; + queryXml);</span>
<a href="#l3.75"></a><span id="l3.75">     }</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineminus">-    let request = new LegacySAXRequest(</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineplus">+</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineplus">+    let onSetupChannel = channel =&gt; {</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineplus">+      channel.requestMethod = &quot;REPORT&quot;;</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineplus">+      channel.setRequestHeader(&quot;Depth&quot;, &quot;1&quot;, false);</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineplus">+    };</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineplus">+    let request = new CalDavLegacySAXRequest(</span>
<a href="#l3.83"></a><span id="l3.83">       this.calendar.session,</span>
<a href="#l3.84"></a><span id="l3.84">       this.calendar,</span>
<a href="#l3.85"></a><span id="l3.85">       requestUri,</span>
<a href="#l3.86"></a><span id="l3.86">       queryXml,</span>
<a href="#l3.87"></a><span id="l3.87">       MIME_TEXT_XML,</span>
<a href="#l3.88"></a><span id="l3.88">       this,</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineminus">-      channel =&gt; {</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineminus">-        channel.requestMethod = &quot;REPORT&quot;;</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineminus">-        channel.setRequestHeader(&quot;Depth&quot;, &quot;1&quot;, false);</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineminus">-      }</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineplus">+      onSetupChannel</span>
<a href="#l3.94"></a><span id="l3.94">     );</span>
<a href="#l3.95"></a><span id="l3.95"> </span>
<a href="#l3.96"></a><span id="l3.96">     request.commit().catch(() =&gt; {</span>
<a href="#l3.97"></a><span id="l3.97">       // Something went wrong with the OAuth token, notify failure</span>
<a href="#l3.98"></a><span id="l3.98">       if (this.calendar.isCached &amp;&amp; this.changeLogListener) {</span>
<a href="#l3.99"></a><span id="l3.99">         this.changeLogListener.onResult(</span>
<a href="#l3.100"></a><span id="l3.100">           { status: Cr.NS_ERROR_NOT_AVAILABLE },</span>
<a href="#l3.101"></a><span id="l3.101">           Cr.NS_ERROR_NOT_AVAILABLE</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1">rename from calendar/providers/caldav/modules/calDavRequest.jsm</span>
<a href="#l4.2"></a><span id="l4.2">rename to calendar/providers/caldav/modules/CalDavRequest.jsm</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineminus">--- a/calendar/providers/caldav/modules/calDavRequest.jsm</span>
<a href="#l4.4"></a><span id="l4.4" class="difflineplus">+++ b/calendar/providers/caldav/modules/CalDavRequest.jsm</span>
<a href="#l4.5"></a><span id="l4.5" class="difflineat">@@ -1,39 +1,44 @@</span>
<a href="#l4.6"></a><span id="l4.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l4.7"></a><span id="l4.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l4.8"></a><span id="l4.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l4.9"></a><span id="l4.9"> </span>
<a href="#l4.10"></a><span id="l4.10" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/calendar/calUtils.jsm&quot;);</span>
<a href="#l4.11"></a><span id="l4.11" class="difflineplus">+var { cal } = ChromeUtils.import(&quot;resource:///modules/calendar/calUtils.jsm&quot;);</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+var { CalDavTagsToXmlns, CalDavNsUnresolver } = ChromeUtils.import(</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+  &quot;resource:///modules/caldav/CalDavUtils.jsm&quot;</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+);</span>
<a href="#l4.16"></a><span id="l4.16"> </span>
<a href="#l4.17"></a><span id="l4.17" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/caldav/calDavUtils.jsm&quot;);</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/caldav/calDavSession.jsm&quot;);</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+var { CalDavSession } = ChromeUtils.import(&quot;resource:///modules/caldav/CalDavSession.jsm&quot;);</span>
<a href="#l4.20"></a><span id="l4.20"> </span>
<a href="#l4.21"></a><span id="l4.21" class="difflineminus">-/* exported GenericRequest, LegacySAXRequest, ItemRequest, DeleteItemRequest, PropfindRequest,</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineminus">-            DAVHeaderRequest, PrincipalPropertySearchRequest, OutboxRequest, FreeBusyRequest */</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+/* exported CalDavGenericRequest, CalDavLegacySAXRequest, CalDavItemRequest,</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineplus">+            CalDavDeleteItemRequest, CalDavPropfindRequest, CalDavHeaderRequest,</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineplus">+            CalDavPrincipalPropertySearchRequest, CalDavOutboxRequest, CalDavFreeBusyRequest */</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineplus">+</span>
<a href="#l4.27"></a><span id="l4.27"> this.EXPORTED_SYMBOLS = [</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineminus">-  &quot;GenericRequest&quot;,</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineminus">-  &quot;LegacySAXRequest&quot;,</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineminus">-  &quot;ItemRequest&quot;,</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineminus">-  &quot;DeleteItemRequest&quot;,</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineminus">-  &quot;PropfindRequest&quot;,</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineminus">-  &quot;DAVHeaderRequest&quot;,</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineminus">-  &quot;PrincipalPropertySearchRequest&quot;,</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineminus">-  &quot;OutboxRequest&quot;,</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineminus">-  &quot;FreeBusyRequest&quot;,</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+  &quot;CalDavGenericRequest&quot;,</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+  &quot;CalDavLegacySAXRequest&quot;,</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+  &quot;CalDavItemRequest&quot;,</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+  &quot;CalDavDeleteItemRequest&quot;,</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+  &quot;CalDavPropfindRequest&quot;,</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+  &quot;CalDavHeaderRequest&quot;,</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineplus">+  &quot;CalDavPrincipalPropertySearchRequest&quot;,</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+  &quot;CalDavOutboxRequest&quot;,</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+  &quot;CalDavFreeBusyRequest&quot;,</span>
<a href="#l4.46"></a><span id="l4.46"> ];</span>
<a href="#l4.47"></a><span id="l4.47"> </span>
<a href="#l4.48"></a><span id="l4.48"> const XML_HEADER = '&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;\n';</span>
<a href="#l4.49"></a><span id="l4.49"> const MIME_TEXT_CALENDAR = &quot;text/calendar; charset=utf-8&quot;;</span>
<a href="#l4.50"></a><span id="l4.50"> const MIME_TEXT_XML = &quot;text/xml; charset=utf-8&quot;;</span>
<a href="#l4.51"></a><span id="l4.51"> </span>
<a href="#l4.52"></a><span id="l4.52"> /**</span>
<a href="#l4.53"></a><span id="l4.53">  * Base class for a caldav request.</span>
<a href="#l4.54"></a><span id="l4.54">  */</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineminus">-class CalDavRequest {</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineplus">+class CalDavRequestBase {</span>
<a href="#l4.57"></a><span id="l4.57">   QueryInterface(aIID) {</span>
<a href="#l4.58"></a><span id="l4.58">     return cal.generateClassQI(this, aIID, [Ci.nsIChannelEventSink, Ci.nsIInterfaceRequestor]);</span>
<a href="#l4.59"></a><span id="l4.59">   }</span>
<a href="#l4.60"></a><span id="l4.60"> </span>
<a href="#l4.61"></a><span id="l4.61">   /**</span>
<a href="#l4.62"></a><span id="l4.62">    * Creates a new base response, this should mainly be done using the subclass constructor</span>
<a href="#l4.63"></a><span id="l4.63">    *</span>
<a href="#l4.64"></a><span id="l4.64">    * @param {CalDavSession} aSession                  The session to use for this request</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineat">@@ -93,18 +98,18 @@ class CalDavRequest {</span>
<a href="#l4.66"></a><span id="l4.66">     } catch (e) {</span>
<a href="#l4.67"></a><span id="l4.67">       return null;</span>
<a href="#l4.68"></a><span id="l4.68">     }</span>
<a href="#l4.69"></a><span id="l4.69">   }</span>
<a href="#l4.70"></a><span id="l4.70"> </span>
<a href="#l4.71"></a><span id="l4.71">   /**</span>
<a href="#l4.72"></a><span id="l4.72">    * Executes the request with the configuration set up in the constructor</span>
<a href="#l4.73"></a><span id="l4.73">    *</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineminus">-   * @return {Promise}        A promise that resolves with the CalDavResponse, or a subclass</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineminus">-   *                            thereof based on |responseClass|</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineplus">+   * @return {Promise}        A promise that resolves with a subclass of CalDavResponseBase</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineplus">+   *                            which is based on |responseClass|.</span>
<a href="#l4.78"></a><span id="l4.78">    */</span>
<a href="#l4.79"></a><span id="l4.79">   async commit() {</span>
<a href="#l4.80"></a><span id="l4.80">     await this.session.prepareRequest(this.channel);</span>
<a href="#l4.81"></a><span id="l4.81"> </span>
<a href="#l4.82"></a><span id="l4.82">     if (this.onSetupChannel) {</span>
<a href="#l4.83"></a><span id="l4.83">       this.onSetupChannel(this.channel);</span>
<a href="#l4.84"></a><span id="l4.84">     }</span>
<a href="#l4.85"></a><span id="l4.85"> </span>
<a href="#l4.86"></a><span id="l4.86" class="difflineat">@@ -223,21 +228,21 @@ class CalDavRequest {</span>
<a href="#l4.87"></a><span id="l4.87">     });</span>
<a href="#l4.88"></a><span id="l4.88">   }</span>
<a href="#l4.89"></a><span id="l4.89"> }</span>
<a href="#l4.90"></a><span id="l4.90"> </span>
<a href="#l4.91"></a><span id="l4.91"> /**</span>
<a href="#l4.92"></a><span id="l4.92">  * The caldav response base class. Should be subclassed, and works with xpcom network code that uses</span>
<a href="#l4.93"></a><span id="l4.93">  * nsIRequest.</span>
<a href="#l4.94"></a><span id="l4.94">  */</span>
<a href="#l4.95"></a><span id="l4.95" class="difflineminus">-class CalDavResponse {</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineplus">+class CalDavResponseBase {</span>
<a href="#l4.97"></a><span id="l4.97">   /**</span>
<a href="#l4.98"></a><span id="l4.98">    * Constructs a new caldav response</span>
<a href="#l4.99"></a><span id="l4.99">    *</span>
<a href="#l4.100"></a><span id="l4.100" class="difflineminus">-   * @param {CalDavRequest} aRequest      The request that initiated the response</span>
<a href="#l4.101"></a><span id="l4.101" class="difflineplus">+   * @param {CalDavRequestBase} aRequest      The request that initiated the response</span>
<a href="#l4.102"></a><span id="l4.102">    */</span>
<a href="#l4.103"></a><span id="l4.103">   constructor(aRequest) {</span>
<a href="#l4.104"></a><span id="l4.104">     this.request = aRequest;</span>
<a href="#l4.105"></a><span id="l4.105"> </span>
<a href="#l4.106"></a><span id="l4.106">     this.responded = new Promise((resolve, reject) =&gt; {</span>
<a href="#l4.107"></a><span id="l4.107">       this._onresponded = resolve;</span>
<a href="#l4.108"></a><span id="l4.108">       this._onrespondederror = reject;</span>
<a href="#l4.109"></a><span id="l4.109">     });</span>
<a href="#l4.110"></a><span id="l4.110" class="difflineat">@@ -306,25 +311,27 @@ class CalDavResponse {</span>
<a href="#l4.111"></a><span id="l4.111">   get serverError() {</span>
<a href="#l4.112"></a><span id="l4.112">     return this.statusCategory == 5;</span>
<a href="#l4.113"></a><span id="l4.113">   }</span>
<a href="#l4.114"></a><span id="l4.114"> </span>
<a href="#l4.115"></a><span id="l4.115">   /**</span>
<a href="#l4.116"></a><span id="l4.116">    * Raise an exception if one of the handled 4xx and 5xx occured</span>
<a href="#l4.117"></a><span id="l4.117">    */</span>
<a href="#l4.118"></a><span id="l4.118">   raiseForStatus() {</span>
<a href="#l4.119"></a><span id="l4.119" class="difflineplus">+    /* eslint-disable no-undef */</span>
<a href="#l4.120"></a><span id="l4.120">     if (this.authError) {</span>
<a href="#l4.121"></a><span id="l4.121">       throw new HttpUnauthorizedError(this);</span>
<a href="#l4.122"></a><span id="l4.122">     } else if (this.conflict) {</span>
<a href="#l4.123"></a><span id="l4.123">       throw new HttpConflictError(this);</span>
<a href="#l4.124"></a><span id="l4.124">     } else if (this.notFound) {</span>
<a href="#l4.125"></a><span id="l4.125">       throw new HttpNotFoundError(this);</span>
<a href="#l4.126"></a><span id="l4.126">     } else if (this.serverError) {</span>
<a href="#l4.127"></a><span id="l4.127">       throw new HttpServerError(this);</span>
<a href="#l4.128"></a><span id="l4.128">     }</span>
<a href="#l4.129"></a><span id="l4.129" class="difflineplus">+    /* eslint-enable no-undef */</span>
<a href="#l4.130"></a><span id="l4.130">   }</span>
<a href="#l4.131"></a><span id="l4.131"> </span>
<a href="#l4.132"></a><span id="l4.132">   /** The text response of the request */</span>
<a href="#l4.133"></a><span id="l4.133">   get text() {</span>
<a href="#l4.134"></a><span id="l4.134">     throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l4.135"></a><span id="l4.135">   }</span>
<a href="#l4.136"></a><span id="l4.136"> </span>
<a href="#l4.137"></a><span id="l4.137">   /** @return {DOMDocument} A DOM document with the response xml */</span>
<a href="#l4.138"></a><span id="l4.138" class="difflineat">@@ -353,17 +360,17 @@ class CalDavResponse {</span>
<a href="#l4.139"></a><span id="l4.139">       return null;</span>
<a href="#l4.140"></a><span id="l4.140">     }</span>
<a href="#l4.141"></a><span id="l4.141">   }</span>
<a href="#l4.142"></a><span id="l4.142"> }</span>
<a href="#l4.143"></a><span id="l4.143"> </span>
<a href="#l4.144"></a><span id="l4.144"> /**</span>
<a href="#l4.145"></a><span id="l4.145">  * A simple caldav response using nsIStreamLoader</span>
<a href="#l4.146"></a><span id="l4.146">  */</span>
<a href="#l4.147"></a><span id="l4.147" class="difflineminus">-class CalDavSimpleResponse extends CalDavResponse {</span>
<a href="#l4.148"></a><span id="l4.148" class="difflineplus">+class CalDavSimpleResponse extends CalDavResponseBase {</span>
<a href="#l4.149"></a><span id="l4.149">   QueryInterface(aIID) {</span>
<a href="#l4.150"></a><span id="l4.150">     return cal.generateClassQI(this, aIID, [Ci.nsIStreamLoaderObserver]);</span>
<a href="#l4.151"></a><span id="l4.151">   }</span>
<a href="#l4.152"></a><span id="l4.152"> </span>
<a href="#l4.153"></a><span id="l4.153">   get listener() {</span>
<a href="#l4.154"></a><span id="l4.154">     if (!this._listener) {</span>
<a href="#l4.155"></a><span id="l4.155">       this._listener = cal.provider.createStreamLoader();</span>
<a href="#l4.156"></a><span id="l4.156">       this._listener.init(this);</span>
<a href="#l4.157"></a><span id="l4.157" class="difflineat">@@ -392,25 +399,25 @@ class CalDavSimpleResponse extends CalDa</span>
<a href="#l4.158"></a><span id="l4.158">       this._onrespondederror(this);</span>
<a href="#l4.159"></a><span id="l4.159">     }</span>
<a href="#l4.160"></a><span id="l4.160">   }</span>
<a href="#l4.161"></a><span id="l4.161"> }</span>
<a href="#l4.162"></a><span id="l4.162"> </span>
<a href="#l4.163"></a><span id="l4.163"> /**</span>
<a href="#l4.164"></a><span id="l4.164">  * A generic request method that uses the CalDavRequest/CalDavResponse infrastructure</span>
<a href="#l4.165"></a><span id="l4.165">  */</span>
<a href="#l4.166"></a><span id="l4.166" class="difflineminus">-class GenericRequest extends CalDavRequest {</span>
<a href="#l4.167"></a><span id="l4.167" class="difflineplus">+class CalDavGenericRequest extends CalDavRequestBase {</span>
<a href="#l4.168"></a><span id="l4.168">   /**</span>
<a href="#l4.169"></a><span id="l4.169">    * Constructs the generic caldav request</span>
<a href="#l4.170"></a><span id="l4.170">    *</span>
<a href="#l4.171"></a><span id="l4.171">    * @param {CalDavSession} aSession                  The session to use for this request</span>
<a href="#l4.172"></a><span id="l4.172">    * @param {calICalendar} aCalendar                  The calendar this request belongs to</span>
<a href="#l4.173"></a><span id="l4.173">    * @param {String} aMethod                          The HTTP method to use</span>
<a href="#l4.174"></a><span id="l4.174">    * @param {nsIURI} aUri                             The uri to request</span>
<a href="#l4.175"></a><span id="l4.175" class="difflineminus">-   * @param {Object} aHeaders                         An object with headers to set</span>
<a href="#l4.176"></a><span id="l4.176" class="difflineplus">+   * @param {?Object} aHeaders                        An object with headers to set</span>
<a href="#l4.177"></a><span id="l4.177">    * @param {?String} aUploadData                     Optional data to upload</span>
<a href="#l4.178"></a><span id="l4.178">    * @param {?String} aUploadType                     Content type for upload data</span>
<a href="#l4.179"></a><span id="l4.179">    */</span>
<a href="#l4.180"></a><span id="l4.180">   constructor(</span>
<a href="#l4.181"></a><span id="l4.181">     aSession,</span>
<a href="#l4.182"></a><span id="l4.182">     aCalendar,</span>
<a href="#l4.183"></a><span id="l4.183">     aMethod,</span>
<a href="#l4.184"></a><span id="l4.184">     aUri,</span>
<a href="#l4.185"></a><span id="l4.185" class="difflineat">@@ -428,17 +435,17 @@ class GenericRequest extends CalDavReque</span>
<a href="#l4.186"></a><span id="l4.186">   }</span>
<a href="#l4.187"></a><span id="l4.187"> }</span>
<a href="#l4.188"></a><span id="l4.188"> </span>
<a href="#l4.189"></a><span id="l4.189"> /**</span>
<a href="#l4.190"></a><span id="l4.190">  * Legacy request handlers request that uses an external request listener. Used for transitioning</span>
<a href="#l4.191"></a><span id="l4.191">  * because once I started refactoring calDavRequestHandlers.js I was on the verge of refactoring the</span>
<a href="#l4.192"></a><span id="l4.192">  * whole caldav provider. Too risky right now.</span>
<a href="#l4.193"></a><span id="l4.193">  */</span>
<a href="#l4.194"></a><span id="l4.194" class="difflineminus">-class LegacySAXRequest extends CalDavRequest {</span>
<a href="#l4.195"></a><span id="l4.195" class="difflineplus">+class CalDavLegacySAXRequest extends CalDavRequestBase {</span>
<a href="#l4.196"></a><span id="l4.196">   /**</span>
<a href="#l4.197"></a><span id="l4.197">    * Constructs the legacy caldav request</span>
<a href="#l4.198"></a><span id="l4.198">    *</span>
<a href="#l4.199"></a><span id="l4.199">    * @param {CalDavSession} aSession                  The session to use for this request</span>
<a href="#l4.200"></a><span id="l4.200">    * @param {calICalendar} aCalendar                  The calendar this request belongs to</span>
<a href="#l4.201"></a><span id="l4.201">    * @param {nsIURI} aUri                             The uri to request</span>
<a href="#l4.202"></a><span id="l4.202">    * @param {?String} aUploadData                     Optional data to upload</span>
<a href="#l4.203"></a><span id="l4.203">    * @param {?String} aUploadType                     Content type for upload data</span>
<a href="#l4.204"></a><span id="l4.204" class="difflineat">@@ -465,22 +472,24 @@ class LegacySAXRequest extends CalDavReq</span>
<a href="#l4.205"></a><span id="l4.205">     return LegacySAXResponse;</span>
<a href="#l4.206"></a><span id="l4.206">   }</span>
<a href="#l4.207"></a><span id="l4.207"> }</span>
<a href="#l4.208"></a><span id="l4.208"> </span>
<a href="#l4.209"></a><span id="l4.209"> /**</span>
<a href="#l4.210"></a><span id="l4.210">  * Response class for legacy requests. Contains a listener that proxies the external handler to run</span>
<a href="#l4.211"></a><span id="l4.211">  * the promises we use.</span>
<a href="#l4.212"></a><span id="l4.212">  */</span>
<a href="#l4.213"></a><span id="l4.213" class="difflineminus">-class LegacySAXResponse extends CalDavResponse {</span>
<a href="#l4.214"></a><span id="l4.214" class="difflineplus">+class LegacySAXResponse extends CalDavResponseBase {</span>
<a href="#l4.215"></a><span id="l4.215">   /** @return {nsIStreamListener} The listener passed to the channel's asyncOpen */</span>
<a href="#l4.216"></a><span id="l4.216">   get listener() {</span>
<a href="#l4.217"></a><span id="l4.217">     if (!this._listener) {</span>
<a href="#l4.218"></a><span id="l4.218" class="difflineplus">+      let self = this;</span>
<a href="#l4.219"></a><span id="l4.219" class="difflineplus">+</span>
<a href="#l4.220"></a><span id="l4.220">       this._listener = new Proxy(this.request._handler, {</span>
<a href="#l4.221"></a><span id="l4.221" class="difflineminus">-        get: function(aTarget, aProp, aReceiver) {</span>
<a href="#l4.222"></a><span id="l4.222" class="difflineplus">+        get(aTarget, aProp, aReceiver) {</span>
<a href="#l4.223"></a><span id="l4.223">           if (aProp == &quot;OnStartRequest&quot;) {</span>
<a href="#l4.224"></a><span id="l4.224">             return function(...args) {</span>
<a href="#l4.225"></a><span id="l4.225">               try {</span>
<a href="#l4.226"></a><span id="l4.226">                 let result = aTarget[aProp].apply(this, args);</span>
<a href="#l4.227"></a><span id="l4.227">                 self._onresponded();</span>
<a href="#l4.228"></a><span id="l4.228">                 return result;</span>
<a href="#l4.229"></a><span id="l4.229">               } catch (e) {</span>
<a href="#l4.230"></a><span id="l4.230">                 self._onrespondederror(e);</span>
<a href="#l4.231"></a><span id="l4.231" class="difflineat">@@ -493,35 +502,34 @@ class LegacySAXResponse extends CalDavRe</span>
<a href="#l4.232"></a><span id="l4.232">                 let result = aTarget[aProp].apply(this, args);</span>
<a href="#l4.233"></a><span id="l4.233">                 self._oncompleted();</span>
<a href="#l4.234"></a><span id="l4.234">                 return result;</span>
<a href="#l4.235"></a><span id="l4.235">               } catch (e) {</span>
<a href="#l4.236"></a><span id="l4.236">                 self._oncompletederror(e);</span>
<a href="#l4.237"></a><span id="l4.237">                 return null;</span>
<a href="#l4.238"></a><span id="l4.238">               }</span>
<a href="#l4.239"></a><span id="l4.239">             };</span>
<a href="#l4.240"></a><span id="l4.240" class="difflineminus">-          } else {</span>
<a href="#l4.241"></a><span id="l4.241" class="difflineminus">-            return Reflect.get(...arguments);</span>
<a href="#l4.242"></a><span id="l4.242">           }</span>
<a href="#l4.243"></a><span id="l4.243" class="difflineplus">+          return Reflect.get(...arguments);</span>
<a href="#l4.244"></a><span id="l4.244">         },</span>
<a href="#l4.245"></a><span id="l4.245">       });</span>
<a href="#l4.246"></a><span id="l4.246">     }</span>
<a href="#l4.247"></a><span id="l4.247">     return this._listener;</span>
<a href="#l4.248"></a><span id="l4.248">   }</span>
<a href="#l4.249"></a><span id="l4.249"> </span>
<a href="#l4.250"></a><span id="l4.250">   /** @return {String} The text response of the request */</span>
<a href="#l4.251"></a><span id="l4.251">   get text() {</span>
<a href="#l4.252"></a><span id="l4.252">     return this.request._handler.logXML;</span>
<a href="#l4.253"></a><span id="l4.253">   }</span>
<a href="#l4.254"></a><span id="l4.254"> }</span>
<a href="#l4.255"></a><span id="l4.255"> </span>
<a href="#l4.256"></a><span id="l4.256"> /**</span>
<a href="#l4.257"></a><span id="l4.257">  * Upload an item to the caldav server</span>
<a href="#l4.258"></a><span id="l4.258">  */</span>
<a href="#l4.259"></a><span id="l4.259" class="difflineminus">-class ItemRequest extends CalDavRequest {</span>
<a href="#l4.260"></a><span id="l4.260" class="difflineplus">+class CalDavItemRequest extends CalDavRequestBase {</span>
<a href="#l4.261"></a><span id="l4.261">   /**</span>
<a href="#l4.262"></a><span id="l4.262">    * Constructs an item request</span>
<a href="#l4.263"></a><span id="l4.263">    *</span>
<a href="#l4.264"></a><span id="l4.264">    * @param {CalDavSession} aSession                  The session to use for this request</span>
<a href="#l4.265"></a><span id="l4.265">    * @param {calICalendar} aCalendar                  The calendar this request belongs to</span>
<a href="#l4.266"></a><span id="l4.266">    * @param {nsIURI} aUri                             The uri to request</span>
<a href="#l4.267"></a><span id="l4.267">    * @param {calIItemBase} aItem                      The item to send</span>
<a href="#l4.268"></a><span id="l4.268">    * @param {?String} aEtag                           The etag to check. The special value &quot;*&quot;</span>
<a href="#l4.269"></a><span id="l4.269" class="difflineat">@@ -563,17 +571,17 @@ class ItemResponse extends CalDavSimpleR</span>
<a href="#l4.270"></a><span id="l4.270">     // server impls don't get this right yet.</span>
<a href="#l4.271"></a><span id="l4.271">     return this.status == 204 || this.status == 201 || this.status == 200;</span>
<a href="#l4.272"></a><span id="l4.272">   }</span>
<a href="#l4.273"></a><span id="l4.273"> }</span>
<a href="#l4.274"></a><span id="l4.274"> </span>
<a href="#l4.275"></a><span id="l4.275"> /**</span>
<a href="#l4.276"></a><span id="l4.276">  * A request for deleting an item from the server</span>
<a href="#l4.277"></a><span id="l4.277">  */</span>
<a href="#l4.278"></a><span id="l4.278" class="difflineminus">-class DeleteItemRequest extends CalDavRequest {</span>
<a href="#l4.279"></a><span id="l4.279" class="difflineplus">+class CalDavDeleteItemRequest extends CalDavRequestBase {</span>
<a href="#l4.280"></a><span id="l4.280">   /**</span>
<a href="#l4.281"></a><span id="l4.281">    * Constructs an delete item request</span>
<a href="#l4.282"></a><span id="l4.282">    *</span>
<a href="#l4.283"></a><span id="l4.283">    * @param {CalDavSession} aSession                  The session to use for this request</span>
<a href="#l4.284"></a><span id="l4.284">    * @param {calICalendar} aCalendar                  The calendar this request belongs to</span>
<a href="#l4.285"></a><span id="l4.285">    * @param {nsIURI} aUri                             The uri to request</span>
<a href="#l4.286"></a><span id="l4.286">    * @param {?String} aEtag                           The etag to check, or null to</span>
<a href="#l4.287"></a><span id="l4.287">    *                                                    unconditionally delete</span>
<a href="#l4.288"></a><span id="l4.288" class="difflineat">@@ -604,31 +612,31 @@ class DeleteItemResponse extends ItemRes</span>
<a href="#l4.289"></a><span id="l4.289">     // Accepting 404 as success because then the item is already deleted</span>
<a href="#l4.290"></a><span id="l4.290">     return this.status == 204 || this.status == 200 || this.status == 404;</span>
<a href="#l4.291"></a><span id="l4.291">   }</span>
<a href="#l4.292"></a><span id="l4.292"> }</span>
<a href="#l4.293"></a><span id="l4.293"> </span>
<a href="#l4.294"></a><span id="l4.294"> /**</span>
<a href="#l4.295"></a><span id="l4.295">  * A dav PROPFIND request to retrieve specific properties of a dav resource</span>
<a href="#l4.296"></a><span id="l4.296">  */</span>
<a href="#l4.297"></a><span id="l4.297" class="difflineminus">-class PropfindRequest extends CalDavRequest {</span>
<a href="#l4.298"></a><span id="l4.298" class="difflineplus">+class CalDavPropfindRequest extends CalDavRequestBase {</span>
<a href="#l4.299"></a><span id="l4.299">   /**</span>
<a href="#l4.300"></a><span id="l4.300">    * Constructs a propfind request</span>
<a href="#l4.301"></a><span id="l4.301">    *</span>
<a href="#l4.302"></a><span id="l4.302">    * @param {CalDavSession} aSession                  The session to use for this request</span>
<a href="#l4.303"></a><span id="l4.303">    * @param {calICalendar} aCalendar                  The calendar this request belongs to</span>
<a href="#l4.304"></a><span id="l4.304">    * @param {nsIURI} aUri                             The uri to request</span>
<a href="#l4.305"></a><span id="l4.305">    * @param {String[]} aProps                         The properties to request, including</span>
<a href="#l4.306"></a><span id="l4.306">    *                                                    namespace prefix.</span>
<a href="#l4.307"></a><span id="l4.307">    * @param {Number} aDepth                           The depth for the request, defaults to 0</span>
<a href="#l4.308"></a><span id="l4.308">    */</span>
<a href="#l4.309"></a><span id="l4.309">   constructor(aSession, aCalendar, aUri, aProps, aDepth = 0) {</span>
<a href="#l4.310"></a><span id="l4.310">     let xml =</span>
<a href="#l4.311"></a><span id="l4.311">       XML_HEADER +</span>
<a href="#l4.312"></a><span id="l4.312" class="difflineminus">-      `&lt;D:propfind ${tagsToXmlns(&quot;D&quot;, ...aProps)}&gt;&lt;D:prop&gt;` +</span>
<a href="#l4.313"></a><span id="l4.313" class="difflineplus">+      `&lt;D:propfind ${CalDavTagsToXmlns(&quot;D&quot;, ...aProps)}&gt;&lt;D:prop&gt;` +</span>
<a href="#l4.314"></a><span id="l4.314">       aProps.map(prop =&gt; `&lt;${prop}/&gt;`).join(&quot;&quot;) +</span>
<a href="#l4.315"></a><span id="l4.315">       &quot;&lt;/D:prop&gt;&lt;/D:propfind&gt;&quot;;</span>
<a href="#l4.316"></a><span id="l4.316"> </span>
<a href="#l4.317"></a><span id="l4.317">     super(aSession, aCalendar, aUri, xml, MIME_TEXT_XML, channel =&gt; {</span>
<a href="#l4.318"></a><span id="l4.318">       channel.setRequestHeader(&quot;Depth&quot;, aDepth, false);</span>
<a href="#l4.319"></a><span id="l4.319">       channel.requestMethod = &quot;PROPFIND&quot;;</span>
<a href="#l4.320"></a><span id="l4.320">     });</span>
<a href="#l4.321"></a><span id="l4.321"> </span>
<a href="#l4.322"></a><span id="l4.322" class="difflineat">@@ -685,17 +693,17 @@ class PropfindResponse extends CalDavSim</span>
<a href="#l4.323"></a><span id="l4.323">      *</span>
<a href="#l4.324"></a><span id="l4.324">      * @param {String} path         The css path to search</span>
<a href="#l4.325"></a><span id="l4.325">      * @param {Element} parent      The parent element to search in</span>
<a href="#l4.326"></a><span id="l4.326">      * @return {Set&lt;String&gt;}        A set with the element names</span>
<a href="#l4.327"></a><span id="l4.327">      */</span>
<a href="#l4.328"></a><span id="l4.328">     function nodeNames(path, parent) {</span>
<a href="#l4.329"></a><span id="l4.329">       return new Set(</span>
<a href="#l4.330"></a><span id="l4.330">         [...parent.querySelectorAll(path)].map(node =&gt; {</span>
<a href="#l4.331"></a><span id="l4.331" class="difflineminus">-          let prefix = caldavNSUnresolver(node.namespaceURI) || node.prefix;</span>
<a href="#l4.332"></a><span id="l4.332" class="difflineplus">+          let prefix = CalDavNsUnresolver(node.namespaceURI) || node.prefix;</span>
<a href="#l4.333"></a><span id="l4.333">           return prefix + &quot;:&quot; + node.localName;</span>
<a href="#l4.334"></a><span id="l4.334">         })</span>
<a href="#l4.335"></a><span id="l4.335">       );</span>
<a href="#l4.336"></a><span id="l4.336">     }</span>
<a href="#l4.337"></a><span id="l4.337"> </span>
<a href="#l4.338"></a><span id="l4.338">     /**</span>
<a href="#l4.339"></a><span id="l4.339">      * Returns a Set with the respective attribute values in the path</span>
<a href="#l4.340"></a><span id="l4.340">      *</span>
<a href="#l4.341"></a><span id="l4.341" class="difflineat">@@ -748,17 +756,17 @@ class PropfindResponse extends CalDavSim</span>
<a href="#l4.342"></a><span id="l4.342">       this._data = {};</span>
<a href="#l4.343"></a><span id="l4.343">       for (let response of this.xml.querySelectorAll(&quot;:scope &gt; response&quot;)) {</span>
<a href="#l4.344"></a><span id="l4.344">         let href = response.querySelector(&quot;:scope &gt; href&quot;).textContent;</span>
<a href="#l4.345"></a><span id="l4.345">         this._data[href] = {};</span>
<a href="#l4.346"></a><span id="l4.346"> </span>
<a href="#l4.347"></a><span id="l4.347">         // This will throw 200's and 400's in one pot, but since 400's are empty that is ok</span>
<a href="#l4.348"></a><span id="l4.348">         // for our needs.</span>
<a href="#l4.349"></a><span id="l4.349">         for (let prop of response.querySelectorAll(&quot;:scope &gt; propstat &gt; prop &gt; *&quot;)) {</span>
<a href="#l4.350"></a><span id="l4.350" class="difflineminus">-          let prefix = caldavNSUnresolver(prop.namespaceURI) || prop.prefix;</span>
<a href="#l4.351"></a><span id="l4.351" class="difflineplus">+          let prefix = CalDavNsUnresolver(prop.namespaceURI) || prop.prefix;</span>
<a href="#l4.352"></a><span id="l4.352">           let qname = prefix + &quot;:&quot; + prop.localName;</span>
<a href="#l4.353"></a><span id="l4.353">           if (qname in this.decorators) {</span>
<a href="#l4.354"></a><span id="l4.354">             this._data[href][qname] = this.decorators[qname](prop) || null;</span>
<a href="#l4.355"></a><span id="l4.355">           } else {</span>
<a href="#l4.356"></a><span id="l4.356">             this._data[href][qname] = prop.textContent.trim() || null;</span>
<a href="#l4.357"></a><span id="l4.357">           }</span>
<a href="#l4.358"></a><span id="l4.358">         }</span>
<a href="#l4.359"></a><span id="l4.359">       }</span>
<a href="#l4.360"></a><span id="l4.360" class="difflineat">@@ -777,17 +785,17 @@ class PropfindResponse extends CalDavSim</span>
<a href="#l4.361"></a><span id="l4.361">   get ok() {</span>
<a href="#l4.362"></a><span id="l4.362">     return this.status == 207 &amp;&amp; this.xml;</span>
<a href="#l4.363"></a><span id="l4.363">   }</span>
<a href="#l4.364"></a><span id="l4.364"> }</span>
<a href="#l4.365"></a><span id="l4.365"> </span>
<a href="#l4.366"></a><span id="l4.366"> /**</span>
<a href="#l4.367"></a><span id="l4.367">  * An OPTIONS request for retrieving the DAV header</span>
<a href="#l4.368"></a><span id="l4.368">  */</span>
<a href="#l4.369"></a><span id="l4.369" class="difflineminus">-class DAVHeaderRequest extends CalDavRequest {</span>
<a href="#l4.370"></a><span id="l4.370" class="difflineplus">+class CalDavHeaderRequest extends CalDavRequestBase {</span>
<a href="#l4.371"></a><span id="l4.371">   /**</span>
<a href="#l4.372"></a><span id="l4.372">    * Constructs the options request</span>
<a href="#l4.373"></a><span id="l4.373">    *</span>
<a href="#l4.374"></a><span id="l4.374">    * @param {CalDavSession} aSession                  The session to use for this request</span>
<a href="#l4.375"></a><span id="l4.375">    * @param {calICalendar} aCalendar                  The calendar this request belongs to</span>
<a href="#l4.376"></a><span id="l4.376">    * @param {nsIURI} aUri                             The uri to request</span>
<a href="#l4.377"></a><span id="l4.377">    */</span>
<a href="#l4.378"></a><span id="l4.378">   constructor(aSession, aCalendar, aUri) {</span>
<a href="#l4.379"></a><span id="l4.379" class="difflineat">@@ -828,32 +836,32 @@ class DAVHeaderResponse extends CalDavSi</span>
<a href="#l4.380"></a><span id="l4.380">     let dav = this.getHeader(&quot;dav&quot;);</span>
<a href="#l4.381"></a><span id="l4.381">     return parseInt(dav.substr(0, dav.indexOf(&quot;,&quot;)), 10);</span>
<a href="#l4.382"></a><span id="l4.382">   }</span>
<a href="#l4.383"></a><span id="l4.383"> }</span>
<a href="#l4.384"></a><span id="l4.384"> </span>
<a href="#l4.385"></a><span id="l4.385"> /**</span>
<a href="#l4.386"></a><span id="l4.386">  * Request class for principal-property-search queries</span>
<a href="#l4.387"></a><span id="l4.387">  */</span>
<a href="#l4.388"></a><span id="l4.388" class="difflineminus">-class PrincipalPropertySearchRequest extends CalDavRequest {</span>
<a href="#l4.389"></a><span id="l4.389" class="difflineplus">+class CalDavPrincipalPropertySearchRequest extends CalDavRequestBase {</span>
<a href="#l4.390"></a><span id="l4.390">   /**</span>
<a href="#l4.391"></a><span id="l4.391">    * Constructs a principal-property-search query.</span>
<a href="#l4.392"></a><span id="l4.392">    *</span>
<a href="#l4.393"></a><span id="l4.393">    * @param {CalDavSession} aSession                  The session to use for this request</span>
<a href="#l4.394"></a><span id="l4.394">    * @param {calICalendar} aCalendar                  The calendar this request belongs to</span>
<a href="#l4.395"></a><span id="l4.395">    * @param {nsIURI} aUri                             The uri to request</span>
<a href="#l4.396"></a><span id="l4.396">    * @param {String} aMatch                           The href to search in</span>
<a href="#l4.397"></a><span id="l4.397">    * @param {String} aSearchProp                      The property to search for</span>
<a href="#l4.398"></a><span id="l4.398">    * @param {String[]} aProps                         The properties to retieve</span>
<a href="#l4.399"></a><span id="l4.399">    * @param {Number} aDepth                           The depth of the query, defaults to 1</span>
<a href="#l4.400"></a><span id="l4.400">    */</span>
<a href="#l4.401"></a><span id="l4.401">   constructor(aSession, aCalendar, aUri, aMatch, aSearchProp, aProps, aDepth = 1) {</span>
<a href="#l4.402"></a><span id="l4.402">     let xml =</span>
<a href="#l4.403"></a><span id="l4.403">       XML_HEADER +</span>
<a href="#l4.404"></a><span id="l4.404" class="difflineminus">-      `&lt;D:principal-property-search ${tagsToXmlns(&quot;D&quot;, aSearchProp, ...aProps)}&gt;` +</span>
<a href="#l4.405"></a><span id="l4.405" class="difflineplus">+      `&lt;D:principal-property-search ${CalDavTagsToXmlns(&quot;D&quot;, aSearchProp, ...aProps)}&gt;` +</span>
<a href="#l4.406"></a><span id="l4.406">       &quot;&lt;D:property-search&gt;&quot; +</span>
<a href="#l4.407"></a><span id="l4.407">       &quot;&lt;D:prop&gt;&quot; +</span>
<a href="#l4.408"></a><span id="l4.408">       `&lt;${aSearchProp}/&gt;` +</span>
<a href="#l4.409"></a><span id="l4.409">       &quot;&lt;/D:prop&gt;&quot; +</span>
<a href="#l4.410"></a><span id="l4.410">       `&lt;D:match&gt;${cal.xml.escapeString(aMatch)}&lt;/D:match&gt;` +</span>
<a href="#l4.411"></a><span id="l4.411">       &quot;&lt;/D:property-search&gt;&quot; +</span>
<a href="#l4.412"></a><span id="l4.412">       &quot;&lt;D:prop&gt;&quot; +</span>
<a href="#l4.413"></a><span id="l4.413">       aProps.map(prop =&gt; `&lt;${prop}/&gt;`).join(&quot;&quot;) +</span>
<a href="#l4.414"></a><span id="l4.414" class="difflineat">@@ -872,17 +880,17 @@ class PrincipalPropertySearchRequest ext</span>
<a href="#l4.415"></a><span id="l4.415">   get responseClass() {</span>
<a href="#l4.416"></a><span id="l4.416">     return PropfindResponse;</span>
<a href="#l4.417"></a><span id="l4.417">   }</span>
<a href="#l4.418"></a><span id="l4.418"> }</span>
<a href="#l4.419"></a><span id="l4.419"> </span>
<a href="#l4.420"></a><span id="l4.420"> /**</span>
<a href="#l4.421"></a><span id="l4.421">  * Request class for calendar outbox queries, to send or respond to invitations</span>
<a href="#l4.422"></a><span id="l4.422">  */</span>
<a href="#l4.423"></a><span id="l4.423" class="difflineminus">-class OutboxRequest extends CalDavRequest {</span>
<a href="#l4.424"></a><span id="l4.424" class="difflineplus">+class CalDavOutboxRequest extends CalDavRequestBase {</span>
<a href="#l4.425"></a><span id="l4.425">   /**</span>
<a href="#l4.426"></a><span id="l4.426">    * Constructs an outbox request</span>
<a href="#l4.427"></a><span id="l4.427">    *</span>
<a href="#l4.428"></a><span id="l4.428">    * @param {CalDavSession} aSession                  The session to use for this request</span>
<a href="#l4.429"></a><span id="l4.429">    * @param {calICalendar} aCalendar                  The calendar this request belongs to</span>
<a href="#l4.430"></a><span id="l4.430">    * @param {nsIURI} aUri                             The uri to request</span>
<a href="#l4.431"></a><span id="l4.431">    * @param {String} aOrganizer                       The organizer of the request</span>
<a href="#l4.432"></a><span id="l4.432">    * @param {String} aRecipients                      The recipients of the request</span>
<a href="#l4.433"></a><span id="l4.433" class="difflineat">@@ -948,17 +956,17 @@ class OutboxResponse extends CalDavSimpl</span>
<a href="#l4.434"></a><span id="l4.434">   get ok() {</span>
<a href="#l4.435"></a><span id="l4.435">     return this.status == 200 &amp;&amp; this.xml;</span>
<a href="#l4.436"></a><span id="l4.436">   }</span>
<a href="#l4.437"></a><span id="l4.437"> }</span>
<a href="#l4.438"></a><span id="l4.438"> </span>
<a href="#l4.439"></a><span id="l4.439"> /**</span>
<a href="#l4.440"></a><span id="l4.440">  * Request class for freebusy queries</span>
<a href="#l4.441"></a><span id="l4.441">  */</span>
<a href="#l4.442"></a><span id="l4.442" class="difflineminus">-class FreeBusyRequest extends CalDavRequest {</span>
<a href="#l4.443"></a><span id="l4.443" class="difflineplus">+class CalDavFreeBusyRequest extends CalDavRequestBase {</span>
<a href="#l4.444"></a><span id="l4.444">   /**</span>
<a href="#l4.445"></a><span id="l4.445">    * Creates a freebusy request, for the specified range</span>
<a href="#l4.446"></a><span id="l4.446">    *</span>
<a href="#l4.447"></a><span id="l4.447">    * @param {CalDavSession} aSession                  The session to use for this request</span>
<a href="#l4.448"></a><span id="l4.448">    * @param {calICalendar} aCalendar                  The calendar this request belongs to</span>
<a href="#l4.449"></a><span id="l4.449">    * @param {nsIURI} aUri                             The uri to request</span>
<a href="#l4.450"></a><span id="l4.450">    * @param {String} aOrganizer                       The organizer of the request</span>
<a href="#l4.451"></a><span id="l4.451">    * @param {String} aRecipient                       The attendee to look up</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1">rename from calendar/providers/caldav/modules/calDavSession.jsm</span>
<a href="#l5.2"></a><span id="l5.2">rename to calendar/providers/caldav/modules/CalDavSession.jsm</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineminus">--- a/calendar/providers/caldav/modules/calDavSession.jsm</span>
<a href="#l5.4"></a><span id="l5.4" class="difflineplus">+++ b/calendar/providers/caldav/modules/CalDavSession.jsm</span>
<a href="#l5.5"></a><span id="l5.5" class="difflineat">@@ -1,17 +1,17 @@</span>
<a href="#l5.6"></a><span id="l5.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l5.7"></a><span id="l5.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l5.8"></a><span id="l5.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l5.9"></a><span id="l5.9"> </span>
<a href="#l5.10"></a><span id="l5.10" class="difflineminus">-ChromeUtils.import(&quot;resource://gre/modules/Timer.jsm&quot;);</span>
<a href="#l5.11"></a><span id="l5.11" class="difflineplus">+var { setTimeout } = ChromeUtils.import(&quot;resource://gre/modules/Timer.jsm&quot;);</span>
<a href="#l5.12"></a><span id="l5.12"> </span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/OAuth2.jsm&quot;);</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+var { OAuth2 } = ChromeUtils.import(&quot;resource:///modules/OAuth2.jsm&quot;);</span>
<a href="#l5.15"></a><span id="l5.15"> </span>
<a href="#l5.16"></a><span id="l5.16" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/calendar/calUtils.jsm&quot;);</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+var { cal } = ChromeUtils.import(&quot;resource:///modules/calendar/calUtils.jsm&quot;);</span>
<a href="#l5.18"></a><span id="l5.18"> </span>
<a href="#l5.19"></a><span id="l5.19"> /**</span>
<a href="#l5.20"></a><span id="l5.20">  * Session and authentication tools for the caldav provider</span>
<a href="#l5.21"></a><span id="l5.21">  */</span>
<a href="#l5.22"></a><span id="l5.22"> </span>
<a href="#l5.23"></a><span id="l5.23"> this.EXPORTED_SYMBOLS = [&quot;CalDavSession&quot;]; /* exported CalDavSession */</span>
<a href="#l5.24"></a><span id="l5.24"> </span>
<a href="#l5.25"></a><span id="l5.25"> const OAUTH_GRACE_TIME = 30 * 1000;</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineat">@@ -22,16 +22,17 @@ const OAUTH_GRACE_TIME = 30 * 1000;</span>
<a href="#l5.27"></a><span id="l5.27"> class CalDavGoogleOAuth extends OAuth2 {</span>
<a href="#l5.28"></a><span id="l5.28">   /**</span>
<a href="#l5.29"></a><span id="l5.29">    * Constructs a new Google OAuth autentication provider</span>
<a href="#l5.30"></a><span id="l5.30">    *</span>
<a href="#l5.31"></a><span id="l5.31">    * @param {String} sessionId    The session id, used in the password manager</span>
<a href="#l5.32"></a><span id="l5.32">    * @param {String} name         The user-readable description of this session</span>
<a href="#l5.33"></a><span id="l5.33">    */</span>
<a href="#l5.34"></a><span id="l5.34">   constructor(sessionId, name) {</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineplus">+    // eslint-disable-next-line no-undef</span>
<a href="#l5.36"></a><span id="l5.36">     super(OAUTH_BASE_URI, OAUTH_SCOPE, OAUTH_CLIENT_ID, OAUTH_HASH);</span>
<a href="#l5.37"></a><span id="l5.37"> </span>
<a href="#l5.38"></a><span id="l5.38">     this.id = sessionId;</span>
<a href="#l5.39"></a><span id="l5.39">     this.pwMgrId = &quot;Google CalDAV v2&quot;;</span>
<a href="#l5.40"></a><span id="l5.40">     this.requestWindowTitle = cal.l10n.getAnyString(</span>
<a href="#l5.41"></a><span id="l5.41">       &quot;global&quot;,</span>
<a href="#l5.42"></a><span id="l5.42">       &quot;commonDialogs&quot;,</span>
<a href="#l5.43"></a><span id="l5.43">       &quot;EnterUserPasswordFor2&quot;,</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineat">@@ -194,19 +195,19 @@ class CalDavGoogleOAuth extends OAuth2 {</span>
<a href="#l5.45"></a><span id="l5.45">         throw e;</span>
<a href="#l5.46"></a><span id="l5.46">       }</span>
<a href="#l5.47"></a><span id="l5.47">     }</span>
<a href="#l5.48"></a><span id="l5.48">   }</span>
<a href="#l5.49"></a><span id="l5.49"> </span>
<a href="#l5.50"></a><span id="l5.50">   /**</span>
<a href="#l5.51"></a><span id="l5.51">    * Check for OAuth auth errors and restart the request without a token if necessary</span>
<a href="#l5.52"></a><span id="l5.52">    *</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineminus">-   * @param {CalDavResponse} aResponse    The response to inspect for completion</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineminus">-   * @return {Promise}                    A promise resolved when complete, with</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineminus">-   *                                        CalDavSession.RESTART_REQUEST or null</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineplus">+   * @param {CalDavResponseBase} aResponse    The response to inspect for completion</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineplus">+   * @return {Promise}                        A promise resolved when complete, with</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineplus">+   *                                            CalDavSession.RESTART_REQUEST or null</span>
<a href="#l5.59"></a><span id="l5.59">    */</span>
<a href="#l5.60"></a><span id="l5.60">   async completeRequest(aResponse) {</span>
<a href="#l5.61"></a><span id="l5.61">     // Check for OAuth errors</span>
<a href="#l5.62"></a><span id="l5.62">     let wwwauth = aResponse.getHeader(&quot;WWW-Authenticate&quot;);</span>
<a href="#l5.63"></a><span id="l5.63">     if (this.oauth &amp;&amp; wwwauth &amp;&amp; wwwauth.startsWith(&quot;Bearer&quot;) &amp;&amp; wwwauth.includes(&quot;error=&quot;)) {</span>
<a href="#l5.64"></a><span id="l5.64">       this.oauth.accessToken = null;</span>
<a href="#l5.65"></a><span id="l5.65"> </span>
<a href="#l5.66"></a><span id="l5.66">       return CalDavSession.RESTART_REQUEST;</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineat">@@ -307,19 +308,19 @@ class CalDavSession {</span>
<a href="#l5.68"></a><span id="l5.68">   async prepareRedirect(aOldChannel, aNewChannel) {</span>
<a href="#l5.69"></a><span id="l5.69">     return this._callAdapter(aNewChannel.URI.host, &quot;prepareRedirect&quot;, aOldChannel, aNewChannel);</span>
<a href="#l5.70"></a><span id="l5.70">   }</span>
<a href="#l5.71"></a><span id="l5.71"> </span>
<a href="#l5.72"></a><span id="l5.72">   /**</span>
<a href="#l5.73"></a><span id="l5.73">    * Complete the request based on the results from the response. Allows restarting the session if</span>
<a href="#l5.74"></a><span id="l5.74">    * |CalDavSession.RESTART_REQUEST| is returned.</span>
<a href="#l5.75"></a><span id="l5.75">    *</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineminus">-   * @param {CalDavResponse} aResponse    The response to inspect for completion</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineminus">-   * @return {Promise}                    A promise resolved when complete, with</span>
<a href="#l5.78"></a><span id="l5.78" class="difflineminus">-   *                                        CalDavSession.RESTART_REQUEST or null</span>
<a href="#l5.79"></a><span id="l5.79" class="difflineplus">+   * @param {CalDavResponseBase} aResponse    The response to inspect for completion</span>
<a href="#l5.80"></a><span id="l5.80" class="difflineplus">+   * @return {Promise}                        A promise resolved when complete, with</span>
<a href="#l5.81"></a><span id="l5.81" class="difflineplus">+   *                                            CalDavSession.RESTART_REQUEST or null</span>
<a href="#l5.82"></a><span id="l5.82">    */</span>
<a href="#l5.83"></a><span id="l5.83">   async completeRequest(aResponse) {</span>
<a href="#l5.84"></a><span id="l5.84">     return this._callAdapter(aResponse.request.uri.host, &quot;completeRequest&quot;, aResponse);</span>
<a href="#l5.85"></a><span id="l5.85">   }</span>
<a href="#l5.86"></a><span id="l5.86"> }</span>
<a href="#l5.87"></a><span id="l5.87"> </span>
<a href="#l5.88"></a><span id="l5.88"> // Before you spend time trying to find out what this means, please note that</span>
<a href="#l5.89"></a><span id="l5.89"> // doing so and using the information WILL cause Google to revoke Lightning's</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1">rename from calendar/providers/caldav/modules/calDavUtils.jsm</span>
<a href="#l6.2"></a><span id="l6.2">rename to calendar/providers/caldav/modules/CalDavUtils.jsm</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineminus">--- a/calendar/providers/caldav/modules/calDavUtils.jsm</span>
<a href="#l6.4"></a><span id="l6.4" class="difflineplus">+++ b/calendar/providers/caldav/modules/CalDavUtils.jsm</span>
<a href="#l6.5"></a><span id="l6.5" class="difflineat">@@ -1,80 +1,82 @@</span>
<a href="#l6.6"></a><span id="l6.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l6.7"></a><span id="l6.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l6.8"></a><span id="l6.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l6.9"></a><span id="l6.9"> </span>
<a href="#l6.10"></a><span id="l6.10" class="difflineplus">+var { cal } = ChromeUtils.import(&quot;resource:///modules/calendar/calUtils.jsm&quot;);</span>
<a href="#l6.11"></a><span id="l6.11" class="difflineplus">+</span>
<a href="#l6.12"></a><span id="l6.12"> /**</span>
<a href="#l6.13"></a><span id="l6.13">  * Various utility functions for the caldav provider</span>
<a href="#l6.14"></a><span id="l6.14">  */</span>
<a href="#l6.15"></a><span id="l6.15"> </span>
<a href="#l6.16"></a><span id="l6.16" class="difflineminus">-/* exported xmlns, tagsToXmlns, caldavNSUnresolver, caldavNSResolver, caldavXPath,</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineminus">- *          caldavXPathFirst */</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+/* exported CalDavXmlns, CalDavTagsToXmlns, CalDavNsUnresolver, CalDavNsResolver, CalDavXPath,</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineplus">+ *          CalDavXPathFirst */</span>
<a href="#l6.20"></a><span id="l6.20"> this.EXPORTED_SYMBOLS = [</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineminus">-  &quot;xmlns&quot;,</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineminus">-  &quot;tagsToXmlns&quot;,</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineminus">-  &quot;caldavNSUnresolver&quot;,</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineminus">-  &quot;caldavNSResolver&quot;,</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineminus">-  &quot;caldavXPath&quot;,</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineminus">-  &quot;caldavXPathFirst&quot;,</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineplus">+  &quot;CalDavXmlns&quot;,</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineplus">+  &quot;CalDavTagsToXmlns&quot;,</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineplus">+  &quot;CalDavNsUnresolver&quot;,</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineplus">+  &quot;CalDavNsResolver&quot;,</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineplus">+  &quot;CalDavXPath&quot;,</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+  &quot;CalDavXPathFirst&quot;,</span>
<a href="#l6.33"></a><span id="l6.33"> ];</span>
<a href="#l6.34"></a><span id="l6.34"> </span>
<a href="#l6.35"></a><span id="l6.35"> /**</span>
<a href="#l6.36"></a><span id="l6.36">  * Creates an xmlns string with the requested namespace prefixes</span>
<a href="#l6.37"></a><span id="l6.37">  *</span>
<a href="#l6.38"></a><span id="l6.38">  * @param {...String} aRequested        The requested namespace prefixes</span>
<a href="#l6.39"></a><span id="l6.39">  * @return {String}                     An xmlns string that can be inserted into xml documents</span>
<a href="#l6.40"></a><span id="l6.40">  */</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineminus">-function xmlns(...aRequested) {</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineplus">+function CalDavXmlns(...aRequested) {</span>
<a href="#l6.43"></a><span id="l6.43">   let namespaces = [];</span>
<a href="#l6.44"></a><span id="l6.44">   for (let namespace of aRequested) {</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineminus">-    let nsUri = caldavNSResolver(namespace);</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineplus">+    let nsUri = CalDavNsResolver(namespace);</span>
<a href="#l6.47"></a><span id="l6.47">     if (namespace) {</span>
<a href="#l6.48"></a><span id="l6.48">       namespaces.push(`xmlns:${namespace}='${nsUri}'`);</span>
<a href="#l6.49"></a><span id="l6.49">     }</span>
<a href="#l6.50"></a><span id="l6.50">   }</span>
<a href="#l6.51"></a><span id="l6.51"> </span>
<a href="#l6.52"></a><span id="l6.52">   return namespaces.join(&quot; &quot;);</span>
<a href="#l6.53"></a><span id="l6.53"> }</span>
<a href="#l6.54"></a><span id="l6.54"> </span>
<a href="#l6.55"></a><span id="l6.55"> /**</span>
<a href="#l6.56"></a><span id="l6.56">  * Helper function to gather namespaces from QNames or namespace prefixes, plus a few extra for the</span>
<a href="#l6.57"></a><span id="l6.57">  * remaining request.</span>
<a href="#l6.58"></a><span id="l6.58">  *</span>
<a href="#l6.59"></a><span id="l6.59">  * @param {...String} aTags     Either QNames, or just namespace prefixes to be resolved.</span>
<a href="#l6.60"></a><span id="l6.60">  * @return {String}             The complete namespace string</span>
<a href="#l6.61"></a><span id="l6.61">  */</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineminus">-function tagsToXmlns(...aTags) {</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineplus">+function CalDavTagsToXmlns(...aTags) {</span>
<a href="#l6.64"></a><span id="l6.64">   let namespaces = new Set(aTags.map(tag =&gt; tag.split(&quot;:&quot;)[0]));</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineminus">-  return xmlns(...namespaces.values());</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineplus">+  return CalDavXmlns(...namespaces.values());</span>
<a href="#l6.67"></a><span id="l6.67"> }</span>
<a href="#l6.68"></a><span id="l6.68"> </span>
<a href="#l6.69"></a><span id="l6.69"> /**</span>
<a href="#l6.70"></a><span id="l6.70">  * Resolve the namespace URI to one of the prefixes used in our codebase</span>
<a href="#l6.71"></a><span id="l6.71">  *</span>
<a href="#l6.72"></a><span id="l6.72">  * @param {String} aNamespace       The namespace URI to resolve</span>
<a href="#l6.73"></a><span id="l6.73">  * @return {?String}                The namespace prefix we use</span>
<a href="#l6.74"></a><span id="l6.74">  */</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineminus">-function caldavNSUnresolver(aNamespace) {</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineplus">+function CalDavNsUnresolver(aNamespace) {</span>
<a href="#l6.77"></a><span id="l6.77">   const prefixes = {</span>
<a href="#l6.78"></a><span id="l6.78">     &quot;http://apple.com/ns/ical/&quot;: &quot;A&quot;,</span>
<a href="#l6.79"></a><span id="l6.79">     &quot;DAV:&quot;: &quot;D&quot;,</span>
<a href="#l6.80"></a><span id="l6.80">     &quot;urn:ietf:params:xml:ns:caldav&quot;: &quot;C&quot;,</span>
<a href="#l6.81"></a><span id="l6.81">     &quot;http://calendarserver.org/ns/&quot;: &quot;CS&quot;,</span>
<a href="#l6.82"></a><span id="l6.82">   };</span>
<a href="#l6.83"></a><span id="l6.83">   return prefixes[aNamespace] || null;</span>
<a href="#l6.84"></a><span id="l6.84"> }</span>
<a href="#l6.85"></a><span id="l6.85"> </span>
<a href="#l6.86"></a><span id="l6.86"> /**</span>
<a href="#l6.87"></a><span id="l6.87">  * Resolve the namespace URI from one of the prefixes used in our codebase</span>
<a href="#l6.88"></a><span id="l6.88">  *</span>
<a href="#l6.89"></a><span id="l6.89">  * @param {String} aPrefix          The namespace prefix we use</span>
<a href="#l6.90"></a><span id="l6.90">  * @return {?String}                The namespace URI for the prefix</span>
<a href="#l6.91"></a><span id="l6.91">  */</span>
<a href="#l6.92"></a><span id="l6.92" class="difflineminus">-function caldavNSResolver(aPrefix) {</span>
<a href="#l6.93"></a><span id="l6.93" class="difflineplus">+function CalDavNsResolver(aPrefix) {</span>
<a href="#l6.94"></a><span id="l6.94">   /* eslint-disable id-length */</span>
<a href="#l6.95"></a><span id="l6.95">   const namespaces = {</span>
<a href="#l6.96"></a><span id="l6.96">     A: &quot;http://apple.com/ns/ical/&quot;,</span>
<a href="#l6.97"></a><span id="l6.97">     D: &quot;DAV:&quot;,</span>
<a href="#l6.98"></a><span id="l6.98">     C: &quot;urn:ietf:params:xml:ns:caldav&quot;,</span>
<a href="#l6.99"></a><span id="l6.99">     CS: &quot;http://calendarserver.org/ns/&quot;,</span>
<a href="#l6.100"></a><span id="l6.100">   };</span>
<a href="#l6.101"></a><span id="l6.101">   /* eslint-enable id-length */</span>
<a href="#l6.102"></a><span id="l6.102" class="difflineat">@@ -85,24 +87,24 @@ function caldavNSResolver(aPrefix) {</span>
<a href="#l6.103"></a><span id="l6.103"> /**</span>
<a href="#l6.104"></a><span id="l6.104">  * Run an xpath expression on the given node, using the caldav namespace resolver</span>
<a href="#l6.105"></a><span id="l6.105">  *</span>
<a href="#l6.106"></a><span id="l6.106">  * @param {Element} aNode           The context node to search from</span>
<a href="#l6.107"></a><span id="l6.107">  * @param {String} aExpr            The XPath expression to search for</span>
<a href="#l6.108"></a><span id="l6.108">  * @param {?XPathResult} aType      (optional) Force a result type, must be an XPathResult constant</span>
<a href="#l6.109"></a><span id="l6.109">  * @return {Element[]}              Array of found elements</span>
<a href="#l6.110"></a><span id="l6.110">  */</span>
<a href="#l6.111"></a><span id="l6.111" class="difflineminus">-function caldavXPath(aNode, aExpr, aType) {</span>
<a href="#l6.112"></a><span id="l6.112" class="difflineminus">-  return cal.xml.evalXPath(aNode, aExpr, caldavNSResolver, aType);</span>
<a href="#l6.113"></a><span id="l6.113" class="difflineplus">+function CalDavXPath(aNode, aExpr, aType) {</span>
<a href="#l6.114"></a><span id="l6.114" class="difflineplus">+  return cal.xml.evalXPath(aNode, aExpr, CalDavNsResolver, aType);</span>
<a href="#l6.115"></a><span id="l6.115"> }</span>
<a href="#l6.116"></a><span id="l6.116"> </span>
<a href="#l6.117"></a><span id="l6.117"> /**</span>
<a href="#l6.118"></a><span id="l6.118">  * Run an xpath expression on the given node, using the caldav namespace resolver. Returns the first</span>
<a href="#l6.119"></a><span id="l6.119">  * result.</span>
<a href="#l6.120"></a><span id="l6.120">  *</span>
<a href="#l6.121"></a><span id="l6.121">  * @param {Element} aNode           The context node to search from</span>
<a href="#l6.122"></a><span id="l6.122">  * @param {String} aExpr            The XPath expression to search for</span>
<a href="#l6.123"></a><span id="l6.123">  * @param {?XPathResult} aType      (optional) Force a result type, must be an XPathResult constant</span>
<a href="#l6.124"></a><span id="l6.124">  * @return {?Element}               The found element, or null.</span>
<a href="#l6.125"></a><span id="l6.125">  */</span>
<a href="#l6.126"></a><span id="l6.126" class="difflineminus">-function caldavXPathFirst(aNode, aExpr, aType) {</span>
<a href="#l6.127"></a><span id="l6.127" class="difflineminus">-  return cal.xml.evalXPathFirst(aNode, aExpr, caldavNSResolver, aType);</span>
<a href="#l6.128"></a><span id="l6.128" class="difflineplus">+function CalDavXPathFirst(aNode, aExpr, aType) {</span>
<a href="#l6.129"></a><span id="l6.129" class="difflineplus">+  return cal.xml.evalXPathFirst(aNode, aExpr, CalDavNsResolver, aType);</span>
<a href="#l6.130"></a><span id="l6.130"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/calendar/providers/caldav/moz.build</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/calendar/providers/caldav/moz.build</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -9,19 +9,19 @@ EXTRA_JS_MODULES += [</span>
<a href="#l7.4"></a><span id="l7.4">     'CalDavCalendar.jsm',</span>
<a href="#l7.5"></a><span id="l7.5"> ]</span>
<a href="#l7.6"></a><span id="l7.6"> </span>
<a href="#l7.7"></a><span id="l7.7"> XPCOM_MANIFESTS += [</span>
<a href="#l7.8"></a><span id="l7.8">     'components.conf',</span>
<a href="#l7.9"></a><span id="l7.9"> ]</span>
<a href="#l7.10"></a><span id="l7.10"> </span>
<a href="#l7.11"></a><span id="l7.11"> EXTRA_JS_MODULES.caldav += [</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-    'modules/calDavRequest.jsm',</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-    'modules/calDavSession.jsm',</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineminus">-    'modules/calDavUtils.jsm',</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+    'modules/CalDavRequest.jsm',</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+    'modules/CalDavSession.jsm',</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+    'modules/CalDavUtils.jsm',</span>
<a href="#l7.18"></a><span id="l7.18"> ]</span>
<a href="#l7.19"></a><span id="l7.19"> </span>
<a href="#l7.20"></a><span id="l7.20"> # These files go in components so they can be packaged correctly.</span>
<a href="#l7.21"></a><span id="l7.21"> FINAL_TARGET_FILES.components += [</span>
<a href="#l7.22"></a><span id="l7.22">     'calDavRequestHandlers.js',</span>
<a href="#l7.23"></a><span id="l7.23"> ]</span>
<a href="#l7.24"></a><span id="l7.24"> </span>
<a href="#l7.25"></a><span id="l7.25"> with Files('**'):</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/calendar/test/unit/test_caldav_requests.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/calendar/test/unit/test_caldav_requests.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -1,44 +1,56 @@</span>
<a href="#l8.4"></a><span id="l8.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l8.5"></a><span id="l8.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l8.6"></a><span id="l8.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l8.7"></a><span id="l8.7"> </span>
<a href="#l8.8"></a><span id="l8.8" class="difflineminus">-ChromeUtils.import(&quot;resource://gre/modules/NetUtil.jsm&quot;);</span>
<a href="#l8.9"></a><span id="l8.9" class="difflineplus">+var { NetUtil } = ChromeUtils.import(&quot;resource://gre/modules/NetUtil.jsm&quot;);</span>
<a href="#l8.10"></a><span id="l8.10"> </span>
<a href="#l8.11"></a><span id="l8.11" class="difflineminus">-ChromeUtils.import(&quot;resource://testing-common/httpd.js&quot;);</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-ChromeUtils.import(&quot;resource://testing-common/MockRegistrar.jsm&quot;);</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+var { HttpServer } = ChromeUtils.import(&quot;resource://testing-common/httpd.js&quot;);</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+var { MockRegistrar } = ChromeUtils.import(&quot;resource://testing-common/MockRegistrar.jsm&quot;);</span>
<a href="#l8.15"></a><span id="l8.15"> </span>
<a href="#l8.16"></a><span id="l8.16" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/caldav/calDavSession.jsm&quot;);</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/caldav/calDavRequest.jsm&quot;);</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/caldav/calDavUtils.jsm&quot;);</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+var {</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineplus">+  CalDavGenericRequest,</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineplus">+  CalDavItemRequest,</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineplus">+  CalDavDeleteItemRequest,</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineplus">+  CalDavPropfindRequest,</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+  CalDavHeaderRequest,</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineplus">+  CalDavPrincipalPropertySearchRequest,</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineplus">+  CalDavOutboxRequest,</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineplus">+  CalDavFreeBusyRequest,</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineplus">+} = ChromeUtils.import(&quot;resource:///modules/caldav/CalDavRequest.jsm&quot;);</span>
<a href="#l8.29"></a><span id="l8.29"> </span>
<a href="#l8.30"></a><span id="l8.30" class="difflineminus">-Components.utils.importGlobalProperties([&quot;URL&quot;]);</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineplus">+var { CalDavSession } = ChromeUtils.import(&quot;resource:///modules/caldav/CalDavSession.jsm&quot;);</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+var { CalDavXmlns } = ChromeUtils.import(&quot;resource:///modules/caldav/CalDavUtils.jsm&quot;);</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineplus">+var { Preferences } = ChromeUtils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l8.34"></a><span id="l8.34"> </span>
<a href="#l8.35"></a><span id="l8.35"> class LowerMap extends Map {</span>
<a href="#l8.36"></a><span id="l8.36">   get(key) {</span>
<a href="#l8.37"></a><span id="l8.37">     return super.get(key.toLowerCase());</span>
<a href="#l8.38"></a><span id="l8.38">   }</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineplus">+  set(key, value) {</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineplus">+    return super.set(key.toLowerCase(), value);</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineplus">+  }</span>
<a href="#l8.42"></a><span id="l8.42"> }</span>
<a href="#l8.43"></a><span id="l8.43"> </span>
<a href="#l8.44"></a><span id="l8.44"> var gServer;</span>
<a href="#l8.45"></a><span id="l8.45"> </span>
<a href="#l8.46"></a><span id="l8.46"> var MockConflictPrompt = {</span>
<a href="#l8.47"></a><span id="l8.47">   _origFunc: null,</span>
<a href="#l8.48"></a><span id="l8.48">   overwrite: false,</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineminus">-  register: function() {</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineplus">+  register() {</span>
<a href="#l8.51"></a><span id="l8.51">     if (!this._origFunc) {</span>
<a href="#l8.52"></a><span id="l8.52">       this._origFunc = cal.provider.promptOverwrite;</span>
<a href="#l8.53"></a><span id="l8.53">       cal.provider.promptOverwrite = (aMode, aItem) =&gt; {</span>
<a href="#l8.54"></a><span id="l8.54">         return this.overwrite;</span>
<a href="#l8.55"></a><span id="l8.55">       };</span>
<a href="#l8.56"></a><span id="l8.56">     }</span>
<a href="#l8.57"></a><span id="l8.57">   },</span>
<a href="#l8.58"></a><span id="l8.58"> </span>
<a href="#l8.59"></a><span id="l8.59" class="difflineminus">-  unregister: function() {</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineplus">+  unregister() {</span>
<a href="#l8.61"></a><span id="l8.61">     if (this._origFunc) {</span>
<a href="#l8.62"></a><span id="l8.62">       cal.provider.promptOverwrite = this._origFunc;</span>
<a href="#l8.63"></a><span id="l8.63">       this._origFunc = null;</span>
<a href="#l8.64"></a><span id="l8.64">     }</span>
<a href="#l8.65"></a><span id="l8.65">   },</span>
<a href="#l8.66"></a><span id="l8.66"> };</span>
<a href="#l8.67"></a><span id="l8.67"> </span>
<a href="#l8.68"></a><span id="l8.68"> class MockAlertsService {</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineat">@@ -99,17 +111,24 @@ class CalDavServer {</span>
<a href="#l8.70"></a><span id="l8.70">     try {</span>
<a href="#l8.71"></a><span id="l8.71">       let method = request.method;</span>
<a href="#l8.72"></a><span id="l8.72">       let parameters = new Map(request.queryString.split(&quot;&amp;&quot;).map(part =&gt; part.split(&quot;=&quot;, 2)));</span>
<a href="#l8.73"></a><span id="l8.73">       let available = request.bodyInputStream.available();</span>
<a href="#l8.74"></a><span id="l8.74">       let body =</span>
<a href="#l8.75"></a><span id="l8.75">         available &gt; 0 ? NetUtil.readInputStreamToString(request.bodyInputStream, available) : null;</span>
<a href="#l8.76"></a><span id="l8.76"> </span>
<a href="#l8.77"></a><span id="l8.77">       let headers = new LowerMap();</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineminus">-      for (let hdr of XPCOMUtils.IterSimpleEnumerator(request.headers, Ci.nsISupportsString)) {</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineplus">+</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineplus">+      let headerIterator = function*(enumerator) {</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineplus">+        while (enumerator.hasMoreElements()) {</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineplus">+          yield enumerator.getNext().QueryInterface(Ci.nsISupportsString);</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineplus">+        }</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineplus">+      };</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineplus">+</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineplus">+      for (let hdr of headerIterator(request.headers)) {</span>
<a href="#l8.87"></a><span id="l8.87">         headers.set(hdr.data, request.getHeader(hdr.data));</span>
<a href="#l8.88"></a><span id="l8.88">       }</span>
<a href="#l8.89"></a><span id="l8.89"> </span>
<a href="#l8.90"></a><span id="l8.90">       return nextHandler(request, response, method, headers, parameters, body);</span>
<a href="#l8.91"></a><span id="l8.91">     } catch (e) {</span>
<a href="#l8.92"></a><span id="l8.92">       info(&quot;Server Error: &quot; + e.fileName + &quot;:&quot; + e.lineNumber + &quot;: &quot; + e + &quot;\n&quot;);</span>
<a href="#l8.93"></a><span id="l8.93">       return null;</span>
<a href="#l8.94"></a><span id="l8.94">     }</span>
<a href="#l8.95"></a><span id="l8.95" class="difflineat">@@ -117,18 +136,18 @@ class CalDavServer {</span>
<a href="#l8.96"></a><span id="l8.96"> </span>
<a href="#l8.97"></a><span id="l8.97">   resetClient(client) {</span>
<a href="#l8.98"></a><span id="l8.98">     MockConflictPrompt.unregister();</span>
<a href="#l8.99"></a><span id="l8.99">     cal.getCalendarManager().unregisterCalendar(client);</span>
<a href="#l8.100"></a><span id="l8.100">   }</span>
<a href="#l8.101"></a><span id="l8.101"> </span>
<a href="#l8.102"></a><span id="l8.102">   waitForLoad(aCalendar) {</span>
<a href="#l8.103"></a><span id="l8.103">     return new Promise((resolve, reject) =&gt; {</span>
<a href="#l8.104"></a><span id="l8.104" class="difflineminus">-      let observer = cal.createAdapter(Components.interfaces.calIObserver, {</span>
<a href="#l8.105"></a><span id="l8.105" class="difflineminus">-        onLoad: function() {</span>
<a href="#l8.106"></a><span id="l8.106" class="difflineplus">+      let observer = cal.createAdapter(Ci.calIObserver, {</span>
<a href="#l8.107"></a><span id="l8.107" class="difflineplus">+        onLoad() {</span>
<a href="#l8.108"></a><span id="l8.108">           let uncached = aCalendar.wrappedJSObject.mUncachedCalendar.wrappedJSObject;</span>
<a href="#l8.109"></a><span id="l8.109">           aCalendar.removeObserver(observer);</span>
<a href="#l8.110"></a><span id="l8.110"> </span>
<a href="#l8.111"></a><span id="l8.111">           if (Components.isSuccessCode(uncached._lastStatus)) {</span>
<a href="#l8.112"></a><span id="l8.112">             resolve(aCalendar);</span>
<a href="#l8.113"></a><span id="l8.113">           } else {</span>
<a href="#l8.114"></a><span id="l8.114">             reject(uncached._lastMessage);</span>
<a href="#l8.115"></a><span id="l8.115">           }</span>
<a href="#l8.116"></a><span id="l8.116" class="difflineat">@@ -144,17 +163,17 @@ class CalDavServer {</span>
<a href="#l8.117"></a><span id="l8.117">     let client = calmgr.createCalendar(&quot;caldav&quot;, uri);</span>
<a href="#l8.118"></a><span id="l8.118">     let uclient = client.wrappedJSObject;</span>
<a href="#l8.119"></a><span id="l8.119">     client.name = &quot;xpcshell&quot;;</span>
<a href="#l8.120"></a><span id="l8.120">     client.setProperty(&quot;cache.enabled&quot;, true);</span>
<a href="#l8.121"></a><span id="l8.121"> </span>
<a href="#l8.122"></a><span id="l8.122">     // Make sure we catch the last error message in case sync fails</span>
<a href="#l8.123"></a><span id="l8.123">     monkeyPatch(uclient, &quot;replayChangesOn&quot;, (protofunc, aListener) =&gt; {</span>
<a href="#l8.124"></a><span id="l8.124">       protofunc({</span>
<a href="#l8.125"></a><span id="l8.125" class="difflineminus">-        onResult: function(operation, detail) {</span>
<a href="#l8.126"></a><span id="l8.126" class="difflineplus">+        onResult(operation, detail) {</span>
<a href="#l8.127"></a><span id="l8.127">           uclient._lastStatus = operation.status;</span>
<a href="#l8.128"></a><span id="l8.128">           uclient._lastMessage = detail;</span>
<a href="#l8.129"></a><span id="l8.129">           aListener.onResult(operation, detail);</span>
<a href="#l8.130"></a><span id="l8.130">         },</span>
<a href="#l8.131"></a><span id="l8.131">       });</span>
<a href="#l8.132"></a><span id="l8.132">     });</span>
<a href="#l8.133"></a><span id="l8.133"> </span>
<a href="#l8.134"></a><span id="l8.134">     calmgr.registerCalendar(client);</span>
<a href="#l8.135"></a><span id="l8.135" class="difflineat">@@ -247,17 +266,17 @@ class CalDavServer {</span>
<a href="#l8.136"></a><span id="l8.136">     if (</span>
<a href="#l8.137"></a><span id="l8.137">       method == &quot;PROPFIND&quot; &amp;&amp;</span>
<a href="#l8.138"></a><span id="l8.138">       request.path.startsWith(&quot;/calendars/xpcshell/events&quot;) &amp;&amp;</span>
<a href="#l8.139"></a><span id="l8.139">       headers.get(&quot;depth&quot;) == 0</span>
<a href="#l8.140"></a><span id="l8.140">     ) {</span>
<a href="#l8.141"></a><span id="l8.141">       response.setHeader(&quot;Content-Type&quot;, &quot;application/xml&quot;);</span>
<a href="#l8.142"></a><span id="l8.142">       response.write(dedent`</span>
<a href="#l8.143"></a><span id="l8.143">         &lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot; ?&gt;</span>
<a href="#l8.144"></a><span id="l8.144" class="difflineminus">-        &lt;D:multistatus ${xmlns(&quot;D&quot;, &quot;C&quot;, &quot;CS&quot;)} xmlns:R=&quot;http://www.foo.bar/boxschema/&quot;&gt;</span>
<a href="#l8.145"></a><span id="l8.145" class="difflineplus">+        &lt;D:multistatus ${CalDavXmlns(&quot;D&quot;, &quot;C&quot;, &quot;CS&quot;)} xmlns:R=&quot;http://www.foo.bar/boxschema/&quot;&gt;</span>
<a href="#l8.146"></a><span id="l8.146">           &lt;D:response&gt;</span>
<a href="#l8.147"></a><span id="l8.147">             &lt;D:href&gt;${request.path}&lt;/D:href&gt;</span>
<a href="#l8.148"></a><span id="l8.148">             &lt;D:propstat&gt;</span>
<a href="#l8.149"></a><span id="l8.149">               &lt;D:prop&gt;</span>
<a href="#l8.150"></a><span id="l8.150">                 &lt;D:resourcetype&gt;</span>
<a href="#l8.151"></a><span id="l8.151">                   &lt;D:collection/&gt;</span>
<a href="#l8.152"></a><span id="l8.152">                   &lt;C:calendar/&gt;</span>
<a href="#l8.153"></a><span id="l8.153">                 &lt;/D:resourcetype&gt;</span>
<a href="#l8.154"></a><span id="l8.154" class="difflineat">@@ -309,33 +328,33 @@ class CalDavServer {</span>
<a href="#l8.155"></a><span id="l8.155">           &lt;/D:response&gt;</span>
<a href="#l8.156"></a><span id="l8.156">         &lt;/D:multistatus&gt;</span>
<a href="#l8.157"></a><span id="l8.157">       `);</span>
<a href="#l8.158"></a><span id="l8.158">       response.setStatusLine(null, 207, &quot;Multistatus&quot;);</span>
<a href="#l8.159"></a><span id="l8.159">     } else if (method == &quot;POST&quot; &amp;&amp; request.path == &quot;/calendars/xpcshell/outbox&quot;) {</span>
<a href="#l8.160"></a><span id="l8.160">       response.setHeader(&quot;Content-Type&quot;, &quot;application/xml&quot;);</span>
<a href="#l8.161"></a><span id="l8.161">       response.write(dedent`</span>
<a href="#l8.162"></a><span id="l8.162">         &lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot; ?&gt;</span>
<a href="#l8.163"></a><span id="l8.163" class="difflineminus">-        &lt;C:schedule-response ${xmlns(&quot;D&quot;, &quot;C&quot;)}&gt;</span>
<a href="#l8.164"></a><span id="l8.164" class="difflineplus">+        &lt;C:schedule-response ${CalDavXmlns(&quot;D&quot;, &quot;C&quot;)}&gt;</span>
<a href="#l8.165"></a><span id="l8.165">           &lt;D:response&gt;</span>
<a href="#l8.166"></a><span id="l8.166">             &lt;D:href&gt;mailto:recipient1@example.com&lt;/D:href&gt;</span>
<a href="#l8.167"></a><span id="l8.167">             &lt;D:request-status&gt;2.0;Success&lt;/D:request-status&gt;</span>
<a href="#l8.168"></a><span id="l8.168">           &lt;/D:response&gt;</span>
<a href="#l8.169"></a><span id="l8.169">           &lt;D:response&gt;</span>
<a href="#l8.170"></a><span id="l8.170">             &lt;D:href&gt;mailto:recipient2@example.com&lt;/D:href&gt;</span>
<a href="#l8.171"></a><span id="l8.171">             &lt;D:request-status&gt;2.0;Success&lt;/D:request-status&gt;</span>
<a href="#l8.172"></a><span id="l8.172">           &lt;/D:response&gt;</span>
<a href="#l8.173"></a><span id="l8.173">         &lt;/C:schedule-response&gt;</span>
<a href="#l8.174"></a><span id="l8.174">       `);</span>
<a href="#l8.175"></a><span id="l8.175">       response.setStatusLine(null, 200, &quot;OK&quot;);</span>
<a href="#l8.176"></a><span id="l8.176">     } else if (method == &quot;POST&quot; &amp;&amp; request.path == &quot;/calendars/xpcshell/outbox2&quot;) {</span>
<a href="#l8.177"></a><span id="l8.177">       response.setHeader(&quot;Content-Type&quot;, &quot;application/xml&quot;);</span>
<a href="#l8.178"></a><span id="l8.178">       response.write(dedent`</span>
<a href="#l8.179"></a><span id="l8.179">         &lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot; ?&gt;</span>
<a href="#l8.180"></a><span id="l8.180" class="difflineminus">-        &lt;C:schedule-response ${xmlns(&quot;D&quot;, &quot;C&quot;)}&gt;</span>
<a href="#l8.181"></a><span id="l8.181" class="difflineplus">+        &lt;C:schedule-response ${CalDavXmlns(&quot;D&quot;, &quot;C&quot;)}&gt;</span>
<a href="#l8.182"></a><span id="l8.182">           &lt;D:response&gt;</span>
<a href="#l8.183"></a><span id="l8.183">             &lt;D:recipient&gt;</span>
<a href="#l8.184"></a><span id="l8.184">               &lt;D:href&gt;mailto:recipient1@example.com&lt;/D:href&gt;</span>
<a href="#l8.185"></a><span id="l8.185">             &lt;/D:recipient&gt;</span>
<a href="#l8.186"></a><span id="l8.186">             &lt;D:request-status&gt;2.0;Success&lt;/D:request-status&gt;</span>
<a href="#l8.187"></a><span id="l8.187">             &lt;C:calendar-data&gt;</span>
<a href="#l8.188"></a><span id="l8.188">         BEGIN:VCALENDAR</span>
<a href="#l8.189"></a><span id="l8.189">         PRODID:-//Mozilla.org/NONSGML Mozilla Calendar V1.1//EN</span>
<a href="#l8.190"></a><span id="l8.190" class="difflineat">@@ -364,17 +383,17 @@ class CalDavServer {</span>
<a href="#l8.191"></a><span id="l8.191">       response.setStatusLine(null, 200, &quot;OK&quot;);</span>
<a href="#l8.192"></a><span id="l8.192">     } else if (method == &quot;REPORT&quot; &amp;&amp; request.path == &quot;/calendars/xpcshell/events/&quot;) {</span>
<a href="#l8.193"></a><span id="l8.193">       response.setHeader(&quot;Content-Type&quot;, &quot;application/xml&quot;);</span>
<a href="#l8.194"></a><span id="l8.194">       let bodydom = cal.xml.parseString(body);</span>
<a href="#l8.195"></a><span id="l8.195">       let report = bodydom.documentElement.localName;</span>
<a href="#l8.196"></a><span id="l8.196">       if (report == &quot;sync-collection&quot;) {</span>
<a href="#l8.197"></a><span id="l8.197">         response.write(dedent`</span>
<a href="#l8.198"></a><span id="l8.198">           &lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot; ?&gt;</span>
<a href="#l8.199"></a><span id="l8.199" class="difflineminus">-          &lt;D:multistatus ${xmlns(&quot;D&quot;)}&gt;</span>
<a href="#l8.200"></a><span id="l8.200" class="difflineplus">+          &lt;D:multistatus ${CalDavXmlns(&quot;D&quot;)}&gt;</span>
<a href="#l8.201"></a><span id="l8.201">             &lt;D:response&gt;</span>
<a href="#l8.202"></a><span id="l8.202">               &lt;D:href&gt;${this.uri(&quot;/calendars/xpcshell/events/test.ics&quot;).spec}&lt;/D:href&gt;</span>
<a href="#l8.203"></a><span id="l8.203">               &lt;D:propstat&gt;</span>
<a href="#l8.204"></a><span id="l8.204">                 &lt;D:prop&gt;</span>
<a href="#l8.205"></a><span id="l8.205">                   &lt;D:getcontenttype&gt;text/calendar; charset=utf-8; component=VEVENT&lt;/D:getcontenttype&gt;</span>
<a href="#l8.206"></a><span id="l8.206">                   &lt;D:getetag&gt;&quot;2decee6ffb701583398996bfbdacb8eec53edf94&quot;&lt;/D:getetag&gt;</span>
<a href="#l8.207"></a><span id="l8.207">                 &lt;/D:prop&gt;</span>
<a href="#l8.208"></a><span id="l8.208">                 &lt;D:status&gt;HTTP/1.1 200 OK&lt;/D:status&gt;</span>
<a href="#l8.209"></a><span id="l8.209" class="difflineat">@@ -383,17 +402,17 @@ class CalDavServer {</span>
<a href="#l8.210"></a><span id="l8.210">           &lt;/D:multistatus&gt;</span>
<a href="#l8.211"></a><span id="l8.211">         `);</span>
<a href="#l8.212"></a><span id="l8.212">       } else if (report == &quot;calendar-multiget&quot;) {</span>
<a href="#l8.213"></a><span id="l8.213">         let event = cal.createEvent();</span>
<a href="#l8.214"></a><span id="l8.214">         event.startDate = cal.dtz.now();</span>
<a href="#l8.215"></a><span id="l8.215">         event.endDate = cal.dtz.now();</span>
<a href="#l8.216"></a><span id="l8.216">         response.write(dedent`</span>
<a href="#l8.217"></a><span id="l8.217">           &lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<a href="#l8.218"></a><span id="l8.218" class="difflineminus">-          &lt;D:multistatus ${xmlns(&quot;D&quot;, &quot;C&quot;)}&gt;</span>
<a href="#l8.219"></a><span id="l8.219" class="difflineplus">+          &lt;D:multistatus ${CalDavXmlns(&quot;D&quot;, &quot;C&quot;)}&gt;</span>
<a href="#l8.220"></a><span id="l8.220">             &lt;D:response&gt;</span>
<a href="#l8.221"></a><span id="l8.221">               &lt;D:href&gt;${this.uri(&quot;/calendars/xpcshell/events/test.ics&quot;).spec}&lt;/D:href&gt;</span>
<a href="#l8.222"></a><span id="l8.222">               &lt;D:propstat&gt;</span>
<a href="#l8.223"></a><span id="l8.223">                 &lt;D:prop&gt;</span>
<a href="#l8.224"></a><span id="l8.224">                   &lt;D:getetag&gt;&quot;2decee6ffb701583398996bfbdacb8eec53edf94&quot;&lt;/D:getetag&gt;</span>
<a href="#l8.225"></a><span id="l8.225">                   &lt;C:calendar-data&gt;${event.icalString}&lt;/C:calendar-data&gt;</span>
<a href="#l8.226"></a><span id="l8.226">                 &lt;/D:prop&gt;</span>
<a href="#l8.227"></a><span id="l8.227">               &lt;/D:propstat&gt;</span>
<a href="#l8.228"></a><span id="l8.228" class="difflineat">@@ -438,21 +457,21 @@ function run_test() {</span>
<a href="#l8.229"></a><span id="l8.229">   cal.console.maxLogLevel = &quot;debug&quot;;</span>
<a href="#l8.230"></a><span id="l8.230">   replaceAlertsService();</span>
<a href="#l8.231"></a><span id="l8.231"> </span>
<a href="#l8.232"></a><span id="l8.232">   // TODO: make do_calendar_startup to work with this test and replace the startup code here</span>
<a href="#l8.233"></a><span id="l8.233">   do_get_profile();</span>
<a href="#l8.234"></a><span id="l8.234">   do_test_pending();</span>
<a href="#l8.235"></a><span id="l8.235"> </span>
<a href="#l8.236"></a><span id="l8.236">   cal.getCalendarManager().startup({</span>
<a href="#l8.237"></a><span id="l8.237" class="difflineminus">-    onResult: function() {</span>
<a href="#l8.238"></a><span id="l8.238" class="difflineplus">+    onResult() {</span>
<a href="#l8.239"></a><span id="l8.239">       gServer = new CalDavServer(&quot;xpcshell@example.com&quot;);</span>
<a href="#l8.240"></a><span id="l8.240">       gServer.start();</span>
<a href="#l8.241"></a><span id="l8.241">       cal.getTimezoneService().startup({</span>
<a href="#l8.242"></a><span id="l8.242" class="difflineminus">-        onResult: function() {</span>
<a href="#l8.243"></a><span id="l8.243" class="difflineplus">+        onResult() {</span>
<a href="#l8.244"></a><span id="l8.244">           run_next_test();</span>
<a href="#l8.245"></a><span id="l8.245">           do_test_finished();</span>
<a href="#l8.246"></a><span id="l8.246">         },</span>
<a href="#l8.247"></a><span id="l8.247">       });</span>
<a href="#l8.248"></a><span id="l8.248">     },</span>
<a href="#l8.249"></a><span id="l8.249">   });</span>
<a href="#l8.250"></a><span id="l8.250"> }</span>
<a href="#l8.251"></a><span id="l8.251"> </span>
<a href="#l8.252"></a><span id="l8.252" class="difflineat">@@ -480,55 +499,55 @@ add_task(async function test_caldav_sess</span>
<a href="#l8.253"></a><span id="l8.253">         return CalDavSession.RESTART_REQUEST;</span>
<a href="#l8.254"></a><span id="l8.254">       }</span>
<a href="#l8.255"></a><span id="l8.255">       return null;</span>
<a href="#l8.256"></a><span id="l8.256">     },</span>
<a href="#l8.257"></a><span id="l8.257">   };</span>
<a href="#l8.258"></a><span id="l8.258"> </span>
<a href="#l8.259"></a><span id="l8.259">   // First a simple request</span>
<a href="#l8.260"></a><span id="l8.260">   let uri = gServer.uri(&quot;/requests/session&quot;);</span>
<a href="#l8.261"></a><span id="l8.261" class="difflineminus">-  let request = new GenericRequest(gServer.session, gMockCalendar, &quot;HEAD&quot;, uri);</span>
<a href="#l8.262"></a><span id="l8.262" class="difflineplus">+  let request = new CalDavGenericRequest(gServer.session, gMockCalendar, &quot;HEAD&quot;, uri);</span>
<a href="#l8.263"></a><span id="l8.263">   await request.commit();</span>
<a href="#l8.264"></a><span id="l8.264"> </span>
<a href="#l8.265"></a><span id="l8.265">   equal(prepared, 1);</span>
<a href="#l8.266"></a><span id="l8.266">   equal(redirected, 0);</span>
<a href="#l8.267"></a><span id="l8.267">   equal(completed, 1);</span>
<a href="#l8.268"></a><span id="l8.268"> </span>
<a href="#l8.269"></a><span id="l8.269">   // Now a redirect</span>
<a href="#l8.270"></a><span id="l8.270">   prepared = redirected = completed = 0;</span>
<a href="#l8.271"></a><span id="l8.271"> </span>
<a href="#l8.272"></a><span id="l8.272">   uri = gServer.uri(&quot;/requests/redirected&quot;);</span>
<a href="#l8.273"></a><span id="l8.273" class="difflineminus">-  request = new GenericRequest(gServer.session, gMockCalendar, &quot;HEAD&quot;, uri);</span>
<a href="#l8.274"></a><span id="l8.274" class="difflineplus">+  request = new CalDavGenericRequest(gServer.session, gMockCalendar, &quot;HEAD&quot;, uri);</span>
<a href="#l8.275"></a><span id="l8.275">   await request.commit();</span>
<a href="#l8.276"></a><span id="l8.276"> </span>
<a href="#l8.277"></a><span id="l8.277">   equal(prepared, 1);</span>
<a href="#l8.278"></a><span id="l8.278">   equal(redirected, 1);</span>
<a href="#l8.279"></a><span id="l8.279">   equal(completed, 1);</span>
<a href="#l8.280"></a><span id="l8.280"> </span>
<a href="#l8.281"></a><span id="l8.281">   // Now with restarting the request</span>
<a href="#l8.282"></a><span id="l8.282">   prepared = redirected = completed = 0;</span>
<a href="#l8.283"></a><span id="l8.283">   restart = true;</span>
<a href="#l8.284"></a><span id="l8.284"> </span>
<a href="#l8.285"></a><span id="l8.285">   uri = gServer.uri(&quot;/requests/redirected&quot;);</span>
<a href="#l8.286"></a><span id="l8.286" class="difflineminus">-  request = new GenericRequest(gServer.session, gMockCalendar, &quot;HEAD&quot;, uri);</span>
<a href="#l8.287"></a><span id="l8.287" class="difflineplus">+  request = new CalDavGenericRequest(gServer.session, gMockCalendar, &quot;HEAD&quot;, uri);</span>
<a href="#l8.288"></a><span id="l8.288">   await request.commit();</span>
<a href="#l8.289"></a><span id="l8.289"> </span>
<a href="#l8.290"></a><span id="l8.290">   equal(prepared, 2);</span>
<a href="#l8.291"></a><span id="l8.291">   equal(redirected, 2);</span>
<a href="#l8.292"></a><span id="l8.292">   equal(completed, 2);</span>
<a href="#l8.293"></a><span id="l8.293"> });</span>
<a href="#l8.294"></a><span id="l8.294"> </span>
<a href="#l8.295"></a><span id="l8.295"> /**</span>
<a href="#l8.296"></a><span id="l8.296" class="difflineminus">- * This test covers both GenericRequest and the base class CalDavRequest/CalDavResponse</span>
<a href="#l8.297"></a><span id="l8.297" class="difflineplus">+ * This test covers both GenericRequest and the base class CalDavRequestBase/CalDavResponseBase</span>
<a href="#l8.298"></a><span id="l8.298">  */</span>
<a href="#l8.299"></a><span id="l8.299"> add_task(async function test_generic_request() {</span>
<a href="#l8.300"></a><span id="l8.300">   gServer.reset();</span>
<a href="#l8.301"></a><span id="l8.301">   let uri = gServer.uri(&quot;/requests/generic&quot;);</span>
<a href="#l8.302"></a><span id="l8.302">   let headers = { &quot;X-Hdr&quot;: &quot;exists&quot; };</span>
<a href="#l8.303"></a><span id="l8.303" class="difflineminus">-  let request = new GenericRequest(</span>
<a href="#l8.304"></a><span id="l8.304" class="difflineplus">+  let request = new CalDavGenericRequest(</span>
<a href="#l8.305"></a><span id="l8.305">     gServer.session,</span>
<a href="#l8.306"></a><span id="l8.306">     gMockCalendar,</span>
<a href="#l8.307"></a><span id="l8.307">     &quot;PUT&quot;,</span>
<a href="#l8.308"></a><span id="l8.308">     uri,</span>
<a href="#l8.309"></a><span id="l8.309">     headers,</span>
<a href="#l8.310"></a><span id="l8.310">     &quot;&lt;body&gt;xpc&lt;/body&gt;&quot;,</span>
<a href="#l8.311"></a><span id="l8.311">     &quot;text/plain&quot;</span>
<a href="#l8.312"></a><span id="l8.312">   );</span>
<a href="#l8.313"></a><span id="l8.313" class="difflineat">@@ -572,17 +591,17 @@ add_task(async function test_generic_red</span>
<a href="#l8.314"></a><span id="l8.314">   let uri = gServer.uri(&quot;/requests/redirected&quot;);</span>
<a href="#l8.315"></a><span id="l8.315">   let headers = {</span>
<a href="#l8.316"></a><span id="l8.316">     Depth: 1,</span>
<a href="#l8.317"></a><span id="l8.317">     Originator: &quot;o&quot;,</span>
<a href="#l8.318"></a><span id="l8.318">     Recipient: &quot;r&quot;,</span>
<a href="#l8.319"></a><span id="l8.319">     &quot;If-None-Match&quot;: &quot;*&quot;,</span>
<a href="#l8.320"></a><span id="l8.320">     &quot;If-Match&quot;: &quot;123&quot;,</span>
<a href="#l8.321"></a><span id="l8.321">   };</span>
<a href="#l8.322"></a><span id="l8.322" class="difflineminus">-  let request = new GenericRequest(</span>
<a href="#l8.323"></a><span id="l8.323" class="difflineplus">+  let request = new CalDavGenericRequest(</span>
<a href="#l8.324"></a><span id="l8.324">     gServer.session,</span>
<a href="#l8.325"></a><span id="l8.325">     gMockCalendar,</span>
<a href="#l8.326"></a><span id="l8.326">     &quot;PUT&quot;,</span>
<a href="#l8.327"></a><span id="l8.327">     uri,</span>
<a href="#l8.328"></a><span id="l8.328">     headers,</span>
<a href="#l8.329"></a><span id="l8.329">     &quot;&lt;body&gt;xpc&lt;/body&gt;&quot;,</span>
<a href="#l8.330"></a><span id="l8.330">     &quot;text/plain&quot;</span>
<a href="#l8.331"></a><span id="l8.331">   );</span>
<a href="#l8.332"></a><span id="l8.332" class="difflineat">@@ -614,17 +633,17 @@ add_task(async function test_generic_red</span>
<a href="#l8.333"></a><span id="l8.333">   equal(response.lastRedirectStatus, 302);</span>
<a href="#l8.334"></a><span id="l8.334"> });</span>
<a href="#l8.335"></a><span id="l8.335"> </span>
<a href="#l8.336"></a><span id="l8.336"> add_task(async function test_item_request() {</span>
<a href="#l8.337"></a><span id="l8.337">   gServer.reset();</span>
<a href="#l8.338"></a><span id="l8.338">   let uri = gServer.uri(&quot;/requests/item/201&quot;);</span>
<a href="#l8.339"></a><span id="l8.339">   let icalString = &quot;BEGIN:VEVENT\r\nUID:123\r\nEND:VEVENT&quot;;</span>
<a href="#l8.340"></a><span id="l8.340">   let componentString = `BEGIN:VCALENDAR\r\nPRODID:-//Mozilla.org/NONSGML Mozilla Calendar V1.1//EN\r\nVERSION:2.0\r\n${icalString}\r\nEND:VCALENDAR\r\n`;</span>
<a href="#l8.341"></a><span id="l8.341" class="difflineminus">-  let request = new ItemRequest(</span>
<a href="#l8.342"></a><span id="l8.342" class="difflineplus">+  let request = new CalDavItemRequest(</span>
<a href="#l8.343"></a><span id="l8.343">     gServer.session,</span>
<a href="#l8.344"></a><span id="l8.344">     gMockCalendar,</span>
<a href="#l8.345"></a><span id="l8.345">     uri,</span>
<a href="#l8.346"></a><span id="l8.346">     cal.createEvent(icalString),</span>
<a href="#l8.347"></a><span id="l8.347">     &quot;*&quot;</span>
<a href="#l8.348"></a><span id="l8.348">   );</span>
<a href="#l8.349"></a><span id="l8.349">   let response = await request.commit();</span>
<a href="#l8.350"></a><span id="l8.350"> </span>
<a href="#l8.351"></a><span id="l8.351" class="difflineat">@@ -636,17 +655,17 @@ add_task(async function test_item_reques</span>
<a href="#l8.352"></a><span id="l8.352">   equal(serverResult.method, &quot;PUT&quot;);</span>
<a href="#l8.353"></a><span id="l8.353">   equal(serverResult.body, componentString);</span>
<a href="#l8.354"></a><span id="l8.354">   equal(serverResult.headers.get(&quot;If-None-Match&quot;), &quot;*&quot;);</span>
<a href="#l8.355"></a><span id="l8.355">   ok(!serverResult.headers.has(&quot;If-Match&quot;));</span>
<a href="#l8.356"></a><span id="l8.356"> </span>
<a href="#l8.357"></a><span id="l8.357">   // Now the same with 204 No Content and an etag</span>
<a href="#l8.358"></a><span id="l8.358">   gServer.reset();</span>
<a href="#l8.359"></a><span id="l8.359">   uri = gServer.uri(&quot;/requests/item/204&quot;);</span>
<a href="#l8.360"></a><span id="l8.360" class="difflineminus">-  request = new ItemRequest(</span>
<a href="#l8.361"></a><span id="l8.361" class="difflineplus">+  request = new CalDavItemRequest(</span>
<a href="#l8.362"></a><span id="l8.362">     gServer.session,</span>
<a href="#l8.363"></a><span id="l8.363">     gMockCalendar,</span>
<a href="#l8.364"></a><span id="l8.364">     uri,</span>
<a href="#l8.365"></a><span id="l8.365">     cal.createEvent(icalString),</span>
<a href="#l8.366"></a><span id="l8.366">     &quot;123123&quot;</span>
<a href="#l8.367"></a><span id="l8.367">   );</span>
<a href="#l8.368"></a><span id="l8.368">   response = await request.commit();</span>
<a href="#l8.369"></a><span id="l8.369"> </span>
<a href="#l8.370"></a><span id="l8.370" class="difflineat">@@ -658,34 +677,34 @@ add_task(async function test_item_reques</span>
<a href="#l8.371"></a><span id="l8.371">   equal(serverResult.method, &quot;PUT&quot;);</span>
<a href="#l8.372"></a><span id="l8.372">   equal(serverResult.body, componentString);</span>
<a href="#l8.373"></a><span id="l8.373">   equal(serverResult.headers.get(&quot;If-Match&quot;), &quot;123123&quot;);</span>
<a href="#l8.374"></a><span id="l8.374">   ok(!serverResult.headers.has(&quot;If-None-Match&quot;));</span>
<a href="#l8.375"></a><span id="l8.375"> </span>
<a href="#l8.376"></a><span id="l8.376">   // Now the same with 200 OK and no etag</span>
<a href="#l8.377"></a><span id="l8.377">   gServer.reset();</span>
<a href="#l8.378"></a><span id="l8.378">   uri = gServer.uri(&quot;/requests/item/200&quot;);</span>
<a href="#l8.379"></a><span id="l8.379" class="difflineminus">-  request = new ItemRequest(gServer.session, gMockCalendar, uri, cal.createEvent(icalString));</span>
<a href="#l8.380"></a><span id="l8.380" class="difflineplus">+  request = new CalDavItemRequest(gServer.session, gMockCalendar, uri, cal.createEvent(icalString));</span>
<a href="#l8.381"></a><span id="l8.381">   response = await request.commit();</span>
<a href="#l8.382"></a><span id="l8.382"> </span>
<a href="#l8.383"></a><span id="l8.383">   equal(response.status, 200);</span>
<a href="#l8.384"></a><span id="l8.384">   ok(response.ok);</span>
<a href="#l8.385"></a><span id="l8.385"> </span>
<a href="#l8.386"></a><span id="l8.386">   serverResult = gServer.serverRequests.item;</span>
<a href="#l8.387"></a><span id="l8.387"> </span>
<a href="#l8.388"></a><span id="l8.388">   equal(serverResult.method, &quot;PUT&quot;);</span>
<a href="#l8.389"></a><span id="l8.389">   equal(serverResult.body, componentString);</span>
<a href="#l8.390"></a><span id="l8.390">   ok(!serverResult.headers.has(&quot;If-Match&quot;));</span>
<a href="#l8.391"></a><span id="l8.391">   ok(!serverResult.headers.has(&quot;If-None-Match&quot;));</span>
<a href="#l8.392"></a><span id="l8.392"> });</span>
<a href="#l8.393"></a><span id="l8.393"> </span>
<a href="#l8.394"></a><span id="l8.394"> add_task(async function test_delete_item_request() {</span>
<a href="#l8.395"></a><span id="l8.395">   gServer.reset();</span>
<a href="#l8.396"></a><span id="l8.396">   let uri = gServer.uri(&quot;/requests/deleteitem&quot;);</span>
<a href="#l8.397"></a><span id="l8.397" class="difflineminus">-  let request = new DeleteItemRequest(gServer.session, gMockCalendar, uri, &quot;*&quot;);</span>
<a href="#l8.398"></a><span id="l8.398" class="difflineplus">+  let request = new CalDavDeleteItemRequest(gServer.session, gMockCalendar, uri, &quot;*&quot;);</span>
<a href="#l8.399"></a><span id="l8.399"> </span>
<a href="#l8.400"></a><span id="l8.400">   strictEqual(request.uploadData, null);</span>
<a href="#l8.401"></a><span id="l8.401">   strictEqual(request.contentType, null);</span>
<a href="#l8.402"></a><span id="l8.402"> </span>
<a href="#l8.403"></a><span id="l8.403">   let response = await request.commit();</span>
<a href="#l8.404"></a><span id="l8.404"> </span>
<a href="#l8.405"></a><span id="l8.405">   equal(response.status, 200);</span>
<a href="#l8.406"></a><span id="l8.406">   ok(response.ok);</span>
<a href="#l8.407"></a><span id="l8.407" class="difflineat">@@ -694,17 +713,17 @@ add_task(async function test_delete_item</span>
<a href="#l8.408"></a><span id="l8.408"> </span>
<a href="#l8.409"></a><span id="l8.409">   equal(serverResult.method, &quot;DELETE&quot;);</span>
<a href="#l8.410"></a><span id="l8.410">   equal(serverResult.headers.get(&quot;If-Match&quot;), &quot;*&quot;);</span>
<a href="#l8.411"></a><span id="l8.411">   ok(!serverResult.headers.has(&quot;If-None-Match&quot;));</span>
<a href="#l8.412"></a><span id="l8.412"> </span>
<a href="#l8.413"></a><span id="l8.413">   // Now the same with no etag, and a (valid) 404 response</span>
<a href="#l8.414"></a><span id="l8.414">   gServer.reset();</span>
<a href="#l8.415"></a><span id="l8.415">   uri = gServer.uri(&quot;/requests/deleteitem/404&quot;);</span>
<a href="#l8.416"></a><span id="l8.416" class="difflineminus">-  request = new DeleteItemRequest(gServer.session, gMockCalendar, uri);</span>
<a href="#l8.417"></a><span id="l8.417" class="difflineplus">+  request = new CalDavDeleteItemRequest(gServer.session, gMockCalendar, uri);</span>
<a href="#l8.418"></a><span id="l8.418">   response = await request.commit();</span>
<a href="#l8.419"></a><span id="l8.419"> </span>
<a href="#l8.420"></a><span id="l8.420">   equal(response.status, 404);</span>
<a href="#l8.421"></a><span id="l8.421">   ok(response.ok);</span>
<a href="#l8.422"></a><span id="l8.422"> </span>
<a href="#l8.423"></a><span id="l8.423">   serverResult = gServer.serverRequests.deleteitem;</span>
<a href="#l8.424"></a><span id="l8.424"> </span>
<a href="#l8.425"></a><span id="l8.425">   equal(serverResult.method, &quot;DELETE&quot;);</span>
<a href="#l8.426"></a><span id="l8.426" class="difflineat">@@ -719,17 +738,17 @@ add_task(async function test_propfind_re</span>
<a href="#l8.427"></a><span id="l8.427">     &quot;D:principal-collection-set&quot;,</span>
<a href="#l8.428"></a><span id="l8.428">     &quot;D:current-user-principal&quot;,</span>
<a href="#l8.429"></a><span id="l8.429">     &quot;D:supported-report-set&quot;,</span>
<a href="#l8.430"></a><span id="l8.430">     &quot;C:supported-calendar-component-set&quot;,</span>
<a href="#l8.431"></a><span id="l8.431">     &quot;C:schedule-inbox-URL&quot;,</span>
<a href="#l8.432"></a><span id="l8.432">     &quot;C:schedule-outbox-URL&quot;,</span>
<a href="#l8.433"></a><span id="l8.433">     &quot;R:obscure-thing-not-found&quot;,</span>
<a href="#l8.434"></a><span id="l8.434">   ];</span>
<a href="#l8.435"></a><span id="l8.435" class="difflineminus">-  let request = new PropfindRequest(gServer.session, gMockCalendar, uri, props);</span>
<a href="#l8.436"></a><span id="l8.436" class="difflineplus">+  let request = new CalDavPropfindRequest(gServer.session, gMockCalendar, uri, props);</span>
<a href="#l8.437"></a><span id="l8.437">   let response = await request.commit();</span>
<a href="#l8.438"></a><span id="l8.438"> </span>
<a href="#l8.439"></a><span id="l8.439">   equal(response.status, 207);</span>
<a href="#l8.440"></a><span id="l8.440">   ok(response.ok);</span>
<a href="#l8.441"></a><span id="l8.441"> </span>
<a href="#l8.442"></a><span id="l8.442">   let results = gServer.serverRequests.calendars;</span>
<a href="#l8.443"></a><span id="l8.443"> </span>
<a href="#l8.444"></a><span id="l8.444">   ok(</span>
<a href="#l8.445"></a><span id="l8.445" class="difflineat">@@ -758,31 +777,31 @@ add_task(async function test_propfind_re</span>
<a href="#l8.446"></a><span id="l8.446">   equal(resprops[&quot;C:schedule-outbox-URL&quot;], gServer.uri(&quot;/calendars/xpcshell/outbox&quot;).spec);</span>
<a href="#l8.447"></a><span id="l8.447">   strictEqual(resprops[&quot;R:obscure-thing-not-found&quot;], null);</span>
<a href="#l8.448"></a><span id="l8.448">   equal(resprops[&quot;R:plain-text-prop&quot;], &quot;hello, world&quot;);</span>
<a href="#l8.449"></a><span id="l8.449"> });</span>
<a href="#l8.450"></a><span id="l8.450"> </span>
<a href="#l8.451"></a><span id="l8.451"> add_task(async function test_davheader_request() {</span>
<a href="#l8.452"></a><span id="l8.452">   gServer.reset();</span>
<a href="#l8.453"></a><span id="l8.453">   let uri = gServer.uri(&quot;/requests/dav&quot;);</span>
<a href="#l8.454"></a><span id="l8.454" class="difflineminus">-  let request = new DAVHeaderRequest(gServer.session, gMockCalendar, uri);</span>
<a href="#l8.455"></a><span id="l8.455" class="difflineplus">+  let request = new CalDavHeaderRequest(gServer.session, gMockCalendar, uri);</span>
<a href="#l8.456"></a><span id="l8.456">   let response = await request.commit();</span>
<a href="#l8.457"></a><span id="l8.457"> </span>
<a href="#l8.458"></a><span id="l8.458">   let serverResult = gServer.serverRequests.dav;</span>
<a href="#l8.459"></a><span id="l8.459"> </span>
<a href="#l8.460"></a><span id="l8.460">   equal(serverResult.method, &quot;OPTIONS&quot;);</span>
<a href="#l8.461"></a><span id="l8.461">   deepEqual([...response.features], [&quot;calendar-schedule&quot;, &quot;calendar-auto-schedule&quot;]);</span>
<a href="#l8.462"></a><span id="l8.462">   strictEqual(response.version, 1);</span>
<a href="#l8.463"></a><span id="l8.463"> });</span>
<a href="#l8.464"></a><span id="l8.464"> </span>
<a href="#l8.465"></a><span id="l8.465"> add_task(async function test_propsearch_request() {</span>
<a href="#l8.466"></a><span id="l8.466">   gServer.reset();</span>
<a href="#l8.467"></a><span id="l8.467">   let uri = gServer.uri(&quot;/principals/&quot;);</span>
<a href="#l8.468"></a><span id="l8.468">   let props = [&quot;D:displayname&quot;, &quot;B:department&quot;, &quot;B:phone&quot;, &quot;B:office&quot;];</span>
<a href="#l8.469"></a><span id="l8.469" class="difflineminus">-  let request = new PrincipalPropertySearchRequest(</span>
<a href="#l8.470"></a><span id="l8.470" class="difflineplus">+  let request = new CalDavPrincipalPropertySearchRequest(</span>
<a href="#l8.471"></a><span id="l8.471">     gServer.session,</span>
<a href="#l8.472"></a><span id="l8.472">     gMockCalendar,</span>
<a href="#l8.473"></a><span id="l8.473">     uri,</span>
<a href="#l8.474"></a><span id="l8.474">     &quot;doE&quot;,</span>
<a href="#l8.475"></a><span id="l8.475">     &quot;D:displayname&quot;,</span>
<a href="#l8.476"></a><span id="l8.476">     props</span>
<a href="#l8.477"></a><span id="l8.477">   );</span>
<a href="#l8.478"></a><span id="l8.478">   let response = await request.commit();</span>
<a href="#l8.479"></a><span id="l8.479" class="difflineat">@@ -798,17 +817,17 @@ add_task(async function test_propsearch_</span>
<a href="#l8.480"></a><span id="l8.480">     gServer.serverRequests.principals.body.match(/&lt;D:prop&gt;\s*&lt;D:displayname\/&gt;\s*&lt;B:department\/&gt;/)</span>
<a href="#l8.481"></a><span id="l8.481">   );</span>
<a href="#l8.482"></a><span id="l8.482"> });</span>
<a href="#l8.483"></a><span id="l8.483"> </span>
<a href="#l8.484"></a><span id="l8.484"> add_task(async function test_outbox_request() {</span>
<a href="#l8.485"></a><span id="l8.485">   gServer.reset();</span>
<a href="#l8.486"></a><span id="l8.486">   let icalString = &quot;BEGIN:VEVENT\r\nUID:123\r\nEND:VEVENT&quot;;</span>
<a href="#l8.487"></a><span id="l8.487">   let uri = gServer.uri(&quot;/calendars/xpcshell/outbox&quot;);</span>
<a href="#l8.488"></a><span id="l8.488" class="difflineminus">-  let request = new OutboxRequest(</span>
<a href="#l8.489"></a><span id="l8.489" class="difflineplus">+  let request = new CalDavOutboxRequest(</span>
<a href="#l8.490"></a><span id="l8.490">     gServer.session,</span>
<a href="#l8.491"></a><span id="l8.491">     gMockCalendar,</span>
<a href="#l8.492"></a><span id="l8.492">     uri,</span>
<a href="#l8.493"></a><span id="l8.493">     &quot;xpcshell@example.com&quot;,</span>
<a href="#l8.494"></a><span id="l8.494">     [&quot;recipient1@example.com&quot;, &quot;recipient2@example.com&quot;],</span>
<a href="#l8.495"></a><span id="l8.495">     &quot;REPLY&quot;,</span>
<a href="#l8.496"></a><span id="l8.496">     cal.createEvent(icalString)</span>
<a href="#l8.497"></a><span id="l8.497">   );</span>
<a href="#l8.498"></a><span id="l8.498" class="difflineat">@@ -823,17 +842,17 @@ add_task(async function test_outbox_requ</span>
<a href="#l8.499"></a><span id="l8.499">   equal(results.method, &quot;POST&quot;);</span>
<a href="#l8.500"></a><span id="l8.500">   equal(results.headers.get(&quot;Originator&quot;), &quot;xpcshell@example.com&quot;);</span>
<a href="#l8.501"></a><span id="l8.501">   equal(results.headers.get(&quot;Recipient&quot;), &quot;recipient1@example.com, recipient2@example.com&quot;);</span>
<a href="#l8.502"></a><span id="l8.502"> });</span>
<a href="#l8.503"></a><span id="l8.503"> </span>
<a href="#l8.504"></a><span id="l8.504"> add_task(async function test_freebusy_request() {</span>
<a href="#l8.505"></a><span id="l8.505">   gServer.reset();</span>
<a href="#l8.506"></a><span id="l8.506">   let uri = gServer.uri(&quot;/calendars/xpcshell/outbox2&quot;);</span>
<a href="#l8.507"></a><span id="l8.507" class="difflineminus">-  let request = new FreeBusyRequest(</span>
<a href="#l8.508"></a><span id="l8.508" class="difflineplus">+  let request = new CalDavFreeBusyRequest(</span>
<a href="#l8.509"></a><span id="l8.509">     gServer.session,</span>
<a href="#l8.510"></a><span id="l8.510">     gMockCalendar,</span>
<a href="#l8.511"></a><span id="l8.511">     uri,</span>
<a href="#l8.512"></a><span id="l8.512">     &quot;mailto:xpcshell@example.com&quot;,</span>
<a href="#l8.513"></a><span id="l8.513">     &quot;mailto:recipient@example.com&quot;,</span>
<a href="#l8.514"></a><span id="l8.514">     cal.createDateTime(&quot;20180101&quot;),</span>
<a href="#l8.515"></a><span id="l8.515">     cal.createDateTime(&quot;20180201&quot;)</span>
<a href="#l8.516"></a><span id="l8.516">   );</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:32Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

