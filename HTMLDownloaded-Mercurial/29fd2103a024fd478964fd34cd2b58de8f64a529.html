<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 20469:29fd2103a024fd478964fd34cd2b58de8f64a529</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 29fd2103a024fd478964fd34cd2b58de8f64a529" />
<meta property="og:url" content="/comm-central/rev/29fd2103a024fd478964fd34cd2b58de8f64a529" />
<meta property="og:description" content="Bug 1244650 - Failure to clear Forms and Search Data on exit. r=yoric" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 29fd2103a024fd478964fd34cd2b58de8f64a529 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/29fd2103a024fd478964fd34cd2b58de8f64a529">shortlog</a> |
<a href="/comm-central/log/29fd2103a024fd478964fd34cd2b58de8f64a529">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/29fd2103a024fd478964fd34cd2b58de8f64a529">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/29fd2103a024fd478964fd34cd2b58de8f64a529">files</a> |
changeset |
<a href="/comm-central/raw-rev/29fd2103a024fd478964fd34cd2b58de8f64a529">raw</a>  | <a href="/comm-central/archive/29fd2103a024fd478964fd34cd2b58de8f64a529.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1244650">Bug 1244650</a> - Failure to clear Forms and Search Data on exit. r=yoric
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#77;&#97;&#114;&#99;&#111;&#32;&#66;&#111;&#110;&#97;&#114;&#100;&#111;&#32;&#60;&#109;&#98;&#111;&#110;&#97;&#114;&#100;&#111;&#64;&#109;&#111;&#122;&#105;&#108;&#108;&#97;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 04 Feb 2016 13:51:34 +0100</td></tr>

<tr>
 <td>changeset 20469</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/29fd2103a024fd478964fd34cd2b58de8f64a529">29fd2103a024fd478964fd34cd2b58de8f64a529</a></td>
</tr>



<tr>
<td>parent 20468</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/15f47ac5004ac4ae5542ddde6e25c794c0656ad3">15f47ac5004ac4ae5542ddde6e25c794c0656ad3</a>
</td>
</tr>

<tr>
<td>child 20470</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/8244daf298c9b73116c77ae21eb22e827d87578f">8244daf298c9b73116c77ae21eb22e827d87578f</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=29fd2103a024fd478964fd34cd2b58de8f64a529">12352</a></td></tr>
<tr><td>push user</td><td>philip.chee@gmail.com</td></tr>
<tr><td>push date</td><td class="date age">Tue, 27 Sep 2016 08:56:11 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@9bd937fc0c12 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=9bd937fc0c12bc6b04247f0da5e1f140bd1441de">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=9bd937fc0c12bc6b04247f0da5e1f140bd1441de&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=9bd937fc0c12bc6b04247f0da5e1f140bd1441de&newProject=comm-central&newRevision=66094254572ec015e4e170847fdebd67a6cf6198&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=9bd937fc0c12bc6b04247f0da5e1f140bd1441de&newProject=comm-central&newRevision=66094254572ec015e4e170847fdebd67a6cf6198&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=9bd937fc0c12bc6b04247f0da5e1f140bd1441de&newProject=comm-central&newRevision=66094254572ec015e4e170847fdebd67a6cf6198&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28yoric%29&revcount=50">yoric</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1244650">1244650</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1244650">Bug 1244650</a> - Failure to clear Forms and Search Data on exit. r=yoric

The problem is due to sanitization happening too late in the shutdown cycle.
The Sanitizer depends on Places shutdown, that recently moved to async shutdown.
That change caused shutdown to happen completely at profile-before-change, unfortunately
during that phase it's impossible to predict which services are already shutdown.
The patch restores the previous Places shutdown procedure, thus clients are notified
earlier, during profile-change-teardown.

Additional meaningful changes:
* Fixes FX_SANITIZE_TOTAL telemetry to properly count total time taken by sanitize.
* Makes each cleanup operation isolated from other errors to try cleaning up as most as possible.
* In case of multiple sanitization sub steps, each step is isolated by a try/catch, the last seen exception is reported upstream.
* Makes FX_SANITIZE_HISTORY actually measure history, not other random stuff.
* Removes TOPIC_SIMULATE_PLACES_MUST_CLOSE_1 since we can now just use profile-change-teardown for shutdown phase 1.

MozReview-Commit-ID: HroLvbi25IC</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/29fd2103a024fd478964fd34cd2b58de8f64a529/suite/common/places/tests/head_common.js">suite/common/places/tests/head_common.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/29fd2103a024fd478964fd34cd2b58de8f64a529/suite/common/places/tests/head_common.js">file</a> |
<a href="/comm-central/annotate/29fd2103a024fd478964fd34cd2b58de8f64a529/suite/common/places/tests/head_common.js">annotate</a> |
<a href="/comm-central/diff/29fd2103a024fd478964fd34cd2b58de8f64a529/suite/common/places/tests/head_common.js">diff</a> |
<a href="/comm-central/comparison/29fd2103a024fd478964fd34cd2b58de8f64a529/suite/common/places/tests/head_common.js">comparison</a> |
<a href="/comm-central/log/29fd2103a024fd478964fd34cd2b58de8f64a529/suite/common/places/tests/head_common.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/suite/common/places/tests/head_common.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/suite/common/places/tests/head_common.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -380,20 +380,20 @@ function promiseTopicObserved(aTopic)</span>
<a href="#l1.4"></a><span id="l1.4">  * Simulates a Places shutdown.</span>
<a href="#l1.5"></a><span id="l1.5">  */</span>
<a href="#l1.6"></a><span id="l1.6"> var shutdownPlaces = function() {</span>
<a href="#l1.7"></a><span id="l1.7">   do_print(&quot;shutdownPlaces: starting&quot;);</span>
<a href="#l1.8"></a><span id="l1.8">   let promise = new Promise(resolve =&gt; {</span>
<a href="#l1.9"></a><span id="l1.9">     Services.obs.addObserver(resolve, &quot;places-connection-closed&quot;, false);</span>
<a href="#l1.10"></a><span id="l1.10">   });</span>
<a href="#l1.11"></a><span id="l1.11">   let hs = PlacesUtils.history.QueryInterface(Ci.nsIObserver);</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-  hs.observe(null, &quot;test-simulate-places-shutdown-phase-1&quot;, null);</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-  do_print(&quot;shutdownPlaces: sent test-simulate-places-shutdown-phase-1&quot;);</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-  hs.observe(null, &quot;test-simulate-places-shutdown-phase-2&quot;, null);</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineminus">-  do_print(&quot;shutdownPlaces: sent test-simulate-places-shutdown-phase-2&quot;);</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+  hs.observe(null, &quot;profile-change-teardown&quot;, null);</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+  do_print(&quot;shutdownPlaces: sent profile-change-teardown&quot;);</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+  hs.observe(null, &quot;test-simulate-places-shutdown&quot;, null);</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+  do_print(&quot;shutdownPlaces: sent test-simulate-places-shutdown&quot;);</span>
<a href="#l1.20"></a><span id="l1.20">   return promise.then(() =&gt; {</span>
<a href="#l1.21"></a><span id="l1.21">     do_print(&quot;shutdownPlaces: complete&quot;);</span>
<a href="#l1.22"></a><span id="l1.22">   });</span>
<a href="#l1.23"></a><span id="l1.23"> };</span>
<a href="#l1.24"></a><span id="l1.24"> </span>
<a href="#l1.25"></a><span id="l1.25"> const FILENAME_BOOKMARKS_HTML = &quot;bookmarks.html&quot;;</span>
<a href="#l1.26"></a><span id="l1.26"> const FILENAME_BOOKMARKS_JSON = &quot;bookmarks-&quot; +</span>
<a href="#l1.27"></a><span id="l1.27">   (PlacesBackups.toISODateString(new Date())) + &quot;.json&quot;;</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

