<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 11117:089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f" />
<meta property="og:url" content="/comm-central/rev/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f" />
<meta property="og:description" content="Bug 763106 - Convert /mail/components/preferences/*.js to Services.jsm and MailServices.js. r=mconley" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f">shortlog</a> |
<a href="/comm-central/log/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f">files</a> |
changeset |
<a href="/comm-central/raw-rev/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f">raw</a>  | <a href="/comm-central/archive/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=763106">Bug 763106</a> - Convert /mail/components/preferences/*.js to Services.jsm and MailServices.js. r=mconley
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#97;&#99;&#101;&#109;&#97;&#110;&#32;&#60;&#97;&#99;&#101;&#108;&#105;&#115;&#116;&#115;&#64;&#97;&#116;&#108;&#97;&#115;&#46;&#115;&#107;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 24 Sep 2012 18:09:14 -0400</td></tr>

<tr>
 <td>changeset 11117</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f">089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f</a></td>
</tr>



<tr>
<td>parent 11116</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/18d35f49e7fdeef9e3fe51fb36c50508a42fc8a0">18d35f49e7fdeef9e3fe51fb36c50508a42fc8a0</a>
</td>
</tr>

<tr>
<td>child 11118</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/432feab3693cbf72f86de47aae78ec49840ee646">432feab3693cbf72f86de47aae78ec49840ee646</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f">8343</a></td></tr>
<tr><td>push user</td><td>ryanvm@gmail.com</td></tr>
<tr><td>push date</td><td class="date age">Mon, 24 Sep 2012 22:09:10 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@dd7842775a4a [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=dd7842775a4a35ecb4133c2ab2bee9ff60bf3022">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=dd7842775a4a35ecb4133c2ab2bee9ff60bf3022&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=dd7842775a4a35ecb4133c2ab2bee9ff60bf3022&newProject=comm-central&newRevision=c3d8cf23a2f2a5718a7463fa51f75a0e90d484a8&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=dd7842775a4a35ecb4133c2ab2bee9ff60bf3022&newProject=comm-central&newRevision=c3d8cf23a2f2a5718a7463fa51f75a0e90d484a8&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=dd7842775a4a35ecb4133c2ab2bee9ff60bf3022&newProject=comm-central&newRevision=c3d8cf23a2f2a5718a7463fa51f75a0e90d484a8&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mconley%29&revcount=50">mconley</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=763106">763106</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=763106">Bug 763106</a> - Convert /mail/components/preferences/*.js to Services.jsm and MailServices.js. r=mconley</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f/mail/components/preferences/advanced.js">mail/components/preferences/advanced.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f/mail/components/preferences/advanced.js">file</a> |
<a href="/comm-central/annotate/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f/mail/components/preferences/advanced.js">annotate</a> |
<a href="/comm-central/diff/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f/mail/components/preferences/advanced.js">diff</a> |
<a href="/comm-central/comparison/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f/mail/components/preferences/advanced.js">comparison</a> |
<a href="/comm-central/log/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f/mail/components/preferences/advanced.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f/mail/components/preferences/applications.js">mail/components/preferences/applications.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f/mail/components/preferences/applications.js">file</a> |
<a href="/comm-central/annotate/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f/mail/components/preferences/applications.js">annotate</a> |
<a href="/comm-central/diff/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f/mail/components/preferences/applications.js">diff</a> |
<a href="/comm-central/comparison/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f/mail/components/preferences/applications.js">comparison</a> |
<a href="/comm-central/log/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f/mail/components/preferences/applications.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f/mail/components/preferences/attachmentReminder.js">mail/components/preferences/attachmentReminder.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f/mail/components/preferences/attachmentReminder.js">file</a> |
<a href="/comm-central/annotate/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f/mail/components/preferences/attachmentReminder.js">annotate</a> |
<a href="/comm-central/diff/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f/mail/components/preferences/attachmentReminder.js">diff</a> |
<a href="/comm-central/comparison/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f/mail/components/preferences/attachmentReminder.js">comparison</a> |
<a href="/comm-central/log/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f/mail/components/preferences/attachmentReminder.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f/mail/components/preferences/connection.js">mail/components/preferences/connection.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f/mail/components/preferences/connection.js">file</a> |
<a href="/comm-central/annotate/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f/mail/components/preferences/connection.js">annotate</a> |
<a href="/comm-central/diff/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f/mail/components/preferences/connection.js">diff</a> |
<a href="/comm-central/comparison/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f/mail/components/preferences/connection.js">comparison</a> |
<a href="/comm-central/log/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f/mail/components/preferences/connection.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f/mail/components/preferences/cookies.js">mail/components/preferences/cookies.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f/mail/components/preferences/cookies.js">file</a> |
<a href="/comm-central/annotate/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f/mail/components/preferences/cookies.js">annotate</a> |
<a href="/comm-central/diff/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f/mail/components/preferences/cookies.js">diff</a> |
<a href="/comm-central/comparison/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f/mail/components/preferences/cookies.js">comparison</a> |
<a href="/comm-central/log/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f/mail/components/preferences/cookies.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f/mail/components/preferences/downloads.js">mail/components/preferences/downloads.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f/mail/components/preferences/downloads.js">file</a> |
<a href="/comm-central/annotate/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f/mail/components/preferences/downloads.js">annotate</a> |
<a href="/comm-central/diff/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f/mail/components/preferences/downloads.js">diff</a> |
<a href="/comm-central/comparison/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f/mail/components/preferences/downloads.js">comparison</a> |
<a href="/comm-central/log/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f/mail/components/preferences/downloads.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f/mail/components/preferences/fonts.js">mail/components/preferences/fonts.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f/mail/components/preferences/fonts.js">file</a> |
<a href="/comm-central/annotate/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f/mail/components/preferences/fonts.js">annotate</a> |
<a href="/comm-central/diff/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f/mail/components/preferences/fonts.js">diff</a> |
<a href="/comm-central/comparison/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f/mail/components/preferences/fonts.js">comparison</a> |
<a href="/comm-central/log/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f/mail/components/preferences/fonts.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f/mail/components/preferences/general.js">mail/components/preferences/general.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f/mail/components/preferences/general.js">file</a> |
<a href="/comm-central/annotate/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f/mail/components/preferences/general.js">annotate</a> |
<a href="/comm-central/diff/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f/mail/components/preferences/general.js">diff</a> |
<a href="/comm-central/comparison/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f/mail/components/preferences/general.js">comparison</a> |
<a href="/comm-central/log/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f/mail/components/preferences/general.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f/mail/components/preferences/permissions.js">mail/components/preferences/permissions.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f/mail/components/preferences/permissions.js">file</a> |
<a href="/comm-central/annotate/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f/mail/components/preferences/permissions.js">annotate</a> |
<a href="/comm-central/diff/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f/mail/components/preferences/permissions.js">diff</a> |
<a href="/comm-central/comparison/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f/mail/components/preferences/permissions.js">comparison</a> |
<a href="/comm-central/log/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f/mail/components/preferences/permissions.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f/mail/components/preferences/security.js">mail/components/preferences/security.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f/mail/components/preferences/security.js">file</a> |
<a href="/comm-central/annotate/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f/mail/components/preferences/security.js">annotate</a> |
<a href="/comm-central/diff/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f/mail/components/preferences/security.js">diff</a> |
<a href="/comm-central/comparison/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f/mail/components/preferences/security.js">comparison</a> |
<a href="/comm-central/log/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f/mail/components/preferences/security.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f/mail/components/preferences/sendoptions.js">mail/components/preferences/sendoptions.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f/mail/components/preferences/sendoptions.js">file</a> |
<a href="/comm-central/annotate/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f/mail/components/preferences/sendoptions.js">annotate</a> |
<a href="/comm-central/diff/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f/mail/components/preferences/sendoptions.js">diff</a> |
<a href="/comm-central/comparison/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f/mail/components/preferences/sendoptions.js">comparison</a> |
<a href="/comm-central/log/089215e2d64ff8a34ffaafe9ad7b5d2a4415b48f/mail/components/preferences/sendoptions.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/components/preferences/advanced.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/components/preferences/advanced.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -86,22 +86,19 @@ var gAdvancedPane = {</span>
<a href="#l1.4"></a><span id="l1.4">     if (shellSvc.isDefaultClient(false, nsIShellService.MAIL |</span>
<a href="#l1.5"></a><span id="l1.5">                                         nsIShellService.NEWS |</span>
<a href="#l1.6"></a><span id="l1.6">                                         nsIShellService.RSS))</span>
<a href="#l1.7"></a><span id="l1.7">     {</span>
<a href="#l1.8"></a><span id="l1.8">       var brandBundle = document.getElementById(&quot;bundleBrand&quot;);</span>
<a href="#l1.9"></a><span id="l1.9">       var preferencesBundle = document.getElementById(&quot;bundlePreferences&quot;);</span>
<a href="#l1.10"></a><span id="l1.10">       var brandShortName = brandBundle.getString(&quot;brandShortName&quot;);</span>
<a href="#l1.11"></a><span id="l1.11">       var promptTitle = preferencesBundle.getString(&quot;alreadyDefaultClientTitle&quot;);</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-      var psvc = Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-                           .getService(Components.interfaces.nsIPromptService);</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-</span>
<a href="#l1.15"></a><span id="l1.15">       var promptMessage = preferencesBundle.getFormattedString(&quot;alreadyDefault&quot;,</span>
<a href="#l1.16"></a><span id="l1.16">                                                                [brandShortName]);</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineminus">-      psvc.alert(window, promptTitle, promptMessage);</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+      Services.prompt.alert(window, promptTitle, promptMessage);</span>
<a href="#l1.19"></a><span id="l1.19">     }</span>
<a href="#l1.20"></a><span id="l1.20">     else</span>
<a href="#l1.21"></a><span id="l1.21">     {</span>
<a href="#l1.22"></a><span id="l1.22">       // otherwise, bring up the default client dialog</span>
<a href="#l1.23"></a><span id="l1.23">       window.openDialog(&quot;chrome://messenger/content/systemIntegrationDialog.xul&quot;,</span>
<a href="#l1.24"></a><span id="l1.24">                         &quot;SystemIntegration&quot;,</span>
<a href="#l1.25"></a><span id="l1.25">                         &quot;modal,centerscreen,chrome,resizable=no&quot;);</span>
<a href="#l1.26"></a><span id="l1.26">     }</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineat">@@ -145,20 +142,18 @@ var gAdvancedPane = {</span>
<a href="#l1.28"></a><span id="l1.28">     return isNaN(intValue) ? 0 : intValue * 1024;</span>
<a href="#l1.29"></a><span id="l1.29">   },</span>
<a href="#l1.30"></a><span id="l1.30"> </span>
<a href="#l1.31"></a><span id="l1.31">   /**</span>
<a href="#l1.32"></a><span id="l1.32">    * Clears the cache.</span>
<a href="#l1.33"></a><span id="l1.33">    */</span>
<a href="#l1.34"></a><span id="l1.34">   clearCache: function ()</span>
<a href="#l1.35"></a><span id="l1.35">   {</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineminus">-    var cacheService = Components.classes[&quot;@mozilla.org/network/cache-service;1&quot;]</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineminus">-                                 .getService(Components.interfaces.nsICacheService);</span>
<a href="#l1.38"></a><span id="l1.38">     try {</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineminus">-      cacheService.evictEntries(Components.interfaces.nsICache.STORE_ANYWHERE);</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+      Services.cache.evictEntries(Components.interfaces.nsICache.STORE_ANYWHERE);</span>
<a href="#l1.41"></a><span id="l1.41">     } catch(ex) {}</span>
<a href="#l1.42"></a><span id="l1.42">   },</span>
<a href="#l1.43"></a><span id="l1.43"> </span>
<a href="#l1.44"></a><span id="l1.44">   updateButtons: function (aButtonID, aPreferenceID)</span>
<a href="#l1.45"></a><span id="l1.45">   {</span>
<a href="#l1.46"></a><span id="l1.46">     var button = document.getElementById(aButtonID);</span>
<a href="#l1.47"></a><span id="l1.47">     var preference = document.getElementById(aPreferenceID);</span>
<a href="#l1.48"></a><span id="l1.48">     // This is actually before the value changes, so the value is not as you expect. </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/components/preferences/applications.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/components/preferences/applications.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -138,19 +138,16 @@ HandlerInfoWrapper.prototype = {</span>
<a href="#l2.4"></a><span id="l2.4">   wrappedHandlerInfo: null,</span>
<a href="#l2.5"></a><span id="l2.5"> </span>
<a href="#l2.6"></a><span id="l2.6">   //**************************************************************************//</span>
<a href="#l2.7"></a><span id="l2.7">   // Convenience Utils</span>
<a href="#l2.8"></a><span id="l2.8"> </span>
<a href="#l2.9"></a><span id="l2.9">   _handlerSvc: Components.classes[&quot;@mozilla.org/uriloader/handler-service;1&quot;]</span>
<a href="#l2.10"></a><span id="l2.10">                          .getService(Components.interfaces.nsIHandlerService),</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-  _prefSvc: Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-                      .getService(Components.interfaces.nsIPrefBranch),</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-</span>
<a href="#l2.15"></a><span id="l2.15">   _categoryMgr: Components.classes[&quot;@mozilla.org/categorymanager;1&quot;]</span>
<a href="#l2.16"></a><span id="l2.16">                           .getService(Components.interfaces.nsICategoryManager),</span>
<a href="#l2.17"></a><span id="l2.17"> </span>
<a href="#l2.18"></a><span id="l2.18">   //**************************************************************************//</span>
<a href="#l2.19"></a><span id="l2.19">   // nsIHandlerInfo</span>
<a href="#l2.20"></a><span id="l2.20"> </span>
<a href="#l2.21"></a><span id="l2.21">   // The MIME type or protocol scheme.</span>
<a href="#l2.22"></a><span id="l2.22">   _type: null,</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineat">@@ -323,47 +320,47 @@ HandlerInfoWrapper.prototype = {</span>
<a href="#l2.24"></a><span id="l2.24"> </span>
<a href="#l2.25"></a><span id="l2.25">   get isDisabledPluginType() {</span>
<a href="#l2.26"></a><span id="l2.26">     return this._getDisabledPluginTypes().indexOf(this.type) != -1;</span>
<a href="#l2.27"></a><span id="l2.27">   },</span>
<a href="#l2.28"></a><span id="l2.28"> </span>
<a href="#l2.29"></a><span id="l2.29">   _getDisabledPluginTypes: function() {</span>
<a href="#l2.30"></a><span id="l2.30">     var types = &quot;&quot;;</span>
<a href="#l2.31"></a><span id="l2.31"> </span>
<a href="#l2.32"></a><span id="l2.32" class="difflineminus">-    if (this._prefSvc.prefHasUserValue(PREF_DISABLED_PLUGIN_TYPES))</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineminus">-      types = this._prefSvc.getCharPref(PREF_DISABLED_PLUGIN_TYPES);</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+    if (Services.prefs.prefHasUserValue(PREF_DISABLED_PLUGIN_TYPES))</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+      types = Services.prefs.getCharPref(PREF_DISABLED_PLUGIN_TYPES);</span>
<a href="#l2.36"></a><span id="l2.36"> </span>
<a href="#l2.37"></a><span id="l2.37">     // Only split if the string isn't empty so we don't end up with an array</span>
<a href="#l2.38"></a><span id="l2.38">     // containing a single empty string.</span>
<a href="#l2.39"></a><span id="l2.39">     return types ? types.split(&quot;,&quot;) : [];</span>
<a href="#l2.40"></a><span id="l2.40">   },</span>
<a href="#l2.41"></a><span id="l2.41"> </span>
<a href="#l2.42"></a><span id="l2.42">   disablePluginType: function() {</span>
<a href="#l2.43"></a><span id="l2.43">     var disabledPluginTypes = this._getDisabledPluginTypes();</span>
<a href="#l2.44"></a><span id="l2.44"> </span>
<a href="#l2.45"></a><span id="l2.45">     if (disabledPluginTypes.indexOf(this.type) == -1)</span>
<a href="#l2.46"></a><span id="l2.46">       disabledPluginTypes.push(this.type);</span>
<a href="#l2.47"></a><span id="l2.47"> </span>
<a href="#l2.48"></a><span id="l2.48" class="difflineminus">-    this._prefSvc.setCharPref(PREF_DISABLED_PLUGIN_TYPES,</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineminus">-                              disabledPluginTypes.join(&quot;,&quot;));</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineplus">+    Services.prefs.setCharPref(PREF_DISABLED_PLUGIN_TYPES,</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineplus">+                               disabledPluginTypes.join(&quot;,&quot;));</span>
<a href="#l2.52"></a><span id="l2.52"> </span>
<a href="#l2.53"></a><span id="l2.53">     // Update the category manager so existing browser windows update.</span>
<a href="#l2.54"></a><span id="l2.54">     this._categoryMgr.deleteCategoryEntry(&quot;Gecko-Content-Viewers&quot;,</span>
<a href="#l2.55"></a><span id="l2.55">                                           this.type,</span>
<a href="#l2.56"></a><span id="l2.56">                                           false);</span>
<a href="#l2.57"></a><span id="l2.57">   },</span>
<a href="#l2.58"></a><span id="l2.58"> </span>
<a href="#l2.59"></a><span id="l2.59">   enablePluginType: function() {</span>
<a href="#l2.60"></a><span id="l2.60">     var disabledPluginTypes = this._getDisabledPluginTypes();</span>
<a href="#l2.61"></a><span id="l2.61"> </span>
<a href="#l2.62"></a><span id="l2.62">     var type = this.type;</span>
<a href="#l2.63"></a><span id="l2.63">     disabledPluginTypes = disabledPluginTypes.filter(function(v) v != type);</span>
<a href="#l2.64"></a><span id="l2.64"> </span>
<a href="#l2.65"></a><span id="l2.65" class="difflineminus">-    this._prefSvc.setCharPref(PREF_DISABLED_PLUGIN_TYPES,</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineminus">-                              disabledPluginTypes.join(&quot;,&quot;));</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineplus">+    Services.prefs.setCharPref(PREF_DISABLED_PLUGIN_TYPES,</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineplus">+                               disabledPluginTypes.join(&quot;,&quot;));</span>
<a href="#l2.69"></a><span id="l2.69"> </span>
<a href="#l2.70"></a><span id="l2.70">     // Update the category manager so existing browser windows update.</span>
<a href="#l2.71"></a><span id="l2.71">     this._categoryMgr.</span>
<a href="#l2.72"></a><span id="l2.72">       addCategoryEntry(&quot;Gecko-Content-Viewers&quot;,</span>
<a href="#l2.73"></a><span id="l2.73">                        this.type,</span>
<a href="#l2.74"></a><span id="l2.74">                        &quot;@mozilla.org/content/plugin/document-loader-factory;1&quot;,</span>
<a href="#l2.75"></a><span id="l2.75">                        false,</span>
<a href="#l2.76"></a><span id="l2.76">                        true);</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineat">@@ -867,47 +864,40 @@ var gApplicationsPane = {</span>
<a href="#l2.78"></a><span id="l2.78">   // Convenience &amp; Performance Shortcuts</span>
<a href="#l2.79"></a><span id="l2.79"> </span>
<a href="#l2.80"></a><span id="l2.80">   // These get defined by init().</span>
<a href="#l2.81"></a><span id="l2.81">   _brandShortName : null,</span>
<a href="#l2.82"></a><span id="l2.82">   _prefsBundle    : null,</span>
<a href="#l2.83"></a><span id="l2.83">   _list           : null,</span>
<a href="#l2.84"></a><span id="l2.84">   _filter         : null,</span>
<a href="#l2.85"></a><span id="l2.85"> </span>
<a href="#l2.86"></a><span id="l2.86" class="difflineminus">-  _prefSvc      : Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineminus">-                            .getService(Components.interfaces.nsIPrefBranch),</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineminus">-</span>
<a href="#l2.89"></a><span id="l2.89">   _mimeSvc      : Components.classes[&quot;@mozilla.org/mime;1&quot;]</span>
<a href="#l2.90"></a><span id="l2.90">                             .getService(Components.interfaces.nsIMIMEService),</span>
<a href="#l2.91"></a><span id="l2.91"> </span>
<a href="#l2.92"></a><span id="l2.92">   _helperAppSvc : Components.classes[&quot;@mozilla.org/uriloader/external-helper-app-service;1&quot;]</span>
<a href="#l2.93"></a><span id="l2.93">                             .getService(Components.interfaces.nsIExternalHelperAppService),</span>
<a href="#l2.94"></a><span id="l2.94"> </span>
<a href="#l2.95"></a><span id="l2.95">   _handlerSvc   : Components.classes[&quot;@mozilla.org/uriloader/handler-service;1&quot;]</span>
<a href="#l2.96"></a><span id="l2.96">                             .getService(Components.interfaces.nsIHandlerService),</span>
<a href="#l2.97"></a><span id="l2.97"> </span>
<a href="#l2.98"></a><span id="l2.98" class="difflineminus">-  _ioSvc        : Components.classes[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l2.99"></a><span id="l2.99" class="difflineminus">-                            .getService(Components.interfaces.nsIIOService),</span>
<a href="#l2.100"></a><span id="l2.100" class="difflineminus">-</span>
<a href="#l2.101"></a><span id="l2.101" class="difflineminus">-</span>
<a href="#l2.102"></a><span id="l2.102">   //**************************************************************************//</span>
<a href="#l2.103"></a><span id="l2.103">   // Initialization &amp; Destruction</span>
<a href="#l2.104"></a><span id="l2.104"> </span>
<a href="#l2.105"></a><span id="l2.105">   init: function() {</span>
<a href="#l2.106"></a><span id="l2.106">     // Initialize shortcuts to some commonly accessed elements &amp; values.</span>
<a href="#l2.107"></a><span id="l2.107">     this._brandShortName =</span>
<a href="#l2.108"></a><span id="l2.108">       document.getElementById(&quot;bundleBrand&quot;).getString(&quot;brandShortName&quot;);</span>
<a href="#l2.109"></a><span id="l2.109">     this._prefsBundle = document.getElementById(&quot;bundlePreferences&quot;);</span>
<a href="#l2.110"></a><span id="l2.110">     this._list = document.getElementById(&quot;handlersView&quot;);</span>
<a href="#l2.111"></a><span id="l2.111">     this._filter = document.getElementById(&quot;filter&quot;);</span>
<a href="#l2.112"></a><span id="l2.112"> </span>
<a href="#l2.113"></a><span id="l2.113">     // Observe preferences that influence what we display so we can rebuild</span>
<a href="#l2.114"></a><span id="l2.114">     // the view when they change.</span>
<a href="#l2.115"></a><span id="l2.115" class="difflineminus">-    this._prefSvc.addObserver(PREF_SHOW_PLUGINS_IN_LIST, this, false);</span>
<a href="#l2.116"></a><span id="l2.116" class="difflineminus">-    this._prefSvc.addObserver(PREF_HIDE_PLUGINS_WITHOUT_EXTENSIONS, this, false);</span>
<a href="#l2.117"></a><span id="l2.117" class="difflineplus">+    Services.prefs.addObserver(PREF_SHOW_PLUGINS_IN_LIST, this, false);</span>
<a href="#l2.118"></a><span id="l2.118" class="difflineplus">+    Services.prefs.addObserver(PREF_HIDE_PLUGINS_WITHOUT_EXTENSIONS, this, false);</span>
<a href="#l2.119"></a><span id="l2.119"> </span>
<a href="#l2.120"></a><span id="l2.120">     // Listen for window unload so we can remove our preference observers.</span>
<a href="#l2.121"></a><span id="l2.121">     window.addEventListener(&quot;unload&quot;, this, false);</span>
<a href="#l2.122"></a><span id="l2.122"> </span>
<a href="#l2.123"></a><span id="l2.123">     // Figure out how we should be sorting the list.  We persist sort settings</span>
<a href="#l2.124"></a><span id="l2.124">     // across sessions, so we can't assume the default sort column/direction.</span>
<a href="#l2.125"></a><span id="l2.125">     // XXX should we be using the XUL sort service instead?</span>
<a href="#l2.126"></a><span id="l2.126">     this._sortColumn = document.getElementById(&quot;typeColumn&quot;)</span>
<a href="#l2.127"></a><span id="l2.127" class="difflineat">@@ -928,27 +918,25 @@ var gApplicationsPane = {</span>
<a href="#l2.128"></a><span id="l2.128">     // XXX Shouldn't we perhaps just set a max-height on the richlistbox?</span>
<a href="#l2.129"></a><span id="l2.129">     var _delayedPaneLoad = function(self) {</span>
<a href="#l2.130"></a><span id="l2.130">       self._loadData();</span>
<a href="#l2.131"></a><span id="l2.131">       self._rebuildVisibleTypes();</span>
<a href="#l2.132"></a><span id="l2.132">       self._sortVisibleTypes();</span>
<a href="#l2.133"></a><span id="l2.133">       self.rebuildView();</span>
<a href="#l2.134"></a><span id="l2.134"> </span>
<a href="#l2.135"></a><span id="l2.135">       // Notify observers that the UI is now ready</span>
<a href="#l2.136"></a><span id="l2.136" class="difflineminus">-      Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l2.137"></a><span id="l2.137" class="difflineminus">-                .getService(Components.interfaces.nsIObserverService)</span>
<a href="#l2.138"></a><span id="l2.138" class="difflineminus">-                .notifyObservers(window, &quot;app-handler-pane-loaded&quot;, null);</span>
<a href="#l2.139"></a><span id="l2.139" class="difflineplus">+      Services.obs.notifyObservers(window, &quot;app-handler-pane-loaded&quot;, null);</span>
<a href="#l2.140"></a><span id="l2.140">     }</span>
<a href="#l2.141"></a><span id="l2.141">     setTimeout(_delayedPaneLoad, 0, this);</span>
<a href="#l2.142"></a><span id="l2.142">   },</span>
<a href="#l2.143"></a><span id="l2.143"> </span>
<a href="#l2.144"></a><span id="l2.144">   destroy: function() {</span>
<a href="#l2.145"></a><span id="l2.145">     window.removeEventListener(&quot;unload&quot;, this, false);</span>
<a href="#l2.146"></a><span id="l2.146" class="difflineminus">-    this._prefSvc.removeObserver(PREF_SHOW_PLUGINS_IN_LIST, this);</span>
<a href="#l2.147"></a><span id="l2.147" class="difflineminus">-    this._prefSvc.removeObserver(PREF_HIDE_PLUGINS_WITHOUT_EXTENSIONS, this);</span>
<a href="#l2.148"></a><span id="l2.148" class="difflineplus">+    Services.prefs.removeObserver(PREF_SHOW_PLUGINS_IN_LIST, this);</span>
<a href="#l2.149"></a><span id="l2.149" class="difflineplus">+    Services.prefs.removeObserver(PREF_HIDE_PLUGINS_WITHOUT_EXTENSIONS, this);</span>
<a href="#l2.150"></a><span id="l2.150">   },</span>
<a href="#l2.151"></a><span id="l2.151"> </span>
<a href="#l2.152"></a><span id="l2.152"> </span>
<a href="#l2.153"></a><span id="l2.153">   //**************************************************************************//</span>
<a href="#l2.154"></a><span id="l2.154">   // nsISupports</span>
<a href="#l2.155"></a><span id="l2.155"> </span>
<a href="#l2.156"></a><span id="l2.156">   QueryInterface: function(aIID) {</span>
<a href="#l2.157"></a><span id="l2.157">     if (aIID.equals(Components.interfaces.nsIObserver) ||</span>
<a href="#l2.158"></a><span id="l2.158" class="difflineat">@@ -1068,19 +1056,19 @@ var gApplicationsPane = {</span>
<a href="#l2.159"></a><span id="l2.159">   // View Construction</span>
<a href="#l2.160"></a><span id="l2.160"> </span>
<a href="#l2.161"></a><span id="l2.161">   _rebuildVisibleTypes: function() {</span>
<a href="#l2.162"></a><span id="l2.162">     // Reset the list of visible types and the visible type description counts.</span>
<a href="#l2.163"></a><span id="l2.163">     this._visibleTypes = [];</span>
<a href="#l2.164"></a><span id="l2.164">     this._visibleTypeDescriptionCount = [];</span>
<a href="#l2.165"></a><span id="l2.165"> </span>
<a href="#l2.166"></a><span id="l2.166">     // Get the preferences that help determine what types to show.</span>
<a href="#l2.167"></a><span id="l2.167" class="difflineminus">-    var showPlugins = this._prefSvc.getBoolPref(PREF_SHOW_PLUGINS_IN_LIST);</span>
<a href="#l2.168"></a><span id="l2.168" class="difflineplus">+    var showPlugins = Services.prefs.getBoolPref(PREF_SHOW_PLUGINS_IN_LIST);</span>
<a href="#l2.169"></a><span id="l2.169">     var hidePluginsWithoutExtensions =</span>
<a href="#l2.170"></a><span id="l2.170" class="difflineminus">-      this._prefSvc.getBoolPref(PREF_HIDE_PLUGINS_WITHOUT_EXTENSIONS);</span>
<a href="#l2.171"></a><span id="l2.171" class="difflineplus">+      Services.prefs.getBoolPref(PREF_HIDE_PLUGINS_WITHOUT_EXTENSIONS);</span>
<a href="#l2.172"></a><span id="l2.172"> </span>
<a href="#l2.173"></a><span id="l2.173">     for (let type in this._handledTypes) {</span>
<a href="#l2.174"></a><span id="l2.174">       let handlerInfo = this._handledTypes[type];</span>
<a href="#l2.175"></a><span id="l2.175"> </span>
<a href="#l2.176"></a><span id="l2.176">       // Hide plugins without associated extensions if so prefed so we don't</span>
<a href="#l2.177"></a><span id="l2.177">       // show a whole bunch of obscure types handled by plugins on Mac.</span>
<a href="#l2.178"></a><span id="l2.178">       // Note: though protocol types don't have extensions, we still show them;</span>
<a href="#l2.179"></a><span id="l2.179">       // the pref is only meant to be applied to MIME types, since plugins are</span>
<a href="#l2.180"></a><span id="l2.180" class="difflineat">@@ -1245,16 +1233,20 @@ var gApplicationsPane = {</span>
<a href="#l2.181"></a><span id="l2.181">       case Components.interfaces.nsIHandlerInfo.useSystemDefault:</span>
<a href="#l2.182"></a><span id="l2.182">         return this._prefsBundle.getFormattedString(&quot;useDefault&quot;,</span>
<a href="#l2.183"></a><span id="l2.183">                                                     [aHandlerInfo.defaultDescription]);</span>
<a href="#l2.184"></a><span id="l2.184"> </span>
<a href="#l2.185"></a><span id="l2.185">       case kActionUsePlugin:</span>
<a href="#l2.186"></a><span id="l2.186">         return this._prefsBundle.getFormattedString(&quot;usePluginIn&quot;,</span>
<a href="#l2.187"></a><span id="l2.187">                                                     [aHandlerInfo.plugin.name,</span>
<a href="#l2.188"></a><span id="l2.188">                                                      this._brandShortName]);</span>
<a href="#l2.189"></a><span id="l2.189" class="difflineplus">+      default:</span>
<a href="#l2.190"></a><span id="l2.190" class="difflineplus">+        // Hopefully this never happens.</span>
<a href="#l2.191"></a><span id="l2.191" class="difflineplus">+        Components.utils.reportError(&quot;No description for action &quot; + aHandlerInfo.preferredAction + &quot; found!&quot;);</span>
<a href="#l2.192"></a><span id="l2.192" class="difflineplus">+        return &quot;&quot;;</span>
<a href="#l2.193"></a><span id="l2.193">     }</span>
<a href="#l2.194"></a><span id="l2.194">   },</span>
<a href="#l2.195"></a><span id="l2.195"> </span>
<a href="#l2.196"></a><span id="l2.196">   _selectLastSelectedType: function() {</span>
<a href="#l2.197"></a><span id="l2.197">     // If the list is disabled by the pref.downloads.disable_button.edit_actions</span>
<a href="#l2.198"></a><span id="l2.198">     // preference being locked, then don't select the type, as that would cause</span>
<a href="#l2.199"></a><span id="l2.199">     // it to appear selected, with a different background and an actions menu</span>
<a href="#l2.200"></a><span id="l2.200">     // that makes it seem like you can choose an action for the type.</span>
<a href="#l2.201"></a><span id="l2.201" class="difflineat">@@ -1713,21 +1705,19 @@ var gApplicationsPane = {</span>
<a href="#l2.202"></a><span id="l2.202">   onSelectionChanged: function() {</span>
<a href="#l2.203"></a><span id="l2.203">     if (this._list.selectedItem)</span>
<a href="#l2.204"></a><span id="l2.204">       this._list.setAttribute(&quot;lastSelectedType&quot;,</span>
<a href="#l2.205"></a><span id="l2.205">                               this._list.selectedItem.getAttribute(&quot;type&quot;));</span>
<a href="#l2.206"></a><span id="l2.206">   },</span>
<a href="#l2.207"></a><span id="l2.207"> </span>
<a href="#l2.208"></a><span id="l2.208">   confirmDelete: function(aEvent) {</span>
<a href="#l2.209"></a><span id="l2.209">     aEvent.stopPropagation();</span>
<a href="#l2.210"></a><span id="l2.210" class="difflineminus">-    let promptSvc = Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l2.211"></a><span id="l2.211" class="difflineminus">-                              .getService(Components.interfaces.nsIPromptService);</span>
<a href="#l2.212"></a><span id="l2.212" class="difflineminus">-    if (promptSvc.confirm(null,</span>
<a href="#l2.213"></a><span id="l2.213" class="difflineminus">-                          this._prefsBundle.getString(&quot;confirmDeleteTitle&quot;),</span>
<a href="#l2.214"></a><span id="l2.214" class="difflineminus">-                          this._prefsBundle.getString(&quot;confirmDeleteText&quot;)))</span>
<a href="#l2.215"></a><span id="l2.215" class="difflineplus">+    if (Services.prompt.confirm(null,</span>
<a href="#l2.216"></a><span id="l2.216" class="difflineplus">+                                this._prefsBundle.getString(&quot;confirmDeleteTitle&quot;),</span>
<a href="#l2.217"></a><span id="l2.217" class="difflineplus">+                                this._prefsBundle.getString(&quot;confirmDeleteText&quot;)))</span>
<a href="#l2.218"></a><span id="l2.218">       this.onDelete(aEvent);</span>
<a href="#l2.219"></a><span id="l2.219">     else {</span>
<a href="#l2.220"></a><span id="l2.220">       // They hit cancel, so return them to the previously selected item.</span>
<a href="#l2.221"></a><span id="l2.221">       let typeItem = this._list.selectedItem;</span>
<a href="#l2.222"></a><span id="l2.222">       let menu = document.getAnonymousElementByAttribute(this._list.selectedItem,</span>
<a href="#l2.223"></a><span id="l2.223">                                                          &quot;class&quot;, &quot;actionsMenu&quot;);</span>
<a href="#l2.224"></a><span id="l2.224">       menu.selectedItem = menu.previousSelectedItem;</span>
<a href="#l2.225"></a><span id="l2.225">     }</span>
<a href="#l2.226"></a><span id="l2.226" class="difflineat">@@ -1782,23 +1772,20 @@ var gApplicationsPane = {</span>
<a href="#l2.227"></a><span id="l2.227">       case Components.interfaces.nsIHandlerInfo.useSystemDefault:</span>
<a href="#l2.228"></a><span id="l2.228">         return this._getIconURLForSystemDefault(aHandlerInfo);</span>
<a href="#l2.229"></a><span id="l2.229"> </span>
<a href="#l2.230"></a><span id="l2.230">       case Components.interfaces.nsIHandlerInfo.useHelperApp:</span>
<a href="#l2.231"></a><span id="l2.231">         let (preferredApp = aHandlerInfo.preferredApplicationHandler) {</span>
<a href="#l2.232"></a><span id="l2.232">           if (this.isValidHandlerApp(preferredApp))</span>
<a href="#l2.233"></a><span id="l2.233">             return this._getIconURLForHandlerApp(preferredApp);</span>
<a href="#l2.234"></a><span id="l2.234">         }</span>
<a href="#l2.235"></a><span id="l2.235" class="difflineminus">-        break;</span>
<a href="#l2.236"></a><span id="l2.236" class="difflineminus">-</span>
<a href="#l2.237"></a><span id="l2.237" class="difflineminus">-      // This should never happen, but if preferredAction is set to some weird</span>
<a href="#l2.238"></a><span id="l2.238" class="difflineminus">-      // value, then fall back to the generic application icon.</span>
<a href="#l2.239"></a><span id="l2.239" class="difflineminus">-      default:</span>
<a href="#l2.240"></a><span id="l2.240" class="difflineminus">-        return ICON_URL_APP;</span>
<a href="#l2.241"></a><span id="l2.241">     }</span>
<a href="#l2.242"></a><span id="l2.242" class="difflineplus">+    // This should never happen, but if preferredAction is set to some weird</span>
<a href="#l2.243"></a><span id="l2.243" class="difflineplus">+    // value, then fall back to the generic application icon.</span>
<a href="#l2.244"></a><span id="l2.244" class="difflineplus">+    return ICON_URL_APP;</span>
<a href="#l2.245"></a><span id="l2.245">   },</span>
<a href="#l2.246"></a><span id="l2.246"> </span>
<a href="#l2.247"></a><span id="l2.247">   _getIconURLForHandlerApp: function(aHandlerApp) {</span>
<a href="#l2.248"></a><span id="l2.248">     if (aHandlerApp instanceof Components.interfaces.nsILocalHandlerApp)</span>
<a href="#l2.249"></a><span id="l2.249">       return this._getIconURLForFile(aHandlerApp.executable);</span>
<a href="#l2.250"></a><span id="l2.250"> </span>
<a href="#l2.251"></a><span id="l2.251">     if (aHandlerApp instanceof Components.interfaces.nsIWebHandlerApp)</span>
<a href="#l2.252"></a><span id="l2.252">       return this._getIconURLForWebApp(aHandlerApp.uriTemplate);</span>
<a href="#l2.253"></a><span id="l2.253" class="difflineat">@@ -1806,25 +1793,25 @@ var gApplicationsPane = {</span>
<a href="#l2.254"></a><span id="l2.254">     if (aHandlerApp instanceof Components.interfaces.nsIWebContentHandlerInfo)</span>
<a href="#l2.255"></a><span id="l2.255">       return this._getIconURLForWebApp(aHandlerApp.uri)</span>
<a href="#l2.256"></a><span id="l2.256"> </span>
<a href="#l2.257"></a><span id="l2.257">     // We know nothing about other kinds of handler apps.</span>
<a href="#l2.258"></a><span id="l2.258">     return &quot;&quot;;</span>
<a href="#l2.259"></a><span id="l2.259">   },</span>
<a href="#l2.260"></a><span id="l2.260"> </span>
<a href="#l2.261"></a><span id="l2.261">   _getIconURLForFile: function(aFile) {</span>
<a href="#l2.262"></a><span id="l2.262" class="difflineminus">-    var fph = this._ioSvc.getProtocolHandler(&quot;file&quot;)</span>
<a href="#l2.263"></a><span id="l2.263" class="difflineminus">-                  .QueryInterface(Components.interfaces.nsIFileProtocolHandler);</span>
<a href="#l2.264"></a><span id="l2.264" class="difflineminus">-    var urlSpec = fph.getURLSpecFromFile(aFile);</span>
<a href="#l2.265"></a><span id="l2.265" class="difflineplus">+    let urlSpec = Services.io.getProtocolHandler(&quot;file&quot;)</span>
<a href="#l2.266"></a><span id="l2.266" class="difflineplus">+      .QueryInterface(Components.interfaces.nsIFileProtocolHandler)</span>
<a href="#l2.267"></a><span id="l2.267" class="difflineplus">+      .getURLSpecFromFile(aFile);</span>
<a href="#l2.268"></a><span id="l2.268"> </span>
<a href="#l2.269"></a><span id="l2.269">     return &quot;moz-icon://&quot; + urlSpec + &quot;?size=16&quot;;</span>
<a href="#l2.270"></a><span id="l2.270">   },</span>
<a href="#l2.271"></a><span id="l2.271"> </span>
<a href="#l2.272"></a><span id="l2.272">   _getIconURLForWebApp: function(aWebAppURITemplate) {</span>
<a href="#l2.273"></a><span id="l2.273" class="difflineminus">-    var uri = this._ioSvc.newURI(aWebAppURITemplate, null, null);</span>
<a href="#l2.274"></a><span id="l2.274" class="difflineplus">+    var uri = Services.io.newURI(aWebAppURITemplate, null, null);</span>
<a href="#l2.275"></a><span id="l2.275"> </span>
<a href="#l2.276"></a><span id="l2.276">     // Unfortunately we can't use the favicon service to get the favicon,</span>
<a href="#l2.277"></a><span id="l2.277">     // because the service looks in the annotations table for a record with</span>
<a href="#l2.278"></a><span id="l2.278">     // the exact URL we give it, and users won't have such records for URLs</span>
<a href="#l2.279"></a><span id="l2.279">     // they don't visit, and users won't visit the web app's URL template,</span>
<a href="#l2.280"></a><span id="l2.280">     // they'll only visit URLs derived from that template (i.e. with %s</span>
<a href="#l2.281"></a><span id="l2.281">     // in the template replaced by the URL of the content being handled).</span>
<a href="#l2.282"></a><span id="l2.282"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/components/preferences/attachmentReminder.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/components/preferences/attachmentReminder.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -1,68 +1,65 @@</span>
<a href="#l3.4"></a><span id="l3.4"> /* -*- Mode: Javascript; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l3.5"></a><span id="l3.5">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l3.6"></a><span id="l3.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l3.7"></a><span id="l3.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l3.8"></a><span id="l3.8"> </span>
<a href="#l3.9"></a><span id="l3.9" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l3.10"></a><span id="l3.10" class="difflineplus">+</span>
<a href="#l3.11"></a><span id="l3.11"> var gAttachmentReminderOptionsDialog = {</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-  prefs: null,</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-  promptService: null,</span>
<a href="#l3.14"></a><span id="l3.14">   keywordListBox: null,</span>
<a href="#l3.15"></a><span id="l3.15">   bundle: null,</span>
<a href="#l3.16"></a><span id="l3.16"> </span>
<a href="#l3.17"></a><span id="l3.17">   init: function()</span>
<a href="#l3.18"></a><span id="l3.18">   {</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineminus">-    this.prefs = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineminus">-                           .getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineminus">-    this.promptService = Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineminus">-                                   .getService(Components.interfaces.nsIPromptService);</span>
<a href="#l3.23"></a><span id="l3.23">     this.keywordListBox = document.getElementById(&quot;keywordList&quot;);</span>
<a href="#l3.24"></a><span id="l3.24">     this.bundle = document.getElementById(&quot;bundlePreferences&quot;);</span>
<a href="#l3.25"></a><span id="l3.25">     this.buildKeywordList();</span>
<a href="#l3.26"></a><span id="l3.26">   },</span>
<a href="#l3.27"></a><span id="l3.27"> </span>
<a href="#l3.28"></a><span id="l3.28">   buildKeywordList: function()</span>
<a href="#l3.29"></a><span id="l3.29">   {</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineminus">-    var keywordsInCsv = this.prefs.getComplexValue(&quot;mail.compose.attachment_reminder_keywords&quot;,</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-                                                   Components.interfaces.nsIPrefLocalizedString);</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+    var keywordsInCsv = Services.prefs</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+      .getComplexValue(&quot;mail.compose.attachment_reminder_keywords&quot;,</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+                       Components.interfaces.nsIPrefLocalizedString);</span>
<a href="#l3.35"></a><span id="l3.35">     if (!keywordsInCsv)</span>
<a href="#l3.36"></a><span id="l3.36">       return;</span>
<a href="#l3.37"></a><span id="l3.37">     var keywordsInCsv = keywordsInCsv.data;</span>
<a href="#l3.38"></a><span id="l3.38">     var keywordsInArr = keywordsInCsv.split(&quot;,&quot;);</span>
<a href="#l3.39"></a><span id="l3.39">     for (var i = 0; i &lt; keywordsInArr.length; i++)</span>
<a href="#l3.40"></a><span id="l3.40">     {</span>
<a href="#l3.41"></a><span id="l3.41">       if (keywordsInArr[i])</span>
<a href="#l3.42"></a><span id="l3.42">         this.keywordListBox.appendItem(keywordsInArr[i], keywordsInArr[i]);</span>
<a href="#l3.43"></a><span id="l3.43">     }</span>
<a href="#l3.44"></a><span id="l3.44">     if (keywordsInArr.length)</span>
<a href="#l3.45"></a><span id="l3.45">       this.keywordListBox.selectedIndex = 0;</span>
<a href="#l3.46"></a><span id="l3.46">   },</span>
<a href="#l3.47"></a><span id="l3.47"> </span>
<a href="#l3.48"></a><span id="l3.48">   addKeyword: function()</span>
<a href="#l3.49"></a><span id="l3.49">   {</span>
<a href="#l3.50"></a><span id="l3.50">     var input = {value: &quot;&quot;}; // Default to empty.</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineminus">-    var ok = this.promptService.prompt(window,</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineminus">-                                       this.bundle.getString(&quot;attachmentReminderAddDialogTitle&quot;),</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineminus">-                                       this.bundle.getString(&quot;attachmentReminderAddText&quot;),</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineminus">-                                       input, null, {value:0});</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineplus">+    var ok = Services.prompt.prompt(window,</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineplus">+                                    this.bundle.getString(&quot;attachmentReminderAddDialogTitle&quot;),</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineplus">+                                    this.bundle.getString(&quot;attachmentReminderAddText&quot;),</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineplus">+                                    input, null, {value:0});</span>
<a href="#l3.59"></a><span id="l3.59">     if (ok &amp;&amp; input.value)</span>
<a href="#l3.60"></a><span id="l3.60">       this.keywordListBox.appendItem(input.value, input.value);</span>
<a href="#l3.61"></a><span id="l3.61">   },</span>
<a href="#l3.62"></a><span id="l3.62"> </span>
<a href="#l3.63"></a><span id="l3.63">   editKeyword: function()</span>
<a href="#l3.64"></a><span id="l3.64">   {</span>
<a href="#l3.65"></a><span id="l3.65">     if (this.keywordListBox.selectedIndex &lt; 0)</span>
<a href="#l3.66"></a><span id="l3.66">       return;</span>
<a href="#l3.67"></a><span id="l3.67">     var keywordToEdit = this.keywordListBox.getItemAtIndex(this.keywordListBox.selectedIndex);</span>
<a href="#l3.68"></a><span id="l3.68">     var input = {value: keywordToEdit.getAttribute(&quot;value&quot;)};</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineminus">-    var ok = this.promptService.prompt(window,</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineminus">-                                       this.bundle.getString(&quot;attachmentReminderEditDialogTitle&quot;),</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineminus">-                                       this.bundle.getString(&quot;attachmentReminderEditText&quot;),</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineminus">-                                       input, null, {value:0});</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineplus">+    var ok = Services.prompt.prompt(window,</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineplus">+                                    this.bundle.getString(&quot;attachmentReminderEditDialogTitle&quot;),</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineplus">+                                    this.bundle.getString(&quot;attachmentReminderEditText&quot;),</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineplus">+                                    input, null, {value:0});</span>
<a href="#l3.77"></a><span id="l3.77">     if (ok &amp;&amp; input.value) {</span>
<a href="#l3.78"></a><span id="l3.78">       this.keywordListBox.removeItemAt(this.keywordListBox.selectedIndex);</span>
<a href="#l3.79"></a><span id="l3.79">       this.keywordListBox.appendItem(input.value, input.value);</span>
<a href="#l3.80"></a><span id="l3.80">     }</span>
<a href="#l3.81"></a><span id="l3.81">   },</span>
<a href="#l3.82"></a><span id="l3.82"> </span>
<a href="#l3.83"></a><span id="l3.83">   removeKeyword: function()</span>
<a href="#l3.84"></a><span id="l3.84">   {</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineat">@@ -78,12 +75,12 @@ var gAttachmentReminderOptionsDialog = {</span>
<a href="#l3.86"></a><span id="l3.86">       keywordList += this.keywordListBox.getItemAtIndex(i).getAttribute(&quot;value&quot;);</span>
<a href="#l3.87"></a><span id="l3.87">       if (i != this.keywordListBox.getRowCount() - 1)</span>
<a href="#l3.88"></a><span id="l3.88">         keywordList += &quot;,&quot;;</span>
<a href="#l3.89"></a><span id="l3.89">     }</span>
<a href="#l3.90"></a><span id="l3.90"> </span>
<a href="#l3.91"></a><span id="l3.91">     var str = Components.classes[&quot;@mozilla.org/supports-string;1&quot;]</span>
<a href="#l3.92"></a><span id="l3.92">                         .createInstance(Components.interfaces.nsISupportsString);</span>
<a href="#l3.93"></a><span id="l3.93">     str.data = keywordList;</span>
<a href="#l3.94"></a><span id="l3.94" class="difflineminus">-    this.prefs.setComplexValue(&quot;mail.compose.attachment_reminder_keywords&quot;,</span>
<a href="#l3.95"></a><span id="l3.95" class="difflineminus">-                               Components.interfaces.nsISupportsString, str);</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineplus">+    Services.prefs.setComplexValue(&quot;mail.compose.attachment_reminder_keywords&quot;,</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineplus">+                                   Components.interfaces.nsISupportsString, str);</span>
<a href="#l3.98"></a><span id="l3.98">   }</span>
<a href="#l3.99"></a><span id="l3.99"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/components/preferences/connection.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/components/preferences/connection.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -74,21 +74,18 @@ var gConnectionsDialog = {</span>
<a href="#l4.4"></a><span id="l4.4">     // Disable the &quot;Reload PAC&quot; button if the selected proxy type is not PAC or</span>
<a href="#l4.5"></a><span id="l4.5">     // if the current value of the PAC textbox does not match the value stored</span>
<a href="#l4.6"></a><span id="l4.6">     // in prefs.  Likewise, disable the reload button if PAC is not configured</span>
<a href="#l4.7"></a><span id="l4.7">     // in prefs.</span>
<a href="#l4.8"></a><span id="l4.8"> </span>
<a href="#l4.9"></a><span id="l4.9">     var typedURL = document.getElementById(&quot;networkProxyAutoconfigURL&quot;).value;</span>
<a href="#l4.10"></a><span id="l4.10">     var proxyTypeCur = document.getElementById(&quot;network.proxy.type&quot;).value;</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-    var prefs =</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-        Components.classes[&quot;@mozilla.org/preferences-service;1&quot;].</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-        getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineminus">-    var pacURL = prefs.getCharPref(&quot;network.proxy.autoconfig_url&quot;);</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineminus">-    var proxyType = prefs.getIntPref(&quot;network.proxy.type&quot;);</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+    var pacURL = Services.prefs.getCharPref(&quot;network.proxy.autoconfig_url&quot;);</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+    var proxyType = Services.prefs.getIntPref(&quot;network.proxy.type&quot;);</span>
<a href="#l4.19"></a><span id="l4.19"> </span>
<a href="#l4.20"></a><span id="l4.20">     var disableReloadPref =</span>
<a href="#l4.21"></a><span id="l4.21">         document.getElementById(&quot;pref.advanced.proxies.disable_button.reload&quot;);</span>
<a href="#l4.22"></a><span id="l4.22">     disableReloadPref.disabled =</span>
<a href="#l4.23"></a><span id="l4.23">         (proxyTypeCur != 2 || proxyType != 2 || typedURL != pacURL);</span>
<a href="#l4.24"></a><span id="l4.24">   },</span>
<a href="#l4.25"></a><span id="l4.25"> </span>
<a href="#l4.26"></a><span id="l4.26">   readProxyType: function ()</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/components/preferences/cookies.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/components/preferences/cookies.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -1,46 +1,42 @@</span>
<a href="#l5.4"></a><span id="l5.4"> /* -*- Mode: Javascript; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l5.5"></a><span id="l5.5">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l5.6"></a><span id="l5.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l5.7"></a><span id="l5.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l5.8"></a><span id="l5.8"> </span>
<a href="#l5.9"></a><span id="l5.9" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l5.10"></a><span id="l5.10" class="difflineplus">+</span>
<a href="#l5.11"></a><span id="l5.11"> const nsICookie = Components.interfaces.nsICookie;</span>
<a href="#l5.12"></a><span id="l5.12"> </span>
<a href="#l5.13"></a><span id="l5.13"> var gCookiesWindow = {</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineminus">-  _cm               : Components.classes[&quot;@mozilla.org/cookiemanager;1&quot;]</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineminus">-                                .getService(Components.interfaces.nsICookieManager),</span>
<a href="#l5.16"></a><span id="l5.16">   _ds               : Components.classes[&quot;@mozilla.org/intl/scriptabledateformat;1&quot;]</span>
<a href="#l5.17"></a><span id="l5.17">                                 .getService(Components.interfaces.nsIScriptableDateFormat),</span>
<a href="#l5.18"></a><span id="l5.18">   _hosts            : {},</span>
<a href="#l5.19"></a><span id="l5.19">   _hostOrder        : [],</span>
<a href="#l5.20"></a><span id="l5.20">   _tree             : null,</span>
<a href="#l5.21"></a><span id="l5.21">   _bundle           : null,</span>
<a href="#l5.22"></a><span id="l5.22"> </span>
<a href="#l5.23"></a><span id="l5.23">   init: function ()</span>
<a href="#l5.24"></a><span id="l5.24">   {</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineminus">-    var os = Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineminus">-                       .getService(Components.interfaces.nsIObserverService);</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineminus">-    os.addObserver(this, &quot;cookie-changed&quot;, false);</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineminus">-    os.addObserver(this, &quot;perm-changed&quot;, false);</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineplus">+    Services.obs.addObserver(this, &quot;cookie-changed&quot;, false);</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineplus">+    Services.obs.addObserver(this, &quot;perm-changed&quot;, false);</span>
<a href="#l5.31"></a><span id="l5.31"> </span>
<a href="#l5.32"></a><span id="l5.32">     this._bundle = document.getElementById(&quot;bundlePreferences&quot;);</span>
<a href="#l5.33"></a><span id="l5.33">     this._tree = document.getElementById(&quot;cookiesList&quot;);</span>
<a href="#l5.34"></a><span id="l5.34"> </span>
<a href="#l5.35"></a><span id="l5.35">     this._populateList(true);</span>
<a href="#l5.36"></a><span id="l5.36"> </span>
<a href="#l5.37"></a><span id="l5.37">     document.getElementById(&quot;filter&quot;).focus();</span>
<a href="#l5.38"></a><span id="l5.38">   },</span>
<a href="#l5.39"></a><span id="l5.39"> </span>
<a href="#l5.40"></a><span id="l5.40">   uninit: function ()</span>
<a href="#l5.41"></a><span id="l5.41">   {</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineminus">-    var os = Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineminus">-                       .getService(Components.interfaces.nsIObserverService);</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineminus">-    os.removeObserver(this, &quot;cookie-changed&quot;);</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineminus">-    os.removeObserver(this, &quot;perm-changed&quot;);</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineplus">+    Services.obs.removeObserver(this, &quot;cookie-changed&quot;);</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineplus">+    Services.obs.removeObserver(this, &quot;perm-changed&quot;);</span>
<a href="#l5.48"></a><span id="l5.48">   },</span>
<a href="#l5.49"></a><span id="l5.49"> </span>
<a href="#l5.50"></a><span id="l5.50">   _populateList: function (aInitialLoad)</span>
<a href="#l5.51"></a><span id="l5.51">   {</span>
<a href="#l5.52"></a><span id="l5.52">     this._loadCookies();</span>
<a href="#l5.53"></a><span id="l5.53">     this._tree.treeBoxObject.view = this._view;</span>
<a href="#l5.54"></a><span id="l5.54">     if (aInitialLoad)</span>
<a href="#l5.55"></a><span id="l5.55">       this.sort(&quot;rawHost&quot;);</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineat">@@ -298,23 +294,23 @@ var gCookiesWindow = {</span>
<a href="#l5.57"></a><span id="l5.57">     {</span>
<a href="#l5.58"></a><span id="l5.58">       if (!this._filtered) {</span>
<a href="#l5.59"></a><span id="l5.59">         var item = this._getItemAtIndex(aIndex);</span>
<a href="#l5.60"></a><span id="l5.60">         if (!item)</span>
<a href="#l5.61"></a><span id="l5.61">           return &quot;&quot;;</span>
<a href="#l5.62"></a><span id="l5.62">         if (aColumn.id == &quot;domainCol&quot;)</span>
<a href="#l5.63"></a><span id="l5.63">           return item.rawHost;</span>
<a href="#l5.64"></a><span id="l5.64">         else if (aColumn.id == &quot;nameCol&quot;)</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineminus">-          return item.name;</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineplus">+          return (&quot;name&quot; in item) ? item.name : &quot;&quot;;</span>
<a href="#l5.67"></a><span id="l5.67">       }</span>
<a href="#l5.68"></a><span id="l5.68">       else {</span>
<a href="#l5.69"></a><span id="l5.69">         if (aColumn.id == &quot;domainCol&quot;)</span>
<a href="#l5.70"></a><span id="l5.70">           return this._filterSet[aIndex].rawHost;</span>
<a href="#l5.71"></a><span id="l5.71">         else if (aColumn.id == &quot;nameCol&quot;)</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineminus">-          return this._filterSet[aIndex].name;</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineplus">+          return (&quot;name&quot; in this._filterSet[aIndex]) ? this._filterSet[aIndex].name : &quot;&quot;;</span>
<a href="#l5.74"></a><span id="l5.74">       }</span>
<a href="#l5.75"></a><span id="l5.75">       return &quot;&quot;;</span>
<a href="#l5.76"></a><span id="l5.76">     },</span>
<a href="#l5.77"></a><span id="l5.77"> </span>
<a href="#l5.78"></a><span id="l5.78">     _selection: null,</span>
<a href="#l5.79"></a><span id="l5.79">     get selection () { return this._selection; },</span>
<a href="#l5.80"></a><span id="l5.80">     set selection (val) { this._selection = val; return val; },</span>
<a href="#l5.81"></a><span id="l5.81">     getRowProperties: function (aIndex, aProperties) {},</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineat">@@ -484,17 +480,17 @@ var gCookiesWindow = {</span>
<a href="#l5.83"></a><span id="l5.83">               expires     : aCookie.expires,</span>
<a href="#l5.84"></a><span id="l5.84">               level       : 1,</span>
<a href="#l5.85"></a><span id="l5.85">               container   : false };</span>
<a href="#l5.86"></a><span id="l5.86">     return c;</span>
<a href="#l5.87"></a><span id="l5.87">   },</span>
<a href="#l5.88"></a><span id="l5.88"> </span>
<a href="#l5.89"></a><span id="l5.89">   _loadCookies: function ()</span>
<a href="#l5.90"></a><span id="l5.90">   {</span>
<a href="#l5.91"></a><span id="l5.91" class="difflineminus">-    var e = this._cm.enumerator;</span>
<a href="#l5.92"></a><span id="l5.92" class="difflineplus">+    var e = Services.cookies.enumerator;</span>
<a href="#l5.93"></a><span id="l5.93">     var hostCount = { value: 0 };</span>
<a href="#l5.94"></a><span id="l5.94">     this._hosts = {};</span>
<a href="#l5.95"></a><span id="l5.95">     this._hostOrder = [];</span>
<a href="#l5.96"></a><span id="l5.96">     while (e.hasMoreElements()) {</span>
<a href="#l5.97"></a><span id="l5.97">       var cookie = e.getNext();</span>
<a href="#l5.98"></a><span id="l5.98">       if (cookie &amp;&amp; cookie instanceof Components.interfaces.nsICookie) {</span>
<a href="#l5.99"></a><span id="l5.99">         var strippedHost = this._makeStrippedHost(cookie.host);</span>
<a href="#l5.100"></a><span id="l5.100">         this._addCookie(strippedHost, cookie, hostCount);</span>
<a href="#l5.101"></a><span id="l5.101" class="difflineat">@@ -694,57 +690,58 @@ var gCookiesWindow = {</span>
<a href="#l5.102"></a><span id="l5.102">         var delta = max.value - min.value + 1;</span>
<a href="#l5.103"></a><span id="l5.103">         this._view._removeItemAtIndex(min.value, delta);</span>
<a href="#l5.104"></a><span id="l5.104">         rowCountImpact = -1 * delta;</span>
<a href="#l5.105"></a><span id="l5.105">         this._view._rowCount += rowCountImpact;</span>
<a href="#l5.106"></a><span id="l5.106">         tbo.rowCountChanged(min.value, rowCountImpact);</span>
<a href="#l5.107"></a><span id="l5.107">       }</span>
<a href="#l5.108"></a><span id="l5.108">     }</span>
<a href="#l5.109"></a><span id="l5.109"> </span>
<a href="#l5.110"></a><span id="l5.110" class="difflineminus">-    var psvc = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l5.111"></a><span id="l5.111" class="difflineminus">-                         .getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l5.112"></a><span id="l5.112">     var blockFutureCookies = false;</span>
<a href="#l5.113"></a><span id="l5.113" class="difflineminus">-    if (psvc.prefHasUserValue(&quot;network.cookie.blockFutureCookies&quot;))</span>
<a href="#l5.114"></a><span id="l5.114" class="difflineminus">-      blockFutureCookies = psvc.getBoolPref(&quot;network.cookie.blockFutureCookies&quot;);</span>
<a href="#l5.115"></a><span id="l5.115" class="difflineplus">+    if (Services.prefs.prefHasUserValue(&quot;network.cookie.blockFutureCookies&quot;))</span>
<a href="#l5.116"></a><span id="l5.116" class="difflineplus">+      blockFutureCookies = Services.prefs</span>
<a href="#l5.117"></a><span id="l5.117" class="difflineplus">+        .getBoolPref(&quot;network.cookie.blockFutureCookies&quot;);</span>
<a href="#l5.118"></a><span id="l5.118">     for (i = 0; i &lt; deleteItems.length; ++i) {</span>
<a href="#l5.119"></a><span id="l5.119">       var item = deleteItems[i];</span>
<a href="#l5.120"></a><span id="l5.120" class="difflineminus">-      this._cm.remove(item.host, item.name, item.path, blockFutureCookies);</span>
<a href="#l5.121"></a><span id="l5.121" class="difflineplus">+      Services.cookies.remove(item.host, item.name, item.path, blockFutureCookies);</span>
<a href="#l5.122"></a><span id="l5.122">     }</span>
<a href="#l5.123"></a><span id="l5.123"> </span>
<a href="#l5.124"></a><span id="l5.124">     if (nextSelected &lt; 0)</span>
<a href="#l5.125"></a><span id="l5.125">       seln.clearSelection();</span>
<a href="#l5.126"></a><span id="l5.126">     else {</span>
<a href="#l5.127"></a><span id="l5.127">       seln.select(nextSelected);</span>
<a href="#l5.128"></a><span id="l5.128">       this._tree.focus();</span>
<a href="#l5.129"></a><span id="l5.129">     }</span>
<a href="#l5.130"></a><span id="l5.130">   },</span>
<a href="#l5.131"></a><span id="l5.131"> </span>
<a href="#l5.132"></a><span id="l5.132">   deleteAllCookies: function ()</span>
<a href="#l5.133"></a><span id="l5.133">   {</span>
<a href="#l5.134"></a><span id="l5.134" class="difflineminus">-    this._cm.removeAll();</span>
<a href="#l5.135"></a><span id="l5.135" class="difflineplus">+    Services.cookies.removeAll();</span>
<a href="#l5.136"></a><span id="l5.136">     this._tree.focus();</span>
<a href="#l5.137"></a><span id="l5.137">   },</span>
<a href="#l5.138"></a><span id="l5.138"> </span>
<a href="#l5.139"></a><span id="l5.139">   onCookieKeyPress: function (aEvent)</span>
<a href="#l5.140"></a><span id="l5.140">   {</span>
<a href="#l5.141"></a><span id="l5.141">     if (aEvent.keyCode == 46)</span>
<a href="#l5.142"></a><span id="l5.142">       this.deleteCookie();</span>
<a href="#l5.143"></a><span id="l5.143">   },</span>
<a href="#l5.144"></a><span id="l5.144"> </span>
<a href="#l5.145"></a><span id="l5.145">   _lastSortProperty : &quot;&quot;,</span>
<a href="#l5.146"></a><span id="l5.146">   _lastSortAscending: false,</span>
<a href="#l5.147"></a><span id="l5.147">   sort: function (aProperty)</span>
<a href="#l5.148"></a><span id="l5.148">   {</span>
<a href="#l5.149"></a><span id="l5.149">     var ascending = (aProperty == this._lastSortProperty) ? !this._lastSortAscending : true;</span>
<a href="#l5.150"></a><span id="l5.150" class="difflineplus">+</span>
<a href="#l5.151"></a><span id="l5.151" class="difflineplus">+    function sortByHost(a, b)</span>
<a href="#l5.152"></a><span id="l5.152" class="difflineplus">+    {</span>
<a href="#l5.153"></a><span id="l5.153" class="difflineplus">+      return a.toLowerCase().localeCompare(b.toLowerCase());</span>
<a href="#l5.154"></a><span id="l5.154" class="difflineplus">+    }</span>
<a href="#l5.155"></a><span id="l5.155" class="difflineplus">+</span>
<a href="#l5.156"></a><span id="l5.156">     // Sort the Non-Filtered Host Collections</span>
<a href="#l5.157"></a><span id="l5.157">     if (aProperty == &quot;rawHost&quot;) {</span>
<a href="#l5.158"></a><span id="l5.158" class="difflineminus">-      function sortByHost(a, b)</span>
<a href="#l5.159"></a><span id="l5.159" class="difflineminus">-      {</span>
<a href="#l5.160"></a><span id="l5.160" class="difflineminus">-        return a.toLowerCase().localeCompare(b.toLowerCase());</span>
<a href="#l5.161"></a><span id="l5.161" class="difflineminus">-      }</span>
<a href="#l5.162"></a><span id="l5.162">       this._hostOrder.sort(sortByHost);</span>
<a href="#l5.163"></a><span id="l5.163">       if (!ascending)</span>
<a href="#l5.164"></a><span id="l5.164">         this._hostOrder.reverse();</span>
<a href="#l5.165"></a><span id="l5.165">     }</span>
<a href="#l5.166"></a><span id="l5.166"> </span>
<a href="#l5.167"></a><span id="l5.167">     function sortByProperty(a, b)</span>
<a href="#l5.168"></a><span id="l5.168">     {</span>
<a href="#l5.169"></a><span id="l5.169">       return a[aProperty].toLowerCase().localeCompare(b[aProperty].toLowerCase());</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/components/preferences/downloads.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/components/preferences/downloads.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -74,20 +74,18 @@ var gDownloadDirSection = {</span>
<a href="#l6.4"></a><span id="l6.4"> #else</span>
<a href="#l6.5"></a><span id="l6.5">     return &quot;Home&quot;;</span>
<a href="#l6.6"></a><span id="l6.6"> #endif</span>
<a href="#l6.7"></a><span id="l6.7"> #endif</span>
<a href="#l6.8"></a><span id="l6.8">   },</span>
<a href="#l6.9"></a><span id="l6.9"> </span>
<a href="#l6.10"></a><span id="l6.10">   _getDownloadsFolder: function (aFolder)</span>
<a href="#l6.11"></a><span id="l6.11">   {</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-    var fileLocator = Components.classes[&quot;@mozilla.org/file/directory_service;1&quot;]</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-                                .getService(Components.interfaces.nsIProperties);</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-    var dir = fileLocator.get(this._getSpecialFolderKey(aFolder),</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineminus">-                              Components.interfaces.nsILocalFile);</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+    let dir = Services.dirsvc.get(this._getSpecialFolderKey(aFolder),</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+                                  Components.interfaces.nsILocalFile);</span>
<a href="#l6.18"></a><span id="l6.18">     if (aFolder != &quot;Desktop&quot;)</span>
<a href="#l6.19"></a><span id="l6.19">       dir.append(&quot;My Downloads&quot;);</span>
<a href="#l6.20"></a><span id="l6.20"> </span>
<a href="#l6.21"></a><span id="l6.21">     return dir;</span>
<a href="#l6.22"></a><span id="l6.22">   },</span>
<a href="#l6.23"></a><span id="l6.23"> </span>
<a href="#l6.24"></a><span id="l6.24">   readDownloadDirPref: function ()</span>
<a href="#l6.25"></a><span id="l6.25">   {</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineat">@@ -99,24 +97,23 @@ var gDownloadDirSection = {</span>
<a href="#l6.27"></a><span id="l6.27">     var customIndex = customDirPref.value ? this._fileToIndex(customDirPref.value) : 0;</span>
<a href="#l6.28"></a><span id="l6.28">     if (folderListPref.value == 0 || customIndex == 0)</span>
<a href="#l6.29"></a><span id="l6.29">       downloadFolder.label = bundlePreferences.getString(&quot;desktopFolderName&quot;);</span>
<a href="#l6.30"></a><span id="l6.30">     else if (folderListPref.value == 1 || customIndex == 1) </span>
<a href="#l6.31"></a><span id="l6.31">       downloadFolder.label = bundlePreferences.getString(&quot;myDownloadsFolderName&quot;);</span>
<a href="#l6.32"></a><span id="l6.32">     else</span>
<a href="#l6.33"></a><span id="l6.33">       downloadFolder.label = customDirPref.value ? customDirPref.value.path : &quot;&quot;;</span>
<a href="#l6.34"></a><span id="l6.34"> </span>
<a href="#l6.35"></a><span id="l6.35" class="difflineminus">-    var ios = Components.classes[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineminus">-                        .getService(Components.interfaces.nsIIOService);</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineminus">-    var fph = ios.getProtocolHandler(&quot;file&quot;)</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineminus">-                 .QueryInterface(Components.interfaces.nsIFileProtocolHandler);</span>
<a href="#l6.39"></a><span id="l6.39">     var currentDirPref = document.getElementById(&quot;browser.download.downloadDir&quot;);</span>
<a href="#l6.40"></a><span id="l6.40">     var downloadDir = currentDirPref.value || this._indexToFile(folderListPref.value);</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineminus">-    var urlspec = fph.getURLSpecFromFile(downloadDir);</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineminus">-    downloadFolder.image = &quot;moz-icon://&quot; + urlspec + &quot;?size=16&quot;;</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineplus">+    let urlSpec = Services.io.getProtocolHandler(&quot;file&quot;)</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineplus">+      .QueryInterface(Components.interfaces.nsIFileProtocolHandler)</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineplus">+      .getURLSpecFromFile(downloadDir);</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineplus">+</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineplus">+    downloadFolder.image = &quot;moz-icon://&quot; + urlSpec + &quot;?size=16&quot;;</span>
<a href="#l6.48"></a><span id="l6.48"> </span>
<a href="#l6.49"></a><span id="l6.49">     return undefined;</span>
<a href="#l6.50"></a><span id="l6.50">   },</span>
<a href="#l6.51"></a><span id="l6.51"> </span>
<a href="#l6.52"></a><span id="l6.52">   writeFolderList: function ()</span>
<a href="#l6.53"></a><span id="l6.53">   {</span>
<a href="#l6.54"></a><span id="l6.54">     var currentDirPref = document.getElementById(&quot;browser.download.downloadDir&quot;);</span>
<a href="#l6.55"></a><span id="l6.55">     return this._fileToIndex(currentDirPref.value);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mail/components/preferences/fonts.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mail/components/preferences/fonts.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -1,13 +1,15 @@</span>
<a href="#l7.4"></a><span id="l7.4"> /* -*- Mode: JavaScript; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l7.5"></a><span id="l7.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l7.6"></a><span id="l7.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l7.7"></a><span id="l7.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l7.8"></a><span id="l7.8"> </span>
<a href="#l7.9"></a><span id="l7.9" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l7.10"></a><span id="l7.10" class="difflineplus">+</span>
<a href="#l7.11"></a><span id="l7.11"> const kDefaultFontType          = &quot;font.default.%LANG%&quot;;</span>
<a href="#l7.12"></a><span id="l7.12"> const kFontNameFmtSerif         = &quot;font.name.serif.%LANG%&quot;;</span>
<a href="#l7.13"></a><span id="l7.13"> const kFontNameFmtSansSerif     = &quot;font.name.sans-serif.%LANG%&quot;;</span>
<a href="#l7.14"></a><span id="l7.14"> const kFontNameFmtMonospace     = &quot;font.name.monospace.%LANG%&quot;;</span>
<a href="#l7.15"></a><span id="l7.15"> const kFontNameListFmtSerif     = &quot;font.name-list.serif.%LANG%&quot;;</span>
<a href="#l7.16"></a><span id="l7.16"> const kFontNameListFmtSansSerif = &quot;font.name-list.sans-serif.%LANG%&quot;;</span>
<a href="#l7.17"></a><span id="l7.17"> const kFontNameListFmtMonospace = &quot;font.name-list.monospace.%LANG%&quot;;</span>
<a href="#l7.18"></a><span id="l7.18"> const kFontSizeFmtVariable      = &quot;font.size.variable.%LANG%&quot;;</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineat">@@ -167,19 +169,17 @@ var gFontsDialog = {</span>
<a href="#l7.20"></a><span id="l7.20">     }</span>
<a href="#l7.21"></a><span id="l7.21">   },</span>
<a href="#l7.22"></a><span id="l7.22"> </span>
<a href="#l7.23"></a><span id="l7.23">   mCharsetMenuInitialized: false,</span>
<a href="#l7.24"></a><span id="l7.24">   readDefaultCharset: function()</span>
<a href="#l7.25"></a><span id="l7.25">   {</span>
<a href="#l7.26"></a><span id="l7.26">     if (!this.mCharsetMenuInitialized)</span>
<a href="#l7.27"></a><span id="l7.27">     {</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineminus">-      Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineminus">-                .getService(Components.interfaces.nsIObserverService)</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineminus">-                .notifyObservers(null, &quot;charsetmenu-selected&quot;, &quot;mailedit&quot;);</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineplus">+      Services.obs.notifyObservers(null, &quot;charsetmenu-selected&quot;, &quot;mailedit&quot;);</span>
<a href="#l7.32"></a><span id="l7.32">       // build the charset menu list. We do this by hand instead of using the xul template</span>
<a href="#l7.33"></a><span id="l7.33">       // builder because of Bug #285076,</span>
<a href="#l7.34"></a><span id="l7.34">       this.createCharsetMenus(document.getElementById(&quot;sendDefaultCharset-menupopup&quot;), &quot;NC:MaileditCharsetMenuRoot&quot;,</span>
<a href="#l7.35"></a><span id="l7.35">                               document.getElementById('mailnews.send_default_charset').value);</span>
<a href="#l7.36"></a><span id="l7.36">       this.mCharsetMenuInitialized = true;</span>
<a href="#l7.37"></a><span id="l7.37">     }</span>
<a href="#l7.38"></a><span id="l7.38">     return undefined;</span>
<a href="#l7.39"></a><span id="l7.39">   },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mail/components/preferences/general.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mail/components/preferences/general.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -26,83 +26,77 @@ var gGeneralPane = {</span>
<a href="#l8.4"></a><span id="l8.4">   /**</span>
<a href="#l8.5"></a><span id="l8.5">    * Returns a formatted url corresponding to the value of mailnews.start_page.url </span>
<a href="#l8.6"></a><span id="l8.6">    * Stores the original value of mailnews.start_page.url </span>
<a href="#l8.7"></a><span id="l8.7">    */</span>
<a href="#l8.8"></a><span id="l8.8">   readStartPageUrl: function()</span>
<a href="#l8.9"></a><span id="l8.9">   {</span>
<a href="#l8.10"></a><span id="l8.10">     var pref = document.getElementById(&quot;mailnews.start_page.url&quot;);</span>
<a href="#l8.11"></a><span id="l8.11">     this.mStartPageUrl = pref.value;</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-    var formatter = Components.classes[&quot;@mozilla.org/toolkit/URLFormatterService;1&quot;].</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-                               getService(Components.interfaces.nsIURLFormatter);</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineminus">-    return formatter.formatURL(this.mStartPageUrl);</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+    return Services.urlFormatter.formatURL(this.mStartPageUrl);</span>
<a href="#l8.16"></a><span id="l8.16">   },</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineminus">-  </span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+</span>
<a href="#l8.19"></a><span id="l8.19">   /**</span>
<a href="#l8.20"></a><span id="l8.20">    * Returns the value of the mailnews start page url represented by the UI.</span>
<a href="#l8.21"></a><span id="l8.21">    * If the url matches the formatted version of our stored value, then </span>
<a href="#l8.22"></a><span id="l8.22">    * return the unformatted url.</span>
<a href="#l8.23"></a><span id="l8.23">    */</span>
<a href="#l8.24"></a><span id="l8.24">   writeStartPageUrl: function()</span>
<a href="#l8.25"></a><span id="l8.25">   {</span>
<a href="#l8.26"></a><span id="l8.26">     var startPage = document.getElementById('mailnewsStartPageUrl');</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineminus">-    var formatter = Components.classes[&quot;@mozilla.org/toolkit/URLFormatterService;1&quot;].</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineminus">-                               getService(Components.interfaces.nsIURLFormatter);</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineminus">-    return formatter.formatURL(this.mStartPageUrl) == startPage.value ? this.mStartPageUrl : startPage.value;         </span>
<a href="#l8.30"></a><span id="l8.30" class="difflineplus">+    return Services.urlFormatter.formatURL(this.mStartPageUrl) == startPage.value ? this.mStartPageUrl : startPage.value;</span>
<a href="#l8.31"></a><span id="l8.31">   },</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineminus">-  </span>
<a href="#l8.33"></a><span id="l8.33" class="difflineplus">+</span>
<a href="#l8.34"></a><span id="l8.34">   customizeMailAlert: function()</span>
<a href="#l8.35"></a><span id="l8.35">   {</span>
<a href="#l8.36"></a><span id="l8.36">     document.documentElement</span>
<a href="#l8.37"></a><span id="l8.37">             .openSubDialog(&quot;chrome://messenger/content/preferences/notifications.xul&quot;,</span>
<a href="#l8.38"></a><span id="l8.38">                             &quot;&quot;, null);</span>
<a href="#l8.39"></a><span id="l8.39">   },</span>
<a href="#l8.40"></a><span id="l8.40">   </span>
<a href="#l8.41"></a><span id="l8.41">   convertURLToLocalFile: function(aFileURL)</span>
<a href="#l8.42"></a><span id="l8.42">   {</span>
<a href="#l8.43"></a><span id="l8.43">     // convert the file url into a nsILocalFile</span>
<a href="#l8.44"></a><span id="l8.44">     if (aFileURL)</span>
<a href="#l8.45"></a><span id="l8.45">     {</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineminus">-      var ios = Components.classes[&quot;@mozilla.org/network/io-service;1&quot;].getService(Components.interfaces.nsIIOService);</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineminus">-      var fph = ios.getProtocolHandler(&quot;file&quot;).QueryInterface(Components.interfaces.nsIFileProtocolHandler);</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineminus">-      return fph.getFileFromURLSpec(aFileURL);</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineminus">-    } </span>
<a href="#l8.50"></a><span id="l8.50" class="difflineplus">+      return Services.io</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+                     .getProtocolHandler(&quot;file&quot;)</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineplus">+                     .QueryInterface(Components.interfaces.nsIFileProtocolHandler)</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineplus">+                     .getFileFromURLSpec(aFileURL);</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineplus">+    }</span>
<a href="#l8.55"></a><span id="l8.55">     else</span>
<a href="#l8.56"></a><span id="l8.56">       return null;</span>
<a href="#l8.57"></a><span id="l8.57">   },</span>
<a href="#l8.58"></a><span id="l8.58"> </span>
<a href="#l8.59"></a><span id="l8.59">   readSoundLocation: function()</span>
<a href="#l8.60"></a><span id="l8.60">   {</span>
<a href="#l8.61"></a><span id="l8.61">     var soundUrlLocation = document.getElementById(&quot;soundUrlLocation&quot;);</span>
<a href="#l8.62"></a><span id="l8.62">     soundUrlLocation.value = document.getElementById(&quot;mail.biff.play_sound.url&quot;).value;</span>
<a href="#l8.63"></a><span id="l8.63">     if (soundUrlLocation.value)</span>
<a href="#l8.64"></a><span id="l8.64">     {</span>
<a href="#l8.65"></a><span id="l8.65">       soundUrlLocation.label = this.convertURLToLocalFile(soundUrlLocation.value).leafName;</span>
<a href="#l8.66"></a><span id="l8.66">       soundUrlLocation.image = &quot;moz-icon://&quot; + soundUrlLocation.label + &quot;?size=16&quot;;</span>
<a href="#l8.67"></a><span id="l8.67">     }</span>
<a href="#l8.68"></a><span id="l8.68">     return undefined;</span>
<a href="#l8.69"></a><span id="l8.69">   },</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineminus">-  </span>
<a href="#l8.71"></a><span id="l8.71" class="difflineplus">+</span>
<a href="#l8.72"></a><span id="l8.72">   previewSound: function ()</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineminus">-  {  </span>
<a href="#l8.74"></a><span id="l8.74" class="difflineplus">+  {</span>
<a href="#l8.75"></a><span id="l8.75">     sound = Components.classes[&quot;@mozilla.org/sound;1&quot;].createInstance(Components.interfaces.nsISound);</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineminus">-    </span>
<a href="#l8.77"></a><span id="l8.77" class="difflineplus">+</span>
<a href="#l8.78"></a><span id="l8.78">     var soundLocation;</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineminus">-    soundLocation = document.getElementById('soundType').value == 1 ? </span>
<a href="#l8.80"></a><span id="l8.80" class="difflineplus">+    soundLocation = document.getElementById('soundType').value == 1 ?</span>
<a href="#l8.81"></a><span id="l8.81">                     document.getElementById('soundUrlLocation').value : &quot;_moz_mailbeep&quot;</span>
<a href="#l8.82"></a><span id="l8.82"> </span>
<a href="#l8.83"></a><span id="l8.83" class="difflineminus">-    if (soundLocation.indexOf(&quot;file://&quot;) == -1) </span>
<a href="#l8.84"></a><span id="l8.84" class="difflineplus">+    if (soundLocation.indexOf(&quot;file://&quot;) == -1)</span>
<a href="#l8.85"></a><span id="l8.85">       sound.playSystemSound(soundLocation);</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineminus">-    else </span>
<a href="#l8.87"></a><span id="l8.87" class="difflineminus">-    {</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineminus">-      var ioService = Components.classes[&quot;@mozilla.org/network/io-service;1&quot;].getService(Components.interfaces.nsIIOService);</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineminus">-      sound.play(ioService.newURI(soundLocation, null, null));</span>
<a href="#l8.90"></a><span id="l8.90" class="difflineminus">-    }</span>
<a href="#l8.91"></a><span id="l8.91" class="difflineplus">+    else</span>
<a href="#l8.92"></a><span id="l8.92" class="difflineplus">+      sound.play(Services.io.newURI(soundLocation, null, null));</span>
<a href="#l8.93"></a><span id="l8.93">   },</span>
<a href="#l8.94"></a><span id="l8.94" class="difflineminus">-  </span>
<a href="#l8.95"></a><span id="l8.95" class="difflineplus">+</span>
<a href="#l8.96"></a><span id="l8.96">   browseForSoundFile: function ()</span>
<a href="#l8.97"></a><span id="l8.97">   {</span>
<a href="#l8.98"></a><span id="l8.98">     const nsIFilePicker = Components.interfaces.nsIFilePicker;</span>
<a href="#l8.99"></a><span id="l8.99">     var fp = Components.classes[&quot;@mozilla.org/filepicker;1&quot;].createInstance(nsIFilePicker);</span>
<a href="#l8.100"></a><span id="l8.100"> </span>
<a href="#l8.101"></a><span id="l8.101">     // if we already have a sound file, then use the path for that sound file</span>
<a href="#l8.102"></a><span id="l8.102">     // as the initial path in the dialog.</span>
<a href="#l8.103"></a><span id="l8.103">     var localFile = this.convertURLToLocalFile(document.getElementById('soundUrlLocation').value);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mail/components/preferences/permissions.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mail/components/preferences/permissions.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -1,29 +1,29 @@</span>
<a href="#l9.4"></a><span id="l9.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l9.5"></a><span id="l9.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l9.6"></a><span id="l9.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l9.7"></a><span id="l9.7"> </span>
<a href="#l9.8"></a><span id="l9.8" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l9.9"></a><span id="l9.9" class="difflineplus">+</span>
<a href="#l9.10"></a><span id="l9.10"> const nsIPermissionManager = Components.interfaces.nsIPermissionManager;</span>
<a href="#l9.11"></a><span id="l9.11"> const nsICookiePermission = Components.interfaces.nsICookiePermission;</span>
<a href="#l9.12"></a><span id="l9.12"> </span>
<a href="#l9.13"></a><span id="l9.13"> function Permission(host, rawHost, type, capability, perm)</span>
<a href="#l9.14"></a><span id="l9.14"> {</span>
<a href="#l9.15"></a><span id="l9.15">   this.host = host;</span>
<a href="#l9.16"></a><span id="l9.16">   this.rawHost = rawHost;</span>
<a href="#l9.17"></a><span id="l9.17">   this.type = type;</span>
<a href="#l9.18"></a><span id="l9.18">   this.capability = capability;</span>
<a href="#l9.19"></a><span id="l9.19">   this.perm = perm;</span>
<a href="#l9.20"></a><span id="l9.20"> }</span>
<a href="#l9.21"></a><span id="l9.21"> </span>
<a href="#l9.22"></a><span id="l9.22"> var gPermissionManager = {</span>
<a href="#l9.23"></a><span id="l9.23">   _type         : &quot;&quot;,</span>
<a href="#l9.24"></a><span id="l9.24">   _permissions  : [],</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineminus">-  _pm           : Components.classes[&quot;@mozilla.org/permissionmanager;1&quot;]</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineminus">-                            .getService(Components.interfaces.nsIPermissionManager),</span>
<a href="#l9.27"></a><span id="l9.27">   _bundle       : null,</span>
<a href="#l9.28"></a><span id="l9.28">   _tree         : null,</span>
<a href="#l9.29"></a><span id="l9.29"> </span>
<a href="#l9.30"></a><span id="l9.30">   _view: {</span>
<a href="#l9.31"></a><span id="l9.31">     _rowCount: 0,</span>
<a href="#l9.32"></a><span id="l9.32">     get rowCount()</span>
<a href="#l9.33"></a><span id="l9.33">     {</span>
<a href="#l9.34"></a><span id="l9.34">       return this._rowCount;</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineat">@@ -70,26 +70,22 @@ var gPermissionManager = {</span>
<a href="#l9.36"></a><span id="l9.36">     return this._bundle.getString(stringKey);</span>
<a href="#l9.37"></a><span id="l9.37">   },</span>
<a href="#l9.38"></a><span id="l9.38"> </span>
<a href="#l9.39"></a><span id="l9.39">   addPermission: function (aCapability)</span>
<a href="#l9.40"></a><span id="l9.40">   {</span>
<a href="#l9.41"></a><span id="l9.41">     var textbox = document.getElementById(&quot;url&quot;);</span>
<a href="#l9.42"></a><span id="l9.42">     var host = textbox.value.replace(/^\s*([-\w]*:\/+)?/, &quot;&quot;); // trim any leading space and scheme</span>
<a href="#l9.43"></a><span id="l9.43">     try {</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineminus">-      var ioService = Components.classes[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineminus">-                                .getService(Components.interfaces.nsIIOService);</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineminus">-      var uri = ioService.newURI(&quot;http://&quot;+host, null, null);</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineplus">+      var uri = Services.io.newURI(&quot;http://&quot; + host, null, null);</span>
<a href="#l9.48"></a><span id="l9.48">       host = uri.host;</span>
<a href="#l9.49"></a><span id="l9.49">     } catch(ex) {</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineminus">-      var promptService = Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineminus">-                                    .getService(Components.interfaces.nsIPromptService);</span>
<a href="#l9.52"></a><span id="l9.52">       var message = this._bundle.getString(&quot;invalidURI&quot;);</span>
<a href="#l9.53"></a><span id="l9.53">       var title = this._bundle.getString(&quot;invalidURITitle&quot;);</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineminus">-      promptService.alert(window, title, message);</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineplus">+      Services.prompt.alert(window, title, message);</span>
<a href="#l9.56"></a><span id="l9.56">       return;</span>
<a href="#l9.57"></a><span id="l9.57">     }</span>
<a href="#l9.58"></a><span id="l9.58"> </span>
<a href="#l9.59"></a><span id="l9.59">     var capabilityString = this._getCapabilityString(aCapability);</span>
<a href="#l9.60"></a><span id="l9.60"> </span>
<a href="#l9.61"></a><span id="l9.61">     // check whether the permission already exists, if not, add it</span>
<a href="#l9.62"></a><span id="l9.62">     var exists = false;</span>
<a href="#l9.63"></a><span id="l9.63">     for (var i = 0; i &lt; this._permissions.length; ++i) {</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineat">@@ -99,18 +95,18 @@ var gPermissionManager = {</span>
<a href="#l9.65"></a><span id="l9.65">         // update the listbox for us.</span>
<a href="#l9.66"></a><span id="l9.66">         exists = this._permissions[i].perm == aCapability;</span>
<a href="#l9.67"></a><span id="l9.67">         break;</span>
<a href="#l9.68"></a><span id="l9.68">       }</span>
<a href="#l9.69"></a><span id="l9.69">     }</span>
<a href="#l9.70"></a><span id="l9.70"> </span>
<a href="#l9.71"></a><span id="l9.71">     if (!exists) {</span>
<a href="#l9.72"></a><span id="l9.72">       host = (host.charAt(0) == &quot;.&quot;) ? host.substring(1,host.length) : host;</span>
<a href="#l9.73"></a><span id="l9.73" class="difflineminus">-      var uri = ioService.newURI(&quot;http://&quot; + host, null, null);</span>
<a href="#l9.74"></a><span id="l9.74" class="difflineminus">-      this._pm.add(uri, this._type, aCapability);</span>
<a href="#l9.75"></a><span id="l9.75" class="difflineplus">+      var uri = Services.io.newURI(&quot;http://&quot; + host, null, null);</span>
<a href="#l9.76"></a><span id="l9.76" class="difflineplus">+      Services.perms.add(uri, this._type, aCapability);</span>
<a href="#l9.77"></a><span id="l9.77">     }</span>
<a href="#l9.78"></a><span id="l9.78">     textbox.value = &quot;&quot;;</span>
<a href="#l9.79"></a><span id="l9.79">     textbox.focus();</span>
<a href="#l9.80"></a><span id="l9.80"> </span>
<a href="#l9.81"></a><span id="l9.81">     // covers a case where the site exists already, so the buttons don't disable</span>
<a href="#l9.82"></a><span id="l9.82">     this.onHostInput(textbox);</span>
<a href="#l9.83"></a><span id="l9.83"> </span>
<a href="#l9.84"></a><span id="l9.84">     // enable &quot;remove all&quot; button as needed</span>
<a href="#l9.85"></a><span id="l9.85" class="difflineat">@@ -164,34 +160,30 @@ var gPermissionManager = {</span>
<a href="#l9.86"></a><span id="l9.86">     urlField.value = aParams.prefilledHost;</span>
<a href="#l9.87"></a><span id="l9.87">     urlField.hidden = !urlFieldVisible;</span>
<a href="#l9.88"></a><span id="l9.88"> </span>
<a href="#l9.89"></a><span id="l9.89">     this.onHostInput(urlField);</span>
<a href="#l9.90"></a><span id="l9.90"> </span>
<a href="#l9.91"></a><span id="l9.91">     var urlLabel = document.getElementById(&quot;urlLabel&quot;);</span>
<a href="#l9.92"></a><span id="l9.92">     urlLabel.hidden = !urlFieldVisible;</span>
<a href="#l9.93"></a><span id="l9.93"> </span>
<a href="#l9.94"></a><span id="l9.94" class="difflineminus">-    var os = Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l9.95"></a><span id="l9.95" class="difflineminus">-                       .getService(Components.interfaces.nsIObserverService);</span>
<a href="#l9.96"></a><span id="l9.96" class="difflineminus">-    os.addObserver(this, &quot;perm-changed&quot;, false);</span>
<a href="#l9.97"></a><span id="l9.97" class="difflineplus">+    Services.obs.addObserver(this, &quot;perm-changed&quot;, false);</span>
<a href="#l9.98"></a><span id="l9.98"> </span>
<a href="#l9.99"></a><span id="l9.99">     this._loadPermissions();</span>
<a href="#l9.100"></a><span id="l9.100"> </span>
<a href="#l9.101"></a><span id="l9.101">     urlField.focus();</span>
<a href="#l9.102"></a><span id="l9.102"> </span>
<a href="#l9.103"></a><span id="l9.103">     this._ltrAtom = Components.classes[&quot;@mozilla.org/atom-service;1&quot;]</span>
<a href="#l9.104"></a><span id="l9.104">                               .getService(Components.interfaces.nsIAtomService)</span>
<a href="#l9.105"></a><span id="l9.105">                               .getAtom(&quot;ltr&quot;);</span>
<a href="#l9.106"></a><span id="l9.106">   },</span>
<a href="#l9.107"></a><span id="l9.107"> </span>
<a href="#l9.108"></a><span id="l9.108">   uninit: function ()</span>
<a href="#l9.109"></a><span id="l9.109">   {</span>
<a href="#l9.110"></a><span id="l9.110" class="difflineminus">-    var os = Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l9.111"></a><span id="l9.111" class="difflineminus">-                       .getService(Components.interfaces.nsIObserverService);</span>
<a href="#l9.112"></a><span id="l9.112" class="difflineminus">-    os.removeObserver(this, &quot;perm-changed&quot;);</span>
<a href="#l9.113"></a><span id="l9.113" class="difflineplus">+    Services.obs.removeObserver(this, &quot;perm-changed&quot;);</span>
<a href="#l9.114"></a><span id="l9.114">   },</span>
<a href="#l9.115"></a><span id="l9.115"> </span>
<a href="#l9.116"></a><span id="l9.116">   observe: function (aSubject, aTopic, aData)</span>
<a href="#l9.117"></a><span id="l9.117">   {</span>
<a href="#l9.118"></a><span id="l9.118">     if (aTopic == &quot;perm-changed&quot;) {</span>
<a href="#l9.119"></a><span id="l9.119">       var permission = aSubject.QueryInterface(Components.interfaces.nsIPermission);</span>
<a href="#l9.120"></a><span id="l9.120">       if (aData == &quot;added&quot;) {</span>
<a href="#l9.121"></a><span id="l9.121">         this._addPermissionToList(permission);</span>
<a href="#l9.122"></a><span id="l9.122" class="difflineat">@@ -237,31 +229,31 @@ var gPermissionManager = {</span>
<a href="#l9.123"></a><span id="l9.123">   onPermissionDeleted: function ()</span>
<a href="#l9.124"></a><span id="l9.124">   {</span>
<a href="#l9.125"></a><span id="l9.125">     if (!this._view.rowCount)</span>
<a href="#l9.126"></a><span id="l9.126">       return;</span>
<a href="#l9.127"></a><span id="l9.127">     var removedPermissions = [];</span>
<a href="#l9.128"></a><span id="l9.128">     gTreeUtils.deleteSelectedItems(this._tree, this._view, this._permissions, removedPermissions);</span>
<a href="#l9.129"></a><span id="l9.129">     for (var i = 0; i &lt; removedPermissions.length; ++i) {</span>
<a href="#l9.130"></a><span id="l9.130">       var p = removedPermissions[i];</span>
<a href="#l9.131"></a><span id="l9.131" class="difflineminus">-      this._pm.remove(p.host, p.type);</span>
<a href="#l9.132"></a><span id="l9.132" class="difflineplus">+      Services.perms.remove(p.host, p.type);</span>
<a href="#l9.133"></a><span id="l9.133">     }</span>
<a href="#l9.134"></a><span id="l9.134">     document.getElementById(&quot;removePermission&quot;).disabled = !this._permissions.length;</span>
<a href="#l9.135"></a><span id="l9.135">     document.getElementById(&quot;removeAllPermissions&quot;).disabled = !this._permissions.length;</span>
<a href="#l9.136"></a><span id="l9.136">   },</span>
<a href="#l9.137"></a><span id="l9.137"> </span>
<a href="#l9.138"></a><span id="l9.138">   onAllPermissionsDeleted: function ()</span>
<a href="#l9.139"></a><span id="l9.139">   {</span>
<a href="#l9.140"></a><span id="l9.140">     if (!this._view.rowCount)</span>
<a href="#l9.141"></a><span id="l9.141">       return;</span>
<a href="#l9.142"></a><span id="l9.142">     var removedPermissions = [];</span>
<a href="#l9.143"></a><span id="l9.143">     gTreeUtils.deleteAll(this._tree, this._view, this._permissions, removedPermissions);</span>
<a href="#l9.144"></a><span id="l9.144">     for (var i = 0; i &lt; removedPermissions.length; ++i) {</span>
<a href="#l9.145"></a><span id="l9.145">       var p = removedPermissions[i];</span>
<a href="#l9.146"></a><span id="l9.146" class="difflineminus">-      this._pm.remove(p.host, p.type);</span>
<a href="#l9.147"></a><span id="l9.147" class="difflineplus">+      Services.perms.remove(p.host, p.type);</span>
<a href="#l9.148"></a><span id="l9.148">     }</span>
<a href="#l9.149"></a><span id="l9.149">     document.getElementById(&quot;removePermission&quot;).disabled = true;</span>
<a href="#l9.150"></a><span id="l9.150">     document.getElementById(&quot;removeAllPermissions&quot;).disabled = true;</span>
<a href="#l9.151"></a><span id="l9.151">   },</span>
<a href="#l9.152"></a><span id="l9.152"> </span>
<a href="#l9.153"></a><span id="l9.153">   onPermissionKeyPress: function (aEvent)</span>
<a href="#l9.154"></a><span id="l9.154">   {</span>
<a href="#l9.155"></a><span id="l9.155">     if (aEvent.keyCode == 46)</span>
<a href="#l9.156"></a><span id="l9.156" class="difflineat">@@ -284,17 +276,17 @@ var gPermissionManager = {</span>
<a href="#l9.157"></a><span id="l9.157"> </span>
<a href="#l9.158"></a><span id="l9.158">   _loadPermissions: function ()</span>
<a href="#l9.159"></a><span id="l9.159">   {</span>
<a href="#l9.160"></a><span id="l9.160">     this._tree = document.getElementById(&quot;permissionsTree&quot;);</span>
<a href="#l9.161"></a><span id="l9.161">     this._permissions = [];</span>
<a href="#l9.162"></a><span id="l9.162"> </span>
<a href="#l9.163"></a><span id="l9.163">     // load permissions into a table</span>
<a href="#l9.164"></a><span id="l9.164">     var count = 0;</span>
<a href="#l9.165"></a><span id="l9.165" class="difflineminus">-    var enumerator = this._pm.enumerator;</span>
<a href="#l9.166"></a><span id="l9.166" class="difflineplus">+    var enumerator = Services.perms.enumerator;</span>
<a href="#l9.167"></a><span id="l9.167">     while (enumerator.hasMoreElements()) {</span>
<a href="#l9.168"></a><span id="l9.168">       var nextPermission = enumerator.getNext().QueryInterface(Components.interfaces.nsIPermission);</span>
<a href="#l9.169"></a><span id="l9.169">       this._addPermissionToList(nextPermission);</span>
<a href="#l9.170"></a><span id="l9.170">     }</span>
<a href="#l9.171"></a><span id="l9.171"> </span>
<a href="#l9.172"></a><span id="l9.172">     this._view._rowCount = this._permissions.length;</span>
<a href="#l9.173"></a><span id="l9.173"> </span>
<a href="#l9.174"></a><span id="l9.174">     // sort and display the table</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mail/components/preferences/security.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mail/components/preferences/security.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -50,32 +50,26 @@ var gSecurityPane = {</span>
<a href="#l10.4"></a><span id="l10.4">     document.documentElement.openWindow(&quot;mailnews:junklog&quot;,</span>
<a href="#l10.5"></a><span id="l10.5">                                         &quot;chrome://messenger/content/junkLog.xul&quot;,</span>
<a href="#l10.6"></a><span id="l10.6">                                         &quot;&quot;, null);</span>
<a href="#l10.7"></a><span id="l10.7">   },</span>
<a href="#l10.8"></a><span id="l10.8"> </span>
<a href="#l10.9"></a><span id="l10.9">   resetTrainingData: function()</span>
<a href="#l10.10"></a><span id="l10.10">   {</span>
<a href="#l10.11"></a><span id="l10.11">     // make sure the user really wants to do this</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-    var promptService = Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-                          .getService(Components.interfaces.nsIPromptService);</span>
<a href="#l10.14"></a><span id="l10.14">     var bundle = document.getElementById(&quot;bundlePreferences&quot;);</span>
<a href="#l10.15"></a><span id="l10.15">     var title = bundle.getString(&quot;confirmResetJunkTrainingTitle&quot;);</span>
<a href="#l10.16"></a><span id="l10.16">     var text = bundle.getString(&quot;confirmResetJunkTrainingText&quot;);</span>
<a href="#l10.17"></a><span id="l10.17"> </span>
<a href="#l10.18"></a><span id="l10.18">     // if the user says no, then just fall out</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineminus">-    if (!promptService.confirm(window, title, text))</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineplus">+    if (!Services.prompt.confirm(window, title, text))</span>
<a href="#l10.21"></a><span id="l10.21">       return;</span>
<a href="#l10.22"></a><span id="l10.22"> </span>
<a href="#l10.23"></a><span id="l10.23">     // otherwise go ahead and remove the training data</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineminus">-    var junkmailPlugin = Components.classes[&quot;@mozilla.org/messenger/filter-plugin;1?name=bayesianfilter&quot;]</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineminus">-                        .getService(Components.interfaces.nsIJunkMailPlugin);</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineminus">-</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineminus">-    if (junkmailPlugin)</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineminus">-      junkmailPlugin.resetTrainingData();</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineplus">+    MailServices.junk.resetTrainingData();</span>
<a href="#l10.30"></a><span id="l10.30">   },</span>
<a href="#l10.31"></a><span id="l10.31"> </span>
<a href="#l10.32"></a><span id="l10.32"> </span>
<a href="#l10.33"></a><span id="l10.33">   /**</span>
<a href="#l10.34"></a><span id="l10.34">    * Initializes master password UI: the &quot;use master password&quot; checkbox, selects</span>
<a href="#l10.35"></a><span id="l10.35">    * the master password button to show, and enables/disables it as necessary.</span>
<a href="#l10.36"></a><span id="l10.36">    * The master password is controlled by various bits of NSS functionality,</span>
<a href="#l10.37"></a><span id="l10.37">    * so the UI for it can't be controlled by the normal preference bindings.</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineat">@@ -141,22 +135,20 @@ var gSecurityPane = {</span>
<a href="#l10.39"></a><span id="l10.39">    * UI is automatically updated.</span>
<a href="#l10.40"></a><span id="l10.40">    */</span>
<a href="#l10.41"></a><span id="l10.41">   _removeMasterPassword: function ()</span>
<a href="#l10.42"></a><span id="l10.42">   {</span>
<a href="#l10.43"></a><span id="l10.43">     const Cc = Components.classes, Ci = Components.interfaces;</span>
<a href="#l10.44"></a><span id="l10.44">     var secmodDB = Cc[&quot;@mozilla.org/security/pkcs11moduledb;1&quot;].</span>
<a href="#l10.45"></a><span id="l10.45">                    getService(Ci.nsIPKCS11ModuleDB);</span>
<a href="#l10.46"></a><span id="l10.46">     if (secmodDB.isFIPSEnabled) {</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineminus">-      var promptService = Cc[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;].</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineminus">-                          getService(Ci.nsIPromptService);</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineminus">-      var bundle = document.getElementById(&quot;bundlePreferences&quot;);</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineminus">-      promptService.alert(window,</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineminus">-                          bundle.getString(&quot;pw_change_failed_title&quot;),</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineminus">-                          bundle.getString(&quot;pw_change2empty_in_fips_mode&quot;));</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineplus">+      let bundle = document.getElementById(&quot;bundlePreferences&quot;);</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineplus">+      Services.prompt.alert(window,</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineplus">+                            bundle.getString(&quot;pw_change_failed_title&quot;),</span>
<a href="#l10.56"></a><span id="l10.56" class="difflineplus">+                            bundle.getString(&quot;pw_change2empty_in_fips_mode&quot;));</span>
<a href="#l10.57"></a><span id="l10.57">     }</span>
<a href="#l10.58"></a><span id="l10.58">     else {</span>
<a href="#l10.59"></a><span id="l10.59">       document.documentElement.openSubDialog(&quot;chrome://mozapps/content/preferences/removemp.xul&quot;,</span>
<a href="#l10.60"></a><span id="l10.60">                                              &quot;&quot;, null);</span>
<a href="#l10.61"></a><span id="l10.61">     }</span>
<a href="#l10.62"></a><span id="l10.62">     this._initMasterPasswordUI();</span>
<a href="#l10.63"></a><span id="l10.63">   },</span>
<a href="#l10.64"></a><span id="l10.64"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mail/components/preferences/sendoptions.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mail/components/preferences/sendoptions.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -1,13 +1,15 @@</span>
<a href="#l11.4"></a><span id="l11.4"> /* -*- Mode: JavaScript; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l11.5"></a><span id="l11.5">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l11.6"></a><span id="l11.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l11.7"></a><span id="l11.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l11.8"></a><span id="l11.8"> </span>
<a href="#l11.9"></a><span id="l11.9" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l11.10"></a><span id="l11.10" class="difflineplus">+</span>
<a href="#l11.11"></a><span id="l11.11"> var gSendOptionsDialog = {</span>
<a href="#l11.12"></a><span id="l11.12">   mPrefsBundle: null,</span>
<a href="#l11.13"></a><span id="l11.13">   mHTMLListBox: null,</span>
<a href="#l11.14"></a><span id="l11.14">   mPlainTextListBox: null,</span>
<a href="#l11.15"></a><span id="l11.15"> </span>
<a href="#l11.16"></a><span id="l11.16">   init: function ()</span>
<a href="#l11.17"></a><span id="l11.17">   {</span>
<a href="#l11.18"></a><span id="l11.18">     this.mPrefsBundle = document.getElementById('bundlePreferences'); </span>
<a href="#l11.19"></a><span id="l11.19" class="difflineat">@@ -67,50 +69,42 @@ var gSendOptionsDialog = {</span>
<a href="#l11.20"></a><span id="l11.20">       listbox.removeChild(listbox.selectedItems[0]);</span>
<a href="#l11.21"></a><span id="l11.21"> </span>
<a href="#l11.22"></a><span id="l11.22">     document.getElementById('SendOptionsDialogPane').userChangedValue(listbox);</span>
<a href="#l11.23"></a><span id="l11.23">   },</span>
<a href="#l11.24"></a><span id="l11.24"> </span>
<a href="#l11.25"></a><span id="l11.25">   addDomain: function (aHTML)</span>
<a href="#l11.26"></a><span id="l11.26">   {</span>
<a href="#l11.27"></a><span id="l11.27">     var listbox = aHTML ? this.mHTMLListBox : this.mPlainTextListBox;</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineminus">-      </span>
<a href="#l11.29"></a><span id="l11.29" class="difflineplus">+</span>
<a href="#l11.30"></a><span id="l11.30">     var domainName;</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineminus">-    var promptService = Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;].getService();</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineminus">-    promptService = promptService.QueryInterface(Components.interfaces.nsIPromptService);</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineminus">-</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineminus">-    if (promptService)</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineminus">-    {</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineminus">-      var result = {value:null};</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineminus">-      if (promptService.prompt(window, this.mPrefsBundle.getString(listbox.id + 'AddDomainTitle'),</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineplus">+    var result = {value:null};</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineplus">+    if (Services.prompt.prompt(window, this.mPrefsBundle.getString(listbox.id + 'AddDomainTitle'),</span>
<a href="#l11.40"></a><span id="l11.40">                                this.mPrefsBundle.getString(listbox.id + 'AddDomain'), result, null, {value:0}))</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineminus">-        domainName = result.value.replace(/ /g,&quot;&quot;);</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineminus">-    }</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineplus">+      domainName = result.value.replace(/ /g,&quot;&quot;);</span>
<a href="#l11.44"></a><span id="l11.44"> </span>
<a href="#l11.45"></a><span id="l11.45">     if (domainName &amp;&amp; !this.domainAlreadyPresent(domainName))</span>
<a href="#l11.46"></a><span id="l11.46">     {</span>
<a href="#l11.47"></a><span id="l11.47">       this.addItemToDomainList(listbox, domainName);</span>
<a href="#l11.48"></a><span id="l11.48">       document.getElementById('SendOptionsDialogPane').userChangedValue(listbox);</span>
<a href="#l11.49"></a><span id="l11.49">     }</span>
<a href="#l11.50"></a><span id="l11.50"> </span>
<a href="#l11.51"></a><span id="l11.51">   },</span>
<a href="#l11.52"></a><span id="l11.52"> </span>
<a href="#l11.53"></a><span id="l11.53">   domainAlreadyPresent: function(aDomainName)</span>
<a href="#l11.54"></a><span id="l11.54">   {</span>
<a href="#l11.55"></a><span id="l11.55">     var matchingDomains = this.mHTMLListBox.getElementsByAttribute('label', aDomainName);</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineminus">-    var promptService = Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;].getService();</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineminus">-    promptService = promptService.QueryInterface(Components.interfaces.nsIPromptService);</span>
<a href="#l11.58"></a><span id="l11.58"> </span>
<a href="#l11.59"></a><span id="l11.59">     if (!matchingDomains.length)</span>
<a href="#l11.60"></a><span id="l11.60">       matchingDomains = this.mPlainTextListBox.getElementsByAttribute('label', aDomainName);</span>
<a href="#l11.61"></a><span id="l11.61"> </span>
<a href="#l11.62"></a><span id="l11.62">     if (matchingDomains.length)</span>
<a href="#l11.63"></a><span id="l11.63">     {</span>
<a href="#l11.64"></a><span id="l11.64" class="difflineminus">-      promptService.alert(window, this.mPrefsBundle.getString('domainNameErrorTitle'), </span>
<a href="#l11.65"></a><span id="l11.65" class="difflineminus">-                         this.mPrefsBundle.getFormattedString(&quot;domainDuplicationError&quot;, [aDomainName]));</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineplus">+      Services.prompt.alert(window, this.mPrefsBundle.getString('domainNameErrorTitle'),</span>
<a href="#l11.67"></a><span id="l11.67" class="difflineplus">+                            this.mPrefsBundle.getFormattedString(&quot;domainDuplicationError&quot;, [aDomainName]));</span>
<a href="#l11.68"></a><span id="l11.68">     }</span>
<a href="#l11.69"></a><span id="l11.69"> </span>
<a href="#l11.70"></a><span id="l11.70">     return matchingDomains.length;</span>
<a href="#l11.71"></a><span id="l11.71">   },</span>
<a href="#l11.72"></a><span id="l11.72"> </span>
<a href="#l11.73"></a><span id="l11.73">   addItemToDomainList: function (aListBox, aDomainTitle)</span>
<a href="#l11.74"></a><span id="l11.74">   {</span>
<a href="#l11.75"></a><span id="l11.75">     var item = document.createElement('listitem');</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

