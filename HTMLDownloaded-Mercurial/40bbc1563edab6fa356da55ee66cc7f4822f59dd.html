<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 26410:40bbc1563edab6fa356da55ee66cc7f4822f59dd</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 40bbc1563edab6fa356da55ee66cc7f4822f59dd" />
<meta property="og:url" content="/comm-central/rev/40bbc1563edab6fa356da55ee66cc7f4822f59dd" />
<meta property="og:description" content="Bug 1546364 - Reformat to Google coding style in mailnews/mapi. rs=reformat" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 40bbc1563edab6fa356da55ee66cc7f4822f59dd 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/40bbc1563edab6fa356da55ee66cc7f4822f59dd">shortlog</a> |
<a href="/comm-central/log/40bbc1563edab6fa356da55ee66cc7f4822f59dd">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/40bbc1563edab6fa356da55ee66cc7f4822f59dd">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/40bbc1563edab6fa356da55ee66cc7f4822f59dd">files</a> |
changeset |
<a href="/comm-central/raw-rev/40bbc1563edab6fa356da55ee66cc7f4822f59dd">raw</a>  | <a href="/comm-central/archive/40bbc1563edab6fa356da55ee66cc7f4822f59dd.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1546364">Bug 1546364</a> - Reformat to Google coding style in mailnews/mapi. rs=reformat
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#74;&#111;&#114;&#103;&#32;&#75;&#32;&#60;&#106;&#111;&#114;&#103;&#107;&#64;&#106;&#111;&#114;&#103;&#107;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 24 Apr 2019 00:16:30 +0200</td></tr>

<tr>
 <td>changeset 26410</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/40bbc1563edab6fa356da55ee66cc7f4822f59dd">40bbc1563edab6fa356da55ee66cc7f4822f59dd</a></td>
</tr>



<tr>
<td>parent 26409</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/428288c5138c641044f1c28c69986c93c9187216">428288c5138c641044f1c28c69986c93c9187216</a>
</td>
</tr>

<tr>
<td>child 26411</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/babef6da7d89f1715921953da0fd0d95a5bb4f49">babef6da7d89f1715921953da0fd0d95a5bb4f49</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=40bbc1563edab6fa356da55ee66cc7f4822f59dd">15827</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Tue, 23 Apr 2019 22:38:08 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@0c50a354ca18 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=0c50a354ca18dd895b9f6d4e1a19a1780927e21f">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=0c50a354ca18dd895b9f6d4e1a19a1780927e21f&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=0c50a354ca18dd895b9f6d4e1a19a1780927e21f&newProject=comm-central&newRevision=452b1d36e872ac355882048b28139cdf99e1eef8&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=0c50a354ca18dd895b9f6d4e1a19a1780927e21f&newProject=comm-central&newRevision=452b1d36e872ac355882048b28139cdf99e1eef8&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=0c50a354ca18dd895b9f6d4e1a19a1780927e21f&newProject=comm-central&newRevision=452b1d36e872ac355882048b28139cdf99e1eef8&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28reformat%29&revcount=50">reformat</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1546364">1546364</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1546364">Bug 1546364</a> - Reformat to Google coding style in mailnews/mapi. rs=reformat
# ignore-this-changeset</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapiDll/MapiDll.cpp">mailnews/mapi/mapiDll/MapiDll.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapiDll/MapiDll.cpp">file</a> |
<a href="/comm-central/annotate/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapiDll/MapiDll.cpp">annotate</a> |
<a href="/comm-central/diff/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapiDll/MapiDll.cpp">diff</a> |
<a href="/comm-central/comparison/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapiDll/MapiDll.cpp">comparison</a> |
<a href="/comm-central/log/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapiDll/MapiDll.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapihook/src/Registry.cpp">mailnews/mapi/mapihook/src/Registry.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapihook/src/Registry.cpp">file</a> |
<a href="/comm-central/annotate/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapihook/src/Registry.cpp">annotate</a> |
<a href="/comm-central/diff/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapihook/src/Registry.cpp">diff</a> |
<a href="/comm-central/comparison/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapihook/src/Registry.cpp">comparison</a> |
<a href="/comm-central/log/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapihook/src/Registry.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapihook/src/Registry.h">mailnews/mapi/mapihook/src/Registry.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapihook/src/Registry.h">file</a> |
<a href="/comm-central/annotate/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapihook/src/Registry.h">annotate</a> |
<a href="/comm-central/diff/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapihook/src/Registry.h">diff</a> |
<a href="/comm-central/comparison/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapihook/src/Registry.h">comparison</a> |
<a href="/comm-central/log/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapihook/src/Registry.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapihook/src/msgMapiFactory.cpp">mailnews/mapi/mapihook/src/msgMapiFactory.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapihook/src/msgMapiFactory.cpp">file</a> |
<a href="/comm-central/annotate/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapihook/src/msgMapiFactory.cpp">annotate</a> |
<a href="/comm-central/diff/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapihook/src/msgMapiFactory.cpp">diff</a> |
<a href="/comm-central/comparison/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapihook/src/msgMapiFactory.cpp">comparison</a> |
<a href="/comm-central/log/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapihook/src/msgMapiFactory.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapihook/src/msgMapiFactory.h">mailnews/mapi/mapihook/src/msgMapiFactory.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapihook/src/msgMapiFactory.h">file</a> |
<a href="/comm-central/annotate/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapihook/src/msgMapiFactory.h">annotate</a> |
<a href="/comm-central/diff/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapihook/src/msgMapiFactory.h">diff</a> |
<a href="/comm-central/comparison/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapihook/src/msgMapiFactory.h">comparison</a> |
<a href="/comm-central/log/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapihook/src/msgMapiFactory.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapihook/src/msgMapiHook.cpp">mailnews/mapi/mapihook/src/msgMapiHook.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapihook/src/msgMapiHook.cpp">file</a> |
<a href="/comm-central/annotate/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapihook/src/msgMapiHook.cpp">annotate</a> |
<a href="/comm-central/diff/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapihook/src/msgMapiHook.cpp">diff</a> |
<a href="/comm-central/comparison/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapihook/src/msgMapiHook.cpp">comparison</a> |
<a href="/comm-central/log/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapihook/src/msgMapiHook.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapihook/src/msgMapiHook.h">mailnews/mapi/mapihook/src/msgMapiHook.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapihook/src/msgMapiHook.h">file</a> |
<a href="/comm-central/annotate/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapihook/src/msgMapiHook.h">annotate</a> |
<a href="/comm-central/diff/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapihook/src/msgMapiHook.h">diff</a> |
<a href="/comm-central/comparison/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapihook/src/msgMapiHook.h">comparison</a> |
<a href="/comm-central/log/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapihook/src/msgMapiHook.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapihook/src/msgMapiImp.cpp">mailnews/mapi/mapihook/src/msgMapiImp.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapihook/src/msgMapiImp.cpp">file</a> |
<a href="/comm-central/annotate/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapihook/src/msgMapiImp.cpp">annotate</a> |
<a href="/comm-central/diff/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapihook/src/msgMapiImp.cpp">diff</a> |
<a href="/comm-central/comparison/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapihook/src/msgMapiImp.cpp">comparison</a> |
<a href="/comm-central/log/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapihook/src/msgMapiImp.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapihook/src/msgMapiImp.h">mailnews/mapi/mapihook/src/msgMapiImp.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapihook/src/msgMapiImp.h">file</a> |
<a href="/comm-central/annotate/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapihook/src/msgMapiImp.h">annotate</a> |
<a href="/comm-central/diff/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapihook/src/msgMapiImp.h">diff</a> |
<a href="/comm-central/comparison/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapihook/src/msgMapiImp.h">comparison</a> |
<a href="/comm-central/log/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapihook/src/msgMapiImp.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapihook/src/msgMapiMain.cpp">mailnews/mapi/mapihook/src/msgMapiMain.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapihook/src/msgMapiMain.cpp">file</a> |
<a href="/comm-central/annotate/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapihook/src/msgMapiMain.cpp">annotate</a> |
<a href="/comm-central/diff/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapihook/src/msgMapiMain.cpp">diff</a> |
<a href="/comm-central/comparison/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapihook/src/msgMapiMain.cpp">comparison</a> |
<a href="/comm-central/log/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapihook/src/msgMapiMain.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapihook/src/msgMapiMain.h">mailnews/mapi/mapihook/src/msgMapiMain.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapihook/src/msgMapiMain.h">file</a> |
<a href="/comm-central/annotate/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapihook/src/msgMapiMain.h">annotate</a> |
<a href="/comm-central/diff/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapihook/src/msgMapiMain.h">diff</a> |
<a href="/comm-central/comparison/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapihook/src/msgMapiMain.h">comparison</a> |
<a href="/comm-central/log/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapihook/src/msgMapiMain.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapihook/src/msgMapiSupport.cpp">mailnews/mapi/mapihook/src/msgMapiSupport.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapihook/src/msgMapiSupport.cpp">file</a> |
<a href="/comm-central/annotate/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapihook/src/msgMapiSupport.cpp">annotate</a> |
<a href="/comm-central/diff/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapihook/src/msgMapiSupport.cpp">diff</a> |
<a href="/comm-central/comparison/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapihook/src/msgMapiSupport.cpp">comparison</a> |
<a href="/comm-central/log/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapihook/src/msgMapiSupport.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapihook/src/msgMapiSupport.h">mailnews/mapi/mapihook/src/msgMapiSupport.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapihook/src/msgMapiSupport.h">file</a> |
<a href="/comm-central/annotate/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapihook/src/msgMapiSupport.h">annotate</a> |
<a href="/comm-central/diff/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapihook/src/msgMapiSupport.h">diff</a> |
<a href="/comm-central/comparison/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapihook/src/msgMapiSupport.h">comparison</a> |
<a href="/comm-central/log/40bbc1563edab6fa356da55ee66cc7f4822f59dd/mailnews/mapi/mapihook/src/msgMapiSupport.h">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/mapi/mapiDll/MapiDll.cpp</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/mapi/mapiDll/MapiDll.cpp</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -1,417 +1,487 @@</span>
<a href="#l1.4"></a><span id="l1.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l1.5"></a><span id="l1.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l1.6"></a><span id="l1.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8" class="difflineminus">-#pragma warning (disable : 4996) // MAPILogoff is deprecated</span>
<a href="#l1.9"></a><span id="l1.9" class="difflineplus">+#pragma warning(disable : 4996)  // MAPILogoff is deprecated</span>
<a href="#l1.10"></a><span id="l1.10"> </span>
<a href="#l1.11"></a><span id="l1.11"> #include &lt;windows.h&gt;</span>
<a href="#l1.12"></a><span id="l1.12"> #include &lt;mapidefs.h&gt;</span>
<a href="#l1.13"></a><span id="l1.13"> #include &lt;mapi.h&gt;</span>
<a href="#l1.14"></a><span id="l1.14"> #include &quot;msgMapi.h&quot;</span>
<a href="#l1.15"></a><span id="l1.15"> </span>
<a href="#l1.16"></a><span id="l1.16" class="difflineminus">-// Ensure that our COM structs match MS MAPI structs - thoroughly check each struct layout</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineminus">-// This needs that MAPI.h is not used from https://www.microsoft.com/en-us/download/details.aspx?id=12905</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineminus">-// because the newer MAPI.h is the part of Windows SDK, and it includes MapiFileDescW and friends.</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+// Ensure that our COM structs match MS MAPI structs - thoroughly check each</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+// struct layout This needs that MAPI.h is not used from</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+// https://www.microsoft.com/en-us/download/details.aspx?id=12905 because the</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineplus">+// newer MAPI.h is the part of Windows SDK, and it includes MapiFileDescW and</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineplus">+// friends.</span>
<a href="#l1.24"></a><span id="l1.24"> </span>
<a href="#l1.25"></a><span id="l1.25"> static_assert(sizeof(nsMapiFileDesc) == sizeof(MapiFileDesc), &quot;Size mismatch!&quot;);</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineminus">-static_assert(offsetof(nsMapiFileDesc, ulReserved) == offsetof(MapiFileDesc, ulReserved), &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineminus">-static_assert(offsetof(nsMapiFileDesc, flFlags) == offsetof(MapiFileDesc, flFlags), &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineminus">-static_assert(offsetof(nsMapiFileDesc, nPosition_NotUsed) == offsetof(MapiFileDesc, nPosition), &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineminus">-static_assert(offsetof(nsMapiFileDesc, lpszPathName) == offsetof(MapiFileDesc, lpszPathName), &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineminus">-static_assert(offsetof(nsMapiFileDesc, lpszFileName) == offsetof(MapiFileDesc, lpszFileName), &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-static_assert(offsetof(nsMapiFileDesc, lpFileType_NotUsed) == offsetof(MapiFileDesc, lpFileType), &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+static_assert(offsetof(nsMapiFileDesc, ulReserved) ==</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+                  offsetof(MapiFileDesc, ulReserved),</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+              &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineplus">+static_assert(offsetof(nsMapiFileDesc, flFlags) ==</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineplus">+                  offsetof(MapiFileDesc, flFlags),</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineplus">+              &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineplus">+static_assert(offsetof(nsMapiFileDesc, nPosition_NotUsed) ==</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineplus">+                  offsetof(MapiFileDesc, nPosition),</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+              &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineplus">+static_assert(offsetof(nsMapiFileDesc, lpszPathName) ==</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineplus">+                  offsetof(MapiFileDesc, lpszPathName),</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineplus">+              &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineplus">+static_assert(offsetof(nsMapiFileDesc, lpszFileName) ==</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineplus">+                  offsetof(MapiFileDesc, lpszFileName),</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineplus">+              &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineplus">+static_assert(offsetof(nsMapiFileDesc, lpFileType_NotUsed) ==</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineplus">+                  offsetof(MapiFileDesc, lpFileType),</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineplus">+              &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.50"></a><span id="l1.50"> </span>
<a href="#l1.51"></a><span id="l1.51" class="difflineminus">-static_assert(sizeof(nsMapiRecipDesc) == sizeof(MapiRecipDesc), &quot;Size mismatch!&quot;);</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineminus">-static_assert(offsetof(nsMapiRecipDesc, ulReserved) == offsetof(MapiRecipDesc, ulReserved), &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineminus">-static_assert(offsetof(nsMapiRecipDesc, ulRecipClass) == offsetof(MapiRecipDesc, ulRecipClass), &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineminus">-static_assert(offsetof(nsMapiRecipDesc, lpszName) == offsetof(MapiRecipDesc, lpszName), &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineminus">-static_assert(offsetof(nsMapiRecipDesc, lpszAddress) == offsetof(MapiRecipDesc, lpszAddress), &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineminus">-static_assert(offsetof(nsMapiRecipDesc, ulEIDSize_NotUsed) == offsetof(MapiRecipDesc, ulEIDSize), &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineminus">-static_assert(offsetof(nsMapiRecipDesc, lpEntryID_NotUsed) == offsetof(MapiRecipDesc, lpEntryID), &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineplus">+static_assert(sizeof(nsMapiRecipDesc) == sizeof(MapiRecipDesc),</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineplus">+              &quot;Size mismatch!&quot;);</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineplus">+static_assert(offsetof(nsMapiRecipDesc, ulReserved) ==</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineplus">+                  offsetof(MapiRecipDesc, ulReserved),</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineplus">+              &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineplus">+static_assert(offsetof(nsMapiRecipDesc, ulRecipClass) ==</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineplus">+                  offsetof(MapiRecipDesc, ulRecipClass),</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineplus">+              &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineplus">+static_assert(offsetof(nsMapiRecipDesc, lpszName) ==</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineplus">+                  offsetof(MapiRecipDesc, lpszName),</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineplus">+              &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineplus">+static_assert(offsetof(nsMapiRecipDesc, lpszAddress) ==</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineplus">+                  offsetof(MapiRecipDesc, lpszAddress),</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineplus">+              &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineplus">+static_assert(offsetof(nsMapiRecipDesc, ulEIDSize_NotUsed) ==</span>
<a href="#l1.73"></a><span id="l1.73" class="difflineplus">+                  offsetof(MapiRecipDesc, ulEIDSize),</span>
<a href="#l1.74"></a><span id="l1.74" class="difflineplus">+              &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.75"></a><span id="l1.75" class="difflineplus">+static_assert(offsetof(nsMapiRecipDesc, lpEntryID_NotUsed) ==</span>
<a href="#l1.76"></a><span id="l1.76" class="difflineplus">+                  offsetof(MapiRecipDesc, lpEntryID),</span>
<a href="#l1.77"></a><span id="l1.77" class="difflineplus">+              &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.78"></a><span id="l1.78"> </span>
<a href="#l1.79"></a><span id="l1.79"> static_assert(sizeof(nsMapiMessage) == sizeof(MapiMessage), &quot;Size mismatch!&quot;);</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineminus">-static_assert(offsetof(nsMapiMessage, ulReserved) == offsetof(MapiMessage, ulReserved), &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.81"></a><span id="l1.81" class="difflineminus">-static_assert(offsetof(nsMapiMessage, lpszSubject) == offsetof(MapiMessage, lpszSubject), &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.82"></a><span id="l1.82" class="difflineminus">-static_assert(offsetof(nsMapiMessage, lpszNoteText) == offsetof(MapiMessage, lpszNoteText), &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.83"></a><span id="l1.83" class="difflineminus">-static_assert(offsetof(nsMapiMessage, lpszMessageType) == offsetof(MapiMessage, lpszMessageType), &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.84"></a><span id="l1.84" class="difflineminus">-static_assert(offsetof(nsMapiMessage, lpszDateReceived) == offsetof(MapiMessage, lpszDateReceived), &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.85"></a><span id="l1.85" class="difflineminus">-static_assert(offsetof(nsMapiMessage, lpszConversationID_NotUsed) == offsetof(MapiMessage, lpszConversationID), &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.86"></a><span id="l1.86" class="difflineminus">-static_assert(offsetof(nsMapiMessage, flFlags) == offsetof(MapiMessage, flFlags), &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineminus">-static_assert(offsetof(nsMapiMessage, lpOriginator) == offsetof(MapiMessage, lpOriginator), &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.88"></a><span id="l1.88" class="difflineminus">-static_assert(offsetof(nsMapiMessage, nRecipCount) == offsetof(MapiMessage, nRecipCount), &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.89"></a><span id="l1.89" class="difflineminus">-static_assert(offsetof(nsMapiMessage, lpRecips) == offsetof(MapiMessage, lpRecips), &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.90"></a><span id="l1.90" class="difflineminus">-static_assert(offsetof(nsMapiMessage, nFileCount) == offsetof(MapiMessage, nFileCount), &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.91"></a><span id="l1.91" class="difflineminus">-static_assert(offsetof(nsMapiMessage, lpFiles) == offsetof(MapiMessage, lpFiles), &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.92"></a><span id="l1.92" class="difflineplus">+static_assert(offsetof(nsMapiMessage, ulReserved) ==</span>
<a href="#l1.93"></a><span id="l1.93" class="difflineplus">+                  offsetof(MapiMessage, ulReserved),</span>
<a href="#l1.94"></a><span id="l1.94" class="difflineplus">+              &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.95"></a><span id="l1.95" class="difflineplus">+static_assert(offsetof(nsMapiMessage, lpszSubject) ==</span>
<a href="#l1.96"></a><span id="l1.96" class="difflineplus">+                  offsetof(MapiMessage, lpszSubject),</span>
<a href="#l1.97"></a><span id="l1.97" class="difflineplus">+              &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.98"></a><span id="l1.98" class="difflineplus">+static_assert(offsetof(nsMapiMessage, lpszNoteText) ==</span>
<a href="#l1.99"></a><span id="l1.99" class="difflineplus">+                  offsetof(MapiMessage, lpszNoteText),</span>
<a href="#l1.100"></a><span id="l1.100" class="difflineplus">+              &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.101"></a><span id="l1.101" class="difflineplus">+static_assert(offsetof(nsMapiMessage, lpszMessageType) ==</span>
<a href="#l1.102"></a><span id="l1.102" class="difflineplus">+                  offsetof(MapiMessage, lpszMessageType),</span>
<a href="#l1.103"></a><span id="l1.103" class="difflineplus">+              &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.104"></a><span id="l1.104" class="difflineplus">+static_assert(offsetof(nsMapiMessage, lpszDateReceived) ==</span>
<a href="#l1.105"></a><span id="l1.105" class="difflineplus">+                  offsetof(MapiMessage, lpszDateReceived),</span>
<a href="#l1.106"></a><span id="l1.106" class="difflineplus">+              &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.107"></a><span id="l1.107" class="difflineplus">+static_assert(offsetof(nsMapiMessage, lpszConversationID_NotUsed) ==</span>
<a href="#l1.108"></a><span id="l1.108" class="difflineplus">+                  offsetof(MapiMessage, lpszConversationID),</span>
<a href="#l1.109"></a><span id="l1.109" class="difflineplus">+              &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.110"></a><span id="l1.110" class="difflineplus">+static_assert(offsetof(nsMapiMessage, flFlags) ==</span>
<a href="#l1.111"></a><span id="l1.111" class="difflineplus">+                  offsetof(MapiMessage, flFlags),</span>
<a href="#l1.112"></a><span id="l1.112" class="difflineplus">+              &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.113"></a><span id="l1.113" class="difflineplus">+static_assert(offsetof(nsMapiMessage, lpOriginator) ==</span>
<a href="#l1.114"></a><span id="l1.114" class="difflineplus">+                  offsetof(MapiMessage, lpOriginator),</span>
<a href="#l1.115"></a><span id="l1.115" class="difflineplus">+              &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.116"></a><span id="l1.116" class="difflineplus">+static_assert(offsetof(nsMapiMessage, nRecipCount) ==</span>
<a href="#l1.117"></a><span id="l1.117" class="difflineplus">+                  offsetof(MapiMessage, nRecipCount),</span>
<a href="#l1.118"></a><span id="l1.118" class="difflineplus">+              &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.119"></a><span id="l1.119" class="difflineplus">+static_assert(offsetof(nsMapiMessage, lpRecips) ==</span>
<a href="#l1.120"></a><span id="l1.120" class="difflineplus">+                  offsetof(MapiMessage, lpRecips),</span>
<a href="#l1.121"></a><span id="l1.121" class="difflineplus">+              &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.122"></a><span id="l1.122" class="difflineplus">+static_assert(offsetof(nsMapiMessage, nFileCount) ==</span>
<a href="#l1.123"></a><span id="l1.123" class="difflineplus">+                  offsetof(MapiMessage, nFileCount),</span>
<a href="#l1.124"></a><span id="l1.124" class="difflineplus">+              &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.125"></a><span id="l1.125" class="difflineplus">+static_assert(offsetof(nsMapiMessage, lpFiles) ==</span>
<a href="#l1.126"></a><span id="l1.126" class="difflineplus">+                  offsetof(MapiMessage, lpFiles),</span>
<a href="#l1.127"></a><span id="l1.127" class="difflineplus">+              &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.128"></a><span id="l1.128"> </span>
<a href="#l1.129"></a><span id="l1.129" class="difflineminus">-static_assert(sizeof(nsMapiFileDescW) == sizeof(MapiFileDescW), &quot;Size mismatch!&quot;);</span>
<a href="#l1.130"></a><span id="l1.130" class="difflineminus">-static_assert(offsetof(nsMapiFileDescW, ulReserved) == offsetof(MapiFileDescW, ulReserved), &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.131"></a><span id="l1.131" class="difflineminus">-static_assert(offsetof(nsMapiFileDescW, flFlags) == offsetof(MapiFileDescW, flFlags), &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.132"></a><span id="l1.132" class="difflineminus">-static_assert(offsetof(nsMapiFileDescW, nPosition_NotUsed) == offsetof(MapiFileDescW, nPosition), &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.133"></a><span id="l1.133" class="difflineminus">-static_assert(offsetof(nsMapiFileDescW, lpszPathName) == offsetof(MapiFileDescW, lpszPathName), &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.134"></a><span id="l1.134" class="difflineminus">-static_assert(offsetof(nsMapiFileDescW, lpszFileName) == offsetof(MapiFileDescW, lpszFileName), &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.135"></a><span id="l1.135" class="difflineminus">-static_assert(offsetof(nsMapiFileDescW, lpFileType_NotUsed) == offsetof(MapiFileDescW, lpFileType), &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.136"></a><span id="l1.136" class="difflineplus">+static_assert(sizeof(nsMapiFileDescW) == sizeof(MapiFileDescW),</span>
<a href="#l1.137"></a><span id="l1.137" class="difflineplus">+              &quot;Size mismatch!&quot;);</span>
<a href="#l1.138"></a><span id="l1.138" class="difflineplus">+static_assert(offsetof(nsMapiFileDescW, ulReserved) ==</span>
<a href="#l1.139"></a><span id="l1.139" class="difflineplus">+                  offsetof(MapiFileDescW, ulReserved),</span>
<a href="#l1.140"></a><span id="l1.140" class="difflineplus">+              &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.141"></a><span id="l1.141" class="difflineplus">+static_assert(offsetof(nsMapiFileDescW, flFlags) ==</span>
<a href="#l1.142"></a><span id="l1.142" class="difflineplus">+                  offsetof(MapiFileDescW, flFlags),</span>
<a href="#l1.143"></a><span id="l1.143" class="difflineplus">+              &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.144"></a><span id="l1.144" class="difflineplus">+static_assert(offsetof(nsMapiFileDescW, nPosition_NotUsed) ==</span>
<a href="#l1.145"></a><span id="l1.145" class="difflineplus">+                  offsetof(MapiFileDescW, nPosition),</span>
<a href="#l1.146"></a><span id="l1.146" class="difflineplus">+              &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.147"></a><span id="l1.147" class="difflineplus">+static_assert(offsetof(nsMapiFileDescW, lpszPathName) ==</span>
<a href="#l1.148"></a><span id="l1.148" class="difflineplus">+                  offsetof(MapiFileDescW, lpszPathName),</span>
<a href="#l1.149"></a><span id="l1.149" class="difflineplus">+              &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.150"></a><span id="l1.150" class="difflineplus">+static_assert(offsetof(nsMapiFileDescW, lpszFileName) ==</span>
<a href="#l1.151"></a><span id="l1.151" class="difflineplus">+                  offsetof(MapiFileDescW, lpszFileName),</span>
<a href="#l1.152"></a><span id="l1.152" class="difflineplus">+              &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.153"></a><span id="l1.153" class="difflineplus">+static_assert(offsetof(nsMapiFileDescW, lpFileType_NotUsed) ==</span>
<a href="#l1.154"></a><span id="l1.154" class="difflineplus">+                  offsetof(MapiFileDescW, lpFileType),</span>
<a href="#l1.155"></a><span id="l1.155" class="difflineplus">+              &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.156"></a><span id="l1.156"> </span>
<a href="#l1.157"></a><span id="l1.157" class="difflineminus">-static_assert(sizeof(nsMapiRecipDescW) == sizeof(MapiRecipDescW), &quot;Size mismatch!&quot;);</span>
<a href="#l1.158"></a><span id="l1.158" class="difflineminus">-static_assert(offsetof(nsMapiRecipDescW, ulReserved) == offsetof(MapiRecipDescW, ulReserved), &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.159"></a><span id="l1.159" class="difflineminus">-static_assert(offsetof(nsMapiRecipDescW, ulRecipClass) == offsetof(MapiRecipDescW, ulRecipClass), &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.160"></a><span id="l1.160" class="difflineminus">-static_assert(offsetof(nsMapiRecipDescW, lpszName) == offsetof(MapiRecipDescW, lpszName), &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.161"></a><span id="l1.161" class="difflineminus">-static_assert(offsetof(nsMapiRecipDescW, lpszAddress) == offsetof(MapiRecipDescW, lpszAddress), &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.162"></a><span id="l1.162" class="difflineminus">-static_assert(offsetof(nsMapiRecipDescW, ulEIDSize_NotUsed) == offsetof(MapiRecipDescW, ulEIDSize), &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.163"></a><span id="l1.163" class="difflineminus">-static_assert(offsetof(nsMapiRecipDescW, lpEntryID_NotUsed) == offsetof(MapiRecipDescW, lpEntryID), &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.164"></a><span id="l1.164" class="difflineplus">+static_assert(sizeof(nsMapiRecipDescW) == sizeof(MapiRecipDescW),</span>
<a href="#l1.165"></a><span id="l1.165" class="difflineplus">+              &quot;Size mismatch!&quot;);</span>
<a href="#l1.166"></a><span id="l1.166" class="difflineplus">+static_assert(offsetof(nsMapiRecipDescW, ulReserved) ==</span>
<a href="#l1.167"></a><span id="l1.167" class="difflineplus">+                  offsetof(MapiRecipDescW, ulReserved),</span>
<a href="#l1.168"></a><span id="l1.168" class="difflineplus">+              &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.169"></a><span id="l1.169" class="difflineplus">+static_assert(offsetof(nsMapiRecipDescW, ulRecipClass) ==</span>
<a href="#l1.170"></a><span id="l1.170" class="difflineplus">+                  offsetof(MapiRecipDescW, ulRecipClass),</span>
<a href="#l1.171"></a><span id="l1.171" class="difflineplus">+              &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.172"></a><span id="l1.172" class="difflineplus">+static_assert(offsetof(nsMapiRecipDescW, lpszName) ==</span>
<a href="#l1.173"></a><span id="l1.173" class="difflineplus">+                  offsetof(MapiRecipDescW, lpszName),</span>
<a href="#l1.174"></a><span id="l1.174" class="difflineplus">+              &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.175"></a><span id="l1.175" class="difflineplus">+static_assert(offsetof(nsMapiRecipDescW, lpszAddress) ==</span>
<a href="#l1.176"></a><span id="l1.176" class="difflineplus">+                  offsetof(MapiRecipDescW, lpszAddress),</span>
<a href="#l1.177"></a><span id="l1.177" class="difflineplus">+              &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.178"></a><span id="l1.178" class="difflineplus">+static_assert(offsetof(nsMapiRecipDescW, ulEIDSize_NotUsed) ==</span>
<a href="#l1.179"></a><span id="l1.179" class="difflineplus">+                  offsetof(MapiRecipDescW, ulEIDSize),</span>
<a href="#l1.180"></a><span id="l1.180" class="difflineplus">+              &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.181"></a><span id="l1.181" class="difflineplus">+static_assert(offsetof(nsMapiRecipDescW, lpEntryID_NotUsed) ==</span>
<a href="#l1.182"></a><span id="l1.182" class="difflineplus">+                  offsetof(MapiRecipDescW, lpEntryID),</span>
<a href="#l1.183"></a><span id="l1.183" class="difflineplus">+              &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.184"></a><span id="l1.184"> </span>
<a href="#l1.185"></a><span id="l1.185"> static_assert(sizeof(nsMapiMessageW) == sizeof(MapiMessageW), &quot;Size mismatch!&quot;);</span>
<a href="#l1.186"></a><span id="l1.186" class="difflineminus">-static_assert(offsetof(nsMapiMessageW, ulReserved) == offsetof(MapiMessageW, ulReserved), &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.187"></a><span id="l1.187" class="difflineminus">-static_assert(offsetof(nsMapiMessageW, lpszSubject) == offsetof(MapiMessageW, lpszSubject), &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.188"></a><span id="l1.188" class="difflineminus">-static_assert(offsetof(nsMapiMessageW, ulReserved) == offsetof(MapiMessageW, ulReserved), &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.189"></a><span id="l1.189" class="difflineminus">-static_assert(offsetof(nsMapiMessageW, lpszSubject) == offsetof(MapiMessageW, lpszSubject), &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.190"></a><span id="l1.190" class="difflineminus">-static_assert(offsetof(nsMapiMessageW, lpszNoteText) == offsetof(MapiMessageW, lpszNoteText), &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.191"></a><span id="l1.191" class="difflineminus">-static_assert(offsetof(nsMapiMessageW, lpszMessageType) == offsetof(MapiMessageW, lpszMessageType), &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.192"></a><span id="l1.192" class="difflineminus">-static_assert(offsetof(nsMapiMessageW, lpszDateReceived) == offsetof(MapiMessageW, lpszDateReceived), &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.193"></a><span id="l1.193" class="difflineminus">-static_assert(offsetof(nsMapiMessageW, lpszConversationID_NotUsed) == offsetof(MapiMessageW, lpszConversationID), &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.194"></a><span id="l1.194" class="difflineminus">-static_assert(offsetof(nsMapiMessageW, flFlags) == offsetof(MapiMessageW, flFlags), &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.195"></a><span id="l1.195" class="difflineminus">-static_assert(offsetof(nsMapiMessageW, lpOriginator) == offsetof(MapiMessageW, lpOriginator), &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.196"></a><span id="l1.196" class="difflineminus">-static_assert(offsetof(nsMapiMessageW, nRecipCount) == offsetof(MapiMessageW, nRecipCount), &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.197"></a><span id="l1.197" class="difflineminus">-static_assert(offsetof(nsMapiMessageW, lpRecips) == offsetof(MapiMessageW, lpRecips), &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.198"></a><span id="l1.198" class="difflineminus">-static_assert(offsetof(nsMapiMessageW, nFileCount) == offsetof(MapiMessageW, nFileCount), &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.199"></a><span id="l1.199" class="difflineminus">-static_assert(offsetof(nsMapiMessageW, lpFiles) == offsetof(MapiMessageW, lpFiles), &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.200"></a><span id="l1.200" class="difflineplus">+static_assert(offsetof(nsMapiMessageW, ulReserved) ==</span>
<a href="#l1.201"></a><span id="l1.201" class="difflineplus">+                  offsetof(MapiMessageW, ulReserved),</span>
<a href="#l1.202"></a><span id="l1.202" class="difflineplus">+              &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.203"></a><span id="l1.203" class="difflineplus">+static_assert(offsetof(nsMapiMessageW, lpszSubject) ==</span>
<a href="#l1.204"></a><span id="l1.204" class="difflineplus">+                  offsetof(MapiMessageW, lpszSubject),</span>
<a href="#l1.205"></a><span id="l1.205" class="difflineplus">+              &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.206"></a><span id="l1.206" class="difflineplus">+static_assert(offsetof(nsMapiMessageW, ulReserved) ==</span>
<a href="#l1.207"></a><span id="l1.207" class="difflineplus">+                  offsetof(MapiMessageW, ulReserved),</span>
<a href="#l1.208"></a><span id="l1.208" class="difflineplus">+              &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.209"></a><span id="l1.209" class="difflineplus">+static_assert(offsetof(nsMapiMessageW, lpszSubject) ==</span>
<a href="#l1.210"></a><span id="l1.210" class="difflineplus">+                  offsetof(MapiMessageW, lpszSubject),</span>
<a href="#l1.211"></a><span id="l1.211" class="difflineplus">+              &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.212"></a><span id="l1.212" class="difflineplus">+static_assert(offsetof(nsMapiMessageW, lpszNoteText) ==</span>
<a href="#l1.213"></a><span id="l1.213" class="difflineplus">+                  offsetof(MapiMessageW, lpszNoteText),</span>
<a href="#l1.214"></a><span id="l1.214" class="difflineplus">+              &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.215"></a><span id="l1.215" class="difflineplus">+static_assert(offsetof(nsMapiMessageW, lpszMessageType) ==</span>
<a href="#l1.216"></a><span id="l1.216" class="difflineplus">+                  offsetof(MapiMessageW, lpszMessageType),</span>
<a href="#l1.217"></a><span id="l1.217" class="difflineplus">+              &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.218"></a><span id="l1.218" class="difflineplus">+static_assert(offsetof(nsMapiMessageW, lpszDateReceived) ==</span>
<a href="#l1.219"></a><span id="l1.219" class="difflineplus">+                  offsetof(MapiMessageW, lpszDateReceived),</span>
<a href="#l1.220"></a><span id="l1.220" class="difflineplus">+              &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.221"></a><span id="l1.221" class="difflineplus">+static_assert(offsetof(nsMapiMessageW, lpszConversationID_NotUsed) ==</span>
<a href="#l1.222"></a><span id="l1.222" class="difflineplus">+                  offsetof(MapiMessageW, lpszConversationID),</span>
<a href="#l1.223"></a><span id="l1.223" class="difflineplus">+              &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.224"></a><span id="l1.224" class="difflineplus">+static_assert(offsetof(nsMapiMessageW, flFlags) ==</span>
<a href="#l1.225"></a><span id="l1.225" class="difflineplus">+                  offsetof(MapiMessageW, flFlags),</span>
<a href="#l1.226"></a><span id="l1.226" class="difflineplus">+              &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.227"></a><span id="l1.227" class="difflineplus">+static_assert(offsetof(nsMapiMessageW, lpOriginator) ==</span>
<a href="#l1.228"></a><span id="l1.228" class="difflineplus">+                  offsetof(MapiMessageW, lpOriginator),</span>
<a href="#l1.229"></a><span id="l1.229" class="difflineplus">+              &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.230"></a><span id="l1.230" class="difflineplus">+static_assert(offsetof(nsMapiMessageW, nRecipCount) ==</span>
<a href="#l1.231"></a><span id="l1.231" class="difflineplus">+                  offsetof(MapiMessageW, nRecipCount),</span>
<a href="#l1.232"></a><span id="l1.232" class="difflineplus">+              &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.233"></a><span id="l1.233" class="difflineplus">+static_assert(offsetof(nsMapiMessageW, lpRecips) ==</span>
<a href="#l1.234"></a><span id="l1.234" class="difflineplus">+                  offsetof(MapiMessageW, lpRecips),</span>
<a href="#l1.235"></a><span id="l1.235" class="difflineplus">+              &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.236"></a><span id="l1.236" class="difflineplus">+static_assert(offsetof(nsMapiMessageW, nFileCount) ==</span>
<a href="#l1.237"></a><span id="l1.237" class="difflineplus">+                  offsetof(MapiMessageW, nFileCount),</span>
<a href="#l1.238"></a><span id="l1.238" class="difflineplus">+              &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.239"></a><span id="l1.239" class="difflineplus">+static_assert(offsetof(nsMapiMessageW, lpFiles) ==</span>
<a href="#l1.240"></a><span id="l1.240" class="difflineplus">+                  offsetof(MapiMessageW, lpFiles),</span>
<a href="#l1.241"></a><span id="l1.241" class="difflineplus">+              &quot;Member offset mismatch!&quot;);</span>
<a href="#l1.242"></a><span id="l1.242"> </span>
<a href="#l1.243"></a><span id="l1.243" class="difflineminus">-#define MAX_RECIPS  2000</span>
<a href="#l1.244"></a><span id="l1.244" class="difflineminus">-#define MAX_FILES   100</span>
<a href="#l1.245"></a><span id="l1.245" class="difflineplus">+#define MAX_RECIPS 2000</span>
<a href="#l1.246"></a><span id="l1.246" class="difflineplus">+#define MAX_FILES 100</span>
<a href="#l1.247"></a><span id="l1.247"> </span>
<a href="#l1.248"></a><span id="l1.248" class="difflineplus">+#define MAX_NAME_LEN 256</span>
<a href="#l1.249"></a><span id="l1.249" class="difflineplus">+#define MAX_PW_LEN 256</span>
<a href="#l1.250"></a><span id="l1.250" class="difflineplus">+#define MAX_MSGINFO_LEN 512</span>
<a href="#l1.251"></a><span id="l1.251" class="difflineplus">+#define MAX_POINTERS 32</span>
<a href="#l1.252"></a><span id="l1.252"> </span>
<a href="#l1.253"></a><span id="l1.253" class="difflineminus">-#define           MAX_NAME_LEN    256</span>
<a href="#l1.254"></a><span id="l1.254" class="difflineminus">-#define           MAX_PW_LEN      256</span>
<a href="#l1.255"></a><span id="l1.255" class="difflineminus">-#define           MAX_MSGINFO_LEN 512</span>
<a href="#l1.256"></a><span id="l1.256" class="difflineminus">-#define           MAX_POINTERS    32</span>
<a href="#l1.257"></a><span id="l1.257" class="difflineminus">-</span>
<a href="#l1.258"></a><span id="l1.258" class="difflineminus">-const CLSID CLSID_CMapiImp = {0x29f458be, 0x8866, 0x11d5,</span>
<a href="#l1.259"></a><span id="l1.259" class="difflineplus">+const CLSID CLSID_CMapiImp = {0x29f458be,</span>
<a href="#l1.260"></a><span id="l1.260" class="difflineplus">+                              0x8866,</span>
<a href="#l1.261"></a><span id="l1.261" class="difflineplus">+                              0x11d5,</span>
<a href="#l1.262"></a><span id="l1.262">                               {0xa3, 0xdd, 0x0, 0xb0, 0xd0, 0xf3, 0xba, 0xa7}};</span>
<a href="#l1.263"></a><span id="l1.263" class="difflineminus">-const IID IID_nsIMapi = {0x6EDCD38E,0x8861,0x11d5,</span>
<a href="#l1.264"></a><span id="l1.264" class="difflineminus">-                        {0xA3,0xDD,0x00,0xB0,0xD0,0xF3,0xBA,0xA7}};</span>
<a href="#l1.265"></a><span id="l1.265" class="difflineplus">+const IID IID_nsIMapi = {0x6EDCD38E,</span>
<a href="#l1.266"></a><span id="l1.266" class="difflineplus">+                         0x8861,</span>
<a href="#l1.267"></a><span id="l1.267" class="difflineplus">+                         0x11d5,</span>
<a href="#l1.268"></a><span id="l1.268" class="difflineplus">+                         {0xA3, 0xDD, 0x00, 0xB0, 0xD0, 0xF3, 0xBA, 0xA7}};</span>
<a href="#l1.269"></a><span id="l1.269"> </span>
<a href="#l1.270"></a><span id="l1.270"> DWORD tId = 0;</span>
<a href="#l1.271"></a><span id="l1.271"> </span>
<a href="#l1.272"></a><span id="l1.272" class="difflineminus">-#define   MAPI_MESSAGE_TYPE     0</span>
<a href="#l1.273"></a><span id="l1.273" class="difflineminus">-#define   MAPI_RECIPIENT_TYPE   1</span>
<a href="#l1.274"></a><span id="l1.274" class="difflineplus">+#define MAPI_MESSAGE_TYPE 0</span>
<a href="#l1.275"></a><span id="l1.275" class="difflineplus">+#define MAPI_RECIPIENT_TYPE 1</span>
<a href="#l1.276"></a><span id="l1.276"> </span>
<a href="#l1.277"></a><span id="l1.277"> typedef struct {</span>
<a href="#l1.278"></a><span id="l1.278" class="difflineminus">-  LPVOID    lpMem;</span>
<a href="#l1.279"></a><span id="l1.279" class="difflineminus">-  UCHAR     memType;</span>
<a href="#l1.280"></a><span id="l1.280" class="difflineplus">+  LPVOID lpMem;</span>
<a href="#l1.281"></a><span id="l1.281" class="difflineplus">+  UCHAR memType;</span>
<a href="#l1.282"></a><span id="l1.282"> } memTrackerType;</span>
<a href="#l1.283"></a><span id="l1.283"> </span>
<a href="#l1.284"></a><span id="l1.284" class="difflineminus">-</span>
<a href="#l1.285"></a><span id="l1.285"> // this can't be right.</span>
<a href="#l1.286"></a><span id="l1.286" class="difflineminus">-memTrackerType    memArray[MAX_POINTERS];</span>
<a href="#l1.287"></a><span id="l1.287" class="difflineplus">+memTrackerType memArray[MAX_POINTERS];</span>
<a href="#l1.288"></a><span id="l1.288"> </span>
<a href="#l1.289"></a><span id="l1.289"> //</span>
<a href="#l1.290"></a><span id="l1.290"> // For remembering memory...how ironic.</span>
<a href="#l1.291"></a><span id="l1.291"> //</span>
<a href="#l1.292"></a><span id="l1.292" class="difflineminus">-void</span>
<a href="#l1.293"></a><span id="l1.293" class="difflineminus">-SetPointerArray(LPVOID ptr, BYTE type)</span>
<a href="#l1.294"></a><span id="l1.294" class="difflineminus">-{</span>
<a href="#l1.295"></a><span id="l1.295" class="difflineminus">-int i;</span>
<a href="#l1.296"></a><span id="l1.296" class="difflineplus">+void SetPointerArray(LPVOID ptr, BYTE type) {</span>
<a href="#l1.297"></a><span id="l1.297" class="difflineplus">+  int i;</span>
<a href="#l1.298"></a><span id="l1.298"> </span>
<a href="#l1.299"></a><span id="l1.299" class="difflineminus">-  for (i=0; i&lt;MAX_POINTERS; i++)</span>
<a href="#l1.300"></a><span id="l1.300" class="difflineminus">-  {</span>
<a href="#l1.301"></a><span id="l1.301" class="difflineminus">-    if (memArray[i].lpMem == NULL)</span>
<a href="#l1.302"></a><span id="l1.302" class="difflineminus">-    {</span>
<a href="#l1.303"></a><span id="l1.303" class="difflineplus">+  for (i = 0; i &lt; MAX_POINTERS; i++) {</span>
<a href="#l1.304"></a><span id="l1.304" class="difflineplus">+    if (memArray[i].lpMem == NULL) {</span>
<a href="#l1.305"></a><span id="l1.305">       memArray[i].lpMem = ptr;</span>
<a href="#l1.306"></a><span id="l1.306">       memArray[i].memType = type;</span>
<a href="#l1.307"></a><span id="l1.307">       break;</span>
<a href="#l1.308"></a><span id="l1.308">     }</span>
<a href="#l1.309"></a><span id="l1.309">   }</span>
<a href="#l1.310"></a><span id="l1.310"> }</span>
<a href="#l1.311"></a><span id="l1.311"> </span>
<a href="#l1.312"></a><span id="l1.312" class="difflineplus">+BOOL WINAPI DllMain(HINSTANCE aInstance, DWORD aReason, LPVOID aReserved) {</span>
<a href="#l1.313"></a><span id="l1.313" class="difflineplus">+  switch (aReason) {</span>
<a href="#l1.314"></a><span id="l1.314" class="difflineplus">+    case DLL_PROCESS_ATTACH:</span>
<a href="#l1.315"></a><span id="l1.315" class="difflineplus">+      tId = TlsAlloc();</span>
<a href="#l1.316"></a><span id="l1.316" class="difflineplus">+      if (tId == 0xFFFFFFFF) return FALSE;</span>
<a href="#l1.317"></a><span id="l1.317" class="difflineplus">+      break;</span>
<a href="#l1.318"></a><span id="l1.318"> </span>
<a href="#l1.319"></a><span id="l1.319" class="difflineminus">-BOOL WINAPI DllMain(HINSTANCE aInstance, DWORD aReason, LPVOID aReserved)</span>
<a href="#l1.320"></a><span id="l1.320" class="difflineminus">-{</span>
<a href="#l1.321"></a><span id="l1.321" class="difflineminus">-    switch (aReason)</span>
<a href="#l1.322"></a><span id="l1.322" class="difflineminus">-    {</span>
<a href="#l1.323"></a><span id="l1.323" class="difflineminus">-        case DLL_PROCESS_ATTACH : tId = TlsAlloc();</span>
<a href="#l1.324"></a><span id="l1.324" class="difflineminus">-                                  if (tId == 0xFFFFFFFF)</span>
<a href="#l1.325"></a><span id="l1.325" class="difflineminus">-                                      return FALSE;</span>
<a href="#l1.326"></a><span id="l1.326" class="difflineminus">-                                  break;</span>
<a href="#l1.327"></a><span id="l1.327" class="difflineminus">-</span>
<a href="#l1.328"></a><span id="l1.328" class="difflineminus">-        case DLL_PROCESS_DETACH : TlsFree(tId);</span>
<a href="#l1.329"></a><span id="l1.329" class="difflineminus">-                                  break;</span>
<a href="#l1.330"></a><span id="l1.330" class="difflineminus">-    }</span>
<a href="#l1.331"></a><span id="l1.331" class="difflineminus">-    return TRUE;</span>
<a href="#l1.332"></a><span id="l1.332" class="difflineplus">+    case DLL_PROCESS_DETACH:</span>
<a href="#l1.333"></a><span id="l1.333" class="difflineplus">+      TlsFree(tId);</span>
<a href="#l1.334"></a><span id="l1.334" class="difflineplus">+      break;</span>
<a href="#l1.335"></a><span id="l1.335" class="difflineplus">+  }</span>
<a href="#l1.336"></a><span id="l1.336" class="difflineplus">+  return TRUE;</span>
<a href="#l1.337"></a><span id="l1.337"> }</span>
<a href="#l1.338"></a><span id="l1.338"> </span>
<a href="#l1.339"></a><span id="l1.339" class="difflineminus">-BOOL InitMozillaReference(nsIMapi **aRetValue)</span>
<a href="#l1.340"></a><span id="l1.340" class="difflineminus">-{</span>
<a href="#l1.341"></a><span id="l1.341" class="difflineminus">-    // Check whether this thread has a valid Interface</span>
<a href="#l1.342"></a><span id="l1.342" class="difflineminus">-    // by looking into thread-specific-data variable</span>
<a href="#l1.343"></a><span id="l1.343" class="difflineplus">+BOOL InitMozillaReference(nsIMapi **aRetValue) {</span>
<a href="#l1.344"></a><span id="l1.344" class="difflineplus">+  // Check whether this thread has a valid Interface</span>
<a href="#l1.345"></a><span id="l1.345" class="difflineplus">+  // by looking into thread-specific-data variable</span>
<a href="#l1.346"></a><span id="l1.346"> </span>
<a href="#l1.347"></a><span id="l1.347" class="difflineminus">-    *aRetValue = (nsIMapi *)TlsGetValue(tId);</span>
<a href="#l1.348"></a><span id="l1.348" class="difflineplus">+  *aRetValue = (nsIMapi *)TlsGetValue(tId);</span>
<a href="#l1.349"></a><span id="l1.349"> </span>
<a href="#l1.350"></a><span id="l1.350" class="difflineminus">-    // Check whether the pointer actually resolves to</span>
<a href="#l1.351"></a><span id="l1.351" class="difflineminus">-    // a valid method call; otherwise mozilla is not running</span>
<a href="#l1.352"></a><span id="l1.352" class="difflineplus">+  // Check whether the pointer actually resolves to</span>
<a href="#l1.353"></a><span id="l1.353" class="difflineplus">+  // a valid method call; otherwise mozilla is not running</span>
<a href="#l1.354"></a><span id="l1.354"> </span>
<a href="#l1.355"></a><span id="l1.355" class="difflineminus">-    if ((*aRetValue) &amp;&amp; (*aRetValue)-&gt;IsValid() == S_OK)</span>
<a href="#l1.356"></a><span id="l1.356" class="difflineminus">-         return TRUE;</span>
<a href="#l1.357"></a><span id="l1.357" class="difflineplus">+  if ((*aRetValue) &amp;&amp; (*aRetValue)-&gt;IsValid() == S_OK) return TRUE;</span>
<a href="#l1.358"></a><span id="l1.358"> </span>
<a href="#l1.359"></a><span id="l1.359" class="difflineminus">-    HRESULT hRes = ::CoInitialize(NULL) ;</span>
<a href="#l1.360"></a><span id="l1.360" class="difflineplus">+  HRESULT hRes = ::CoInitialize(NULL);</span>
<a href="#l1.361"></a><span id="l1.361"> </span>
<a href="#l1.362"></a><span id="l1.362" class="difflineminus">-    hRes = ::CoCreateInstance(CLSID_CMapiImp, NULL, CLSCTX_LOCAL_SERVER,</span>
<a href="#l1.363"></a><span id="l1.363" class="difflineminus">-                                         IID_nsIMapi, (LPVOID *)aRetValue);</span>
<a href="#l1.364"></a><span id="l1.364" class="difflineplus">+  hRes = ::CoCreateInstance(CLSID_CMapiImp, NULL, CLSCTX_LOCAL_SERVER,</span>
<a href="#l1.365"></a><span id="l1.365" class="difflineplus">+                            IID_nsIMapi, (LPVOID *)aRetValue);</span>
<a href="#l1.366"></a><span id="l1.366"> </span>
<a href="#l1.367"></a><span id="l1.367" class="difflineminus">-    if (hRes == S_OK &amp;&amp; (*aRetValue)-&gt;Initialize() == S_OK)</span>
<a href="#l1.368"></a><span id="l1.368" class="difflineminus">-        if (TlsSetValue(tId, (LPVOID)(*aRetValue)))</span>
<a href="#l1.369"></a><span id="l1.369" class="difflineminus">-            return TRUE;</span>
<a href="#l1.370"></a><span id="l1.370" class="difflineplus">+  if (hRes == S_OK &amp;&amp; (*aRetValue)-&gt;Initialize() == S_OK)</span>
<a href="#l1.371"></a><span id="l1.371" class="difflineplus">+    if (TlsSetValue(tId, (LPVOID)(*aRetValue))) return TRUE;</span>
<a href="#l1.372"></a><span id="l1.372"> </span>
<a href="#l1.373"></a><span id="l1.373" class="difflineminus">-    // Either CoCreate or TlsSetValue failed; so return FALSE</span>
<a href="#l1.374"></a><span id="l1.374" class="difflineplus">+  // Either CoCreate or TlsSetValue failed; so return FALSE</span>
<a href="#l1.375"></a><span id="l1.375"> </span>
<a href="#l1.376"></a><span id="l1.376" class="difflineminus">-    if ((*aRetValue))</span>
<a href="#l1.377"></a><span id="l1.377" class="difflineminus">-        (*aRetValue)-&gt;Release();</span>
<a href="#l1.378"></a><span id="l1.378" class="difflineplus">+  if ((*aRetValue)) (*aRetValue)-&gt;Release();</span>
<a href="#l1.379"></a><span id="l1.379"> </span>
<a href="#l1.380"></a><span id="l1.380" class="difflineminus">-    ::CoUninitialize();</span>
<a href="#l1.381"></a><span id="l1.381" class="difflineminus">-    return FALSE;</span>
<a href="#l1.382"></a><span id="l1.382" class="difflineplus">+  ::CoUninitialize();</span>
<a href="#l1.383"></a><span id="l1.383" class="difflineplus">+  return FALSE;</span>
<a href="#l1.384"></a><span id="l1.384"> }</span>
<a href="#l1.385"></a><span id="l1.385"> </span>
<a href="#l1.386"></a><span id="l1.386"> ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l1.387"></a><span id="l1.387" class="difflineminus">-// The MAPILogon function begins a Simple MAPI session, loading the default message ////</span>
<a href="#l1.388"></a><span id="l1.388" class="difflineminus">-// store and address book providers                            ////</span>
<a href="#l1.389"></a><span id="l1.389" class="difflineplus">+// The MAPILogon function begins a Simple MAPI session, loading the default</span>
<a href="#l1.390"></a><span id="l1.390" class="difflineplus">+// message //// store and address book providers                            ////</span>
<a href="#l1.391"></a><span id="l1.391"> ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l1.392"></a><span id="l1.392"> </span>
<a href="#l1.393"></a><span id="l1.393" class="difflineminus">-ULONG FAR PASCAL MAPILogon(ULONG aUIParam, LPSTR aProfileName,</span>
<a href="#l1.394"></a><span id="l1.394" class="difflineminus">-                           LPSTR aPassword, FLAGS aFlags,</span>
<a href="#l1.395"></a><span id="l1.395" class="difflineminus">-                           ULONG aReserved, LPLHANDLE aSession)</span>
<a href="#l1.396"></a><span id="l1.396" class="difflineminus">-{</span>
<a href="#l1.397"></a><span id="l1.397" class="difflineminus">-    HRESULT hr = 0;</span>
<a href="#l1.398"></a><span id="l1.398" class="difflineminus">-    ULONG nSessionId = 0;</span>
<a href="#l1.399"></a><span id="l1.399" class="difflineminus">-    nsIMapi *pNsMapi = NULL;</span>
<a href="#l1.400"></a><span id="l1.400" class="difflineplus">+ULONG FAR PASCAL MAPILogon(ULONG aUIParam, LPSTR aProfileName, LPSTR aPassword,</span>
<a href="#l1.401"></a><span id="l1.401" class="difflineplus">+                           FLAGS aFlags, ULONG aReserved, LPLHANDLE aSession) {</span>
<a href="#l1.402"></a><span id="l1.402" class="difflineplus">+  HRESULT hr = 0;</span>
<a href="#l1.403"></a><span id="l1.403" class="difflineplus">+  ULONG nSessionId = 0;</span>
<a href="#l1.404"></a><span id="l1.404" class="difflineplus">+  nsIMapi *pNsMapi = NULL;</span>
<a href="#l1.405"></a><span id="l1.405" class="difflineplus">+</span>
<a href="#l1.406"></a><span id="l1.406" class="difflineplus">+  if (!InitMozillaReference(&amp;pNsMapi)) return MAPI_E_FAILURE;</span>
<a href="#l1.407"></a><span id="l1.407"> </span>
<a href="#l1.408"></a><span id="l1.408" class="difflineminus">-    if (!InitMozillaReference(&amp;pNsMapi))</span>
<a href="#l1.409"></a><span id="l1.409" class="difflineminus">-        return MAPI_E_FAILURE;</span>
<a href="#l1.410"></a><span id="l1.410" class="difflineplus">+  hr = pNsMapi-&gt;Login(aUIParam, aProfileName, aPassword, aFlags, &amp;nSessionId);</span>
<a href="#l1.411"></a><span id="l1.411" class="difflineplus">+  if (hr == S_OK)</span>
<a href="#l1.412"></a><span id="l1.412" class="difflineplus">+    (*aSession) = (LHANDLE)nSessionId;</span>
<a href="#l1.413"></a><span id="l1.413" class="difflineplus">+  else</span>
<a href="#l1.414"></a><span id="l1.414" class="difflineplus">+    return nSessionId;</span>
<a href="#l1.415"></a><span id="l1.415"> </span>
<a href="#l1.416"></a><span id="l1.416" class="difflineminus">-    hr = pNsMapi-&gt;Login(aUIParam, aProfileName, aPassword, aFlags, &amp;nSessionId);</span>
<a href="#l1.417"></a><span id="l1.417" class="difflineminus">-    if (hr == S_OK)</span>
<a href="#l1.418"></a><span id="l1.418" class="difflineminus">-        (*aSession) = (LHANDLE) nSessionId;</span>
<a href="#l1.419"></a><span id="l1.419" class="difflineminus">-    else</span>
<a href="#l1.420"></a><span id="l1.420" class="difflineminus">-        return nSessionId;</span>
<a href="#l1.421"></a><span id="l1.421" class="difflineminus">-</span>
<a href="#l1.422"></a><span id="l1.422" class="difflineminus">-    return SUCCESS_SUCCESS;</span>
<a href="#l1.423"></a><span id="l1.423" class="difflineplus">+  return SUCCESS_SUCCESS;</span>
<a href="#l1.424"></a><span id="l1.424"> }</span>
<a href="#l1.425"></a><span id="l1.425"> </span>
<a href="#l1.426"></a><span id="l1.426" class="difflineminus">-ULONG FAR PASCAL MAPILogoff (LHANDLE aSession, ULONG aUIParam,</span>
<a href="#l1.427"></a><span id="l1.427" class="difflineminus">-                                            FLAGS aFlags, ULONG aReserved)</span>
<a href="#l1.428"></a><span id="l1.428" class="difflineminus">-{</span>
<a href="#l1.429"></a><span id="l1.429" class="difflineminus">-    nsIMapi *pNsMapi = (nsIMapi *)TlsGetValue(tId);</span>
<a href="#l1.430"></a><span id="l1.430" class="difflineminus">-    if (pNsMapi != NULL)</span>
<a href="#l1.431"></a><span id="l1.431" class="difflineminus">-    {</span>
<a href="#l1.432"></a><span id="l1.432" class="difflineminus">-        if (pNsMapi-&gt;Logoff((ULONG) aSession) == S_OK)</span>
<a href="#l1.433"></a><span id="l1.433" class="difflineminus">-            pNsMapi-&gt;Release();</span>
<a href="#l1.434"></a><span id="l1.434" class="difflineminus">-        pNsMapi = NULL;</span>
<a href="#l1.435"></a><span id="l1.435" class="difflineminus">-    }</span>
<a href="#l1.436"></a><span id="l1.436" class="difflineplus">+ULONG FAR PASCAL MAPILogoff(LHANDLE aSession, ULONG aUIParam, FLAGS aFlags,</span>
<a href="#l1.437"></a><span id="l1.437" class="difflineplus">+                            ULONG aReserved) {</span>
<a href="#l1.438"></a><span id="l1.438" class="difflineplus">+  nsIMapi *pNsMapi = (nsIMapi *)TlsGetValue(tId);</span>
<a href="#l1.439"></a><span id="l1.439" class="difflineplus">+  if (pNsMapi != NULL) {</span>
<a href="#l1.440"></a><span id="l1.440" class="difflineplus">+    if (pNsMapi-&gt;Logoff((ULONG)aSession) == S_OK) pNsMapi-&gt;Release();</span>
<a href="#l1.441"></a><span id="l1.441" class="difflineplus">+    pNsMapi = NULL;</span>
<a href="#l1.442"></a><span id="l1.442" class="difflineplus">+  }</span>
<a href="#l1.443"></a><span id="l1.443"> </span>
<a href="#l1.444"></a><span id="l1.444" class="difflineminus">-    TlsSetValue(tId, NULL);</span>
<a href="#l1.445"></a><span id="l1.445" class="difflineplus">+  TlsSetValue(tId, NULL);</span>
<a href="#l1.446"></a><span id="l1.446"> </span>
<a href="#l1.447"></a><span id="l1.447" class="difflineminus">-    ::CoUninitialize();</span>
<a href="#l1.448"></a><span id="l1.448" class="difflineplus">+  ::CoUninitialize();</span>
<a href="#l1.449"></a><span id="l1.449"> </span>
<a href="#l1.450"></a><span id="l1.450" class="difflineminus">-    return SUCCESS_SUCCESS;</span>
<a href="#l1.451"></a><span id="l1.451" class="difflineplus">+  return SUCCESS_SUCCESS;</span>
<a href="#l1.452"></a><span id="l1.452"> }</span>
<a href="#l1.453"></a><span id="l1.453"> </span>
<a href="#l1.454"></a><span id="l1.454" class="difflineminus">-ULONG FAR PASCAL MAPISendMail (LHANDLE lhSession, ULONG ulUIParam, nsMapiMessage *lpMessage,</span>
<a href="#l1.455"></a><span id="l1.455" class="difflineminus">-                FLAGS flFlags, ULONG ulReserved )</span>
<a href="#l1.456"></a><span id="l1.456" class="difflineminus">-{</span>
<a href="#l1.457"></a><span id="l1.457" class="difflineminus">-    HRESULT hr = 0;</span>
<a href="#l1.458"></a><span id="l1.458" class="difflineminus">-    BOOL bTempSession = FALSE ;</span>
<a href="#l1.459"></a><span id="l1.459" class="difflineminus">-    nsIMapi *pNsMapi = NULL;</span>
<a href="#l1.460"></a><span id="l1.460" class="difflineplus">+ULONG FAR PASCAL MAPISendMail(LHANDLE lhSession, ULONG ulUIParam,</span>
<a href="#l1.461"></a><span id="l1.461" class="difflineplus">+                              nsMapiMessage *lpMessage, FLAGS flFlags,</span>
<a href="#l1.462"></a><span id="l1.462" class="difflineplus">+                              ULONG ulReserved) {</span>
<a href="#l1.463"></a><span id="l1.463" class="difflineplus">+  HRESULT hr = 0;</span>
<a href="#l1.464"></a><span id="l1.464" class="difflineplus">+  BOOL bTempSession = FALSE;</span>
<a href="#l1.465"></a><span id="l1.465" class="difflineplus">+  nsIMapi *pNsMapi = NULL;</span>
<a href="#l1.466"></a><span id="l1.466"> </span>
<a href="#l1.467"></a><span id="l1.467" class="difflineminus">-    if (!InitMozillaReference(&amp;pNsMapi))</span>
<a href="#l1.468"></a><span id="l1.468" class="difflineminus">-        return MAPI_E_FAILURE;</span>
<a href="#l1.469"></a><span id="l1.469" class="difflineplus">+  if (!InitMozillaReference(&amp;pNsMapi)) return MAPI_E_FAILURE;</span>
<a href="#l1.470"></a><span id="l1.470"> </span>
<a href="#l1.471"></a><span id="l1.471" class="difflineminus">-    if (lpMessage-&gt;nRecipCount &gt; MAX_RECIPS)</span>
<a href="#l1.472"></a><span id="l1.472" class="difflineminus">-        return MAPI_E_TOO_MANY_RECIPIENTS ;</span>
<a href="#l1.473"></a><span id="l1.473" class="difflineplus">+  if (lpMessage-&gt;nRecipCount &gt; MAX_RECIPS) return MAPI_E_TOO_MANY_RECIPIENTS;</span>
<a href="#l1.474"></a><span id="l1.474"> </span>
<a href="#l1.475"></a><span id="l1.475" class="difflineminus">-    if (lpMessage-&gt;nFileCount &gt; MAX_FILES)</span>
<a href="#l1.476"></a><span id="l1.476" class="difflineminus">-        return MAPI_E_TOO_MANY_FILES ;</span>
<a href="#l1.477"></a><span id="l1.477" class="difflineplus">+  if (lpMessage-&gt;nFileCount &gt; MAX_FILES) return MAPI_E_TOO_MANY_FILES;</span>
<a href="#l1.478"></a><span id="l1.478"> </span>
<a href="#l1.479"></a><span id="l1.479" class="difflineminus">-    if ( (!(flFlags &amp; MAPI_DIALOG)) &amp;&amp; (lpMessage-&gt;lpRecips == NULL) )</span>
<a href="#l1.480"></a><span id="l1.480" class="difflineminus">-        return MAPI_E_UNKNOWN_RECIPIENT ;</span>
<a href="#l1.481"></a><span id="l1.481" class="difflineplus">+  if ((!(flFlags &amp; MAPI_DIALOG)) &amp;&amp; (lpMessage-&gt;lpRecips == NULL))</span>
<a href="#l1.482"></a><span id="l1.482" class="difflineplus">+    return MAPI_E_UNKNOWN_RECIPIENT;</span>
<a href="#l1.483"></a><span id="l1.483"> </span>
<a href="#l1.484"></a><span id="l1.484" class="difflineminus">-    if (!lhSession || pNsMapi-&gt;IsValidSession(lhSession) != S_OK)</span>
<a href="#l1.485"></a><span id="l1.485" class="difflineminus">-    {</span>
<a href="#l1.486"></a><span id="l1.486" class="difflineminus">-        FLAGS LoginFlag = flFlags &amp; (MAPI_LOGON_UI | MAPI_NEW_SESSION);</span>
<a href="#l1.487"></a><span id="l1.487" class="difflineminus">-        hr = MAPILogon(ulUIParam, nullptr, nullptr, LoginFlag, 0, &amp;lhSession);</span>
<a href="#l1.488"></a><span id="l1.488" class="difflineminus">-        if (hr != SUCCESS_SUCCESS)</span>
<a href="#l1.489"></a><span id="l1.489" class="difflineminus">-            return MAPI_E_LOGIN_FAILURE ;</span>
<a href="#l1.490"></a><span id="l1.490" class="difflineminus">-        bTempSession = TRUE ;</span>
<a href="#l1.491"></a><span id="l1.491" class="difflineminus">-    }</span>
<a href="#l1.492"></a><span id="l1.492" class="difflineplus">+  if (!lhSession || pNsMapi-&gt;IsValidSession(lhSession) != S_OK) {</span>
<a href="#l1.493"></a><span id="l1.493" class="difflineplus">+    FLAGS LoginFlag = flFlags &amp; (MAPI_LOGON_UI | MAPI_NEW_SESSION);</span>
<a href="#l1.494"></a><span id="l1.494" class="difflineplus">+    hr = MAPILogon(ulUIParam, nullptr, nullptr, LoginFlag, 0, &amp;lhSession);</span>
<a href="#l1.495"></a><span id="l1.495" class="difflineplus">+    if (hr != SUCCESS_SUCCESS) return MAPI_E_LOGIN_FAILURE;</span>
<a href="#l1.496"></a><span id="l1.496" class="difflineplus">+    bTempSession = TRUE;</span>
<a href="#l1.497"></a><span id="l1.497" class="difflineplus">+  }</span>
<a href="#l1.498"></a><span id="l1.498" class="difflineplus">+</span>
<a href="#l1.499"></a><span id="l1.499" class="difflineplus">+  hr = pNsMapi-&gt;SendMail(lhSession, lpMessage, flFlags, ulReserved);</span>
<a href="#l1.500"></a><span id="l1.500"> </span>
<a href="#l1.501"></a><span id="l1.501" class="difflineminus">-    hr = pNsMapi-&gt;SendMail(lhSession, lpMessage, flFlags, ulReserved);</span>
<a href="#l1.502"></a><span id="l1.502" class="difflineplus">+  // we are seeing a problem when using Word, although we return success from</span>
<a href="#l1.503"></a><span id="l1.503" class="difflineplus">+  // the MAPI support MS COM interface in mozilla, we are getting this error</span>
<a href="#l1.504"></a><span id="l1.504" class="difflineplus">+  // here. This is a temporary hack !!</span>
<a href="#l1.505"></a><span id="l1.505" class="difflineplus">+  if (hr == 0x800703e6) hr = SUCCESS_SUCCESS;</span>
<a href="#l1.506"></a><span id="l1.506"> </span>
<a href="#l1.507"></a><span id="l1.507" class="difflineminus">-    // we are seeing a problem when using Word, although we return success from the MAPI support</span>
<a href="#l1.508"></a><span id="l1.508" class="difflineminus">-    // MS COM interface in mozilla, we are getting this error here. This is a temporary hack !!</span>
<a href="#l1.509"></a><span id="l1.509" class="difflineminus">-    if (hr == 0x800703e6)</span>
<a href="#l1.510"></a><span id="l1.510" class="difflineminus">-        hr = SUCCESS_SUCCESS;</span>
<a href="#l1.511"></a><span id="l1.511" class="difflineplus">+  if (bTempSession) MAPILogoff(lhSession, ulUIParam, 0, 0);</span>
<a href="#l1.512"></a><span id="l1.512"> </span>
<a href="#l1.513"></a><span id="l1.513" class="difflineminus">-    if (bTempSession)</span>
<a href="#l1.514"></a><span id="l1.514" class="difflineminus">-        MAPILogoff (lhSession, ulUIParam, 0,0) ;</span>
<a href="#l1.515"></a><span id="l1.515" class="difflineminus">-</span>
<a href="#l1.516"></a><span id="l1.516" class="difflineminus">-    return hr ;</span>
<a href="#l1.517"></a><span id="l1.517" class="difflineplus">+  return hr;</span>
<a href="#l1.518"></a><span id="l1.518"> }</span>
<a href="#l1.519"></a><span id="l1.519"> </span>
<a href="#l1.520"></a><span id="l1.520" class="difflineminus">-ULONG FAR PASCAL MAPISendMailW(LHANDLE lhSession, ULONG ulUIParam, nsMapiMessageW *lpMessage,</span>
<a href="#l1.521"></a><span id="l1.521" class="difflineminus">-                               FLAGS flFlags, ULONG ulReserved)</span>
<a href="#l1.522"></a><span id="l1.522" class="difflineminus">-{</span>
<a href="#l1.523"></a><span id="l1.523" class="difflineminus">-    HRESULT hr = 0;</span>
<a href="#l1.524"></a><span id="l1.524" class="difflineminus">-    BOOL bTempSession = FALSE;</span>
<a href="#l1.525"></a><span id="l1.525" class="difflineminus">-    nsIMapi *pNsMapi = nullptr;</span>
<a href="#l1.526"></a><span id="l1.526" class="difflineplus">+ULONG FAR PASCAL MAPISendMailW(LHANDLE lhSession, ULONG ulUIParam,</span>
<a href="#l1.527"></a><span id="l1.527" class="difflineplus">+                               nsMapiMessageW *lpMessage, FLAGS flFlags,</span>
<a href="#l1.528"></a><span id="l1.528" class="difflineplus">+                               ULONG ulReserved) {</span>
<a href="#l1.529"></a><span id="l1.529" class="difflineplus">+  HRESULT hr = 0;</span>
<a href="#l1.530"></a><span id="l1.530" class="difflineplus">+  BOOL bTempSession = FALSE;</span>
<a href="#l1.531"></a><span id="l1.531" class="difflineplus">+  nsIMapi *pNsMapi = nullptr;</span>
<a href="#l1.532"></a><span id="l1.532"> </span>
<a href="#l1.533"></a><span id="l1.533" class="difflineminus">-    if (!InitMozillaReference(&amp;pNsMapi))</span>
<a href="#l1.534"></a><span id="l1.534" class="difflineminus">-      return MAPI_E_FAILURE;</span>
<a href="#l1.535"></a><span id="l1.535" class="difflineplus">+  if (!InitMozillaReference(&amp;pNsMapi)) return MAPI_E_FAILURE;</span>
<a href="#l1.536"></a><span id="l1.536"> </span>
<a href="#l1.537"></a><span id="l1.537" class="difflineminus">-    if (lpMessage-&gt;nRecipCount &gt; MAX_RECIPS)</span>
<a href="#l1.538"></a><span id="l1.538" class="difflineminus">-      return MAPI_E_TOO_MANY_RECIPIENTS;</span>
<a href="#l1.539"></a><span id="l1.539" class="difflineplus">+  if (lpMessage-&gt;nRecipCount &gt; MAX_RECIPS) return MAPI_E_TOO_MANY_RECIPIENTS;</span>
<a href="#l1.540"></a><span id="l1.540"> </span>
<a href="#l1.541"></a><span id="l1.541" class="difflineminus">-    if (lpMessage-&gt;nFileCount &gt; MAX_FILES)</span>
<a href="#l1.542"></a><span id="l1.542" class="difflineminus">-      return MAPI_E_TOO_MANY_FILES;</span>
<a href="#l1.543"></a><span id="l1.543" class="difflineplus">+  if (lpMessage-&gt;nFileCount &gt; MAX_FILES) return MAPI_E_TOO_MANY_FILES;</span>
<a href="#l1.544"></a><span id="l1.544"> </span>
<a href="#l1.545"></a><span id="l1.545" class="difflineminus">-    if ((!(flFlags &amp; MAPI_DIALOG)) &amp;&amp; (lpMessage-&gt;lpRecips == nullptr))</span>
<a href="#l1.546"></a><span id="l1.546" class="difflineminus">-      return MAPI_E_UNKNOWN_RECIPIENT;</span>
<a href="#l1.547"></a><span id="l1.547" class="difflineplus">+  if ((!(flFlags &amp; MAPI_DIALOG)) &amp;&amp; (lpMessage-&gt;lpRecips == nullptr))</span>
<a href="#l1.548"></a><span id="l1.548" class="difflineplus">+    return MAPI_E_UNKNOWN_RECIPIENT;</span>
<a href="#l1.549"></a><span id="l1.549"> </span>
<a href="#l1.550"></a><span id="l1.550" class="difflineminus">-    if (!lhSession || pNsMapi-&gt;IsValidSession(lhSession) != S_OK)</span>
<a href="#l1.551"></a><span id="l1.551" class="difflineminus">-    {</span>
<a href="#l1.552"></a><span id="l1.552" class="difflineminus">-      FLAGS LoginFlag = flFlags &amp; (MAPI_LOGON_UI | MAPI_NEW_SESSION);</span>
<a href="#l1.553"></a><span id="l1.553" class="difflineminus">-      hr = MAPILogon(ulUIParam, nullptr, nullptr, LoginFlag, 0, &amp;lhSession);</span>
<a href="#l1.554"></a><span id="l1.554" class="difflineminus">-      if (hr != SUCCESS_SUCCESS)</span>
<a href="#l1.555"></a><span id="l1.555" class="difflineminus">-        return MAPI_E_LOGIN_FAILURE;</span>
<a href="#l1.556"></a><span id="l1.556" class="difflineminus">-      bTempSession = TRUE;</span>
<a href="#l1.557"></a><span id="l1.557" class="difflineminus">-    }</span>
<a href="#l1.558"></a><span id="l1.558" class="difflineplus">+  if (!lhSession || pNsMapi-&gt;IsValidSession(lhSession) != S_OK) {</span>
<a href="#l1.559"></a><span id="l1.559" class="difflineplus">+    FLAGS LoginFlag = flFlags &amp; (MAPI_LOGON_UI | MAPI_NEW_SESSION);</span>
<a href="#l1.560"></a><span id="l1.560" class="difflineplus">+    hr = MAPILogon(ulUIParam, nullptr, nullptr, LoginFlag, 0, &amp;lhSession);</span>
<a href="#l1.561"></a><span id="l1.561" class="difflineplus">+    if (hr != SUCCESS_SUCCESS) return MAPI_E_LOGIN_FAILURE;</span>
<a href="#l1.562"></a><span id="l1.562" class="difflineplus">+    bTempSession = TRUE;</span>
<a href="#l1.563"></a><span id="l1.563" class="difflineplus">+  }</span>
<a href="#l1.564"></a><span id="l1.564" class="difflineplus">+</span>
<a href="#l1.565"></a><span id="l1.565" class="difflineplus">+  hr = pNsMapi-&gt;SendMailW(lhSession, lpMessage, flFlags, ulReserved);</span>
<a href="#l1.566"></a><span id="l1.566"> </span>
<a href="#l1.567"></a><span id="l1.567" class="difflineminus">-    hr = pNsMapi-&gt;SendMailW(lhSession, lpMessage, flFlags, ulReserved);</span>
<a href="#l1.568"></a><span id="l1.568" class="difflineplus">+  // we are seeing a problem when using Word, although we return success from</span>
<a href="#l1.569"></a><span id="l1.569" class="difflineplus">+  // the MAPI support MS COM interface in mozilla, we are getting this error</span>
<a href="#l1.570"></a><span id="l1.570" class="difflineplus">+  // here. This is a temporary hack !!</span>
<a href="#l1.571"></a><span id="l1.571" class="difflineplus">+  if (hr == 0x800703e6) hr = SUCCESS_SUCCESS;</span>
<a href="#l1.572"></a><span id="l1.572"> </span>
<a href="#l1.573"></a><span id="l1.573" class="difflineminus">-    // we are seeing a problem when using Word, although we return success from the MAPI support</span>
<a href="#l1.574"></a><span id="l1.574" class="difflineminus">-    // MS COM interface in mozilla, we are getting this error here. This is a temporary hack !!</span>
<a href="#l1.575"></a><span id="l1.575" class="difflineminus">-    if (hr == 0x800703e6)</span>
<a href="#l1.576"></a><span id="l1.576" class="difflineminus">-      hr = SUCCESS_SUCCESS;</span>
<a href="#l1.577"></a><span id="l1.577" class="difflineplus">+  if (bTempSession) MAPILogoff(lhSession, ulUIParam, 0, 0);</span>
<a href="#l1.578"></a><span id="l1.578"> </span>
<a href="#l1.579"></a><span id="l1.579" class="difflineminus">-    if (bTempSession)</span>
<a href="#l1.580"></a><span id="l1.580" class="difflineminus">-      MAPILogoff(lhSession, ulUIParam, 0, 0);</span>
<a href="#l1.581"></a><span id="l1.581" class="difflineminus">-</span>
<a href="#l1.582"></a><span id="l1.582" class="difflineminus">-    return hr;</span>
<a href="#l1.583"></a><span id="l1.583" class="difflineplus">+  return hr;</span>
<a href="#l1.584"></a><span id="l1.584"> }</span>
<a href="#l1.585"></a><span id="l1.585"> </span>
<a href="#l1.586"></a><span id="l1.586" class="difflineminus">-ULONG FAR PASCAL MAPISendDocuments(ULONG ulUIParam, LPSTR lpszDelimChar, LPSTR lpszFilePaths,</span>
<a href="#l1.587"></a><span id="l1.587" class="difflineminus">-                                   LPSTR lpszFileNames, ULONG ulReserved)</span>
<a href="#l1.588"></a><span id="l1.588" class="difflineminus">-{</span>
<a href="#l1.589"></a><span id="l1.589" class="difflineminus">-    LHANDLE lhSession ;</span>
<a href="#l1.590"></a><span id="l1.590" class="difflineminus">-    nsIMapi *pNsMapi = NULL;</span>
<a href="#l1.591"></a><span id="l1.591" class="difflineplus">+ULONG FAR PASCAL MAPISendDocuments(ULONG ulUIParam, LPSTR lpszDelimChar,</span>
<a href="#l1.592"></a><span id="l1.592" class="difflineplus">+                                   LPSTR lpszFilePaths, LPSTR lpszFileNames,</span>
<a href="#l1.593"></a><span id="l1.593" class="difflineplus">+                                   ULONG ulReserved) {</span>
<a href="#l1.594"></a><span id="l1.594" class="difflineplus">+  LHANDLE lhSession;</span>
<a href="#l1.595"></a><span id="l1.595" class="difflineplus">+  nsIMapi *pNsMapi = NULL;</span>
<a href="#l1.596"></a><span id="l1.596"> </span>
<a href="#l1.597"></a><span id="l1.597" class="difflineminus">-    if (!InitMozillaReference(&amp;pNsMapi))</span>
<a href="#l1.598"></a><span id="l1.598" class="difflineminus">-        return MAPI_E_FAILURE;</span>
<a href="#l1.599"></a><span id="l1.599" class="difflineplus">+  if (!InitMozillaReference(&amp;pNsMapi)) return MAPI_E_FAILURE;</span>
<a href="#l1.600"></a><span id="l1.600"> </span>
<a href="#l1.601"></a><span id="l1.601" class="difflineminus">-    unsigned long result = MAPILogon(ulUIParam, nullptr, nullptr, MAPI_LOGON_UI, 0, &amp;lhSession);</span>
<a href="#l1.602"></a><span id="l1.602" class="difflineminus">-    if (result != SUCCESS_SUCCESS)</span>
<a href="#l1.603"></a><span id="l1.603" class="difflineminus">-        return MAPI_E_LOGIN_FAILURE ;</span>
<a href="#l1.604"></a><span id="l1.604" class="difflineplus">+  unsigned long result =</span>
<a href="#l1.605"></a><span id="l1.605" class="difflineplus">+      MAPILogon(ulUIParam, nullptr, nullptr, MAPI_LOGON_UI, 0, &amp;lhSession);</span>
<a href="#l1.606"></a><span id="l1.606" class="difflineplus">+  if (result != SUCCESS_SUCCESS) return MAPI_E_LOGIN_FAILURE;</span>
<a href="#l1.607"></a><span id="l1.607"> </span>
<a href="#l1.608"></a><span id="l1.608" class="difflineminus">-    HRESULT hr;</span>
<a href="#l1.609"></a><span id="l1.609" class="difflineplus">+  HRESULT hr;</span>
<a href="#l1.610"></a><span id="l1.610"> </span>
<a href="#l1.611"></a><span id="l1.611" class="difflineminus">-    hr = pNsMapi-&gt;SendDocuments(lhSession, lpszDelimChar, lpszFilePaths, lpszFileNames, ulReserved);</span>
<a href="#l1.612"></a><span id="l1.612" class="difflineplus">+  hr = pNsMapi-&gt;SendDocuments(lhSession, lpszDelimChar, lpszFilePaths,</span>
<a href="#l1.613"></a><span id="l1.613" class="difflineplus">+                              lpszFileNames, ulReserved);</span>
<a href="#l1.614"></a><span id="l1.614"> </span>
<a href="#l1.615"></a><span id="l1.615" class="difflineminus">-    MAPILogoff (lhSession, ulUIParam, 0,0) ;</span>
<a href="#l1.616"></a><span id="l1.616" class="difflineplus">+  MAPILogoff(lhSession, ulUIParam, 0, 0);</span>
<a href="#l1.617"></a><span id="l1.617"> </span>
<a href="#l1.618"></a><span id="l1.618" class="difflineminus">-    return hr ;</span>
<a href="#l1.619"></a><span id="l1.619" class="difflineplus">+  return hr;</span>
<a href="#l1.620"></a><span id="l1.620"> }</span>
<a href="#l1.621"></a><span id="l1.621"> </span>
<a href="#l1.622"></a><span id="l1.622" class="difflineminus">-ULONG FAR PASCAL MAPIFindNext(LHANDLE lhSession, ULONG ulUIParam, const LPSTR lpszMessageType,</span>
<a href="#l1.623"></a><span id="l1.623" class="difflineminus">-                              const LPSTR lpszSeedMessageID, FLAGS flFlags, ULONG ulReserved,</span>
<a href="#l1.624"></a><span id="l1.624" class="difflineminus">-                              unsigned char lpszMessageID[64])</span>
<a href="#l1.625"></a><span id="l1.625" class="difflineminus">-{</span>
<a href="#l1.626"></a><span id="l1.626" class="difflineplus">+ULONG FAR PASCAL MAPIFindNext(LHANDLE lhSession, ULONG ulUIParam,</span>
<a href="#l1.627"></a><span id="l1.627" class="difflineplus">+                              const LPSTR lpszMessageType,</span>
<a href="#l1.628"></a><span id="l1.628" class="difflineplus">+                              const LPSTR lpszSeedMessageID, FLAGS flFlags,</span>
<a href="#l1.629"></a><span id="l1.629" class="difflineplus">+                              ULONG ulReserved,</span>
<a href="#l1.630"></a><span id="l1.630" class="difflineplus">+                              unsigned char lpszMessageID[64]) {</span>
<a href="#l1.631"></a><span id="l1.631">   nsIMapi *pNsMapi = NULL;</span>
<a href="#l1.632"></a><span id="l1.632"> </span>
<a href="#l1.633"></a><span id="l1.633" class="difflineminus">-  if (!InitMozillaReference(&amp;pNsMapi))</span>
<a href="#l1.634"></a><span id="l1.634" class="difflineminus">-    return MAPI_E_FAILURE;</span>
<a href="#l1.635"></a><span id="l1.635" class="difflineplus">+  if (!InitMozillaReference(&amp;pNsMapi)) return MAPI_E_FAILURE;</span>
<a href="#l1.636"></a><span id="l1.636" class="difflineplus">+</span>
<a href="#l1.637"></a><span id="l1.637" class="difflineplus">+  if (lhSession == 0) return MAPI_E_INVALID_SESSION;</span>
<a href="#l1.638"></a><span id="l1.638"> </span>
<a href="#l1.639"></a><span id="l1.639" class="difflineminus">-  if (lhSession == 0)</span>
<a href="#l1.640"></a><span id="l1.640" class="difflineminus">-    return MAPI_E_INVALID_SESSION;</span>
<a href="#l1.641"></a><span id="l1.641" class="difflineminus">-</span>
<a href="#l1.642"></a><span id="l1.642" class="difflineminus">-  return pNsMapi-&gt;FindNext(lhSession, ulUIParam, lpszMessageType, lpszSeedMessageID,</span>
<a href="#l1.643"></a><span id="l1.643" class="difflineminus">-                           flFlags, ulReserved, lpszMessageID);</span>
<a href="#l1.644"></a><span id="l1.644" class="difflineplus">+  return pNsMapi-&gt;FindNext(lhSession, ulUIParam, lpszMessageType,</span>
<a href="#l1.645"></a><span id="l1.645" class="difflineplus">+                           lpszSeedMessageID, flFlags, ulReserved,</span>
<a href="#l1.646"></a><span id="l1.646" class="difflineplus">+                           lpszMessageID);</span>
<a href="#l1.647"></a><span id="l1.647"> }</span>
<a href="#l1.648"></a><span id="l1.648"> </span>
<a href="#l1.649"></a><span id="l1.649" class="difflineminus">-</span>
<a href="#l1.650"></a><span id="l1.650" class="difflineminus">-ULONG FAR PASCAL MAPIReadMail(LHANDLE lhSession, ULONG ulUIParam, LPSTR lpszMessageID,</span>
<a href="#l1.651"></a><span id="l1.651" class="difflineminus">-                              FLAGS flFlags, ULONG ulReserved, nsMapiMessage **lppMessage)</span>
<a href="#l1.652"></a><span id="l1.652" class="difflineminus">-{</span>
<a href="#l1.653"></a><span id="l1.653" class="difflineplus">+ULONG FAR PASCAL MAPIReadMail(LHANDLE lhSession, ULONG ulUIParam,</span>
<a href="#l1.654"></a><span id="l1.654" class="difflineplus">+                              LPSTR lpszMessageID, FLAGS flFlags,</span>
<a href="#l1.655"></a><span id="l1.655" class="difflineplus">+                              ULONG ulReserved, nsMapiMessage **lppMessage) {</span>
<a href="#l1.656"></a><span id="l1.656">   nsIMapi *pNsMapi = NULL;</span>
<a href="#l1.657"></a><span id="l1.657"> </span>
<a href="#l1.658"></a><span id="l1.658" class="difflineminus">-  if (!InitMozillaReference(&amp;pNsMapi))</span>
<a href="#l1.659"></a><span id="l1.659" class="difflineminus">-    return MAPI_E_FAILURE;</span>
<a href="#l1.660"></a><span id="l1.660" class="difflineplus">+  if (!InitMozillaReference(&amp;pNsMapi)) return MAPI_E_FAILURE;</span>
<a href="#l1.661"></a><span id="l1.661"> </span>
<a href="#l1.662"></a><span id="l1.662" class="difflineminus">-  if (lhSession == 0)</span>
<a href="#l1.663"></a><span id="l1.663" class="difflineminus">-    return MAPI_E_INVALID_SESSION;</span>
<a href="#l1.664"></a><span id="l1.664" class="difflineplus">+  if (lhSession == 0) return MAPI_E_INVALID_SESSION;</span>
<a href="#l1.665"></a><span id="l1.665"> </span>
<a href="#l1.666"></a><span id="l1.666" class="difflineminus">-  return pNsMapi-&gt;ReadMail(lhSession, ulUIParam,</span>
<a href="#l1.667"></a><span id="l1.667" class="difflineminus">-                              lpszMessageID, flFlags, ulReserved,</span>
<a href="#l1.668"></a><span id="l1.668" class="difflineminus">-                              lppMessage) ;</span>
<a href="#l1.669"></a><span id="l1.669" class="difflineminus">-</span>
<a href="#l1.670"></a><span id="l1.670" class="difflineplus">+  return pNsMapi-&gt;ReadMail(lhSession, ulUIParam, lpszMessageID, flFlags,</span>
<a href="#l1.671"></a><span id="l1.671" class="difflineplus">+                           ulReserved, lppMessage);</span>
<a href="#l1.672"></a><span id="l1.672"> }</span>
<a href="#l1.673"></a><span id="l1.673"> </span>
<a href="#l1.674"></a><span id="l1.674" class="difflineminus">-ULONG FAR PASCAL MAPISaveMail(LHANDLE lhSession, ULONG ulUIParam, lpnsMapiMessage lpMessage,</span>
<a href="#l1.675"></a><span id="l1.675" class="difflineminus">-                              FLAGS flFlags, ULONG ulReserved, LPSTR lpszMessageID)</span>
<a href="#l1.676"></a><span id="l1.676" class="difflineminus">-{</span>
<a href="#l1.677"></a><span id="l1.677" class="difflineplus">+ULONG FAR PASCAL MAPISaveMail(LHANDLE lhSession, ULONG ulUIParam,</span>
<a href="#l1.678"></a><span id="l1.678" class="difflineplus">+                              lpnsMapiMessage lpMessage, FLAGS flFlags,</span>
<a href="#l1.679"></a><span id="l1.679" class="difflineplus">+                              ULONG ulReserved, LPSTR lpszMessageID) {</span>
<a href="#l1.680"></a><span id="l1.680">   nsIMapi *pNsMapi = NULL;</span>
<a href="#l1.681"></a><span id="l1.681"> </span>
<a href="#l1.682"></a><span id="l1.682" class="difflineminus">-  if (lhSession == 0)</span>
<a href="#l1.683"></a><span id="l1.683" class="difflineminus">-    return MAPI_E_INVALID_SESSION;</span>
<a href="#l1.684"></a><span id="l1.684" class="difflineplus">+  if (lhSession == 0) return MAPI_E_INVALID_SESSION;</span>
<a href="#l1.685"></a><span id="l1.685"> </span>
<a href="#l1.686"></a><span id="l1.686" class="difflineminus">-  if (!InitMozillaReference(&amp;pNsMapi))</span>
<a href="#l1.687"></a><span id="l1.687" class="difflineminus">-    return MAPI_E_FAILURE;</span>
<a href="#l1.688"></a><span id="l1.688" class="difflineplus">+  if (!InitMozillaReference(&amp;pNsMapi)) return MAPI_E_FAILURE;</span>
<a href="#l1.689"></a><span id="l1.689"> </span>
<a href="#l1.690"></a><span id="l1.690">   return MAPI_E_FAILURE;</span>
<a href="#l1.691"></a><span id="l1.691"> }</span>
<a href="#l1.692"></a><span id="l1.692"> </span>
<a href="#l1.693"></a><span id="l1.693" class="difflineminus">-ULONG FAR PASCAL MAPIDeleteMail(LHANDLE lhSession, ULONG ulUIParam, LPSTR lpszMessageID,</span>
<a href="#l1.694"></a><span id="l1.694" class="difflineminus">-                                FLAGS flFlags, ULONG ulReserved)</span>
<a href="#l1.695"></a><span id="l1.695" class="difflineminus">-{</span>
<a href="#l1.696"></a><span id="l1.696" class="difflineplus">+ULONG FAR PASCAL MAPIDeleteMail(LHANDLE lhSession, ULONG ulUIParam,</span>
<a href="#l1.697"></a><span id="l1.697" class="difflineplus">+                                LPSTR lpszMessageID, FLAGS flFlags,</span>
<a href="#l1.698"></a><span id="l1.698" class="difflineplus">+                                ULONG ulReserved) {</span>
<a href="#l1.699"></a><span id="l1.699">   nsIMapi *pNsMapi = NULL;</span>
<a href="#l1.700"></a><span id="l1.700"> </span>
<a href="#l1.701"></a><span id="l1.701" class="difflineminus">-  if (lhSession == 0)</span>
<a href="#l1.702"></a><span id="l1.702" class="difflineminus">-    return MAPI_E_INVALID_SESSION;</span>
<a href="#l1.703"></a><span id="l1.703" class="difflineplus">+  if (lhSession == 0) return MAPI_E_INVALID_SESSION;</span>
<a href="#l1.704"></a><span id="l1.704"> </span>
<a href="#l1.705"></a><span id="l1.705" class="difflineminus">-  if (!InitMozillaReference(&amp;pNsMapi))</span>
<a href="#l1.706"></a><span id="l1.706" class="difflineminus">-    return MAPI_E_FAILURE;</span>
<a href="#l1.707"></a><span id="l1.707" class="difflineplus">+  if (!InitMozillaReference(&amp;pNsMapi)) return MAPI_E_FAILURE;</span>
<a href="#l1.708"></a><span id="l1.708"> </span>
<a href="#l1.709"></a><span id="l1.709" class="difflineminus">-  return pNsMapi-&gt;DeleteMail(lhSession, ulUIParam,</span>
<a href="#l1.710"></a><span id="l1.710" class="difflineminus">-                              lpszMessageID, flFlags, ulReserved) ;</span>
<a href="#l1.711"></a><span id="l1.711" class="difflineplus">+  return pNsMapi-&gt;DeleteMail(lhSession, ulUIParam, lpszMessageID, flFlags,</span>
<a href="#l1.712"></a><span id="l1.712" class="difflineplus">+                             ulReserved);</span>
<a href="#l1.713"></a><span id="l1.713"> }</span>
<a href="#l1.714"></a><span id="l1.714"> </span>
<a href="#l1.715"></a><span id="l1.715" class="difflineminus">-ULONG FAR PASCAL MAPIAddress(LHANDLE lhSession, ULONG ulUIParam, LPSTR lpszCaption,</span>
<a href="#l1.716"></a><span id="l1.716" class="difflineminus">-                             ULONG nEditFields, LPSTR lpszLabels, ULONG nRecips,</span>
<a href="#l1.717"></a><span id="l1.717" class="difflineplus">+ULONG FAR PASCAL MAPIAddress(LHANDLE lhSession, ULONG ulUIParam,</span>
<a href="#l1.718"></a><span id="l1.718" class="difflineplus">+                             LPSTR lpszCaption, ULONG nEditFields,</span>
<a href="#l1.719"></a><span id="l1.719" class="difflineplus">+                             LPSTR lpszLabels, ULONG nRecips,</span>
<a href="#l1.720"></a><span id="l1.720">                              lpMapiRecipDesc lpRecips, FLAGS flFlags,</span>
<a href="#l1.721"></a><span id="l1.721">                              ULONG ulReserved, LPULONG lpnNewRecips,</span>
<a href="#l1.722"></a><span id="l1.722" class="difflineminus">-                             lpMapiRecipDesc FAR *lppNewRecips)</span>
<a href="#l1.723"></a><span id="l1.723" class="difflineminus">-{</span>
<a href="#l1.724"></a><span id="l1.724" class="difflineminus">-    return MAPI_E_NOT_SUPPORTED;</span>
<a href="#l1.725"></a><span id="l1.725" class="difflineplus">+                             lpMapiRecipDesc FAR *lppNewRecips) {</span>
<a href="#l1.726"></a><span id="l1.726" class="difflineplus">+  return MAPI_E_NOT_SUPPORTED;</span>
<a href="#l1.727"></a><span id="l1.727"> }</span>
<a href="#l1.728"></a><span id="l1.728"> </span>
<a href="#l1.729"></a><span id="l1.729" class="difflineminus">-ULONG FAR PASCAL MAPIDetails(LHANDLE lhSession, ULONG ulUIParam, lpMapiRecipDesc lpRecip,</span>
<a href="#l1.730"></a><span id="l1.730" class="difflineminus">-                             FLAGS flFlags, ULONG ulReserved)</span>
<a href="#l1.731"></a><span id="l1.731" class="difflineminus">-{</span>
<a href="#l1.732"></a><span id="l1.732" class="difflineminus">-    return MAPI_E_NOT_SUPPORTED;</span>
<a href="#l1.733"></a><span id="l1.733" class="difflineplus">+ULONG FAR PASCAL MAPIDetails(LHANDLE lhSession, ULONG ulUIParam,</span>
<a href="#l1.734"></a><span id="l1.734" class="difflineplus">+                             lpMapiRecipDesc lpRecip, FLAGS flFlags,</span>
<a href="#l1.735"></a><span id="l1.735" class="difflineplus">+                             ULONG ulReserved) {</span>
<a href="#l1.736"></a><span id="l1.736" class="difflineplus">+  return MAPI_E_NOT_SUPPORTED;</span>
<a href="#l1.737"></a><span id="l1.737"> }</span>
<a href="#l1.738"></a><span id="l1.738"> </span>
<a href="#l1.739"></a><span id="l1.739" class="difflineminus">-ULONG FAR PASCAL MAPIResolveName(LHANDLE lhSession, ULONG ulUIParam, LPSTR lpszName,</span>
<a href="#l1.740"></a><span id="l1.740" class="difflineminus">-                                 FLAGS flFlags, ULONG ulReserved, lpMapiRecipDesc FAR *lppRecip)</span>
<a href="#l1.741"></a><span id="l1.741" class="difflineminus">-{</span>
<a href="#l1.742"></a><span id="l1.742" class="difflineminus">-  char* lpszRecipName = new char[(strlen((const char*)lpszName) + 1)];</span>
<a href="#l1.743"></a><span id="l1.743" class="difflineminus">-  if (lpszRecipName == NULL)</span>
<a href="#l1.744"></a><span id="l1.744" class="difflineminus">-    return MAPI_E_INSUFFICIENT_MEMORY;</span>
<a href="#l1.745"></a><span id="l1.745" class="difflineminus">-  char* lpszRecipAddress = new char[(strlen((const char*)lpszName) + 6)];</span>
<a href="#l1.746"></a><span id="l1.746" class="difflineplus">+ULONG FAR PASCAL MAPIResolveName(LHANDLE lhSession, ULONG ulUIParam,</span>
<a href="#l1.747"></a><span id="l1.747" class="difflineplus">+                                 LPSTR lpszName, FLAGS flFlags,</span>
<a href="#l1.748"></a><span id="l1.748" class="difflineplus">+                                 ULONG ulReserved,</span>
<a href="#l1.749"></a><span id="l1.749" class="difflineplus">+                                 lpMapiRecipDesc FAR *lppRecip) {</span>
<a href="#l1.750"></a><span id="l1.750" class="difflineplus">+  char *lpszRecipName = new char[(strlen((const char *)lpszName) + 1)];</span>
<a href="#l1.751"></a><span id="l1.751" class="difflineplus">+  if (lpszRecipName == NULL) return MAPI_E_INSUFFICIENT_MEMORY;</span>
<a href="#l1.752"></a><span id="l1.752" class="difflineplus">+  char *lpszRecipAddress = new char[(strlen((const char *)lpszName) + 6)];</span>
<a href="#l1.753"></a><span id="l1.753">   if (!lpszRecipAddress) {</span>
<a href="#l1.754"></a><span id="l1.754">     delete[] lpszRecipName;</span>
<a href="#l1.755"></a><span id="l1.755">     return MAPI_E_INSUFFICIENT_MEMORY;</span>
<a href="#l1.756"></a><span id="l1.756">   }</span>
<a href="#l1.757"></a><span id="l1.757" class="difflineminus">-  strcpy(lpszRecipName, (const char*)lpszName);</span>
<a href="#l1.758"></a><span id="l1.758" class="difflineminus">-  strcpy(lpszRecipAddress, (const char*)lpszName);</span>
<a href="#l1.759"></a><span id="l1.759" class="difflineplus">+  strcpy(lpszRecipName, (const char *)lpszName);</span>
<a href="#l1.760"></a><span id="l1.760" class="difflineplus">+  strcpy(lpszRecipAddress, (const char *)lpszName);</span>
<a href="#l1.761"></a><span id="l1.761">   (*lppRecip) = (lpMapiRecipDesc FAR)malloc(sizeof(MapiRecipDesc));</span>
<a href="#l1.762"></a><span id="l1.762">   if (!(*lppRecip)) {</span>
<a href="#l1.763"></a><span id="l1.763">     delete[] lpszRecipName;</span>
<a href="#l1.764"></a><span id="l1.764">     delete[] lpszRecipAddress;</span>
<a href="#l1.765"></a><span id="l1.765">     return MAPI_E_INSUFFICIENT_MEMORY;</span>
<a href="#l1.766"></a><span id="l1.766">   }</span>
<a href="#l1.767"></a><span id="l1.767">   (*lppRecip)-&gt;ulRecipClass = 1;</span>
<a href="#l1.768"></a><span id="l1.768">   (*lppRecip)-&gt;lpszName = lpszRecipName;</span>
<a href="#l1.769"></a><span id="l1.769" class="difflineat">@@ -419,125 +489,89 @@ ULONG FAR PASCAL MAPIResolveName(LHANDLE</span>
<a href="#l1.770"></a><span id="l1.770">   (*lppRecip)-&gt;ulEIDSize = 0;</span>
<a href="#l1.771"></a><span id="l1.771">   (*lppRecip)-&gt;lpEntryID = 0;</span>
<a href="#l1.772"></a><span id="l1.772">   return SUCCESS_SUCCESS;</span>
<a href="#l1.773"></a><span id="l1.773"> }</span>
<a href="#l1.774"></a><span id="l1.774"> </span>
<a href="#l1.775"></a><span id="l1.775"> void FreeMAPIRecipient(lpMapiRecipDesc pv);</span>
<a href="#l1.776"></a><span id="l1.776"> void FreeMAPIMessage(lpMapiMessage pv);</span>
<a href="#l1.777"></a><span id="l1.777"> </span>
<a href="#l1.778"></a><span id="l1.778" class="difflineminus">-ULONG FAR PASCAL MAPIFreeBuffer(LPVOID pv)</span>
<a href="#l1.779"></a><span id="l1.779" class="difflineminus">-{</span>
<a href="#l1.780"></a><span id="l1.780" class="difflineminus">-  int   i;</span>
<a href="#l1.781"></a><span id="l1.781" class="difflineminus">-</span>
<a href="#l1.782"></a><span id="l1.782" class="difflineminus">-  if (!pv)</span>
<a href="#l1.783"></a><span id="l1.783" class="difflineminus">-    return S_OK;</span>
<a href="#l1.784"></a><span id="l1.784" class="difflineplus">+ULONG FAR PASCAL MAPIFreeBuffer(LPVOID pv) {</span>
<a href="#l1.785"></a><span id="l1.785" class="difflineplus">+  int i;</span>
<a href="#l1.786"></a><span id="l1.786"> </span>
<a href="#l1.787"></a><span id="l1.787" class="difflineminus">-  for (i=0; i&lt;MAX_POINTERS; i++)</span>
<a href="#l1.788"></a><span id="l1.788" class="difflineminus">-  {</span>
<a href="#l1.789"></a><span id="l1.789" class="difflineminus">-    if (pv == memArray[i].lpMem)</span>
<a href="#l1.790"></a><span id="l1.790" class="difflineminus">-    {</span>
<a href="#l1.791"></a><span id="l1.791" class="difflineminus">-      if (memArray[i].memType == MAPI_MESSAGE_TYPE)</span>
<a href="#l1.792"></a><span id="l1.792" class="difflineminus">-      {</span>
<a href="#l1.793"></a><span id="l1.793" class="difflineplus">+  if (!pv) return S_OK;</span>
<a href="#l1.794"></a><span id="l1.794" class="difflineplus">+</span>
<a href="#l1.795"></a><span id="l1.795" class="difflineplus">+  for (i = 0; i &lt; MAX_POINTERS; i++) {</span>
<a href="#l1.796"></a><span id="l1.796" class="difflineplus">+    if (pv == memArray[i].lpMem) {</span>
<a href="#l1.797"></a><span id="l1.797" class="difflineplus">+      if (memArray[i].memType == MAPI_MESSAGE_TYPE) {</span>
<a href="#l1.798"></a><span id="l1.798">         FreeMAPIMessage((MapiMessage *)pv);</span>
<a href="#l1.799"></a><span id="l1.799">         memArray[i].lpMem = NULL;</span>
<a href="#l1.800"></a><span id="l1.800" class="difflineminus">-      }</span>
<a href="#l1.801"></a><span id="l1.801" class="difflineminus">-      else if (memArray[i].memType == MAPI_RECIPIENT_TYPE)</span>
<a href="#l1.802"></a><span id="l1.802" class="difflineminus">-      {</span>
<a href="#l1.803"></a><span id="l1.803" class="difflineplus">+      } else if (memArray[i].memType == MAPI_RECIPIENT_TYPE) {</span>
<a href="#l1.804"></a><span id="l1.804">         FreeMAPIRecipient((MapiRecipDesc *)pv);</span>
<a href="#l1.805"></a><span id="l1.805">         memArray[i].lpMem = NULL;</span>
<a href="#l1.806"></a><span id="l1.806">       }</span>
<a href="#l1.807"></a><span id="l1.807">     }</span>
<a href="#l1.808"></a><span id="l1.808">   }</span>
<a href="#l1.809"></a><span id="l1.809"> </span>
<a href="#l1.810"></a><span id="l1.810">   pv = NULL;</span>
<a href="#l1.811"></a><span id="l1.811">   return S_OK;</span>
<a href="#l1.812"></a><span id="l1.812"> }</span>
<a href="#l1.813"></a><span id="l1.813"> </span>
<a href="#l1.814"></a><span id="l1.814" class="difflineminus">-ULONG FAR PASCAL GetMapiDllVersion()</span>
<a href="#l1.815"></a><span id="l1.815" class="difflineminus">-{</span>
<a href="#l1.816"></a><span id="l1.816" class="difflineminus">-  return 94;</span>
<a href="#l1.817"></a><span id="l1.817" class="difflineplus">+ULONG FAR PASCAL GetMapiDllVersion() { return 94; }</span>
<a href="#l1.818"></a><span id="l1.818" class="difflineplus">+</span>
<a href="#l1.819"></a><span id="l1.819" class="difflineplus">+void FreeMAPIFile(lpMapiFileDesc pv) {</span>
<a href="#l1.820"></a><span id="l1.820" class="difflineplus">+  if (!pv) return;</span>
<a href="#l1.821"></a><span id="l1.821" class="difflineplus">+</span>
<a href="#l1.822"></a><span id="l1.822" class="difflineplus">+  if (pv-&gt;lpszPathName != NULL) free(pv-&gt;lpszPathName);</span>
<a href="#l1.823"></a><span id="l1.823" class="difflineplus">+</span>
<a href="#l1.824"></a><span id="l1.824" class="difflineplus">+  if (pv-&gt;lpszFileName != NULL) free(pv-&gt;lpszFileName);</span>
<a href="#l1.825"></a><span id="l1.825"> }</span>
<a href="#l1.826"></a><span id="l1.826"> </span>
<a href="#l1.827"></a><span id="l1.827" class="difflineminus">-void</span>
<a href="#l1.828"></a><span id="l1.828" class="difflineminus">-FreeMAPIFile(lpMapiFileDesc pv)</span>
<a href="#l1.829"></a><span id="l1.829" class="difflineminus">-{</span>
<a href="#l1.830"></a><span id="l1.830" class="difflineminus">-  if (!pv)</span>
<a href="#l1.831"></a><span id="l1.831" class="difflineminus">-    return;</span>
<a href="#l1.832"></a><span id="l1.832" class="difflineminus">-</span>
<a href="#l1.833"></a><span id="l1.833" class="difflineminus">-  if (pv-&gt;lpszPathName != NULL)</span>
<a href="#l1.834"></a><span id="l1.834" class="difflineminus">-    free(pv-&gt;lpszPathName);</span>
<a href="#l1.835"></a><span id="l1.835" class="difflineminus">-</span>
<a href="#l1.836"></a><span id="l1.836" class="difflineminus">-  if (pv-&gt;lpszFileName != NULL)</span>
<a href="#l1.837"></a><span id="l1.837" class="difflineminus">-    free(pv-&gt;lpszFileName);</span>
<a href="#l1.838"></a><span id="l1.838" class="difflineminus">-}</span>
<a href="#l1.839"></a><span id="l1.839" class="difflineminus">-</span>
<a href="#l1.840"></a><span id="l1.840" class="difflineminus">-void</span>
<a href="#l1.841"></a><span id="l1.841" class="difflineminus">-FreeMAPIMessage(lpMapiMessage pv)</span>
<a href="#l1.842"></a><span id="l1.842" class="difflineminus">-{</span>
<a href="#l1.843"></a><span id="l1.843" class="difflineplus">+void FreeMAPIMessage(lpMapiMessage pv) {</span>
<a href="#l1.844"></a><span id="l1.844">   ULONG i;</span>
<a href="#l1.845"></a><span id="l1.845"> </span>
<a href="#l1.846"></a><span id="l1.846" class="difflineminus">-  if (!pv)</span>
<a href="#l1.847"></a><span id="l1.847" class="difflineminus">-    return;</span>
<a href="#l1.848"></a><span id="l1.848" class="difflineplus">+  if (!pv) return;</span>
<a href="#l1.849"></a><span id="l1.849"> </span>
<a href="#l1.850"></a><span id="l1.850" class="difflineminus">-  if (pv-&gt;lpszSubject != NULL)</span>
<a href="#l1.851"></a><span id="l1.851" class="difflineminus">-    free(pv-&gt;lpszSubject);</span>
<a href="#l1.852"></a><span id="l1.852" class="difflineplus">+  if (pv-&gt;lpszSubject != NULL) free(pv-&gt;lpszSubject);</span>
<a href="#l1.853"></a><span id="l1.853"> </span>
<a href="#l1.854"></a><span id="l1.854" class="difflineminus">-  if (pv-&gt;lpszNoteText)</span>
<a href="#l1.855"></a><span id="l1.855" class="difflineminus">-      free(pv-&gt;lpszNoteText);</span>
<a href="#l1.856"></a><span id="l1.856" class="difflineplus">+  if (pv-&gt;lpszNoteText) free(pv-&gt;lpszNoteText);</span>
<a href="#l1.857"></a><span id="l1.857"> </span>
<a href="#l1.858"></a><span id="l1.858" class="difflineminus">-  if (pv-&gt;lpszMessageType)</span>
<a href="#l1.859"></a><span id="l1.859" class="difflineminus">-    free(pv-&gt;lpszMessageType);</span>
<a href="#l1.860"></a><span id="l1.860" class="difflineplus">+  if (pv-&gt;lpszMessageType) free(pv-&gt;lpszMessageType);</span>
<a href="#l1.861"></a><span id="l1.861"> </span>
<a href="#l1.862"></a><span id="l1.862" class="difflineminus">-  if (pv-&gt;lpszDateReceived)</span>
<a href="#l1.863"></a><span id="l1.863" class="difflineminus">-    free(pv-&gt;lpszDateReceived);</span>
<a href="#l1.864"></a><span id="l1.864" class="difflineplus">+  if (pv-&gt;lpszDateReceived) free(pv-&gt;lpszDateReceived);</span>
<a href="#l1.865"></a><span id="l1.865"> </span>
<a href="#l1.866"></a><span id="l1.866" class="difflineminus">-  if (pv-&gt;lpszConversationID)</span>
<a href="#l1.867"></a><span id="l1.867" class="difflineminus">-    free(pv-&gt;lpszConversationID);</span>
<a href="#l1.868"></a><span id="l1.868" class="difflineplus">+  if (pv-&gt;lpszConversationID) free(pv-&gt;lpszConversationID);</span>
<a href="#l1.869"></a><span id="l1.869"> </span>
<a href="#l1.870"></a><span id="l1.870" class="difflineminus">-  if (pv-&gt;lpOriginator)</span>
<a href="#l1.871"></a><span id="l1.871" class="difflineminus">-    FreeMAPIRecipient(pv-&gt;lpOriginator);</span>
<a href="#l1.872"></a><span id="l1.872" class="difflineplus">+  if (pv-&gt;lpOriginator) FreeMAPIRecipient(pv-&gt;lpOriginator);</span>
<a href="#l1.873"></a><span id="l1.873"> </span>
<a href="#l1.874"></a><span id="l1.874" class="difflineminus">-  for (i=0; i&lt;pv-&gt;nRecipCount; i++)</span>
<a href="#l1.875"></a><span id="l1.875" class="difflineminus">-  {</span>
<a href="#l1.876"></a><span id="l1.876" class="difflineminus">-    if (&amp;(pv-&gt;lpRecips[i]) != NULL)</span>
<a href="#l1.877"></a><span id="l1.877" class="difflineminus">-    {</span>
<a href="#l1.878"></a><span id="l1.878" class="difflineplus">+  for (i = 0; i &lt; pv-&gt;nRecipCount; i++) {</span>
<a href="#l1.879"></a><span id="l1.879" class="difflineplus">+    if (&amp;(pv-&gt;lpRecips[i]) != NULL) {</span>
<a href="#l1.880"></a><span id="l1.880">       FreeMAPIRecipient(&amp;(pv-&gt;lpRecips[i]));</span>
<a href="#l1.881"></a><span id="l1.881">     }</span>
<a href="#l1.882"></a><span id="l1.882">   }</span>
<a href="#l1.883"></a><span id="l1.883"> </span>
<a href="#l1.884"></a><span id="l1.884" class="difflineminus">-  if (pv-&gt;lpRecips != NULL)</span>
<a href="#l1.885"></a><span id="l1.885" class="difflineminus">-  {</span>
<a href="#l1.886"></a><span id="l1.886" class="difflineplus">+  if (pv-&gt;lpRecips != NULL) {</span>
<a href="#l1.887"></a><span id="l1.887">     free(pv-&gt;lpRecips);</span>
<a href="#l1.888"></a><span id="l1.888">   }</span>
<a href="#l1.889"></a><span id="l1.889"> </span>
<a href="#l1.890"></a><span id="l1.890" class="difflineminus">-  for (i=0; i&lt;pv-&gt;nFileCount; i++)</span>
<a href="#l1.891"></a><span id="l1.891" class="difflineminus">-  {</span>
<a href="#l1.892"></a><span id="l1.892" class="difflineminus">-    if (&amp;(pv-&gt;lpFiles[i]) != NULL)</span>
<a href="#l1.893"></a><span id="l1.893" class="difflineminus">-    {</span>
<a href="#l1.894"></a><span id="l1.894" class="difflineplus">+  for (i = 0; i &lt; pv-&gt;nFileCount; i++) {</span>
<a href="#l1.895"></a><span id="l1.895" class="difflineplus">+    if (&amp;(pv-&gt;lpFiles[i]) != NULL) {</span>
<a href="#l1.896"></a><span id="l1.896">       FreeMAPIFile(&amp;(pv-&gt;lpFiles[i]));</span>
<a href="#l1.897"></a><span id="l1.897">     }</span>
<a href="#l1.898"></a><span id="l1.898">   }</span>
<a href="#l1.899"></a><span id="l1.899"> </span>
<a href="#l1.900"></a><span id="l1.900" class="difflineminus">-  if (pv-&gt;lpFiles != NULL)</span>
<a href="#l1.901"></a><span id="l1.901" class="difflineminus">-  {</span>
<a href="#l1.902"></a><span id="l1.902" class="difflineplus">+  if (pv-&gt;lpFiles != NULL) {</span>
<a href="#l1.903"></a><span id="l1.903">     free(pv-&gt;lpFiles);</span>
<a href="#l1.904"></a><span id="l1.904">   }</span>
<a href="#l1.905"></a><span id="l1.905"> </span>
<a href="#l1.906"></a><span id="l1.906">   free(pv);</span>
<a href="#l1.907"></a><span id="l1.907">   pv = NULL;</span>
<a href="#l1.908"></a><span id="l1.908"> }</span>
<a href="#l1.909"></a><span id="l1.909"> </span>
<a href="#l1.910"></a><span id="l1.910" class="difflineminus">-void</span>
<a href="#l1.911"></a><span id="l1.911" class="difflineminus">-FreeMAPIRecipient(lpMapiRecipDesc pv)</span>
<a href="#l1.912"></a><span id="l1.912" class="difflineminus">-{</span>
<a href="#l1.913"></a><span id="l1.913" class="difflineminus">-  if (!pv)</span>
<a href="#l1.914"></a><span id="l1.914" class="difflineminus">-    return;</span>
<a href="#l1.915"></a><span id="l1.915" class="difflineplus">+void FreeMAPIRecipient(lpMapiRecipDesc pv) {</span>
<a href="#l1.916"></a><span id="l1.916" class="difflineplus">+  if (!pv) return;</span>
<a href="#l1.917"></a><span id="l1.917" class="difflineplus">+</span>
<a href="#l1.918"></a><span id="l1.918" class="difflineplus">+  if (pv-&gt;lpszName != NULL) free(pv-&gt;lpszName);</span>
<a href="#l1.919"></a><span id="l1.919"> </span>
<a href="#l1.920"></a><span id="l1.920" class="difflineminus">-  if (pv-&gt;lpszName != NULL)</span>
<a href="#l1.921"></a><span id="l1.921" class="difflineminus">-    free(pv-&gt;lpszName);</span>
<a href="#l1.922"></a><span id="l1.922" class="difflineplus">+  if (pv-&gt;lpszAddress != NULL) free(pv-&gt;lpszAddress);</span>
<a href="#l1.923"></a><span id="l1.923"> </span>
<a href="#l1.924"></a><span id="l1.924" class="difflineminus">-  if (pv-&gt;lpszAddress != NULL)</span>
<a href="#l1.925"></a><span id="l1.925" class="difflineminus">-    free(pv-&gt;lpszAddress);</span>
<a href="#l1.926"></a><span id="l1.926" class="difflineminus">-</span>
<a href="#l1.927"></a><span id="l1.927" class="difflineminus">-  if (pv-&gt;lpEntryID != NULL)</span>
<a href="#l1.928"></a><span id="l1.928" class="difflineminus">-    free(pv-&gt;lpEntryID);</span>
<a href="#l1.929"></a><span id="l1.929" class="difflineplus">+  if (pv-&gt;lpEntryID != NULL) free(pv-&gt;lpEntryID);</span>
<a href="#l1.930"></a><span id="l1.930"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/mapi/mapihook/src/Registry.cpp</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/mapi/mapihook/src/Registry.cpp</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -4,288 +4,256 @@</span>
<a href="#l2.4"></a><span id="l2.4"> </span>
<a href="#l2.5"></a><span id="l2.5"> #undef _UNICODE</span>
<a href="#l2.6"></a><span id="l2.6"> #undef UNICODE</span>
<a href="#l2.7"></a><span id="l2.7"> </span>
<a href="#l2.8"></a><span id="l2.8"> #include &lt;objbase.h&gt;</span>
<a href="#l2.9"></a><span id="l2.9"> #include &quot;nsString.h&quot;</span>
<a href="#l2.10"></a><span id="l2.10"> #include &quot;Registry.h&quot;</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-#define MAPI_PROXY_DLL_NAME   u&quot;MapiProxy.dll&quot;</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-#define MAPI_STARTUP_ARG      &quot; /MAPIStartUp&quot;</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-#define MAX_SIZE              2048</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+#define MAPI_PROXY_DLL_NAME u&quot;MapiProxy.dll&quot;</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+#define MAPI_STARTUP_ARG &quot; /MAPIStartUp&quot;</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+#define MAX_SIZE 2048</span>
<a href="#l2.18"></a><span id="l2.18"> </span>
<a href="#l2.19"></a><span id="l2.19"> // Size of a CLSID as a string</span>
<a href="#l2.20"></a><span id="l2.20"> const int CLSID_STRING_SIZE = 39;</span>
<a href="#l2.21"></a><span id="l2.21"> </span>
<a href="#l2.22"></a><span id="l2.22"> // Proxy/Stub Dll Routines</span>
<a href="#l2.23"></a><span id="l2.23"> </span>
<a href="#l2.24"></a><span id="l2.24" class="difflineminus">-typedef HRESULT (__stdcall ProxyServer)();</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineminus">-</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineplus">+typedef HRESULT(__stdcall ProxyServer)();</span>
<a href="#l2.27"></a><span id="l2.27"> </span>
<a href="#l2.28"></a><span id="l2.28"> // Convert a CLSID to a char string.</span>
<a href="#l2.29"></a><span id="l2.29"> </span>
<a href="#l2.30"></a><span id="l2.30" class="difflineminus">-BOOL CLSIDtochar(const CLSID&amp; clsid, char* szCLSID,</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-                 int length)</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineminus">-{</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineminus">-    LPOLESTR wszCLSID = NULL;</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+BOOL CLSIDtochar(const CLSID&amp; clsid, char* szCLSID, int length) {</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+  LPOLESTR wszCLSID = NULL;</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+  // Get CLSID</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+  HRESULT hr = StringFromCLSID(clsid, &amp;wszCLSID);</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+  if (FAILED(hr)) return FALSE;</span>
<a href="#l2.40"></a><span id="l2.40"> </span>
<a href="#l2.41"></a><span id="l2.41" class="difflineminus">-    // Get CLSID</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineminus">-    HRESULT hr = StringFromCLSID(clsid, &amp;wszCLSID);</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineminus">-    if (FAILED(hr))</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineminus">-        return FALSE;</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineplus">+  // Covert from wide characters to non-wide.</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineplus">+  wcstombs(szCLSID, wszCLSID, length);</span>
<a href="#l2.47"></a><span id="l2.47"> </span>
<a href="#l2.48"></a><span id="l2.48" class="difflineminus">-    // Covert from wide characters to non-wide.</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineminus">-    wcstombs(szCLSID, wszCLSID, length);</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineplus">+  // Free memory.</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineplus">+  CoTaskMemFree(wszCLSID);</span>
<a href="#l2.52"></a><span id="l2.52"> </span>
<a href="#l2.53"></a><span id="l2.53" class="difflineminus">-    // Free memory.</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineminus">-    CoTaskMemFree(wszCLSID);</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineminus">-</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineminus">-    return TRUE;</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineplus">+  return TRUE;</span>
<a href="#l2.58"></a><span id="l2.58"> }</span>
<a href="#l2.59"></a><span id="l2.59"> </span>
<a href="#l2.60"></a><span id="l2.60"> // Create a key and set its value.</span>
<a href="#l2.61"></a><span id="l2.61"> </span>
<a href="#l2.62"></a><span id="l2.62"> BOOL setKeyAndValue(nsAutoCString keyName, const char* subKey,</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineminus">-                    const char* theValue)</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineminus">-{</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineminus">-    HKEY hKey;</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineminus">-    BOOL retValue = TRUE;</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineplus">+                    const char* theValue) {</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineplus">+  HKEY hKey;</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineplus">+  BOOL retValue = TRUE;</span>
<a href="#l2.70"></a><span id="l2.70"> </span>
<a href="#l2.71"></a><span id="l2.71" class="difflineminus">-    nsAutoCString theKey(keyName);</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineminus">-    if (subKey != NULL)</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineminus">-    {</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineminus">-        theKey += &quot;\\&quot;;</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineminus">-        theKey += subKey;</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineminus">-    }</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineplus">+  nsAutoCString theKey(keyName);</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineplus">+  if (subKey != NULL) {</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineplus">+    theKey += &quot;\\&quot;;</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineplus">+    theKey += subKey;</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineplus">+  }</span>
<a href="#l2.82"></a><span id="l2.82"> </span>
<a href="#l2.83"></a><span id="l2.83" class="difflineminus">-    // Create and open key and subkey.</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineminus">-    long lResult = RegCreateKeyEx(HKEY_CLASSES_ROOT, theKey.get(),</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineminus">-                                  0, NULL, REG_OPTION_NON_VOLATILE,</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineminus">-                                  KEY_ALL_ACCESS, NULL, &amp;hKey, NULL);</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineminus">-    if (lResult != ERROR_SUCCESS)</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineminus">-        return FALSE ;</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineplus">+  // Create and open key and subkey.</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineplus">+  long lResult = RegCreateKeyEx(HKEY_CLASSES_ROOT, theKey.get(), 0, NULL,</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineplus">+                                REG_OPTION_NON_VOLATILE, KEY_ALL_ACCESS, NULL,</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineplus">+                                &amp;hKey, NULL);</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineplus">+  if (lResult != ERROR_SUCCESS) return FALSE;</span>
<a href="#l2.94"></a><span id="l2.94"> </span>
<a href="#l2.95"></a><span id="l2.95" class="difflineminus">-    // Set the Value.</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineminus">-    if (theValue != NULL)</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineminus">-    {</span>
<a href="#l2.98"></a><span id="l2.98" class="difflineminus">-       lResult = RegSetValueEx(hKey, NULL, 0, REG_SZ, (BYTE *)theValue,</span>
<a href="#l2.99"></a><span id="l2.99" class="difflineminus">-                      strlen(theValue)+1);</span>
<a href="#l2.100"></a><span id="l2.100" class="difflineminus">-       if (lResult != ERROR_SUCCESS)</span>
<a href="#l2.101"></a><span id="l2.101" class="difflineminus">-           retValue = FALSE;</span>
<a href="#l2.102"></a><span id="l2.102" class="difflineminus">-    }</span>
<a href="#l2.103"></a><span id="l2.103" class="difflineplus">+  // Set the Value.</span>
<a href="#l2.104"></a><span id="l2.104" class="difflineplus">+  if (theValue != NULL) {</span>
<a href="#l2.105"></a><span id="l2.105" class="difflineplus">+    lResult = RegSetValueEx(hKey, NULL, 0, REG_SZ, (BYTE*)theValue,</span>
<a href="#l2.106"></a><span id="l2.106" class="difflineplus">+                            strlen(theValue) + 1);</span>
<a href="#l2.107"></a><span id="l2.107" class="difflineplus">+    if (lResult != ERROR_SUCCESS) retValue = FALSE;</span>
<a href="#l2.108"></a><span id="l2.108" class="difflineplus">+  }</span>
<a href="#l2.109"></a><span id="l2.109"> </span>
<a href="#l2.110"></a><span id="l2.110" class="difflineminus">-    RegCloseKey(hKey);</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineminus">-    return TRUE;</span>
<a href="#l2.112"></a><span id="l2.112" class="difflineplus">+  RegCloseKey(hKey);</span>
<a href="#l2.113"></a><span id="l2.113" class="difflineplus">+  return TRUE;</span>
<a href="#l2.114"></a><span id="l2.114"> }</span>
<a href="#l2.115"></a><span id="l2.115"> </span>
<a href="#l2.116"></a><span id="l2.116"> // Delete a key and all of its descendents.</span>
<a href="#l2.117"></a><span id="l2.117"> </span>
<a href="#l2.118"></a><span id="l2.118"> LONG recursiveDeleteKey(HKEY hKeyParent,           // Parent of key to delete</span>
<a href="#l2.119"></a><span id="l2.119">                         const char* lpszKeyChild)  // Key to delete</span>
<a href="#l2.120"></a><span id="l2.120"> {</span>
<a href="#l2.121"></a><span id="l2.121" class="difflineminus">-    // Open the child.</span>
<a href="#l2.122"></a><span id="l2.122" class="difflineminus">-    HKEY hKeyChild ;</span>
<a href="#l2.123"></a><span id="l2.123" class="difflineminus">-    LONG lRes = RegOpenKeyEx(hKeyParent, lpszKeyChild, 0,</span>
<a href="#l2.124"></a><span id="l2.124" class="difflineminus">-                             KEY_ALL_ACCESS, &amp;hKeyChild) ;</span>
<a href="#l2.125"></a><span id="l2.125" class="difflineminus">-    if (lRes != ERROR_SUCCESS)</span>
<a href="#l2.126"></a><span id="l2.126" class="difflineminus">-    {</span>
<a href="#l2.127"></a><span id="l2.127" class="difflineminus">-        return lRes ;</span>
<a href="#l2.128"></a><span id="l2.128" class="difflineminus">-    }</span>
<a href="#l2.129"></a><span id="l2.129" class="difflineplus">+  // Open the child.</span>
<a href="#l2.130"></a><span id="l2.130" class="difflineplus">+  HKEY hKeyChild;</span>
<a href="#l2.131"></a><span id="l2.131" class="difflineplus">+  LONG lRes =</span>
<a href="#l2.132"></a><span id="l2.132" class="difflineplus">+      RegOpenKeyEx(hKeyParent, lpszKeyChild, 0, KEY_ALL_ACCESS, &amp;hKeyChild);</span>
<a href="#l2.133"></a><span id="l2.133" class="difflineplus">+  if (lRes != ERROR_SUCCESS) {</span>
<a href="#l2.134"></a><span id="l2.134" class="difflineplus">+    return lRes;</span>
<a href="#l2.135"></a><span id="l2.135" class="difflineplus">+  }</span>
<a href="#l2.136"></a><span id="l2.136"> </span>
<a href="#l2.137"></a><span id="l2.137" class="difflineminus">-    // Enumerate all of the descendants of this child.</span>
<a href="#l2.138"></a><span id="l2.138" class="difflineminus">-    FILETIME time ;</span>
<a href="#l2.139"></a><span id="l2.139" class="difflineminus">-    char szBuffer[MAX_SIZE] ;</span>
<a href="#l2.140"></a><span id="l2.140" class="difflineminus">-    DWORD dwSize = MAX_SIZE ;</span>
<a href="#l2.141"></a><span id="l2.141" class="difflineminus">-    while (RegEnumKeyEx(hKeyChild, 0, szBuffer, &amp;dwSize, NULL,</span>
<a href="#l2.142"></a><span id="l2.142" class="difflineminus">-                        NULL, NULL, &amp;time) == S_OK)</span>
<a href="#l2.143"></a><span id="l2.143" class="difflineminus">-    {</span>
<a href="#l2.144"></a><span id="l2.144" class="difflineminus">-        // Delete the descendants of this child.</span>
<a href="#l2.145"></a><span id="l2.145" class="difflineminus">-        lRes = recursiveDeleteKey(hKeyChild, szBuffer) ;</span>
<a href="#l2.146"></a><span id="l2.146" class="difflineminus">-        if (lRes != ERROR_SUCCESS)</span>
<a href="#l2.147"></a><span id="l2.147" class="difflineminus">-        {</span>
<a href="#l2.148"></a><span id="l2.148" class="difflineminus">-            // Cleanup before exiting.</span>
<a href="#l2.149"></a><span id="l2.149" class="difflineminus">-            RegCloseKey(hKeyChild) ;</span>
<a href="#l2.150"></a><span id="l2.150" class="difflineminus">-            return lRes;</span>
<a href="#l2.151"></a><span id="l2.151" class="difflineminus">-        }</span>
<a href="#l2.152"></a><span id="l2.152" class="difflineminus">-        dwSize = MAX_SIZE;</span>
<a href="#l2.153"></a><span id="l2.153" class="difflineplus">+  // Enumerate all of the descendants of this child.</span>
<a href="#l2.154"></a><span id="l2.154" class="difflineplus">+  FILETIME time;</span>
<a href="#l2.155"></a><span id="l2.155" class="difflineplus">+  char szBuffer[MAX_SIZE];</span>
<a href="#l2.156"></a><span id="l2.156" class="difflineplus">+  DWORD dwSize = MAX_SIZE;</span>
<a href="#l2.157"></a><span id="l2.157" class="difflineplus">+  while (RegEnumKeyEx(hKeyChild, 0, szBuffer, &amp;dwSize, NULL, NULL, NULL,</span>
<a href="#l2.158"></a><span id="l2.158" class="difflineplus">+                      &amp;time) == S_OK) {</span>
<a href="#l2.159"></a><span id="l2.159" class="difflineplus">+    // Delete the descendants of this child.</span>
<a href="#l2.160"></a><span id="l2.160" class="difflineplus">+    lRes = recursiveDeleteKey(hKeyChild, szBuffer);</span>
<a href="#l2.161"></a><span id="l2.161" class="difflineplus">+    if (lRes != ERROR_SUCCESS) {</span>
<a href="#l2.162"></a><span id="l2.162" class="difflineplus">+      // Cleanup before exiting.</span>
<a href="#l2.163"></a><span id="l2.163" class="difflineplus">+      RegCloseKey(hKeyChild);</span>
<a href="#l2.164"></a><span id="l2.164" class="difflineplus">+      return lRes;</span>
<a href="#l2.165"></a><span id="l2.165">     }</span>
<a href="#l2.166"></a><span id="l2.166" class="difflineplus">+    dwSize = MAX_SIZE;</span>
<a href="#l2.167"></a><span id="l2.167" class="difflineplus">+  }</span>
<a href="#l2.168"></a><span id="l2.168"> </span>
<a href="#l2.169"></a><span id="l2.169" class="difflineminus">-    // Close the child.</span>
<a href="#l2.170"></a><span id="l2.170" class="difflineminus">-    RegCloseKey(hKeyChild) ;</span>
<a href="#l2.171"></a><span id="l2.171" class="difflineplus">+  // Close the child.</span>
<a href="#l2.172"></a><span id="l2.172" class="difflineplus">+  RegCloseKey(hKeyChild);</span>
<a href="#l2.173"></a><span id="l2.173"> </span>
<a href="#l2.174"></a><span id="l2.174" class="difflineminus">-    // Delete this child.</span>
<a href="#l2.175"></a><span id="l2.175" class="difflineminus">-    return RegDeleteKey(hKeyParent, lpszKeyChild) ;</span>
<a href="#l2.176"></a><span id="l2.176" class="difflineplus">+  // Delete this child.</span>
<a href="#l2.177"></a><span id="l2.177" class="difflineplus">+  return RegDeleteKey(hKeyParent, lpszKeyChild);</span>
<a href="#l2.178"></a><span id="l2.178"> }</span>
<a href="#l2.179"></a><span id="l2.179"> </span>
<a href="#l2.180"></a><span id="l2.180" class="difflineminus">-void RegisterProxy()</span>
<a href="#l2.181"></a><span id="l2.181" class="difflineminus">-{</span>
<a href="#l2.182"></a><span id="l2.182" class="difflineminus">-    HINSTANCE h = NULL;</span>
<a href="#l2.183"></a><span id="l2.183" class="difflineminus">-    ProxyServer *RegisterFunc = NULL;</span>
<a href="#l2.184"></a><span id="l2.184" class="difflineplus">+void RegisterProxy() {</span>
<a href="#l2.185"></a><span id="l2.185" class="difflineplus">+  HINSTANCE h = NULL;</span>
<a href="#l2.186"></a><span id="l2.186" class="difflineplus">+  ProxyServer* RegisterFunc = NULL;</span>
<a href="#l2.187"></a><span id="l2.187"> </span>
<a href="#l2.188"></a><span id="l2.188" class="difflineminus">-    WCHAR szModule[MAX_SIZE];</span>
<a href="#l2.189"></a><span id="l2.189" class="difflineminus">-    WCHAR *pTemp = NULL;</span>
<a href="#l2.190"></a><span id="l2.190" class="difflineplus">+  WCHAR szModule[MAX_SIZE];</span>
<a href="#l2.191"></a><span id="l2.191" class="difflineplus">+  WCHAR* pTemp = NULL;</span>
<a href="#l2.192"></a><span id="l2.192"> </span>
<a href="#l2.193"></a><span id="l2.193" class="difflineminus">-    HMODULE hModule = GetModuleHandle(NULL);</span>
<a href="#l2.194"></a><span id="l2.194" class="difflineminus">-    DWORD dwResult  = ::GetModuleFileNameW(hModule, szModule,</span>
<a href="#l2.195"></a><span id="l2.195" class="difflineminus">-                                           sizeof(szModule)/sizeof(WCHAR));</span>
<a href="#l2.196"></a><span id="l2.196" class="difflineminus">-    if (dwResult == 0)</span>
<a href="#l2.197"></a><span id="l2.197" class="difflineminus">-        return;</span>
<a href="#l2.198"></a><span id="l2.198" class="difflineplus">+  HMODULE hModule = GetModuleHandle(NULL);</span>
<a href="#l2.199"></a><span id="l2.199" class="difflineplus">+  DWORD dwResult =</span>
<a href="#l2.200"></a><span id="l2.200" class="difflineplus">+      ::GetModuleFileNameW(hModule, szModule, sizeof(szModule) / sizeof(WCHAR));</span>
<a href="#l2.201"></a><span id="l2.201" class="difflineplus">+  if (dwResult == 0) return;</span>
<a href="#l2.202"></a><span id="l2.202"> </span>
<a href="#l2.203"></a><span id="l2.203" class="difflineminus">-    pTemp = wcsrchr(szModule, L'\\');</span>
<a href="#l2.204"></a><span id="l2.204" class="difflineminus">-    if (pTemp == NULL)</span>
<a href="#l2.205"></a><span id="l2.205" class="difflineminus">-        return;</span>
<a href="#l2.206"></a><span id="l2.206" class="difflineplus">+  pTemp = wcsrchr(szModule, L'\\');</span>
<a href="#l2.207"></a><span id="l2.207" class="difflineplus">+  if (pTemp == NULL) return;</span>
<a href="#l2.208"></a><span id="l2.208"> </span>
<a href="#l2.209"></a><span id="l2.209" class="difflineminus">-    *pTemp = '\0';</span>
<a href="#l2.210"></a><span id="l2.210" class="difflineminus">-    nsAutoString proxyPath(szModule);</span>
<a href="#l2.211"></a><span id="l2.211" class="difflineminus">-</span>
<a href="#l2.212"></a><span id="l2.212" class="difflineminus">-    proxyPath += u&quot;\\&quot;;</span>
<a href="#l2.213"></a><span id="l2.213" class="difflineminus">-    proxyPath += MAPI_PROXY_DLL_NAME;</span>
<a href="#l2.214"></a><span id="l2.214" class="difflineplus">+  *pTemp = '\0';</span>
<a href="#l2.215"></a><span id="l2.215" class="difflineplus">+  nsAutoString proxyPath(szModule);</span>
<a href="#l2.216"></a><span id="l2.216"> </span>
<a href="#l2.217"></a><span id="l2.217" class="difflineminus">-    h = LoadLibraryW(proxyPath.get());</span>
<a href="#l2.218"></a><span id="l2.218" class="difflineminus">-    if (h == NULL)</span>
<a href="#l2.219"></a><span id="l2.219" class="difflineminus">-        return;</span>
<a href="#l2.220"></a><span id="l2.220" class="difflineplus">+  proxyPath += u&quot;\\&quot;;</span>
<a href="#l2.221"></a><span id="l2.221" class="difflineplus">+  proxyPath += MAPI_PROXY_DLL_NAME;</span>
<a href="#l2.222"></a><span id="l2.222"> </span>
<a href="#l2.223"></a><span id="l2.223" class="difflineminus">-    RegisterFunc = (ProxyServer *) GetProcAddress(h, &quot;DllRegisterServer&quot;);</span>
<a href="#l2.224"></a><span id="l2.224" class="difflineminus">-    if (RegisterFunc)</span>
<a href="#l2.225"></a><span id="l2.225" class="difflineminus">-        RegisterFunc();</span>
<a href="#l2.226"></a><span id="l2.226" class="difflineplus">+  h = LoadLibraryW(proxyPath.get());</span>
<a href="#l2.227"></a><span id="l2.227" class="difflineplus">+  if (h == NULL) return;</span>
<a href="#l2.228"></a><span id="l2.228"> </span>
<a href="#l2.229"></a><span id="l2.229" class="difflineminus">-    FreeLibrary(h);</span>
<a href="#l2.230"></a><span id="l2.230" class="difflineplus">+  RegisterFunc = (ProxyServer*)GetProcAddress(h, &quot;DllRegisterServer&quot;);</span>
<a href="#l2.231"></a><span id="l2.231" class="difflineplus">+  if (RegisterFunc) RegisterFunc();</span>
<a href="#l2.232"></a><span id="l2.232" class="difflineplus">+</span>
<a href="#l2.233"></a><span id="l2.233" class="difflineplus">+  FreeLibrary(h);</span>
<a href="#l2.234"></a><span id="l2.234"> }</span>
<a href="#l2.235"></a><span id="l2.235"> </span>
<a href="#l2.236"></a><span id="l2.236" class="difflineminus">-void UnRegisterProxy()</span>
<a href="#l2.237"></a><span id="l2.237" class="difflineminus">-{</span>
<a href="#l2.238"></a><span id="l2.238" class="difflineminus">-    HINSTANCE h = NULL;</span>
<a href="#l2.239"></a><span id="l2.239" class="difflineminus">-    ProxyServer *UnRegisterFunc = NULL;</span>
<a href="#l2.240"></a><span id="l2.240" class="difflineplus">+void UnRegisterProxy() {</span>
<a href="#l2.241"></a><span id="l2.241" class="difflineplus">+  HINSTANCE h = NULL;</span>
<a href="#l2.242"></a><span id="l2.242" class="difflineplus">+  ProxyServer* UnRegisterFunc = NULL;</span>
<a href="#l2.243"></a><span id="l2.243"> </span>
<a href="#l2.244"></a><span id="l2.244" class="difflineminus">-    WCHAR szModule[MAX_SIZE];</span>
<a href="#l2.245"></a><span id="l2.245" class="difflineminus">-    WCHAR *pTemp = NULL;</span>
<a href="#l2.246"></a><span id="l2.246" class="difflineplus">+  WCHAR szModule[MAX_SIZE];</span>
<a href="#l2.247"></a><span id="l2.247" class="difflineplus">+  WCHAR* pTemp = NULL;</span>
<a href="#l2.248"></a><span id="l2.248"> </span>
<a href="#l2.249"></a><span id="l2.249" class="difflineminus">-    HMODULE hModule = GetModuleHandle(NULL);</span>
<a href="#l2.250"></a><span id="l2.250" class="difflineminus">-    DWORD dwResult  = ::GetModuleFileNameW(hModule, szModule,</span>
<a href="#l2.251"></a><span id="l2.251" class="difflineminus">-                                           sizeof(szModule)/sizeof(WCHAR));</span>
<a href="#l2.252"></a><span id="l2.252" class="difflineminus">-    if (dwResult == 0)</span>
<a href="#l2.253"></a><span id="l2.253" class="difflineminus">-        return;</span>
<a href="#l2.254"></a><span id="l2.254" class="difflineplus">+  HMODULE hModule = GetModuleHandle(NULL);</span>
<a href="#l2.255"></a><span id="l2.255" class="difflineplus">+  DWORD dwResult =</span>
<a href="#l2.256"></a><span id="l2.256" class="difflineplus">+      ::GetModuleFileNameW(hModule, szModule, sizeof(szModule) / sizeof(WCHAR));</span>
<a href="#l2.257"></a><span id="l2.257" class="difflineplus">+  if (dwResult == 0) return;</span>
<a href="#l2.258"></a><span id="l2.258"> </span>
<a href="#l2.259"></a><span id="l2.259" class="difflineminus">-    pTemp = wcsrchr(szModule, L'\\');</span>
<a href="#l2.260"></a><span id="l2.260" class="difflineminus">-    if (pTemp == NULL)</span>
<a href="#l2.261"></a><span id="l2.261" class="difflineminus">-        return;</span>
<a href="#l2.262"></a><span id="l2.262" class="difflineplus">+  pTemp = wcsrchr(szModule, L'\\');</span>
<a href="#l2.263"></a><span id="l2.263" class="difflineplus">+  if (pTemp == NULL) return;</span>
<a href="#l2.264"></a><span id="l2.264"> </span>
<a href="#l2.265"></a><span id="l2.265" class="difflineminus">-    *pTemp = '\0';</span>
<a href="#l2.266"></a><span id="l2.266" class="difflineminus">-    nsAutoString proxyPath(szModule);</span>
<a href="#l2.267"></a><span id="l2.267" class="difflineminus">-</span>
<a href="#l2.268"></a><span id="l2.268" class="difflineminus">-    proxyPath += u&quot;\\&quot;;</span>
<a href="#l2.269"></a><span id="l2.269" class="difflineminus">-    proxyPath += MAPI_PROXY_DLL_NAME;</span>
<a href="#l2.270"></a><span id="l2.270" class="difflineplus">+  *pTemp = '\0';</span>
<a href="#l2.271"></a><span id="l2.271" class="difflineplus">+  nsAutoString proxyPath(szModule);</span>
<a href="#l2.272"></a><span id="l2.272"> </span>
<a href="#l2.273"></a><span id="l2.273" class="difflineminus">-    h = LoadLibraryW(proxyPath.get());</span>
<a href="#l2.274"></a><span id="l2.274" class="difflineminus">-    if (h == NULL)</span>
<a href="#l2.275"></a><span id="l2.275" class="difflineminus">-        return;</span>
<a href="#l2.276"></a><span id="l2.276" class="difflineplus">+  proxyPath += u&quot;\\&quot;;</span>
<a href="#l2.277"></a><span id="l2.277" class="difflineplus">+  proxyPath += MAPI_PROXY_DLL_NAME;</span>
<a href="#l2.278"></a><span id="l2.278"> </span>
<a href="#l2.279"></a><span id="l2.279" class="difflineminus">-    UnRegisterFunc = (ProxyServer *) GetProcAddress(h, &quot;DllUnregisterServer&quot;);</span>
<a href="#l2.280"></a><span id="l2.280" class="difflineminus">-    if (UnRegisterFunc)</span>
<a href="#l2.281"></a><span id="l2.281" class="difflineminus">-        UnRegisterFunc();</span>
<a href="#l2.282"></a><span id="l2.282" class="difflineplus">+  h = LoadLibraryW(proxyPath.get());</span>
<a href="#l2.283"></a><span id="l2.283" class="difflineplus">+  if (h == NULL) return;</span>
<a href="#l2.284"></a><span id="l2.284"> </span>
<a href="#l2.285"></a><span id="l2.285" class="difflineminus">-    FreeLibrary(h);</span>
<a href="#l2.286"></a><span id="l2.286" class="difflineplus">+  UnRegisterFunc = (ProxyServer*)GetProcAddress(h, &quot;DllUnregisterServer&quot;);</span>
<a href="#l2.287"></a><span id="l2.287" class="difflineplus">+  if (UnRegisterFunc) UnRegisterFunc();</span>
<a href="#l2.288"></a><span id="l2.288" class="difflineplus">+</span>
<a href="#l2.289"></a><span id="l2.289" class="difflineplus">+  FreeLibrary(h);</span>
<a href="#l2.290"></a><span id="l2.290"> }</span>
<a href="#l2.291"></a><span id="l2.291"> </span>
<a href="#l2.292"></a><span id="l2.292"> // Register the component in the registry.</span>
<a href="#l2.293"></a><span id="l2.293"> </span>
<a href="#l2.294"></a><span id="l2.294" class="difflineminus">-HRESULT RegisterServer(const CLSID&amp; clsid,         // Class ID</span>
<a href="#l2.295"></a><span id="l2.295" class="difflineminus">-                       const char* szFriendlyName, // Friendly Name</span>
<a href="#l2.296"></a><span id="l2.296" class="difflineminus">-                       const char* szVerIndProgID, // Programmatic</span>
<a href="#l2.297"></a><span id="l2.297" class="difflineminus">-                       const char* szProgID)       //   IDs</span>
<a href="#l2.298"></a><span id="l2.298" class="difflineplus">+HRESULT RegisterServer(const CLSID&amp; clsid,          // Class ID</span>
<a href="#l2.299"></a><span id="l2.299" class="difflineplus">+                       const char* szFriendlyName,  // Friendly Name</span>
<a href="#l2.300"></a><span id="l2.300" class="difflineplus">+                       const char* szVerIndProgID,  // Programmatic</span>
<a href="#l2.301"></a><span id="l2.301" class="difflineplus">+                       const char* szProgID)        //   IDs</span>
<a href="#l2.302"></a><span id="l2.302"> {</span>
<a href="#l2.303"></a><span id="l2.303" class="difflineminus">-    HMODULE hModule = GetModuleHandle(NULL);</span>
<a href="#l2.304"></a><span id="l2.304" class="difflineminus">-    char szModuleName[MAX_SIZE];</span>
<a href="#l2.305"></a><span id="l2.305" class="difflineminus">-    char szCLSID[CLSID_STRING_SIZE];</span>
<a href="#l2.306"></a><span id="l2.306" class="difflineplus">+  HMODULE hModule = GetModuleHandle(NULL);</span>
<a href="#l2.307"></a><span id="l2.307" class="difflineplus">+  char szModuleName[MAX_SIZE];</span>
<a href="#l2.308"></a><span id="l2.308" class="difflineplus">+  char szCLSID[CLSID_STRING_SIZE];</span>
<a href="#l2.309"></a><span id="l2.309"> </span>
<a href="#l2.310"></a><span id="l2.310" class="difflineminus">-    nsAutoCString independentProgId(szVerIndProgID);</span>
<a href="#l2.311"></a><span id="l2.311" class="difflineminus">-    nsAutoCString progId(szProgID);</span>
<a href="#l2.312"></a><span id="l2.312" class="difflineplus">+  nsAutoCString independentProgId(szVerIndProgID);</span>
<a href="#l2.313"></a><span id="l2.313" class="difflineplus">+  nsAutoCString progId(szProgID);</span>
<a href="#l2.314"></a><span id="l2.314"> </span>
<a href="#l2.315"></a><span id="l2.315" class="difflineminus">-    DWORD dwResult = ::GetModuleFileName(hModule, szModuleName,</span>
<a href="#l2.316"></a><span id="l2.316" class="difflineminus">-                              sizeof(szModuleName)/sizeof(char));</span>
<a href="#l2.317"></a><span id="l2.317" class="difflineplus">+  DWORD dwResult = ::GetModuleFileName(hModule, szModuleName,</span>
<a href="#l2.318"></a><span id="l2.318" class="difflineplus">+                                       sizeof(szModuleName) / sizeof(char));</span>
<a href="#l2.319"></a><span id="l2.319"> </span>
<a href="#l2.320"></a><span id="l2.320" class="difflineminus">-    if (dwResult == 0)</span>
<a href="#l2.321"></a><span id="l2.321" class="difflineminus">-        return S_FALSE;</span>
<a href="#l2.322"></a><span id="l2.322" class="difflineplus">+  if (dwResult == 0) return S_FALSE;</span>
<a href="#l2.323"></a><span id="l2.323"> </span>
<a href="#l2.324"></a><span id="l2.324" class="difflineminus">-    nsAutoCString moduleName(szModuleName);</span>
<a href="#l2.325"></a><span id="l2.325" class="difflineminus">-    nsAutoCString registryKey(&quot;CLSID\\&quot;);</span>
<a href="#l2.326"></a><span id="l2.326" class="difflineminus">-</span>
<a href="#l2.327"></a><span id="l2.327" class="difflineminus">-    moduleName += MAPI_STARTUP_ARG;</span>
<a href="#l2.328"></a><span id="l2.328" class="difflineplus">+  nsAutoCString moduleName(szModuleName);</span>
<a href="#l2.329"></a><span id="l2.329" class="difflineplus">+  nsAutoCString registryKey(&quot;CLSID\\&quot;);</span>
<a href="#l2.330"></a><span id="l2.330"> </span>
<a href="#l2.331"></a><span id="l2.331" class="difflineminus">-    // Convert the CLSID into a char.</span>
<a href="#l2.332"></a><span id="l2.332" class="difflineplus">+  moduleName += MAPI_STARTUP_ARG;</span>
<a href="#l2.333"></a><span id="l2.333"> </span>
<a href="#l2.334"></a><span id="l2.334" class="difflineminus">-    if (!CLSIDtochar(clsid, szCLSID, sizeof(szCLSID)))</span>
<a href="#l2.335"></a><span id="l2.335" class="difflineminus">-        return S_FALSE;</span>
<a href="#l2.336"></a><span id="l2.336" class="difflineminus">-    registryKey += szCLSID;</span>
<a href="#l2.337"></a><span id="l2.337" class="difflineplus">+  // Convert the CLSID into a char.</span>
<a href="#l2.338"></a><span id="l2.338"> </span>
<a href="#l2.339"></a><span id="l2.339" class="difflineminus">-    // Add the CLSID to the registry.</span>
<a href="#l2.340"></a><span id="l2.340" class="difflineminus">-    if (!setKeyAndValue(registryKey, NULL, szFriendlyName))</span>
<a href="#l2.341"></a><span id="l2.341" class="difflineminus">-        return S_FALSE;</span>
<a href="#l2.342"></a><span id="l2.342" class="difflineplus">+  if (!CLSIDtochar(clsid, szCLSID, sizeof(szCLSID))) return S_FALSE;</span>
<a href="#l2.343"></a><span id="l2.343" class="difflineplus">+  registryKey += szCLSID;</span>
<a href="#l2.344"></a><span id="l2.344"> </span>
<a href="#l2.345"></a><span id="l2.345" class="difflineminus">-    if (!setKeyAndValue(registryKey, &quot;LocalServer32&quot;, moduleName.get()))</span>
<a href="#l2.346"></a><span id="l2.346" class="difflineminus">-        return S_FALSE;</span>
<a href="#l2.347"></a><span id="l2.347" class="difflineplus">+  // Add the CLSID to the registry.</span>
<a href="#l2.348"></a><span id="l2.348" class="difflineplus">+  if (!setKeyAndValue(registryKey, NULL, szFriendlyName)) return S_FALSE;</span>
<a href="#l2.349"></a><span id="l2.349"> </span>
<a href="#l2.350"></a><span id="l2.350" class="difflineminus">-    // Add the ProgID subkey under the CLSID key.</span>
<a href="#l2.351"></a><span id="l2.351" class="difflineminus">-    if (!setKeyAndValue(registryKey, &quot;ProgID&quot;, szProgID))</span>
<a href="#l2.352"></a><span id="l2.352" class="difflineminus">-        return S_FALSE;</span>
<a href="#l2.353"></a><span id="l2.353" class="difflineplus">+  if (!setKeyAndValue(registryKey, &quot;LocalServer32&quot;, moduleName.get()))</span>
<a href="#l2.354"></a><span id="l2.354" class="difflineplus">+    return S_FALSE;</span>
<a href="#l2.355"></a><span id="l2.355"> </span>
<a href="#l2.356"></a><span id="l2.356" class="difflineminus">-    // Add the version-independent ProgID subkey under CLSID key.</span>
<a href="#l2.357"></a><span id="l2.357" class="difflineminus">-    if (!setKeyAndValue(registryKey, &quot;VersionIndependentProgID&quot;, szVerIndProgID))</span>
<a href="#l2.358"></a><span id="l2.358" class="difflineminus">-        return S_FALSE;</span>
<a href="#l2.359"></a><span id="l2.359" class="difflineplus">+  // Add the ProgID subkey under the CLSID key.</span>
<a href="#l2.360"></a><span id="l2.360" class="difflineplus">+  if (!setKeyAndValue(registryKey, &quot;ProgID&quot;, szProgID)) return S_FALSE;</span>
<a href="#l2.361"></a><span id="l2.361"> </span>
<a href="#l2.362"></a><span id="l2.362" class="difflineminus">-    // Add the version-independent ProgID subkey under HKEY_CLASSES_ROOT.</span>
<a href="#l2.363"></a><span id="l2.363" class="difflineminus">-    if (!setKeyAndValue(independentProgId, NULL, szFriendlyName))</span>
<a href="#l2.364"></a><span id="l2.364" class="difflineminus">-        return S_FALSE;</span>
<a href="#l2.365"></a><span id="l2.365" class="difflineminus">-    if (!setKeyAndValue(independentProgId, &quot;CLSID&quot;, szCLSID))</span>
<a href="#l2.366"></a><span id="l2.366" class="difflineminus">-        return S_FALSE;</span>
<a href="#l2.367"></a><span id="l2.367" class="difflineminus">-    if (!setKeyAndValue(independentProgId, &quot;CurVer&quot;, szProgID))</span>
<a href="#l2.368"></a><span id="l2.368" class="difflineminus">-        return S_FALSE;</span>
<a href="#l2.369"></a><span id="l2.369" class="difflineplus">+  // Add the version-independent ProgID subkey under CLSID key.</span>
<a href="#l2.370"></a><span id="l2.370" class="difflineplus">+  if (!setKeyAndValue(registryKey, &quot;VersionIndependentProgID&quot;, szVerIndProgID))</span>
<a href="#l2.371"></a><span id="l2.371" class="difflineplus">+    return S_FALSE;</span>
<a href="#l2.372"></a><span id="l2.372"> </span>
<a href="#l2.373"></a><span id="l2.373" class="difflineminus">-    // Add the versioned ProgID subkey under HKEY_CLASSES_ROOT.</span>
<a href="#l2.374"></a><span id="l2.374" class="difflineminus">-    if (!setKeyAndValue(progId, NULL, szFriendlyName))</span>
<a href="#l2.375"></a><span id="l2.375" class="difflineminus">-        return S_FALSE;</span>
<a href="#l2.376"></a><span id="l2.376" class="difflineminus">-    if (!setKeyAndValue(progId, &quot;CLSID&quot;, szCLSID))</span>
<a href="#l2.377"></a><span id="l2.377" class="difflineminus">-        return S_FALSE;</span>
<a href="#l2.378"></a><span id="l2.378" class="difflineplus">+  // Add the version-independent ProgID subkey under HKEY_CLASSES_ROOT.</span>
<a href="#l2.379"></a><span id="l2.379" class="difflineplus">+  if (!setKeyAndValue(independentProgId, NULL, szFriendlyName)) return S_FALSE;</span>
<a href="#l2.380"></a><span id="l2.380" class="difflineplus">+  if (!setKeyAndValue(independentProgId, &quot;CLSID&quot;, szCLSID)) return S_FALSE;</span>
<a href="#l2.381"></a><span id="l2.381" class="difflineplus">+  if (!setKeyAndValue(independentProgId, &quot;CurVer&quot;, szProgID)) return S_FALSE;</span>
<a href="#l2.382"></a><span id="l2.382"> </span>
<a href="#l2.383"></a><span id="l2.383" class="difflineminus">-    RegisterProxy();</span>
<a href="#l2.384"></a><span id="l2.384" class="difflineplus">+  // Add the versioned ProgID subkey under HKEY_CLASSES_ROOT.</span>
<a href="#l2.385"></a><span id="l2.385" class="difflineplus">+  if (!setKeyAndValue(progId, NULL, szFriendlyName)) return S_FALSE;</span>
<a href="#l2.386"></a><span id="l2.386" class="difflineplus">+  if (!setKeyAndValue(progId, &quot;CLSID&quot;, szCLSID)) return S_FALSE;</span>
<a href="#l2.387"></a><span id="l2.387"> </span>
<a href="#l2.388"></a><span id="l2.388" class="difflineminus">-    return S_OK;</span>
<a href="#l2.389"></a><span id="l2.389" class="difflineplus">+  RegisterProxy();</span>
<a href="#l2.390"></a><span id="l2.390" class="difflineplus">+</span>
<a href="#l2.391"></a><span id="l2.391" class="difflineplus">+  return S_OK;</span>
<a href="#l2.392"></a><span id="l2.392"> }</span>
<a href="#l2.393"></a><span id="l2.393"> </span>
<a href="#l2.394"></a><span id="l2.394" class="difflineminus">-LONG UnregisterServer(const CLSID&amp; clsid,         // Class ID</span>
<a href="#l2.395"></a><span id="l2.395" class="difflineminus">-                      const char* szVerIndProgID, // Programmatic</span>
<a href="#l2.396"></a><span id="l2.396" class="difflineminus">-                      const char* szProgID)       //   IDs</span>
<a href="#l2.397"></a><span id="l2.397" class="difflineplus">+LONG UnregisterServer(const CLSID&amp; clsid,          // Class ID</span>
<a href="#l2.398"></a><span id="l2.398" class="difflineplus">+                      const char* szVerIndProgID,  // Programmatic</span>
<a href="#l2.399"></a><span id="l2.399" class="difflineplus">+                      const char* szProgID)        //   IDs</span>
<a href="#l2.400"></a><span id="l2.400"> {</span>
<a href="#l2.401"></a><span id="l2.401" class="difflineminus">-    LONG lResult = S_OK;</span>
<a href="#l2.402"></a><span id="l2.402" class="difflineplus">+  LONG lResult = S_OK;</span>
<a href="#l2.403"></a><span id="l2.403"> </span>
<a href="#l2.404"></a><span id="l2.404" class="difflineminus">-    // Convert the CLSID into a char.</span>
<a href="#l2.405"></a><span id="l2.405" class="difflineplus">+  // Convert the CLSID into a char.</span>
<a href="#l2.406"></a><span id="l2.406"> </span>
<a href="#l2.407"></a><span id="l2.407" class="difflineminus">-    char szCLSID[CLSID_STRING_SIZE];</span>
<a href="#l2.408"></a><span id="l2.408" class="difflineminus">-    if (!CLSIDtochar(clsid, szCLSID, sizeof(szCLSID)))</span>
<a href="#l2.409"></a><span id="l2.409" class="difflineminus">-        return S_FALSE;</span>
<a href="#l2.410"></a><span id="l2.410" class="difflineplus">+  char szCLSID[CLSID_STRING_SIZE];</span>
<a href="#l2.411"></a><span id="l2.411" class="difflineplus">+  if (!CLSIDtochar(clsid, szCLSID, sizeof(szCLSID))) return S_FALSE;</span>
<a href="#l2.412"></a><span id="l2.412"> </span>
<a href="#l2.413"></a><span id="l2.413" class="difflineminus">-    UnRegisterProxy();</span>
<a href="#l2.414"></a><span id="l2.414" class="difflineplus">+  UnRegisterProxy();</span>
<a href="#l2.415"></a><span id="l2.415"> </span>
<a href="#l2.416"></a><span id="l2.416" class="difflineminus">-    nsAutoCString registryKey(&quot;CLSID\\&quot;);</span>
<a href="#l2.417"></a><span id="l2.417" class="difflineminus">-    registryKey += szCLSID;</span>
<a href="#l2.418"></a><span id="l2.418" class="difflineplus">+  nsAutoCString registryKey(&quot;CLSID\\&quot;);</span>
<a href="#l2.419"></a><span id="l2.419" class="difflineplus">+  registryKey += szCLSID;</span>
<a href="#l2.420"></a><span id="l2.420"> </span>
<a href="#l2.421"></a><span id="l2.421" class="difflineminus">-    lResult = recursiveDeleteKey(HKEY_CLASSES_ROOT, registryKey.get());</span>
<a href="#l2.422"></a><span id="l2.422" class="difflineminus">-    if (lResult == ERROR_SUCCESS || lResult == ERROR_FILE_NOT_FOUND)</span>
<a href="#l2.423"></a><span id="l2.423" class="difflineminus">-        return lResult;</span>
<a href="#l2.424"></a><span id="l2.424" class="difflineplus">+  lResult = recursiveDeleteKey(HKEY_CLASSES_ROOT, registryKey.get());</span>
<a href="#l2.425"></a><span id="l2.425" class="difflineplus">+  if (lResult == ERROR_SUCCESS || lResult == ERROR_FILE_NOT_FOUND)</span>
<a href="#l2.426"></a><span id="l2.426" class="difflineplus">+    return lResult;</span>
<a href="#l2.427"></a><span id="l2.427"> </span>
<a href="#l2.428"></a><span id="l2.428" class="difflineminus">-    registryKey += &quot;\\LocalServer32&quot;;</span>
<a href="#l2.429"></a><span id="l2.429" class="difflineplus">+  registryKey += &quot;\\LocalServer32&quot;;</span>
<a href="#l2.430"></a><span id="l2.430"> </span>
<a href="#l2.431"></a><span id="l2.431" class="difflineminus">-    // Delete only the path for this server.</span>
<a href="#l2.432"></a><span id="l2.432" class="difflineplus">+  // Delete only the path for this server.</span>
<a href="#l2.433"></a><span id="l2.433"> </span>
<a href="#l2.434"></a><span id="l2.434" class="difflineminus">-    lResult = recursiveDeleteKey(HKEY_CLASSES_ROOT, registryKey.get());</span>
<a href="#l2.435"></a><span id="l2.435" class="difflineminus">-    if (lResult != ERROR_SUCCESS &amp;&amp; lResult != ERROR_FILE_NOT_FOUND)</span>
<a href="#l2.436"></a><span id="l2.436" class="difflineminus">-        return lResult;</span>
<a href="#l2.437"></a><span id="l2.437" class="difflineplus">+  lResult = recursiveDeleteKey(HKEY_CLASSES_ROOT, registryKey.get());</span>
<a href="#l2.438"></a><span id="l2.438" class="difflineplus">+  if (lResult != ERROR_SUCCESS &amp;&amp; lResult != ERROR_FILE_NOT_FOUND)</span>
<a href="#l2.439"></a><span id="l2.439" class="difflineplus">+    return lResult;</span>
<a href="#l2.440"></a><span id="l2.440"> </span>
<a href="#l2.441"></a><span id="l2.441" class="difflineminus">-    // Delete the version-independent ProgID Key.</span>
<a href="#l2.442"></a><span id="l2.442" class="difflineminus">-    lResult = recursiveDeleteKey(HKEY_CLASSES_ROOT, szVerIndProgID);</span>
<a href="#l2.443"></a><span id="l2.443" class="difflineminus">-    if (lResult != ERROR_SUCCESS &amp;&amp; lResult != ERROR_FILE_NOT_FOUND)</span>
<a href="#l2.444"></a><span id="l2.444" class="difflineminus">-        return lResult;</span>
<a href="#l2.445"></a><span id="l2.445" class="difflineplus">+  // Delete the version-independent ProgID Key.</span>
<a href="#l2.446"></a><span id="l2.446" class="difflineplus">+  lResult = recursiveDeleteKey(HKEY_CLASSES_ROOT, szVerIndProgID);</span>
<a href="#l2.447"></a><span id="l2.447" class="difflineplus">+  if (lResult != ERROR_SUCCESS &amp;&amp; lResult != ERROR_FILE_NOT_FOUND)</span>
<a href="#l2.448"></a><span id="l2.448" class="difflineplus">+    return lResult;</span>
<a href="#l2.449"></a><span id="l2.449"> </span>
<a href="#l2.450"></a><span id="l2.450" class="difflineminus">-    lResult = recursiveDeleteKey(HKEY_CLASSES_ROOT, szProgID);</span>
<a href="#l2.451"></a><span id="l2.451" class="difflineplus">+  lResult = recursiveDeleteKey(HKEY_CLASSES_ROOT, szProgID);</span>
<a href="#l2.452"></a><span id="l2.452"> </span>
<a href="#l2.453"></a><span id="l2.453" class="difflineminus">-    return lResult;</span>
<a href="#l2.454"></a><span id="l2.454" class="difflineplus">+  return lResult;</span>
<a href="#l2.455"></a><span id="l2.455"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/mapi/mapihook/src/Registry.h</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/mapi/mapihook/src/Registry.h</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -4,20 +4,17 @@</span>
<a href="#l3.4"></a><span id="l3.4"> </span>
<a href="#l3.5"></a><span id="l3.5"> #ifndef _REGISTRY_H_</span>
<a href="#l3.6"></a><span id="l3.6"> #define _REGISTRY_H_</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8"> #include &lt;objbase.h&gt;</span>
<a href="#l3.9"></a><span id="l3.9"> </span>
<a href="#l3.10"></a><span id="l3.10"> // This function will register a component in the Registry.</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-HRESULT RegisterServer(const CLSID&amp; clsid,</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-                       const char* szFriendlyName,</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-                       const char* szVerIndProgID,</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">-                       const char* szProgID) ;</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+HRESULT RegisterServer(const CLSID&amp; clsid, const char* szFriendlyName,</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+                       const char* szVerIndProgID, const char* szProgID);</span>
<a href="#l3.18"></a><span id="l3.18"> </span>
<a href="#l3.19"></a><span id="l3.19"> // This function will unregister a component.</span>
<a href="#l3.20"></a><span id="l3.20"> </span>
<a href="#l3.21"></a><span id="l3.21" class="difflineminus">-HRESULT UnregisterServer(const CLSID&amp; clsid,</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineminus">-                         const char* szVerIndProgID,</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineminus">-                         const char* szProgID) ;</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+HRESULT UnregisterServer(const CLSID&amp; clsid, const char* szVerIndProgID,</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineplus">+                         const char* szProgID);</span>
<a href="#l3.26"></a><span id="l3.26"> </span>
<a href="#l3.27"></a><span id="l3.27"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/mapi/mapihook/src/msgMapiFactory.cpp</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/mapi/mapihook/src/msgMapiFactory.cpp</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -4,82 +4,61 @@</span>
<a href="#l4.4"></a><span id="l4.4"> </span>
<a href="#l4.5"></a><span id="l4.5"> #undef UNICODE</span>
<a href="#l4.6"></a><span id="l4.6"> #undef _UNICODE</span>
<a href="#l4.7"></a><span id="l4.7"> </span>
<a href="#l4.8"></a><span id="l4.8"> #include &quot;msgMapiFactory.h&quot;</span>
<a href="#l4.9"></a><span id="l4.9"> #include &quot;msgMapiImp.h&quot;</span>
<a href="#l4.10"></a><span id="l4.10"> #include &quot;msgMapi.h&quot;</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-CMapiFactory ::CMapiFactory()</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-: m_cRef(1)</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-{</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineminus">-}</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+CMapiFactory ::CMapiFactory() : m_cRef(1) {}</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+CMapiFactory::~CMapiFactory() {}</span>
<a href="#l4.19"></a><span id="l4.19"> </span>
<a href="#l4.20"></a><span id="l4.20" class="difflineminus">-CMapiFactory::~CMapiFactory()</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineminus">-{</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+STDMETHODIMP CMapiFactory::QueryInterface(const IID&amp; aIid, void** aPpv) {</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+  if ((aIid == IID_IUnknown) || (aIid == IID_IClassFactory)) {</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineplus">+    *aPpv = static_cast&lt;IClassFactory*&gt;(this);</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineplus">+  } else {</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineplus">+    *aPpv = nullptr;</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineplus">+    return E_NOINTERFACE;</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+  }</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineplus">+  reinterpret_cast&lt;IUnknown*&gt;(*aPpv)-&gt;AddRef();</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineplus">+  return S_OK;</span>
<a href="#l4.31"></a><span id="l4.31"> }</span>
<a href="#l4.32"></a><span id="l4.32"> </span>
<a href="#l4.33"></a><span id="l4.33" class="difflineminus">-STDMETHODIMP CMapiFactory::QueryInterface(const IID&amp; aIid, void** aPpv)</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineminus">-{</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineminus">-    if ((aIid == IID_IUnknown) || (aIid == IID_IClassFactory))</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineminus">-    {</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineminus">-        *aPpv = static_cast&lt;IClassFactory*&gt;(this);</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineminus">-    }</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineminus">-    else</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineminus">-    {</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineminus">-        *aPpv = nullptr;</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineminus">-        return E_NOINTERFACE;</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineminus">-    }</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineminus">-    reinterpret_cast&lt;IUnknown*&gt;(*aPpv)-&gt;AddRef();</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineminus">-    return S_OK;</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineminus">-}</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineplus">+STDMETHODIMP_(ULONG) CMapiFactory::AddRef() { return ++m_cRef; }</span>
<a href="#l4.48"></a><span id="l4.48"> </span>
<a href="#l4.49"></a><span id="l4.49" class="difflineminus">-STDMETHODIMP_(ULONG) CMapiFactory::AddRef()</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineminus">-{</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineminus">-    return ++m_cRef;</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineminus">-}</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineplus">+STDMETHODIMP_(ULONG) CMapiFactory::Release() {</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineplus">+  int32_t temp = --m_cRef;</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineplus">+  if (m_cRef == 0) {</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineplus">+    delete this;</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineplus">+    return 0;</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineplus">+  }</span>
<a href="#l4.59"></a><span id="l4.59"> </span>
<a href="#l4.60"></a><span id="l4.60" class="difflineminus">-STDMETHODIMP_(ULONG) CMapiFactory::Release()</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineminus">-{</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineminus">-    int32_t temp = --m_cRef;</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineminus">-    if (m_cRef == 0)</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineminus">-    {</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineminus">-        delete this;</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineminus">-        return 0;</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineminus">-    }</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineminus">-</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineminus">-    return temp;</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineplus">+  return temp;</span>
<a href="#l4.71"></a><span id="l4.71"> }</span>
<a href="#l4.72"></a><span id="l4.72"> </span>
<a href="#l4.73"></a><span id="l4.73"> STDMETHODIMP CMapiFactory::CreateInstance(IUnknown* aUnknownOuter,</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineminus">-                                           const IID&amp; aIid,</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineminus">-                                           void** aPpv)</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineminus">-{</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineminus">-    // Cannot aggregate.</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineplus">+                                          const IID&amp; aIid, void** aPpv) {</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineplus">+  // Cannot aggregate.</span>
<a href="#l4.80"></a><span id="l4.80"> </span>
<a href="#l4.81"></a><span id="l4.81" class="difflineminus">-    if (aUnknownOuter != nullptr)</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineminus">-    {</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineminus">-        return CLASS_E_NOAGGREGATION ;</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineminus">-    }</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineplus">+  if (aUnknownOuter != nullptr) {</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineplus">+    return CLASS_E_NOAGGREGATION;</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineplus">+  }</span>
<a href="#l4.88"></a><span id="l4.88"> </span>
<a href="#l4.89"></a><span id="l4.89" class="difflineminus">-    // Create component.</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineplus">+  // Create component.</span>
<a href="#l4.91"></a><span id="l4.91"> </span>
<a href="#l4.92"></a><span id="l4.92" class="difflineminus">-    CMapiImp* pImp = new CMapiImp();</span>
<a href="#l4.93"></a><span id="l4.93" class="difflineminus">-    if (pImp == nullptr)</span>
<a href="#l4.94"></a><span id="l4.94" class="difflineminus">-    {</span>
<a href="#l4.95"></a><span id="l4.95" class="difflineminus">-        return E_OUTOFMEMORY ;</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineminus">-    }</span>
<a href="#l4.97"></a><span id="l4.97" class="difflineplus">+  CMapiImp* pImp = new CMapiImp();</span>
<a href="#l4.98"></a><span id="l4.98" class="difflineplus">+  if (pImp == nullptr) {</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineplus">+    return E_OUTOFMEMORY;</span>
<a href="#l4.100"></a><span id="l4.100" class="difflineplus">+  }</span>
<a href="#l4.101"></a><span id="l4.101"> </span>
<a href="#l4.102"></a><span id="l4.102" class="difflineminus">-    // Get the requested interface.</span>
<a href="#l4.103"></a><span id="l4.103" class="difflineminus">-    HRESULT hr = pImp-&gt;QueryInterface(aIid, aPpv);</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineplus">+  // Get the requested interface.</span>
<a href="#l4.105"></a><span id="l4.105" class="difflineplus">+  HRESULT hr = pImp-&gt;QueryInterface(aIid, aPpv);</span>
<a href="#l4.106"></a><span id="l4.106"> </span>
<a href="#l4.107"></a><span id="l4.107" class="difflineminus">-    // Release the IUnknown pointer.</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineminus">-    // (If QueryInterface failed, component will delete itself.)</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineplus">+  // Release the IUnknown pointer.</span>
<a href="#l4.110"></a><span id="l4.110" class="difflineplus">+  // (If QueryInterface failed, component will delete itself.)</span>
<a href="#l4.111"></a><span id="l4.111"> </span>
<a href="#l4.112"></a><span id="l4.112" class="difflineminus">-    pImp-&gt;Release();</span>
<a href="#l4.113"></a><span id="l4.113" class="difflineminus">-    return hr;</span>
<a href="#l4.114"></a><span id="l4.114" class="difflineplus">+  pImp-&gt;Release();</span>
<a href="#l4.115"></a><span id="l4.115" class="difflineplus">+  return hr;</span>
<a href="#l4.116"></a><span id="l4.116"> }</span>
<a href="#l4.117"></a><span id="l4.117"> </span>
<a href="#l4.118"></a><span id="l4.118" class="difflineminus">-STDMETHODIMP CMapiFactory::LockServer(BOOL aLock)</span>
<a href="#l4.119"></a><span id="l4.119" class="difflineminus">-{</span>
<a href="#l4.120"></a><span id="l4.120" class="difflineminus">-    return S_OK ;</span>
<a href="#l4.121"></a><span id="l4.121" class="difflineminus">-}</span>
<a href="#l4.122"></a><span id="l4.122" class="difflineplus">+STDMETHODIMP CMapiFactory::LockServer(BOOL aLock) { return S_OK; }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/mapi/mapihook/src/msgMapiFactory.h</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/mapi/mapihook/src/msgMapiFactory.h</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -3,37 +3,33 @@</span>
<a href="#l5.4"></a><span id="l5.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l5.5"></a><span id="l5.5"> </span>
<a href="#l5.6"></a><span id="l5.6"> #ifndef MSG_MAPI_FACTORY_H</span>
<a href="#l5.7"></a><span id="l5.7"> #define MSG_MAPI_FACTORY_H</span>
<a href="#l5.8"></a><span id="l5.8"> </span>
<a href="#l5.9"></a><span id="l5.9"> #include &lt;windows.h&gt;</span>
<a href="#l5.10"></a><span id="l5.10"> #include &lt;objbase.h&gt;</span>
<a href="#l5.11"></a><span id="l5.11"> #include &quot;nspr.h&quot;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-#include &quot;nsISupportsImpl.h&quot; // ThreadSafeAutoRefCnt</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+#include &quot;nsISupportsImpl.h&quot;  // ThreadSafeAutoRefCnt</span>
<a href="#l5.14"></a><span id="l5.14"> #include &lt;stdint.h&gt;</span>
<a href="#l5.15"></a><span id="l5.15"> </span>
<a href="#l5.16"></a><span id="l5.16" class="difflineminus">-</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineminus">-class CMapiFactory : public IClassFactory</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineminus">-{</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineminus">-public :</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+class CMapiFactory : public IClassFactory {</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineplus">+ public:</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineplus">+  // IUnknown</span>
<a href="#l5.23"></a><span id="l5.23"> </span>
<a href="#l5.24"></a><span id="l5.24" class="difflineminus">-    // IUnknown</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineplus">+  STDMETHODIMP QueryInterface(REFIID aIid, void** aPpv);</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineplus">+  STDMETHODIMP_(ULONG) AddRef(void);</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineplus">+  STDMETHODIMP_(ULONG) Release(void);</span>
<a href="#l5.28"></a><span id="l5.28"> </span>
<a href="#l5.29"></a><span id="l5.29" class="difflineminus">-    STDMETHODIMP            QueryInterface (REFIID aIid, void** aPpv);</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineminus">-    STDMETHODIMP_(ULONG)    AddRef(void);</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineminus">-    STDMETHODIMP_(ULONG)    Release(void);</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+  // IClassFactory</span>
<a href="#l5.33"></a><span id="l5.33"> </span>
<a href="#l5.34"></a><span id="l5.34" class="difflineminus">-    // IClassFactory</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineplus">+  STDMETHODIMP CreateInstance(LPUNKNOWN aUnkOuter, REFIID aIid, void** aPpv);</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineplus">+  STDMETHODIMP LockServer(BOOL aLock);</span>
<a href="#l5.37"></a><span id="l5.37"> </span>
<a href="#l5.38"></a><span id="l5.38" class="difflineminus">-    STDMETHODIMP        CreateInstance (LPUNKNOWN aUnkOuter, REFIID aIid, void **aPpv);</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineminus">-    STDMETHODIMP        LockServer (BOOL aLock);</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineplus">+  CMapiFactory();</span>
<a href="#l5.41"></a><span id="l5.41"> </span>
<a href="#l5.42"></a><span id="l5.42" class="difflineminus">-    CMapiFactory ();</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineplus">+ private:</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineplus">+  mozilla::ThreadSafeAutoRefCnt m_cRef;</span>
<a href="#l5.45"></a><span id="l5.45"> </span>
<a href="#l5.46"></a><span id="l5.46" class="difflineminus">-private:</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineminus">-    mozilla::ThreadSafeAutoRefCnt m_cRef;</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineminus">-</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineminus">-    virtual ~CMapiFactory ();</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineplus">+  virtual ~CMapiFactory();</span>
<a href="#l5.51"></a><span id="l5.51"> };</span>
<a href="#l5.52"></a><span id="l5.52"> </span>
<a href="#l5.53"></a><span id="l5.53"> #endif  // MSG_MAPI_FACTORY_H</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/mapi/mapihook/src/msgMapiHook.cpp</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/mapi/mapihook/src/msgMapiHook.cpp</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -1,13 +1,13 @@</span>
<a href="#l6.4"></a><span id="l6.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l6.5"></a><span id="l6.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l6.6"></a><span id="l6.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l6.7"></a><span id="l6.7"> </span>
<a href="#l6.8"></a><span id="l6.8" class="difflineminus">-#define MAPI_STARTUP_ARG       &quot;/MAPIStartUp&quot;</span>
<a href="#l6.9"></a><span id="l6.9" class="difflineplus">+#define MAPI_STARTUP_ARG &quot;/MAPIStartUp&quot;</span>
<a href="#l6.10"></a><span id="l6.10"> </span>
<a href="#l6.11"></a><span id="l6.11"> #include &lt;mapidefs.h&gt;</span>
<a href="#l6.12"></a><span id="l6.12"> #include &lt;mapi.h&gt;</span>
<a href="#l6.13"></a><span id="l6.13"> #include &lt;direct.h&gt;</span>
<a href="#l6.14"></a><span id="l6.14"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l6.15"></a><span id="l6.15"> #include &quot;nsISupports.h&quot;</span>
<a href="#l6.16"></a><span id="l6.16"> #include &quot;nsIPromptService.h&quot;</span>
<a href="#l6.17"></a><span id="l6.17"> #include &quot;nsIAppShellService.h&quot;</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineat">@@ -38,858 +38,827 @@</span>
<a href="#l6.19"></a><span id="l6.19"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l6.20"></a><span id="l6.20"> #include &quot;mozilla/ReentrantMonitor.h&quot;</span>
<a href="#l6.21"></a><span id="l6.21"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l6.22"></a><span id="l6.22"> #include &quot;nsIArray.h&quot;</span>
<a href="#l6.23"></a><span id="l6.23"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l6.24"></a><span id="l6.24"> #include &quot;nsEmbedCID.h&quot;</span>
<a href="#l6.25"></a><span id="l6.25"> #include &quot;mozilla/Logging.h&quot;</span>
<a href="#l6.26"></a><span id="l6.26"> </span>
<a href="#l6.27"></a><span id="l6.27" class="difflineminus">-extern mozilla::LazyLogModule MAPI; // defined in msgMapiImp.cpp</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineplus">+extern mozilla::LazyLogModule MAPI;  // defined in msgMapiImp.cpp</span>
<a href="#l6.29"></a><span id="l6.29"> </span>
<a href="#l6.30"></a><span id="l6.30"> class MAPISendListener : public nsIMsgSendListener,</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-                         public mozilla::ReentrantMonitor</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineminus">-{</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineminus">-public:</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+                         public mozilla::ReentrantMonitor {</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+ public:</span>
<a href="#l6.36"></a><span id="l6.36">   MAPISendListener()</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineminus">-  : ReentrantMonitor(&quot;MAPISendListener monitor&quot;),</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineminus">-    m_done(false) {}</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineplus">+      : ReentrantMonitor(&quot;MAPISendListener monitor&quot;), m_done(false) {}</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineplus">+</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineplus">+  // nsISupports interface</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineplus">+  NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l6.43"></a><span id="l6.43"> </span>
<a href="#l6.44"></a><span id="l6.44" class="difflineminus">-    // nsISupports interface</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineminus">-    NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineminus">-</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineminus">-    /* void OnStartSending (in string aMsgID, in uint32_t aMsgSize); */</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineminus">-    NS_IMETHOD OnStartSending(const char *aMsgID, uint32_t aMsgSize) { return NS_OK; }</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineplus">+  /* void OnStartSending (in string aMsgID, in uint32_t aMsgSize); */</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineplus">+  NS_IMETHOD OnStartSending(const char *aMsgID, uint32_t aMsgSize) {</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineplus">+    return NS_OK;</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineplus">+  }</span>
<a href="#l6.53"></a><span id="l6.53"> </span>
<a href="#l6.54"></a><span id="l6.54" class="difflineminus">-    /* void OnProgress (in string aMsgID, in uint32_t aProgress, in uint32_t aProgressMax); */</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineminus">-    NS_IMETHOD OnProgress(const char *aMsgID, uint32_t aProgress, uint32_t aProgressMax) { return NS_OK;}</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineminus">-</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineminus">-    /* void OnStatus (in string aMsgID, in wstring aMsg); */</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineminus">-    NS_IMETHOD OnStatus(const char *aMsgID, const char16_t *aMsg) { return NS_OK;}</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineplus">+  /* void OnProgress (in string aMsgID, in uint32_t aProgress, in uint32_t</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineplus">+   * aProgressMax); */</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineplus">+  NS_IMETHOD OnProgress(const char *aMsgID, uint32_t aProgress,</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineplus">+                        uint32_t aProgressMax) {</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineplus">+    return NS_OK;</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineplus">+  }</span>
<a href="#l6.65"></a><span id="l6.65"> </span>
<a href="#l6.66"></a><span id="l6.66" class="difflineminus">-    /* void OnStopSending (in string aMsgID, in nsresult aStatus, in wstring aMsg, in nsIFile returnFile); */</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineminus">-    NS_IMETHOD OnStopSending(const char *aMsgID, nsresult aStatus, const char16_t *aMsg,</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineminus">-                           nsIFile *returnFile) {</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineminus">-        mozilla::ReentrantMonitorAutoEnter mon(*this);</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineminus">-        m_done = true;</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineminus">-        NotifyAll();</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineminus">-        return NS_OK;</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineminus">-    }</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineplus">+  /* void OnStatus (in string aMsgID, in wstring aMsg); */</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineplus">+  NS_IMETHOD OnStatus(const char *aMsgID, const char16_t *aMsg) {</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineplus">+    return NS_OK;</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineplus">+  }</span>
<a href="#l6.78"></a><span id="l6.78"> </span>
<a href="#l6.79"></a><span id="l6.79" class="difflineminus">-    /* void OnSendNotPerformed */</span>
<a href="#l6.80"></a><span id="l6.80" class="difflineminus">-    NS_IMETHOD OnSendNotPerformed(const char *aMsgID, nsresult aStatus)</span>
<a href="#l6.81"></a><span id="l6.81" class="difflineminus">-    {</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineminus">-      return OnStopSending(aMsgID, aStatus, nullptr, nullptr) ;</span>
<a href="#l6.83"></a><span id="l6.83" class="difflineminus">-    }</span>
<a href="#l6.84"></a><span id="l6.84" class="difflineplus">+  /* void OnStopSending (in string aMsgID, in nsresult aStatus, in wstring aMsg,</span>
<a href="#l6.85"></a><span id="l6.85" class="difflineplus">+   * in nsIFile returnFile); */</span>
<a href="#l6.86"></a><span id="l6.86" class="difflineplus">+  NS_IMETHOD OnStopSending(const char *aMsgID, nsresult aStatus,</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineplus">+                           const char16_t *aMsg, nsIFile *returnFile) {</span>
<a href="#l6.88"></a><span id="l6.88" class="difflineplus">+    mozilla::ReentrantMonitorAutoEnter mon(*this);</span>
<a href="#l6.89"></a><span id="l6.89" class="difflineplus">+    m_done = true;</span>
<a href="#l6.90"></a><span id="l6.90" class="difflineplus">+    NotifyAll();</span>
<a href="#l6.91"></a><span id="l6.91" class="difflineplus">+    return NS_OK;</span>
<a href="#l6.92"></a><span id="l6.92" class="difflineplus">+  }</span>
<a href="#l6.93"></a><span id="l6.93"> </span>
<a href="#l6.94"></a><span id="l6.94" class="difflineminus">-    /* void OnGetDraftFolderURI (); */</span>
<a href="#l6.95"></a><span id="l6.95" class="difflineminus">-    NS_IMETHOD OnGetDraftFolderURI(const char *aFolderURI) {return NS_OK;}</span>
<a href="#l6.96"></a><span id="l6.96" class="difflineplus">+  /* void OnSendNotPerformed */</span>
<a href="#l6.97"></a><span id="l6.97" class="difflineplus">+  NS_IMETHOD OnSendNotPerformed(const char *aMsgID, nsresult aStatus) {</span>
<a href="#l6.98"></a><span id="l6.98" class="difflineplus">+    return OnStopSending(aMsgID, aStatus, nullptr, nullptr);</span>
<a href="#l6.99"></a><span id="l6.99" class="difflineplus">+  }</span>
<a href="#l6.100"></a><span id="l6.100"> </span>
<a href="#l6.101"></a><span id="l6.101" class="difflineminus">-    bool IsDone() { return m_done ; }</span>
<a href="#l6.102"></a><span id="l6.102" class="difflineplus">+  /* void OnGetDraftFolderURI (); */</span>
<a href="#l6.103"></a><span id="l6.103" class="difflineplus">+  NS_IMETHOD OnGetDraftFolderURI(const char *aFolderURI) { return NS_OK; }</span>
<a href="#l6.104"></a><span id="l6.104"> </span>
<a href="#l6.105"></a><span id="l6.105" class="difflineminus">-private:</span>
<a href="#l6.106"></a><span id="l6.106" class="difflineminus">-    bool            m_done;</span>
<a href="#l6.107"></a><span id="l6.107" class="difflineminus">-    virtual ~MAPISendListener() { }</span>
<a href="#l6.108"></a><span id="l6.108" class="difflineplus">+  bool IsDone() { return m_done; }</span>
<a href="#l6.109"></a><span id="l6.109" class="difflineplus">+</span>
<a href="#l6.110"></a><span id="l6.110" class="difflineplus">+ private:</span>
<a href="#l6.111"></a><span id="l6.111" class="difflineplus">+  bool m_done;</span>
<a href="#l6.112"></a><span id="l6.112" class="difflineplus">+  virtual ~MAPISendListener() {}</span>
<a href="#l6.113"></a><span id="l6.113"> };</span>
<a href="#l6.114"></a><span id="l6.114"> </span>
<a href="#l6.115"></a><span id="l6.115" class="difflineminus">-  /// Helper for setting up the hidden window for blind MAPI.</span>
<a href="#l6.116"></a><span id="l6.116" class="difflineminus">-  class MOZ_STACK_CLASS AutoHiddenWindow {</span>
<a href="#l6.117"></a><span id="l6.117" class="difflineminus">-  public:</span>
<a href="#l6.118"></a><span id="l6.118" class="difflineminus">-    explicit AutoHiddenWindow(nsresult &amp;rv)</span>
<a href="#l6.119"></a><span id="l6.119" class="difflineminus">-      : mAppService(do_GetService(&quot;@mozilla.org/appshell/appShellService;1&quot;))</span>
<a href="#l6.120"></a><span id="l6.120" class="difflineminus">-    {</span>
<a href="#l6.121"></a><span id="l6.121" class="difflineminus">-      mCreatedHiddenWindow = false;</span>
<a href="#l6.122"></a><span id="l6.122" class="difflineplus">+/// Helper for setting up the hidden window for blind MAPI.</span>
<a href="#l6.123"></a><span id="l6.123" class="difflineplus">+class MOZ_STACK_CLASS AutoHiddenWindow {</span>
<a href="#l6.124"></a><span id="l6.124" class="difflineplus">+ public:</span>
<a href="#l6.125"></a><span id="l6.125" class="difflineplus">+  explicit AutoHiddenWindow(nsresult &amp;rv)</span>
<a href="#l6.126"></a><span id="l6.126" class="difflineplus">+      : mAppService(do_GetService(&quot;@mozilla.org/appshell/appShellService;1&quot;)) {</span>
<a href="#l6.127"></a><span id="l6.127" class="difflineplus">+    mCreatedHiddenWindow = false;</span>
<a href="#l6.128"></a><span id="l6.128" class="difflineplus">+    rv = mAppService-&gt;GetHiddenDOMWindow(getter_AddRefs(mHiddenWindow));</span>
<a href="#l6.129"></a><span id="l6.129" class="difflineplus">+    if (rv == NS_ERROR_FAILURE) {</span>
<a href="#l6.130"></a><span id="l6.130" class="difflineplus">+      // Try to get a hidden window. If it doesn't exist, create a hidden</span>
<a href="#l6.131"></a><span id="l6.131" class="difflineplus">+      // window for us to use.</span>
<a href="#l6.132"></a><span id="l6.132" class="difflineplus">+      rv = mAppService-&gt;CreateHiddenWindow();</span>
<a href="#l6.133"></a><span id="l6.133" class="difflineplus">+      NS_ENSURE_SUCCESS_VOID(rv);</span>
<a href="#l6.134"></a><span id="l6.134" class="difflineplus">+      mCreatedHiddenWindow = true;</span>
<a href="#l6.135"></a><span id="l6.135">       rv = mAppService-&gt;GetHiddenDOMWindow(getter_AddRefs(mHiddenWindow));</span>
<a href="#l6.136"></a><span id="l6.136" class="difflineminus">-      if (rv == NS_ERROR_FAILURE)</span>
<a href="#l6.137"></a><span id="l6.137" class="difflineminus">-      {</span>
<a href="#l6.138"></a><span id="l6.138" class="difflineminus">-        // Try to get a hidden window. If it doesn't exist, create a hidden</span>
<a href="#l6.139"></a><span id="l6.139" class="difflineminus">-        // window for us to use.</span>
<a href="#l6.140"></a><span id="l6.140" class="difflineminus">-        rv = mAppService-&gt;CreateHiddenWindow();</span>
<a href="#l6.141"></a><span id="l6.141" class="difflineminus">-        NS_ENSURE_SUCCESS_VOID(rv);</span>
<a href="#l6.142"></a><span id="l6.142" class="difflineminus">-        mCreatedHiddenWindow = true;</span>
<a href="#l6.143"></a><span id="l6.143" class="difflineminus">-        rv = mAppService-&gt;GetHiddenDOMWindow(getter_AddRefs(mHiddenWindow));</span>
<a href="#l6.144"></a><span id="l6.144" class="difflineminus">-      }</span>
<a href="#l6.145"></a><span id="l6.145" class="difflineminus">-      NS_ENSURE_SUCCESS_VOID(rv);</span>
<a href="#l6.146"></a><span id="l6.146">     }</span>
<a href="#l6.147"></a><span id="l6.147" class="difflineminus">-    ~AutoHiddenWindow()</span>
<a href="#l6.148"></a><span id="l6.148" class="difflineminus">-    {</span>
<a href="#l6.149"></a><span id="l6.149" class="difflineminus">-      if (mCreatedHiddenWindow)</span>
<a href="#l6.150"></a><span id="l6.150" class="difflineminus">-        mAppService-&gt;DestroyHiddenWindow();</span>
<a href="#l6.151"></a><span id="l6.151" class="difflineminus">-    }</span>
<a href="#l6.152"></a><span id="l6.152" class="difflineminus">-    mozIDOMWindowProxy *operator-&gt;()</span>
<a href="#l6.153"></a><span id="l6.153" class="difflineminus">-    {</span>
<a href="#l6.154"></a><span id="l6.154" class="difflineminus">-      return mHiddenWindow;</span>
<a href="#l6.155"></a><span id="l6.155" class="difflineminus">-    }</span>
<a href="#l6.156"></a><span id="l6.156" class="difflineminus">-    operator mozIDOMWindowProxy *()</span>
<a href="#l6.157"></a><span id="l6.157" class="difflineminus">-    {</span>
<a href="#l6.158"></a><span id="l6.158" class="difflineminus">-      return mHiddenWindow;</span>
<a href="#l6.159"></a><span id="l6.159" class="difflineminus">-    }</span>
<a href="#l6.160"></a><span id="l6.160" class="difflineminus">-  private:</span>
<a href="#l6.161"></a><span id="l6.161" class="difflineminus">-    nsCOMPtr&lt;nsIAppShellService&gt; mAppService;</span>
<a href="#l6.162"></a><span id="l6.162" class="difflineminus">-    nsCOMPtr&lt;mozIDOMWindowProxy&gt; mHiddenWindow;</span>
<a href="#l6.163"></a><span id="l6.163" class="difflineminus">-    bool mCreatedHiddenWindow;</span>
<a href="#l6.164"></a><span id="l6.164" class="difflineminus">-  };</span>
<a href="#l6.165"></a><span id="l6.165" class="difflineplus">+    NS_ENSURE_SUCCESS_VOID(rv);</span>
<a href="#l6.166"></a><span id="l6.166" class="difflineplus">+  }</span>
<a href="#l6.167"></a><span id="l6.167" class="difflineplus">+  ~AutoHiddenWindow() {</span>
<a href="#l6.168"></a><span id="l6.168" class="difflineplus">+    if (mCreatedHiddenWindow) mAppService-&gt;DestroyHiddenWindow();</span>
<a href="#l6.169"></a><span id="l6.169" class="difflineplus">+  }</span>
<a href="#l6.170"></a><span id="l6.170" class="difflineplus">+  mozIDOMWindowProxy *operator-&gt;() { return mHiddenWindow; }</span>
<a href="#l6.171"></a><span id="l6.171" class="difflineplus">+  operator mozIDOMWindowProxy *() { return mHiddenWindow; }</span>
<a href="#l6.172"></a><span id="l6.172" class="difflineplus">+</span>
<a href="#l6.173"></a><span id="l6.173" class="difflineplus">+ private:</span>
<a href="#l6.174"></a><span id="l6.174" class="difflineplus">+  nsCOMPtr&lt;nsIAppShellService&gt; mAppService;</span>
<a href="#l6.175"></a><span id="l6.175" class="difflineplus">+  nsCOMPtr&lt;mozIDOMWindowProxy&gt; mHiddenWindow;</span>
<a href="#l6.176"></a><span id="l6.176" class="difflineplus">+  bool mCreatedHiddenWindow;</span>
<a href="#l6.177"></a><span id="l6.177" class="difflineplus">+};</span>
<a href="#l6.178"></a><span id="l6.178"> </span>
<a href="#l6.179"></a><span id="l6.179"> NS_IMPL_ISUPPORTS(MAPISendListener, nsIMsgSendListener)</span>
<a href="#l6.180"></a><span id="l6.180"> </span>
<a href="#l6.181"></a><span id="l6.181"> bool nsMapiHook::isMapiService = false;</span>
<a href="#l6.182"></a><span id="l6.182"> </span>
<a href="#l6.183"></a><span id="l6.183" class="difflineminus">-void nsMapiHook::CleanUp()</span>
<a href="#l6.184"></a><span id="l6.184" class="difflineminus">-{</span>
<a href="#l6.185"></a><span id="l6.185" class="difflineminus">-    // This routine will be fully implemented in future</span>
<a href="#l6.186"></a><span id="l6.186" class="difflineminus">-    // to cleanup mapi related stuff inside mozilla code.</span>
<a href="#l6.187"></a><span id="l6.187" class="difflineplus">+void nsMapiHook::CleanUp() {</span>
<a href="#l6.188"></a><span id="l6.188" class="difflineplus">+  // This routine will be fully implemented in future</span>
<a href="#l6.189"></a><span id="l6.189" class="difflineplus">+  // to cleanup mapi related stuff inside mozilla code.</span>
<a href="#l6.190"></a><span id="l6.190"> }</span>
<a href="#l6.191"></a><span id="l6.191"> </span>
<a href="#l6.192"></a><span id="l6.192"> bool nsMapiHook::DisplayLoginDialog(bool aLogin, char16_t **aUsername,</span>
<a href="#l6.193"></a><span id="l6.193" class="difflineminus">-                      char16_t **aPassword)</span>
<a href="#l6.194"></a><span id="l6.194" class="difflineminus">-{</span>
<a href="#l6.195"></a><span id="l6.195" class="difflineplus">+                                    char16_t **aPassword) {</span>
<a href="#l6.196"></a><span id="l6.196">   nsresult rv;</span>
<a href="#l6.197"></a><span id="l6.197">   bool btnResult = false;</span>
<a href="#l6.198"></a><span id="l6.198"> </span>
<a href="#l6.199"></a><span id="l6.199" class="difflineminus">-  nsCOMPtr&lt;nsIPromptService&gt; dlgService(do_GetService(NS_PROMPTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l6.200"></a><span id="l6.200" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; dlgService)</span>
<a href="#l6.201"></a><span id="l6.201" class="difflineminus">-  {</span>
<a href="#l6.202"></a><span id="l6.202" class="difflineplus">+  nsCOMPtr&lt;nsIPromptService&gt; dlgService(</span>
<a href="#l6.203"></a><span id="l6.203" class="difflineplus">+      do_GetService(NS_PROMPTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l6.204"></a><span id="l6.204" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; dlgService) {</span>
<a href="#l6.205"></a><span id="l6.205">     nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l6.206"></a><span id="l6.206" class="difflineminus">-      mozilla::services::GetStringBundleService();</span>
<a href="#l6.207"></a><span id="l6.207" class="difflineplus">+        mozilla::services::GetStringBundleService();</span>
<a href="#l6.208"></a><span id="l6.208">     if (!bundleService) return false;</span>
<a href="#l6.209"></a><span id="l6.209"> </span>
<a href="#l6.210"></a><span id="l6.210">     nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l6.211"></a><span id="l6.211" class="difflineminus">-    rv = bundleService-&gt;CreateBundle(MAPI_PROPERTIES_CHROME, getter_AddRefs(bundle));</span>
<a href="#l6.212"></a><span id="l6.212" class="difflineplus">+    rv = bundleService-&gt;CreateBundle(MAPI_PROPERTIES_CHROME,</span>
<a href="#l6.213"></a><span id="l6.213" class="difflineplus">+                                     getter_AddRefs(bundle));</span>
<a href="#l6.214"></a><span id="l6.214">     if (NS_FAILED(rv) || !bundle) return false;</span>
<a href="#l6.215"></a><span id="l6.215"> </span>
<a href="#l6.216"></a><span id="l6.216">     nsCOMPtr&lt;nsIStringBundle&gt; brandBundle;</span>
<a href="#l6.217"></a><span id="l6.217" class="difflineminus">-    rv = bundleService-&gt;CreateBundle(</span>
<a href="#l6.218"></a><span id="l6.218" class="difflineminus">-                    &quot;chrome://branding/locale/brand.properties&quot;,</span>
<a href="#l6.219"></a><span id="l6.219" class="difflineminus">-                    getter_AddRefs(brandBundle));</span>
<a href="#l6.220"></a><span id="l6.220" class="difflineplus">+    rv =</span>
<a href="#l6.221"></a><span id="l6.221" class="difflineplus">+        bundleService-&gt;CreateBundle(&quot;chrome://branding/locale/brand.properties&quot;,</span>
<a href="#l6.222"></a><span id="l6.222" class="difflineplus">+                                    getter_AddRefs(brandBundle));</span>
<a href="#l6.223"></a><span id="l6.223">     if (NS_FAILED(rv)) return false;</span>
<a href="#l6.224"></a><span id="l6.224"> </span>
<a href="#l6.225"></a><span id="l6.225">     nsString brandName;</span>
<a href="#l6.226"></a><span id="l6.226">     rv = brandBundle-&gt;GetStringFromName(&quot;brandFullName&quot;, brandName);</span>
<a href="#l6.227"></a><span id="l6.227">     if (NS_FAILED(rv)) return false;</span>
<a href="#l6.228"></a><span id="l6.228"> </span>
<a href="#l6.229"></a><span id="l6.229">     nsString loginTitle;</span>
<a href="#l6.230"></a><span id="l6.230" class="difflineminus">-    const char16_t *brandStrings[] = { brandName.get() };</span>
<a href="#l6.231"></a><span id="l6.231" class="difflineminus">-    rv = bundle-&gt;FormatStringFromName(&quot;loginTitle&quot;, brandStrings, 1,</span>
<a href="#l6.232"></a><span id="l6.232" class="difflineminus">-                                      loginTitle);</span>
<a href="#l6.233"></a><span id="l6.233" class="difflineplus">+    const char16_t *brandStrings[] = {brandName.get()};</span>
<a href="#l6.234"></a><span id="l6.234" class="difflineplus">+    rv =</span>
<a href="#l6.235"></a><span id="l6.235" class="difflineplus">+        bundle-&gt;FormatStringFromName(&quot;loginTitle&quot;, brandStrings, 1, loginTitle);</span>
<a href="#l6.236"></a><span id="l6.236">     if (NS_FAILED(rv)) return false;</span>
<a href="#l6.237"></a><span id="l6.237"> </span>
<a href="#l6.238"></a><span id="l6.238" class="difflineminus">-    if (aLogin)</span>
<a href="#l6.239"></a><span id="l6.239" class="difflineminus">-    {</span>
<a href="#l6.240"></a><span id="l6.240" class="difflineplus">+    if (aLogin) {</span>
<a href="#l6.241"></a><span id="l6.241">       nsString loginText;</span>
<a href="#l6.242"></a><span id="l6.242">       rv = bundle-&gt;GetStringFromName(&quot;loginTextwithName&quot;, loginText);</span>
<a href="#l6.243"></a><span id="l6.243">       if (NS_FAILED(rv) || loginText.IsEmpty()) return false;</span>
<a href="#l6.244"></a><span id="l6.244"> </span>
<a href="#l6.245"></a><span id="l6.245">       bool dummyValue = false;</span>
<a href="#l6.246"></a><span id="l6.246" class="difflineminus">-      rv = dlgService-&gt;PromptUsernameAndPassword(nullptr, loginTitle.get(),</span>
<a href="#l6.247"></a><span id="l6.247" class="difflineminus">-                                                 loginText.get(), aUsername, aPassword,</span>
<a href="#l6.248"></a><span id="l6.248" class="difflineminus">-                                                 nullptr, &amp;dummyValue, &amp;btnResult);</span>
<a href="#l6.249"></a><span id="l6.249" class="difflineminus">-    }</span>
<a href="#l6.250"></a><span id="l6.250" class="difflineminus">-    else</span>
<a href="#l6.251"></a><span id="l6.251" class="difflineminus">-    {</span>
<a href="#l6.252"></a><span id="l6.252" class="difflineminus">-      //nsString loginString;</span>
<a href="#l6.253"></a><span id="l6.253" class="difflineplus">+      rv = dlgService-&gt;PromptUsernameAndPassword(</span>
<a href="#l6.254"></a><span id="l6.254" class="difflineplus">+          nullptr, loginTitle.get(), loginText.get(), aUsername, aPassword,</span>
<a href="#l6.255"></a><span id="l6.255" class="difflineplus">+          nullptr, &amp;dummyValue, &amp;btnResult);</span>
<a href="#l6.256"></a><span id="l6.256" class="difflineplus">+    } else {</span>
<a href="#l6.257"></a><span id="l6.257" class="difflineplus">+      // nsString loginString;</span>
<a href="#l6.258"></a><span id="l6.258">       nsString loginText;</span>
<a href="#l6.259"></a><span id="l6.259" class="difflineminus">-      const char16_t *userNameStrings[] = { *aUsername };</span>
<a href="#l6.260"></a><span id="l6.260" class="difflineplus">+      const char16_t *userNameStrings[] = {*aUsername};</span>
<a href="#l6.261"></a><span id="l6.261">       rv = bundle-&gt;FormatStringFromName(&quot;loginText&quot;, userNameStrings, 1,</span>
<a href="#l6.262"></a><span id="l6.262">                                         loginText);</span>
<a href="#l6.263"></a><span id="l6.263">       if (NS_FAILED(rv)) return false;</span>
<a href="#l6.264"></a><span id="l6.264"> </span>
<a href="#l6.265"></a><span id="l6.265">       bool dummyValue = false;</span>
<a href="#l6.266"></a><span id="l6.266" class="difflineminus">-      rv = dlgService-&gt;PromptPassword(nullptr, loginTitle.get(), loginText.get(),</span>
<a href="#l6.267"></a><span id="l6.267" class="difflineminus">-                                      aPassword, nullptr, &amp;dummyValue, &amp;btnResult);</span>
<a href="#l6.268"></a><span id="l6.268" class="difflineplus">+      rv = dlgService-&gt;PromptPassword(nullptr, loginTitle.get(),</span>
<a href="#l6.269"></a><span id="l6.269" class="difflineplus">+                                      loginText.get(), aPassword, nullptr,</span>
<a href="#l6.270"></a><span id="l6.270" class="difflineplus">+                                      &amp;dummyValue, &amp;btnResult);</span>
<a href="#l6.271"></a><span id="l6.271">     }</span>
<a href="#l6.272"></a><span id="l6.272">   }</span>
<a href="#l6.273"></a><span id="l6.273"> </span>
<a href="#l6.274"></a><span id="l6.274">   return btnResult;</span>
<a href="#l6.275"></a><span id="l6.275"> }</span>
<a href="#l6.276"></a><span id="l6.276"> </span>
<a href="#l6.277"></a><span id="l6.277" class="difflineminus">-bool nsMapiHook::VerifyUserName(const nsCString&amp; aUsername, nsCString&amp; aIdKey)</span>
<a href="#l6.278"></a><span id="l6.278" class="difflineminus">-{</span>
<a href="#l6.279"></a><span id="l6.279" class="difflineplus">+bool nsMapiHook::VerifyUserName(const nsCString &amp;aUsername, nsCString &amp;aIdKey) {</span>
<a href="#l6.280"></a><span id="l6.280">   nsresult rv;</span>
<a href="#l6.281"></a><span id="l6.281"> </span>
<a href="#l6.282"></a><span id="l6.282" class="difflineminus">-  if (aUsername.IsEmpty())</span>
<a href="#l6.283"></a><span id="l6.283" class="difflineminus">-    return false;</span>
<a href="#l6.284"></a><span id="l6.284" class="difflineplus">+  if (aUsername.IsEmpty()) return false;</span>
<a href="#l6.285"></a><span id="l6.285"> </span>
<a href="#l6.286"></a><span id="l6.286" class="difflineminus">-  nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager(do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv));</span>
<a href="#l6.287"></a><span id="l6.287" class="difflineplus">+  nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager(</span>
<a href="#l6.288"></a><span id="l6.288" class="difflineplus">+      do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv));</span>
<a href="#l6.289"></a><span id="l6.289">   if (NS_FAILED(rv)) return false;</span>
<a href="#l6.290"></a><span id="l6.290">   nsCOMPtr&lt;nsIArray&gt; identities;</span>
<a href="#l6.291"></a><span id="l6.291">   rv = accountManager-&gt;GetAllIdentities(getter_AddRefs(identities));</span>
<a href="#l6.292"></a><span id="l6.292">   if (NS_FAILED(rv)) return false;</span>
<a href="#l6.293"></a><span id="l6.293"> </span>
<a href="#l6.294"></a><span id="l6.294">   uint32_t numIndentities = 0;</span>
<a href="#l6.295"></a><span id="l6.295">   identities-&gt;GetLength(&amp;numIndentities);</span>
<a href="#l6.296"></a><span id="l6.296"> </span>
<a href="#l6.297"></a><span id="l6.297" class="difflineminus">-  for (uint32_t i = 0; i &lt; numIndentities; i++)</span>
<a href="#l6.298"></a><span id="l6.298" class="difflineminus">-  {</span>
<a href="#l6.299"></a><span id="l6.299" class="difflineminus">-    nsCOMPtr&lt;nsIMsgIdentity&gt; thisIdentity(do_QueryElementAt(identities, i, &amp;rv));</span>
<a href="#l6.300"></a><span id="l6.300" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; thisIdentity)</span>
<a href="#l6.301"></a><span id="l6.301" class="difflineminus">-    {</span>
<a href="#l6.302"></a><span id="l6.302" class="difflineplus">+  for (uint32_t i = 0; i &lt; numIndentities; i++) {</span>
<a href="#l6.303"></a><span id="l6.303" class="difflineplus">+    nsCOMPtr&lt;nsIMsgIdentity&gt; thisIdentity(</span>
<a href="#l6.304"></a><span id="l6.304" class="difflineplus">+        do_QueryElementAt(identities, i, &amp;rv));</span>
<a href="#l6.305"></a><span id="l6.305" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; thisIdentity) {</span>
<a href="#l6.306"></a><span id="l6.306">       nsCString email;</span>
<a href="#l6.307"></a><span id="l6.307">       rv = thisIdentity-&gt;GetEmail(email);</span>
<a href="#l6.308"></a><span id="l6.308">       if (NS_FAILED(rv)) continue;</span>
<a href="#l6.309"></a><span id="l6.309"> </span>
<a href="#l6.310"></a><span id="l6.310">       // get the username from the email and compare with the username</span>
<a href="#l6.311"></a><span id="l6.311">       int32_t index = email.FindChar('@');</span>
<a href="#l6.312"></a><span id="l6.312" class="difflineminus">-      if (index != -1)</span>
<a href="#l6.313"></a><span id="l6.313" class="difflineminus">-        email.SetLength(index);</span>
<a href="#l6.314"></a><span id="l6.314" class="difflineplus">+      if (index != -1) email.SetLength(index);</span>
<a href="#l6.315"></a><span id="l6.315"> </span>
<a href="#l6.316"></a><span id="l6.316">       if (aUsername.Equals(email))</span>
<a href="#l6.317"></a><span id="l6.317">         return NS_SUCCEEDED(thisIdentity-&gt;GetKey(aIdKey));</span>
<a href="#l6.318"></a><span id="l6.318">     }</span>
<a href="#l6.319"></a><span id="l6.319">   }</span>
<a href="#l6.320"></a><span id="l6.320"> </span>
<a href="#l6.321"></a><span id="l6.321">   return false;</span>
<a href="#l6.322"></a><span id="l6.322"> }</span>
<a href="#l6.323"></a><span id="l6.323"> </span>
<a href="#l6.324"></a><span id="l6.324" class="difflineminus">-bool</span>
<a href="#l6.325"></a><span id="l6.325" class="difflineminus">-nsMapiHook::IsBlindSendAllowed()</span>
<a href="#l6.326"></a><span id="l6.326" class="difflineminus">-{</span>
<a href="#l6.327"></a><span id="l6.327" class="difflineplus">+bool nsMapiHook::IsBlindSendAllowed() {</span>
<a href="#l6.328"></a><span id="l6.328">   bool enabled = false;</span>
<a href="#l6.329"></a><span id="l6.329">   bool warn = true;</span>
<a href="#l6.330"></a><span id="l6.330">   nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch = do_GetService(NS_PREFSERVICE_CONTRACTID);</span>
<a href="#l6.331"></a><span id="l6.331">   if (prefBranch) {</span>
<a href="#l6.332"></a><span id="l6.332" class="difflineminus">-      prefBranch-&gt;GetBoolPref(PREF_MAPI_WARN_PRIOR_TO_BLIND_SEND, &amp;warn);</span>
<a href="#l6.333"></a><span id="l6.333" class="difflineminus">-      prefBranch-&gt;GetBoolPref(PREF_MAPI_BLIND_SEND_ENABLED, &amp;enabled);</span>
<a href="#l6.334"></a><span id="l6.334" class="difflineplus">+    prefBranch-&gt;GetBoolPref(PREF_MAPI_WARN_PRIOR_TO_BLIND_SEND, &amp;warn);</span>
<a href="#l6.335"></a><span id="l6.335" class="difflineplus">+    prefBranch-&gt;GetBoolPref(PREF_MAPI_BLIND_SEND_ENABLED, &amp;enabled);</span>
<a href="#l6.336"></a><span id="l6.336">   }</span>
<a href="#l6.337"></a><span id="l6.337" class="difflineminus">-  if (!enabled)</span>
<a href="#l6.338"></a><span id="l6.338" class="difflineminus">-      return false;</span>
<a href="#l6.339"></a><span id="l6.339" class="difflineplus">+  if (!enabled) return false;</span>
<a href="#l6.340"></a><span id="l6.340"> </span>
<a href="#l6.341"></a><span id="l6.341" class="difflineminus">-  if (!warn)</span>
<a href="#l6.342"></a><span id="l6.342" class="difflineminus">-      return true; // Everything is okay.</span>
<a href="#l6.343"></a><span id="l6.343" class="difflineplus">+  if (!warn) return true;  // Everything is okay.</span>
<a href="#l6.344"></a><span id="l6.344"> </span>
<a href="#l6.345"></a><span id="l6.345">   nsresult rv;</span>
<a href="#l6.346"></a><span id="l6.346">   nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l6.347"></a><span id="l6.347" class="difflineminus">-    mozilla::services::GetStringBundleService();</span>
<a href="#l6.348"></a><span id="l6.348" class="difflineplus">+      mozilla::services::GetStringBundleService();</span>
<a href="#l6.349"></a><span id="l6.349">   if (!bundleService) return false;</span>
<a href="#l6.350"></a><span id="l6.350"> </span>
<a href="#l6.351"></a><span id="l6.351">   nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l6.352"></a><span id="l6.352" class="difflineminus">-  rv = bundleService-&gt;CreateBundle(MAPI_PROPERTIES_CHROME, getter_AddRefs(bundle));</span>
<a href="#l6.353"></a><span id="l6.353" class="difflineplus">+  rv = bundleService-&gt;CreateBundle(MAPI_PROPERTIES_CHROME,</span>
<a href="#l6.354"></a><span id="l6.354" class="difflineplus">+                                   getter_AddRefs(bundle));</span>
<a href="#l6.355"></a><span id="l6.355">   if (NS_FAILED(rv) || !bundle) return false;</span>
<a href="#l6.356"></a><span id="l6.356"> </span>
<a href="#l6.357"></a><span id="l6.357">   nsString warningMsg;</span>
<a href="#l6.358"></a><span id="l6.358">   rv = bundle-&gt;GetStringFromName(&quot;mapiBlindSendWarning&quot;, warningMsg);</span>
<a href="#l6.359"></a><span id="l6.359">   if (NS_FAILED(rv)) return false;</span>
<a href="#l6.360"></a><span id="l6.360"> </span>
<a href="#l6.361"></a><span id="l6.361">   nsString dontShowAgainMessage;</span>
<a href="#l6.362"></a><span id="l6.362">   rv = bundle-&gt;GetStringFromName(&quot;mapiBlindSendDontShowAgain&quot;,</span>
<a href="#l6.363"></a><span id="l6.363">                                  dontShowAgainMessage);</span>
<a href="#l6.364"></a><span id="l6.364">   if (NS_FAILED(rv)) return false;</span>
<a href="#l6.365"></a><span id="l6.365"> </span>
<a href="#l6.366"></a><span id="l6.366" class="difflineminus">-  nsCOMPtr&lt;nsIPromptService&gt; dlgService(do_GetService(NS_PROMPTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l6.367"></a><span id="l6.367" class="difflineplus">+  nsCOMPtr&lt;nsIPromptService&gt; dlgService(</span>
<a href="#l6.368"></a><span id="l6.368" class="difflineplus">+      do_GetService(NS_PROMPTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l6.369"></a><span id="l6.369">   if (NS_FAILED(rv) || !dlgService) return false;</span>
<a href="#l6.370"></a><span id="l6.370"> </span>
<a href="#l6.371"></a><span id="l6.371">   bool continueToWarn = true;</span>
<a href="#l6.372"></a><span id="l6.372">   bool okayToContinue = false;</span>
<a href="#l6.373"></a><span id="l6.373" class="difflineminus">-  dlgService-&gt;ConfirmCheck(nullptr, nullptr, warningMsg.get(), dontShowAgainMessage.get(), &amp;continueToWarn, &amp;okayToContinue);</span>
<a href="#l6.374"></a><span id="l6.374" class="difflineplus">+  dlgService-&gt;ConfirmCheck(nullptr, nullptr, warningMsg.get(),</span>
<a href="#l6.375"></a><span id="l6.375" class="difflineplus">+                           dontShowAgainMessage.get(), &amp;continueToWarn,</span>
<a href="#l6.376"></a><span id="l6.376" class="difflineplus">+                           &amp;okayToContinue);</span>
<a href="#l6.377"></a><span id="l6.377"> </span>
<a href="#l6.378"></a><span id="l6.378">   if (!continueToWarn &amp;&amp; okayToContinue &amp;&amp; prefBranch)</span>
<a href="#l6.379"></a><span id="l6.379">     prefBranch-&gt;SetBoolPref(PREF_MAPI_WARN_PRIOR_TO_BLIND_SEND, false);</span>
<a href="#l6.380"></a><span id="l6.380"> </span>
<a href="#l6.381"></a><span id="l6.381">   return okayToContinue;</span>
<a href="#l6.382"></a><span id="l6.382"> }</span>
<a href="#l6.383"></a><span id="l6.383"> </span>
<a href="#l6.384"></a><span id="l6.384"> // this is used for Send without UI</span>
<a href="#l6.385"></a><span id="l6.385" class="difflineminus">-nsresult nsMapiHook::BlindSendMail (unsigned long aSession, nsIMsgCompFields * aCompFields)</span>
<a href="#l6.386"></a><span id="l6.386" class="difflineminus">-{</span>
<a href="#l6.387"></a><span id="l6.387" class="difflineplus">+nsresult nsMapiHook::BlindSendMail(unsigned long aSession,</span>
<a href="#l6.388"></a><span id="l6.388" class="difflineplus">+                                   nsIMsgCompFields *aCompFields) {</span>
<a href="#l6.389"></a><span id="l6.389">   nsresult rv = NS_OK;</span>
<a href="#l6.390"></a><span id="l6.390"> </span>
<a href="#l6.391"></a><span id="l6.391" class="difflineminus">-  if (!IsBlindSendAllowed())</span>
<a href="#l6.392"></a><span id="l6.392" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l6.393"></a><span id="l6.393" class="difflineplus">+  if (!IsBlindSendAllowed()) return NS_ERROR_FAILURE;</span>
<a href="#l6.394"></a><span id="l6.394"> </span>
<a href="#l6.395"></a><span id="l6.395">   // Get a hidden window to use for compose.</span>
<a href="#l6.396"></a><span id="l6.396">   AutoHiddenWindow hiddenWindow(rv);</span>
<a href="#l6.397"></a><span id="l6.397">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.398"></a><span id="l6.398"> </span>
<a href="#l6.399"></a><span id="l6.399">   // smtp password and Logged in used IdKey from MapiConfig (session obj)</span>
<a href="#l6.400"></a><span id="l6.400" class="difflineminus">-  nsMAPIConfiguration * pMapiConfig = nsMAPIConfiguration::GetMAPIConfiguration() ;</span>
<a href="#l6.401"></a><span id="l6.401" class="difflineminus">-  if (!pMapiConfig) return NS_ERROR_FAILURE ;  // get the singelton obj</span>
<a href="#l6.402"></a><span id="l6.402" class="difflineminus">-  char16_t * password = pMapiConfig-&gt;GetPassword(aSession) ;</span>
<a href="#l6.403"></a><span id="l6.403" class="difflineplus">+  nsMAPIConfiguration *pMapiConfig =</span>
<a href="#l6.404"></a><span id="l6.404" class="difflineplus">+      nsMAPIConfiguration::GetMAPIConfiguration();</span>
<a href="#l6.405"></a><span id="l6.405" class="difflineplus">+  if (!pMapiConfig) return NS_ERROR_FAILURE;  // get the singelton obj</span>
<a href="#l6.406"></a><span id="l6.406" class="difflineplus">+  char16_t *password = pMapiConfig-&gt;GetPassword(aSession);</span>
<a href="#l6.407"></a><span id="l6.407"> </span>
<a href="#l6.408"></a><span id="l6.408">   // Id key</span>
<a href="#l6.409"></a><span id="l6.409">   nsCString MsgIdKey;</span>
<a href="#l6.410"></a><span id="l6.410">   pMapiConfig-&gt;GetIdKey(aSession, MsgIdKey);</span>
<a href="#l6.411"></a><span id="l6.411"> </span>
<a href="#l6.412"></a><span id="l6.412">   // get the MsgIdentity for the above key using AccountManager</span>
<a href="#l6.413"></a><span id="l6.413" class="difflineminus">-  nsCOMPtr &lt;nsIMsgAccountManager&gt; accountManager = do_GetService (NS_MSGACCOUNTMANAGER_CONTRACTID) ;</span>
<a href="#l6.414"></a><span id="l6.414" class="difflineminus">-  if (NS_FAILED(rv) || (!accountManager) ) return rv ;</span>
<a href="#l6.415"></a><span id="l6.415" class="difflineplus">+  nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l6.416"></a><span id="l6.416" class="difflineplus">+      do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID);</span>
<a href="#l6.417"></a><span id="l6.417" class="difflineplus">+  if (NS_FAILED(rv) || (!accountManager)) return rv;</span>
<a href="#l6.418"></a><span id="l6.418"> </span>
<a href="#l6.419"></a><span id="l6.419" class="difflineminus">-  nsCOMPtr &lt;nsIMsgIdentity&gt; pMsgId ;</span>
<a href="#l6.420"></a><span id="l6.420" class="difflineminus">-  rv = accountManager-&gt;GetIdentity (MsgIdKey, getter_AddRefs(pMsgId)) ;</span>
<a href="#l6.421"></a><span id="l6.421" class="difflineminus">-  if (NS_FAILED(rv) ) return rv ;</span>
<a href="#l6.422"></a><span id="l6.422" class="difflineplus">+  nsCOMPtr&lt;nsIMsgIdentity&gt; pMsgId;</span>
<a href="#l6.423"></a><span id="l6.423" class="difflineplus">+  rv = accountManager-&gt;GetIdentity(MsgIdKey, getter_AddRefs(pMsgId));</span>
<a href="#l6.424"></a><span id="l6.424" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.425"></a><span id="l6.425"> </span>
<a href="#l6.426"></a><span id="l6.426">   // create a send listener to get back the send status</span>
<a href="#l6.427"></a><span id="l6.427">   RefPtr&lt;MAPISendListener&gt; sendListener = new MAPISendListener;</span>
<a href="#l6.428"></a><span id="l6.428"> </span>
<a href="#l6.429"></a><span id="l6.429">   // create the compose params object</span>
<a href="#l6.430"></a><span id="l6.430" class="difflineminus">-  nsCOMPtr&lt;nsIMsgComposeParams&gt; pMsgComposeParams (do_CreateInstance(NS_MSGCOMPOSEPARAMS_CONTRACTID, &amp;rv));</span>
<a href="#l6.431"></a><span id="l6.431" class="difflineminus">-  if (NS_FAILED(rv) || (!pMsgComposeParams) ) return rv ;</span>
<a href="#l6.432"></a><span id="l6.432" class="difflineplus">+  nsCOMPtr&lt;nsIMsgComposeParams&gt; pMsgComposeParams(</span>
<a href="#l6.433"></a><span id="l6.433" class="difflineplus">+      do_CreateInstance(NS_MSGCOMPOSEPARAMS_CONTRACTID, &amp;rv));</span>
<a href="#l6.434"></a><span id="l6.434" class="difflineplus">+  if (NS_FAILED(rv) || (!pMsgComposeParams)) return rv;</span>
<a href="#l6.435"></a><span id="l6.435"> </span>
<a href="#l6.436"></a><span id="l6.436">   // populate the compose params</span>
<a href="#l6.437"></a><span id="l6.437">   bool forcePlainText;</span>
<a href="#l6.438"></a><span id="l6.438">   aCompFields-&gt;GetForcePlainText(&amp;forcePlainText);</span>
<a href="#l6.439"></a><span id="l6.439">   pMsgComposeParams-&gt;SetType(nsIMsgCompType::New);</span>
<a href="#l6.440"></a><span id="l6.440" class="difflineminus">-  pMsgComposeParams-&gt;SetFormat(forcePlainText ? nsIMsgCompFormat::PlainText : nsIMsgCompFormat::HTML);</span>
<a href="#l6.441"></a><span id="l6.441" class="difflineplus">+  pMsgComposeParams-&gt;SetFormat(forcePlainText ? nsIMsgCompFormat::PlainText</span>
<a href="#l6.442"></a><span id="l6.442" class="difflineplus">+                                              : nsIMsgCompFormat::HTML);</span>
<a href="#l6.443"></a><span id="l6.443">   pMsgComposeParams-&gt;SetIdentity(pMsgId);</span>
<a href="#l6.444"></a><span id="l6.444">   pMsgComposeParams-&gt;SetComposeFields(aCompFields);</span>
<a href="#l6.445"></a><span id="l6.445" class="difflineminus">-  pMsgComposeParams-&gt;SetSendListener(sendListener) ;</span>
<a href="#l6.446"></a><span id="l6.446" class="difflineminus">-  if (password)</span>
<a href="#l6.447"></a><span id="l6.447" class="difflineminus">-    pMsgComposeParams-&gt;SetSmtpPassword(nsDependentString(password));</span>
<a href="#l6.448"></a><span id="l6.448" class="difflineplus">+  pMsgComposeParams-&gt;SetSendListener(sendListener);</span>
<a href="#l6.449"></a><span id="l6.449" class="difflineplus">+  if (password) pMsgComposeParams-&gt;SetSmtpPassword(nsDependentString(password));</span>
<a href="#l6.450"></a><span id="l6.450"> </span>
<a href="#l6.451"></a><span id="l6.451">   // create the nsIMsgCompose object to send the object</span>
<a href="#l6.452"></a><span id="l6.452" class="difflineminus">-  nsCOMPtr&lt;nsIMsgCompose&gt; pMsgCompose (do_CreateInstance(NS_MSGCOMPOSE_CONTRACTID, &amp;rv));</span>
<a href="#l6.453"></a><span id="l6.453" class="difflineplus">+  nsCOMPtr&lt;nsIMsgCompose&gt; pMsgCompose(</span>
<a href="#l6.454"></a><span id="l6.454" class="difflineplus">+      do_CreateInstance(NS_MSGCOMPOSE_CONTRACTID, &amp;rv));</span>
<a href="#l6.455"></a><span id="l6.455">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.456"></a><span id="l6.456">   rv = pMsgCompose-&gt;Initialize(pMsgComposeParams, hiddenWindow, nullptr);</span>
<a href="#l6.457"></a><span id="l6.457">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.458"></a><span id="l6.458"> </span>
<a href="#l6.459"></a><span id="l6.459">   // If we're in offline mode, we'll need to queue it for later.</span>
<a href="#l6.460"></a><span id="l6.460">   rv = pMsgCompose-&gt;SendMsg(WeAreOffline() ? nsIMsgSend::nsMsgQueueForLater</span>
<a href="#l6.461"></a><span id="l6.461">                                            : nsIMsgSend::nsMsgDeliverNow,</span>
<a href="#l6.462"></a><span id="l6.462">                             pMsgId, nullptr, nullptr, nullptr);</span>
<a href="#l6.463"></a><span id="l6.463">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.464"></a><span id="l6.464"> </span>
<a href="#l6.465"></a><span id="l6.465">   // We need to wait to make sure that we only return when the send is</span>
<a href="#l6.466"></a><span id="l6.466">   // completed. If we're offline, we're not sending yet, so don't bother</span>
<a href="#l6.467"></a><span id="l6.467">   // waiting.</span>
<a href="#l6.468"></a><span id="l6.468" class="difflineminus">-  if (WeAreOffline())</span>
<a href="#l6.469"></a><span id="l6.469" class="difflineminus">-    return NS_OK;</span>
<a href="#l6.470"></a><span id="l6.470" class="difflineplus">+  if (WeAreOffline()) return NS_OK;</span>
<a href="#l6.471"></a><span id="l6.471"> </span>
<a href="#l6.472"></a><span id="l6.472">   nsCOMPtr&lt;nsIThread&gt; thread(do_GetCurrentThread());</span>
<a href="#l6.473"></a><span id="l6.473" class="difflineminus">-  while (!sendListener-&gt;IsDone())</span>
<a href="#l6.474"></a><span id="l6.474" class="difflineminus">-  {</span>
<a href="#l6.475"></a><span id="l6.475" class="difflineplus">+  while (!sendListener-&gt;IsDone()) {</span>
<a href="#l6.476"></a><span id="l6.476">     mozilla::ReentrantMonitorAutoEnter mon(*sendListener);</span>
<a href="#l6.477"></a><span id="l6.477">     sendListener-&gt;Wait(PR_MicrosecondsToInterval(1000UL));</span>
<a href="#l6.478"></a><span id="l6.478">     NS_ProcessPendingEvents(thread);</span>
<a href="#l6.479"></a><span id="l6.479">   }</span>
<a href="#l6.480"></a><span id="l6.480"> </span>
<a href="#l6.481"></a><span id="l6.481">   return rv;</span>
<a href="#l6.482"></a><span id="l6.482"> }</span>
<a href="#l6.483"></a><span id="l6.483"> </span>
<a href="#l6.484"></a><span id="l6.484" class="difflineminus">-nsresult nsMapiHook::HandleAttachments (nsIMsgCompFields * aCompFields, int32_t aFileCount,</span>
<a href="#l6.485"></a><span id="l6.485" class="difflineminus">-                                        lpnsMapiFileDesc aFiles, bool aIsUTF8)</span>
<a href="#l6.486"></a><span id="l6.486" class="difflineminus">-{</span>
<a href="#l6.487"></a><span id="l6.487" class="difflineminus">-    nsresult rv = NS_OK ;</span>
<a href="#l6.488"></a><span id="l6.488" class="difflineminus">-    // Do nothing if there are no files to process.</span>
<a href="#l6.489"></a><span id="l6.489" class="difflineminus">-    if (!aFiles || aFileCount &lt;= 0)</span>
<a href="#l6.490"></a><span id="l6.490" class="difflineminus">-        return NS_OK;</span>
<a href="#l6.491"></a><span id="l6.491" class="difflineplus">+nsresult nsMapiHook::HandleAttachments(nsIMsgCompFields *aCompFields,</span>
<a href="#l6.492"></a><span id="l6.492" class="difflineplus">+                                       int32_t aFileCount,</span>
<a href="#l6.493"></a><span id="l6.493" class="difflineplus">+                                       lpnsMapiFileDesc aFiles, bool aIsUTF8) {</span>
<a href="#l6.494"></a><span id="l6.494" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l6.495"></a><span id="l6.495" class="difflineplus">+  // Do nothing if there are no files to process.</span>
<a href="#l6.496"></a><span id="l6.496" class="difflineplus">+  if (!aFiles || aFileCount &lt;= 0) return NS_OK;</span>
<a href="#l6.497"></a><span id="l6.497" class="difflineplus">+</span>
<a href="#l6.498"></a><span id="l6.498" class="difflineplus">+  nsAutoCString Attachments;</span>
<a href="#l6.499"></a><span id="l6.499" class="difflineplus">+  nsAutoCString TempFiles;</span>
<a href="#l6.500"></a><span id="l6.500"> </span>
<a href="#l6.501"></a><span id="l6.501" class="difflineminus">-    nsAutoCString Attachments ;</span>
<a href="#l6.502"></a><span id="l6.502" class="difflineminus">-    nsAutoCString TempFiles ;</span>
<a href="#l6.503"></a><span id="l6.503" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; pFile = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l6.504"></a><span id="l6.504" class="difflineplus">+  if (NS_FAILED(rv) || (!pFile)) return rv;</span>
<a href="#l6.505"></a><span id="l6.505" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; pTempDir = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l6.506"></a><span id="l6.506" class="difflineplus">+  if (NS_FAILED(rv) || (!pTempDir)) return rv;</span>
<a href="#l6.507"></a><span id="l6.507"> </span>
<a href="#l6.508"></a><span id="l6.508" class="difflineminus">-    nsCOMPtr &lt;nsIFile&gt; pFile = do_CreateInstance (NS_LOCAL_FILE_CONTRACTID, &amp;rv) ;</span>
<a href="#l6.509"></a><span id="l6.509" class="difflineminus">-    if (NS_FAILED(rv) || (!pFile) ) return rv ;</span>
<a href="#l6.510"></a><span id="l6.510" class="difflineminus">-    nsCOMPtr &lt;nsIFile&gt; pTempDir = do_CreateInstance (NS_LOCAL_FILE_CONTRACTID, &amp;rv) ;</span>
<a href="#l6.511"></a><span id="l6.511" class="difflineminus">-    if (NS_FAILED(rv) || (!pTempDir) ) return rv ;</span>
<a href="#l6.512"></a><span id="l6.512" class="difflineplus">+  for (int i = 0; i &lt; aFileCount; i++) {</span>
<a href="#l6.513"></a><span id="l6.513" class="difflineplus">+    if (aFiles[i].lpszPathName) {</span>
<a href="#l6.514"></a><span id="l6.514" class="difflineplus">+      // check if attachment exists</span>
<a href="#l6.515"></a><span id="l6.515" class="difflineplus">+      if (!aIsUTF8)</span>
<a href="#l6.516"></a><span id="l6.516" class="difflineplus">+        pFile-&gt;InitWithNativePath(nsDependentCString(aFiles[i].lpszPathName));</span>
<a href="#l6.517"></a><span id="l6.517" class="difflineplus">+      else</span>
<a href="#l6.518"></a><span id="l6.518" class="difflineplus">+        pFile-&gt;InitWithPath(NS_ConvertUTF8toUTF16(aFiles[i].lpszPathName));</span>
<a href="#l6.519"></a><span id="l6.519"> </span>
<a href="#l6.520"></a><span id="l6.520" class="difflineminus">-    for (int i=0 ; i &lt; aFileCount ; i++)</span>
<a href="#l6.521"></a><span id="l6.521" class="difflineminus">-    {</span>
<a href="#l6.522"></a><span id="l6.522" class="difflineminus">-        if (aFiles[i].lpszPathName)</span>
<a href="#l6.523"></a><span id="l6.523" class="difflineminus">-        {</span>
<a href="#l6.524"></a><span id="l6.524" class="difflineminus">-            // check if attachment exists</span>
<a href="#l6.525"></a><span id="l6.525" class="difflineminus">-            if (!aIsUTF8)</span>
<a href="#l6.526"></a><span id="l6.526" class="difflineminus">-              pFile-&gt;InitWithNativePath(nsDependentCString(aFiles[i].lpszPathName));</span>
<a href="#l6.527"></a><span id="l6.527" class="difflineminus">-            else</span>
<a href="#l6.528"></a><span id="l6.528" class="difflineminus">-              pFile-&gt;InitWithPath(NS_ConvertUTF8toUTF16(aFiles[i].lpszPathName));</span>
<a href="#l6.529"></a><span id="l6.529" class="difflineplus">+      bool bExist;</span>
<a href="#l6.530"></a><span id="l6.530" class="difflineplus">+      rv = pFile-&gt;Exists(&amp;bExist);</span>
<a href="#l6.531"></a><span id="l6.531" class="difflineplus">+      MOZ_LOG(</span>
<a href="#l6.532"></a><span id="l6.532" class="difflineplus">+          MAPI, mozilla::LogLevel::Debug,</span>
<a href="#l6.533"></a><span id="l6.533" class="difflineplus">+          (&quot;nsMapiHook::HandleAttachments: filename: %s path: %s exists = %s\n&quot;,</span>
<a href="#l6.534"></a><span id="l6.534" class="difflineplus">+           (const char *)aFiles[i].lpszFileName,</span>
<a href="#l6.535"></a><span id="l6.535" class="difflineplus">+           (const char *)aFiles[i].lpszPathName, bExist ? &quot;true&quot; : &quot;false&quot;));</span>
<a href="#l6.536"></a><span id="l6.536" class="difflineplus">+      if (NS_FAILED(rv) || (!bExist))</span>
<a href="#l6.537"></a><span id="l6.537" class="difflineplus">+        return NS_ERROR_FILE_TARGET_DOES_NOT_EXIST;</span>
<a href="#l6.538"></a><span id="l6.538"> </span>
<a href="#l6.539"></a><span id="l6.539" class="difflineminus">-            bool bExist ;</span>
<a href="#l6.540"></a><span id="l6.540" class="difflineminus">-            rv = pFile-&gt;Exists(&amp;bExist) ;</span>
<a href="#l6.541"></a><span id="l6.541" class="difflineminus">-            MOZ_LOG(MAPI, mozilla::LogLevel::Debug,</span>
<a href="#l6.542"></a><span id="l6.542" class="difflineminus">-              (&quot;nsMapiHook::HandleAttachments: filename: %s path: %s exists = %s\n&quot;,</span>
<a href="#l6.543"></a><span id="l6.543" class="difflineminus">-               (const char*)aFiles[i].lpszFileName,</span>
<a href="#l6.544"></a><span id="l6.544" class="difflineminus">-               (const char*)aFiles[i].lpszPathName, bExist ? &quot;true&quot; : &quot;false&quot;));</span>
<a href="#l6.545"></a><span id="l6.545" class="difflineminus">-            if (NS_FAILED(rv) || (!bExist) ) return NS_ERROR_FILE_TARGET_DOES_NOT_EXIST ;</span>
<a href="#l6.546"></a><span id="l6.546" class="difflineplus">+      // Temp Directory</span>
<a href="#l6.547"></a><span id="l6.547" class="difflineplus">+      nsCOMPtr&lt;nsIFile&gt; pTempDir;</span>
<a href="#l6.548"></a><span id="l6.548" class="difflineplus">+      NS_GetSpecialDirectory(NS_OS_TEMP_DIR, getter_AddRefs(pTempDir));</span>
<a href="#l6.549"></a><span id="l6.549"> </span>
<a href="#l6.550"></a><span id="l6.550" class="difflineminus">-            //Temp Directory</span>
<a href="#l6.551"></a><span id="l6.551" class="difflineminus">-            nsCOMPtr &lt;nsIFile&gt; pTempDir;</span>
<a href="#l6.552"></a><span id="l6.552" class="difflineminus">-            NS_GetSpecialDirectory(NS_OS_TEMP_DIR, getter_AddRefs(pTempDir));</span>
<a href="#l6.553"></a><span id="l6.553" class="difflineplus">+      // create a new sub directory called moz_mapi underneath the temp</span>
<a href="#l6.554"></a><span id="l6.554" class="difflineplus">+      // directory</span>
<a href="#l6.555"></a><span id="l6.555" class="difflineplus">+      pTempDir-&gt;AppendRelativePath(NS_LITERAL_STRING(&quot;moz_mapi&quot;));</span>
<a href="#l6.556"></a><span id="l6.556" class="difflineplus">+      pTempDir-&gt;Exists(&amp;bExist);</span>
<a href="#l6.557"></a><span id="l6.557" class="difflineplus">+      if (!bExist) {</span>
<a href="#l6.558"></a><span id="l6.558" class="difflineplus">+        rv = pTempDir-&gt;Create(nsIFile::DIRECTORY_TYPE, 777);</span>
<a href="#l6.559"></a><span id="l6.559" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.560"></a><span id="l6.560" class="difflineplus">+      }</span>
<a href="#l6.561"></a><span id="l6.561"> </span>
<a href="#l6.562"></a><span id="l6.562" class="difflineminus">-            // create a new sub directory called moz_mapi underneath the temp directory</span>
<a href="#l6.563"></a><span id="l6.563" class="difflineminus">-            pTempDir-&gt;AppendRelativePath(NS_LITERAL_STRING(&quot;moz_mapi&quot;));</span>
<a href="#l6.564"></a><span id="l6.564" class="difflineminus">-            pTempDir-&gt;Exists (&amp;bExist) ;</span>
<a href="#l6.565"></a><span id="l6.565" class="difflineminus">-            if (!bExist)</span>
<a href="#l6.566"></a><span id="l6.566" class="difflineminus">-            {</span>
<a href="#l6.567"></a><span id="l6.567" class="difflineminus">-                rv = pTempDir-&gt;Create(nsIFile::DIRECTORY_TYPE, 777) ;</span>
<a href="#l6.568"></a><span id="l6.568" class="difflineminus">-                if (NS_FAILED(rv)) return rv ;</span>
<a href="#l6.569"></a><span id="l6.569" class="difflineminus">-            }</span>
<a href="#l6.570"></a><span id="l6.570" class="difflineminus">-</span>
<a href="#l6.571"></a><span id="l6.571" class="difflineminus">-            // rename or copy the existing temp file with the real file name</span>
<a href="#l6.572"></a><span id="l6.572" class="difflineplus">+      // rename or copy the existing temp file with the real file name</span>
<a href="#l6.573"></a><span id="l6.573"> </span>
<a href="#l6.574"></a><span id="l6.574" class="difflineminus">-            nsAutoString leafName ;</span>
<a href="#l6.575"></a><span id="l6.575" class="difflineminus">-            // convert to Unicode using Platform charset</span>
<a href="#l6.576"></a><span id="l6.576" class="difflineminus">-            // leafName already contains a unicode leafName from lpszPathName. If we were given</span>
<a href="#l6.577"></a><span id="l6.577" class="difflineminus">-            // a value for lpszFileName, use it. Otherwise stick with leafName</span>
<a href="#l6.578"></a><span id="l6.578" class="difflineminus">-            if (aFiles[i].lpszFileName)</span>
<a href="#l6.579"></a><span id="l6.579" class="difflineminus">-            {</span>
<a href="#l6.580"></a><span id="l6.580" class="difflineminus">-                nsAutoString wholeFileName;</span>
<a href="#l6.581"></a><span id="l6.581" class="difflineminus">-                if (!aIsUTF8)</span>
<a href="#l6.582"></a><span id="l6.582" class="difflineminus">-                    NS_CopyNativeToUnicode(nsDependentCString(aFiles[i].lpszFileName),</span>
<a href="#l6.583"></a><span id="l6.583" class="difflineminus">-                                           wholeFileName);</span>
<a href="#l6.584"></a><span id="l6.584" class="difflineminus">-                else</span>
<a href="#l6.585"></a><span id="l6.585" class="difflineminus">-                    wholeFileName.Append(NS_ConvertUTF8toUTF16(aFiles[i].lpszFileName));</span>
<a href="#l6.586"></a><span id="l6.586" class="difflineminus">-                // need to find the last '\' and find the leafname from that.</span>
<a href="#l6.587"></a><span id="l6.587" class="difflineminus">-                int32_t lastSlash = wholeFileName.RFindChar(char16_t('\\'));</span>
<a href="#l6.588"></a><span id="l6.588" class="difflineminus">-                if (lastSlash != kNotFound)</span>
<a href="#l6.589"></a><span id="l6.589" class="difflineminus">-                  leafName.Assign(Substring(wholeFileName, lastSlash + 1));</span>
<a href="#l6.590"></a><span id="l6.590" class="difflineminus">-                else</span>
<a href="#l6.591"></a><span id="l6.591" class="difflineminus">-                  leafName.Assign(wholeFileName);</span>
<a href="#l6.592"></a><span id="l6.592" class="difflineminus">-            }</span>
<a href="#l6.593"></a><span id="l6.593" class="difflineminus">-            else</span>
<a href="#l6.594"></a><span id="l6.594" class="difflineminus">-              pFile-&gt;GetLeafName (leafName);</span>
<a href="#l6.595"></a><span id="l6.595" class="difflineplus">+      nsAutoString leafName;</span>
<a href="#l6.596"></a><span id="l6.596" class="difflineplus">+      // convert to Unicode using Platform charset</span>
<a href="#l6.597"></a><span id="l6.597" class="difflineplus">+      // leafName already contains a unicode leafName from lpszPathName. If we</span>
<a href="#l6.598"></a><span id="l6.598" class="difflineplus">+      // were given a value for lpszFileName, use it. Otherwise stick with</span>
<a href="#l6.599"></a><span id="l6.599" class="difflineplus">+      // leafName</span>
<a href="#l6.600"></a><span id="l6.600" class="difflineplus">+      if (aFiles[i].lpszFileName) {</span>
<a href="#l6.601"></a><span id="l6.601" class="difflineplus">+        nsAutoString wholeFileName;</span>
<a href="#l6.602"></a><span id="l6.602" class="difflineplus">+        if (!aIsUTF8)</span>
<a href="#l6.603"></a><span id="l6.603" class="difflineplus">+          NS_CopyNativeToUnicode(nsDependentCString(aFiles[i].lpszFileName),</span>
<a href="#l6.604"></a><span id="l6.604" class="difflineplus">+                                 wholeFileName);</span>
<a href="#l6.605"></a><span id="l6.605" class="difflineplus">+        else</span>
<a href="#l6.606"></a><span id="l6.606" class="difflineplus">+          wholeFileName.Append(NS_ConvertUTF8toUTF16(aFiles[i].lpszFileName));</span>
<a href="#l6.607"></a><span id="l6.607" class="difflineplus">+        // need to find the last '\' and find the leafname from that.</span>
<a href="#l6.608"></a><span id="l6.608" class="difflineplus">+        int32_t lastSlash = wholeFileName.RFindChar(char16_t('\\'));</span>
<a href="#l6.609"></a><span id="l6.609" class="difflineplus">+        if (lastSlash != kNotFound)</span>
<a href="#l6.610"></a><span id="l6.610" class="difflineplus">+          leafName.Assign(Substring(wholeFileName, lastSlash + 1));</span>
<a href="#l6.611"></a><span id="l6.611" class="difflineplus">+        else</span>
<a href="#l6.612"></a><span id="l6.612" class="difflineplus">+          leafName.Assign(wholeFileName);</span>
<a href="#l6.613"></a><span id="l6.613" class="difflineplus">+      } else</span>
<a href="#l6.614"></a><span id="l6.614" class="difflineplus">+        pFile-&gt;GetLeafName(leafName);</span>
<a href="#l6.615"></a><span id="l6.615"> </span>
<a href="#l6.616"></a><span id="l6.616" class="difflineminus">-            nsCOMPtr&lt;nsIMsgAttachment&gt; attachment = do_CreateInstance(NS_MSGATTACHMENT_CONTRACTID, &amp;rv);</span>
<a href="#l6.617"></a><span id="l6.617" class="difflineminus">-            NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.618"></a><span id="l6.618" class="difflineminus">-            attachment-&gt;SetName(leafName);</span>
<a href="#l6.619"></a><span id="l6.619" class="difflineplus">+      nsCOMPtr&lt;nsIMsgAttachment&gt; attachment =</span>
<a href="#l6.620"></a><span id="l6.620" class="difflineplus">+          do_CreateInstance(NS_MSGATTACHMENT_CONTRACTID, &amp;rv);</span>
<a href="#l6.621"></a><span id="l6.621" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.622"></a><span id="l6.622" class="difflineplus">+      attachment-&gt;SetName(leafName);</span>
<a href="#l6.623"></a><span id="l6.623"> </span>
<a href="#l6.624"></a><span id="l6.624" class="difflineminus">-            nsCOMPtr&lt;nsIFile&gt; pTempFile;</span>
<a href="#l6.625"></a><span id="l6.625" class="difflineminus">-            rv = pTempDir-&gt;Clone(getter_AddRefs(pTempFile));</span>
<a href="#l6.626"></a><span id="l6.626" class="difflineminus">-            if (NS_FAILED(rv) || !pTempFile)</span>
<a href="#l6.627"></a><span id="l6.627" class="difflineminus">-              return rv;</span>
<a href="#l6.628"></a><span id="l6.628" class="difflineplus">+      nsCOMPtr&lt;nsIFile&gt; pTempFile;</span>
<a href="#l6.629"></a><span id="l6.629" class="difflineplus">+      rv = pTempDir-&gt;Clone(getter_AddRefs(pTempFile));</span>
<a href="#l6.630"></a><span id="l6.630" class="difflineplus">+      if (NS_FAILED(rv) || !pTempFile) return rv;</span>
<a href="#l6.631"></a><span id="l6.631"> </span>
<a href="#l6.632"></a><span id="l6.632" class="difflineminus">-            pTempFile-&gt;Append(leafName);</span>
<a href="#l6.633"></a><span id="l6.633" class="difflineminus">-            pTempFile-&gt;Exists(&amp;bExist);</span>
<a href="#l6.634"></a><span id="l6.634" class="difflineminus">-            if (bExist)</span>
<a href="#l6.635"></a><span id="l6.635" class="difflineminus">-            {</span>
<a href="#l6.636"></a><span id="l6.636" class="difflineminus">-              rv = pTempFile-&gt;CreateUnique(nsIFile::NORMAL_FILE_TYPE, 0777);</span>
<a href="#l6.637"></a><span id="l6.637" class="difflineminus">-              NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.638"></a><span id="l6.638" class="difflineminus">-              pTempFile-&gt;Remove(false); // remove so we can copy over it.</span>
<a href="#l6.639"></a><span id="l6.639" class="difflineminus">-              pTempFile-&gt;GetLeafName(leafName);</span>
<a href="#l6.640"></a><span id="l6.640" class="difflineminus">-            }</span>
<a href="#l6.641"></a><span id="l6.641" class="difflineminus">-            // copy the file to its new location and file name</span>
<a href="#l6.642"></a><span id="l6.642" class="difflineminus">-            pFile-&gt;CopyTo(pTempDir, leafName);</span>
<a href="#l6.643"></a><span id="l6.643" class="difflineminus">-            // point pFile to the new location of the attachment</span>
<a href="#l6.644"></a><span id="l6.644" class="difflineminus">-            pFile-&gt;InitWithFile(pTempDir);</span>
<a href="#l6.645"></a><span id="l6.645" class="difflineminus">-            pFile-&gt;Append(leafName);</span>
<a href="#l6.646"></a><span id="l6.646" class="difflineplus">+      pTempFile-&gt;Append(leafName);</span>
<a href="#l6.647"></a><span id="l6.647" class="difflineplus">+      pTempFile-&gt;Exists(&amp;bExist);</span>
<a href="#l6.648"></a><span id="l6.648" class="difflineplus">+      if (bExist) {</span>
<a href="#l6.649"></a><span id="l6.649" class="difflineplus">+        rv = pTempFile-&gt;CreateUnique(nsIFile::NORMAL_FILE_TYPE, 0777);</span>
<a href="#l6.650"></a><span id="l6.650" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.651"></a><span id="l6.651" class="difflineplus">+        pTempFile-&gt;Remove(false);  // remove so we can copy over it.</span>
<a href="#l6.652"></a><span id="l6.652" class="difflineplus">+        pTempFile-&gt;GetLeafName(leafName);</span>
<a href="#l6.653"></a><span id="l6.653" class="difflineplus">+      }</span>
<a href="#l6.654"></a><span id="l6.654" class="difflineplus">+      // copy the file to its new location and file name</span>
<a href="#l6.655"></a><span id="l6.655" class="difflineplus">+      pFile-&gt;CopyTo(pTempDir, leafName);</span>
<a href="#l6.656"></a><span id="l6.656" class="difflineplus">+      // point pFile to the new location of the attachment</span>
<a href="#l6.657"></a><span id="l6.657" class="difflineplus">+      pFile-&gt;InitWithFile(pTempDir);</span>
<a href="#l6.658"></a><span id="l6.658" class="difflineplus">+      pFile-&gt;Append(leafName);</span>
<a href="#l6.659"></a><span id="l6.659"> </span>
<a href="#l6.660"></a><span id="l6.660" class="difflineminus">-            // create MsgCompose attachment object</span>
<a href="#l6.661"></a><span id="l6.661" class="difflineminus">-            attachment-&gt;SetTemporary(true); // this one is a temp file so set the flag for MsgCompose</span>
<a href="#l6.662"></a><span id="l6.662" class="difflineplus">+      // create MsgCompose attachment object</span>
<a href="#l6.663"></a><span id="l6.663" class="difflineplus">+      attachment-&gt;SetTemporary(</span>
<a href="#l6.664"></a><span id="l6.664" class="difflineplus">+          true);  // this one is a temp file so set the flag for MsgCompose</span>
<a href="#l6.665"></a><span id="l6.665"> </span>
<a href="#l6.666"></a><span id="l6.666" class="difflineminus">-            // now set the attachment object</span>
<a href="#l6.667"></a><span id="l6.667" class="difflineminus">-            nsAutoCString pURL ;</span>
<a href="#l6.668"></a><span id="l6.668" class="difflineminus">-            NS_GetURLSpecFromFile(pFile, pURL);</span>
<a href="#l6.669"></a><span id="l6.669" class="difflineminus">-            attachment-&gt;SetUrl(pURL);</span>
<a href="#l6.670"></a><span id="l6.670" class="difflineplus">+      // now set the attachment object</span>
<a href="#l6.671"></a><span id="l6.671" class="difflineplus">+      nsAutoCString pURL;</span>
<a href="#l6.672"></a><span id="l6.672" class="difflineplus">+      NS_GetURLSpecFromFile(pFile, pURL);</span>
<a href="#l6.673"></a><span id="l6.673" class="difflineplus">+      attachment-&gt;SetUrl(pURL);</span>
<a href="#l6.674"></a><span id="l6.674" class="difflineplus">+</span>
<a href="#l6.675"></a><span id="l6.675" class="difflineplus">+      // set the file size</span>
<a href="#l6.676"></a><span id="l6.676" class="difflineplus">+      int64_t fileSize;</span>
<a href="#l6.677"></a><span id="l6.677" class="difflineplus">+      pFile-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l6.678"></a><span id="l6.678" class="difflineplus">+      attachment-&gt;SetSize(fileSize);</span>
<a href="#l6.679"></a><span id="l6.679"> </span>
<a href="#l6.680"></a><span id="l6.680" class="difflineminus">-            // set the file size</span>
<a href="#l6.681"></a><span id="l6.681" class="difflineminus">-            int64_t fileSize;</span>
<a href="#l6.682"></a><span id="l6.682" class="difflineminus">-            pFile-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l6.683"></a><span id="l6.683" class="difflineminus">-            attachment-&gt;SetSize(fileSize);</span>
<a href="#l6.684"></a><span id="l6.684" class="difflineminus">-</span>
<a href="#l6.685"></a><span id="l6.685" class="difflineminus">-            // add the attachment</span>
<a href="#l6.686"></a><span id="l6.686" class="difflineminus">-            rv = aCompFields-&gt;AddAttachment (attachment);</span>
<a href="#l6.687"></a><span id="l6.687" class="difflineminus">-            if (NS_FAILED(rv))</span>
<a href="#l6.688"></a><span id="l6.688" class="difflineminus">-              MOZ_LOG(MAPI, mozilla::LogLevel::Debug, (&quot;nsMapiHook::HandleAttachments: AddAttachment rv =  %lx\n&quot;, rv));</span>
<a href="#l6.689"></a><span id="l6.689" class="difflineminus">-        }</span>
<a href="#l6.690"></a><span id="l6.690" class="difflineplus">+      // add the attachment</span>
<a href="#l6.691"></a><span id="l6.691" class="difflineplus">+      rv = aCompFields-&gt;AddAttachment(attachment);</span>
<a href="#l6.692"></a><span id="l6.692" class="difflineplus">+      if (NS_FAILED(rv))</span>
<a href="#l6.693"></a><span id="l6.693" class="difflineplus">+        MOZ_LOG(</span>
<a href="#l6.694"></a><span id="l6.694" class="difflineplus">+            MAPI, mozilla::LogLevel::Debug,</span>
<a href="#l6.695"></a><span id="l6.695" class="difflineplus">+            (&quot;nsMapiHook::HandleAttachments: AddAttachment rv =  %lx\n&quot;, rv));</span>
<a href="#l6.696"></a><span id="l6.696">     }</span>
<a href="#l6.697"></a><span id="l6.697" class="difflineminus">-    return rv ;</span>
<a href="#l6.698"></a><span id="l6.698" class="difflineplus">+  }</span>
<a href="#l6.699"></a><span id="l6.699" class="difflineplus">+  return rv;</span>
<a href="#l6.700"></a><span id="l6.700"> }</span>
<a href="#l6.701"></a><span id="l6.701"> </span>
<a href="#l6.702"></a><span id="l6.702" class="difflineminus">-</span>
<a href="#l6.703"></a><span id="l6.703" class="difflineminus">-nsresult nsMapiHook::HandleAttachmentsW(nsIMsgCompFields* aCompFields, int32_t aFileCount,</span>
<a href="#l6.704"></a><span id="l6.704" class="difflineminus">-                                        lpnsMapiFileDescW aFiles)</span>
<a href="#l6.705"></a><span id="l6.705" class="difflineminus">-{</span>
<a href="#l6.706"></a><span id="l6.706" class="difflineminus">-  nsresult rv = NS_OK ;</span>
<a href="#l6.707"></a><span id="l6.707" class="difflineplus">+nsresult nsMapiHook::HandleAttachmentsW(nsIMsgCompFields *aCompFields,</span>
<a href="#l6.708"></a><span id="l6.708" class="difflineplus">+                                        int32_t aFileCount,</span>
<a href="#l6.709"></a><span id="l6.709" class="difflineplus">+                                        lpnsMapiFileDescW aFiles) {</span>
<a href="#l6.710"></a><span id="l6.710" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l6.711"></a><span id="l6.711">   // Do nothing if there are no files to process.</span>
<a href="#l6.712"></a><span id="l6.712" class="difflineminus">-  if (!aFiles || aFileCount &lt;= 0)</span>
<a href="#l6.713"></a><span id="l6.713" class="difflineminus">-      return NS_OK;</span>
<a href="#l6.714"></a><span id="l6.714" class="difflineplus">+  if (!aFiles || aFileCount &lt;= 0) return NS_OK;</span>
<a href="#l6.715"></a><span id="l6.715" class="difflineplus">+</span>
<a href="#l6.716"></a><span id="l6.716" class="difflineplus">+  nsAutoCString Attachments;</span>
<a href="#l6.717"></a><span id="l6.717" class="difflineplus">+  nsAutoCString TempFiles;</span>
<a href="#l6.718"></a><span id="l6.718"> </span>
<a href="#l6.719"></a><span id="l6.719" class="difflineminus">-  nsAutoCString Attachments ;</span>
<a href="#l6.720"></a><span id="l6.720" class="difflineminus">-  nsAutoCString TempFiles ;</span>
<a href="#l6.721"></a><span id="l6.721" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; pFile = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l6.722"></a><span id="l6.722" class="difflineplus">+  if (NS_FAILED(rv) || (!pFile)) return rv;</span>
<a href="#l6.723"></a><span id="l6.723" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; pTempDir = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l6.724"></a><span id="l6.724" class="difflineplus">+  if (NS_FAILED(rv) || (!pTempDir)) return rv;</span>
<a href="#l6.725"></a><span id="l6.725"> </span>
<a href="#l6.726"></a><span id="l6.726" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; pFile = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv) ;</span>
<a href="#l6.727"></a><span id="l6.727" class="difflineminus">-  if (NS_FAILED(rv) || (!pFile)) return rv ;</span>
<a href="#l6.728"></a><span id="l6.728" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; pTempDir = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv) ;</span>
<a href="#l6.729"></a><span id="l6.729" class="difflineminus">-  if (NS_FAILED(rv) || (!pTempDir)) return rv ;</span>
<a href="#l6.730"></a><span id="l6.730" class="difflineminus">-</span>
<a href="#l6.731"></a><span id="l6.731" class="difflineminus">-  for (int i=0 ; i &lt; aFileCount ; i++)</span>
<a href="#l6.732"></a><span id="l6.732" class="difflineminus">-  {</span>
<a href="#l6.733"></a><span id="l6.733" class="difflineminus">-    if (aFiles[i].lpszPathName)</span>
<a href="#l6.734"></a><span id="l6.734" class="difflineminus">-    {</span>
<a href="#l6.735"></a><span id="l6.735" class="difflineplus">+  for (int i = 0; i &lt; aFileCount; i++) {</span>
<a href="#l6.736"></a><span id="l6.736" class="difflineplus">+    if (aFiles[i].lpszPathName) {</span>
<a href="#l6.737"></a><span id="l6.737">       // Check if attachment exists.</span>
<a href="#l6.738"></a><span id="l6.738" class="difflineminus">-      pFile-&gt;InitWithPath (nsDependentString(aFiles[i].lpszPathName));</span>
<a href="#l6.739"></a><span id="l6.739" class="difflineplus">+      pFile-&gt;InitWithPath(nsDependentString(aFiles[i].lpszPathName));</span>
<a href="#l6.740"></a><span id="l6.740"> </span>
<a href="#l6.741"></a><span id="l6.741" class="difflineminus">-      bool bExist ;</span>
<a href="#l6.742"></a><span id="l6.742" class="difflineminus">-      rv = pFile-&gt;Exists(&amp;bExist) ;</span>
<a href="#l6.743"></a><span id="l6.743" class="difflineplus">+      bool bExist;</span>
<a href="#l6.744"></a><span id="l6.744" class="difflineplus">+      rv = pFile-&gt;Exists(&amp;bExist);</span>
<a href="#l6.745"></a><span id="l6.745">       MOZ_LOG(MAPI, mozilla::LogLevel::Debug,</span>
<a href="#l6.746"></a><span id="l6.746" class="difflineminus">-        (&quot;nsMapiHook::HandleAttachmentsW: filename: %s path: %s exists = %s \n&quot;,</span>
<a href="#l6.747"></a><span id="l6.747" class="difflineminus">-         NS_ConvertUTF16toUTF8(aFiles[i].lpszFileName).get(),</span>
<a href="#l6.748"></a><span id="l6.748" class="difflineminus">-         NS_ConvertUTF16toUTF8(aFiles[i].lpszPathName).get(),</span>
<a href="#l6.749"></a><span id="l6.749" class="difflineminus">-         bExist ? &quot;true&quot; : &quot;false&quot;));</span>
<a href="#l6.750"></a><span id="l6.750" class="difflineminus">-      if (NS_FAILED(rv) || (!bExist)) return NS_ERROR_FILE_TARGET_DOES_NOT_EXIST ;</span>
<a href="#l6.751"></a><span id="l6.751" class="difflineplus">+              (&quot;nsMapiHook::HandleAttachmentsW: filename: %s path: %s exists = &quot;</span>
<a href="#l6.752"></a><span id="l6.752" class="difflineplus">+               &quot;%s \n&quot;,</span>
<a href="#l6.753"></a><span id="l6.753" class="difflineplus">+               NS_ConvertUTF16toUTF8(aFiles[i].lpszFileName).get(),</span>
<a href="#l6.754"></a><span id="l6.754" class="difflineplus">+               NS_ConvertUTF16toUTF8(aFiles[i].lpszPathName).get(),</span>
<a href="#l6.755"></a><span id="l6.755" class="difflineplus">+               bExist ? &quot;true&quot; : &quot;false&quot;));</span>
<a href="#l6.756"></a><span id="l6.756" class="difflineplus">+      if (NS_FAILED(rv) || (!bExist))</span>
<a href="#l6.757"></a><span id="l6.757" class="difflineplus">+        return NS_ERROR_FILE_TARGET_DOES_NOT_EXIST;</span>
<a href="#l6.758"></a><span id="l6.758"> </span>
<a href="#l6.759"></a><span id="l6.759">       // Temp Directory.</span>
<a href="#l6.760"></a><span id="l6.760" class="difflineminus">-      nsCOMPtr &lt;nsIFile&gt; pTempDir;</span>
<a href="#l6.761"></a><span id="l6.761" class="difflineplus">+      nsCOMPtr&lt;nsIFile&gt; pTempDir;</span>
<a href="#l6.762"></a><span id="l6.762">       NS_GetSpecialDirectory(NS_OS_TEMP_DIR, getter_AddRefs(pTempDir));</span>
<a href="#l6.763"></a><span id="l6.763"> </span>
<a href="#l6.764"></a><span id="l6.764" class="difflineminus">-      // Create a new sub directory called moz_mapi underneath the temp directory.</span>
<a href="#l6.765"></a><span id="l6.765" class="difflineplus">+      // Create a new sub directory called moz_mapi underneath the temp</span>
<a href="#l6.766"></a><span id="l6.766" class="difflineplus">+      // directory.</span>
<a href="#l6.767"></a><span id="l6.767">       pTempDir-&gt;AppendRelativePath(NS_LITERAL_STRING(&quot;moz_mapi&quot;));</span>
<a href="#l6.768"></a><span id="l6.768" class="difflineminus">-      pTempDir-&gt;Exists(&amp;bExist) ;</span>
<a href="#l6.769"></a><span id="l6.769" class="difflineminus">-      if (!bExist)</span>
<a href="#l6.770"></a><span id="l6.770" class="difflineminus">-      {</span>
<a href="#l6.771"></a><span id="l6.771" class="difflineminus">-        rv = pTempDir-&gt;Create(nsIFile::DIRECTORY_TYPE, 777) ;</span>
<a href="#l6.772"></a><span id="l6.772" class="difflineminus">-        if (NS_FAILED(rv)) return rv ;</span>
<a href="#l6.773"></a><span id="l6.773" class="difflineplus">+      pTempDir-&gt;Exists(&amp;bExist);</span>
<a href="#l6.774"></a><span id="l6.774" class="difflineplus">+      if (!bExist) {</span>
<a href="#l6.775"></a><span id="l6.775" class="difflineplus">+        rv = pTempDir-&gt;Create(nsIFile::DIRECTORY_TYPE, 777);</span>
<a href="#l6.776"></a><span id="l6.776" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.777"></a><span id="l6.777">       }</span>
<a href="#l6.778"></a><span id="l6.778"> </span>
<a href="#l6.779"></a><span id="l6.779">       // Rename or copy the existing temp file with the real file name.</span>
<a href="#l6.780"></a><span id="l6.780"> </span>
<a href="#l6.781"></a><span id="l6.781" class="difflineminus">-      nsAutoString leafName ;</span>
<a href="#l6.782"></a><span id="l6.782" class="difflineminus">-      // leafName already contains a unicode leafName from lpszPathName. If we were given</span>
<a href="#l6.783"></a><span id="l6.783" class="difflineminus">-      // a value for lpszFileName, use it. Otherwise stick with leafName.</span>
<a href="#l6.784"></a><span id="l6.784" class="difflineminus">-      if (aFiles[i].lpszFileName)</span>
<a href="#l6.785"></a><span id="l6.785" class="difflineminus">-      {</span>
<a href="#l6.786"></a><span id="l6.786" class="difflineplus">+      nsAutoString leafName;</span>
<a href="#l6.787"></a><span id="l6.787" class="difflineplus">+      // leafName already contains a unicode leafName from lpszPathName. If we</span>
<a href="#l6.788"></a><span id="l6.788" class="difflineplus">+      // were given a value for lpszFileName, use it. Otherwise stick with</span>
<a href="#l6.789"></a><span id="l6.789" class="difflineplus">+      // leafName.</span>
<a href="#l6.790"></a><span id="l6.790" class="difflineplus">+      if (aFiles[i].lpszFileName) {</span>
<a href="#l6.791"></a><span id="l6.791">         nsAutoString wholeFileName(aFiles[i].lpszFileName);</span>
<a href="#l6.792"></a><span id="l6.792">         // Need to find the last '\' and find the leafname from that.</span>
<a href="#l6.793"></a><span id="l6.793">         int32_t lastSlash = wholeFileName.RFindChar(char16_t('\\'));</span>
<a href="#l6.794"></a><span id="l6.794">         if (lastSlash != kNotFound)</span>
<a href="#l6.795"></a><span id="l6.795">           leafName.Assign(Substring(wholeFileName, lastSlash + 1));</span>
<a href="#l6.796"></a><span id="l6.796">         else</span>
<a href="#l6.797"></a><span id="l6.797">           leafName.Assign(wholeFileName);</span>
<a href="#l6.798"></a><span id="l6.798" class="difflineminus">-      }</span>
<a href="#l6.799"></a><span id="l6.799" class="difflineminus">-      else</span>
<a href="#l6.800"></a><span id="l6.800" class="difflineplus">+      } else</span>
<a href="#l6.801"></a><span id="l6.801">         pFile-&gt;GetLeafName(leafName);</span>
<a href="#l6.802"></a><span id="l6.802"> </span>
<a href="#l6.803"></a><span id="l6.803" class="difflineminus">-      nsCOMPtr&lt;nsIMsgAttachment&gt; attachment = do_CreateInstance(NS_MSGATTACHMENT_CONTRACTID, &amp;rv);</span>
<a href="#l6.804"></a><span id="l6.804" class="difflineplus">+      nsCOMPtr&lt;nsIMsgAttachment&gt; attachment =</span>
<a href="#l6.805"></a><span id="l6.805" class="difflineplus">+          do_CreateInstance(NS_MSGATTACHMENT_CONTRACTID, &amp;rv);</span>
<a href="#l6.806"></a><span id="l6.806">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.807"></a><span id="l6.807">       attachment-&gt;SetName(leafName);</span>
<a href="#l6.808"></a><span id="l6.808"> </span>
<a href="#l6.809"></a><span id="l6.809">       nsCOMPtr&lt;nsIFile&gt; pTempFile;</span>
<a href="#l6.810"></a><span id="l6.810">       rv = pTempDir-&gt;Clone(getter_AddRefs(pTempFile));</span>
<a href="#l6.811"></a><span id="l6.811" class="difflineminus">-      if (NS_FAILED(rv) || !pTempFile)</span>
<a href="#l6.812"></a><span id="l6.812" class="difflineminus">-        return rv;</span>
<a href="#l6.813"></a><span id="l6.813" class="difflineplus">+      if (NS_FAILED(rv) || !pTempFile) return rv;</span>
<a href="#l6.814"></a><span id="l6.814"> </span>
<a href="#l6.815"></a><span id="l6.815">       pTempFile-&gt;Append(leafName);</span>
<a href="#l6.816"></a><span id="l6.816">       pTempFile-&gt;Exists(&amp;bExist);</span>
<a href="#l6.817"></a><span id="l6.817" class="difflineminus">-      if (bExist)</span>
<a href="#l6.818"></a><span id="l6.818" class="difflineminus">-      {</span>
<a href="#l6.819"></a><span id="l6.819" class="difflineplus">+      if (bExist) {</span>
<a href="#l6.820"></a><span id="l6.820">         rv = pTempFile-&gt;CreateUnique(nsIFile::NORMAL_FILE_TYPE, 0777);</span>
<a href="#l6.821"></a><span id="l6.821">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.822"></a><span id="l6.822" class="difflineminus">-        pTempFile-&gt;Remove(false); // remove so we can copy over it.</span>
<a href="#l6.823"></a><span id="l6.823" class="difflineplus">+        pTempFile-&gt;Remove(false);  // remove so we can copy over it.</span>
<a href="#l6.824"></a><span id="l6.824">         pTempFile-&gt;GetLeafName(leafName);</span>
<a href="#l6.825"></a><span id="l6.825">       }</span>
<a href="#l6.826"></a><span id="l6.826">       // Copy the file to its new location and file name.</span>
<a href="#l6.827"></a><span id="l6.827">       pFile-&gt;CopyTo(pTempDir, leafName);</span>
<a href="#l6.828"></a><span id="l6.828">       // Point pFile to the new location of the attachment.</span>
<a href="#l6.829"></a><span id="l6.829">       pFile-&gt;InitWithFile(pTempDir);</span>
<a href="#l6.830"></a><span id="l6.830">       pFile-&gt;Append(leafName);</span>
<a href="#l6.831"></a><span id="l6.831"> </span>
<a href="#l6.832"></a><span id="l6.832">       // Create MsgCompose attachment object.</span>
<a href="#l6.833"></a><span id="l6.833" class="difflineminus">-      attachment-&gt;SetTemporary(true);  // this one is a temp file so set the flag for MsgCompose</span>
<a href="#l6.834"></a><span id="l6.834" class="difflineplus">+      attachment-&gt;SetTemporary(</span>
<a href="#l6.835"></a><span id="l6.835" class="difflineplus">+          true);  // this one is a temp file so set the flag for MsgCompose</span>
<a href="#l6.836"></a><span id="l6.836"> </span>
<a href="#l6.837"></a><span id="l6.837">       // Now set the attachment object.</span>
<a href="#l6.838"></a><span id="l6.838" class="difflineminus">-      nsAutoCString pURL ;</span>
<a href="#l6.839"></a><span id="l6.839" class="difflineplus">+      nsAutoCString pURL;</span>
<a href="#l6.840"></a><span id="l6.840">       NS_GetURLSpecFromFile(pFile, pURL);</span>
<a href="#l6.841"></a><span id="l6.841">       attachment-&gt;SetUrl(pURL);</span>
<a href="#l6.842"></a><span id="l6.842"> </span>
<a href="#l6.843"></a><span id="l6.843">       // Set the file size.</span>
<a href="#l6.844"></a><span id="l6.844">       int64_t fileSize;</span>
<a href="#l6.845"></a><span id="l6.845">       pFile-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l6.846"></a><span id="l6.846">       attachment-&gt;SetSize(fileSize);</span>
<a href="#l6.847"></a><span id="l6.847"> </span>
<a href="#l6.848"></a><span id="l6.848">       // Add the attachment.</span>
<a href="#l6.849"></a><span id="l6.849" class="difflineminus">-      rv = aCompFields-&gt;AddAttachment (attachment);</span>
<a href="#l6.850"></a><span id="l6.850" class="difflineplus">+      rv = aCompFields-&gt;AddAttachment(attachment);</span>
<a href="#l6.851"></a><span id="l6.851">       if (NS_FAILED(rv))</span>
<a href="#l6.852"></a><span id="l6.852" class="difflineminus">-        MOZ_LOG(MAPI, mozilla::LogLevel::Debug,</span>
<a href="#l6.853"></a><span id="l6.853" class="difflineminus">-          (&quot;nsMapiHook::HandleAttachmentsW: AddAttachment rv =  %lx\n&quot;, rv));</span>
<a href="#l6.854"></a><span id="l6.854" class="difflineplus">+        MOZ_LOG(</span>
<a href="#l6.855"></a><span id="l6.855" class="difflineplus">+            MAPI, mozilla::LogLevel::Debug,</span>
<a href="#l6.856"></a><span id="l6.856" class="difflineplus">+            (&quot;nsMapiHook::HandleAttachmentsW: AddAttachment rv =  %lx\n&quot;, rv));</span>
<a href="#l6.857"></a><span id="l6.857">     }</span>
<a href="#l6.858"></a><span id="l6.858">   }</span>
<a href="#l6.859"></a><span id="l6.859" class="difflineminus">-  return rv ;</span>
<a href="#l6.860"></a><span id="l6.860" class="difflineplus">+  return rv;</span>
<a href="#l6.861"></a><span id="l6.861"> }</span>
<a href="#l6.862"></a><span id="l6.862"> </span>
<a href="#l6.863"></a><span id="l6.863"> // this is used to convert non Unicode data and then populate comp fields</span>
<a href="#l6.864"></a><span id="l6.864" class="difflineminus">-nsresult nsMapiHook::PopulateCompFieldsWithConversion(lpnsMapiMessage aMessage,</span>
<a href="#l6.865"></a><span id="l6.865" class="difflineminus">-                                    nsIMsgCompFields * aCompFields)</span>
<a href="#l6.866"></a><span id="l6.866" class="difflineminus">-{</span>
<a href="#l6.867"></a><span id="l6.867" class="difflineplus">+nsresult nsMapiHook::PopulateCompFieldsWithConversion(</span>
<a href="#l6.868"></a><span id="l6.868" class="difflineplus">+    lpnsMapiMessage aMessage, nsIMsgCompFields *aCompFields) {</span>
<a href="#l6.869"></a><span id="l6.869">   bool isUTF8 = aMessage-&gt;ulReserved == CP_UTF8;</span>
<a href="#l6.870"></a><span id="l6.870"> </span>
<a href="#l6.871"></a><span id="l6.871" class="difflineminus">-  if (aMessage-&gt;lpOriginator &amp;&amp; aMessage-&gt;lpOriginator-&gt;lpszAddress)</span>
<a href="#l6.872"></a><span id="l6.872" class="difflineminus">-  {</span>
<a href="#l6.873"></a><span id="l6.873" class="difflineplus">+  if (aMessage-&gt;lpOriginator &amp;&amp; aMessage-&gt;lpOriginator-&gt;lpszAddress) {</span>
<a href="#l6.874"></a><span id="l6.874">     nsAutoString From;</span>
<a href="#l6.875"></a><span id="l6.875">     if (!isUTF8)</span>
<a href="#l6.876"></a><span id="l6.876" class="difflineminus">-        From.Append(NS_ConvertASCIItoUTF16(aMessage-&gt;lpOriginator-&gt;lpszAddress));</span>
<a href="#l6.877"></a><span id="l6.877" class="difflineplus">+      From.Append(NS_ConvertASCIItoUTF16(aMessage-&gt;lpOriginator-&gt;lpszAddress));</span>
<a href="#l6.878"></a><span id="l6.878">     else</span>
<a href="#l6.879"></a><span id="l6.879" class="difflineminus">-        From.Append(NS_ConvertUTF8toUTF16(aMessage-&gt;lpOriginator-&gt;lpszAddress));</span>
<a href="#l6.880"></a><span id="l6.880" class="difflineminus">-    aCompFields-&gt;SetFrom (From);</span>
<a href="#l6.881"></a><span id="l6.881" class="difflineplus">+      From.Append(NS_ConvertUTF8toUTF16(aMessage-&gt;lpOriginator-&gt;lpszAddress));</span>
<a href="#l6.882"></a><span id="l6.882" class="difflineplus">+    aCompFields-&gt;SetFrom(From);</span>
<a href="#l6.883"></a><span id="l6.883">   }</span>
<a href="#l6.884"></a><span id="l6.884"> </span>
<a href="#l6.885"></a><span id="l6.885">   nsAutoString To;</span>
<a href="#l6.886"></a><span id="l6.886">   nsAutoString Cc;</span>
<a href="#l6.887"></a><span id="l6.887">   nsAutoString Bcc;</span>
<a href="#l6.888"></a><span id="l6.888">   NS_NAMED_LITERAL_STRING(Comma, &quot;,&quot;);</span>
<a href="#l6.889"></a><span id="l6.889" class="difflineminus">-  if (aMessage-&gt;lpRecips)</span>
<a href="#l6.890"></a><span id="l6.890" class="difflineminus">-  {</span>
<a href="#l6.891"></a><span id="l6.891" class="difflineminus">-    for (int i=0 ; i &lt; (int) aMessage-&gt;nRecipCount ; i++)</span>
<a href="#l6.892"></a><span id="l6.892" class="difflineminus">-    {</span>
<a href="#l6.893"></a><span id="l6.893" class="difflineminus">-      if (aMessage-&gt;lpRecips[i].lpszAddress || aMessage-&gt;lpRecips[i].lpszName)</span>
<a href="#l6.894"></a><span id="l6.894" class="difflineminus">-      {</span>
<a href="#l6.895"></a><span id="l6.895" class="difflineplus">+  if (aMessage-&gt;lpRecips) {</span>
<a href="#l6.896"></a><span id="l6.896" class="difflineplus">+    for (int i = 0; i &lt; (int)aMessage-&gt;nRecipCount; i++) {</span>
<a href="#l6.897"></a><span id="l6.897" class="difflineplus">+      if (aMessage-&gt;lpRecips[i].lpszAddress || aMessage-&gt;lpRecips[i].lpszName) {</span>
<a href="#l6.898"></a><span id="l6.898">         const char *addressWithoutType = (aMessage-&gt;lpRecips[i].lpszAddress)</span>
<a href="#l6.899"></a><span id="l6.899" class="difflineminus">-          ? aMessage-&gt;lpRecips[i].lpszAddress : aMessage-&gt;lpRecips[i].lpszName;</span>
<a href="#l6.900"></a><span id="l6.900" class="difflineplus">+                                             ? aMessage-&gt;lpRecips[i].lpszAddress</span>
<a href="#l6.901"></a><span id="l6.901" class="difflineplus">+                                             : aMessage-&gt;lpRecips[i].lpszName;</span>
<a href="#l6.902"></a><span id="l6.902">         if (!PL_strncasecmp(addressWithoutType, &quot;SMTP:&quot;, 5))</span>
<a href="#l6.903"></a><span id="l6.903">           addressWithoutType += 5;</span>
<a href="#l6.904"></a><span id="l6.904"> </span>
<a href="#l6.905"></a><span id="l6.905" class="difflineminus">-        switch (aMessage-&gt;lpRecips[i].ulRecipClass)</span>
<a href="#l6.906"></a><span id="l6.906" class="difflineminus">-        {</span>
<a href="#l6.907"></a><span id="l6.907" class="difflineminus">-        case MAPI_TO :</span>
<a href="#l6.908"></a><span id="l6.908" class="difflineminus">-          if (!To.IsEmpty())</span>
<a href="#l6.909"></a><span id="l6.909" class="difflineminus">-            To += Comma ;</span>
<a href="#l6.910"></a><span id="l6.910" class="difflineminus">-          if (!isUTF8)</span>
<a href="#l6.911"></a><span id="l6.911" class="difflineplus">+        switch (aMessage-&gt;lpRecips[i].ulRecipClass) {</span>
<a href="#l6.912"></a><span id="l6.912" class="difflineplus">+          case MAPI_TO:</span>
<a href="#l6.913"></a><span id="l6.913" class="difflineplus">+            if (!To.IsEmpty()) To += Comma;</span>
<a href="#l6.914"></a><span id="l6.914" class="difflineplus">+            if (!isUTF8)</span>
<a href="#l6.915"></a><span id="l6.915">               To.Append(NS_ConvertASCIItoUTF16(addressWithoutType));</span>
<a href="#l6.916"></a><span id="l6.916" class="difflineminus">-          else</span>
<a href="#l6.917"></a><span id="l6.917" class="difflineplus">+            else</span>
<a href="#l6.918"></a><span id="l6.918">               To.Append(NS_ConvertUTF8toUTF16(addressWithoutType));</span>
<a href="#l6.919"></a><span id="l6.919" class="difflineminus">-          break ;</span>
<a href="#l6.920"></a><span id="l6.920" class="difflineplus">+            break;</span>
<a href="#l6.921"></a><span id="l6.921"> </span>
<a href="#l6.922"></a><span id="l6.922" class="difflineminus">-        case MAPI_CC :</span>
<a href="#l6.923"></a><span id="l6.923" class="difflineminus">-          if (!Cc.IsEmpty())</span>
<a href="#l6.924"></a><span id="l6.924" class="difflineminus">-            Cc += Comma ;</span>
<a href="#l6.925"></a><span id="l6.925" class="difflineminus">-          if (!isUTF8)</span>
<a href="#l6.926"></a><span id="l6.926" class="difflineplus">+          case MAPI_CC:</span>
<a href="#l6.927"></a><span id="l6.927" class="difflineplus">+            if (!Cc.IsEmpty()) Cc += Comma;</span>
<a href="#l6.928"></a><span id="l6.928" class="difflineplus">+            if (!isUTF8)</span>
<a href="#l6.929"></a><span id="l6.929">               Cc.Append(NS_ConvertASCIItoUTF16(addressWithoutType));</span>
<a href="#l6.930"></a><span id="l6.930" class="difflineminus">-          else</span>
<a href="#l6.931"></a><span id="l6.931" class="difflineplus">+            else</span>
<a href="#l6.932"></a><span id="l6.932">               Cc.Append(NS_ConvertUTF8toUTF16(addressWithoutType));</span>
<a href="#l6.933"></a><span id="l6.933" class="difflineminus">-          break ;</span>
<a href="#l6.934"></a><span id="l6.934" class="difflineplus">+            break;</span>
<a href="#l6.935"></a><span id="l6.935"> </span>
<a href="#l6.936"></a><span id="l6.936" class="difflineminus">-        case MAPI_BCC :</span>
<a href="#l6.937"></a><span id="l6.937" class="difflineminus">-          if (!Bcc.IsEmpty())</span>
<a href="#l6.938"></a><span id="l6.938" class="difflineminus">-              Bcc += Comma ;</span>
<a href="#l6.939"></a><span id="l6.939" class="difflineminus">-          if (!isUTF8)</span>
<a href="#l6.940"></a><span id="l6.940" class="difflineplus">+          case MAPI_BCC:</span>
<a href="#l6.941"></a><span id="l6.941" class="difflineplus">+            if (!Bcc.IsEmpty()) Bcc += Comma;</span>
<a href="#l6.942"></a><span id="l6.942" class="difflineplus">+            if (!isUTF8)</span>
<a href="#l6.943"></a><span id="l6.943">               Bcc.Append(NS_ConvertASCIItoUTF16(addressWithoutType));</span>
<a href="#l6.944"></a><span id="l6.944" class="difflineminus">-          else</span>
<a href="#l6.945"></a><span id="l6.945" class="difflineplus">+            else</span>
<a href="#l6.946"></a><span id="l6.946">               Bcc.Append(NS_ConvertUTF8toUTF16(addressWithoutType));</span>
<a href="#l6.947"></a><span id="l6.947" class="difflineminus">-          break ;</span>
<a href="#l6.948"></a><span id="l6.948" class="difflineplus">+            break;</span>
<a href="#l6.949"></a><span id="l6.949">         }</span>
<a href="#l6.950"></a><span id="l6.950">       }</span>
<a href="#l6.951"></a><span id="l6.951">     }</span>
<a href="#l6.952"></a><span id="l6.952">   }</span>
<a href="#l6.953"></a><span id="l6.953"> </span>
<a href="#l6.954"></a><span id="l6.954">   // set To, Cc, Bcc</span>
<a href="#l6.955"></a><span id="l6.955" class="difflineminus">-  aCompFields-&gt;SetTo (To) ;</span>
<a href="#l6.956"></a><span id="l6.956" class="difflineminus">-  aCompFields-&gt;SetCc (Cc) ;</span>
<a href="#l6.957"></a><span id="l6.957" class="difflineminus">-  aCompFields-&gt;SetBcc (Bcc) ;</span>
<a href="#l6.958"></a><span id="l6.958" class="difflineplus">+  aCompFields-&gt;SetTo(To);</span>
<a href="#l6.959"></a><span id="l6.959" class="difflineplus">+  aCompFields-&gt;SetCc(Cc);</span>
<a href="#l6.960"></a><span id="l6.960" class="difflineplus">+  aCompFields-&gt;SetBcc(Bcc);</span>
<a href="#l6.961"></a><span id="l6.961"> </span>
<a href="#l6.962"></a><span id="l6.962" class="difflineminus">-  MOZ_LOG(MAPI, mozilla::LogLevel::Debug, (&quot;to: %s cc: %s bcc: %s \n&quot;, NS_ConvertUTF16toUTF8(To).get(), NS_ConvertUTF16toUTF8(Cc).get(), NS_ConvertUTF16toUTF8(Bcc).get()));</span>
<a href="#l6.963"></a><span id="l6.963" class="difflineplus">+  MOZ_LOG(MAPI, mozilla::LogLevel::Debug,</span>
<a href="#l6.964"></a><span id="l6.964" class="difflineplus">+          (&quot;to: %s cc: %s bcc: %s \n&quot;, NS_ConvertUTF16toUTF8(To).get(),</span>
<a href="#l6.965"></a><span id="l6.965" class="difflineplus">+           NS_ConvertUTF16toUTF8(Cc).get(), NS_ConvertUTF16toUTF8(Bcc).get()));</span>
<a href="#l6.966"></a><span id="l6.966"> </span>
<a href="#l6.967"></a><span id="l6.967">   // set subject</span>
<a href="#l6.968"></a><span id="l6.968">   nsresult rv = NS_OK;</span>
<a href="#l6.969"></a><span id="l6.969" class="difflineminus">-  if (aMessage-&gt;lpszSubject)</span>
<a href="#l6.970"></a><span id="l6.970" class="difflineminus">-  {</span>
<a href="#l6.971"></a><span id="l6.971" class="difflineminus">-    nsAutoString Subject ;</span>
<a href="#l6.972"></a><span id="l6.972" class="difflineplus">+  if (aMessage-&gt;lpszSubject) {</span>
<a href="#l6.973"></a><span id="l6.973" class="difflineplus">+    nsAutoString Subject;</span>
<a href="#l6.974"></a><span id="l6.974">     if (!isUTF8)</span>
<a href="#l6.975"></a><span id="l6.975" class="difflineminus">-        rv = NS_CopyNativeToUnicode(nsDependentCString(aMessage-&gt;lpszSubject),</span>
<a href="#l6.976"></a><span id="l6.976" class="difflineminus">-                                    Subject);</span>
<a href="#l6.977"></a><span id="l6.977" class="difflineplus">+      rv = NS_CopyNativeToUnicode(nsDependentCString(aMessage-&gt;lpszSubject),</span>
<a href="#l6.978"></a><span id="l6.978" class="difflineplus">+                                  Subject);</span>
<a href="#l6.979"></a><span id="l6.979">     else</span>
<a href="#l6.980"></a><span id="l6.980" class="difflineminus">-        Subject.Append(NS_ConvertUTF8toUTF16(aMessage-&gt;lpszSubject));</span>
<a href="#l6.981"></a><span id="l6.981" class="difflineplus">+      Subject.Append(NS_ConvertUTF8toUTF16(aMessage-&gt;lpszSubject));</span>
<a href="#l6.982"></a><span id="l6.982">     if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.983"></a><span id="l6.983">     aCompFields-&gt;SetSubject(Subject);</span>
<a href="#l6.984"></a><span id="l6.984">   }</span>
<a href="#l6.985"></a><span id="l6.985"> </span>
<a href="#l6.986"></a><span id="l6.986">   // handle attachments as File URL</span>
<a href="#l6.987"></a><span id="l6.987" class="difflineminus">-  rv = HandleAttachments(aCompFields, aMessage-&gt;nFileCount, aMessage-&gt;lpFiles, isUTF8);</span>
<a href="#l6.988"></a><span id="l6.988" class="difflineminus">-  if (NS_FAILED(rv)) return rv ;</span>
<a href="#l6.989"></a><span id="l6.989" class="difflineplus">+  rv = HandleAttachments(aCompFields, aMessage-&gt;nFileCount, aMessage-&gt;lpFiles,</span>
<a href="#l6.990"></a><span id="l6.990" class="difflineplus">+                         isUTF8);</span>
<a href="#l6.991"></a><span id="l6.991" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.992"></a><span id="l6.992"> </span>
<a href="#l6.993"></a><span id="l6.993">   // set body</span>
<a href="#l6.994"></a><span id="l6.994" class="difflineminus">-  if (aMessage-&gt;lpszNoteText)</span>
<a href="#l6.995"></a><span id="l6.995" class="difflineminus">-  {</span>
<a href="#l6.996"></a><span id="l6.996" class="difflineminus">-    nsAutoString Body ;</span>
<a href="#l6.997"></a><span id="l6.997" class="difflineplus">+  if (aMessage-&gt;lpszNoteText) {</span>
<a href="#l6.998"></a><span id="l6.998" class="difflineplus">+    nsAutoString Body;</span>
<a href="#l6.999"></a><span id="l6.999">     if (!isUTF8)</span>
<a href="#l6.1000"></a><span id="l6.1000" class="difflineminus">-        rv = NS_CopyNativeToUnicode(nsDependentCString(aMessage-&gt;lpszNoteText),</span>
<a href="#l6.1001"></a><span id="l6.1001" class="difflineminus">-                                    Body);</span>
<a href="#l6.1002"></a><span id="l6.1002" class="difflineplus">+      rv = NS_CopyNativeToUnicode(nsDependentCString(aMessage-&gt;lpszNoteText),</span>
<a href="#l6.1003"></a><span id="l6.1003" class="difflineplus">+                                  Body);</span>
<a href="#l6.1004"></a><span id="l6.1004">     else</span>
<a href="#l6.1005"></a><span id="l6.1005" class="difflineminus">-        Body.Append(NS_ConvertUTF8toUTF16(aMessage-&gt;lpszNoteText));</span>
<a href="#l6.1006"></a><span id="l6.1006" class="difflineminus">-    if (NS_FAILED(rv)) return rv ;</span>
<a href="#l6.1007"></a><span id="l6.1007" class="difflineminus">-    if (Body.IsEmpty() || Body.Last() != '\n')</span>
<a href="#l6.1008"></a><span id="l6.1008" class="difflineminus">-      Body.AppendLiteral(CRLF);</span>
<a href="#l6.1009"></a><span id="l6.1009" class="difflineplus">+      Body.Append(NS_ConvertUTF8toUTF16(aMessage-&gt;lpszNoteText));</span>
<a href="#l6.1010"></a><span id="l6.1010" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.1011"></a><span id="l6.1011" class="difflineplus">+    if (Body.IsEmpty() || Body.Last() != '\n') Body.AppendLiteral(CRLF);</span>
<a href="#l6.1012"></a><span id="l6.1012"> </span>
<a href="#l6.1013"></a><span id="l6.1013">     // This is needed when Simple MAPI is used without a compose window.</span>
<a href="#l6.1014"></a><span id="l6.1014">     // See bug 1366196.</span>
<a href="#l6.1015"></a><span id="l6.1015" class="difflineminus">-    if (Body.Find(&quot;&lt;html&gt;&quot;) == kNotFound)</span>
<a href="#l6.1016"></a><span id="l6.1016" class="difflineminus">-      aCompFields-&gt;SetForcePlainText(true);</span>
<a href="#l6.1017"></a><span id="l6.1017" class="difflineplus">+    if (Body.Find(&quot;&lt;html&gt;&quot;) == kNotFound) aCompFields-&gt;SetForcePlainText(true);</span>
<a href="#l6.1018"></a><span id="l6.1018"> </span>
<a href="#l6.1019"></a><span id="l6.1019" class="difflineminus">-    rv = aCompFields-&gt;SetBody(Body) ;</span>
<a href="#l6.1020"></a><span id="l6.1020" class="difflineplus">+    rv = aCompFields-&gt;SetBody(Body);</span>
<a href="#l6.1021"></a><span id="l6.1021">   }</span>
<a href="#l6.1022"></a><span id="l6.1022"> </span>
<a href="#l6.1023"></a><span id="l6.1023"> #ifdef RAJIV_DEBUG</span>
<a href="#l6.1024"></a><span id="l6.1024">   // testing what all was set in CompFields</span>
<a href="#l6.1025"></a><span id="l6.1025" class="difflineminus">-  printf (&quot;To : %S \n&quot;, To.get()) ;</span>
<a href="#l6.1026"></a><span id="l6.1026" class="difflineminus">-  printf (&quot;CC : %S \n&quot;, Cc.get() ) ;</span>
<a href="#l6.1027"></a><span id="l6.1027" class="difflineminus">-  printf (&quot;BCC : %S \n&quot;, Bcc.get() ) ;</span>
<a href="#l6.1028"></a><span id="l6.1028" class="difflineplus">+  printf(&quot;To : %S \n&quot;, To.get());</span>
<a href="#l6.1029"></a><span id="l6.1029" class="difflineplus">+  printf(&quot;CC : %S \n&quot;, Cc.get());</span>
<a href="#l6.1030"></a><span id="l6.1030" class="difflineplus">+  printf(&quot;BCC : %S \n&quot;, Bcc.get());</span>
<a href="#l6.1031"></a><span id="l6.1031"> #endif</span>
<a href="#l6.1032"></a><span id="l6.1032"> </span>
<a href="#l6.1033"></a><span id="l6.1033" class="difflineminus">-  return rv ;</span>
<a href="#l6.1034"></a><span id="l6.1034" class="difflineplus">+  return rv;</span>
<a href="#l6.1035"></a><span id="l6.1035"> }</span>
<a href="#l6.1036"></a><span id="l6.1036"> </span>
<a href="#l6.1037"></a><span id="l6.1037" class="difflineminus">-// This is used to populate comp fields with UTF-16 data from MAPISendMailW function.</span>
<a href="#l6.1038"></a><span id="l6.1038" class="difflineplus">+// This is used to populate comp fields with UTF-16 data from MAPISendMailW</span>
<a href="#l6.1039"></a><span id="l6.1039" class="difflineplus">+// function.</span>
<a href="#l6.1040"></a><span id="l6.1040"> nsresult nsMapiHook::PopulateCompFieldsW(lpnsMapiMessageW aMessage,</span>
<a href="#l6.1041"></a><span id="l6.1041" class="difflineminus">-                                         nsIMsgCompFields* aCompFields)</span>
<a href="#l6.1042"></a><span id="l6.1042" class="difflineminus">-{</span>
<a href="#l6.1043"></a><span id="l6.1043" class="difflineplus">+                                         nsIMsgCompFields *aCompFields) {</span>
<a href="#l6.1044"></a><span id="l6.1044">   if (aMessage-&gt;lpOriginator &amp;&amp; aMessage-&gt;lpOriginator-&gt;lpszAddress)</span>
<a href="#l6.1045"></a><span id="l6.1045" class="difflineminus">-    aCompFields-&gt;SetFrom(nsDependentString(aMessage-&gt;lpOriginator-&gt;lpszAddress));</span>
<a href="#l6.1046"></a><span id="l6.1046" class="difflineplus">+    aCompFields-&gt;SetFrom(</span>
<a href="#l6.1047"></a><span id="l6.1047" class="difflineplus">+        nsDependentString(aMessage-&gt;lpOriginator-&gt;lpszAddress));</span>
<a href="#l6.1048"></a><span id="l6.1048"> </span>
<a href="#l6.1049"></a><span id="l6.1049">   nsAutoString To;</span>
<a href="#l6.1050"></a><span id="l6.1050">   nsAutoString Cc;</span>
<a href="#l6.1051"></a><span id="l6.1051">   nsAutoString Bcc;</span>
<a href="#l6.1052"></a><span id="l6.1052"> </span>
<a href="#l6.1053"></a><span id="l6.1053">   NS_NAMED_LITERAL_STRING(Comma, &quot;,&quot;);</span>
<a href="#l6.1054"></a><span id="l6.1054"> </span>
<a href="#l6.1055"></a><span id="l6.1055" class="difflineminus">-  if (aMessage-&gt;lpRecips)</span>
<a href="#l6.1056"></a><span id="l6.1056" class="difflineminus">-  {</span>
<a href="#l6.1057"></a><span id="l6.1057" class="difflineminus">-    for (int i=0 ; i &lt; (int)aMessage-&gt;nRecipCount ; i++)</span>
<a href="#l6.1058"></a><span id="l6.1058" class="difflineminus">-    {</span>
<a href="#l6.1059"></a><span id="l6.1059" class="difflineminus">-      if (aMessage-&gt;lpRecips[i].lpszAddress || aMessage-&gt;lpRecips[i].lpszName)</span>
<a href="#l6.1060"></a><span id="l6.1060" class="difflineminus">-      {</span>
<a href="#l6.1061"></a><span id="l6.1061" class="difflineminus">-        const wchar_t *addressWithoutType = (aMessage-&gt;lpRecips[i].lpszAddress)</span>
<a href="#l6.1062"></a><span id="l6.1062" class="difflineminus">-          ? aMessage-&gt;lpRecips[i].lpszAddress : aMessage-&gt;lpRecips[i].lpszName;</span>
<a href="#l6.1063"></a><span id="l6.1063" class="difflineplus">+  if (aMessage-&gt;lpRecips) {</span>
<a href="#l6.1064"></a><span id="l6.1064" class="difflineplus">+    for (int i = 0; i &lt; (int)aMessage-&gt;nRecipCount; i++) {</span>
<a href="#l6.1065"></a><span id="l6.1065" class="difflineplus">+      if (aMessage-&gt;lpRecips[i].lpszAddress || aMessage-&gt;lpRecips[i].lpszName) {</span>
<a href="#l6.1066"></a><span id="l6.1066" class="difflineplus">+        const wchar_t *addressWithoutType =</span>
<a href="#l6.1067"></a><span id="l6.1067" class="difflineplus">+            (aMessage-&gt;lpRecips[i].lpszAddress)</span>
<a href="#l6.1068"></a><span id="l6.1068" class="difflineplus">+                ? aMessage-&gt;lpRecips[i].lpszAddress</span>
<a href="#l6.1069"></a><span id="l6.1069" class="difflineplus">+                : aMessage-&gt;lpRecips[i].lpszName;</span>
<a href="#l6.1070"></a><span id="l6.1070">         if (nsDependentString(addressWithoutType, 5).EqualsASCII(&quot;SMTP:&quot;) == 0)</span>
<a href="#l6.1071"></a><span id="l6.1071">           addressWithoutType += 5;</span>
<a href="#l6.1072"></a><span id="l6.1072" class="difflineminus">-        switch (aMessage-&gt;lpRecips[i].ulRecipClass)</span>
<a href="#l6.1073"></a><span id="l6.1073" class="difflineminus">-        {</span>
<a href="#l6.1074"></a><span id="l6.1074" class="difflineminus">-        case MAPI_TO :</span>
<a href="#l6.1075"></a><span id="l6.1075" class="difflineminus">-          if (!To.IsEmpty())</span>
<a href="#l6.1076"></a><span id="l6.1076" class="difflineminus">-            To += Comma;</span>
<a href="#l6.1077"></a><span id="l6.1077" class="difflineminus">-          To.Append(nsDependentString(addressWithoutType));</span>
<a href="#l6.1078"></a><span id="l6.1078" class="difflineminus">-          break;</span>
<a href="#l6.1079"></a><span id="l6.1079" class="difflineplus">+        switch (aMessage-&gt;lpRecips[i].ulRecipClass) {</span>
<a href="#l6.1080"></a><span id="l6.1080" class="difflineplus">+          case MAPI_TO:</span>
<a href="#l6.1081"></a><span id="l6.1081" class="difflineplus">+            if (!To.IsEmpty()) To += Comma;</span>
<a href="#l6.1082"></a><span id="l6.1082" class="difflineplus">+            To.Append(nsDependentString(addressWithoutType));</span>
<a href="#l6.1083"></a><span id="l6.1083" class="difflineplus">+            break;</span>
<a href="#l6.1084"></a><span id="l6.1084"> </span>
<a href="#l6.1085"></a><span id="l6.1085" class="difflineminus">-        case MAPI_CC :</span>
<a href="#l6.1086"></a><span id="l6.1086" class="difflineminus">-          if (!Cc.IsEmpty())</span>
<a href="#l6.1087"></a><span id="l6.1087" class="difflineminus">-            Cc += Comma;</span>
<a href="#l6.1088"></a><span id="l6.1088" class="difflineminus">-          Cc.Append(nsDependentString(addressWithoutType));</span>
<a href="#l6.1089"></a><span id="l6.1089" class="difflineminus">-          break;</span>
<a href="#l6.1090"></a><span id="l6.1090" class="difflineplus">+          case MAPI_CC:</span>
<a href="#l6.1091"></a><span id="l6.1091" class="difflineplus">+            if (!Cc.IsEmpty()) Cc += Comma;</span>
<a href="#l6.1092"></a><span id="l6.1092" class="difflineplus">+            Cc.Append(nsDependentString(addressWithoutType));</span>
<a href="#l6.1093"></a><span id="l6.1093" class="difflineplus">+            break;</span>
<a href="#l6.1094"></a><span id="l6.1094"> </span>
<a href="#l6.1095"></a><span id="l6.1095" class="difflineminus">-        case MAPI_BCC :</span>
<a href="#l6.1096"></a><span id="l6.1096" class="difflineminus">-          if (!Bcc.IsEmpty())</span>
<a href="#l6.1097"></a><span id="l6.1097" class="difflineminus">-            Bcc += Comma;</span>
<a href="#l6.1098"></a><span id="l6.1098" class="difflineminus">-          Bcc.Append(nsDependentString(addressWithoutType));</span>
<a href="#l6.1099"></a><span id="l6.1099" class="difflineminus">-          break;</span>
<a href="#l6.1100"></a><span id="l6.1100" class="difflineplus">+          case MAPI_BCC:</span>
<a href="#l6.1101"></a><span id="l6.1101" class="difflineplus">+            if (!Bcc.IsEmpty()) Bcc += Comma;</span>
<a href="#l6.1102"></a><span id="l6.1102" class="difflineplus">+            Bcc.Append(nsDependentString(addressWithoutType));</span>
<a href="#l6.1103"></a><span id="l6.1103" class="difflineplus">+            break;</span>
<a href="#l6.1104"></a><span id="l6.1104">         }</span>
<a href="#l6.1105"></a><span id="l6.1105">       }</span>
<a href="#l6.1106"></a><span id="l6.1106">     }</span>
<a href="#l6.1107"></a><span id="l6.1107">   }</span>
<a href="#l6.1108"></a><span id="l6.1108"> </span>
<a href="#l6.1109"></a><span id="l6.1109">   MOZ_LOG(MAPI, mozilla::LogLevel::Debug,</span>
<a href="#l6.1110"></a><span id="l6.1110" class="difflineminus">-    (&quot;to: %s cc: %s bcc: %s \n&quot;, NS_ConvertUTF16toUTF8(To).get(),</span>
<a href="#l6.1111"></a><span id="l6.1111" class="difflineminus">-                                 NS_ConvertUTF16toUTF8(Cc).get(),</span>
<a href="#l6.1112"></a><span id="l6.1112" class="difflineminus">-                                 NS_ConvertUTF16toUTF8(Bcc).get()));</span>
<a href="#l6.1113"></a><span id="l6.1113" class="difflineplus">+          (&quot;to: %s cc: %s bcc: %s \n&quot;, NS_ConvertUTF16toUTF8(To).get(),</span>
<a href="#l6.1114"></a><span id="l6.1114" class="difflineplus">+           NS_ConvertUTF16toUTF8(Cc).get(), NS_ConvertUTF16toUTF8(Bcc).get()));</span>
<a href="#l6.1115"></a><span id="l6.1115">   // set To, Cc, Bcc</span>
<a href="#l6.1116"></a><span id="l6.1116">   aCompFields-&gt;SetTo(To);</span>
<a href="#l6.1117"></a><span id="l6.1117">   aCompFields-&gt;SetCc(Cc);</span>
<a href="#l6.1118"></a><span id="l6.1118">   aCompFields-&gt;SetBcc(Bcc);</span>
<a href="#l6.1119"></a><span id="l6.1119"> </span>
<a href="#l6.1120"></a><span id="l6.1120">   // Set subject.</span>
<a href="#l6.1121"></a><span id="l6.1121">   if (aMessage-&gt;lpszSubject)</span>
<a href="#l6.1122"></a><span id="l6.1122">     aCompFields-&gt;SetSubject(nsDependentString(aMessage-&gt;lpszSubject));</span>
<a href="#l6.1123"></a><span id="l6.1123"> </span>
<a href="#l6.1124"></a><span id="l6.1124">   // handle attachments as File URL</span>
<a href="#l6.1125"></a><span id="l6.1125" class="difflineminus">-  nsresult rv = HandleAttachmentsW(aCompFields, aMessage-&gt;nFileCount, aMessage-&gt;lpFiles);</span>
<a href="#l6.1126"></a><span id="l6.1126" class="difflineplus">+  nsresult rv =</span>
<a href="#l6.1127"></a><span id="l6.1127" class="difflineplus">+      HandleAttachmentsW(aCompFields, aMessage-&gt;nFileCount, aMessage-&gt;lpFiles);</span>
<a href="#l6.1128"></a><span id="l6.1128">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.1129"></a><span id="l6.1129"> </span>
<a href="#l6.1130"></a><span id="l6.1130">   // Set body.</span>
<a href="#l6.1131"></a><span id="l6.1131" class="difflineminus">-  if (aMessage-&gt;lpszNoteText)</span>
<a href="#l6.1132"></a><span id="l6.1132" class="difflineminus">-  {</span>
<a href="#l6.1133"></a><span id="l6.1133" class="difflineplus">+  if (aMessage-&gt;lpszNoteText) {</span>
<a href="#l6.1134"></a><span id="l6.1134">     nsString Body(aMessage-&gt;lpszNoteText);</span>
<a href="#l6.1135"></a><span id="l6.1135" class="difflineminus">-    if (Body.IsEmpty() || Body.Last() != '\n')</span>
<a href="#l6.1136"></a><span id="l6.1136" class="difflineminus">-      Body.AppendLiteral(CRLF);</span>
<a href="#l6.1137"></a><span id="l6.1137" class="difflineplus">+    if (Body.IsEmpty() || Body.Last() != '\n') Body.AppendLiteral(CRLF);</span>
<a href="#l6.1138"></a><span id="l6.1138"> </span>
<a href="#l6.1139"></a><span id="l6.1139">     // This is needed when Simple MAPI is used without a compose window.</span>
<a href="#l6.1140"></a><span id="l6.1140">     // See bug 1366196.</span>
<a href="#l6.1141"></a><span id="l6.1141" class="difflineminus">-    if (Body.Find(&quot;&lt;html&gt;&quot;) == kNotFound)</span>
<a href="#l6.1142"></a><span id="l6.1142" class="difflineminus">-      aCompFields-&gt;SetForcePlainText(true);</span>
<a href="#l6.1143"></a><span id="l6.1143" class="difflineplus">+    if (Body.Find(&quot;&lt;html&gt;&quot;) == kNotFound) aCompFields-&gt;SetForcePlainText(true);</span>
<a href="#l6.1144"></a><span id="l6.1144"> </span>
<a href="#l6.1145"></a><span id="l6.1145">     rv = aCompFields-&gt;SetBody(Body);</span>
<a href="#l6.1146"></a><span id="l6.1146">   }</span>
<a href="#l6.1147"></a><span id="l6.1147">   return rv;</span>
<a href="#l6.1148"></a><span id="l6.1148"> }</span>
<a href="#l6.1149"></a><span id="l6.1149"> </span>
<a href="#l6.1150"></a><span id="l6.1150" class="difflineminus">-// this is used to populate the docs as attachments in the Comp fields for Send Documents</span>
<a href="#l6.1151"></a><span id="l6.1151" class="difflineminus">-nsresult nsMapiHook::PopulateCompFieldsForSendDocs(nsIMsgCompFields * aCompFields, ULONG aFlags,</span>
<a href="#l6.1152"></a><span id="l6.1152" class="difflineminus">-                                                   LPSTR aDelimChar, LPSTR aFilePaths)</span>
<a href="#l6.1153"></a><span id="l6.1153" class="difflineminus">-{</span>
<a href="#l6.1154"></a><span id="l6.1154" class="difflineplus">+// this is used to populate the docs as attachments in the Comp fields for Send</span>
<a href="#l6.1155"></a><span id="l6.1155" class="difflineplus">+// Documents</span>
<a href="#l6.1156"></a><span id="l6.1156" class="difflineplus">+nsresult nsMapiHook::PopulateCompFieldsForSendDocs(</span>
<a href="#l6.1157"></a><span id="l6.1157" class="difflineplus">+    nsIMsgCompFields *aCompFields, ULONG aFlags, LPSTR aDelimChar,</span>
<a href="#l6.1158"></a><span id="l6.1158" class="difflineplus">+    LPSTR aFilePaths) {</span>
<a href="#l6.1159"></a><span id="l6.1159">   nsAutoCString strDelimChars;</span>
<a href="#l6.1160"></a><span id="l6.1160">   nsAutoCString strFilePaths;</span>
<a href="#l6.1161"></a><span id="l6.1161" class="difflineminus">-  nsresult rv = NS_OK ;</span>
<a href="#l6.1162"></a><span id="l6.1162" class="difflineminus">-  bool bExist ;</span>
<a href="#l6.1163"></a><span id="l6.1163" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l6.1164"></a><span id="l6.1164" class="difflineplus">+  bool bExist;</span>
<a href="#l6.1165"></a><span id="l6.1165"> </span>
<a href="#l6.1166"></a><span id="l6.1166" class="difflineminus">-  if (aDelimChar)</span>
<a href="#l6.1167"></a><span id="l6.1167" class="difflineminus">-    strDelimChars.Assign(aDelimChar);</span>
<a href="#l6.1168"></a><span id="l6.1168" class="difflineminus">-  if (aFilePaths)</span>
<a href="#l6.1169"></a><span id="l6.1169" class="difflineminus">-    strFilePaths.Assign(aFilePaths);</span>
<a href="#l6.1170"></a><span id="l6.1170" class="difflineplus">+  if (aDelimChar) strDelimChars.Assign(aDelimChar);</span>
<a href="#l6.1171"></a><span id="l6.1171" class="difflineplus">+  if (aFilePaths) strFilePaths.Assign(aFilePaths);</span>
<a href="#l6.1172"></a><span id="l6.1172"> </span>
<a href="#l6.1173"></a><span id="l6.1173">   // check for comma in filename</span>
<a href="#l6.1174"></a><span id="l6.1174" class="difflineminus">-  if (strDelimChars.FindChar(',') == kNotFound)  // if comma is not in the delimiter specified by user</span>
<a href="#l6.1175"></a><span id="l6.1175" class="difflineplus">+  if (strDelimChars.FindChar(',') ==</span>
<a href="#l6.1176"></a><span id="l6.1176" class="difflineplus">+      kNotFound)  // if comma is not in the delimiter specified by user</span>
<a href="#l6.1177"></a><span id="l6.1177">   {</span>
<a href="#l6.1178"></a><span id="l6.1178" class="difflineminus">-    if (strFilePaths.FindChar(',') != kNotFound) // if comma found in filenames return error</span>
<a href="#l6.1179"></a><span id="l6.1179" class="difflineplus">+    if (strFilePaths.FindChar(',') !=</span>
<a href="#l6.1180"></a><span id="l6.1180" class="difflineplus">+        kNotFound)  // if comma found in filenames return error</span>
<a href="#l6.1181"></a><span id="l6.1181">       return NS_ERROR_FILE_INVALID_PATH;</span>
<a href="#l6.1182"></a><span id="l6.1182">   }</span>
<a href="#l6.1183"></a><span id="l6.1183"> </span>
<a href="#l6.1184"></a><span id="l6.1184" class="difflineminus">-  nsCString Attachments ;</span>
<a href="#l6.1185"></a><span id="l6.1185" class="difflineplus">+  nsCString Attachments;</span>
<a href="#l6.1186"></a><span id="l6.1186"> </span>
<a href="#l6.1187"></a><span id="l6.1187">   // only 1 file is to be sent, no delim specified</span>
<a href="#l6.1188"></a><span id="l6.1188" class="difflineminus">-  if (strDelimChars.IsEmpty())</span>
<a href="#l6.1189"></a><span id="l6.1189" class="difflineminus">-      strDelimChars.Assign(';');</span>
<a href="#l6.1190"></a><span id="l6.1190" class="difflineplus">+  if (strDelimChars.IsEmpty()) strDelimChars.Assign(';');</span>
<a href="#l6.1191"></a><span id="l6.1191"> </span>
<a href="#l6.1192"></a><span id="l6.1192" class="difflineminus">-  int32_t offset = 0 ;</span>
<a href="#l6.1193"></a><span id="l6.1193" class="difflineminus">-  int32_t FilePathsLen = strFilePaths.Length() ;</span>
<a href="#l6.1194"></a><span id="l6.1194" class="difflineminus">-  if (FilePathsLen)</span>
<a href="#l6.1195"></a><span id="l6.1195" class="difflineminus">-  {</span>
<a href="#l6.1196"></a><span id="l6.1196" class="difflineminus">-    nsAutoString Subject ;</span>
<a href="#l6.1197"></a><span id="l6.1197" class="difflineplus">+  int32_t offset = 0;</span>
<a href="#l6.1198"></a><span id="l6.1198" class="difflineplus">+  int32_t FilePathsLen = strFilePaths.Length();</span>
<a href="#l6.1199"></a><span id="l6.1199" class="difflineplus">+  if (FilePathsLen) {</span>
<a href="#l6.1200"></a><span id="l6.1200" class="difflineplus">+    nsAutoString Subject;</span>
<a href="#l6.1201"></a><span id="l6.1201"> </span>
<a href="#l6.1202"></a><span id="l6.1202">     // multiple files to be sent, delim specified</span>
<a href="#l6.1203"></a><span id="l6.1203" class="difflineminus">-    nsCOMPtr &lt;nsIFile&gt; pFile = do_CreateInstance (NS_LOCAL_FILE_CONTRACTID, &amp;rv) ;</span>
<a href="#l6.1204"></a><span id="l6.1204" class="difflineminus">-    if (NS_FAILED(rv) || (!pFile) ) return rv ;</span>
<a href="#l6.1205"></a><span id="l6.1205" class="difflineplus">+    nsCOMPtr&lt;nsIFile&gt; pFile = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l6.1206"></a><span id="l6.1206" class="difflineplus">+    if (NS_FAILED(rv) || (!pFile)) return rv;</span>
<a href="#l6.1207"></a><span id="l6.1207"> </span>
<a href="#l6.1208"></a><span id="l6.1208">     char *newFilePaths = (char *)strFilePaths.get();</span>
<a href="#l6.1209"></a><span id="l6.1209" class="difflineminus">-    while (offset != kNotFound)</span>
<a href="#l6.1210"></a><span id="l6.1210" class="difflineminus">-    {</span>
<a href="#l6.1211"></a><span id="l6.1211" class="difflineminus">-      //Temp Directory</span>
<a href="#l6.1212"></a><span id="l6.1212" class="difflineminus">-      nsCOMPtr &lt;nsIFile&gt; pTempDir;</span>
<a href="#l6.1213"></a><span id="l6.1213" class="difflineplus">+    while (offset != kNotFound) {</span>
<a href="#l6.1214"></a><span id="l6.1214" class="difflineplus">+      // Temp Directory</span>
<a href="#l6.1215"></a><span id="l6.1215" class="difflineplus">+      nsCOMPtr&lt;nsIFile&gt; pTempDir;</span>
<a href="#l6.1216"></a><span id="l6.1216">       NS_GetSpecialDirectory(NS_OS_TEMP_DIR, getter_AddRefs(pTempDir));</span>
<a href="#l6.1217"></a><span id="l6.1217"> </span>
<a href="#l6.1218"></a><span id="l6.1218" class="difflineminus">-      // if not already existing, create another temp dir for mapi within Win temp dir</span>
<a href="#l6.1219"></a><span id="l6.1219" class="difflineminus">-      // this is windows only so we can do &quot;\\&quot;</span>
<a href="#l6.1220"></a><span id="l6.1220" class="difflineminus">-      pTempDir-&gt;AppendRelativePath (NS_LITERAL_STRING(&quot;moz_mapi&quot;));</span>
<a href="#l6.1221"></a><span id="l6.1221" class="difflineminus">-      pTempDir-&gt;Exists(&amp;bExist) ;</span>
<a href="#l6.1222"></a><span id="l6.1222" class="difflineminus">-      if (!bExist)</span>
<a href="#l6.1223"></a><span id="l6.1223" class="difflineminus">-      {</span>
<a href="#l6.1224"></a><span id="l6.1224" class="difflineminus">-        rv = pTempDir-&gt;Create(nsIFile::DIRECTORY_TYPE, 777) ;</span>
<a href="#l6.1225"></a><span id="l6.1225" class="difflineminus">-        if (NS_FAILED(rv)) return rv ;</span>
<a href="#l6.1226"></a><span id="l6.1226" class="difflineplus">+      // if not already existing, create another temp dir for mapi within Win</span>
<a href="#l6.1227"></a><span id="l6.1227" class="difflineplus">+      // temp dir this is windows only so we can do &quot;\\&quot;</span>
<a href="#l6.1228"></a><span id="l6.1228" class="difflineplus">+      pTempDir-&gt;AppendRelativePath(NS_LITERAL_STRING(&quot;moz_mapi&quot;));</span>
<a href="#l6.1229"></a><span id="l6.1229" class="difflineplus">+      pTempDir-&gt;Exists(&amp;bExist);</span>
<a href="#l6.1230"></a><span id="l6.1230" class="difflineplus">+      if (!bExist) {</span>
<a href="#l6.1231"></a><span id="l6.1231" class="difflineplus">+        rv = pTempDir-&gt;Create(nsIFile::DIRECTORY_TYPE, 777);</span>
<a href="#l6.1232"></a><span id="l6.1232" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.1233"></a><span id="l6.1233">       }</span>
<a href="#l6.1234"></a><span id="l6.1234"> </span>
<a href="#l6.1235"></a><span id="l6.1235">       nsAutoCString RemainingPaths;</span>
<a href="#l6.1236"></a><span id="l6.1236" class="difflineminus">-      RemainingPaths.Assign(newFilePaths) ;</span>
<a href="#l6.1237"></a><span id="l6.1237" class="difflineminus">-      offset = RemainingPaths.Find (strDelimChars) ;</span>
<a href="#l6.1238"></a><span id="l6.1238" class="difflineminus">-      if (offset != kNotFound)</span>
<a href="#l6.1239"></a><span id="l6.1239" class="difflineminus">-      {</span>
<a href="#l6.1240"></a><span id="l6.1240" class="difflineminus">-        RemainingPaths.SetLength (offset) ;</span>
<a href="#l6.1241"></a><span id="l6.1241" class="difflineplus">+      RemainingPaths.Assign(newFilePaths);</span>
<a href="#l6.1242"></a><span id="l6.1242" class="difflineplus">+      offset = RemainingPaths.Find(strDelimChars);</span>
<a href="#l6.1243"></a><span id="l6.1243" class="difflineplus">+      if (offset != kNotFound) {</span>
<a href="#l6.1244"></a><span id="l6.1244" class="difflineplus">+        RemainingPaths.SetLength(offset);</span>
<a href="#l6.1245"></a><span id="l6.1245">         if ((offset + (int32_t)strDelimChars.Length()) &lt; FilePathsLen)</span>
<a href="#l6.1246"></a><span id="l6.1246" class="difflineminus">-          newFilePaths += offset + strDelimChars.Length() ;</span>
<a href="#l6.1247"></a><span id="l6.1247" class="difflineplus">+          newFilePaths += offset + strDelimChars.Length();</span>
<a href="#l6.1248"></a><span id="l6.1248">         else</span>
<a href="#l6.1249"></a><span id="l6.1249">           offset = kNotFound;</span>
<a href="#l6.1250"></a><span id="l6.1250">         FilePathsLen -= offset + strDelimChars.Length();</span>
<a href="#l6.1251"></a><span id="l6.1251">       }</span>
<a href="#l6.1252"></a><span id="l6.1252"> </span>
<a href="#l6.1253"></a><span id="l6.1253" class="difflineminus">-      if (RemainingPaths[1] != ':' &amp;&amp; RemainingPaths[1] != '\\')</span>
<a href="#l6.1254"></a><span id="l6.1254" class="difflineminus">-      {</span>
<a href="#l6.1255"></a><span id="l6.1255" class="difflineplus">+      if (RemainingPaths[1] != ':' &amp;&amp; RemainingPaths[1] != '\\') {</span>
<a href="#l6.1256"></a><span id="l6.1256">         char cwd[MAX_PATH];</span>
<a href="#l6.1257"></a><span id="l6.1257" class="difflineminus">-        if (_getdcwd(_getdrive(), cwd, MAX_PATH))</span>
<a href="#l6.1258"></a><span id="l6.1258" class="difflineminus">-        {</span>
<a href="#l6.1259"></a><span id="l6.1259" class="difflineplus">+        if (_getdcwd(_getdrive(), cwd, MAX_PATH)) {</span>
<a href="#l6.1260"></a><span id="l6.1260">           nsAutoCString cwdStr;</span>
<a href="#l6.1261"></a><span id="l6.1261">           cwdStr.Assign(cwd);</span>
<a href="#l6.1262"></a><span id="l6.1262">           cwdStr.Append('\\');</span>
<a href="#l6.1263"></a><span id="l6.1263">           RemainingPaths.Insert(cwdStr, 0);</span>
<a href="#l6.1264"></a><span id="l6.1264">         }</span>
<a href="#l6.1265"></a><span id="l6.1265">       }</span>
<a href="#l6.1266"></a><span id="l6.1266"> </span>
<a href="#l6.1267"></a><span id="l6.1267" class="difflineminus">-      pFile-&gt;InitWithNativePath(RemainingPaths) ;</span>
<a href="#l6.1268"></a><span id="l6.1268" class="difflineplus">+      pFile-&gt;InitWithNativePath(RemainingPaths);</span>
<a href="#l6.1269"></a><span id="l6.1269"> </span>
<a href="#l6.1270"></a><span id="l6.1270" class="difflineminus">-      rv = pFile-&gt;Exists(&amp;bExist) ;</span>
<a href="#l6.1271"></a><span id="l6.1271" class="difflineminus">-      if (NS_FAILED(rv) || (!bExist) ) return NS_ERROR_FILE_TARGET_DOES_NOT_EXIST ;</span>
<a href="#l6.1272"></a><span id="l6.1272" class="difflineplus">+      rv = pFile-&gt;Exists(&amp;bExist);</span>
<a href="#l6.1273"></a><span id="l6.1273" class="difflineplus">+      if (NS_FAILED(rv) || (!bExist))</span>
<a href="#l6.1274"></a><span id="l6.1274" class="difflineplus">+        return NS_ERROR_FILE_TARGET_DOES_NOT_EXIST;</span>
<a href="#l6.1275"></a><span id="l6.1275"> </span>
<a href="#l6.1276"></a><span id="l6.1276">       // filename of the file attachment</span>
<a href="#l6.1277"></a><span id="l6.1277" class="difflineminus">-      nsAutoString leafName ;</span>
<a href="#l6.1278"></a><span id="l6.1278" class="difflineminus">-      pFile-&gt;GetLeafName (leafName) ;</span>
<a href="#l6.1279"></a><span id="l6.1279" class="difflineminus">-      if(NS_FAILED(rv) || leafName.IsEmpty()) return rv ;</span>
<a href="#l6.1280"></a><span id="l6.1280" class="difflineplus">+      nsAutoString leafName;</span>
<a href="#l6.1281"></a><span id="l6.1281" class="difflineplus">+      pFile-&gt;GetLeafName(leafName);</span>
<a href="#l6.1282"></a><span id="l6.1282" class="difflineplus">+      if (NS_FAILED(rv) || leafName.IsEmpty()) return rv;</span>
<a href="#l6.1283"></a><span id="l6.1283"> </span>
<a href="#l6.1284"></a><span id="l6.1284" class="difflineminus">-      if (!Subject.IsEmpty())</span>
<a href="#l6.1285"></a><span id="l6.1285" class="difflineminus">-          Subject.AppendLiteral(&quot;, &quot;);</span>
<a href="#l6.1286"></a><span id="l6.1286" class="difflineplus">+      if (!Subject.IsEmpty()) Subject.AppendLiteral(&quot;, &quot;);</span>
<a href="#l6.1287"></a><span id="l6.1287">       Subject += leafName;</span>
<a href="#l6.1288"></a><span id="l6.1288"> </span>
<a href="#l6.1289"></a><span id="l6.1289">       // create MsgCompose attachment object</span>
<a href="#l6.1290"></a><span id="l6.1290" class="difflineminus">-      nsCOMPtr&lt;nsIMsgAttachment&gt; attachment = do_CreateInstance(NS_MSGATTACHMENT_CONTRACTID, &amp;rv);</span>
<a href="#l6.1291"></a><span id="l6.1291" class="difflineplus">+      nsCOMPtr&lt;nsIMsgAttachment&gt; attachment =</span>
<a href="#l6.1292"></a><span id="l6.1292" class="difflineplus">+          do_CreateInstance(NS_MSGATTACHMENT_CONTRACTID, &amp;rv);</span>
<a href="#l6.1293"></a><span id="l6.1293">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.1294"></a><span id="l6.1294"> </span>
<a href="#l6.1295"></a><span id="l6.1295">       nsDependentString fileNameNative(leafName.get());</span>
<a href="#l6.1296"></a><span id="l6.1296">       rv = pFile-&gt;CopyTo(pTempDir, fileNameNative);</span>
<a href="#l6.1297"></a><span id="l6.1297">       if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.1298"></a><span id="l6.1298"> </span>
<a href="#l6.1299"></a><span id="l6.1299">       // now turn pTempDir into a full file path to the temp file</span>
<a href="#l6.1300"></a><span id="l6.1300">       pTempDir-&gt;Append(fileNameNative);</span>
<a href="#l6.1301"></a><span id="l6.1301" class="difflineat">@@ -903,54 +872,58 @@ nsresult nsMapiHook::PopulateCompFieldsF</span>
<a href="#l6.1302"></a><span id="l6.1302">       attachment-&gt;SetUrl(pURL);</span>
<a href="#l6.1303"></a><span id="l6.1303"> </span>
<a href="#l6.1304"></a><span id="l6.1304">       // set the file size</span>
<a href="#l6.1305"></a><span id="l6.1305">       int64_t fileSize;</span>
<a href="#l6.1306"></a><span id="l6.1306">       pFile-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l6.1307"></a><span id="l6.1307">       attachment-&gt;SetSize(fileSize);</span>
<a href="#l6.1308"></a><span id="l6.1308"> </span>
<a href="#l6.1309"></a><span id="l6.1309">       // add the attachment</span>
<a href="#l6.1310"></a><span id="l6.1310" class="difflineminus">-      rv = aCompFields-&gt;AddAttachment (attachment);</span>
<a href="#l6.1311"></a><span id="l6.1311" class="difflineplus">+      rv = aCompFields-&gt;AddAttachment(attachment);</span>
<a href="#l6.1312"></a><span id="l6.1312">       if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.1313"></a><span id="l6.1313">     }</span>
<a href="#l6.1314"></a><span id="l6.1314"> </span>
<a href="#l6.1315"></a><span id="l6.1315" class="difflineminus">-    rv = aCompFields-&gt;SetBody(Subject) ;</span>
<a href="#l6.1316"></a><span id="l6.1316" class="difflineplus">+    rv = aCompFields-&gt;SetBody(Subject);</span>
<a href="#l6.1317"></a><span id="l6.1317">   }</span>
<a href="#l6.1318"></a><span id="l6.1318"> </span>
<a href="#l6.1319"></a><span id="l6.1319" class="difflineminus">-  return rv ;</span>
<a href="#l6.1320"></a><span id="l6.1320" class="difflineplus">+  return rv;</span>
<a href="#l6.1321"></a><span id="l6.1321"> }</span>
<a href="#l6.1322"></a><span id="l6.1322"> </span>
<a href="#l6.1323"></a><span id="l6.1323"> // this used for Send with UI</span>
<a href="#l6.1324"></a><span id="l6.1324" class="difflineminus">-nsresult nsMapiHook::ShowComposerWindow (unsigned long aSession, nsIMsgCompFields * aCompFields)</span>
<a href="#l6.1325"></a><span id="l6.1325" class="difflineminus">-{</span>
<a href="#l6.1326"></a><span id="l6.1326" class="difflineminus">-    nsresult rv = NS_OK ;</span>
<a href="#l6.1327"></a><span id="l6.1327" class="difflineplus">+nsresult nsMapiHook::ShowComposerWindow(unsigned long aSession,</span>
<a href="#l6.1328"></a><span id="l6.1328" class="difflineplus">+                                        nsIMsgCompFields *aCompFields) {</span>
<a href="#l6.1329"></a><span id="l6.1329" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l6.1330"></a><span id="l6.1330"> </span>
<a href="#l6.1331"></a><span id="l6.1331" class="difflineminus">-    // create a send listener to get back the send status</span>
<a href="#l6.1332"></a><span id="l6.1332" class="difflineminus">-    RefPtr&lt;MAPISendListener&gt; sendListener = new MAPISendListener;</span>
<a href="#l6.1333"></a><span id="l6.1333" class="difflineplus">+  // create a send listener to get back the send status</span>
<a href="#l6.1334"></a><span id="l6.1334" class="difflineplus">+  RefPtr&lt;MAPISendListener&gt; sendListener = new MAPISendListener;</span>
<a href="#l6.1335"></a><span id="l6.1335"> </span>
<a href="#l6.1336"></a><span id="l6.1336" class="difflineminus">-    // create the compose params object</span>
<a href="#l6.1337"></a><span id="l6.1337" class="difflineminus">-    nsCOMPtr&lt;nsIMsgComposeParams&gt; pMsgComposeParams (do_CreateInstance(NS_MSGCOMPOSEPARAMS_CONTRACTID, &amp;rv));</span>
<a href="#l6.1338"></a><span id="l6.1338" class="difflineminus">-    if (NS_FAILED(rv) || (!pMsgComposeParams) ) return rv ;</span>
<a href="#l6.1339"></a><span id="l6.1339" class="difflineplus">+  // create the compose params object</span>
<a href="#l6.1340"></a><span id="l6.1340" class="difflineplus">+  nsCOMPtr&lt;nsIMsgComposeParams&gt; pMsgComposeParams(</span>
<a href="#l6.1341"></a><span id="l6.1341" class="difflineplus">+      do_CreateInstance(NS_MSGCOMPOSEPARAMS_CONTRACTID, &amp;rv));</span>
<a href="#l6.1342"></a><span id="l6.1342" class="difflineplus">+  if (NS_FAILED(rv) || (!pMsgComposeParams)) return rv;</span>
<a href="#l6.1343"></a><span id="l6.1343"> </span>
<a href="#l6.1344"></a><span id="l6.1344" class="difflineminus">-    // If we found HTML, compose in HTML.</span>
<a href="#l6.1345"></a><span id="l6.1345" class="difflineminus">-    bool forcePlainText;</span>
<a href="#l6.1346"></a><span id="l6.1346" class="difflineminus">-    aCompFields-&gt;GetForcePlainText(&amp;forcePlainText);</span>
<a href="#l6.1347"></a><span id="l6.1347" class="difflineminus">-    pMsgComposeParams-&gt;SetFormat(forcePlainText ? nsIMsgCompFormat::Default : nsIMsgCompFormat::HTML);</span>
<a href="#l6.1348"></a><span id="l6.1348" class="difflineplus">+  // If we found HTML, compose in HTML.</span>
<a href="#l6.1349"></a><span id="l6.1349" class="difflineplus">+  bool forcePlainText;</span>
<a href="#l6.1350"></a><span id="l6.1350" class="difflineplus">+  aCompFields-&gt;GetForcePlainText(&amp;forcePlainText);</span>
<a href="#l6.1351"></a><span id="l6.1351" class="difflineplus">+  pMsgComposeParams-&gt;SetFormat(forcePlainText ? nsIMsgCompFormat::Default</span>
<a href="#l6.1352"></a><span id="l6.1352" class="difflineplus">+                                              : nsIMsgCompFormat::HTML);</span>
<a href="#l6.1353"></a><span id="l6.1353"> </span>
<a href="#l6.1354"></a><span id="l6.1354" class="difflineminus">-    // populate the compose params</span>
<a href="#l6.1355"></a><span id="l6.1355" class="difflineminus">-    pMsgComposeParams-&gt;SetType(nsIMsgCompType::New);</span>
<a href="#l6.1356"></a><span id="l6.1356" class="difflineplus">+  // populate the compose params</span>
<a href="#l6.1357"></a><span id="l6.1357" class="difflineplus">+  pMsgComposeParams-&gt;SetType(nsIMsgCompType::New);</span>
<a href="#l6.1358"></a><span id="l6.1358"> </span>
<a href="#l6.1359"></a><span id="l6.1359" class="difflineminus">-    // Never force to plain text, the default format will take care of that.</span>
<a href="#l6.1360"></a><span id="l6.1360" class="difflineminus">-    // Undo the forcing that happened in PopulateCompFields/PopulateCompFieldsWithConversion.</span>
<a href="#l6.1361"></a><span id="l6.1361" class="difflineminus">-    // See bug 1095629 and bug 1366196.</span>
<a href="#l6.1362"></a><span id="l6.1362" class="difflineminus">-    aCompFields-&gt;SetForcePlainText(false);</span>
<a href="#l6.1363"></a><span id="l6.1363" class="difflineminus">-    pMsgComposeParams-&gt;SetComposeFields(aCompFields);</span>
<a href="#l6.1364"></a><span id="l6.1364" class="difflineminus">-    pMsgComposeParams-&gt;SetSendListener(sendListener);</span>
<a href="#l6.1365"></a><span id="l6.1365" class="difflineplus">+  // Never force to plain text, the default format will take care of that.</span>
<a href="#l6.1366"></a><span id="l6.1366" class="difflineplus">+  // Undo the forcing that happened in</span>
<a href="#l6.1367"></a><span id="l6.1367" class="difflineplus">+  // PopulateCompFields/PopulateCompFieldsWithConversion. See bug 1095629 and</span>
<a href="#l6.1368"></a><span id="l6.1368" class="difflineplus">+  // bug 1366196.</span>
<a href="#l6.1369"></a><span id="l6.1369" class="difflineplus">+  aCompFields-&gt;SetForcePlainText(false);</span>
<a href="#l6.1370"></a><span id="l6.1370" class="difflineplus">+  pMsgComposeParams-&gt;SetComposeFields(aCompFields);</span>
<a href="#l6.1371"></a><span id="l6.1371" class="difflineplus">+  pMsgComposeParams-&gt;SetSendListener(sendListener);</span>
<a href="#l6.1372"></a><span id="l6.1372"> </span>
<a href="#l6.1373"></a><span id="l6.1373" class="difflineminus">-    /** get the nsIMsgComposeService object to open the compose window **/</span>
<a href="#l6.1374"></a><span id="l6.1374" class="difflineminus">-    nsCOMPtr &lt;nsIMsgComposeService&gt; compService = do_GetService (NS_MSGCOMPOSESERVICE_CONTRACTID) ;</span>
<a href="#l6.1375"></a><span id="l6.1375" class="difflineminus">-    if (NS_FAILED(rv)|| (!compService) ) return rv ;</span>
<a href="#l6.1376"></a><span id="l6.1376" class="difflineplus">+  /** get the nsIMsgComposeService object to open the compose window **/</span>
<a href="#l6.1377"></a><span id="l6.1377" class="difflineplus">+  nsCOMPtr&lt;nsIMsgComposeService&gt; compService =</span>
<a href="#l6.1378"></a><span id="l6.1378" class="difflineplus">+      do_GetService(NS_MSGCOMPOSESERVICE_CONTRACTID);</span>
<a href="#l6.1379"></a><span id="l6.1379" class="difflineplus">+  if (NS_FAILED(rv) || (!compService)) return rv;</span>
<a href="#l6.1380"></a><span id="l6.1380"> </span>
<a href="#l6.1381"></a><span id="l6.1381" class="difflineminus">-    rv = compService-&gt;OpenComposeWindowWithParams(nullptr, pMsgComposeParams) ;</span>
<a href="#l6.1382"></a><span id="l6.1382" class="difflineminus">-    if (NS_FAILED(rv)) return rv ;</span>
<a href="#l6.1383"></a><span id="l6.1383" class="difflineplus">+  rv = compService-&gt;OpenComposeWindowWithParams(nullptr, pMsgComposeParams);</span>
<a href="#l6.1384"></a><span id="l6.1384" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.1385"></a><span id="l6.1385"> </span>
<a href="#l6.1386"></a><span id="l6.1386" class="difflineminus">-    return rv ;</span>
<a href="#l6.1387"></a><span id="l6.1387" class="difflineplus">+  return rv;</span>
<a href="#l6.1388"></a><span id="l6.1388"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/mapi/mapihook/src/msgMapiHook.h</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/mapi/mapihook/src/msgMapiHook.h</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -2,34 +2,38 @@</span>
<a href="#l7.4"></a><span id="l7.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l7.5"></a><span id="l7.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l7.6"></a><span id="l7.6"> </span>
<a href="#l7.7"></a><span id="l7.7"> #ifndef MSG_MAPI_HOOK_H_</span>
<a href="#l7.8"></a><span id="l7.8"> #define MSG_MAPI_HOOK_H_</span>
<a href="#l7.9"></a><span id="l7.9"> </span>
<a href="#l7.10"></a><span id="l7.10"> #include &quot;prtypes.h&quot;</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-class nsMapiHook</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-{</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineminus">-    public :</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineminus">-</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineminus">-        static bool DisplayLoginDialog(bool aLogin, char16_t **aUsername,</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineminus">-                        char16_t **aPassword);</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineminus">-        static bool VerifyUserName(const nsCString&amp; aUsername, nsCString&amp; aIdKey);</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+class nsMapiHook {</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+ public:</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineplus">+  static bool DisplayLoginDialog(bool aLogin, char16_t **aUsername,</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineplus">+                                 char16_t **aPassword);</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineplus">+  static bool VerifyUserName(const nsCString &amp;aUsername, nsCString &amp;aIdKey);</span>
<a href="#l7.24"></a><span id="l7.24"> </span>
<a href="#l7.25"></a><span id="l7.25" class="difflineminus">-        static bool IsBlindSendAllowed () ;</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineminus">-        static nsresult BlindSendMail (unsigned long aSession, nsIMsgCompFields * aCompFields) ;</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineminus">-        static nsresult ShowComposerWindow (unsigned long aSession, nsIMsgCompFields * aCompFields) ;</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineminus">-        static nsresult PopulateCompFieldsWithConversion(lpnsMapiMessage aMessage,</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineminus">-                                        nsIMsgCompFields * aCompFields) ;</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineminus">-        static nsresult PopulateCompFieldsW(lpnsMapiMessageW aMessage, nsIMsgCompFields *aCompFields);</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">-        static nsresult PopulateCompFieldsForSendDocs(nsIMsgCompFields * aCompFields,</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineminus">-                                        ULONG aFlags, LPSTR aDelimChar, LPSTR aFilePaths);</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineminus">-        static nsresult HandleAttachments(nsIMsgCompFields *aCompFields, int32_t aFileCount,</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineminus">-                                          lpnsMapiFileDesc aFiles, bool aIsUTF8);</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineminus">-        static nsresult HandleAttachmentsW(nsIMsgCompFields *aCompFields, int32_t aFileCount,</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineminus">-                                           lpnsMapiFileDescW aFiles);</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineminus">-        static void CleanUp();</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineplus">+  static bool IsBlindSendAllowed();</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineplus">+  static nsresult BlindSendMail(unsigned long aSession,</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineplus">+                                nsIMsgCompFields *aCompFields);</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineplus">+  static nsresult ShowComposerWindow(unsigned long aSession,</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineplus">+                                     nsIMsgCompFields *aCompFields);</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineplus">+  static nsresult PopulateCompFieldsWithConversion(</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineplus">+      lpnsMapiMessage aMessage, nsIMsgCompFields *aCompFields);</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineplus">+  static nsresult PopulateCompFieldsW(lpnsMapiMessageW aMessage,</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineplus">+                                      nsIMsgCompFields *aCompFields);</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineplus">+  static nsresult PopulateCompFieldsForSendDocs(nsIMsgCompFields *aCompFields,</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineplus">+                                                ULONG aFlags, LPSTR aDelimChar,</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineplus">+                                                LPSTR aFilePaths);</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineplus">+  static nsresult HandleAttachments(nsIMsgCompFields *aCompFields,</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineplus">+                                    int32_t aFileCount, lpnsMapiFileDesc aFiles,</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineplus">+                                    bool aIsUTF8);</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineplus">+  static nsresult HandleAttachmentsW(nsIMsgCompFields *aCompFields,</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineplus">+                                     int32_t aFileCount,</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineplus">+                                     lpnsMapiFileDescW aFiles);</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineplus">+  static void CleanUp();</span>
<a href="#l7.57"></a><span id="l7.57"> </span>
<a href="#l7.58"></a><span id="l7.58" class="difflineminus">-        static bool isMapiService;</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineplus">+  static bool isMapiService;</span>
<a href="#l7.60"></a><span id="l7.60"> };</span>
<a href="#l7.61"></a><span id="l7.61"> </span>
<a href="#l7.62"></a><span id="l7.62"> #endif  // MSG_MAPI_HOOK_H_</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/mapi/mapihook/src/msgMapiImp.cpp</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/mapi/mapihook/src/msgMapiImp.cpp</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -33,876 +33,775 @@</span>
<a href="#l8.4"></a><span id="l8.4"> #include &quot;nsMsgMessageFlags.h&quot;</span>
<a href="#l8.5"></a><span id="l8.5"> #include &quot;mozilla/mailnews/MimeHeaderParser.h&quot;</span>
<a href="#l8.6"></a><span id="l8.6"> #include &quot;mozilla/Logging.h&quot;</span>
<a href="#l8.7"></a><span id="l8.7"> </span>
<a href="#l8.8"></a><span id="l8.8"> using namespace mozilla::mailnews;</span>
<a href="#l8.9"></a><span id="l8.9"> </span>
<a href="#l8.10"></a><span id="l8.10"> mozilla::LazyLogModule MAPI(&quot;MAPI&quot;);</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-CMapiImp::CMapiImp()</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-: m_cRef(1)</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineminus">-{</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineminus">-    m_Lock = PR_NewLock();</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineminus">-}</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+CMapiImp::CMapiImp() : m_cRef(1) { m_Lock = PR_NewLock(); }</span>
<a href="#l8.18"></a><span id="l8.18"> </span>
<a href="#l8.19"></a><span id="l8.19" class="difflineminus">-CMapiImp::~CMapiImp()</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineminus">-{</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineminus">-    if (m_Lock)</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineminus">-        PR_DestroyLock(m_Lock);</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineplus">+CMapiImp::~CMapiImp() {</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+  if (m_Lock) PR_DestroyLock(m_Lock);</span>
<a href="#l8.25"></a><span id="l8.25"> }</span>
<a href="#l8.26"></a><span id="l8.26"> </span>
<a href="#l8.27"></a><span id="l8.27" class="difflineminus">-STDMETHODIMP CMapiImp::QueryInterface(const IID&amp; aIid, void** aPpv)</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineminus">-{</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineminus">-    if (aIid == IID_IUnknown)</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineminus">-    {</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-        *aPpv = static_cast&lt;nsIMapi*&gt;(this);</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineminus">-    }</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineminus">-    else if (aIid == IID_nsIMapi)</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineminus">-    {</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineminus">-        *aPpv = static_cast&lt;nsIMapi*&gt;(this);</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineminus">-    }</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineminus">-    else</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineminus">-    {</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineminus">-        *aPpv = nullptr;</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineminus">-        return E_NOINTERFACE;</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineminus">-    }</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineplus">+STDMETHODIMP CMapiImp::QueryInterface(const IID &amp;aIid, void **aPpv) {</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineplus">+  if (aIid == IID_IUnknown) {</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineplus">+    *aPpv = static_cast&lt;nsIMapi *&gt;(this);</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineplus">+  } else if (aIid == IID_nsIMapi) {</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineplus">+    *aPpv = static_cast&lt;nsIMapi *&gt;(this);</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineplus">+  } else {</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineplus">+    *aPpv = nullptr;</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineplus">+    return E_NOINTERFACE;</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineplus">+  }</span>
<a href="#l8.51"></a><span id="l8.51"> </span>
<a href="#l8.52"></a><span id="l8.52" class="difflineminus">-    reinterpret_cast&lt;IUnknown*&gt;(*aPpv)-&gt;AddRef();</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineminus">-    return S_OK;</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineminus">-}</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineminus">-</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineminus">-STDMETHODIMP_(ULONG) CMapiImp::AddRef()</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineminus">-{</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineminus">-    return ++m_cRef;</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineplus">+  reinterpret_cast&lt;IUnknown *&gt;(*aPpv)-&gt;AddRef();</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineplus">+  return S_OK;</span>
<a href="#l8.61"></a><span id="l8.61"> }</span>
<a href="#l8.62"></a><span id="l8.62"> </span>
<a href="#l8.63"></a><span id="l8.63" class="difflineminus">-STDMETHODIMP_(ULONG) CMapiImp::Release()</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineminus">-{</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineminus">-    int32_t temp = --m_cRef;</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineminus">-    if (m_cRef == 0)</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineminus">-    {</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineminus">-        delete this;</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineminus">-        return 0;</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineminus">-    }</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineplus">+STDMETHODIMP_(ULONG) CMapiImp::AddRef() { return ++m_cRef; }</span>
<a href="#l8.72"></a><span id="l8.72"> </span>
<a href="#l8.73"></a><span id="l8.73" class="difflineminus">-    return temp;</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineminus">-}</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineplus">+STDMETHODIMP_(ULONG) CMapiImp::Release() {</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineplus">+  int32_t temp = --m_cRef;</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineplus">+  if (m_cRef == 0) {</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineplus">+    delete this;</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineplus">+    return 0;</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineplus">+  }</span>
<a href="#l8.81"></a><span id="l8.81"> </span>
<a href="#l8.82"></a><span id="l8.82" class="difflineminus">-STDMETHODIMP CMapiImp::IsValid()</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineminus">-{</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineminus">-    return S_OK;</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineplus">+  return temp;</span>
<a href="#l8.86"></a><span id="l8.86"> }</span>
<a href="#l8.87"></a><span id="l8.87"> </span>
<a href="#l8.88"></a><span id="l8.88" class="difflineminus">-STDMETHODIMP CMapiImp::IsValidSession(unsigned long aSession)</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineminus">-{</span>
<a href="#l8.90"></a><span id="l8.90" class="difflineminus">-    nsMAPIConfiguration *pConfig = nsMAPIConfiguration::GetMAPIConfiguration();</span>
<a href="#l8.91"></a><span id="l8.91" class="difflineminus">-    if (pConfig &amp;&amp; pConfig-&gt;IsSessionValid(aSession))</span>
<a href="#l8.92"></a><span id="l8.92" class="difflineminus">-        return S_OK;</span>
<a href="#l8.93"></a><span id="l8.93" class="difflineplus">+STDMETHODIMP CMapiImp::IsValid() { return S_OK; }</span>
<a href="#l8.94"></a><span id="l8.94"> </span>
<a href="#l8.95"></a><span id="l8.95" class="difflineminus">-    return E_FAIL;</span>
<a href="#l8.96"></a><span id="l8.96" class="difflineplus">+STDMETHODIMP CMapiImp::IsValidSession(unsigned long aSession) {</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineplus">+  nsMAPIConfiguration *pConfig = nsMAPIConfiguration::GetMAPIConfiguration();</span>
<a href="#l8.98"></a><span id="l8.98" class="difflineplus">+  if (pConfig &amp;&amp; pConfig-&gt;IsSessionValid(aSession)) return S_OK;</span>
<a href="#l8.99"></a><span id="l8.99" class="difflineplus">+</span>
<a href="#l8.100"></a><span id="l8.100" class="difflineplus">+  return E_FAIL;</span>
<a href="#l8.101"></a><span id="l8.101"> }</span>
<a href="#l8.102"></a><span id="l8.102"> </span>
<a href="#l8.103"></a><span id="l8.103" class="difflineminus">-STDMETHODIMP CMapiImp::Initialize()</span>
<a href="#l8.104"></a><span id="l8.104" class="difflineminus">-{</span>
<a href="#l8.105"></a><span id="l8.105" class="difflineminus">-    HRESULT hr = E_FAIL;</span>
<a href="#l8.106"></a><span id="l8.106" class="difflineplus">+STDMETHODIMP CMapiImp::Initialize() {</span>
<a href="#l8.107"></a><span id="l8.107" class="difflineplus">+  HRESULT hr = E_FAIL;</span>
<a href="#l8.108"></a><span id="l8.108"> </span>
<a href="#l8.109"></a><span id="l8.109" class="difflineminus">-    if (!m_Lock)</span>
<a href="#l8.110"></a><span id="l8.110" class="difflineminus">-        return E_FAIL;</span>
<a href="#l8.111"></a><span id="l8.111" class="difflineplus">+  if (!m_Lock) return E_FAIL;</span>
<a href="#l8.112"></a><span id="l8.112"> </span>
<a href="#l8.113"></a><span id="l8.113" class="difflineminus">-    PR_Lock(m_Lock);</span>
<a href="#l8.114"></a><span id="l8.114" class="difflineplus">+  PR_Lock(m_Lock);</span>
<a href="#l8.115"></a><span id="l8.115"> </span>
<a href="#l8.116"></a><span id="l8.116" class="difflineminus">-    // Initialize MAPI Configuration</span>
<a href="#l8.117"></a><span id="l8.117" class="difflineplus">+  // Initialize MAPI Configuration</span>
<a href="#l8.118"></a><span id="l8.118"> </span>
<a href="#l8.119"></a><span id="l8.119" class="difflineminus">-    nsMAPIConfiguration *pConfig = nsMAPIConfiguration::GetMAPIConfiguration();</span>
<a href="#l8.120"></a><span id="l8.120" class="difflineminus">-    if (pConfig != nullptr)</span>
<a href="#l8.121"></a><span id="l8.121" class="difflineminus">-      hr = S_OK;</span>
<a href="#l8.122"></a><span id="l8.122" class="difflineplus">+  nsMAPIConfiguration *pConfig = nsMAPIConfiguration::GetMAPIConfiguration();</span>
<a href="#l8.123"></a><span id="l8.123" class="difflineplus">+  if (pConfig != nullptr) hr = S_OK;</span>
<a href="#l8.124"></a><span id="l8.124"> </span>
<a href="#l8.125"></a><span id="l8.125" class="difflineminus">-    PR_Unlock(m_Lock);</span>
<a href="#l8.126"></a><span id="l8.126" class="difflineplus">+  PR_Unlock(m_Lock);</span>
<a href="#l8.127"></a><span id="l8.127"> </span>
<a href="#l8.128"></a><span id="l8.128" class="difflineminus">-    return hr;</span>
<a href="#l8.129"></a><span id="l8.129" class="difflineplus">+  return hr;</span>
<a href="#l8.130"></a><span id="l8.130"> }</span>
<a href="#l8.131"></a><span id="l8.131"> </span>
<a href="#l8.132"></a><span id="l8.132" class="difflineminus">-STDMETHODIMP CMapiImp::Login(unsigned long aUIArg, LPSTR aLogin, LPSTR aPassWord,</span>
<a href="#l8.133"></a><span id="l8.133" class="difflineminus">-                             unsigned long aFlags, unsigned long *aSessionId)</span>
<a href="#l8.134"></a><span id="l8.134" class="difflineminus">-{</span>
<a href="#l8.135"></a><span id="l8.135" class="difflineminus">-    HRESULT hr = E_FAIL;</span>
<a href="#l8.136"></a><span id="l8.136" class="difflineminus">-     bool bNewSession = false;</span>
<a href="#l8.137"></a><span id="l8.137" class="difflineminus">-    nsCString id_key;</span>
<a href="#l8.138"></a><span id="l8.138" class="difflineplus">+STDMETHODIMP CMapiImp::Login(unsigned long aUIArg, LPSTR aLogin,</span>
<a href="#l8.139"></a><span id="l8.139" class="difflineplus">+                             LPSTR aPassWord, unsigned long aFlags,</span>
<a href="#l8.140"></a><span id="l8.140" class="difflineplus">+                             unsigned long *aSessionId) {</span>
<a href="#l8.141"></a><span id="l8.141" class="difflineplus">+  HRESULT hr = E_FAIL;</span>
<a href="#l8.142"></a><span id="l8.142" class="difflineplus">+  bool bNewSession = false;</span>
<a href="#l8.143"></a><span id="l8.143" class="difflineplus">+  nsCString id_key;</span>
<a href="#l8.144"></a><span id="l8.144"> </span>
<a href="#l8.145"></a><span id="l8.145" class="difflineminus">-    MOZ_LOG(MAPI, mozilla::LogLevel::Debug, (&quot;CMapiImp::Login using flags %d\n&quot;, aFlags));</span>
<a href="#l8.146"></a><span id="l8.146" class="difflineminus">-    if (aFlags &amp; MAPI_NEW_SESSION)</span>
<a href="#l8.147"></a><span id="l8.147" class="difflineminus">-        bNewSession = true;</span>
<a href="#l8.148"></a><span id="l8.148" class="difflineplus">+  MOZ_LOG(MAPI, mozilla::LogLevel::Debug,</span>
<a href="#l8.149"></a><span id="l8.149" class="difflineplus">+          (&quot;CMapiImp::Login using flags %d\n&quot;, aFlags));</span>
<a href="#l8.150"></a><span id="l8.150" class="difflineplus">+  if (aFlags &amp; MAPI_NEW_SESSION) bNewSession = true;</span>
<a href="#l8.151"></a><span id="l8.151"> </span>
<a href="#l8.152"></a><span id="l8.152" class="difflineminus">-    // Check For Profile Name</span>
<a href="#l8.153"></a><span id="l8.153" class="difflineminus">-    if (aLogin != nullptr &amp;&amp; aLogin[0] != '\0')</span>
<a href="#l8.154"></a><span id="l8.154" class="difflineminus">-    {</span>
<a href="#l8.155"></a><span id="l8.155" class="difflineminus">-        if (!nsMapiHook::VerifyUserName(nsDependentCString(aLogin), id_key))</span>
<a href="#l8.156"></a><span id="l8.156" class="difflineminus">-        {</span>
<a href="#l8.157"></a><span id="l8.157" class="difflineminus">-            *aSessionId = MAPI_E_LOGIN_FAILURE;</span>
<a href="#l8.158"></a><span id="l8.158" class="difflineminus">-            MOZ_LOG(MAPI, mozilla::LogLevel::Debug, (&quot;CMapiImp::Login failed for username %s\n&quot;, aLogin));</span>
<a href="#l8.159"></a><span id="l8.159" class="difflineminus">-            NS_ASSERTION(false, &quot;failed verifying user name&quot;);</span>
<a href="#l8.160"></a><span id="l8.160" class="difflineminus">-            return hr;</span>
<a href="#l8.161"></a><span id="l8.161" class="difflineminus">-        }</span>
<a href="#l8.162"></a><span id="l8.162" class="difflineplus">+  // Check For Profile Name</span>
<a href="#l8.163"></a><span id="l8.163" class="difflineplus">+  if (aLogin != nullptr &amp;&amp; aLogin[0] != '\0') {</span>
<a href="#l8.164"></a><span id="l8.164" class="difflineplus">+    if (!nsMapiHook::VerifyUserName(nsDependentCString(aLogin), id_key)) {</span>
<a href="#l8.165"></a><span id="l8.165" class="difflineplus">+      *aSessionId = MAPI_E_LOGIN_FAILURE;</span>
<a href="#l8.166"></a><span id="l8.166" class="difflineplus">+      MOZ_LOG(MAPI, mozilla::LogLevel::Debug,</span>
<a href="#l8.167"></a><span id="l8.167" class="difflineplus">+              (&quot;CMapiImp::Login failed for username %s\n&quot;, aLogin));</span>
<a href="#l8.168"></a><span id="l8.168" class="difflineplus">+      NS_ASSERTION(false, &quot;failed verifying user name&quot;);</span>
<a href="#l8.169"></a><span id="l8.169" class="difflineplus">+      return hr;</span>
<a href="#l8.170"></a><span id="l8.170">     }</span>
<a href="#l8.171"></a><span id="l8.171" class="difflineminus">-    else</span>
<a href="#l8.172"></a><span id="l8.172" class="difflineminus">-    {</span>
<a href="#l8.173"></a><span id="l8.173" class="difflineminus">-      // get default account</span>
<a href="#l8.174"></a><span id="l8.174" class="difflineminus">-      nsresult rv;</span>
<a href="#l8.175"></a><span id="l8.175" class="difflineminus">-      nsCOMPtr &lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l8.176"></a><span id="l8.176" class="difflineplus">+  } else {</span>
<a href="#l8.177"></a><span id="l8.177" class="difflineplus">+    // get default account</span>
<a href="#l8.178"></a><span id="l8.178" class="difflineplus">+    nsresult rv;</span>
<a href="#l8.179"></a><span id="l8.179" class="difflineplus">+    nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l8.180"></a><span id="l8.180">         do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l8.181"></a><span id="l8.181" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,MAPI_E_LOGIN_FAILURE);</span>
<a href="#l8.182"></a><span id="l8.182" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, MAPI_E_LOGIN_FAILURE);</span>
<a href="#l8.183"></a><span id="l8.183"> </span>
<a href="#l8.184"></a><span id="l8.184" class="difflineminus">-      nsCOMPtr&lt;nsIMsgAccount&gt; account;</span>
<a href="#l8.185"></a><span id="l8.185" class="difflineminus">-      rv = accountManager-&gt;GetDefaultAccount(getter_AddRefs(account));</span>
<a href="#l8.186"></a><span id="l8.186" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,MAPI_E_LOGIN_FAILURE);</span>
<a href="#l8.187"></a><span id="l8.187" class="difflineminus">-      if (!account)</span>
<a href="#l8.188"></a><span id="l8.188" class="difflineminus">-        return MAPI_E_LOGIN_FAILURE;</span>
<a href="#l8.189"></a><span id="l8.189" class="difflineplus">+    nsCOMPtr&lt;nsIMsgAccount&gt; account;</span>
<a href="#l8.190"></a><span id="l8.190" class="difflineplus">+    rv = accountManager-&gt;GetDefaultAccount(getter_AddRefs(account));</span>
<a href="#l8.191"></a><span id="l8.191" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, MAPI_E_LOGIN_FAILURE);</span>
<a href="#l8.192"></a><span id="l8.192" class="difflineplus">+    if (!account) return MAPI_E_LOGIN_FAILURE;</span>
<a href="#l8.193"></a><span id="l8.193"> </span>
<a href="#l8.194"></a><span id="l8.194" class="difflineminus">-      nsCOMPtr&lt;nsIMsgIdentity&gt; identity;</span>
<a href="#l8.195"></a><span id="l8.195" class="difflineminus">-      rv = account-&gt;GetDefaultIdentity(getter_AddRefs(identity));</span>
<a href="#l8.196"></a><span id="l8.196" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,MAPI_E_LOGIN_FAILURE);</span>
<a href="#l8.197"></a><span id="l8.197" class="difflineminus">-      if (!identity)</span>
<a href="#l8.198"></a><span id="l8.198" class="difflineminus">-        return MAPI_E_LOGIN_FAILURE;</span>
<a href="#l8.199"></a><span id="l8.199" class="difflineminus">-      identity-&gt;GetKey(id_key);</span>
<a href="#l8.200"></a><span id="l8.200" class="difflineminus">-    }</span>
<a href="#l8.201"></a><span id="l8.201" class="difflineplus">+    nsCOMPtr&lt;nsIMsgIdentity&gt; identity;</span>
<a href="#l8.202"></a><span id="l8.202" class="difflineplus">+    rv = account-&gt;GetDefaultIdentity(getter_AddRefs(identity));</span>
<a href="#l8.203"></a><span id="l8.203" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, MAPI_E_LOGIN_FAILURE);</span>
<a href="#l8.204"></a><span id="l8.204" class="difflineplus">+    if (!identity) return MAPI_E_LOGIN_FAILURE;</span>
<a href="#l8.205"></a><span id="l8.205" class="difflineplus">+    identity-&gt;GetKey(id_key);</span>
<a href="#l8.206"></a><span id="l8.206" class="difflineplus">+  }</span>
<a href="#l8.207"></a><span id="l8.207"> </span>
<a href="#l8.208"></a><span id="l8.208" class="difflineminus">-    // finally register(create) the session.</span>
<a href="#l8.209"></a><span id="l8.209" class="difflineminus">-    uint32_t nSession_Id;</span>
<a href="#l8.210"></a><span id="l8.210" class="difflineminus">-    int16_t nResult = 0;</span>
<a href="#l8.211"></a><span id="l8.211" class="difflineplus">+  // finally register(create) the session.</span>
<a href="#l8.212"></a><span id="l8.212" class="difflineplus">+  uint32_t nSession_Id;</span>
<a href="#l8.213"></a><span id="l8.213" class="difflineplus">+  int16_t nResult = 0;</span>
<a href="#l8.214"></a><span id="l8.214"> </span>
<a href="#l8.215"></a><span id="l8.215" class="difflineminus">-    nsMAPIConfiguration *pConfig = nsMAPIConfiguration::GetMAPIConfiguration();</span>
<a href="#l8.216"></a><span id="l8.216" class="difflineminus">-    if (pConfig != nullptr)</span>
<a href="#l8.217"></a><span id="l8.217" class="difflineminus">-        nResult = pConfig-&gt;RegisterSession(aUIArg,</span>
<a href="#l8.218"></a><span id="l8.218" class="difflineminus">-            aLogin ? nsDependentCString(aLogin) : EmptyCString(),</span>
<a href="#l8.219"></a><span id="l8.219" class="difflineminus">-            aPassWord ? nsDependentCString(aPassWord) : EmptyCString(),</span>
<a href="#l8.220"></a><span id="l8.220" class="difflineminus">-            (aFlags &amp; MAPI_FORCE_DOWNLOAD), bNewSession,</span>
<a href="#l8.221"></a><span id="l8.221" class="difflineminus">-            &amp;nSession_Id, id_key.get());</span>
<a href="#l8.222"></a><span id="l8.222" class="difflineminus">-    switch (nResult)</span>
<a href="#l8.223"></a><span id="l8.223" class="difflineminus">-    {</span>
<a href="#l8.224"></a><span id="l8.224" class="difflineminus">-        case -1 :</span>
<a href="#l8.225"></a><span id="l8.225" class="difflineminus">-        {</span>
<a href="#l8.226"></a><span id="l8.226" class="difflineminus">-            *aSessionId = MAPI_E_TOO_MANY_SESSIONS;</span>
<a href="#l8.227"></a><span id="l8.227" class="difflineminus">-            return hr;</span>
<a href="#l8.228"></a><span id="l8.228" class="difflineminus">-        }</span>
<a href="#l8.229"></a><span id="l8.229" class="difflineminus">-        case 0 :</span>
<a href="#l8.230"></a><span id="l8.230" class="difflineminus">-        {</span>
<a href="#l8.231"></a><span id="l8.231" class="difflineminus">-            *aSessionId = MAPI_E_INSUFFICIENT_MEMORY;</span>
<a href="#l8.232"></a><span id="l8.232" class="difflineminus">-            return hr;</span>
<a href="#l8.233"></a><span id="l8.233" class="difflineminus">-        }</span>
<a href="#l8.234"></a><span id="l8.234" class="difflineminus">-        default :</span>
<a href="#l8.235"></a><span id="l8.235" class="difflineminus">-        {</span>
<a href="#l8.236"></a><span id="l8.236" class="difflineminus">-            *aSessionId = nSession_Id;</span>
<a href="#l8.237"></a><span id="l8.237" class="difflineminus">-            MOZ_LOG(MAPI, mozilla::LogLevel::Debug, (&quot;CMapiImp::Login succeeded\n&quot;));</span>
<a href="#l8.238"></a><span id="l8.238" class="difflineminus">-            break;</span>
<a href="#l8.239"></a><span id="l8.239" class="difflineminus">-        }</span>
<a href="#l8.240"></a><span id="l8.240" class="difflineplus">+  nsMAPIConfiguration *pConfig = nsMAPIConfiguration::GetMAPIConfiguration();</span>
<a href="#l8.241"></a><span id="l8.241" class="difflineplus">+  if (pConfig != nullptr)</span>
<a href="#l8.242"></a><span id="l8.242" class="difflineplus">+    nResult = pConfig-&gt;RegisterSession(</span>
<a href="#l8.243"></a><span id="l8.243" class="difflineplus">+        aUIArg, aLogin ? nsDependentCString(aLogin) : EmptyCString(),</span>
<a href="#l8.244"></a><span id="l8.244" class="difflineplus">+        aPassWord ? nsDependentCString(aPassWord) : EmptyCString(),</span>
<a href="#l8.245"></a><span id="l8.245" class="difflineplus">+        (aFlags &amp; MAPI_FORCE_DOWNLOAD), bNewSession, &amp;nSession_Id,</span>
<a href="#l8.246"></a><span id="l8.246" class="difflineplus">+        id_key.get());</span>
<a href="#l8.247"></a><span id="l8.247" class="difflineplus">+  switch (nResult) {</span>
<a href="#l8.248"></a><span id="l8.248" class="difflineplus">+    case -1: {</span>
<a href="#l8.249"></a><span id="l8.249" class="difflineplus">+      *aSessionId = MAPI_E_TOO_MANY_SESSIONS;</span>
<a href="#l8.250"></a><span id="l8.250" class="difflineplus">+      return hr;</span>
<a href="#l8.251"></a><span id="l8.251">     }</span>
<a href="#l8.252"></a><span id="l8.252" class="difflineplus">+    case 0: {</span>
<a href="#l8.253"></a><span id="l8.253" class="difflineplus">+      *aSessionId = MAPI_E_INSUFFICIENT_MEMORY;</span>
<a href="#l8.254"></a><span id="l8.254" class="difflineplus">+      return hr;</span>
<a href="#l8.255"></a><span id="l8.255" class="difflineplus">+    }</span>
<a href="#l8.256"></a><span id="l8.256" class="difflineplus">+    default: {</span>
<a href="#l8.257"></a><span id="l8.257" class="difflineplus">+      *aSessionId = nSession_Id;</span>
<a href="#l8.258"></a><span id="l8.258" class="difflineplus">+      MOZ_LOG(MAPI, mozilla::LogLevel::Debug, (&quot;CMapiImp::Login succeeded\n&quot;));</span>
<a href="#l8.259"></a><span id="l8.259" class="difflineplus">+      break;</span>
<a href="#l8.260"></a><span id="l8.260" class="difflineplus">+    }</span>
<a href="#l8.261"></a><span id="l8.261" class="difflineplus">+  }</span>
<a href="#l8.262"></a><span id="l8.262"> </span>
<a href="#l8.263"></a><span id="l8.263" class="difflineminus">-    return S_OK;</span>
<a href="#l8.264"></a><span id="l8.264" class="difflineplus">+  return S_OK;</span>
<a href="#l8.265"></a><span id="l8.265"> }</span>
<a href="#l8.266"></a><span id="l8.266"> </span>
<a href="#l8.267"></a><span id="l8.267" class="difflineminus">-STDMETHODIMP CMapiImp::SendMail( unsigned long aSession, lpnsMapiMessage aMessage,</span>
<a href="#l8.268"></a><span id="l8.268" class="difflineminus">-     unsigned long aFlags, unsigned long aReserved)</span>
<a href="#l8.269"></a><span id="l8.269" class="difflineminus">-{</span>
<a href="#l8.270"></a><span id="l8.270" class="difflineminus">-    MOZ_LOG(MAPI, mozilla::LogLevel::Debug,</span>
<a href="#l8.271"></a><span id="l8.271" class="difflineminus">-      (&quot;CMapiImp::SendMail flags=%lx subject: %s sender: %s\n&quot;,</span>
<a href="#l8.272"></a><span id="l8.272" class="difflineminus">-       aFlags,</span>
<a href="#l8.273"></a><span id="l8.273" class="difflineminus">-       (aMessage &amp;&amp; aMessage-&gt;lpszSubject) ? aMessage-&gt;lpszSubject : &quot;(no subject)&quot;,</span>
<a href="#l8.274"></a><span id="l8.274" class="difflineminus">-       (aMessage &amp;&amp; aMessage-&gt;lpOriginator &amp;&amp; aMessage-&gt;lpOriginator-&gt;lpszAddress) ?</span>
<a href="#l8.275"></a><span id="l8.275" class="difflineminus">-          aMessage-&gt;lpOriginator-&gt;lpszAddress : &quot;(no sender)&quot;));</span>
<a href="#l8.276"></a><span id="l8.276" class="difflineminus">-</span>
<a href="#l8.277"></a><span id="l8.277" class="difflineminus">-    /** create nsIMsgCompFields obj and populate it **/</span>
<a href="#l8.278"></a><span id="l8.278" class="difflineminus">-    nsresult rv = NS_OK ;</span>
<a href="#l8.279"></a><span id="l8.279" class="difflineminus">-    nsCOMPtr&lt;nsIMsgCompFields&gt; pCompFields = do_CreateInstance(NS_MSGCOMPFIELDS_CONTRACTID, &amp;rv) ;</span>
<a href="#l8.280"></a><span id="l8.280" class="difflineminus">-    if (NS_FAILED(rv) || (!pCompFields) ) return MAPI_E_INSUFFICIENT_MEMORY ;</span>
<a href="#l8.281"></a><span id="l8.281" class="difflineplus">+STDMETHODIMP CMapiImp::SendMail(unsigned long aSession,</span>
<a href="#l8.282"></a><span id="l8.282" class="difflineplus">+                                lpnsMapiMessage aMessage, unsigned long aFlags,</span>
<a href="#l8.283"></a><span id="l8.283" class="difflineplus">+                                unsigned long aReserved) {</span>
<a href="#l8.284"></a><span id="l8.284" class="difflineplus">+  MOZ_LOG(MAPI, mozilla::LogLevel::Debug,</span>
<a href="#l8.285"></a><span id="l8.285" class="difflineplus">+          (&quot;CMapiImp::SendMail flags=%lx subject: %s sender: %s\n&quot;, aFlags,</span>
<a href="#l8.286"></a><span id="l8.286" class="difflineplus">+           (aMessage &amp;&amp; aMessage-&gt;lpszSubject) ? aMessage-&gt;lpszSubject</span>
<a href="#l8.287"></a><span id="l8.287" class="difflineplus">+                                               : &quot;(no subject)&quot;,</span>
<a href="#l8.288"></a><span id="l8.288" class="difflineplus">+           (aMessage &amp;&amp; aMessage-&gt;lpOriginator &amp;&amp;</span>
<a href="#l8.289"></a><span id="l8.289" class="difflineplus">+            aMessage-&gt;lpOriginator-&gt;lpszAddress)</span>
<a href="#l8.290"></a><span id="l8.290" class="difflineplus">+               ? aMessage-&gt;lpOriginator-&gt;lpszAddress</span>
<a href="#l8.291"></a><span id="l8.291" class="difflineplus">+               : &quot;(no sender)&quot;));</span>
<a href="#l8.292"></a><span id="l8.292"> </span>
<a href="#l8.293"></a><span id="l8.293" class="difflineminus">-    if (aMessage)</span>
<a href="#l8.294"></a><span id="l8.294" class="difflineminus">-      rv = nsMapiHook::PopulateCompFieldsWithConversion(aMessage, pCompFields);</span>
<a href="#l8.295"></a><span id="l8.295" class="difflineplus">+  /** create nsIMsgCompFields obj and populate it **/</span>
<a href="#l8.296"></a><span id="l8.296" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l8.297"></a><span id="l8.297" class="difflineplus">+  nsCOMPtr&lt;nsIMsgCompFields&gt; pCompFields =</span>
<a href="#l8.298"></a><span id="l8.298" class="difflineplus">+      do_CreateInstance(NS_MSGCOMPFIELDS_CONTRACTID, &amp;rv);</span>
<a href="#l8.299"></a><span id="l8.299" class="difflineplus">+  if (NS_FAILED(rv) || (!pCompFields)) return MAPI_E_INSUFFICIENT_MEMORY;</span>
<a href="#l8.300"></a><span id="l8.300" class="difflineplus">+</span>
<a href="#l8.301"></a><span id="l8.301" class="difflineplus">+  if (aMessage)</span>
<a href="#l8.302"></a><span id="l8.302" class="difflineplus">+    rv = nsMapiHook::PopulateCompFieldsWithConversion(aMessage, pCompFields);</span>
<a href="#l8.303"></a><span id="l8.303"> </span>
<a href="#l8.304"></a><span id="l8.304" class="difflineminus">-    if (NS_SUCCEEDED (rv))</span>
<a href="#l8.305"></a><span id="l8.305" class="difflineminus">-    {</span>
<a href="#l8.306"></a><span id="l8.306" class="difflineminus">-        // see flag to see if UI needs to be brought up</span>
<a href="#l8.307"></a><span id="l8.307" class="difflineminus">-        if (!(aFlags &amp; MAPI_DIALOG))</span>
<a href="#l8.308"></a><span id="l8.308" class="difflineminus">-        {</span>
<a href="#l8.309"></a><span id="l8.309" class="difflineminus">-            rv = nsMapiHook::BlindSendMail(aSession, pCompFields);</span>
<a href="#l8.310"></a><span id="l8.310" class="difflineminus">-        }</span>
<a href="#l8.311"></a><span id="l8.311" class="difflineminus">-        else</span>
<a href="#l8.312"></a><span id="l8.312" class="difflineminus">-        {</span>
<a href="#l8.313"></a><span id="l8.313" class="difflineminus">-            rv = nsMapiHook::ShowComposerWindow(aSession, pCompFields);</span>
<a href="#l8.314"></a><span id="l8.314" class="difflineminus">-        }</span>
<a href="#l8.315"></a><span id="l8.315" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l8.316"></a><span id="l8.316" class="difflineplus">+    // see flag to see if UI needs to be brought up</span>
<a href="#l8.317"></a><span id="l8.317" class="difflineplus">+    if (!(aFlags &amp; MAPI_DIALOG)) {</span>
<a href="#l8.318"></a><span id="l8.318" class="difflineplus">+      rv = nsMapiHook::BlindSendMail(aSession, pCompFields);</span>
<a href="#l8.319"></a><span id="l8.319" class="difflineplus">+    } else {</span>
<a href="#l8.320"></a><span id="l8.320" class="difflineplus">+      rv = nsMapiHook::ShowComposerWindow(aSession, pCompFields);</span>
<a href="#l8.321"></a><span id="l8.321">     }</span>
<a href="#l8.322"></a><span id="l8.322" class="difflineplus">+  }</span>
<a href="#l8.323"></a><span id="l8.323"> </span>
<a href="#l8.324"></a><span id="l8.324" class="difflineminus">-    return nsMAPIConfiguration::GetMAPIErrorFromNSError (rv) ;</span>
<a href="#l8.325"></a><span id="l8.325" class="difflineplus">+  return nsMAPIConfiguration::GetMAPIErrorFromNSError(rv);</span>
<a href="#l8.326"></a><span id="l8.326"> }</span>
<a href="#l8.327"></a><span id="l8.327"> </span>
<a href="#l8.328"></a><span id="l8.328" class="difflineminus">-STDMETHODIMP CMapiImp::SendMailW(unsigned long aSession, lpnsMapiMessageW aMessage,</span>
<a href="#l8.329"></a><span id="l8.329" class="difflineminus">-                                 unsigned long aFlags, unsigned long aReserved)</span>
<a href="#l8.330"></a><span id="l8.330" class="difflineminus">-{</span>
<a href="#l8.331"></a><span id="l8.331" class="difflineminus">-    MOZ_LOG(MAPI, mozilla::LogLevel::Debug,</span>
<a href="#l8.332"></a><span id="l8.332" class="difflineminus">-      (&quot;CMapiImp::SendMailW flags=%lx subject: %s sender: %s\n&quot;,</span>
<a href="#l8.333"></a><span id="l8.333" class="difflineminus">-       aFlags,</span>
<a href="#l8.334"></a><span id="l8.334" class="difflineminus">-       (aMessage &amp;&amp; aMessage-&gt;lpszSubject) ?</span>
<a href="#l8.335"></a><span id="l8.335" class="difflineminus">-          NS_ConvertUTF16toUTF8(aMessage-&gt;lpszSubject).get() : &quot;(no subject)&quot;,</span>
<a href="#l8.336"></a><span id="l8.336" class="difflineminus">-       (aMessage &amp;&amp; aMessage-&gt;lpOriginator &amp;&amp; aMessage-&gt;lpOriginator-&gt;lpszAddress) ?</span>
<a href="#l8.337"></a><span id="l8.337" class="difflineminus">-          NS_ConvertUTF16toUTF8(aMessage-&gt;lpOriginator-&gt;lpszAddress).get() : &quot;(no sender)&quot;));</span>
<a href="#l8.338"></a><span id="l8.338" class="difflineminus">-</span>
<a href="#l8.339"></a><span id="l8.339" class="difflineminus">-    // Create nsIMsgCompFields obj and populate it.</span>
<a href="#l8.340"></a><span id="l8.340" class="difflineminus">-    nsresult rv = NS_OK;</span>
<a href="#l8.341"></a><span id="l8.341" class="difflineminus">-    nsCOMPtr&lt;nsIMsgCompFields&gt; pCompFields = do_CreateInstance(NS_MSGCOMPFIELDS_CONTRACTID, &amp;rv);</span>
<a href="#l8.342"></a><span id="l8.342" class="difflineminus">-    if (NS_FAILED(rv) || !pCompFields) return MAPI_E_INSUFFICIENT_MEMORY;</span>
<a href="#l8.343"></a><span id="l8.343" class="difflineplus">+STDMETHODIMP CMapiImp::SendMailW(unsigned long aSession,</span>
<a href="#l8.344"></a><span id="l8.344" class="difflineplus">+                                 lpnsMapiMessageW aMessage,</span>
<a href="#l8.345"></a><span id="l8.345" class="difflineplus">+                                 unsigned long aFlags,</span>
<a href="#l8.346"></a><span id="l8.346" class="difflineplus">+                                 unsigned long aReserved) {</span>
<a href="#l8.347"></a><span id="l8.347" class="difflineplus">+  MOZ_LOG(</span>
<a href="#l8.348"></a><span id="l8.348" class="difflineplus">+      MAPI, mozilla::LogLevel::Debug,</span>
<a href="#l8.349"></a><span id="l8.349" class="difflineplus">+      (&quot;CMapiImp::SendMailW flags=%lx subject: %s sender: %s\n&quot;, aFlags,</span>
<a href="#l8.350"></a><span id="l8.350" class="difflineplus">+       (aMessage &amp;&amp; aMessage-&gt;lpszSubject)</span>
<a href="#l8.351"></a><span id="l8.351" class="difflineplus">+           ? NS_ConvertUTF16toUTF8(aMessage-&gt;lpszSubject).get()</span>
<a href="#l8.352"></a><span id="l8.352" class="difflineplus">+           : &quot;(no subject)&quot;,</span>
<a href="#l8.353"></a><span id="l8.353" class="difflineplus">+       (aMessage &amp;&amp; aMessage-&gt;lpOriginator &amp;&amp;</span>
<a href="#l8.354"></a><span id="l8.354" class="difflineplus">+        aMessage-&gt;lpOriginator-&gt;lpszAddress)</span>
<a href="#l8.355"></a><span id="l8.355" class="difflineplus">+           ? NS_ConvertUTF16toUTF8(aMessage-&gt;lpOriginator-&gt;lpszAddress).get()</span>
<a href="#l8.356"></a><span id="l8.356" class="difflineplus">+           : &quot;(no sender)&quot;));</span>
<a href="#l8.357"></a><span id="l8.357"> </span>
<a href="#l8.358"></a><span id="l8.358" class="difflineminus">-    if (aMessage)</span>
<a href="#l8.359"></a><span id="l8.359" class="difflineminus">-      rv = nsMapiHook::PopulateCompFieldsW(aMessage, pCompFields);</span>
<a href="#l8.360"></a><span id="l8.360" class="difflineplus">+  // Create nsIMsgCompFields obj and populate it.</span>
<a href="#l8.361"></a><span id="l8.361" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l8.362"></a><span id="l8.362" class="difflineplus">+  nsCOMPtr&lt;nsIMsgCompFields&gt; pCompFields =</span>
<a href="#l8.363"></a><span id="l8.363" class="difflineplus">+      do_CreateInstance(NS_MSGCOMPFIELDS_CONTRACTID, &amp;rv);</span>
<a href="#l8.364"></a><span id="l8.364" class="difflineplus">+  if (NS_FAILED(rv) || !pCompFields) return MAPI_E_INSUFFICIENT_MEMORY;</span>
<a href="#l8.365"></a><span id="l8.365" class="difflineplus">+</span>
<a href="#l8.366"></a><span id="l8.366" class="difflineplus">+  if (aMessage) rv = nsMapiHook::PopulateCompFieldsW(aMessage, pCompFields);</span>
<a href="#l8.367"></a><span id="l8.367"> </span>
<a href="#l8.368"></a><span id="l8.368" class="difflineminus">-    if (NS_SUCCEEDED (rv))</span>
<a href="#l8.369"></a><span id="l8.369" class="difflineminus">-    {</span>
<a href="#l8.370"></a><span id="l8.370" class="difflineminus">-      // Check flag to see if UI needs to be brought up.</span>
<a href="#l8.371"></a><span id="l8.371" class="difflineminus">-      if (!(aFlags &amp; MAPI_DIALOG))</span>
<a href="#l8.372"></a><span id="l8.372" class="difflineminus">-      {</span>
<a href="#l8.373"></a><span id="l8.373" class="difflineminus">-        rv = nsMapiHook::BlindSendMail(aSession, pCompFields);</span>
<a href="#l8.374"></a><span id="l8.374" class="difflineminus">-      }</span>
<a href="#l8.375"></a><span id="l8.375" class="difflineminus">-      else</span>
<a href="#l8.376"></a><span id="l8.376" class="difflineminus">-      {</span>
<a href="#l8.377"></a><span id="l8.377" class="difflineminus">-        rv = nsMapiHook::ShowComposerWindow(aSession, pCompFields);</span>
<a href="#l8.378"></a><span id="l8.378" class="difflineminus">-      }</span>
<a href="#l8.379"></a><span id="l8.379" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l8.380"></a><span id="l8.380" class="difflineplus">+    // Check flag to see if UI needs to be brought up.</span>
<a href="#l8.381"></a><span id="l8.381" class="difflineplus">+    if (!(aFlags &amp; MAPI_DIALOG)) {</span>
<a href="#l8.382"></a><span id="l8.382" class="difflineplus">+      rv = nsMapiHook::BlindSendMail(aSession, pCompFields);</span>
<a href="#l8.383"></a><span id="l8.383" class="difflineplus">+    } else {</span>
<a href="#l8.384"></a><span id="l8.384" class="difflineplus">+      rv = nsMapiHook::ShowComposerWindow(aSession, pCompFields);</span>
<a href="#l8.385"></a><span id="l8.385">     }</span>
<a href="#l8.386"></a><span id="l8.386" class="difflineplus">+  }</span>
<a href="#l8.387"></a><span id="l8.387"> </span>
<a href="#l8.388"></a><span id="l8.388" class="difflineminus">-    return nsMAPIConfiguration::GetMAPIErrorFromNSError(rv);</span>
<a href="#l8.389"></a><span id="l8.389" class="difflineplus">+  return nsMAPIConfiguration::GetMAPIErrorFromNSError(rv);</span>
<a href="#l8.390"></a><span id="l8.390"> }</span>
<a href="#l8.391"></a><span id="l8.391"> </span>
<a href="#l8.392"></a><span id="l8.392"> STDMETHODIMP CMapiImp::SendDocuments(unsigned long aSession, LPSTR aDelimChar,</span>
<a href="#l8.393"></a><span id="l8.393" class="difflineminus">-                                     LPSTR aFilePaths, LPSTR aFileNames, ULONG aFlags)</span>
<a href="#l8.394"></a><span id="l8.394" class="difflineminus">-{</span>
<a href="#l8.395"></a><span id="l8.395" class="difflineminus">-    nsresult rv = NS_OK ;</span>
<a href="#l8.396"></a><span id="l8.396" class="difflineplus">+                                     LPSTR aFilePaths, LPSTR aFileNames,</span>
<a href="#l8.397"></a><span id="l8.397" class="difflineplus">+                                     ULONG aFlags) {</span>
<a href="#l8.398"></a><span id="l8.398" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l8.399"></a><span id="l8.399"> </span>
<a href="#l8.400"></a><span id="l8.400" class="difflineminus">-    MOZ_LOG(MAPI, mozilla::LogLevel::Debug, (&quot;CMapiImp::SendDocument using flags %d\n&quot;, aFlags));</span>
<a href="#l8.401"></a><span id="l8.401" class="difflineminus">-    /** create nsIMsgCompFields obj and populate it **/</span>
<a href="#l8.402"></a><span id="l8.402" class="difflineminus">-    nsCOMPtr&lt;nsIMsgCompFields&gt; pCompFields = do_CreateInstance(NS_MSGCOMPFIELDS_CONTRACTID, &amp;rv) ;</span>
<a href="#l8.403"></a><span id="l8.403" class="difflineminus">-    if (NS_FAILED(rv) || (!pCompFields) ) return MAPI_E_INSUFFICIENT_MEMORY ;</span>
<a href="#l8.404"></a><span id="l8.404" class="difflineplus">+  MOZ_LOG(MAPI, mozilla::LogLevel::Debug,</span>
<a href="#l8.405"></a><span id="l8.405" class="difflineplus">+          (&quot;CMapiImp::SendDocument using flags %d\n&quot;, aFlags));</span>
<a href="#l8.406"></a><span id="l8.406" class="difflineplus">+  /** create nsIMsgCompFields obj and populate it **/</span>
<a href="#l8.407"></a><span id="l8.407" class="difflineplus">+  nsCOMPtr&lt;nsIMsgCompFields&gt; pCompFields =</span>
<a href="#l8.408"></a><span id="l8.408" class="difflineplus">+      do_CreateInstance(NS_MSGCOMPFIELDS_CONTRACTID, &amp;rv);</span>
<a href="#l8.409"></a><span id="l8.409" class="difflineplus">+  if (NS_FAILED(rv) || (!pCompFields)) return MAPI_E_INSUFFICIENT_MEMORY;</span>
<a href="#l8.410"></a><span id="l8.410"> </span>
<a href="#l8.411"></a><span id="l8.411" class="difflineminus">-    if (aFilePaths)</span>
<a href="#l8.412"></a><span id="l8.412" class="difflineminus">-    {</span>
<a href="#l8.413"></a><span id="l8.413" class="difflineminus">-        rv = nsMapiHook::PopulateCompFieldsForSendDocs(pCompFields, aFlags, aDelimChar, aFilePaths) ;</span>
<a href="#l8.414"></a><span id="l8.414" class="difflineminus">-    }</span>
<a href="#l8.415"></a><span id="l8.415" class="difflineplus">+  if (aFilePaths) {</span>
<a href="#l8.416"></a><span id="l8.416" class="difflineplus">+    rv = nsMapiHook::PopulateCompFieldsForSendDocs(pCompFields, aFlags,</span>
<a href="#l8.417"></a><span id="l8.417" class="difflineplus">+                                                   aDelimChar, aFilePaths);</span>
<a href="#l8.418"></a><span id="l8.418" class="difflineplus">+  }</span>
<a href="#l8.419"></a><span id="l8.419"> </span>
<a href="#l8.420"></a><span id="l8.420" class="difflineminus">-    if (NS_SUCCEEDED (rv))</span>
<a href="#l8.421"></a><span id="l8.421" class="difflineminus">-        rv = nsMapiHook::ShowComposerWindow(aSession, pCompFields);</span>
<a href="#l8.422"></a><span id="l8.422" class="difflineminus">-    else</span>
<a href="#l8.423"></a><span id="l8.423" class="difflineminus">-      MOZ_LOG(MAPI, mozilla::LogLevel::Debug, (&quot;CMapiImp::SendDocument error rv = %lx, paths = %s names = %s\n&quot;, rv, aFilePaths, aFileNames));</span>
<a href="#l8.424"></a><span id="l8.424" class="difflineplus">+  if (NS_SUCCEEDED(rv))</span>
<a href="#l8.425"></a><span id="l8.425" class="difflineplus">+    rv = nsMapiHook::ShowComposerWindow(aSession, pCompFields);</span>
<a href="#l8.426"></a><span id="l8.426" class="difflineplus">+  else</span>
<a href="#l8.427"></a><span id="l8.427" class="difflineplus">+    MOZ_LOG(MAPI, mozilla::LogLevel::Debug,</span>
<a href="#l8.428"></a><span id="l8.428" class="difflineplus">+            (&quot;CMapiImp::SendDocument error rv = %lx, paths = %s names = %s\n&quot;,</span>
<a href="#l8.429"></a><span id="l8.429" class="difflineplus">+             rv, aFilePaths, aFileNames));</span>
<a href="#l8.430"></a><span id="l8.430"> </span>
<a href="#l8.431"></a><span id="l8.431" class="difflineminus">-    return nsMAPIConfiguration::GetMAPIErrorFromNSError (rv) ;</span>
<a href="#l8.432"></a><span id="l8.432" class="difflineplus">+  return nsMAPIConfiguration::GetMAPIErrorFromNSError(rv);</span>
<a href="#l8.433"></a><span id="l8.433"> }</span>
<a href="#l8.434"></a><span id="l8.434"> </span>
<a href="#l8.435"></a><span id="l8.435" class="difflineminus">-nsresult CMapiImp::GetDefaultInbox(nsIMsgFolder **inboxFolder)</span>
<a href="#l8.436"></a><span id="l8.436" class="difflineminus">-{</span>
<a href="#l8.437"></a><span id="l8.437" class="difflineplus">+nsresult CMapiImp::GetDefaultInbox(nsIMsgFolder **inboxFolder) {</span>
<a href="#l8.438"></a><span id="l8.438">   // get default account</span>
<a href="#l8.439"></a><span id="l8.439">   nsresult rv;</span>
<a href="#l8.440"></a><span id="l8.440" class="difflineminus">-  nsCOMPtr &lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l8.441"></a><span id="l8.441" class="difflineminus">-    do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l8.442"></a><span id="l8.442" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l8.443"></a><span id="l8.443" class="difflineplus">+  nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l8.444"></a><span id="l8.444" class="difflineplus">+      do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l8.445"></a><span id="l8.445" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.446"></a><span id="l8.446"> </span>
<a href="#l8.447"></a><span id="l8.447" class="difflineminus">-  nsCOMPtr &lt;nsIMsgAccount&gt; account;</span>
<a href="#l8.448"></a><span id="l8.448" class="difflineplus">+  nsCOMPtr&lt;nsIMsgAccount&gt; account;</span>
<a href="#l8.449"></a><span id="l8.449">   rv = accountManager-&gt;GetDefaultAccount(getter_AddRefs(account));</span>
<a href="#l8.450"></a><span id="l8.450" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l8.451"></a><span id="l8.451" class="difflineminus">-  if (!account)</span>
<a href="#l8.452"></a><span id="l8.452" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l8.453"></a><span id="l8.453" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.454"></a><span id="l8.454" class="difflineplus">+  if (!account) return NS_ERROR_FAILURE;</span>
<a href="#l8.455"></a><span id="l8.455"> </span>
<a href="#l8.456"></a><span id="l8.456">   // get incoming server</span>
<a href="#l8.457"></a><span id="l8.457" class="difflineminus">-  nsCOMPtr &lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l8.458"></a><span id="l8.458" class="difflineplus">+  nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l8.459"></a><span id="l8.459">   rv = account-&gt;GetIncomingServer(getter_AddRefs(server));</span>
<a href="#l8.460"></a><span id="l8.460" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l8.461"></a><span id="l8.461" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.462"></a><span id="l8.462"> </span>
<a href="#l8.463"></a><span id="l8.463">   nsCString type;</span>
<a href="#l8.464"></a><span id="l8.464">   rv = server-&gt;GetType(type);</span>
<a href="#l8.465"></a><span id="l8.465" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l8.466"></a><span id="l8.466" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.467"></a><span id="l8.467"> </span>
<a href="#l8.468"></a><span id="l8.468">   // we only care about imap and pop3</span>
<a href="#l8.469"></a><span id="l8.469" class="difflineminus">-  if (type.EqualsLiteral(&quot;imap&quot;) || type.EqualsLiteral(&quot;pop3&quot;))</span>
<a href="#l8.470"></a><span id="l8.470" class="difflineminus">-  {</span>
<a href="#l8.471"></a><span id="l8.471" class="difflineplus">+  if (type.EqualsLiteral(&quot;imap&quot;) || type.EqualsLiteral(&quot;pop3&quot;)) {</span>
<a href="#l8.472"></a><span id="l8.472">     // imap and pop3 account should have an Inbox</span>
<a href="#l8.473"></a><span id="l8.473">     nsCOMPtr&lt;nsIMsgFolder&gt; rootMsgFolder;</span>
<a href="#l8.474"></a><span id="l8.474">     rv = server-&gt;GetRootMsgFolder(getter_AddRefs(rootMsgFolder));</span>
<a href="#l8.475"></a><span id="l8.475" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l8.476"></a><span id="l8.476" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.477"></a><span id="l8.477"> </span>
<a href="#l8.478"></a><span id="l8.478" class="difflineminus">-    if (!rootMsgFolder)</span>
<a href="#l8.479"></a><span id="l8.479" class="difflineminus">-      return NS_ERROR_FAILURE;</span>
<a href="#l8.480"></a><span id="l8.480" class="difflineplus">+    if (!rootMsgFolder) return NS_ERROR_FAILURE;</span>
<a href="#l8.481"></a><span id="l8.481"> </span>
<a href="#l8.482"></a><span id="l8.482">     rootMsgFolder-&gt;GetFolderWithFlags(nsMsgFolderFlags::Inbox, inboxFolder);</span>
<a href="#l8.483"></a><span id="l8.483" class="difflineminus">-    if (!*inboxFolder)</span>
<a href="#l8.484"></a><span id="l8.484" class="difflineminus">-     return NS_ERROR_FAILURE;</span>
<a href="#l8.485"></a><span id="l8.485" class="difflineminus">-</span>
<a href="#l8.486"></a><span id="l8.486" class="difflineplus">+    if (!*inboxFolder) return NS_ERROR_FAILURE;</span>
<a href="#l8.487"></a><span id="l8.487">   }</span>
<a href="#l8.488"></a><span id="l8.488">   return NS_OK;</span>
<a href="#l8.489"></a><span id="l8.489"> }</span>
<a href="#l8.490"></a><span id="l8.490"> </span>
<a href="#l8.491"></a><span id="l8.491"> //*****************************************************************************</span>
<a href="#l8.492"></a><span id="l8.492"> // Encapsulate the XP DB stuff required to enumerate messages</span>
<a href="#l8.493"></a><span id="l8.493"> </span>
<a href="#l8.494"></a><span id="l8.494" class="difflineminus">-class MsgMapiListContext</span>
<a href="#l8.495"></a><span id="l8.495" class="difflineminus">-{</span>
<a href="#l8.496"></a><span id="l8.496" class="difflineminus">-public:</span>
<a href="#l8.497"></a><span id="l8.497" class="difflineminus">-  MsgMapiListContext () {}</span>
<a href="#l8.498"></a><span id="l8.498" class="difflineminus">-  ~MsgMapiListContext ();</span>
<a href="#l8.499"></a><span id="l8.499" class="difflineplus">+class MsgMapiListContext {</span>
<a href="#l8.500"></a><span id="l8.500" class="difflineplus">+ public:</span>
<a href="#l8.501"></a><span id="l8.501" class="difflineplus">+  MsgMapiListContext() {}</span>
<a href="#l8.502"></a><span id="l8.502" class="difflineplus">+  ~MsgMapiListContext();</span>
<a href="#l8.503"></a><span id="l8.503"> </span>
<a href="#l8.504"></a><span id="l8.504" class="difflineminus">-  nsresult OpenDatabase (nsIMsgFolder *folder);</span>
<a href="#l8.505"></a><span id="l8.505" class="difflineplus">+  nsresult OpenDatabase(nsIMsgFolder *folder);</span>
<a href="#l8.506"></a><span id="l8.506"> </span>
<a href="#l8.507"></a><span id="l8.507" class="difflineminus">-  nsMsgKey GetNext ();</span>
<a href="#l8.508"></a><span id="l8.508" class="difflineminus">-  nsresult MarkRead (nsMsgKey key, bool read);</span>
<a href="#l8.509"></a><span id="l8.509" class="difflineplus">+  nsMsgKey GetNext();</span>
<a href="#l8.510"></a><span id="l8.510" class="difflineplus">+  nsresult MarkRead(nsMsgKey key, bool read);</span>
<a href="#l8.511"></a><span id="l8.511"> </span>
<a href="#l8.512"></a><span id="l8.512" class="difflineminus">-  lpnsMapiMessage GetMessage (nsMsgKey, unsigned long flFlags);</span>
<a href="#l8.513"></a><span id="l8.513" class="difflineplus">+  lpnsMapiMessage GetMessage(nsMsgKey, unsigned long flFlags);</span>
<a href="#l8.514"></a><span id="l8.514">   bool IsIMAPHost(void);</span>
<a href="#l8.515"></a><span id="l8.515">   bool DeleteMessage(nsMsgKey key);</span>
<a href="#l8.516"></a><span id="l8.516"> </span>
<a href="#l8.517"></a><span id="l8.517" class="difflineminus">-protected:</span>
<a href="#l8.518"></a><span id="l8.518" class="difflineplus">+ protected:</span>
<a href="#l8.519"></a><span id="l8.519" class="difflineplus">+  char *ConvertDateToMapiFormat(time_t);</span>
<a href="#l8.520"></a><span id="l8.520" class="difflineplus">+  char *ConvertBodyToMapiFormat(nsIMsgDBHdr *hdr);</span>
<a href="#l8.521"></a><span id="l8.521" class="difflineplus">+  void ConvertRecipientsToMapiFormat(</span>
<a href="#l8.522"></a><span id="l8.522" class="difflineplus">+      const nsCOMArray&lt;msgIAddressObject&gt; &amp;ourRecips,</span>
<a href="#l8.523"></a><span id="l8.523" class="difflineplus">+      lpnsMapiRecipDesc mapiRecips, int mapiRecipClass);</span>
<a href="#l8.524"></a><span id="l8.524"> </span>
<a href="#l8.525"></a><span id="l8.525" class="difflineminus">-  char *ConvertDateToMapiFormat (time_t);</span>
<a href="#l8.526"></a><span id="l8.526" class="difflineminus">-  char *ConvertBodyToMapiFormat (nsIMsgDBHdr *hdr);</span>
<a href="#l8.527"></a><span id="l8.527" class="difflineminus">-  void ConvertRecipientsToMapiFormat(const nsCOMArray&lt;msgIAddressObject&gt; &amp;ourRecips,</span>
<a href="#l8.528"></a><span id="l8.528" class="difflineminus">-                                     lpnsMapiRecipDesc mapiRecips,</span>
<a href="#l8.529"></a><span id="l8.529" class="difflineminus">-                                     int mapiRecipClass);</span>
<a href="#l8.530"></a><span id="l8.530" class="difflineminus">-</span>
<a href="#l8.531"></a><span id="l8.531" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFolder&gt; m_folder;</span>
<a href="#l8.532"></a><span id="l8.532" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDatabase&gt; m_db;</span>
<a href="#l8.533"></a><span id="l8.533" class="difflineminus">-  nsCOMPtr &lt;nsISimpleEnumerator&gt; m_msgEnumerator;</span>
<a href="#l8.534"></a><span id="l8.534" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; m_folder;</span>
<a href="#l8.535"></a><span id="l8.535" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDatabase&gt; m_db;</span>
<a href="#l8.536"></a><span id="l8.536" class="difflineplus">+  nsCOMPtr&lt;nsISimpleEnumerator&gt; m_msgEnumerator;</span>
<a href="#l8.537"></a><span id="l8.537"> };</span>
<a href="#l8.538"></a><span id="l8.538"> </span>
<a href="#l8.539"></a><span id="l8.539" class="difflineminus">-</span>
<a href="#l8.540"></a><span id="l8.540" class="difflineminus">-LONG CMapiImp::InitContext(unsigned long session, MsgMapiListContext **listContext)</span>
<a href="#l8.541"></a><span id="l8.541" class="difflineminus">-{</span>
<a href="#l8.542"></a><span id="l8.542" class="difflineminus">-  nsMAPIConfiguration * pMapiConfig = nsMAPIConfiguration::GetMAPIConfiguration() ;</span>
<a href="#l8.543"></a><span id="l8.543" class="difflineminus">-  if (!pMapiConfig)</span>
<a href="#l8.544"></a><span id="l8.544" class="difflineminus">-    return MAPI_E_FAILURE ;  // get the singelton obj</span>
<a href="#l8.545"></a><span id="l8.545" class="difflineminus">-  *listContext = (MsgMapiListContext *) pMapiConfig-&gt;GetMapiListContext(session);</span>
<a href="#l8.546"></a><span id="l8.546" class="difflineplus">+LONG CMapiImp::InitContext(unsigned long session,</span>
<a href="#l8.547"></a><span id="l8.547" class="difflineplus">+                           MsgMapiListContext **listContext) {</span>
<a href="#l8.548"></a><span id="l8.548" class="difflineplus">+  nsMAPIConfiguration *pMapiConfig =</span>
<a href="#l8.549"></a><span id="l8.549" class="difflineplus">+      nsMAPIConfiguration::GetMAPIConfiguration();</span>
<a href="#l8.550"></a><span id="l8.550" class="difflineplus">+  if (!pMapiConfig) return MAPI_E_FAILURE;  // get the singelton obj</span>
<a href="#l8.551"></a><span id="l8.551" class="difflineplus">+  *listContext = (MsgMapiListContext *)pMapiConfig-&gt;GetMapiListContext(session);</span>
<a href="#l8.552"></a><span id="l8.552">   // This is the first message</span>
<a href="#l8.553"></a><span id="l8.553" class="difflineminus">-  if (!*listContext)</span>
<a href="#l8.554"></a><span id="l8.554" class="difflineminus">-  {</span>
<a href="#l8.555"></a><span id="l8.555" class="difflineminus">-    nsCOMPtr &lt;nsIMsgFolder&gt; inboxFolder;</span>
<a href="#l8.556"></a><span id="l8.556" class="difflineplus">+  if (!*listContext) {</span>
<a href="#l8.557"></a><span id="l8.557" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFolder&gt; inboxFolder;</span>
<a href="#l8.558"></a><span id="l8.558">     nsresult rv = GetDefaultInbox(getter_AddRefs(inboxFolder));</span>
<a href="#l8.559"></a><span id="l8.559" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l8.560"></a><span id="l8.560" class="difflineminus">-    {</span>
<a href="#l8.561"></a><span id="l8.561" class="difflineplus">+    if (NS_FAILED(rv)) {</span>
<a href="#l8.562"></a><span id="l8.562">       NS_ASSERTION(false, &quot;in init context, no inbox&quot;);</span>
<a href="#l8.563"></a><span id="l8.563" class="difflineminus">-      return(MAPI_E_NO_MESSAGES);</span>
<a href="#l8.564"></a><span id="l8.564" class="difflineplus">+      return (MAPI_E_NO_MESSAGES);</span>
<a href="#l8.565"></a><span id="l8.565">     }</span>
<a href="#l8.566"></a><span id="l8.566"> </span>
<a href="#l8.567"></a><span id="l8.567">     *listContext = new MsgMapiListContext;</span>
<a href="#l8.568"></a><span id="l8.568" class="difflineminus">-    if (!*listContext)</span>
<a href="#l8.569"></a><span id="l8.569" class="difflineminus">-      return MAPI_E_INSUFFICIENT_MEMORY;</span>
<a href="#l8.570"></a><span id="l8.570" class="difflineplus">+    if (!*listContext) return MAPI_E_INSUFFICIENT_MEMORY;</span>
<a href="#l8.571"></a><span id="l8.571"> </span>
<a href="#l8.572"></a><span id="l8.572">     rv = (*listContext)-&gt;OpenDatabase(inboxFolder);</span>
<a href="#l8.573"></a><span id="l8.573" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l8.574"></a><span id="l8.574" class="difflineminus">-    {</span>
<a href="#l8.575"></a><span id="l8.575" class="difflineplus">+    if (NS_FAILED(rv)) {</span>
<a href="#l8.576"></a><span id="l8.576">       pMapiConfig-&gt;SetMapiListContext(session, NULL);</span>
<a href="#l8.577"></a><span id="l8.577">       delete *listContext;</span>
<a href="#l8.578"></a><span id="l8.578">       NS_ASSERTION(false, &quot;in init context, unable to open db&quot;);</span>
<a href="#l8.579"></a><span id="l8.579">       return MAPI_E_NO_MESSAGES;</span>
<a href="#l8.580"></a><span id="l8.580" class="difflineminus">-    }</span>
<a href="#l8.581"></a><span id="l8.581" class="difflineminus">-    else</span>
<a href="#l8.582"></a><span id="l8.582" class="difflineplus">+    } else</span>
<a href="#l8.583"></a><span id="l8.583">       pMapiConfig-&gt;SetMapiListContext(session, *listContext);</span>
<a href="#l8.584"></a><span id="l8.584">   }</span>
<a href="#l8.585"></a><span id="l8.585">   return SUCCESS_SUCCESS;</span>
<a href="#l8.586"></a><span id="l8.586"> }</span>
<a href="#l8.587"></a><span id="l8.587"> </span>
<a href="#l8.588"></a><span id="l8.588" class="difflineminus">-STDMETHODIMP CMapiImp::FindNext(unsigned long aSession, unsigned long ulUIParam, LPSTR lpszMessageType,</span>
<a href="#l8.589"></a><span id="l8.589" class="difflineminus">-                                LPSTR lpszSeedMessageID, unsigned long flFlags, unsigned long ulReserved,</span>
<a href="#l8.590"></a><span id="l8.590" class="difflineplus">+STDMETHODIMP CMapiImp::FindNext(unsigned long aSession, unsigned long ulUIParam,</span>
<a href="#l8.591"></a><span id="l8.591" class="difflineplus">+                                LPSTR lpszMessageType, LPSTR lpszSeedMessageID,</span>
<a href="#l8.592"></a><span id="l8.592" class="difflineplus">+                                unsigned long flFlags, unsigned long ulReserved,</span>
<a href="#l8.593"></a><span id="l8.593">                                 unsigned char lpszMessageID[64])</span>
<a href="#l8.594"></a><span id="l8.594"> </span>
<a href="#l8.595"></a><span id="l8.595"> {</span>
<a href="#l8.596"></a><span id="l8.596">   //</span>
<a href="#l8.597"></a><span id="l8.597">   // If this is true, then this is the first call to this FindNext function</span>
<a href="#l8.598"></a><span id="l8.598">   // and we should start the enumeration operation.</span>
<a href="#l8.599"></a><span id="l8.599">   //</span>
<a href="#l8.600"></a><span id="l8.600"> </span>
<a href="#l8.601"></a><span id="l8.601">   *lpszMessageID = '\0';</span>
<a href="#l8.602"></a><span id="l8.602" class="difflineminus">-  nsMAPIConfiguration * pMapiConfig = nsMAPIConfiguration::GetMAPIConfiguration() ;</span>
<a href="#l8.603"></a><span id="l8.603" class="difflineminus">-  if (!pMapiConfig)</span>
<a href="#l8.604"></a><span id="l8.604" class="difflineminus">-  {</span>
<a href="#l8.605"></a><span id="l8.605" class="difflineplus">+  nsMAPIConfiguration *pMapiConfig =</span>
<a href="#l8.606"></a><span id="l8.606" class="difflineplus">+      nsMAPIConfiguration::GetMAPIConfiguration();</span>
<a href="#l8.607"></a><span id="l8.607" class="difflineplus">+  if (!pMapiConfig) {</span>
<a href="#l8.608"></a><span id="l8.608">     NS_ASSERTION(false, &quot;failed to get config in findnext&quot;);</span>
<a href="#l8.609"></a><span id="l8.609" class="difflineminus">-    return MAPI_E_FAILURE ;  // get the singelton obj</span>
<a href="#l8.610"></a><span id="l8.610" class="difflineplus">+    return MAPI_E_FAILURE;  // get the singelton obj</span>
<a href="#l8.611"></a><span id="l8.611">   }</span>
<a href="#l8.612"></a><span id="l8.612">   MsgMapiListContext *listContext;</span>
<a href="#l8.613"></a><span id="l8.613">   LONG ret = InitContext(aSession, &amp;listContext);</span>
<a href="#l8.614"></a><span id="l8.614" class="difflineminus">-  if (ret != SUCCESS_SUCCESS)</span>
<a href="#l8.615"></a><span id="l8.615" class="difflineminus">-  {</span>
<a href="#l8.616"></a><span id="l8.616" class="difflineplus">+  if (ret != SUCCESS_SUCCESS) {</span>
<a href="#l8.617"></a><span id="l8.617">     NS_ASSERTION(false, &quot;init context failed&quot;);</span>
<a href="#l8.618"></a><span id="l8.618">     return ret;</span>
<a href="#l8.619"></a><span id="l8.619">   }</span>
<a href="#l8.620"></a><span id="l8.620">   NS_ASSERTION(listContext, &quot;initContext returned null context&quot;);</span>
<a href="#l8.621"></a><span id="l8.621" class="difflineminus">-  if (listContext)</span>
<a href="#l8.622"></a><span id="l8.622" class="difflineminus">-  {</span>
<a href="#l8.623"></a><span id="l8.623" class="difflineminus">-//    NS_ASSERTION(false, &quot;find next init context succeeded&quot;);</span>
<a href="#l8.624"></a><span id="l8.624" class="difflineplus">+  if (listContext) {</span>
<a href="#l8.625"></a><span id="l8.625" class="difflineplus">+    //    NS_ASSERTION(false, &quot;find next init context succeeded&quot;);</span>
<a href="#l8.626"></a><span id="l8.626">     nsMsgKey nextKey = listContext-&gt;GetNext();</span>
<a href="#l8.627"></a><span id="l8.627" class="difflineminus">-    if (nextKey == nsMsgKey_None)</span>
<a href="#l8.628"></a><span id="l8.628" class="difflineminus">-    {</span>
<a href="#l8.629"></a><span id="l8.629" class="difflineplus">+    if (nextKey == nsMsgKey_None) {</span>
<a href="#l8.630"></a><span id="l8.630">       pMapiConfig-&gt;SetMapiListContext(aSession, NULL);</span>
<a href="#l8.631"></a><span id="l8.631">       delete listContext;</span>
<a href="#l8.632"></a><span id="l8.632" class="difflineminus">-      return(MAPI_E_NO_MESSAGES);</span>
<a href="#l8.633"></a><span id="l8.633" class="difflineplus">+      return (MAPI_E_NO_MESSAGES);</span>
<a href="#l8.634"></a><span id="l8.634">     }</span>
<a href="#l8.635"></a><span id="l8.635"> </span>
<a href="#l8.636"></a><span id="l8.636" class="difflineminus">-//    TRACE(&quot;MAPI: ProcessMAPIFindNext() Found message id = %d\n&quot;, nextKey);</span>
<a href="#l8.637"></a><span id="l8.637" class="difflineplus">+    //    TRACE(&quot;MAPI: ProcessMAPIFindNext() Found message id = %d\n&quot;, nextKey);</span>
<a href="#l8.638"></a><span id="l8.638"> </span>
<a href="#l8.639"></a><span id="l8.639" class="difflineminus">-    sprintf((char *) lpszMessageID, &quot;%d&quot;, nextKey);</span>
<a href="#l8.640"></a><span id="l8.640" class="difflineplus">+    sprintf((char *)lpszMessageID, &quot;%d&quot;, nextKey);</span>
<a href="#l8.641"></a><span id="l8.641">   }</span>
<a href="#l8.642"></a><span id="l8.642"> </span>
<a href="#l8.643"></a><span id="l8.643" class="difflineminus">-  MOZ_LOG(MAPI, mozilla::LogLevel::Debug, (&quot;CMapiImp::FindNext returning key %s\n&quot;, (char *) lpszMessageID));</span>
<a href="#l8.644"></a><span id="l8.644" class="difflineminus">-  return(SUCCESS_SUCCESS);</span>
<a href="#l8.645"></a><span id="l8.645" class="difflineplus">+  MOZ_LOG(MAPI, mozilla::LogLevel::Debug,</span>
<a href="#l8.646"></a><span id="l8.646" class="difflineplus">+          (&quot;CMapiImp::FindNext returning key %s\n&quot;, (char *)lpszMessageID));</span>
<a href="#l8.647"></a><span id="l8.647" class="difflineplus">+  return (SUCCESS_SUCCESS);</span>
<a href="#l8.648"></a><span id="l8.648"> }</span>
<a href="#l8.649"></a><span id="l8.649"> </span>
<a href="#l8.650"></a><span id="l8.650" class="difflineminus">-STDMETHODIMP CMapiImp::ReadMail(unsigned long aSession, unsigned long ulUIParam, LPSTR lpszMessageID,</span>
<a href="#l8.651"></a><span id="l8.651" class="difflineminus">-                                unsigned long flFlags, unsigned long ulReserved, lpnsMapiMessage *lppMessage)</span>
<a href="#l8.652"></a><span id="l8.652" class="difflineminus">-{</span>
<a href="#l8.653"></a><span id="l8.653" class="difflineplus">+STDMETHODIMP CMapiImp::ReadMail(unsigned long aSession, unsigned long ulUIParam,</span>
<a href="#l8.654"></a><span id="l8.654" class="difflineplus">+                                LPSTR lpszMessageID, unsigned long flFlags,</span>
<a href="#l8.655"></a><span id="l8.655" class="difflineplus">+                                unsigned long ulReserved,</span>
<a href="#l8.656"></a><span id="l8.656" class="difflineplus">+                                lpnsMapiMessage *lppMessage) {</span>
<a href="#l8.657"></a><span id="l8.657">   nsresult irv;</span>
<a href="#l8.658"></a><span id="l8.658" class="difflineminus">-  nsAutoCString keyString((char *) lpszMessageID);</span>
<a href="#l8.659"></a><span id="l8.659" class="difflineminus">-  MOZ_LOG(MAPI, mozilla::LogLevel::Debug, (&quot;CMapiImp::ReadMail asking for key %s\n&quot;, (char *) lpszMessageID));</span>
<a href="#l8.660"></a><span id="l8.660" class="difflineplus">+  nsAutoCString keyString((char *)lpszMessageID);</span>
<a href="#l8.661"></a><span id="l8.661" class="difflineplus">+  MOZ_LOG(MAPI, mozilla::LogLevel::Debug,</span>
<a href="#l8.662"></a><span id="l8.662" class="difflineplus">+          (&quot;CMapiImp::ReadMail asking for key %s\n&quot;, (char *)lpszMessageID));</span>
<a href="#l8.663"></a><span id="l8.663">   nsMsgKey msgKey = keyString.ToInteger(&amp;irv);</span>
<a href="#l8.664"></a><span id="l8.664" class="difflineminus">-  if (NS_FAILED(irv))</span>
<a href="#l8.665"></a><span id="l8.665" class="difflineminus">-  {</span>
<a href="#l8.666"></a><span id="l8.666" class="difflineplus">+  if (NS_FAILED(irv)) {</span>
<a href="#l8.667"></a><span id="l8.667">     NS_ASSERTION(false, &quot;invalid lpszMessageID&quot;);</span>
<a href="#l8.668"></a><span id="l8.668">     return MAPI_E_INVALID_MESSAGE;</span>
<a href="#l8.669"></a><span id="l8.669">   }</span>
<a href="#l8.670"></a><span id="l8.670">   MsgMapiListContext *listContext;</span>
<a href="#l8.671"></a><span id="l8.671">   LONG ret = InitContext(aSession, &amp;listContext);</span>
<a href="#l8.672"></a><span id="l8.672" class="difflineminus">-  if (ret != SUCCESS_SUCCESS)</span>
<a href="#l8.673"></a><span id="l8.673" class="difflineminus">-  {</span>
<a href="#l8.674"></a><span id="l8.674" class="difflineplus">+  if (ret != SUCCESS_SUCCESS) {</span>
<a href="#l8.675"></a><span id="l8.675">     NS_ASSERTION(false, &quot;init context failed in ReadMail&quot;);</span>
<a href="#l8.676"></a><span id="l8.676">     return ret;</span>
<a href="#l8.677"></a><span id="l8.677">   }</span>
<a href="#l8.678"></a><span id="l8.678" class="difflineminus">-  *lppMessage = listContext-&gt;GetMessage (msgKey, flFlags);</span>
<a href="#l8.679"></a><span id="l8.679" class="difflineplus">+  *lppMessage = listContext-&gt;GetMessage(msgKey, flFlags);</span>
<a href="#l8.680"></a><span id="l8.680">   NS_ASSERTION(*lppMessage, &quot;get message failed&quot;);</span>
<a href="#l8.681"></a><span id="l8.681"> </span>
<a href="#l8.682"></a><span id="l8.682">   return (*lppMessage) ? SUCCESS_SUCCESS : E_FAIL;</span>
<a href="#l8.683"></a><span id="l8.683"> }</span>
<a href="#l8.684"></a><span id="l8.684"> </span>
<a href="#l8.685"></a><span id="l8.685" class="difflineminus">-</span>
<a href="#l8.686"></a><span id="l8.686" class="difflineminus">-STDMETHODIMP CMapiImp::DeleteMail(unsigned long aSession, unsigned long ulUIParam, LPSTR lpszMessageID,</span>
<a href="#l8.687"></a><span id="l8.687" class="difflineminus">-                                  unsigned long flFlags, unsigned long ulReserved)</span>
<a href="#l8.688"></a><span id="l8.688" class="difflineminus">-{</span>
<a href="#l8.689"></a><span id="l8.689" class="difflineplus">+STDMETHODIMP CMapiImp::DeleteMail(unsigned long aSession,</span>
<a href="#l8.690"></a><span id="l8.690" class="difflineplus">+                                  unsigned long ulUIParam, LPSTR lpszMessageID,</span>
<a href="#l8.691"></a><span id="l8.691" class="difflineplus">+                                  unsigned long flFlags,</span>
<a href="#l8.692"></a><span id="l8.692" class="difflineplus">+                                  unsigned long ulReserved) {</span>
<a href="#l8.693"></a><span id="l8.693">   nsresult irv;</span>
<a href="#l8.694"></a><span id="l8.694" class="difflineminus">-  nsAutoCString keyString((char *) lpszMessageID);</span>
<a href="#l8.695"></a><span id="l8.695" class="difflineplus">+  nsAutoCString keyString((char *)lpszMessageID);</span>
<a href="#l8.696"></a><span id="l8.696">   nsMsgKey msgKey = keyString.ToInteger(&amp;irv);</span>
<a href="#l8.697"></a><span id="l8.697">   // XXX Why do we return success on failure?</span>
<a href="#l8.698"></a><span id="l8.698" class="difflineminus">-  if (NS_FAILED(irv))</span>
<a href="#l8.699"></a><span id="l8.699" class="difflineminus">-    return SUCCESS_SUCCESS;</span>
<a href="#l8.700"></a><span id="l8.700" class="difflineplus">+  if (NS_FAILED(irv)) return SUCCESS_SUCCESS;</span>
<a href="#l8.701"></a><span id="l8.701">   MsgMapiListContext *listContext;</span>
<a href="#l8.702"></a><span id="l8.702">   LONG ret = InitContext(aSession, &amp;listContext);</span>
<a href="#l8.703"></a><span id="l8.703" class="difflineminus">-  if (ret != SUCCESS_SUCCESS)</span>
<a href="#l8.704"></a><span id="l8.704" class="difflineminus">-    return ret;</span>
<a href="#l8.705"></a><span id="l8.705" class="difflineminus">-  return (listContext-&gt;DeleteMessage(msgKey)) ? SUCCESS_SUCCESS : MAPI_E_INVALID_MESSAGE;</span>
<a href="#l8.706"></a><span id="l8.706" class="difflineplus">+  if (ret != SUCCESS_SUCCESS) return ret;</span>
<a href="#l8.707"></a><span id="l8.707" class="difflineplus">+  return (listContext-&gt;DeleteMessage(msgKey)) ? SUCCESS_SUCCESS</span>
<a href="#l8.708"></a><span id="l8.708" class="difflineplus">+                                              : MAPI_E_INVALID_MESSAGE;</span>
<a href="#l8.709"></a><span id="l8.709"> }</span>
<a href="#l8.710"></a><span id="l8.710"> </span>
<a href="#l8.711"></a><span id="l8.711" class="difflineminus">-STDMETHODIMP CMapiImp::SaveMail(unsigned long aSession, unsigned long ulUIParam, lpnsMapiMessage lppMessage,</span>
<a href="#l8.712"></a><span id="l8.712" class="difflineminus">-                                unsigned long flFlags, unsigned long ulReserved, LPSTR lpszMessageID)</span>
<a href="#l8.713"></a><span id="l8.713" class="difflineminus">-{</span>
<a href="#l8.714"></a><span id="l8.714" class="difflineplus">+STDMETHODIMP CMapiImp::SaveMail(unsigned long aSession, unsigned long ulUIParam,</span>
<a href="#l8.715"></a><span id="l8.715" class="difflineplus">+                                lpnsMapiMessage lppMessage,</span>
<a href="#l8.716"></a><span id="l8.716" class="difflineplus">+                                unsigned long flFlags, unsigned long ulReserved,</span>
<a href="#l8.717"></a><span id="l8.717" class="difflineplus">+                                LPSTR lpszMessageID) {</span>
<a href="#l8.718"></a><span id="l8.718">   MsgMapiListContext *listContext;</span>
<a href="#l8.719"></a><span id="l8.719">   LONG ret = InitContext(aSession, &amp;listContext);</span>
<a href="#l8.720"></a><span id="l8.720" class="difflineminus">-  if (ret != SUCCESS_SUCCESS)</span>
<a href="#l8.721"></a><span id="l8.721" class="difflineminus">-    return ret;</span>
<a href="#l8.722"></a><span id="l8.722" class="difflineplus">+  if (ret != SUCCESS_SUCCESS) return ret;</span>
<a href="#l8.723"></a><span id="l8.723">   return S_OK;</span>
<a href="#l8.724"></a><span id="l8.724"> }</span>
<a href="#l8.725"></a><span id="l8.725"> </span>
<a href="#l8.726"></a><span id="l8.726" class="difflineminus">-</span>
<a href="#l8.727"></a><span id="l8.727" class="difflineminus">-STDMETHODIMP CMapiImp::Logoff (unsigned long aSession)</span>
<a href="#l8.728"></a><span id="l8.728" class="difflineminus">-{</span>
<a href="#l8.729"></a><span id="l8.729" class="difflineminus">-    nsMAPIConfiguration *pConfig = nsMAPIConfiguration::GetMAPIConfiguration();</span>
<a href="#l8.730"></a><span id="l8.730" class="difflineplus">+STDMETHODIMP CMapiImp::Logoff(unsigned long aSession) {</span>
<a href="#l8.731"></a><span id="l8.731" class="difflineplus">+  nsMAPIConfiguration *pConfig = nsMAPIConfiguration::GetMAPIConfiguration();</span>
<a href="#l8.732"></a><span id="l8.732"> </span>
<a href="#l8.733"></a><span id="l8.733" class="difflineminus">-    if (pConfig-&gt;UnRegisterSession((uint32_t)aSession))</span>
<a href="#l8.734"></a><span id="l8.734" class="difflineminus">-        return S_OK;</span>
<a href="#l8.735"></a><span id="l8.735" class="difflineplus">+  if (pConfig-&gt;UnRegisterSession((uint32_t)aSession)) return S_OK;</span>
<a href="#l8.736"></a><span id="l8.736"> </span>
<a href="#l8.737"></a><span id="l8.737" class="difflineminus">-    return E_FAIL;</span>
<a href="#l8.738"></a><span id="l8.738" class="difflineplus">+  return E_FAIL;</span>
<a href="#l8.739"></a><span id="l8.739"> }</span>
<a href="#l8.740"></a><span id="l8.740"> </span>
<a href="#l8.741"></a><span id="l8.741" class="difflineminus">-STDMETHODIMP CMapiImp::CleanUp()</span>
<a href="#l8.742"></a><span id="l8.742" class="difflineminus">-{</span>
<a href="#l8.743"></a><span id="l8.743" class="difflineminus">-    nsMapiHook::CleanUp();</span>
<a href="#l8.744"></a><span id="l8.744" class="difflineminus">-    return S_OK;</span>
<a href="#l8.745"></a><span id="l8.745" class="difflineplus">+STDMETHODIMP CMapiImp::CleanUp() {</span>
<a href="#l8.746"></a><span id="l8.746" class="difflineplus">+  nsMapiHook::CleanUp();</span>
<a href="#l8.747"></a><span id="l8.747" class="difflineplus">+  return S_OK;</span>
<a href="#l8.748"></a><span id="l8.748"> }</span>
<a href="#l8.749"></a><span id="l8.749"> </span>
<a href="#l8.750"></a><span id="l8.750" class="difflineminus">-</span>
<a href="#l8.751"></a><span id="l8.751" class="difflineminus">-#define           MAX_NAME_LEN    256</span>
<a href="#l8.752"></a><span id="l8.752" class="difflineminus">-</span>
<a href="#l8.753"></a><span id="l8.753" class="difflineplus">+#define MAX_NAME_LEN 256</span>
<a href="#l8.754"></a><span id="l8.754"> </span>
<a href="#l8.755"></a><span id="l8.755" class="difflineminus">-MsgMapiListContext::~MsgMapiListContext ()</span>
<a href="#l8.756"></a><span id="l8.756" class="difflineminus">-{</span>
<a href="#l8.757"></a><span id="l8.757" class="difflineminus">-  if (m_db)</span>
<a href="#l8.758"></a><span id="l8.758" class="difflineminus">-    m_db-&gt;Close(false);</span>
<a href="#l8.759"></a><span id="l8.759" class="difflineplus">+MsgMapiListContext::~MsgMapiListContext() {</span>
<a href="#l8.760"></a><span id="l8.760" class="difflineplus">+  if (m_db) m_db-&gt;Close(false);</span>
<a href="#l8.761"></a><span id="l8.761"> }</span>
<a href="#l8.762"></a><span id="l8.762"> </span>
<a href="#l8.763"></a><span id="l8.763" class="difflineminus">-</span>
<a href="#l8.764"></a><span id="l8.764" class="difflineminus">-nsresult MsgMapiListContext::OpenDatabase (nsIMsgFolder *folder)</span>
<a href="#l8.765"></a><span id="l8.765" class="difflineminus">-{</span>
<a href="#l8.766"></a><span id="l8.766" class="difflineplus">+nsresult MsgMapiListContext::OpenDatabase(nsIMsgFolder *folder) {</span>
<a href="#l8.767"></a><span id="l8.767">   nsresult dbErr = NS_ERROR_FAILURE;</span>
<a href="#l8.768"></a><span id="l8.768" class="difflineminus">-  if (folder)</span>
<a href="#l8.769"></a><span id="l8.769" class="difflineminus">-  {</span>
<a href="#l8.770"></a><span id="l8.770" class="difflineplus">+  if (folder) {</span>
<a href="#l8.771"></a><span id="l8.771">     m_folder = folder;</span>
<a href="#l8.772"></a><span id="l8.772">     dbErr = folder-&gt;GetMsgDatabase(getter_AddRefs(m_db));</span>
<a href="#l8.773"></a><span id="l8.773" class="difflineminus">-    if (m_db)</span>
<a href="#l8.774"></a><span id="l8.774" class="difflineminus">-      dbErr = m_db-&gt;EnumerateMessages(getter_AddRefs(m_msgEnumerator));</span>
<a href="#l8.775"></a><span id="l8.775" class="difflineplus">+    if (m_db) dbErr = m_db-&gt;EnumerateMessages(getter_AddRefs(m_msgEnumerator));</span>
<a href="#l8.776"></a><span id="l8.776">   }</span>
<a href="#l8.777"></a><span id="l8.777">   return dbErr;</span>
<a href="#l8.778"></a><span id="l8.778"> }</span>
<a href="#l8.779"></a><span id="l8.779"> </span>
<a href="#l8.780"></a><span id="l8.780" class="difflineminus">-bool</span>
<a href="#l8.781"></a><span id="l8.781" class="difflineminus">-MsgMapiListContext::IsIMAPHost(void)</span>
<a href="#l8.782"></a><span id="l8.782" class="difflineminus">-{</span>
<a href="#l8.783"></a><span id="l8.783" class="difflineminus">-  if (!m_folder)</span>
<a href="#l8.784"></a><span id="l8.784" class="difflineminus">-    return FALSE;</span>
<a href="#l8.785"></a><span id="l8.785" class="difflineminus">-  nsCOMPtr &lt;nsIMsgImapMailFolder&gt; imapFolder = do_QueryInterface(m_folder);</span>
<a href="#l8.786"></a><span id="l8.786" class="difflineplus">+bool MsgMapiListContext::IsIMAPHost(void) {</span>
<a href="#l8.787"></a><span id="l8.787" class="difflineplus">+  if (!m_folder) return FALSE;</span>
<a href="#l8.788"></a><span id="l8.788" class="difflineplus">+  nsCOMPtr&lt;nsIMsgImapMailFolder&gt; imapFolder = do_QueryInterface(m_folder);</span>
<a href="#l8.789"></a><span id="l8.789"> </span>
<a href="#l8.790"></a><span id="l8.790">   return imapFolder != nullptr;</span>
<a href="#l8.791"></a><span id="l8.791"> }</span>
<a href="#l8.792"></a><span id="l8.792"> </span>
<a href="#l8.793"></a><span id="l8.793" class="difflineminus">-nsMsgKey MsgMapiListContext::GetNext ()</span>
<a href="#l8.794"></a><span id="l8.794" class="difflineminus">-{</span>
<a href="#l8.795"></a><span id="l8.795" class="difflineplus">+nsMsgKey MsgMapiListContext::GetNext() {</span>
<a href="#l8.796"></a><span id="l8.796">   nsMsgKey key = nsMsgKey_None;</span>
<a href="#l8.797"></a><span id="l8.797" class="difflineminus">-  bool      keepTrying = TRUE;</span>
<a href="#l8.798"></a><span id="l8.798" class="difflineplus">+  bool keepTrying = TRUE;</span>
<a href="#l8.799"></a><span id="l8.799"> </span>
<a href="#l8.800"></a><span id="l8.800" class="difflineminus">-//  NS_ASSERTION (m_msgEnumerator &amp;&amp; m_db, &quot;need enumerator and db&quot;);</span>
<a href="#l8.801"></a><span id="l8.801" class="difflineminus">-  if (m_msgEnumerator &amp;&amp; m_db)</span>
<a href="#l8.802"></a><span id="l8.802" class="difflineminus">-  {</span>
<a href="#l8.803"></a><span id="l8.803" class="difflineminus">-</span>
<a href="#l8.804"></a><span id="l8.804" class="difflineminus">-    do</span>
<a href="#l8.805"></a><span id="l8.805" class="difflineminus">-    {</span>
<a href="#l8.806"></a><span id="l8.806" class="difflineplus">+  //  NS_ASSERTION (m_msgEnumerator &amp;&amp; m_db, &quot;need enumerator and db&quot;);</span>
<a href="#l8.807"></a><span id="l8.807" class="difflineplus">+  if (m_msgEnumerator &amp;&amp; m_db) {</span>
<a href="#l8.808"></a><span id="l8.808" class="difflineplus">+    do {</span>
<a href="#l8.809"></a><span id="l8.809">       keepTrying = FALSE;</span>
<a href="#l8.810"></a><span id="l8.810" class="difflineminus">-      nsCOMPtr &lt;nsISupports&gt; hdrISupports;</span>
<a href="#l8.811"></a><span id="l8.811" class="difflineminus">-      nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l8.812"></a><span id="l8.812" class="difflineminus">-      if (NS_SUCCEEDED(m_msgEnumerator-&gt;GetNext(getter_AddRefs(hdrISupports))) &amp;&amp; hdrISupports)</span>
<a href="#l8.813"></a><span id="l8.813" class="difflineminus">-      {</span>
<a href="#l8.814"></a><span id="l8.814" class="difflineplus">+      nsCOMPtr&lt;nsISupports&gt; hdrISupports;</span>
<a href="#l8.815"></a><span id="l8.815" class="difflineplus">+      nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l8.816"></a><span id="l8.816" class="difflineplus">+      if (NS_SUCCEEDED(</span>
<a href="#l8.817"></a><span id="l8.817" class="difflineplus">+              m_msgEnumerator-&gt;GetNext(getter_AddRefs(hdrISupports))) &amp;&amp;</span>
<a href="#l8.818"></a><span id="l8.818" class="difflineplus">+          hdrISupports) {</span>
<a href="#l8.819"></a><span id="l8.819">         msgHdr = do_QueryInterface(hdrISupports);</span>
<a href="#l8.820"></a><span id="l8.820">         msgHdr-&gt;GetMessageKey(&amp;key);</span>
<a href="#l8.821"></a><span id="l8.821"> </span>
<a href="#l8.822"></a><span id="l8.822">         // Check here for IMAP message...if not, just return...</span>
<a href="#l8.823"></a><span id="l8.823" class="difflineminus">-        if (!IsIMAPHost())</span>
<a href="#l8.824"></a><span id="l8.824" class="difflineminus">-          return key;</span>
<a href="#l8.825"></a><span id="l8.825" class="difflineplus">+        if (!IsIMAPHost()) return key;</span>
<a href="#l8.826"></a><span id="l8.826"> </span>
<a href="#l8.827"></a><span id="l8.827">         // If this is an IMAP message, we have to make sure we have a valid</span>
<a href="#l8.828"></a><span id="l8.828">         // body to work with.</span>
<a href="#l8.829"></a><span id="l8.829" class="difflineminus">-        uint32_t  flags = 0;</span>
<a href="#l8.830"></a><span id="l8.830" class="difflineplus">+        uint32_t flags = 0;</span>
<a href="#l8.831"></a><span id="l8.831"> </span>
<a href="#l8.832"></a><span id="l8.832" class="difflineminus">-        (void) msgHdr-&gt;GetFlags(&amp;flags);</span>
<a href="#l8.833"></a><span id="l8.833" class="difflineminus">-        if (flags &amp; nsMsgMessageFlags::Offline)</span>
<a href="#l8.834"></a><span id="l8.834" class="difflineminus">-          return key;</span>
<a href="#l8.835"></a><span id="l8.835" class="difflineplus">+        (void)msgHdr-&gt;GetFlags(&amp;flags);</span>
<a href="#l8.836"></a><span id="l8.836" class="difflineplus">+        if (flags &amp; nsMsgMessageFlags::Offline) return key;</span>
<a href="#l8.837"></a><span id="l8.837"> </span>
<a href="#l8.838"></a><span id="l8.838">         // Ok, if we get here, we have an IMAP message without a body!</span>
<a href="#l8.839"></a><span id="l8.839">         // We need to keep trying by calling the GetNext member recursively...</span>
<a href="#l8.840"></a><span id="l8.840">         keepTrying = TRUE;</span>
<a href="#l8.841"></a><span id="l8.841">       }</span>
<a href="#l8.842"></a><span id="l8.842">     } while (keepTrying);</span>
<a href="#l8.843"></a><span id="l8.843">   }</span>
<a href="#l8.844"></a><span id="l8.844"> </span>
<a href="#l8.845"></a><span id="l8.845">   return key;</span>
<a href="#l8.846"></a><span id="l8.846"> }</span>
<a href="#l8.847"></a><span id="l8.847"> </span>
<a href="#l8.848"></a><span id="l8.848" class="difflineminus">-</span>
<a href="#l8.849"></a><span id="l8.849" class="difflineminus">-nsresult MsgMapiListContext::MarkRead (nsMsgKey key, bool read)</span>
<a href="#l8.850"></a><span id="l8.850" class="difflineminus">-{</span>
<a href="#l8.851"></a><span id="l8.851" class="difflineplus">+nsresult MsgMapiListContext::MarkRead(nsMsgKey key, bool read) {</span>
<a href="#l8.852"></a><span id="l8.852">   nsresult err = NS_ERROR_FAILURE;</span>
<a href="#l8.853"></a><span id="l8.853">   NS_ASSERTION(m_db, &quot;no db&quot;);</span>
<a href="#l8.854"></a><span id="l8.854" class="difflineminus">-  if (m_db)</span>
<a href="#l8.855"></a><span id="l8.855" class="difflineminus">-    err = m_db-&gt;MarkRead (key, read, nullptr);</span>
<a href="#l8.856"></a><span id="l8.856" class="difflineplus">+  if (m_db) err = m_db-&gt;MarkRead(key, read, nullptr);</span>
<a href="#l8.857"></a><span id="l8.857">   return err;</span>
<a href="#l8.858"></a><span id="l8.858"> }</span>
<a href="#l8.859"></a><span id="l8.859"> </span>
<a href="#l8.860"></a><span id="l8.860" class="difflineminus">-</span>
<a href="#l8.861"></a><span id="l8.861" class="difflineminus">-lpnsMapiMessage MsgMapiListContext::GetMessage (nsMsgKey key, unsigned long flFlags)</span>
<a href="#l8.862"></a><span id="l8.862" class="difflineminus">-{</span>
<a href="#l8.863"></a><span id="l8.863" class="difflineminus">-  lpnsMapiMessage message = (lpnsMapiMessage) CoTaskMemAlloc (sizeof(nsMapiMessage));</span>
<a href="#l8.864"></a><span id="l8.864" class="difflineplus">+lpnsMapiMessage MsgMapiListContext::GetMessage(nsMsgKey key,</span>
<a href="#l8.865"></a><span id="l8.865" class="difflineplus">+                                               unsigned long flFlags) {</span>
<a href="#l8.866"></a><span id="l8.866" class="difflineplus">+  lpnsMapiMessage message =</span>
<a href="#l8.867"></a><span id="l8.867" class="difflineplus">+      (lpnsMapiMessage)CoTaskMemAlloc(sizeof(nsMapiMessage));</span>
<a href="#l8.868"></a><span id="l8.868">   memset(message, 0, sizeof(nsMapiMessage));</span>
<a href="#l8.869"></a><span id="l8.869" class="difflineminus">-  if (message)</span>
<a href="#l8.870"></a><span id="l8.870" class="difflineminus">-  {</span>
<a href="#l8.871"></a><span id="l8.871" class="difflineplus">+  if (message) {</span>
<a href="#l8.872"></a><span id="l8.872">     nsCString subject;</span>
<a href="#l8.873"></a><span id="l8.873">     nsCString author;</span>
<a href="#l8.874"></a><span id="l8.874" class="difflineminus">-    nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l8.875"></a><span id="l8.875" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l8.876"></a><span id="l8.876"> </span>
<a href="#l8.877"></a><span id="l8.877" class="difflineminus">-    m_db-&gt;GetMsgHdrForKey (key, getter_AddRefs(msgHdr));</span>
<a href="#l8.878"></a><span id="l8.878" class="difflineminus">-    if (msgHdr)</span>
<a href="#l8.879"></a><span id="l8.879" class="difflineminus">-    {</span>
<a href="#l8.880"></a><span id="l8.880" class="difflineminus">-      msgHdr-&gt;GetSubject (getter_Copies(subject));</span>
<a href="#l8.881"></a><span id="l8.881" class="difflineminus">-      message-&gt;lpszSubject = (char *) CoTaskMemAlloc(subject.Length() + 1);</span>
<a href="#l8.882"></a><span id="l8.882" class="difflineminus">-      strcpy((char *) message-&gt;lpszSubject, subject.get());</span>
<a href="#l8.883"></a><span id="l8.883" class="difflineplus">+    m_db-&gt;GetMsgHdrForKey(key, getter_AddRefs(msgHdr));</span>
<a href="#l8.884"></a><span id="l8.884" class="difflineplus">+    if (msgHdr) {</span>
<a href="#l8.885"></a><span id="l8.885" class="difflineplus">+      msgHdr-&gt;GetSubject(getter_Copies(subject));</span>
<a href="#l8.886"></a><span id="l8.886" class="difflineplus">+      message-&gt;lpszSubject = (char *)CoTaskMemAlloc(subject.Length() + 1);</span>
<a href="#l8.887"></a><span id="l8.887" class="difflineplus">+      strcpy((char *)message-&gt;lpszSubject, subject.get());</span>
<a href="#l8.888"></a><span id="l8.888">       uint32_t date;</span>
<a href="#l8.889"></a><span id="l8.889" class="difflineminus">-      (void) msgHdr-&gt;GetDateInSeconds(&amp;date);</span>
<a href="#l8.890"></a><span id="l8.890" class="difflineminus">-      message-&gt;lpszDateReceived = ConvertDateToMapiFormat (date);</span>
<a href="#l8.891"></a><span id="l8.891" class="difflineplus">+      (void)msgHdr-&gt;GetDateInSeconds(&amp;date);</span>
<a href="#l8.892"></a><span id="l8.892" class="difflineplus">+      message-&gt;lpszDateReceived = ConvertDateToMapiFormat(date);</span>
<a href="#l8.893"></a><span id="l8.893"> </span>
<a href="#l8.894"></a><span id="l8.894">       // Pull out the flags info</span>
<a href="#l8.895"></a><span id="l8.895" class="difflineminus">-      // anything to do with MAPI_SENT? Since we're only reading the Inbox, I guess not</span>
<a href="#l8.896"></a><span id="l8.896" class="difflineplus">+      // anything to do with MAPI_SENT? Since we're only reading the Inbox, I</span>
<a href="#l8.897"></a><span id="l8.897" class="difflineplus">+      // guess not</span>
<a href="#l8.898"></a><span id="l8.898">       uint32_t ourFlags;</span>
<a href="#l8.899"></a><span id="l8.899" class="difflineminus">-      (void) msgHdr-&gt;GetFlags(&amp;ourFlags);</span>
<a href="#l8.900"></a><span id="l8.900" class="difflineplus">+      (void)msgHdr-&gt;GetFlags(&amp;ourFlags);</span>
<a href="#l8.901"></a><span id="l8.901">       if (!(ourFlags &amp; nsMsgMessageFlags::Read))</span>
<a href="#l8.902"></a><span id="l8.902">         message-&gt;flFlags |= MAPI_UNREAD;</span>
<a href="#l8.903"></a><span id="l8.903" class="difflineminus">-      if (ourFlags &amp; (nsMsgMessageFlags::MDNReportNeeded | nsMsgMessageFlags::MDNReportSent))</span>
<a href="#l8.904"></a><span id="l8.904" class="difflineplus">+      if (ourFlags &amp; (nsMsgMessageFlags::MDNReportNeeded |</span>
<a href="#l8.905"></a><span id="l8.905" class="difflineplus">+                      nsMsgMessageFlags::MDNReportSent))</span>
<a href="#l8.906"></a><span id="l8.906">         message-&gt;flFlags |= MAPI_RECEIPT_REQUESTED;</span>
<a href="#l8.907"></a><span id="l8.907"> </span>
<a href="#l8.908"></a><span id="l8.908">       // Pull out the author/originator info</span>
<a href="#l8.909"></a><span id="l8.909" class="difflineminus">-      message-&gt;lpOriginator = (lpnsMapiRecipDesc) CoTaskMemAlloc (sizeof(nsMapiRecipDesc));</span>
<a href="#l8.910"></a><span id="l8.910" class="difflineplus">+      message-&gt;lpOriginator =</span>
<a href="#l8.911"></a><span id="l8.911" class="difflineplus">+          (lpnsMapiRecipDesc)CoTaskMemAlloc(sizeof(nsMapiRecipDesc));</span>
<a href="#l8.912"></a><span id="l8.912">       memset(message-&gt;lpOriginator, 0, sizeof(nsMapiRecipDesc));</span>
<a href="#l8.913"></a><span id="l8.913" class="difflineminus">-      if (message-&gt;lpOriginator)</span>
<a href="#l8.914"></a><span id="l8.914" class="difflineminus">-      {</span>
<a href="#l8.915"></a><span id="l8.915" class="difflineminus">-        msgHdr-&gt;GetAuthor (getter_Copies(author));</span>
<a href="#l8.916"></a><span id="l8.916" class="difflineplus">+      if (message-&gt;lpOriginator) {</span>
<a href="#l8.917"></a><span id="l8.917" class="difflineplus">+        msgHdr-&gt;GetAuthor(getter_Copies(author));</span>
<a href="#l8.918"></a><span id="l8.918">         ConvertRecipientsToMapiFormat(EncodedHeader(author),</span>
<a href="#l8.919"></a><span id="l8.919" class="difflineminus">-          message-&gt;lpOriginator, MAPI_ORIG);</span>
<a href="#l8.920"></a><span id="l8.920" class="difflineplus">+                                      message-&gt;lpOriginator, MAPI_ORIG);</span>
<a href="#l8.921"></a><span id="l8.921">       }</span>
<a href="#l8.922"></a><span id="l8.922">       // Pull out the To/CC info</span>
<a href="#l8.923"></a><span id="l8.923">       nsCString recipients, ccList;</span>
<a href="#l8.924"></a><span id="l8.924">       msgHdr-&gt;GetRecipients(getter_Copies(recipients));</span>
<a href="#l8.925"></a><span id="l8.925">       msgHdr-&gt;GetCcList(getter_Copies(ccList));</span>
<a href="#l8.926"></a><span id="l8.926"> </span>
<a href="#l8.927"></a><span id="l8.927">       nsCOMArray&lt;msgIAddressObject&gt; parsedToRecips = EncodedHeader(recipients);</span>
<a href="#l8.928"></a><span id="l8.928">       nsCOMArray&lt;msgIAddressObject&gt; parsedCCRecips = EncodedHeader(ccList);</span>
<a href="#l8.929"></a><span id="l8.929">       uint32_t numToRecips = parsedToRecips.Length();</span>
<a href="#l8.930"></a><span id="l8.930">       uint32_t numCCRecips = parsedCCRecips.Length();</span>
<a href="#l8.931"></a><span id="l8.931"> </span>
<a href="#l8.932"></a><span id="l8.932" class="difflineminus">-      message-&gt;lpRecips = (lpnsMapiRecipDesc) CoTaskMemAlloc ((numToRecips + numCCRecips) * sizeof(MapiRecipDesc));</span>
<a href="#l8.933"></a><span id="l8.933" class="difflineminus">-      memset(message-&gt;lpRecips, 0, (numToRecips + numCCRecips) * sizeof(MapiRecipDesc));</span>
<a href="#l8.934"></a><span id="l8.934" class="difflineminus">-      if (message-&gt;lpRecips)</span>
<a href="#l8.935"></a><span id="l8.935" class="difflineminus">-      {</span>
<a href="#l8.936"></a><span id="l8.936" class="difflineplus">+      message-&gt;lpRecips = (lpnsMapiRecipDesc)CoTaskMemAlloc(</span>
<a href="#l8.937"></a><span id="l8.937" class="difflineplus">+          (numToRecips + numCCRecips) * sizeof(MapiRecipDesc));</span>
<a href="#l8.938"></a><span id="l8.938" class="difflineplus">+      memset(message-&gt;lpRecips, 0,</span>
<a href="#l8.939"></a><span id="l8.939" class="difflineplus">+             (numToRecips + numCCRecips) * sizeof(MapiRecipDesc));</span>
<a href="#l8.940"></a><span id="l8.940" class="difflineplus">+      if (message-&gt;lpRecips) {</span>
<a href="#l8.941"></a><span id="l8.941">         ConvertRecipientsToMapiFormat(parsedToRecips, message-&gt;lpRecips,</span>
<a href="#l8.942"></a><span id="l8.942" class="difflineminus">-          MAPI_TO);</span>
<a href="#l8.943"></a><span id="l8.943" class="difflineplus">+                                      MAPI_TO);</span>
<a href="#l8.944"></a><span id="l8.944">         ConvertRecipientsToMapiFormat(parsedCCRecips,</span>
<a href="#l8.945"></a><span id="l8.945" class="difflineminus">-          &amp;message-&gt;lpRecips[numToRecips], MAPI_CC);</span>
<a href="#l8.946"></a><span id="l8.946" class="difflineplus">+                                      &amp;message-&gt;lpRecips[numToRecips], MAPI_CC);</span>
<a href="#l8.947"></a><span id="l8.947">       }</span>
<a href="#l8.948"></a><span id="l8.948"> </span>
<a href="#l8.949"></a><span id="l8.949" class="difflineminus">-      MOZ_LOG(MAPI, mozilla::LogLevel::Debug, (&quot;MsgMapiListContext::GetMessage flags=%x subject %s date %s sender %s\n&quot;,</span>
<a href="#l8.950"></a><span id="l8.950" class="difflineminus">-        flFlags, (char *) message-&gt;lpszSubject,(char *) message-&gt;lpszDateReceived, author.get()) );</span>
<a href="#l8.951"></a><span id="l8.951" class="difflineplus">+      MOZ_LOG(MAPI, mozilla::LogLevel::Debug,</span>
<a href="#l8.952"></a><span id="l8.952" class="difflineplus">+              (&quot;MsgMapiListContext::GetMessage flags=%x subject %s date %s &quot;</span>
<a href="#l8.953"></a><span id="l8.953" class="difflineplus">+               &quot;sender %s\n&quot;,</span>
<a href="#l8.954"></a><span id="l8.954" class="difflineplus">+               flFlags, (char *)message-&gt;lpszSubject,</span>
<a href="#l8.955"></a><span id="l8.955" class="difflineplus">+               (char *)message-&gt;lpszDateReceived, author.get()));</span>
<a href="#l8.956"></a><span id="l8.956"> </span>
<a href="#l8.957"></a><span id="l8.957">       // Convert any body text that we have locally</span>
<a href="#l8.958"></a><span id="l8.958">       if (!(flFlags &amp; MAPI_ENVELOPE_ONLY))</span>
<a href="#l8.959"></a><span id="l8.959" class="difflineminus">-        message-&gt;lpszNoteText = (char *) ConvertBodyToMapiFormat (msgHdr);</span>
<a href="#l8.960"></a><span id="l8.960" class="difflineminus">-</span>
<a href="#l8.961"></a><span id="l8.961" class="difflineplus">+        message-&gt;lpszNoteText = (char *)ConvertBodyToMapiFormat(msgHdr);</span>
<a href="#l8.962"></a><span id="l8.962">     }</span>
<a href="#l8.963"></a><span id="l8.963" class="difflineminus">-    if (! (flFlags &amp; (MAPI_PEEK | MAPI_ENVELOPE_ONLY)))</span>
<a href="#l8.964"></a><span id="l8.964" class="difflineplus">+    if (!(flFlags &amp; (MAPI_PEEK | MAPI_ENVELOPE_ONLY)))</span>
<a href="#l8.965"></a><span id="l8.965">       m_db-&gt;MarkRead(key, true, nullptr);</span>
<a href="#l8.966"></a><span id="l8.966">   }</span>
<a href="#l8.967"></a><span id="l8.967">   return message;</span>
<a href="#l8.968"></a><span id="l8.968"> }</span>
<a href="#l8.969"></a><span id="l8.969"> </span>
<a href="#l8.970"></a><span id="l8.970" class="difflineminus">-</span>
<a href="#l8.971"></a><span id="l8.971" class="difflineminus">-char *MsgMapiListContext::ConvertDateToMapiFormat (time_t ourTime)</span>
<a href="#l8.972"></a><span id="l8.972" class="difflineminus">-{</span>
<a href="#l8.973"></a><span id="l8.973" class="difflineminus">-  char *date = (char*) CoTaskMemAlloc(32);</span>
<a href="#l8.974"></a><span id="l8.974" class="difflineminus">-  if (date)</span>
<a href="#l8.975"></a><span id="l8.975" class="difflineminus">-  {</span>
<a href="#l8.976"></a><span id="l8.976" class="difflineplus">+char *MsgMapiListContext::ConvertDateToMapiFormat(time_t ourTime) {</span>
<a href="#l8.977"></a><span id="l8.977" class="difflineplus">+  char *date = (char *)CoTaskMemAlloc(32);</span>
<a href="#l8.978"></a><span id="l8.978" class="difflineplus">+  if (date) {</span>
<a href="#l8.979"></a><span id="l8.979">     // MAPI time format is YYYY/MM/DD HH:MM</span>
<a href="#l8.980"></a><span id="l8.980" class="difflineminus">-    // Note that we're not using XP_StrfTime because that localizes the time format,</span>
<a href="#l8.981"></a><span id="l8.981" class="difflineminus">-    // and the way I read the MAPI spec is that their format is canonical, not localized.</span>
<a href="#l8.982"></a><span id="l8.982" class="difflineminus">-    struct tm *local = localtime (&amp;ourTime);</span>
<a href="#l8.983"></a><span id="l8.983" class="difflineplus">+    // Note that we're not using XP_StrfTime because that localizes the time</span>
<a href="#l8.984"></a><span id="l8.984" class="difflineplus">+    // format, and the way I read the MAPI spec is that their format is</span>
<a href="#l8.985"></a><span id="l8.985" class="difflineplus">+    // canonical, not localized.</span>
<a href="#l8.986"></a><span id="l8.986" class="difflineplus">+    struct tm *local = localtime(&amp;ourTime);</span>
<a href="#l8.987"></a><span id="l8.987">     if (local)</span>
<a href="#l8.988"></a><span id="l8.988" class="difflineminus">-      strftime (date, 32, &quot;%Y/%m/%d %I:%M&quot;, local); //use %H if hours should be 24 hour format</span>
<a href="#l8.989"></a><span id="l8.989" class="difflineplus">+      strftime(date, 32, &quot;%Y/%m/%d %I:%M&quot;,</span>
<a href="#l8.990"></a><span id="l8.990" class="difflineplus">+               local);  // use %H if hours should be 24 hour format</span>
<a href="#l8.991"></a><span id="l8.991">   }</span>
<a href="#l8.992"></a><span id="l8.992">   return date;</span>
<a href="#l8.993"></a><span id="l8.993"> }</span>
<a href="#l8.994"></a><span id="l8.994"> </span>
<a href="#l8.995"></a><span id="l8.995" class="difflineminus">-</span>
<a href="#l8.996"></a><span id="l8.996"> void MsgMapiListContext::ConvertRecipientsToMapiFormat(</span>
<a href="#l8.997"></a><span id="l8.997">     const nsCOMArray&lt;msgIAddressObject&gt; &amp;recipients,</span>
<a href="#l8.998"></a><span id="l8.998" class="difflineminus">-    lpnsMapiRecipDesc mapiRecips, int mapiRecipClass)</span>
<a href="#l8.999"></a><span id="l8.999" class="difflineminus">-{</span>
<a href="#l8.1000"></a><span id="l8.1000" class="difflineplus">+    lpnsMapiRecipDesc mapiRecips, int mapiRecipClass) {</span>
<a href="#l8.1001"></a><span id="l8.1001">   nsTArray&lt;nsCString&gt; names, addresses;</span>
<a href="#l8.1002"></a><span id="l8.1002">   ExtractAllAddresses(recipients, UTF16ArrayAdapter&lt;&gt;(names),</span>
<a href="#l8.1003"></a><span id="l8.1003" class="difflineminus">-    UTF16ArrayAdapter&lt;&gt;(addresses));</span>
<a href="#l8.1004"></a><span id="l8.1004" class="difflineplus">+                      UTF16ArrayAdapter&lt;&gt;(addresses));</span>
<a href="#l8.1005"></a><span id="l8.1005"> </span>
<a href="#l8.1006"></a><span id="l8.1006">   size_t numAddresses = names.Length();</span>
<a href="#l8.1007"></a><span id="l8.1007" class="difflineminus">-  for (size_t i = 0; i &lt; numAddresses; i++)</span>
<a href="#l8.1008"></a><span id="l8.1008" class="difflineminus">-  {</span>
<a href="#l8.1009"></a><span id="l8.1009" class="difflineminus">-    if (!names[i].IsEmpty())</span>
<a href="#l8.1010"></a><span id="l8.1010" class="difflineminus">-    {</span>
<a href="#l8.1011"></a><span id="l8.1011" class="difflineminus">-      mapiRecips[i].lpszName = (char *) CoTaskMemAlloc(names[i].Length() + 1);</span>
<a href="#l8.1012"></a><span id="l8.1012" class="difflineplus">+  for (size_t i = 0; i &lt; numAddresses; i++) {</span>
<a href="#l8.1013"></a><span id="l8.1013" class="difflineplus">+    if (!names[i].IsEmpty()) {</span>
<a href="#l8.1014"></a><span id="l8.1014" class="difflineplus">+      mapiRecips[i].lpszName = (char *)CoTaskMemAlloc(names[i].Length() + 1);</span>
<a href="#l8.1015"></a><span id="l8.1015">       if (mapiRecips[i].lpszName)</span>
<a href="#l8.1016"></a><span id="l8.1016">         strcpy((char *)mapiRecips[i].lpszName, names[i].get());</span>
<a href="#l8.1017"></a><span id="l8.1017">     }</span>
<a href="#l8.1018"></a><span id="l8.1018" class="difflineminus">-    if (!addresses[i].IsEmpty())</span>
<a href="#l8.1019"></a><span id="l8.1019" class="difflineminus">-    {</span>
<a href="#l8.1020"></a><span id="l8.1020" class="difflineminus">-      mapiRecips[i].lpszName = (char *) CoTaskMemAlloc(addresses[i].Length() + 1);</span>
<a href="#l8.1021"></a><span id="l8.1021" class="difflineplus">+    if (!addresses[i].IsEmpty()) {</span>
<a href="#l8.1022"></a><span id="l8.1022" class="difflineplus">+      mapiRecips[i].lpszName =</span>
<a href="#l8.1023"></a><span id="l8.1023" class="difflineplus">+          (char *)CoTaskMemAlloc(addresses[i].Length() + 1);</span>
<a href="#l8.1024"></a><span id="l8.1024">       if (mapiRecips[i].lpszName)</span>
<a href="#l8.1025"></a><span id="l8.1025">         strcpy((char *)mapiRecips[i].lpszName, addresses[i].get());</span>
<a href="#l8.1026"></a><span id="l8.1026">     }</span>
<a href="#l8.1027"></a><span id="l8.1027">     mapiRecips[i].ulRecipClass = mapiRecipClass;</span>
<a href="#l8.1028"></a><span id="l8.1028">   }</span>
<a href="#l8.1029"></a><span id="l8.1029"> }</span>
<a href="#l8.1030"></a><span id="l8.1030"> </span>
<a href="#l8.1031"></a><span id="l8.1031" class="difflineminus">-</span>
<a href="#l8.1032"></a><span id="l8.1032" class="difflineminus">-char *MsgMapiListContext::ConvertBodyToMapiFormat (nsIMsgDBHdr *hdr)</span>
<a href="#l8.1033"></a><span id="l8.1033" class="difflineminus">-{</span>
<a href="#l8.1034"></a><span id="l8.1034" class="difflineminus">-  const int kBufLen = 64000; // I guess we only return the first 64K of a message.</span>
<a href="#l8.1035"></a><span id="l8.1035" class="difflineminus">-#define EMPTY_MESSAGE_LINE(buf) (buf[0] == '\r' || buf[0] == '\n' || buf[0] == '\0')</span>
<a href="#l8.1036"></a><span id="l8.1036" class="difflineplus">+char *MsgMapiListContext::ConvertBodyToMapiFormat(nsIMsgDBHdr *hdr) {</span>
<a href="#l8.1037"></a><span id="l8.1037" class="difflineplus">+  const int kBufLen =</span>
<a href="#l8.1038"></a><span id="l8.1038" class="difflineplus">+      64000;  // I guess we only return the first 64K of a message.</span>
<a href="#l8.1039"></a><span id="l8.1039" class="difflineplus">+#define EMPTY_MESSAGE_LINE(buf) \</span>
<a href="#l8.1040"></a><span id="l8.1040" class="difflineplus">+  (buf[0] == '\r' || buf[0] == '\n' || buf[0] == '\0')</span>
<a href="#l8.1041"></a><span id="l8.1041"> </span>
<a href="#l8.1042"></a><span id="l8.1042" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFolder&gt; folder;</span>
<a href="#l8.1043"></a><span id="l8.1043" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l8.1044"></a><span id="l8.1044">   hdr-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l8.1045"></a><span id="l8.1045" class="difflineminus">-  if (!folder)</span>
<a href="#l8.1046"></a><span id="l8.1046" class="difflineminus">-    return nullptr;</span>
<a href="#l8.1047"></a><span id="l8.1047" class="difflineplus">+  if (!folder) return nullptr;</span>
<a href="#l8.1048"></a><span id="l8.1048"> </span>
<a href="#l8.1049"></a><span id="l8.1049" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; localFile;</span>
<a href="#l8.1050"></a><span id="l8.1050" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; localFile;</span>
<a href="#l8.1051"></a><span id="l8.1051">   folder-&gt;GetFilePath(getter_AddRefs(localFile));</span>
<a href="#l8.1052"></a><span id="l8.1052"> </span>
<a href="#l8.1053"></a><span id="l8.1053">   nsresult rv;</span>
<a href="#l8.1054"></a><span id="l8.1054" class="difflineminus">-  nsCOMPtr&lt;nsIFileInputStream&gt; fileStream = do_CreateInstance(NS_LOCALFILEINPUTSTREAM_CONTRACTID, &amp;rv);</span>
<a href="#l8.1055"></a><span id="l8.1055" class="difflineplus">+  nsCOMPtr&lt;nsIFileInputStream&gt; fileStream =</span>
<a href="#l8.1056"></a><span id="l8.1056" class="difflineplus">+      do_CreateInstance(NS_LOCALFILEINPUTSTREAM_CONTRACTID, &amp;rv);</span>
<a href="#l8.1057"></a><span id="l8.1057">   NS_ENSURE_SUCCESS(rv, nullptr);</span>
<a href="#l8.1058"></a><span id="l8.1058"> </span>
<a href="#l8.1059"></a><span id="l8.1059" class="difflineminus">-  rv = fileStream-&gt;Init(localFile,  PR_RDONLY, 0664, false);  //just have to read the messages</span>
<a href="#l8.1060"></a><span id="l8.1060" class="difflineplus">+  rv = fileStream-&gt;Init(localFile, PR_RDONLY, 0664,</span>
<a href="#l8.1061"></a><span id="l8.1061" class="difflineplus">+                        false);  // just have to read the messages</span>
<a href="#l8.1062"></a><span id="l8.1062">   NS_ENSURE_SUCCESS(rv, nullptr);</span>
<a href="#l8.1063"></a><span id="l8.1063"> </span>
<a href="#l8.1064"></a><span id="l8.1064" class="difflineminus">-  nsCOMPtr &lt;nsILineInputStream&gt; fileLineStream = do_QueryInterface(fileStream);</span>
<a href="#l8.1065"></a><span id="l8.1065" class="difflineminus">-  if (!fileLineStream)</span>
<a href="#l8.1066"></a><span id="l8.1066" class="difflineminus">-    return nullptr;</span>
<a href="#l8.1067"></a><span id="l8.1067" class="difflineplus">+  nsCOMPtr&lt;nsILineInputStream&gt; fileLineStream = do_QueryInterface(fileStream);</span>
<a href="#l8.1068"></a><span id="l8.1068" class="difflineplus">+  if (!fileLineStream) return nullptr;</span>
<a href="#l8.1069"></a><span id="l8.1069"> </span>
<a href="#l8.1070"></a><span id="l8.1070">   // ### really want to skip past headers...</span>
<a href="#l8.1071"></a><span id="l8.1071">   uint64_t messageOffset;</span>
<a href="#l8.1072"></a><span id="l8.1072">   uint32_t lineCount;</span>
<a href="#l8.1073"></a><span id="l8.1073">   hdr-&gt;GetMessageOffset(&amp;messageOffset);</span>
<a href="#l8.1074"></a><span id="l8.1074">   hdr-&gt;GetLineCount(&amp;lineCount);</span>
<a href="#l8.1075"></a><span id="l8.1075" class="difflineminus">-  nsCOMPtr &lt;nsISeekableStream&gt; seekableStream = do_QueryInterface(fileStream);</span>
<a href="#l8.1076"></a><span id="l8.1076" class="difflineplus">+  nsCOMPtr&lt;nsISeekableStream&gt; seekableStream = do_QueryInterface(fileStream);</span>
<a href="#l8.1077"></a><span id="l8.1077">   seekableStream-&gt;Seek(PR_SEEK_SET, messageOffset);</span>
<a href="#l8.1078"></a><span id="l8.1078">   bool hasMore = true;</span>
<a href="#l8.1079"></a><span id="l8.1079">   nsAutoCString curLine;</span>
<a href="#l8.1080"></a><span id="l8.1080"> </span>
<a href="#l8.1081"></a><span id="l8.1081" class="difflineminus">-  while (hasMore) // advance past message headers</span>
<a href="#l8.1082"></a><span id="l8.1082" class="difflineplus">+  while (hasMore)  // advance past message headers</span>
<a href="#l8.1083"></a><span id="l8.1083">   {</span>
<a href="#l8.1084"></a><span id="l8.1084">     nsresult rv = fileLineStream-&gt;ReadLine(curLine, &amp;hasMore);</span>
<a href="#l8.1085"></a><span id="l8.1085" class="difflineminus">-    if (NS_FAILED(rv) || EMPTY_MESSAGE_LINE(curLine))</span>
<a href="#l8.1086"></a><span id="l8.1086" class="difflineminus">-      break;</span>
<a href="#l8.1087"></a><span id="l8.1087" class="difflineplus">+    if (NS_FAILED(rv) || EMPTY_MESSAGE_LINE(curLine)) break;</span>
<a href="#l8.1088"></a><span id="l8.1088">   }</span>
<a href="#l8.1089"></a><span id="l8.1089">   uint32_t msgSize;</span>
<a href="#l8.1090"></a><span id="l8.1090">   hdr-&gt;GetMessageSize(&amp;msgSize);</span>
<a href="#l8.1091"></a><span id="l8.1091" class="difflineminus">-  if (msgSize &gt; kBufLen)</span>
<a href="#l8.1092"></a><span id="l8.1092" class="difflineminus">-    msgSize = kBufLen - 1;</span>
<a href="#l8.1093"></a><span id="l8.1093" class="difflineplus">+  if (msgSize &gt; kBufLen) msgSize = kBufLen - 1;</span>
<a href="#l8.1094"></a><span id="l8.1094">   // this is too big, since it includes the msg hdr size...oh well</span>
<a href="#l8.1095"></a><span id="l8.1095" class="difflineminus">-  char *body = (char*) CoTaskMemAlloc (msgSize + 1);</span>
<a href="#l8.1096"></a><span id="l8.1096" class="difflineplus">+  char *body = (char *)CoTaskMemAlloc(msgSize + 1);</span>
<a href="#l8.1097"></a><span id="l8.1097"> </span>
<a href="#l8.1098"></a><span id="l8.1098" class="difflineminus">-  if (!body)</span>
<a href="#l8.1099"></a><span id="l8.1099" class="difflineminus">-    return nullptr;</span>
<a href="#l8.1100"></a><span id="l8.1100" class="difflineplus">+  if (!body) return nullptr;</span>
<a href="#l8.1101"></a><span id="l8.1101">   int32_t bytesCopied = 0;</span>
<a href="#l8.1102"></a><span id="l8.1102" class="difflineminus">-  for (hasMore = TRUE; lineCount &gt; 0 &amp;&amp; hasMore &amp;&amp; NS_SUCCEEDED(rv); lineCount--)</span>
<a href="#l8.1103"></a><span id="l8.1103" class="difflineminus">-  {</span>
<a href="#l8.1104"></a><span id="l8.1104" class="difflineplus">+  for (hasMore = TRUE; lineCount &gt; 0 &amp;&amp; hasMore &amp;&amp; NS_SUCCEEDED(rv);</span>
<a href="#l8.1105"></a><span id="l8.1105" class="difflineplus">+       lineCount--) {</span>
<a href="#l8.1106"></a><span id="l8.1106">     rv = fileLineStream-&gt;ReadLine(curLine, &amp;hasMore);</span>
<a href="#l8.1107"></a><span id="l8.1107" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l8.1108"></a><span id="l8.1108" class="difflineminus">-      break;</span>
<a href="#l8.1109"></a><span id="l8.1109" class="difflineplus">+    if (NS_FAILED(rv)) break;</span>
<a href="#l8.1110"></a><span id="l8.1110">     curLine.Append(CRLF);</span>
<a href="#l8.1111"></a><span id="l8.1111">     // make sure we have room left</span>
<a href="#l8.1112"></a><span id="l8.1112" class="difflineminus">-    if (bytesCopied + curLine.Length() &lt; msgSize)</span>
<a href="#l8.1113"></a><span id="l8.1113" class="difflineminus">-    {</span>
<a href="#l8.1114"></a><span id="l8.1114" class="difflineplus">+    if (bytesCopied + curLine.Length() &lt; msgSize) {</span>
<a href="#l8.1115"></a><span id="l8.1115">       strcpy(body + bytesCopied, curLine.get());</span>
<a href="#l8.1116"></a><span id="l8.1116">       bytesCopied += curLine.Length();</span>
<a href="#l8.1117"></a><span id="l8.1117">     }</span>
<a href="#l8.1118"></a><span id="l8.1118">   }</span>
<a href="#l8.1119"></a><span id="l8.1119" class="difflineminus">-  MOZ_LOG(MAPI, mozilla::LogLevel::Debug, (&quot;ConvertBodyToMapiFormat size=%x allocated size %x body = %100.100s\n&quot;,</span>
<a href="#l8.1120"></a><span id="l8.1120" class="difflineminus">-      bytesCopied, msgSize + 1, (char *) body) );</span>
<a href="#l8.1121"></a><span id="l8.1121" class="difflineminus">-  body[bytesCopied] = '\0';   // rhp - fix last line garbage...</span>
<a href="#l8.1122"></a><span id="l8.1122" class="difflineplus">+  MOZ_LOG(</span>
<a href="#l8.1123"></a><span id="l8.1123" class="difflineplus">+      MAPI, mozilla::LogLevel::Debug,</span>
<a href="#l8.1124"></a><span id="l8.1124" class="difflineplus">+      (&quot;ConvertBodyToMapiFormat size=%x allocated size %x body = %100.100s\n&quot;,</span>
<a href="#l8.1125"></a><span id="l8.1125" class="difflineplus">+       bytesCopied, msgSize + 1, (char *)body));</span>
<a href="#l8.1126"></a><span id="l8.1126" class="difflineplus">+  body[bytesCopied] = '\0';  // rhp - fix last line garbage...</span>
<a href="#l8.1127"></a><span id="l8.1127">   return body;</span>
<a href="#l8.1128"></a><span id="l8.1128"> }</span>
<a href="#l8.1129"></a><span id="l8.1129"> </span>
<a href="#l8.1130"></a><span id="l8.1130" class="difflineminus">-</span>
<a href="#l8.1131"></a><span id="l8.1131"> //*****************************************************************************</span>
<a href="#l8.1132"></a><span id="l8.1132"> // MSGMAPI API implementation</span>
<a href="#l8.1133"></a><span id="l8.1133"> </span>
<a href="#l8.1134"></a><span id="l8.1134" class="difflineminus">-</span>
<a href="#l8.1135"></a><span id="l8.1135" class="difflineminus">-</span>
<a href="#l8.1136"></a><span id="l8.1136" class="difflineminus">-static void msg_FreeMAPIFile(lpMapiFileDesc f)</span>
<a href="#l8.1137"></a><span id="l8.1137" class="difflineminus">-{</span>
<a href="#l8.1138"></a><span id="l8.1138" class="difflineminus">-  if (f)</span>
<a href="#l8.1139"></a><span id="l8.1139" class="difflineminus">-  {</span>
<a href="#l8.1140"></a><span id="l8.1140" class="difflineplus">+static void msg_FreeMAPIFile(lpMapiFileDesc f) {</span>
<a href="#l8.1141"></a><span id="l8.1141" class="difflineplus">+  if (f) {</span>
<a href="#l8.1142"></a><span id="l8.1142">     CoTaskMemFree(f-&gt;lpszPathName);</span>
<a href="#l8.1143"></a><span id="l8.1143">     CoTaskMemFree(f-&gt;lpszFileName);</span>
<a href="#l8.1144"></a><span id="l8.1144">   }</span>
<a href="#l8.1145"></a><span id="l8.1145"> }</span>
<a href="#l8.1146"></a><span id="l8.1146"> </span>
<a href="#l8.1147"></a><span id="l8.1147" class="difflineminus">-static void msg_FreeMAPIRecipient(lpMapiRecipDesc rd)</span>
<a href="#l8.1148"></a><span id="l8.1148" class="difflineminus">-{</span>
<a href="#l8.1149"></a><span id="l8.1149" class="difflineminus">-  if (rd)</span>
<a href="#l8.1150"></a><span id="l8.1150" class="difflineminus">-  {</span>
<a href="#l8.1151"></a><span id="l8.1151" class="difflineminus">-    if (rd-&gt;lpszName)</span>
<a href="#l8.1152"></a><span id="l8.1152" class="difflineminus">-      CoTaskMemFree(rd-&gt;lpszName);</span>
<a href="#l8.1153"></a><span id="l8.1153" class="difflineminus">-    if (rd-&gt;lpszAddress)</span>
<a href="#l8.1154"></a><span id="l8.1154" class="difflineminus">-      CoTaskMemFree(rd-&gt;lpszAddress);</span>
<a href="#l8.1155"></a><span id="l8.1155" class="difflineplus">+static void msg_FreeMAPIRecipient(lpMapiRecipDesc rd) {</span>
<a href="#l8.1156"></a><span id="l8.1156" class="difflineplus">+  if (rd) {</span>
<a href="#l8.1157"></a><span id="l8.1157" class="difflineplus">+    if (rd-&gt;lpszName) CoTaskMemFree(rd-&gt;lpszName);</span>
<a href="#l8.1158"></a><span id="l8.1158" class="difflineplus">+    if (rd-&gt;lpszAddress) CoTaskMemFree(rd-&gt;lpszAddress);</span>
<a href="#l8.1159"></a><span id="l8.1159">     // CoTaskMemFree(rd-&gt;lpEntryID);</span>
<a href="#l8.1160"></a><span id="l8.1160">   }</span>
<a href="#l8.1161"></a><span id="l8.1161"> }</span>
<a href="#l8.1162"></a><span id="l8.1162"> </span>
<a href="#l8.1163"></a><span id="l8.1163" class="difflineminus">-extern &quot;C&quot; void MSG_FreeMapiMessage (lpMapiMessage msg)</span>
<a href="#l8.1164"></a><span id="l8.1164" class="difflineminus">-{</span>
<a href="#l8.1165"></a><span id="l8.1165" class="difflineplus">+extern &quot;C&quot; void MSG_FreeMapiMessage(lpMapiMessage msg) {</span>
<a href="#l8.1166"></a><span id="l8.1166">   ULONG i;</span>
<a href="#l8.1167"></a><span id="l8.1167"> </span>
<a href="#l8.1168"></a><span id="l8.1168" class="difflineminus">-  if (msg)</span>
<a href="#l8.1169"></a><span id="l8.1169" class="difflineminus">-  {</span>
<a href="#l8.1170"></a><span id="l8.1170" class="difflineplus">+  if (msg) {</span>
<a href="#l8.1171"></a><span id="l8.1171">     CoTaskMemFree(msg-&gt;lpszSubject);</span>
<a href="#l8.1172"></a><span id="l8.1172">     CoTaskMemFree(msg-&gt;lpszNoteText);</span>
<a href="#l8.1173"></a><span id="l8.1173">     CoTaskMemFree(msg-&gt;lpszMessageType);</span>
<a href="#l8.1174"></a><span id="l8.1174">     CoTaskMemFree(msg-&gt;lpszDateReceived);</span>
<a href="#l8.1175"></a><span id="l8.1175">     CoTaskMemFree(msg-&gt;lpszConversationID);</span>
<a href="#l8.1176"></a><span id="l8.1176"> </span>
<a href="#l8.1177"></a><span id="l8.1177" class="difflineminus">-    if (msg-&gt;lpOriginator)</span>
<a href="#l8.1178"></a><span id="l8.1178" class="difflineminus">-      msg_FreeMAPIRecipient(msg-&gt;lpOriginator);</span>
<a href="#l8.1179"></a><span id="l8.1179" class="difflineplus">+    if (msg-&gt;lpOriginator) msg_FreeMAPIRecipient(msg-&gt;lpOriginator);</span>
<a href="#l8.1180"></a><span id="l8.1180"> </span>
<a href="#l8.1181"></a><span id="l8.1181" class="difflineminus">-    for (i=0; i&lt;msg-&gt;nRecipCount; i++)</span>
<a href="#l8.1182"></a><span id="l8.1182" class="difflineplus">+    for (i = 0; i &lt; msg-&gt;nRecipCount; i++)</span>
<a href="#l8.1183"></a><span id="l8.1183">       if (&amp;(msg-&gt;lpRecips[i]) != nullptr)</span>
<a href="#l8.1184"></a><span id="l8.1184">         msg_FreeMAPIRecipient(&amp;(msg-&gt;lpRecips[i]));</span>
<a href="#l8.1185"></a><span id="l8.1185"> </span>
<a href="#l8.1186"></a><span id="l8.1186" class="difflineminus">-      CoTaskMemFree(msg-&gt;lpRecips);</span>
<a href="#l8.1187"></a><span id="l8.1187" class="difflineplus">+    CoTaskMemFree(msg-&gt;lpRecips);</span>
<a href="#l8.1188"></a><span id="l8.1188"> </span>
<a href="#l8.1189"></a><span id="l8.1189" class="difflineminus">-      for (i=0; i&lt;msg-&gt;nFileCount; i++)</span>
<a href="#l8.1190"></a><span id="l8.1190" class="difflineminus">-        if (&amp;(msg-&gt;lpFiles[i]) != nullptr)</span>
<a href="#l8.1191"></a><span id="l8.1191" class="difflineminus">-          msg_FreeMAPIFile(&amp;(msg-&gt;lpFiles[i]));</span>
<a href="#l8.1192"></a><span id="l8.1192" class="difflineplus">+    for (i = 0; i &lt; msg-&gt;nFileCount; i++)</span>
<a href="#l8.1193"></a><span id="l8.1193" class="difflineplus">+      if (&amp;(msg-&gt;lpFiles[i]) != nullptr) msg_FreeMAPIFile(&amp;(msg-&gt;lpFiles[i]));</span>
<a href="#l8.1194"></a><span id="l8.1194"> </span>
<a href="#l8.1195"></a><span id="l8.1195" class="difflineminus">-      CoTaskMemFree(msg-&gt;lpFiles);</span>
<a href="#l8.1196"></a><span id="l8.1196" class="difflineplus">+    CoTaskMemFree(msg-&gt;lpFiles);</span>
<a href="#l8.1197"></a><span id="l8.1197"> </span>
<a href="#l8.1198"></a><span id="l8.1198" class="difflineminus">-      CoTaskMemFree(msg);</span>
<a href="#l8.1199"></a><span id="l8.1199" class="difflineplus">+    CoTaskMemFree(msg);</span>
<a href="#l8.1200"></a><span id="l8.1200">   }</span>
<a href="#l8.1201"></a><span id="l8.1201"> }</span>
<a href="#l8.1202"></a><span id="l8.1202"> </span>
<a href="#l8.1203"></a><span id="l8.1203" class="difflineminus">-</span>
<a href="#l8.1204"></a><span id="l8.1204" class="difflineminus">-extern &quot;C&quot; bool MsgMarkMapiMessageRead (nsIMsgFolder *folder, nsMsgKey key, bool read)</span>
<a href="#l8.1205"></a><span id="l8.1205" class="difflineminus">-{</span>
<a href="#l8.1206"></a><span id="l8.1206" class="difflineplus">+extern &quot;C&quot; bool MsgMarkMapiMessageRead(nsIMsgFolder *folder, nsMsgKey key,</span>
<a href="#l8.1207"></a><span id="l8.1207" class="difflineplus">+                                       bool read) {</span>
<a href="#l8.1208"></a><span id="l8.1208">   bool success = FALSE;</span>
<a href="#l8.1209"></a><span id="l8.1209">   MsgMapiListContext *context = new MsgMapiListContext();</span>
<a href="#l8.1210"></a><span id="l8.1210" class="difflineminus">-  if (context)</span>
<a href="#l8.1211"></a><span id="l8.1211" class="difflineminus">-  {</span>
<a href="#l8.1212"></a><span id="l8.1212" class="difflineminus">-    if (NS_SUCCEEDED(context-&gt;OpenDatabase(folder)))</span>
<a href="#l8.1213"></a><span id="l8.1213" class="difflineminus">-    {</span>
<a href="#l8.1214"></a><span id="l8.1214" class="difflineminus">-      if (NS_SUCCEEDED(context-&gt;MarkRead (key, read)))</span>
<a href="#l8.1215"></a><span id="l8.1215" class="difflineminus">-        success = TRUE;</span>
<a href="#l8.1216"></a><span id="l8.1216" class="difflineplus">+  if (context) {</span>
<a href="#l8.1217"></a><span id="l8.1217" class="difflineplus">+    if (NS_SUCCEEDED(context-&gt;OpenDatabase(folder))) {</span>
<a href="#l8.1218"></a><span id="l8.1218" class="difflineplus">+      if (NS_SUCCEEDED(context-&gt;MarkRead(key, read))) success = TRUE;</span>
<a href="#l8.1219"></a><span id="l8.1219">     }</span>
<a href="#l8.1220"></a><span id="l8.1220">     delete context;</span>
<a href="#l8.1221"></a><span id="l8.1221">   }</span>
<a href="#l8.1222"></a><span id="l8.1222">   return success;</span>
<a href="#l8.1223"></a><span id="l8.1223"> }</span>
<a href="#l8.1224"></a><span id="l8.1224"> </span>
<a href="#l8.1225"></a><span id="l8.1225" class="difflineminus">-bool</span>
<a href="#l8.1226"></a><span id="l8.1226" class="difflineminus">-MsgMapiListContext::DeleteMessage(nsMsgKey key)</span>
<a href="#l8.1227"></a><span id="l8.1227" class="difflineminus">-{</span>
<a href="#l8.1228"></a><span id="l8.1228" class="difflineminus">-  if (!m_db)</span>
<a href="#l8.1229"></a><span id="l8.1229" class="difflineminus">-    return FALSE;</span>
<a href="#l8.1230"></a><span id="l8.1230" class="difflineplus">+bool MsgMapiListContext::DeleteMessage(nsMsgKey key) {</span>
<a href="#l8.1231"></a><span id="l8.1231" class="difflineplus">+  if (!m_db) return FALSE;</span>
<a href="#l8.1232"></a><span id="l8.1232"> </span>
<a href="#l8.1233"></a><span id="l8.1233" class="difflineminus">-  if ( !IsIMAPHost() )</span>
<a href="#l8.1234"></a><span id="l8.1234" class="difflineminus">-  {</span>
<a href="#l8.1235"></a><span id="l8.1235" class="difflineplus">+  if (!IsIMAPHost()) {</span>
<a href="#l8.1236"></a><span id="l8.1236">     return NS_SUCCEEDED((m_db-&gt;DeleteMessages(1, &amp;key, nullptr)));</span>
<a href="#l8.1237"></a><span id="l8.1237">   }</span>
<a href="#l8.1238"></a><span id="l8.1238"> #if 0</span>
<a href="#l8.1239"></a><span id="l8.1239">   else if ( m_folder-&gt;GetIMAPFolderInfoMail() )</span>
<a href="#l8.1240"></a><span id="l8.1240">   {</span>
<a href="#l8.1241"></a><span id="l8.1241">     AutoTArray&lt;nsMsgKey, 1&gt; messageKeys;</span>
<a href="#l8.1242"></a><span id="l8.1242">     messageKeys.AppendElement(key);</span>
<a href="#l8.1243"></a><span id="l8.1243"> </span>
<a href="#l8.1244"></a><span id="l8.1244">     (m_folder-&gt;GetIMAPFolderInfoMail())-&gt;DeleteSpecifiedMessages(pane, messageKeys, nsMsgKey_None);</span>
<a href="#l8.1245"></a><span id="l8.1245">     m_db-&gt;DeleteMessage(key, nullptr, FALSE);</span>
<a href="#l8.1246"></a><span id="l8.1246">     return TRUE;</span>
<a href="#l8.1247"></a><span id="l8.1247">   }</span>
<a href="#l8.1248"></a><span id="l8.1248"> #endif</span>
<a href="#l8.1249"></a><span id="l8.1249" class="difflineminus">-  else</span>
<a href="#l8.1250"></a><span id="l8.1250" class="difflineminus">-  {</span>
<a href="#l8.1251"></a><span id="l8.1251" class="difflineplus">+  else {</span>
<a href="#l8.1252"></a><span id="l8.1252">     return FALSE;</span>
<a href="#l8.1253"></a><span id="l8.1253">   }</span>
<a href="#l8.1254"></a><span id="l8.1254"> }</span>
<a href="#l8.1255"></a><span id="l8.1255"> </span>
<a href="#l8.1256"></a><span id="l8.1256"> /* Return TRUE on success, FALSE on failure */</span>
<a href="#l8.1257"></a><span id="l8.1257" class="difflineminus">-extern &quot;C&quot; bool MSG_DeleteMapiMessage(nsIMsgFolder *folder, nsMsgKey key)</span>
<a href="#l8.1258"></a><span id="l8.1258" class="difflineminus">-{</span>
<a href="#l8.1259"></a><span id="l8.1259" class="difflineplus">+extern &quot;C&quot; bool MSG_DeleteMapiMessage(nsIMsgFolder *folder, nsMsgKey key) {</span>
<a href="#l8.1260"></a><span id="l8.1260">   bool success = FALSE;</span>
<a href="#l8.1261"></a><span id="l8.1261">   MsgMapiListContext *context = new MsgMapiListContext();</span>
<a href="#l8.1262"></a><span id="l8.1262" class="difflineminus">-  if (context)</span>
<a href="#l8.1263"></a><span id="l8.1263" class="difflineminus">-  {</span>
<a href="#l8.1264"></a><span id="l8.1264" class="difflineminus">-    if (NS_SUCCEEDED(context-&gt;OpenDatabase(folder)))</span>
<a href="#l8.1265"></a><span id="l8.1265" class="difflineminus">-    {</span>
<a href="#l8.1266"></a><span id="l8.1266" class="difflineplus">+  if (context) {</span>
<a href="#l8.1267"></a><span id="l8.1267" class="difflineplus">+    if (NS_SUCCEEDED(context-&gt;OpenDatabase(folder))) {</span>
<a href="#l8.1268"></a><span id="l8.1268">       success = context-&gt;DeleteMessage(key);</span>
<a href="#l8.1269"></a><span id="l8.1269">     }</span>
<a href="#l8.1270"></a><span id="l8.1270"> </span>
<a href="#l8.1271"></a><span id="l8.1271">     delete context;</span>
<a href="#l8.1272"></a><span id="l8.1272">   }</span>
<a href="#l8.1273"></a><span id="l8.1273"> </span>
<a href="#l8.1274"></a><span id="l8.1274">   return success;</span>
<a href="#l8.1275"></a><span id="l8.1275"> }</span>
<a href="#l8.1276"></a><span id="l8.1276" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/mapi/mapihook/src/msgMapiImp.h</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/mapi/mapihook/src/msgMapiImp.h</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -3,74 +3,77 @@</span>
<a href="#l9.4"></a><span id="l9.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l9.5"></a><span id="l9.5"> </span>
<a href="#l9.6"></a><span id="l9.6"> #ifndef MSG_MAPI_IMP_H</span>
<a href="#l9.7"></a><span id="l9.7"> #define MSG_MAPI_IMP_H</span>
<a href="#l9.8"></a><span id="l9.8"> </span>
<a href="#l9.9"></a><span id="l9.9"> #include &quot;msgMapi.h&quot;</span>
<a href="#l9.10"></a><span id="l9.10"> #include &quot;nspr.h&quot;</span>
<a href="#l9.11"></a><span id="l9.11"> #include &quot;nscore.h&quot;</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-#include &quot;nsISupportsImpl.h&quot; // ThreadSafeAutoRefCnt</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+#include &quot;nsISupportsImpl.h&quot;  // ThreadSafeAutoRefCnt</span>
<a href="#l9.14"></a><span id="l9.14"> </span>
<a href="#l9.15"></a><span id="l9.15"> class nsIMsgFolder;</span>
<a href="#l9.16"></a><span id="l9.16"> class MsgMapiListContext;</span>
<a href="#l9.17"></a><span id="l9.17"> </span>
<a href="#l9.18"></a><span id="l9.18" class="difflineminus">-const CLSID CLSID_CMapiImp = {0x29f458be, 0x8866, 0x11d5, {0xa3, 0xdd, 0x0, 0xb0, 0xd0, 0xf3, 0xba, 0xa7}};</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineplus">+const CLSID CLSID_CMapiImp = {0x29f458be,</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineplus">+                              0x8866,</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineplus">+                              0x11d5,</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineplus">+                              {0xa3, 0xdd, 0x0, 0xb0, 0xd0, 0xf3, 0xba, 0xa7}};</span>
<a href="#l9.23"></a><span id="l9.23"> </span>
<a href="#l9.24"></a><span id="l9.24"> // this class implements the MS COM interface nsIMapi that provides the methods</span>
<a href="#l9.25"></a><span id="l9.25"> // called by mapi32.dll to perform the mail operations as specified by MAPI.</span>
<a href="#l9.26"></a><span id="l9.26"> // These class methods in turn use the Mozilla Mail XPCOM interfaces to do so.</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineminus">-class CMapiImp : public nsIMapi</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineminus">-{</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineminus">-</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineminus">-public :</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineminus">-</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineplus">+class CMapiImp : public nsIMapi {</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineplus">+ public:</span>
<a href="#l9.34"></a><span id="l9.34">   // IUnknown</span>
<a href="#l9.35"></a><span id="l9.35"> </span>
<a href="#l9.36"></a><span id="l9.36" class="difflineminus">-  STDMETHODIMP            QueryInterface(const IID&amp; aIid, void** aPpv);</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineminus">-  STDMETHODIMP_(ULONG)    AddRef();</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineminus">-  STDMETHODIMP_(ULONG)    Release();</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineplus">+  STDMETHODIMP QueryInterface(const IID &amp;aIid, void **aPpv);</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineplus">+  STDMETHODIMP_(ULONG) AddRef();</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineplus">+  STDMETHODIMP_(ULONG) Release();</span>
<a href="#l9.42"></a><span id="l9.42"> </span>
<a href="#l9.43"></a><span id="l9.43">   // Interface INsMapi</span>
<a href="#l9.44"></a><span id="l9.44"> </span>
<a href="#l9.45"></a><span id="l9.45" class="difflineminus">-  STDMETHODIMP Login(unsigned long aUIArg, LPSTR aLogin,</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineminus">-                     LPSTR aPassWord, unsigned long aFlags,</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineminus">-                     unsigned long *aSessionId);</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineplus">+  STDMETHODIMP Login(unsigned long aUIArg, LPSTR aLogin, LPSTR aPassWord,</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineplus">+                     unsigned long aFlags, unsigned long *aSessionId);</span>
<a href="#l9.50"></a><span id="l9.50"> </span>
<a href="#l9.51"></a><span id="l9.51">   STDMETHODIMP SendMail(unsigned long aSession, lpnsMapiMessage aMessage,</span>
<a href="#l9.52"></a><span id="l9.52">                         unsigned long aFlags, unsigned long aReserved);</span>
<a href="#l9.53"></a><span id="l9.53"> </span>
<a href="#l9.54"></a><span id="l9.54">   STDMETHODIMP SendDocuments(unsigned long aSession, LPSTR aDelimChar,</span>
<a href="#l9.55"></a><span id="l9.55">                              LPSTR aFilePaths, LPSTR aFileNames, ULONG aFlags);</span>
<a href="#l9.56"></a><span id="l9.56"> </span>
<a href="#l9.57"></a><span id="l9.57" class="difflineminus">-  STDMETHODIMP FindNext(unsigned long aSession, unsigned long ulUIParam, LPSTR lpszMessageType,</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineminus">-                        LPSTR lpszSeedMessageID, unsigned long flFlags, unsigned long ulReserved,</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineplus">+  STDMETHODIMP FindNext(unsigned long aSession, unsigned long ulUIParam,</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineplus">+                        LPSTR lpszMessageType, LPSTR lpszSeedMessageID,</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineplus">+                        unsigned long flFlags, unsigned long ulReserved,</span>
<a href="#l9.62"></a><span id="l9.62">                         unsigned char lpszMessageID[64]);</span>
<a href="#l9.63"></a><span id="l9.63"> </span>
<a href="#l9.64"></a><span id="l9.64" class="difflineminus">-  STDMETHODIMP ReadMail(unsigned long lhSession, unsigned long ulUIParam, LPSTR lpszMessageID,</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineminus">-                        unsigned long flFlags, unsigned long ulReserved, lpnsMapiMessage *lppMessage);</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineminus">-  STDMETHODIMP DeleteMail(unsigned long lhSession, unsigned long ulUIParam, LPSTR lpszMessageID,</span>
<a href="#l9.67"></a><span id="l9.67" class="difflineminus">-                          unsigned long flFlags, unsigned long ulReserved);</span>
<a href="#l9.68"></a><span id="l9.68" class="difflineminus">-  STDMETHODIMP SaveMail(unsigned long lhSession, unsigned long ulUIParam, lpnsMapiMessage lppMessage,</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineminus">-                        unsigned long flFlags, unsigned long ulReserved, LPSTR lpszMessageID);</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineplus">+  STDMETHODIMP ReadMail(unsigned long lhSession, unsigned long ulUIParam,</span>
<a href="#l9.71"></a><span id="l9.71" class="difflineplus">+                        LPSTR lpszMessageID, unsigned long flFlags,</span>
<a href="#l9.72"></a><span id="l9.72" class="difflineplus">+                        unsigned long ulReserved, lpnsMapiMessage *lppMessage);</span>
<a href="#l9.73"></a><span id="l9.73" class="difflineplus">+  STDMETHODIMP DeleteMail(unsigned long lhSession, unsigned long ulUIParam,</span>
<a href="#l9.74"></a><span id="l9.74" class="difflineplus">+                          LPSTR lpszMessageID, unsigned long flFlags,</span>
<a href="#l9.75"></a><span id="l9.75" class="difflineplus">+                          unsigned long ulReserved);</span>
<a href="#l9.76"></a><span id="l9.76" class="difflineplus">+  STDMETHODIMP SaveMail(unsigned long lhSession, unsigned long ulUIParam,</span>
<a href="#l9.77"></a><span id="l9.77" class="difflineplus">+                        lpnsMapiMessage lppMessage, unsigned long flFlags,</span>
<a href="#l9.78"></a><span id="l9.78" class="difflineplus">+                        unsigned long ulReserved, LPSTR lpszMessageID);</span>
<a href="#l9.79"></a><span id="l9.79"> </span>
<a href="#l9.80"></a><span id="l9.80">   STDMETHODIMP Initialize();</span>
<a href="#l9.81"></a><span id="l9.81">   STDMETHODIMP IsValid();</span>
<a href="#l9.82"></a><span id="l9.82">   STDMETHODIMP IsValidSession(unsigned long aSession);</span>
<a href="#l9.83"></a><span id="l9.83"> </span>
<a href="#l9.84"></a><span id="l9.84">   STDMETHODIMP SendMailW(unsigned long aSession, lpnsMapiMessageW aMessage,</span>
<a href="#l9.85"></a><span id="l9.85">                          unsigned long aFlags, unsigned long aReserved);</span>
<a href="#l9.86"></a><span id="l9.86"> </span>
<a href="#l9.87"></a><span id="l9.87" class="difflineminus">-  STDMETHODIMP Logoff (unsigned long aSession);</span>
<a href="#l9.88"></a><span id="l9.88" class="difflineplus">+  STDMETHODIMP Logoff(unsigned long aSession);</span>
<a href="#l9.89"></a><span id="l9.89">   STDMETHODIMP CleanUp();</span>
<a href="#l9.90"></a><span id="l9.90"> </span>
<a href="#l9.91"></a><span id="l9.91">   CMapiImp();</span>
<a href="#l9.92"></a><span id="l9.92">   virtual ~CMapiImp();</span>
<a href="#l9.93"></a><span id="l9.93"> </span>
<a href="#l9.94"></a><span id="l9.94">   LONG InitContext(unsigned long session, MsgMapiListContext **listContext);</span>
<a href="#l9.95"></a><span id="l9.95">   nsresult GetDefaultInbox(nsIMsgFolder **inboxFolder);</span>
<a href="#l9.96"></a><span id="l9.96"> </span>
<a href="#l9.97"></a><span id="l9.97" class="difflineminus">-private :</span>
<a href="#l9.98"></a><span id="l9.98" class="difflineplus">+ private:</span>
<a href="#l9.99"></a><span id="l9.99">   PRLock *m_Lock;</span>
<a href="#l9.100"></a><span id="l9.100">   mozilla::ThreadSafeAutoRefCnt m_cRef;</span>
<a href="#l9.101"></a><span id="l9.101"> };</span>
<a href="#l9.102"></a><span id="l9.102"> </span>
<a href="#l9.103"></a><span id="l9.103" class="difflineminus">-#endif // MSG_MAPI_IMP_H</span>
<a href="#l9.104"></a><span id="l9.104" class="difflineplus">+#endif  // MSG_MAPI_IMP_H</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/mapi/mapihook/src/msgMapiMain.cpp</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/mapi/mapihook/src/msgMapiMain.cpp</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -9,293 +9,243 @@</span>
<a href="#l10.4"></a><span id="l10.4"> #include &quot;nsComposeStrings.h&quot;</span>
<a href="#l10.5"></a><span id="l10.5"> #include &quot;msgMapiMain.h&quot;</span>
<a href="#l10.6"></a><span id="l10.6"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l10.7"></a><span id="l10.7"> </span>
<a href="#l10.8"></a><span id="l10.8"> nsMAPIConfiguration *nsMAPIConfiguration::m_pSelfRef = nullptr;</span>
<a href="#l10.9"></a><span id="l10.9"> uint32_t nsMAPIConfiguration::session_generator = 0;</span>
<a href="#l10.10"></a><span id="l10.10"> uint32_t nsMAPIConfiguration::sessionCount = 0;</span>
<a href="#l10.11"></a><span id="l10.11"> </span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-nsMAPIConfiguration *nsMAPIConfiguration::GetMAPIConfiguration()</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-{</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineminus">-  if (m_pSelfRef == nullptr)</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineminus">-    m_pSelfRef = new nsMAPIConfiguration();</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+nsMAPIConfiguration *nsMAPIConfiguration::GetMAPIConfiguration() {</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineplus">+  if (m_pSelfRef == nullptr) m_pSelfRef = new nsMAPIConfiguration();</span>
<a href="#l10.18"></a><span id="l10.18"> </span>
<a href="#l10.19"></a><span id="l10.19">   return m_pSelfRef;</span>
<a href="#l10.20"></a><span id="l10.20"> }</span>
<a href="#l10.21"></a><span id="l10.21"> </span>
<a href="#l10.22"></a><span id="l10.22" class="difflineminus">-nsMAPIConfiguration::nsMAPIConfiguration()</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineminus">-: m_nMaxSessions(MAX_SESSIONS)</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineminus">-{</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineplus">+nsMAPIConfiguration::nsMAPIConfiguration() : m_nMaxSessions(MAX_SESSIONS) {</span>
<a href="#l10.26"></a><span id="l10.26">   m_Lock = PR_NewLock();</span>
<a href="#l10.27"></a><span id="l10.27"> }</span>
<a href="#l10.28"></a><span id="l10.28"> </span>
<a href="#l10.29"></a><span id="l10.29" class="difflineminus">-nsMAPIConfiguration::~nsMAPIConfiguration()</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineminus">-{</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineminus">-  if (m_Lock)</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineminus">-    PR_DestroyLock(m_Lock);</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineplus">+nsMAPIConfiguration::~nsMAPIConfiguration() {</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineplus">+  if (m_Lock) PR_DestroyLock(m_Lock);</span>
<a href="#l10.35"></a><span id="l10.35"> }</span>
<a href="#l10.36"></a><span id="l10.36"> </span>
<a href="#l10.37"></a><span id="l10.37" class="difflineminus">-void nsMAPIConfiguration::OpenConfiguration()</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineminus">-{</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineplus">+void nsMAPIConfiguration::OpenConfiguration() {</span>
<a href="#l10.40"></a><span id="l10.40">   // No. of max. sessions is set to MAX_SESSIONS.  In future</span>
<a href="#l10.41"></a><span id="l10.41">   // if it is decided to have configuration (registry)</span>
<a href="#l10.42"></a><span id="l10.42">   // parameter, this function can be used to set the</span>
<a href="#l10.43"></a><span id="l10.43">   // max sessions;</span>
<a href="#l10.44"></a><span id="l10.44"> </span>
<a href="#l10.45"></a><span id="l10.45">   return;</span>
<a href="#l10.46"></a><span id="l10.46"> }</span>
<a href="#l10.47"></a><span id="l10.47"> </span>
<a href="#l10.48"></a><span id="l10.48" class="difflineminus">-int16_t nsMAPIConfiguration::RegisterSession(uint32_t aHwnd,</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineminus">-                const nsCString&amp; aUserName, const nsCString&amp; aPassword,</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineminus">-                bool aForceDownLoad, bool aNewSession,</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineminus">-                uint32_t *aSession, const char *aIdKey)</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineminus">-{</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineplus">+int16_t nsMAPIConfiguration::RegisterSession(</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineplus">+    uint32_t aHwnd, const nsCString &amp;aUserName, const nsCString &amp;aPassword,</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineplus">+    bool aForceDownLoad, bool aNewSession, uint32_t *aSession,</span>
<a href="#l10.56"></a><span id="l10.56" class="difflineplus">+    const char *aIdKey) {</span>
<a href="#l10.57"></a><span id="l10.57">   int16_t nResult = 0;</span>
<a href="#l10.58"></a><span id="l10.58">   uint32_t n_SessionId = 0;</span>
<a href="#l10.59"></a><span id="l10.59"> </span>
<a href="#l10.60"></a><span id="l10.60">   PR_Lock(m_Lock);</span>
<a href="#l10.61"></a><span id="l10.61"> </span>
<a href="#l10.62"></a><span id="l10.62">   // Check whether max sessions is exceeded</span>
<a href="#l10.63"></a><span id="l10.63"> </span>
<a href="#l10.64"></a><span id="l10.64" class="difflineminus">-  if (sessionCount &gt;= m_nMaxSessions)</span>
<a href="#l10.65"></a><span id="l10.65" class="difflineminus">-  {</span>
<a href="#l10.66"></a><span id="l10.66" class="difflineplus">+  if (sessionCount &gt;= m_nMaxSessions) {</span>
<a href="#l10.67"></a><span id="l10.67">     PR_Unlock(m_Lock);</span>
<a href="#l10.68"></a><span id="l10.68">     return -1;</span>
<a href="#l10.69"></a><span id="l10.69">   }</span>
<a href="#l10.70"></a><span id="l10.70"> </span>
<a href="#l10.71"></a><span id="l10.71" class="difflineminus">-  if (!aUserName.IsEmpty())</span>
<a href="#l10.72"></a><span id="l10.72" class="difflineminus">-    m_ProfileMap.Get(aUserName, &amp;n_SessionId);</span>
<a href="#l10.73"></a><span id="l10.73" class="difflineplus">+  if (!aUserName.IsEmpty()) m_ProfileMap.Get(aUserName, &amp;n_SessionId);</span>
<a href="#l10.74"></a><span id="l10.74"> </span>
<a href="#l10.75"></a><span id="l10.75">   // try to share a session; if not create a session</span>
<a href="#l10.76"></a><span id="l10.76" class="difflineminus">-  if (n_SessionId &gt; 0)</span>
<a href="#l10.77"></a><span id="l10.77" class="difflineminus">-  {</span>
<a href="#l10.78"></a><span id="l10.78" class="difflineplus">+  if (n_SessionId &gt; 0) {</span>
<a href="#l10.79"></a><span id="l10.79">     nsMAPISession *pTemp = nullptr;</span>
<a href="#l10.80"></a><span id="l10.80">     m_SessionMap.Get(n_SessionId, &amp;pTemp);</span>
<a href="#l10.81"></a><span id="l10.81" class="difflineminus">-    if (pTemp != nullptr)</span>
<a href="#l10.82"></a><span id="l10.82" class="difflineminus">-    {</span>
<a href="#l10.83"></a><span id="l10.83" class="difflineplus">+    if (pTemp != nullptr) {</span>
<a href="#l10.84"></a><span id="l10.84">       pTemp-&gt;IncrementSession();</span>
<a href="#l10.85"></a><span id="l10.85">       *aSession = n_SessionId;</span>
<a href="#l10.86"></a><span id="l10.86">       nResult = 1;</span>
<a href="#l10.87"></a><span id="l10.87">     }</span>
<a href="#l10.88"></a><span id="l10.88" class="difflineminus">-  }</span>
<a href="#l10.89"></a><span id="l10.89" class="difflineminus">-  else if (aNewSession || n_SessionId == 0) // checking for n_SessionId is a concession</span>
<a href="#l10.90"></a><span id="l10.90" class="difflineplus">+  } else if (aNewSession ||</span>
<a href="#l10.91"></a><span id="l10.91" class="difflineplus">+             n_SessionId == 0)  // checking for n_SessionId is a concession</span>
<a href="#l10.92"></a><span id="l10.92">   {</span>
<a href="#l10.93"></a><span id="l10.93">     // create a new session; if new session is specified OR there is no session</span>
<a href="#l10.94"></a><span id="l10.94">     nsMAPISession *pTemp = nullptr;</span>
<a href="#l10.95"></a><span id="l10.95" class="difflineminus">-    pTemp = new nsMAPISession(aHwnd, aUserName, aPassword, aForceDownLoad, aIdKey);</span>
<a href="#l10.96"></a><span id="l10.96" class="difflineplus">+    pTemp =</span>
<a href="#l10.97"></a><span id="l10.97" class="difflineplus">+        new nsMAPISession(aHwnd, aUserName, aPassword, aForceDownLoad, aIdKey);</span>
<a href="#l10.98"></a><span id="l10.98"> </span>
<a href="#l10.99"></a><span id="l10.99" class="difflineminus">-    if (pTemp != nullptr)</span>
<a href="#l10.100"></a><span id="l10.100" class="difflineminus">-    {</span>
<a href="#l10.101"></a><span id="l10.101" class="difflineplus">+    if (pTemp != nullptr) {</span>
<a href="#l10.102"></a><span id="l10.102">       session_generator++;</span>
<a href="#l10.103"></a><span id="l10.103"> </span>
<a href="#l10.104"></a><span id="l10.104">       // I don't think there will be (2 power 32) sessions alive</span>
<a href="#l10.105"></a><span id="l10.105">       // in a cycle.  This is an assumption</span>
<a href="#l10.106"></a><span id="l10.106"> </span>
<a href="#l10.107"></a><span id="l10.107" class="difflineminus">-      if (session_generator == 0)</span>
<a href="#l10.108"></a><span id="l10.108" class="difflineminus">-          session_generator++;</span>
<a href="#l10.109"></a><span id="l10.109" class="difflineplus">+      if (session_generator == 0) session_generator++;</span>
<a href="#l10.110"></a><span id="l10.110">       m_SessionMap.Put(session_generator, pTemp);</span>
<a href="#l10.111"></a><span id="l10.111" class="difflineminus">-      if (!aUserName.IsEmpty())</span>
<a href="#l10.112"></a><span id="l10.112" class="difflineminus">-        m_ProfileMap.Put(aUserName, session_generator);</span>
<a href="#l10.113"></a><span id="l10.113" class="difflineplus">+      if (!aUserName.IsEmpty()) m_ProfileMap.Put(aUserName, session_generator);</span>
<a href="#l10.114"></a><span id="l10.114">       *aSession = session_generator;</span>
<a href="#l10.115"></a><span id="l10.115">       sessionCount++;</span>
<a href="#l10.116"></a><span id="l10.116">       nResult = 1;</span>
<a href="#l10.117"></a><span id="l10.117">     }</span>
<a href="#l10.118"></a><span id="l10.118">   }</span>
<a href="#l10.119"></a><span id="l10.119"> </span>
<a href="#l10.120"></a><span id="l10.120">   PR_Unlock(m_Lock);</span>
<a href="#l10.121"></a><span id="l10.121">   return nResult;</span>
<a href="#l10.122"></a><span id="l10.122"> }</span>
<a href="#l10.123"></a><span id="l10.123"> </span>
<a href="#l10.124"></a><span id="l10.124" class="difflineminus">-bool nsMAPIConfiguration::UnRegisterSession(uint32_t aSessionID)</span>
<a href="#l10.125"></a><span id="l10.125" class="difflineminus">-{</span>
<a href="#l10.126"></a><span id="l10.126" class="difflineplus">+bool nsMAPIConfiguration::UnRegisterSession(uint32_t aSessionID) {</span>
<a href="#l10.127"></a><span id="l10.127">   bool bResult = false;</span>
<a href="#l10.128"></a><span id="l10.128"> </span>
<a href="#l10.129"></a><span id="l10.129">   PR_Lock(m_Lock);</span>
<a href="#l10.130"></a><span id="l10.130"> </span>
<a href="#l10.131"></a><span id="l10.131" class="difflineminus">-  if (aSessionID != 0)</span>
<a href="#l10.132"></a><span id="l10.132" class="difflineminus">-  {</span>
<a href="#l10.133"></a><span id="l10.133" class="difflineplus">+  if (aSessionID != 0) {</span>
<a href="#l10.134"></a><span id="l10.134">     nsMAPISession *pTemp = nullptr;</span>
<a href="#l10.135"></a><span id="l10.135">     m_SessionMap.Get(aSessionID, &amp;pTemp);</span>
<a href="#l10.136"></a><span id="l10.136"> </span>
<a href="#l10.137"></a><span id="l10.137" class="difflineminus">-    if (pTemp != nullptr)</span>
<a href="#l10.138"></a><span id="l10.138" class="difflineminus">-    {</span>
<a href="#l10.139"></a><span id="l10.139" class="difflineminus">-      if (pTemp-&gt;DecrementSession() == 0)</span>
<a href="#l10.140"></a><span id="l10.140" class="difflineminus">-      {</span>
<a href="#l10.141"></a><span id="l10.141" class="difflineplus">+    if (pTemp != nullptr) {</span>
<a href="#l10.142"></a><span id="l10.142" class="difflineplus">+      if (pTemp-&gt;DecrementSession() == 0) {</span>
<a href="#l10.143"></a><span id="l10.143">         if (pTemp-&gt;m_pProfileName.get() != nullptr)</span>
<a href="#l10.144"></a><span id="l10.144">           m_ProfileMap.Remove(pTemp-&gt;m_pProfileName);</span>
<a href="#l10.145"></a><span id="l10.145">         m_SessionMap.Remove(aSessionID);</span>
<a href="#l10.146"></a><span id="l10.146">         sessionCount--;</span>
<a href="#l10.147"></a><span id="l10.147">         bResult = true;</span>
<a href="#l10.148"></a><span id="l10.148">       }</span>
<a href="#l10.149"></a><span id="l10.149">     }</span>
<a href="#l10.150"></a><span id="l10.150">   }</span>
<a href="#l10.151"></a><span id="l10.151"> </span>
<a href="#l10.152"></a><span id="l10.152">   PR_Unlock(m_Lock);</span>
<a href="#l10.153"></a><span id="l10.153">   return bResult;</span>
<a href="#l10.154"></a><span id="l10.154"> }</span>
<a href="#l10.155"></a><span id="l10.155"> </span>
<a href="#l10.156"></a><span id="l10.156" class="difflineminus">-bool nsMAPIConfiguration::IsSessionValid(uint32_t aSessionID)</span>
<a href="#l10.157"></a><span id="l10.157" class="difflineminus">-{</span>
<a href="#l10.158"></a><span id="l10.158" class="difflineminus">-  if (aSessionID == 0)</span>
<a href="#l10.159"></a><span id="l10.159" class="difflineminus">-    return false;</span>
<a href="#l10.160"></a><span id="l10.160" class="difflineplus">+bool nsMAPIConfiguration::IsSessionValid(uint32_t aSessionID) {</span>
<a href="#l10.161"></a><span id="l10.161" class="difflineplus">+  if (aSessionID == 0) return false;</span>
<a href="#l10.162"></a><span id="l10.162">   bool retValue = false;</span>
<a href="#l10.163"></a><span id="l10.163">   PR_Lock(m_Lock);</span>
<a href="#l10.164"></a><span id="l10.164">   retValue = m_SessionMap.Get(aSessionID, NULL);</span>
<a href="#l10.165"></a><span id="l10.165">   PR_Unlock(m_Lock);</span>
<a href="#l10.166"></a><span id="l10.166">   return retValue;</span>
<a href="#l10.167"></a><span id="l10.167"> }</span>
<a href="#l10.168"></a><span id="l10.168"> </span>
<a href="#l10.169"></a><span id="l10.169" class="difflineminus">-char16_t *nsMAPIConfiguration::GetPassword(uint32_t aSessionID)</span>
<a href="#l10.170"></a><span id="l10.170" class="difflineminus">-{</span>
<a href="#l10.171"></a><span id="l10.171" class="difflineplus">+char16_t *nsMAPIConfiguration::GetPassword(uint32_t aSessionID) {</span>
<a href="#l10.172"></a><span id="l10.172">   char16_t *pResult = nullptr;</span>
<a href="#l10.173"></a><span id="l10.173"> </span>
<a href="#l10.174"></a><span id="l10.174">   PR_Lock(m_Lock);</span>
<a href="#l10.175"></a><span id="l10.175"> </span>
<a href="#l10.176"></a><span id="l10.176" class="difflineminus">-  if (aSessionID != 0)</span>
<a href="#l10.177"></a><span id="l10.177" class="difflineminus">-  {</span>
<a href="#l10.178"></a><span id="l10.178" class="difflineplus">+  if (aSessionID != 0) {</span>
<a href="#l10.179"></a><span id="l10.179">     nsMAPISession *pTemp = nullptr;</span>
<a href="#l10.180"></a><span id="l10.180">     m_SessionMap.Get(aSessionID, &amp;pTemp);</span>
<a href="#l10.181"></a><span id="l10.181"> </span>
<a href="#l10.182"></a><span id="l10.182" class="difflineminus">-    if (pTemp)</span>
<a href="#l10.183"></a><span id="l10.183" class="difflineminus">-      pResult = pTemp-&gt;GetPassword();</span>
<a href="#l10.184"></a><span id="l10.184" class="difflineplus">+    if (pTemp) pResult = pTemp-&gt;GetPassword();</span>
<a href="#l10.185"></a><span id="l10.185">   }</span>
<a href="#l10.186"></a><span id="l10.186">   PR_Unlock(m_Lock);</span>
<a href="#l10.187"></a><span id="l10.187">   return pResult;</span>
<a href="#l10.188"></a><span id="l10.188"> }</span>
<a href="#l10.189"></a><span id="l10.189"> </span>
<a href="#l10.190"></a><span id="l10.190" class="difflineminus">-void *nsMAPIConfiguration::GetMapiListContext(uint32_t aSessionID)</span>
<a href="#l10.191"></a><span id="l10.191" class="difflineminus">-{</span>
<a href="#l10.192"></a><span id="l10.192" class="difflineplus">+void *nsMAPIConfiguration::GetMapiListContext(uint32_t aSessionID) {</span>
<a href="#l10.193"></a><span id="l10.193">   void *pResult = nullptr;</span>
<a href="#l10.194"></a><span id="l10.194"> </span>
<a href="#l10.195"></a><span id="l10.195">   PR_Lock(m_Lock);</span>
<a href="#l10.196"></a><span id="l10.196"> </span>
<a href="#l10.197"></a><span id="l10.197" class="difflineminus">-  if (aSessionID != 0)</span>
<a href="#l10.198"></a><span id="l10.198" class="difflineminus">-  {</span>
<a href="#l10.199"></a><span id="l10.199" class="difflineplus">+  if (aSessionID != 0) {</span>
<a href="#l10.200"></a><span id="l10.200">     nsMAPISession *pTemp = nullptr;</span>
<a href="#l10.201"></a><span id="l10.201">     m_SessionMap.Get(aSessionID, &amp;pTemp);</span>
<a href="#l10.202"></a><span id="l10.202" class="difflineminus">-    if (pTemp)</span>
<a href="#l10.203"></a><span id="l10.203" class="difflineminus">-      pResult = pTemp-&gt;GetMapiListContext();</span>
<a href="#l10.204"></a><span id="l10.204" class="difflineplus">+    if (pTemp) pResult = pTemp-&gt;GetMapiListContext();</span>
<a href="#l10.205"></a><span id="l10.205">   }</span>
<a href="#l10.206"></a><span id="l10.206"> </span>
<a href="#l10.207"></a><span id="l10.207">   PR_Unlock(m_Lock);</span>
<a href="#l10.208"></a><span id="l10.208">   return pResult;</span>
<a href="#l10.209"></a><span id="l10.209"> }</span>
<a href="#l10.210"></a><span id="l10.210"> </span>
<a href="#l10.211"></a><span id="l10.211" class="difflineminus">-void nsMAPIConfiguration::SetMapiListContext(uint32_t aSessionID, void *mapiListContext)</span>
<a href="#l10.212"></a><span id="l10.212" class="difflineminus">-{</span>
<a href="#l10.213"></a><span id="l10.213" class="difflineplus">+void nsMAPIConfiguration::SetMapiListContext(uint32_t aSessionID,</span>
<a href="#l10.214"></a><span id="l10.214" class="difflineplus">+                                             void *mapiListContext) {</span>
<a href="#l10.215"></a><span id="l10.215">   PR_Lock(m_Lock);</span>
<a href="#l10.216"></a><span id="l10.216"> </span>
<a href="#l10.217"></a><span id="l10.217" class="difflineminus">-  if (aSessionID != 0)</span>
<a href="#l10.218"></a><span id="l10.218" class="difflineminus">-  {</span>
<a href="#l10.219"></a><span id="l10.219" class="difflineplus">+  if (aSessionID != 0) {</span>
<a href="#l10.220"></a><span id="l10.220">     nsMAPISession *pTemp = nullptr;</span>
<a href="#l10.221"></a><span id="l10.221">     m_SessionMap.Get(aSessionID, &amp;pTemp);</span>
<a href="#l10.222"></a><span id="l10.222" class="difflineminus">-    if (pTemp)</span>
<a href="#l10.223"></a><span id="l10.223" class="difflineminus">-      pTemp-&gt;SetMapiListContext(mapiListContext);</span>
<a href="#l10.224"></a><span id="l10.224" class="difflineplus">+    if (pTemp) pTemp-&gt;SetMapiListContext(mapiListContext);</span>
<a href="#l10.225"></a><span id="l10.225">   }</span>
<a href="#l10.226"></a><span id="l10.226"> </span>
<a href="#l10.227"></a><span id="l10.227">   PR_Unlock(m_Lock);</span>
<a href="#l10.228"></a><span id="l10.228"> }</span>
<a href="#l10.229"></a><span id="l10.229"> </span>
<a href="#l10.230"></a><span id="l10.230" class="difflineminus">-void nsMAPIConfiguration::GetIdKey(uint32_t aSessionID, nsCString&amp; aKey)</span>
<a href="#l10.231"></a><span id="l10.231" class="difflineminus">-{</span>
<a href="#l10.232"></a><span id="l10.232" class="difflineplus">+void nsMAPIConfiguration::GetIdKey(uint32_t aSessionID, nsCString &amp;aKey) {</span>
<a href="#l10.233"></a><span id="l10.233">   PR_Lock(m_Lock);</span>
<a href="#l10.234"></a><span id="l10.234" class="difflineminus">-  if (aSessionID != 0)</span>
<a href="#l10.235"></a><span id="l10.235" class="difflineminus">-  {</span>
<a href="#l10.236"></a><span id="l10.236" class="difflineplus">+  if (aSessionID != 0) {</span>
<a href="#l10.237"></a><span id="l10.237">     nsMAPISession *pTemp = nullptr;</span>
<a href="#l10.238"></a><span id="l10.238">     m_SessionMap.Get(aSessionID, &amp;pTemp);</span>
<a href="#l10.239"></a><span id="l10.239" class="difflineminus">-    if (pTemp)</span>
<a href="#l10.240"></a><span id="l10.240" class="difflineminus">-      pTemp-&gt;GetIdKey(aKey);</span>
<a href="#l10.241"></a><span id="l10.241" class="difflineplus">+    if (pTemp) pTemp-&gt;GetIdKey(aKey);</span>
<a href="#l10.242"></a><span id="l10.242">   }</span>
<a href="#l10.243"></a><span id="l10.243">   PR_Unlock(m_Lock);</span>
<a href="#l10.244"></a><span id="l10.244">   return;</span>
<a href="#l10.245"></a><span id="l10.245"> }</span>
<a href="#l10.246"></a><span id="l10.246"> </span>
<a href="#l10.247"></a><span id="l10.247"> // util func</span>
<a href="#l10.248"></a><span id="l10.248" class="difflineminus">-HRESULT nsMAPIConfiguration::GetMAPIErrorFromNSError (nsresult res)</span>
<a href="#l10.249"></a><span id="l10.249" class="difflineminus">-{</span>
<a href="#l10.250"></a><span id="l10.250" class="difflineplus">+HRESULT nsMAPIConfiguration::GetMAPIErrorFromNSError(nsresult res) {</span>
<a href="#l10.251"></a><span id="l10.251">   HRESULT hr = SUCCESS_SUCCESS;</span>
<a href="#l10.252"></a><span id="l10.252"> </span>
<a href="#l10.253"></a><span id="l10.253" class="difflineminus">-  if (NS_SUCCEEDED (res)) return hr;</span>
<a href="#l10.254"></a><span id="l10.254" class="difflineplus">+  if (NS_SUCCEEDED(res)) return hr;</span>
<a href="#l10.255"></a><span id="l10.255"> </span>
<a href="#l10.256"></a><span id="l10.256">   // if failure return the related MAPI failure code</span>
<a href="#l10.257"></a><span id="l10.257" class="difflineminus">-  switch (res)</span>
<a href="#l10.258"></a><span id="l10.258" class="difflineminus">-  {</span>
<a href="#l10.259"></a><span id="l10.259" class="difflineminus">-    case NS_MSG_NO_RECIPIENTS :</span>
<a href="#l10.260"></a><span id="l10.260" class="difflineplus">+  switch (res) {</span>
<a href="#l10.261"></a><span id="l10.261" class="difflineplus">+    case NS_MSG_NO_RECIPIENTS:</span>
<a href="#l10.262"></a><span id="l10.262">       hr = MAPI_E_BAD_RECIPTYPE;</span>
<a href="#l10.263"></a><span id="l10.263">       break;</span>
<a href="#l10.264"></a><span id="l10.264" class="difflineminus">-    case NS_ERROR_COULD_NOT_GET_USERS_MAIL_ADDRESS :</span>
<a href="#l10.265"></a><span id="l10.265" class="difflineminus">-    case NS_ERROR_COULD_NOT_GET_SENDERS_IDENTITY :</span>
<a href="#l10.266"></a><span id="l10.266" class="difflineplus">+    case NS_ERROR_COULD_NOT_GET_USERS_MAIL_ADDRESS:</span>
<a href="#l10.267"></a><span id="l10.267" class="difflineplus">+    case NS_ERROR_COULD_NOT_GET_SENDERS_IDENTITY:</span>
<a href="#l10.268"></a><span id="l10.268">       // Something went wrong with the sender. There's no error we can map to</span>
<a href="#l10.269"></a><span id="l10.269">       // so we use a general error, see:</span>
<a href="#l10.270"></a><span id="l10.270">       // https://msdn.microsoft.com/en-us/library/hh802867(v=vs.85).aspx</span>
<a href="#l10.271"></a><span id="l10.271">       hr = MAPI_E_FAILURE;</span>
<a href="#l10.272"></a><span id="l10.272">       break;</span>
<a href="#l10.273"></a><span id="l10.273" class="difflineminus">-    case NS_ERROR_SMTP_AUTH_FAILURE :</span>
<a href="#l10.274"></a><span id="l10.274" class="difflineminus">-    case NS_ERROR_SMTP_AUTH_GSSAPI :</span>
<a href="#l10.275"></a><span id="l10.275" class="difflineminus">-    case NS_ERROR_SMTP_AUTH_MECH_NOT_SUPPORTED :</span>
<a href="#l10.276"></a><span id="l10.276" class="difflineminus">-    case NS_ERROR_SMTP_AUTH_CHANGE_ENCRYPT_TO_PLAIN_NO_SSL :</span>
<a href="#l10.277"></a><span id="l10.277" class="difflineminus">-    case NS_ERROR_SMTP_AUTH_CHANGE_ENCRYPT_TO_PLAIN_SSL :</span>
<a href="#l10.278"></a><span id="l10.278" class="difflineminus">-    case NS_ERROR_SMTP_AUTH_CHANGE_PLAIN_TO_ENCRYPT :</span>
<a href="#l10.279"></a><span id="l10.279" class="difflineplus">+    case NS_ERROR_SMTP_AUTH_FAILURE:</span>
<a href="#l10.280"></a><span id="l10.280" class="difflineplus">+    case NS_ERROR_SMTP_AUTH_GSSAPI:</span>
<a href="#l10.281"></a><span id="l10.281" class="difflineplus">+    case NS_ERROR_SMTP_AUTH_MECH_NOT_SUPPORTED:</span>
<a href="#l10.282"></a><span id="l10.282" class="difflineplus">+    case NS_ERROR_SMTP_AUTH_CHANGE_ENCRYPT_TO_PLAIN_NO_SSL:</span>
<a href="#l10.283"></a><span id="l10.283" class="difflineplus">+    case NS_ERROR_SMTP_AUTH_CHANGE_ENCRYPT_TO_PLAIN_SSL:</span>
<a href="#l10.284"></a><span id="l10.284" class="difflineplus">+    case NS_ERROR_SMTP_AUTH_CHANGE_PLAIN_TO_ENCRYPT:</span>
<a href="#l10.285"></a><span id="l10.285">       hr = MAPI_E_LOGIN_FAILURE;</span>
<a href="#l10.286"></a><span id="l10.286">       break;</span>
<a href="#l10.287"></a><span id="l10.287" class="difflineminus">-    case NS_MSG_UNABLE_TO_OPEN_FILE :</span>
<a href="#l10.288"></a><span id="l10.288" class="difflineminus">-    case NS_MSG_UNABLE_TO_OPEN_TMP_FILE :</span>
<a href="#l10.289"></a><span id="l10.289" class="difflineminus">-    case NS_MSG_COULDNT_OPEN_FCC_FOLDER :</span>
<a href="#l10.290"></a><span id="l10.290" class="difflineminus">-    case NS_ERROR_FILE_INVALID_PATH :</span>
<a href="#l10.291"></a><span id="l10.291" class="difflineplus">+    case NS_MSG_UNABLE_TO_OPEN_FILE:</span>
<a href="#l10.292"></a><span id="l10.292" class="difflineplus">+    case NS_MSG_UNABLE_TO_OPEN_TMP_FILE:</span>
<a href="#l10.293"></a><span id="l10.293" class="difflineplus">+    case NS_MSG_COULDNT_OPEN_FCC_FOLDER:</span>
<a href="#l10.294"></a><span id="l10.294" class="difflineplus">+    case NS_ERROR_FILE_INVALID_PATH:</span>
<a href="#l10.295"></a><span id="l10.295">       hr = MAPI_E_ATTACHMENT_OPEN_FAILURE;</span>
<a href="#l10.296"></a><span id="l10.296">       break;</span>
<a href="#l10.297"></a><span id="l10.297" class="difflineminus">-    case NS_ERROR_FILE_TARGET_DOES_NOT_EXIST :</span>
<a href="#l10.298"></a><span id="l10.298" class="difflineplus">+    case NS_ERROR_FILE_TARGET_DOES_NOT_EXIST:</span>
<a href="#l10.299"></a><span id="l10.299">       hr = MAPI_E_ATTACHMENT_NOT_FOUND;</span>
<a href="#l10.300"></a><span id="l10.300">       break;</span>
<a href="#l10.301"></a><span id="l10.301" class="difflineminus">-    case NS_MSG_ERROR_WRITING_FILE :</span>
<a href="#l10.302"></a><span id="l10.302" class="difflineminus">-    case NS_MSG_UNABLE_TO_SAVE_TEMPLATE :</span>
<a href="#l10.303"></a><span id="l10.303" class="difflineminus">-    case NS_MSG_UNABLE_TO_SAVE_DRAFT :</span>
<a href="#l10.304"></a><span id="l10.304" class="difflineplus">+    case NS_MSG_ERROR_WRITING_FILE:</span>
<a href="#l10.305"></a><span id="l10.305" class="difflineplus">+    case NS_MSG_UNABLE_TO_SAVE_TEMPLATE:</span>
<a href="#l10.306"></a><span id="l10.306" class="difflineplus">+    case NS_MSG_UNABLE_TO_SAVE_DRAFT:</span>
<a href="#l10.307"></a><span id="l10.307">       hr = MAPI_E_ATTACHMENT_WRITE_FAILURE;</span>
<a href="#l10.308"></a><span id="l10.308">       break;</span>
<a href="#l10.309"></a><span id="l10.309">     default:</span>
<a href="#l10.310"></a><span id="l10.310">       hr = MAPI_E_FAILURE;</span>
<a href="#l10.311"></a><span id="l10.311">       break;</span>
<a href="#l10.312"></a><span id="l10.312">   }</span>
<a href="#l10.313"></a><span id="l10.313"> </span>
<a href="#l10.314"></a><span id="l10.314">   return hr;</span>
<a href="#l10.315"></a><span id="l10.315"> }</span>
<a href="#l10.316"></a><span id="l10.316"> </span>
<a href="#l10.317"></a><span id="l10.317" class="difflineminus">-</span>
<a href="#l10.318"></a><span id="l10.318" class="difflineminus">-nsMAPISession::nsMAPISession(uint32_t aHwnd, const nsCString&amp; aUserName, const nsCString&amp; aPassword,</span>
<a href="#l10.319"></a><span id="l10.319" class="difflineminus">-                             bool aForceDownLoad, const char *aKey)</span>
<a href="#l10.320"></a><span id="l10.320" class="difflineminus">-: m_nShared(1),</span>
<a href="#l10.321"></a><span id="l10.321" class="difflineminus">-  m_pIdKey(aKey)</span>
<a href="#l10.322"></a><span id="l10.322" class="difflineminus">-{</span>
<a href="#l10.323"></a><span id="l10.323" class="difflineplus">+nsMAPISession::nsMAPISession(uint32_t aHwnd, const nsCString &amp;aUserName,</span>
<a href="#l10.324"></a><span id="l10.324" class="difflineplus">+                             const nsCString &amp;aPassword, bool aForceDownLoad,</span>
<a href="#l10.325"></a><span id="l10.325" class="difflineplus">+                             const char *aKey)</span>
<a href="#l10.326"></a><span id="l10.326" class="difflineplus">+    : m_nShared(1), m_pIdKey(aKey) {</span>
<a href="#l10.327"></a><span id="l10.327">   m_listContext = NULL;</span>
<a href="#l10.328"></a><span id="l10.328">   m_pProfileName = aUserName;</span>
<a href="#l10.329"></a><span id="l10.329">   m_pPassword = aPassword;</span>
<a href="#l10.330"></a><span id="l10.330"> }</span>
<a href="#l10.331"></a><span id="l10.331"> </span>
<a href="#l10.332"></a><span id="l10.332" class="difflineminus">-nsMAPISession::~nsMAPISession()</span>
<a href="#l10.333"></a><span id="l10.333" class="difflineminus">-{</span>
<a href="#l10.334"></a><span id="l10.334" class="difflineminus">-}</span>
<a href="#l10.335"></a><span id="l10.335" class="difflineplus">+nsMAPISession::~nsMAPISession() {}</span>
<a href="#l10.336"></a><span id="l10.336"> </span>
<a href="#l10.337"></a><span id="l10.337" class="difflineminus">-uint32_t nsMAPISession::IncrementSession()</span>
<a href="#l10.338"></a><span id="l10.338" class="difflineminus">-{</span>
<a href="#l10.339"></a><span id="l10.339" class="difflineminus">-  return ++m_nShared;</span>
<a href="#l10.340"></a><span id="l10.340" class="difflineminus">-}</span>
<a href="#l10.341"></a><span id="l10.341" class="difflineplus">+uint32_t nsMAPISession::IncrementSession() { return ++m_nShared; }</span>
<a href="#l10.342"></a><span id="l10.342" class="difflineplus">+</span>
<a href="#l10.343"></a><span id="l10.343" class="difflineplus">+uint32_t nsMAPISession::DecrementSession() { return --m_nShared; }</span>
<a href="#l10.344"></a><span id="l10.344"> </span>
<a href="#l10.345"></a><span id="l10.345" class="difflineminus">-uint32_t nsMAPISession::DecrementSession()</span>
<a href="#l10.346"></a><span id="l10.346" class="difflineminus">-{</span>
<a href="#l10.347"></a><span id="l10.347" class="difflineminus">-  return --m_nShared;</span>
<a href="#l10.348"></a><span id="l10.348" class="difflineminus">-}</span>
<a href="#l10.349"></a><span id="l10.349" class="difflineplus">+uint32_t nsMAPISession::GetSessionCount() { return m_nShared; }</span>
<a href="#l10.350"></a><span id="l10.350"> </span>
<a href="#l10.351"></a><span id="l10.351" class="difflineminus">-uint32_t nsMAPISession::GetSessionCount()</span>
<a href="#l10.352"></a><span id="l10.352" class="difflineminus">-{</span>
<a href="#l10.353"></a><span id="l10.353" class="difflineminus">-  return m_nShared;</span>
<a href="#l10.354"></a><span id="l10.354" class="difflineminus">-}</span>
<a href="#l10.355"></a><span id="l10.355" class="difflineplus">+char16_t *nsMAPISession::GetPassword() { return (char16_t *)m_pPassword.get(); }</span>
<a href="#l10.356"></a><span id="l10.356"> </span>
<a href="#l10.357"></a><span id="l10.357" class="difflineminus">-char16_t *nsMAPISession::GetPassword()</span>
<a href="#l10.358"></a><span id="l10.358" class="difflineminus">-{</span>
<a href="#l10.359"></a><span id="l10.359" class="difflineminus">-  return (char16_t *)m_pPassword.get();</span>
<a href="#l10.360"></a><span id="l10.360" class="difflineminus">-}</span>
<a href="#l10.361"></a><span id="l10.361" class="difflineminus">-</span>
<a href="#l10.362"></a><span id="l10.362" class="difflineminus">-void nsMAPISession::GetIdKey(nsCString&amp; aKey)</span>
<a href="#l10.363"></a><span id="l10.363" class="difflineminus">-{</span>
<a href="#l10.364"></a><span id="l10.364" class="difflineplus">+void nsMAPISession::GetIdKey(nsCString &amp;aKey) {</span>
<a href="#l10.365"></a><span id="l10.365">   aKey = m_pIdKey;</span>
<a href="#l10.366"></a><span id="l10.366">   return;</span>
<a href="#l10.367"></a><span id="l10.367"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/mapi/mapihook/src/msgMapiMain.h</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/mapi/mapihook/src/msgMapiMain.h</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -1,81 +1,80 @@</span>
<a href="#l11.4"></a><span id="l11.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l11.5"></a><span id="l11.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l11.6"></a><span id="l11.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l11.7"></a><span id="l11.7"> </span>
<a href="#l11.8"></a><span id="l11.8"> #ifndef MSG_MAPI_MAIN_H_</span>
<a href="#l11.9"></a><span id="l11.9"> #define MSG_MAPI_MAIN_H_</span>
<a href="#l11.10"></a><span id="l11.10"> </span>
<a href="#l11.11"></a><span id="l11.11" class="difflineminus">-#define        MAX_NAME_LEN    256</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-#define        MAX_PW_LEN      256</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-#define        MAX_SESSIONS    50</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineminus">-#define        MAPI_SENDCOMPLETE_EVENT   &quot;SendCompletionEvent&quot;</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+#define MAX_NAME_LEN 256</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineplus">+#define MAX_PW_LEN 256</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineplus">+#define MAX_SESSIONS 50</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineplus">+#define MAPI_SENDCOMPLETE_EVENT &quot;SendCompletionEvent&quot;</span>
<a href="#l11.19"></a><span id="l11.19"> </span>
<a href="#l11.20"></a><span id="l11.20"> #define MAPI_PROPERTIES_CHROME &quot;chrome://messenger-mapi/locale/mapi.properties&quot;</span>
<a href="#l11.21"></a><span id="l11.21"> #define PREF_MAPI_WARN_PRIOR_TO_BLIND_SEND &quot;mapi.blind-send.warn&quot;</span>
<a href="#l11.22"></a><span id="l11.22"> #define PREF_MAPI_BLIND_SEND_ENABLED &quot;mapi.blind-send.enabled&quot;</span>
<a href="#l11.23"></a><span id="l11.23"> </span>
<a href="#l11.24"></a><span id="l11.24"> #include &quot;nspr.h&quot;</span>
<a href="#l11.25"></a><span id="l11.25"> #include &quot;nsDataHashtable.h&quot;</span>
<a href="#l11.26"></a><span id="l11.26"> #include &quot;nsClassHashtable.h&quot;</span>
<a href="#l11.27"></a><span id="l11.27"> #include &quot;nsString.h&quot;</span>
<a href="#l11.28"></a><span id="l11.28"> </span>
<a href="#l11.29"></a><span id="l11.29"> class nsMAPISession;</span>
<a href="#l11.30"></a><span id="l11.30"> </span>
<a href="#l11.31"></a><span id="l11.31" class="difflineminus">-class nsMAPIConfiguration</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineminus">-{</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineminus">-private :</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineminus">-</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineplus">+class nsMAPIConfiguration {</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineplus">+ private:</span>
<a href="#l11.37"></a><span id="l11.37">   static uint32_t session_generator;</span>
<a href="#l11.38"></a><span id="l11.38">   static uint32_t sessionCount;</span>
<a href="#l11.39"></a><span id="l11.39">   static nsMAPIConfiguration *m_pSelfRef;</span>
<a href="#l11.40"></a><span id="l11.40">   PRLock *m_Lock;</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineminus">-  uint32_t  m_nMaxSessions;</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineplus">+  uint32_t m_nMaxSessions;</span>
<a href="#l11.43"></a><span id="l11.43"> </span>
<a href="#l11.44"></a><span id="l11.44">   nsDataHashtable&lt;nsCStringHashKey, uint32_t&gt; m_ProfileMap;</span>
<a href="#l11.45"></a><span id="l11.45">   nsClassHashtable&lt;nsUint32HashKey, nsMAPISession&gt; m_SessionMap;</span>
<a href="#l11.46"></a><span id="l11.46">   nsMAPIConfiguration();</span>
<a href="#l11.47"></a><span id="l11.47">   ~nsMAPIConfiguration();</span>
<a href="#l11.48"></a><span id="l11.48"> </span>
<a href="#l11.49"></a><span id="l11.49" class="difflineminus">-public :</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineplus">+ public:</span>
<a href="#l11.51"></a><span id="l11.51">   static nsMAPIConfiguration *GetMAPIConfiguration();</span>
<a href="#l11.52"></a><span id="l11.52">   void OpenConfiguration();</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineminus">-  int16_t RegisterSession(uint32_t aHwnd, const nsCString&amp; aUserName,</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineminus">-                          const nsCString&amp; aPassword, bool aForceDownLoad,</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineminus">-                          bool aNewSession, uint32_t *aSession, const char *aIdKey);</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineplus">+  int16_t RegisterSession(uint32_t aHwnd, const nsCString &amp;aUserName,</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineplus">+                          const nsCString &amp;aPassword, bool aForceDownLoad,</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineplus">+                          bool aNewSession, uint32_t *aSession,</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineplus">+                          const char *aIdKey);</span>
<a href="#l11.60"></a><span id="l11.60">   bool IsSessionValid(uint32_t aSessionID);</span>
<a href="#l11.61"></a><span id="l11.61">   bool UnRegisterSession(uint32_t aSessionID);</span>
<a href="#l11.62"></a><span id="l11.62">   char16_t *GetPassword(uint32_t aSessionID);</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineminus">-  void GetIdKey(uint32_t aSessionID, nsCString&amp; aKey);</span>
<a href="#l11.64"></a><span id="l11.64" class="difflineplus">+  void GetIdKey(uint32_t aSessionID, nsCString &amp;aKey);</span>
<a href="#l11.65"></a><span id="l11.65">   void *GetMapiListContext(uint32_t aSessionID);</span>
<a href="#l11.66"></a><span id="l11.66">   void SetMapiListContext(uint32_t aSessionID, void *mapiListContext);</span>
<a href="#l11.67"></a><span id="l11.67"> </span>
<a href="#l11.68"></a><span id="l11.68">   // a util func</span>
<a href="#l11.69"></a><span id="l11.69" class="difflineminus">-  static HRESULT GetMAPIErrorFromNSError (nsresult res) ;</span>
<a href="#l11.70"></a><span id="l11.70" class="difflineplus">+  static HRESULT GetMAPIErrorFromNSError(nsresult res);</span>
<a href="#l11.71"></a><span id="l11.71"> };</span>
<a href="#l11.72"></a><span id="l11.72"> </span>
<a href="#l11.73"></a><span id="l11.73" class="difflineminus">-class nsMAPISession</span>
<a href="#l11.74"></a><span id="l11.74" class="difflineminus">-{</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineplus">+class nsMAPISession {</span>
<a href="#l11.76"></a><span id="l11.76">   friend class nsMAPIConfiguration;</span>
<a href="#l11.77"></a><span id="l11.77"> </span>
<a href="#l11.78"></a><span id="l11.78" class="difflineminus">-  private :</span>
<a href="#l11.79"></a><span id="l11.79" class="difflineminus">-    uint32_t m_nShared;</span>
<a href="#l11.80"></a><span id="l11.80" class="difflineminus">-    nsCString m_pIdKey;</span>
<a href="#l11.81"></a><span id="l11.81" class="difflineminus">-    nsCString m_pProfileName;</span>
<a href="#l11.82"></a><span id="l11.82" class="difflineminus">-    nsCString m_pPassword;</span>
<a href="#l11.83"></a><span id="l11.83" class="difflineminus">-    void   *m_listContext; // used by findNext</span>
<a href="#l11.84"></a><span id="l11.84" class="difflineplus">+ private:</span>
<a href="#l11.85"></a><span id="l11.85" class="difflineplus">+  uint32_t m_nShared;</span>
<a href="#l11.86"></a><span id="l11.86" class="difflineplus">+  nsCString m_pIdKey;</span>
<a href="#l11.87"></a><span id="l11.87" class="difflineplus">+  nsCString m_pProfileName;</span>
<a href="#l11.88"></a><span id="l11.88" class="difflineplus">+  nsCString m_pPassword;</span>
<a href="#l11.89"></a><span id="l11.89" class="difflineplus">+  void *m_listContext;  // used by findNext</span>
<a href="#l11.90"></a><span id="l11.90"> </span>
<a href="#l11.91"></a><span id="l11.91" class="difflineminus">-  public :</span>
<a href="#l11.92"></a><span id="l11.92" class="difflineminus">-    nsMAPISession(uint32_t aHwnd, const nsCString&amp; aUserName, const nsCString&amp; aPassword,</span>
<a href="#l11.93"></a><span id="l11.93" class="difflineminus">-                  bool aForceDownLoad, const char *aKey);</span>
<a href="#l11.94"></a><span id="l11.94" class="difflineminus">-    uint32_t IncrementSession();</span>
<a href="#l11.95"></a><span id="l11.95" class="difflineminus">-    uint32_t DecrementSession();</span>
<a href="#l11.96"></a><span id="l11.96" class="difflineminus">-    uint32_t GetSessionCount();</span>
<a href="#l11.97"></a><span id="l11.97" class="difflineminus">-    char16_t *GetPassword();</span>
<a href="#l11.98"></a><span id="l11.98" class="difflineminus">-    void GetIdKey(nsCString&amp; aKey);</span>
<a href="#l11.99"></a><span id="l11.99" class="difflineminus">-    ~nsMAPISession();</span>
<a href="#l11.100"></a><span id="l11.100" class="difflineminus">-    // For enumerating Messages...</span>
<a href="#l11.101"></a><span id="l11.101" class="difflineminus">-    void SetMapiListContext( void *listContext) { m_listContext = listContext; }</span>
<a href="#l11.102"></a><span id="l11.102" class="difflineminus">-    void *GetMapiListContext( ) { return m_listContext; }</span>
<a href="#l11.103"></a><span id="l11.103" class="difflineplus">+ public:</span>
<a href="#l11.104"></a><span id="l11.104" class="difflineplus">+  nsMAPISession(uint32_t aHwnd, const nsCString &amp;aUserName,</span>
<a href="#l11.105"></a><span id="l11.105" class="difflineplus">+                const nsCString &amp;aPassword, bool aForceDownLoad,</span>
<a href="#l11.106"></a><span id="l11.106" class="difflineplus">+                const char *aKey);</span>
<a href="#l11.107"></a><span id="l11.107" class="difflineplus">+  uint32_t IncrementSession();</span>
<a href="#l11.108"></a><span id="l11.108" class="difflineplus">+  uint32_t DecrementSession();</span>
<a href="#l11.109"></a><span id="l11.109" class="difflineplus">+  uint32_t GetSessionCount();</span>
<a href="#l11.110"></a><span id="l11.110" class="difflineplus">+  char16_t *GetPassword();</span>
<a href="#l11.111"></a><span id="l11.111" class="difflineplus">+  void GetIdKey(nsCString &amp;aKey);</span>
<a href="#l11.112"></a><span id="l11.112" class="difflineplus">+  ~nsMAPISession();</span>
<a href="#l11.113"></a><span id="l11.113" class="difflineplus">+  // For enumerating Messages...</span>
<a href="#l11.114"></a><span id="l11.114" class="difflineplus">+  void SetMapiListContext(void *listContext) { m_listContext = listContext; }</span>
<a href="#l11.115"></a><span id="l11.115" class="difflineplus">+  void *GetMapiListContext() { return m_listContext; }</span>
<a href="#l11.116"></a><span id="l11.116"> };</span>
<a href="#l11.117"></a><span id="l11.117"> </span>
<a href="#l11.118"></a><span id="l11.118" class="difflineminus">-#endif    // MSG_MAPI_MAIN_H_</span>
<a href="#l11.119"></a><span id="l11.119" class="difflineplus">+#endif  // MSG_MAPI_MAIN_H_</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/mapi/mapihook/src/msgMapiSupport.cpp</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/mapi/mapihook/src/msgMapiSupport.cpp</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -16,129 +16,108 @@</span>
<a href="#l12.4"></a><span id="l12.4"> </span>
<a href="#l12.5"></a><span id="l12.5"> /** Implementation of the nsIMapiSupport interface.</span>
<a href="#l12.6"></a><span id="l12.6">  *  Use standard implementation of nsISupports stuff.</span>
<a href="#l12.7"></a><span id="l12.7">  */</span>
<a href="#l12.8"></a><span id="l12.8"> </span>
<a href="#l12.9"></a><span id="l12.9"> NS_IMPL_ISUPPORTS(nsMapiSupport, nsIMapiSupport, nsIObserver)</span>
<a href="#l12.10"></a><span id="l12.10"> </span>
<a href="#l12.11"></a><span id="l12.11"> NS_IMETHODIMP</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-nsMapiSupport::Observe(nsISupports *aSubject, const char *aTopic, const char16_t *aData)</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineminus">-{</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineminus">-    nsresult rv = NS_OK ;</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+nsMapiSupport::Observe(nsISupports *aSubject, const char *aTopic,</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineplus">+                       const char16_t *aData) {</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l12.18"></a><span id="l12.18"> </span>
<a href="#l12.19"></a><span id="l12.19" class="difflineminus">-    if (!strcmp(aTopic, &quot;profile-after-change&quot;))</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineminus">-        return InitializeMAPISupport();</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineplus">+  if (!strcmp(aTopic, &quot;profile-after-change&quot;)) return InitializeMAPISupport();</span>
<a href="#l12.22"></a><span id="l12.22"> </span>
<a href="#l12.23"></a><span id="l12.23" class="difflineminus">-    if (!strcmp(aTopic, NS_XPCOM_SHUTDOWN_OBSERVER_ID))</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineminus">-        return ShutdownMAPISupport();</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineplus">+  if (!strcmp(aTopic, NS_XPCOM_SHUTDOWN_OBSERVER_ID))</span>
<a href="#l12.26"></a><span id="l12.26" class="difflineplus">+    return ShutdownMAPISupport();</span>
<a href="#l12.27"></a><span id="l12.27"> </span>
<a href="#l12.28"></a><span id="l12.28" class="difflineminus">-    nsCOMPtr&lt;nsIObserverService&gt; observerService =</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineplus">+  nsCOMPtr&lt;nsIObserverService&gt; observerService =</span>
<a href="#l12.30"></a><span id="l12.30">       mozilla::services::GetObserverService();</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineminus">-    NS_ENSURE_TRUE(observerService, NS_ERROR_UNEXPECTED);</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineplus">+  NS_ENSURE_TRUE(observerService, NS_ERROR_UNEXPECTED);</span>
<a href="#l12.33"></a><span id="l12.33"> </span>
<a href="#l12.34"></a><span id="l12.34" class="difflineminus">-    rv = observerService-&gt;AddObserver(this,&quot;profile-after-change&quot;, false);</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineplus">+  rv = observerService-&gt;AddObserver(this, &quot;profile-after-change&quot;, false);</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l12.38"></a><span id="l12.38"> </span>
<a href="#l12.39"></a><span id="l12.39" class="difflineminus">-    rv = observerService-&gt;AddObserver(this, NS_XPCOM_SHUTDOWN_OBSERVER_ID, false);</span>
<a href="#l12.40"></a><span id="l12.40" class="difflineminus">-    if (NS_FAILED(rv))  return rv;</span>
<a href="#l12.41"></a><span id="l12.41" class="difflineplus">+  rv = observerService-&gt;AddObserver(this, NS_XPCOM_SHUTDOWN_OBSERVER_ID, false);</span>
<a href="#l12.42"></a><span id="l12.42" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l12.43"></a><span id="l12.43"> </span>
<a href="#l12.44"></a><span id="l12.44" class="difflineminus">-    return rv;</span>
<a href="#l12.45"></a><span id="l12.45" class="difflineplus">+  return rv;</span>
<a href="#l12.46"></a><span id="l12.46"> }</span>
<a href="#l12.47"></a><span id="l12.47"> </span>
<a href="#l12.48"></a><span id="l12.48" class="difflineplus">+nsMapiSupport::nsMapiSupport() : m_dwRegister(0), m_nsMapiFactory(nullptr) {}</span>
<a href="#l12.49"></a><span id="l12.49"> </span>
<a href="#l12.50"></a><span id="l12.50" class="difflineminus">-nsMapiSupport::nsMapiSupport()</span>
<a href="#l12.51"></a><span id="l12.51" class="difflineminus">-: m_dwRegister(0),</span>
<a href="#l12.52"></a><span id="l12.52" class="difflineminus">-  m_nsMapiFactory(nullptr)</span>
<a href="#l12.53"></a><span id="l12.53" class="difflineminus">-{</span>
<a href="#l12.54"></a><span id="l12.54" class="difflineminus">-}</span>
<a href="#l12.55"></a><span id="l12.55" class="difflineminus">-</span>
<a href="#l12.56"></a><span id="l12.56" class="difflineminus">-nsMapiSupport::~nsMapiSupport()</span>
<a href="#l12.57"></a><span id="l12.57" class="difflineminus">-{</span>
<a href="#l12.58"></a><span id="l12.58" class="difflineminus">-}</span>
<a href="#l12.59"></a><span id="l12.59" class="difflineplus">+nsMapiSupport::~nsMapiSupport() {}</span>
<a href="#l12.60"></a><span id="l12.60"> </span>
<a href="#l12.61"></a><span id="l12.61"> NS_IMETHODIMP</span>
<a href="#l12.62"></a><span id="l12.62" class="difflineminus">-nsMapiSupport::InitializeMAPISupport()</span>
<a href="#l12.63"></a><span id="l12.63" class="difflineminus">-{</span>
<a href="#l12.64"></a><span id="l12.64" class="difflineminus">-    ::OleInitialize(nullptr) ;</span>
<a href="#l12.65"></a><span id="l12.65" class="difflineminus">-</span>
<a href="#l12.66"></a><span id="l12.66" class="difflineminus">-    if (m_nsMapiFactory == nullptr)    // No Registering if already done.  Sanity Check!!</span>
<a href="#l12.67"></a><span id="l12.67" class="difflineminus">-    {</span>
<a href="#l12.68"></a><span id="l12.68" class="difflineminus">-        m_nsMapiFactory = new CMapiFactory();</span>
<a href="#l12.69"></a><span id="l12.69" class="difflineminus">-</span>
<a href="#l12.70"></a><span id="l12.70" class="difflineminus">-        if (m_nsMapiFactory != nullptr)</span>
<a href="#l12.71"></a><span id="l12.71" class="difflineminus">-        {</span>
<a href="#l12.72"></a><span id="l12.72" class="difflineminus">-            HRESULT hr = ::CoRegisterClassObject(CLSID_CMapiImp, \</span>
<a href="#l12.73"></a><span id="l12.73" class="difflineminus">-                                                 m_nsMapiFactory, \</span>
<a href="#l12.74"></a><span id="l12.74" class="difflineminus">-                                                 CLSCTX_LOCAL_SERVER, \</span>
<a href="#l12.75"></a><span id="l12.75" class="difflineminus">-                                                 REGCLS_MULTIPLEUSE, \</span>
<a href="#l12.76"></a><span id="l12.76" class="difflineminus">-                                                 &amp;m_dwRegister);</span>
<a href="#l12.77"></a><span id="l12.77" class="difflineplus">+nsMapiSupport::InitializeMAPISupport() {</span>
<a href="#l12.78"></a><span id="l12.78" class="difflineplus">+  ::OleInitialize(nullptr);</span>
<a href="#l12.79"></a><span id="l12.79"> </span>
<a href="#l12.80"></a><span id="l12.80" class="difflineminus">-            if (FAILED(hr))</span>
<a href="#l12.81"></a><span id="l12.81" class="difflineminus">-            {</span>
<a href="#l12.82"></a><span id="l12.82" class="difflineminus">-                m_nsMapiFactory-&gt;Release() ;</span>
<a href="#l12.83"></a><span id="l12.83" class="difflineminus">-                m_nsMapiFactory = nullptr;</span>
<a href="#l12.84"></a><span id="l12.84" class="difflineminus">-                return NS_ERROR_FAILURE;</span>
<a href="#l12.85"></a><span id="l12.85" class="difflineminus">-            }</span>
<a href="#l12.86"></a><span id="l12.86" class="difflineminus">-        }</span>
<a href="#l12.87"></a><span id="l12.87" class="difflineminus">-    }</span>
<a href="#l12.88"></a><span id="l12.88" class="difflineplus">+  if (m_nsMapiFactory ==</span>
<a href="#l12.89"></a><span id="l12.89" class="difflineplus">+      nullptr)  // No Registering if already done.  Sanity Check!!</span>
<a href="#l12.90"></a><span id="l12.90" class="difflineplus">+  {</span>
<a href="#l12.91"></a><span id="l12.91" class="difflineplus">+    m_nsMapiFactory = new CMapiFactory();</span>
<a href="#l12.92"></a><span id="l12.92"> </span>
<a href="#l12.93"></a><span id="l12.93" class="difflineminus">-    return NS_OK;</span>
<a href="#l12.94"></a><span id="l12.94" class="difflineminus">-}</span>
<a href="#l12.95"></a><span id="l12.95" class="difflineplus">+    if (m_nsMapiFactory != nullptr) {</span>
<a href="#l12.96"></a><span id="l12.96" class="difflineplus">+      HRESULT hr = ::CoRegisterClassObject(CLSID_CMapiImp, m_nsMapiFactory,</span>
<a href="#l12.97"></a><span id="l12.97" class="difflineplus">+                                           CLSCTX_LOCAL_SERVER,</span>
<a href="#l12.98"></a><span id="l12.98" class="difflineplus">+                                           REGCLS_MULTIPLEUSE, &amp;m_dwRegister);</span>
<a href="#l12.99"></a><span id="l12.99"> </span>
<a href="#l12.100"></a><span id="l12.100" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l12.101"></a><span id="l12.101" class="difflineminus">-nsMapiSupport::ShutdownMAPISupport()</span>
<a href="#l12.102"></a><span id="l12.102" class="difflineminus">-{</span>
<a href="#l12.103"></a><span id="l12.103" class="difflineminus">-    if (m_dwRegister != 0)</span>
<a href="#l12.104"></a><span id="l12.104" class="difflineminus">-        ::CoRevokeClassObject(m_dwRegister);</span>
<a href="#l12.105"></a><span id="l12.105" class="difflineminus">-</span>
<a href="#l12.106"></a><span id="l12.106" class="difflineminus">-    if (m_nsMapiFactory != nullptr)</span>
<a href="#l12.107"></a><span id="l12.107" class="difflineminus">-    {</span>
<a href="#l12.108"></a><span id="l12.108" class="difflineplus">+      if (FAILED(hr)) {</span>
<a href="#l12.109"></a><span id="l12.109">         m_nsMapiFactory-&gt;Release();</span>
<a href="#l12.110"></a><span id="l12.110">         m_nsMapiFactory = nullptr;</span>
<a href="#l12.111"></a><span id="l12.111" class="difflineplus">+        return NS_ERROR_FAILURE;</span>
<a href="#l12.112"></a><span id="l12.112" class="difflineplus">+      }</span>
<a href="#l12.113"></a><span id="l12.113">     }</span>
<a href="#l12.114"></a><span id="l12.114" class="difflineminus">-</span>
<a href="#l12.115"></a><span id="l12.115" class="difflineminus">-    ::OleUninitialize();</span>
<a href="#l12.116"></a><span id="l12.116" class="difflineplus">+  }</span>
<a href="#l12.117"></a><span id="l12.117"> </span>
<a href="#l12.118"></a><span id="l12.118" class="difflineminus">-    return NS_OK ;</span>
<a href="#l12.119"></a><span id="l12.119" class="difflineminus">-}</span>
<a href="#l12.120"></a><span id="l12.120" class="difflineminus">-</span>
<a href="#l12.121"></a><span id="l12.121" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l12.122"></a><span id="l12.122" class="difflineminus">-nsMapiSupport::RegisterServer()</span>
<a href="#l12.123"></a><span id="l12.123" class="difflineminus">-{</span>
<a href="#l12.124"></a><span id="l12.124" class="difflineminus">-  // TODO: Figure out what kind of error propagation to pass back</span>
<a href="#l12.125"></a><span id="l12.125" class="difflineminus">-  ::RegisterServer(CLSID_CMapiImp, &quot;Mozilla MAPI&quot;, &quot;MozillaMapi&quot;, &quot;MozillaMapi.1&quot;);</span>
<a href="#l12.126"></a><span id="l12.126">   return NS_OK;</span>
<a href="#l12.127"></a><span id="l12.127"> }</span>
<a href="#l12.128"></a><span id="l12.128"> </span>
<a href="#l12.129"></a><span id="l12.129"> NS_IMETHODIMP</span>
<a href="#l12.130"></a><span id="l12.130" class="difflineminus">-nsMapiSupport::UnRegisterServer()</span>
<a href="#l12.131"></a><span id="l12.131" class="difflineminus">-{</span>
<a href="#l12.132"></a><span id="l12.132" class="difflineplus">+nsMapiSupport::ShutdownMAPISupport() {</span>
<a href="#l12.133"></a><span id="l12.133" class="difflineplus">+  if (m_dwRegister != 0) ::CoRevokeClassObject(m_dwRegister);</span>
<a href="#l12.134"></a><span id="l12.134" class="difflineplus">+</span>
<a href="#l12.135"></a><span id="l12.135" class="difflineplus">+  if (m_nsMapiFactory != nullptr) {</span>
<a href="#l12.136"></a><span id="l12.136" class="difflineplus">+    m_nsMapiFactory-&gt;Release();</span>
<a href="#l12.137"></a><span id="l12.137" class="difflineplus">+    m_nsMapiFactory = nullptr;</span>
<a href="#l12.138"></a><span id="l12.138" class="difflineplus">+  }</span>
<a href="#l12.139"></a><span id="l12.139" class="difflineplus">+</span>
<a href="#l12.140"></a><span id="l12.140" class="difflineplus">+  ::OleUninitialize();</span>
<a href="#l12.141"></a><span id="l12.141" class="difflineplus">+</span>
<a href="#l12.142"></a><span id="l12.142" class="difflineplus">+  return NS_OK;</span>
<a href="#l12.143"></a><span id="l12.143" class="difflineplus">+}</span>
<a href="#l12.144"></a><span id="l12.144" class="difflineplus">+</span>
<a href="#l12.145"></a><span id="l12.145" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l12.146"></a><span id="l12.146" class="difflineplus">+nsMapiSupport::RegisterServer() {</span>
<a href="#l12.147"></a><span id="l12.147" class="difflineplus">+  // TODO: Figure out what kind of error propagation to pass back</span>
<a href="#l12.148"></a><span id="l12.148" class="difflineplus">+  ::RegisterServer(CLSID_CMapiImp, &quot;Mozilla MAPI&quot;, &quot;MozillaMapi&quot;,</span>
<a href="#l12.149"></a><span id="l12.149" class="difflineplus">+                   &quot;MozillaMapi.1&quot;);</span>
<a href="#l12.150"></a><span id="l12.150" class="difflineplus">+  return NS_OK;</span>
<a href="#l12.151"></a><span id="l12.151" class="difflineplus">+}</span>
<a href="#l12.152"></a><span id="l12.152" class="difflineplus">+</span>
<a href="#l12.153"></a><span id="l12.153" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l12.154"></a><span id="l12.154" class="difflineplus">+nsMapiSupport::UnRegisterServer() {</span>
<a href="#l12.155"></a><span id="l12.155">   // TODO: Figure out what kind of error propagation to pass back</span>
<a href="#l12.156"></a><span id="l12.156">   ::UnregisterServer(CLSID_CMapiImp, &quot;MozillaMapi&quot;, &quot;MozillaMapi.1&quot;);</span>
<a href="#l12.157"></a><span id="l12.157">   return NS_OK;</span>
<a href="#l12.158"></a><span id="l12.158"> }</span>
<a href="#l12.159"></a><span id="l12.159"> </span>
<a href="#l12.160"></a><span id="l12.160"> NS_DEFINE_NAMED_CID(NS_IMAPISUPPORT_CID);</span>
<a href="#l12.161"></a><span id="l12.161"> </span>
<a href="#l12.162"></a><span id="l12.162"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsMapiSupport)</span>
<a href="#l12.163"></a><span id="l12.163"> </span>
<a href="#l12.164"></a><span id="l12.164"> static const mozilla::Module::CategoryEntry kMAPICategories[] = {</span>
<a href="#l12.165"></a><span id="l12.165" class="difflineminus">-  { APPSTARTUP_CATEGORY, &quot;Mapi Support&quot;, &quot;service,&quot; NS_IMAPISUPPORT_CONTRACTID, },</span>
<a href="#l12.166"></a><span id="l12.166" class="difflineminus">-  { NULL }</span>
<a href="#l12.167"></a><span id="l12.167" class="difflineminus">-};</span>
<a href="#l12.168"></a><span id="l12.168" class="difflineplus">+    {</span>
<a href="#l12.169"></a><span id="l12.169" class="difflineplus">+        APPSTARTUP_CATEGORY,</span>
<a href="#l12.170"></a><span id="l12.170" class="difflineplus">+        &quot;Mapi Support&quot;,</span>
<a href="#l12.171"></a><span id="l12.171" class="difflineplus">+        &quot;service,&quot; NS_IMAPISUPPORT_CONTRACTID,</span>
<a href="#l12.172"></a><span id="l12.172" class="difflineplus">+    },</span>
<a href="#l12.173"></a><span id="l12.173" class="difflineplus">+    {NULL}};</span>
<a href="#l12.174"></a><span id="l12.174"> </span>
<a href="#l12.175"></a><span id="l12.175"> const mozilla::Module::CIDEntry kMAPICIDs[] = {</span>
<a href="#l12.176"></a><span id="l12.176" class="difflineminus">-  { &amp;kNS_IMAPISUPPORT_CID, false, NULL, nsMapiSupportConstructor },</span>
<a href="#l12.177"></a><span id="l12.177" class="difflineminus">-  { NULL }</span>
<a href="#l12.178"></a><span id="l12.178" class="difflineminus">-};</span>
<a href="#l12.179"></a><span id="l12.179" class="difflineplus">+    {&amp;kNS_IMAPISUPPORT_CID, false, NULL, nsMapiSupportConstructor}, {NULL}};</span>
<a href="#l12.180"></a><span id="l12.180"> </span>
<a href="#l12.181"></a><span id="l12.181"> const mozilla::Module::ContractIDEntry kMAPIContracts[] = {</span>
<a href="#l12.182"></a><span id="l12.182" class="difflineminus">-  { NS_IMAPISUPPORT_CONTRACTID, &amp;kNS_IMAPISUPPORT_CID },</span>
<a href="#l12.183"></a><span id="l12.183" class="difflineminus">-  { NULL }</span>
<a href="#l12.184"></a><span id="l12.184" class="difflineminus">-};</span>
<a href="#l12.185"></a><span id="l12.185" class="difflineplus">+    {NS_IMAPISUPPORT_CONTRACTID, &amp;kNS_IMAPISUPPORT_CID}, {NULL}};</span>
<a href="#l12.186"></a><span id="l12.186"> </span>
<a href="#l12.187"></a><span id="l12.187"> extern const mozilla::Module kMAPIModule = {</span>
<a href="#l12.188"></a><span id="l12.188" class="difflineminus">-    mozilla::Module::kVersion,</span>
<a href="#l12.189"></a><span id="l12.189" class="difflineminus">-    kMAPICIDs,</span>
<a href="#l12.190"></a><span id="l12.190" class="difflineminus">-    kMAPIContracts,</span>
<a href="#l12.191"></a><span id="l12.191" class="difflineminus">-    kMAPICategories</span>
<a href="#l12.192"></a><span id="l12.192" class="difflineminus">-};</span>
<a href="#l12.193"></a><span id="l12.193" class="difflineplus">+    mozilla::Module::kVersion, kMAPICIDs, kMAPIContracts, kMAPICategories};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/mapi/mapihook/src/msgMapiSupport.h</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/mapi/mapihook/src/msgMapiSupport.h</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -4,31 +4,32 @@</span>
<a href="#l13.4"></a><span id="l13.4"> </span>
<a href="#l13.5"></a><span id="l13.5"> #ifndef MSG_MAPI_SUPPORT_H_</span>
<a href="#l13.6"></a><span id="l13.6"> #define MSG_MAPI_SUPPORT_H_</span>
<a href="#l13.7"></a><span id="l13.7"> </span>
<a href="#l13.8"></a><span id="l13.8"> #include &quot;nsIObserver.h&quot;</span>
<a href="#l13.9"></a><span id="l13.9"> #include &quot;nsIMapiSupport.h&quot;</span>
<a href="#l13.10"></a><span id="l13.10"> #include &quot;msgMapiFactory.h&quot;</span>
<a href="#l13.11"></a><span id="l13.11"> </span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-#define NS_IMAPISUPPORT_CID \</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-  {0x8967fed2, 0xc8bb, 0x11d5, \</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineminus">-    { 0xa3, 0xe9, 0x00, 0xb0, 0xd0, 0xf3, 0xba, 0xa7 }}</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+#define NS_IMAPISUPPORT_CID                          \</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineplus">+  {                                                  \</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineplus">+    0x8967fed2, 0xc8bb, 0x11d5, {                    \</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineplus">+      0xa3, 0xe9, 0x00, 0xb0, 0xd0, 0xf3, 0xba, 0xa7 \</span>
<a href="#l13.19"></a><span id="l13.19" class="difflineplus">+    }                                                \</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineplus">+  }</span>
<a href="#l13.21"></a><span id="l13.21"> </span>
<a href="#l13.22"></a><span id="l13.22" class="difflineminus">-class nsMapiSupport : public nsIMapiSupport,</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineminus">-                      public nsIObserver</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineminus">-{</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineminus">-    public :</span>
<a href="#l13.26"></a><span id="l13.26" class="difflineminus">-        nsMapiSupport();</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineplus">+class nsMapiSupport : public nsIMapiSupport, public nsIObserver {</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineplus">+ public:</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineplus">+  nsMapiSupport();</span>
<a href="#l13.30"></a><span id="l13.30"> </span>
<a href="#l13.31"></a><span id="l13.31" class="difflineminus">-        // Declare all interface methods we must implement.</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineminus">-        NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineminus">-        NS_DECL_NSIOBSERVER</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineminus">-        NS_DECL_NSIMAPISUPPORT</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineplus">+  // Declare all interface methods we must implement.</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineplus">+  NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineplus">+  NS_DECL_NSIOBSERVER</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineplus">+  NS_DECL_NSIMAPISUPPORT</span>
<a href="#l13.39"></a><span id="l13.39"> </span>
<a href="#l13.40"></a><span id="l13.40" class="difflineminus">-    private :</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineminus">-        virtual ~nsMapiSupport();</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineplus">+ private:</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineplus">+  virtual ~nsMapiSupport();</span>
<a href="#l13.44"></a><span id="l13.44"> </span>
<a href="#l13.45"></a><span id="l13.45" class="difflineminus">-        DWORD   m_dwRegister;</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineminus">-        CMapiFactory *m_nsMapiFactory;</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineplus">+  DWORD m_dwRegister;</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineplus">+  CMapiFactory *m_nsMapiFactory;</span>
<a href="#l13.49"></a><span id="l13.49"> };</span>
<a href="#l13.50"></a><span id="l13.50"> </span>
<a href="#l13.51"></a><span id="l13.51"> #endif  // MSG_MAPI_SUPPORT_H_</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

