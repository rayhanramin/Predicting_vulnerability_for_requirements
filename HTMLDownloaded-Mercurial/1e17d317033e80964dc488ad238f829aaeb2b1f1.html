<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 20812:1e17d317033e80964dc488ad238f829aaeb2b1f1</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 1e17d317033e80964dc488ad238f829aaeb2b1f1" />
<meta property="og:url" content="/comm-central/rev/1e17d317033e80964dc488ad238f829aaeb2b1f1" />
<meta property="og:description" content="Bug 1225784 - Deal properly with incoming counter proposals;r=philipp" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 1e17d317033e80964dc488ad238f829aaeb2b1f1 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/1e17d317033e80964dc488ad238f829aaeb2b1f1">shortlog</a> |
<a href="/comm-central/log/1e17d317033e80964dc488ad238f829aaeb2b1f1">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/1e17d317033e80964dc488ad238f829aaeb2b1f1">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/1e17d317033e80964dc488ad238f829aaeb2b1f1">files</a> |
changeset |
<a href="/comm-central/raw-rev/1e17d317033e80964dc488ad238f829aaeb2b1f1">raw</a>  | <a href="/comm-central/archive/1e17d317033e80964dc488ad238f829aaeb2b1f1.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1225784">Bug 1225784</a> - Deal properly with incoming counter proposals;r=philipp
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#77;&#97;&#107;&#101;&#77;&#121;&#68;&#97;&#121;&#32;&#60;&#109;&#97;&#107;&#101;&#109;&#121;&#100;&#97;&#121;&#64;&#103;&#109;&#120;&#45;&#116;&#111;&#112;&#109;&#97;&#105;&#108;&#46;&#100;&#101;&#62;</td></tr>
<tr><td></td><td class="date age">Sun, 04 Dec 2016 13:35:52 +0100</td></tr>

<tr>
 <td>changeset 20812</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/1e17d317033e80964dc488ad238f829aaeb2b1f1">1e17d317033e80964dc488ad238f829aaeb2b1f1</a></td>
</tr>



<tr>
<td>parent 20811</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/fb75b7e909b7842179f700141b5b112e57740ba0">fb75b7e909b7842179f700141b5b112e57740ba0</a>
</td>
</tr>

<tr>
<td>child 20813</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/cd64861e22c692f2237e60b141b113ec0a8d0665">cd64861e22c692f2237e60b141b113ec0a8d0665</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=1e17d317033e80964dc488ad238f829aaeb2b1f1">12612</a></td></tr>
<tr><td>push user</td><td>makemyday@gmx-topmail.de</td></tr>
<tr><td>push date</td><td class="date age">Sun, 04 Dec 2016 19:35:24 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@9290eb29cde9 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=9290eb29cde94f5912fef14d0fa67c445c4f522c">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=9290eb29cde94f5912fef14d0fa67c445c4f522c&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=9290eb29cde94f5912fef14d0fa67c445c4f522c&newProject=comm-central&newRevision=fcaede61f5c17597a55035feadc6beb7438f388d&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=9290eb29cde94f5912fef14d0fa67c445c4f522c&newProject=comm-central&newRevision=fcaede61f5c17597a55035feadc6beb7438f388d&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=9290eb29cde94f5912fef14d0fa67c445c4f522c&newProject=comm-central&newRevision=fcaede61f5c17597a55035feadc6beb7438f388d&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28philipp%29&revcount=50">philipp</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1225784">1225784</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1225784">Bug 1225784</a> - Deal properly with incoming counter proposals;r=philipp</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/base/content/calendar-item-editing.js">calendar/base/content/calendar-item-editing.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/base/content/calendar-item-editing.js">file</a> |
<a href="/comm-central/annotate/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/base/content/calendar-item-editing.js">annotate</a> |
<a href="/comm-central/diff/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/base/content/calendar-item-editing.js">diff</a> |
<a href="/comm-central/comparison/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/base/content/calendar-item-editing.js">comparison</a> |
<a href="/comm-central/log/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/base/content/calendar-item-editing.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/base/modules/calItipUtils.jsm">calendar/base/modules/calItipUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/base/modules/calItipUtils.jsm">file</a> |
<a href="/comm-central/annotate/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/base/modules/calItipUtils.jsm">annotate</a> |
<a href="/comm-central/diff/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/base/modules/calItipUtils.jsm">diff</a> |
<a href="/comm-central/comparison/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/base/modules/calItipUtils.jsm">comparison</a> |
<a href="/comm-central/log/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/base/modules/calItipUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/base/modules/calUtils.jsm">calendar/base/modules/calUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/base/modules/calUtils.jsm">file</a> |
<a href="/comm-central/annotate/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/base/modules/calUtils.jsm">annotate</a> |
<a href="/comm-central/diff/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/base/modules/calUtils.jsm">diff</a> |
<a href="/comm-central/comparison/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/base/modules/calUtils.jsm">comparison</a> |
<a href="/comm-central/log/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/base/modules/calUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/base/public/calIItipItem.idl">calendar/base/public/calIItipItem.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/base/public/calIItipItem.idl">file</a> |
<a href="/comm-central/annotate/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/base/public/calIItipItem.idl">annotate</a> |
<a href="/comm-central/diff/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/base/public/calIItipItem.idl">diff</a> |
<a href="/comm-central/comparison/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/base/public/calIItipItem.idl">comparison</a> |
<a href="/comm-central/log/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/base/public/calIItipItem.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/base/src/calItipItem.js">calendar/base/src/calItipItem.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/base/src/calItipItem.js">file</a> |
<a href="/comm-central/annotate/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/base/src/calItipItem.js">annotate</a> |
<a href="/comm-central/diff/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/base/src/calItipItem.js">diff</a> |
<a href="/comm-central/comparison/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/base/src/calItipItem.js">comparison</a> |
<a href="/comm-central/log/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/base/src/calItipItem.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/base/src/calUtils.js">calendar/base/src/calUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/base/src/calUtils.js">file</a> |
<a href="/comm-central/annotate/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/base/src/calUtils.js">annotate</a> |
<a href="/comm-central/diff/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/base/src/calUtils.js">diff</a> |
<a href="/comm-central/comparison/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/base/src/calUtils.js">comparison</a> |
<a href="/comm-central/log/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/base/src/calUtils.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/base/themes/common/dialogs/calendar-event-dialog.css">calendar/base/themes/common/dialogs/calendar-event-dialog.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/base/themes/common/dialogs/calendar-event-dialog.css">file</a> |
<a href="/comm-central/annotate/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/base/themes/common/dialogs/calendar-event-dialog.css">annotate</a> |
<a href="/comm-central/diff/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/base/themes/common/dialogs/calendar-event-dialog.css">diff</a> |
<a href="/comm-central/comparison/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/base/themes/common/dialogs/calendar-event-dialog.css">comparison</a> |
<a href="/comm-central/log/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/base/themes/common/dialogs/calendar-event-dialog.css">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/itip/calItipEmailTransport.js">calendar/itip/calItipEmailTransport.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/itip/calItipEmailTransport.js">file</a> |
<a href="/comm-central/annotate/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/itip/calItipEmailTransport.js">annotate</a> |
<a href="/comm-central/diff/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/itip/calItipEmailTransport.js">diff</a> |
<a href="/comm-central/comparison/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/itip/calItipEmailTransport.js">comparison</a> |
<a href="/comm-central/log/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/itip/calItipEmailTransport.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/lightning/components/lightningTextCalendarConverter.js">calendar/lightning/components/lightningTextCalendarConverter.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/lightning/components/lightningTextCalendarConverter.js">file</a> |
<a href="/comm-central/annotate/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/lightning/components/lightningTextCalendarConverter.js">annotate</a> |
<a href="/comm-central/diff/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/lightning/components/lightningTextCalendarConverter.js">diff</a> |
<a href="/comm-central/comparison/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/lightning/components/lightningTextCalendarConverter.js">comparison</a> |
<a href="/comm-central/log/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/lightning/components/lightningTextCalendarConverter.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/lightning/content/imip-bar-overlay.xul">calendar/lightning/content/imip-bar-overlay.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/lightning/content/imip-bar-overlay.xul">file</a> |
<a href="/comm-central/annotate/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/lightning/content/imip-bar-overlay.xul">annotate</a> |
<a href="/comm-central/diff/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/lightning/content/imip-bar-overlay.xul">diff</a> |
<a href="/comm-central/comparison/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/lightning/content/imip-bar-overlay.xul">comparison</a> |
<a href="/comm-central/log/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/lightning/content/imip-bar-overlay.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/lightning/content/imip-bar.js">calendar/lightning/content/imip-bar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/lightning/content/imip-bar.js">file</a> |
<a href="/comm-central/annotate/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/lightning/content/imip-bar.js">annotate</a> |
<a href="/comm-central/diff/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/lightning/content/imip-bar.js">diff</a> |
<a href="/comm-central/comparison/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/lightning/content/imip-bar.js">comparison</a> |
<a href="/comm-central/log/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/lightning/content/imip-bar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/lightning/content/lightning-item-iframe.js">calendar/lightning/content/lightning-item-iframe.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/lightning/content/lightning-item-iframe.js">file</a> |
<a href="/comm-central/annotate/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/lightning/content/lightning-item-iframe.js">annotate</a> |
<a href="/comm-central/diff/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/lightning/content/lightning-item-iframe.js">diff</a> |
<a href="/comm-central/comparison/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/lightning/content/lightning-item-iframe.js">comparison</a> |
<a href="/comm-central/log/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/lightning/content/lightning-item-iframe.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/lightning/content/lightning-item-iframe.xul">calendar/lightning/content/lightning-item-iframe.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/lightning/content/lightning-item-iframe.xul">file</a> |
<a href="/comm-central/annotate/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/lightning/content/lightning-item-iframe.xul">annotate</a> |
<a href="/comm-central/diff/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/lightning/content/lightning-item-iframe.xul">diff</a> |
<a href="/comm-central/comparison/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/lightning/content/lightning-item-iframe.xul">comparison</a> |
<a href="/comm-central/log/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/lightning/content/lightning-item-iframe.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/lightning/modules/ltnInvitationUtils.jsm">calendar/lightning/modules/ltnInvitationUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/lightning/modules/ltnInvitationUtils.jsm">file</a> |
<a href="/comm-central/annotate/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/lightning/modules/ltnInvitationUtils.jsm">annotate</a> |
<a href="/comm-central/diff/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/lightning/modules/ltnInvitationUtils.jsm">diff</a> |
<a href="/comm-central/comparison/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/lightning/modules/ltnInvitationUtils.jsm">comparison</a> |
<a href="/comm-central/log/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/lightning/modules/ltnInvitationUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/lightning/themes/linux/lightning.css">calendar/lightning/themes/linux/lightning.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/lightning/themes/linux/lightning.css">file</a> |
<a href="/comm-central/annotate/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/lightning/themes/linux/lightning.css">annotate</a> |
<a href="/comm-central/diff/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/lightning/themes/linux/lightning.css">diff</a> |
<a href="/comm-central/comparison/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/lightning/themes/linux/lightning.css">comparison</a> |
<a href="/comm-central/log/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/lightning/themes/linux/lightning.css">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/lightning/themes/osx/lightning.css">calendar/lightning/themes/osx/lightning.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/lightning/themes/osx/lightning.css">file</a> |
<a href="/comm-central/annotate/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/lightning/themes/osx/lightning.css">annotate</a> |
<a href="/comm-central/diff/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/lightning/themes/osx/lightning.css">diff</a> |
<a href="/comm-central/comparison/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/lightning/themes/osx/lightning.css">comparison</a> |
<a href="/comm-central/log/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/lightning/themes/osx/lightning.css">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/lightning/themes/windows/lightning.css">calendar/lightning/themes/windows/lightning.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/lightning/themes/windows/lightning.css">file</a> |
<a href="/comm-central/annotate/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/lightning/themes/windows/lightning.css">annotate</a> |
<a href="/comm-central/diff/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/lightning/themes/windows/lightning.css">diff</a> |
<a href="/comm-central/comparison/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/lightning/themes/windows/lightning.css">comparison</a> |
<a href="/comm-central/log/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/lightning/themes/windows/lightning.css">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/locales/en-US/chrome/calendar/calendar-event-dialog.dtd">calendar/locales/en-US/chrome/calendar/calendar-event-dialog.dtd</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/locales/en-US/chrome/calendar/calendar-event-dialog.dtd">file</a> |
<a href="/comm-central/annotate/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/locales/en-US/chrome/calendar/calendar-event-dialog.dtd">annotate</a> |
<a href="/comm-central/diff/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/locales/en-US/chrome/calendar/calendar-event-dialog.dtd">diff</a> |
<a href="/comm-central/comparison/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/locales/en-US/chrome/calendar/calendar-event-dialog.dtd">comparison</a> |
<a href="/comm-central/log/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/locales/en-US/chrome/calendar/calendar-event-dialog.dtd">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/locales/en-US/chrome/lightning/lightning.properties">calendar/locales/en-US/chrome/lightning/lightning.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/locales/en-US/chrome/lightning/lightning.properties">file</a> |
<a href="/comm-central/annotate/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/locales/en-US/chrome/lightning/lightning.properties">annotate</a> |
<a href="/comm-central/diff/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/locales/en-US/chrome/lightning/lightning.properties">diff</a> |
<a href="/comm-central/comparison/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/locales/en-US/chrome/lightning/lightning.properties">comparison</a> |
<a href="/comm-central/log/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/locales/en-US/chrome/lightning/lightning.properties">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/test/unit/test_calitiputils.js">calendar/test/unit/test_calitiputils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/test/unit/test_calitiputils.js">file</a> |
<a href="/comm-central/annotate/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/test/unit/test_calitiputils.js">annotate</a> |
<a href="/comm-central/diff/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/test/unit/test_calitiputils.js">diff</a> |
<a href="/comm-central/comparison/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/test/unit/test_calitiputils.js">comparison</a> |
<a href="/comm-central/log/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/test/unit/test_calitiputils.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/test/unit/test_calutils.js">calendar/test/unit/test_calutils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/test/unit/test_calutils.js">file</a> |
<a href="/comm-central/annotate/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/test/unit/test_calutils.js">annotate</a> |
<a href="/comm-central/diff/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/test/unit/test_calutils.js">diff</a> |
<a href="/comm-central/comparison/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/test/unit/test_calutils.js">comparison</a> |
<a href="/comm-central/log/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/test/unit/test_calutils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/test/unit/test_ltninvitationutils.js">calendar/test/unit/test_ltninvitationutils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/test/unit/test_ltninvitationutils.js">file</a> |
<a href="/comm-central/annotate/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/test/unit/test_ltninvitationutils.js">annotate</a> |
<a href="/comm-central/diff/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/test/unit/test_ltninvitationutils.js">diff</a> |
<a href="/comm-central/comparison/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/test/unit/test_ltninvitationutils.js">comparison</a> |
<a href="/comm-central/log/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/test/unit/test_ltninvitationutils.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/test/unit/xpcshell-shared.ini">calendar/test/unit/xpcshell-shared.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/test/unit/xpcshell-shared.ini">file</a> |
<a href="/comm-central/annotate/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/test/unit/xpcshell-shared.ini">annotate</a> |
<a href="/comm-central/diff/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/test/unit/xpcshell-shared.ini">diff</a> |
<a href="/comm-central/comparison/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/test/unit/xpcshell-shared.ini">comparison</a> |
<a href="/comm-central/log/1e17d317033e80964dc488ad238f829aaeb2b1f1/calendar/test/unit/xpcshell-shared.ini">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/calendar/base/content/calendar-item-editing.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/calendar/base/content/calendar-item-editing.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -264,17 +264,17 @@ function createEventWithDialog(calendar,</span>
<a href="#l1.4"></a><span id="l1.4">         event = cal.createEvent();</span>
<a href="#l1.5"></a><span id="l1.5"> </span>
<a href="#l1.6"></a><span id="l1.6">         let refDate = currentView().initialized &amp;&amp; currentView().selectedDay.clone();</span>
<a href="#l1.7"></a><span id="l1.7">         setDefaultItemValues(event, calendar, startDate, endDate, refDate, aForceAllday);</span>
<a href="#l1.8"></a><span id="l1.8">         if (summary) {</span>
<a href="#l1.9"></a><span id="l1.9">             event.title = summary;</span>
<a href="#l1.10"></a><span id="l1.10">         }</span>
<a href="#l1.11"></a><span id="l1.11">     }</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-    openEventDialog(event, event.calendar, &quot;new&quot;, onNewEvent, null);</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+    openEventDialog(event, event.calendar, &quot;new&quot;, onNewEvent);</span>
<a href="#l1.14"></a><span id="l1.14"> }</span>
<a href="#l1.15"></a><span id="l1.15"> </span>
<a href="#l1.16"></a><span id="l1.16"> /**</span>
<a href="#l1.17"></a><span id="l1.17">  * Creates a task with the calendar event dialog.</span>
<a href="#l1.18"></a><span id="l1.18">  *</span>
<a href="#l1.19"></a><span id="l1.19">  * @param calendar      (optional) The calendar to create the task in</span>
<a href="#l1.20"></a><span id="l1.20">  * @param dueDate       (optional) The task's due date.</span>
<a href="#l1.21"></a><span id="l1.21">  * @param summary       (optional) The task's title.</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineat">@@ -321,18 +321,31 @@ function createTodoWithDialog(calendar, </span>
<a href="#l1.23"></a><span id="l1.23">  * Modifies the passed event in the event dialog.</span>
<a href="#l1.24"></a><span id="l1.24">  *</span>
<a href="#l1.25"></a><span id="l1.25">  * @param aItem                 The item to modify.</span>
<a href="#l1.26"></a><span id="l1.26">  * @param job                   (optional) The job object that controls this</span>
<a href="#l1.27"></a><span id="l1.27">  *                                           modification.</span>
<a href="#l1.28"></a><span id="l1.28">  * @param aPromptOccurrence     If the user should be prompted to select if the</span>
<a href="#l1.29"></a><span id="l1.29">  *                                parent item or occurrence should be modified.</span>
<a href="#l1.30"></a><span id="l1.30">  * @param initialDate           (optional) The initial date for new task datepickers</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+ * @param aCounterProposal      (optional) An object representing the counterproposal</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+ *        {</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+ *            {JsObject} result: {</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+ *                type: {String} &quot;OK&quot;|&quot;OUTDATED&quot;|&quot;NOTLATESTUPDATE&quot;|&quot;ERROR&quot;|&quot;NODIFF&quot;</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineplus">+ *                descr: {String} a technical description of the problem if type is ERROR or NODIFF,</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineplus">+ *                                otherwise an empty string </span>
<a href="#l1.37"></a><span id="l1.37" class="difflineplus">+ *            },</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineplus">+ *            (empty if result.type = &quot;ERROR&quot;|&quot;NODIFF&quot;){Array} differences: [{</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineplus">+ *                property: {String} a property that is subject to the proposal</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+ *                proposed: {String} the proposed value</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineplus">+ *                original: {String} the original value</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineplus">+ *            }]</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineplus">+ *        }</span>
<a href="#l1.44"></a><span id="l1.44">  */</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineminus">-function modifyEventWithDialog(aItem, job, aPromptOccurrence, initialDate) {</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineplus">+function modifyEventWithDialog(aItem, job=null, aPromptOccurrence, initialDate=null, aCounterProposal) {</span>
<a href="#l1.47"></a><span id="l1.47">     let dlg = cal.findItemWindow(aItem);</span>
<a href="#l1.48"></a><span id="l1.48">     if (dlg) {</span>
<a href="#l1.49"></a><span id="l1.49">         dlg.focus();</span>
<a href="#l1.50"></a><span id="l1.50">         disposeJob(job);</span>
<a href="#l1.51"></a><span id="l1.51">         return;</span>
<a href="#l1.52"></a><span id="l1.52">     }</span>
<a href="#l1.53"></a><span id="l1.53"> </span>
<a href="#l1.54"></a><span id="l1.54">     let onModifyItem = function(item, calendar, originalItem, listener) {</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineat">@@ -341,33 +354,36 @@ function modifyEventWithDialog(aItem, jo</span>
<a href="#l1.56"></a><span id="l1.56"> </span>
<a href="#l1.57"></a><span id="l1.57">     let item = aItem;</span>
<a href="#l1.58"></a><span id="l1.58">     let response;</span>
<a href="#l1.59"></a><span id="l1.59">     if (aPromptOccurrence !== false) {</span>
<a href="#l1.60"></a><span id="l1.60">         [item, , response] = promptOccurrenceModification(aItem, true, &quot;edit&quot;);</span>
<a href="#l1.61"></a><span id="l1.61">     }</span>
<a href="#l1.62"></a><span id="l1.62"> </span>
<a href="#l1.63"></a><span id="l1.63">     if (item &amp;&amp; (response || response === undefined)) {</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineminus">-        openEventDialog(item, item.calendar, &quot;modify&quot;, onModifyItem, job, initialDate);</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineplus">+        openEventDialog(item, item.calendar, &quot;modify&quot;, onModifyItem, job, initialDate,</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineplus">+                        aCounterProposal);</span>
<a href="#l1.67"></a><span id="l1.67">     } else {</span>
<a href="#l1.68"></a><span id="l1.68">         disposeJob(job);</span>
<a href="#l1.69"></a><span id="l1.69">     }</span>
<a href="#l1.70"></a><span id="l1.70"> }</span>
<a href="#l1.71"></a><span id="l1.71"> </span>
<a href="#l1.72"></a><span id="l1.72"> /**</span>
<a href="#l1.73"></a><span id="l1.73">  * Opens the event dialog with the given item (task OR event)</span>
<a href="#l1.74"></a><span id="l1.74">  *</span>
<a href="#l1.75"></a><span id="l1.75">  * @param calendarItem      The item to open the dialog with</span>
<a href="#l1.76"></a><span id="l1.76">  * @param calendar          The calendar to open the dialog with.</span>
<a href="#l1.77"></a><span id="l1.77">  * @param mode              The operation the dialog should do (&quot;new&quot;, &quot;modify&quot;)</span>
<a href="#l1.78"></a><span id="l1.78">  * @param callback          The callback to call when the dialog has completed.</span>
<a href="#l1.79"></a><span id="l1.79">  * @param job               (optional) The job object for the modification.</span>
<a href="#l1.80"></a><span id="l1.80">  * @param initialDate       (optional) The initial date for new task datepickers</span>
<a href="#l1.81"></a><span id="l1.81" class="difflineplus">+ * @param counterProposal   (optional) An object representing the counterproposal - see</span>
<a href="#l1.82"></a><span id="l1.82" class="difflineplus">+ *                                     description for modifyEventWithDialog()</span>
<a href="#l1.83"></a><span id="l1.83">  */</span>
<a href="#l1.84"></a><span id="l1.84" class="difflineminus">-function openEventDialog(calendarItem, calendar, mode, callback, job, initialDate) {</span>
<a href="#l1.85"></a><span id="l1.85" class="difflineplus">+function openEventDialog(calendarItem, calendar, mode, callback, job=null, initialDate=null, counterProposal) {</span>
<a href="#l1.86"></a><span id="l1.86">     let dlg = cal.findItemWindow(calendarItem);</span>
<a href="#l1.87"></a><span id="l1.87">     if (dlg) {</span>
<a href="#l1.88"></a><span id="l1.88">         dlg.focus();</span>
<a href="#l1.89"></a><span id="l1.89">         disposeJob(job);</span>
<a href="#l1.90"></a><span id="l1.90">         return;</span>
<a href="#l1.91"></a><span id="l1.91">     }</span>
<a href="#l1.92"></a><span id="l1.92"> </span>
<a href="#l1.93"></a><span id="l1.93">     // Set up some defaults</span>
<a href="#l1.94"></a><span id="l1.94" class="difflineat">@@ -433,16 +449,17 @@ function openEventDialog(calendarItem, c</span>
<a href="#l1.95"></a><span id="l1.95">     // Setup the window arguments</span>
<a href="#l1.96"></a><span id="l1.96">     let args = {};</span>
<a href="#l1.97"></a><span id="l1.97">     args.calendarEvent = calendarItem;</span>
<a href="#l1.98"></a><span id="l1.98">     args.calendar = calendar;</span>
<a href="#l1.99"></a><span id="l1.99">     args.mode = mode;</span>
<a href="#l1.100"></a><span id="l1.100">     args.onOk = callback;</span>
<a href="#l1.101"></a><span id="l1.101">     args.job = job;</span>
<a href="#l1.102"></a><span id="l1.102">     args.initialStartDateValue = initialDate || getDefaultStartDate();</span>
<a href="#l1.103"></a><span id="l1.103" class="difflineplus">+    args.counterProposal = counterProposal;</span>
<a href="#l1.104"></a><span id="l1.104">     args.inTab = Preferences.get(&quot;calendar.item.editInTab&quot;, false);</span>
<a href="#l1.105"></a><span id="l1.105">     args.useNewItemUI = Preferences.get(&quot;calendar.item.useNewItemUI&quot;, false);</span>
<a href="#l1.106"></a><span id="l1.106"> </span>
<a href="#l1.107"></a><span id="l1.107">     // this will be called if file-&gt;new has been selected from within the dialog</span>
<a href="#l1.108"></a><span id="l1.108">     args.onNewEvent = function(opcalendar) {</span>
<a href="#l1.109"></a><span id="l1.109">         createEventWithDialog(opcalendar, null, null);</span>
<a href="#l1.110"></a><span id="l1.110">     };</span>
<a href="#l1.111"></a><span id="l1.111">     args.onNewTodo = function(opcalendar) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/calendar/base/modules/calItipUtils.jsm</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/calendar/base/modules/calItipUtils.jsm</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -75,37 +75,67 @@ cal.itip = {</span>
<a href="#l2.4"></a><span id="l2.4">                 dtstamp = item.stampTime;</span>
<a href="#l2.5"></a><span id="l2.5">             }</span>
<a href="#l2.6"></a><span id="l2.6">         }</span>
<a href="#l2.7"></a><span id="l2.7"> </span>
<a href="#l2.8"></a><span id="l2.8">         return dtstamp;</span>
<a href="#l2.9"></a><span id="l2.9">     },</span>
<a href="#l2.10"></a><span id="l2.10"> </span>
<a href="#l2.11"></a><span id="l2.11">     /**</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-     * Compares sequences and/or stamps of two parties; returns -1, 0, +1.</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+     * Compares sequences and/or stamps of two items</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+     *</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+     * @param {calIEvent|calIToDo|calIAttendee} aItem1</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+     * @param {calIEvent|calIToDo|calIAttendee} aItem2</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+     * @return {Integer} +1 if item2 is newer, -1 if item1 is newer or 0 if both are equal</span>
<a href="#l2.18"></a><span id="l2.18">      */</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineminus">-    compare: function(item1, item2) {</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineminus">-        let seq1 = cal.itip.getSequence(item1);</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineminus">-        let seq2 = cal.itip.getSequence(item2);</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineplus">+    compare: function(aItem1, aItem2) {</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineplus">+        let comp = cal.itip.compareSequence(aItem1, aItem2);</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineplus">+        if (comp == 0) {</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineplus">+            comp = cal.itip.compareStamp(aItem1, aItem2);</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineplus">+        }</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineplus">+        return comp;</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineplus">+    },</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineplus">+</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineplus">+    /**</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+     * Compares sequences of two items</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+     *</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+     * @param {calIEvent|calIToDo|calIAttendee} aItem1</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+     * @param {calIEvent|calIToDo|calIAttendee} aItem2</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+     * @return {Integer} +1 if item2 is newer, -1 if item1 is newer or 0 if both are equal</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+     */</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+    compareSequence: function(aItem1, aItem2) {</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+        let seq1 = cal.itip.getSequence(aItem1);</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+        let seq2 = cal.itip.getSequence(aItem2);</span>
<a href="#l2.40"></a><span id="l2.40">         if (seq1 &gt; seq2) {</span>
<a href="#l2.41"></a><span id="l2.41">             return 1;</span>
<a href="#l2.42"></a><span id="l2.42">         } else if (seq1 &lt; seq2) {</span>
<a href="#l2.43"></a><span id="l2.43">             return -1;</span>
<a href="#l2.44"></a><span id="l2.44">         } else {</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineminus">-            let st1 = cal.itip.getStamp(item1);</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineminus">-            let st2 = cal.itip.getStamp(item2);</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineminus">-            if (st1 &amp;&amp; st2) {</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineminus">-                return st1.compare(st2);</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineminus">-            } else if (!st1 &amp;&amp; st2) {</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineminus">-                return -1;</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineminus">-            } else if (st1 &amp;&amp; !st2) {</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineminus">-                return 1;</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineminus">-            } else {</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineminus">-                return 0;</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineminus">-            }</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineplus">+            return 0;</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineplus">+        }</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineplus">+    },</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineplus">+</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineplus">+    /**</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineplus">+     * Compares stamp of two items</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineplus">+     *</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineplus">+     * @param {calIEvent|calIToDo|calIAttendee} aItem1</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineplus">+     * @param {calIEvent|calIToDo|calIAttendee} aItem2</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineplus">+     * @return {Integer} +1 if item2 is newer, -1 if item1 is newer or 0 if both are equal</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineplus">+     */</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineplus">+    compareStamp: function(aItem1, aItem2) {</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineplus">+        let st1 = cal.itip.getStamp(aItem1);</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineplus">+        let st2 = cal.itip.getStamp(aItem2);</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineplus">+        if (st1 &amp;&amp; st2) {</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineplus">+            return st1.compare(st2);</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineplus">+        } else if (!st1 &amp;&amp; st2) {</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineplus">+            return -1;</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineplus">+        } else if (st1 &amp;&amp; !st2) {</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineplus">+            return 1;</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineplus">+        } else {</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineplus">+            return 0;</span>
<a href="#l2.78"></a><span id="l2.78">         }</span>
<a href="#l2.79"></a><span id="l2.79">     },</span>
<a href="#l2.80"></a><span id="l2.80"> </span>
<a href="#l2.81"></a><span id="l2.81">     /**</span>
<a href="#l2.82"></a><span id="l2.82">      * Checks if the given calendar is a scheduling calendar. This means it</span>
<a href="#l2.83"></a><span id="l2.83">      * needs an organizer id and an itip transport. It should also be writable.</span>
<a href="#l2.84"></a><span id="l2.84">      *</span>
<a href="#l2.85"></a><span id="l2.85">      * @param calendar    The calendar to check</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineat">@@ -122,16 +152,19 @@ cal.itip = {</span>
<a href="#l2.87"></a><span id="l2.87">      *</span>
<a href="#l2.88"></a><span id="l2.88">      * Given an nsIMsgDBHdr and an imipMethod, set up the given itip item.</span>
<a href="#l2.89"></a><span id="l2.89">      *</span>
<a href="#l2.90"></a><span id="l2.90">      * @param itipItem    The item to set up</span>
<a href="#l2.91"></a><span id="l2.91">      * @param imipMethod  The received imip method</span>
<a href="#l2.92"></a><span id="l2.92">      * @param aMsgHdr     Information about the received email</span>
<a href="#l2.93"></a><span id="l2.93">      */</span>
<a href="#l2.94"></a><span id="l2.94">     initItemFromMsgData: function(itipItem, imipMethod, aMsgHdr) {</span>
<a href="#l2.95"></a><span id="l2.95" class="difflineplus">+        // set the sender of the itip message</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineplus">+        itipItem.sender = cal.itip.getMessageSender(aMsgHdr);</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineplus">+</span>
<a href="#l2.98"></a><span id="l2.98">         // Get the recipient identity and save it with the itip item.</span>
<a href="#l2.99"></a><span id="l2.99">         itipItem.identity = cal.itip.getMessageRecipient(aMsgHdr);</span>
<a href="#l2.100"></a><span id="l2.100"> </span>
<a href="#l2.101"></a><span id="l2.101">         // We are only called upon receipt of an invite, so ensure that isSend</span>
<a href="#l2.102"></a><span id="l2.102">         // is false.</span>
<a href="#l2.103"></a><span id="l2.103">         itipItem.isSend = false;</span>
<a href="#l2.104"></a><span id="l2.104"> </span>
<a href="#l2.105"></a><span id="l2.105">         // XXX Get these from preferences</span>
<a href="#l2.106"></a><span id="l2.106" class="difflineat">@@ -204,16 +237,18 @@ cal.itip = {</span>
<a href="#l2.107"></a><span id="l2.107">         }</span>
<a href="#l2.108"></a><span id="l2.108"> </span>
<a href="#l2.109"></a><span id="l2.109">         switch (method) {</span>
<a href="#l2.110"></a><span id="l2.110">             case &quot;REFRESH&quot;: return _gs(&quot;imipBarRefreshText&quot;);</span>
<a href="#l2.111"></a><span id="l2.111">             case &quot;REQUEST&quot;: return _gs(&quot;imipBarRequestText&quot;);</span>
<a href="#l2.112"></a><span id="l2.112">             case &quot;PUBLISH&quot;: return _gs(&quot;imipBarPublishText&quot;);</span>
<a href="#l2.113"></a><span id="l2.113">             case &quot;CANCEL&quot;: return _gs(&quot;imipBarCancelText&quot;);</span>
<a href="#l2.114"></a><span id="l2.114">             case &quot;REPLY&quot;: return _gs(&quot;imipBarReplyText&quot;);</span>
<a href="#l2.115"></a><span id="l2.115" class="difflineplus">+            case &quot;COUNTER&quot;: return _gs(&quot;imipBarCounterText&quot;);</span>
<a href="#l2.116"></a><span id="l2.116" class="difflineplus">+            case &quot;DECLINECOUNTER&quot;: return _gs(&quot;imipBarDeclineCounterText&quot;);</span>
<a href="#l2.117"></a><span id="l2.117">             default:</span>
<a href="#l2.118"></a><span id="l2.118">                 cal.ERROR(&quot;Unknown iTIP method: &quot; + method);</span>
<a href="#l2.119"></a><span id="l2.119">                 return _gs(&quot;imipBarUnsupportedText&quot;);</span>
<a href="#l2.120"></a><span id="l2.120">         }</span>
<a href="#l2.121"></a><span id="l2.121">     },</span>
<a href="#l2.122"></a><span id="l2.122"> </span>
<a href="#l2.123"></a><span id="l2.123">     /**</span>
<a href="#l2.124"></a><span id="l2.124">      * Scope: iTIP message receiver</span>
<a href="#l2.125"></a><span id="l2.125" class="difflineat">@@ -237,41 +272,70 @@ cal.itip = {</span>
<a href="#l2.126"></a><span id="l2.126">             return cal.calGetString(&quot;lightning&quot;, strName, null, &quot;lightning&quot;);</span>
<a href="#l2.127"></a><span id="l2.127">         }</span>
<a href="#l2.128"></a><span id="l2.128">         let imipLabel = null;</span>
<a href="#l2.129"></a><span id="l2.129">         if (itipItem.receivedMethod) {</span>
<a href="#l2.130"></a><span id="l2.130">             imipLabel = cal.itip.getMethodText(itipItem.receivedMethod);</span>
<a href="#l2.131"></a><span id="l2.131">         }</span>
<a href="#l2.132"></a><span id="l2.132">         let data = { label: imipLabel, buttons: [], hideMenuItems: [] };</span>
<a href="#l2.133"></a><span id="l2.133"> </span>
<a href="#l2.134"></a><span id="l2.134" class="difflineplus">+        let disallowedCounter = false;</span>
<a href="#l2.135"></a><span id="l2.135" class="difflineplus">+        if (foundItems &amp;&amp; foundItems.length) {</span>
<a href="#l2.136"></a><span id="l2.136" class="difflineplus">+             let disallow = foundItems[0].getProperty(&quot;X-MICROSOFT-DISALLOW-COUNTER&quot;);</span>
<a href="#l2.137"></a><span id="l2.137" class="difflineplus">+             disallowedCounter = disallow &amp;&amp; disallow == &quot;TRUE&quot;;</span>
<a href="#l2.138"></a><span id="l2.138" class="difflineplus">+        }</span>
<a href="#l2.139"></a><span id="l2.139">         if (rc == Components.interfaces.calIErrors.CAL_IS_READONLY) {</span>
<a href="#l2.140"></a><span id="l2.140">             // No writable calendars, tell the user about it</span>
<a href="#l2.141"></a><span id="l2.141">             data.label = _gs(&quot;imipBarNotWritable&quot;);</span>
<a href="#l2.142"></a><span id="l2.142">         } else if (Components.isSuccessCode(rc) &amp;&amp; !actionFunc) {</span>
<a href="#l2.143"></a><span id="l2.143">             // This case, they clicked on an old message that has already been</span>
<a href="#l2.144"></a><span id="l2.144">             // added/updated, we want to tell them that.</span>
<a href="#l2.145"></a><span id="l2.145">             data.label = _gs(&quot;imipBarAlreadyProcessedText&quot;);</span>
<a href="#l2.146"></a><span id="l2.146">             if (foundItems &amp;&amp; foundItems.length) {</span>
<a href="#l2.147"></a><span id="l2.147" class="difflineminus">-                // Not a real method, but helps us decide</span>
<a href="#l2.148"></a><span id="l2.148">                 data.buttons.push(&quot;imipDetailsButton&quot;);</span>
<a href="#l2.149"></a><span id="l2.149" class="difflineplus">+                if (itipItem.receivedMethod == &quot;COUNTER&quot; &amp;&amp; itipItem.sender) {</span>
<a href="#l2.150"></a><span id="l2.150" class="difflineplus">+                    if (disallowedCounter) {</span>
<a href="#l2.151"></a><span id="l2.151" class="difflineplus">+                        data.label = _gs(&quot;imipBarDisallowedCounterText&quot;);</span>
<a href="#l2.152"></a><span id="l2.152" class="difflineplus">+                    } else {</span>
<a href="#l2.153"></a><span id="l2.153" class="difflineplus">+                        let comparison;</span>
<a href="#l2.154"></a><span id="l2.154" class="difflineplus">+                        for (let item of itipItem.getItemList({})) {</span>
<a href="#l2.155"></a><span id="l2.155" class="difflineplus">+                            let attendees = cal.getAttendeesBySender(</span>
<a href="#l2.156"></a><span id="l2.156" class="difflineplus">+                                    item.getAttendees({}),</span>
<a href="#l2.157"></a><span id="l2.157" class="difflineplus">+                                    itipItem.sender</span>
<a href="#l2.158"></a><span id="l2.158" class="difflineplus">+                            );</span>
<a href="#l2.159"></a><span id="l2.159" class="difflineplus">+                            if (attendees.length == 1) {</span>
<a href="#l2.160"></a><span id="l2.160" class="difflineplus">+                                let replyer = foundItems[0].getAttendeeById(attendees[0].id);</span>
<a href="#l2.161"></a><span id="l2.161" class="difflineplus">+                                comparison = cal.itip.compareSequence(item, foundItems[0]);</span>
<a href="#l2.162"></a><span id="l2.162" class="difflineplus">+                                if (comparison == 1) {</span>
<a href="#l2.163"></a><span id="l2.163" class="difflineplus">+                                    data.label = _gs(&quot;imipBarCounterErrorText&quot;);</span>
<a href="#l2.164"></a><span id="l2.164" class="difflineplus">+                                    break;</span>
<a href="#l2.165"></a><span id="l2.165" class="difflineplus">+                                } else if (comparison == -1) {</span>
<a href="#l2.166"></a><span id="l2.166" class="difflineplus">+                                    data.label = _gs(&quot;imipBarCounterPreviousVersionText&quot;);</span>
<a href="#l2.167"></a><span id="l2.167" class="difflineplus">+                                }</span>
<a href="#l2.168"></a><span id="l2.168" class="difflineplus">+                            }</span>
<a href="#l2.169"></a><span id="l2.169" class="difflineplus">+                        }</span>
<a href="#l2.170"></a><span id="l2.170" class="difflineplus">+                    }</span>
<a href="#l2.171"></a><span id="l2.171" class="difflineplus">+                }</span>
<a href="#l2.172"></a><span id="l2.172">             } else if (itipItem.receivedMethod == &quot;REPLY&quot;) {</span>
<a href="#l2.173"></a><span id="l2.173">                 // The item has been previously removed from the available calendars or the calendar</span>
<a href="#l2.174"></a><span id="l2.174">                 // containing the item is not available</span>
<a href="#l2.175"></a><span id="l2.175">                 let delmgr = Components.classes[&quot;@mozilla.org/calendar/deleted-items-manager;1&quot;]</span>
<a href="#l2.176"></a><span id="l2.176">                                        .getService(Components.interfaces.calIDeletedItems);</span>
<a href="#l2.177"></a><span id="l2.177">                 let delTime = null;</span>
<a href="#l2.178"></a><span id="l2.178">                 let items = itipItem.getItemList({});</span>
<a href="#l2.179"></a><span id="l2.179">                 if (items &amp;&amp; items.length) {</span>
<a href="#l2.180"></a><span id="l2.180">                     delTime = delmgr.getDeletedDate(items[0].id);</span>
<a href="#l2.181"></a><span id="l2.181">                 }</span>
<a href="#l2.182"></a><span id="l2.182">                 if (delTime) {</span>
<a href="#l2.183"></a><span id="l2.183">                     data.label = _gs(&quot;imipBarReplyToRecentlyRemovedItem&quot;, [delTime.toString()]);</span>
<a href="#l2.184"></a><span id="l2.184">                 } else {</span>
<a href="#l2.185"></a><span id="l2.185">                     data.label = _gs(&quot;imipBarReplyToNotExistingItem&quot;);</span>
<a href="#l2.186"></a><span id="l2.186">                 }</span>
<a href="#l2.187"></a><span id="l2.187" class="difflineplus">+            } else if (itipItem.receivedMethod == &quot;DECLINECOUNTER&quot;) {</span>
<a href="#l2.188"></a><span id="l2.188" class="difflineplus">+                data.label = _gs(&quot;imipBarDeclineCounterText&quot;);</span>
<a href="#l2.189"></a><span id="l2.189">             }</span>
<a href="#l2.190"></a><span id="l2.190">         } else if (Components.isSuccessCode(rc)) {</span>
<a href="#l2.191"></a><span id="l2.191">             cal.LOG(&quot;iTIP options on: &quot; + actionFunc.method);</span>
<a href="#l2.192"></a><span id="l2.192">             switch (actionFunc.method) {</span>
<a href="#l2.193"></a><span id="l2.193">                 case &quot;PUBLISH:UPDATE&quot;:</span>
<a href="#l2.194"></a><span id="l2.194">                 case &quot;REQUEST:UPDATE-MINOR&quot;:</span>
<a href="#l2.195"></a><span id="l2.195">                     data.label = _gs(&quot;imipBarUpdateText&quot;);</span>
<a href="#l2.196"></a><span id="l2.196">                     // falls through</span>
<a href="#l2.197"></a><span id="l2.197" class="difflineat">@@ -314,29 +378,55 @@ cal.itip = {</span>
<a href="#l2.198"></a><span id="l2.198">                 case &quot;CANCEL&quot;: {</span>
<a href="#l2.199"></a><span id="l2.199">                     data.buttons.push(&quot;imipDeleteButton&quot;);</span>
<a href="#l2.200"></a><span id="l2.200">                     break;</span>
<a href="#l2.201"></a><span id="l2.201">                 }</span>
<a href="#l2.202"></a><span id="l2.202">                 case &quot;REFRESH&quot;: {</span>
<a href="#l2.203"></a><span id="l2.203">                     data.buttons.push(&quot;imipReconfirmButton&quot;);</span>
<a href="#l2.204"></a><span id="l2.204">                     break;</span>
<a href="#l2.205"></a><span id="l2.205">                 }</span>
<a href="#l2.206"></a><span id="l2.206" class="difflineplus">+                case &quot;COUNTER&quot;: {</span>
<a href="#l2.207"></a><span id="l2.207" class="difflineplus">+                    if (disallowedCounter) {</span>
<a href="#l2.208"></a><span id="l2.208" class="difflineplus">+                        data.label = _gs(&quot;imipBarDisallowedCounterText&quot;);</span>
<a href="#l2.209"></a><span id="l2.209" class="difflineplus">+                    }</span>
<a href="#l2.210"></a><span id="l2.210" class="difflineplus">+                    data.buttons.push(&quot;imipDeclineCounterButton&quot;);</span>
<a href="#l2.211"></a><span id="l2.211" class="difflineplus">+                    data.buttons.push(&quot;imipRescheduleButton&quot;);</span>
<a href="#l2.212"></a><span id="l2.212" class="difflineplus">+                    break;</span>
<a href="#l2.213"></a><span id="l2.213" class="difflineplus">+                }</span>
<a href="#l2.214"></a><span id="l2.214">                 default:</span>
<a href="#l2.215"></a><span id="l2.215">                     data.label = _gs(&quot;imipBarUnsupportedText&quot;);</span>
<a href="#l2.216"></a><span id="l2.216">                     break;</span>
<a href="#l2.217"></a><span id="l2.217">             }</span>
<a href="#l2.218"></a><span id="l2.218">         } else {</span>
<a href="#l2.219"></a><span id="l2.219">             data.label = _gs(&quot;imipBarUnsupportedText&quot;);</span>
<a href="#l2.220"></a><span id="l2.220">         }</span>
<a href="#l2.221"></a><span id="l2.221"> </span>
<a href="#l2.222"></a><span id="l2.222">         return data;</span>
<a href="#l2.223"></a><span id="l2.223">     },</span>
<a href="#l2.224"></a><span id="l2.224"> </span>
<a href="#l2.225"></a><span id="l2.225">     /**</span>
<a href="#l2.226"></a><span id="l2.226">      * Scope: iTIP message receiver</span>
<a href="#l2.227"></a><span id="l2.227" class="difflineplus">+     * Retrieves the message sender.</span>
<a href="#l2.228"></a><span id="l2.228" class="difflineplus">+     *</span>
<a href="#l2.229"></a><span id="l2.229" class="difflineplus">+     * @param {nsIMsgHdr} aMsgHdr     The message header to check.</span>
<a href="#l2.230"></a><span id="l2.230" class="difflineplus">+     * @return                        The email address of the intended recipient.</span>
<a href="#l2.231"></a><span id="l2.231" class="difflineplus">+     */</span>
<a href="#l2.232"></a><span id="l2.232" class="difflineplus">+    getMessageSender: function(aMsgHdr) {</span>
<a href="#l2.233"></a><span id="l2.233" class="difflineplus">+        let author = (aMsgHdr &amp;&amp; aMsgHdr.author) || &quot;&quot;;</span>
<a href="#l2.234"></a><span id="l2.234" class="difflineplus">+        let compFields = Components.classes[&quot;@mozilla.org/messengercompose/composefields;1&quot;]</span>
<a href="#l2.235"></a><span id="l2.235" class="difflineplus">+                                   .createInstance(Components.interfaces.nsIMsgCompFields);</span>
<a href="#l2.236"></a><span id="l2.236" class="difflineplus">+        let addresses = compFields.splitRecipients(author, true, {});</span>
<a href="#l2.237"></a><span id="l2.237" class="difflineplus">+        if (addresses.length != 1) {</span>
<a href="#l2.238"></a><span id="l2.238" class="difflineplus">+            cal.LOG(&quot;No unique email address for lookup in message.\r\n&quot; + cal.STACK(20));</span>
<a href="#l2.239"></a><span id="l2.239" class="difflineplus">+        }</span>
<a href="#l2.240"></a><span id="l2.240" class="difflineplus">+        return addresses[0] || null;</span>
<a href="#l2.241"></a><span id="l2.241" class="difflineplus">+    },</span>
<a href="#l2.242"></a><span id="l2.242" class="difflineplus">+</span>
<a href="#l2.243"></a><span id="l2.243" class="difflineplus">+    /**</span>
<a href="#l2.244"></a><span id="l2.244" class="difflineplus">+     * Scope: iTIP message receiver</span>
<a href="#l2.245"></a><span id="l2.245">      *</span>
<a href="#l2.246"></a><span id="l2.246">      * Retrieves the intended recipient for this message.</span>
<a href="#l2.247"></a><span id="l2.247">      *</span>
<a href="#l2.248"></a><span id="l2.248">      * @param aMsgHdr     The message to check.</span>
<a href="#l2.249"></a><span id="l2.249">      * @return            The email of the intended recipient.</span>
<a href="#l2.250"></a><span id="l2.250">      */</span>
<a href="#l2.251"></a><span id="l2.251">     getMessageRecipient: function(aMsgHdr) {</span>
<a href="#l2.252"></a><span id="l2.252">         if (!aMsgHdr) {</span>
<a href="#l2.253"></a><span id="l2.253" class="difflineat">@@ -420,16 +510,18 @@ cal.itip = {</span>
<a href="#l2.254"></a><span id="l2.254">         switch (aMethod) {</span>
<a href="#l2.255"></a><span id="l2.255">             // methods that don't require the calendar chooser:</span>
<a href="#l2.256"></a><span id="l2.256">             case &quot;REFRESH&quot;:</span>
<a href="#l2.257"></a><span id="l2.257">             case &quot;REQUEST:UPDATE&quot;:</span>
<a href="#l2.258"></a><span id="l2.258">             case &quot;REQUEST:UPDATE-MINOR&quot;:</span>
<a href="#l2.259"></a><span id="l2.259">             case &quot;PUBLISH:UPDATE&quot;:</span>
<a href="#l2.260"></a><span id="l2.260">             case &quot;REPLY&quot;:</span>
<a href="#l2.261"></a><span id="l2.261">             case &quot;CANCEL&quot;:</span>
<a href="#l2.262"></a><span id="l2.262" class="difflineplus">+            case &quot;COUNTER&quot;:</span>
<a href="#l2.263"></a><span id="l2.263" class="difflineplus">+            case &quot;DECLINECOUNTER&quot;:</span>
<a href="#l2.264"></a><span id="l2.264">                 needsCalendar = false;</span>
<a href="#l2.265"></a><span id="l2.265">                 break;</span>
<a href="#l2.266"></a><span id="l2.266">             default:</span>
<a href="#l2.267"></a><span id="l2.267">                 needsCalendar = true;</span>
<a href="#l2.268"></a><span id="l2.268">                 break;</span>
<a href="#l2.269"></a><span id="l2.269">         }</span>
<a href="#l2.270"></a><span id="l2.270"> </span>
<a href="#l2.271"></a><span id="l2.271">         if (needsCalendar) {</span>
<a href="#l2.272"></a><span id="l2.272" class="difflineat">@@ -500,23 +592,27 @@ cal.itip = {</span>
<a href="#l2.273"></a><span id="l2.273">      *                    * REFRESH -- send the latest item (sent by attendee(s))</span>
<a href="#l2.274"></a><span id="l2.274">      *                    * PUBLISH -- initial publish, no reply (sent by organizer)</span>
<a href="#l2.275"></a><span id="l2.275">      *                    * PUBLISH:UPDATE -- update of a published item (sent by organizer)</span>
<a href="#l2.276"></a><span id="l2.276">      *                    * REQUEST -- initial invitation (sent by organizer)</span>
<a href="#l2.277"></a><span id="l2.277">      *                    * REQUEST:UPDATE -- rescheduling invitation, has major change (sent by organizer)</span>
<a href="#l2.278"></a><span id="l2.278">      *                    * REQUEST:UPDATE-MINOR -- update of invitation, minor change (sent by organizer)</span>
<a href="#l2.279"></a><span id="l2.279">      *                    * REPLY -- invitation reply (sent by attendee(s))</span>
<a href="#l2.280"></a><span id="l2.280">      *                    * CANCEL -- invitation cancel (sent by organizer)</span>
<a href="#l2.281"></a><span id="l2.281" class="difflineplus">+     *                    * COUNTER -- counterproposal (sent by attendee)</span>
<a href="#l2.282"></a><span id="l2.282" class="difflineplus">+     *                    * DECLINECOUNTER -- denial of a counterproposal (sent by organizer)</span>
<a href="#l2.283"></a><span id="l2.283">      */</span>
<a href="#l2.284"></a><span id="l2.284">     processItipItem: function(itipItem, optionsFunc) {</span>
<a href="#l2.285"></a><span id="l2.285">         switch (itipItem.receivedMethod.toUpperCase()) {</span>
<a href="#l2.286"></a><span id="l2.286">             case &quot;REFRESH&quot;:</span>
<a href="#l2.287"></a><span id="l2.287">             case &quot;PUBLISH&quot;:</span>
<a href="#l2.288"></a><span id="l2.288">             case &quot;REQUEST&quot;:</span>
<a href="#l2.289"></a><span id="l2.289">             case &quot;CANCEL&quot;:</span>
<a href="#l2.290"></a><span id="l2.290" class="difflineplus">+            case &quot;COUNTER&quot;:</span>
<a href="#l2.291"></a><span id="l2.291" class="difflineplus">+            case &quot;DECLINECOUNTER&quot;:</span>
<a href="#l2.292"></a><span id="l2.292">             case &quot;REPLY&quot;: {</span>
<a href="#l2.293"></a><span id="l2.293">                 // Per iTIP spec (new Draft 4), multiple items in an iTIP message MUST have</span>
<a href="#l2.294"></a><span id="l2.294">                 // same ID, this simplifies our searching, we can just look for Item[0].id</span>
<a href="#l2.295"></a><span id="l2.295">                 let itemList = itipItem.getItemList({});</span>
<a href="#l2.296"></a><span id="l2.296">                 if (!itipItem.targetCalendar) {</span>
<a href="#l2.297"></a><span id="l2.297">                     optionsFunc(itipItem, Components.interfaces.calIErrors.CAL_IS_READONLY);</span>
<a href="#l2.298"></a><span id="l2.298">                 } else if (itemList.length &gt; 0) {</span>
<a href="#l2.299"></a><span id="l2.299">                     ItipItemFinderFactory.findItem(itemList[0].id, itipItem, optionsFunc);</span>
<a href="#l2.300"></a><span id="l2.300" class="difflineat">@@ -826,19 +922,20 @@ cal.itip = {</span>
<a href="#l2.301"></a><span id="l2.301"> </span>
<a href="#l2.302"></a><span id="l2.302">         return newItem;</span>
<a href="#l2.303"></a><span id="l2.303">     },</span>
<a href="#l2.304"></a><span id="l2.304"> </span>
<a href="#l2.305"></a><span id="l2.305">     /**</span>
<a href="#l2.306"></a><span id="l2.306">      * Returns a copy of an itipItem with modified properties and items build from scratch</span>
<a href="#l2.307"></a><span id="l2.307">      * Use itipItem.clone() instead if only a simple copy is required</span>
<a href="#l2.308"></a><span id="l2.308">      *</span>
<a href="#l2.309"></a><span id="l2.309" class="difflineminus">-     * @param aItipItem     ItipItem to derive a new one from</span>
<a href="#l2.310"></a><span id="l2.310" class="difflineminus">-     * @param aItems        List of items to be contained in the new itipItem</span>
<a href="#l2.311"></a><span id="l2.311" class="difflineminus">-     * @param aProps        List of properties to be different in the new itipItem</span>
<a href="#l2.312"></a><span id="l2.312" class="difflineplus">+     * @param  {calIItipItem} aItipItem  ItipItem to derive a new one from</span>
<a href="#l2.313"></a><span id="l2.313" class="difflineplus">+     * @param  {Array}        aItems     calIEvent or calITodo items to be contained in the new itipItem</span>
<a href="#l2.314"></a><span id="l2.314" class="difflineplus">+     * @param  {JsObject}     aProps     Properties to be different in the new itipItem</span>
<a href="#l2.315"></a><span id="l2.315" class="difflineplus">+     * @return {calIItipItem}</span>
<a href="#l2.316"></a><span id="l2.316">      */</span>
<a href="#l2.317"></a><span id="l2.317">     getModifiedItipItem: function(aItipItem, aItems=[], aProps={}) {</span>
<a href="#l2.318"></a><span id="l2.318">         let itipItem = Components.classes[&quot;@mozilla.org/calendar/itip-item;1&quot;]</span>
<a href="#l2.319"></a><span id="l2.319">                                  .createInstance(Components.interfaces.calIItipItem);</span>
<a href="#l2.320"></a><span id="l2.320">         let serializedItems = &quot;&quot;;</span>
<a href="#l2.321"></a><span id="l2.321">         for (let item of aItems) {</span>
<a href="#l2.322"></a><span id="l2.322">             serializedItems += cal.getSerializedItem(item);</span>
<a href="#l2.323"></a><span id="l2.323">         }</span>
<a href="#l2.324"></a><span id="l2.324" class="difflineat">@@ -848,16 +945,30 @@ cal.itip = {</span>
<a href="#l2.325"></a><span id="l2.325">         itipItem.identity = (&quot;identity&quot; in aProps) ? aProps.identity : aItipItem.identity;</span>
<a href="#l2.326"></a><span id="l2.326">         itipItem.isSend = (&quot;isSend&quot; in aProps) ? aProps.isSend : aItipItem.isSend;</span>
<a href="#l2.327"></a><span id="l2.327">         itipItem.localStatus = (&quot;localStatus&quot; in aProps) ? aProps.localStatus : aItipItem.localStatus;</span>
<a href="#l2.328"></a><span id="l2.328">         itipItem.receivedMethod = (&quot;receivedMethod&quot; in aProps) ? aProps.receivedMethod : aItipItem.receivedMethod;</span>
<a href="#l2.329"></a><span id="l2.329">         itipItem.responseMethod = (&quot;responseMethod&quot; in aProps) ? aProps.responseMethod : aItipItem.responseMethod;</span>
<a href="#l2.330"></a><span id="l2.330">         itipItem.targetCalendar = (&quot;targetCalendar&quot; in aProps) ? aProps.targetCalendar : aItipItem.targetCalendar;</span>
<a href="#l2.331"></a><span id="l2.331"> </span>
<a href="#l2.332"></a><span id="l2.332">         return itipItem;</span>
<a href="#l2.333"></a><span id="l2.333" class="difflineplus">+    },</span>
<a href="#l2.334"></a><span id="l2.334" class="difflineplus">+</span>
<a href="#l2.335"></a><span id="l2.335" class="difflineplus">+    /**</span>
<a href="#l2.336"></a><span id="l2.336" class="difflineplus">+     * A shortcut to send DECLINECOUNTER messages - for everything else use cal.itip.checkAndSend</span>
<a href="#l2.337"></a><span id="l2.337" class="difflineplus">+     *</span>
<a href="#l2.338"></a><span id="l2.338" class="difflineplus">+     * @param aItem iTIP item to be sent</span>
<a href="#l2.339"></a><span id="l2.339" class="difflineplus">+     * @param aMethod iTIP method</span>
<a href="#l2.340"></a><span id="l2.340" class="difflineplus">+     * @param aRecipientsList an array of calIAttendee objects the message should be sent to</span>
<a href="#l2.341"></a><span id="l2.341" class="difflineplus">+     * @param aAutoResponse an inout object whether the transport should ask before sending</span>
<a href="#l2.342"></a><span id="l2.342" class="difflineplus">+     */</span>
<a href="#l2.343"></a><span id="l2.343" class="difflineplus">+    sendDeclineCounterMessage: function(aItem, aMethod, aRecipientsList, aAutoResponse) {</span>
<a href="#l2.344"></a><span id="l2.344" class="difflineplus">+        if (aMethod == &quot;DECLINECOUNTER&quot;) {</span>
<a href="#l2.345"></a><span id="l2.345" class="difflineplus">+            return sendMessage(aItem, aMethod, aRecipientsList, aAutoResponse);</span>
<a href="#l2.346"></a><span id="l2.346" class="difflineplus">+        }</span>
<a href="#l2.347"></a><span id="l2.347">     }</span>
<a href="#l2.348"></a><span id="l2.348"> };</span>
<a href="#l2.349"></a><span id="l2.349"> </span>
<a href="#l2.350"></a><span id="l2.350"> /** local to this module file</span>
<a href="#l2.351"></a><span id="l2.351">  * Sets the received info either on the passed attendee or item object.</span>
<a href="#l2.352"></a><span id="l2.352">  *</span>
<a href="#l2.353"></a><span id="l2.353">  * @param item either  calIAttendee or calIItemBase</span>
<a href="#l2.354"></a><span id="l2.354">  * @param itipItemItem received iTIP item</span>
<a href="#l2.355"></a><span id="l2.355" class="difflineat">@@ -999,17 +1110,17 @@ function createOrganizer(aCalendar) {</span>
<a href="#l2.356"></a><span id="l2.356">  */</span>
<a href="#l2.357"></a><span id="l2.357"> function sendMessage(aItem, aMethod, aRecipientsList, autoResponse) {</span>
<a href="#l2.358"></a><span id="l2.358">     if (aRecipientsList.length == 0) {</span>
<a href="#l2.359"></a><span id="l2.359">         return false;</span>
<a href="#l2.360"></a><span id="l2.360">     }</span>
<a href="#l2.361"></a><span id="l2.361">     let calendar = cal.wrapInstance(aItem.calendar, Components.interfaces.calISchedulingSupport);</span>
<a href="#l2.362"></a><span id="l2.362">     if (calendar) {</span>
<a href="#l2.363"></a><span id="l2.363">         if (calendar.QueryInterface(Components.interfaces.calISchedulingSupport)</span>
<a href="#l2.364"></a><span id="l2.364" class="difflineminus">-                          .canNotify(aMethod, aItem)) {</span>
<a href="#l2.365"></a><span id="l2.365" class="difflineplus">+                    .canNotify(aMethod, aItem)) {</span>
<a href="#l2.366"></a><span id="l2.366">             // provider will handle that, so we return - we leave it also to the provider to</span>
<a href="#l2.367"></a><span id="l2.367">             // deal with user canceled notifications (if possible), so set the return value</span>
<a href="#l2.368"></a><span id="l2.368">             // to true as false would prevent any further notification within this cycle</span>
<a href="#l2.369"></a><span id="l2.369">             return true;</span>
<a href="#l2.370"></a><span id="l2.370">         }</span>
<a href="#l2.371"></a><span id="l2.371">     }</span>
<a href="#l2.372"></a><span id="l2.372"> </span>
<a href="#l2.373"></a><span id="l2.373">     let aTransport = aItem.calendar.getProperty(&quot;itip.transport&quot;);</span>
<a href="#l2.374"></a><span id="l2.374" class="difflineat">@@ -1208,17 +1319,17 @@ ItipItemFinder.prototype = {</span>
<a href="#l2.375"></a><span id="l2.375">                     } else {</span>
<a href="#l2.376"></a><span id="l2.376">                         this.mFoundItems.splice(idx, 1);</span>
<a href="#l2.377"></a><span id="l2.377">                     }</span>
<a href="#l2.378"></a><span id="l2.378">                     found = true;</span>
<a href="#l2.379"></a><span id="l2.379">                     break;</span>
<a href="#l2.380"></a><span id="l2.380">                 }</span>
<a href="#l2.381"></a><span id="l2.381">             }</span>
<a href="#l2.382"></a><span id="l2.382"> </span>
<a href="#l2.383"></a><span id="l2.383" class="difflineminus">-            // If it hasn't been found and there isto add a item, add it to the end</span>
<a href="#l2.384"></a><span id="l2.384" class="difflineplus">+            // If it hasn't been found and there is to add a item, add it to the end</span>
<a href="#l2.385"></a><span id="l2.385">             if (!found &amp;&amp; aNewItem) {</span>
<a href="#l2.386"></a><span id="l2.386">                 this.mFoundItems.push(aNewItem);</span>
<a href="#l2.387"></a><span id="l2.387">             }</span>
<a href="#l2.388"></a><span id="l2.388">             this.processFoundItems();</span>
<a href="#l2.389"></a><span id="l2.389">         }</span>
<a href="#l2.390"></a><span id="l2.390">     },</span>
<a href="#l2.391"></a><span id="l2.391"> </span>
<a href="#l2.392"></a><span id="l2.392">     onAddItem: function(aItem) {</span>
<a href="#l2.393"></a><span id="l2.393" class="difflineat">@@ -1258,16 +1369,18 @@ ItipItemFinder.prototype = {</span>
<a href="#l2.394"></a><span id="l2.394">                 //           implicitly on the parent (ics/memory/storage calls modifyException),</span>
<a href="#l2.395"></a><span id="l2.395">                 //           the generation check will fail. We should really consider to allow</span>
<a href="#l2.396"></a><span id="l2.396">                 //           deletion/modification/addition of occurrences directly on the providers,</span>
<a href="#l2.397"></a><span id="l2.397">                 //           which would ease client code a lot.</span>
<a href="#l2.398"></a><span id="l2.398">                 case &quot;REFRESH&quot;:</span>
<a href="#l2.399"></a><span id="l2.399">                 case &quot;PUBLISH&quot;:</span>
<a href="#l2.400"></a><span id="l2.400">                 case &quot;REQUEST&quot;:</span>
<a href="#l2.401"></a><span id="l2.401">                 case &quot;REPLY&quot;:</span>
<a href="#l2.402"></a><span id="l2.402" class="difflineplus">+                case &quot;COUNTER&quot;:</span>
<a href="#l2.403"></a><span id="l2.403" class="difflineplus">+                case &quot;DECLINECOUNTER&quot;:</span>
<a href="#l2.404"></a><span id="l2.404">                     for (let itipItemItem of this.mItipItem.getItemList({})) {</span>
<a href="#l2.405"></a><span id="l2.405">                         for (let item of this.mFoundItems) {</span>
<a href="#l2.406"></a><span id="l2.406">                             let rid = itipItemItem.recurrenceId; //  XXX todo support multiple</span>
<a href="#l2.407"></a><span id="l2.407">                             if (rid) { // actually applies to individual occurrence(s)</span>
<a href="#l2.408"></a><span id="l2.408">                                 if (item.recurrenceInfo) {</span>
<a href="#l2.409"></a><span id="l2.409">                                     item = item.recurrenceInfo.getOccurrenceFor(rid);</span>
<a href="#l2.410"></a><span id="l2.410">                                     if (!item) {</span>
<a href="#l2.411"></a><span id="l2.411">                                         continue;</span>
<a href="#l2.412"></a><span id="l2.412" class="difflineat">@@ -1275,17 +1388,18 @@ ItipItemFinder.prototype = {</span>
<a href="#l2.413"></a><span id="l2.413">                                 } else { // the item has been rescheduled with master:</span>
<a href="#l2.414"></a><span id="l2.414">                                     itipItemItem = itipItemItem.parentItem;</span>
<a href="#l2.415"></a><span id="l2.415">                                 }</span>
<a href="#l2.416"></a><span id="l2.416">                             }</span>
<a href="#l2.417"></a><span id="l2.417"> </span>
<a href="#l2.418"></a><span id="l2.418">                             switch (method) {</span>
<a href="#l2.419"></a><span id="l2.419">                                 case &quot;REFRESH&quot;: { // xxx todo test</span>
<a href="#l2.420"></a><span id="l2.420">                                     let attendees = itipItemItem.getAttendees({});</span>
<a href="#l2.421"></a><span id="l2.421" class="difflineminus">-                                    cal.ASSERT(attendees.length == 1, &quot;invalid number of attendees in REFRESH!&quot;);</span>
<a href="#l2.422"></a><span id="l2.422" class="difflineplus">+                                    cal.ASSERT(attendees.length == 1,</span>
<a href="#l2.423"></a><span id="l2.423" class="difflineplus">+                                               &quot;invalid number of attendees in REFRESH!&quot;);</span>
<a href="#l2.424"></a><span id="l2.424">                                     if (attendees.length &gt; 0) {</span>
<a href="#l2.425"></a><span id="l2.425">                                         let action = function(opListener) {</span>
<a href="#l2.426"></a><span id="l2.426">                                             if (!item.organizer) {</span>
<a href="#l2.427"></a><span id="l2.427">                                                 let org = createOrganizer(item.calendar);</span>
<a href="#l2.428"></a><span id="l2.428">                                                 if (org) {</span>
<a href="#l2.429"></a><span id="l2.429">                                                     item = item.clone();</span>
<a href="#l2.430"></a><span id="l2.430">                                                     item.organizer = org;</span>
<a href="#l2.431"></a><span id="l2.431">                                                 }</span>
<a href="#l2.432"></a><span id="l2.432" class="difflineat">@@ -1363,35 +1477,75 @@ ItipItemFinder.prototype = {</span>
<a href="#l2.433"></a><span id="l2.433">                                                 newItem.addAttendee(att);</span>
<a href="#l2.434"></a><span id="l2.434">                                                 return newItem.calendar.modifyItem(</span>
<a href="#l2.435"></a><span id="l2.435">                                                     newItem, item, new ItipOpListener(opListener, item));</span>
<a href="#l2.436"></a><span id="l2.436">                                             });</span>
<a href="#l2.437"></a><span id="l2.437">                                         }</span>
<a href="#l2.438"></a><span id="l2.438">                                     }</span>
<a href="#l2.439"></a><span id="l2.439">                                     break;</span>
<a href="#l2.440"></a><span id="l2.440">                                 }</span>
<a href="#l2.441"></a><span id="l2.441" class="difflineplus">+                                case &quot;DECLINECOUNTER&quot;:</span>
<a href="#l2.442"></a><span id="l2.442" class="difflineplus">+                                    // nothing to do right now, but once countering is implemented,</span>
<a href="#l2.443"></a><span id="l2.443" class="difflineplus">+                                    // we probably need some action here to remove the proposal from</span>
<a href="#l2.444"></a><span id="l2.444" class="difflineplus">+                                    // the countering attendee's calendar</span>
<a href="#l2.445"></a><span id="l2.445" class="difflineplus">+                                    break;</span>
<a href="#l2.446"></a><span id="l2.446" class="difflineplus">+                                case &quot;COUNTER&quot;:</span>
<a href="#l2.447"></a><span id="l2.447">                                 case &quot;REPLY&quot;: {</span>
<a href="#l2.448"></a><span id="l2.448">                                     let attendees = itipItemItem.getAttendees({});</span>
<a href="#l2.449"></a><span id="l2.449" class="difflineminus">-                                    cal.ASSERT(attendees.length == 1, &quot;invalid number of attendees in REPLY!&quot;);</span>
<a href="#l2.450"></a><span id="l2.450" class="difflineminus">-                                    if (attendees.length &gt; 0 &amp;&amp;</span>
<a href="#l2.451"></a><span id="l2.451" class="difflineminus">-                                        (item.calendar.getProperty(&quot;itip.disableRevisionChecks&quot;) ||</span>
<a href="#l2.452"></a><span id="l2.452" class="difflineminus">-                                         (cal.itip.compare(itipItemItem, item.getAttendeeById(attendees[0].id)) &gt; 0))) {</span>
<a href="#l2.453"></a><span id="l2.453" class="difflineminus">-                                        // accepts REPLYs from previously uninvited attendees:</span>
<a href="#l2.454"></a><span id="l2.454" class="difflineplus">+                                    if (method == &quot;REPLY&quot;) {</span>
<a href="#l2.455"></a><span id="l2.455" class="difflineplus">+                                        cal.ASSERT(</span>
<a href="#l2.456"></a><span id="l2.456" class="difflineplus">+                                            attendees.length == 1,</span>
<a href="#l2.457"></a><span id="l2.457" class="difflineplus">+                                            &quot;invalid number of attendees in REPLY!&quot;</span>
<a href="#l2.458"></a><span id="l2.458" class="difflineplus">+                                        );</span>
<a href="#l2.459"></a><span id="l2.459" class="difflineplus">+                                    } else {</span>
<a href="#l2.460"></a><span id="l2.460" class="difflineplus">+                                        attendees = cal.getAttendeesBySender(</span>
<a href="#l2.461"></a><span id="l2.461" class="difflineplus">+                                            attendees,</span>
<a href="#l2.462"></a><span id="l2.462" class="difflineplus">+                                            this.mItipItem.sender</span>
<a href="#l2.463"></a><span id="l2.463" class="difflineplus">+                                        );</span>
<a href="#l2.464"></a><span id="l2.464" class="difflineplus">+                                        cal.ASSERT(</span>
<a href="#l2.465"></a><span id="l2.465" class="difflineplus">+                                            attendees.length == 1,</span>
<a href="#l2.466"></a><span id="l2.466" class="difflineplus">+                                            &quot;ambiguous resolution of replying attendee in COUNTER!&quot;</span>
<a href="#l2.467"></a><span id="l2.467" class="difflineplus">+                                        );</span>
<a href="#l2.468"></a><span id="l2.468" class="difflineplus">+                                    }</span>
<a href="#l2.469"></a><span id="l2.469" class="difflineplus">+                                    // we get the attendee from the event stored in the calendar</span>
<a href="#l2.470"></a><span id="l2.470" class="difflineplus">+                                    let replyer = item.getAttendeeById(attendees[0].id);</span>
<a href="#l2.471"></a><span id="l2.471" class="difflineplus">+                                    if (!replyer &amp;&amp; method == &quot;REPLY&quot;) {</span>
<a href="#l2.472"></a><span id="l2.472" class="difflineplus">+                                        // We accepts REPLYs also from previously uninvited</span>
<a href="#l2.473"></a><span id="l2.473" class="difflineplus">+                                        // attendees, so we always have one for REPLY</span>
<a href="#l2.474"></a><span id="l2.474" class="difflineplus">+                                        replyer = attendees[0];</span>
<a href="#l2.475"></a><span id="l2.475" class="difflineplus">+                                    }</span>
<a href="#l2.476"></a><span id="l2.476" class="difflineplus">+                                    let noCheck = item.calendar.getProperty(</span>
<a href="#l2.477"></a><span id="l2.477" class="difflineplus">+                                        &quot;itip.disableRevisionChecks&quot;);</span>
<a href="#l2.478"></a><span id="l2.478" class="difflineplus">+                                    let revCheck = false;</span>
<a href="#l2.479"></a><span id="l2.479" class="difflineplus">+                                    if (replyer &amp;&amp; !noCheck) {</span>
<a href="#l2.480"></a><span id="l2.480" class="difflineplus">+                                        revCheck = cal.itip.compare(itipItemItem, replyer) &gt; 0;</span>
<a href="#l2.481"></a><span id="l2.481" class="difflineplus">+                                        if (revCheck &amp;&amp; method == &quot;COUNTER&quot;) {</span>
<a href="#l2.482"></a><span id="l2.482" class="difflineplus">+                                            revCheck = cal.itip.compareSequence(itipItemItem, item) == 0;</span>
<a href="#l2.483"></a><span id="l2.483" class="difflineplus">+                                        }</span>
<a href="#l2.484"></a><span id="l2.484" class="difflineplus">+                                    }</span>
<a href="#l2.485"></a><span id="l2.485" class="difflineplus">+</span>
<a href="#l2.486"></a><span id="l2.486" class="difflineplus">+                                    if (replyer &amp;&amp; (noCheck || revCheck)) {</span>
<a href="#l2.487"></a><span id="l2.487">                                         let newItem = item.clone();</span>
<a href="#l2.488"></a><span id="l2.488" class="difflineminus">-                                        let att = item.getAttendeeById(attendees[0].id) || attendees[0];</span>
<a href="#l2.489"></a><span id="l2.489" class="difflineminus">-                                        newItem.removeAttendee(att);</span>
<a href="#l2.490"></a><span id="l2.490" class="difflineminus">-                                        att = att.clone();</span>
<a href="#l2.491"></a><span id="l2.491" class="difflineminus">-                                        setReceivedInfo(att, itipItemItem);</span>
<a href="#l2.492"></a><span id="l2.492" class="difflineminus">-                                        att.participationStatus = attendees[0].participationStatus;</span>
<a href="#l2.493"></a><span id="l2.493" class="difflineminus">-                                        newItem.addAttendee(att);</span>
<a href="#l2.494"></a><span id="l2.494" class="difflineplus">+                                        newItem.removeAttendee(replyer);</span>
<a href="#l2.495"></a><span id="l2.495" class="difflineplus">+                                        replyer = replyer.clone();</span>
<a href="#l2.496"></a><span id="l2.496" class="difflineplus">+                                        setReceivedInfo(replyer, itipItemItem);</span>
<a href="#l2.497"></a><span id="l2.497" class="difflineplus">+                                        let newPS = itipItemItem.getAttendeeById(replyer.id)</span>
<a href="#l2.498"></a><span id="l2.498" class="difflineplus">+                                                                .participationStatus;</span>
<a href="#l2.499"></a><span id="l2.499" class="difflineplus">+                                        replyer.participationStatus = newPS;</span>
<a href="#l2.500"></a><span id="l2.500" class="difflineplus">+                                        newItem.addAttendee(replyer);</span>
<a href="#l2.501"></a><span id="l2.501"> </span>
<a href="#l2.502"></a><span id="l2.502">                                         // Make sure the provider-specified properties are copied over</span>
<a href="#l2.503"></a><span id="l2.503">                                         copyProviderProperties(this.mItipItem, itipItemItem, newItem);</span>
<a href="#l2.504"></a><span id="l2.504"> </span>
<a href="#l2.505"></a><span id="l2.505">                                         let action = function(opListener) {</span>
<a href="#l2.506"></a><span id="l2.506" class="difflineplus">+                                            // n.b.: this will only be processed in case of reply or</span>
<a href="#l2.507"></a><span id="l2.507" class="difflineplus">+                                            // declining the counter request - of sending the</span>
<a href="#l2.508"></a><span id="l2.508" class="difflineplus">+                                            // appropriate reply will be taken care within the</span>
<a href="#l2.509"></a><span id="l2.509" class="difflineplus">+                                            // opListener (defined in imip-bar.js)</span>
<a href="#l2.510"></a><span id="l2.510" class="difflineplus">+                                            // TODO: move that from imip-bar.js to here</span>
<a href="#l2.511"></a><span id="l2.511">                                             return newItem.calendar.modifyItem(</span>
<a href="#l2.512"></a><span id="l2.512">                                                 newItem, item,</span>
<a href="#l2.513"></a><span id="l2.513">                                                 newItem.calendar.getProperty(&quot;itip.notify-replies&quot;)</span>
<a href="#l2.514"></a><span id="l2.514">                                                 ? new ItipOpListener(opListener, item)</span>
<a href="#l2.515"></a><span id="l2.515">                                                 : opListener);</span>
<a href="#l2.516"></a><span id="l2.516">                                         };</span>
<a href="#l2.517"></a><span id="l2.517">                                         operations.push(action);</span>
<a href="#l2.518"></a><span id="l2.518">                                     }</span>
<a href="#l2.519"></a><span id="l2.519" class="difflineat">@@ -1479,16 +1633,17 @@ ItipItemFinder.prototype = {</span>
<a href="#l2.520"></a><span id="l2.520">                                                             ? new ItipOpListener(opListener, null)</span>
<a href="#l2.521"></a><span id="l2.521">                                                             : opListener);</span>
<a href="#l2.522"></a><span id="l2.522">                         };</span>
<a href="#l2.523"></a><span id="l2.523">                         operations.push(action);</span>
<a href="#l2.524"></a><span id="l2.524">                         break;</span>
<a href="#l2.525"></a><span id="l2.525">                     }</span>
<a href="#l2.526"></a><span id="l2.526">                     case &quot;CANCEL&quot;: // has already been processed</span>
<a href="#l2.527"></a><span id="l2.527">                     case &quot;REPLY&quot;: // item has been previously removed from the calendar</span>
<a href="#l2.528"></a><span id="l2.528" class="difflineplus">+                    case &quot;COUNTER&quot;: // the item has been previously removed form the calendar</span>
<a href="#l2.529"></a><span id="l2.529">                         break;</span>
<a href="#l2.530"></a><span id="l2.530">                     default:</span>
<a href="#l2.531"></a><span id="l2.531">                         rc = Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l2.532"></a><span id="l2.532">                         break;</span>
<a href="#l2.533"></a><span id="l2.533">                 }</span>
<a href="#l2.534"></a><span id="l2.534">             }</span>
<a href="#l2.535"></a><span id="l2.535">         }</span>
<a href="#l2.536"></a><span id="l2.536"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/calendar/base/modules/calUtils.jsm</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/calendar/base/modules/calUtils.jsm</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -390,16 +390,43 @@ var cal = {</span>
<a href="#l3.4"></a><span id="l3.4">         let calendar = cal.wrapInstance(aCalendar, Components.interfaces.calISchedulingSupport);</span>
<a href="#l3.5"></a><span id="l3.5">         if (calendar) {</span>
<a href="#l3.6"></a><span id="l3.6">             invitedAttendee = calendar.getInvitedAttendee(aItem);</span>
<a href="#l3.7"></a><span id="l3.7">         }</span>
<a href="#l3.8"></a><span id="l3.8">         return invitedAttendee;</span>
<a href="#l3.9"></a><span id="l3.9">     },</span>
<a href="#l3.10"></a><span id="l3.10"> </span>
<a href="#l3.11"></a><span id="l3.11">     /**</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+     * Returns all attendees from given set of attendees matching based on the attendee id</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+     * or a sent-by parameter compared to the specified email address</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+     *</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+     * @param  {Array}  aAttendees      An array of calIAttendee objects</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+     * @param  {String} aEmailAddress   A string containing the email address for lookup</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+     * @return {Array}                  Returns an array of matching attendees</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+     */</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+    getAttendeesBySender: function(aAttendees, aEmailAddress) {</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+        let attendees = [];</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+        // we extract the email address to make it work also for a raw header value</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+        let compFields = Components.classes[&quot;@mozilla.org/messengercompose/composefields;1&quot;]</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+                                   .createInstance(Components.interfaces.nsIMsgCompFields);</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+        let addresses = compFields.splitRecipients(aEmailAddress, true, {});</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineplus">+        if (addresses.length == 1) {</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineplus">+            let searchFor = cal.prependMailTo(addresses[0]);</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+            aAttendees.forEach(aAttendee =&gt; {</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineplus">+                if ([aAttendee.id, aAttendee.getProperty(&quot;SENT-BY&quot;)].includes(searchFor)) {</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineplus">+                    attendees.push(aAttendee);</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineplus">+                }</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+            });</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+        } else {</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+            cal.WARN(&quot;No unique email address for lookup!&quot;);</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+        }</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+        return attendees;</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+    },</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+    /**</span>
<a href="#l3.39"></a><span id="l3.39">      * Returns a wellformed email string like 'attendee@example.net',</span>
<a href="#l3.40"></a><span id="l3.40">      * 'Common Name &lt;attendee@example.net&gt;' or '&quot;Name, Common&quot; &lt;attendee@example.net&gt;'</span>
<a href="#l3.41"></a><span id="l3.41">      *</span>
<a href="#l3.42"></a><span id="l3.42">      * @param  {calIAttendee}  aAttendee - the attendee to check</span>
<a href="#l3.43"></a><span id="l3.43">      * @param  {boolean}       aIncludeCn - whether or not to return also the CN if available</span>
<a href="#l3.44"></a><span id="l3.44">      * @return {string}        valid email string or an empty string in case of error</span>
<a href="#l3.45"></a><span id="l3.45">      */</span>
<a href="#l3.46"></a><span id="l3.46">     getAttendeeEmail: function(aAttendee, aIncludeCn) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/calendar/base/public/calIItipItem.idl</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/calendar/base/public/calIItipItem.idl</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -9,17 +9,17 @@ interface calIItemBase;</span>
<a href="#l4.4"></a><span id="l4.4"> interface calICalendar;</span>
<a href="#l4.5"></a><span id="l4.5"> interface nsISimpleEnumerator;</span>
<a href="#l4.6"></a><span id="l4.6"> </span>
<a href="#l4.7"></a><span id="l4.7"> /** </span>
<a href="#l4.8"></a><span id="l4.8">  * calIItipItem is an interface used to carry information between the mime</span>
<a href="#l4.9"></a><span id="l4.9">  * parser, the imip-bar UI, and the iTIP processor. It encapsulates a list of</span>
<a href="#l4.10"></a><span id="l4.10">  * calIItemBase objects and provides specialized iTIP methods for those items.</span>
<a href="#l4.11"></a><span id="l4.11">  */</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-[scriptable, uuid(f41392ab-dcad-4bad-818f-b3d1631c4d93)]</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+[scriptable, uuid(7539c158-c30d-41d0-90e9-41d315ac3eb1)]</span>
<a href="#l4.14"></a><span id="l4.14"> interface calIItipItem : nsISupports</span>
<a href="#l4.15"></a><span id="l4.15"> {</span>
<a href="#l4.16"></a><span id="l4.16">     /**</span>
<a href="#l4.17"></a><span id="l4.17">      * Initializes the item with an ics string</span>
<a href="#l4.18"></a><span id="l4.18">      * @param - in parameter - AString of ical Data</span>
<a href="#l4.19"></a><span id="l4.19">      */</span>
<a href="#l4.20"></a><span id="l4.20">     void init(in  AUTF8String icalData);</span>
<a href="#l4.21"></a><span id="l4.21"> </span>
<a href="#l4.22"></a><span id="l4.22" class="difflineat">@@ -35,16 +35,22 @@ interface calIItipItem : nsISupports</span>
<a href="#l4.23"></a><span id="l4.23">      * the item directly to the email subsystem so that communication can be</span>
<a href="#l4.24"></a><span id="l4.24">      * initiated. For example, if you are Sending a REQUEST, you would set</span>
<a href="#l4.25"></a><span id="l4.25">      * this flag, and send the iTIP Item into the iTIP processor, which would</span>
<a href="#l4.26"></a><span id="l4.26">      * handle everything else.</span>
<a href="#l4.27"></a><span id="l4.27">      */</span>
<a href="#l4.28"></a><span id="l4.28">     attribute boolean isSend;</span>
<a href="#l4.29"></a><span id="l4.29"> </span>
<a href="#l4.30"></a><span id="l4.30">     /**</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+     * Attribute: sender - set to the email address of the sender if part of an</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+     * iMIP communication.</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+     */</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+    attribute AUTF8String sender;</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+    /**</span>
<a href="#l4.37"></a><span id="l4.37">      * Attribute: receivedMethod - method the iTIP item had upon reciept</span>
<a href="#l4.38"></a><span id="l4.38">      */</span>
<a href="#l4.39"></a><span id="l4.39">     attribute AUTF8String receivedMethod;</span>
<a href="#l4.40"></a><span id="l4.40"> </span>
<a href="#l4.41"></a><span id="l4.41">     /**</span>
<a href="#l4.42"></a><span id="l4.42">      * Attribute: responseMethod - method that the protocol handler (or the</span>
<a href="#l4.43"></a><span id="l4.43">      * user) decides to use to respond to the iTIP item (could be COUNTER,</span>
<a href="#l4.44"></a><span id="l4.44">      * REPLY, DECLINECOUNTER, etc)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/calendar/base/src/calItipItem.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/calendar/base/src/calItipItem.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -23,16 +23,24 @@ calItipItem.prototype = {</span>
<a href="#l5.4"></a><span id="l5.4">     QueryInterface: XPCOMUtils.generateQI(calItipItemInterfaces),</span>
<a href="#l5.5"></a><span id="l5.5">     classInfo: XPCOMUtils.generateCI({</span>
<a href="#l5.6"></a><span id="l5.6">         classID: calItipItemClassID,</span>
<a href="#l5.7"></a><span id="l5.7">         contractID: &quot;@mozilla.org/calendar/itip-item;1&quot;,</span>
<a href="#l5.8"></a><span id="l5.8">         classDescription: &quot;Calendar iTIP item&quot;,</span>
<a href="#l5.9"></a><span id="l5.9">         interfaces: calItipItemInterfaces</span>
<a href="#l5.10"></a><span id="l5.10">     }),</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+    mSender: null,</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+    get sender() {</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+        return this.mSender;</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+    },</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+    set sender(aValue) {</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+        return (this.mSender = aValue);</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+    },</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+</span>
<a href="#l5.20"></a><span id="l5.20">     mIsSend: false,</span>
<a href="#l5.21"></a><span id="l5.21">     get isSend() {</span>
<a href="#l5.22"></a><span id="l5.22">         return this.mIsSend;</span>
<a href="#l5.23"></a><span id="l5.23">     },</span>
<a href="#l5.24"></a><span id="l5.24">     set isSend(aValue) {</span>
<a href="#l5.25"></a><span id="l5.25">         return (this.mIsSend = aValue);</span>
<a href="#l5.26"></a><span id="l5.26">     },</span>
<a href="#l5.27"></a><span id="l5.27"> </span>
<a href="#l5.28"></a><span id="l5.28" class="difflineat">@@ -159,16 +167,17 @@ calItipItem.prototype = {</span>
<a href="#l5.29"></a><span id="l5.29">         let newItem = new calItipItem();</span>
<a href="#l5.30"></a><span id="l5.30">         newItem.mItemList = this.mItemList.map(item =&gt; item.clone());</span>
<a href="#l5.31"></a><span id="l5.31">         newItem.mReceivedMethod = this.mReceivedMethod;</span>
<a href="#l5.32"></a><span id="l5.32">         newItem.mResponseMethod = this.mResponseMethod;</span>
<a href="#l5.33"></a><span id="l5.33">         newItem.mAutoResponse = this.mAutoResponse;</span>
<a href="#l5.34"></a><span id="l5.34">         newItem.mTargetCalendar = this.mTargetCalendar;</span>
<a href="#l5.35"></a><span id="l5.35">         newItem.mIdentity = this.mIdentity;</span>
<a href="#l5.36"></a><span id="l5.36">         newItem.mLocalStatus = this.mLocalStatus;</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineplus">+        newItem.mSender = this.mSender;</span>
<a href="#l5.38"></a><span id="l5.38">         newItem.mIsSend = this.mIsSend;</span>
<a href="#l5.39"></a><span id="l5.39">         newItem.mIsInitialized = this.mIsInitialized;</span>
<a href="#l5.40"></a><span id="l5.40">         return newItem;</span>
<a href="#l5.41"></a><span id="l5.41">     },</span>
<a href="#l5.42"></a><span id="l5.42"> </span>
<a href="#l5.43"></a><span id="l5.43">     /**</span>
<a href="#l5.44"></a><span id="l5.44">      * This returns both the array and the number of items. An easy way to</span>
<a href="#l5.45"></a><span id="l5.45">      * call it is: let itemArray = itipItem.getItemList({ });</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/calendar/base/src/calUtils.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/calendar/base/src/calUtils.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -1693,17 +1693,17 @@ function calIterateEmailIdentities(func)</span>
<a href="#l6.4"></a><span id="l6.4">  * @param aSecondItem       The item to compare to.</span>
<a href="#l6.5"></a><span id="l6.5">  * @param aIgnoreProps      (optional) An array of parameters to ignore.</span>
<a href="#l6.6"></a><span id="l6.6">  * @param aIgnoreParams     (optional) An object describing which parameters to</span>
<a href="#l6.7"></a><span id="l6.7">  *                                     ignore.</span>
<a href="#l6.8"></a><span id="l6.8">  * @return                  True, if items match.</span>
<a href="#l6.9"></a><span id="l6.9">  */</span>
<a href="#l6.10"></a><span id="l6.10"> function compareItemContent(aFirstItem, aSecondItem, aIgnoreProps, aIgnoreParams) {</span>
<a href="#l6.11"></a><span id="l6.11">     let ignoreProps = arr2hash(aIgnoreProps ||</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-        [&quot;SEQUENCE&quot;, &quot;DTSTAMP&quot;, &quot;LAST-MODIFIED&quot;, &quot;X-MOZ-GENERATION&quot;,</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+        [&quot;SEQUENCE&quot;, &quot;DTSTAMP&quot;, &quot;LAST-MODIFIED&quot;, &quot;X-MOZ-GENERATION&quot;, &quot;X-MICROSOFT-DISALLOW-COUNTER&quot;,</span>
<a href="#l6.14"></a><span id="l6.14">          &quot;X-MOZ-SEND-INVITATIONS&quot;, &quot;X-MOZ-SEND-INVITATIONS-UNDISCLOSED&quot;]);</span>
<a href="#l6.15"></a><span id="l6.15"> </span>
<a href="#l6.16"></a><span id="l6.16">     let ignoreParams = aIgnoreParams ||</span>
<a href="#l6.17"></a><span id="l6.17">         { ATTENDEE: [&quot;CN&quot;], ORGANIZER: [&quot;CN&quot;] };</span>
<a href="#l6.18"></a><span id="l6.18">     for (let x in ignoreParams) {</span>
<a href="#l6.19"></a><span id="l6.19">         ignoreParams[x] = arr2hash(ignoreParams[x]);</span>
<a href="#l6.20"></a><span id="l6.20">     }</span>
<a href="#l6.21"></a><span id="l6.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/calendar/base/themes/common/dialogs/calendar-event-dialog.css</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/calendar/base/themes/common/dialogs/calendar-event-dialog.css</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -29,16 +29,37 @@ dialog[systemcolors] {</span>
<a href="#l7.4"></a><span id="l7.4"> </span>
<a href="#l7.5"></a><span id="l7.5"> #calendar-event-dialog .todo-only,</span>
<a href="#l7.6"></a><span id="l7.6"> #calendar-task-dialog .event-only,</span>
<a href="#l7.7"></a><span id="l7.7"> #calendar-event-dialog-inner .todo-only,</span>
<a href="#l7.8"></a><span id="l7.8"> #calendar-task-dialog-inner .event-only {</span>
<a href="#l7.9"></a><span id="l7.9">     display: none;</span>
<a href="#l7.10"></a><span id="l7.10"> }</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+/*--------------------------------------------------------------------</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+ *   Event dialog counter box section</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+ *-------------------------------------------------------------------*/</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+#counter-proposal-box {</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+    background-color: rgb(186, 238, 255);</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+    border-bottom: 1px solid #444444;</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+}</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineplus">+#counter-proposal-property-values &gt; description {</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineplus">+    margin-bottom: 2px;</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineplus">+}</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineplus">+</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineplus">+#counter-proposal-summary {</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineplus">+    font-weight: bold;</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineplus">+}</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineplus">+</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineplus">+.counter-buttons {</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineplus">+    max-height: 25px;</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineplus">+}</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+</span>
<a href="#l7.33"></a><span id="l7.33"> #yearly-period-of-label,</span>
<a href="#l7.34"></a><span id="l7.34"> label.label {</span>
<a href="#l7.35"></a><span id="l7.35">     text-align: right;</span>
<a href="#l7.36"></a><span id="l7.36"> }</span>
<a href="#l7.37"></a><span id="l7.37"> </span>
<a href="#l7.38"></a><span id="l7.38"> #item-calendar,</span>
<a href="#l7.39"></a><span id="l7.39"> #item-categories,</span>
<a href="#l7.40"></a><span id="l7.40"> #item-repeat,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/calendar/itip/calItipEmailTransport.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/calendar/itip/calItipEmailTransport.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -107,21 +107,36 @@ calItipEmailTransport.prototype = {</span>
<a href="#l8.4"></a><span id="l8.4">                 body = cal.calGetString(</span>
<a href="#l8.5"></a><span id="l8.5">                     &quot;lightning&quot;,</span>
<a href="#l8.6"></a><span id="l8.6">                     &quot;itipCancelBody&quot;,</span>
<a href="#l8.7"></a><span id="l8.7">                     [item.organizer ? item.organizer.toString() : &quot;&quot;, summary],</span>
<a href="#l8.8"></a><span id="l8.8">                     &quot;lightning&quot;</span>
<a href="#l8.9"></a><span id="l8.9">                 );</span>
<a href="#l8.10"></a><span id="l8.10">                 break;</span>
<a href="#l8.11"></a><span id="l8.11">             }</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+            case &quot;DECLINECOUNTER&quot;: {</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+                subject = cal.calGetString(</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+                    &quot;lightning&quot;,</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+                    &quot;itipDeclineCounterSubject&quot;,</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+                    [summary],</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+                    &quot;lightning&quot;</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+                );</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+                body = cal.calGetString(</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineplus">+                    &quot;lightning&quot;,</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineplus">+                    &quot;itipDeclineCounterBody&quot;,</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineplus">+                    [item.organizer ? item.organizer.toString() : &quot;&quot;, summary],</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineplus">+                    &quot;lightning&quot;</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+                );</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineplus">+                break;</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineplus">+            }</span>
<a href="#l8.27"></a><span id="l8.27">             case &quot;REPLY&quot;: {</span>
<a href="#l8.28"></a><span id="l8.28">                 // Get my participation status</span>
<a href="#l8.29"></a><span id="l8.29">                 let att = cal.getInvitedAttendee(item, aItipItem.targetCalendar);</span>
<a href="#l8.30"></a><span id="l8.30">                 if (!att &amp;&amp; aItipItem.identity) {</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-                    att = item.getAttendeeById(&quot;mailto:&quot; + aItipItem.identity);</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+                    att = item.getAttendeeById(cal.prependMailTo(aItipItem.identity));</span>
<a href="#l8.33"></a><span id="l8.33">                 }</span>
<a href="#l8.34"></a><span id="l8.34">                 if (!att) { // should not happen anymore</span>
<a href="#l8.35"></a><span id="l8.35">                     return false;</span>
<a href="#l8.36"></a><span id="l8.36">                 }</span>
<a href="#l8.37"></a><span id="l8.37"> </span>
<a href="#l8.38"></a><span id="l8.38">                 // work around BUG 351589, the below just removes RSVP:</span>
<a href="#l8.39"></a><span id="l8.39">                 aItipItem.setAttendeeStatus(att.id, att.participationStatus);</span>
<a href="#l8.40"></a><span id="l8.40">                 let myPartStat = att.participationStatus;</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineat">@@ -303,17 +318,17 @@ calItipEmailTransport.prototype = {</span>
<a href="#l8.42"></a><span id="l8.42">                                             .createInstance(Components.interfaces.nsIMsgSend);</span>
<a href="#l8.43"></a><span id="l8.43">                     msgSend.sendMessageFile(identity,</span>
<a href="#l8.44"></a><span id="l8.44">                                             account.key,</span>
<a href="#l8.45"></a><span id="l8.45">                                             composeFields,</span>
<a href="#l8.46"></a><span id="l8.46">                                             mailFile,</span>
<a href="#l8.47"></a><span id="l8.47">                                             true  /* deleteSendFileOnCompletion */,</span>
<a href="#l8.48"></a><span id="l8.48">                                             false /* digest_p */,</span>
<a href="#l8.49"></a><span id="l8.49">                                             (Services.io.offline ? Components.interfaces.nsIMsgSend.nsMsgQueueForLater</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineminus">-                                                                 : Components.interfaces.nsIMsgSend.nsMsgDeliverNow),</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+                                                    : Components.interfaces.nsIMsgSend.nsMsgDeliverNow),</span>
<a href="#l8.52"></a><span id="l8.52">                                             null  /* nsIMsgDBHdr msgToReplace */,</span>
<a href="#l8.53"></a><span id="l8.53">                                             null  /* nsIMsgSendListener aListener */,</span>
<a href="#l8.54"></a><span id="l8.54">                                             null  /* nsIMsgStatusFeedback aStatusFeedback */,</span>
<a href="#l8.55"></a><span id="l8.55">                                             &quot;&quot;    /* password */);</span>
<a href="#l8.56"></a><span id="l8.56">                     return true;</span>
<a href="#l8.57"></a><span id="l8.57">                 }</span>
<a href="#l8.58"></a><span id="l8.58">                 break;</span>
<a href="#l8.59"></a><span id="l8.59">             }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/calendar/lightning/components/lightningTextCalendarConverter.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/calendar/lightning/components/lightningTextCalendarConverter.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -48,47 +48,43 @@ ltnMimeConverter.prototype = {</span>
<a href="#l9.4"></a><span id="l9.4">             }</span>
<a href="#l9.5"></a><span id="l9.5">         }</span>
<a href="#l9.6"></a><span id="l9.6">         if (!event) {</span>
<a href="#l9.7"></a><span id="l9.7">             return &quot;&quot;;</span>
<a href="#l9.8"></a><span id="l9.8">         }</span>
<a href="#l9.9"></a><span id="l9.9"> </span>
<a href="#l9.10"></a><span id="l9.10">         let itipItem = null;</span>
<a href="#l9.11"></a><span id="l9.11">         let msgOverlay = &quot;&quot;;</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+        let msgWindow = null;</span>
<a href="#l9.13"></a><span id="l9.13"> </span>
<a href="#l9.14"></a><span id="l9.14" class="difflineminus">-        try {</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineminus">-            itipItem = Components.classes[&quot;@mozilla.org/calendar/itip-item;1&quot;]</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineminus">-                                 .createInstance(Components.interfaces.calIItipItem);</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineminus">-            itipItem.init(data);</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+        itipItem = Components.classes[&quot;@mozilla.org/calendar/itip-item;1&quot;]</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineplus">+                             .createInstance(Components.interfaces.calIItipItem);</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineplus">+        itipItem.init(data);</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineplus">+</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineplus">+        // this.uri is the message URL that we are processing.</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineplus">+        // We use it to get the nsMsgHeaderSink to store the calItipItem.</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineplus">+        if (this.uri) {</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineplus">+            try {</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineplus">+                let msgUrl = this.uri.QueryInterface(Components.interfaces.nsIMsgMailNewsUrl);</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineplus">+                msgWindow = msgUrl.msgWindow;</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineplus">+                itipItem.sender = msgUrl.mimeHeaders.extractHeader(&quot;From&quot;, false);</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineplus">+            } catch (exc) {</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineplus">+                // msgWindow is optional in some scenarios</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineplus">+                // (e.g. gloda in action, throws NS_ERROR_INVALID_POINTER then)</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineplus">+            }</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineplus">+        }</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineplus">+</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineplus">+        if (msgWindow) {</span>
<a href="#l9.36"></a><span id="l9.36">             let dom = ltn.invitation.createInvitationOverlay(event, itipItem);</span>
<a href="#l9.37"></a><span id="l9.37">             msgOverlay = cal.xml.serializeDOM(dom);</span>
<a href="#l9.38"></a><span id="l9.38"> </span>
<a href="#l9.39"></a><span id="l9.39" class="difflineminus">-            // this.uri is the message URL that we are processing.</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineminus">-            // We use it to get the nsMsgHeaderSink to store the calItipItem.</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineminus">-            if (this.uri) {</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineminus">-                let msgWindow = null;</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineminus">-                try {</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineminus">-                    let msgUrl = this.uri.QueryInterface(Components.interfaces.nsIMsgMailNewsUrl);</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineminus">-                    msgWindow = msgUrl.msgWindow;</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineminus">-                } catch (exc) {</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineminus">-                    // msgWindow is optional in some scenarios</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineminus">-                    // (e.g. gloda in action, throws NS_ERROR_INVALID_POINTER then)</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineminus">-                }</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineplus">+            let sinkProps = msgWindow.msgHeaderSink.properties;</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineplus">+            sinkProps.setPropertyAsInterface(&quot;itipItem&quot;, itipItem);</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineplus">+            sinkProps.setPropertyAsAUTF8String(&quot;msgOverlay&quot;, msgOverlay);</span>
<a href="#l9.53"></a><span id="l9.53"> </span>
<a href="#l9.54"></a><span id="l9.54" class="difflineminus">-                if (msgWindow) {</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineminus">-                    let sinkProps = msgWindow.msgHeaderSink.properties;</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineminus">-                    sinkProps.setPropertyAsInterface(&quot;itipItem&quot;, itipItem);</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineminus">-                    sinkProps.setPropertyAsAUTF8String(&quot;msgOverlay&quot;, msgOverlay);</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineminus">-</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineminus">-                    // Notify the observer that the itipItem is available</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineminus">-                    Services.obs.notifyObservers(null, &quot;onItipItemCreation&quot;, 0);</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineminus">-                }</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineminus">-            }</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineminus">-        } catch (e) {</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineminus">-            cal.ERROR(&quot;[ltnMimeConverter] convertToHTML: &quot; + e);</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineplus">+            // Notify the observer that the itipItem is available</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineplus">+            Services.obs.notifyObservers(null, &quot;onItipItemCreation&quot;, 0);</span>
<a href="#l9.67"></a><span id="l9.67">         }</span>
<a href="#l9.68"></a><span id="l9.68" class="difflineminus">-</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineminus">-        // Create the HTML string for display</span>
<a href="#l9.70"></a><span id="l9.70">         return msgOverlay;</span>
<a href="#l9.71"></a><span id="l9.71">     }</span>
<a href="#l9.72"></a><span id="l9.72"> };</span>
<a href="#l9.73"></a><span id="l9.73"> </span>
<a href="#l9.74"></a><span id="l9.74"> this.NSGetFactory = XPCOMUtils.generateNSGetFactory([ltnMimeConverter]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/calendar/lightning/content/imip-bar-overlay.xul</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/calendar/lightning/content/imip-bar-overlay.xul</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -78,16 +78,32 @@</span>
<a href="#l10.4"></a><span id="l10.4">               &lt;!-- show event/invitation details --&gt;</span>
<a href="#l10.5"></a><span id="l10.5">               &lt;toolbarbutton id=&quot;imipDetailsButton&quot;</span>
<a href="#l10.6"></a><span id="l10.6">                              label=&quot;&amp;lightning.imipbar.btnDetails.label;&quot;</span>
<a href="#l10.7"></a><span id="l10.7">                              tooltiptext=&quot;&amp;lightning.imipbar.btnDetails.tooltiptext;&quot;</span>
<a href="#l10.8"></a><span id="l10.8">                              class=&quot;toolbarbutton-1 msgHeaderView-button imipDetailsButton&quot;</span>
<a href="#l10.9"></a><span id="l10.9">                              oncommand=&quot;ltnImipBar.executeAction('X-SHOWDETAILS')&quot;</span>
<a href="#l10.10"></a><span id="l10.10">                              hidden=&quot;true&quot;/&gt;</span>
<a href="#l10.11"></a><span id="l10.11"> </span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+              &lt;!-- decline counter --&gt;</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+              &lt;toolbarbutton id=&quot;imipDeclineCounterButton&quot;</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+                             label=&quot;&amp;lightning.imipbar.btnDeclineCounter.label;&quot;</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+                             tooltiptext=&quot;&amp;lightning.imipbar.btnDeclineCounter.tooltiptext;&quot;</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+                             class=&quot;toolbarbutton-1 msgHeaderView-button imipDeclineCounterButton&quot;</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineplus">+                             oncommand=&quot;ltnImipBar.executeAction('X-DECLINECOUNTER')&quot;</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineplus">+                             hidden=&quot;true&quot;/&gt;</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineplus">+</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineplus">+              &lt;!-- reschedule --&gt;</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineplus">+              &lt;toolbarbutton id=&quot;imipRescheduleButton&quot;</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineplus">+                             label=&quot;&amp;lightning.imipbar.btnReschedule.label;&quot;</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineplus">+                             tooltiptext=&quot;&amp;lightning.imipbar.btnReschedule.tooltiptext;&quot;</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineplus">+                             class=&quot;toolbarbutton-1 msgHeaderView-button imipRescheduleButton&quot;</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineplus">+                             oncommand=&quot;ltnImipBar.executeAction('X-RESCHEDULE')&quot;</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineplus">+                             hidden=&quot;true&quot;/&gt;</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineplus">+</span>
<a href="#l10.28"></a><span id="l10.28">               &lt;!-- add published events --&gt;</span>
<a href="#l10.29"></a><span id="l10.29">               &lt;toolbarbutton id=&quot;imipAddButton&quot;</span>
<a href="#l10.30"></a><span id="l10.30">                              label=&quot;&amp;lightning.imipbar.btnAdd.label;&quot;</span>
<a href="#l10.31"></a><span id="l10.31">                              tooltiptext=&quot;&amp;lightning.imipbar.btnAdd.tooltiptext;&quot;</span>
<a href="#l10.32"></a><span id="l10.32">                              class=&quot;toolbarbutton-1 msgHeaderView-button imipAddButton&quot;</span>
<a href="#l10.33"></a><span id="l10.33">                              oncommand=&quot;ltnImipBar.executeAction()&quot;</span>
<a href="#l10.34"></a><span id="l10.34">                              hidden=&quot;true&quot;/&gt;</span>
<a href="#l10.35"></a><span id="l10.35"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/calendar/lightning/content/imip-bar.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/calendar/lightning/content/imip-bar.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -205,17 +205,17 @@ var ltnImipBar = {</span>
<a href="#l11.4"></a><span id="l11.4">                 return false;</span>
<a href="#l11.5"></a><span id="l11.5">             }</span>
<a href="#l11.6"></a><span id="l11.6">             let author = aMsgHdr.mime2DecodedAuthor;</span>
<a href="#l11.7"></a><span id="l11.7">             let isSentFolder = aMsgHdr.folder.flags &amp; nsMsgFolderFlags.SentMail;</span>
<a href="#l11.8"></a><span id="l11.8">             if (author &amp;&amp; isSentFolder) {</span>
<a href="#l11.9"></a><span id="l11.9">                 let accounts = MailServices.accounts;</span>
<a href="#l11.10"></a><span id="l11.10">                 for (let identity in fixIterator(accounts.allIdentities,</span>
<a href="#l11.11"></a><span id="l11.11">                                                  Components.interfaces.nsIMsgIdentity)) {</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-                    if (author.includes(identity.email) &amp;&amp; !identity.fccReplyFollowParent) {</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+                    if (author.includes(identity.email) &amp;&amp; !identity.fccReplyFollowsParent) {</span>
<a href="#l11.14"></a><span id="l11.14">                         return true;</span>
<a href="#l11.15"></a><span id="l11.15">                     }</span>
<a href="#l11.16"></a><span id="l11.16">                 }</span>
<a href="#l11.17"></a><span id="l11.17">             }</span>
<a href="#l11.18"></a><span id="l11.18">             return false;</span>
<a href="#l11.19"></a><span id="l11.19">         };</span>
<a href="#l11.20"></a><span id="l11.20"> </span>
<a href="#l11.21"></a><span id="l11.21">         // We override the bar label for sent out invitations and in case the event does not exist</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineat">@@ -274,30 +274,71 @@ var ltnImipBar = {</span>
<a href="#l11.23"></a><span id="l11.23">             }</span>
<a href="#l11.24"></a><span id="l11.24">         }</span>
<a href="#l11.25"></a><span id="l11.25">         msgWindow.displayHTMLInMessagePane(&quot;&quot;, msgOverlay, false);</span>
<a href="#l11.26"></a><span id="l11.26">     },</span>
<a href="#l11.27"></a><span id="l11.27"> </span>
<a href="#l11.28"></a><span id="l11.28">     executeAction: function(partStat, extendResponse) {</span>
<a href="#l11.29"></a><span id="l11.29">         function _execAction(aActionFunc, aItipItem, aWindow, aPartStat) {</span>
<a href="#l11.30"></a><span id="l11.30">             if (cal.itip.promptCalendar(aActionFunc.method, aItipItem, aWindow)) {</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineplus">+                let isDeclineCounter = aPartStat == &quot;X-DECLINECOUNTER&quot;;</span>
<a href="#l11.32"></a><span id="l11.32">                 // filter out fake partstats</span>
<a href="#l11.33"></a><span id="l11.33">                 if (aPartStat.startsWith(&quot;X-&quot;)) {</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineminus">-                    partstat = &quot;&quot;;</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineplus">+                    partStat = &quot;&quot;;</span>
<a href="#l11.36"></a><span id="l11.36">                 }</span>
<a href="#l11.37"></a><span id="l11.37">                 // hide the buttons now, to disable pressing them twice...</span>
<a href="#l11.38"></a><span id="l11.38">                 if (aPartStat == partStat) {</span>
<a href="#l11.39"></a><span id="l11.39">                     ltnImipBar.resetButtons();</span>
<a href="#l11.40"></a><span id="l11.40">                 }</span>
<a href="#l11.41"></a><span id="l11.41"> </span>
<a href="#l11.42"></a><span id="l11.42">                 let opListener = {</span>
<a href="#l11.43"></a><span id="l11.43">                     QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calIOperationListener]),</span>
<a href="#l11.44"></a><span id="l11.44">                     onOperationComplete: function(aCalendar, aStatus, aOperationType, aId, aDetail) {</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineplus">+                        if (Components.isSuccessCode(aStatus) &amp;&amp; isDeclineCounter) {</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineplus">+                            // TODO: move the DECLINECOUNTER stuff to actionFunc</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineplus">+                            aItipItem.getItemList({}).forEach(aItem =&gt; {</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineplus">+                                // we can rely on the received itipItem to reply at this stage</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineplus">+                                // already, the checks have been done in cal.itip.processFoundItems</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineplus">+                                // when setting up the respective aActionFunc</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineplus">+                                let attendees = cal.getAttendeesBySender(</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineplus">+                                    aItem.getAttendees({}),</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineplus">+                                    aItipItem.sender</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineplus">+                                );</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineplus">+                                let status = true;</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineplus">+                                if (attendees.length == 1 &amp;&amp; ltnImipBar.foundItems &amp;&amp;</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineplus">+                                    ltnImipBar.foundItems.length) {</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineplus">+                                    // we must return a message with the same sequence number as the</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineplus">+                                    // counterproposal - to make it easy, we simply use the received</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineplus">+                                    // item and just remove a comment, if any</span>
<a href="#l11.61"></a><span id="l11.61" class="difflineplus">+                                    try {</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineplus">+                                        let item = aItem.clone();</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineplus">+                                        item.calendar = ltnImipBar.foundItems[0].calendar;</span>
<a href="#l11.64"></a><span id="l11.64" class="difflineplus">+                                        item.deleteProperty(&quot;COMMENT&quot;);</span>
<a href="#l11.65"></a><span id="l11.65" class="difflineplus">+                                        // once we have full support to deal with for multiple items</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineplus">+                                        // in a received invitation message, we should send this</span>
<a href="#l11.67"></a><span id="l11.67" class="difflineplus">+                                        // from outside outside of the forEach context</span>
<a href="#l11.68"></a><span id="l11.68" class="difflineplus">+                                        status = cal.itip.sendDeclineCounterMessage(</span>
<a href="#l11.69"></a><span id="l11.69" class="difflineplus">+                                            item,</span>
<a href="#l11.70"></a><span id="l11.70" class="difflineplus">+                                            &quot;DECLINECOUNTER&quot;,</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineplus">+                                            attendees,</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineplus">+                                            { value: false }</span>
<a href="#l11.73"></a><span id="l11.73" class="difflineplus">+                                        );</span>
<a href="#l11.74"></a><span id="l11.74" class="difflineplus">+                                    } catch (e) {</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineplus">+                                        cal.ERROR(e);</span>
<a href="#l11.76"></a><span id="l11.76" class="difflineplus">+                                        status = false;</span>
<a href="#l11.77"></a><span id="l11.77" class="difflineplus">+                                    }</span>
<a href="#l11.78"></a><span id="l11.78" class="difflineplus">+                                } else {</span>
<a href="#l11.79"></a><span id="l11.79" class="difflineplus">+                                    status = false;</span>
<a href="#l11.80"></a><span id="l11.80" class="difflineplus">+                                }</span>
<a href="#l11.81"></a><span id="l11.81" class="difflineplus">+                                if (!status) {</span>
<a href="#l11.82"></a><span id="l11.82" class="difflineplus">+                                    cal.ERROR(&quot;Failed to send DECLINECOUNTER reply!&quot;);</span>
<a href="#l11.83"></a><span id="l11.83" class="difflineplus">+                                }</span>
<a href="#l11.84"></a><span id="l11.84" class="difflineplus">+                            });</span>
<a href="#l11.85"></a><span id="l11.85" class="difflineplus">+                        }</span>
<a href="#l11.86"></a><span id="l11.86">                         // For now, we just state the status for the user something very simple</span>
<a href="#l11.87"></a><span id="l11.87" class="difflineminus">-                        let imipBar = document.getElementById(&quot;imip-bar&quot;);</span>
<a href="#l11.88"></a><span id="l11.88">                         let label = cal.itip.getCompleteText(aStatus, aOperationType);</span>
<a href="#l11.89"></a><span id="l11.89">                         imipBar.setAttribute(&quot;label&quot;, label);</span>
<a href="#l11.90"></a><span id="l11.90"> </span>
<a href="#l11.91"></a><span id="l11.91">                         if (!Components.isSuccessCode(aStatus)) {</span>
<a href="#l11.92"></a><span id="l11.92">                             showError(label);</span>
<a href="#l11.93"></a><span id="l11.93">                         }</span>
<a href="#l11.94"></a><span id="l11.94">                     },</span>
<a href="#l11.95"></a><span id="l11.95">                     onGetResult: function(aCalendar, aStatus, aItemType, aDetail, aCount, aItems) {</span>
<a href="#l11.96"></a><span id="l11.96" class="difflineat">@@ -309,29 +350,80 @@ var ltnImipBar = {</span>
<a href="#l11.97"></a><span id="l11.97">                 } catch (exc) {</span>
<a href="#l11.98"></a><span id="l11.98">                     Components.utils.reportError(exc);</span>
<a href="#l11.99"></a><span id="l11.99">                 }</span>
<a href="#l11.100"></a><span id="l11.100">                 return true;</span>
<a href="#l11.101"></a><span id="l11.101">             }</span>
<a href="#l11.102"></a><span id="l11.102">             return false;</span>
<a href="#l11.103"></a><span id="l11.103">         }</span>
<a href="#l11.104"></a><span id="l11.104"> </span>
<a href="#l11.105"></a><span id="l11.105" class="difflineplus">+        let imipBar = document.getElementById(&quot;imip-bar&quot;);</span>
<a href="#l11.106"></a><span id="l11.106">         if (partStat == null) {</span>
<a href="#l11.107"></a><span id="l11.107">             partStat = &quot;&quot;;</span>
<a href="#l11.108"></a><span id="l11.108">         }</span>
<a href="#l11.109"></a><span id="l11.109" class="difflineminus">-        if (partStat == &quot;X-SHOWDETAILS&quot;) {</span>
<a href="#l11.110"></a><span id="l11.110" class="difflineplus">+        if (partStat == &quot;X-SHOWDETAILS&quot; || partStat == &quot;X-RESCHEDULE&quot;) {</span>
<a href="#l11.111"></a><span id="l11.111" class="difflineplus">+            let counterProposal;</span>
<a href="#l11.112"></a><span id="l11.112">             let items = ltnImipBar.foundItems;</span>
<a href="#l11.113"></a><span id="l11.113">             if (items &amp;&amp; items.length) {</span>
<a href="#l11.114"></a><span id="l11.114">                 let item = items[0].isMutable ? items[0] : items[0].clone();</span>
<a href="#l11.115"></a><span id="l11.115" class="difflineminus">-                modifyEventWithDialog(item);</span>
<a href="#l11.116"></a><span id="l11.116" class="difflineplus">+</span>
<a href="#l11.117"></a><span id="l11.117" class="difflineplus">+                if (partStat == &quot;X-RESCHEDULE&quot;) {</span>
<a href="#l11.118"></a><span id="l11.118" class="difflineplus">+                    // TODO most of the following should be moved to the actionFunc defined in</span>
<a href="#l11.119"></a><span id="l11.119" class="difflineplus">+                    // calItipUtils</span>
<a href="#l11.120"></a><span id="l11.120" class="difflineplus">+                    let proposedItem = ltnImipBar.itipItem.getItemList({})[0];</span>
<a href="#l11.121"></a><span id="l11.121" class="difflineplus">+                    let proposedRID = proposedItem.getProperty(&quot;RECURRENCE-ID&quot;);</span>
<a href="#l11.122"></a><span id="l11.122" class="difflineplus">+                    if (proposedRID) {</span>
<a href="#l11.123"></a><span id="l11.123" class="difflineplus">+                        // if this is a counterproposal for a specific occurrence, we use</span>
<a href="#l11.124"></a><span id="l11.124" class="difflineplus">+                        // that to compare with</span>
<a href="#l11.125"></a><span id="l11.125" class="difflineplus">+                        item = item.recurrenceInfo.getOccurrenceFor(proposedRID).clone();</span>
<a href="#l11.126"></a><span id="l11.126" class="difflineplus">+                    }</span>
<a href="#l11.127"></a><span id="l11.127" class="difflineplus">+                    let parsedProposal = ltn.invitation.parseCounter(proposedItem, item);</span>
<a href="#l11.128"></a><span id="l11.128" class="difflineplus">+                    let potentialProposers = cal.getAttendeesBySender(</span>
<a href="#l11.129"></a><span id="l11.129" class="difflineplus">+                        proposedItem.getAttendees({}),</span>
<a href="#l11.130"></a><span id="l11.130" class="difflineplus">+                        ltnImipBar.itipItem.sender</span>
<a href="#l11.131"></a><span id="l11.131" class="difflineplus">+                    );</span>
<a href="#l11.132"></a><span id="l11.132" class="difflineplus">+                    let proposingAttendee = potentialProposers.length == 1 ?</span>
<a href="#l11.133"></a><span id="l11.133" class="difflineplus">+                                            potentialProposers[0] : null;</span>
<a href="#l11.134"></a><span id="l11.134" class="difflineplus">+                    if (proposingAttendee &amp;&amp;</span>
<a href="#l11.135"></a><span id="l11.135" class="difflineplus">+                        [&quot;OK&quot;, &quot;OUTDATED&quot;, &quot;NOTLATESTUPDATE&quot;].includes(parsedProposal.result.type)) {</span>
<a href="#l11.136"></a><span id="l11.136" class="difflineplus">+                        counterProposal = {</span>
<a href="#l11.137"></a><span id="l11.137" class="difflineplus">+                            attendee: proposingAttendee,</span>
<a href="#l11.138"></a><span id="l11.138" class="difflineplus">+                            proposal: parsedProposal.differences,</span>
<a href="#l11.139"></a><span id="l11.139" class="difflineplus">+                            oldVersion: parsedProposal.result == &quot;OLDVERSION&quot; ||</span>
<a href="#l11.140"></a><span id="l11.140" class="difflineplus">+                                        parsedProposal.result == &quot;NOTLATESTUPDATE&quot;,</span>
<a href="#l11.141"></a><span id="l11.141" class="difflineplus">+                            onReschedule: () =&gt; {</span>
<a href="#l11.142"></a><span id="l11.142" class="difflineplus">+                                imipBar.setAttribute(</span>
<a href="#l11.143"></a><span id="l11.143" class="difflineplus">+                                    &quot;label&quot;,</span>
<a href="#l11.144"></a><span id="l11.144" class="difflineplus">+                                    ltn.getString(&quot;lightning&quot;, &quot;imipBarCounterPreviousVersionText&quot;)</span>
<a href="#l11.145"></a><span id="l11.145" class="difflineplus">+                                );</span>
<a href="#l11.146"></a><span id="l11.146" class="difflineplus">+                                // TODO: should we hide the buttons in this case, too?</span>
<a href="#l11.147"></a><span id="l11.147" class="difflineplus">+                            }</span>
<a href="#l11.148"></a><span id="l11.148" class="difflineplus">+                        };</span>
<a href="#l11.149"></a><span id="l11.149" class="difflineplus">+                    } else {</span>
<a href="#l11.150"></a><span id="l11.150" class="difflineplus">+                        imipBar.setAttribute(</span>
<a href="#l11.151"></a><span id="l11.151" class="difflineplus">+                            &quot;label&quot;,</span>
<a href="#l11.152"></a><span id="l11.152" class="difflineplus">+                            ltn.getString(&quot;lightning&quot;, &quot;imipBarCounterErrorText&quot;)</span>
<a href="#l11.153"></a><span id="l11.153" class="difflineplus">+                        );</span>
<a href="#l11.154"></a><span id="l11.154" class="difflineplus">+                        ltnImipBar.resetButtons();</span>
<a href="#l11.155"></a><span id="l11.155" class="difflineplus">+                        if (proposingAttendee) {</span>
<a href="#l11.156"></a><span id="l11.156" class="difflineplus">+                            cal.LOG(parsedProposal.result.descr);</span>
<a href="#l11.157"></a><span id="l11.157" class="difflineplus">+                        } else {</span>
<a href="#l11.158"></a><span id="l11.158" class="difflineplus">+                            cal.LOG(&quot;Failed to identify the sending attendee of the counterproposal.&quot;);</span>
<a href="#l11.159"></a><span id="l11.159" class="difflineplus">+                        }</span>
<a href="#l11.160"></a><span id="l11.160" class="difflineplus">+</span>
<a href="#l11.161"></a><span id="l11.161" class="difflineplus">+                        return false;</span>
<a href="#l11.162"></a><span id="l11.162" class="difflineplus">+                    }</span>
<a href="#l11.163"></a><span id="l11.163" class="difflineplus">+                }</span>
<a href="#l11.164"></a><span id="l11.164" class="difflineplus">+                // if this a rescheduling operation, we suppress the occurrence prompt here</span>
<a href="#l11.165"></a><span id="l11.165" class="difflineplus">+                modifyEventWithDialog(item, null, partStat != &quot;X-RESCHEDULE&quot;, null, counterProposal);</span>
<a href="#l11.166"></a><span id="l11.166">             }</span>
<a href="#l11.167"></a><span id="l11.167">         } else {</span>
<a href="#l11.168"></a><span id="l11.168">             if (extendResponse) {</span>
<a href="#l11.169"></a><span id="l11.169">                 // Open an extended response dialog to enable the user to add a comment, make a</span>
<a href="#l11.170"></a><span id="l11.170" class="difflineminus">-                // counter proposal, delegate the event or interact in another way.</span>
<a href="#l11.171"></a><span id="l11.171" class="difflineplus">+                // counterproposal, delegate the event or interact in another way.</span>
<a href="#l11.172"></a><span id="l11.172">                 // Instead of a dialog, this might be implemented as a separate container inside the</span>
<a href="#l11.173"></a><span id="l11.173">                 // imip-overlay as proposed in bug 458578</span>
<a href="#l11.174"></a><span id="l11.174">                 //</span>
<a href="#l11.175"></a><span id="l11.175">                 // If implemented as a dialog, the OL compatibility decision should be incorporated</span>
<a href="#l11.176"></a><span id="l11.176">                 // therein too and the itipItems's autoResponse set to auto subsequently</span>
<a href="#l11.177"></a><span id="l11.177">                 // to prevent a second popup during imip transport processing.</span>
<a href="#l11.178"></a><span id="l11.178">             }</span>
<a href="#l11.179"></a><span id="l11.179">             let delmgr = Components.classes[&quot;@mozilla.org/calendar/deleted-items-manager;1&quot;]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/calendar/lightning/content/lightning-item-iframe.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/calendar/lightning/content/lightning-item-iframe.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -368,16 +368,21 @@ function onLoad() {</span>
<a href="#l12.4"></a><span id="l12.4">         if (!gNewItemUI) {</span>
<a href="#l12.5"></a><span id="l12.5">             setElementValue(&quot;completed-date-picker&quot;, initialDatesValue);</span>
<a href="#l12.6"></a><span id="l12.6">             setElementValue(&quot;todo-entrydate&quot;, initialDatesValue);</span>
<a href="#l12.7"></a><span id="l12.7">             setElementValue(&quot;todo-duedate&quot;, initialDatesValue);</span>
<a href="#l12.8"></a><span id="l12.8">         }</span>
<a href="#l12.9"></a><span id="l12.9">     }</span>
<a href="#l12.10"></a><span id="l12.10">     loadDialog(window.calendarItem);</span>
<a href="#l12.11"></a><span id="l12.11"> </span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+    if (args.counterProposal) {</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+        window.counterProposal = args.counterProposal;</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+        displayCounterProposal();</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+    }</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineplus">+</span>
<a href="#l12.17"></a><span id="l12.17">     gMainWindow.setCursor(&quot;auto&quot;);</span>
<a href="#l12.18"></a><span id="l12.18"> </span>
<a href="#l12.19"></a><span id="l12.19">     if (typeof ToolbarIconColor !== &quot;undefined&quot;) {</span>
<a href="#l12.20"></a><span id="l12.20">         ToolbarIconColor.init();</span>
<a href="#l12.21"></a><span id="l12.21">     }</span>
<a href="#l12.22"></a><span id="l12.22"> </span>
<a href="#l12.23"></a><span id="l12.23">     if (!gNewItemUI) {</span>
<a href="#l12.24"></a><span id="l12.24">         document.getElementById(&quot;item-title&quot;).focus();</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineat">@@ -730,34 +735,41 @@ function loadDialog(aItem) {</span>
<a href="#l12.26"></a><span id="l12.26">         // figure out what the title of the dialog should be and set it</span>
<a href="#l12.27"></a><span id="l12.27">         // tabs already have their title set</span>
<a href="#l12.28"></a><span id="l12.28">         if (!gInTab) {</span>
<a href="#l12.29"></a><span id="l12.29">             updateTitle();</span>
<a href="#l12.30"></a><span id="l12.30">         }</span>
<a href="#l12.31"></a><span id="l12.31"> </span>
<a href="#l12.32"></a><span id="l12.32">         let notifyCheckbox = document.getElementById(&quot;notify-attendees-checkbox&quot;);</span>
<a href="#l12.33"></a><span id="l12.33">         let undiscloseCheckbox = document.getElementById(&quot;undisclose-attendees-checkbox&quot;);</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineplus">+        let disallowcounterCheckbox = document.getElementById(&quot;disallow-counter-checkbox&quot;);</span>
<a href="#l12.35"></a><span id="l12.35">         if (canNotifyAttendees(aItem.calendar, aItem)) {</span>
<a href="#l12.36"></a><span id="l12.36">             // visualize that the server will send out mail:</span>
<a href="#l12.37"></a><span id="l12.37">             notifyCheckbox.checked = true;</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineminus">-            // hide undisclosure control as this a client only feature</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineplus">+            // hide these controls as this a client only feature</span>
<a href="#l12.40"></a><span id="l12.40">             undiscloseCheckbox.disabled = true;</span>
<a href="#l12.41"></a><span id="l12.41">         } else {</span>
<a href="#l12.42"></a><span id="l12.42">             let itemProp = aItem.getProperty(&quot;X-MOZ-SEND-INVITATIONS&quot;);</span>
<a href="#l12.43"></a><span id="l12.43">             notifyCheckbox.checked = (aItem.calendar.getProperty(&quot;imip.identity&quot;) &amp;&amp;</span>
<a href="#l12.44"></a><span id="l12.44">                                       ((itemProp === null)</span>
<a href="#l12.45"></a><span id="l12.45">                                        ? Preferences.get(&quot;calendar.itip.notify&quot;, true)</span>
<a href="#l12.46"></a><span id="l12.46">                                        : (itemProp == &quot;TRUE&quot;)));</span>
<a href="#l12.47"></a><span id="l12.47">             let undiscloseProp = aItem.getProperty(&quot;X-MOZ-SEND-INVITATIONS-UNDISCLOSED&quot;);</span>
<a href="#l12.48"></a><span id="l12.48">             undiscloseCheckbox.checked = (undiscloseProp === null)</span>
<a href="#l12.49"></a><span id="l12.49">                                          ? false // default value as most common within organizations</span>
<a href="#l12.50"></a><span id="l12.50">                                          : (undiscloseProp == &quot;TRUE&quot;);</span>
<a href="#l12.51"></a><span id="l12.51">             // disable checkbox, if notifyCheckbox is not checked</span>
<a href="#l12.52"></a><span id="l12.52">             undiscloseCheckbox.disabled = (notifyCheckbox.checked == false);</span>
<a href="#l12.53"></a><span id="l12.53">         }</span>
<a href="#l12.54"></a><span id="l12.54" class="difflineplus">+        // this may also be a server exposed calendar property from exchange servers - if so, this</span>
<a href="#l12.55"></a><span id="l12.55" class="difflineplus">+        // probably should overrule the client-side config option</span>
<a href="#l12.56"></a><span id="l12.56" class="difflineplus">+        let disallowCounterProp = aItem.getProperty(&quot;X-MICROSOFT-DISALLOW-COUNTER&quot;);</span>
<a href="#l12.57"></a><span id="l12.57" class="difflineplus">+        disallowcounterCheckbox.checked = disallowCounterProp == &quot;TRUE&quot;;</span>
<a href="#l12.58"></a><span id="l12.58" class="difflineplus">+        // if we're in reschedule mode, it's pointless to enable the control</span>
<a href="#l12.59"></a><span id="l12.59" class="difflineplus">+        disallowcounterCheckbox.disabled = !!window.counterProposal;</span>
<a href="#l12.60"></a><span id="l12.60"> </span>
<a href="#l12.61"></a><span id="l12.61">         updateAttendees();</span>
<a href="#l12.62"></a><span id="l12.62">         updateRepeat(true);</span>
<a href="#l12.63"></a><span id="l12.63">         updateReminder(true);</span>
<a href="#l12.64"></a><span id="l12.64">     }</span>
<a href="#l12.65"></a><span id="l12.65"> </span>
<a href="#l12.66"></a><span id="l12.66">     // Status</span>
<a href="#l12.67"></a><span id="l12.67">     if (cal.isEvent(aItem)) {</span>
<a href="#l12.68"></a><span id="l12.68" class="difflineat">@@ -2923,17 +2935,30 @@ function saveItem() {</span>
<a href="#l12.69"></a><span id="l12.69">             item.deleteProperty(&quot;X-MOZ-SEND-INVITATIONS&quot;);</span>
<a href="#l12.70"></a><span id="l12.70">         } else {</span>
<a href="#l12.71"></a><span id="l12.71">             item.setProperty(&quot;X-MOZ-SEND-INVITATIONS&quot;, notifyCheckbox.checked ? &quot;TRUE&quot; : &quot;FALSE&quot;);</span>
<a href="#l12.72"></a><span id="l12.72">         }</span>
<a href="#l12.73"></a><span id="l12.73">         let undiscloseCheckbox = document.getElementById(&quot;undisclose-attendees-checkbox&quot;);</span>
<a href="#l12.74"></a><span id="l12.74">         if (undiscloseCheckbox.disabled) {</span>
<a href="#l12.75"></a><span id="l12.75">             item.deleteProperty(&quot;X-MOZ-SEND-INVITATIONS-UNDISCLOSED&quot;);</span>
<a href="#l12.76"></a><span id="l12.76">         } else {</span>
<a href="#l12.77"></a><span id="l12.77" class="difflineminus">-            item.setProperty(&quot;X-MOZ-SEND-INVITATIONS-UNDISCLOSED&quot;, undiscloseCheckbox.checked ? &quot;TRUE&quot; : &quot;FALSE&quot;);</span>
<a href="#l12.78"></a><span id="l12.78" class="difflineplus">+            item.setProperty(&quot;X-MOZ-SEND-INVITATIONS-UNDISCLOSED&quot;,</span>
<a href="#l12.79"></a><span id="l12.79" class="difflineplus">+                             undiscloseCheckbox.checked ? &quot;TRUE&quot; : &quot;FALSE&quot;);</span>
<a href="#l12.80"></a><span id="l12.80" class="difflineplus">+        }</span>
<a href="#l12.81"></a><span id="l12.81" class="difflineplus">+        let disallowcounterCheckbox = document.getElementById(&quot;disallow-counter-checkbox&quot;);</span>
<a href="#l12.82"></a><span id="l12.82" class="difflineplus">+        let xProp = window.calendarItem.getProperty(&quot;X-MICROSOFT-DISALLOW-COUNTER&quot;);</span>
<a href="#l12.83"></a><span id="l12.83" class="difflineplus">+        // we want to leave an existing x-prop in case the checkbox is disabled as we need to</span>
<a href="#l12.84"></a><span id="l12.84" class="difflineplus">+        // roundtrip x-props that are not exclusively under our control</span>
<a href="#l12.85"></a><span id="l12.85" class="difflineplus">+        if (!disallowcounterCheckbox.disabled) {</span>
<a href="#l12.86"></a><span id="l12.86" class="difflineplus">+            // we only set the prop if we need to</span>
<a href="#l12.87"></a><span id="l12.87" class="difflineplus">+            if (disallowcounterCheckbox.checked) {</span>
<a href="#l12.88"></a><span id="l12.88" class="difflineplus">+                item.setProperty(&quot;X-MICROSOFT-DISALLOW-COUNTER&quot;, &quot;TRUE&quot;);</span>
<a href="#l12.89"></a><span id="l12.89" class="difflineplus">+            } else if (xProp) {</span>
<a href="#l12.90"></a><span id="l12.90" class="difflineplus">+                item.setProperty(&quot;X-MICROSOFT-DISALLOW-COUNTER&quot;, &quot;FALSE&quot;);</span>
<a href="#l12.91"></a><span id="l12.91" class="difflineplus">+            }</span>
<a href="#l12.92"></a><span id="l12.92">         }</span>
<a href="#l12.93"></a><span id="l12.93">     }</span>
<a href="#l12.94"></a><span id="l12.94"> </span>
<a href="#l12.95"></a><span id="l12.95">     // We check if the organizerID is different from our</span>
<a href="#l12.96"></a><span id="l12.96">     // calendar-user-address-set. The organzerID is the owner of the calendar.</span>
<a href="#l12.97"></a><span id="l12.97">     // If it's different, that is because someone is acting on behalf of</span>
<a href="#l12.98"></a><span id="l12.98">     // the organizer.</span>
<a href="#l12.99"></a><span id="l12.99">     if (item.organizer &amp;&amp; item.calendar.aclEntry) {</span>
<a href="#l12.100"></a><span id="l12.100" class="difflineat">@@ -2988,17 +3013,17 @@ function onCommandSave(aIsClosing) {</span>
<a href="#l12.101"></a><span id="l12.101">     // the call is complete? This might help when the user tries to save twice</span>
<a href="#l12.102"></a><span id="l12.102">     // before the call is complete. In that case, we do need a progress bar and</span>
<a href="#l12.103"></a><span id="l12.103">     // the ability to cancel the operation though.</span>
<a href="#l12.104"></a><span id="l12.104">     let listener = {</span>
<a href="#l12.105"></a><span id="l12.105">         QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calIOperationListener]),</span>
<a href="#l12.106"></a><span id="l12.106">         onOperationComplete: function(aCalendar, aStatus, aOpType, aId, aItem) {</span>
<a href="#l12.107"></a><span id="l12.107">             // Check if the current window has a calendarItem first, because in case of undo</span>
<a href="#l12.108"></a><span id="l12.108">             // window refers to the main window and we would get a 'calendarItem is undefined' warning.</span>
<a href="#l12.109"></a><span id="l12.109" class="difflineminus">-            if (&quot;calendarItem&quot; in window) {</span>
<a href="#l12.110"></a><span id="l12.110" class="difflineplus">+            if (!aIsClosing &amp;&amp; &quot;calendarItem&quot; in window) {</span>
<a href="#l12.111"></a><span id="l12.111">                 // If we changed the calendar of the item, onOperationComplete will be called multiple</span>
<a href="#l12.112"></a><span id="l12.112">                 // times. We need to make sure we're receiving the update on the right calendar.</span>
<a href="#l12.113"></a><span id="l12.113">                 if ((!window.calendarItem.id ||aId == window.calendarItem.id) &amp;&amp;</span>
<a href="#l12.114"></a><span id="l12.114">                     (aCalendar.id == window.calendarItem.calendar.id) &amp;&amp;</span>
<a href="#l12.115"></a><span id="l12.115">                     Components.isSuccessCode(aStatus)) {</span>
<a href="#l12.116"></a><span id="l12.116">                     if (window.calendarItem.recurrenceId) {</span>
<a href="#l12.117"></a><span id="l12.117">                         // TODO This workaround needs to be removed in bug 396182</span>
<a href="#l12.118"></a><span id="l12.118">                         // We are editing an occurrence. Make sure that the returned</span>
<a href="#l12.119"></a><span id="l12.119" class="difflineat">@@ -3012,24 +3037,24 @@ function onCommandSave(aIsClosing) {</span>
<a href="#l12.120"></a><span id="l12.120">                     }</span>
<a href="#l12.121"></a><span id="l12.121"> </span>
<a href="#l12.122"></a><span id="l12.122">                     // We now have an item, so we must change to an edit.</span>
<a href="#l12.123"></a><span id="l12.123">                     window.mode = &quot;modify&quot;;</span>
<a href="#l12.124"></a><span id="l12.124">                     updateTitle();</span>
<a href="#l12.125"></a><span id="l12.125">                     eventDialogCalendarObserver.observe(window.calendarItem.calendar);</span>
<a href="#l12.126"></a><span id="l12.126">                 }</span>
<a href="#l12.127"></a><span id="l12.127">             }</span>
<a href="#l12.128"></a><span id="l12.128" class="difflineplus">+            // this triggers the update of the imipbar in case this is a rescheduling case</span>
<a href="#l12.129"></a><span id="l12.129" class="difflineplus">+            if (window.counterProposal &amp;&amp; window.counterProposal.onReschedule) {</span>
<a href="#l12.130"></a><span id="l12.130" class="difflineplus">+                window.counterProposal.onReschedule();</span>
<a href="#l12.131"></a><span id="l12.131" class="difflineplus">+            }</span>
<a href="#l12.132"></a><span id="l12.132">         },</span>
<a href="#l12.133"></a><span id="l12.133">         onGetResult: function() {}</span>
<a href="#l12.134"></a><span id="l12.134">     };</span>
<a href="#l12.135"></a><span id="l12.135" class="difflineminus">-</span>
<a href="#l12.136"></a><span id="l12.136" class="difflineminus">-    // Let the caller decide how to handle the modified/added item. Only pass</span>
<a href="#l12.137"></a><span id="l12.137" class="difflineminus">-    // the above item if we are not closing, otherwise the listener will be</span>
<a href="#l12.138"></a><span id="l12.138" class="difflineminus">-    // missing its window afterwards.</span>
<a href="#l12.139"></a><span id="l12.139" class="difflineminus">-    window.onAcceptCallback(item, calendar, originalItem, !aIsClosing &amp;&amp; listener);</span>
<a href="#l12.140"></a><span id="l12.140" class="difflineplus">+    window.onAcceptCallback(item, calendar, originalItem, listener);</span>
<a href="#l12.141"></a><span id="l12.141"> }</span>
<a href="#l12.142"></a><span id="l12.142"> </span>
<a href="#l12.143"></a><span id="l12.143"> /**</span>
<a href="#l12.144"></a><span id="l12.144">  * This function is called when the user chooses to delete an Item</span>
<a href="#l12.145"></a><span id="l12.145">  * from the Event/Task dialog</span>
<a href="#l12.146"></a><span id="l12.146">  *</span>
<a href="#l12.147"></a><span id="l12.147">  */</span>
<a href="#l12.148"></a><span id="l12.148"> function onCommandDeleteItem() {</span>
<a href="#l12.149"></a><span id="l12.149" class="difflineat">@@ -3814,17 +3839,17 @@ function capSupported(aCap) {</span>
<a href="#l12.150"></a><span id="l12.150">  * @return          The values for this capability</span>
<a href="#l12.151"></a><span id="l12.151">  */</span>
<a href="#l12.152"></a><span id="l12.152"> function capValues(aCap, aDefault) {</span>
<a href="#l12.153"></a><span id="l12.153">     let calendar = getCurrentCalendar();</span>
<a href="#l12.154"></a><span id="l12.154">     let vals = calendar.getProperty(&quot;capabilities.&quot; + aCap + &quot;.values&quot;);</span>
<a href="#l12.155"></a><span id="l12.155">     return (vals === null ? aDefault : vals);</span>
<a href="#l12.156"></a><span id="l12.156"> }</span>
<a href="#l12.157"></a><span id="l12.157"> </span>
<a href="#l12.158"></a><span id="l12.158" class="difflineminus">- /**</span>
<a href="#l12.159"></a><span id="l12.159" class="difflineplus">+/**</span>
<a href="#l12.160"></a><span id="l12.160">  * Checks the until date just entered in the datepicker in order to avoid</span>
<a href="#l12.161"></a><span id="l12.161">  * setting a date earlier than the start date.</span>
<a href="#l12.162"></a><span id="l12.162">  * Restores the previous correct date; sets the warning flag to prevent closing</span>
<a href="#l12.163"></a><span id="l12.163">  * the dialog when the user enters a wrong until date.</span>
<a href="#l12.164"></a><span id="l12.164">  */</span>
<a href="#l12.165"></a><span id="l12.165"> function checkUntilDate() {</span>
<a href="#l12.166"></a><span id="l12.166">     let repeatUntilDate = getElementValue(&quot;repeat-until-datepicker&quot;);</span>
<a href="#l12.167"></a><span id="l12.167">     if (repeatUntilDate == &quot;forever&quot;) {</span>
<a href="#l12.168"></a><span id="l12.168" class="difflineat">@@ -3858,8 +3883,203 @@ function checkUntilDate() {</span>
<a href="#l12.169"></a><span id="l12.169">         };</span>
<a href="#l12.170"></a><span id="l12.170">         setTimeout(callback, 1);</span>
<a href="#l12.171"></a><span id="l12.171">     } else {</span>
<a href="#l12.172"></a><span id="l12.172">         // Valid date: set the time equal to start date time.</span>
<a href="#l12.173"></a><span id="l12.173">         gUntilDate = untilDate;</span>
<a href="#l12.174"></a><span id="l12.174">         updateUntildateRecRule();</span>
<a href="#l12.175"></a><span id="l12.175">     }</span>
<a href="#l12.176"></a><span id="l12.176"> }</span>
<a href="#l12.177"></a><span id="l12.177" class="difflineplus">+</span>
<a href="#l12.178"></a><span id="l12.178" class="difflineplus">+/**</span>
<a href="#l12.179"></a><span id="l12.179" class="difflineplus">+ * Displays a counterproposal if any</span>
<a href="#l12.180"></a><span id="l12.180" class="difflineplus">+ */</span>
<a href="#l12.181"></a><span id="l12.181" class="difflineplus">+function displayCounterProposal() {</span>
<a href="#l12.182"></a><span id="l12.182" class="difflineplus">+    if (!window.counterProposal || !window.counterProposal.attendee ||</span>
<a href="#l12.183"></a><span id="l12.183" class="difflineplus">+        !window.counterProposal.proposal) {</span>
<a href="#l12.184"></a><span id="l12.184" class="difflineplus">+        return;</span>
<a href="#l12.185"></a><span id="l12.185" class="difflineplus">+    }</span>
<a href="#l12.186"></a><span id="l12.186" class="difflineplus">+</span>
<a href="#l12.187"></a><span id="l12.187" class="difflineplus">+    let propLabels = document.getElementById(&quot;counter-proposal-property-labels&quot;);</span>
<a href="#l12.188"></a><span id="l12.188" class="difflineplus">+    let propValues = document.getElementById(&quot;counter-proposal-property-values&quot;);</span>
<a href="#l12.189"></a><span id="l12.189" class="difflineplus">+    let idCounter = 0;</span>
<a href="#l12.190"></a><span id="l12.190" class="difflineplus">+    let comment;</span>
<a href="#l12.191"></a><span id="l12.191" class="difflineplus">+</span>
<a href="#l12.192"></a><span id="l12.192" class="difflineplus">+    for (let proposal of window.counterProposal.proposal) {</span>
<a href="#l12.193"></a><span id="l12.193" class="difflineplus">+        if (proposal.property == &quot;COMMENT&quot;) {</span>
<a href="#l12.194"></a><span id="l12.194" class="difflineplus">+            if (proposal.proposed &amp;&amp; !proposal.original) {</span>
<a href="#l12.195"></a><span id="l12.195" class="difflineplus">+                comment = proposal.proposed;</span>
<a href="#l12.196"></a><span id="l12.196" class="difflineplus">+            }</span>
<a href="#l12.197"></a><span id="l12.197" class="difflineplus">+        } else {</span>
<a href="#l12.198"></a><span id="l12.198" class="difflineplus">+            let label = lookupCounterLabel(proposal);</span>
<a href="#l12.199"></a><span id="l12.199" class="difflineplus">+            let value = formatCounterValue(proposal);</span>
<a href="#l12.200"></a><span id="l12.200" class="difflineplus">+            if (label &amp;&amp; value) {</span>
<a href="#l12.201"></a><span id="l12.201" class="difflineplus">+                // setup label node</span>
<a href="#l12.202"></a><span id="l12.202" class="difflineplus">+                let propLabel = propLabels.firstChild.cloneNode(false);</span>
<a href="#l12.203"></a><span id="l12.203" class="difflineplus">+                propLabel.id = propLabel.id + &quot;-&quot; + idCounter;</span>
<a href="#l12.204"></a><span id="l12.204" class="difflineplus">+                propLabel.control = propLabel.control + &quot;-&quot; + idCounter;</span>
<a href="#l12.205"></a><span id="l12.205" class="difflineplus">+                propLabel.removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l12.206"></a><span id="l12.206" class="difflineplus">+                propLabel.value = label;</span>
<a href="#l12.207"></a><span id="l12.207" class="difflineplus">+                // setup value node</span>
<a href="#l12.208"></a><span id="l12.208" class="difflineplus">+                let propValue = propValues.firstChild.cloneNode(false);</span>
<a href="#l12.209"></a><span id="l12.209" class="difflineplus">+                propValue.id = propLabel.control;</span>
<a href="#l12.210"></a><span id="l12.210" class="difflineplus">+                propValue.removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l12.211"></a><span id="l12.211" class="difflineplus">+                propValue.value = value;</span>
<a href="#l12.212"></a><span id="l12.212" class="difflineplus">+                // append nodes</span>
<a href="#l12.213"></a><span id="l12.213" class="difflineplus">+                propLabels.appendChild(propLabel);</span>
<a href="#l12.214"></a><span id="l12.214" class="difflineplus">+                propValues.appendChild(propValue);</span>
<a href="#l12.215"></a><span id="l12.215" class="difflineplus">+                idCounter++;</span>
<a href="#l12.216"></a><span id="l12.216" class="difflineplus">+            }</span>
<a href="#l12.217"></a><span id="l12.217" class="difflineplus">+        }</span>
<a href="#l12.218"></a><span id="l12.218" class="difflineplus">+    }</span>
<a href="#l12.219"></a><span id="l12.219" class="difflineplus">+</span>
<a href="#l12.220"></a><span id="l12.220" class="difflineplus">+    let attendeeId = window.counterProposal.attendee.CN ||</span>
<a href="#l12.221"></a><span id="l12.221" class="difflineplus">+                     cal.removeMailTo(window.counterProposal.attendee.id || &quot;&quot;);</span>
<a href="#l12.222"></a><span id="l12.222" class="difflineplus">+    let partStat = window.counterProposal.attendee.participationStatus;</span>
<a href="#l12.223"></a><span id="l12.223" class="difflineplus">+    if (partStat == &quot;DECLINED&quot;) {</span>
<a href="#l12.224"></a><span id="l12.224" class="difflineplus">+        partStat = &quot;counterSummaryDeclined&quot;;</span>
<a href="#l12.225"></a><span id="l12.225" class="difflineplus">+    } else if (partStat == &quot;TENTATIVE&quot;) {</span>
<a href="#l12.226"></a><span id="l12.226" class="difflineplus">+        partStat = &quot;counterSummaryTentative&quot;;</span>
<a href="#l12.227"></a><span id="l12.227" class="difflineplus">+    } else if (partStat == &quot;ACCEPTED&quot;) {</span>
<a href="#l12.228"></a><span id="l12.228" class="difflineplus">+        partStat = &quot;counterSummaryAccepted&quot;;</span>
<a href="#l12.229"></a><span id="l12.229" class="difflineplus">+    } else if (partStat == &quot;DELEGATED&quot;) {</span>
<a href="#l12.230"></a><span id="l12.230" class="difflineplus">+        partStat = &quot;counterSummaryDelegated&quot;;</span>
<a href="#l12.231"></a><span id="l12.231" class="difflineplus">+    } else if (partStat == &quot;NEEDS-ACTION&quot;) {</span>
<a href="#l12.232"></a><span id="l12.232" class="difflineplus">+        partStat = &quot;counterSummaryNeedsAction&quot;;</span>
<a href="#l12.233"></a><span id="l12.233" class="difflineplus">+    } else {</span>
<a href="#l12.234"></a><span id="l12.234" class="difflineplus">+        cal.LOG(&quot;Unexpected partstat &quot; + partStat + &quot; detected.&quot;);</span>
<a href="#l12.235"></a><span id="l12.235" class="difflineplus">+        // we simply reset partStat not display the summary text of the counter box</span>
<a href="#l12.236"></a><span id="l12.236" class="difflineplus">+        // to avoid the window of death</span>
<a href="#l12.237"></a><span id="l12.237" class="difflineplus">+        partStat = null;</span>
<a href="#l12.238"></a><span id="l12.238" class="difflineplus">+    }</span>
<a href="#l12.239"></a><span id="l12.239" class="difflineplus">+</span>
<a href="#l12.240"></a><span id="l12.240" class="difflineplus">+    if (idCounter &gt; 0) {</span>
<a href="#l12.241"></a><span id="l12.241" class="difflineplus">+        if (partStat &amp;&amp; attendeeId.length) {</span>
<a href="#l12.242"></a><span id="l12.242" class="difflineplus">+            document.getElementById(&quot;counter-proposal-summary&quot;).value = cal.calGetString(</span>
<a href="#l12.243"></a><span id="l12.243" class="difflineplus">+                &quot;calendar-event-dialog&quot;,</span>
<a href="#l12.244"></a><span id="l12.244" class="difflineplus">+                partStat,</span>
<a href="#l12.245"></a><span id="l12.245" class="difflineplus">+                [attendeeId]</span>
<a href="#l12.246"></a><span id="l12.246" class="difflineplus">+            );</span>
<a href="#l12.247"></a><span id="l12.247" class="difflineplus">+            document.getElementById(&quot;counter-proposal-summary&quot;).removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l12.248"></a><span id="l12.248" class="difflineplus">+        }</span>
<a href="#l12.249"></a><span id="l12.249" class="difflineplus">+        if (comment) {</span>
<a href="#l12.250"></a><span id="l12.250" class="difflineplus">+            document.getElementById(&quot;counter-proposal-comment&quot;).value = comment;</span>
<a href="#l12.251"></a><span id="l12.251" class="difflineplus">+            document.getElementById(&quot;counter-proposal-box&quot;).removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l12.252"></a><span id="l12.252" class="difflineplus">+        }</span>
<a href="#l12.253"></a><span id="l12.253" class="difflineplus">+        document.getElementById(&quot;counter-proposal-box&quot;).removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l12.254"></a><span id="l12.254" class="difflineplus">+</span>
<a href="#l12.255"></a><span id="l12.255" class="difflineplus">+        if (window.counterProposal.oldVersion) {</span>
<a href="#l12.256"></a><span id="l12.256" class="difflineplus">+            // this is a counterproposal to a previous version of the event - we should notify the</span>
<a href="#l12.257"></a><span id="l12.257" class="difflineplus">+            // user accordingly</span>
<a href="#l12.258"></a><span id="l12.258" class="difflineplus">+            notifyUser(</span>
<a href="#l12.259"></a><span id="l12.259" class="difflineplus">+                &quot;counterProposalOnPreviousVersion&quot;,</span>
<a href="#l12.260"></a><span id="l12.260" class="difflineplus">+                cal.calGetString(&quot;calendar-event-dialog&quot;, &quot;counterOnPreviousVersionNotification&quot;),</span>
<a href="#l12.261"></a><span id="l12.261" class="difflineplus">+                &quot;warn&quot;</span>
<a href="#l12.262"></a><span id="l12.262" class="difflineplus">+            );</span>
<a href="#l12.263"></a><span id="l12.263" class="difflineplus">+        }</span>
<a href="#l12.264"></a><span id="l12.264" class="difflineplus">+        if (window.calendarItem.getProperty(&quot;X-MICROSOFT-DISALLOW-COUNTER&quot;) == &quot;TRUE&quot;) {</span>
<a href="#l12.265"></a><span id="l12.265" class="difflineplus">+            // this is a counterproposal although the user disallowed countering when sending the</span>
<a href="#l12.266"></a><span id="l12.266" class="difflineplus">+            // invitation, so we notify the user accordingly</span>
<a href="#l12.267"></a><span id="l12.267" class="difflineplus">+            notifyUser(</span>
<a href="#l12.268"></a><span id="l12.268" class="difflineplus">+                &quot;counterProposalOnCounteringDisallowed&quot;,</span>
<a href="#l12.269"></a><span id="l12.269" class="difflineplus">+                cal.calGetString(&quot;calendar-event-dialog&quot;, &quot;counterOnCounterDisallowedNotification&quot;),</span>
<a href="#l12.270"></a><span id="l12.270" class="difflineplus">+                &quot;warn&quot;</span>
<a href="#l12.271"></a><span id="l12.271" class="difflineplus">+            );</span>
<a href="#l12.272"></a><span id="l12.272" class="difflineplus">+        }</span>
<a href="#l12.273"></a><span id="l12.273" class="difflineplus">+    }</span>
<a href="#l12.274"></a><span id="l12.274" class="difflineplus">+}</span>
<a href="#l12.275"></a><span id="l12.275" class="difflineplus">+</span>
<a href="#l12.276"></a><span id="l12.276" class="difflineplus">+/**</span>
<a href="#l12.277"></a><span id="l12.277" class="difflineplus">+ * Get the property label to display for a counterproposal based on the respective label used in</span>
<a href="#l12.278"></a><span id="l12.278" class="difflineplus">+ * the dialog</span>
<a href="#l12.279"></a><span id="l12.279" class="difflineplus">+ *</span>
<a href="#l12.280"></a><span id="l12.280" class="difflineplus">+ * @param   {JSObject}     aProperty  The property to check for a label</span>
<a href="#l12.281"></a><span id="l12.281" class="difflineplus">+ * @returns {String|null}             The label to display or null if no such label</span>
<a href="#l12.282"></a><span id="l12.282" class="difflineplus">+ */</span>
<a href="#l12.283"></a><span id="l12.283" class="difflineplus">+function lookupCounterLabel(aProperty) {</span>
<a href="#l12.284"></a><span id="l12.284" class="difflineplus">+    let nodeIds = getPropertyMap();</span>
<a href="#l12.285"></a><span id="l12.285" class="difflineplus">+    let labels = nodeIds.has(aProperty.property) &amp;&amp;</span>
<a href="#l12.286"></a><span id="l12.286" class="difflineplus">+                document.getElementsByAttribute(&quot;control&quot;, nodeIds.get(aProperty.property));</span>
<a href="#l12.287"></a><span id="l12.287" class="difflineplus">+    let labelValue;</span>
<a href="#l12.288"></a><span id="l12.288" class="difflineplus">+    if (labels &amp;&amp; labels.length) {</span>
<a href="#l12.289"></a><span id="l12.289" class="difflineplus">+        // as label control assignment should be unique, we can just take the first result</span>
<a href="#l12.290"></a><span id="l12.290" class="difflineplus">+        labelValue = labels[0].value;</span>
<a href="#l12.291"></a><span id="l12.291" class="difflineplus">+    } else {</span>
<a href="#l12.292"></a><span id="l12.292" class="difflineplus">+        cal.LOG(&quot;Unsupported property &quot; + aProperty.property + &quot; detected when setting up counter &quot; +</span>
<a href="#l12.293"></a><span id="l12.293" class="difflineplus">+                &quot;box labels.&quot;);</span>
<a href="#l12.294"></a><span id="l12.294" class="difflineplus">+    }</span>
<a href="#l12.295"></a><span id="l12.295" class="difflineplus">+    return labelValue;</span>
<a href="#l12.296"></a><span id="l12.296" class="difflineplus">+}</span>
<a href="#l12.297"></a><span id="l12.297" class="difflineplus">+</span>
<a href="#l12.298"></a><span id="l12.298" class="difflineplus">+/**</span>
<a href="#l12.299"></a><span id="l12.299" class="difflineplus">+ * Get the property value to display for a counterproposal as currently supported</span>
<a href="#l12.300"></a><span id="l12.300" class="difflineplus">+ *</span>
<a href="#l12.301"></a><span id="l12.301" class="difflineplus">+ * @param   {JSObject}     aProperty  The property to check for a label</span>
<a href="#l12.302"></a><span id="l12.302" class="difflineplus">+ * @returns {String|null}             The value to display or null if the property is not supported</span>
<a href="#l12.303"></a><span id="l12.303" class="difflineplus">+ */</span>
<a href="#l12.304"></a><span id="l12.304" class="difflineplus">+function formatCounterValue(aProperty) {</span>
<a href="#l12.305"></a><span id="l12.305" class="difflineplus">+    const dateProps = [&quot;DTSTART&quot;, &quot;DTEND&quot;];</span>
<a href="#l12.306"></a><span id="l12.306" class="difflineplus">+    const stringProps = [&quot;SUMMARY&quot;, &quot;LOCATION&quot;];</span>
<a href="#l12.307"></a><span id="l12.307" class="difflineplus">+</span>
<a href="#l12.308"></a><span id="l12.308" class="difflineplus">+    let val;</span>
<a href="#l12.309"></a><span id="l12.309" class="difflineplus">+    if (dateProps.includes(aProperty.property)) {</span>
<a href="#l12.310"></a><span id="l12.310" class="difflineplus">+        let localTime = aProperty.proposed.getInTimezone(cal.calendarDefaultTimezone());</span>
<a href="#l12.311"></a><span id="l12.311" class="difflineplus">+        let formatter = getDateFormatter();</span>
<a href="#l12.312"></a><span id="l12.312" class="difflineplus">+        val = formatter.formatDateTime(localTime);</span>
<a href="#l12.313"></a><span id="l12.313" class="difflineplus">+        if (gTimezonesEnabled) {</span>
<a href="#l12.314"></a><span id="l12.314" class="difflineplus">+            let tzone = localTime.timezone.displayName || localTime.timezone.tzid;</span>
<a href="#l12.315"></a><span id="l12.315" class="difflineplus">+            val += &quot; &quot; + tzone;</span>
<a href="#l12.316"></a><span id="l12.316" class="difflineplus">+        }</span>
<a href="#l12.317"></a><span id="l12.317" class="difflineplus">+    } else if (stringProps.includes(aProperty.property)) {</span>
<a href="#l12.318"></a><span id="l12.318" class="difflineplus">+        val = aProperty.proposed;</span>
<a href="#l12.319"></a><span id="l12.319" class="difflineplus">+    } else {</span>
<a href="#l12.320"></a><span id="l12.320" class="difflineplus">+        cal.LOG(&quot;Unsupported property &quot; + aProperty.property +</span>
<a href="#l12.321"></a><span id="l12.321" class="difflineplus">+                &quot; detected when setting up counter box values.&quot;);</span>
<a href="#l12.322"></a><span id="l12.322" class="difflineplus">+    }</span>
<a href="#l12.323"></a><span id="l12.323" class="difflineplus">+    return val;</span>
<a href="#l12.324"></a><span id="l12.324" class="difflineplus">+}</span>
<a href="#l12.325"></a><span id="l12.325" class="difflineplus">+</span>
<a href="#l12.326"></a><span id="l12.326" class="difflineplus">+/**</span>
<a href="#l12.327"></a><span id="l12.327" class="difflineplus">+ * Get a map of porperty names and labels of currently supported properties</span>
<a href="#l12.328"></a><span id="l12.328" class="difflineplus">+ *</span>
<a href="#l12.329"></a><span id="l12.329" class="difflineplus">+ * @returns {Map}</span>
<a href="#l12.330"></a><span id="l12.330" class="difflineplus">+ */</span>
<a href="#l12.331"></a><span id="l12.331" class="difflineplus">+function getPropertyMap() {</span>
<a href="#l12.332"></a><span id="l12.332" class="difflineplus">+    let map = new Map();</span>
<a href="#l12.333"></a><span id="l12.333" class="difflineplus">+    map.set(&quot;SUMMARY&quot;, &quot;item-title&quot;);</span>
<a href="#l12.334"></a><span id="l12.334" class="difflineplus">+    map.set(&quot;LOCATION&quot;, &quot;item-location&quot;);</span>
<a href="#l12.335"></a><span id="l12.335" class="difflineplus">+    map.set(&quot;DTSTART&quot;, &quot;event-starttime&quot;);</span>
<a href="#l12.336"></a><span id="l12.336" class="difflineplus">+    map.set(&quot;DTEND&quot;, &quot;event-endtime&quot;);</span>
<a href="#l12.337"></a><span id="l12.337" class="difflineplus">+    return map;</span>
<a href="#l12.338"></a><span id="l12.338" class="difflineplus">+}</span>
<a href="#l12.339"></a><span id="l12.339" class="difflineplus">+</span>
<a href="#l12.340"></a><span id="l12.340" class="difflineplus">+/**</span>
<a href="#l12.341"></a><span id="l12.341" class="difflineplus">+ * Applies the proposal or original data to the respective dialog fields</span>
<a href="#l12.342"></a><span id="l12.342" class="difflineplus">+ *</span>
<a href="#l12.343"></a><span id="l12.343" class="difflineplus">+ * @param {String} aType Either 'proposed' or 'original'</span>
<a href="#l12.344"></a><span id="l12.344" class="difflineplus">+ */</span>
<a href="#l12.345"></a><span id="l12.345" class="difflineplus">+function applyValues(aType) {</span>
<a href="#l12.346"></a><span id="l12.346" class="difflineplus">+    if (!window.counterProposal || (aType != &quot;proposed&quot; &amp;&amp; aType != &quot;original&quot;)) {</span>
<a href="#l12.347"></a><span id="l12.347" class="difflineplus">+        return;</span>
<a href="#l12.348"></a><span id="l12.348" class="difflineplus">+    }</span>
<a href="#l12.349"></a><span id="l12.349" class="difflineplus">+    let originalBtn = document.getElementById(&quot;counter-original-btn&quot;);</span>
<a href="#l12.350"></a><span id="l12.350" class="difflineplus">+    if (originalBtn.disabled) {</span>
<a href="#l12.351"></a><span id="l12.351" class="difflineplus">+        // The button is disbled when opening the dialog/tab, which makes it more obvious to the</span>
<a href="#l12.352"></a><span id="l12.352" class="difflineplus">+        // user that he/she needs to apply the proposal values prior to saving &amp; sending.</span>
<a href="#l12.353"></a><span id="l12.353" class="difflineplus">+        // Once that happened, we leave both options to the user without toogling the button states</span>
<a href="#l12.354"></a><span id="l12.354" class="difflineplus">+        // to avoid needing to listen to manual changes to do that correctly</span>
<a href="#l12.355"></a><span id="l12.355" class="difflineplus">+        originalBtn.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l12.356"></a><span id="l12.356" class="difflineplus">+    }</span>
<a href="#l12.357"></a><span id="l12.357" class="difflineplus">+    let nodeIds = getPropertyMap();</span>
<a href="#l12.358"></a><span id="l12.358" class="difflineplus">+    window.counterProposal.proposal.forEach(aProperty =&gt; {</span>
<a href="#l12.359"></a><span id="l12.359" class="difflineplus">+        if (aProperty.property != &quot;COMMENT&quot;) {</span>
<a href="#l12.360"></a><span id="l12.360" class="difflineplus">+            let valueNode = nodeIds.has(aProperty.property) &amp;&amp;</span>
<a href="#l12.361"></a><span id="l12.361" class="difflineplus">+                            document.getElementById(nodeIds.get(aProperty.property));</span>
<a href="#l12.362"></a><span id="l12.362" class="difflineplus">+            if (valueNode) {</span>
<a href="#l12.363"></a><span id="l12.363" class="difflineplus">+                if ([&quot;DTSTART&quot;, &quot;DTEND&quot;].includes(aProperty.property)) {</span>
<a href="#l12.364"></a><span id="l12.364" class="difflineplus">+                    valueNode.value = cal.dateTimeToJsDate(aProperty[aType]);</span>
<a href="#l12.365"></a><span id="l12.365" class="difflineplus">+                } else {</span>
<a href="#l12.366"></a><span id="l12.366" class="difflineplus">+                    valueNode.value = aProperty[aType];</span>
<a href="#l12.367"></a><span id="l12.367" class="difflineplus">+                }</span>
<a href="#l12.368"></a><span id="l12.368" class="difflineplus">+            }</span>
<a href="#l12.369"></a><span id="l12.369" class="difflineplus">+        }</span>
<a href="#l12.370"></a><span id="l12.370" class="difflineplus">+    });</span>
<a href="#l12.371"></a><span id="l12.371" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/calendar/lightning/content/lightning-item-iframe.xul</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/calendar/lightning/content/lightning-item-iframe.xul</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -74,18 +74,71 @@</span>
<a href="#l13.4"></a><span id="l13.4">     &lt;command id=&quot;cmd_copyAttachment&quot;</span>
<a href="#l13.5"></a><span id="l13.5">              oncommand=&quot;copyAttachment()&quot;/&gt;</span>
<a href="#l13.6"></a><span id="l13.6">     &lt;command id=&quot;cmd_deleteAttachment&quot;</span>
<a href="#l13.7"></a><span id="l13.7">              disable-on-readonly=&quot;true&quot;</span>
<a href="#l13.8"></a><span id="l13.8">              oncommand=&quot;deleteAttachment()&quot;/&gt;</span>
<a href="#l13.9"></a><span id="l13.9">     &lt;command id=&quot;cmd_deleteAllAttachments&quot;</span>
<a href="#l13.10"></a><span id="l13.10">              disable-on-readonly=&quot;true&quot;</span>
<a href="#l13.11"></a><span id="l13.11">              oncommand=&quot;deleteAllAttachments()&quot;/&gt;</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+    &lt;command id=&quot;cmd_applyProposal&quot;</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+             disable-on-readonly=&quot;true&quot;</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+             oncommand=&quot;applyValues('proposed')&quot;/&gt;</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+    &lt;command id=&quot;cmd_applyOriginal&quot;</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineplus">+             disable-on-readonly=&quot;true&quot;</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineplus">+             oncommand=&quot;applyValues('original')&quot;/&gt;</span>
<a href="#l13.18"></a><span id="l13.18">   &lt;/commandset&gt;</span>
<a href="#l13.19"></a><span id="l13.19"> </span>
<a href="#l13.20"></a><span id="l13.20" class="difflineplus">+  &lt;!-- Counter information section --&gt;</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineplus">+  &lt;hbox id=&quot;counter-proposal-box&quot;</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineplus">+        collapsed=&quot;true&quot;&gt;</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineplus">+    &lt;vbox&gt;</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineplus">+      &lt;description id=&quot;counter-proposal-summary&quot;</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineplus">+                   collapsed=&quot;true&quot;</span>
<a href="#l13.26"></a><span id="l13.26" class="difflineplus">+                   crop=&quot;end&quot; /&gt;</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineplus">+      &lt;hbox id=&quot;counter-proposal&quot;&gt;</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineplus">+        &lt;vbox id=&quot;counter-proposal-property-labels&quot;&gt;</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineplus">+          &lt;label id=&quot;counter-proposal-property-label&quot;</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineplus">+                 control=&quot;counter-proposal-property-value&quot;</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineplus">+                 collapsed=&quot;true&quot;</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineplus">+                 value=&quot;&quot; /&gt;</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineplus">+        &lt;/vbox&gt;</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineplus">+        &lt;vbox id=&quot;counter-proposal-property-values&quot;&gt;</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineplus">+          &lt;description id=&quot;counter-proposal-property-value&quot;</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineplus">+                       crop=&quot;end&quot;</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineplus">+                       collapsed=&quot;true&quot;</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineplus">+                       value=&quot;&quot; /&gt;</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineplus">+        &lt;/vbox&gt;</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineplus">+      &lt;/hbox&gt;</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineplus">+      &lt;description id=&quot;counter-proposal-comment&quot;</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineplus">+                   collapsed=&quot;true&quot;</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineplus">+                   crop=&quot;end&quot; /&gt;</span>
<a href="#l13.44"></a><span id="l13.44" class="difflineplus">+    &lt;/vbox&gt;</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineplus">+    &lt;spacer flex=&quot;1&quot; /&gt;</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineplus">+    &lt;vbox id =&quot;counter-buttons&quot;&gt;</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineplus">+      &lt;button id=&quot;counter-proposal-btn&quot;</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineplus">+              label=&quot;&amp;counter.button.proposal.label;&quot;</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineplus">+              crop=&quot;end&quot;</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineplus">+              command=&quot;cmd_applyProposal&quot;</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineplus">+              orient=&quot;horizontal&quot;</span>
<a href="#l13.52"></a><span id="l13.52" class="difflineplus">+              class=&quot;counter-buttons&quot;</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineplus">+              accesskey=&quot;&amp;counter.button.proposal.accesskey;&quot;</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineplus">+              tooltip=&quot;&amp;counter.button.proposal.tooltip2;&quot; /&gt;</span>
<a href="#l13.55"></a><span id="l13.55" class="difflineplus">+      &lt;button id=&quot;counter-original-btn&quot;</span>
<a href="#l13.56"></a><span id="l13.56" class="difflineplus">+              label=&quot;&amp;counter.button.original.label;&quot;</span>
<a href="#l13.57"></a><span id="l13.57" class="difflineplus">+              crop=&quot;end&quot;</span>
<a href="#l13.58"></a><span id="l13.58" class="difflineplus">+              command=&quot;cmd_applyOriginal&quot;</span>
<a href="#l13.59"></a><span id="l13.59" class="difflineplus">+              orient=&quot;horizontal&quot;</span>
<a href="#l13.60"></a><span id="l13.60" class="difflineplus">+              disabled=&quot;true&quot;</span>
<a href="#l13.61"></a><span id="l13.61" class="difflineplus">+              class=&quot;counter-buttons&quot;</span>
<a href="#l13.62"></a><span id="l13.62" class="difflineplus">+              accesskey=&quot;&amp;counter.button.original.accesskey;&quot;</span>
<a href="#l13.63"></a><span id="l13.63" class="difflineplus">+              tooltip=&quot;&amp;counter.button.original.tooltip2;&quot; /&gt;</span>
<a href="#l13.64"></a><span id="l13.64" class="difflineplus">+    &lt;/vbox&gt;</span>
<a href="#l13.65"></a><span id="l13.65" class="difflineplus">+  &lt;/hbox&gt;</span>
<a href="#l13.66"></a><span id="l13.66" class="difflineplus">+</span>
<a href="#l13.67"></a><span id="l13.67">   &lt;notificationbox id=&quot;event-dialog-notifications&quot; notificationside=&quot;top&quot;/&gt;</span>
<a href="#l13.68"></a><span id="l13.68"> </span>
<a href="#l13.69"></a><span id="l13.69">   &lt;grid id=&quot;event-grid&quot;</span>
<a href="#l13.70"></a><span id="l13.70">         flex=&quot;1&quot;</span>
<a href="#l13.71"></a><span id="l13.71">         style=&quot;padding-top: 8px; padding-bottom: 10px; padding-inline-start: 8px; padding-inline-end: 10px;&quot;&gt;</span>
<a href="#l13.72"></a><span id="l13.72">     &lt;columns id=&quot;event-grid-columns&quot;&gt;</span>
<a href="#l13.73"></a><span id="l13.73">         &lt;column id=&quot;event-description-column&quot;/&gt;</span>
<a href="#l13.74"></a><span id="l13.74">         &lt;column id=&quot;event-controls-column&quot; flex=&quot;1&quot;/&gt;</span>
<a href="#l13.75"></a><span id="l13.75" class="difflineat">@@ -567,16 +620,21 @@</span>
<a href="#l13.76"></a><span id="l13.76">                           accesskey=&quot;&amp;event.attendees.notify.accesskey;&quot;</span>
<a href="#l13.77"></a><span id="l13.77">                           oncommand=&quot;changeUndiscloseCheckboxStatus();&quot;</span>
<a href="#l13.78"></a><span id="l13.78">                           pack=&quot;start&quot;/&gt;</span>
<a href="#l13.79"></a><span id="l13.79">                 &lt;checkbox id=&quot;undisclose-attendees-checkbox&quot;</span>
<a href="#l13.80"></a><span id="l13.80">                           label=&quot;&amp;event.attendees.notifyundisclosed.label;&quot;</span>
<a href="#l13.81"></a><span id="l13.81">                           accesskey=&quot;&amp;event.attendees.notifyundisclosed.accesskey;&quot;</span>
<a href="#l13.82"></a><span id="l13.82">                           tooltiptext=&quot;&amp;event.attendees.notifyundisclosed.tooltip;&quot;</span>
<a href="#l13.83"></a><span id="l13.83">                           pack=&quot;start&quot;/&gt;</span>
<a href="#l13.84"></a><span id="l13.84" class="difflineplus">+                &lt;checkbox id=&quot;disallow-counter-checkbox&quot;</span>
<a href="#l13.85"></a><span id="l13.85" class="difflineplus">+                          label=&quot;&amp;event.attendees.disallowcounter.label;&quot;</span>
<a href="#l13.86"></a><span id="l13.86" class="difflineplus">+                          accesskey=&quot;&amp;event.attendees.disallowcounter.accesskey;&quot;</span>
<a href="#l13.87"></a><span id="l13.87" class="difflineplus">+                          tooltiptext=&quot;&amp;event.attendees.disallowcounter.tooltip;&quot;</span>
<a href="#l13.88"></a><span id="l13.88" class="difflineplus">+                          pack=&quot;start&quot;/&gt;</span>
<a href="#l13.89"></a><span id="l13.89">               &lt;/hbox&gt;</span>
<a href="#l13.90"></a><span id="l13.90">             &lt;/vbox&gt;</span>
<a href="#l13.91"></a><span id="l13.91">           &lt;/tabpanel&gt;</span>
<a href="#l13.92"></a><span id="l13.92">         &lt;/tabpanels&gt;</span>
<a href="#l13.93"></a><span id="l13.93">       &lt;/tabbox&gt;</span>
<a href="#l13.94"></a><span id="l13.94"> </span>
<a href="#l13.95"></a><span id="l13.95">       &lt;separator id=&quot;event-grid-link-separator&quot;</span>
<a href="#l13.96"></a><span id="l13.96">                  class=&quot;groove&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/calendar/lightning/modules/ltnInvitationUtils.jsm</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/calendar/lightning/modules/ltnInvitationUtils.jsm</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -32,34 +32,44 @@ ltn.invitation = {</span>
<a href="#l14.4"></a><span id="l14.4">                                            &quot;itipRequestBody&quot;,</span>
<a href="#l14.5"></a><span id="l14.5">                                            [organizerString, summary]);</span>
<a href="#l14.6"></a><span id="l14.6">                     break;</span>
<a href="#l14.7"></a><span id="l14.7">                 case &quot;CANCEL&quot;:</span>
<a href="#l14.8"></a><span id="l14.8">                     header = ltn.getString(&quot;lightning&quot;,</span>
<a href="#l14.9"></a><span id="l14.9">                                            &quot;itipCancelBody&quot;,</span>
<a href="#l14.10"></a><span id="l14.10">                                            [organizerString, summary]);</span>
<a href="#l14.11"></a><span id="l14.11">                     break;</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-                case &quot;REPLY&quot;: {</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineminus">-                    // This is a reply received from someone else, there should</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineminus">-                    // be just one attendee, the attendee that replied. If</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineminus">-                    // there is more than one attendee, just take the first so</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineminus">-                    // code doesn't break here.</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineplus">+                case &quot;COUNTER&quot;:</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineplus">+                    // falls through</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineplus">+                case &quot;REPLY&quot;:</span>
<a href="#l14.20"></a><span id="l14.20">                     let attendees = item.getAttendees({});</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineminus">-                    if (attendees &amp;&amp; attendees.length &gt;= 1) {</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineminus">-                        let sender = attendees[0];</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineminus">-                        let statusString = sender.participationStatus == &quot;DECLINED&quot;</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineminus">-                                               ? &quot;itipReplyBodyDecline&quot;</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineminus">-                                               : &quot;itipReplyBodyAccept&quot;;</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineminus">-</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineminus">-                        header = ltn.getString(&quot;lightning&quot;, statusString, [sender.toString()]);</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineplus">+                    let sender = cal.getAttendeesBySender(attendees, aItipItem.sender);</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineplus">+                    if (sender.length == 1) {</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineplus">+                        if (aItipItem.responseMethod == &quot;COUNTER&quot;) {</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineplus">+                            header = cal.calGetString(&quot;lightning&quot;,</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineplus">+                                                      &quot;itipCounterBody&quot;,</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineplus">+                                                      [sender[0].toString(), summary],</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineplus">+                                                      &quot;lightning&quot;);</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineplus">+                        } else {</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineplus">+                            let statusString = (sender[0].participationStatus == &quot;DECLINED&quot; ?</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineplus">+                                                &quot;itipReplyBodyDecline&quot; : &quot;itipReplyBodyAccept&quot;);</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineplus">+                            header = cal.calGetString(&quot;lightning&quot;,</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineplus">+                                                      statusString,</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineplus">+                                                      [sender[0].toString()],</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineplus">+                                                      &quot;lightning&quot;);</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineplus">+                        }</span>
<a href="#l14.43"></a><span id="l14.43">                     } else {</span>
<a href="#l14.44"></a><span id="l14.44">                         header = &quot;&quot;;</span>
<a href="#l14.45"></a><span id="l14.45">                     }</span>
<a href="#l14.46"></a><span id="l14.46">                     break;</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineminus">-                }</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineplus">+                case &quot;DECLINECOUNTER&quot;:</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineplus">+                    header = ltn.getString(&quot;lightning&quot;,</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineplus">+                                           &quot;itipDeclineCounterBody&quot;,</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineplus">+                                           [organizerString, summary]);</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineplus">+                    break;</span>
<a href="#l14.53"></a><span id="l14.53">             }</span>
<a href="#l14.54"></a><span id="l14.54">         }</span>
<a href="#l14.55"></a><span id="l14.55"> </span>
<a href="#l14.56"></a><span id="l14.56">         if (!header) {</span>
<a href="#l14.57"></a><span id="l14.57">             header = ltn.getString(&quot;lightning&quot;, &quot;imipHtml.header&quot;, null);</span>
<a href="#l14.58"></a><span id="l14.58">         }</span>
<a href="#l14.59"></a><span id="l14.59"> </span>
<a href="#l14.60"></a><span id="l14.60">         return header;</span>
<a href="#l14.61"></a><span id="l14.61" class="difflineat">@@ -499,10 +509,80 @@ ltn.invitation = {</span>
<a href="#l14.62"></a><span id="l14.62">         return MailServices.mimeConverter</span>
<a href="#l14.63"></a><span id="l14.63">                            .encodeMimePartIIStr_UTF8(aHeader,</span>
<a href="#l14.64"></a><span id="l14.64">                                                      aIsEmail,</span>
<a href="#l14.65"></a><span id="l14.65">                                                      &quot;UTF-8&quot;,</span>
<a href="#l14.66"></a><span id="l14.66">                                                      fieldNameLen,</span>
<a href="#l14.67"></a><span id="l14.67">                                                      Components.interfaces</span>
<a href="#l14.68"></a><span id="l14.68">                                                                .nsIMimeConverter</span>
<a href="#l14.69"></a><span id="l14.69">                                                                .MIME_ENCODED_WORD_SIZE);</span>
<a href="#l14.70"></a><span id="l14.70" class="difflineplus">+    },</span>
<a href="#l14.71"></a><span id="l14.71" class="difflineplus">+</span>
<a href="#l14.72"></a><span id="l14.72" class="difflineplus">+    /**</span>
<a href="#l14.73"></a><span id="l14.73" class="difflineplus">+     * Parses a counterproposal to extract differences to the existing event</span>
<a href="#l14.74"></a><span id="l14.74" class="difflineplus">+     * @param  {calIEvent|calITodo} aProposedItem  The counterproposal</span>
<a href="#l14.75"></a><span id="l14.75" class="difflineplus">+     * @param  {calIEvent|calITodo} aExistingItem  The item to compare with</span>
<a href="#l14.76"></a><span id="l14.76" class="difflineplus">+     * @return {JSObject}                          Objcet of result and differences of parsing</span>
<a href="#l14.77"></a><span id="l14.77" class="difflineplus">+     * @return {String} JsObject.result.type       Parsing result: OK|OLDVERSION|ERROR|NODIFF</span>
<a href="#l14.78"></a><span id="l14.78" class="difflineplus">+     * @return {String} JsObject.result.descr      Parsing result description</span>
<a href="#l14.79"></a><span id="l14.79" class="difflineplus">+     * @return {Array}  JsObject.differences       Array of objects consisting of property, proposed</span>
<a href="#l14.80"></a><span id="l14.80" class="difflineplus">+     *                                                 and original properties.</span>
<a href="#l14.81"></a><span id="l14.81" class="difflineplus">+     * @return {String} JsObject.comment           A comment of the attendee, if any</span>
<a href="#l14.82"></a><span id="l14.82" class="difflineplus">+     */</span>
<a href="#l14.83"></a><span id="l14.83" class="difflineplus">+    parseCounter: function(aProposedItem, aExistingItem) {</span>
<a href="#l14.84"></a><span id="l14.84" class="difflineplus">+        let isEvent = cal.isEvent(aProposedItem);</span>
<a href="#l14.85"></a><span id="l14.85" class="difflineplus">+        // atm we only support a subset of properties, for a full list see RfC 5546 section 3.2.7</span>
<a href="#l14.86"></a><span id="l14.86" class="difflineplus">+        let properties = [&quot;SUMMARY&quot;, &quot;LOCATION&quot;, &quot;DTSTART&quot;, &quot;DTEND&quot;, &quot;COMMENT&quot;];</span>
<a href="#l14.87"></a><span id="l14.87" class="difflineplus">+        if (!isEvent) {</span>
<a href="#l14.88"></a><span id="l14.88" class="difflineplus">+            cal.LOG(&quot;Parsing of counterproposals is currently only supported for events.&quot;);</span>
<a href="#l14.89"></a><span id="l14.89" class="difflineplus">+            properties = [];</span>
<a href="#l14.90"></a><span id="l14.90" class="difflineplus">+        }</span>
<a href="#l14.91"></a><span id="l14.91" class="difflineplus">+</span>
<a href="#l14.92"></a><span id="l14.92" class="difflineplus">+        let diff = [];</span>
<a href="#l14.93"></a><span id="l14.93" class="difflineplus">+        let status = { descr: &quot;&quot;, type: &quot;OK&quot; };</span>
<a href="#l14.94"></a><span id="l14.94" class="difflineplus">+        // As required in https://tools.ietf.org/html/rfc5546#section-3.2.7 a valid counterproposal</span>
<a href="#l14.95"></a><span id="l14.95" class="difflineplus">+        // is referring to as existing UID and must include the same sequence number and organizer as</span>
<a href="#l14.96"></a><span id="l14.96" class="difflineplus">+        // the original request being countered</span>
<a href="#l14.97"></a><span id="l14.97" class="difflineplus">+        if (aProposedItem.id == aExistingItem.id &amp;&amp;</span>
<a href="#l14.98"></a><span id="l14.98" class="difflineplus">+            aProposedItem.organizer &amp;&amp; aExistingItem.organizer &amp;&amp;</span>
<a href="#l14.99"></a><span id="l14.99" class="difflineplus">+            aProposedItem.organizer.id == aExistingItem.organizer.id) {</span>
<a href="#l14.100"></a><span id="l14.100" class="difflineplus">+            let proposedSequence = aProposedItem.getProperty(&quot;SEQUENCE&quot;) || 0;</span>
<a href="#l14.101"></a><span id="l14.101" class="difflineplus">+            let existingSequence = aExistingItem.getProperty(&quot;SEQUENCE&quot;) || 0;</span>
<a href="#l14.102"></a><span id="l14.102" class="difflineplus">+            if (existingSequence &gt;= proposedSequence) {</span>
<a href="#l14.103"></a><span id="l14.103" class="difflineplus">+                if (existingSequence &gt; proposedSequence) {</span>
<a href="#l14.104"></a><span id="l14.104" class="difflineplus">+                    // in this case we prompt the organizer with the additional information that the</span>
<a href="#l14.105"></a><span id="l14.105" class="difflineplus">+                    // received proposal refers to an outdated version of the event</span>
<a href="#l14.106"></a><span id="l14.106" class="difflineplus">+                    status.descr = &quot;This is a counterproposal to an already rescheduled event.&quot;;</span>
<a href="#l14.107"></a><span id="l14.107" class="difflineplus">+                    status.type = &quot;OUTDATED&quot;;</span>
<a href="#l14.108"></a><span id="l14.108" class="difflineplus">+                } else if (aProposedItem.stampTime.compare(aExistingItem.stampTime) == -1) {</span>
<a href="#l14.109"></a><span id="l14.109" class="difflineplus">+                    // now this is the same sequence but the proposal is not based on the latest</span>
<a href="#l14.110"></a><span id="l14.110" class="difflineplus">+                    // update of the event - updated events may have minor changes, while for major</span>
<a href="#l14.111"></a><span id="l14.111" class="difflineplus">+                    // ones there has been a rescheduling</span>
<a href="#l14.112"></a><span id="l14.112" class="difflineplus">+                    status.descr = &quot;This is a counterproposal not based on the latest event update.&quot;;</span>
<a href="#l14.113"></a><span id="l14.113" class="difflineplus">+                    status.type = &quot;NOTLATESTUPDATE&quot;;</span>
<a href="#l14.114"></a><span id="l14.114" class="difflineplus">+                }</span>
<a href="#l14.115"></a><span id="l14.115" class="difflineplus">+                for (let prop of properties) {</span>
<a href="#l14.116"></a><span id="l14.116" class="difflineplus">+                    let newValue = aProposedItem.getProperty(prop) || null;</span>
<a href="#l14.117"></a><span id="l14.117" class="difflineplus">+                    let oldValue = aExistingItem.getProperty(prop) || null;</span>
<a href="#l14.118"></a><span id="l14.118" class="difflineplus">+                    if (([&quot;DTSTART&quot;, &quot;DTEND&quot;].includes(prop) &amp;&amp; newValue.toString() != oldValue.toString()) ||</span>
<a href="#l14.119"></a><span id="l14.119" class="difflineplus">+                        (![&quot;DTSTART&quot;, &quot;DTEND&quot;].includes(prop) &amp;&amp; newValue != oldValue)) {</span>
<a href="#l14.120"></a><span id="l14.120" class="difflineplus">+                        diff.push({</span>
<a href="#l14.121"></a><span id="l14.121" class="difflineplus">+                            property: prop,</span>
<a href="#l14.122"></a><span id="l14.122" class="difflineplus">+                            proposed: newValue,</span>
<a href="#l14.123"></a><span id="l14.123" class="difflineplus">+                            original: oldValue</span>
<a href="#l14.124"></a><span id="l14.124" class="difflineplus">+                        });</span>
<a href="#l14.125"></a><span id="l14.125" class="difflineplus">+                    }</span>
<a href="#l14.126"></a><span id="l14.126" class="difflineplus">+                }</span>
<a href="#l14.127"></a><span id="l14.127" class="difflineplus">+            } else {</span>
<a href="#l14.128"></a><span id="l14.128" class="difflineplus">+                status.descr = &quot;Invalid sequence number in counterproposal.&quot;;</span>
<a href="#l14.129"></a><span id="l14.129" class="difflineplus">+                status.type = &quot;ERROR&quot;;</span>
<a href="#l14.130"></a><span id="l14.130" class="difflineplus">+            }</span>
<a href="#l14.131"></a><span id="l14.131" class="difflineplus">+        } else {</span>
<a href="#l14.132"></a><span id="l14.132" class="difflineplus">+            status.descr = &quot;Mismatch of uid or organizer in counterproposal.&quot;;</span>
<a href="#l14.133"></a><span id="l14.133" class="difflineplus">+            status.type = &quot;ERROR&quot;;</span>
<a href="#l14.134"></a><span id="l14.134" class="difflineplus">+        }</span>
<a href="#l14.135"></a><span id="l14.135" class="difflineplus">+        if (status.type != &quot;ERROR&quot; &amp;&amp; !diff.length) {</span>
<a href="#l14.136"></a><span id="l14.136" class="difflineplus">+            status.descr = &quot;No difference in counterproposal detected.&quot;;</span>
<a href="#l14.137"></a><span id="l14.137" class="difflineplus">+            status.type = &quot;NODIFF&quot;;</span>
<a href="#l14.138"></a><span id="l14.138" class="difflineplus">+        }</span>
<a href="#l14.139"></a><span id="l14.139" class="difflineplus">+        return { result: status, differences: diff };</span>
<a href="#l14.140"></a><span id="l14.140">     }</span>
<a href="#l14.141"></a><span id="l14.141"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/calendar/lightning/themes/linux/lightning.css</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/calendar/lightning/themes/linux/lightning.css</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -185,16 +185,17 @@ radio[pane=paneLightning] {</span>
<a href="#l15.4"></a><span id="l15.4"> }</span>
<a href="#l15.5"></a><span id="l15.5"> </span>
<a href="#l15.6"></a><span id="l15.6"> /* ::: imip button icons ::: */</span>
<a href="#l15.7"></a><span id="l15.7"> .imipAcceptRecurrencesButton,</span>
<a href="#l15.8"></a><span id="l15.8"> .imipAcceptButton {</span>
<a href="#l15.9"></a><span id="l15.9">   list-style-image: url(chrome://calendar-common/skin/calendar-toolbar.svg#complete);</span>
<a href="#l15.10"></a><span id="l15.10"> }</span>
<a href="#l15.11"></a><span id="l15.11"> </span>
<a href="#l15.12"></a><span id="l15.12" class="difflineplus">+.imipDeclineCounterButton,</span>
<a href="#l15.13"></a><span id="l15.13"> .imipDeclineRecurrencesButton,</span>
<a href="#l15.14"></a><span id="l15.14"> .imipDeclineButton {</span>
<a href="#l15.15"></a><span id="l15.15">   list-style-image: url(chrome://calendar-common/skin/calendar-toolbar.svg#decline);</span>
<a href="#l15.16"></a><span id="l15.16"> }</span>
<a href="#l15.17"></a><span id="l15.17"> </span>
<a href="#l15.18"></a><span id="l15.18"> .imipTentativeRecurrencesButton,</span>
<a href="#l15.19"></a><span id="l15.19"> .imipTentativeButton {</span>
<a href="#l15.20"></a><span id="l15.20">   list-style-image: url(chrome://calendar-common/skin/calendar-toolbar.svg#tentative);</span>
<a href="#l15.21"></a><span id="l15.21" class="difflineat">@@ -203,16 +204,17 @@ radio[pane=paneLightning] {</span>
<a href="#l15.22"></a><span id="l15.22"> .imipDetailsButton {</span>
<a href="#l15.23"></a><span id="l15.23">   list-style-image: url(chrome://calendar-common/skin/calendar-toolbar.svg#find);</span>
<a href="#l15.24"></a><span id="l15.24"> }</span>
<a href="#l15.25"></a><span id="l15.25"> </span>
<a href="#l15.26"></a><span id="l15.26"> .imipAddButton {</span>
<a href="#l15.27"></a><span id="l15.27">   list-style-image: url(chrome://calendar-common/skin/calendar-toolbar.svg#newevent);</span>
<a href="#l15.28"></a><span id="l15.28"> }</span>
<a href="#l15.29"></a><span id="l15.29"> </span>
<a href="#l15.30"></a><span id="l15.30" class="difflineplus">+.imipRescheduleButton,</span>
<a href="#l15.31"></a><span id="l15.31"> .imipUpdateButton {</span>
<a href="#l15.32"></a><span id="l15.32">   list-style-image: url(chrome://calendar-common/skin/calendar-toolbar.svg#synchronize);</span>
<a href="#l15.33"></a><span id="l15.33"> }</span>
<a href="#l15.34"></a><span id="l15.34"> </span>
<a href="#l15.35"></a><span id="l15.35"> .imipDeleteButton {</span>
<a href="#l15.36"></a><span id="l15.36">   list-style-image: url(chrome://calendar-common/skin/calendar-toolbar.svg#delete);</span>
<a href="#l15.37"></a><span id="l15.37"> }</span>
<a href="#l15.38"></a><span id="l15.38"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/calendar/lightning/themes/osx/lightning.css</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/calendar/lightning/themes/osx/lightning.css</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -261,16 +261,17 @@ toolbar[bighttext] #task-tab-button {</span>
<a href="#l16.4"></a><span id="l16.4"> </span>
<a href="#l16.5"></a><span id="l16.5"> /* ::: imip button icons ::: */</span>
<a href="#l16.6"></a><span id="l16.6"> @media not all and (-moz-mac-yosemite-theme) {</span>
<a href="#l16.7"></a><span id="l16.7">   .imipAcceptRecurrencesButton,</span>
<a href="#l16.8"></a><span id="l16.8">   .imipAcceptButton {</span>
<a href="#l16.9"></a><span id="l16.9">     list-style-image: url(chrome://calendar-common/skin/calendar-toolbar-osxlion.svg#complete);</span>
<a href="#l16.10"></a><span id="l16.10">   }</span>
<a href="#l16.11"></a><span id="l16.11"> </span>
<a href="#l16.12"></a><span id="l16.12" class="difflineplus">+  .imipDeclineCounterButton,</span>
<a href="#l16.13"></a><span id="l16.13">   .imipDeclineRecurrencesButton,</span>
<a href="#l16.14"></a><span id="l16.14">   .imipDeclineButton {</span>
<a href="#l16.15"></a><span id="l16.15">     list-style-image: url(chrome://calendar-common/skin/calendar-toolbar-osxlion.svg#decline);</span>
<a href="#l16.16"></a><span id="l16.16">   }</span>
<a href="#l16.17"></a><span id="l16.17"> </span>
<a href="#l16.18"></a><span id="l16.18">   .imipTentativeRecurrencesButton,</span>
<a href="#l16.19"></a><span id="l16.19">   .imipTentativeButton {</span>
<a href="#l16.20"></a><span id="l16.20">     list-style-image: url(chrome://calendar-common/skin/calendar-toolbar-osxlion.svg#tentative);</span>
<a href="#l16.21"></a><span id="l16.21" class="difflineat">@@ -279,16 +280,17 @@ toolbar[bighttext] #task-tab-button {</span>
<a href="#l16.22"></a><span id="l16.22">   .imipDetailsButton {</span>
<a href="#l16.23"></a><span id="l16.23">     list-style-image: url(chrome://calendar-common/skin/calendar-toolbar-osxlion.svg#find);</span>
<a href="#l16.24"></a><span id="l16.24">   }</span>
<a href="#l16.25"></a><span id="l16.25"> </span>
<a href="#l16.26"></a><span id="l16.26">   .imipAddButton {</span>
<a href="#l16.27"></a><span id="l16.27">     list-style-image: url(chrome://calendar-common/skin/calendar-toolbar-osxlion.svg#newevent);</span>
<a href="#l16.28"></a><span id="l16.28">   }</span>
<a href="#l16.29"></a><span id="l16.29"> </span>
<a href="#l16.30"></a><span id="l16.30" class="difflineplus">+  .imipRescheduleButton,</span>
<a href="#l16.31"></a><span id="l16.31">   .imipUpdateButton {</span>
<a href="#l16.32"></a><span id="l16.32">     list-style-image: url(chrome://calendar-common/skin/calendar-toolbar-osxlion.svg#synchronize);</span>
<a href="#l16.33"></a><span id="l16.33">   }</span>
<a href="#l16.34"></a><span id="l16.34"> </span>
<a href="#l16.35"></a><span id="l16.35">   .imipDeleteButton {</span>
<a href="#l16.36"></a><span id="l16.36">     list-style-image: url(chrome://calendar-common/skin/calendar-toolbar-osxlion.svg#delete);</span>
<a href="#l16.37"></a><span id="l16.37">   }</span>
<a href="#l16.38"></a><span id="l16.38"> </span>
<a href="#l16.39"></a><span id="l16.39" class="difflineat">@@ -298,16 +300,17 @@ toolbar[bighttext] #task-tab-button {</span>
<a href="#l16.40"></a><span id="l16.40"> }</span>
<a href="#l16.41"></a><span id="l16.41"> </span>
<a href="#l16.42"></a><span id="l16.42"> @media (-moz-mac-yosemite-theme) {</span>
<a href="#l16.43"></a><span id="l16.43">   .imipAcceptRecurrencesButton,</span>
<a href="#l16.44"></a><span id="l16.44">   .imipAcceptButton {</span>
<a href="#l16.45"></a><span id="l16.45">     list-style-image: url(chrome://calendar-common/skin/calendar-toolbar.svg#complete-flat);</span>
<a href="#l16.46"></a><span id="l16.46">   }</span>
<a href="#l16.47"></a><span id="l16.47"> </span>
<a href="#l16.48"></a><span id="l16.48" class="difflineplus">+  .imipDeclineCounterButton,</span>
<a href="#l16.49"></a><span id="l16.49">   .imipDeclineRecurrencesButton,</span>
<a href="#l16.50"></a><span id="l16.50">   .imipDeclineButton {</span>
<a href="#l16.51"></a><span id="l16.51">     list-style-image: url(chrome://calendar-common/skin/calendar-toolbar.svg#decline-flat);</span>
<a href="#l16.52"></a><span id="l16.52">   }</span>
<a href="#l16.53"></a><span id="l16.53"> </span>
<a href="#l16.54"></a><span id="l16.54">   .imipTentativeRecurrencesButton,</span>
<a href="#l16.55"></a><span id="l16.55">   .imipTentativeButton {</span>
<a href="#l16.56"></a><span id="l16.56">     list-style-image: url(chrome://calendar-common/skin/calendar-toolbar.svg#tentative-flat);</span>
<a href="#l16.57"></a><span id="l16.57" class="difflineat">@@ -316,16 +319,17 @@ toolbar[bighttext] #task-tab-button {</span>
<a href="#l16.58"></a><span id="l16.58">   .imipDetailsButton {</span>
<a href="#l16.59"></a><span id="l16.59">     list-style-image: url(chrome://calendar-common/skin/calendar-toolbar.svg#find-flat);</span>
<a href="#l16.60"></a><span id="l16.60">   }</span>
<a href="#l16.61"></a><span id="l16.61"> </span>
<a href="#l16.62"></a><span id="l16.62">   .imipAddButton {</span>
<a href="#l16.63"></a><span id="l16.63">     list-style-image: url(chrome://calendar-common/skin/calendar-toolbar.svg#newevent-flat);</span>
<a href="#l16.64"></a><span id="l16.64">   }</span>
<a href="#l16.65"></a><span id="l16.65"> </span>
<a href="#l16.66"></a><span id="l16.66" class="difflineplus">+  .imipRescheduleButton,</span>
<a href="#l16.67"></a><span id="l16.67">   .imipUpdateButton {</span>
<a href="#l16.68"></a><span id="l16.68">     list-style-image: url(chrome://calendar-common/skin/calendar-toolbar.svg#synchronize-flat);</span>
<a href="#l16.69"></a><span id="l16.69">   }</span>
<a href="#l16.70"></a><span id="l16.70"> </span>
<a href="#l16.71"></a><span id="l16.71">   .imipDeleteButton {</span>
<a href="#l16.72"></a><span id="l16.72">     list-style-image: url(chrome://calendar-common/skin/calendar-toolbar.svg#delete);</span>
<a href="#l16.73"></a><span id="l16.73">   }</span>
<a href="#l16.74"></a><span id="l16.74"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/calendar/lightning/themes/windows/lightning.css</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/calendar/lightning/themes/windows/lightning.css</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -239,30 +239,32 @@ radio[pane=paneLightning] {</span>
<a href="#l17.4"></a><span id="l17.4">   }</span>
<a href="#l17.5"></a><span id="l17.5"> </span>
<a href="#l17.6"></a><span id="l17.6">   /* ::: imip button icons ::: */</span>
<a href="#l17.7"></a><span id="l17.7">   .imipAcceptButton,</span>
<a href="#l17.8"></a><span id="l17.8">   .imipAcceptRecurrencesButton {</span>
<a href="#l17.9"></a><span id="l17.9">     list-style-image: url(chrome://calendar-common/skin/calendar-toolbar.svg#complete);</span>
<a href="#l17.10"></a><span id="l17.10">   }</span>
<a href="#l17.11"></a><span id="l17.11"> </span>
<a href="#l17.12"></a><span id="l17.12" class="difflineplus">+  .imipDeclineCounterButton,</span>
<a href="#l17.13"></a><span id="l17.13">   .imipDeclineButton,</span>
<a href="#l17.14"></a><span id="l17.14">   .imipDeclineRecurrencesButton {</span>
<a href="#l17.15"></a><span id="l17.15">     list-style-image: url(chrome://calendar-common/skin/calendar-toolbar.svg#decline);</span>
<a href="#l17.16"></a><span id="l17.16">   }</span>
<a href="#l17.17"></a><span id="l17.17"> </span>
<a href="#l17.18"></a><span id="l17.18">   .imipTentativeButton,</span>
<a href="#l17.19"></a><span id="l17.19">   .imipTentativeRecurrencesButton {</span>
<a href="#l17.20"></a><span id="l17.20">     list-style-image: url(chrome://calendar-common/skin/calendar-toolbar.svg#tentative);</span>
<a href="#l17.21"></a><span id="l17.21">   }</span>
<a href="#l17.22"></a><span id="l17.22"> </span>
<a href="#l17.23"></a><span id="l17.23">   .imipAddButton {</span>
<a href="#l17.24"></a><span id="l17.24">     list-style-image: url(chrome://calendar-common/skin/calendar-toolbar.svg#newevent);</span>
<a href="#l17.25"></a><span id="l17.25">   }</span>
<a href="#l17.26"></a><span id="l17.26"> </span>
<a href="#l17.27"></a><span id="l17.27" class="difflineplus">+  .imipRescheduleButton,</span>
<a href="#l17.28"></a><span id="l17.28">   .imipUpdateButton {</span>
<a href="#l17.29"></a><span id="l17.29">     list-style-image: url(chrome://calendar-common/skin/calendar-toolbar.svg#synchronize);</span>
<a href="#l17.30"></a><span id="l17.30">   }</span>
<a href="#l17.31"></a><span id="l17.31"> </span>
<a href="#l17.32"></a><span id="l17.32">   .imipDetailsButton {</span>
<a href="#l17.33"></a><span id="l17.33">     list-style-image: url(chrome://calendar-common/skin/calendar-toolbar.svg#find);</span>
<a href="#l17.34"></a><span id="l17.34">   }</span>
<a href="#l17.35"></a><span id="l17.35"> </span>
<a href="#l17.36"></a><span id="l17.36" class="difflineat">@@ -356,30 +358,32 @@ radio[pane=paneLightning] {</span>
<a href="#l17.37"></a><span id="l17.37">   }</span>
<a href="#l17.38"></a><span id="l17.38"> </span>
<a href="#l17.39"></a><span id="l17.39">   /* ::: imip button icons ::: */</span>
<a href="#l17.40"></a><span id="l17.40">   .imipAcceptButton,</span>
<a href="#l17.41"></a><span id="l17.41">   .imipAcceptRecurrencesButton {</span>
<a href="#l17.42"></a><span id="l17.42">     list-style-image: url(chrome://calendar-common/skin/calendar-toolbar.svg#complete-flat);</span>
<a href="#l17.43"></a><span id="l17.43">   }</span>
<a href="#l17.44"></a><span id="l17.44"> </span>
<a href="#l17.45"></a><span id="l17.45" class="difflineplus">+  .imipDeclineCounterButton,</span>
<a href="#l17.46"></a><span id="l17.46">   .imipDeclineButton,</span>
<a href="#l17.47"></a><span id="l17.47">   .imipDeclineRecurrencesButton {</span>
<a href="#l17.48"></a><span id="l17.48">     list-style-image: url(chrome://calendar-common/skin/calendar-toolbar.svg#decline-flat);</span>
<a href="#l17.49"></a><span id="l17.49">   }</span>
<a href="#l17.50"></a><span id="l17.50"> </span>
<a href="#l17.51"></a><span id="l17.51">   .imipTentativeButton,</span>
<a href="#l17.52"></a><span id="l17.52">   .imipTentativeRecurrencesButton {</span>
<a href="#l17.53"></a><span id="l17.53">     list-style-image: url(chrome://calendar-common/skin/calendar-toolbar.svg#tentative-flat);</span>
<a href="#l17.54"></a><span id="l17.54">   }</span>
<a href="#l17.55"></a><span id="l17.55"> </span>
<a href="#l17.56"></a><span id="l17.56">   .imipAddButton {</span>
<a href="#l17.57"></a><span id="l17.57">     list-style-image: url(chrome://calendar-common/skin/calendar-toolbar.svg#newevent-flat);</span>
<a href="#l17.58"></a><span id="l17.58">   }</span>
<a href="#l17.59"></a><span id="l17.59"> </span>
<a href="#l17.60"></a><span id="l17.60" class="difflineplus">+  .imipRescheduleButton,</span>
<a href="#l17.61"></a><span id="l17.61">   .imipUpdateButton {</span>
<a href="#l17.62"></a><span id="l17.62">     list-style-image: url(chrome://calendar-common/skin/calendar-toolbar.svg#synchronize-flat);</span>
<a href="#l17.63"></a><span id="l17.63">   }</span>
<a href="#l17.64"></a><span id="l17.64"> </span>
<a href="#l17.65"></a><span id="l17.65">   .imipDetailsButton {</span>
<a href="#l17.66"></a><span id="l17.66">     list-style-image: url(chrome://calendar-common/skin/calendar-toolbar.svg#find-flat);</span>
<a href="#l17.67"></a><span id="l17.67">   }</span>
<a href="#l17.68"></a><span id="l17.68"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/calendar/locales/en-US/chrome/calendar/calendar-event-dialog.dtd</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/calendar/locales/en-US/chrome/calendar/calendar-event-dialog.dtd</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -35,17 +35,17 @@</span>
<a href="#l18.4"></a><span id="l18.4">    - they still fit in. --&gt;</span>
<a href="#l18.5"></a><span id="l18.5"> &lt;!ENTITY event.attendees.notify.label                &quot;Notify attendees&quot;&gt;</span>
<a href="#l18.6"></a><span id="l18.6"> &lt;!ENTITY event.attendees.notify.accesskey            &quot;f&quot;&gt;</span>
<a href="#l18.7"></a><span id="l18.7"> &lt;!ENTITY event.attendees.notifyundisclosed.label     &quot;Separate invitation per attendee&quot;&gt;</span>
<a href="#l18.8"></a><span id="l18.8"> &lt;!ENTITY event.attendees.notifyundisclosed.accesskey &quot;x&quot;&gt;</span>
<a href="#l18.9"></a><span id="l18.9"> &lt;!ENTITY event.attendees.notifyundisclosed.tooltip   &quot;This option sends one invitation email per attendee. Each invitation only contains the recipient attendee so that other attendee identities are not disclosed.&quot;&gt;</span>
<a href="#l18.10"></a><span id="l18.10"> &lt;!ENTITY event.attendees.disallowcounter.label       &quot;Disallow counter&quot;&gt;</span>
<a href="#l18.11"></a><span id="l18.11"> &lt;!ENTITY event.attendees.disallowcounter.accesskey   &quot;a&quot;&gt;</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-&lt;!ENTITY event.attendees.disallowcounter.tooltip     &quot;Indicates that you will not accept counter proposals&quot;&gt;</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+&lt;!ENTITY event.attendees.disallowcounter.tooltip     &quot;Indicates that you will not accept counterproposals&quot;&gt;</span>
<a href="#l18.14"></a><span id="l18.14"> </span>
<a href="#l18.15"></a><span id="l18.15"> &lt;!-- Keyboard Shortcuts --&gt;</span>
<a href="#l18.16"></a><span id="l18.16"> &lt;!ENTITY event.dialog.new.event.key2              &quot;I&quot;&gt;</span>
<a href="#l18.17"></a><span id="l18.17"> &lt;!ENTITY event.dialog.new.task.key2               &quot;D&quot;&gt;</span>
<a href="#l18.18"></a><span id="l18.18"> &lt;!ENTITY event.dialog.new.message.key2            &quot;N&quot;&gt;</span>
<a href="#l18.19"></a><span id="l18.19"> &lt;!ENTITY event.dialog.close.key                   &quot;W&quot;&gt;</span>
<a href="#l18.20"></a><span id="l18.20"> &lt;!ENTITY event.dialog.save.key                    &quot;S&quot;&gt;</span>
<a href="#l18.21"></a><span id="l18.21"> &lt;!ENTITY event.dialog.saveandclose.key            &quot;L&quot;&gt;</span>
<a href="#l18.22"></a><span id="l18.22" class="difflineat">@@ -160,22 +160,28 @@</span>
<a href="#l18.23"></a><span id="l18.23"> &lt;!ENTITY  event.toolbar.attendees.tooltip                 &quot;Invite Attendees&quot;&gt;</span>
<a href="#l18.24"></a><span id="l18.24"> &lt;!ENTITY  event.toolbar.attachments.tooltip               &quot;Add Attachments&quot;&gt;</span>
<a href="#l18.25"></a><span id="l18.25"> &lt;!ENTITY  event.toolbar.privacy.tooltip                   &quot;Change Privacy&quot;&gt;</span>
<a href="#l18.26"></a><span id="l18.26"> &lt;!ENTITY  event.toolbar.priority.tooltip                  &quot;Change Priority&quot;&gt;</span>
<a href="#l18.27"></a><span id="l18.27"> &lt;!ENTITY  event.toolbar.status.tooltip                    &quot;Change Status&quot;&gt;</span>
<a href="#l18.28"></a><span id="l18.28"> &lt;!ENTITY  event.toolbar.freebusy.tooltip                  &quot;Change Free/Busy time&quot;&gt;</span>
<a href="#l18.29"></a><span id="l18.29"> </span>
<a href="#l18.30"></a><span id="l18.30"> &lt;!-- Counter box --&gt;</span>
<a href="#l18.31"></a><span id="l18.31" class="difflineplus">+&lt;!-- LOCALIZATON NOTE(counter.button.*)</span>
<a href="#l18.32"></a><span id="l18.32" class="difflineplus">+   - This is only visible in the UI if you have received a counterproposal before and are going to</span>
<a href="#l18.33"></a><span id="l18.33" class="difflineplus">+   - reschedule the event from the imipbar in the email view. Clicking on the buttons will only</span>
<a href="#l18.34"></a><span id="l18.34" class="difflineplus">+   - populate the form fields in the dialog, there's no other immediate action on clicking like with</span>
<a href="#l18.35"></a><span id="l18.35" class="difflineplus">+   - the imip bar. Rescheduling will happen after clicking on save&amp;close as usual. This screenshot</span>
<a href="#l18.36"></a><span id="l18.36" class="difflineplus">+   - illustrates how it might look like: https://bugzilla.mozilla.org/attachment.cgi?id=8810121 --&gt;</span>
<a href="#l18.37"></a><span id="l18.37"> &lt;!ENTITY counter.button.proposal.label                    &quot;Apply proposal&quot;&gt;</span>
<a href="#l18.38"></a><span id="l18.38"> &lt;!ENTITY counter.button.proposal.accesskey                &quot;p&quot;&gt;</span>
<a href="#l18.39"></a><span id="l18.39" class="difflineminus">-&lt;!ENTITY counter.button.proposal.tooltip                  &quot;Apply the proposal data to the form.&quot;&gt;</span>
<a href="#l18.40"></a><span id="l18.40" class="difflineplus">+&lt;!ENTITY counter.button.proposal.tooltip2                 &quot;Event fields will be filled in using the values from the counterproposal, only saving with or without additional changes will notify all attendees accordingly&quot;&gt;</span>
<a href="#l18.41"></a><span id="l18.41"> &lt;!ENTITY counter.button.original.label                    &quot;Apply original data&quot;&gt;</span>
<a href="#l18.42"></a><span id="l18.42"> &lt;!ENTITY counter.button.original.accesskey                &quot;r&quot;&gt;</span>
<a href="#l18.43"></a><span id="l18.43" class="difflineminus">-&lt;!ENTITY counter.button.original.tooltip                  &quot;Apply the original data to the form.&quot;&gt;</span>
<a href="#l18.44"></a><span id="l18.44" class="difflineplus">+&lt;!ENTITY counter.button.original.tooltip2                 &quot;The fields will be set to the values from the original event, before the counterproposal was made&quot;&gt;</span>
<a href="#l18.45"></a><span id="l18.45"> </span>
<a href="#l18.46"></a><span id="l18.46"> &lt;!-- Main page --&gt;</span>
<a href="#l18.47"></a><span id="l18.47"> &lt;!ENTITY event.title.textbox.label                        &quot;Title:&quot; &gt;</span>
<a href="#l18.48"></a><span id="l18.48"> &lt;!ENTITY event.title.textbox.accesskey                    &quot;I&quot;&gt;</span>
<a href="#l18.49"></a><span id="l18.49"> &lt;!ENTITY event.location.label                             &quot;Location:&quot; &gt;</span>
<a href="#l18.50"></a><span id="l18.50"> &lt;!ENTITY event.location.accesskey                         &quot;L&quot;&gt;</span>
<a href="#l18.51"></a><span id="l18.51"> &lt;!ENTITY event.categories.label                           &quot;Category:&quot;&gt;</span>
<a href="#l18.52"></a><span id="l18.52"> &lt;!ENTITY event.categories.accesskey                       &quot;y&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/calendar/locales/en-US/chrome/lightning/lightning.properties</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/calendar/locales/en-US/chrome/lightning/lightning.properties</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -113,21 +113,21 @@ imipHtml.attendeeUserType2.ROOM=%1$S (ro</span>
<a href="#l19.4"></a><span id="l19.4"> # imipHtml.attendeeRole2.*</span>
<a href="#l19.5"></a><span id="l19.5"> # %1$S - email address or common name &lt;email address&gt; representing an attendee of unknown type</span>
<a href="#l19.6"></a><span id="l19.6"> imipHtml.attendeeUserType2.UNKNOWN=%1$S</span>
<a href="#l19.7"></a><span id="l19.7"> </span>
<a href="#l19.8"></a><span id="l19.8"> imipAddedItemToCal2=The event has been added to your calendar.</span>
<a href="#l19.9"></a><span id="l19.9"> imipCanceledItem2=The event has been deleted from your calendar.</span>
<a href="#l19.10"></a><span id="l19.10"> imipUpdatedItem2=The event has been updated.</span>
<a href="#l19.11"></a><span id="l19.11"> imipBarCancelText=This message contains an event cancellation.</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-imipBarCounterErrorText=This message contains a counter proposal to an invitation that cannot be processed.</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineminus">-imipBarCounterPreviousVersionText=This message contains a counter proposal to a previous version of an invitation.</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineminus">-imipBarCounterText=This message contains a counter proposal to an invitation.</span>
<a href="#l19.15"></a><span id="l19.15" class="difflineminus">-imipBarDisallowedCounterText=This message contains a counter proposal although you disallowed countering for this event.</span>
<a href="#l19.16"></a><span id="l19.16" class="difflineminus">-imipBarDeclineCounterText=This message contains a reply to your counter proposal.</span>
<a href="#l19.17"></a><span id="l19.17" class="difflineplus">+imipBarCounterErrorText=This message contains a counterproposal to an invitation that cannot be processed.</span>
<a href="#l19.18"></a><span id="l19.18" class="difflineplus">+imipBarCounterPreviousVersionText=This message contains a counterproposal to a previous version of an invitation.</span>
<a href="#l19.19"></a><span id="l19.19" class="difflineplus">+imipBarCounterText=This message contains a counterproposal to an invitation.</span>
<a href="#l19.20"></a><span id="l19.20" class="difflineplus">+imipBarDisallowedCounterText=This message contains a counterproposal although you disallowed countering for this event.</span>
<a href="#l19.21"></a><span id="l19.21" class="difflineplus">+imipBarDeclineCounterText=This message contains a reply to your counterproposal.</span>
<a href="#l19.22"></a><span id="l19.22"> imipBarRefreshText=This message asks for an event update.</span>
<a href="#l19.23"></a><span id="l19.23"> imipBarPublishText=This message contains an event.</span>
<a href="#l19.24"></a><span id="l19.24"> imipBarRequestText=This message contains an invitation to an event.</span>
<a href="#l19.25"></a><span id="l19.25"> imipBarSentText=This message contains a sent event.</span>
<a href="#l19.26"></a><span id="l19.26"> imipBarSentButRemovedText=This message contains a sent out event that is not in your calendar anymore.</span>
<a href="#l19.27"></a><span id="l19.27"> imipBarUpdateText=This message contains an update to an existing event.</span>
<a href="#l19.28"></a><span id="l19.28"> imipBarAlreadyProcessedText=This message contains an event that has already been processed.</span>
<a href="#l19.29"></a><span id="l19.29"> imipBarProcessedNeedsAction=This message contains an event that you have not yet responded to.</span>
<a href="#l19.30"></a><span id="l19.30" class="difflineat">@@ -150,20 +150,20 @@ itipReplyBodyAccept=%1$S has accepted yo</span>
<a href="#l19.31"></a><span id="l19.31"> itipReplyBodyDecline=%1$S has declined your event invitation.</span>
<a href="#l19.32"></a><span id="l19.32"> itipReplySubjectAccept=Event Invitation Reply (Accepted): %1$S</span>
<a href="#l19.33"></a><span id="l19.33"> itipReplySubjectDecline=Event Invitation Reply (Declined): %1$S</span>
<a href="#l19.34"></a><span id="l19.34"> itipReplySubjectTentative=Event Invitation Reply (Tentative): %1$S</span>
<a href="#l19.35"></a><span id="l19.35"> itipRequestSubject=Event Invitation: %1$S</span>
<a href="#l19.36"></a><span id="l19.36"> itipRequestUpdatedSubject=Updated Event Invitation: %1$S</span>
<a href="#l19.37"></a><span id="l19.37"> itipRequestBody=%1$S has invited you to %2$S</span>
<a href="#l19.38"></a><span id="l19.38"> itipCancelSubject=Event Canceled: %1$S</span>
<a href="#l19.39"></a><span id="l19.39" class="difflineminus">-itipCancelBody=%1$S has canceled this event: « %2$S »</span>
<a href="#l19.40"></a><span id="l19.40" class="difflineminus">-itipCounterBody=%1$S has made a counter proposal for « %2$S »:</span>
<a href="#l19.41"></a><span id="l19.41" class="difflineminus">-itipDeclineCounterBody=%1$S has declined your counter proposal for « %2$S ».</span>
<a href="#l19.42"></a><span id="l19.42" class="difflineminus">-itipDeclineCounterSubject=Counter Proposal Declined: %1$S</span>
<a href="#l19.43"></a><span id="l19.43" class="difflineplus">+itipCancelBody=%1$S has canceled this event: %2$S</span>
<a href="#l19.44"></a><span id="l19.44" class="difflineplus">+itipCounterBody=%1$S has made a counterproposal for &quot;%2$S&quot;:</span>
<a href="#l19.45"></a><span id="l19.45" class="difflineplus">+itipDeclineCounterBody=%1$S has declined your counterproposal for &quot;%2$S&quot;.</span>
<a href="#l19.46"></a><span id="l19.46" class="difflineplus">+itipDeclineCounterSubject=Counterproposal Declined: %1$S</span>
<a href="#l19.47"></a><span id="l19.47"> </span>
<a href="#l19.48"></a><span id="l19.48"> confirmProcessInvitation=You have recently deleted this item, are you sure you want to process this invitation?</span>
<a href="#l19.49"></a><span id="l19.49"> confirmProcessInvitationTitle=Process Invitation?</span>
<a href="#l19.50"></a><span id="l19.50"> </span>
<a href="#l19.51"></a><span id="l19.51"> invitationsLink.label=Invitations: %1$S</span>
<a href="#l19.52"></a><span id="l19.52"> </span>
<a href="#l19.53"></a><span id="l19.53"> # LOCALIZATION_NOTE(binaryComponentKnown): This is shown when Lightning is</span>
<a href="#l19.54"></a><span id="l19.54"> # missing the binary component and knows how to calculate the expected version</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1">new file mode 100644</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineminus">--- /dev/null</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineplus">+++ b/calendar/test/unit/test_calitiputils.js</span>
<a href="#l20.4"></a><span id="l20.4" class="difflineat">@@ -0,0 +1,398 @@</span>
<a href="#l20.5"></a><span id="l20.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l20.6"></a><span id="l20.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l20.7"></a><span id="l20.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l20.8"></a><span id="l20.8" class="difflineplus">+</span>
<a href="#l20.9"></a><span id="l20.9" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l20.10"></a><span id="l20.10" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calItipUtils.jsm&quot;);</span>
<a href="#l20.11"></a><span id="l20.11" class="difflineplus">+Components.utils.import(&quot;resource://testing-common/mailnews/mailTestUtils.js&quot;);</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineplus">+</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineplus">+// tests for calItipUtils.jsm</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineplus">+</span>
<a href="#l20.15"></a><span id="l20.15" class="difflineplus">+function run_test() {</span>
<a href="#l20.16"></a><span id="l20.16" class="difflineplus">+    getMessageSender_test();</span>
<a href="#l20.17"></a><span id="l20.17" class="difflineplus">+    getSequence_test();</span>
<a href="#l20.18"></a><span id="l20.18" class="difflineplus">+    getStamp_test();</span>
<a href="#l20.19"></a><span id="l20.19" class="difflineplus">+    compareSequence_test();</span>
<a href="#l20.20"></a><span id="l20.20" class="difflineplus">+    compareStamp_test();</span>
<a href="#l20.21"></a><span id="l20.21" class="difflineplus">+    compare_test();</span>
<a href="#l20.22"></a><span id="l20.22" class="difflineplus">+}</span>
<a href="#l20.23"></a><span id="l20.23" class="difflineplus">+</span>
<a href="#l20.24"></a><span id="l20.24" class="difflineplus">+/*</span>
<a href="#l20.25"></a><span id="l20.25" class="difflineplus">+ * Helper function to get an ics for testing sequence and stamp comparison</span>
<a href="#l20.26"></a><span id="l20.26" class="difflineplus">+ *</span>
<a href="#l20.27"></a><span id="l20.27" class="difflineplus">+ * @param {String} aAttendee              A serialized ATTENDEE property</span>
<a href="#l20.28"></a><span id="l20.28" class="difflineplus">+ * @param {String} aSequence              A serialized SEQUENCE property</span>
<a href="#l20.29"></a><span id="l20.29" class="difflineplus">+ * @param {String} aDtStamp               A serialized DTSTAMP property</span>
<a href="#l20.30"></a><span id="l20.30" class="difflineplus">+ * @param {String} aXMozReceivedSequence  A serialized X-MOZ-RECEIVED-SEQUENCE property</span>
<a href="#l20.31"></a><span id="l20.31" class="difflineplus">+ * @param {String} aXMozReceivedDtStamp   A serialized X-MOZ-RECEIVED-STAMP property</span>
<a href="#l20.32"></a><span id="l20.32" class="difflineplus">+ */</span>
<a href="#l20.33"></a><span id="l20.33" class="difflineplus">+function getSeqStampTestIcs(aProperties) {</span>
<a href="#l20.34"></a><span id="l20.34" class="difflineplus">+    // we make sure to have a dtstamp property to get a valid ics</span>
<a href="#l20.35"></a><span id="l20.35" class="difflineplus">+    let dtStamp = &quot;20150909T181048Z&quot;;</span>
<a href="#l20.36"></a><span id="l20.36" class="difflineplus">+    let additionalProperties = &quot;&quot;;</span>
<a href="#l20.37"></a><span id="l20.37" class="difflineplus">+    aProperties.forEach((aProp) =&gt; {</span>
<a href="#l20.38"></a><span id="l20.38" class="difflineplus">+        if (aProp.startsWith(&quot;DTSTAMP:&quot;)) {</span>
<a href="#l20.39"></a><span id="l20.39" class="difflineplus">+            dtStamp = aProp;</span>
<a href="#l20.40"></a><span id="l20.40" class="difflineplus">+        } else {</span>
<a href="#l20.41"></a><span id="l20.41" class="difflineplus">+            additionalProperties += &quot;\r\n&quot; + aProp;</span>
<a href="#l20.42"></a><span id="l20.42" class="difflineplus">+        }</span>
<a href="#l20.43"></a><span id="l20.43" class="difflineplus">+    });</span>
<a href="#l20.44"></a><span id="l20.44" class="difflineplus">+</span>
<a href="#l20.45"></a><span id="l20.45" class="difflineplus">+    return [</span>
<a href="#l20.46"></a><span id="l20.46" class="difflineplus">+        &quot;BEGIN:VCALENDAR&quot;,</span>
<a href="#l20.47"></a><span id="l20.47" class="difflineplus">+        &quot;PRODID:-//Mozilla.org/NONSGML Mozilla Calendar V1.1//EN&quot;,</span>
<a href="#l20.48"></a><span id="l20.48" class="difflineplus">+        &quot;VERSION:2.0&quot;,</span>
<a href="#l20.49"></a><span id="l20.49" class="difflineplus">+        &quot;METHOD:REQUEST&quot;,</span>
<a href="#l20.50"></a><span id="l20.50" class="difflineplus">+        &quot;BEGIN:VTIMEZONE&quot;,</span>
<a href="#l20.51"></a><span id="l20.51" class="difflineplus">+        &quot;TZID:Europe/Berlin&quot;,</span>
<a href="#l20.52"></a><span id="l20.52" class="difflineplus">+        &quot;BEGIN:DAYLIGHT&quot;,</span>
<a href="#l20.53"></a><span id="l20.53" class="difflineplus">+        &quot;TZOFFSETFROM:+0100&quot;,</span>
<a href="#l20.54"></a><span id="l20.54" class="difflineplus">+        &quot;TZOFFSETTO:+0200&quot;,</span>
<a href="#l20.55"></a><span id="l20.55" class="difflineplus">+        &quot;TZNAME:CEST&quot;,</span>
<a href="#l20.56"></a><span id="l20.56" class="difflineplus">+        &quot;DTSTART:19700329T020000&quot;,</span>
<a href="#l20.57"></a><span id="l20.57" class="difflineplus">+        &quot;RRULE:FREQ=YEARLY;BYMONTH=3;BYDAY=-1SU&quot;,</span>
<a href="#l20.58"></a><span id="l20.58" class="difflineplus">+        &quot;END:DAYLIGHT&quot;,</span>
<a href="#l20.59"></a><span id="l20.59" class="difflineplus">+        &quot;BEGIN:STANDARD&quot;,</span>
<a href="#l20.60"></a><span id="l20.60" class="difflineplus">+        &quot;TZOFFSETFROM:+0200&quot;,</span>
<a href="#l20.61"></a><span id="l20.61" class="difflineplus">+        &quot;TZOFFSETTO:+0100&quot;,</span>
<a href="#l20.62"></a><span id="l20.62" class="difflineplus">+        &quot;TZNAME:CET&quot;,</span>
<a href="#l20.63"></a><span id="l20.63" class="difflineplus">+        &quot;DTSTART:19701025T030000&quot;,</span>
<a href="#l20.64"></a><span id="l20.64" class="difflineplus">+        &quot;RRULE:FREQ=YEARLY;BYMONTH=10;BYDAY=-1SU&quot;,</span>
<a href="#l20.65"></a><span id="l20.65" class="difflineplus">+        &quot;END:STANDARD&quot;,</span>
<a href="#l20.66"></a><span id="l20.66" class="difflineplus">+        &quot;END:VTIMEZONE&quot;,</span>
<a href="#l20.67"></a><span id="l20.67" class="difflineplus">+        &quot;BEGIN:VEVENT&quot;,</span>
<a href="#l20.68"></a><span id="l20.68" class="difflineplus">+        &quot;CREATED:20150909T180909Z&quot;,</span>
<a href="#l20.69"></a><span id="l20.69" class="difflineplus">+        &quot;LAST-MODIFIED:20150909T181048Z&quot;,</span>
<a href="#l20.70"></a><span id="l20.70" class="difflineplus">+        dtStamp,</span>
<a href="#l20.71"></a><span id="l20.71" class="difflineplus">+        &quot;UID:cb189fdc-ed47-4db6-a8d7-31a08802249d&quot;,</span>
<a href="#l20.72"></a><span id="l20.72" class="difflineplus">+        &quot;SUMMARY:Test Event&quot;,</span>
<a href="#l20.73"></a><span id="l20.73" class="difflineplus">+        &quot;ORGANIZER;RSVP=TRUE;CN=Organizer;PARTSTAT=ACCEPTED;ROLE=CHAIR:mailto:organizer@example.net&quot;,</span>
<a href="#l20.74"></a><span id="l20.74" class="difflineplus">+        &quot;ATTENDEE;RSVP=TRUE;CN=Attendee;PARTSTAT=NEEDS-ACTION;ROLE=REQ-PARTICIPANT:mailto:attende&quot; +</span>
<a href="#l20.75"></a><span id="l20.75" class="difflineplus">+        &quot;e@example.net&quot; + additionalProperties,</span>
<a href="#l20.76"></a><span id="l20.76" class="difflineplus">+        &quot;DTSTART;TZID=Europe/Berlin:20150909T210000&quot;,</span>
<a href="#l20.77"></a><span id="l20.77" class="difflineplus">+        &quot;DTEND;TZID=Europe/Berlin:20150909T220000&quot;,</span>
<a href="#l20.78"></a><span id="l20.78" class="difflineplus">+        &quot;TRANSP:OPAQUE&quot;,</span>
<a href="#l20.79"></a><span id="l20.79" class="difflineplus">+        &quot;LOCATION:Room 1&quot;,</span>
<a href="#l20.80"></a><span id="l20.80" class="difflineplus">+        &quot;DESCRIPTION:Let us get together&quot;,</span>
<a href="#l20.81"></a><span id="l20.81" class="difflineplus">+        &quot;URL:http://www.example.com&quot;,</span>
<a href="#l20.82"></a><span id="l20.82" class="difflineplus">+        &quot;ATTACH:http://www.example.com&quot;,</span>
<a href="#l20.83"></a><span id="l20.83" class="difflineplus">+        &quot;END:VEVENT&quot;,</span>
<a href="#l20.84"></a><span id="l20.84" class="difflineplus">+        &quot;END:VCALENDAR&quot;].join(&quot;\r\n&quot;);</span>
<a href="#l20.85"></a><span id="l20.85" class="difflineplus">+}</span>
<a href="#l20.86"></a><span id="l20.86" class="difflineplus">+</span>
<a href="#l20.87"></a><span id="l20.87" class="difflineplus">+function getSeqStampTestItems(aTest) {</span>
<a href="#l20.88"></a><span id="l20.88" class="difflineplus">+    let items = [];</span>
<a href="#l20.89"></a><span id="l20.89" class="difflineplus">+    for (let input of aTest.input) {</span>
<a href="#l20.90"></a><span id="l20.90" class="difflineplus">+        if (input.item) {</span>
<a href="#l20.91"></a><span id="l20.91" class="difflineplus">+            // in this case, we need to return an event</span>
<a href="#l20.92"></a><span id="l20.92" class="difflineplus">+            let attendee = &quot;&quot;;</span>
<a href="#l20.93"></a><span id="l20.93" class="difflineplus">+            if (&quot;attendee&quot; in input.item &amp;&amp; input.item.attendee != {}) {</span>
<a href="#l20.94"></a><span id="l20.94" class="difflineplus">+                let att = cal.createAttendee();</span>
<a href="#l20.95"></a><span id="l20.95" class="difflineplus">+                att.id = input.item.attendee.id || &quot;mailto:otherattendee@example.net&quot;;</span>
<a href="#l20.96"></a><span id="l20.96" class="difflineplus">+                if (&quot;receivedSeq&quot; in input.item.attendee &amp;&amp; input.item.attendee.receivedSeq.length) {</span>
<a href="#l20.97"></a><span id="l20.97" class="difflineplus">+                    att.setProperty(&quot;RECEIVED-SEQUENCE&quot;, input.item.attendee.receivedSeq);</span>
<a href="#l20.98"></a><span id="l20.98" class="difflineplus">+                }</span>
<a href="#l20.99"></a><span id="l20.99" class="difflineplus">+                if (&quot;receivedStamp&quot; in input.item.attendee &amp;&amp; input.item.attendee.receivedStamp.length) {</span>
<a href="#l20.100"></a><span id="l20.100" class="difflineplus">+                    att.setProperty(&quot;RECEIVED-DTSTAMP&quot;, input.item.attendee.receivedStamp);</span>
<a href="#l20.101"></a><span id="l20.101" class="difflineplus">+                }</span>
<a href="#l20.102"></a><span id="l20.102" class="difflineplus">+            }</span>
<a href="#l20.103"></a><span id="l20.103" class="difflineplus">+            let sequence = &quot;&quot;;</span>
<a href="#l20.104"></a><span id="l20.104" class="difflineplus">+            if (&quot;sequence&quot; in input.item &amp;&amp; input.item.sequence.length) {</span>
<a href="#l20.105"></a><span id="l20.105" class="difflineplus">+                sequence = &quot;SEQUENCE:&quot; + input.item.sequence;</span>
<a href="#l20.106"></a><span id="l20.106" class="difflineplus">+            }</span>
<a href="#l20.107"></a><span id="l20.107" class="difflineplus">+            let dtStamp = &quot;DTSTAMP:20150909T181048Z&quot;;</span>
<a href="#l20.108"></a><span id="l20.108" class="difflineplus">+            if (&quot;dtStamp&quot; in input.item &amp;&amp; input.item.dtStamp) {</span>
<a href="#l20.109"></a><span id="l20.109" class="difflineplus">+                dtStamp = &quot;DTSTAMP:&quot; + input.item.dtStamp;</span>
<a href="#l20.110"></a><span id="l20.110" class="difflineplus">+            }</span>
<a href="#l20.111"></a><span id="l20.111" class="difflineplus">+            let xMozReceivedSeq = &quot;&quot;;</span>
<a href="#l20.112"></a><span id="l20.112" class="difflineplus">+            if (&quot;xMozReceivedSeq&quot; in input.item &amp;&amp; input.item.xMozReceivedSeq.length) {</span>
<a href="#l20.113"></a><span id="l20.113" class="difflineplus">+                xMozReceivedSeq = &quot;X-MOZ-RECEIVED-SEQUENCE:&quot; + input.item.xMozReceivedSeq;</span>
<a href="#l20.114"></a><span id="l20.114" class="difflineplus">+            }</span>
<a href="#l20.115"></a><span id="l20.115" class="difflineplus">+            let xMozReceivedStamp = &quot;&quot;;</span>
<a href="#l20.116"></a><span id="l20.116" class="difflineplus">+            if (&quot;xMozReceivedStamp&quot; in input.item &amp;&amp; input.item.xMozReceivedStamp.length) {</span>
<a href="#l20.117"></a><span id="l20.117" class="difflineplus">+                xMozReceivedStamp = &quot;X-MOZ-RECEIVED-DTSTAMP:&quot; + input.item.xMozReceivedStamp;</span>
<a href="#l20.118"></a><span id="l20.118" class="difflineplus">+            }</span>
<a href="#l20.119"></a><span id="l20.119" class="difflineplus">+            let xMsAptSeq = &quot;&quot;;</span>
<a href="#l20.120"></a><span id="l20.120" class="difflineplus">+            if (&quot;xMsAptSeq&quot; in input.item &amp;&amp; input.item.xMsAptSeq.length) {</span>
<a href="#l20.121"></a><span id="l20.121" class="difflineplus">+                xMsAptSeq = &quot;X-MICROSOFT-CDO-APPT-SEQUENCE:&quot; + input.item.xMsAptSeq;</span>
<a href="#l20.122"></a><span id="l20.122" class="difflineplus">+            }</span>
<a href="#l20.123"></a><span id="l20.123" class="difflineplus">+            let testItem = cal.createEvent();</span>
<a href="#l20.124"></a><span id="l20.124" class="difflineplus">+            testItem.icalString = getSeqStampTestIcs([attendee, sequence, dtStamp, xMozReceivedSeq,</span>
<a href="#l20.125"></a><span id="l20.125" class="difflineplus">+                                                      xMozReceivedStamp, xMsAptSeq]);</span>
<a href="#l20.126"></a><span id="l20.126" class="difflineplus">+            items.push(testItem);</span>
<a href="#l20.127"></a><span id="l20.127" class="difflineplus">+        } else {</span>
<a href="#l20.128"></a><span id="l20.128" class="difflineplus">+            // in this case, we need to return an attendee</span>
<a href="#l20.129"></a><span id="l20.129" class="difflineplus">+            let att = cal.createAttendee();</span>
<a href="#l20.130"></a><span id="l20.130" class="difflineplus">+            att.id = input.attendee.id || &quot;mailto:otherattendee@example.net&quot;;</span>
<a href="#l20.131"></a><span id="l20.131" class="difflineplus">+            if (input.attendee.receivedSeq &amp;&amp; input.attendee.receivedSeq.length) {</span>
<a href="#l20.132"></a><span id="l20.132" class="difflineplus">+                att.setProperty(&quot;RECEIVED-SEQUENCE&quot;, input.attendee.receivedSeq);</span>
<a href="#l20.133"></a><span id="l20.133" class="difflineplus">+            }</span>
<a href="#l20.134"></a><span id="l20.134" class="difflineplus">+            if (input.attendee.receivedStamp &amp;&amp; input.attendee.receivedStamp.length) {</span>
<a href="#l20.135"></a><span id="l20.135" class="difflineplus">+                att.setProperty(&quot;RECEIVED-DTSTAMP&quot;, input.attendee.receivedStamp);</span>
<a href="#l20.136"></a><span id="l20.136" class="difflineplus">+            }</span>
<a href="#l20.137"></a><span id="l20.137" class="difflineplus">+            items.push(att);</span>
<a href="#l20.138"></a><span id="l20.138" class="difflineplus">+        }</span>
<a href="#l20.139"></a><span id="l20.139" class="difflineplus">+    }</span>
<a href="#l20.140"></a><span id="l20.140" class="difflineplus">+    return items;</span>
<a href="#l20.141"></a><span id="l20.141" class="difflineplus">+}</span>
<a href="#l20.142"></a><span id="l20.142" class="difflineplus">+</span>
<a href="#l20.143"></a><span id="l20.143" class="difflineplus">+function getMessageSender_test() {</span>
<a href="#l20.144"></a><span id="l20.144" class="difflineplus">+    let data = [{</span>
<a href="#l20.145"></a><span id="l20.145" class="difflineplus">+        input: null,</span>
<a href="#l20.146"></a><span id="l20.146" class="difflineplus">+        expected: null</span>
<a href="#l20.147"></a><span id="l20.147" class="difflineplus">+    }, {</span>
<a href="#l20.148"></a><span id="l20.148" class="difflineplus">+        input: { },</span>
<a href="#l20.149"></a><span id="l20.149" class="difflineplus">+        expected: null</span>
<a href="#l20.150"></a><span id="l20.150" class="difflineplus">+    }, {</span>
<a href="#l20.151"></a><span id="l20.151" class="difflineplus">+        input: { author: &quot;Sender 1 &lt;sender1@example.net&gt;&quot; },</span>
<a href="#l20.152"></a><span id="l20.152" class="difflineplus">+        expected: &quot;sender1@example.net&quot;</span>
<a href="#l20.153"></a><span id="l20.153" class="difflineplus">+    }];</span>
<a href="#l20.154"></a><span id="l20.154" class="difflineplus">+    for (let i = 1; i &lt;= data.length; i++) {</span>
<a href="#l20.155"></a><span id="l20.155" class="difflineplus">+        let test = data[i - 1];</span>
<a href="#l20.156"></a><span id="l20.156" class="difflineplus">+        equal(cal.itip.getMessageSender(test.input), test.expected, &quot;(test #&quot; + i + &quot;)&quot;);</span>
<a href="#l20.157"></a><span id="l20.157" class="difflineplus">+    }</span>
<a href="#l20.158"></a><span id="l20.158" class="difflineplus">+}</span>
<a href="#l20.159"></a><span id="l20.159" class="difflineplus">+</span>
<a href="#l20.160"></a><span id="l20.160" class="difflineplus">+function getSequence_test() {</span>
<a href="#l20.161"></a><span id="l20.161" class="difflineplus">+    // assigning an empty string results in not having the property in the ics here</span>
<a href="#l20.162"></a><span id="l20.162" class="difflineplus">+    let data = [{</span>
<a href="#l20.163"></a><span id="l20.163" class="difflineplus">+        input: [{ item: { sequence: &quot;&quot;, xMozReceivedSeq: &quot;&quot; } }],</span>
<a href="#l20.164"></a><span id="l20.164" class="difflineplus">+        expected: 0</span>
<a href="#l20.165"></a><span id="l20.165" class="difflineplus">+    }, {</span>
<a href="#l20.166"></a><span id="l20.166" class="difflineplus">+        input: [{ item: { sequence: &quot;0&quot;, xMozReceivedSeq: &quot;&quot; } }],</span>
<a href="#l20.167"></a><span id="l20.167" class="difflineplus">+        expected: 0</span>
<a href="#l20.168"></a><span id="l20.168" class="difflineplus">+    }, {</span>
<a href="#l20.169"></a><span id="l20.169" class="difflineplus">+        input: [{ item: { sequence: &quot;&quot;, xMozReceivedSeq: &quot;0&quot; } }],</span>
<a href="#l20.170"></a><span id="l20.170" class="difflineplus">+        expected: 0</span>
<a href="#l20.171"></a><span id="l20.171" class="difflineplus">+    }, {</span>
<a href="#l20.172"></a><span id="l20.172" class="difflineplus">+        input: [{ item: { sequence: &quot;1&quot;, xMozReceivedSeq: &quot;&quot; } }],</span>
<a href="#l20.173"></a><span id="l20.173" class="difflineplus">+        expected: 1</span>
<a href="#l20.174"></a><span id="l20.174" class="difflineplus">+    }, {</span>
<a href="#l20.175"></a><span id="l20.175" class="difflineplus">+        input: [{ item: { sequence: &quot;&quot;, xMozReceivedSeq: &quot;1&quot; } }],</span>
<a href="#l20.176"></a><span id="l20.176" class="difflineplus">+        expected: 1</span>
<a href="#l20.177"></a><span id="l20.177" class="difflineplus">+    }, {</span>
<a href="#l20.178"></a><span id="l20.178" class="difflineplus">+        input: [{ attendee: { receivedSeq: &quot;&quot; } }],</span>
<a href="#l20.179"></a><span id="l20.179" class="difflineplus">+        expected: 0</span>
<a href="#l20.180"></a><span id="l20.180" class="difflineplus">+    }, {</span>
<a href="#l20.181"></a><span id="l20.181" class="difflineplus">+        input: [{ attendee: { receivedSeq: &quot;0&quot; } }],</span>
<a href="#l20.182"></a><span id="l20.182" class="difflineplus">+        expected: 0</span>
<a href="#l20.183"></a><span id="l20.183" class="difflineplus">+    }, {</span>
<a href="#l20.184"></a><span id="l20.184" class="difflineplus">+        input: [{ attendee: { receivedSeq: &quot;1&quot; } }],</span>
<a href="#l20.185"></a><span id="l20.185" class="difflineplus">+        expected: 1</span>
<a href="#l20.186"></a><span id="l20.186" class="difflineplus">+    }];</span>
<a href="#l20.187"></a><span id="l20.187" class="difflineplus">+    for (let i = 1; i &lt;= data.length; i++) {</span>
<a href="#l20.188"></a><span id="l20.188" class="difflineplus">+        let test = data[i - 1];</span>
<a href="#l20.189"></a><span id="l20.189" class="difflineplus">+        testItems = getSeqStampTestItems(test);</span>
<a href="#l20.190"></a><span id="l20.190" class="difflineplus">+        equal(cal.itip.getSequence(testItems[0], testItems[1]), test.expected, &quot;(test #&quot; + i + &quot;)&quot;);</span>
<a href="#l20.191"></a><span id="l20.191" class="difflineplus">+    }</span>
<a href="#l20.192"></a><span id="l20.192" class="difflineplus">+}</span>
<a href="#l20.193"></a><span id="l20.193" class="difflineplus">+</span>
<a href="#l20.194"></a><span id="l20.194" class="difflineplus">+function getStamp_test() {</span>
<a href="#l20.195"></a><span id="l20.195" class="difflineplus">+    // assigning an empty string results in not having the property in the ics here. However, there</span>
<a href="#l20.196"></a><span id="l20.196" class="difflineplus">+    // must be always an dtStamp for item - if it's missing it will be set by the test code to make</span>
<a href="#l20.197"></a><span id="l20.197" class="difflineplus">+    // sure we get a valid ics</span>
<a href="#l20.198"></a><span id="l20.198" class="difflineplus">+    let data = [{</span>
<a href="#l20.199"></a><span id="l20.199" class="difflineplus">+        // !dtStamp &amp;&amp; !xMozReceivedStamp =&gt; test default value</span>
<a href="#l20.200"></a><span id="l20.200" class="difflineplus">+        input: [{ item: { dtStamp: &quot;&quot;, xMozReceivedStamp: &quot;&quot; } }],</span>
<a href="#l20.201"></a><span id="l20.201" class="difflineplus">+        expected: &quot;20150909T181048Z&quot;</span>
<a href="#l20.202"></a><span id="l20.202" class="difflineplus">+    }, {</span>
<a href="#l20.203"></a><span id="l20.203" class="difflineplus">+        // dtStamp &amp;&amp; !xMozReceivedStamp =&gt; dtStamp</span>
<a href="#l20.204"></a><span id="l20.204" class="difflineplus">+        input: [{ item: { dtStamp: &quot;20150910T181048Z&quot;, xMozReceivedStamp: &quot;&quot; } }],</span>
<a href="#l20.205"></a><span id="l20.205" class="difflineplus">+        expected: &quot;20150910T181048Z&quot;</span>
<a href="#l20.206"></a><span id="l20.206" class="difflineplus">+    }, {</span>
<a href="#l20.207"></a><span id="l20.207" class="difflineplus">+         // dtStamp &amp;&amp; xMozReceivedStamp =&gt; xMozReceivedStamp</span>
<a href="#l20.208"></a><span id="l20.208" class="difflineplus">+        input: [{ item: { dtStamp: &quot;20150909T181048Z&quot;, xMozReceivedStamp: &quot;20150910T181048Z&quot; } }],</span>
<a href="#l20.209"></a><span id="l20.209" class="difflineplus">+        expected: &quot;20150910T181048Z&quot;</span>
<a href="#l20.210"></a><span id="l20.210" class="difflineplus">+    }, {</span>
<a href="#l20.211"></a><span id="l20.211" class="difflineplus">+        input: [{ attendee: { receivedStamp: &quot;&quot; } }],</span>
<a href="#l20.212"></a><span id="l20.212" class="difflineplus">+        expected: null</span>
<a href="#l20.213"></a><span id="l20.213" class="difflineplus">+    }, {</span>
<a href="#l20.214"></a><span id="l20.214" class="difflineplus">+        input: [{ attendee: { receivedStamp: &quot;20150910T181048Z&quot; } }],</span>
<a href="#l20.215"></a><span id="l20.215" class="difflineplus">+        expected: &quot;20150910T181048Z&quot;</span>
<a href="#l20.216"></a><span id="l20.216" class="difflineplus">+    }];</span>
<a href="#l20.217"></a><span id="l20.217" class="difflineplus">+    for (let i = 1; i &lt;= data.length; i++) {</span>
<a href="#l20.218"></a><span id="l20.218" class="difflineplus">+        let test = data[i - 1];</span>
<a href="#l20.219"></a><span id="l20.219" class="difflineplus">+        let result = cal.itip.getStamp(getSeqStampTestItems(test)[0]);</span>
<a href="#l20.220"></a><span id="l20.220" class="difflineplus">+        if (result) {</span>
<a href="#l20.221"></a><span id="l20.221" class="difflineplus">+            result = result.icalString;</span>
<a href="#l20.222"></a><span id="l20.222" class="difflineplus">+        }</span>
<a href="#l20.223"></a><span id="l20.223" class="difflineplus">+        equal(result, test.expected, &quot;(test #&quot; + i + &quot;)&quot;);</span>
<a href="#l20.224"></a><span id="l20.224" class="difflineplus">+    }</span>
<a href="#l20.225"></a><span id="l20.225" class="difflineplus">+}</span>
<a href="#l20.226"></a><span id="l20.226" class="difflineplus">+</span>
<a href="#l20.227"></a><span id="l20.227" class="difflineplus">+function compareSequence_test() {</span>
<a href="#l20.228"></a><span id="l20.228" class="difflineplus">+    // it is sufficient to test here with sequence for items - full test coverage for</span>
<a href="#l20.229"></a><span id="l20.229" class="difflineplus">+    // x-moz-received-sequence is already provided by compareSequence_test</span>
<a href="#l20.230"></a><span id="l20.230" class="difflineplus">+    let data = [{</span>
<a href="#l20.231"></a><span id="l20.231" class="difflineplus">+        // item1.seq == item2.seq</span>
<a href="#l20.232"></a><span id="l20.232" class="difflineplus">+        input: [{ item: { sequence: &quot;2&quot; } },</span>
<a href="#l20.233"></a><span id="l20.233" class="difflineplus">+                { item: { sequence: &quot;2&quot; } }],</span>
<a href="#l20.234"></a><span id="l20.234" class="difflineplus">+        expected: 0</span>
<a href="#l20.235"></a><span id="l20.235" class="difflineplus">+    }, {</span>
<a href="#l20.236"></a><span id="l20.236" class="difflineplus">+        // item1.seq &gt; item2.seq</span>
<a href="#l20.237"></a><span id="l20.237" class="difflineplus">+        input: [{ item: { sequence: &quot;3&quot; } },</span>
<a href="#l20.238"></a><span id="l20.238" class="difflineplus">+                { item: { sequence: &quot;2&quot; } }],</span>
<a href="#l20.239"></a><span id="l20.239" class="difflineplus">+        expected: 1</span>
<a href="#l20.240"></a><span id="l20.240" class="difflineplus">+    }, {</span>
<a href="#l20.241"></a><span id="l20.241" class="difflineplus">+        // item1.seq &lt; item2.seq</span>
<a href="#l20.242"></a><span id="l20.242" class="difflineplus">+        input: [{ item: { sequence: &quot;2&quot; } },</span>
<a href="#l20.243"></a><span id="l20.243" class="difflineplus">+                { item: { sequence: &quot;3&quot; } }],</span>
<a href="#l20.244"></a><span id="l20.244" class="difflineplus">+        expected: -1</span>
<a href="#l20.245"></a><span id="l20.245" class="difflineplus">+    }, {</span>
<a href="#l20.246"></a><span id="l20.246" class="difflineplus">+        // attendee1.seq == attendee2.seq</span>
<a href="#l20.247"></a><span id="l20.247" class="difflineplus">+        input: [{ attendee: { receivedSeq: &quot;2&quot; } },</span>
<a href="#l20.248"></a><span id="l20.248" class="difflineplus">+                { attendee: { receivedSeq: &quot;2&quot; } }],</span>
<a href="#l20.249"></a><span id="l20.249" class="difflineplus">+        expected: 0</span>
<a href="#l20.250"></a><span id="l20.250" class="difflineplus">+    }, {</span>
<a href="#l20.251"></a><span id="l20.251" class="difflineplus">+        // attendee1.seq &gt; attendee2.seq</span>
<a href="#l20.252"></a><span id="l20.252" class="difflineplus">+        input: [{ attendee: { receivedSeq: &quot;3&quot; } },</span>
<a href="#l20.253"></a><span id="l20.253" class="difflineplus">+                { attendee: { receivedSeq: &quot;2&quot; } }],</span>
<a href="#l20.254"></a><span id="l20.254" class="difflineplus">+        expected: 1</span>
<a href="#l20.255"></a><span id="l20.255" class="difflineplus">+    }, {</span>
<a href="#l20.256"></a><span id="l20.256" class="difflineplus">+        // attendee1.seq &lt; attendee2.seq</span>
<a href="#l20.257"></a><span id="l20.257" class="difflineplus">+        input: [{ attendee: { receivedSeq: &quot;2&quot; } },</span>
<a href="#l20.258"></a><span id="l20.258" class="difflineplus">+                { attendee: { receivedSeq: &quot;3&quot; } }],</span>
<a href="#l20.259"></a><span id="l20.259" class="difflineplus">+        expected: -1</span>
<a href="#l20.260"></a><span id="l20.260" class="difflineplus">+    }, {</span>
<a href="#l20.261"></a><span id="l20.261" class="difflineplus">+        // item.seq == attendee.seq</span>
<a href="#l20.262"></a><span id="l20.262" class="difflineplus">+        input: [{ item: { sequence: &quot;2&quot; } },</span>
<a href="#l20.263"></a><span id="l20.263" class="difflineplus">+                { attendee: { receivedSeq: &quot;2&quot; } }],</span>
<a href="#l20.264"></a><span id="l20.264" class="difflineplus">+        expected: 0</span>
<a href="#l20.265"></a><span id="l20.265" class="difflineplus">+    }, {</span>
<a href="#l20.266"></a><span id="l20.266" class="difflineplus">+        // item.seq &gt; attendee.seq</span>
<a href="#l20.267"></a><span id="l20.267" class="difflineplus">+        input: [{ item: { sequence: &quot;3&quot; } },</span>
<a href="#l20.268"></a><span id="l20.268" class="difflineplus">+                { attendee: { receivedSeq: &quot;2&quot; } }],</span>
<a href="#l20.269"></a><span id="l20.269" class="difflineplus">+        expected: 1</span>
<a href="#l20.270"></a><span id="l20.270" class="difflineplus">+    }, {</span>
<a href="#l20.271"></a><span id="l20.271" class="difflineplus">+        // item.seq &lt; attendee.seq</span>
<a href="#l20.272"></a><span id="l20.272" class="difflineplus">+        input: [{ item: { sequence: &quot;2&quot; } },</span>
<a href="#l20.273"></a><span id="l20.273" class="difflineplus">+                { attendee: { receivedSeq: &quot;3&quot; } }],</span>
<a href="#l20.274"></a><span id="l20.274" class="difflineplus">+        expected: -1</span>
<a href="#l20.275"></a><span id="l20.275" class="difflineplus">+    }];</span>
<a href="#l20.276"></a><span id="l20.276" class="difflineplus">+    for (let i = 1; i &lt;= data.length; i++) {</span>
<a href="#l20.277"></a><span id="l20.277" class="difflineplus">+        let test = data[i - 1];</span>
<a href="#l20.278"></a><span id="l20.278" class="difflineplus">+        testItems = getSeqStampTestItems(test);</span>
<a href="#l20.279"></a><span id="l20.279" class="difflineplus">+        equal(cal.itip.compareSequence(testItems[0], testItems[1]),</span>
<a href="#l20.280"></a><span id="l20.280" class="difflineplus">+              test.expected,</span>
<a href="#l20.281"></a><span id="l20.281" class="difflineplus">+              &quot;(test #&quot; + i + &quot;)&quot;</span>
<a href="#l20.282"></a><span id="l20.282" class="difflineplus">+        );</span>
<a href="#l20.283"></a><span id="l20.283" class="difflineplus">+    }</span>
<a href="#l20.284"></a><span id="l20.284" class="difflineplus">+}</span>
<a href="#l20.285"></a><span id="l20.285" class="difflineplus">+</span>
<a href="#l20.286"></a><span id="l20.286" class="difflineplus">+function compareStamp_test() {</span>
<a href="#l20.287"></a><span id="l20.287" class="difflineplus">+    // it is sufficient to test here with dtstamp for items - full test coverage for</span>
<a href="#l20.288"></a><span id="l20.288" class="difflineplus">+    // x-moz-received-stamp is already provided by compareStamp_test</span>
<a href="#l20.289"></a><span id="l20.289" class="difflineplus">+    let data = [{</span>
<a href="#l20.290"></a><span id="l20.290" class="difflineplus">+        // item1.stamp == item2.stamp</span>
<a href="#l20.291"></a><span id="l20.291" class="difflineplus">+        input: [{ item: { dtStamp: &quot;20150910T181048Z&quot; } },</span>
<a href="#l20.292"></a><span id="l20.292" class="difflineplus">+                { item: { dtStamp: &quot;20150910T181048Z&quot; } }],</span>
<a href="#l20.293"></a><span id="l20.293" class="difflineplus">+        expected: 0</span>
<a href="#l20.294"></a><span id="l20.294" class="difflineplus">+    }, {</span>
<a href="#l20.295"></a><span id="l20.295" class="difflineplus">+        // item1.stamp &gt; item2.stamp</span>
<a href="#l20.296"></a><span id="l20.296" class="difflineplus">+        input: [{ item: { dtStamp: &quot;20150911T181048Z&quot; } },</span>
<a href="#l20.297"></a><span id="l20.297" class="difflineplus">+                { item: { dtStamp: &quot;20150910T181048Z&quot; } }],</span>
<a href="#l20.298"></a><span id="l20.298" class="difflineplus">+        expected: 1</span>
<a href="#l20.299"></a><span id="l20.299" class="difflineplus">+    }, {</span>
<a href="#l20.300"></a><span id="l20.300" class="difflineplus">+        // item1.stamp &lt; item2.stamp</span>
<a href="#l20.301"></a><span id="l20.301" class="difflineplus">+        input: [{ item: { dtStamp: &quot;20150910T181048Z&quot; } },</span>
<a href="#l20.302"></a><span id="l20.302" class="difflineplus">+                { item: { dtStamp: &quot;20150911T181048Z&quot; } }],</span>
<a href="#l20.303"></a><span id="l20.303" class="difflineplus">+        expected: -1</span>
<a href="#l20.304"></a><span id="l20.304" class="difflineplus">+    }, {</span>
<a href="#l20.305"></a><span id="l20.305" class="difflineplus">+        // attendee1.stamp == attendee2.stamp</span>
<a href="#l20.306"></a><span id="l20.306" class="difflineplus">+        input: [{ attendee: { receivedStamp: &quot;20150910T181048Z&quot; } },</span>
<a href="#l20.307"></a><span id="l20.307" class="difflineplus">+                { attendee: { receivedStamp: &quot;20150910T181048Z&quot; } }],</span>
<a href="#l20.308"></a><span id="l20.308" class="difflineplus">+        expected: 0</span>
<a href="#l20.309"></a><span id="l20.309" class="difflineplus">+    }, {</span>
<a href="#l20.310"></a><span id="l20.310" class="difflineplus">+        // attendee1.stamp &gt; attendee2.stamp</span>
<a href="#l20.311"></a><span id="l20.311" class="difflineplus">+        input: [{ attendee: { receivedStamp: &quot;20150911T181048Z&quot; } },</span>
<a href="#l20.312"></a><span id="l20.312" class="difflineplus">+                { attendee: { receivedStamp: &quot;20150910T181048Z&quot; } }],</span>
<a href="#l20.313"></a><span id="l20.313" class="difflineplus">+        expected: 1</span>
<a href="#l20.314"></a><span id="l20.314" class="difflineplus">+    }, {</span>
<a href="#l20.315"></a><span id="l20.315" class="difflineplus">+        // attendee1.stamp &lt; attendee2.stamp</span>
<a href="#l20.316"></a><span id="l20.316" class="difflineplus">+        input: [{ attendee: { receivedStamp: &quot;20150910T181048Z&quot; } },</span>
<a href="#l20.317"></a><span id="l20.317" class="difflineplus">+                { attendee: { receivedStamp: &quot;20150911T181048Z&quot; } }],</span>
<a href="#l20.318"></a><span id="l20.318" class="difflineplus">+        expected: -1</span>
<a href="#l20.319"></a><span id="l20.319" class="difflineplus">+    }, {</span>
<a href="#l20.320"></a><span id="l20.320" class="difflineplus">+        // item.stamp == attendee.stamp</span>
<a href="#l20.321"></a><span id="l20.321" class="difflineplus">+        input: [{ item: { dtStamp: &quot;20150910T181048Z&quot; } },</span>
<a href="#l20.322"></a><span id="l20.322" class="difflineplus">+                { attendee: { receivedStamp: &quot;20150910T181048Z&quot; } }],</span>
<a href="#l20.323"></a><span id="l20.323" class="difflineplus">+        expected: 0</span>
<a href="#l20.324"></a><span id="l20.324" class="difflineplus">+    }, {</span>
<a href="#l20.325"></a><span id="l20.325" class="difflineplus">+        // item.stamp &gt; attendee.stamp</span>
<a href="#l20.326"></a><span id="l20.326" class="difflineplus">+        input: [{ item: { dtStamp: &quot;20150911T181048Z&quot; } },</span>
<a href="#l20.327"></a><span id="l20.327" class="difflineplus">+                { attendee: { receivedStamp: &quot;20150910T181048Z&quot; } }],</span>
<a href="#l20.328"></a><span id="l20.328" class="difflineplus">+        expected: 1</span>
<a href="#l20.329"></a><span id="l20.329" class="difflineplus">+    }, {</span>
<a href="#l20.330"></a><span id="l20.330" class="difflineplus">+        // item.stamp &lt; attendee.stamp</span>
<a href="#l20.331"></a><span id="l20.331" class="difflineplus">+        input: [{ item: { dtStamp: &quot;20150910T181048Z&quot; } },</span>
<a href="#l20.332"></a><span id="l20.332" class="difflineplus">+                { attendee: { receivedStamp: &quot;20150911T181048Z&quot; } }],</span>
<a href="#l20.333"></a><span id="l20.333" class="difflineplus">+        expected: -1</span>
<a href="#l20.334"></a><span id="l20.334" class="difflineplus">+    }];</span>
<a href="#l20.335"></a><span id="l20.335" class="difflineplus">+    for (let i = 1; i &lt;= data.length; i++) {</span>
<a href="#l20.336"></a><span id="l20.336" class="difflineplus">+        let test = data[i - 1];</span>
<a href="#l20.337"></a><span id="l20.337" class="difflineplus">+        testItems = getSeqStampTestItems(test);</span>
<a href="#l20.338"></a><span id="l20.338" class="difflineplus">+        equal(cal.itip.compareStamp(testItems[0], testItems[1]),</span>
<a href="#l20.339"></a><span id="l20.339" class="difflineplus">+              test.expected,</span>
<a href="#l20.340"></a><span id="l20.340" class="difflineplus">+              &quot;(test #&quot; + i + &quot;)&quot;</span>
<a href="#l20.341"></a><span id="l20.341" class="difflineplus">+        );</span>
<a href="#l20.342"></a><span id="l20.342" class="difflineplus">+    }</span>
<a href="#l20.343"></a><span id="l20.343" class="difflineplus">+}</span>
<a href="#l20.344"></a><span id="l20.344" class="difflineplus">+</span>
<a href="#l20.345"></a><span id="l20.345" class="difflineplus">+function compare_test() {</span>
<a href="#l20.346"></a><span id="l20.346" class="difflineplus">+    // it is sufficient to test here with items only - full test coverage for attendees or</span>
<a href="#l20.347"></a><span id="l20.347" class="difflineplus">+    // item/attendee is already provided by compareSequence_test and compareStamp_test</span>
<a href="#l20.348"></a><span id="l20.348" class="difflineplus">+    let data = [{</span>
<a href="#l20.349"></a><span id="l20.349" class="difflineplus">+        // item1.seq == item2.seq &amp;&amp; item1.stamp == item2.stamp</span>
<a href="#l20.350"></a><span id="l20.350" class="difflineplus">+        input: [{ item: { sequence: &quot;2&quot;, dtStamp: &quot;20150910T181048Z&quot; } },</span>
<a href="#l20.351"></a><span id="l20.351" class="difflineplus">+                { item: { sequence: &quot;2&quot;, dtStamp: &quot;20150910T181048Z&quot; } }],</span>
<a href="#l20.352"></a><span id="l20.352" class="difflineplus">+        expected: 0</span>
<a href="#l20.353"></a><span id="l20.353" class="difflineplus">+    }, {</span>
<a href="#l20.354"></a><span id="l20.354" class="difflineplus">+        // item1.seq == item2.seq &amp;&amp; item1.stamp &gt; item2.stamp</span>
<a href="#l20.355"></a><span id="l20.355" class="difflineplus">+        input: [{ item: { sequence: &quot;2&quot;, dtStamp: &quot;20150911T181048Z&quot; } },</span>
<a href="#l20.356"></a><span id="l20.356" class="difflineplus">+                { item: { sequence: &quot;2&quot;, dtStamp: &quot;20150910T181048Z&quot; } }],</span>
<a href="#l20.357"></a><span id="l20.357" class="difflineplus">+        expected: 1</span>
<a href="#l20.358"></a><span id="l20.358" class="difflineplus">+    }, {</span>
<a href="#l20.359"></a><span id="l20.359" class="difflineplus">+        // item1.seq == item2.seq &amp;&amp; item1.stamp &lt; item2.stamp</span>
<a href="#l20.360"></a><span id="l20.360" class="difflineplus">+        input: [{ item: { sequence: &quot;2&quot;, dtStamp: &quot;20150910T181048Z&quot; } },</span>
<a href="#l20.361"></a><span id="l20.361" class="difflineplus">+                { item: { sequence: &quot;2&quot;, dtStamp: &quot;20150911T181048Z&quot; } }],</span>
<a href="#l20.362"></a><span id="l20.362" class="difflineplus">+        expected: -1</span>
<a href="#l20.363"></a><span id="l20.363" class="difflineplus">+    }, {</span>
<a href="#l20.364"></a><span id="l20.364" class="difflineplus">+        // item1.seq &gt; item2.seq &amp;&amp; item1.stamp == item2.stamp</span>
<a href="#l20.365"></a><span id="l20.365" class="difflineplus">+        input: [{ item: { sequence: &quot;3&quot;, dtStamp: &quot;20150910T181048Z&quot; } },</span>
<a href="#l20.366"></a><span id="l20.366" class="difflineplus">+                { item: { sequence: &quot;2&quot;, dtStamp: &quot;20150910T181048Z&quot; } }],</span>
<a href="#l20.367"></a><span id="l20.367" class="difflineplus">+        expected: 1</span>
<a href="#l20.368"></a><span id="l20.368" class="difflineplus">+    }, {</span>
<a href="#l20.369"></a><span id="l20.369" class="difflineplus">+        // item1.seq &gt; item2.seq &amp;&amp; item1.stamp &gt; item2.stamp</span>
<a href="#l20.370"></a><span id="l20.370" class="difflineplus">+        input: [{ item: { sequence: &quot;3&quot;, dtStamp: &quot;20150911T181048Z&quot; } },</span>
<a href="#l20.371"></a><span id="l20.371" class="difflineplus">+                { item: { sequence: &quot;2&quot;, dtStamp: &quot;20150910T181048Z&quot; } }],</span>
<a href="#l20.372"></a><span id="l20.372" class="difflineplus">+        expected: 1</span>
<a href="#l20.373"></a><span id="l20.373" class="difflineplus">+    }, {</span>
<a href="#l20.374"></a><span id="l20.374" class="difflineplus">+        // item1.seq &gt; item2.seq &amp;&amp; item1.stamp &lt; item2.stamp</span>
<a href="#l20.375"></a><span id="l20.375" class="difflineplus">+        input: [{ item: { sequence: &quot;3&quot;, dtStamp: &quot;20150910T181048Z&quot; } },</span>
<a href="#l20.376"></a><span id="l20.376" class="difflineplus">+                { item: { sequence: &quot;2&quot;, dtStamp: &quot;20150911T181048Z&quot; } }],</span>
<a href="#l20.377"></a><span id="l20.377" class="difflineplus">+        expected: 1</span>
<a href="#l20.378"></a><span id="l20.378" class="difflineplus">+    }, {</span>
<a href="#l20.379"></a><span id="l20.379" class="difflineplus">+        // item1.seq &lt; item2.seq &amp;&amp; item1.stamp == item2.stamp</span>
<a href="#l20.380"></a><span id="l20.380" class="difflineplus">+        input: [{ item: { sequence: &quot;2&quot;, dtStamp: &quot;20150910T181048Z&quot; } },</span>
<a href="#l20.381"></a><span id="l20.381" class="difflineplus">+                { item: { sequence: &quot;3&quot;, dtStamp: &quot;20150910T181048Z&quot; } }],</span>
<a href="#l20.382"></a><span id="l20.382" class="difflineplus">+        expected: -1</span>
<a href="#l20.383"></a><span id="l20.383" class="difflineplus">+    }, {</span>
<a href="#l20.384"></a><span id="l20.384" class="difflineplus">+        // item1.seq &lt; item2.seq &amp;&amp; item1.stamp &gt; item2.stamp</span>
<a href="#l20.385"></a><span id="l20.385" class="difflineplus">+        input: [{ item: { sequence: &quot;2&quot;, dtStamp: &quot;20150911T181048Z&quot; } },</span>
<a href="#l20.386"></a><span id="l20.386" class="difflineplus">+                { item: { sequence: &quot;3&quot;, dtStamp: &quot;20150910T181048Z&quot; } }],</span>
<a href="#l20.387"></a><span id="l20.387" class="difflineplus">+        expected: -1</span>
<a href="#l20.388"></a><span id="l20.388" class="difflineplus">+    }, {</span>
<a href="#l20.389"></a><span id="l20.389" class="difflineplus">+        // item1.seq &lt; item2.seq &amp;&amp; item1.stamp &lt; item2.stamp</span>
<a href="#l20.390"></a><span id="l20.390" class="difflineplus">+        input: [{ item: { sequence: &quot;2&quot;, dtStamp: &quot;20150910T181048Z&quot; } },</span>
<a href="#l20.391"></a><span id="l20.391" class="difflineplus">+                { item: { sequence: &quot;3&quot;, dtStamp: &quot;20150911T181048Z&quot; } }],</span>
<a href="#l20.392"></a><span id="l20.392" class="difflineplus">+        expected: -1</span>
<a href="#l20.393"></a><span id="l20.393" class="difflineplus">+    }];</span>
<a href="#l20.394"></a><span id="l20.394" class="difflineplus">+    for (let i = 1; i &lt;= data.length; i++) {</span>
<a href="#l20.395"></a><span id="l20.395" class="difflineplus">+        let test = data[i - 1];</span>
<a href="#l20.396"></a><span id="l20.396" class="difflineplus">+        testItems = getSeqStampTestItems(test);</span>
<a href="#l20.397"></a><span id="l20.397" class="difflineplus">+        equal(cal.itip.compare(testItems[0], testItems[1]),</span>
<a href="#l20.398"></a><span id="l20.398" class="difflineplus">+              test.expected,</span>
<a href="#l20.399"></a><span id="l20.399" class="difflineplus">+              &quot;(test #&quot; + i + &quot;)&quot;</span>
<a href="#l20.400"></a><span id="l20.400" class="difflineplus">+        );</span>
<a href="#l20.401"></a><span id="l20.401" class="difflineplus">+    }</span>
<a href="#l20.402"></a><span id="l20.402" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/calendar/test/unit/test_calutils.js</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/calendar/test/unit/test_calutils.js</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -1,25 +1,26 @@</span>
<a href="#l21.4"></a><span id="l21.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l21.5"></a><span id="l21.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l21.6"></a><span id="l21.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l21.7"></a><span id="l21.7"> </span>
<a href="#l21.8"></a><span id="l21.8"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l21.9"></a><span id="l21.9"> </span>
<a href="#l21.10"></a><span id="l21.10" class="difflineplus">+// tests for calUtils.jsm</span>
<a href="#l21.11"></a><span id="l21.11" class="difflineplus">+</span>
<a href="#l21.12"></a><span id="l21.12"> function run_test() {</span>
<a href="#l21.13"></a><span id="l21.13">     getAttendeeEmail_test();</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineplus">+    getAttendeesBySender_test();</span>
<a href="#l21.15"></a><span id="l21.15">     getRecipientList_test();</span>
<a href="#l21.16"></a><span id="l21.16">     prependMailTo_test();</span>
<a href="#l21.17"></a><span id="l21.17">     removeMailTo_test();</span>
<a href="#l21.18"></a><span id="l21.18">     resolveDelegation_test();</span>
<a href="#l21.19"></a><span id="l21.19">     validateRecipientList_test();</span>
<a href="#l21.20"></a><span id="l21.20"> }</span>
<a href="#l21.21"></a><span id="l21.21"> </span>
<a href="#l21.22"></a><span id="l21.22" class="difflineminus">-// tests for calUtils.jsm</span>
<a href="#l21.23"></a><span id="l21.23" class="difflineminus">-</span>
<a href="#l21.24"></a><span id="l21.24"> function getAttendeeEmail_test() {</span>
<a href="#l21.25"></a><span id="l21.25">     let data = [{</span>
<a href="#l21.26"></a><span id="l21.26">         input: { id: &quot;mailto:first.last@example.net&quot;, cname: &quot;Last, First&quot;, email: null, useCn: true },</span>
<a href="#l21.27"></a><span id="l21.27">         expected: &quot;\&quot;Last, First\&quot; &lt;first.last@example.net&gt;&quot;</span>
<a href="#l21.28"></a><span id="l21.28">     }, {</span>
<a href="#l21.29"></a><span id="l21.29">         input: { id: &quot;mailto:first.last@example.net&quot;, cname: &quot;Last; First&quot;, email: null, useCn: true },</span>
<a href="#l21.30"></a><span id="l21.30">         expected: &quot;\&quot;Last; First\&quot; &lt;first.last@example.net&gt;&quot;</span>
<a href="#l21.31"></a><span id="l21.31">     }, {</span>
<a href="#l21.32"></a><span id="l21.32" class="difflineat">@@ -54,16 +55,84 @@ function getAttendeeEmail_test() {</span>
<a href="#l21.33"></a><span id="l21.33">         }</span>
<a href="#l21.34"></a><span id="l21.34">         if (test.input.email) {</span>
<a href="#l21.35"></a><span id="l21.35">             attendee.setProperty(&quot;EMAIL&quot;, test.input.email);</span>
<a href="#l21.36"></a><span id="l21.36">         }</span>
<a href="#l21.37"></a><span id="l21.37">         equal(cal.getAttendeeEmail(attendee, test.input.useCn), test.expected, &quot;(test #&quot; + i + &quot;)&quot;);</span>
<a href="#l21.38"></a><span id="l21.38">     }</span>
<a href="#l21.39"></a><span id="l21.39"> }</span>
<a href="#l21.40"></a><span id="l21.40"> </span>
<a href="#l21.41"></a><span id="l21.41" class="difflineplus">+function getAttendeesBySender_test() {</span>
<a href="#l21.42"></a><span id="l21.42" class="difflineplus">+    let data = [{</span>
<a href="#l21.43"></a><span id="l21.43" class="difflineplus">+        input: {</span>
<a href="#l21.44"></a><span id="l21.44" class="difflineplus">+            attendees: [{ id: &quot;mailto:user1@example.net&quot;, sentBy: null },</span>
<a href="#l21.45"></a><span id="l21.45" class="difflineplus">+                        { id: &quot;mailto:user2@example.net&quot;, sentBy: null }],</span>
<a href="#l21.46"></a><span id="l21.46" class="difflineplus">+            sender: &quot;user1@example.net&quot;</span>
<a href="#l21.47"></a><span id="l21.47" class="difflineplus">+        },</span>
<a href="#l21.48"></a><span id="l21.48" class="difflineplus">+        expected: [&quot;mailto:user1@example.net&quot;]</span>
<a href="#l21.49"></a><span id="l21.49" class="difflineplus">+    }, {</span>
<a href="#l21.50"></a><span id="l21.50" class="difflineplus">+        input: {</span>
<a href="#l21.51"></a><span id="l21.51" class="difflineplus">+            attendees: [{ id: &quot;mailto:user1@example.net&quot;, sentBy: null },</span>
<a href="#l21.52"></a><span id="l21.52" class="difflineplus">+                        { id: &quot;mailto:user2@example.net&quot;, sentBy: null }],</span>
<a href="#l21.53"></a><span id="l21.53" class="difflineplus">+            sender: &quot;user3@example.net&quot;</span>
<a href="#l21.54"></a><span id="l21.54" class="difflineplus">+        },</span>
<a href="#l21.55"></a><span id="l21.55" class="difflineplus">+        expected: []</span>
<a href="#l21.56"></a><span id="l21.56" class="difflineplus">+    }, {</span>
<a href="#l21.57"></a><span id="l21.57" class="difflineplus">+        input: {</span>
<a href="#l21.58"></a><span id="l21.58" class="difflineplus">+            attendees: [{ id: &quot;mailto:user1@example.net&quot;, sentBy: &quot;mailto:user3@example.net&quot; },</span>
<a href="#l21.59"></a><span id="l21.59" class="difflineplus">+                        { id: &quot;mailto:user2@example.net&quot;, sentBy: null }],</span>
<a href="#l21.60"></a><span id="l21.60" class="difflineplus">+            sender: &quot;user3@example.net&quot;</span>
<a href="#l21.61"></a><span id="l21.61" class="difflineplus">+        },</span>
<a href="#l21.62"></a><span id="l21.62" class="difflineplus">+        expected: [&quot;mailto:user1@example.net&quot;]</span>
<a href="#l21.63"></a><span id="l21.63" class="difflineplus">+    }, {</span>
<a href="#l21.64"></a><span id="l21.64" class="difflineplus">+        input: {</span>
<a href="#l21.65"></a><span id="l21.65" class="difflineplus">+            attendees: [{ id: &quot;mailto:user1@example.net&quot;, sentBy: null },</span>
<a href="#l21.66"></a><span id="l21.66" class="difflineplus">+                        { id: &quot;mailto:user2@example.net&quot;, sentBy: &quot;mailto:user1@example.net&quot; }],</span>
<a href="#l21.67"></a><span id="l21.67" class="difflineplus">+            sender: &quot;user1@example.net&quot;</span>
<a href="#l21.68"></a><span id="l21.68" class="difflineplus">+        },</span>
<a href="#l21.69"></a><span id="l21.69" class="difflineplus">+        expected: [&quot;mailto:user1@example.net&quot;, &quot;mailto:user2@example.net&quot;]</span>
<a href="#l21.70"></a><span id="l21.70" class="difflineplus">+    }, {</span>
<a href="#l21.71"></a><span id="l21.71" class="difflineplus">+        input: { attendees: [], sender: &quot;user1@example.net&quot; },</span>
<a href="#l21.72"></a><span id="l21.72" class="difflineplus">+        expected: []</span>
<a href="#l21.73"></a><span id="l21.73" class="difflineplus">+    }, {</span>
<a href="#l21.74"></a><span id="l21.74" class="difflineplus">+        input: {</span>
<a href="#l21.75"></a><span id="l21.75" class="difflineplus">+            attendees: [{ id: &quot;mailto:user1@example.net&quot;, sentBy: null },</span>
<a href="#l21.76"></a><span id="l21.76" class="difflineplus">+                        { id: &quot;mailto:user2@example.net&quot;, sentBy: null }],</span>
<a href="#l21.77"></a><span id="l21.77" class="difflineplus">+            sender: &quot;&quot;</span>
<a href="#l21.78"></a><span id="l21.78" class="difflineplus">+        },</span>
<a href="#l21.79"></a><span id="l21.79" class="difflineplus">+        expected: []</span>
<a href="#l21.80"></a><span id="l21.80" class="difflineplus">+    }, {</span>
<a href="#l21.81"></a><span id="l21.81" class="difflineplus">+        input: {</span>
<a href="#l21.82"></a><span id="l21.82" class="difflineplus">+            attendees: [{ id: &quot;mailto:user1@example.net&quot;, sentBy: null },</span>
<a href="#l21.83"></a><span id="l21.83" class="difflineplus">+                        { id: &quot;mailto:user2@example.net&quot;, sentBy: null }],</span>
<a href="#l21.84"></a><span id="l21.84" class="difflineplus">+            sender: null</span>
<a href="#l21.85"></a><span id="l21.85" class="difflineplus">+        },</span>
<a href="#l21.86"></a><span id="l21.86" class="difflineplus">+        expected: []</span>
<a href="#l21.87"></a><span id="l21.87" class="difflineplus">+    }];</span>
<a href="#l21.88"></a><span id="l21.88" class="difflineplus">+</span>
<a href="#l21.89"></a><span id="l21.89" class="difflineplus">+    for (let i = 1; i &lt;= data.length; i++) {</span>
<a href="#l21.90"></a><span id="l21.90" class="difflineplus">+        let test = data[i - 1];</span>
<a href="#l21.91"></a><span id="l21.91" class="difflineplus">+        let attendees = [];</span>
<a href="#l21.92"></a><span id="l21.92" class="difflineplus">+        for (let att of test.input.attendees) {</span>
<a href="#l21.93"></a><span id="l21.93" class="difflineplus">+            let attendee = cal.createAttendee();</span>
<a href="#l21.94"></a><span id="l21.94" class="difflineplus">+            attendee.id = att.id;</span>
<a href="#l21.95"></a><span id="l21.95" class="difflineplus">+            if (att.sentBy) {</span>
<a href="#l21.96"></a><span id="l21.96" class="difflineplus">+                attendee.setProperty(&quot;SENT-BY&quot;, att.sentBy);</span>
<a href="#l21.97"></a><span id="l21.97" class="difflineplus">+            }</span>
<a href="#l21.98"></a><span id="l21.98" class="difflineplus">+            attendees.push(attendee);</span>
<a href="#l21.99"></a><span id="l21.99" class="difflineplus">+        }</span>
<a href="#l21.100"></a><span id="l21.100" class="difflineplus">+        let detected = [];</span>
<a href="#l21.101"></a><span id="l21.101" class="difflineplus">+        cal.getAttendeesBySender(attendees, test.input.sender).forEach(att =&gt; {</span>
<a href="#l21.102"></a><span id="l21.102" class="difflineplus">+            detected.push(att.id);</span>
<a href="#l21.103"></a><span id="l21.103" class="difflineplus">+        });</span>
<a href="#l21.104"></a><span id="l21.104" class="difflineplus">+        ok(detected.every(aId =&gt; test.expected.includes(aId)), &quot;(test #&quot; + i + &quot; ok1)&quot;);</span>
<a href="#l21.105"></a><span id="l21.105" class="difflineplus">+        ok(test.expected.every(aId =&gt; detected.includes(aId)), &quot;(test #&quot; + i + &quot; ok2)&quot;);</span>
<a href="#l21.106"></a><span id="l21.106" class="difflineplus">+    }</span>
<a href="#l21.107"></a><span id="l21.107" class="difflineplus">+}</span>
<a href="#l21.108"></a><span id="l21.108" class="difflineplus">+</span>
<a href="#l21.109"></a><span id="l21.109"> function getRecipientList_test() {</span>
<a href="#l21.110"></a><span id="l21.110">     let data = [{</span>
<a href="#l21.111"></a><span id="l21.111">         input: [{ id: &quot;mailto:first@example.net&quot;, cname: null },</span>
<a href="#l21.112"></a><span id="l21.112">                 { id: &quot;mailto:second@example.net&quot;, cname: null },</span>
<a href="#l21.113"></a><span id="l21.113">                 { id: &quot;mailto:third@example.net&quot;, cname: null }],</span>
<a href="#l21.114"></a><span id="l21.114">         expected: &quot;first@example.net, second@example.net, third@example.net&quot;</span>
<a href="#l21.115"></a><span id="l21.115">     }, {</span>
<a href="#l21.116"></a><span id="l21.116">         input: [{ id: &quot;mailto:first@example.net&quot;, cname: &quot;first example&quot; },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/calendar/test/unit/test_ltninvitationutils.js</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/calendar/test/unit/test_ltninvitationutils.js</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -8,19 +8,19 @@ Components.utils.import(&quot;resource:///mod</span>
<a href="#l22.4"></a><span id="l22.4"> Components.utils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l22.5"></a><span id="l22.5"> </span>
<a href="#l22.6"></a><span id="l22.6"> function run_test() {</span>
<a href="#l22.7"></a><span id="l22.7">     do_calendar_startup(run_next_test);</span>
<a href="#l22.8"></a><span id="l22.8"> }</span>
<a href="#l22.9"></a><span id="l22.9"> </span>
<a href="#l22.10"></a><span id="l22.10"> // tests for ltnInvitationUtils.jsm</span>
<a href="#l22.11"></a><span id="l22.11"> </span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-function getIcs() {</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineplus">+function getIcs(aAsArray=false) {</span>
<a href="#l22.14"></a><span id="l22.14">     // we use an unfolded ics blueprint here to make replacing of properties easier</span>
<a href="#l22.15"></a><span id="l22.15" class="difflineminus">-    return [</span>
<a href="#l22.16"></a><span id="l22.16" class="difflineplus">+    let item = [</span>
<a href="#l22.17"></a><span id="l22.17">         &quot;BEGIN:VCALENDAR&quot;,</span>
<a href="#l22.18"></a><span id="l22.18">         &quot;PRODID:-//Mozilla.org/NONSGML Mozilla Calendar V1.1//EN&quot;,</span>
<a href="#l22.19"></a><span id="l22.19">         &quot;VERSION:2.0&quot;,</span>
<a href="#l22.20"></a><span id="l22.20">         &quot;METHOD:REQUEST&quot;,</span>
<a href="#l22.21"></a><span id="l22.21">         &quot;BEGIN:VTIMEZONE&quot;,</span>
<a href="#l22.22"></a><span id="l22.22">         &quot;TZID:Europe/Berlin&quot;,</span>
<a href="#l22.23"></a><span id="l22.23">         &quot;BEGIN:DAYLIGHT&quot;,</span>
<a href="#l22.24"></a><span id="l22.24">         &quot;TZOFFSETFROM:+0100&quot;,</span>
<a href="#l22.25"></a><span id="l22.25" class="difflineat">@@ -43,96 +43,123 @@ function getIcs() {</span>
<a href="#l22.26"></a><span id="l22.26">         &quot;DTSTAMP:20150909T181048Z&quot;,</span>
<a href="#l22.27"></a><span id="l22.27">         &quot;UID:cb189fdc-ed47-4db6-a8d7-31a08802249d&quot;,</span>
<a href="#l22.28"></a><span id="l22.28">         &quot;SUMMARY:Test Event&quot;,</span>
<a href="#l22.29"></a><span id="l22.29">         &quot;ORGANIZER;RSVP=TRUE;CN=Organizer;PARTSTAT=ACCEPTED;ROLE=CHAIR:mailto:organizer@example.net&quot;,</span>
<a href="#l22.30"></a><span id="l22.30">         &quot;ATTENDEE;RSVP=TRUE;CN=Attendee;PARTSTAT=NEEDS-ACTION;ROLE=REQ-PARTICIPANT:mailto:attende&quot; +</span>
<a href="#l22.31"></a><span id="l22.31">         &quot;e@example.net&quot;,</span>
<a href="#l22.32"></a><span id="l22.32">         &quot;DTSTART;TZID=Europe/Berlin:20150909T210000&quot;,</span>
<a href="#l22.33"></a><span id="l22.33">         &quot;DTEND;TZID=Europe/Berlin:20150909T220000&quot;,</span>
<a href="#l22.34"></a><span id="l22.34" class="difflineplus">+        &quot;SEQUENCE:1&quot;,</span>
<a href="#l22.35"></a><span id="l22.35">         &quot;TRANSP:OPAQUE&quot;,</span>
<a href="#l22.36"></a><span id="l22.36">         &quot;LOCATION:Room 1&quot;,</span>
<a href="#l22.37"></a><span id="l22.37">         &quot;DESCRIPTION:Let us get together&quot;,</span>
<a href="#l22.38"></a><span id="l22.38">         &quot;URL:http://www.example.com&quot;,</span>
<a href="#l22.39"></a><span id="l22.39">         &quot;ATTACH:http://www.example.com&quot;,</span>
<a href="#l22.40"></a><span id="l22.40">         &quot;END:VEVENT&quot;,</span>
<a href="#l22.41"></a><span id="l22.41" class="difflineminus">-        &quot;END:VCALENDAR&quot;].join(&quot;\r\n&quot;);</span>
<a href="#l22.42"></a><span id="l22.42" class="difflineplus">+        &quot;END:VCALENDAR&quot;];</span>
<a href="#l22.43"></a><span id="l22.43" class="difflineplus">+    if (!aAsArray) {</span>
<a href="#l22.44"></a><span id="l22.44" class="difflineplus">+        item = item.join(&quot;\r\n&quot;);</span>
<a href="#l22.45"></a><span id="l22.45" class="difflineplus">+    }</span>
<a href="#l22.46"></a><span id="l22.46" class="difflineplus">+    return item;</span>
<a href="#l22.47"></a><span id="l22.47"> }</span>
<a href="#l22.48"></a><span id="l22.48"> </span>
<a href="#l22.49"></a><span id="l22.49"> add_task(function* getItipHeader_test() {</span>
<a href="#l22.50"></a><span id="l22.50">     let data = [{</span>
<a href="#l22.51"></a><span id="l22.51">         input: {</span>
<a href="#l22.52"></a><span id="l22.52">             method: &quot;METHOD:REQUEST\r\n&quot;,</span>
<a href="#l22.53"></a><span id="l22.53" class="difflineminus">-            attendee: null</span>
<a href="#l22.54"></a><span id="l22.54" class="difflineplus">+            attendees: [null]</span>
<a href="#l22.55"></a><span id="l22.55">         },</span>
<a href="#l22.56"></a><span id="l22.56">         expected: &quot;Organizer has invited you to Test Event&quot;</span>
<a href="#l22.57"></a><span id="l22.57">     }, {</span>
<a href="#l22.58"></a><span id="l22.58">         input: {</span>
<a href="#l22.59"></a><span id="l22.59">             method: &quot;METHOD:CANCEL\r\n&quot;,</span>
<a href="#l22.60"></a><span id="l22.60" class="difflineminus">-            attendee: null</span>
<a href="#l22.61"></a><span id="l22.61" class="difflineplus">+            attendees: [null]</span>
<a href="#l22.62"></a><span id="l22.62" class="difflineplus">+        },</span>
<a href="#l22.63"></a><span id="l22.63" class="difflineplus">+        expected: &quot;Organizer has canceled this event: Test Event&quot;</span>
<a href="#l22.64"></a><span id="l22.64" class="difflineplus">+    }, {</span>
<a href="#l22.65"></a><span id="l22.65" class="difflineplus">+        input: {</span>
<a href="#l22.66"></a><span id="l22.66" class="difflineplus">+            method: &quot;METHOD:DECLINECOUNTER\r\n&quot;,</span>
<a href="#l22.67"></a><span id="l22.67" class="difflineplus">+            attendees: [&quot;ATTENDEE;RSVP=TRUE;CN=Attendee1;PARTSTAT=ACCEPTED;&quot; +</span>
<a href="#l22.68"></a><span id="l22.68" class="difflineplus">+                        &quot;ROLE=REQ-PARTICIPANT:mailto:attendee1@example.net&quot;]</span>
<a href="#l22.69"></a><span id="l22.69">         },</span>
<a href="#l22.70"></a><span id="l22.70" class="difflineminus">-        expected: &quot;Organizer has canceled this event: « Test Event »&quot;</span>
<a href="#l22.71"></a><span id="l22.71" class="difflineplus">+        expected: &quot;Organizer has declined your counterproposal for \&quot;Test Event\&quot;.&quot;</span>
<a href="#l22.72"></a><span id="l22.72" class="difflineplus">+    }, {</span>
<a href="#l22.73"></a><span id="l22.73" class="difflineplus">+        input: {</span>
<a href="#l22.74"></a><span id="l22.74" class="difflineplus">+            method: &quot;METHOD:COUNTER\r\n&quot;,</span>
<a href="#l22.75"></a><span id="l22.75" class="difflineplus">+            attendees: [&quot;ATTENDEE;RSVP=TRUE;CN=Attendee1;PARTSTAT=DECLINED;&quot; +</span>
<a href="#l22.76"></a><span id="l22.76" class="difflineplus">+                        &quot;ROLE=REQ-PARTICIPANT:mailto:attendee1@example.net&quot;]</span>
<a href="#l22.77"></a><span id="l22.77" class="difflineplus">+        },</span>
<a href="#l22.78"></a><span id="l22.78" class="difflineplus">+        expected: &quot;Attendee1 &lt;attendee1@example.net&gt; has made a counterproposal for \&quot;Test Event\&quot;:&quot;</span>
<a href="#l22.79"></a><span id="l22.79">     }, {</span>
<a href="#l22.80"></a><span id="l22.80">         input: {</span>
<a href="#l22.81"></a><span id="l22.81">             method: &quot;METHOD:REPLY\r\n&quot;,</span>
<a href="#l22.82"></a><span id="l22.82" class="difflineminus">-            attendee: &quot;ATTENDEE;RSVP=TRUE;CN=Attendee1;PARTSTAT=ACCEPTED;&quot; +</span>
<a href="#l22.83"></a><span id="l22.83" class="difflineminus">-                      &quot;ROLE=REQ-PARTICIPANT:mailto:attendee1@example.net&quot;</span>
<a href="#l22.84"></a><span id="l22.84" class="difflineplus">+            attendees: [&quot;ATTENDEE;RSVP=TRUE;CN=Attendee1;PARTSTAT=ACCEPTED;&quot; +</span>
<a href="#l22.85"></a><span id="l22.85" class="difflineplus">+                        &quot;ROLE=REQ-PARTICIPANT:mailto:attendee1@example.net&quot;]</span>
<a href="#l22.86"></a><span id="l22.86">         },</span>
<a href="#l22.87"></a><span id="l22.87">         expected: &quot;Attendee1 &lt;attendee1@example.net&gt; has accepted your event invitation.&quot;</span>
<a href="#l22.88"></a><span id="l22.88">     }, {</span>
<a href="#l22.89"></a><span id="l22.89">         input: {</span>
<a href="#l22.90"></a><span id="l22.90">             method: &quot;METHOD:REPLY\r\n&quot;,</span>
<a href="#l22.91"></a><span id="l22.91" class="difflineminus">-            attendee: &quot;ATTENDEE;RSVP=TRUE;CN=Attendee1;PARTSTAT=TENTATIVE;&quot; +</span>
<a href="#l22.92"></a><span id="l22.92" class="difflineminus">-                      &quot;ROLE=REQ-PARTICIPANT:mailto:attendee1@example.net&quot;</span>
<a href="#l22.93"></a><span id="l22.93" class="difflineplus">+            attendees: [&quot;ATTENDEE;RSVP=TRUE;CN=Attendee1;PARTSTAT=TENTATIVE;&quot; +</span>
<a href="#l22.94"></a><span id="l22.94" class="difflineplus">+                        &quot;ROLE=REQ-PARTICIPANT:mailto:attendee1@example.net&quot;]</span>
<a href="#l22.95"></a><span id="l22.95">         },</span>
<a href="#l22.96"></a><span id="l22.96">         expected: &quot;Attendee1 &lt;attendee1@example.net&gt; has accepted your event invitation.&quot;</span>
<a href="#l22.97"></a><span id="l22.97">     }, {</span>
<a href="#l22.98"></a><span id="l22.98">         input: {</span>
<a href="#l22.99"></a><span id="l22.99">             method: &quot;METHOD:REPLY\r\n&quot;,</span>
<a href="#l22.100"></a><span id="l22.100" class="difflineminus">-            attendee: &quot;ATTENDEE;RSVP=TRUE;CN=Attendee1;PARTSTAT=DECLINED;&quot; +</span>
<a href="#l22.101"></a><span id="l22.101" class="difflineminus">-                      &quot;ROLE=REQ-PARTICIPANT:mailto:attendee1@example.net&quot;</span>
<a href="#l22.102"></a><span id="l22.102" class="difflineplus">+            attendees: [&quot;ATTENDEE;RSVP=TRUE;CN=Attendee1;PARTSTAT=DECLINED;&quot; +</span>
<a href="#l22.103"></a><span id="l22.103" class="difflineplus">+                        &quot;ROLE=REQ-PARTICIPANT:mailto:attendee1@example.net&quot;]</span>
<a href="#l22.104"></a><span id="l22.104">         },</span>
<a href="#l22.105"></a><span id="l22.105">         expected: &quot;Attendee1 &lt;attendee1@example.net&gt; has declined your event invitation.&quot;</span>
<a href="#l22.106"></a><span id="l22.106">     }, {</span>
<a href="#l22.107"></a><span id="l22.107">         input: {</span>
<a href="#l22.108"></a><span id="l22.108">             method: &quot;METHOD:REPLY\r\n&quot;,</span>
<a href="#l22.109"></a><span id="l22.109" class="difflineminus">-            attendee: [&quot;ATTENDEE;RSVP=TRUE;CN=Attendee1;PARTSTAT=ACCEPTED;&quot; +</span>
<a href="#l22.110"></a><span id="l22.110" class="difflineminus">-                       &quot;ROLE=REQ-PARTICIPANT:mailto:attendee1@example.net&quot;,</span>
<a href="#l22.111"></a><span id="l22.111" class="difflineminus">-                       &quot;ATTENDEE;RSVP=TRUE;CN=Attendee2;PARTSTAT=DECLINED;&quot; +</span>
<a href="#l22.112"></a><span id="l22.112" class="difflineminus">-                       &quot;ROLE=REQ-PARTICIPANT:mailto:attendee2@example.net&quot;].join(&quot;\r\n&quot;)</span>
<a href="#l22.113"></a><span id="l22.113" class="difflineplus">+            attendees: [&quot;ATTENDEE;RSVP=TRUE;CN=Attendee1;PARTSTAT=ACCEPTED;&quot; +</span>
<a href="#l22.114"></a><span id="l22.114" class="difflineplus">+                        &quot;ROLE=REQ-PARTICIPANT:mailto:attendee1@example.net&quot;,</span>
<a href="#l22.115"></a><span id="l22.115" class="difflineplus">+                        &quot;ATTENDEE;RSVP=TRUE;CN=Attendee2;PARTSTAT=DECLINED;&quot; +</span>
<a href="#l22.116"></a><span id="l22.116" class="difflineplus">+                        &quot;ROLE=REQ-PARTICIPANT:mailto:attendee2@example.net&quot;]</span>
<a href="#l22.117"></a><span id="l22.117">         },</span>
<a href="#l22.118"></a><span id="l22.118">         expected: &quot;Attendee1 &lt;attendee1@example.net&gt; has accepted your event invitation.&quot;</span>
<a href="#l22.119"></a><span id="l22.119">     }, {</span>
<a href="#l22.120"></a><span id="l22.120">         input: {</span>
<a href="#l22.121"></a><span id="l22.121">             method: &quot;METHOD:UNSUPPORTED\r\n&quot;,</span>
<a href="#l22.122"></a><span id="l22.122" class="difflineminus">-            attendee: null</span>
<a href="#l22.123"></a><span id="l22.123" class="difflineplus">+            attendees: [null]</span>
<a href="#l22.124"></a><span id="l22.124">         },</span>
<a href="#l22.125"></a><span id="l22.125">         expected: &quot;Event Invitation&quot;</span>
<a href="#l22.126"></a><span id="l22.126">     }, {</span>
<a href="#l22.127"></a><span id="l22.127">         input: {</span>
<a href="#l22.128"></a><span id="l22.128">             method: &quot;&quot;,</span>
<a href="#l22.129"></a><span id="l22.129" class="difflineminus">-            attendee: &quot;&quot;</span>
<a href="#l22.130"></a><span id="l22.130" class="difflineplus">+            attendees: [&quot;&quot;]</span>
<a href="#l22.131"></a><span id="l22.131">         },</span>
<a href="#l22.132"></a><span id="l22.132">         expected: &quot;Event Invitation&quot;</span>
<a href="#l22.133"></a><span id="l22.133">     }];</span>
<a href="#l22.134"></a><span id="l22.134">     let i = 0;</span>
<a href="#l22.135"></a><span id="l22.135">     for (let test of data) {</span>
<a href="#l22.136"></a><span id="l22.136">         i++;</span>
<a href="#l22.137"></a><span id="l22.137">         let itipItem = Components.classes[&quot;@mozilla.org/calendar/itip-item;1&quot;]</span>
<a href="#l22.138"></a><span id="l22.138">                                  .createInstance(Components.interfaces.calIItipItem);</span>
<a href="#l22.139"></a><span id="l22.139">         let item = getIcs();</span>
<a href="#l22.140"></a><span id="l22.140" class="difflineplus">+        let sender;</span>
<a href="#l22.141"></a><span id="l22.141">         if (test.input.method || test.input.method == &quot;&quot;) {</span>
<a href="#l22.142"></a><span id="l22.142">             item = item.replace(/METHOD:REQUEST\r\n/, test.input.method);</span>
<a href="#l22.143"></a><span id="l22.143">         }</span>
<a href="#l22.144"></a><span id="l22.144" class="difflineminus">-        if (test.input.attendee || test.input.attendee == &quot;&quot;) {</span>
<a href="#l22.145"></a><span id="l22.145" class="difflineminus">-            item = item.replace(/(ATTENDEE.+(?:\r\n))/, test.input.attendee + &quot;\r\n&quot;);</span>
<a href="#l22.146"></a><span id="l22.146" class="difflineplus">+        if (test.input.attendees.length) {</span>
<a href="#l22.147"></a><span id="l22.147" class="difflineplus">+            let attendees = test.input.attendees.filter(aAtt =&gt; !!aAtt).join(&quot;\r\n&quot;);</span>
<a href="#l22.148"></a><span id="l22.148" class="difflineplus">+            item = item.replace(/(ATTENDEE.+(?:\r\n))/, attendees + &quot;\r\n&quot;);</span>
<a href="#l22.149"></a><span id="l22.149" class="difflineplus">+            if (test.input.attendees[0]) {</span>
<a href="#l22.150"></a><span id="l22.150" class="difflineplus">+                sender = cal.createAttendee();</span>
<a href="#l22.151"></a><span id="l22.151" class="difflineplus">+                sender.icalString = test.input.attendees[0];</span>
<a href="#l22.152"></a><span id="l22.152" class="difflineplus">+            }</span>
<a href="#l22.153"></a><span id="l22.153">         }</span>
<a href="#l22.154"></a><span id="l22.154">         itipItem.init(item);</span>
<a href="#l22.155"></a><span id="l22.155" class="difflineminus">-        equal(ltn.invitation.getItipHeader(itipItem), test.expected,</span>
<a href="#l22.156"></a><span id="l22.156" class="difflineminus">-              &quot;(test #&quot; + i + &quot;)&quot;);</span>
<a href="#l22.157"></a><span id="l22.157" class="difflineplus">+        if (sender) {</span>
<a href="#l22.158"></a><span id="l22.158" class="difflineplus">+            itipItem.sender = sender.id;</span>
<a href="#l22.159"></a><span id="l22.159" class="difflineplus">+        }</span>
<a href="#l22.160"></a><span id="l22.160" class="difflineplus">+        equal(ltn.invitation.getItipHeader(itipItem), test.expected, &quot;(test #&quot; + i + &quot;)&quot;);</span>
<a href="#l22.161"></a><span id="l22.161">     }</span>
<a href="#l22.162"></a><span id="l22.162"> });</span>
<a href="#l22.163"></a><span id="l22.163"> </span>
<a href="#l22.164"></a><span id="l22.164"> add_task(function* createInvitationOverlay_test() {</span>
<a href="#l22.165"></a><span id="l22.165">     let data = [{</span>
<a href="#l22.166"></a><span id="l22.166">         input: { description: &quot;DESCRIPTION:Go to https://www.example.net if you can.\r\n&quot; },</span>
<a href="#l22.167"></a><span id="l22.167">         expected: {</span>
<a href="#l22.168"></a><span id="l22.168">             node: &quot;imipHtml-description-content&quot;,</span>
<a href="#l22.169"></a><span id="l22.169" class="difflineat">@@ -767,8 +794,340 @@ add_task(function* getRfc5322FormattedDa</span>
<a href="#l22.170"></a><span id="l22.170">             Preferences.reset(&quot;calendar.timezone.local&quot;);</span>
<a href="#l22.171"></a><span id="l22.171">         }</span>
<a href="#l22.172"></a><span id="l22.172">         let date = test.date ? new Date(test.date) : null;</span>
<a href="#l22.173"></a><span id="l22.173">         let re = new RegExp(data.expected);</span>
<a href="#l22.174"></a><span id="l22.174">         ok(re.test(ltn.invitation.getRfc5322FormattedDate(date)), &quot;(test #&quot; + i + &quot;)&quot;);</span>
<a href="#l22.175"></a><span id="l22.175">     }</span>
<a href="#l22.176"></a><span id="l22.176">     Preferences.set(&quot;calendar.timezone.local&quot;, timezone);</span>
<a href="#l22.177"></a><span id="l22.177"> });</span>
<a href="#l22.178"></a><span id="l22.178" class="difflineplus">+</span>
<a href="#l22.179"></a><span id="l22.179" class="difflineplus">+add_task(function* parseCounter_test() {</span>
<a href="#l22.180"></a><span id="l22.180" class="difflineplus">+    let data = [{</span>
<a href="#l22.181"></a><span id="l22.181" class="difflineplus">+        // #1: basic test to check all currently supported properties</span>
<a href="#l22.182"></a><span id="l22.182" class="difflineplus">+        input: {</span>
<a href="#l22.183"></a><span id="l22.183" class="difflineplus">+            existing: [],</span>
<a href="#l22.184"></a><span id="l22.184" class="difflineplus">+            proposed: [</span>
<a href="#l22.185"></a><span id="l22.185" class="difflineplus">+                {</span>
<a href="#l22.186"></a><span id="l22.186" class="difflineplus">+                    method: &quot;METHOD:COUNTER&quot;</span>
<a href="#l22.187"></a><span id="l22.187" class="difflineplus">+                }, {</span>
<a href="#l22.188"></a><span id="l22.188" class="difflineplus">+                    dtStart: &quot;DTSTART;TZID=Europe/Berlin:20150910T210000&quot;</span>
<a href="#l22.189"></a><span id="l22.189" class="difflineplus">+                }, {</span>
<a href="#l22.190"></a><span id="l22.190" class="difflineplus">+                    dtEnd: &quot;DTEND;TZID=Europe/Berlin:20150910T220000&quot;</span>
<a href="#l22.191"></a><span id="l22.191" class="difflineplus">+                }, {</span>
<a href="#l22.192"></a><span id="l22.192" class="difflineplus">+                    location: &quot;LOCATION:Room 2&quot;</span>
<a href="#l22.193"></a><span id="l22.193" class="difflineplus">+                }, {</span>
<a href="#l22.194"></a><span id="l22.194" class="difflineplus">+                    summary: &quot;SUMMARY:Test Event 2&quot;</span>
<a href="#l22.195"></a><span id="l22.195" class="difflineplus">+                }, {</span>
<a href="#l22.196"></a><span id="l22.196" class="difflineplus">+                    attendee: &quot;ATTENDEE;CN=Attendee;PARTSTAT=DECLINED;ROLE=REQ-PARTICIPANT:&quot; +</span>
<a href="#l22.197"></a><span id="l22.197" class="difflineplus">+                              &quot;mailto:attendee@example.net&quot;</span>
<a href="#l22.198"></a><span id="l22.198" class="difflineplus">+                }, {</span>
<a href="#l22.199"></a><span id="l22.199" class="difflineplus">+                    dtStamp: &quot;DTSTAMP:20150909T182048Z&quot;</span>
<a href="#l22.200"></a><span id="l22.200" class="difflineplus">+                }, {</span>
<a href="#l22.201"></a><span id="l22.201" class="difflineplus">+                    attach: &quot;COMMENT:Sorry\, I cannot make it that time.&quot;</span>
<a href="#l22.202"></a><span id="l22.202" class="difflineplus">+                }</span>
<a href="#l22.203"></a><span id="l22.203" class="difflineplus">+            ]</span>
<a href="#l22.204"></a><span id="l22.204" class="difflineplus">+        },</span>
<a href="#l22.205"></a><span id="l22.205" class="difflineplus">+        expected: {</span>
<a href="#l22.206"></a><span id="l22.206" class="difflineplus">+            result: { descr: &quot;&quot;, type: &quot;OK&quot; },</span>
<a href="#l22.207"></a><span id="l22.207" class="difflineplus">+            differences: [{</span>
<a href="#l22.208"></a><span id="l22.208" class="difflineplus">+                property: &quot;SUMMARY&quot;,</span>
<a href="#l22.209"></a><span id="l22.209" class="difflineplus">+                proposed: &quot;Test Event 2&quot;,</span>
<a href="#l22.210"></a><span id="l22.210" class="difflineplus">+                original: &quot;Test Event&quot;</span>
<a href="#l22.211"></a><span id="l22.211" class="difflineplus">+            }, {</span>
<a href="#l22.212"></a><span id="l22.212" class="difflineplus">+                property: &quot;LOCATION&quot;,</span>
<a href="#l22.213"></a><span id="l22.213" class="difflineplus">+                proposed: &quot;Room 2&quot;,</span>
<a href="#l22.214"></a><span id="l22.214" class="difflineplus">+                original: &quot;Room 1&quot;</span>
<a href="#l22.215"></a><span id="l22.215" class="difflineplus">+            }, {</span>
<a href="#l22.216"></a><span id="l22.216" class="difflineplus">+                property: &quot;DTSTART&quot;,</span>
<a href="#l22.217"></a><span id="l22.217" class="difflineplus">+                proposed: [&quot;Thursday, September 10, 2015 9:00 PM Europe/Berlin&quot;, // Automation Win</span>
<a href="#l22.218"></a><span id="l22.218" class="difflineplus">+                           &quot;Thu 10 Sep 2015 9:00 PM Europe/Berlin&quot;, // Automation OSX</span>
<a href="#l22.219"></a><span id="l22.219" class="difflineplus">+                           &quot;Thu 10 Sep 2015 09:00 PM Europe/Berlin&quot;, // Automation Linux</span>
<a href="#l22.220"></a><span id="l22.220" class="difflineplus">+                           &quot;Thu 10 Sep 2015 21:00 Europe/Berlin&quot;], // Local Win 24h</span>
<a href="#l22.221"></a><span id="l22.221" class="difflineplus">+                original: [&quot;Wednesday, September 09, 2015 9:00 PM Europe/Berlin&quot;,</span>
<a href="#l22.222"></a><span id="l22.222" class="difflineplus">+                           &quot;Wed 9 Sep 2015 9:00 PM Europe/Berlin&quot;,</span>
<a href="#l22.223"></a><span id="l22.223" class="difflineplus">+                           &quot;Wed 9 Sep 2015 09:00 PM Europe/Berlin&quot;,</span>
<a href="#l22.224"></a><span id="l22.224" class="difflineplus">+                           &quot;Wed 9 Sep 2015 21:00 Europe/Berlin&quot;]</span>
<a href="#l22.225"></a><span id="l22.225" class="difflineplus">+            }, {</span>
<a href="#l22.226"></a><span id="l22.226" class="difflineplus">+                property: &quot;DTEND&quot;,</span>
<a href="#l22.227"></a><span id="l22.227" class="difflineplus">+                proposed: [&quot;Thursday, September 10, 2015 10:00 PM Europe/Berlin&quot;,</span>
<a href="#l22.228"></a><span id="l22.228" class="difflineplus">+                           &quot;Thu 10 Sep 2015 10:00 PM Europe/Berlin&quot;,</span>
<a href="#l22.229"></a><span id="l22.229" class="difflineplus">+                           &quot;Thu 10 Sep 2015 22:00 Europe/Berlin&quot;],</span>
<a href="#l22.230"></a><span id="l22.230" class="difflineplus">+                original: [&quot;Wednesday, September 09, 2015 10:00 PM Europe/Berlin&quot;,</span>
<a href="#l22.231"></a><span id="l22.231" class="difflineplus">+                           &quot;Wed 9 Sep 2015 10:00 PM Europe/Berlin&quot;,</span>
<a href="#l22.232"></a><span id="l22.232" class="difflineplus">+                           &quot;Wed 9 Sep 2015 22:00 Europe/Berlin&quot;]</span>
<a href="#l22.233"></a><span id="l22.233" class="difflineplus">+            }, {</span>
<a href="#l22.234"></a><span id="l22.234" class="difflineplus">+                property: &quot;COMMENT&quot;,</span>
<a href="#l22.235"></a><span id="l22.235" class="difflineplus">+                proposed: &quot;Sorry\, I cannot make it that time.&quot;,</span>
<a href="#l22.236"></a><span id="l22.236" class="difflineplus">+                original: null</span>
<a href="#l22.237"></a><span id="l22.237" class="difflineplus">+            }]</span>
<a href="#l22.238"></a><span id="l22.238" class="difflineplus">+        }</span>
<a href="#l22.239"></a><span id="l22.239" class="difflineplus">+    }, {</span>
<a href="#l22.240"></a><span id="l22.240" class="difflineplus">+        // #2: test with an unsupported property has been changed</span>
<a href="#l22.241"></a><span id="l22.241" class="difflineplus">+        input: {</span>
<a href="#l22.242"></a><span id="l22.242" class="difflineplus">+            existing: [],</span>
<a href="#l22.243"></a><span id="l22.243" class="difflineplus">+            proposed: [</span>
<a href="#l22.244"></a><span id="l22.244" class="difflineplus">+                {</span>
<a href="#l22.245"></a><span id="l22.245" class="difflineplus">+                    method: &quot;METHOD:COUNTER&quot;</span>
<a href="#l22.246"></a><span id="l22.246" class="difflineplus">+                }, {</span>
<a href="#l22.247"></a><span id="l22.247" class="difflineplus">+                    attendee: &quot;ATTENDEE;CN=Attendee;PARTSTAT=NEEDS-ACTION;ROLE=REQ-PARTICIPANT:&quot; +</span>
<a href="#l22.248"></a><span id="l22.248" class="difflineplus">+                              &quot;mailto:attendee@example.net&quot;</span>
<a href="#l22.249"></a><span id="l22.249" class="difflineplus">+                }, {</span>
<a href="#l22.250"></a><span id="l22.250" class="difflineplus">+                    location: &quot;LOCATION:Room 2&quot;</span>
<a href="#l22.251"></a><span id="l22.251" class="difflineplus">+                }, {</span>
<a href="#l22.252"></a><span id="l22.252" class="difflineplus">+                    attach: &quot;ATTACH:http://www.example2.com&quot;</span>
<a href="#l22.253"></a><span id="l22.253" class="difflineplus">+                } ,{</span>
<a href="#l22.254"></a><span id="l22.254" class="difflineplus">+                    dtStamp: &quot;DTSTAMP:20150909T182048Z&quot;</span>
<a href="#l22.255"></a><span id="l22.255" class="difflineplus">+                }]</span>
<a href="#l22.256"></a><span id="l22.256" class="difflineplus">+        },</span>
<a href="#l22.257"></a><span id="l22.257" class="difflineplus">+        expected: {</span>
<a href="#l22.258"></a><span id="l22.258" class="difflineplus">+            result: { descr: &quot;&quot;, type: &quot;OK&quot; },</span>
<a href="#l22.259"></a><span id="l22.259" class="difflineplus">+            differences: [{ property: &quot;LOCATION&quot;, proposed: &quot;Room 2&quot;, original: &quot;Room 1&quot; }]</span>
<a href="#l22.260"></a><span id="l22.260" class="difflineplus">+        }</span>
<a href="#l22.261"></a><span id="l22.261" class="difflineplus">+    }, {</span>
<a href="#l22.262"></a><span id="l22.262" class="difflineplus">+        // #3: proposed change not based on the latest update of the invitation</span>
<a href="#l22.263"></a><span id="l22.263" class="difflineplus">+        input: {</span>
<a href="#l22.264"></a><span id="l22.264" class="difflineplus">+            existing: [],</span>
<a href="#l22.265"></a><span id="l22.265" class="difflineplus">+            proposed: [</span>
<a href="#l22.266"></a><span id="l22.266" class="difflineplus">+                {</span>
<a href="#l22.267"></a><span id="l22.267" class="difflineplus">+                    method: &quot;METHOD:COUNTER&quot;</span>
<a href="#l22.268"></a><span id="l22.268" class="difflineplus">+                }, {</span>
<a href="#l22.269"></a><span id="l22.269" class="difflineplus">+                    attendee: &quot;ATTENDEE;CN=Attendee;PARTSTAT=NEEDS-ACTION;ROLE=REQ-PARTICIPANT:&quot; +</span>
<a href="#l22.270"></a><span id="l22.270" class="difflineplus">+                              &quot;mailto:attendee@example.net&quot;</span>
<a href="#l22.271"></a><span id="l22.271" class="difflineplus">+                }, {</span>
<a href="#l22.272"></a><span id="l22.272" class="difflineplus">+                    location: &quot;LOCATION:Room 2&quot;</span>
<a href="#l22.273"></a><span id="l22.273" class="difflineplus">+                }, {</span>
<a href="#l22.274"></a><span id="l22.274" class="difflineplus">+                    dtStamp: &quot;DTSTAMP:20150909T171048Z&quot;</span>
<a href="#l22.275"></a><span id="l22.275" class="difflineplus">+                }</span>
<a href="#l22.276"></a><span id="l22.276" class="difflineplus">+            ]</span>
<a href="#l22.277"></a><span id="l22.277" class="difflineplus">+        },</span>
<a href="#l22.278"></a><span id="l22.278" class="difflineplus">+        expected: {</span>
<a href="#l22.279"></a><span id="l22.279" class="difflineplus">+            result: {</span>
<a href="#l22.280"></a><span id="l22.280" class="difflineplus">+                descr: &quot;This is a counterproposal not based on the latest event update.&quot;,</span>
<a href="#l22.281"></a><span id="l22.281" class="difflineplus">+                type: &quot;NOTLATESTUPDATE&quot;</span>
<a href="#l22.282"></a><span id="l22.282" class="difflineplus">+            },</span>
<a href="#l22.283"></a><span id="l22.283" class="difflineplus">+            differences: [{ property: &quot;LOCATION&quot;, proposed: &quot;Room 2&quot;, original: &quot;Room 1&quot; }]</span>
<a href="#l22.284"></a><span id="l22.284" class="difflineplus">+        }</span>
<a href="#l22.285"></a><span id="l22.285" class="difflineplus">+    }, {</span>
<a href="#l22.286"></a><span id="l22.286" class="difflineplus">+        // #4: proposed change based on a meanwhile reschuled invitation</span>
<a href="#l22.287"></a><span id="l22.287" class="difflineplus">+        input: {</span>
<a href="#l22.288"></a><span id="l22.288" class="difflineplus">+            existing: [],</span>
<a href="#l22.289"></a><span id="l22.289" class="difflineplus">+            proposed: [</span>
<a href="#l22.290"></a><span id="l22.290" class="difflineplus">+                {</span>
<a href="#l22.291"></a><span id="l22.291" class="difflineplus">+                    method: &quot;METHOD:COUNTER&quot;</span>
<a href="#l22.292"></a><span id="l22.292" class="difflineplus">+                }, {</span>
<a href="#l22.293"></a><span id="l22.293" class="difflineplus">+                    attendee: &quot;ATTENDEE;CN=Attendee;PARTSTAT=NEEDS-ACTION;ROLE=REQ-PARTICIPANT:&quot; +</span>
<a href="#l22.294"></a><span id="l22.294" class="difflineplus">+                              &quot;mailto:attendee@example.net&quot;</span>
<a href="#l22.295"></a><span id="l22.295" class="difflineplus">+                }, {</span>
<a href="#l22.296"></a><span id="l22.296" class="difflineplus">+                    location: &quot;LOCATION:Room 2&quot;</span>
<a href="#l22.297"></a><span id="l22.297" class="difflineplus">+                }, {</span>
<a href="#l22.298"></a><span id="l22.298" class="difflineplus">+                    sequence: &quot;SEQUENCE:0&quot;</span>
<a href="#l22.299"></a><span id="l22.299" class="difflineplus">+                }, {</span>
<a href="#l22.300"></a><span id="l22.300" class="difflineplus">+                    dtStamp: &quot;DTSTAMP:20150909T182048Z&quot;</span>
<a href="#l22.301"></a><span id="l22.301" class="difflineplus">+                }</span>
<a href="#l22.302"></a><span id="l22.302" class="difflineplus">+            ]</span>
<a href="#l22.303"></a><span id="l22.303" class="difflineplus">+        },</span>
<a href="#l22.304"></a><span id="l22.304" class="difflineplus">+        expected: {</span>
<a href="#l22.305"></a><span id="l22.305" class="difflineplus">+            result: {</span>
<a href="#l22.306"></a><span id="l22.306" class="difflineplus">+                descr: &quot;This is a counterproposal to an already rescheduled event.&quot;,</span>
<a href="#l22.307"></a><span id="l22.307" class="difflineplus">+                type: &quot;OUTDATED&quot;</span>
<a href="#l22.308"></a><span id="l22.308" class="difflineplus">+            },</span>
<a href="#l22.309"></a><span id="l22.309" class="difflineplus">+            differences: [{ property: &quot;LOCATION&quot;, proposed: &quot;Room 2&quot;, original: &quot;Room 1&quot; }]</span>
<a href="#l22.310"></a><span id="l22.310" class="difflineplus">+        }</span>
<a href="#l22.311"></a><span id="l22.311" class="difflineplus">+    }, {</span>
<a href="#l22.312"></a><span id="l22.312" class="difflineplus">+        // #5: proposed change for an later sequence of the event</span>
<a href="#l22.313"></a><span id="l22.313" class="difflineplus">+        input: {</span>
<a href="#l22.314"></a><span id="l22.314" class="difflineplus">+            existing: [],</span>
<a href="#l22.315"></a><span id="l22.315" class="difflineplus">+            proposed: [</span>
<a href="#l22.316"></a><span id="l22.316" class="difflineplus">+                {</span>
<a href="#l22.317"></a><span id="l22.317" class="difflineplus">+                    method: &quot;METHOD:COUNTER&quot;</span>
<a href="#l22.318"></a><span id="l22.318" class="difflineplus">+                }, {</span>
<a href="#l22.319"></a><span id="l22.319" class="difflineplus">+                    attendee: &quot;ATTENDEE;CN=Attendee;PARTSTAT=NEEDS-ACTION;ROLE=REQ-PARTICIPANT:&quot; +</span>
<a href="#l22.320"></a><span id="l22.320" class="difflineplus">+                              &quot;mailto:attendee@example.net&quot;</span>
<a href="#l22.321"></a><span id="l22.321" class="difflineplus">+                }, {</span>
<a href="#l22.322"></a><span id="l22.322" class="difflineplus">+                    location: &quot;LOCATION:Room 2&quot;</span>
<a href="#l22.323"></a><span id="l22.323" class="difflineplus">+                }, {</span>
<a href="#l22.324"></a><span id="l22.324" class="difflineplus">+                    sequence: &quot;SEQUENCE:2&quot;</span>
<a href="#l22.325"></a><span id="l22.325" class="difflineplus">+                }, {</span>
<a href="#l22.326"></a><span id="l22.326" class="difflineplus">+                    dtStamp: &quot;DTSTAMP:20150909T182048Z&quot;</span>
<a href="#l22.327"></a><span id="l22.327" class="difflineplus">+                }</span>
<a href="#l22.328"></a><span id="l22.328" class="difflineplus">+            ]</span>
<a href="#l22.329"></a><span id="l22.329" class="difflineplus">+        },</span>
<a href="#l22.330"></a><span id="l22.330" class="difflineplus">+        expected: {</span>
<a href="#l22.331"></a><span id="l22.331" class="difflineplus">+            result: {</span>
<a href="#l22.332"></a><span id="l22.332" class="difflineplus">+                descr: &quot;Invalid sequence number in counterproposal.&quot;,</span>
<a href="#l22.333"></a><span id="l22.333" class="difflineplus">+                type: &quot;ERROR&quot;</span>
<a href="#l22.334"></a><span id="l22.334" class="difflineplus">+            },</span>
<a href="#l22.335"></a><span id="l22.335" class="difflineplus">+            differences: []</span>
<a href="#l22.336"></a><span id="l22.336" class="difflineplus">+        }</span>
<a href="#l22.337"></a><span id="l22.337" class="difflineplus">+    }, {</span>
<a href="#l22.338"></a><span id="l22.338" class="difflineplus">+        // #6: proposal to a different event</span>
<a href="#l22.339"></a><span id="l22.339" class="difflineplus">+        input: {</span>
<a href="#l22.340"></a><span id="l22.340" class="difflineplus">+            existing: [],</span>
<a href="#l22.341"></a><span id="l22.341" class="difflineplus">+            proposed: [</span>
<a href="#l22.342"></a><span id="l22.342" class="difflineplus">+                {</span>
<a href="#l22.343"></a><span id="l22.343" class="difflineplus">+                    method: &quot;METHOD:COUNTER&quot;</span>
<a href="#l22.344"></a><span id="l22.344" class="difflineplus">+                }, {</span>
<a href="#l22.345"></a><span id="l22.345" class="difflineplus">+                    uid: &quot;UID:cb189fdc-0000-0000-0000-31a08802249d&quot;</span>
<a href="#l22.346"></a><span id="l22.346" class="difflineplus">+                }, {</span>
<a href="#l22.347"></a><span id="l22.347" class="difflineplus">+                    attendee: &quot;ATTENDEE;CN=Attendee;PARTSTAT=NEEDS-ACTION;ROLE=REQ-PARTICIPANT:&quot; +</span>
<a href="#l22.348"></a><span id="l22.348" class="difflineplus">+                              &quot;mailto:attendee@example.net&quot;</span>
<a href="#l22.349"></a><span id="l22.349" class="difflineplus">+                }, {</span>
<a href="#l22.350"></a><span id="l22.350" class="difflineplus">+                    location: &quot;LOCATION:Room 2&quot;</span>
<a href="#l22.351"></a><span id="l22.351" class="difflineplus">+                }, {</span>
<a href="#l22.352"></a><span id="l22.352" class="difflineplus">+                    dtStamp: &quot;DTSTAMP:20150909T182048Z&quot;</span>
<a href="#l22.353"></a><span id="l22.353" class="difflineplus">+                }</span>
<a href="#l22.354"></a><span id="l22.354" class="difflineplus">+            ]</span>
<a href="#l22.355"></a><span id="l22.355" class="difflineplus">+        },</span>
<a href="#l22.356"></a><span id="l22.356" class="difflineplus">+        expected: {</span>
<a href="#l22.357"></a><span id="l22.357" class="difflineplus">+            result: {</span>
<a href="#l22.358"></a><span id="l22.358" class="difflineplus">+                descr: &quot;Mismatch of uid or organizer in counterproposal.&quot;,</span>
<a href="#l22.359"></a><span id="l22.359" class="difflineplus">+                type: &quot;ERROR&quot;</span>
<a href="#l22.360"></a><span id="l22.360" class="difflineplus">+            },</span>
<a href="#l22.361"></a><span id="l22.361" class="difflineplus">+            differences: []</span>
<a href="#l22.362"></a><span id="l22.362" class="difflineplus">+        }</span>
<a href="#l22.363"></a><span id="l22.363" class="difflineplus">+    }, {</span>
<a href="#l22.364"></a><span id="l22.364" class="difflineplus">+        // #7: proposal with a different organizer</span>
<a href="#l22.365"></a><span id="l22.365" class="difflineplus">+        input: {</span>
<a href="#l22.366"></a><span id="l22.366" class="difflineplus">+            existing: [],</span>
<a href="#l22.367"></a><span id="l22.367" class="difflineplus">+            proposed: [</span>
<a href="#l22.368"></a><span id="l22.368" class="difflineplus">+                {</span>
<a href="#l22.369"></a><span id="l22.369" class="difflineplus">+                    method: &quot;METHOD:COUNTER&quot;</span>
<a href="#l22.370"></a><span id="l22.370" class="difflineplus">+                }, {</span>
<a href="#l22.371"></a><span id="l22.371" class="difflineplus">+                    organizer: &quot;ORGANIZER;RSVP=TRUE;CN=Organizer;PARTSTAT=ACCEPTED;ROLE=CHAI&quot; +</span>
<a href="#l22.372"></a><span id="l22.372" class="difflineplus">+                               &quot;R:mailto:organizer2@example.net&quot;</span>
<a href="#l22.373"></a><span id="l22.373" class="difflineplus">+                }, {</span>
<a href="#l22.374"></a><span id="l22.374" class="difflineplus">+                    attendee: &quot;ATTENDEE;CN=Attendee;PARTSTAT=NEEDS-ACTION;ROLE=REQ-PARTICIPANT:&quot; +</span>
<a href="#l22.375"></a><span id="l22.375" class="difflineplus">+                              &quot;mailto:attendee@example.net&quot;</span>
<a href="#l22.376"></a><span id="l22.376" class="difflineplus">+                }, {</span>
<a href="#l22.377"></a><span id="l22.377" class="difflineplus">+                    dtStamp: &quot;DTSTAMP:20150909T182048Z&quot;</span>
<a href="#l22.378"></a><span id="l22.378" class="difflineplus">+                }</span>
<a href="#l22.379"></a><span id="l22.379" class="difflineplus">+            ]</span>
<a href="#l22.380"></a><span id="l22.380" class="difflineplus">+        },</span>
<a href="#l22.381"></a><span id="l22.381" class="difflineplus">+        expected: {</span>
<a href="#l22.382"></a><span id="l22.382" class="difflineplus">+            result: {</span>
<a href="#l22.383"></a><span id="l22.383" class="difflineplus">+                descr: &quot;Mismatch of uid or organizer in counterproposal.&quot;,</span>
<a href="#l22.384"></a><span id="l22.384" class="difflineplus">+                type: &quot;ERROR&quot;</span>
<a href="#l22.385"></a><span id="l22.385" class="difflineplus">+            },</span>
<a href="#l22.386"></a><span id="l22.386" class="difflineplus">+            differences: []</span>
<a href="#l22.387"></a><span id="l22.387" class="difflineplus">+        }</span>
<a href="#l22.388"></a><span id="l22.388" class="difflineplus">+    }, {</span>
<a href="#l22.389"></a><span id="l22.389" class="difflineplus">+        // #8:counterproposal without any difference</span>
<a href="#l22.390"></a><span id="l22.390" class="difflineplus">+        input: {</span>
<a href="#l22.391"></a><span id="l22.391" class="difflineplus">+            existing: [],</span>
<a href="#l22.392"></a><span id="l22.392" class="difflineplus">+            proposed: [{ method: &quot;METHOD:COUNTER&quot; }] },</span>
<a href="#l22.393"></a><span id="l22.393" class="difflineplus">+        expected: {</span>
<a href="#l22.394"></a><span id="l22.394" class="difflineplus">+            result: {</span>
<a href="#l22.395"></a><span id="l22.395" class="difflineplus">+                descr: &quot;No difference in counterproposal detected.&quot;,</span>
<a href="#l22.396"></a><span id="l22.396" class="difflineplus">+                type: &quot;NODIFF&quot;</span>
<a href="#l22.397"></a><span id="l22.397" class="difflineplus">+            },</span>
<a href="#l22.398"></a><span id="l22.398" class="difflineplus">+            differences: []</span>
<a href="#l22.399"></a><span id="l22.399" class="difflineplus">+        }</span>
<a href="#l22.400"></a><span id="l22.400" class="difflineplus">+    }];</span>
<a href="#l22.401"></a><span id="l22.401" class="difflineplus">+</span>
<a href="#l22.402"></a><span id="l22.402" class="difflineplus">+    let getItem = function(aProperties) {</span>
<a href="#l22.403"></a><span id="l22.403" class="difflineplus">+        let item = getIcs(true);</span>
<a href="#l22.404"></a><span id="l22.404" class="difflineplus">+</span>
<a href="#l22.405"></a><span id="l22.405" class="difflineplus">+        let modifyProperty = function(aRegex, aReplacement, aInVevent) {</span>
<a href="#l22.406"></a><span id="l22.406" class="difflineplus">+            let inVevent = false;</span>
<a href="#l22.407"></a><span id="l22.407" class="difflineplus">+            let i = 0;</span>
<a href="#l22.408"></a><span id="l22.408" class="difflineplus">+            item.forEach(aProp =&gt; {</span>
<a href="#l22.409"></a><span id="l22.409" class="difflineplus">+                if (aProp == &quot;BEGIN:VEVENT&quot; &amp;&amp; !inVevent) {</span>
<a href="#l22.410"></a><span id="l22.410" class="difflineplus">+                    inVevent = true;</span>
<a href="#l22.411"></a><span id="l22.411" class="difflineplus">+                } else if (aProp == &quot;END:VEVENT&quot; &amp;&amp; inVevent) {</span>
<a href="#l22.412"></a><span id="l22.412" class="difflineplus">+                    inVevent = false;</span>
<a href="#l22.413"></a><span id="l22.413" class="difflineplus">+                }</span>
<a href="#l22.414"></a><span id="l22.414" class="difflineplus">+                if ((aInVevent &amp;&amp; inVevent) || !aInVevent) {</span>
<a href="#l22.415"></a><span id="l22.415" class="difflineplus">+                    item[i] = aProp.replace(aRegex, aReplacement);</span>
<a href="#l22.416"></a><span id="l22.416" class="difflineplus">+                }</span>
<a href="#l22.417"></a><span id="l22.417" class="difflineplus">+                i++;</span>
<a href="#l22.418"></a><span id="l22.418" class="difflineplus">+            });</span>
<a href="#l22.419"></a><span id="l22.419" class="difflineplus">+        };</span>
<a href="#l22.420"></a><span id="l22.420" class="difflineplus">+</span>
<a href="#l22.421"></a><span id="l22.421" class="difflineplus">+        if (aProperties) {</span>
<a href="#l22.422"></a><span id="l22.422" class="difflineplus">+            aProperties.forEach(aProp =&gt; {</span>
<a href="#l22.423"></a><span id="l22.423" class="difflineplus">+                if (&quot;method&quot; in aProp &amp;&amp; aProp.method) {</span>
<a href="#l22.424"></a><span id="l22.424" class="difflineplus">+                    modifyProperty(/(METHOD.+)/, aProp.method, false);</span>
<a href="#l22.425"></a><span id="l22.425" class="difflineplus">+                } else if (&quot;attendee&quot; in aProp &amp;&amp; aProp.attendee) {</span>
<a href="#l22.426"></a><span id="l22.426" class="difflineplus">+                    modifyProperty(/(ATTENDEE.+)/, aProp.attendee, true);</span>
<a href="#l22.427"></a><span id="l22.427" class="difflineplus">+                } else if (&quot;attach&quot; in aProp &amp;&amp; aProp.attach) {</span>
<a href="#l22.428"></a><span id="l22.428" class="difflineplus">+                    modifyProperty(/(ATTACH.+)/, aProp.attach, true);</span>
<a href="#l22.429"></a><span id="l22.429" class="difflineplus">+                } else if (&quot;summary&quot; in aProp &amp;&amp; aProp.summary) {</span>
<a href="#l22.430"></a><span id="l22.430" class="difflineplus">+                    modifyProperty(/(SUMMARY.+)/, aProp.summary, true);</span>
<a href="#l22.431"></a><span id="l22.431" class="difflineplus">+                } else if (&quot;location&quot; in aProp &amp;&amp; aProp.location) {</span>
<a href="#l22.432"></a><span id="l22.432" class="difflineplus">+                    modifyProperty(/(LOCATION.+)/, aProp.location, true);</span>
<a href="#l22.433"></a><span id="l22.433" class="difflineplus">+                } else if (&quot;dtStart&quot; in aProp &amp;&amp; aProp.dtStart) {</span>
<a href="#l22.434"></a><span id="l22.434" class="difflineplus">+                    modifyProperty(/(DTSTART.+)/, aProp.dtStart, true);</span>
<a href="#l22.435"></a><span id="l22.435" class="difflineplus">+                } else if (&quot;dtEnd&quot; in aProp &amp;&amp; aProp.dtEnd) {</span>
<a href="#l22.436"></a><span id="l22.436" class="difflineplus">+                    modifyProperty(/(DTEND.+)/, aProp.dtEnd, true);</span>
<a href="#l22.437"></a><span id="l22.437" class="difflineplus">+                } else if (&quot;sequence&quot; in aProp &amp;&amp; aProp.sequence) {</span>
<a href="#l22.438"></a><span id="l22.438" class="difflineplus">+                    modifyProperty(/(SEQUENCE.+)/, aProp.sequence, true);</span>
<a href="#l22.439"></a><span id="l22.439" class="difflineplus">+                } else if (&quot;dtStamp&quot; in aProp &amp;&amp; aProp.dtStamp) {</span>
<a href="#l22.440"></a><span id="l22.440" class="difflineplus">+                    modifyProperty(/(DTSTAMP.+)/, aProp.dtStamp, true);</span>
<a href="#l22.441"></a><span id="l22.441" class="difflineplus">+                } else if (&quot;organizer&quot; in aProp &amp;&amp; aProp.organizer) {</span>
<a href="#l22.442"></a><span id="l22.442" class="difflineplus">+                    modifyProperty(/(ORGANIZER.+)/, aProp.organizer, true);</span>
<a href="#l22.443"></a><span id="l22.443" class="difflineplus">+                } else if (&quot;uid&quot; in aProp &amp;&amp; aProp.uid) {</span>
<a href="#l22.444"></a><span id="l22.444" class="difflineplus">+                    modifyProperty(/(UID.+)/, aProp.uid, true);</span>
<a href="#l22.445"></a><span id="l22.445" class="difflineplus">+                }</span>
<a href="#l22.446"></a><span id="l22.446" class="difflineplus">+            });</span>
<a href="#l22.447"></a><span id="l22.447" class="difflineplus">+        }</span>
<a href="#l22.448"></a><span id="l22.448" class="difflineplus">+        item = item.join(&quot;\r\n&quot;);</span>
<a href="#l22.449"></a><span id="l22.449" class="difflineplus">+        return createEventFromIcalString(item);</span>
<a href="#l22.450"></a><span id="l22.450" class="difflineplus">+    };</span>
<a href="#l22.451"></a><span id="l22.451" class="difflineplus">+</span>
<a href="#l22.452"></a><span id="l22.452" class="difflineplus">+    let formatDt = function (aDateTime) {</span>
<a href="#l22.453"></a><span id="l22.453" class="difflineplus">+        let datetime = getDateFormatter().formatDateTime(aDateTime);</span>
<a href="#l22.454"></a><span id="l22.454" class="difflineplus">+        return datetime += &quot; &quot; + aDateTime.timezone.displayName;</span>
<a href="#l22.455"></a><span id="l22.455" class="difflineplus">+    };</span>
<a href="#l22.456"></a><span id="l22.456" class="difflineplus">+</span>
<a href="#l22.457"></a><span id="l22.457" class="difflineplus">+    for (let i = 1; i &lt;= data.length; i++) {</span>
<a href="#l22.458"></a><span id="l22.458" class="difflineplus">+        let test = data[i - 1];</span>
<a href="#l22.459"></a><span id="l22.459" class="difflineplus">+        let existingItem = getItem(test.input.existing);</span>
<a href="#l22.460"></a><span id="l22.460" class="difflineplus">+        let proposedItem = getItem(test.input.proposed);</span>
<a href="#l22.461"></a><span id="l22.461" class="difflineplus">+        let parsed = ltn.invitation.parseCounter(proposedItem, existingItem);</span>
<a href="#l22.462"></a><span id="l22.462" class="difflineplus">+</span>
<a href="#l22.463"></a><span id="l22.463" class="difflineplus">+        equal(parsed.result.type, test.expected.result.type, &quot;(test #&quot; + i + &quot;: result.type)&quot;);</span>
<a href="#l22.464"></a><span id="l22.464" class="difflineplus">+        equal(parsed.result.descr, test.expected.result.descr, &quot;(test #&quot; + i + &quot;: result.descr)&quot;);</span>
<a href="#l22.465"></a><span id="l22.465" class="difflineplus">+        let parsedProps = [];</span>
<a href="#l22.466"></a><span id="l22.466" class="difflineplus">+        let additionalProps = [];</span>
<a href="#l22.467"></a><span id="l22.467" class="difflineplus">+        let missingProps = [];</span>
<a href="#l22.468"></a><span id="l22.468" class="difflineplus">+        parsed.differences.forEach(aDiff =&gt; {</span>
<a href="#l22.469"></a><span id="l22.469" class="difflineplus">+            let expected = test.expected.differences.filter(bDiff =&gt; bDiff.property == aDiff.property);</span>
<a href="#l22.470"></a><span id="l22.470" class="difflineplus">+            if (expected.length == 1) {</span>
<a href="#l22.471"></a><span id="l22.471" class="difflineplus">+                if ([&quot;DTSTART&quot;, &quot;DTEND&quot;].includes(aDiff.property)) {</span>
<a href="#l22.472"></a><span id="l22.472" class="difflineplus">+                    let prop = aDiff.proposed ? formatDt(aDiff.proposed) : null;</span>
<a href="#l22.473"></a><span id="l22.473" class="difflineplus">+                    ok(</span>
<a href="#l22.474"></a><span id="l22.474" class="difflineplus">+                        prop &amp;&amp; expected[0].proposed.includes(prop),</span>
<a href="#l22.475"></a><span id="l22.475" class="difflineplus">+                        &quot;(test #&quot; + i + &quot;: difference &quot; + aDiff.property + &quot;: proposed '&quot; + prop + &quot;')&quot;</span>
<a href="#l22.476"></a><span id="l22.476" class="difflineplus">+                    );</span>
<a href="#l22.477"></a><span id="l22.477" class="difflineplus">+                    prop = aDiff.original ? formatDt(aDiff.original) : null</span>
<a href="#l22.478"></a><span id="l22.478" class="difflineplus">+                    ok(</span>
<a href="#l22.479"></a><span id="l22.479" class="difflineplus">+                        prop &amp;&amp; expected[0].original.includes(prop),</span>
<a href="#l22.480"></a><span id="l22.480" class="difflineplus">+                        &quot;(test #&quot; + i + &quot;: difference &quot; + aDiff.property + &quot;: original '&quot; + prop + &quot;')&quot;</span>
<a href="#l22.481"></a><span id="l22.481" class="difflineplus">+                    );</span>
<a href="#l22.482"></a><span id="l22.482" class="difflineplus">+                } else {</span>
<a href="#l22.483"></a><span id="l22.483" class="difflineplus">+                    equal(</span>
<a href="#l22.484"></a><span id="l22.484" class="difflineplus">+                        aDiff.proposed,</span>
<a href="#l22.485"></a><span id="l22.485" class="difflineplus">+                        expected[0].proposed,</span>
<a href="#l22.486"></a><span id="l22.486" class="difflineplus">+                        &quot;(test #&quot; + i + &quot;: difference &quot; + aDiff.property + &quot;: proposed)&quot;</span>
<a href="#l22.487"></a><span id="l22.487" class="difflineplus">+                    );</span>
<a href="#l22.488"></a><span id="l22.488" class="difflineplus">+                    equal(</span>
<a href="#l22.489"></a><span id="l22.489" class="difflineplus">+                        aDiff.original,</span>
<a href="#l22.490"></a><span id="l22.490" class="difflineplus">+                        expected[0].original,</span>
<a href="#l22.491"></a><span id="l22.491" class="difflineplus">+                        &quot;(test #&quot; + i + &quot;: difference &quot; + aDiff.property + &quot;: original)&quot;</span>
<a href="#l22.492"></a><span id="l22.492" class="difflineplus">+                    );</span>
<a href="#l22.493"></a><span id="l22.493" class="difflineplus">+                }</span>
<a href="#l22.494"></a><span id="l22.494" class="difflineplus">+                parsedProps.push(aDiff.property);</span>
<a href="#l22.495"></a><span id="l22.495" class="difflineplus">+            } else if (expected.length == 0) {</span>
<a href="#l22.496"></a><span id="l22.496" class="difflineplus">+                additionalProps.push(aDiff.property);</span>
<a href="#l22.497"></a><span id="l22.497" class="difflineplus">+            }</span>
<a href="#l22.498"></a><span id="l22.498" class="difflineplus">+        });</span>
<a href="#l22.499"></a><span id="l22.499" class="difflineplus">+        test.expected.differences.forEach(aDiff =&gt; {</span>
<a href="#l22.500"></a><span id="l22.500" class="difflineplus">+            if (!parsedProps.includes(aDiff.property)) {</span>
<a href="#l22.501"></a><span id="l22.501" class="difflineplus">+                missingProps.push(aDiff.property);</span>
<a href="#l22.502"></a><span id="l22.502" class="difflineplus">+            }</span>
<a href="#l22.503"></a><span id="l22.503" class="difflineplus">+        });</span>
<a href="#l22.504"></a><span id="l22.504" class="difflineplus">+        ok(additionalProps.length == 0, &quot;(test #&quot; + i + &quot;: differences: check for unexpectedly &quot;+</span>
<a href="#l22.505"></a><span id="l22.505" class="difflineplus">+                                        &quot;occurring additional properties &quot; + additionalProps + &quot;)&quot;);</span>
<a href="#l22.506"></a><span id="l22.506" class="difflineplus">+        ok(missingProps.length == 0, &quot;(test #&quot; + i + &quot;: differences: check for unexpectedly &quot; +</span>
<a href="#l22.507"></a><span id="l22.507" class="difflineplus">+                                     &quot;missing properties &quot; + missingProps + &quot;)&quot;);</span>
<a href="#l22.508"></a><span id="l22.508" class="difflineplus">+    }</span>
<a href="#l22.509"></a><span id="l22.509" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/calendar/test/unit/xpcshell-shared.ini</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/calendar/test/unit/xpcshell-shared.ini</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -14,16 +14,17 @@</span>
<a href="#l23.4"></a><span id="l23.4"> [test_bug486186.js]</span>
<a href="#l23.5"></a><span id="l23.5"> [test_bug494140.js]</span>
<a href="#l23.6"></a><span id="l23.6"> [test_bug523860.js]</span>
<a href="#l23.7"></a><span id="l23.7"> [test_bug653924.js]</span>
<a href="#l23.8"></a><span id="l23.8"> [test_bug668222.js]</span>
<a href="#l23.9"></a><span id="l23.9"> [test_bug759324.js]</span>
<a href="#l23.10"></a><span id="l23.10"> [test_calmgr.js]</span>
<a href="#l23.11"></a><span id="l23.11"> [test_calutils.js]</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineplus">+[test_calitiputils.js]</span>
<a href="#l23.13"></a><span id="l23.13"> [test_datetime.js]</span>
<a href="#l23.14"></a><span id="l23.14"> [test_datetime_before_1970.js]</span>
<a href="#l23.15"></a><span id="l23.15"> [test_deleted_items.js]</span>
<a href="#l23.16"></a><span id="l23.16"> [test_duration.js]</span>
<a href="#l23.17"></a><span id="l23.17"> [test_extract.js]</span>
<a href="#l23.18"></a><span id="l23.18"> [test_freebusy.js]</span>
<a href="#l23.19"></a><span id="l23.19"> [test_freebusy_service.js]</span>
<a href="#l23.20"></a><span id="l23.20"> [test_gdata_provider.js]</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

