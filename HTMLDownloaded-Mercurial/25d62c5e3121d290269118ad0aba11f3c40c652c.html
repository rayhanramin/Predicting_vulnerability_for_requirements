<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 9154:25d62c5e3121d290269118ad0aba11f3c40c652c</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 25d62c5e3121d290269118ad0aba11f3c40c652c" />
<meta property="og:url" content="/comm-central/rev/25d62c5e3121d290269118ad0aba11f3c40c652c" />
<meta property="og:description" content="fix gug 704707, don't need event target when running imap urls, along with a bunch of fixes for issues with test that this change exposed r=neil, sr=standard8" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 25d62c5e3121d290269118ad0aba11f3c40c652c 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/25d62c5e3121d290269118ad0aba11f3c40c652c">shortlog</a> |
<a href="/comm-central/log/25d62c5e3121d290269118ad0aba11f3c40c652c">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/25d62c5e3121d290269118ad0aba11f3c40c652c">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/25d62c5e3121d290269118ad0aba11f3c40c652c">files</a> |
changeset |
<a href="/comm-central/raw-rev/25d62c5e3121d290269118ad0aba11f3c40c652c">raw</a>  | <a href="/comm-central/archive/25d62c5e3121d290269118ad0aba11f3c40c652c.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
fix gug 704707, don't need event target when running imap urls, along with a bunch of fixes for issues with test that this change exposed r=neil, sr=standard8
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#68;&#97;&#118;&#105;&#100;&#32;&#66;&#105;&#101;&#110;&#118;&#101;&#110;&#117;&#32;&#60;&#98;&#105;&#101;&#110;&#118;&#101;&#110;&#117;&#64;&#110;&#118;&#101;&#110;&#116;&#117;&#114;&#101;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 10 Jan 2012 07:37:22 -0800</td></tr>

<tr>
 <td>changeset 9154</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/25d62c5e3121d290269118ad0aba11f3c40c652c">25d62c5e3121d290269118ad0aba11f3c40c652c</a></td>
</tr>



<tr>
<td>parent 9153</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/b43c074160f0a71b1d0fd519cc7896b20b1c8a9e">b43c074160f0a71b1d0fd519cc7896b20b1c8a9e</a>
</td>
</tr>

<tr>
<td>child 9155</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/fa7ba14da2071c0739f4196551b183f4ea5bcd18">fa7ba14da2071c0739f4196551b183f4ea5bcd18</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=25d62c5e3121d290269118ad0aba11f3c40c652c">7004</a></td></tr>
<tr><td>push user</td><td>bienvenu@nventure.com</td></tr>
<tr><td>push date</td><td class="date age">Tue, 10 Jan 2012 15:36:46 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@25d62c5e3121 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=25d62c5e3121d290269118ad0aba11f3c40c652c">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=25d62c5e3121d290269118ad0aba11f3c40c652c&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=25d62c5e3121d290269118ad0aba11f3c40c652c&newProject=comm-central&newRevision=25d62c5e3121d290269118ad0aba11f3c40c652c&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=25d62c5e3121d290269118ad0aba11f3c40c652c&newProject=comm-central&newRevision=25d62c5e3121d290269118ad0aba11f3c40c652c&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=25d62c5e3121d290269118ad0aba11f3c40c652c&newProject=comm-central&newRevision=25d62c5e3121d290269118ad0aba11f3c40c652c&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28neil%29&revcount=50">neil</a>, <a href="/comm-central/log?rev=reviewer%28standard8%29&revcount=50">standard8</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=704707">704707</a></td></tr>




</table></div>

<div class="page_body description">fix gug 704707, don't need event target when running imap urls, along with a bunch of fixes for issues with test that this change exposed r=neil, sr=standard8</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/base/test/unit/test_imapPump.js">mailnews/base/test/unit/test_imapPump.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/base/test/unit/test_imapPump.js">file</a> |
<a href="/comm-central/annotate/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/base/test/unit/test_imapPump.js">annotate</a> |
<a href="/comm-central/diff/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/base/test/unit/test_imapPump.js">diff</a> |
<a href="/comm-central/comparison/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/base/test/unit/test_imapPump.js">comparison</a> |
<a href="/comm-central/log/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/base/test/unit/test_imapPump.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/base/util/nsImapMoveCoalescer.cpp">mailnews/base/util/nsImapMoveCoalescer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/base/util/nsImapMoveCoalescer.cpp">file</a> |
<a href="/comm-central/annotate/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/base/util/nsImapMoveCoalescer.cpp">annotate</a> |
<a href="/comm-central/diff/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/base/util/nsImapMoveCoalescer.cpp">diff</a> |
<a href="/comm-central/comparison/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/base/util/nsImapMoveCoalescer.cpp">comparison</a> |
<a href="/comm-central/log/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/base/util/nsImapMoveCoalescer.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/public/nsIImapIncomingServer.idl">mailnews/imap/public/nsIImapIncomingServer.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/public/nsIImapIncomingServer.idl">file</a> |
<a href="/comm-central/annotate/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/public/nsIImapIncomingServer.idl">annotate</a> |
<a href="/comm-central/diff/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/public/nsIImapIncomingServer.idl">diff</a> |
<a href="/comm-central/comparison/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/public/nsIImapIncomingServer.idl">comparison</a> |
<a href="/comm-central/log/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/public/nsIImapIncomingServer.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/public/nsIImapProtocol.idl">mailnews/imap/public/nsIImapProtocol.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/public/nsIImapProtocol.idl">file</a> |
<a href="/comm-central/annotate/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/public/nsIImapProtocol.idl">annotate</a> |
<a href="/comm-central/diff/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/public/nsIImapProtocol.idl">diff</a> |
<a href="/comm-central/comparison/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/public/nsIImapProtocol.idl">comparison</a> |
<a href="/comm-central/log/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/public/nsIImapProtocol.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/public/nsIImapService.idl">mailnews/imap/public/nsIImapService.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/public/nsIImapService.idl">file</a> |
<a href="/comm-central/annotate/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/public/nsIImapService.idl">annotate</a> |
<a href="/comm-central/diff/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/public/nsIImapService.idl">diff</a> |
<a href="/comm-central/comparison/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/public/nsIImapService.idl">comparison</a> |
<a href="/comm-central/log/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/public/nsIImapService.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/src/nsImapIncomingServer.cpp">mailnews/imap/src/nsImapIncomingServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/src/nsImapIncomingServer.cpp">file</a> |
<a href="/comm-central/annotate/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/src/nsImapIncomingServer.cpp">annotate</a> |
<a href="/comm-central/diff/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/src/nsImapIncomingServer.cpp">diff</a> |
<a href="/comm-central/comparison/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/src/nsImapIncomingServer.cpp">comparison</a> |
<a href="/comm-central/log/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/src/nsImapIncomingServer.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/src/nsImapIncomingServer.h">mailnews/imap/src/nsImapIncomingServer.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/src/nsImapIncomingServer.h">file</a> |
<a href="/comm-central/annotate/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/src/nsImapIncomingServer.h">annotate</a> |
<a href="/comm-central/diff/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/src/nsImapIncomingServer.h">diff</a> |
<a href="/comm-central/comparison/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/src/nsImapIncomingServer.h">comparison</a> |
<a href="/comm-central/log/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/src/nsImapIncomingServer.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/src/nsImapMailFolder.cpp">mailnews/imap/src/nsImapMailFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/src/nsImapMailFolder.cpp">file</a> |
<a href="/comm-central/annotate/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/src/nsImapMailFolder.cpp">annotate</a> |
<a href="/comm-central/diff/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/src/nsImapMailFolder.cpp">diff</a> |
<a href="/comm-central/comparison/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/src/nsImapMailFolder.cpp">comparison</a> |
<a href="/comm-central/log/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/src/nsImapMailFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/src/nsImapMailFolder.h">mailnews/imap/src/nsImapMailFolder.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/src/nsImapMailFolder.h">file</a> |
<a href="/comm-central/annotate/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/src/nsImapMailFolder.h">annotate</a> |
<a href="/comm-central/diff/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/src/nsImapMailFolder.h">diff</a> |
<a href="/comm-central/comparison/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/src/nsImapMailFolder.h">comparison</a> |
<a href="/comm-central/log/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/src/nsImapMailFolder.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/src/nsImapOfflineSync.cpp">mailnews/imap/src/nsImapOfflineSync.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/src/nsImapOfflineSync.cpp">file</a> |
<a href="/comm-central/annotate/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/src/nsImapOfflineSync.cpp">annotate</a> |
<a href="/comm-central/diff/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/src/nsImapOfflineSync.cpp">diff</a> |
<a href="/comm-central/comparison/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/src/nsImapOfflineSync.cpp">comparison</a> |
<a href="/comm-central/log/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/src/nsImapOfflineSync.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/src/nsImapProtocol.cpp">mailnews/imap/src/nsImapProtocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/src/nsImapProtocol.cpp">file</a> |
<a href="/comm-central/annotate/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/src/nsImapProtocol.cpp">annotate</a> |
<a href="/comm-central/diff/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/src/nsImapProtocol.cpp">diff</a> |
<a href="/comm-central/comparison/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/src/nsImapProtocol.cpp">comparison</a> |
<a href="/comm-central/log/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/src/nsImapProtocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/src/nsImapProtocol.h">mailnews/imap/src/nsImapProtocol.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/src/nsImapProtocol.h">file</a> |
<a href="/comm-central/annotate/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/src/nsImapProtocol.h">annotate</a> |
<a href="/comm-central/diff/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/src/nsImapProtocol.h">diff</a> |
<a href="/comm-central/comparison/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/src/nsImapProtocol.h">comparison</a> |
<a href="/comm-central/log/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/src/nsImapProtocol.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/src/nsImapService.cpp">mailnews/imap/src/nsImapService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/src/nsImapService.cpp">file</a> |
<a href="/comm-central/annotate/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/src/nsImapService.cpp">annotate</a> |
<a href="/comm-central/diff/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/src/nsImapService.cpp">diff</a> |
<a href="/comm-central/comparison/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/src/nsImapService.cpp">comparison</a> |
<a href="/comm-central/log/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/src/nsImapService.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/src/nsImapService.h">mailnews/imap/src/nsImapService.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/src/nsImapService.h">file</a> |
<a href="/comm-central/annotate/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/src/nsImapService.h">annotate</a> |
<a href="/comm-central/diff/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/src/nsImapService.h">diff</a> |
<a href="/comm-central/comparison/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/src/nsImapService.h">comparison</a> |
<a href="/comm-central/log/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/src/nsImapService.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/src/nsImapUndoTxn.cpp">mailnews/imap/src/nsImapUndoTxn.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/src/nsImapUndoTxn.cpp">file</a> |
<a href="/comm-central/annotate/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/src/nsImapUndoTxn.cpp">annotate</a> |
<a href="/comm-central/diff/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/src/nsImapUndoTxn.cpp">diff</a> |
<a href="/comm-central/comparison/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/src/nsImapUndoTxn.cpp">comparison</a> |
<a href="/comm-central/log/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/src/nsImapUndoTxn.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/src/nsImapUndoTxn.h">mailnews/imap/src/nsImapUndoTxn.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/src/nsImapUndoTxn.h">file</a> |
<a href="/comm-central/annotate/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/src/nsImapUndoTxn.h">annotate</a> |
<a href="/comm-central/diff/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/src/nsImapUndoTxn.h">diff</a> |
<a href="/comm-central/comparison/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/src/nsImapUndoTxn.h">comparison</a> |
<a href="/comm-central/log/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/src/nsImapUndoTxn.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/test/unit/test_filterCustomHeaders.js">mailnews/imap/test/unit/test_filterCustomHeaders.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/test/unit/test_filterCustomHeaders.js">file</a> |
<a href="/comm-central/annotate/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/test/unit/test_filterCustomHeaders.js">annotate</a> |
<a href="/comm-central/diff/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/test/unit/test_filterCustomHeaders.js">diff</a> |
<a href="/comm-central/comparison/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/test/unit/test_filterCustomHeaders.js">comparison</a> |
<a href="/comm-central/log/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/test/unit/test_filterCustomHeaders.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/test/unit/test_imapCopyTimeout.js">mailnews/imap/test/unit/test_imapCopyTimeout.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/test/unit/test_imapCopyTimeout.js">file</a> |
<a href="/comm-central/annotate/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/test/unit/test_imapCopyTimeout.js">annotate</a> |
<a href="/comm-central/diff/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/test/unit/test_imapCopyTimeout.js">diff</a> |
<a href="/comm-central/comparison/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/test/unit/test_imapCopyTimeout.js">comparison</a> |
<a href="/comm-central/log/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/test/unit/test_imapCopyTimeout.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/test/unit/test_imapHighWater.js">mailnews/imap/test/unit/test_imapHighWater.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/test/unit/test_imapHighWater.js">file</a> |
<a href="/comm-central/annotate/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/test/unit/test_imapHighWater.js">annotate</a> |
<a href="/comm-central/diff/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/test/unit/test_imapHighWater.js">diff</a> |
<a href="/comm-central/comparison/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/test/unit/test_imapHighWater.js">comparison</a> |
<a href="/comm-central/log/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/test/unit/test_imapHighWater.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/test/unit/test_imapMove.js">mailnews/imap/test/unit/test_imapMove.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/test/unit/test_imapMove.js">file</a> |
<a href="/comm-central/annotate/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/test/unit/test_imapMove.js">annotate</a> |
<a href="/comm-central/diff/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/test/unit/test_imapMove.js">diff</a> |
<a href="/comm-central/comparison/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/test/unit/test_imapMove.js">comparison</a> |
<a href="/comm-central/log/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/test/unit/test_imapMove.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/test/unit/test_mailboxes.js">mailnews/imap/test/unit/test_mailboxes.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/test/unit/test_mailboxes.js">file</a> |
<a href="/comm-central/annotate/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/test/unit/test_mailboxes.js">annotate</a> |
<a href="/comm-central/diff/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/test/unit/test_mailboxes.js">diff</a> |
<a href="/comm-central/comparison/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/test/unit/test_mailboxes.js">comparison</a> |
<a href="/comm-central/log/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/test/unit/test_mailboxes.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/test/unit/test_preserveDataOnMove.js">mailnews/imap/test/unit/test_preserveDataOnMove.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/test/unit/test_preserveDataOnMove.js">file</a> |
<a href="/comm-central/annotate/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/test/unit/test_preserveDataOnMove.js">annotate</a> |
<a href="/comm-central/diff/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/test/unit/test_preserveDataOnMove.js">diff</a> |
<a href="/comm-central/comparison/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/test/unit/test_preserveDataOnMove.js">comparison</a> |
<a href="/comm-central/log/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/test/unit/test_preserveDataOnMove.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/test/unit/test_saveImapDraft.js">mailnews/imap/test/unit/test_saveImapDraft.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/test/unit/test_saveImapDraft.js">file</a> |
<a href="/comm-central/annotate/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/test/unit/test_saveImapDraft.js">annotate</a> |
<a href="/comm-central/diff/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/test/unit/test_saveImapDraft.js">diff</a> |
<a href="/comm-central/comparison/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/test/unit/test_saveImapDraft.js">comparison</a> |
<a href="/comm-central/log/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/test/unit/test_saveImapDraft.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/test/unit/test_saveTemplate.js">mailnews/imap/test/unit/test_saveTemplate.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/test/unit/test_saveTemplate.js">file</a> |
<a href="/comm-central/annotate/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/test/unit/test_saveTemplate.js">annotate</a> |
<a href="/comm-central/diff/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/test/unit/test_saveTemplate.js">diff</a> |
<a href="/comm-central/comparison/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/test/unit/test_saveTemplate.js">comparison</a> |
<a href="/comm-central/log/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/imap/test/unit/test_saveTemplate.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/local/src/nsLocalUndoTxn.cpp">mailnews/local/src/nsLocalUndoTxn.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/local/src/nsLocalUndoTxn.cpp">file</a> |
<a href="/comm-central/annotate/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/local/src/nsLocalUndoTxn.cpp">annotate</a> |
<a href="/comm-central/diff/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/local/src/nsLocalUndoTxn.cpp">diff</a> |
<a href="/comm-central/comparison/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/local/src/nsLocalUndoTxn.cpp">comparison</a> |
<a href="/comm-central/log/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/local/src/nsLocalUndoTxn.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/test/resources/IMAPpump.js">mailnews/test/resources/IMAPpump.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/test/resources/IMAPpump.js">file</a> |
<a href="/comm-central/annotate/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/test/resources/IMAPpump.js">annotate</a> |
<a href="/comm-central/diff/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/test/resources/IMAPpump.js">diff</a> |
<a href="/comm-central/comparison/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/test/resources/IMAPpump.js">comparison</a> |
<a href="/comm-central/log/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/test/resources/IMAPpump.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/test/resources/messageInjection.js">mailnews/test/resources/messageInjection.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/test/resources/messageInjection.js">file</a> |
<a href="/comm-central/annotate/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/test/resources/messageInjection.js">annotate</a> |
<a href="/comm-central/diff/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/test/resources/messageInjection.js">diff</a> |
<a href="/comm-central/comparison/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/test/resources/messageInjection.js">comparison</a> |
<a href="/comm-central/log/25d62c5e3121d290269118ad0aba11f3c40c652c/mailnews/test/resources/messageInjection.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/base/test/unit/test_imapPump.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_imapPump.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -39,16 +39,18 @@</span>
<a href="#l1.4"></a><span id="l1.4"> // async support </span>
<a href="#l1.5"></a><span id="l1.5"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l1.6"></a><span id="l1.6"> load(&quot;../../../resources/mailTestUtils.js&quot;);</span>
<a href="#l1.7"></a><span id="l1.7"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l1.8"></a><span id="l1.8"> </span>
<a href="#l1.9"></a><span id="l1.9"> // IMAP pump</span>
<a href="#l1.10"></a><span id="l1.10"> load(&quot;../../../resources/IMAPpump.js&quot;);</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+</span>
<a href="#l1.14"></a><span id="l1.14"> // Globals</span>
<a href="#l1.15"></a><span id="l1.15"> </span>
<a href="#l1.16"></a><span id="l1.16"> // Messages to load must have CRLF line endings, that is Windows style</span>
<a href="#l1.17"></a><span id="l1.17"> const gMessage = &quot;bugmail10&quot;; // message file used as the test message</span>
<a href="#l1.18"></a><span id="l1.18"> </span>
<a href="#l1.19"></a><span id="l1.19"> setupIMAPPump();</span>
<a href="#l1.20"></a><span id="l1.20"> </span>
<a href="#l1.21"></a><span id="l1.21"> // Definition of tests</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineat">@@ -73,16 +75,17 @@ function loadImapMessage()</span>
<a href="#l1.23"></a><span id="l1.23"> // Cleanup at end</span>
<a href="#l1.24"></a><span id="l1.24"> function endTest()</span>
<a href="#l1.25"></a><span id="l1.25"> {</span>
<a href="#l1.26"></a><span id="l1.26">   teardownIMAPPump();</span>
<a href="#l1.27"></a><span id="l1.27"> }</span>
<a href="#l1.28"></a><span id="l1.28"> </span>
<a href="#l1.29"></a><span id="l1.29"> function run_test()</span>
<a href="#l1.30"></a><span id="l1.30"> {</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+  Services.prefs.setBoolPref(&quot;mail.server.server1.autosync_offline_stores&quot;, false);</span>
<a href="#l1.32"></a><span id="l1.32">   async_run_tests(tests);</span>
<a href="#l1.33"></a><span id="l1.33"> }</span>
<a href="#l1.34"></a><span id="l1.34"> </span>
<a href="#l1.35"></a><span id="l1.35"> /*</span>
<a href="#l1.36"></a><span id="l1.36">  * helper functions</span>
<a href="#l1.37"></a><span id="l1.37">  */</span>
<a href="#l1.38"></a><span id="l1.38"> </span>
<a href="#l1.39"></a><span id="l1.39"> // given a test file, return the file uri spec</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/base/util/nsImapMoveCoalescer.cpp</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/base/util/nsImapMoveCoalescer.cpp</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -244,18 +244,17 @@ NS_IMETHODIMP nsMoveCoalescerCopyListene</span>
<a href="#l2.4"></a><span id="l2.4">       PRUint32 folderFlags;</span>
<a href="#l2.5"></a><span id="l2.5">       m_destFolder-&gt;GetFlags(&amp;folderFlags);</span>
<a href="#l2.6"></a><span id="l2.6">       if (!(folderFlags &amp; (nsMsgFolderFlags::Junk | nsMsgFolderFlags::Trash)))</span>
<a href="#l2.7"></a><span id="l2.7">       {</span>
<a href="#l2.8"></a><span id="l2.8">         nsCOMPtr&lt;nsIImapService&gt; imapService = do_GetService(NS_IMAPSERVICE_CONTRACTID, &amp;rv); </span>
<a href="#l2.9"></a><span id="l2.9">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.10"></a><span id="l2.10">         nsCOMPtr &lt;nsIURI&gt; url;</span>
<a href="#l2.11"></a><span id="l2.11">         nsCOMPtr &lt;nsIUrlListener&gt; listener = do_QueryInterface(m_coalescer);</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-        nsCOMPtr&lt;nsIThread&gt; thread(do_GetCurrentThread());</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-        rv = imapService-&gt;SelectFolder(thread, m_destFolder, listener, nsnull, getter_AddRefs(url));</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+        rv = imapService-&gt;SelectFolder(m_destFolder, listener, nsnull, getter_AddRefs(url));</span>
<a href="#l2.15"></a><span id="l2.15">       }</span>
<a href="#l2.16"></a><span id="l2.16">     }</span>
<a href="#l2.17"></a><span id="l2.17">     else // give junk filters a chance to run on new msgs in destination local folder</span>
<a href="#l2.18"></a><span id="l2.18">     {</span>
<a href="#l2.19"></a><span id="l2.19">       bool filtersRun;</span>
<a href="#l2.20"></a><span id="l2.20">       m_destFolder-&gt;CallFilterPlugins(nsnull, &amp;filtersRun);</span>
<a href="#l2.21"></a><span id="l2.21">     }</span>
<a href="#l2.22"></a><span id="l2.22">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/imap/public/nsIImapIncomingServer.idl</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/imap/public/nsIImapIncomingServer.idl</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -35,32 +35,31 @@</span>
<a href="#l3.4"></a><span id="l3.4">  *</span>
<a href="#l3.5"></a><span id="l3.5">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l3.6"></a><span id="l3.6"> </span>
<a href="#l3.7"></a><span id="l3.7"> #include &quot;nsISupports.idl&quot;</span>
<a href="#l3.8"></a><span id="l3.8"> </span>
<a href="#l3.9"></a><span id="l3.9"> interface nsIUrlListener;</span>
<a href="#l3.10"></a><span id="l3.10"> interface nsIURI;</span>
<a href="#l3.11"></a><span id="l3.11"> interface nsIImapUrl;</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-interface nsIEventTarget;</span>
<a href="#l3.13"></a><span id="l3.13"> interface nsIImapProtocol;</span>
<a href="#l3.14"></a><span id="l3.14"> interface nsIMsgFolder;</span>
<a href="#l3.15"></a><span id="l3.15"> interface nsIMsgWindow;</span>
<a href="#l3.16"></a><span id="l3.16"> </span>
<a href="#l3.17"></a><span id="l3.17"> typedef long nsMsgImapDeleteModel;</span>
<a href="#l3.18"></a><span id="l3.18"> </span>
<a href="#l3.19"></a><span id="l3.19"> [scriptable, uuid(bbfc33de-fe89-11d3-a564-0060b0fc04b7)]</span>
<a href="#l3.20"></a><span id="l3.20"> interface nsMsgImapDeleteModels</span>
<a href="#l3.21"></a><span id="l3.21"> {</span>
<a href="#l3.22"></a><span id="l3.22">   const long IMAPDelete = 0;    /* delete with a big red x */</span>
<a href="#l3.23"></a><span id="l3.23">   const long MoveToTrash = 1;   /* delete moves message to the trash */</span>
<a href="#l3.24"></a><span id="l3.24">   const long DeleteNoTrash = 2; /* delete is shift delete - don't create or use trash */</span>
<a href="#l3.25"></a><span id="l3.25"> };</span>
<a href="#l3.26"></a><span id="l3.26"> </span>
<a href="#l3.27"></a><span id="l3.27" class="difflineminus">-[scriptable, uuid(d4f8f5c7-d413-4c11-b886-abed7f7265a6)]</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineplus">+[scriptable, uuid(3f02221b-d556-48ef-8b4f-7e50bfe9813d)]</span>
<a href="#l3.29"></a><span id="l3.29"> interface nsIImapIncomingServer : nsISupports {</span>
<a href="#l3.30"></a><span id="l3.30"> </span>
<a href="#l3.31"></a><span id="l3.31">   attribute long maximumConnectionsNumber;</span>
<a href="#l3.32"></a><span id="l3.32">   attribute long timeOutLimits;</span>
<a href="#l3.33"></a><span id="l3.33">   attribute ACString adminUrl;</span>
<a href="#l3.34"></a><span id="l3.34">   attribute ACString serverDirectory;</span>
<a href="#l3.35"></a><span id="l3.35">   attribute long capabilityPref;</span>
<a href="#l3.36"></a><span id="l3.36">   /// RFC 2971 ID response stored as a pref</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineat">@@ -99,19 +98,18 @@ interface nsIImapIncomingServer : nsISup</span>
<a href="#l3.38"></a><span id="l3.38">   attribute AString trashFolderName;</span>
<a href="#l3.39"></a><span id="l3.39"> </span>
<a href="#l3.40"></a><span id="l3.40">   attribute boolean downloadBodiesOnGetNewMail;</span>
<a href="#l3.41"></a><span id="l3.41">   attribute boolean autoSyncOfflineStores;</span>
<a href="#l3.42"></a><span id="l3.42"> </span>
<a href="#l3.43"></a><span id="l3.43">   /// Max age of messages we will autosync to, or keep in offline store.</span>
<a href="#l3.44"></a><span id="l3.44">   attribute long autoSyncMaxAgeDays;</span>
<a href="#l3.45"></a><span id="l3.45"> </span>
<a href="#l3.46"></a><span id="l3.46" class="difflineminus">-  void GetImapConnectionAndLoadUrl(in nsIEventTarget aClientEventTarget,</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineminus">-                                           in nsIImapUrl aImapUrl,</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineminus">-                                           in nsISupports aConsumer);</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineplus">+  void GetImapConnectionAndLoadUrl(in nsIImapUrl aImapUrl,</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineplus">+                                   in nsISupports aConsumer);</span>
<a href="#l3.51"></a><span id="l3.51"> </span>
<a href="#l3.52"></a><span id="l3.52">   void RemoveConnection(in nsIImapProtocol aImapConnection);</span>
<a href="#l3.53"></a><span id="l3.53">   void ResetNamespaceReferences();</span>
<a href="#l3.54"></a><span id="l3.54">   void pseudoInterruptMsgLoad(in nsIMsgFolder aImapFolder, in nsIMsgWindow aMsgWindow, out boolean interrupted);</span>
<a href="#l3.55"></a><span id="l3.55">   void ResetConnection(in ACString folderName);</span>
<a href="#l3.56"></a><span id="l3.56">   void CloseConnectionForFolder(in nsIMsgFolder aMsgFolder);</span>
<a href="#l3.57"></a><span id="l3.57">   void reDiscoverAllFolders();</span>
<a href="#l3.58"></a><span id="l3.58">   nsIURI subscribeToFolder(in AString name, in boolean subscribe);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/imap/public/nsIImapProtocol.idl</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/imap/public/nsIImapProtocol.idl</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -36,24 +36,23 @@</span>
<a href="#l4.4"></a><span id="l4.4">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l4.5"></a><span id="l4.5"> </span>
<a href="#l4.6"></a><span id="l4.6"> #include &quot;nsISupports.idl&quot;</span>
<a href="#l4.7"></a><span id="l4.7"> #include &quot;nsIStreamListener.idl&quot;</span>
<a href="#l4.8"></a><span id="l4.8"> </span>
<a href="#l4.9"></a><span id="l4.9"> interface nsIUrlListener;</span>
<a href="#l4.10"></a><span id="l4.10"> interface nsIURI;</span>
<a href="#l4.11"></a><span id="l4.11"> interface nsIImapUrl;</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-interface nsIEventTarget;</span>
<a href="#l4.13"></a><span id="l4.13"> interface nsIImapProtocol;</span>
<a href="#l4.14"></a><span id="l4.14"> interface nsIImapIncomingServer;</span>
<a href="#l4.15"></a><span id="l4.15"> interface nsIMsgFolder;</span>
<a href="#l4.16"></a><span id="l4.16"> interface nsIImapHostSessionList;</span>
<a href="#l4.17"></a><span id="l4.17"> interface nsIMsgWindow;</span>
<a href="#l4.18"></a><span id="l4.18"> </span>
<a href="#l4.19"></a><span id="l4.19" class="difflineminus">-[scriptable, uuid(1c3bbfa9-69f7-4716-8986-2dba10cefb09)]</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+[scriptable, uuid(177f4140-37ad-4828-880c-42d4ee5d2015)]</span>
<a href="#l4.21"></a><span id="l4.21"> interface nsIImapProtocol : nsISupports {</span>
<a href="#l4.22"></a><span id="l4.22">   void LoadImapUrl(in nsIURI aUrl, in nsISupports aConsumer);</span>
<a href="#l4.23"></a><span id="l4.23"> </span>
<a href="#l4.24"></a><span id="l4.24">   /**</span>
<a href="#l4.25"></a><span id="l4.25">    * IsBusy returns true if the connection is currently processing a url</span>
<a href="#l4.26"></a><span id="l4.26">    * and false otherwise.</span>
<a href="#l4.27"></a><span id="l4.27">    */</span>
<a href="#l4.28"></a><span id="l4.28">   void IsBusy(out boolean aIsConnectionBusy,</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineat">@@ -64,22 +63,21 @@ interface nsIImapProtocol : nsISupports </span>
<a href="#l4.30"></a><span id="l4.30">    * if it can process this url. I decided to push the semantics about</span>
<a href="#l4.31"></a><span id="l4.31">    * whether a connection can handle a url down into the connection level</span>
<a href="#l4.32"></a><span id="l4.32">    * instead of in the connection cache.</span>
<a href="#l4.33"></a><span id="l4.33">    */</span>
<a href="#l4.34"></a><span id="l4.34">   void CanHandleUrl(in nsIImapUrl aImapUrl, out boolean aCanRunUrl,</span>
<a href="#l4.35"></a><span id="l4.35">                     out boolean hasToWait);</span>
<a href="#l4.36"></a><span id="l4.36"> </span>
<a href="#l4.37"></a><span id="l4.37">   /**</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineminus">-   * Right now, initialize requires the event queue of the UI thread,</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineminus">-   * or more importantly the event queue of the consumer of the imap</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineminus">-   * protocol data. The protocol also needs a host session list.</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+   * Initialize a protocol object.</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+   * @param aHostSessionList host session list service</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineplus">+   * @param aServer imap server the protocol object will be talking to</span>
<a href="#l4.44"></a><span id="l4.44">    */</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineminus">-  void Initialize(in nsIImapHostSessionList aHostSessionList, in nsIImapIncomingServer aServer,</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineminus">-                  in nsIEventTarget aSinkEventTarget);</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineplus">+  void Initialize(in nsIImapHostSessionList aHostSessionList, in nsIImapIncomingServer aServer);</span>
<a href="#l4.48"></a><span id="l4.48"> </span>
<a href="#l4.49"></a><span id="l4.49">   void NotifyBodysToDownload(out unsigned long keys, in unsigned long count);</span>
<a href="#l4.50"></a><span id="l4.50">   // methods to get data from the imap parser flag state.</span>
<a href="#l4.51"></a><span id="l4.51">   void GetFlagsForUID(in unsigned long uid, out boolean foundIt, out unsigned short flags, out string customFlags);</span>
<a href="#l4.52"></a><span id="l4.52">   void GetSupportedUserFlags(out unsigned short flags);</span>
<a href="#l4.53"></a><span id="l4.53"> </span>
<a href="#l4.54"></a><span id="l4.54">   void GetRunningImapURL(out nsIImapUrl aImapUrl);</span>
<a href="#l4.55"></a><span id="l4.55"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/imap/public/nsIImapService.idl</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/imap/public/nsIImapService.idl</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -46,50 +46,45 @@</span>
<a href="#l5.4"></a><span id="l5.4"> </span>
<a href="#l5.5"></a><span id="l5.5"> #include &quot;nsISupports.idl&quot;</span>
<a href="#l5.6"></a><span id="l5.6"> #include &quot;nsIImapUrl.idl&quot;</span>
<a href="#l5.7"></a><span id="l5.7"> </span>
<a href="#l5.8"></a><span id="l5.8"> interface nsIImapProtocol;</span>
<a href="#l5.9"></a><span id="l5.9"> interface nsIImapMessageSink;</span>
<a href="#l5.10"></a><span id="l5.10"> interface nsIUrlListener;</span>
<a href="#l5.11"></a><span id="l5.11"> interface nsIURI;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-interface nsIEventTarget;</span>
<a href="#l5.13"></a><span id="l5.13"> interface nsIFile;</span>
<a href="#l5.14"></a><span id="l5.14"> interface nsIMsgFolder;</span>
<a href="#l5.15"></a><span id="l5.15"> interface nsIMsgWindow;</span>
<a href="#l5.16"></a><span id="l5.16"> interface nsIImapIncomingServer;</span>
<a href="#l5.17"></a><span id="l5.17"> interface nsICacheSession;</span>
<a href="#l5.18"></a><span id="l5.18"> </span>
<a href="#l5.19"></a><span id="l5.19" class="difflineminus">-[scriptable, uuid(7ff02a19-f402-436a-a6cc-c4c454f0b86f)]</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+[scriptable, uuid(aba44b3d-7a0f-4987-8794-96d2de66d966)]</span>
<a href="#l5.21"></a><span id="l5.21"> interface nsIImapService : nsISupports</span>
<a href="#l5.22"></a><span id="l5.22"> {</span>
<a href="#l5.23"></a><span id="l5.23">   // You can pass in null for the url listener and the url if you don't require either.....</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineminus">-  // aClientEventTarget is the event queue of the event sinks. We post events into this queue.</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineminus">-  void selectFolder(in nsIEventTarget aClientEventTarget,</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineminus">-                    in nsIMsgFolder aImapMailFolder,</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineplus">+  void selectFolder(in nsIMsgFolder aImapMailFolder,</span>
<a href="#l5.28"></a><span id="l5.28">                     in nsIUrlListener aUrlListener,</span>
<a href="#l5.29"></a><span id="l5.29">                     in nsIMsgWindow   aMsgWindow,</span>
<a href="#l5.30"></a><span id="l5.30">                     out nsIURI aURL);</span>
<a href="#l5.31"></a><span id="l5.31"> </span>
<a href="#l5.32"></a><span id="l5.32">   /**</span>
<a href="#l5.33"></a><span id="l5.33">    * Select the folder on the imap server without doing a sync of flags or</span>
<a href="#l5.34"></a><span id="l5.34">    * headers. This is used for offline playback, where we don't want to</span>
<a href="#l5.35"></a><span id="l5.35">    * download hdrs we don't have, because they may have been offline deleted.</span>
<a href="#l5.36"></a><span id="l5.36">    *</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineminus">-   * @param aClientEventTarget  the event target of the ui thread</span>
<a href="#l5.38"></a><span id="l5.38">    * @param aImapMailFolder     the folder to select</span>
<a href="#l5.39"></a><span id="l5.39">    * @param aUrlListener        url listener, can be null</span>
<a href="#l5.40"></a><span id="l5.40">    * @param aMsgWindow          msg window url is running in, can be null</span>
<a href="#l5.41"></a><span id="l5.41">    *</span>
<a href="#l5.42"></a><span id="l5.42">    * @returns the url created to run the lite select in.</span>
<a href="#l5.43"></a><span id="l5.43">    */</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineminus">-  nsIURI liteSelectFolder(in nsIEventTarget aClientEventTarget,</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineminus">-                        in nsIMsgFolder aImapMailFolder,</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineminus">-                        in nsIUrlListener aUrlListener,</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineminus">-                        in nsIMsgWindow aMsgWindow);</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineplus">+  nsIURI liteSelectFolder(in nsIMsgFolder aImapMailFolder,</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineplus">+                          in nsIUrlListener aUrlListener,</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineplus">+                          in nsIMsgWindow aMsgWindow);</span>
<a href="#l5.51"></a><span id="l5.51"> </span>
<a href="#l5.52"></a><span id="l5.52">   void addImapFetchToUrl(in nsIURI aURL,</span>
<a href="#l5.53"></a><span id="l5.53">                          in nsIMsgFolder aImapMailFolder,</span>
<a href="#l5.54"></a><span id="l5.54">                          in ACString aMessageIdentifierList,</span>
<a href="#l5.55"></a><span id="l5.55">                          in ACString aAdditionalHeader);</span>
<a href="#l5.56"></a><span id="l5.56"> </span>
<a href="#l5.57"></a><span id="l5.57">   void fetchMessage(in nsIImapUrl aUrl,</span>
<a href="#l5.58"></a><span id="l5.58">                     in nsImapState aImapAction,</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineat">@@ -97,228 +92,199 @@ interface nsIImapService : nsISupports</span>
<a href="#l5.60"></a><span id="l5.60">                     in nsIImapMessageSink aImapMessageSink,</span>
<a href="#l5.61"></a><span id="l5.61">                     in nsIMsgWindow aMsgWindow,</span>
<a href="#l5.62"></a><span id="l5.62">                     in nsISupports aConsumer,</span>
<a href="#l5.63"></a><span id="l5.63">                     in ACString aMessageIdentifierList,</span>
<a href="#l5.64"></a><span id="l5.64">                     in boolean convertDataToText,</span>
<a href="#l5.65"></a><span id="l5.65">                     in ACString additionalHeader,</span>
<a href="#l5.66"></a><span id="l5.66">                     out nsIURI aOutURL);</span>
<a href="#l5.67"></a><span id="l5.67"> </span>
<a href="#l5.68"></a><span id="l5.68" class="difflineminus">-  void noop(in nsIEventTarget aClientEventTarget,</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineminus">-            in nsIMsgFolder aImapMailFolder,</span>
<a href="#l5.70"></a><span id="l5.70" class="difflineplus">+  void noop(in nsIMsgFolder aImapMailFolder,</span>
<a href="#l5.71"></a><span id="l5.71">             in nsIUrlListener aUrlListener,</span>
<a href="#l5.72"></a><span id="l5.72">             out nsIURI aURL);</span>
<a href="#l5.73"></a><span id="l5.73"> </span>
<a href="#l5.74"></a><span id="l5.74" class="difflineminus">-  void getHeaders(in nsIEventTarget aClientEventTarget,</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineminus">-                  in nsIMsgFolder aImapMailFolder,</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineplus">+  void getHeaders(in nsIMsgFolder aImapMailFolder,</span>
<a href="#l5.77"></a><span id="l5.77">                   in nsIUrlListener aUrlListener,</span>
<a href="#l5.78"></a><span id="l5.78">                   out nsIURI aURL,</span>
<a href="#l5.79"></a><span id="l5.79">                   in ACString aMessageIdentifierList,</span>
<a href="#l5.80"></a><span id="l5.80">                   in boolean aMessageIdsAreUID);</span>
<a href="#l5.81"></a><span id="l5.81"> </span>
<a href="#l5.82"></a><span id="l5.82" class="difflineminus">-  nsIURI getBodyStart(in nsIEventTarget aClientEventTarget,</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineminus">-                  in nsIMsgFolder aImapMailFolder,</span>
<a href="#l5.84"></a><span id="l5.84" class="difflineminus">-                  in nsIUrlListener aUrlListener,</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineminus">-                  in ACString aMessageIdentifierList,</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineminus">-                  in long numBytes);</span>
<a href="#l5.87"></a><span id="l5.87" class="difflineplus">+  nsIURI getBodyStart(in nsIMsgFolder aImapMailFolder,</span>
<a href="#l5.88"></a><span id="l5.88" class="difflineplus">+                      in nsIUrlListener aUrlListener,</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineplus">+                      in ACString aMessageIdentifierList,</span>
<a href="#l5.90"></a><span id="l5.90" class="difflineplus">+                      in long numBytes);</span>
<a href="#l5.91"></a><span id="l5.91"> </span>
<a href="#l5.92"></a><span id="l5.92">   /**</span>
<a href="#l5.93"></a><span id="l5.93">    * Issue an EXPUNGE on the target folder.</span>
<a href="#l5.94"></a><span id="l5.94">    *</span>
<a href="#l5.95"></a><span id="l5.95" class="difflineminus">-   * @param aClientEventTarget  the event target of the ui thread</span>
<a href="#l5.96"></a><span id="l5.96">    * @param aImapMailFolder     the folder to expunge</span>
<a href="#l5.97"></a><span id="l5.97">    * @param aUrlListener        url listener, can be null</span>
<a href="#l5.98"></a><span id="l5.98">    * @param aMsgWindow          msg window url is running in, can be null</span>
<a href="#l5.99"></a><span id="l5.99">    *</span>
<a href="#l5.100"></a><span id="l5.100">    * @returns the url created to run the expunge.</span>
<a href="#l5.101"></a><span id="l5.101">    */</span>
<a href="#l5.102"></a><span id="l5.102" class="difflineminus">-  void expunge(in nsIEventTarget aClientEventTarget,</span>
<a href="#l5.103"></a><span id="l5.103" class="difflineminus">-               in nsIMsgFolder aImapMailFolder,</span>
<a href="#l5.104"></a><span id="l5.104" class="difflineplus">+  void expunge(in nsIMsgFolder aImapMailFolder,</span>
<a href="#l5.105"></a><span id="l5.105">                in nsIUrlListener aUrlListener,</span>
<a href="#l5.106"></a><span id="l5.106">                in nsIMsgWindow aMsgWindow,</span>
<a href="#l5.107"></a><span id="l5.107">                out nsIURI aURL);</span>
<a href="#l5.108"></a><span id="l5.108"> </span>
<a href="#l5.109"></a><span id="l5.109">   /**</span>
<a href="#l5.110"></a><span id="l5.110">    * Issue a STATUS on the target folder.</span>
<a href="#l5.111"></a><span id="l5.111">    *</span>
<a href="#l5.112"></a><span id="l5.112" class="difflineminus">-   * @param aClientEventTarget  the event target of the ui thread</span>
<a href="#l5.113"></a><span id="l5.113">    * @param aImapMailFolder     the folder to expunge</span>
<a href="#l5.114"></a><span id="l5.114">    * @param aUrlListener        url listener, can be null</span>
<a href="#l5.115"></a><span id="l5.115">    *</span>
<a href="#l5.116"></a><span id="l5.116">    * @returns the url created to run the status.</span>
<a href="#l5.117"></a><span id="l5.117">    */</span>
<a href="#l5.118"></a><span id="l5.118" class="difflineminus">-  nsIURI updateFolderStatus(in nsIEventTarget aClientEventTarget,</span>
<a href="#l5.119"></a><span id="l5.119" class="difflineminus">-                            in nsIMsgFolder aImapMailFolder,</span>
<a href="#l5.120"></a><span id="l5.120" class="difflineplus">+  nsIURI updateFolderStatus(in nsIMsgFolder aImapMailFolder,</span>
<a href="#l5.121"></a><span id="l5.121">                             in nsIUrlListener aUrlListener);</span>
<a href="#l5.122"></a><span id="l5.122"> </span>
<a href="#l5.123"></a><span id="l5.123">   /**</span>
<a href="#l5.124"></a><span id="l5.124">    * Verify that we can login.</span>
<a href="#l5.125"></a><span id="l5.125">    *</span>
<a href="#l5.126"></a><span id="l5.126">    * @param aImapMailFolder - any old imap folder - we just need it to</span>
<a href="#l5.127"></a><span id="l5.127">    *                          set url sinks.</span>
<a href="#l5.128"></a><span id="l5.128">    * @param aMsgWindow    - nsIMsgWindow to use for notification callbacks.</span>
<a href="#l5.129"></a><span id="l5.129">    * @return - the url that we run.</span>
<a href="#l5.130"></a><span id="l5.130">    */</span>
<a href="#l5.131"></a><span id="l5.131">   nsIURI verifyLogon(in nsIMsgFolder aImapMailFolder,</span>
<a href="#l5.132"></a><span id="l5.132">                      in nsIUrlListener aUrlListener,</span>
<a href="#l5.133"></a><span id="l5.133">                      in nsIMsgWindow aMsgWindow);</span>
<a href="#l5.134"></a><span id="l5.134"> </span>
<a href="#l5.135"></a><span id="l5.135" class="difflineminus">-  void biff(in nsIEventTarget aClientEventTarget,</span>
<a href="#l5.136"></a><span id="l5.136" class="difflineminus">-            in nsIMsgFolder aImapMailFolder,</span>
<a href="#l5.137"></a><span id="l5.137" class="difflineplus">+  void biff(in nsIMsgFolder aImapMailFolder,</span>
<a href="#l5.138"></a><span id="l5.138">             in nsIUrlListener aUrlListener,</span>
<a href="#l5.139"></a><span id="l5.139">             out nsIURI aURL,</span>
<a href="#l5.140"></a><span id="l5.140">             in unsigned long aUidHighWater);</span>
<a href="#l5.141"></a><span id="l5.141"> </span>
<a href="#l5.142"></a><span id="l5.142" class="difflineminus">-  void deleteMessages(in nsIEventTarget aClientEventTarget,</span>
<a href="#l5.143"></a><span id="l5.143" class="difflineminus">-                      in nsIMsgFolder aImapMailFolder,</span>
<a href="#l5.144"></a><span id="l5.144" class="difflineplus">+  void deleteMessages(in nsIMsgFolder aImapMailFolder,</span>
<a href="#l5.145"></a><span id="l5.145">                       in nsIUrlListener aUrlListener,</span>
<a href="#l5.146"></a><span id="l5.146">                       out nsIURI aURL,</span>
<a href="#l5.147"></a><span id="l5.147">                       in ACString aMessageIdentifierList,</span>
<a href="#l5.148"></a><span id="l5.148">                       in boolean aMessageIdsAreUID);</span>
<a href="#l5.149"></a><span id="l5.149"> </span>
<a href="#l5.150"></a><span id="l5.150" class="difflineminus">-  void deleteAllMessages(in nsIEventTarget aClientEventTarget,</span>
<a href="#l5.151"></a><span id="l5.151" class="difflineminus">-                         in nsIMsgFolder aImapMailFolder,</span>
<a href="#l5.152"></a><span id="l5.152" class="difflineplus">+  void deleteAllMessages(in nsIMsgFolder aImapMailFolder,</span>
<a href="#l5.153"></a><span id="l5.153">                          in nsIUrlListener aUrlListener,</span>
<a href="#l5.154"></a><span id="l5.154">                          out nsIURI aURL);</span>
<a href="#l5.155"></a><span id="l5.155"> </span>
<a href="#l5.156"></a><span id="l5.156" class="difflineminus">-  void addMessageFlags(in nsIEventTarget aClientEventTarget,</span>
<a href="#l5.157"></a><span id="l5.157" class="difflineminus">-                         in nsIMsgFolder aImapMailFolder,</span>
<a href="#l5.158"></a><span id="l5.158" class="difflineminus">-                         in nsIUrlListener aUrlListener,</span>
<a href="#l5.159"></a><span id="l5.159" class="difflineminus">-                         out nsIURI aURL,</span>
<a href="#l5.160"></a><span id="l5.160" class="difflineminus">-                         in ACString aMessageIdentifierList,</span>
<a href="#l5.161"></a><span id="l5.161" class="difflineminus">-                         in imapMessageFlagsType aFlags,</span>
<a href="#l5.162"></a><span id="l5.162" class="difflineminus">-                         in boolean aMessageIdsAreUID);</span>
<a href="#l5.163"></a><span id="l5.163" class="difflineplus">+  void addMessageFlags(in nsIMsgFolder aImapMailFolder,</span>
<a href="#l5.164"></a><span id="l5.164" class="difflineplus">+                       in nsIUrlListener aUrlListener,</span>
<a href="#l5.165"></a><span id="l5.165" class="difflineplus">+                       out nsIURI aURL,</span>
<a href="#l5.166"></a><span id="l5.166" class="difflineplus">+                       in ACString aMessageIdentifierList,</span>
<a href="#l5.167"></a><span id="l5.167" class="difflineplus">+                       in imapMessageFlagsType aFlags,</span>
<a href="#l5.168"></a><span id="l5.168" class="difflineplus">+                       in boolean aMessageIdsAreUID);</span>
<a href="#l5.169"></a><span id="l5.169"> </span>
<a href="#l5.170"></a><span id="l5.170" class="difflineminus">-  void subtractMessageFlags(in nsIEventTarget aClientEventTarget,</span>
<a href="#l5.171"></a><span id="l5.171" class="difflineminus">-                            in nsIMsgFolder aImapMailFolder,</span>
<a href="#l5.172"></a><span id="l5.172" class="difflineplus">+  void subtractMessageFlags(in nsIMsgFolder aImapMailFolder,</span>
<a href="#l5.173"></a><span id="l5.173">                             in nsIUrlListener aUrlListener,</span>
<a href="#l5.174"></a><span id="l5.174">                             out nsIURI aURL,</span>
<a href="#l5.175"></a><span id="l5.175">                             in ACString aMessageIdentifierList,</span>
<a href="#l5.176"></a><span id="l5.176">                             in imapMessageFlagsType aFlags,</span>
<a href="#l5.177"></a><span id="l5.177">                             in boolean aMessageIdsAreUID);</span>
<a href="#l5.178"></a><span id="l5.178"> </span>
<a href="#l5.179"></a><span id="l5.179" class="difflineminus">-  void setMessageFlags(in nsIEventTarget aClientEventTarget,</span>
<a href="#l5.180"></a><span id="l5.180" class="difflineminus">-                       in nsIMsgFolder aImapMailFolder,</span>
<a href="#l5.181"></a><span id="l5.181" class="difflineplus">+  void setMessageFlags(in nsIMsgFolder aImapMailFolder,</span>
<a href="#l5.182"></a><span id="l5.182">                        in nsIUrlListener aUrlListener,</span>
<a href="#l5.183"></a><span id="l5.183">                        out nsIURI aURL,</span>
<a href="#l5.184"></a><span id="l5.184">                        in ACString aMessageIdentifierList,</span>
<a href="#l5.185"></a><span id="l5.185">                        in imapMessageFlagsType aFlags,</span>
<a href="#l5.186"></a><span id="l5.186">                        in boolean aMessageIdsAreUID);</span>
<a href="#l5.187"></a><span id="l5.187"> </span>
<a href="#l5.188"></a><span id="l5.188" class="difflineminus">-  void discoverAllFolders(in nsIEventTarget aClientEventTarget,</span>
<a href="#l5.189"></a><span id="l5.189" class="difflineminus">-                          in nsIMsgFolder aImapMailFolder,</span>
<a href="#l5.190"></a><span id="l5.190" class="difflineplus">+  void discoverAllFolders(in nsIMsgFolder aImapMailFolder,</span>
<a href="#l5.191"></a><span id="l5.191">                           in nsIUrlListener aUrlListener,</span>
<a href="#l5.192"></a><span id="l5.192">                           in nsIMsgWindow aMsgWindow,</span>
<a href="#l5.193"></a><span id="l5.193">                           out nsIURI aURL);</span>
<a href="#l5.194"></a><span id="l5.194"> </span>
<a href="#l5.195"></a><span id="l5.195" class="difflineminus">-  void discoverAllAndSubscribedFolders(in nsIEventTarget aClientEventTarget,</span>
<a href="#l5.196"></a><span id="l5.196" class="difflineminus">-                                       in nsIMsgFolder aImapMailFolder,</span>
<a href="#l5.197"></a><span id="l5.197" class="difflineplus">+  void discoverAllAndSubscribedFolders(in nsIMsgFolder aImapMailFolder,</span>
<a href="#l5.198"></a><span id="l5.198">                                        in nsIUrlListener aUrlListener,</span>
<a href="#l5.199"></a><span id="l5.199">                                        out nsIURI aURL);</span>
<a href="#l5.200"></a><span id="l5.200" class="difflineminus">-  void discoverChildren(in nsIEventTarget aClientEventTarget,</span>
<a href="#l5.201"></a><span id="l5.201" class="difflineminus">-                        in nsIMsgFolder aImapMailFolder,</span>
<a href="#l5.202"></a><span id="l5.202" class="difflineplus">+</span>
<a href="#l5.203"></a><span id="l5.203" class="difflineplus">+  void discoverChildren(in nsIMsgFolder aImapMailFolder,</span>
<a href="#l5.204"></a><span id="l5.204">                         in nsIUrlListener aUrlListener,</span>
<a href="#l5.205"></a><span id="l5.205">                         in ACString folderPath,</span>
<a href="#l5.206"></a><span id="l5.206">                         out nsIURI aURL);</span>
<a href="#l5.207"></a><span id="l5.207"> </span>
<a href="#l5.208"></a><span id="l5.208" class="difflineminus">-  void onlineMessageCopy(in nsIEventTarget aClientEventTarget,</span>
<a href="#l5.209"></a><span id="l5.209" class="difflineminus">-                         in nsIMsgFolder aSrcFolder,</span>
<a href="#l5.210"></a><span id="l5.210" class="difflineplus">+  void onlineMessageCopy(in nsIMsgFolder aSrcFolder,</span>
<a href="#l5.211"></a><span id="l5.211">                          in ACString aMessageIds,</span>
<a href="#l5.212"></a><span id="l5.212">                          in nsIMsgFolder aDstFolder,</span>
<a href="#l5.213"></a><span id="l5.213">                          in boolean aIdsAreUids,</span>
<a href="#l5.214"></a><span id="l5.214">                          in boolean aIsMove,</span>
<a href="#l5.215"></a><span id="l5.215">                          in nsIUrlListener aUrlListener,</span>
<a href="#l5.216"></a><span id="l5.216">                          out nsIURI aURL,</span>
<a href="#l5.217"></a><span id="l5.217">                          in nsISupports aCopyState,</span>
<a href="#l5.218"></a><span id="l5.218">                          in nsIMsgWindow aWindow);</span>
<a href="#l5.219"></a><span id="l5.219"> </span>
<a href="#l5.220"></a><span id="l5.220"> </span>
<a href="#l5.221"></a><span id="l5.221" class="difflineminus">-  void appendMessageFromFile(in nsIEventTarget aClientEventTarget,</span>
<a href="#l5.222"></a><span id="l5.222" class="difflineminus">-                             in nsIFile aFile,</span>
<a href="#l5.223"></a><span id="l5.223" class="difflineplus">+  void appendMessageFromFile(in nsIFile aFile,</span>
<a href="#l5.224"></a><span id="l5.224">                              in nsIMsgFolder aDstFolder,</span>
<a href="#l5.225"></a><span id="l5.225">                              in ACString aMessageId,</span>
<a href="#l5.226"></a><span id="l5.226">                              in boolean idsAreUids,</span>
<a href="#l5.227"></a><span id="l5.227">                              in boolean aInSelectedState,</span>
<a href="#l5.228"></a><span id="l5.228">                              in nsIUrlListener aUrlListener,</span>
<a href="#l5.229"></a><span id="l5.229">                              out nsIURI aURL,</span>
<a href="#l5.230"></a><span id="l5.230">                              in nsISupports aCopyState,</span>
<a href="#l5.231"></a><span id="l5.231">                              in nsIMsgWindow aMsgWindow);</span>
<a href="#l5.232"></a><span id="l5.232"> </span>
<a href="#l5.233"></a><span id="l5.233">   void downloadMessagesForOffline(in ACString aMessageIds, in nsIMsgFolder aSrcFolder,</span>
<a href="#l5.234"></a><span id="l5.234">                       in nsIUrlListener aListener, in nsIMsgWindow   aMsgWindow);</span>
<a href="#l5.235"></a><span id="l5.235"> </span>
<a href="#l5.236"></a><span id="l5.236" class="difflineminus">-  nsIURI moveFolder(in nsIEventTarget aClientEventTarget,</span>
<a href="#l5.237"></a><span id="l5.237" class="difflineminus">-                    in nsIMsgFolder aSrcFolder,</span>
<a href="#l5.238"></a><span id="l5.238" class="difflineplus">+  nsIURI moveFolder(in nsIMsgFolder aSrcFolder,</span>
<a href="#l5.239"></a><span id="l5.239">                     in nsIMsgFolder aDstFolder,</span>
<a href="#l5.240"></a><span id="l5.240">                     in nsIUrlListener aUrlListener,</span>
<a href="#l5.241"></a><span id="l5.241">                     in nsIMsgWindow msgWindow);</span>
<a href="#l5.242"></a><span id="l5.242"> </span>
<a href="#l5.243"></a><span id="l5.243" class="difflineminus">-  nsIURI renameLeaf(in nsIEventTarget aClientEventTarget,</span>
<a href="#l5.244"></a><span id="l5.244" class="difflineminus">-                    in nsIMsgFolder aSrcFolder,</span>
<a href="#l5.245"></a><span id="l5.245" class="difflineplus">+  nsIURI renameLeaf(in nsIMsgFolder aSrcFolder,</span>
<a href="#l5.246"></a><span id="l5.246">                     in AString aLeafName,</span>
<a href="#l5.247"></a><span id="l5.247">                     in nsIUrlListener aUrlListener,</span>
<a href="#l5.248"></a><span id="l5.248">                     in nsIMsgWindow msgWindow);</span>
<a href="#l5.249"></a><span id="l5.249"> </span>
<a href="#l5.250"></a><span id="l5.250" class="difflineminus">-  nsIURI deleteFolder(in nsIEventTarget aClientEventTarget,</span>
<a href="#l5.251"></a><span id="l5.251" class="difflineminus">-                      in nsIMsgFolder aFolder,</span>
<a href="#l5.252"></a><span id="l5.252" class="difflineplus">+  nsIURI deleteFolder(in nsIMsgFolder aFolder,</span>
<a href="#l5.253"></a><span id="l5.253">                       in nsIUrlListener aUrlListener,</span>
<a href="#l5.254"></a><span id="l5.254">                       in nsIMsgWindow aMsgWindow);</span>
<a href="#l5.255"></a><span id="l5.255"> </span>
<a href="#l5.256"></a><span id="l5.256" class="difflineminus">-  nsIURI createFolder(in nsIEventTarget aClientEventTarget,</span>
<a href="#l5.257"></a><span id="l5.257" class="difflineminus">-                      in nsIMsgFolder aParentFolder,</span>
<a href="#l5.258"></a><span id="l5.258" class="difflineplus">+  nsIURI createFolder(in nsIMsgFolder aParentFolder,</span>
<a href="#l5.259"></a><span id="l5.259">                       in AString aLeafName,</span>
<a href="#l5.260"></a><span id="l5.260">                       in nsIUrlListener aUrlListener);</span>
<a href="#l5.261"></a><span id="l5.261"> </span>
<a href="#l5.262"></a><span id="l5.262" class="difflineminus">-  nsIURI listFolder(in nsIEventTarget aClientEventTarget,</span>
<a href="#l5.263"></a><span id="l5.263" class="difflineminus">-                    in nsIMsgFolder aMailFolder,</span>
<a href="#l5.264"></a><span id="l5.264" class="difflineplus">+  nsIURI listFolder(in nsIMsgFolder aMailFolder,</span>
<a href="#l5.265"></a><span id="l5.265">                     in nsIUrlListener aUrlListener);</span>
<a href="#l5.266"></a><span id="l5.266"> </span>
<a href="#l5.267"></a><span id="l5.267" class="difflineminus">-  nsIURI subscribeFolder(in nsIEventTarget aClientEventTarget,</span>
<a href="#l5.268"></a><span id="l5.268" class="difflineminus">-                         in nsIMsgFolder aMailFolder,</span>
<a href="#l5.269"></a><span id="l5.269" class="difflineplus">+  nsIURI subscribeFolder(in nsIMsgFolder aMailFolder,</span>
<a href="#l5.270"></a><span id="l5.270">                          in AString mailboxName,</span>
<a href="#l5.271"></a><span id="l5.271">                          in nsIUrlListener aUrlListener);</span>
<a href="#l5.272"></a><span id="l5.272"> </span>
<a href="#l5.273"></a><span id="l5.273" class="difflineminus">-  nsIURI unsubscribeFolder(in nsIEventTarget aClientEventTarget,</span>
<a href="#l5.274"></a><span id="l5.274" class="difflineminus">-                           in nsIMsgFolder aMailFolder,</span>
<a href="#l5.275"></a><span id="l5.275" class="difflineplus">+  nsIURI unsubscribeFolder(in nsIMsgFolder aMailFolder,</span>
<a href="#l5.276"></a><span id="l5.276">                            in AString mailboxName,</span>
<a href="#l5.277"></a><span id="l5.277">                            in nsIUrlListener aUrlListener);</span>
<a href="#l5.278"></a><span id="l5.278"> </span>
<a href="#l5.279"></a><span id="l5.279">   // this method will first check if the folder exists but is</span>
<a href="#l5.280"></a><span id="l5.280">   // not subscribed to, in which case it will subscribe to the folder.</span>
<a href="#l5.281"></a><span id="l5.281">   // otherwise, it will try to create the folder. It will try to do this</span>
<a href="#l5.282"></a><span id="l5.282">   // with one url.</span>
<a href="#l5.283"></a><span id="l5.283" class="difflineminus">-  nsIURI ensureFolderExists(in nsIEventTarget aClientEventTarget,</span>
<a href="#l5.284"></a><span id="l5.284" class="difflineminus">-                            in nsIMsgFolder aParentFolder,</span>
<a href="#l5.285"></a><span id="l5.285" class="difflineplus">+  nsIURI ensureFolderExists(in nsIMsgFolder aParentFolder,</span>
<a href="#l5.286"></a><span id="l5.286">                             in AString aLeafName,</span>
<a href="#l5.287"></a><span id="l5.287">                             in nsIUrlListener aUrlListener);</span>
<a href="#l5.288"></a><span id="l5.288"> </span>
<a href="#l5.289"></a><span id="l5.289"> </span>
<a href="#l5.290"></a><span id="l5.290" class="difflineminus">-  nsIURI getFolderAdminUrl(in nsIEventTarget aClientEventTarget,</span>
<a href="#l5.291"></a><span id="l5.291" class="difflineminus">-                      in nsIMsgFolder aMailFolder,</span>
<a href="#l5.292"></a><span id="l5.292" class="difflineminus">-                      in nsIMsgWindow   aMsgWindow,</span>
<a href="#l5.293"></a><span id="l5.293" class="difflineminus">-                      in nsIUrlListener aUrlListener);</span>
<a href="#l5.294"></a><span id="l5.294" class="difflineplus">+  nsIURI getFolderAdminUrl(in nsIMsgFolder aMailFolder,</span>
<a href="#l5.295"></a><span id="l5.295" class="difflineplus">+                           in nsIMsgWindow   aMsgWindow,</span>
<a href="#l5.296"></a><span id="l5.296" class="difflineplus">+                           in nsIUrlListener aUrlListener);</span>
<a href="#l5.297"></a><span id="l5.297"> </span>
<a href="#l5.298"></a><span id="l5.298" class="difflineminus">-  nsIURI issueCommandOnMsgs(in nsIEventTarget aClientEventTarget,</span>
<a href="#l5.299"></a><span id="l5.299" class="difflineminus">-                      in nsIMsgFolder aMailFolder,</span>
<a href="#l5.300"></a><span id="l5.300" class="difflineminus">-                      in nsIMsgWindow aMsgWindow,</span>
<a href="#l5.301"></a><span id="l5.301" class="difflineminus">-                      in ACString aCommand,</span>
<a href="#l5.302"></a><span id="l5.302" class="difflineminus">-                      in ACString aMessageIdentifierList);</span>
<a href="#l5.303"></a><span id="l5.303" class="difflineplus">+  nsIURI issueCommandOnMsgs(in nsIMsgFolder aMailFolder,</span>
<a href="#l5.304"></a><span id="l5.304" class="difflineplus">+                            in nsIMsgWindow aMsgWindow,</span>
<a href="#l5.305"></a><span id="l5.305" class="difflineplus">+                            in ACString aCommand,</span>
<a href="#l5.306"></a><span id="l5.306" class="difflineplus">+                            in ACString aMessageIdentifierList);</span>
<a href="#l5.307"></a><span id="l5.307"> </span>
<a href="#l5.308"></a><span id="l5.308" class="difflineminus">-  nsIURI fetchCustomMsgAttribute(in nsIEventTarget aClientEventTarget,</span>
<a href="#l5.309"></a><span id="l5.309" class="difflineminus">-                      in nsIMsgFolder aMailFolder,</span>
<a href="#l5.310"></a><span id="l5.310" class="difflineminus">-                      in nsIMsgWindow aMsgWindow,</span>
<a href="#l5.311"></a><span id="l5.311" class="difflineminus">-                      in ACString aAttribute,</span>
<a href="#l5.312"></a><span id="l5.312" class="difflineminus">-                      in ACString aMessageIdentifierList);</span>
<a href="#l5.313"></a><span id="l5.313" class="difflineplus">+  nsIURI fetchCustomMsgAttribute(in nsIMsgFolder aMailFolder,</span>
<a href="#l5.314"></a><span id="l5.314" class="difflineplus">+                                 in nsIMsgWindow aMsgWindow,</span>
<a href="#l5.315"></a><span id="l5.315" class="difflineplus">+                                 in ACString aAttribute,</span>
<a href="#l5.316"></a><span id="l5.316" class="difflineplus">+                                 in ACString aMessageIdentifierList);</span>
<a href="#l5.317"></a><span id="l5.317"> </span>
<a href="#l5.318"></a><span id="l5.318" class="difflineminus">-  nsIURI storeCustomKeywords(in nsIEventTarget aClientEventTarget,</span>
<a href="#l5.319"></a><span id="l5.319" class="difflineminus">-                      in nsIMsgFolder aMailFolder,</span>
<a href="#l5.320"></a><span id="l5.320" class="difflineminus">-                      in nsIMsgWindow aMsgWindow,</span>
<a href="#l5.321"></a><span id="l5.321" class="difflineminus">-                      in ACString flagsToAdd,</span>
<a href="#l5.322"></a><span id="l5.322" class="difflineminus">-                      in ACString flagsToSubtract,</span>
<a href="#l5.323"></a><span id="l5.323" class="difflineminus">-                      in ACString aMessageIdentifierList);</span>
<a href="#l5.324"></a><span id="l5.324" class="difflineplus">+  nsIURI storeCustomKeywords(in nsIMsgFolder aMailFolder,</span>
<a href="#l5.325"></a><span id="l5.325" class="difflineplus">+                             in nsIMsgWindow aMsgWindow,</span>
<a href="#l5.326"></a><span id="l5.326" class="difflineplus">+                             in ACString flagsToAdd,</span>
<a href="#l5.327"></a><span id="l5.327" class="difflineplus">+                             in ACString flagsToSubtract,</span>
<a href="#l5.328"></a><span id="l5.328" class="difflineplus">+                             in ACString aMessageIdentifierList);</span>
<a href="#l5.329"></a><span id="l5.329"> </span>
<a href="#l5.330"></a><span id="l5.330">   void getListOfFoldersOnServer(in nsIImapIncomingServer aServer, in nsIMsgWindow aMsgWindow);</span>
<a href="#l5.331"></a><span id="l5.331">   void getListOfFoldersWithPath(in nsIImapIncomingServer aServer, in nsIMsgWindow aMsgWindow, in ACString folderPath);</span>
<a href="#l5.332"></a><span id="l5.332"> </span>
<a href="#l5.333"></a><span id="l5.333">   nsISupports playbackAllOfflineOperations(in nsIMsgWindow aMsgWindow, in nsIUrlListener aListener);</span>
<a href="#l5.334"></a><span id="l5.334">   void downloadAllOffineImapFolders(in nsIMsgWindow aMsgWindow, in nsIUrlListener aListener);</span>
<a href="#l5.335"></a><span id="l5.335"> </span>
<a href="#l5.336"></a><span id="l5.336">   readonly attribute nsICacheSession cacheSession;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/imap/src/nsImapIncomingServer.cpp</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapIncomingServer.cpp</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -436,23 +436,22 @@ nsImapIncomingServer::SetIsAOLServer(boo</span>
<a href="#l6.4"></a><span id="l6.4">   if (aBool)</span>
<a href="#l6.5"></a><span id="l6.5">     m_capability |= kAOLImapCapability;</span>
<a href="#l6.6"></a><span id="l6.6">   else</span>
<a href="#l6.7"></a><span id="l6.7">     m_capability &amp;= ~kAOLImapCapability;</span>
<a href="#l6.8"></a><span id="l6.8">   return NS_OK;</span>
<a href="#l6.9"></a><span id="l6.9"> }</span>
<a href="#l6.10"></a><span id="l6.10"> </span>
<a href="#l6.11"></a><span id="l6.11"> NS_IMETHODIMP</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-nsImapIncomingServer::GetImapConnectionAndLoadUrl(nsIEventTarget * aClientEventTarget,</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-                                                  nsIImapUrl* aImapUrl,</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+nsImapIncomingServer::GetImapConnectionAndLoadUrl(nsIImapUrl* aImapUrl,</span>
<a href="#l6.15"></a><span id="l6.15">                                                   nsISupports* aConsumer)</span>
<a href="#l6.16"></a><span id="l6.16"> {</span>
<a href="#l6.17"></a><span id="l6.17">   nsCOMPtr&lt;nsIImapProtocol&gt; aProtocol;</span>
<a href="#l6.18"></a><span id="l6.18"> </span>
<a href="#l6.19"></a><span id="l6.19" class="difflineminus">-  nsresult rv = GetImapConnection(aClientEventTarget, aImapUrl, getter_AddRefs(aProtocol));</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+  nsresult rv = GetImapConnection(aImapUrl, getter_AddRefs(aProtocol));</span>
<a href="#l6.21"></a><span id="l6.21">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.22"></a><span id="l6.22"> </span>
<a href="#l6.23"></a><span id="l6.23">   nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(aImapUrl, &amp;rv);</span>
<a href="#l6.24"></a><span id="l6.24">   if (aProtocol)</span>
<a href="#l6.25"></a><span id="l6.25">   {</span>
<a href="#l6.26"></a><span id="l6.26">     rv = aProtocol-&gt;LoadImapUrl(mailnewsurl, aConsumer);</span>
<a href="#l6.27"></a><span id="l6.27">     // *** jt - in case of the time out situation or the connection gets</span>
<a href="#l6.28"></a><span id="l6.28">     // terminated by some unforseen problems let's give it a second chance</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineat">@@ -460,17 +459,17 @@ nsImapIncomingServer::GetImapConnectionA</span>
<a href="#l6.30"></a><span id="l6.30">     if (NS_FAILED(rv))</span>
<a href="#l6.31"></a><span id="l6.31">     {</span>
<a href="#l6.32"></a><span id="l6.32">       NS_ASSERTION(false, &quot;shouldn't get an error loading url&quot;);</span>
<a href="#l6.33"></a><span id="l6.33">       rv = aProtocol-&gt;LoadImapUrl(mailnewsurl, aConsumer);</span>
<a href="#l6.34"></a><span id="l6.34">     }</span>
<a href="#l6.35"></a><span id="l6.35">   }</span>
<a href="#l6.36"></a><span id="l6.36">   else</span>
<a href="#l6.37"></a><span id="l6.37">   {   // unable to get an imap connection to run the url; add to the url</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineminus">-    // queue</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineplus">+     // queue</span>
<a href="#l6.40"></a><span id="l6.40">     nsImapProtocol::LogImapUrl(&quot;queuing url&quot;, aImapUrl);</span>
<a href="#l6.41"></a><span id="l6.41">     PR_CEnterMonitor(this);</span>
<a href="#l6.42"></a><span id="l6.42">     m_urlQueue.AppendObject(aImapUrl);</span>
<a href="#l6.43"></a><span id="l6.43">     m_urlConsumers.AppendElement((void*)aConsumer);</span>
<a href="#l6.44"></a><span id="l6.44">     NS_IF_ADDREF(aConsumer);</span>
<a href="#l6.45"></a><span id="l6.45">     PR_CExitMonitor(this);</span>
<a href="#l6.46"></a><span id="l6.46">     // let's try running it now - maybe the connection is free now.</span>
<a href="#l6.47"></a><span id="l6.47">     bool urlRun;</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineat">@@ -506,17 +505,17 @@ NS_IMETHODIMP</span>
<a href="#l6.49"></a><span id="l6.49"> nsImapIncomingServer::RetryUrl(nsIImapUrl *aImapUrl, nsIImapMockChannel *aChannel)</span>
<a href="#l6.50"></a><span id="l6.50"> {</span>
<a href="#l6.51"></a><span id="l6.51">   nsresult rv;</span>
<a href="#l6.52"></a><span id="l6.52">   // Get current thread envent queue</span>
<a href="#l6.53"></a><span id="l6.53">   aImapUrl-&gt;SetMockChannel(aChannel);</span>
<a href="#l6.54"></a><span id="l6.54">   nsCOMPtr &lt;nsIImapProtocol&gt; protocolInstance;</span>
<a href="#l6.55"></a><span id="l6.55">   nsImapProtocol::LogImapUrl(&quot;creating protocol instance to retry queued url&quot;, aImapUrl);</span>
<a href="#l6.56"></a><span id="l6.56">   nsCOMPtr&lt;nsIThread&gt; thread(do_GetCurrentThread());</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineminus">-  rv = GetImapConnection(thread, aImapUrl, getter_AddRefs(protocolInstance));</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineplus">+  rv = GetImapConnection(aImapUrl, getter_AddRefs(protocolInstance));</span>
<a href="#l6.59"></a><span id="l6.59">   if (NS_SUCCEEDED(rv) &amp;&amp; protocolInstance)</span>
<a href="#l6.60"></a><span id="l6.60">   {</span>
<a href="#l6.61"></a><span id="l6.61">     nsCOMPtr&lt;nsIURI&gt; url = do_QueryInterface(aImapUrl, &amp;rv);</span>
<a href="#l6.62"></a><span id="l6.62">     if (NS_SUCCEEDED(rv) &amp;&amp; url)</span>
<a href="#l6.63"></a><span id="l6.63">     {</span>
<a href="#l6.64"></a><span id="l6.64">       nsImapProtocol::LogImapUrl(&quot;retrying  url&quot;, aImapUrl);</span>
<a href="#l6.65"></a><span id="l6.65">       rv = protocolInstance-&gt;LoadImapUrl(url, nsnull); // ### need to save the display consumer.</span>
<a href="#l6.66"></a><span id="l6.66">       NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed running queued url&quot;);</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineat">@@ -526,16 +525,19 @@ nsImapIncomingServer::RetryUrl(nsIImapUr</span>
<a href="#l6.68"></a><span id="l6.68"> }</span>
<a href="#l6.69"></a><span id="l6.69"> </span>
<a href="#l6.70"></a><span id="l6.70"> // checks to see if there are any queued urls on this incoming server,</span>
<a href="#l6.71"></a><span id="l6.71"> // and if so, tries to run the oldest one. Returns true if the url is run</span>
<a href="#l6.72"></a><span id="l6.72"> // on the passed in protocol connection.</span>
<a href="#l6.73"></a><span id="l6.73"> NS_IMETHODIMP</span>
<a href="#l6.74"></a><span id="l6.74"> nsImapIncomingServer::LoadNextQueuedUrl(nsIImapProtocol *aProtocol, bool *aResult)</span>
<a href="#l6.75"></a><span id="l6.75"> {</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineplus">+  if (WeAreOffline())</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineplus">+    return NS_MSG_ERROR_OFFLINE;</span>
<a href="#l6.78"></a><span id="l6.78" class="difflineplus">+</span>
<a href="#l6.79"></a><span id="l6.79">   nsresult rv = NS_OK;</span>
<a href="#l6.80"></a><span id="l6.80">   bool urlRun = false;</span>
<a href="#l6.81"></a><span id="l6.81">   bool keepGoing = true;</span>
<a href="#l6.82"></a><span id="l6.82">   nsCOMPtr &lt;nsIImapProtocol&gt;  protocolInstance ;</span>
<a href="#l6.83"></a><span id="l6.83"> </span>
<a href="#l6.84"></a><span id="l6.84">   MutexAutoLock mon(mLock);</span>
<a href="#l6.85"></a><span id="l6.85">   PRInt32 cnt = m_urlQueue.Count();</span>
<a href="#l6.86"></a><span id="l6.86"> </span>
<a href="#l6.87"></a><span id="l6.87" class="difflineat">@@ -552,17 +554,17 @@ nsImapIncomingServer::LoadNextQueuedUrl(</span>
<a href="#l6.88"></a><span id="l6.88">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.89"></a><span id="l6.89">       // if we didn't doom the url, lets run it.</span>
<a href="#l6.90"></a><span id="l6.90">       if (!removeUrlFromQueue)</span>
<a href="#l6.91"></a><span id="l6.91">       {</span>
<a href="#l6.92"></a><span id="l6.92">         nsISupports *aConsumer = (nsISupports*)m_urlConsumers.ElementAt(0);</span>
<a href="#l6.93"></a><span id="l6.93">         NS_IF_ADDREF(aConsumer);</span>
<a href="#l6.94"></a><span id="l6.94"> </span>
<a href="#l6.95"></a><span id="l6.95">         nsImapProtocol::LogImapUrl(&quot;creating protocol instance to play queued url&quot;, aImapUrl);</span>
<a href="#l6.96"></a><span id="l6.96" class="difflineminus">-        rv = GetImapConnection(nsnull, aImapUrl, getter_AddRefs(protocolInstance));</span>
<a href="#l6.97"></a><span id="l6.97" class="difflineplus">+        rv = GetImapConnection(aImapUrl, getter_AddRefs(protocolInstance));</span>
<a href="#l6.98"></a><span id="l6.98">         if (NS_SUCCEEDED(rv) &amp;&amp; protocolInstance)</span>
<a href="#l6.99"></a><span id="l6.99">         {</span>
<a href="#l6.100"></a><span id="l6.100">           nsCOMPtr&lt;nsIURI&gt; url = do_QueryInterface(aImapUrl, &amp;rv);</span>
<a href="#l6.101"></a><span id="l6.101">           if (NS_SUCCEEDED(rv) &amp;&amp; url)</span>
<a href="#l6.102"></a><span id="l6.102">           {</span>
<a href="#l6.103"></a><span id="l6.103">             nsImapProtocol::LogImapUrl(&quot;playing queued url&quot;, aImapUrl);</span>
<a href="#l6.104"></a><span id="l6.104">             rv = protocolInstance-&gt;LoadImapUrl(url, aConsumer);</span>
<a href="#l6.105"></a><span id="l6.105">             NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed running queued url&quot;);</span>
<a href="#l6.106"></a><span id="l6.106" class="difflineat">@@ -712,19 +714,18 @@ nsImapIncomingServer::ConnectionTimeOut(</span>
<a href="#l6.107"></a><span id="l6.107">         aProtocol-&gt;TellThreadToDie(false);</span>
<a href="#l6.108"></a><span id="l6.108">         retVal = true;</span>
<a href="#l6.109"></a><span id="l6.109">       }</span>
<a href="#l6.110"></a><span id="l6.110">   }</span>
<a href="#l6.111"></a><span id="l6.111">   return retVal;</span>
<a href="#l6.112"></a><span id="l6.112"> }</span>
<a href="#l6.113"></a><span id="l6.113"> </span>
<a href="#l6.114"></a><span id="l6.114"> nsresult</span>
<a href="#l6.115"></a><span id="l6.115" class="difflineminus">-nsImapIncomingServer::GetImapConnection(nsIEventTarget *aEventTarget,</span>
<a href="#l6.116"></a><span id="l6.116" class="difflineminus">-                                           nsIImapUrl * aImapUrl,</span>
<a href="#l6.117"></a><span id="l6.117" class="difflineminus">-                                           nsIImapProtocol ** aImapConnection)</span>
<a href="#l6.118"></a><span id="l6.118" class="difflineplus">+nsImapIncomingServer::GetImapConnection(nsIImapUrl * aImapUrl,</span>
<a href="#l6.119"></a><span id="l6.119" class="difflineplus">+                                        nsIImapProtocol ** aImapConnection)</span>
<a href="#l6.120"></a><span id="l6.120"> {</span>
<a href="#l6.121"></a><span id="l6.121">   nsresult rv = NS_OK;</span>
<a href="#l6.122"></a><span id="l6.122">   bool canRunUrlImmediately = false;</span>
<a href="#l6.123"></a><span id="l6.123">   bool canRunButBusy = false;</span>
<a href="#l6.124"></a><span id="l6.124">   nsCOMPtr&lt;nsIImapProtocol&gt; connection;</span>
<a href="#l6.125"></a><span id="l6.125">   nsCOMPtr&lt;nsIImapProtocol&gt; freeConnection;</span>
<a href="#l6.126"></a><span id="l6.126">   bool isBusy = false;</span>
<a href="#l6.127"></a><span id="l6.127">   bool isInboxConnection = false;</span>
<a href="#l6.128"></a><span id="l6.128" class="difflineat">@@ -838,19 +839,19 @@ nsImapIncomingServer::GetImapConnection(</span>
<a href="#l6.129"></a><span id="l6.129">   else if (userCancelled)</span>
<a href="#l6.130"></a><span id="l6.130">   {</span>
<a href="#l6.131"></a><span id="l6.131">     rv = NS_BINDING_ABORTED;  // user cancelled</span>
<a href="#l6.132"></a><span id="l6.132">   }</span>
<a href="#l6.133"></a><span id="l6.133">   // CanHandleUrl will pretend that some types of urls require a selected state url</span>
<a href="#l6.134"></a><span id="l6.134">   // (e.g., a folder delete or msg append) but we shouldn't create new connections</span>
<a href="#l6.135"></a><span id="l6.135">   // for these types of urls if we have a free connection. So we check the actual</span>
<a href="#l6.136"></a><span id="l6.136">   // required state here.</span>
<a href="#l6.137"></a><span id="l6.137" class="difflineminus">-  else if (cnt &lt; maxConnections &amp;&amp; aEventTarget</span>
<a href="#l6.138"></a><span id="l6.138" class="difflineplus">+  else if (cnt &lt; maxConnections</span>
<a href="#l6.139"></a><span id="l6.139">       &amp;&amp; (!freeConnection || requiredState == nsIImapUrl::nsImapSelectedState))</span>
<a href="#l6.140"></a><span id="l6.140" class="difflineminus">-    rv = CreateProtocolInstance(aEventTarget, aImapConnection);</span>
<a href="#l6.141"></a><span id="l6.141" class="difflineplus">+    rv = CreateProtocolInstance(aImapConnection);</span>
<a href="#l6.142"></a><span id="l6.142">   else if (freeConnection)</span>
<a href="#l6.143"></a><span id="l6.143">   {</span>
<a href="#l6.144"></a><span id="l6.144">     *aImapConnection = freeConnection;</span>
<a href="#l6.145"></a><span id="l6.145">     NS_IF_ADDREF(*aImapConnection);</span>
<a href="#l6.146"></a><span id="l6.146">   }</span>
<a href="#l6.147"></a><span id="l6.147">   else // cannot get anyone to handle the url queue it</span>
<a href="#l6.148"></a><span id="l6.148">   {</span>
<a href="#l6.149"></a><span id="l6.149">     if (cnt &gt;= maxConnections)</span>
<a href="#l6.150"></a><span id="l6.150" class="difflineat">@@ -858,18 +859,17 @@ nsImapIncomingServer::GetImapConnection(</span>
<a href="#l6.151"></a><span id="l6.151">       // caller will queue the url</span>
<a href="#l6.152"></a><span id="l6.152">   }</span>
<a href="#l6.153"></a><span id="l6.153"> </span>
<a href="#l6.154"></a><span id="l6.154">   PR_CExitMonitor(this);</span>
<a href="#l6.155"></a><span id="l6.155">   return rv;</span>
<a href="#l6.156"></a><span id="l6.156"> }</span>
<a href="#l6.157"></a><span id="l6.157"> </span>
<a href="#l6.158"></a><span id="l6.158"> nsresult</span>
<a href="#l6.159"></a><span id="l6.159" class="difflineminus">-nsImapIncomingServer::CreateProtocolInstance(nsIEventTarget *aEventTarget,</span>
<a href="#l6.160"></a><span id="l6.160" class="difflineminus">-                                             nsIImapProtocol ** aImapConnection)</span>
<a href="#l6.161"></a><span id="l6.161" class="difflineplus">+nsImapIncomingServer::CreateProtocolInstance(nsIImapProtocol ** aImapConnection)</span>
<a href="#l6.162"></a><span id="l6.162"> {</span>
<a href="#l6.163"></a><span id="l6.163">   // create a new connection and add it to the connection cache</span>
<a href="#l6.164"></a><span id="l6.164">   // we may need to flag the protocol connection as busy so we don't get</span>
<a href="#l6.165"></a><span id="l6.165">   // a race condition where someone else goes through this code</span>
<a href="#l6.166"></a><span id="l6.166"> </span>
<a href="#l6.167"></a><span id="l6.167">   PRInt32 authMethod;</span>
<a href="#l6.168"></a><span id="l6.168">   GetAuthMethod(&amp;authMethod);</span>
<a href="#l6.169"></a><span id="l6.169">   nsresult rv;</span>
<a href="#l6.170"></a><span id="l6.170" class="difflineat">@@ -890,17 +890,17 @@ nsImapIncomingServer::CreateProtocolInst</span>
<a href="#l6.171"></a><span id="l6.171">   }</span>
<a href="#l6.172"></a><span id="l6.172">   nsIImapProtocol * protocolInstance;</span>
<a href="#l6.173"></a><span id="l6.173">   rv = CallCreateInstance(kImapProtocolCID, &amp;protocolInstance);</span>
<a href="#l6.174"></a><span id="l6.174">   if (NS_SUCCEEDED(rv) &amp;&amp; protocolInstance)</span>
<a href="#l6.175"></a><span id="l6.175">   {</span>
<a href="#l6.176"></a><span id="l6.176">     nsCOMPtr&lt;nsIImapHostSessionList&gt; hostSession =</span>
<a href="#l6.177"></a><span id="l6.177">       do_GetService(kCImapHostSessionListCID, &amp;rv);</span>
<a href="#l6.178"></a><span id="l6.178">     if (NS_SUCCEEDED(rv))</span>
<a href="#l6.179"></a><span id="l6.179" class="difflineminus">-      rv = protocolInstance-&gt;Initialize(hostSession, this, aEventTarget);</span>
<a href="#l6.180"></a><span id="l6.180" class="difflineplus">+      rv = protocolInstance-&gt;Initialize(hostSession, this);</span>
<a href="#l6.181"></a><span id="l6.181">   }</span>
<a href="#l6.182"></a><span id="l6.182"> </span>
<a href="#l6.183"></a><span id="l6.183">   // take the protocol instance and add it to the connectionCache</span>
<a href="#l6.184"></a><span id="l6.184">   if (protocolInstance)</span>
<a href="#l6.185"></a><span id="l6.185">     m_connectionCache.AppendObject(protocolInstance);</span>
<a href="#l6.186"></a><span id="l6.186">   *aImapConnection = protocolInstance; // this is already ref counted.</span>
<a href="#l6.187"></a><span id="l6.187">   return rv;</span>
<a href="#l6.188"></a><span id="l6.188"> }</span>
<a href="#l6.189"></a><span id="l6.189" class="difflineat">@@ -991,17 +991,17 @@ nsImapIncomingServer::PerformExpand(nsIM</span>
<a href="#l6.190"></a><span id="l6.190">   rv = GetRootFolder(getter_AddRefs(rootMsgFolder));</span>
<a href="#l6.191"></a><span id="l6.191">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.192"></a><span id="l6.192"> </span>
<a href="#l6.193"></a><span id="l6.193">   if (!rootMsgFolder) return NS_ERROR_FAILURE;</span>
<a href="#l6.194"></a><span id="l6.194"> </span>
<a href="#l6.195"></a><span id="l6.195">   nsCOMPtr&lt;nsIImapService&gt; imapService = do_GetService(NS_IMAPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l6.196"></a><span id="l6.196">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.197"></a><span id="l6.197">   nsCOMPtr&lt;nsIThread&gt; thread(do_GetCurrentThread());</span>
<a href="#l6.198"></a><span id="l6.198" class="difflineminus">-  rv = imapService-&gt;DiscoverAllFolders(thread, rootMsgFolder,</span>
<a href="#l6.199"></a><span id="l6.199" class="difflineplus">+  rv = imapService-&gt;DiscoverAllFolders(rootMsgFolder,</span>
<a href="#l6.200"></a><span id="l6.200">                                        this, aMsgWindow, nsnull);</span>
<a href="#l6.201"></a><span id="l6.201">   return rv;</span>
<a href="#l6.202"></a><span id="l6.202"> }</span>
<a href="#l6.203"></a><span id="l6.203"> </span>
<a href="#l6.204"></a><span id="l6.204"> NS_IMETHODIMP</span>
<a href="#l6.205"></a><span id="l6.205"> nsImapIncomingServer::VerifyLogon(nsIUrlListener *aUrlListener,</span>
<a href="#l6.206"></a><span id="l6.206">                                   nsIMsgWindow *aMsgWindow, nsIURI **aURL)</span>
<a href="#l6.207"></a><span id="l6.207"> {</span>
<a href="#l6.208"></a><span id="l6.208" class="difflineat">@@ -2565,19 +2565,19 @@ nsImapIncomingServer::SubscribeToFolder(</span>
<a href="#l6.209"></a><span id="l6.209"> </span>
<a href="#l6.210"></a><span id="l6.210">   nsCOMPtr&lt;nsIThread&gt; thread(do_GetCurrentThread());</span>
<a href="#l6.211"></a><span id="l6.211"> </span>
<a href="#l6.212"></a><span id="l6.212">   nsAutoString unicodeName;</span>
<a href="#l6.213"></a><span id="l6.213">   rv = CopyMUTF7toUTF16(folderCName, unicodeName);</span>
<a href="#l6.214"></a><span id="l6.214">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.215"></a><span id="l6.215"> </span>
<a href="#l6.216"></a><span id="l6.216">   if (subscribe)</span>
<a href="#l6.217"></a><span id="l6.217" class="difflineminus">-    rv = imapService-&gt;SubscribeFolder(thread, msgFolder, unicodeName, nsnull, aUri);</span>
<a href="#l6.218"></a><span id="l6.218" class="difflineplus">+    rv = imapService-&gt;SubscribeFolder(msgFolder, unicodeName, nsnull, aUri);</span>
<a href="#l6.219"></a><span id="l6.219">   else</span>
<a href="#l6.220"></a><span id="l6.220" class="difflineminus">-    rv = imapService-&gt;UnsubscribeFolder(thread, msgFolder, unicodeName, nsnull, nsnull);</span>
<a href="#l6.221"></a><span id="l6.221" class="difflineplus">+    rv = imapService-&gt;UnsubscribeFolder(msgFolder, unicodeName, nsnull, nsnull);</span>
<a href="#l6.222"></a><span id="l6.222">   return rv;</span>
<a href="#l6.223"></a><span id="l6.223"> }</span>
<a href="#l6.224"></a><span id="l6.224"> </span>
<a href="#l6.225"></a><span id="l6.225"> NS_IMETHODIMP</span>
<a href="#l6.226"></a><span id="l6.226"> nsImapIncomingServer::SetDoingLsub(bool doingLsub)</span>
<a href="#l6.227"></a><span id="l6.227"> {</span>
<a href="#l6.228"></a><span id="l6.228">   mDoingLsub = doingLsub;</span>
<a href="#l6.229"></a><span id="l6.229">   return NS_OK;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/imap/src/nsImapIncomingServer.h</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapIncomingServer.h</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -45,17 +45,16 @@</span>
<a href="#l7.4"></a><span id="l7.4"> #include &quot;nsIImapServerSink.h&quot;</span>
<a href="#l7.5"></a><span id="l7.5"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l7.6"></a><span id="l7.6"> #include &quot;nsISubscribableServer.h&quot;</span>
<a href="#l7.7"></a><span id="l7.7"> #include &quot;nsIUrlListener.h&quot;</span>
<a href="#l7.8"></a><span id="l7.8"> #include &quot;nsIMsgImapMailFolder.h&quot;</span>
<a href="#l7.9"></a><span id="l7.9"> #include &quot;nsCOMArray.h&quot;</span>
<a href="#l7.10"></a><span id="l7.10"> #include &quot;mozilla/Mutex.h&quot;</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-class nsIEventTarget;</span>
<a href="#l7.13"></a><span id="l7.13"> class nsIRDFService;</span>
<a href="#l7.14"></a><span id="l7.14"> </span>
<a href="#l7.15"></a><span id="l7.15"> /* get some implementation from nsMsgIncomingServer */</span>
<a href="#l7.16"></a><span id="l7.16"> class nsImapIncomingServer : public nsMsgIncomingServer,</span>
<a href="#l7.17"></a><span id="l7.17">                              public nsIImapIncomingServer,</span>
<a href="#l7.18"></a><span id="l7.18">                              public nsIImapServerSink,</span>
<a href="#l7.19"></a><span id="l7.19">                              public nsISubscribableServer,</span>
<a href="#l7.20"></a><span id="l7.20">                              public nsIUrlListener</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineat">@@ -114,21 +113,19 @@ protected:</span>
<a href="#l7.22"></a><span id="l7.22">   bool AllDescendentsAreNoSelect(nsIMsgFolder *parentFolder);</span>
<a href="#l7.23"></a><span id="l7.23"> </span>
<a href="#l7.24"></a><span id="l7.24">   nsresult GetStringBundle();</span>
<a href="#l7.25"></a><span id="l7.25">   nsString GetImapStringByName(const nsString &amp;aName);</span>
<a href="#l7.26"></a><span id="l7.26">   static nsresult AlertUser(const nsAString&amp; aString, nsIMsgMailNewsUrl *aUrl);</span>
<a href="#l7.27"></a><span id="l7.27"> </span>
<a href="#l7.28"></a><span id="l7.28"> private:</span>
<a href="#l7.29"></a><span id="l7.29">   nsresult SubscribeToFolder(const PRUnichar *aName, bool subscribe);</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineminus">-  nsresult GetImapConnection (nsIEventTarget* aEventTarget,</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">-                                   nsIImapUrl* aImapUrl,</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineminus">-                                   nsIImapProtocol** aImapConnection);</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineminus">-  nsresult CreateProtocolInstance(nsIEventTarget *aEventTarget,</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineminus">-                                           nsIImapProtocol ** aImapConnection);</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineplus">+  nsresult GetImapConnection(nsIImapUrl* aImapUrl,</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+                             nsIImapProtocol** aImapConnection);</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+  nsresult CreateProtocolInstance(nsIImapProtocol ** aImapConnection);</span>
<a href="#l7.38"></a><span id="l7.38">   nsresult CreateHostSpecificPrefName(const char *prefPrefix, nsCAutoString &amp;prefName);</span>
<a href="#l7.39"></a><span id="l7.39"> </span>
<a href="#l7.40"></a><span id="l7.40">   nsresult DoomUrlIfChannelHasError(nsIImapUrl *aImapUrl, bool *urlDoomed);</span>
<a href="#l7.41"></a><span id="l7.41">   bool ConnectionTimeOut(nsIImapProtocol* aImapConnection);</span>
<a href="#l7.42"></a><span id="l7.42">   nsresult GetFormattedStringFromID(const nsAString&amp; aValue, PRInt32 aID, nsAString&amp; aResult);</span>
<a href="#l7.43"></a><span id="l7.43">   nsresult GetPrefForServerAttribute(const char *prefSuffix, bool *prefValue);</span>
<a href="#l7.44"></a><span id="l7.44">   bool CheckSpecialFolder(nsIRDFService *rdf, nsCString &amp;folderUri,</span>
<a href="#l7.45"></a><span id="l7.45">                             PRUint32 folderFlag, nsCString &amp;existingUri);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -230,17 +230,16 @@ nsImapMailFolder::nsImapMailFolder() :</span>
<a href="#l8.4"></a><span id="l8.4">     m_folderQuotaMaxKB(0),</span>
<a href="#l8.5"></a><span id="l8.5">     m_compactingOfflineStore(false),</span>
<a href="#l8.6"></a><span id="l8.6">     m_expunging(false),</span>
<a href="#l8.7"></a><span id="l8.7">     m_applyIncomingFilters(false),</span>
<a href="#l8.8"></a><span id="l8.8">     m_filterListRequiresBody(false)</span>
<a href="#l8.9"></a><span id="l8.9"> {</span>
<a href="#l8.10"></a><span id="l8.10">   MOZ_COUNT_CTOR(nsImapMailFolder); // double count these for now.</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-  m_thread = do_GetCurrentThread();</span>
<a href="#l8.13"></a><span id="l8.13">   m_moveCoalescer = nsnull;</span>
<a href="#l8.14"></a><span id="l8.14">   m_boxFlags = 0;</span>
<a href="#l8.15"></a><span id="l8.15">   m_uidValidity = kUidUnknown;</span>
<a href="#l8.16"></a><span id="l8.16">   m_numServerRecentMessages = 0;</span>
<a href="#l8.17"></a><span id="l8.17">   m_numServerUnseenMessages = 0;</span>
<a href="#l8.18"></a><span id="l8.18">   m_numServerTotalMessages = 0;</span>
<a href="#l8.19"></a><span id="l8.19">   m_nextUID = nsMsgKey_None;</span>
<a href="#l8.20"></a><span id="l8.20">   m_hierarchyDelimiter = kOnlineHierarchySeparatorUnknown;</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineat">@@ -845,17 +844,17 @@ NS_IMETHODIMP nsImapMailFolder::UpdateFo</span>
<a href="#l8.22"></a><span id="l8.22">     selectFolder = false;</span>
<a href="#l8.23"></a><span id="l8.23">   // don't run select if we can't select the folder...</span>
<a href="#l8.24"></a><span id="l8.24">   if (NS_SUCCEEDED(rv) &amp;&amp; !m_urlRunning &amp;&amp; selectFolder)</span>
<a href="#l8.25"></a><span id="l8.25">   {</span>
<a href="#l8.26"></a><span id="l8.26">     nsCOMPtr&lt;nsIImapService&gt; imapService = do_GetService(NS_IMAPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l8.27"></a><span id="l8.27">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.28"></a><span id="l8.28"> </span>
<a href="#l8.29"></a><span id="l8.29">     nsCOMPtr &lt;nsIURI&gt; url;</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineminus">-    rv = imapService-&gt;SelectFolder(m_thread, this, m_urlListener, aMsgWindow, getter_AddRefs(url));</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineplus">+    rv = imapService-&gt;SelectFolder(this, m_urlListener, aMsgWindow, getter_AddRefs(url));</span>
<a href="#l8.32"></a><span id="l8.32">     if (NS_SUCCEEDED(rv))</span>
<a href="#l8.33"></a><span id="l8.33">     {</span>
<a href="#l8.34"></a><span id="l8.34">       m_urlRunning = true;</span>
<a href="#l8.35"></a><span id="l8.35">       m_updatingFolder = true;</span>
<a href="#l8.36"></a><span id="l8.36">     }</span>
<a href="#l8.37"></a><span id="l8.37">     if (url)</span>
<a href="#l8.38"></a><span id="l8.38">     {</span>
<a href="#l8.39"></a><span id="l8.39">       nsCOMPtr &lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(url, &amp;rv);</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineat">@@ -910,17 +909,17 @@ NS_IMETHODIMP nsImapMailFolder::CreateSu</span>
<a href="#l8.41"></a><span id="l8.41">   {</span>
<a href="#l8.42"></a><span id="l8.42">     ThrowAlertMsg(&quot;folderExists&quot;, msgWindow);</span>
<a href="#l8.43"></a><span id="l8.43">     return NS_MSG_FOLDER_EXISTS;</span>
<a href="#l8.44"></a><span id="l8.44">   }</span>
<a href="#l8.45"></a><span id="l8.45"> </span>
<a href="#l8.46"></a><span id="l8.46">   nsCOMPtr&lt;nsIImapService&gt; imapService = do_GetService(NS_IMAPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l8.47"></a><span id="l8.47">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l8.48"></a><span id="l8.48"> </span>
<a href="#l8.49"></a><span id="l8.49" class="difflineminus">-  return imapService-&gt;CreateFolder(m_thread, this, folderName, this, nsnull);</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineplus">+  return imapService-&gt;CreateFolder(this, folderName, this, nsnull);</span>
<a href="#l8.51"></a><span id="l8.51"> }</span>
<a href="#l8.52"></a><span id="l8.52"> </span>
<a href="#l8.53"></a><span id="l8.53"> NS_IMETHODIMP nsImapMailFolder::CreateClientSubfolderInfo(const nsACString&amp; folderName,</span>
<a href="#l8.54"></a><span id="l8.54">                                                           char hierarchyDelimiter,</span>
<a href="#l8.55"></a><span id="l8.55">                                                           PRInt32 flags,</span>
<a href="#l8.56"></a><span id="l8.56">                                                           bool suppressNotification)</span>
<a href="#l8.57"></a><span id="l8.57"> {</span>
<a href="#l8.58"></a><span id="l8.58">   nsresult rv = NS_OK;</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineat">@@ -1044,17 +1043,17 @@ NS_IMETHODIMP nsImapMailFolder::CreateCl</span>
<a href="#l8.60"></a><span id="l8.60">   return rv;</span>
<a href="#l8.61"></a><span id="l8.61"> }</span>
<a href="#l8.62"></a><span id="l8.62"> </span>
<a href="#l8.63"></a><span id="l8.63"> NS_IMETHODIMP nsImapMailFolder::List()</span>
<a href="#l8.64"></a><span id="l8.64"> {</span>
<a href="#l8.65"></a><span id="l8.65">   nsresult rv;</span>
<a href="#l8.66"></a><span id="l8.66">   nsCOMPtr&lt;nsIImapService&gt; imapService = do_GetService(NS_IMAPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l8.67"></a><span id="l8.67">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineminus">-  return imapService-&gt;ListFolder(m_thread, this, this, nsnull);</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineplus">+  return imapService-&gt;ListFolder(this, this, nsnull);</span>
<a href="#l8.70"></a><span id="l8.70"> }</span>
<a href="#l8.71"></a><span id="l8.71"> </span>
<a href="#l8.72"></a><span id="l8.72"> NS_IMETHODIMP nsImapMailFolder::RemoveSubFolder (nsIMsgFolder *which)</span>
<a href="#l8.73"></a><span id="l8.73"> {</span>
<a href="#l8.74"></a><span id="l8.74">   nsresult rv;</span>
<a href="#l8.75"></a><span id="l8.75">   nsCOMPtr&lt;nsIMutableArray&gt; folders(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l8.76"></a><span id="l8.76">   NS_ENSURE_TRUE(folders, rv);</span>
<a href="#l8.77"></a><span id="l8.77">   nsCOMPtr&lt;nsISupports&gt; folderSupport = do_QueryInterface(which, &amp;rv);</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineat">@@ -1098,17 +1097,17 @@ NS_IMETHODIMP nsImapMailFolder::CreateSt</span>
<a href="#l8.79"></a><span id="l8.79">   if (msgParent)</span>
<a href="#l8.80"></a><span id="l8.80">   {</span>
<a href="#l8.81"></a><span id="l8.81">     nsString folderName;</span>
<a href="#l8.82"></a><span id="l8.82">     GetName(folderName);</span>
<a href="#l8.83"></a><span id="l8.83">     nsresult rv;</span>
<a href="#l8.84"></a><span id="l8.84">     nsCOMPtr&lt;nsIImapService&gt; imapService = do_GetService(NS_IMAPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l8.85"></a><span id="l8.85">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.86"></a><span id="l8.86">     nsCOMPtr &lt;nsIURI&gt; uri;</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineminus">-    imapService-&gt;EnsureFolderExists(m_thread, msgParent, folderName, urlListener, getter_AddRefs(uri));</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineplus">+    imapService-&gt;EnsureFolderExists(msgParent, folderName, urlListener, getter_AddRefs(uri));</span>
<a href="#l8.89"></a><span id="l8.89">   }</span>
<a href="#l8.90"></a><span id="l8.90">   return rv;</span>
<a href="#l8.91"></a><span id="l8.91"> }</span>
<a href="#l8.92"></a><span id="l8.92"> </span>
<a href="#l8.93"></a><span id="l8.93"> </span>
<a href="#l8.94"></a><span id="l8.94"> NS_IMETHODIMP nsImapMailFolder::GetVerifiedAsOnlineFolder(bool *aVerifiedAsOnlineFolder)</span>
<a href="#l8.95"></a><span id="l8.95"> {</span>
<a href="#l8.96"></a><span id="l8.96">   NS_ENSURE_ARG_POINTER(aVerifiedAsOnlineFolder);</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineat">@@ -1382,17 +1381,17 @@ NS_IMETHODIMP nsImapMailFolder::MarkPend</span>
<a href="#l8.98"></a><span id="l8.98"> </span>
<a href="#l8.99"></a><span id="l8.99"> NS_IMETHODIMP nsImapMailFolder::Expunge(nsIUrlListener *aListener,</span>
<a href="#l8.100"></a><span id="l8.100">                                         nsIMsgWindow *aMsgWindow)</span>
<a href="#l8.101"></a><span id="l8.101"> {</span>
<a href="#l8.102"></a><span id="l8.102">   nsresult rv;</span>
<a href="#l8.103"></a><span id="l8.103">   nsCOMPtr&lt;nsIImapService&gt; imapService = do_GetService(NS_IMAPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l8.104"></a><span id="l8.104">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.105"></a><span id="l8.105"> </span>
<a href="#l8.106"></a><span id="l8.106" class="difflineminus">-  return imapService-&gt;Expunge(m_thread, this, aListener, aMsgWindow, nsnull);</span>
<a href="#l8.107"></a><span id="l8.107" class="difflineplus">+  return imapService-&gt;Expunge(this, aListener, aMsgWindow, nsnull);</span>
<a href="#l8.108"></a><span id="l8.108"> }</span>
<a href="#l8.109"></a><span id="l8.109"> </span>
<a href="#l8.110"></a><span id="l8.110"> NS_IMETHODIMP nsImapMailFolder::CompactAll(nsIUrlListener *aListener,</span>
<a href="#l8.111"></a><span id="l8.111">                                                nsIMsgWindow *aMsgWindow,</span>
<a href="#l8.112"></a><span id="l8.112">                                                bool aCompactOfflineAlso)</span>
<a href="#l8.113"></a><span id="l8.113"> {</span>
<a href="#l8.114"></a><span id="l8.114">   nsresult rv;</span>
<a href="#l8.115"></a><span id="l8.115">   nsCOMPtr&lt;nsIMutableArray&gt; folderArray, offlineFolderArray;</span>
<a href="#l8.116"></a><span id="l8.116" class="difflineat">@@ -1443,17 +1442,17 @@ NS_IMETHODIMP nsImapMailFolder::CompactA</span>
<a href="#l8.117"></a><span id="l8.117"> </span>
<a href="#l8.118"></a><span id="l8.118"> NS_IMETHODIMP nsImapMailFolder::UpdateStatus(nsIUrlListener *aListener, nsIMsgWindow *aMsgWindow)</span>
<a href="#l8.119"></a><span id="l8.119"> {</span>
<a href="#l8.120"></a><span id="l8.120">   nsresult rv;</span>
<a href="#l8.121"></a><span id="l8.121">   nsCOMPtr&lt;nsIImapService&gt; imapService = do_GetService(NS_IMAPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l8.122"></a><span id="l8.122">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l8.123"></a><span id="l8.123"> </span>
<a href="#l8.124"></a><span id="l8.124">   nsCOMPtr &lt;nsIURI&gt; uri;</span>
<a href="#l8.125"></a><span id="l8.125" class="difflineminus">-  rv = imapService-&gt;UpdateFolderStatus(m_thread, this, aListener, getter_AddRefs(uri));</span>
<a href="#l8.126"></a><span id="l8.126" class="difflineplus">+  rv = imapService-&gt;UpdateFolderStatus(this, aListener, getter_AddRefs(uri));</span>
<a href="#l8.127"></a><span id="l8.127">   if (uri &amp;&amp; !aMsgWindow)</span>
<a href="#l8.128"></a><span id="l8.128">   {</span>
<a href="#l8.129"></a><span id="l8.129">     nsCOMPtr &lt;nsIMsgMailNewsUrl&gt; mailNewsUrl = do_QueryInterface(uri, &amp;rv);</span>
<a href="#l8.130"></a><span id="l8.130">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.131"></a><span id="l8.131">     // if no msg window, we won't put up error messages (this is almost certainly a biff-inspired status)</span>
<a href="#l8.132"></a><span id="l8.132">     mailNewsUrl-&gt;SetSuppressErrorMsgs(true);</span>
<a href="#l8.133"></a><span id="l8.133">   }</span>
<a href="#l8.134"></a><span id="l8.134">   return rv;</span>
<a href="#l8.135"></a><span id="l8.135" class="difflineat">@@ -1570,21 +1569,21 @@ NS_IMETHODIMP nsImapMailFolder::EmptyTra</span>
<a href="#l8.136"></a><span id="l8.136">                                           nsnull, nsnull, nsnull, nsnull, &amp;dummyValue, &amp;dlgResult);</span>
<a href="#l8.137"></a><span id="l8.137">           }</span>
<a href="#l8.138"></a><span id="l8.138">           if (NS_SUCCEEDED(rv) &amp;&amp; dlgResult == 1)</span>
<a href="#l8.139"></a><span id="l8.139">             return NS_BINDING_ABORTED;</span>
<a href="#l8.140"></a><span id="l8.140">         }</span>
<a href="#l8.141"></a><span id="l8.141">       }</span>
<a href="#l8.142"></a><span id="l8.142">     }</span>
<a href="#l8.143"></a><span id="l8.143">     if (aListener)</span>
<a href="#l8.144"></a><span id="l8.144" class="difflineminus">-      rv = imapService-&gt;DeleteAllMessages(m_thread, trashFolder, aListener, nsnull);</span>
<a href="#l8.145"></a><span id="l8.145" class="difflineplus">+      rv = imapService-&gt;DeleteAllMessages(trashFolder, aListener, nsnull);</span>
<a href="#l8.146"></a><span id="l8.146">     else</span>
<a href="#l8.147"></a><span id="l8.147">     {</span>
<a href="#l8.148"></a><span id="l8.148">       nsCOMPtr&lt;nsIUrlListener&gt; urlListener = do_QueryInterface(trashFolder);</span>
<a href="#l8.149"></a><span id="l8.149" class="difflineminus">-      rv = imapService-&gt;DeleteAllMessages(m_thread, trashFolder, urlListener, nsnull);</span>
<a href="#l8.150"></a><span id="l8.150" class="difflineplus">+      rv = imapService-&gt;DeleteAllMessages(trashFolder, urlListener, nsnull);</span>
<a href="#l8.151"></a><span id="l8.151">     }</span>
<a href="#l8.152"></a><span id="l8.152">     // return an error if this failed. We want the empty trash on exit code</span>
<a href="#l8.153"></a><span id="l8.153">     // to know if this fails so that it doesn't block waiting for empty trash to finish.</span>
<a href="#l8.154"></a><span id="l8.154">     if (NS_FAILED(rv))</span>
<a href="#l8.155"></a><span id="l8.155">       return rv;</span>
<a href="#l8.156"></a><span id="l8.156"> </span>
<a href="#l8.157"></a><span id="l8.157">     if (hasSubfolders)</span>
<a href="#l8.158"></a><span id="l8.158">     {</span>
<a href="#l8.159"></a><span id="l8.159" class="difflineat">@@ -1698,17 +1697,17 @@ NS_IMETHODIMP nsImapMailFolder::Rename (</span>
<a href="#l8.160"></a><span id="l8.160">   }</span>
<a href="#l8.161"></a><span id="l8.161">   nsCOMPtr &lt;nsIImapIncomingServer&gt; incomingImapServer;</span>
<a href="#l8.162"></a><span id="l8.162">   GetImapIncomingServer(getter_AddRefs(incomingImapServer));</span>
<a href="#l8.163"></a><span id="l8.163">   if (incomingImapServer)</span>
<a href="#l8.164"></a><span id="l8.164">     RecursiveCloseActiveConnections(incomingImapServer);</span>
<a href="#l8.165"></a><span id="l8.165"> </span>
<a href="#l8.166"></a><span id="l8.166">   nsCOMPtr&lt;nsIImapService&gt; imapService = do_GetService(NS_IMAPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l8.167"></a><span id="l8.167">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l8.168"></a><span id="l8.168" class="difflineminus">-  return imapService-&gt;RenameLeaf(m_thread, this, newName, this, msgWindow, nsnull);</span>
<a href="#l8.169"></a><span id="l8.169" class="difflineplus">+  return imapService-&gt;RenameLeaf(this, newName, this, msgWindow, nsnull);</span>
<a href="#l8.170"></a><span id="l8.170"> }</span>
<a href="#l8.171"></a><span id="l8.171"> </span>
<a href="#l8.172"></a><span id="l8.172"> NS_IMETHODIMP nsImapMailFolder::RecursiveCloseActiveConnections(nsIImapIncomingServer *incomingImapServer)</span>
<a href="#l8.173"></a><span id="l8.173"> {</span>
<a href="#l8.174"></a><span id="l8.174">   NS_ENSURE_ARG(incomingImapServer);</span>
<a href="#l8.175"></a><span id="l8.175"> </span>
<a href="#l8.176"></a><span id="l8.176">   nsCOMPtr&lt;nsIMsgImapMailFolder&gt; folder;</span>
<a href="#l8.177"></a><span id="l8.177">   PRInt32 count = mSubFolders.Count();</span>
<a href="#l8.178"></a><span id="l8.178" class="difflineat">@@ -2302,17 +2301,17 @@ NS_IMETHODIMP nsImapMailFolder::DeleteMe</span>
<a href="#l8.179"></a><span id="l8.179"> </span>
<a href="#l8.180"></a><span id="l8.180">   if ((NS_SUCCEEDED(rv) &amp;&amp; deleteImmediatelyNoTrash) || deleteModel == nsMsgImapDeleteModels::IMAPDelete )</span>
<a href="#l8.181"></a><span id="l8.181">   {</span>
<a href="#l8.182"></a><span id="l8.182">     if (allowUndo)</span>
<a href="#l8.183"></a><span id="l8.183">     {</span>
<a href="#l8.184"></a><span id="l8.184">       //need to take care of these two delete models</span>
<a href="#l8.185"></a><span id="l8.185">       nsRefPtr&lt;nsImapMoveCopyMsgTxn&gt; undoMsgTxn = new nsImapMoveCopyMsgTxn;</span>
<a href="#l8.186"></a><span id="l8.186">       if (!undoMsgTxn || NS_FAILED(undoMsgTxn-&gt;Init(this, &amp;srcKeyArray, messageIds.get(), nsnull,</span>
<a href="#l8.187"></a><span id="l8.187" class="difflineminus">-                                                      true, isMove, m_thread)))</span>
<a href="#l8.188"></a><span id="l8.188" class="difflineplus">+                                                    true, isMove)))</span>
<a href="#l8.189"></a><span id="l8.189">         return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l8.190"></a><span id="l8.190"> </span>
<a href="#l8.191"></a><span id="l8.191">       undoMsgTxn-&gt;SetTransactionType(nsIMessenger::eDeleteMsg);</span>
<a href="#l8.192"></a><span id="l8.192">       // we're adding this undo action before the delete is successful. This is evil,</span>
<a href="#l8.193"></a><span id="l8.193">       // but 4.5 did it as well.</span>
<a href="#l8.194"></a><span id="l8.194">       nsCOMPtr &lt;nsITransactionManager&gt; txnMgr;</span>
<a href="#l8.195"></a><span id="l8.195">       if (msgWindow)</span>
<a href="#l8.196"></a><span id="l8.196">         msgWindow-&gt;GetTransactionManager(getter_AddRefs(txnMgr));</span>
<a href="#l8.197"></a><span id="l8.197" class="difflineat">@@ -2535,34 +2534,32 @@ nsImapMailFolder::DeleteSubFolders(nsIAr</span>
<a href="#l8.198"></a><span id="l8.198">   {</span>
<a href="#l8.199"></a><span id="l8.199">     for (i = 0; i &lt; folderCount; i++)</span>
<a href="#l8.200"></a><span id="l8.200">     {</span>
<a href="#l8.201"></a><span id="l8.201">       curFolder = do_QueryElementAt(foldersRemaining, i, &amp;rv);</span>
<a href="#l8.202"></a><span id="l8.202">       if (NS_SUCCEEDED(rv))</span>
<a href="#l8.203"></a><span id="l8.203">       {</span>
<a href="#l8.204"></a><span id="l8.204">         urlListener = do_QueryInterface(curFolder);</span>
<a href="#l8.205"></a><span id="l8.205">         if (deleteNoTrash)</span>
<a href="#l8.206"></a><span id="l8.206" class="difflineminus">-          rv = imapService-&gt;DeleteFolder(m_thread,</span>
<a href="#l8.207"></a><span id="l8.207" class="difflineminus">-                                         curFolder,</span>
<a href="#l8.208"></a><span id="l8.208" class="difflineplus">+          rv = imapService-&gt;DeleteFolder(curFolder,</span>
<a href="#l8.209"></a><span id="l8.209">                                          urlListener,</span>
<a href="#l8.210"></a><span id="l8.210">                                          msgWindow,</span>
<a href="#l8.211"></a><span id="l8.211">                                          nsnull);</span>
<a href="#l8.212"></a><span id="l8.212">         else</span>
<a href="#l8.213"></a><span id="l8.213">         {</span>
<a href="#l8.214"></a><span id="l8.214">           bool confirm = false;</span>
<a href="#l8.215"></a><span id="l8.215">           bool match = false;</span>
<a href="#l8.216"></a><span id="l8.216">           rv = curFolder-&gt;MatchOrChangeFilterDestination(nsnull, false, &amp;match);</span>
<a href="#l8.217"></a><span id="l8.217">           if (match)</span>
<a href="#l8.218"></a><span id="l8.218">           {</span>
<a href="#l8.219"></a><span id="l8.219">             curFolder-&gt;ConfirmFolderDeletionForFilter(msgWindow, &amp;confirm);</span>
<a href="#l8.220"></a><span id="l8.220">             if (!confirm)</span>
<a href="#l8.221"></a><span id="l8.221">               return NS_OK;</span>
<a href="#l8.222"></a><span id="l8.222">           }</span>
<a href="#l8.223"></a><span id="l8.223" class="difflineminus">-          rv = imapService-&gt;MoveFolder(m_thread,</span>
<a href="#l8.224"></a><span id="l8.224" class="difflineminus">-                                       curFolder,</span>
<a href="#l8.225"></a><span id="l8.225" class="difflineplus">+          rv = imapService-&gt;MoveFolder(curFolder,</span>
<a href="#l8.226"></a><span id="l8.226">                                        trashFolder,</span>
<a href="#l8.227"></a><span id="l8.227">                                        urlListener,</span>
<a href="#l8.228"></a><span id="l8.228">                                        msgWindow,</span>
<a href="#l8.229"></a><span id="l8.229">                                        nsnull);</span>
<a href="#l8.230"></a><span id="l8.230">         }</span>
<a href="#l8.231"></a><span id="l8.231">       }</span>
<a href="#l8.232"></a><span id="l8.232">     }</span>
<a href="#l8.233"></a><span id="l8.233">   }</span>
<a href="#l8.234"></a><span id="l8.234" class="difflineat">@@ -3408,18 +3405,17 @@ NS_IMETHODIMP nsImapMailFolder::EndCopy(</span>
<a href="#l8.235"></a><span id="l8.235">     m_copyState-&gt;m_tmpFile = tmpFile;</span>
<a href="#l8.236"></a><span id="l8.236">     nsCOMPtr&lt;nsIImapService&gt; imapService = do_GetService(NS_IMAPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l8.237"></a><span id="l8.237">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l8.238"></a><span id="l8.238"> </span>
<a href="#l8.239"></a><span id="l8.239">     rv = QueryInterface(NS_GET_IID(nsIUrlListener), getter_AddRefs(urlListener));</span>
<a href="#l8.240"></a><span id="l8.240">     nsCOMPtr&lt;nsISupports&gt; copySupport;</span>
<a href="#l8.241"></a><span id="l8.241">     if (m_copyState)</span>
<a href="#l8.242"></a><span id="l8.242">       copySupport = do_QueryInterface(m_copyState);</span>
<a href="#l8.243"></a><span id="l8.243" class="difflineminus">-    rv = imapService-&gt;AppendMessageFromFile(m_thread,</span>
<a href="#l8.244"></a><span id="l8.244" class="difflineminus">-                                            m_copyState-&gt;m_tmpFile,</span>
<a href="#l8.245"></a><span id="l8.245" class="difflineplus">+    rv = imapService-&gt;AppendMessageFromFile(m_copyState-&gt;m_tmpFile,</span>
<a href="#l8.246"></a><span id="l8.246">                                             this, EmptyCString(), true,</span>
<a href="#l8.247"></a><span id="l8.247">                                             m_copyState-&gt;m_selectedState,</span>
<a href="#l8.248"></a><span id="l8.248">                                             urlListener, nsnull,</span>
<a href="#l8.249"></a><span id="l8.249">                                             copySupport,</span>
<a href="#l8.250"></a><span id="l8.250">                                             m_copyState-&gt;m_msgWindow);</span>
<a href="#l8.251"></a><span id="l8.251">   }</span>
<a href="#l8.252"></a><span id="l8.252">   if (NS_FAILED(rv) || !copySucceeded)</span>
<a href="#l8.253"></a><span id="l8.253">     PR_LOG(IMAP, PR_LOG_ALWAYS, (&quot;EndCopy failed:%lx\n&quot;, rv));</span>
<a href="#l8.254"></a><span id="l8.254" class="difflineat">@@ -3821,26 +3817,26 @@ NS_IMETHODIMP nsImapMailFolder::ApplyFil</span>
<a href="#l8.255"></a><span id="l8.255"> }</span>
<a href="#l8.256"></a><span id="l8.256"> </span>
<a href="#l8.257"></a><span id="l8.257"> NS_IMETHODIMP nsImapMailFolder::SetImapFlags(const char *uids, PRInt32 flags, nsIURI **url)</span>
<a href="#l8.258"></a><span id="l8.258"> {</span>
<a href="#l8.259"></a><span id="l8.259">   nsresult rv;</span>
<a href="#l8.260"></a><span id="l8.260">   nsCOMPtr&lt;nsIImapService&gt; imapService = do_GetService(NS_IMAPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l8.261"></a><span id="l8.261">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l8.262"></a><span id="l8.262"> </span>
<a href="#l8.263"></a><span id="l8.263" class="difflineminus">-  return imapService-&gt;SetMessageFlags(m_thread, this, this, url, nsCAutoString(uids), flags, true);</span>
<a href="#l8.264"></a><span id="l8.264" class="difflineplus">+  return imapService-&gt;SetMessageFlags(this, this, url, nsCAutoString(uids), flags, true);</span>
<a href="#l8.265"></a><span id="l8.265"> }</span>
<a href="#l8.266"></a><span id="l8.266"> </span>
<a href="#l8.267"></a><span id="l8.267"> // &quot;this&quot; is the parent folder</span>
<a href="#l8.268"></a><span id="l8.268"> NS_IMETHODIMP nsImapMailFolder::PlaybackOfflineFolderCreate(const nsAString&amp; aFolderName, nsIMsgWindow *aWindow, nsIURI **url)</span>
<a href="#l8.269"></a><span id="l8.269"> {</span>
<a href="#l8.270"></a><span id="l8.270">   nsresult rv;</span>
<a href="#l8.271"></a><span id="l8.271">   nsCOMPtr&lt;nsIImapService&gt; imapService = do_GetService(NS_IMAPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l8.272"></a><span id="l8.272">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l8.273"></a><span id="l8.273" class="difflineminus">-  return imapService-&gt;CreateFolder(m_thread, this, aFolderName, this, url);</span>
<a href="#l8.274"></a><span id="l8.274" class="difflineplus">+  return imapService-&gt;CreateFolder(this, aFolderName, this, url);</span>
<a href="#l8.275"></a><span id="l8.275"> }</span>
<a href="#l8.276"></a><span id="l8.276"> </span>
<a href="#l8.277"></a><span id="l8.277"> NS_IMETHODIMP </span>
<a href="#l8.278"></a><span id="l8.278"> nsImapMailFolder::ReplayOfflineMoveCopy(nsMsgKey *aMsgKeys, PRUint32 aNumKeys,</span>
<a href="#l8.279"></a><span id="l8.279">                                         bool isMove, nsIMsgFolder *aDstFolder,</span>
<a href="#l8.280"></a><span id="l8.280">                                         nsIUrlListener *aUrlListener, nsIMsgWindow *aWindow)</span>
<a href="#l8.281"></a><span id="l8.281"> {</span>
<a href="#l8.282"></a><span id="l8.282">   nsresult rv;</span>
<a href="#l8.283"></a><span id="l8.283" class="difflineat">@@ -3901,17 +3897,17 @@ nsImapMailFolder::ReplayOfflineMoveCopy(</span>
<a href="#l8.284"></a><span id="l8.284">     // the offline move/copy.</span>
<a href="#l8.285"></a><span id="l8.285">   }</span>
<a href="#l8.286"></a><span id="l8.286"> </span>
<a href="#l8.287"></a><span id="l8.287">   nsCOMPtr&lt;nsIImapService&gt; imapService = do_GetService(NS_IMAPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l8.288"></a><span id="l8.288">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.289"></a><span id="l8.289">   nsCOMPtr &lt;nsIURI&gt; resultUrl;</span>
<a href="#l8.290"></a><span id="l8.290">   nsCAutoString uids;</span>
<a href="#l8.291"></a><span id="l8.291">   AllocateUidStringFromKeys(aMsgKeys, aNumKeys, uids);</span>
<a href="#l8.292"></a><span id="l8.292" class="difflineminus">-  rv = imapService-&gt;OnlineMessageCopy(m_thread, this, uids, aDstFolder,</span>
<a href="#l8.293"></a><span id="l8.293" class="difflineplus">+  rv = imapService-&gt;OnlineMessageCopy(this, uids, aDstFolder,</span>
<a href="#l8.294"></a><span id="l8.294">                                       true, isMove, aUrlListener,</span>
<a href="#l8.295"></a><span id="l8.295">                                       getter_AddRefs(resultUrl), nsnull, aWindow);</span>
<a href="#l8.296"></a><span id="l8.296">   if (resultUrl)</span>
<a href="#l8.297"></a><span id="l8.297">   {</span>
<a href="#l8.298"></a><span id="l8.298">     nsCOMPtr &lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(resultUrl, &amp;rv);</span>
<a href="#l8.299"></a><span id="l8.299">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.300"></a><span id="l8.300">     nsCOMPtr &lt;nsIUrlListener&gt; folderListener = do_QueryInterface(aDstFolder);</span>
<a href="#l8.301"></a><span id="l8.301">     if (folderListener)</span>
<a href="#l8.302"></a><span id="l8.302" class="difflineat">@@ -3943,20 +3939,20 @@ NS_IMETHODIMP nsImapMailFolder::StoreIma</span>
<a href="#l8.303"></a><span id="l8.303">   nsresult rv;</span>
<a href="#l8.304"></a><span id="l8.304">   if (!WeAreOffline())</span>
<a href="#l8.305"></a><span id="l8.305">   {</span>
<a href="#l8.306"></a><span id="l8.306">     nsCOMPtr&lt;nsIImapService&gt; imapService = do_GetService(NS_IMAPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l8.307"></a><span id="l8.307">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.308"></a><span id="l8.308">     nsCAutoString msgIds;</span>
<a href="#l8.309"></a><span id="l8.309">     AllocateUidStringFromKeys(keys, numKeys, msgIds);</span>
<a href="#l8.310"></a><span id="l8.310">     if (addFlags)</span>
<a href="#l8.311"></a><span id="l8.311" class="difflineminus">-      imapService-&gt;AddMessageFlags(m_thread, this, aUrlListener ? aUrlListener : this,</span>
<a href="#l8.312"></a><span id="l8.312" class="difflineplus">+      imapService-&gt;AddMessageFlags(this, aUrlListener ? aUrlListener : this,</span>
<a href="#l8.313"></a><span id="l8.313">                                    nsnull, msgIds, flags, true);</span>
<a href="#l8.314"></a><span id="l8.314">     else</span>
<a href="#l8.315"></a><span id="l8.315" class="difflineminus">-      imapService-&gt;SubtractMessageFlags(m_thread, this, aUrlListener ? aUrlListener : this,</span>
<a href="#l8.316"></a><span id="l8.316" class="difflineplus">+      imapService-&gt;SubtractMessageFlags(this, aUrlListener ? aUrlListener : this,</span>
<a href="#l8.317"></a><span id="l8.317">                                         nsnull, msgIds, flags, true);</span>
<a href="#l8.318"></a><span id="l8.318">   }</span>
<a href="#l8.319"></a><span id="l8.319">   else</span>
<a href="#l8.320"></a><span id="l8.320">   {</span>
<a href="#l8.321"></a><span id="l8.321">     GetDatabase();</span>
<a href="#l8.322"></a><span id="l8.322">     if (mDatabase)</span>
<a href="#l8.323"></a><span id="l8.323">     {</span>
<a href="#l8.324"></a><span id="l8.324">       PRUint32 total = numKeys;</span>
<a href="#l8.325"></a><span id="l8.325" class="difflineat">@@ -3979,17 +3975,17 @@ NS_IMETHODIMP nsImapMailFolder::StoreIma</span>
<a href="#l8.326"></a><span id="l8.326"> }</span>
<a href="#l8.327"></a><span id="l8.327"> </span>
<a href="#l8.328"></a><span id="l8.328"> NS_IMETHODIMP nsImapMailFolder::LiteSelect(nsIUrlListener *aUrlListener,</span>
<a href="#l8.329"></a><span id="l8.329">                                            nsIMsgWindow *aMsgWindow)</span>
<a href="#l8.330"></a><span id="l8.330"> {</span>
<a href="#l8.331"></a><span id="l8.331">   nsresult rv;</span>
<a href="#l8.332"></a><span id="l8.332">   nsCOMPtr&lt;nsIImapService&gt; imapService = do_GetService(NS_IMAPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l8.333"></a><span id="l8.333">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.334"></a><span id="l8.334" class="difflineminus">-  return imapService-&gt;LiteSelectFolder(m_thread, this, aUrlListener,</span>
<a href="#l8.335"></a><span id="l8.335" class="difflineplus">+  return imapService-&gt;LiteSelectFolder(this, aUrlListener,</span>
<a href="#l8.336"></a><span id="l8.336">                                        aMsgWindow, nsnull);</span>
<a href="#l8.337"></a><span id="l8.337"> }</span>
<a href="#l8.338"></a><span id="l8.338"> </span>
<a href="#l8.339"></a><span id="l8.339"> nsresult nsImapMailFolder::GetFolderOwnerUserName(nsACString&amp; userName)</span>
<a href="#l8.340"></a><span id="l8.340"> {</span>
<a href="#l8.341"></a><span id="l8.341">   if ((mFlags &amp; nsMsgFolderFlags::ImapPersonal) ||</span>
<a href="#l8.342"></a><span id="l8.342">     !(mFlags &amp; (nsMsgFolderFlags::ImapPublic | nsMsgFolderFlags::ImapOtherUser)))</span>
<a href="#l8.343"></a><span id="l8.343">   {</span>
<a href="#l8.344"></a><span id="l8.344" class="difflineat">@@ -4078,17 +4074,17 @@ NS_IMETHODIMP nsImapMailFolder::FolderPr</span>
<a href="#l8.345"></a><span id="l8.345">           return extProtService-&gt;LoadUrl(uri);</span>
<a href="#l8.346"></a><span id="l8.346">       }</span>
<a href="#l8.347"></a><span id="l8.347">     }</span>
<a href="#l8.348"></a><span id="l8.348">   }</span>
<a href="#l8.349"></a><span id="l8.349">   else</span>
<a href="#l8.350"></a><span id="l8.350">   {</span>
<a href="#l8.351"></a><span id="l8.351">     nsCOMPtr&lt;nsIImapService&gt; imapService = do_GetService(NS_IMAPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l8.352"></a><span id="l8.352">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l8.353"></a><span id="l8.353" class="difflineminus">-    rv = imapService-&gt;GetFolderAdminUrl(m_thread, this, window, this, nsnull);</span>
<a href="#l8.354"></a><span id="l8.354" class="difflineplus">+    rv = imapService-&gt;GetFolderAdminUrl(this, window, this, nsnull);</span>
<a href="#l8.355"></a><span id="l8.355">     if (NS_SUCCEEDED(rv))</span>
<a href="#l8.356"></a><span id="l8.356">       m_urlRunning = true;</span>
<a href="#l8.357"></a><span id="l8.357">   }</span>
<a href="#l8.358"></a><span id="l8.358">   return rv;</span>
<a href="#l8.359"></a><span id="l8.359"> }</span>
<a href="#l8.360"></a><span id="l8.360"> </span>
<a href="#l8.361"></a><span id="l8.361"> NS_IMETHODIMP nsImapMailFolder::GetHasAdminUrl(bool *aBool)</span>
<a href="#l8.362"></a><span id="l8.362"> {</span>
<a href="#l8.363"></a><span id="l8.363" class="difflineat">@@ -4123,26 +4119,26 @@ NS_IMETHODIMP nsImapMailFolder::GetHdrPa</span>
<a href="#l8.364"></a><span id="l8.364"> </span>
<a href="#l8.365"></a><span id="l8.365">   // this is used to issue an arbitrary imap command on the passed in msgs.</span>
<a href="#l8.366"></a><span id="l8.366">   // It assumes the command needs to be run in the selected state.</span>
<a href="#l8.367"></a><span id="l8.367"> NS_IMETHODIMP nsImapMailFolder::IssueCommandOnMsgs(const nsACString&amp; command, const char *uids, nsIMsgWindow *aWindow, nsIURI **url)</span>
<a href="#l8.368"></a><span id="l8.368"> {</span>
<a href="#l8.369"></a><span id="l8.369">   nsresult rv;</span>
<a href="#l8.370"></a><span id="l8.370">   nsCOMPtr&lt;nsIImapService&gt; imapService = do_GetService(NS_IMAPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l8.371"></a><span id="l8.371">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l8.372"></a><span id="l8.372" class="difflineminus">-  return imapService-&gt;IssueCommandOnMsgs(m_thread, this, aWindow, command, nsDependentCString(uids), url);</span>
<a href="#l8.373"></a><span id="l8.373" class="difflineplus">+  return imapService-&gt;IssueCommandOnMsgs(this, aWindow, command, nsDependentCString(uids), url);</span>
<a href="#l8.374"></a><span id="l8.374"> }</span>
<a href="#l8.375"></a><span id="l8.375"> </span>
<a href="#l8.376"></a><span id="l8.376"> NS_IMETHODIMP nsImapMailFolder::FetchCustomMsgAttribute(const nsACString&amp; attribute, const char *uids, nsIMsgWindow *aWindow, nsIURI **url)</span>
<a href="#l8.377"></a><span id="l8.377"> {</span>
<a href="#l8.378"></a><span id="l8.378">   nsresult rv;</span>
<a href="#l8.379"></a><span id="l8.379">   nsCOMPtr&lt;nsIImapService&gt; imapService = do_GetService(NS_IMAPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l8.380"></a><span id="l8.380">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l8.381"></a><span id="l8.381"> </span>
<a href="#l8.382"></a><span id="l8.382" class="difflineminus">-  return imapService-&gt;FetchCustomMsgAttribute(m_thread, this, aWindow, attribute, nsDependentCString(uids), url);</span>
<a href="#l8.383"></a><span id="l8.383" class="difflineplus">+  return imapService-&gt;FetchCustomMsgAttribute(this, aWindow, attribute, nsDependentCString(uids), url);</span>
<a href="#l8.384"></a><span id="l8.384"> }</span>
<a href="#l8.385"></a><span id="l8.385"> </span>
<a href="#l8.386"></a><span id="l8.386"> nsresult nsImapMailFolder::MoveIncorporatedMessage(nsIMsgDBHdr *mailHdr,</span>
<a href="#l8.387"></a><span id="l8.387">                                                    nsIMsgDatabase *sourceDB,</span>
<a href="#l8.388"></a><span id="l8.388">                                                    const nsACString&amp; destFolderUri,</span>
<a href="#l8.389"></a><span id="l8.389">                                                    nsIMsgFilter *filter,</span>
<a href="#l8.390"></a><span id="l8.390">                                                    nsIMsgWindow *msgWindow)</span>
<a href="#l8.391"></a><span id="l8.391"> {</span>
<a href="#l8.392"></a><span id="l8.392" class="difflineat">@@ -4568,17 +4564,17 @@ NS_IMETHODIMP nsImapMailFolder::Download</span>
<a href="#l8.393"></a><span id="l8.393">       return rv;</span>
<a href="#l8.394"></a><span id="l8.394">     }</span>
<a href="#l8.395"></a><span id="l8.395">     nsCOMPtr&lt;nsIImapService&gt; imapService = do_GetService(NS_IMAPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l8.396"></a><span id="l8.396">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.397"></a><span id="l8.397"> </span>
<a href="#l8.398"></a><span id="l8.398">     // Selecting the folder with nsIImapUrl::shouldStoreMsgOffline true will</span>
<a href="#l8.399"></a><span id="l8.399">     // cause us to fetch any message bodies we don't have.</span>
<a href="#l8.400"></a><span id="l8.400">     m_urlListener = listener;</span>
<a href="#l8.401"></a><span id="l8.401" class="difflineminus">-    rv = imapService-&gt;SelectFolder(m_thread, this, this, msgWindow,</span>
<a href="#l8.402"></a><span id="l8.402" class="difflineplus">+    rv = imapService-&gt;SelectFolder(this, this, msgWindow,</span>
<a href="#l8.403"></a><span id="l8.403">                                    getter_AddRefs(runningURI));</span>
<a href="#l8.404"></a><span id="l8.404">     if (NS_SUCCEEDED(rv))</span>
<a href="#l8.405"></a><span id="l8.405">     {</span>
<a href="#l8.406"></a><span id="l8.406">       nsCOMPtr&lt;nsIImapUrl&gt; imapUrl(do_QueryInterface(runningURI));</span>
<a href="#l8.407"></a><span id="l8.407">       if (imapUrl)</span>
<a href="#l8.408"></a><span id="l8.408">         imapUrl-&gt;SetStoreResultsOffline(true);</span>
<a href="#l8.409"></a><span id="l8.409">       m_urlRunning = true;</span>
<a href="#l8.410"></a><span id="l8.410">     }</span>
<a href="#l8.411"></a><span id="l8.411" class="difflineat">@@ -4736,17 +4732,17 @@ nsImapMailFolder::OnlineCopyCompleted(ns</span>
<a href="#l8.412"></a><span id="l8.412">     if (NS_FAILED(rv)) return rv;</span>
<a href="#l8.413"></a><span id="l8.413">     if (action != nsIImapUrl::nsImapOnlineToOfflineMove)</span>
<a href="#l8.414"></a><span id="l8.414">       return NS_ERROR_FAILURE; // don't assert here...</span>
<a href="#l8.415"></a><span id="l8.415">     nsCString messageIds;</span>
<a href="#l8.416"></a><span id="l8.416">     rv = imapUrl-&gt;GetListOfMessageIds(messageIds);</span>
<a href="#l8.417"></a><span id="l8.417">     if (NS_FAILED(rv)) return rv;</span>
<a href="#l8.418"></a><span id="l8.418">     nsCOMPtr&lt;nsIImapService&gt; imapService =  do_GetService(NS_IMAPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l8.419"></a><span id="l8.419">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l8.420"></a><span id="l8.420" class="difflineminus">-    return imapService-&gt;AddMessageFlags(m_thread, this, nsnull, nsnull,</span>
<a href="#l8.421"></a><span id="l8.421" class="difflineplus">+    return imapService-&gt;AddMessageFlags(this, nsnull, nsnull,</span>
<a href="#l8.422"></a><span id="l8.422">                                       messageIds,</span>
<a href="#l8.423"></a><span id="l8.423">                                       kImapMsgDeletedFlag,</span>
<a href="#l8.424"></a><span id="l8.424">                                       true);</span>
<a href="#l8.425"></a><span id="l8.425">   }</span>
<a href="#l8.426"></a><span id="l8.426">   /* unhandled copystate */</span>
<a href="#l8.427"></a><span id="l8.427">   else if (m_copyState) // whoops, this is the wrong folder - should use the source folder</span>
<a href="#l8.428"></a><span id="l8.428">   {</span>
<a href="#l8.429"></a><span id="l8.429">     nsCOMPtr&lt;nsIMsgFolder&gt; srcFolder;</span>
<a href="#l8.430"></a><span id="l8.430" class="difflineat">@@ -6862,17 +6858,17 @@ nsImapMailFolder::CopyMessagesWithStream</span>
<a href="#l8.431"></a><span id="l8.431">   {</span>
<a href="#l8.432"></a><span id="l8.432">     nsCAutoString messageIds;</span>
<a href="#l8.433"></a><span id="l8.433">     nsTArray&lt;nsMsgKey&gt; srcKeyArray;</span>
<a href="#l8.434"></a><span id="l8.434">     rv = BuildIdsAndKeyArray(messages, messageIds, srcKeyArray);</span>
<a href="#l8.435"></a><span id="l8.435"> </span>
<a href="#l8.436"></a><span id="l8.436">     nsRefPtr&lt;nsImapMoveCopyMsgTxn&gt; undoMsgTxn = new nsImapMoveCopyMsgTxn;</span>
<a href="#l8.437"></a><span id="l8.437"> </span>
<a href="#l8.438"></a><span id="l8.438">     if (!undoMsgTxn || NS_FAILED(undoMsgTxn-&gt;Init(srcFolder, &amp;srcKeyArray, messageIds.get(), this,</span>
<a href="#l8.439"></a><span id="l8.439" class="difflineminus">-                                true, isMove, m_thread)))</span>
<a href="#l8.440"></a><span id="l8.440" class="difflineplus">+                                true, isMove)))</span>
<a href="#l8.441"></a><span id="l8.441">       return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l8.442"></a><span id="l8.442"> </span>
<a href="#l8.443"></a><span id="l8.443">     if (isMove)</span>
<a href="#l8.444"></a><span id="l8.444">     {</span>
<a href="#l8.445"></a><span id="l8.445">       if (mFlags &amp; nsMsgFolderFlags::Trash)</span>
<a href="#l8.446"></a><span id="l8.446">         undoMsgTxn-&gt;SetTransactionType(nsIMessenger::eDeleteMsg);</span>
<a href="#l8.447"></a><span id="l8.447">       else</span>
<a href="#l8.448"></a><span id="l8.448">         undoMsgTxn-&gt;SetTransactionType(nsIMessenger::eMoveMsg);</span>
<a href="#l8.449"></a><span id="l8.449" class="difflineat">@@ -7196,17 +7192,17 @@ nsresult nsImapMailFolder::CopyMessagesO</span>
<a href="#l8.450"></a><span id="l8.450">               sourceOp-&gt;AddMessageCopyOperation(folderURI.get()); // offline copy</span>
<a href="#l8.451"></a><span id="l8.451"> </span>
<a href="#l8.452"></a><span id="l8.452">             nsTArray&lt;nsMsgKey&gt; srcKeyArray;</span>
<a href="#l8.453"></a><span id="l8.453"> </span>
<a href="#l8.454"></a><span id="l8.454">             srcKeyArray.AppendElement(originalKey);</span>
<a href="#l8.455"></a><span id="l8.455">             sourceOp-&gt;GetOperation(&amp;opType);</span>
<a href="#l8.456"></a><span id="l8.456">             nsRefPtr&lt;nsImapOfflineTxn&gt; undoMsgTxn = new</span>
<a href="#l8.457"></a><span id="l8.457">               nsImapOfflineTxn(srcFolder, &amp;srcKeyArray, messageId.get(), this, </span>
<a href="#l8.458"></a><span id="l8.458" class="difflineminus">-                               isMove, opType, message, m_thread);</span>
<a href="#l8.459"></a><span id="l8.459" class="difflineplus">+                               isMove, opType, message);</span>
<a href="#l8.460"></a><span id="l8.460">             if (undoMsgTxn)</span>
<a href="#l8.461"></a><span id="l8.461">             {</span>
<a href="#l8.462"></a><span id="l8.462">               if (isMove)</span>
<a href="#l8.463"></a><span id="l8.463">               {</span>
<a href="#l8.464"></a><span id="l8.464">                 undoMsgTxn-&gt;SetTransactionType(nsIMessenger::eMoveMsg);</span>
<a href="#l8.465"></a><span id="l8.465">                 nsCOMPtr&lt;nsIMsgImapMailFolder&gt; srcIsImap(do_QueryInterface(srcFolder));</span>
<a href="#l8.466"></a><span id="l8.466">                 // remember this undo transaction so we can hook up the result</span>
<a href="#l8.467"></a><span id="l8.467">                 // msg ids in the undo transaction.</span>
<a href="#l8.468"></a><span id="l8.468" class="difflineat">@@ -7284,17 +7280,17 @@ nsresult nsImapMailFolder::CopyMessagesO</span>
<a href="#l8.469"></a><span id="l8.469">                 SetFlag(nsMsgFolderFlags::OfflineEvents);</span>
<a href="#l8.470"></a><span id="l8.470">                 destOp-&gt;SetSourceFolderURI(originalSrcFolderURI.get());</span>
<a href="#l8.471"></a><span id="l8.471">                 destOp-&gt;SetSrcMessageKey(originalKey);</span>
<a href="#l8.472"></a><span id="l8.472">                 {</span>
<a href="#l8.473"></a><span id="l8.473">                   nsTArray&lt;nsMsgKey&gt; keyArray;</span>
<a href="#l8.474"></a><span id="l8.474">                   keyArray.AppendElement(fakeBase + sourceKeyIndex);</span>
<a href="#l8.475"></a><span id="l8.475">                   nsRefPtr&lt;nsImapOfflineTxn&gt; undoMsgTxn = new</span>
<a href="#l8.476"></a><span id="l8.476">                     nsImapOfflineTxn(this, &amp;keyArray, nsnull, this, isMove, nsIMsgOfflineImapOperation::kAddedHeader,</span>
<a href="#l8.477"></a><span id="l8.477" class="difflineminus">-                      newMailHdr, m_thread);</span>
<a href="#l8.478"></a><span id="l8.478" class="difflineplus">+                      newMailHdr);</span>
<a href="#l8.479"></a><span id="l8.479">                   if (undoMsgTxn &amp;&amp; txnMgr)</span>
<a href="#l8.480"></a><span id="l8.480">                      txnMgr-&gt;DoTransaction(undoMsgTxn);</span>
<a href="#l8.481"></a><span id="l8.481">                 }</span>
<a href="#l8.482"></a><span id="l8.482">               }</span>
<a href="#l8.483"></a><span id="l8.483">             }</span>
<a href="#l8.484"></a><span id="l8.484">             else</span>
<a href="#l8.485"></a><span id="l8.485">               stopit = NS_ERROR_FAILURE;</span>
<a href="#l8.486"></a><span id="l8.486">           }</span>
<a href="#l8.487"></a><span id="l8.487" class="difflineat">@@ -7305,18 +7301,17 @@ nsresult nsImapMailFolder::CopyMessagesO</span>
<a href="#l8.488"></a><span id="l8.488">           {</span>
<a href="#l8.489"></a><span id="l8.489">             nsTArray&lt;nsMsgKey&gt; srcKeyArray;</span>
<a href="#l8.490"></a><span id="l8.490">             srcKeyArray.AppendElement(msgKey);</span>
<a href="#l8.491"></a><span id="l8.491">             nsOfflineImapOperationType opType = nsIMsgOfflineImapOperation::kDeletedMsg;</span>
<a href="#l8.492"></a><span id="l8.492">             if (!deleteToTrash)</span>
<a href="#l8.493"></a><span id="l8.493">               opType = nsIMsgOfflineImapOperation::kMsgMarkedDeleted;</span>
<a href="#l8.494"></a><span id="l8.494">             srcKeyArray.AppendElement(msgKey);</span>
<a href="#l8.495"></a><span id="l8.495">             nsRefPtr&lt;nsImapOfflineTxn&gt; undoMsgTxn = new</span>
<a href="#l8.496"></a><span id="l8.496" class="difflineminus">-              nsImapOfflineTxn(srcFolder, &amp;srcKeyArray, messageId.get(), this, isMove, opType, mailHdr,</span>
<a href="#l8.497"></a><span id="l8.497" class="difflineminus">-                m_thread);</span>
<a href="#l8.498"></a><span id="l8.498" class="difflineplus">+              nsImapOfflineTxn(srcFolder, &amp;srcKeyArray, messageId.get(), this, isMove, opType, mailHdr);</span>
<a href="#l8.499"></a><span id="l8.499">             if (undoMsgTxn)</span>
<a href="#l8.500"></a><span id="l8.500">             {</span>
<a href="#l8.501"></a><span id="l8.501">               if (isMove)</span>
<a href="#l8.502"></a><span id="l8.502">               {</span>
<a href="#l8.503"></a><span id="l8.503">                 if (mFlags &amp; nsMsgFolderFlags::Trash)</span>
<a href="#l8.504"></a><span id="l8.504">                   undoMsgTxn-&gt;SetTransactionType(nsIMessenger::eDeleteMsg);</span>
<a href="#l8.505"></a><span id="l8.505">                 else</span>
<a href="#l8.506"></a><span id="l8.506">                   undoMsgTxn-&gt;SetTransactionType(nsIMessenger::eMoveMsg);</span>
<a href="#l8.507"></a><span id="l8.507" class="difflineat">@@ -7595,27 +7590,26 @@ nsImapMailFolder::CopyMessages(nsIMsgFol</span>
<a href="#l8.508"></a><span id="l8.508">     if (NS_FAILED(rv)) goto done;</span>
<a href="#l8.509"></a><span id="l8.509"> </span>
<a href="#l8.510"></a><span id="l8.510">     m_copyState-&gt;m_curIndex = m_copyState-&gt;m_totalCount;</span>
<a href="#l8.511"></a><span id="l8.511"> </span>
<a href="#l8.512"></a><span id="l8.512">     if (isMove)</span>
<a href="#l8.513"></a><span id="l8.513">       srcFolder-&gt;EnableNotifications(allMessageCountNotifications, false, true/* dbBatching*/);  //disable message count notification</span>
<a href="#l8.514"></a><span id="l8.514"> </span>
<a href="#l8.515"></a><span id="l8.515">     copySupport = do_QueryInterface(m_copyState);</span>
<a href="#l8.516"></a><span id="l8.516" class="difflineminus">-    rv = imapService-&gt;OnlineMessageCopy(m_thread,</span>
<a href="#l8.517"></a><span id="l8.517" class="difflineminus">-                                        srcFolder, messageIds,</span>
<a href="#l8.518"></a><span id="l8.518" class="difflineplus">+    rv = imapService-&gt;OnlineMessageCopy(srcFolder, messageIds,</span>
<a href="#l8.519"></a><span id="l8.519">                                         this, true, isMove,</span>
<a href="#l8.520"></a><span id="l8.520">                                         urlListener, nsnull,</span>
<a href="#l8.521"></a><span id="l8.521">                                         copySupport, msgWindow);</span>
<a href="#l8.522"></a><span id="l8.522">     if (NS_SUCCEEDED(rv) &amp;&amp; m_copyState-&gt;m_allowUndo)</span>
<a href="#l8.523"></a><span id="l8.523">     {</span>
<a href="#l8.524"></a><span id="l8.524">       nsRefPtr&lt;nsImapMoveCopyMsgTxn&gt; undoMsgTxn = new nsImapMoveCopyMsgTxn;</span>
<a href="#l8.525"></a><span id="l8.525">       if (!undoMsgTxn || NS_FAILED(undoMsgTxn-&gt;Init(srcFolder, &amp;srcKeyArray,</span>
<a href="#l8.526"></a><span id="l8.526">                                    messageIds.get(), this,</span>
<a href="#l8.527"></a><span id="l8.527" class="difflineminus">-                                   true, isMove, m_thread)))</span>
<a href="#l8.528"></a><span id="l8.528" class="difflineplus">+                                   true, isMove)))</span>
<a href="#l8.529"></a><span id="l8.529">         return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l8.530"></a><span id="l8.530"> </span>
<a href="#l8.531"></a><span id="l8.531">       if (isMove)</span>
<a href="#l8.532"></a><span id="l8.532">       {</span>
<a href="#l8.533"></a><span id="l8.533">         if (mFlags &amp; nsMsgFolderFlags::Trash)</span>
<a href="#l8.534"></a><span id="l8.534">           undoMsgTxn-&gt;SetTransactionType(nsIMessenger::eDeleteMsg);</span>
<a href="#l8.535"></a><span id="l8.535">         else</span>
<a href="#l8.536"></a><span id="l8.536">           undoMsgTxn-&gt;SetTransactionType(nsIMessenger::eMoveMsg);</span>
<a href="#l8.537"></a><span id="l8.537" class="difflineat">@@ -7692,19 +7686,17 @@ nsImapFolderCopyState::StartNextCopy()</span>
<a href="#l8.538"></a><span id="l8.538"> {</span>
<a href="#l8.539"></a><span id="l8.539">   nsresult rv;</span>
<a href="#l8.540"></a><span id="l8.540">   // first make sure dest folder exists.</span>
<a href="#l8.541"></a><span id="l8.541">   nsCOMPtr &lt;nsIImapService&gt; imapService = do_GetService (NS_IMAPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l8.542"></a><span id="l8.542">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.543"></a><span id="l8.543">   nsString folderName;</span>
<a href="#l8.544"></a><span id="l8.544">   m_curSrcFolder-&gt;GetName(folderName);</span>
<a href="#l8.545"></a><span id="l8.545"> </span>
<a href="#l8.546"></a><span id="l8.546" class="difflineminus">-  nsCOMPtr&lt;nsIThread&gt; thread(do_GetCurrentThread());</span>
<a href="#l8.547"></a><span id="l8.547" class="difflineminus">-  return imapService-&gt;EnsureFolderExists(thread,</span>
<a href="#l8.548"></a><span id="l8.548" class="difflineminus">-                                         m_curDestParent,</span>
<a href="#l8.549"></a><span id="l8.549" class="difflineplus">+  return imapService-&gt;EnsureFolderExists(m_curDestParent,</span>
<a href="#l8.550"></a><span id="l8.550">                                          folderName,</span>
<a href="#l8.551"></a><span id="l8.551">                                          this, nsnull);</span>
<a href="#l8.552"></a><span id="l8.552"> }</span>
<a href="#l8.553"></a><span id="l8.553"> </span>
<a href="#l8.554"></a><span id="l8.554"> nsresult nsImapFolderCopyState::AdvanceToNextFolder(nsresult aStatus)</span>
<a href="#l8.555"></a><span id="l8.555"> {</span>
<a href="#l8.556"></a><span id="l8.556">   nsresult rv;</span>
<a href="#l8.557"></a><span id="l8.557">   m_childIndex++;</span>
<a href="#l8.558"></a><span id="l8.558" class="difflineat">@@ -7974,18 +7966,17 @@ nsImapMailFolder::CopyFolder(nsIMsgFolde</span>
<a href="#l8.559"></a><span id="l8.559">         }</span>
<a href="#l8.560"></a><span id="l8.560">       }</span>
<a href="#l8.561"></a><span id="l8.561">       rv = InitCopyState(srcSupport, nsnull, false, nsnull,</span>
<a href="#l8.562"></a><span id="l8.562">                          false, 0, EmptyCString(), listener, </span>
<a href="#l8.563"></a><span id="l8.563">                          msgWindow, false);</span>
<a href="#l8.564"></a><span id="l8.564">       if (NS_FAILED(rv))</span>
<a href="#l8.565"></a><span id="l8.565">         return OnCopyCompleted(srcSupport, rv);</span>
<a href="#l8.566"></a><span id="l8.566"> </span>
<a href="#l8.567"></a><span id="l8.567" class="difflineminus">-      rv = imapService-&gt;MoveFolder(m_thread,</span>
<a href="#l8.568"></a><span id="l8.568" class="difflineminus">-                                   srcFolder,</span>
<a href="#l8.569"></a><span id="l8.569" class="difflineplus">+      rv = imapService-&gt;MoveFolder(srcFolder,</span>
<a href="#l8.570"></a><span id="l8.570">                                    this,</span>
<a href="#l8.571"></a><span id="l8.571">                                    this,</span>
<a href="#l8.572"></a><span id="l8.572">                                    msgWindow,</span>
<a href="#l8.573"></a><span id="l8.573">                                    nsnull);</span>
<a href="#l8.574"></a><span id="l8.574">     }</span>
<a href="#l8.575"></a><span id="l8.575">   }</span>
<a href="#l8.576"></a><span id="l8.576">   else // copying folder (should only be across server?)</span>
<a href="#l8.577"></a><span id="l8.577">   {</span>
<a href="#l8.578"></a><span id="l8.578" class="difflineat">@@ -8051,18 +8042,17 @@ nsImapMailFolder::CopyFileMessage(nsIFil</span>
<a href="#l8.579"></a><span id="l8.579">       copySupport = do_QueryInterface(m_copyState);</span>
<a href="#l8.580"></a><span id="l8.580">     if (!isDraftOrTemplate)</span>
<a href="#l8.581"></a><span id="l8.581">     {</span>
<a href="#l8.582"></a><span id="l8.582">       m_copyState-&gt;m_totalCount = 1;</span>
<a href="#l8.583"></a><span id="l8.583">       // This makes the IMAP APPEND set the INTERNALDATE for the msg copy</span>
<a href="#l8.584"></a><span id="l8.584">       // we make when detaching/deleting attachments to the original msg date.</span>
<a href="#l8.585"></a><span id="l8.585">       m_copyState-&gt;m_message = msgToReplace;</span>
<a href="#l8.586"></a><span id="l8.586">     }</span>
<a href="#l8.587"></a><span id="l8.587" class="difflineminus">-    rv = imapService-&gt;AppendMessageFromFile(m_thread, file, this,</span>
<a href="#l8.588"></a><span id="l8.588" class="difflineminus">-                                            messageId,</span>
<a href="#l8.589"></a><span id="l8.589" class="difflineplus">+    rv = imapService-&gt;AppendMessageFromFile(file, this, messageId,</span>
<a href="#l8.590"></a><span id="l8.590">                                             true, isDraftOrTemplate,</span>
<a href="#l8.591"></a><span id="l8.591">                                             urlListener, nsnull,</span>
<a href="#l8.592"></a><span id="l8.592">                                             copySupport,</span>
<a href="#l8.593"></a><span id="l8.593">                                             msgWindow);</span>
<a href="#l8.594"></a><span id="l8.594">     if (NS_FAILED(rv))</span>
<a href="#l8.595"></a><span id="l8.595">       return OnCopyCompleted(srcSupport, rv);</span>
<a href="#l8.596"></a><span id="l8.596"> </span>
<a href="#l8.597"></a><span id="l8.597">     return rv;</span>
<a href="#l8.598"></a><span id="l8.598" class="difflineat">@@ -8621,19 +8611,17 @@ NS_IMETHODIMP nsImapMailFolder::PerformE</span>
<a href="#l8.599"></a><span id="l8.599">   nsCOMPtr&lt;nsIImapIncomingServer&gt; imapServer;</span>
<a href="#l8.600"></a><span id="l8.600">   rv = GetImapIncomingServer(getter_AddRefs(imapServer));</span>
<a href="#l8.601"></a><span id="l8.601">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.602"></a><span id="l8.602">   rv = imapServer-&gt;GetUsingSubscription(&amp;usingSubscription);</span>
<a href="#l8.603"></a><span id="l8.603">   if (NS_SUCCEEDED(rv) &amp;&amp; !usingSubscription)</span>
<a href="#l8.604"></a><span id="l8.604">   {</span>
<a href="#l8.605"></a><span id="l8.605">     nsCOMPtr&lt;nsIImapService&gt; imapService = do_GetService(NS_IMAPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l8.606"></a><span id="l8.606">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.607"></a><span id="l8.607" class="difflineminus">-    rv = imapService-&gt;DiscoverChildren(m_thread, this, this,</span>
<a href="#l8.608"></a><span id="l8.608" class="difflineminus">-                                       m_onlineFolderName,</span>
<a href="#l8.609"></a><span id="l8.609" class="difflineminus">-                                       nsnull);</span>
<a href="#l8.610"></a><span id="l8.610" class="difflineplus">+    rv = imapService-&gt;DiscoverChildren( this, this, m_onlineFolderName, nsnull);</span>
<a href="#l8.611"></a><span id="l8.611">   }</span>
<a href="#l8.612"></a><span id="l8.612">   return rv;</span>
<a href="#l8.613"></a><span id="l8.613"> }</span>
<a href="#l8.614"></a><span id="l8.614"> </span>
<a href="#l8.615"></a><span id="l8.615"> NS_IMETHODIMP nsImapMailFolder::RenameClient(nsIMsgWindow *msgWindow, nsIMsgFolder *msgFolder, const nsACString&amp; oldName, const nsACString&amp; newName)</span>
<a href="#l8.616"></a><span id="l8.616"> {</span>
<a href="#l8.617"></a><span id="l8.617">   nsresult rv;</span>
<a href="#l8.618"></a><span id="l8.618">   nsCOMPtr&lt;nsILocalFile&gt; pathFile;</span>
<a href="#l8.619"></a><span id="l8.619" class="difflineat">@@ -8940,17 +8928,17 @@ nsImapMailFolder::StoreCustomKeywords(ns</span>
<a href="#l8.620"></a><span id="l8.620">       mDatabase-&gt;Commit(nsMsgDBCommitType::kLargeCommit); // flush offline ops</span>
<a href="#l8.621"></a><span id="l8.621">       return rv;</span>
<a href="#l8.622"></a><span id="l8.622">     }</span>
<a href="#l8.623"></a><span id="l8.623">   }</span>
<a href="#l8.624"></a><span id="l8.624">   nsCOMPtr&lt;nsIImapService&gt; imapService(do_GetService(NS_IMAPSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l8.625"></a><span id="l8.625">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.626"></a><span id="l8.626">   nsCAutoString msgIds;</span>
<a href="#l8.627"></a><span id="l8.627">   AllocateUidStringFromKeys(aKeysToStore, aNumKeys, msgIds);</span>
<a href="#l8.628"></a><span id="l8.628" class="difflineminus">-  return imapService-&gt;StoreCustomKeywords(m_thread, this, aMsgWindow, aFlagsToAdd,</span>
<a href="#l8.629"></a><span id="l8.629" class="difflineplus">+  return imapService-&gt;StoreCustomKeywords(this, aMsgWindow, aFlagsToAdd,</span>
<a href="#l8.630"></a><span id="l8.630">                                           aFlagsToSubtract, msgIds, _retval);</span>
<a href="#l8.631"></a><span id="l8.631"> }</span>
<a href="#l8.632"></a><span id="l8.632"> </span>
<a href="#l8.633"></a><span id="l8.633"> NS_IMETHODIMP nsImapMailFolder::NotifyIfNewMail()</span>
<a href="#l8.634"></a><span id="l8.634"> {</span>
<a href="#l8.635"></a><span id="l8.635">   return PerformBiffNotifications();</span>
<a href="#l8.636"></a><span id="l8.636"> }</span>
<a href="#l8.637"></a><span id="l8.637"> </span>
<a href="#l8.638"></a><span id="l8.638" class="difflineat">@@ -9272,17 +9260,17 @@ NS_IMETHODIMP nsImapMailFolder::FetchMsg</span>
<a href="#l8.639"></a><span id="l8.639">     }</span>
<a href="#l8.640"></a><span id="l8.640">   }</span>
<a href="#l8.641"></a><span id="l8.641">   if (!keysToFetchFromServer.IsEmpty())</span>
<a href="#l8.642"></a><span id="l8.642">   {</span>
<a href="#l8.643"></a><span id="l8.643">     PRUint32 msgCount = keysToFetchFromServer.Length();</span>
<a href="#l8.644"></a><span id="l8.644">     nsCAutoString messageIds;</span>
<a href="#l8.645"></a><span id="l8.645">     AllocateImapUidString(keysToFetchFromServer.Elements(), msgCount,</span>
<a href="#l8.646"></a><span id="l8.646">                          nsnull, messageIds);</span>
<a href="#l8.647"></a><span id="l8.647" class="difflineminus">-    rv = imapService-&gt;GetBodyStart(m_thread, this, aUrlListener,</span>
<a href="#l8.648"></a><span id="l8.648" class="difflineplus">+    rv = imapService-&gt;GetBodyStart(this, aUrlListener,</span>
<a href="#l8.649"></a><span id="l8.649">                                    messageIds, 2048, nsnull);</span>
<a href="#l8.650"></a><span id="l8.650">     *aAsyncResults = true; // the preview text will be available async...</span>
<a href="#l8.651"></a><span id="l8.651">   }</span>
<a href="#l8.652"></a><span id="l8.652">   return NS_OK;</span>
<a href="#l8.653"></a><span id="l8.653"> }</span>
<a href="#l8.654"></a><span id="l8.654"> </span>
<a href="#l8.655"></a><span id="l8.655"> NS_IMETHODIMP nsImapMailFolder::AddKeywordsToMessages(nsIArray *aMessages, const nsACString&amp; aKeywords)</span>
<a href="#l8.656"></a><span id="l8.656"> {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/imap/src/nsImapMailFolder.h</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapMailFolder.h</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -54,17 +54,16 @@</span>
<a href="#l9.4"></a><span id="l9.4"> #include &quot;nsIMsgFilterHitNotify.h&quot;</span>
<a href="#l9.5"></a><span id="l9.5"> #include &quot;nsIMsgFilterList.h&quot;</span>
<a href="#l9.6"></a><span id="l9.6"> #include &quot;prmon.h&quot;</span>
<a href="#l9.7"></a><span id="l9.7"> #include &quot;nsIMsgImapMailFolder.h&quot;</span>
<a href="#l9.8"></a><span id="l9.8"> #include &quot;nsIMsgLocalMailFolder.h&quot;</span>
<a href="#l9.9"></a><span id="l9.9"> #include &quot;nsIImapMailFolderSink.h&quot;</span>
<a href="#l9.10"></a><span id="l9.10"> #include &quot;nsIImapServerSink.h&quot;</span>
<a href="#l9.11"></a><span id="l9.11"> #include &quot;nsIMsgFilterPlugin.h&quot;</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-#include &quot;nsIEventTarget.h&quot;</span>
<a href="#l9.13"></a><span id="l9.13"> #include &quot;nsIThread.h&quot;</span>
<a href="#l9.14"></a><span id="l9.14"> #include &quot;nsDataHashtable.h&quot;</span>
<a href="#l9.15"></a><span id="l9.15"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l9.16"></a><span id="l9.16"> #include &quot;nsITimer.h&quot;</span>
<a href="#l9.17"></a><span id="l9.17"> #include &quot;nsCOMArray.h&quot;</span>
<a href="#l9.18"></a><span id="l9.18"> #include &quot;nsAutoSyncState.h&quot;</span>
<a href="#l9.19"></a><span id="l9.19"> </span>
<a href="#l9.20"></a><span id="l9.20"> class nsImapMoveCoalescer;</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineat">@@ -479,17 +478,16 @@ protected:</span>
<a href="#l9.22"></a><span id="l9.22">   // folder total and unread counts.</span>
<a href="#l9.23"></a><span id="l9.23">   PRInt32 m_numServerRecentMessages;</span>
<a href="#l9.24"></a><span id="l9.24">   PRInt32 m_numServerUnseenMessages;</span>
<a href="#l9.25"></a><span id="l9.25">   PRInt32 m_numServerTotalMessages;</span>
<a href="#l9.26"></a><span id="l9.26">   // if server supports UIDNEXT, we store it here.</span>
<a href="#l9.27"></a><span id="l9.27">   PRInt32 m_nextUID;</span>
<a href="#l9.28"></a><span id="l9.28"> </span>
<a href="#l9.29"></a><span id="l9.29">   PRInt32  m_nextMessageByteLength;</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineminus">-  nsCOMPtr&lt;nsIThread&gt; m_thread;</span>
<a href="#l9.31"></a><span id="l9.31">   nsCOMPtr&lt;nsIUrlListener&gt; m_urlListener;</span>
<a href="#l9.32"></a><span id="l9.32">   bool m_urlRunning;</span>
<a href="#l9.33"></a><span id="l9.33"> </span>
<a href="#l9.34"></a><span id="l9.34">   // undo move/copy transaction support</span>
<a href="#l9.35"></a><span id="l9.35">   nsRefPtr&lt;nsMsgTxn&gt; m_pendingUndoTxn;</span>
<a href="#l9.36"></a><span id="l9.36">   nsRefPtr&lt;nsImapMailCopyState&gt; m_copyState;</span>
<a href="#l9.37"></a><span id="l9.37">   char m_hierarchyDelimiter;</span>
<a href="#l9.38"></a><span id="l9.38">   PRInt32 m_boxFlags;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/imap/src/nsImapOfflineSync.cpp</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapOfflineSync.cpp</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -1043,43 +1043,24 @@ nsresult nsImapOfflineSync::ProcessNextO</span>
<a href="#l10.4"></a><span id="l10.4">     {</span>
<a href="#l10.5"></a><span id="l10.5">       m_currentServer = nsnull;</span>
<a href="#l10.6"></a><span id="l10.6">       AdvanceToNextFolder();</span>
<a href="#l10.7"></a><span id="l10.7">     }</span>
<a href="#l10.8"></a><span id="l10.8">     if (m_singleFolderToUpdate)</span>
<a href="#l10.9"></a><span id="l10.9">     {</span>
<a href="#l10.10"></a><span id="l10.10">       m_singleFolderToUpdate-&gt;ClearFlag(nsMsgFolderFlags::OfflineEvents);</span>
<a href="#l10.11"></a><span id="l10.11">       m_singleFolderToUpdate-&gt;UpdateFolder(m_window);</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-      // do we have to do anything? Old code would do a start update...</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-    }</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineminus">-    else</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineminus">-    {</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+      nsCOMPtr&lt;nsIMsgImapMailFolder&gt; imapFolder(do_QueryInterface(m_singleFolderToUpdate));</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineplus">+      if (imapFolder)</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineplus">+      {</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineplus">+        nsCOMPtr&lt;nsIUrlListener&gt; saveListener = m_listener;</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineplus">+//        m_listener = nsnull;</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineplus">+//        imapFolder-&gt;UpdateFolderWithListener(m_window, saveListener);</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineplus">+      }</span>
<a href="#l10.23"></a><span id="l10.23">     }</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineminus">-    </span>
<a href="#l10.25"></a><span id="l10.25" class="difflineminus">-    //		MSG_FolderIterator *updateFolderIterator = m_singleFolderToUpdate ? (MSG_FolderIterator *) 0 : m_folderIterator;</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineminus">-    </span>
<a href="#l10.27"></a><span id="l10.27" class="difflineminus">-    </span>
<a href="#l10.28"></a><span id="l10.28" class="difflineminus">-    // we are done playing commands back, now queue up the sync with each imap folder</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineminus">-    // If we're using the iterator, m_currentFolder will be set correctly</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineminus">-    //			nsIMsgFolder * folder = m_singleFolderToUpdate ? m_singleFolderToUpdate : m_currentFolder;</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineminus">-    //			while (folder)</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineminus">-    //			{            </span>
<a href="#l10.33"></a><span id="l10.33" class="difflineminus">-    //				bool loadingFolder = m_workerPane-&gt;GetLoadingImapFolder() == folder;</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineminus">-    //				if ((folder-&gt;GetType() == FOLDER_IMAPMAIL) &amp;&amp; (deletedAllOfflineEventsInFolder == folder || (folder-&gt;GetFolderPrefFlags() &amp; nsMsgFolderFlags::Offline)</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineminus">-    //					|| loadingFolder) </span>
<a href="#l10.36"></a><span id="l10.36" class="difflineminus">-    //					&amp;&amp; !(folder-&gt;GetFolderPrefFlags() &amp; MSG_FOLDER_PREF_IMAPNOSELECT) )</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineminus">-    //				{</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineminus">-    //					bool lastChance = ((deletedAllOfflineEventsInFolder == folder) &amp;&amp; m_singleFolderToUpdate) || loadingFolder;</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineminus">-    // if deletedAllOfflineEventsInFolder == folder and we're only updating one folder, then we need to update newly selected folder</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineminus">-    // I think this also means that we're really opening the folder...so we tell StartUpdate that we're loading a folder.</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineminus">-    //					if (!updateFolderIterator || !(imapMail-&gt;GetFlags() &amp; nsMsgFolderFlags::Inbox))		// avoid queueing the inbox twice</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineminus">-    //						imapMail-&gt;StartUpdateOfNewlySelectedFolder(m_workerPane, lastChance, queue, nsnsnull, false, false);</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineminus">-    //				}</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineminus">-    //				folder= m_singleFolderToUpdate ? (MSG_FolderInfo *)nsnull : updateFolderIterator-&gt;Next();</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineminus">-    //       }</span>
<a href="#l10.46"></a><span id="l10.46">   }</span>
<a href="#l10.47"></a><span id="l10.47">   // if we get here, then I *think* we're done. Not sure, though.</span>
<a href="#l10.48"></a><span id="l10.48"> #ifdef DEBUG_bienvenu</span>
<a href="#l10.49"></a><span id="l10.49">   printf(&quot;done with offline imap sync\n&quot;);</span>
<a href="#l10.50"></a><span id="l10.50"> #endif</span>
<a href="#l10.51"></a><span id="l10.51">   nsCOMPtr &lt;nsIUrlListener&gt; saveListener = m_listener;</span>
<a href="#l10.52"></a><span id="l10.52">   m_listener = nsnull;</span>
<a href="#l10.53"></a><span id="l10.53"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/imap/src/nsImapProtocol.cpp</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapProtocol.cpp</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -515,37 +515,37 @@ nsresult nsImapProtocol::Configure(PRInt</span>
<a href="#l11.4"></a><span id="l11.4">   m_chunkStartSize = m_chunkSize = ChunkSize;</span>
<a href="#l11.5"></a><span id="l11.5">   m_chunkThreshold = ChunkThreshold;</span>
<a href="#l11.6"></a><span id="l11.6">   m_fetchByChunks = FetchByChunks;</span>
<a href="#l11.7"></a><span id="l11.7"> </span>
<a href="#l11.8"></a><span id="l11.8">   return NS_OK;</span>
<a href="#l11.9"></a><span id="l11.9"> }</span>
<a href="#l11.10"></a><span id="l11.10"> </span>
<a href="#l11.11"></a><span id="l11.11"> </span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-nsresult nsImapProtocol::Initialize(nsIImapHostSessionList * aHostSessionList, nsIImapIncomingServer *aServer,</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-                                    nsIEventTarget * aSinkEventTarget)</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineminus">-{</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineminus">-  NS_PRECONDITION(aSinkEventTarget &amp;&amp; aHostSessionList,</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineminus">-             &quot;oops...trying to initialize with a null sink event target!&quot;);</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineminus">-  if (!aSinkEventTarget || !aHostSessionList || !aServer)</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineplus">+nsImapProtocol::Initialize(nsIImapHostSessionList * aHostSessionList,</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineplus">+                           nsIImapIncomingServer *aServer)</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineplus">+{</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineplus">+  NS_PRECONDITION(aHostSessionList &amp;&amp; aServer,</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineplus">+     &quot;oops...trying to initialize with a null host session list or server!&quot;);</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineplus">+  if (!aHostSessionList || !aServer)</span>
<a href="#l11.25"></a><span id="l11.25">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l11.26"></a><span id="l11.26"> </span>
<a href="#l11.27"></a><span id="l11.27">   nsresult rv = m_downloadLineCache-&gt;GrowBuffer(kDownLoadCacheSize);</span>
<a href="#l11.28"></a><span id="l11.28">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.29"></a><span id="l11.29"> </span>
<a href="#l11.30"></a><span id="l11.30">   m_flagState = new nsImapFlagAndUidState(kImapFlagAndUidStateSize);</span>
<a href="#l11.31"></a><span id="l11.31">   if (!m_flagState)</span>
<a href="#l11.32"></a><span id="l11.32">     return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l11.33"></a><span id="l11.33"> </span>
<a href="#l11.34"></a><span id="l11.34">   aServer-&gt;GetUseIdle(&amp;m_useIdle);</span>
<a href="#l11.35"></a><span id="l11.35">   aServer-&gt;GetUseCondStore(&amp;m_useCondStore);</span>
<a href="#l11.36"></a><span id="l11.36">   aServer-&gt;GetUseCompressDeflate(&amp;m_useCompressDeflate);</span>
<a href="#l11.37"></a><span id="l11.37">   NS_ADDREF(m_flagState);</span>
<a href="#l11.38"></a><span id="l11.38"> </span>
<a href="#l11.39"></a><span id="l11.39" class="difflineminus">-  m_sinkEventTarget = aSinkEventTarget;</span>
<a href="#l11.40"></a><span id="l11.40">   m_hostSessionList = aHostSessionList; // no ref count...host session list has life time &gt; connection</span>
<a href="#l11.41"></a><span id="l11.41">   m_parser.SetHostSessionList(aHostSessionList);</span>
<a href="#l11.42"></a><span id="l11.42">   m_parser.SetFlagState(m_flagState);</span>
<a href="#l11.43"></a><span id="l11.43"> </span>
<a href="#l11.44"></a><span id="l11.44">   // one of the initializations that should be done in UI thread</span>
<a href="#l11.45"></a><span id="l11.45">   nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l11.46"></a><span id="l11.46"> </span>
<a href="#l11.47"></a><span id="l11.47">   // Now initialize the thread for the connection</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineat">@@ -1054,17 +1054,16 @@ NS_IMETHODIMP nsImapProtocol::Run()</span>
<a href="#l11.49"></a><span id="l11.49">     m_runningUrl.swap(doomed);</span>
<a href="#l11.50"></a><span id="l11.50">     NS_ProxyRelease(thread, doomed);</span>
<a href="#l11.51"></a><span id="l11.51">   }</span>
<a href="#l11.52"></a><span id="l11.52"> </span>
<a href="#l11.53"></a><span id="l11.53">   // close streams via UI thread if it's not already done</span>
<a href="#l11.54"></a><span id="l11.54">   if (m_imapProtocolSink)</span>
<a href="#l11.55"></a><span id="l11.55">     m_imapProtocolSink-&gt;CloseStreams();</span>
<a href="#l11.56"></a><span id="l11.56"> </span>
<a href="#l11.57"></a><span id="l11.57" class="difflineminus">-  m_sinkEventTarget = nsnull;</span>
<a href="#l11.58"></a><span id="l11.58">   m_imapMailFolderSink = nsnull;</span>
<a href="#l11.59"></a><span id="l11.59">   m_imapMessageSink = nsnull;</span>
<a href="#l11.60"></a><span id="l11.60"> </span>
<a href="#l11.61"></a><span id="l11.61">   // shutdown this thread, but do it from the main thread</span>
<a href="#l11.62"></a><span id="l11.62">   nsCOMPtr&lt;nsIRunnable&gt; ev = new nsImapThreadShutdownEvent(m_iThread);</span>
<a href="#l11.63"></a><span id="l11.63">   if (NS_FAILED(NS_DispatchToMainThread(ev)))</span>
<a href="#l11.64"></a><span id="l11.64">     NS_WARNING(&quot;Failed to dispatch nsImapThreadShutdownEvent&quot;);</span>
<a href="#l11.65"></a><span id="l11.65">   m_iThread = nsnull;</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineat">@@ -9146,19 +9145,18 @@ nsresult nsImapMockChannel::ReadFromImap</span>
<a href="#l11.67"></a><span id="l11.67"> </span>
<a href="#l11.68"></a><span id="l11.68">   // loading the url consists of asking the server to add the url to it's imap event queue....</span>
<a href="#l11.69"></a><span id="l11.69">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l11.70"></a><span id="l11.70">   rv = mailnewsUrl-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l11.71"></a><span id="l11.71">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.72"></a><span id="l11.72">   nsCOMPtr&lt;nsIImapIncomingServer&gt; imapServer (do_QueryInterface(server, &amp;rv));</span>
<a href="#l11.73"></a><span id="l11.73">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.74"></a><span id="l11.74"> </span>
<a href="#l11.75"></a><span id="l11.75" class="difflineminus">-  nsCOMPtr&lt;nsIThread&gt; thread(do_GetCurrentThread());</span>
<a href="#l11.76"></a><span id="l11.76">   // Assume AsyncRead is always called from the UI thread.....</span>
<a href="#l11.77"></a><span id="l11.77" class="difflineminus">-  return imapServer-&gt;GetImapConnectionAndLoadUrl(thread, imapUrl, nsnull);</span>
<a href="#l11.78"></a><span id="l11.78" class="difflineplus">+  return imapServer-&gt;GetImapConnectionAndLoadUrl(imapUrl, nsnull);</span>
<a href="#l11.79"></a><span id="l11.79"> }</span>
<a href="#l11.80"></a><span id="l11.80"> </span>
<a href="#l11.81"></a><span id="l11.81"> // for messages stored in our offline cache, we have special code to handle that...</span>
<a href="#l11.82"></a><span id="l11.82"> // If it's in the local cache, we return true and we can abort the download because</span>
<a href="#l11.83"></a><span id="l11.83"> // this method does the rest of the work.</span>
<a href="#l11.84"></a><span id="l11.84"> bool nsImapMockChannel::ReadFromLocalCache()</span>
<a href="#l11.85"></a><span id="l11.85"> {</span>
<a href="#l11.86"></a><span id="l11.86">   nsresult rv = NS_OK;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/imap/src/nsImapProtocol.h</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapProtocol.h</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -38,17 +38,16 @@</span>
<a href="#l12.4"></a><span id="l12.4"> </span>
<a href="#l12.5"></a><span id="l12.5"> #ifndef nsImapProtocol_h___</span>
<a href="#l12.6"></a><span id="l12.6"> #define nsImapProtocol_h___</span>
<a href="#l12.7"></a><span id="l12.7"> </span>
<a href="#l12.8"></a><span id="l12.8"> #include &quot;nsIImapProtocol.h&quot;</span>
<a href="#l12.9"></a><span id="l12.9"> #include &quot;nsIImapUrl.h&quot;</span>
<a href="#l12.10"></a><span id="l12.10"> </span>
<a href="#l12.11"></a><span id="l12.11"> #include &quot;nsMsgProtocol.h&quot;</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-#include &quot;nsIEventTarget.h&quot;</span>
<a href="#l12.13"></a><span id="l12.13"> #include &quot;nsIStreamListener.h&quot;</span>
<a href="#l12.14"></a><span id="l12.14"> #include &quot;nsIAsyncOutputStream.h&quot;</span>
<a href="#l12.15"></a><span id="l12.15"> #include &quot;nsIAsyncInputStream.h&quot;</span>
<a href="#l12.16"></a><span id="l12.16"> #include &quot;nsImapCore.h&quot;</span>
<a href="#l12.17"></a><span id="l12.17"> #include &quot;nsStringGlue.h&quot;</span>
<a href="#l12.18"></a><span id="l12.18"> #include &quot;nsIProgressEventSink.h&quot;</span>
<a href="#l12.19"></a><span id="l12.19"> #include &quot;nsIInterfaceRequestor.h&quot;</span>
<a href="#l12.20"></a><span id="l12.20"> #include &quot;nsIInterfaceRequestorUtils.h&quot;</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineat">@@ -370,17 +369,16 @@ private:</span>
<a href="#l12.22"></a><span id="l12.22"> </span>
<a href="#l12.23"></a><span id="l12.23">   nsCOMPtr&lt;nsIAsyncInputStream&gt;   m_channelInputStream;</span>
<a href="#l12.24"></a><span id="l12.24">   nsCOMPtr&lt;nsIAsyncOutputStream&gt;  m_channelOutputStream;</span>
<a href="#l12.25"></a><span id="l12.25">   nsCOMPtr&lt;nsIImapMockChannel&gt;    m_mockChannel;   // this is the channel we should forward to people</span>
<a href="#l12.26"></a><span id="l12.26">   //nsCOMPtr&lt;nsIRequest&gt; mAsyncReadRequest; // we're going to cancel this when we're done with the conn.</span>
<a href="#l12.27"></a><span id="l12.27"> </span>
<a href="#l12.28"></a><span id="l12.28"> </span>
<a href="#l12.29"></a><span id="l12.29">   // ******* Thread support *******</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineminus">-  nsCOMPtr&lt;nsIEventTarget&gt; m_sinkEventTarget;</span>
<a href="#l12.31"></a><span id="l12.31">   nsCOMPtr&lt;nsIThread&gt;      m_iThread;</span>
<a href="#l12.32"></a><span id="l12.32">   PRThread     *m_thread;</span>
<a href="#l12.33"></a><span id="l12.33">   mozilla::ReentrantMonitor m_dataAvailableMonitor;   // used to notify the arrival of data from the server</span>
<a href="#l12.34"></a><span id="l12.34">   mozilla::ReentrantMonitor m_urlReadyToRunMonitor;   // used to notify the arrival of a new url to be processed</span>
<a href="#l12.35"></a><span id="l12.35">   mozilla::ReentrantMonitor m_pseudoInterruptMonitor;</span>
<a href="#l12.36"></a><span id="l12.36">   mozilla::ReentrantMonitor m_dataMemberMonitor;</span>
<a href="#l12.37"></a><span id="l12.37">   mozilla::ReentrantMonitor m_threadDeathMonitor;</span>
<a href="#l12.38"></a><span id="l12.38">   mozilla::ReentrantMonitor m_waitForBodyIdsMonitor;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/imap/src/nsImapService.cpp</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapService.cpp</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -201,23 +201,21 @@ nsresult nsImapService::GetFolderName(ns</span>
<a href="#l13.4"></a><span id="l13.4">     if (NS_SUCCEEDED(rv))</span>
<a href="#l13.5"></a><span id="l13.5">       onlineName.Adopt(escapedOnlineName);</span>
<a href="#l13.6"></a><span id="l13.6">   }</span>
<a href="#l13.7"></a><span id="l13.7">   // need to escape everything else</span>
<a href="#l13.8"></a><span id="l13.8">   MsgEscapeString(onlineName, nsINetUtil::ESCAPE_URL_PATH, aFolderName);</span>
<a href="#l13.9"></a><span id="l13.9">   return rv;</span>
<a href="#l13.10"></a><span id="l13.10"> }</span>
<a href="#l13.11"></a><span id="l13.11"> </span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-NS_IMETHODIMP nsImapService::SelectFolder(nsIEventTarget *aClientEventTarget, </span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-                                          nsIMsgFolder *aImapMailFolder, </span>
<a href="#l13.14"></a><span id="l13.14" class="difflineminus">-                                          nsIUrlListener *aUrlListener, </span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+NS_IMETHODIMP nsImapService::SelectFolder(nsIMsgFolder *aImapMailFolder,</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineplus">+                                          nsIUrlListener *aUrlListener,</span>
<a href="#l13.17"></a><span id="l13.17">                                           nsIMsgWindow *aMsgWindow,</span>
<a href="#l13.18"></a><span id="l13.18">                                           nsIURI **aURL)</span>
<a href="#l13.19"></a><span id="l13.19"> {</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l13.21"></a><span id="l13.21">   NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l13.22"></a><span id="l13.22"> </span>
<a href="#l13.23"></a><span id="l13.23">   if (WeAreOffline())</span>
<a href="#l13.24"></a><span id="l13.24">     return NS_MSG_ERROR_OFFLINE;</span>
<a href="#l13.25"></a><span id="l13.25"> </span>
<a href="#l13.26"></a><span id="l13.26">   bool canOpenThisFolder = true;</span>
<a href="#l13.27"></a><span id="l13.27">   nsCOMPtr&lt;nsIMsgImapMailFolder&gt; imapFolder = do_QueryInterface(aImapMailFolder);</span>
<a href="#l13.28"></a><span id="l13.28">   if (imapFolder)</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineat">@@ -250,34 +248,32 @@ NS_IMETHODIMP nsImapService::SelectFolde</span>
<a href="#l13.30"></a><span id="l13.30">     {</span>
<a href="#l13.31"></a><span id="l13.31">       nsCAutoString folderName;</span>
<a href="#l13.32"></a><span id="l13.32">       GetFolderName(aImapMailFolder, folderName);</span>
<a href="#l13.33"></a><span id="l13.33">       urlSpec.Append(&quot;/select&gt;&quot;);</span>
<a href="#l13.34"></a><span id="l13.34">       urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l13.35"></a><span id="l13.35">       urlSpec.Append(folderName);</span>
<a href="#l13.36"></a><span id="l13.36">       rv = mailNewsUrl-&gt;SetSpec(urlSpec);</span>
<a href="#l13.37"></a><span id="l13.37">       if (NS_SUCCEEDED(rv))</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineminus">-        rv = GetImapConnectionAndLoadUrl(aClientEventTarget, imapUrl, nsnull, aURL);</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineplus">+        rv = GetImapConnectionAndLoadUrl(imapUrl, nsnull, aURL);</span>
<a href="#l13.40"></a><span id="l13.40">     }</span>
<a href="#l13.41"></a><span id="l13.41">   } // if we have a url to run....</span>
<a href="#l13.42"></a><span id="l13.42"> </span>
<a href="#l13.43"></a><span id="l13.43">   return rv;</span>
<a href="#l13.44"></a><span id="l13.44"> }</span>
<a href="#l13.45"></a><span id="l13.45"> </span>
<a href="#l13.46"></a><span id="l13.46"> // lite select, used to verify UIDVALIDITY while going on/offline</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineminus">-NS_IMETHODIMP nsImapService::LiteSelectFolder(nsIEventTarget *aClientEventTarget,</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineminus">-                                              nsIMsgFolder *aImapMailFolder,</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineplus">+NS_IMETHODIMP nsImapService::LiteSelectFolder(nsIMsgFolder *aImapMailFolder,</span>
<a href="#l13.50"></a><span id="l13.50">                                               nsIUrlListener *aUrlListener,</span>
<a href="#l13.51"></a><span id="l13.51">                                               nsIMsgWindow *aMsgWindow,</span>
<a href="#l13.52"></a><span id="l13.52">                                               nsIURI **aURL)</span>
<a href="#l13.53"></a><span id="l13.53"> {</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l13.55"></a><span id="l13.55">   NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l13.56"></a><span id="l13.56"> </span>
<a href="#l13.57"></a><span id="l13.57" class="difflineminus">-  return FolderCommand(aClientEventTarget, aImapMailFolder, aUrlListener,</span>
<a href="#l13.58"></a><span id="l13.58" class="difflineplus">+  return FolderCommand(aImapMailFolder, aUrlListener,</span>
<a href="#l13.59"></a><span id="l13.59">                        &quot;/liteselect&gt;&quot;, nsIImapUrl::nsImapLiteSelectFolder, aMsgWindow, aURL);</span>
<a href="#l13.60"></a><span id="l13.60"> }</span>
<a href="#l13.61"></a><span id="l13.61"> </span>
<a href="#l13.62"></a><span id="l13.62"> NS_IMETHODIMP nsImapService::GetUrlForUri(const char *aMessageURI, </span>
<a href="#l13.63"></a><span id="l13.63">                                           nsIURI **aURL, </span>
<a href="#l13.64"></a><span id="l13.64">                                           nsIMsgWindow *aMsgWindow) </span>
<a href="#l13.65"></a><span id="l13.65"> {</span>
<a href="#l13.66"></a><span id="l13.66">   nsresult rv = NS_OK;</span>
<a href="#l13.67"></a><span id="l13.67" class="difflineat">@@ -693,19 +689,17 @@ nsresult nsImapService::FetchMimePart(ns</span>
<a href="#l13.68"></a><span id="l13.68">       else // do what we used to do before</span>
<a href="#l13.69"></a><span id="l13.69">       {</span>
<a href="#l13.70"></a><span id="l13.70">         // I'd like to get rid of this code as I believe that we always get a docshell</span>
<a href="#l13.71"></a><span id="l13.71">         // or stream listener passed into us in this method but i'm not sure yet...</span>
<a href="#l13.72"></a><span id="l13.72">         // I'm going to use an assert for now to figure out if this is ever getting called</span>
<a href="#l13.73"></a><span id="l13.73"> #if defined(DEBUG_mscott) || defined(DEBUG_bienvenu)</span>
<a href="#l13.74"></a><span id="l13.74">         NS_ERROR(&quot;oops...someone still is reaching this part of the code&quot;);</span>
<a href="#l13.75"></a><span id="l13.75"> #endif</span>
<a href="#l13.76"></a><span id="l13.76" class="difflineminus">-        nsCOMPtr&lt;nsIThread&gt; thread(do_GetCurrentThread());</span>
<a href="#l13.77"></a><span id="l13.77" class="difflineminus">-        rv = GetImapConnectionAndLoadUrl(thread, aImapUrl,</span>
<a href="#l13.78"></a><span id="l13.78" class="difflineminus">-                                         aDisplayConsumer, aURL);</span>
<a href="#l13.79"></a><span id="l13.79" class="difflineplus">+        rv = GetImapConnectionAndLoadUrl(aImapUrl, aDisplayConsumer, aURL);</span>
<a href="#l13.80"></a><span id="l13.80">       }</span>
<a href="#l13.81"></a><span id="l13.81">     }</span>
<a href="#l13.82"></a><span id="l13.82">   }</span>
<a href="#l13.83"></a><span id="l13.83">   return rv;</span>
<a href="#l13.84"></a><span id="l13.84"> }</span>
<a href="#l13.85"></a><span id="l13.85"> </span>
<a href="#l13.86"></a><span id="l13.86"> //</span>
<a href="#l13.87"></a><span id="l13.87"> // rhp: Right now, this is the same as simple DisplayMessage, but it will change</span>
<a href="#l13.88"></a><span id="l13.88" class="difflineat">@@ -861,20 +855,18 @@ NS_IMETHODIMP nsImapService::Search(nsIM</span>
<a href="#l13.89"></a><span id="l13.89">     // escape aSearchUri so that IMAP special characters (i.e. '\')</span>
<a href="#l13.90"></a><span id="l13.90">     // won't be replaced with '/' in NECKO.</span>
<a href="#l13.91"></a><span id="l13.91">     // it will be unescaped in nsImapUrl::ParseUrl().</span>
<a href="#l13.92"></a><span id="l13.92">     nsCString escapedSearchUri;</span>
<a href="#l13.93"></a><span id="l13.93"> </span>
<a href="#l13.94"></a><span id="l13.94">     MsgEscapeString(nsDependentCString(aSearchUri), nsINetUtil::ESCAPE_XALPHAS, escapedSearchUri);</span>
<a href="#l13.95"></a><span id="l13.95">     urlSpec.Append(escapedSearchUri);</span>
<a href="#l13.96"></a><span id="l13.96">     rv = mailNewsUrl-&gt;SetSpec(urlSpec);</span>
<a href="#l13.97"></a><span id="l13.97" class="difflineminus">-    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l13.98"></a><span id="l13.98" class="difflineminus">-      nsCOMPtr&lt;nsIThread&gt; thread(do_GetCurrentThread());</span>
<a href="#l13.99"></a><span id="l13.99" class="difflineminus">-      rv = GetImapConnectionAndLoadUrl(thread, imapUrl, nsnull, nsnull);</span>
<a href="#l13.100"></a><span id="l13.100" class="difflineminus">-    }</span>
<a href="#l13.101"></a><span id="l13.101" class="difflineplus">+    if (NS_SUCCEEDED(rv))</span>
<a href="#l13.102"></a><span id="l13.102" class="difflineplus">+      rv = GetImapConnectionAndLoadUrl(imapUrl, nsnull, nsnull);</span>
<a href="#l13.103"></a><span id="l13.103">   }</span>
<a href="#l13.104"></a><span id="l13.104">   return rv;</span>
<a href="#l13.105"></a><span id="l13.105"> }</span>
<a href="#l13.106"></a><span id="l13.106"> </span>
<a href="#l13.107"></a><span id="l13.107"> // just a helper method to break down imap message URIs....</span>
<a href="#l13.108"></a><span id="l13.108"> nsresult nsImapService::DecomposeImapURI(const nsACString &amp;aMessageURI, </span>
<a href="#l13.109"></a><span id="l13.109">                                          nsIMsgFolder **aFolder, </span>
<a href="#l13.110"></a><span id="l13.110">                                          nsACString &amp;aMsgKey)</span>
<a href="#l13.111"></a><span id="l13.111" class="difflineat">@@ -1136,18 +1128,17 @@ nsresult nsImapService::GetMessageFromUr</span>
<a href="#l13.112"></a><span id="l13.112">     else // do what we used to do before</span>
<a href="#l13.113"></a><span id="l13.113">     {</span>
<a href="#l13.114"></a><span id="l13.114">       // I'd like to get rid of this code as I believe that we always get a docshell</span>
<a href="#l13.115"></a><span id="l13.115">       // or stream listener passed into us in this method but i'm not sure yet...</span>
<a href="#l13.116"></a><span id="l13.116">       // I'm going to use an assert for now to figure out if this is ever getting called</span>
<a href="#l13.117"></a><span id="l13.117"> #if defined(DEBUG_mscott) || defined(DEBUG_bienvenu)</span>
<a href="#l13.118"></a><span id="l13.118">       NS_ERROR(&quot;oops...someone still is reaching this part of the code&quot;);</span>
<a href="#l13.119"></a><span id="l13.119"> #endif</span>
<a href="#l13.120"></a><span id="l13.120" class="difflineminus">-      nsCOMPtr&lt;nsIThread&gt; thread(do_GetCurrentThread());</span>
<a href="#l13.121"></a><span id="l13.121" class="difflineminus">-      rv = GetImapConnectionAndLoadUrl(thread, aImapUrl,</span>
<a href="#l13.122"></a><span id="l13.122" class="difflineplus">+      rv = GetImapConnectionAndLoadUrl(aImapUrl,</span>
<a href="#l13.123"></a><span id="l13.123">                                        aDisplayConsumer, aURL);</span>
<a href="#l13.124"></a><span id="l13.124">     }</span>
<a href="#l13.125"></a><span id="l13.125">   }</span>
<a href="#l13.126"></a><span id="l13.126">   return rv;</span>
<a href="#l13.127"></a><span id="l13.127"> }</span>
<a href="#l13.128"></a><span id="l13.128"> </span>
<a href="#l13.129"></a><span id="l13.129"> // this method streams a message to the passed in consumer, with an optional stream converter</span>
<a href="#l13.130"></a><span id="l13.130"> // and additional header (e.g., &quot;header=filter&quot;)</span>
<a href="#l13.131"></a><span id="l13.131" class="difflineat">@@ -1403,27 +1394,25 @@ nsresult nsImapService::CreateStartOfIma</span>
<a href="#l13.132"></a><span id="l13.132">   }</span>
<a href="#l13.133"></a><span id="l13.133">   return rv;</span>
<a href="#l13.134"></a><span id="l13.134"> }</span>
<a href="#l13.135"></a><span id="l13.135"> </span>
<a href="#l13.136"></a><span id="l13.136"> /* fetching the headers of RFC822 messages */</span>
<a href="#l13.137"></a><span id="l13.137"> /* imap4://HOST&gt;header&gt;&lt;UID/SEQUENCE&gt;&gt;MAILBOXPATH&gt;x */</span>
<a href="#l13.138"></a><span id="l13.138"> /*   'x' is the message UID or sequence number list */</span>
<a href="#l13.139"></a><span id="l13.139"> /* will not affect the 'SEEN' flag */</span>
<a href="#l13.140"></a><span id="l13.140" class="difflineminus">-NS_IMETHODIMP nsImapService::GetHeaders(nsIEventTarget *aClientEventTarget, </span>
<a href="#l13.141"></a><span id="l13.141" class="difflineminus">-                                        nsIMsgFolder *aImapMailFolder, </span>
<a href="#l13.142"></a><span id="l13.142" class="difflineplus">+NS_IMETHODIMP nsImapService::GetHeaders(nsIMsgFolder *aImapMailFolder, </span>
<a href="#l13.143"></a><span id="l13.143">                                         nsIUrlListener *aUrlListener, </span>
<a href="#l13.144"></a><span id="l13.144">                                         nsIURI **aURL,</span>
<a href="#l13.145"></a><span id="l13.145">                                         const nsACString &amp;messageIdentifierList,</span>
<a href="#l13.146"></a><span id="l13.146">                                         bool messageIdsAreUID)</span>
<a href="#l13.147"></a><span id="l13.147"> {</span>
<a href="#l13.148"></a><span id="l13.148">   // create a protocol instance to handle the request.</span>
<a href="#l13.149"></a><span id="l13.149">   // NOTE: once we start working with multiple connections, this step will be much more complicated...but for now</span>
<a href="#l13.150"></a><span id="l13.150">   // just create a connection and process the request.</span>
<a href="#l13.151"></a><span id="l13.151" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l13.152"></a><span id="l13.152">   NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l13.153"></a><span id="l13.153"> </span>
<a href="#l13.154"></a><span id="l13.154">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l13.155"></a><span id="l13.155">   nsCAutoString urlSpec;</span>
<a href="#l13.156"></a><span id="l13.156">   char hierarchyDelimiter = GetHierarchyDelimiter(aImapMailFolder);</span>
<a href="#l13.157"></a><span id="l13.157"> </span>
<a href="#l13.158"></a><span id="l13.158">   nsresult rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), aImapMailFolder, </span>
<a href="#l13.159"></a><span id="l13.159">                                      aUrlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l13.160"></a><span id="l13.160" class="difflineat">@@ -1445,36 +1434,34 @@ NS_IMETHODIMP nsImapService::GetHeaders(</span>
<a href="#l13.161"></a><span id="l13.161"> </span>
<a href="#l13.162"></a><span id="l13.162">       GetFolderName(aImapMailFolder, folderName);</span>
<a href="#l13.163"></a><span id="l13.163">       urlSpec.Append(folderName);</span>
<a href="#l13.164"></a><span id="l13.164">       urlSpec.Append(&quot;&gt;&quot;);</span>
<a href="#l13.165"></a><span id="l13.165">       urlSpec.Append(messageIdentifierList);</span>
<a href="#l13.166"></a><span id="l13.166">       rv = uri-&gt;SetSpec(urlSpec);</span>
<a href="#l13.167"></a><span id="l13.167"> </span>
<a href="#l13.168"></a><span id="l13.168">       if (NS_SUCCEEDED(rv))</span>
<a href="#l13.169"></a><span id="l13.169" class="difflineminus">-        rv = GetImapConnectionAndLoadUrl(aClientEventTarget, imapUrl, nsnull, aURL);</span>
<a href="#l13.170"></a><span id="l13.170" class="difflineplus">+        rv = GetImapConnectionAndLoadUrl(imapUrl, nsnull, aURL);</span>
<a href="#l13.171"></a><span id="l13.171">     }</span>
<a href="#l13.172"></a><span id="l13.172">   }</span>
<a href="#l13.173"></a><span id="l13.173">   return rv;</span>
<a href="#l13.174"></a><span id="l13.174"> }</span>
<a href="#l13.175"></a><span id="l13.175"> </span>
<a href="#l13.176"></a><span id="l13.176"> </span>
<a href="#l13.177"></a><span id="l13.177"> /* peeking at the start of msg bodies */</span>
<a href="#l13.178"></a><span id="l13.178"> /* imap4://HOST&gt;header&gt;&lt;UID&gt;&gt;MAILBOXPATH&gt;x&gt;n */</span>
<a href="#l13.179"></a><span id="l13.179"> /*   'x' is the message UID */</span>
<a href="#l13.180"></a><span id="l13.180"> /*   'n' is the number of bytes to fetch */</span>
<a href="#l13.181"></a><span id="l13.181"> /* will not affect the 'SEEN' flag */</span>
<a href="#l13.182"></a><span id="l13.182" class="difflineminus">-NS_IMETHODIMP nsImapService::GetBodyStart(nsIEventTarget *aClientEventTarget, </span>
<a href="#l13.183"></a><span id="l13.183" class="difflineminus">-                                          nsIMsgFolder *aImapMailFolder, </span>
<a href="#l13.184"></a><span id="l13.184" class="difflineplus">+NS_IMETHODIMP nsImapService::GetBodyStart(nsIMsgFolder *aImapMailFolder, </span>
<a href="#l13.185"></a><span id="l13.185">                                           nsIUrlListener *aUrlListener, </span>
<a href="#l13.186"></a><span id="l13.186">                                           const nsACString &amp;messageIdentifierList,</span>
<a href="#l13.187"></a><span id="l13.187">                                           PRInt32 numBytes,</span>
<a href="#l13.188"></a><span id="l13.188">                                           nsIURI **aURL)</span>
<a href="#l13.189"></a><span id="l13.189"> {</span>
<a href="#l13.190"></a><span id="l13.190" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l13.191"></a><span id="l13.191">   NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l13.192"></a><span id="l13.192"> </span>
<a href="#l13.193"></a><span id="l13.193">   nsresult rv;</span>
<a href="#l13.194"></a><span id="l13.194">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l13.195"></a><span id="l13.195">   nsCAutoString urlSpec;</span>
<a href="#l13.196"></a><span id="l13.196"> </span>
<a href="#l13.197"></a><span id="l13.197">   char hierarchyDelimiter = GetHierarchyDelimiter(aImapMailFolder);</span>
<a href="#l13.198"></a><span id="l13.198">   rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), aImapMailFolder, </span>
<a href="#l13.199"></a><span id="l13.199" class="difflineat">@@ -1497,31 +1484,29 @@ NS_IMETHODIMP nsImapService::GetBodyStar</span>
<a href="#l13.200"></a><span id="l13.200">       GetFolderName(aImapMailFolder, folderName);</span>
<a href="#l13.201"></a><span id="l13.201">       urlSpec.Append(folderName);</span>
<a href="#l13.202"></a><span id="l13.202">       urlSpec.Append(&quot;&gt;&quot;);</span>
<a href="#l13.203"></a><span id="l13.203">       urlSpec.Append(messageIdentifierList);</span>
<a href="#l13.204"></a><span id="l13.204">       urlSpec.Append(&quot;&gt;&quot;);</span>
<a href="#l13.205"></a><span id="l13.205">       urlSpec.AppendInt(numBytes);</span>
<a href="#l13.206"></a><span id="l13.206">       rv = uri-&gt;SetSpec(urlSpec);</span>
<a href="#l13.207"></a><span id="l13.207">       if (NS_SUCCEEDED(rv))</span>
<a href="#l13.208"></a><span id="l13.208" class="difflineminus">-        rv = GetImapConnectionAndLoadUrl(aClientEventTarget, imapUrl, nsnull, aURL);</span>
<a href="#l13.209"></a><span id="l13.209" class="difflineplus">+        rv = GetImapConnectionAndLoadUrl(imapUrl, nsnull, aURL);</span>
<a href="#l13.210"></a><span id="l13.210">     }</span>
<a href="#l13.211"></a><span id="l13.211">   }</span>
<a href="#l13.212"></a><span id="l13.212">   return rv;</span>
<a href="#l13.213"></a><span id="l13.213"> }</span>
<a href="#l13.214"></a><span id="l13.214"> </span>
<a href="#l13.215"></a><span id="l13.215" class="difflineminus">-nsresult nsImapService::FolderCommand(nsIEventTarget *aClientEventTarget,</span>
<a href="#l13.216"></a><span id="l13.216" class="difflineminus">-                                      nsIMsgFolder *imapMailFolder,</span>
<a href="#l13.217"></a><span id="l13.217" class="difflineplus">+nsresult nsImapService::FolderCommand(nsIMsgFolder *imapMailFolder,</span>
<a href="#l13.218"></a><span id="l13.218">                                       nsIUrlListener *urlListener,</span>
<a href="#l13.219"></a><span id="l13.219">                                       const char *aCommand,</span>
<a href="#l13.220"></a><span id="l13.220">                                       nsImapAction imapAction,</span>
<a href="#l13.221"></a><span id="l13.221">                                       nsIMsgWindow *msgWindow,</span>
<a href="#l13.222"></a><span id="l13.222">                                       nsIURI **url)</span>
<a href="#l13.223"></a><span id="l13.223"> {</span>
<a href="#l13.224"></a><span id="l13.224" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l13.225"></a><span id="l13.225">   NS_ENSURE_ARG_POINTER(imapMailFolder);</span>
<a href="#l13.226"></a><span id="l13.226"> </span>
<a href="#l13.227"></a><span id="l13.227">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l13.228"></a><span id="l13.228">   nsCAutoString urlSpec;</span>
<a href="#l13.229"></a><span id="l13.229"> </span>
<a href="#l13.230"></a><span id="l13.230">   char hierarchyDelimiter = GetHierarchyDelimiter(imapMailFolder);</span>
<a href="#l13.231"></a><span id="l13.231">   nsresult rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl),</span>
<a href="#l13.232"></a><span id="l13.232">                                      imapMailFolder, urlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l13.233"></a><span id="l13.233" class="difflineat">@@ -1539,18 +1524,17 @@ nsresult nsImapService::FolderCommand(ns</span>
<a href="#l13.234"></a><span id="l13.234">       urlSpec.Append(aCommand);</span>
<a href="#l13.235"></a><span id="l13.235">       urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l13.236"></a><span id="l13.236"> </span>
<a href="#l13.237"></a><span id="l13.237">       nsCString folderName;</span>
<a href="#l13.238"></a><span id="l13.238">       GetFolderName(imapMailFolder, folderName);</span>
<a href="#l13.239"></a><span id="l13.239">       urlSpec.Append(folderName);</span>
<a href="#l13.240"></a><span id="l13.240">       rv = uri-&gt;SetSpec(urlSpec);</span>
<a href="#l13.241"></a><span id="l13.241">       if (NS_SUCCEEDED(rv))</span>
<a href="#l13.242"></a><span id="l13.242" class="difflineminus">-        rv = GetImapConnectionAndLoadUrl(aClientEventTarget, imapUrl,</span>
<a href="#l13.243"></a><span id="l13.243" class="difflineminus">-                                         nsnull, url);</span>
<a href="#l13.244"></a><span id="l13.244" class="difflineplus">+        rv = GetImapConnectionAndLoadUrl(imapUrl, nsnull, url);</span>
<a href="#l13.245"></a><span id="l13.245">     }</span>
<a href="#l13.246"></a><span id="l13.246">   }</span>
<a href="#l13.247"></a><span id="l13.247">   return rv;</span>
<a href="#l13.248"></a><span id="l13.248"> }</span>
<a href="#l13.249"></a><span id="l13.249"> </span>
<a href="#l13.250"></a><span id="l13.250"> NS_IMETHODIMP</span>
<a href="#l13.251"></a><span id="l13.251"> nsImapService::VerifyLogon(nsIMsgFolder *aFolder, nsIUrlListener *aUrlListener,</span>
<a href="#l13.252"></a><span id="l13.252">                            nsIMsgWindow *aMsgWindow, nsIURI **aURL)</span>
<a href="#l13.253"></a><span id="l13.253" class="difflineat">@@ -1566,74 +1550,64 @@ nsImapService::VerifyLogon(nsIMsgFolder </span>
<a href="#l13.254"></a><span id="l13.254">     nsCOMPtr&lt;nsIURI&gt; uri = do_QueryInterface(imapUrl);</span>
<a href="#l13.255"></a><span id="l13.255"> </span>
<a href="#l13.256"></a><span id="l13.256">     nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailNewsUrl = do_QueryInterface(imapUrl);</span>
<a href="#l13.257"></a><span id="l13.257">     mailNewsUrl-&gt;SetSuppressErrorMsgs(true);</span>
<a href="#l13.258"></a><span id="l13.258">     mailNewsUrl-&gt;SetMsgWindow(aMsgWindow);</span>
<a href="#l13.259"></a><span id="l13.259">     rv = SetImapUrlSink(aFolder, imapUrl);</span>
<a href="#l13.260"></a><span id="l13.260">     urlSpec.Append(&quot;/verifyLogon&quot;);</span>
<a href="#l13.261"></a><span id="l13.261">     rv = uri-&gt;SetSpec(urlSpec);</span>
<a href="#l13.262"></a><span id="l13.262" class="difflineminus">-    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l13.263"></a><span id="l13.263" class="difflineminus">-      nsCOMPtr&lt;nsIThread&gt; thread(do_GetCurrentThread());</span>
<a href="#l13.264"></a><span id="l13.264" class="difflineminus">-      rv = GetImapConnectionAndLoadUrl(thread, imapUrl, nsnull, nsnull);</span>
<a href="#l13.265"></a><span id="l13.265" class="difflineminus">-    }</span>
<a href="#l13.266"></a><span id="l13.266" class="difflineplus">+    if (NS_SUCCEEDED(rv))</span>
<a href="#l13.267"></a><span id="l13.267" class="difflineplus">+      rv = GetImapConnectionAndLoadUrl(imapUrl, nsnull, nsnull);</span>
<a href="#l13.268"></a><span id="l13.268">     if (aURL)</span>
<a href="#l13.269"></a><span id="l13.269">       uri.forget(aURL);</span>
<a href="#l13.270"></a><span id="l13.270">   }</span>
<a href="#l13.271"></a><span id="l13.271">   return rv;</span>
<a href="#l13.272"></a><span id="l13.272"> }</span>
<a href="#l13.273"></a><span id="l13.273"> </span>
<a href="#l13.274"></a><span id="l13.274"> // Noop, used to update a folder (causes server to send changes).</span>
<a href="#l13.275"></a><span id="l13.275" class="difflineminus">-NS_IMETHODIMP nsImapService::Noop(nsIEventTarget *aClientEventTarget, </span>
<a href="#l13.276"></a><span id="l13.276" class="difflineminus">-                                  nsIMsgFolder *aImapMailFolder,</span>
<a href="#l13.277"></a><span id="l13.277" class="difflineplus">+NS_IMETHODIMP nsImapService::Noop(nsIMsgFolder *aImapMailFolder,</span>
<a href="#l13.278"></a><span id="l13.278">                                   nsIUrlListener *aUrlListener, </span>
<a href="#l13.279"></a><span id="l13.279">                                   nsIURI **aURL)</span>
<a href="#l13.280"></a><span id="l13.280"> {</span>
<a href="#l13.281"></a><span id="l13.281" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l13.282"></a><span id="l13.282">   NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l13.283"></a><span id="l13.283"> </span>
<a href="#l13.284"></a><span id="l13.284" class="difflineminus">-  return FolderCommand(aClientEventTarget, aImapMailFolder, aUrlListener,</span>
<a href="#l13.285"></a><span id="l13.285" class="difflineplus">+  return FolderCommand(aImapMailFolder, aUrlListener,</span>
<a href="#l13.286"></a><span id="l13.286">                        &quot;/selectnoop&gt;&quot;, nsIImapUrl::nsImapSelectNoopFolder, nsnull, aURL);</span>
<a href="#l13.287"></a><span id="l13.287"> }</span>
<a href="#l13.288"></a><span id="l13.288">     </span>
<a href="#l13.289"></a><span id="l13.289"> // FolderStatus, used to update message counts</span>
<a href="#l13.290"></a><span id="l13.290" class="difflineminus">-NS_IMETHODIMP nsImapService::UpdateFolderStatus(nsIEventTarget *aClientEventTarget, </span>
<a href="#l13.291"></a><span id="l13.291" class="difflineminus">-                                                nsIMsgFolder *aImapMailFolder,</span>
<a href="#l13.292"></a><span id="l13.292" class="difflineplus">+NS_IMETHODIMP nsImapService::UpdateFolderStatus(nsIMsgFolder *aImapMailFolder,</span>
<a href="#l13.293"></a><span id="l13.293">                                                 nsIUrlListener *aUrlListener, </span>
<a href="#l13.294"></a><span id="l13.294">                                                 nsIURI **aURL)</span>
<a href="#l13.295"></a><span id="l13.295"> {</span>
<a href="#l13.296"></a><span id="l13.296" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l13.297"></a><span id="l13.297">   NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l13.298"></a><span id="l13.298"> </span>
<a href="#l13.299"></a><span id="l13.299" class="difflineminus">-  return FolderCommand(aClientEventTarget, aImapMailFolder, aUrlListener,</span>
<a href="#l13.300"></a><span id="l13.300" class="difflineplus">+  return FolderCommand(aImapMailFolder, aUrlListener,</span>
<a href="#l13.301"></a><span id="l13.301">                        &quot;/folderstatus&gt;&quot;, nsIImapUrl::nsImapFolderStatus, nsnull, aURL);</span>
<a href="#l13.302"></a><span id="l13.302"> }</span>
<a href="#l13.303"></a><span id="l13.303"> </span>
<a href="#l13.304"></a><span id="l13.304"> // Expunge, used to &quot;compress&quot; an imap folder,removes deleted messages.</span>
<a href="#l13.305"></a><span id="l13.305" class="difflineminus">-NS_IMETHODIMP nsImapService::Expunge(nsIEventTarget *aClientEventTarget,</span>
<a href="#l13.306"></a><span id="l13.306" class="difflineminus">-                                     nsIMsgFolder *aImapMailFolder,</span>
<a href="#l13.307"></a><span id="l13.307" class="difflineplus">+NS_IMETHODIMP nsImapService::Expunge(nsIMsgFolder *aImapMailFolder,</span>
<a href="#l13.308"></a><span id="l13.308">                                      nsIUrlListener *aUrlListener,</span>
<a href="#l13.309"></a><span id="l13.309">                                      nsIMsgWindow *aMsgWindow,</span>
<a href="#l13.310"></a><span id="l13.310">                                      nsIURI **aURL)</span>
<a href="#l13.311"></a><span id="l13.311"> {</span>
<a href="#l13.312"></a><span id="l13.312" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l13.313"></a><span id="l13.313">   NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l13.314"></a><span id="l13.314"> </span>
<a href="#l13.315"></a><span id="l13.315" class="difflineminus">-  return FolderCommand(aClientEventTarget, aImapMailFolder, aUrlListener,</span>
<a href="#l13.316"></a><span id="l13.316" class="difflineplus">+  return FolderCommand(aImapMailFolder, aUrlListener,</span>
<a href="#l13.317"></a><span id="l13.317">                        &quot;/Expunge&gt;&quot;, nsIImapUrl::nsImapExpungeFolder, aMsgWindow, aURL);</span>
<a href="#l13.318"></a><span id="l13.318"> }</span>
<a href="#l13.319"></a><span id="l13.319"> </span>
<a href="#l13.320"></a><span id="l13.320"> /* old-stle biff that doesn't download headers */</span>
<a href="#l13.321"></a><span id="l13.321" class="difflineminus">-NS_IMETHODIMP nsImapService::Biff(nsIEventTarget *aClientEventTarget, </span>
<a href="#l13.322"></a><span id="l13.322" class="difflineminus">-                                  nsIMsgFolder *aImapMailFolder,</span>
<a href="#l13.323"></a><span id="l13.323" class="difflineplus">+NS_IMETHODIMP nsImapService::Biff(nsIMsgFolder *aImapMailFolder,</span>
<a href="#l13.324"></a><span id="l13.324">                                   nsIUrlListener *aUrlListener, </span>
<a href="#l13.325"></a><span id="l13.325">                                   nsIURI **aURL,</span>
<a href="#l13.326"></a><span id="l13.326">                                   PRUint32 uidHighWater)</span>
<a href="#l13.327"></a><span id="l13.327"> {</span>
<a href="#l13.328"></a><span id="l13.328" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l13.329"></a><span id="l13.329">   NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l13.330"></a><span id="l13.330"> </span>
<a href="#l13.331"></a><span id="l13.331">   // static const char *formatString = &quot;biff&gt;%c%s&gt;%ld&quot;;</span>
<a href="#l13.332"></a><span id="l13.332">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l13.333"></a><span id="l13.333">   nsCAutoString urlSpec;</span>
<a href="#l13.334"></a><span id="l13.334"> </span>
<a href="#l13.335"></a><span id="l13.335">   char hierarchyDelimiter = GetHierarchyDelimiter(aImapMailFolder);</span>
<a href="#l13.336"></a><span id="l13.336">   nsresult rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl),</span>
<a href="#l13.337"></a><span id="l13.337" class="difflineat">@@ -1651,55 +1625,51 @@ NS_IMETHODIMP nsImapService::Biff(nsIEve</span>
<a href="#l13.338"></a><span id="l13.338"> </span>
<a href="#l13.339"></a><span id="l13.339">       nsCString folderName;</span>
<a href="#l13.340"></a><span id="l13.340">       GetFolderName(aImapMailFolder, folderName);</span>
<a href="#l13.341"></a><span id="l13.341">       urlSpec.Append(folderName);</span>
<a href="#l13.342"></a><span id="l13.342">       urlSpec.Append(&quot;&gt;&quot;);</span>
<a href="#l13.343"></a><span id="l13.343">       urlSpec.AppendInt(uidHighWater);</span>
<a href="#l13.344"></a><span id="l13.344">       rv = uri-&gt;SetSpec(urlSpec);</span>
<a href="#l13.345"></a><span id="l13.345">       if (NS_SUCCEEDED(rv))</span>
<a href="#l13.346"></a><span id="l13.346" class="difflineminus">-        rv = GetImapConnectionAndLoadUrl(aClientEventTarget, imapUrl, nsnull, aURL);</span>
<a href="#l13.347"></a><span id="l13.347" class="difflineplus">+        rv = GetImapConnectionAndLoadUrl(imapUrl, nsnull, aURL);</span>
<a href="#l13.348"></a><span id="l13.348">     }</span>
<a href="#l13.349"></a><span id="l13.349">   }</span>
<a href="#l13.350"></a><span id="l13.350">   return rv;</span>
<a href="#l13.351"></a><span id="l13.351"> }</span>
<a href="#l13.352"></a><span id="l13.352"> </span>
<a href="#l13.353"></a><span id="l13.353" class="difflineminus">-NS_IMETHODIMP nsImapService::DeleteFolder(nsIEventTarget *aClientEventTarget,</span>
<a href="#l13.354"></a><span id="l13.354" class="difflineminus">-                                          nsIMsgFolder *aImapMailFolder,</span>
<a href="#l13.355"></a><span id="l13.355" class="difflineplus">+NS_IMETHODIMP nsImapService::DeleteFolder(nsIMsgFolder *aImapMailFolder,</span>
<a href="#l13.356"></a><span id="l13.356">                                           nsIUrlListener *aUrlListener,</span>
<a href="#l13.357"></a><span id="l13.357">                                           nsIMsgWindow *aMsgWindow,</span>
<a href="#l13.358"></a><span id="l13.358">                                           nsIURI **aURL)</span>
<a href="#l13.359"></a><span id="l13.359"> {</span>
<a href="#l13.360"></a><span id="l13.360" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l13.361"></a><span id="l13.361">   NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l13.362"></a><span id="l13.362"> </span>
<a href="#l13.363"></a><span id="l13.363">   // If it's an aol server then use 'deletefolder' url to </span>
<a href="#l13.364"></a><span id="l13.364">   // remove all msgs first and then remove the folder itself.</span>
<a href="#l13.365"></a><span id="l13.365">   bool removeFolderAndMsgs = false;</span>
<a href="#l13.366"></a><span id="l13.366">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l13.367"></a><span id="l13.367">   if (NS_SUCCEEDED(aImapMailFolder-&gt;GetServer(getter_AddRefs(server))) &amp;&amp; server)</span>
<a href="#l13.368"></a><span id="l13.368">   {</span>
<a href="#l13.369"></a><span id="l13.369">     nsCOMPtr &lt;nsIImapIncomingServer&gt; imapServer = do_QueryInterface(server);</span>
<a href="#l13.370"></a><span id="l13.370">     if (imapServer) </span>
<a href="#l13.371"></a><span id="l13.371">       imapServer-&gt;GetIsAOLServer(&amp;removeFolderAndMsgs);</span>
<a href="#l13.372"></a><span id="l13.372">   }</span>
<a href="#l13.373"></a><span id="l13.373">   </span>
<a href="#l13.374"></a><span id="l13.374" class="difflineminus">-  return FolderCommand(aClientEventTarget, aImapMailFolder, aUrlListener,</span>
<a href="#l13.375"></a><span id="l13.375" class="difflineplus">+  return FolderCommand(aImapMailFolder, aUrlListener,</span>
<a href="#l13.376"></a><span id="l13.376">                        removeFolderAndMsgs ? &quot;/deletefolder&gt;&quot; : &quot;/delete&gt;&quot;, </span>
<a href="#l13.377"></a><span id="l13.377">                        nsIImapUrl::nsImapDeleteFolder, aMsgWindow, aURL);</span>
<a href="#l13.378"></a><span id="l13.378"> }</span>
<a href="#l13.379"></a><span id="l13.379"> </span>
<a href="#l13.380"></a><span id="l13.380" class="difflineminus">-NS_IMETHODIMP nsImapService::DeleteMessages(nsIEventTarget *aClientEventTarget, </span>
<a href="#l13.381"></a><span id="l13.381" class="difflineminus">-                                            nsIMsgFolder *aImapMailFolder, </span>
<a href="#l13.382"></a><span id="l13.382" class="difflineplus">+NS_IMETHODIMP nsImapService::DeleteMessages(nsIMsgFolder *aImapMailFolder, </span>
<a href="#l13.383"></a><span id="l13.383">                                             nsIUrlListener *aUrlListener, </span>
<a href="#l13.384"></a><span id="l13.384">                                             nsIURI **aURL,</span>
<a href="#l13.385"></a><span id="l13.385">                                             const nsACString &amp;messageIdentifierList,</span>
<a href="#l13.386"></a><span id="l13.386">                                             bool messageIdsAreUID)</span>
<a href="#l13.387"></a><span id="l13.387"> {</span>
<a href="#l13.388"></a><span id="l13.388" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l13.389"></a><span id="l13.389">   NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l13.390"></a><span id="l13.390"> </span>
<a href="#l13.391"></a><span id="l13.391">   // create a protocol instance to handle the request.</span>
<a href="#l13.392"></a><span id="l13.392">   // NOTE: once we start working with multiple connections, this step will be much more complicated...but for now</span>
<a href="#l13.393"></a><span id="l13.393">   // just create a connection and process the request.</span>
<a href="#l13.394"></a><span id="l13.394">   nsresult rv;</span>
<a href="#l13.395"></a><span id="l13.395">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l13.396"></a><span id="l13.396">   nsCAutoString urlSpec;</span>
<a href="#l13.397"></a><span id="l13.397" class="difflineat">@@ -1723,90 +1693,80 @@ NS_IMETHODIMP nsImapService::DeleteMessa</span>
<a href="#l13.398"></a><span id="l13.398"> </span>
<a href="#l13.399"></a><span id="l13.399">       nsCString folderName;</span>
<a href="#l13.400"></a><span id="l13.400">       GetFolderName(aImapMailFolder, folderName);</span>
<a href="#l13.401"></a><span id="l13.401">       urlSpec.Append(folderName);</span>
<a href="#l13.402"></a><span id="l13.402">       urlSpec.Append(&quot;&gt;&quot;);</span>
<a href="#l13.403"></a><span id="l13.403">       urlSpec.Append(messageIdentifierList);</span>
<a href="#l13.404"></a><span id="l13.404">       rv = uri-&gt;SetSpec(urlSpec);</span>
<a href="#l13.405"></a><span id="l13.405">       if (NS_SUCCEEDED(rv))</span>
<a href="#l13.406"></a><span id="l13.406" class="difflineminus">-        rv = GetImapConnectionAndLoadUrl(aClientEventTarget, imapUrl, nsnull, aURL);</span>
<a href="#l13.407"></a><span id="l13.407" class="difflineplus">+        rv = GetImapConnectionAndLoadUrl(imapUrl, nsnull, aURL);</span>
<a href="#l13.408"></a><span id="l13.408">     }</span>
<a href="#l13.409"></a><span id="l13.409">   }</span>
<a href="#l13.410"></a><span id="l13.410">   return rv;</span>
<a href="#l13.411"></a><span id="l13.411"> }</span>
<a href="#l13.412"></a><span id="l13.412"> </span>
<a href="#l13.413"></a><span id="l13.413"> // Delete all messages in a folder, used to empty trash</span>
<a href="#l13.414"></a><span id="l13.414" class="difflineminus">-NS_IMETHODIMP nsImapService::DeleteAllMessages(nsIEventTarget *aClientEventTarget, </span>
<a href="#l13.415"></a><span id="l13.415" class="difflineminus">-                                               nsIMsgFolder *aImapMailFolder,</span>
<a href="#l13.416"></a><span id="l13.416" class="difflineplus">+NS_IMETHODIMP nsImapService::DeleteAllMessages(nsIMsgFolder *aImapMailFolder,</span>
<a href="#l13.417"></a><span id="l13.417">                                                nsIUrlListener *aUrlListener, </span>
<a href="#l13.418"></a><span id="l13.418">                                                nsIURI **aURL)</span>
<a href="#l13.419"></a><span id="l13.419"> {</span>
<a href="#l13.420"></a><span id="l13.420" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l13.421"></a><span id="l13.421">   NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l13.422"></a><span id="l13.422"> </span>
<a href="#l13.423"></a><span id="l13.423" class="difflineminus">-  return FolderCommand(aClientEventTarget, aImapMailFolder, aUrlListener,</span>
<a href="#l13.424"></a><span id="l13.424" class="difflineplus">+  return FolderCommand(aImapMailFolder, aUrlListener,</span>
<a href="#l13.425"></a><span id="l13.425">                       &quot;/deleteallmsgs&gt;&quot;, nsIImapUrl::nsImapSelectNoopFolder, nsnull, aURL);</span>
<a href="#l13.426"></a><span id="l13.426"> }</span>
<a href="#l13.427"></a><span id="l13.427"> </span>
<a href="#l13.428"></a><span id="l13.428" class="difflineminus">-NS_IMETHODIMP nsImapService::AddMessageFlags(nsIEventTarget *aClientEventTarget,</span>
<a href="#l13.429"></a><span id="l13.429" class="difflineminus">-                                             nsIMsgFolder *aImapMailFolder, </span>
<a href="#l13.430"></a><span id="l13.430" class="difflineminus">-                                             nsIUrlListener *aUrlListener, </span>
<a href="#l13.431"></a><span id="l13.431" class="difflineplus">+NS_IMETHODIMP nsImapService::AddMessageFlags(nsIMsgFolder *aImapMailFolder,</span>
<a href="#l13.432"></a><span id="l13.432" class="difflineplus">+                                             nsIUrlListener *aUrlListener,</span>
<a href="#l13.433"></a><span id="l13.433">                                              nsIURI **aURL,</span>
<a href="#l13.434"></a><span id="l13.434">                                              const nsACString &amp;messageIdentifierList,</span>
<a href="#l13.435"></a><span id="l13.435">                                              imapMessageFlagsType flags,</span>
<a href="#l13.436"></a><span id="l13.436">                                              bool messageIdsAreUID)</span>
<a href="#l13.437"></a><span id="l13.437"> {</span>
<a href="#l13.438"></a><span id="l13.438" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l13.439"></a><span id="l13.439">   NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l13.440"></a><span id="l13.440"> </span>
<a href="#l13.441"></a><span id="l13.441" class="difflineminus">-  return DiddleFlags(aClientEventTarget, aImapMailFolder, aUrlListener, aURL, messageIdentifierList,</span>
<a href="#l13.442"></a><span id="l13.442" class="difflineplus">+  return DiddleFlags(aImapMailFolder, aUrlListener, aURL, messageIdentifierList,</span>
<a href="#l13.443"></a><span id="l13.443">                      &quot;addmsgflags&quot;, flags, messageIdsAreUID);</span>
<a href="#l13.444"></a><span id="l13.444"> }</span>
<a href="#l13.445"></a><span id="l13.445"> </span>
<a href="#l13.446"></a><span id="l13.446" class="difflineminus">-NS_IMETHODIMP nsImapService::SubtractMessageFlags(nsIEventTarget *aClientEventTarget,</span>
<a href="#l13.447"></a><span id="l13.447" class="difflineminus">-                                                  nsIMsgFolder *aImapMailFolder, </span>
<a href="#l13.448"></a><span id="l13.448" class="difflineminus">-                                                  nsIUrlListener *aUrlListener, </span>
<a href="#l13.449"></a><span id="l13.449" class="difflineplus">+NS_IMETHODIMP nsImapService::SubtractMessageFlags(nsIMsgFolder *aImapMailFolder,</span>
<a href="#l13.450"></a><span id="l13.450" class="difflineplus">+                                                  nsIUrlListener *aUrlListener,</span>
<a href="#l13.451"></a><span id="l13.451">                                                   nsIURI **aURL,</span>
<a href="#l13.452"></a><span id="l13.452">                                                   const nsACString &amp;messageIdentifierList,</span>
<a href="#l13.453"></a><span id="l13.453">                                                   imapMessageFlagsType flags,</span>
<a href="#l13.454"></a><span id="l13.454">                                                   bool messageIdsAreUID)</span>
<a href="#l13.455"></a><span id="l13.455"> {</span>
<a href="#l13.456"></a><span id="l13.456" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l13.457"></a><span id="l13.457">   NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l13.458"></a><span id="l13.458"> </span>
<a href="#l13.459"></a><span id="l13.459" class="difflineminus">-  return DiddleFlags(aClientEventTarget, aImapMailFolder, aUrlListener, aURL, messageIdentifierList,</span>
<a href="#l13.460"></a><span id="l13.460" class="difflineplus">+  return DiddleFlags(aImapMailFolder, aUrlListener, aURL, messageIdentifierList,</span>
<a href="#l13.461"></a><span id="l13.461">                      &quot;subtractmsgflags&quot;, flags, messageIdsAreUID);</span>
<a href="#l13.462"></a><span id="l13.462"> }</span>
<a href="#l13.463"></a><span id="l13.463"> </span>
<a href="#l13.464"></a><span id="l13.464" class="difflineminus">-NS_IMETHODIMP nsImapService::SetMessageFlags(nsIEventTarget *aClientEventTarget,</span>
<a href="#l13.465"></a><span id="l13.465" class="difflineminus">-                                             nsIMsgFolder *aImapMailFolder, </span>
<a href="#l13.466"></a><span id="l13.466" class="difflineminus">-                                             nsIUrlListener *aUrlListener, </span>
<a href="#l13.467"></a><span id="l13.467" class="difflineplus">+NS_IMETHODIMP nsImapService::SetMessageFlags(nsIMsgFolder *aImapMailFolder,</span>
<a href="#l13.468"></a><span id="l13.468" class="difflineplus">+                                             nsIUrlListener *aUrlListener,</span>
<a href="#l13.469"></a><span id="l13.469">                                              nsIURI **aURL,</span>
<a href="#l13.470"></a><span id="l13.470">                                              const nsACString &amp;messageIdentifierList,</span>
<a href="#l13.471"></a><span id="l13.471">                                              imapMessageFlagsType flags,</span>
<a href="#l13.472"></a><span id="l13.472">                                              bool messageIdsAreUID)</span>
<a href="#l13.473"></a><span id="l13.473"> {</span>
<a href="#l13.474"></a><span id="l13.474" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l13.475"></a><span id="l13.475">   NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l13.476"></a><span id="l13.476"> </span>
<a href="#l13.477"></a><span id="l13.477" class="difflineminus">-  return DiddleFlags(aClientEventTarget, aImapMailFolder, aUrlListener, aURL, messageIdentifierList,</span>
<a href="#l13.478"></a><span id="l13.478" class="difflineplus">+  return DiddleFlags(aImapMailFolder, aUrlListener, aURL, messageIdentifierList,</span>
<a href="#l13.479"></a><span id="l13.479">                      &quot;setmsgflags&quot;, flags, messageIdsAreUID);</span>
<a href="#l13.480"></a><span id="l13.480"> }</span>
<a href="#l13.481"></a><span id="l13.481"> </span>
<a href="#l13.482"></a><span id="l13.482" class="difflineminus">-nsresult nsImapService::DiddleFlags(nsIEventTarget *aClientEventTarget, </span>
<a href="#l13.483"></a><span id="l13.483" class="difflineminus">-                                    nsIMsgFolder *aImapMailFolder, </span>
<a href="#l13.484"></a><span id="l13.484" class="difflineplus">+nsresult nsImapService::DiddleFlags(nsIMsgFolder *aImapMailFolder,</span>
<a href="#l13.485"></a><span id="l13.485">                                     nsIUrlListener *aUrlListener,</span>
<a href="#l13.486"></a><span id="l13.486">                                     nsIURI **aURL,</span>
<a href="#l13.487"></a><span id="l13.487">                                     const nsACString &amp;messageIdentifierList,</span>
<a href="#l13.488"></a><span id="l13.488">                                     const char *howToDiddle,</span>
<a href="#l13.489"></a><span id="l13.489">                                     imapMessageFlagsType flags,</span>
<a href="#l13.490"></a><span id="l13.490">                                     bool messageIdsAreUID)</span>
<a href="#l13.491"></a><span id="l13.491"> {</span>
<a href="#l13.492"></a><span id="l13.492" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l13.493"></a><span id="l13.493">   NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l13.494"></a><span id="l13.494"> </span>
<a href="#l13.495"></a><span id="l13.495">   // create a protocol instance to handle the request.</span>
<a href="#l13.496"></a><span id="l13.496">   // NOTE: once we start working with multiple connections, </span>
<a href="#l13.497"></a><span id="l13.497">   //       this step will be much more complicated...but for now</span>
<a href="#l13.498"></a><span id="l13.498">   // just create a connection and process the request.</span>
<a href="#l13.499"></a><span id="l13.499">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l13.500"></a><span id="l13.500">   nsCAutoString urlSpec;</span>
<a href="#l13.501"></a><span id="l13.501" class="difflineat">@@ -1833,17 +1793,17 @@ nsresult nsImapService::DiddleFlags(nsIE</span>
<a href="#l13.502"></a><span id="l13.502">       GetFolderName(aImapMailFolder, folderName);</span>
<a href="#l13.503"></a><span id="l13.503">       urlSpec.Append(folderName);</span>
<a href="#l13.504"></a><span id="l13.504">       urlSpec.Append(&quot;&gt;&quot;);</span>
<a href="#l13.505"></a><span id="l13.505">       urlSpec.Append(messageIdentifierList);</span>
<a href="#l13.506"></a><span id="l13.506">       urlSpec.Append('&gt;');</span>
<a href="#l13.507"></a><span id="l13.507">       urlSpec.AppendInt(flags);</span>
<a href="#l13.508"></a><span id="l13.508">       rv = uri-&gt;SetSpec(urlSpec);</span>
<a href="#l13.509"></a><span id="l13.509">       if (NS_SUCCEEDED(rv))</span>
<a href="#l13.510"></a><span id="l13.510" class="difflineminus">-        rv = GetImapConnectionAndLoadUrl(aClientEventTarget, imapUrl, nsnull, aURL);</span>
<a href="#l13.511"></a><span id="l13.511" class="difflineplus">+        rv = GetImapConnectionAndLoadUrl(imapUrl, nsnull, aURL);</span>
<a href="#l13.512"></a><span id="l13.512">     }</span>
<a href="#l13.513"></a><span id="l13.513">   }</span>
<a href="#l13.514"></a><span id="l13.514">   return rv;</span>
<a href="#l13.515"></a><span id="l13.515"> }</span>
<a href="#l13.516"></a><span id="l13.516"> </span>
<a href="#l13.517"></a><span id="l13.517"> nsresult nsImapService::SetImapUrlSink(nsIMsgFolder *aMsgFolder, nsIImapUrl *aImapUrl)</span>
<a href="#l13.518"></a><span id="l13.518"> {</span>
<a href="#l13.519"></a><span id="l13.519">   NS_ENSURE_ARG_POINTER(aMsgFolder);</span>
<a href="#l13.520"></a><span id="l13.520" class="difflineat">@@ -1870,23 +1830,21 @@ nsresult nsImapService::SetImapUrlSink(n</span>
<a href="#l13.521"></a><span id="l13.521">     aImapUrl-&gt;SetImapMessageSink(imapMessageSink);</span>
<a href="#l13.522"></a><span id="l13.522">   </span>
<a href="#l13.523"></a><span id="l13.523">   nsCOMPtr &lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(aImapUrl);</span>
<a href="#l13.524"></a><span id="l13.524">   mailnewsUrl-&gt;SetFolder(aMsgFolder);</span>
<a href="#l13.525"></a><span id="l13.525"> </span>
<a href="#l13.526"></a><span id="l13.526">   return NS_OK;</span>
<a href="#l13.527"></a><span id="l13.527"> }</span>
<a href="#l13.528"></a><span id="l13.528"> </span>
<a href="#l13.529"></a><span id="l13.529" class="difflineminus">-NS_IMETHODIMP nsImapService::DiscoverAllFolders(nsIEventTarget *aClientEventTarget,</span>
<a href="#l13.530"></a><span id="l13.530" class="difflineminus">-                                                nsIMsgFolder *aImapMailFolder,</span>
<a href="#l13.531"></a><span id="l13.531" class="difflineplus">+NS_IMETHODIMP nsImapService::DiscoverAllFolders(nsIMsgFolder *aImapMailFolder,</span>
<a href="#l13.532"></a><span id="l13.532">                                                 nsIUrlListener *aUrlListener,</span>
<a href="#l13.533"></a><span id="l13.533">                                                 nsIMsgWindow *aMsgWindow,</span>
<a href="#l13.534"></a><span id="l13.534">                                                 nsIURI **aURL)</span>
<a href="#l13.535"></a><span id="l13.535"> {</span>
<a href="#l13.536"></a><span id="l13.536" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l13.537"></a><span id="l13.537">   NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l13.538"></a><span id="l13.538"> </span>
<a href="#l13.539"></a><span id="l13.539">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l13.540"></a><span id="l13.540">   nsCAutoString urlSpec;</span>
<a href="#l13.541"></a><span id="l13.541"> </span>
<a href="#l13.542"></a><span id="l13.542">   char hierarchyDelimiter = GetHierarchyDelimiter(aImapMailFolder);</span>
<a href="#l13.543"></a><span id="l13.543">   nsresult rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), aImapMailFolder, </span>
<a href="#l13.544"></a><span id="l13.544">                                      aUrlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l13.545"></a><span id="l13.545" class="difflineat">@@ -1899,28 +1857,26 @@ NS_IMETHODIMP nsImapService::DiscoverAll</span>
<a href="#l13.546"></a><span id="l13.546">       nsCOMPtr&lt;nsIURI&gt; uri = do_QueryInterface(imapUrl);</span>
<a href="#l13.547"></a><span id="l13.547">       nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(imapUrl);</span>
<a href="#l13.548"></a><span id="l13.548">       if (mailnewsurl)</span>
<a href="#l13.549"></a><span id="l13.549">         mailnewsurl-&gt;SetMsgWindow(aMsgWindow);</span>
<a href="#l13.550"></a><span id="l13.550">       urlSpec.Append(&quot;/discoverallboxes&quot;);</span>
<a href="#l13.551"></a><span id="l13.551">       nsCOMPtr &lt;nsIURI&gt; url = do_QueryInterface(imapUrl, &amp;rv);</span>
<a href="#l13.552"></a><span id="l13.552">       rv = uri-&gt;SetSpec(urlSpec);</span>
<a href="#l13.553"></a><span id="l13.553">       if (NS_SUCCEEDED(rv))</span>
<a href="#l13.554"></a><span id="l13.554" class="difflineminus">-        rv = GetImapConnectionAndLoadUrl(aClientEventTarget, imapUrl, nsnull, aURL);</span>
<a href="#l13.555"></a><span id="l13.555" class="difflineplus">+        rv = GetImapConnectionAndLoadUrl(imapUrl, nsnull, aURL);</span>
<a href="#l13.556"></a><span id="l13.556">     }</span>
<a href="#l13.557"></a><span id="l13.557">   }</span>
<a href="#l13.558"></a><span id="l13.558">   return rv;</span>
<a href="#l13.559"></a><span id="l13.559"> }</span>
<a href="#l13.560"></a><span id="l13.560"> </span>
<a href="#l13.561"></a><span id="l13.561" class="difflineminus">-NS_IMETHODIMP nsImapService::DiscoverAllAndSubscribedFolders(nsIEventTarget *aClientEventTarget,</span>
<a href="#l13.562"></a><span id="l13.562" class="difflineminus">-                                                             nsIMsgFolder *aImapMailFolder,</span>
<a href="#l13.563"></a><span id="l13.563" class="difflineplus">+NS_IMETHODIMP nsImapService::DiscoverAllAndSubscribedFolders(nsIMsgFolder *aImapMailFolder,</span>
<a href="#l13.564"></a><span id="l13.564">                                                              nsIUrlListener *aUrlListener,</span>
<a href="#l13.565"></a><span id="l13.565">                                                              nsIURI **aURL)</span>
<a href="#l13.566"></a><span id="l13.566"> {</span>
<a href="#l13.567"></a><span id="l13.567" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l13.568"></a><span id="l13.568">   NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l13.569"></a><span id="l13.569"> </span>
<a href="#l13.570"></a><span id="l13.570">   nsCOMPtr&lt;nsIImapUrl&gt; aImapUrl;</span>
<a href="#l13.571"></a><span id="l13.571">   nsCAutoString urlSpec;</span>
<a href="#l13.572"></a><span id="l13.572"> </span>
<a href="#l13.573"></a><span id="l13.573">   char hierarchyDelimiter = GetHierarchyDelimiter(aImapMailFolder);</span>
<a href="#l13.574"></a><span id="l13.574">   nsresult rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(aImapUrl), aImapMailFolder,</span>
<a href="#l13.575"></a><span id="l13.575">                                      aUrlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l13.576"></a><span id="l13.576" class="difflineat">@@ -1928,29 +1884,27 @@ NS_IMETHODIMP nsImapService::DiscoverAll</span>
<a href="#l13.577"></a><span id="l13.577">   {</span>
<a href="#l13.578"></a><span id="l13.578">     rv = SetImapUrlSink(aImapMailFolder, aImapUrl);</span>
<a href="#l13.579"></a><span id="l13.579">     if (NS_SUCCEEDED(rv))</span>
<a href="#l13.580"></a><span id="l13.580">     {</span>
<a href="#l13.581"></a><span id="l13.581">       nsCOMPtr&lt;nsIURI&gt; uri = do_QueryInterface(aImapUrl);</span>
<a href="#l13.582"></a><span id="l13.582">       urlSpec.Append(&quot;/discoverallandsubscribedboxes&quot;);</span>
<a href="#l13.583"></a><span id="l13.583">       rv = uri-&gt;SetSpec(urlSpec);</span>
<a href="#l13.584"></a><span id="l13.584">       if (NS_SUCCEEDED(rv))</span>
<a href="#l13.585"></a><span id="l13.585" class="difflineminus">-        rv = GetImapConnectionAndLoadUrl(aClientEventTarget, aImapUrl, nsnull, aURL);</span>
<a href="#l13.586"></a><span id="l13.586" class="difflineplus">+        rv = GetImapConnectionAndLoadUrl(aImapUrl, nsnull, aURL);</span>
<a href="#l13.587"></a><span id="l13.587">     }</span>
<a href="#l13.588"></a><span id="l13.588">   }</span>
<a href="#l13.589"></a><span id="l13.589">   return rv;</span>
<a href="#l13.590"></a><span id="l13.590"> }</span>
<a href="#l13.591"></a><span id="l13.591"> </span>
<a href="#l13.592"></a><span id="l13.592" class="difflineminus">-NS_IMETHODIMP nsImapService::DiscoverChildren(nsIEventTarget *aClientEventTarget,</span>
<a href="#l13.593"></a><span id="l13.593" class="difflineminus">-                                              nsIMsgFolder *aImapMailFolder,</span>
<a href="#l13.594"></a><span id="l13.594" class="difflineplus">+NS_IMETHODIMP nsImapService::DiscoverChildren(nsIMsgFolder *aImapMailFolder,</span>
<a href="#l13.595"></a><span id="l13.595">                                               nsIUrlListener *aUrlListener,</span>
<a href="#l13.596"></a><span id="l13.596">                                               const nsACString &amp;folderPath,</span>
<a href="#l13.597"></a><span id="l13.597">                                               nsIURI **aURL)</span>
<a href="#l13.598"></a><span id="l13.598"> {</span>
<a href="#l13.599"></a><span id="l13.599" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l13.600"></a><span id="l13.600">   NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l13.601"></a><span id="l13.601"> </span>
<a href="#l13.602"></a><span id="l13.602">   nsCOMPtr&lt;nsIImapUrl&gt; aImapUrl;</span>
<a href="#l13.603"></a><span id="l13.603">   nsCAutoString urlSpec;</span>
<a href="#l13.604"></a><span id="l13.604"> </span>
<a href="#l13.605"></a><span id="l13.605">   char hierarchyDelimiter = GetHierarchyDelimiter(aImapMailFolder);</span>
<a href="#l13.606"></a><span id="l13.606">   nsresult rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(aImapUrl), aImapMailFolder, </span>
<a href="#l13.607"></a><span id="l13.607">                                      aUrlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l13.608"></a><span id="l13.608" class="difflineat">@@ -1971,37 +1925,35 @@ NS_IMETHODIMP nsImapService::DiscoverChi</span>
<a href="#l13.609"></a><span id="l13.609">         // obj if it's not kOnlineHierarchySeparatorUnknown (ie, '^').</span>
<a href="#l13.610"></a><span id="l13.610">         char uriDelimiter;</span>
<a href="#l13.611"></a><span id="l13.611">         nsresult rv1 = aImapUrl-&gt;GetOnlineSubDirSeparator(&amp;uriDelimiter);</span>
<a href="#l13.612"></a><span id="l13.612">         if (NS_SUCCEEDED (rv1) &amp;&amp; hierarchyDelimiter != kOnlineHierarchySeparatorUnknown &amp;&amp;</span>
<a href="#l13.613"></a><span id="l13.613">             uriDelimiter != hierarchyDelimiter)</span>
<a href="#l13.614"></a><span id="l13.614">           aImapUrl-&gt;SetOnlineSubDirSeparator(hierarchyDelimiter);</span>
<a href="#l13.615"></a><span id="l13.615"> </span>
<a href="#l13.616"></a><span id="l13.616">         if (NS_SUCCEEDED(rv))</span>
<a href="#l13.617"></a><span id="l13.617" class="difflineminus">-          rv = GetImapConnectionAndLoadUrl(aClientEventTarget, aImapUrl, nsnull, aURL);</span>
<a href="#l13.618"></a><span id="l13.618" class="difflineplus">+          rv = GetImapConnectionAndLoadUrl(aImapUrl, nsnull, aURL);</span>
<a href="#l13.619"></a><span id="l13.619">       }</span>
<a href="#l13.620"></a><span id="l13.620">       else</span>
<a href="#l13.621"></a><span id="l13.621">         rv = NS_ERROR_FAILURE;</span>
<a href="#l13.622"></a><span id="l13.622">     }</span>
<a href="#l13.623"></a><span id="l13.623">   }</span>
<a href="#l13.624"></a><span id="l13.624">   return rv;</span>
<a href="#l13.625"></a><span id="l13.625"> }</span>
<a href="#l13.626"></a><span id="l13.626"> </span>
<a href="#l13.627"></a><span id="l13.627" class="difflineminus">-NS_IMETHODIMP nsImapService::OnlineMessageCopy(nsIEventTarget *aClientEventTarget,</span>
<a href="#l13.628"></a><span id="l13.628" class="difflineminus">-                                               nsIMsgFolder *aSrcFolder,</span>
<a href="#l13.629"></a><span id="l13.629" class="difflineplus">+NS_IMETHODIMP nsImapService::OnlineMessageCopy(nsIMsgFolder *aSrcFolder,</span>
<a href="#l13.630"></a><span id="l13.630">                                                const nsACString &amp;messageIds,</span>
<a href="#l13.631"></a><span id="l13.631">                                                nsIMsgFolder *aDstFolder,</span>
<a href="#l13.632"></a><span id="l13.632">                                                bool idsAreUids,</span>
<a href="#l13.633"></a><span id="l13.633">                                                bool isMove,</span>
<a href="#l13.634"></a><span id="l13.634">                                                nsIUrlListener *aUrlListener,</span>
<a href="#l13.635"></a><span id="l13.635">                                                nsIURI **aURL,</span>
<a href="#l13.636"></a><span id="l13.636">                                                nsISupports *copyState,</span>
<a href="#l13.637"></a><span id="l13.637">                                                nsIMsgWindow *aMsgWindow)</span>
<a href="#l13.638"></a><span id="l13.638"> {</span>
<a href="#l13.639"></a><span id="l13.639" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l13.640"></a><span id="l13.640">   NS_ENSURE_ARG_POINTER(aSrcFolder);</span>
<a href="#l13.641"></a><span id="l13.641">   NS_ENSURE_ARG_POINTER(aDstFolder);</span>
<a href="#l13.642"></a><span id="l13.642"> </span>
<a href="#l13.643"></a><span id="l13.643">   nsresult rv;</span>
<a href="#l13.644"></a><span id="l13.644">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; srcServer;</span>
<a href="#l13.645"></a><span id="l13.645">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; dstServer;</span>
<a href="#l13.646"></a><span id="l13.646"> </span>
<a href="#l13.647"></a><span id="l13.647">   rv = aSrcFolder-&gt;GetServer(getter_AddRefs(srcServer));</span>
<a href="#l13.648"></a><span id="l13.648" class="difflineat">@@ -2055,17 +2007,17 @@ NS_IMETHODIMP nsImapService::OnlineMessa</span>
<a href="#l13.649"></a><span id="l13.649">     urlSpec.Append('&gt;');</span>
<a href="#l13.650"></a><span id="l13.650">     urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l13.651"></a><span id="l13.651">     folderName.Adopt(strdup(&quot;&quot;));</span>
<a href="#l13.652"></a><span id="l13.652">     GetFolderName(aDstFolder, folderName);</span>
<a href="#l13.653"></a><span id="l13.653">     urlSpec.Append(folderName);</span>
<a href="#l13.654"></a><span id="l13.654"> </span>
<a href="#l13.655"></a><span id="l13.655">     rv = uri-&gt;SetSpec(urlSpec);</span>
<a href="#l13.656"></a><span id="l13.656">     if (NS_SUCCEEDED(rv))</span>
<a href="#l13.657"></a><span id="l13.657" class="difflineminus">-      rv = GetImapConnectionAndLoadUrl(aClientEventTarget, imapUrl, nsnull, aURL);</span>
<a href="#l13.658"></a><span id="l13.658" class="difflineplus">+      rv = GetImapConnectionAndLoadUrl(imapUrl, nsnull, aURL);</span>
<a href="#l13.659"></a><span id="l13.659">   }</span>
<a href="#l13.660"></a><span id="l13.660">   return rv;</span>
<a href="#l13.661"></a><span id="l13.661"> }</span>
<a href="#l13.662"></a><span id="l13.662"> </span>
<a href="#l13.663"></a><span id="l13.663"> nsresult nsImapService::OfflineAppendFromFile(nsIFile *aFile,</span>
<a href="#l13.664"></a><span id="l13.664">                                               nsIURI *aUrl,</span>
<a href="#l13.665"></a><span id="l13.665">                                               nsIMsgFolder* aDstFolder,</span>
<a href="#l13.666"></a><span id="l13.666">                                               const nsACString &amp;messageId,  // to be replaced</span>
<a href="#l13.667"></a><span id="l13.667" class="difflineat">@@ -2186,28 +2138,26 @@ nsresult nsImapService::OfflineAppendFro</span>
<a href="#l13.668"></a><span id="l13.668">   if (destDB)</span>
<a href="#l13.669"></a><span id="l13.669">     destDB-&gt;Close(true);</span>
<a href="#l13.670"></a><span id="l13.670">   return rv;</span>
<a href="#l13.671"></a><span id="l13.671"> }</span>
<a href="#l13.672"></a><span id="l13.672"> </span>
<a href="#l13.673"></a><span id="l13.673"> /* append message from file url */</span>
<a href="#l13.674"></a><span id="l13.674"> /* imap://HOST&gt;appendmsgfromfile&gt;DESTINATIONMAILBOXPATH */</span>
<a href="#l13.675"></a><span id="l13.675"> /* imap://HOST&gt;appenddraftfromfile&gt;DESTINATIONMAILBOXPATH&gt;UID&gt;messageId */</span>
<a href="#l13.676"></a><span id="l13.676" class="difflineminus">-NS_IMETHODIMP nsImapService::AppendMessageFromFile(nsIEventTarget *aClientEventTarget,</span>
<a href="#l13.677"></a><span id="l13.677" class="difflineminus">-                                                   nsIFile *aFile,</span>
<a href="#l13.678"></a><span id="l13.678" class="difflineplus">+NS_IMETHODIMP nsImapService::AppendMessageFromFile(nsIFile *aFile,</span>
<a href="#l13.679"></a><span id="l13.679">                                                    nsIMsgFolder *aDstFolder,</span>
<a href="#l13.680"></a><span id="l13.680">                                                    const nsACString &amp;messageId,  // to be replaced</span>
<a href="#l13.681"></a><span id="l13.681">                                                    bool idsAreUids,</span>
<a href="#l13.682"></a><span id="l13.682">                                                    bool inSelectedState,       // needs to be in</span>
<a href="#l13.683"></a><span id="l13.683">                                                    nsIUrlListener *aListener,</span>
<a href="#l13.684"></a><span id="l13.684">                                                    nsIURI **aURL,</span>
<a href="#l13.685"></a><span id="l13.685">                                                    nsISupports *aCopyState,</span>
<a href="#l13.686"></a><span id="l13.686">                                                    nsIMsgWindow *aMsgWindow)</span>
<a href="#l13.687"></a><span id="l13.687"> {</span>
<a href="#l13.688"></a><span id="l13.688" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l13.689"></a><span id="l13.689">   NS_ENSURE_ARG_POINTER(aFile);</span>
<a href="#l13.690"></a><span id="l13.690">   NS_ENSURE_ARG_POINTER(aDstFolder);</span>
<a href="#l13.691"></a><span id="l13.691"> </span>
<a href="#l13.692"></a><span id="l13.692">   nsresult rv;</span>
<a href="#l13.693"></a><span id="l13.693">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l13.694"></a><span id="l13.694">   nsCAutoString urlSpec;</span>
<a href="#l13.695"></a><span id="l13.695"> </span>
<a href="#l13.696"></a><span id="l13.696">   char hierarchyDelimiter = GetHierarchyDelimiter(aDstFolder);</span>
<a href="#l13.697"></a><span id="l13.697" class="difflineat">@@ -2252,23 +2202,22 @@ NS_IMETHODIMP nsImapService::AppendMessa</span>
<a href="#l13.698"></a><span id="l13.698">     </span>
<a href="#l13.699"></a><span id="l13.699">     rv = uri-&gt;SetSpec(urlSpec);</span>
<a href="#l13.700"></a><span id="l13.700">     if (WeAreOffline())</span>
<a href="#l13.701"></a><span id="l13.701">     {</span>
<a href="#l13.702"></a><span id="l13.702">       // handle offline append to drafts or templates folder here.</span>
<a href="#l13.703"></a><span id="l13.703">       return OfflineAppendFromFile(aFile, uri, aDstFolder, messageId, inSelectedState, aListener, aURL, aCopyState);</span>
<a href="#l13.704"></a><span id="l13.704">     }</span>
<a href="#l13.705"></a><span id="l13.705">     if (NS_SUCCEEDED(rv))</span>
<a href="#l13.706"></a><span id="l13.706" class="difflineminus">-      rv = GetImapConnectionAndLoadUrl(aClientEventTarget, imapUrl, nsnull, aURL);</span>
<a href="#l13.707"></a><span id="l13.707" class="difflineplus">+      rv = GetImapConnectionAndLoadUrl(imapUrl, nsnull, aURL);</span>
<a href="#l13.708"></a><span id="l13.708">   }</span>
<a href="#l13.709"></a><span id="l13.709">   return rv;</span>
<a href="#l13.710"></a><span id="l13.710"> }</span>
<a href="#l13.711"></a><span id="l13.711"> </span>
<a href="#l13.712"></a><span id="l13.712" class="difflineminus">-nsresult nsImapService::GetImapConnectionAndLoadUrl(nsIEventTarget *aClientEventTarget,</span>
<a href="#l13.713"></a><span id="l13.713" class="difflineminus">-                                                    nsIImapUrl *aImapUrl,</span>
<a href="#l13.714"></a><span id="l13.714" class="difflineplus">+nsresult nsImapService::GetImapConnectionAndLoadUrl(nsIImapUrl *aImapUrl,</span>
<a href="#l13.715"></a><span id="l13.715">                                                     nsISupports *aConsumer,</span>
<a href="#l13.716"></a><span id="l13.716">                                                     nsIURI **aURL)</span>
<a href="#l13.717"></a><span id="l13.717"> {</span>
<a href="#l13.718"></a><span id="l13.718">   NS_ENSURE_ARG_POINTER(aImapUrl);</span>
<a href="#l13.719"></a><span id="l13.719"> </span>
<a href="#l13.720"></a><span id="l13.720">   bool isValidUrl;</span>
<a href="#l13.721"></a><span id="l13.721">   aImapUrl-&gt;GetValidUrl(&amp;isValidUrl);</span>
<a href="#l13.722"></a><span id="l13.722">   if (!isValidUrl)</span>
<a href="#l13.723"></a><span id="l13.723" class="difflineat">@@ -2296,29 +2245,27 @@ nsresult nsImapService::GetImapConnectio</span>
<a href="#l13.724"></a><span id="l13.724">     nsCOMPtr&lt;nsIURI&gt; msgUrlUri = do_QueryInterface(msgUrl);</span>
<a href="#l13.725"></a><span id="l13.725">     msgUrlUri.swap(*aURL);</span>
<a href="#l13.726"></a><span id="l13.726">   }</span>
<a href="#l13.727"></a><span id="l13.727"> </span>
<a href="#l13.728"></a><span id="l13.728">   if (NS_SUCCEEDED(rv) &amp;&amp; aMsgIncomingServer)</span>
<a href="#l13.729"></a><span id="l13.729">   {</span>
<a href="#l13.730"></a><span id="l13.730">     nsCOMPtr&lt;nsIImapIncomingServer&gt; aImapServer(do_QueryInterface(aMsgIncomingServer, &amp;rv));</span>
<a href="#l13.731"></a><span id="l13.731">     if (NS_SUCCEEDED(rv) &amp;&amp; aImapServer)</span>
<a href="#l13.732"></a><span id="l13.732" class="difflineminus">-      rv = aImapServer-&gt;GetImapConnectionAndLoadUrl(aClientEventTarget, aImapUrl, aConsumer);</span>
<a href="#l13.733"></a><span id="l13.733" class="difflineplus">+      rv = aImapServer-&gt;GetImapConnectionAndLoadUrl(aImapUrl, aConsumer);</span>
<a href="#l13.734"></a><span id="l13.734">   }</span>
<a href="#l13.735"></a><span id="l13.735">   return rv;</span>
<a href="#l13.736"></a><span id="l13.736"> }</span>
<a href="#l13.737"></a><span id="l13.737"> </span>
<a href="#l13.738"></a><span id="l13.738" class="difflineminus">-NS_IMETHODIMP nsImapService::MoveFolder(nsIEventTarget *aClientEventTarget,</span>
<a href="#l13.739"></a><span id="l13.739" class="difflineminus">-                                        nsIMsgFolder *srcFolder,</span>
<a href="#l13.740"></a><span id="l13.740" class="difflineplus">+NS_IMETHODIMP nsImapService::MoveFolder(nsIMsgFolder *srcFolder,</span>
<a href="#l13.741"></a><span id="l13.741">                                         nsIMsgFolder *dstFolder, </span>
<a href="#l13.742"></a><span id="l13.742">                                         nsIUrlListener *urlListener, </span>
<a href="#l13.743"></a><span id="l13.743">                                         nsIMsgWindow *msgWindow, </span>
<a href="#l13.744"></a><span id="l13.744">                                         nsIURI **url)</span>
<a href="#l13.745"></a><span id="l13.745"> {</span>
<a href="#l13.746"></a><span id="l13.746" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l13.747"></a><span id="l13.747">   NS_ENSURE_ARG_POINTER(srcFolder);</span>
<a href="#l13.748"></a><span id="l13.748">   NS_ENSURE_ARG_POINTER(dstFolder);</span>
<a href="#l13.749"></a><span id="l13.749"> </span>
<a href="#l13.750"></a><span id="l13.750">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l13.751"></a><span id="l13.751">   nsCAutoString urlSpec;</span>
<a href="#l13.752"></a><span id="l13.752">   nsresult rv;</span>
<a href="#l13.753"></a><span id="l13.753"> </span>
<a href="#l13.754"></a><span id="l13.754">   char default_hierarchyDelimiter = GetHierarchyDelimiter(dstFolder);</span>
<a href="#l13.755"></a><span id="l13.755" class="difflineat">@@ -2346,40 +2293,36 @@ NS_IMETHODIMP nsImapService::MoveFolder(</span>
<a href="#l13.756"></a><span id="l13.756">       {</span>
<a href="#l13.757"></a><span id="l13.757">         urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l13.758"></a><span id="l13.758">         urlSpec.Append(folderName);</span>
<a href="#l13.759"></a><span id="l13.759">       }</span>
<a href="#l13.760"></a><span id="l13.760">       rv = uri-&gt;SetSpec(urlSpec);</span>
<a href="#l13.761"></a><span id="l13.761">       if (NS_SUCCEEDED(rv))</span>
<a href="#l13.762"></a><span id="l13.762">       {</span>
<a href="#l13.763"></a><span id="l13.763">         GetFolderName(srcFolder, folderName);</span>
<a href="#l13.764"></a><span id="l13.764" class="difflineminus">-        rv = GetImapConnectionAndLoadUrl(aClientEventTarget, imapUrl,</span>
<a href="#l13.765"></a><span id="l13.765" class="difflineminus">-                                         nsnull, url);</span>
<a href="#l13.766"></a><span id="l13.766" class="difflineplus">+        rv = GetImapConnectionAndLoadUrl(imapUrl, nsnull, url);</span>
<a href="#l13.767"></a><span id="l13.767">       }</span>
<a href="#l13.768"></a><span id="l13.768">     }</span>
<a href="#l13.769"></a><span id="l13.769">   }</span>
<a href="#l13.770"></a><span id="l13.770">   return rv;</span>
<a href="#l13.771"></a><span id="l13.771"> }</span>
<a href="#l13.772"></a><span id="l13.772"> </span>
<a href="#l13.773"></a><span id="l13.773" class="difflineminus">-NS_IMETHODIMP nsImapService::RenameLeaf(nsIEventTarget *aClientEventTarget,</span>
<a href="#l13.774"></a><span id="l13.774" class="difflineminus">-                                        nsIMsgFolder *srcFolder,</span>
<a href="#l13.775"></a><span id="l13.775" class="difflineplus">+NS_IMETHODIMP nsImapService::RenameLeaf(nsIMsgFolder *srcFolder,</span>
<a href="#l13.776"></a><span id="l13.776">                                         const nsAString &amp;newLeafName, </span>
<a href="#l13.777"></a><span id="l13.777">                                         nsIUrlListener *urlListener,</span>
<a href="#l13.778"></a><span id="l13.778">                                         nsIMsgWindow *msgWindow, </span>
<a href="#l13.779"></a><span id="l13.779">                                         nsIURI **url)</span>
<a href="#l13.780"></a><span id="l13.780"> {</span>
<a href="#l13.781"></a><span id="l13.781" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l13.782"></a><span id="l13.782">   NS_ENSURE_ARG_POINTER(srcFolder);</span>
<a href="#l13.783"></a><span id="l13.783" class="difflineminus">-  </span>
<a href="#l13.784"></a><span id="l13.784" class="difflineplus">+</span>
<a href="#l13.785"></a><span id="l13.785">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l13.786"></a><span id="l13.786">   nsCAutoString urlSpec;</span>
<a href="#l13.787"></a><span id="l13.787" class="difflineminus">-  nsresult rv;</span>
<a href="#l13.788"></a><span id="l13.788"> </span>
<a href="#l13.789"></a><span id="l13.789">   char hierarchyDelimiter = GetHierarchyDelimiter(srcFolder);</span>
<a href="#l13.790"></a><span id="l13.790" class="difflineminus">-  rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), srcFolder, </span>
<a href="#l13.791"></a><span id="l13.791" class="difflineplus">+  nsresult rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), srcFolder, </span>
<a href="#l13.792"></a><span id="l13.792">                             urlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l13.793"></a><span id="l13.793">   if (NS_SUCCEEDED(rv))</span>
<a href="#l13.794"></a><span id="l13.794">   {</span>
<a href="#l13.795"></a><span id="l13.795">     rv = SetImapUrlSink(srcFolder, imapUrl);</span>
<a href="#l13.796"></a><span id="l13.796">     if (NS_SUCCEEDED(rv))</span>
<a href="#l13.797"></a><span id="l13.797">     {</span>
<a href="#l13.798"></a><span id="l13.798">       nsCOMPtr&lt;nsIURI&gt; uri = do_QueryInterface(imapUrl);</span>
<a href="#l13.799"></a><span id="l13.799">       nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailNewsUrl = do_QueryInterface(imapUrl);</span>
<a href="#l13.800"></a><span id="l13.800" class="difflineat">@@ -2408,30 +2351,27 @@ NS_IMETHODIMP nsImapService::RenameLeaf(</span>
<a href="#l13.801"></a><span id="l13.801">       MsgEscapeString(utfNewName, nsINetUtil::ESCAPE_URL_PATH, escapedNewName);</span>
<a href="#l13.802"></a><span id="l13.802">       nsCString escapedSlashName;</span>
<a href="#l13.803"></a><span id="l13.803">       rv = nsImapUrl::EscapeSlashes(escapedNewName.get(), getter_Copies(escapedSlashName));</span>
<a href="#l13.804"></a><span id="l13.804">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.805"></a><span id="l13.805">       urlSpec.Append(escapedSlashName);</span>
<a href="#l13.806"></a><span id="l13.806"> </span>
<a href="#l13.807"></a><span id="l13.807">       rv = uri-&gt;SetSpec(urlSpec);</span>
<a href="#l13.808"></a><span id="l13.808">       if (NS_SUCCEEDED(rv))</span>
<a href="#l13.809"></a><span id="l13.809" class="difflineminus">-        rv = GetImapConnectionAndLoadUrl(aClientEventTarget, imapUrl,</span>
<a href="#l13.810"></a><span id="l13.810" class="difflineminus">-                                         nsnull, url);</span>
<a href="#l13.811"></a><span id="l13.811" class="difflineplus">+        rv = GetImapConnectionAndLoadUrl(imapUrl, nsnull, url);</span>
<a href="#l13.812"></a><span id="l13.812">     } // if (NS_SUCCEEDED(rv))</span>
<a href="#l13.813"></a><span id="l13.813">   } // if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl)</span>
<a href="#l13.814"></a><span id="l13.814">   return rv;</span>
<a href="#l13.815"></a><span id="l13.815"> }</span>
<a href="#l13.816"></a><span id="l13.816"> </span>
<a href="#l13.817"></a><span id="l13.817" class="difflineminus">-NS_IMETHODIMP nsImapService::CreateFolder(nsIEventTarget *aClientEventTarget,</span>
<a href="#l13.818"></a><span id="l13.818" class="difflineminus">-                                          nsIMsgFolder *parent,</span>
<a href="#l13.819"></a><span id="l13.819" class="difflineplus">+NS_IMETHODIMP nsImapService::CreateFolder(nsIMsgFolder *parent,</span>
<a href="#l13.820"></a><span id="l13.820">                                           const nsAString &amp;newFolderName,</span>
<a href="#l13.821"></a><span id="l13.821" class="difflineminus">-                                          nsIUrlListener *urlListener, </span>
<a href="#l13.822"></a><span id="l13.822" class="difflineplus">+                                          nsIUrlListener *urlListener,</span>
<a href="#l13.823"></a><span id="l13.823">                                           nsIURI **url)</span>
<a href="#l13.824"></a><span id="l13.824"> {</span>
<a href="#l13.825"></a><span id="l13.825" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l13.826"></a><span id="l13.826">   NS_ENSURE_ARG_POINTER(parent);</span>
<a href="#l13.827"></a><span id="l13.827"> </span>
<a href="#l13.828"></a><span id="l13.828">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l13.829"></a><span id="l13.829">   nsCAutoString urlSpec;</span>
<a href="#l13.830"></a><span id="l13.830">   nsresult rv;</span>
<a href="#l13.831"></a><span id="l13.831"> </span>
<a href="#l13.832"></a><span id="l13.832">   char hierarchyDelimiter = GetHierarchyDelimiter(parent);</span>
<a href="#l13.833"></a><span id="l13.833">   rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), parent, </span>
<a href="#l13.834"></a><span id="l13.834" class="difflineat">@@ -2461,30 +2401,27 @@ NS_IMETHODIMP nsImapService::CreateFolde</span>
<a href="#l13.835"></a><span id="l13.835">       rv = CopyUTF16toMUTF7(PromiseFlatString(newFolderName), utfNewName);</span>
<a href="#l13.836"></a><span id="l13.836">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.837"></a><span id="l13.837">       nsCString escapedFolderName;</span>
<a href="#l13.838"></a><span id="l13.838">       MsgEscapeString(utfNewName, nsINetUtil::ESCAPE_URL_PATH, escapedFolderName);</span>
<a href="#l13.839"></a><span id="l13.839">       urlSpec.Append(escapedFolderName);</span>
<a href="#l13.840"></a><span id="l13.840"> </span>
<a href="#l13.841"></a><span id="l13.841">       rv = uri-&gt;SetSpec(urlSpec);</span>
<a href="#l13.842"></a><span id="l13.842">       if (NS_SUCCEEDED(rv))</span>
<a href="#l13.843"></a><span id="l13.843" class="difflineminus">-        rv = GetImapConnectionAndLoadUrl(aClientEventTarget, imapUrl,</span>
<a href="#l13.844"></a><span id="l13.844" class="difflineminus">-                                         nsnull, url);</span>
<a href="#l13.845"></a><span id="l13.845" class="difflineplus">+        rv = GetImapConnectionAndLoadUrl(imapUrl, nsnull, url);</span>
<a href="#l13.846"></a><span id="l13.846">     } // if (NS_SUCCEEDED(rv))</span>
<a href="#l13.847"></a><span id="l13.847">   } // if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl)</span>
<a href="#l13.848"></a><span id="l13.848">   return rv;</span>
<a href="#l13.849"></a><span id="l13.849"> }</span>
<a href="#l13.850"></a><span id="l13.850"> </span>
<a href="#l13.851"></a><span id="l13.851" class="difflineminus">-NS_IMETHODIMP nsImapService::EnsureFolderExists(nsIEventTarget *aClientEventTarget,</span>
<a href="#l13.852"></a><span id="l13.852" class="difflineminus">-                                                nsIMsgFolder *parent,</span>
<a href="#l13.853"></a><span id="l13.853" class="difflineplus">+NS_IMETHODIMP nsImapService::EnsureFolderExists(nsIMsgFolder *parent,</span>
<a href="#l13.854"></a><span id="l13.854">                                                 const nsAString &amp;newFolderName, </span>
<a href="#l13.855"></a><span id="l13.855">                                                 nsIUrlListener *urlListener, </span>
<a href="#l13.856"></a><span id="l13.856">                                                 nsIURI **url)</span>
<a href="#l13.857"></a><span id="l13.857"> {</span>
<a href="#l13.858"></a><span id="l13.858" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l13.859"></a><span id="l13.859">   NS_ENSURE_ARG_POINTER(parent);</span>
<a href="#l13.860"></a><span id="l13.860"> </span>
<a href="#l13.861"></a><span id="l13.861">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l13.862"></a><span id="l13.862">   nsCAutoString urlSpec;</span>
<a href="#l13.863"></a><span id="l13.863">   nsresult rv;</span>
<a href="#l13.864"></a><span id="l13.864"> </span>
<a href="#l13.865"></a><span id="l13.865">   char hierarchyDelimiter = GetHierarchyDelimiter(parent);</span>
<a href="#l13.866"></a><span id="l13.866">   rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), parent, urlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l13.867"></a><span id="l13.867" class="difflineat">@@ -2507,32 +2444,29 @@ NS_IMETHODIMP nsImapService::EnsureFolde</span>
<a href="#l13.868"></a><span id="l13.868">       nsCAutoString utfNewName; </span>
<a href="#l13.869"></a><span id="l13.869">       CopyUTF16toMUTF7(PromiseFlatString(newFolderName), utfNewName);</span>
<a href="#l13.870"></a><span id="l13.870">       nsCString escapedFolderName;</span>
<a href="#l13.871"></a><span id="l13.871">       MsgEscapeString(utfNewName, nsINetUtil::ESCAPE_URL_PATH, escapedFolderName);</span>
<a href="#l13.872"></a><span id="l13.872">       urlSpec.Append(escapedFolderName);</span>
<a href="#l13.873"></a><span id="l13.873"> </span>
<a href="#l13.874"></a><span id="l13.874">       rv = uri-&gt;SetSpec(urlSpec);</span>
<a href="#l13.875"></a><span id="l13.875">       if (NS_SUCCEEDED(rv))</span>
<a href="#l13.876"></a><span id="l13.876" class="difflineminus">-        rv = GetImapConnectionAndLoadUrl(aClientEventTarget, imapUrl,</span>
<a href="#l13.877"></a><span id="l13.877" class="difflineminus">-                                         nsnull, url);</span>
<a href="#l13.878"></a><span id="l13.878" class="difflineplus">+        rv = GetImapConnectionAndLoadUrl(imapUrl, nsnull, url);</span>
<a href="#l13.879"></a><span id="l13.879">     } // if (NS_SUCCEEDED(rv))</span>
<a href="#l13.880"></a><span id="l13.880">   } // if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl)</span>
<a href="#l13.881"></a><span id="l13.881">   return rv;</span>
<a href="#l13.882"></a><span id="l13.882"> }</span>
<a href="#l13.883"></a><span id="l13.883"> </span>
<a href="#l13.884"></a><span id="l13.884" class="difflineminus">-NS_IMETHODIMP nsImapService::ListFolder(nsIEventTarget *aClientEventTarget,</span>
<a href="#l13.885"></a><span id="l13.885" class="difflineminus">-                                        nsIMsgFolder *aImapMailFolder,</span>
<a href="#l13.886"></a><span id="l13.886" class="difflineplus">+NS_IMETHODIMP nsImapService::ListFolder(nsIMsgFolder *aImapMailFolder,</span>
<a href="#l13.887"></a><span id="l13.887">                                         nsIUrlListener *aUrlListener,</span>
<a href="#l13.888"></a><span id="l13.888">                                         nsIURI **aURL)</span>
<a href="#l13.889"></a><span id="l13.889"> {</span>
<a href="#l13.890"></a><span id="l13.890" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l13.891"></a><span id="l13.891">   NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l13.892"></a><span id="l13.892"> </span>
<a href="#l13.893"></a><span id="l13.893" class="difflineminus">-  return FolderCommand(aClientEventTarget, aImapMailFolder, aUrlListener,</span>
<a href="#l13.894"></a><span id="l13.894" class="difflineplus">+  return FolderCommand(aImapMailFolder, aUrlListener,</span>
<a href="#l13.895"></a><span id="l13.895">                        &quot;/listfolder&gt;&quot;, nsIImapUrl::nsImapListFolder, nsnull, aURL);</span>
<a href="#l13.896"></a><span id="l13.896"> }</span>
<a href="#l13.897"></a><span id="l13.897"> </span>
<a href="#l13.898"></a><span id="l13.898"> NS_IMETHODIMP nsImapService::GetScheme(nsACString &amp;aScheme)</span>
<a href="#l13.899"></a><span id="l13.899"> {</span>
<a href="#l13.900"></a><span id="l13.900">   aScheme.Assign(&quot;imap&quot;);</span>
<a href="#l13.901"></a><span id="l13.901">   return NS_OK; </span>
<a href="#l13.902"></a><span id="l13.902"> }</span>
<a href="#l13.903"></a><span id="l13.903" class="difflineat">@@ -3068,18 +3002,17 @@ NS_IMETHODIMP nsImapService::GetListOfFo</span>
<a href="#l13.904"></a><span id="l13.904">     else</span>
<a href="#l13.905"></a><span id="l13.905">       changedStr.Append(tokenStr);</span>
<a href="#l13.906"></a><span id="l13.906"> </span>
<a href="#l13.907"></a><span id="l13.907">     if (slashPos &gt; 0 ) </span>
<a href="#l13.908"></a><span id="l13.908">       changedStr.Append(remStr);</span>
<a href="#l13.909"></a><span id="l13.909"> </span>
<a href="#l13.910"></a><span id="l13.910">     rv = rootMsgFolder-&gt;FindSubFolder(changedStr, getter_AddRefs(msgFolder));</span>
<a href="#l13.911"></a><span id="l13.911">   }</span>
<a href="#l13.912"></a><span id="l13.912" class="difflineminus">-  nsCOMPtr&lt;nsIThread&gt; thread(do_GetCurrentThread());</span>
<a href="#l13.913"></a><span id="l13.913" class="difflineminus">-  return DiscoverChildren(thread, msgFolder, listener, folderPath, nsnull);</span>
<a href="#l13.914"></a><span id="l13.914" class="difflineplus">+  return DiscoverChildren(msgFolder, listener, folderPath, nsnull);</span>
<a href="#l13.915"></a><span id="l13.915"> }</span>
<a href="#l13.916"></a><span id="l13.916"> </span>
<a href="#l13.917"></a><span id="l13.917"> NS_IMETHODIMP nsImapService::GetListOfFoldersOnServer(nsIImapIncomingServer *aServer, </span>
<a href="#l13.918"></a><span id="l13.918">                                                       nsIMsgWindow *aMsgWindow)</span>
<a href="#l13.919"></a><span id="l13.919"> {</span>
<a href="#l13.920"></a><span id="l13.920">   nsresult rv;</span>
<a href="#l13.921"></a><span id="l13.921"> </span>
<a href="#l13.922"></a><span id="l13.922">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server = do_QueryInterface(aServer);</span>
<a href="#l13.923"></a><span id="l13.923" class="difflineat">@@ -3091,40 +3024,35 @@ NS_IMETHODIMP nsImapService::GetListOfFo</span>
<a href="#l13.924"></a><span id="l13.924"> </span>
<a href="#l13.925"></a><span id="l13.925">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.926"></a><span id="l13.926">   if (!rootMsgFolder) </span>
<a href="#l13.927"></a><span id="l13.927">     return NS_ERROR_FAILURE;</span>
<a href="#l13.928"></a><span id="l13.928"> </span>
<a href="#l13.929"></a><span id="l13.929">   nsCOMPtr&lt;nsIUrlListener&gt; listener = do_QueryInterface(aServer, &amp;rv);</span>
<a href="#l13.930"></a><span id="l13.930">   NS_ENSURE_TRUE(NS_SUCCEEDED(rv) &amp;&amp; listener, NS_ERROR_FAILURE);</span>
<a href="#l13.931"></a><span id="l13.931"> </span>
<a href="#l13.932"></a><span id="l13.932" class="difflineminus">-  nsCOMPtr&lt;nsIThread&gt; thread(do_GetCurrentThread());</span>
<a href="#l13.933"></a><span id="l13.933" class="difflineminus">-  return DiscoverAllAndSubscribedFolders(thread, rootMsgFolder, listener, nsnull);</span>
<a href="#l13.934"></a><span id="l13.934" class="difflineplus">+  return DiscoverAllAndSubscribedFolders(rootMsgFolder, listener, nsnull);</span>
<a href="#l13.935"></a><span id="l13.935"> } </span>
<a href="#l13.936"></a><span id="l13.936"> </span>
<a href="#l13.937"></a><span id="l13.937" class="difflineminus">-NS_IMETHODIMP nsImapService::SubscribeFolder(nsIEventTarget *aClientEventTarget,</span>
<a href="#l13.938"></a><span id="l13.938" class="difflineminus">-                                             nsIMsgFolder *aFolder,</span>
<a href="#l13.939"></a><span id="l13.939" class="difflineplus">+NS_IMETHODIMP nsImapService::SubscribeFolder(nsIMsgFolder *aFolder,</span>
<a href="#l13.940"></a><span id="l13.940">                                              const nsAString &amp;aFolderName, </span>
<a href="#l13.941"></a><span id="l13.941">                                              nsIUrlListener *urlListener, </span>
<a href="#l13.942"></a><span id="l13.942">                                              nsIURI **url)</span>
<a href="#l13.943"></a><span id="l13.943"> {</span>
<a href="#l13.944"></a><span id="l13.944" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l13.945"></a><span id="l13.945" class="difflineminus">-</span>
<a href="#l13.946"></a><span id="l13.946" class="difflineminus">-  return ChangeFolderSubscription(aClientEventTarget, aFolder, aFolderName, </span>
<a href="#l13.947"></a><span id="l13.947" class="difflineplus">+</span>
<a href="#l13.948"></a><span id="l13.948" class="difflineplus">+  return ChangeFolderSubscription(aFolder, aFolderName, </span>
<a href="#l13.949"></a><span id="l13.949">                                   &quot;/subscribe&gt;&quot;, urlListener, url);</span>
<a href="#l13.950"></a><span id="l13.950"> }</span>
<a href="#l13.951"></a><span id="l13.951"> </span>
<a href="#l13.952"></a><span id="l13.952" class="difflineminus">-nsresult nsImapService::ChangeFolderSubscription(nsIEventTarget *aClientEventTarget,</span>
<a href="#l13.953"></a><span id="l13.953" class="difflineminus">-                                                 nsIMsgFolder *folder,</span>
<a href="#l13.954"></a><span id="l13.954" class="difflineplus">+nsresult nsImapService::ChangeFolderSubscription(nsIMsgFolder *folder,</span>
<a href="#l13.955"></a><span id="l13.955">                                                  const nsAString &amp;folderName, </span>
<a href="#l13.956"></a><span id="l13.956">                                                  const char *command,</span>
<a href="#l13.957"></a><span id="l13.957">                                                  nsIUrlListener *urlListener, </span>
<a href="#l13.958"></a><span id="l13.958">                                                  nsIURI **url)</span>
<a href="#l13.959"></a><span id="l13.959"> {</span>
<a href="#l13.960"></a><span id="l13.960" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l13.961"></a><span id="l13.961">   NS_ENSURE_ARG_POINTER(folder);</span>
<a href="#l13.962"></a><span id="l13.962"> </span>
<a href="#l13.963"></a><span id="l13.963">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l13.964"></a><span id="l13.964">   nsCAutoString urlSpec;</span>
<a href="#l13.965"></a><span id="l13.965">   nsresult rv;</span>
<a href="#l13.966"></a><span id="l13.966">   char hierarchyDelimiter = GetHierarchyDelimiter(folder);</span>
<a href="#l13.967"></a><span id="l13.967">   rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), folder, urlListener,</span>
<a href="#l13.968"></a><span id="l13.968">                             urlSpec, hierarchyDelimiter);</span>
<a href="#l13.969"></a><span id="l13.969" class="difflineat">@@ -3139,56 +3067,49 @@ nsresult nsImapService::ChangeFolderSubs</span>
<a href="#l13.970"></a><span id="l13.970">       nsCAutoString utfFolderName;</span>
<a href="#l13.971"></a><span id="l13.971">       rv = CopyUTF16toMUTF7(PromiseFlatString(folderName), utfFolderName);</span>
<a href="#l13.972"></a><span id="l13.972">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.973"></a><span id="l13.973">       nsCString escapedFolderName;</span>
<a href="#l13.974"></a><span id="l13.974">       MsgEscapeString(utfFolderName, nsINetUtil::ESCAPE_URL_PATH, escapedFolderName);</span>
<a href="#l13.975"></a><span id="l13.975">       urlSpec.Append(escapedFolderName);</span>
<a href="#l13.976"></a><span id="l13.976">       rv = uri-&gt;SetSpec(urlSpec);</span>
<a href="#l13.977"></a><span id="l13.977">       if (NS_SUCCEEDED(rv))</span>
<a href="#l13.978"></a><span id="l13.978" class="difflineminus">-        rv = GetImapConnectionAndLoadUrl(aClientEventTarget, imapUrl,</span>
<a href="#l13.979"></a><span id="l13.979" class="difflineminus">-                                         nsnull, url);</span>
<a href="#l13.980"></a><span id="l13.980" class="difflineplus">+        rv = GetImapConnectionAndLoadUrl(imapUrl, nsnull, url);</span>
<a href="#l13.981"></a><span id="l13.981">     }</span>
<a href="#l13.982"></a><span id="l13.982">   }</span>
<a href="#l13.983"></a><span id="l13.983">   return rv;</span>
<a href="#l13.984"></a><span id="l13.984"> }</span>
<a href="#l13.985"></a><span id="l13.985"> </span>
<a href="#l13.986"></a><span id="l13.986" class="difflineminus">-NS_IMETHODIMP nsImapService::UnsubscribeFolder(nsIEventTarget *aClientEventTarget,</span>
<a href="#l13.987"></a><span id="l13.987" class="difflineminus">-                                               nsIMsgFolder *aFolder,</span>
<a href="#l13.988"></a><span id="l13.988" class="difflineplus">+NS_IMETHODIMP nsImapService::UnsubscribeFolder(nsIMsgFolder *aFolder,</span>
<a href="#l13.989"></a><span id="l13.989">                                                const nsAString &amp;aFolderName, </span>
<a href="#l13.990"></a><span id="l13.990">                                                nsIUrlListener *aUrlListener, </span>
<a href="#l13.991"></a><span id="l13.991">                                                nsIURI **aUrl)</span>
<a href="#l13.992"></a><span id="l13.992"> {</span>
<a href="#l13.993"></a><span id="l13.993" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l13.994"></a><span id="l13.994" class="difflineminus">-</span>
<a href="#l13.995"></a><span id="l13.995" class="difflineminus">-  return ChangeFolderSubscription(aClientEventTarget, aFolder, aFolderName,</span>
<a href="#l13.996"></a><span id="l13.996" class="difflineplus">+</span>
<a href="#l13.997"></a><span id="l13.997" class="difflineplus">+  return ChangeFolderSubscription(aFolder, aFolderName,</span>
<a href="#l13.998"></a><span id="l13.998">                                   &quot;/unsubscribe&gt;&quot;, aUrlListener, aUrl);</span>
<a href="#l13.999"></a><span id="l13.999"> }</span>
<a href="#l13.1000"></a><span id="l13.1000"> </span>
<a href="#l13.1001"></a><span id="l13.1001" class="difflineminus">-NS_IMETHODIMP nsImapService::GetFolderAdminUrl(nsIEventTarget *aClientEventTarget,</span>
<a href="#l13.1002"></a><span id="l13.1002" class="difflineminus">-                                               nsIMsgFolder *aImapMailFolder,</span>
<a href="#l13.1003"></a><span id="l13.1003" class="difflineplus">+NS_IMETHODIMP nsImapService::GetFolderAdminUrl(nsIMsgFolder *aImapMailFolder,</span>
<a href="#l13.1004"></a><span id="l13.1004">                                                nsIMsgWindow *aMsgWindow,</span>
<a href="#l13.1005"></a><span id="l13.1005">                                                nsIUrlListener *aUrlListener,</span>
<a href="#l13.1006"></a><span id="l13.1006">                                                nsIURI **aURL)</span>
<a href="#l13.1007"></a><span id="l13.1007"> {</span>
<a href="#l13.1008"></a><span id="l13.1008" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l13.1009"></a><span id="l13.1009">   NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l13.1010"></a><span id="l13.1010"> </span>
<a href="#l13.1011"></a><span id="l13.1011" class="difflineminus">-  return FolderCommand(aClientEventTarget, aImapMailFolder, aUrlListener,</span>
<a href="#l13.1012"></a><span id="l13.1012" class="difflineplus">+  return FolderCommand(aImapMailFolder, aUrlListener,</span>
<a href="#l13.1013"></a><span id="l13.1013">                        &quot;/refreshfolderurls&gt;&quot;, nsIImapUrl::nsImapRefreshFolderUrls, aMsgWindow, aURL);</span>
<a href="#l13.1014"></a><span id="l13.1014"> }</span>
<a href="#l13.1015"></a><span id="l13.1015"> </span>
<a href="#l13.1016"></a><span id="l13.1016" class="difflineminus">-NS_IMETHODIMP nsImapService::IssueCommandOnMsgs(nsIEventTarget *aClientEventTarget,</span>
<a href="#l13.1017"></a><span id="l13.1017" class="difflineminus">-                                                nsIMsgFolder *anImapFolder,</span>
<a href="#l13.1018"></a><span id="l13.1018" class="difflineplus">+NS_IMETHODIMP nsImapService::IssueCommandOnMsgs(nsIMsgFolder *anImapFolder,</span>
<a href="#l13.1019"></a><span id="l13.1019">                                                 nsIMsgWindow *aMsgWindow,</span>
<a href="#l13.1020"></a><span id="l13.1020">                                                 const nsACString &amp;aCommand,</span>
<a href="#l13.1021"></a><span id="l13.1021">                                                 const nsACString &amp;uids,</span>
<a href="#l13.1022"></a><span id="l13.1022">                                                 nsIURI **aURL)</span>
<a href="#l13.1023"></a><span id="l13.1023"> {</span>
<a href="#l13.1024"></a><span id="l13.1024" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l13.1025"></a><span id="l13.1025">   NS_ENSURE_ARG_POINTER(anImapFolder);</span>
<a href="#l13.1026"></a><span id="l13.1026">   NS_ENSURE_ARG_POINTER(aMsgWindow);</span>
<a href="#l13.1027"></a><span id="l13.1027"> </span>
<a href="#l13.1028"></a><span id="l13.1028">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l13.1029"></a><span id="l13.1029">   nsCAutoString urlSpec;</span>
<a href="#l13.1030"></a><span id="l13.1030">   nsresult rv;</span>
<a href="#l13.1031"></a><span id="l13.1031">   char hierarchyDelimiter = GetHierarchyDelimiter(anImapFolder);</span>
<a href="#l13.1032"></a><span id="l13.1032">   rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), anImapFolder, nsnull, urlSpec, hierarchyDelimiter);</span>
<a href="#l13.1033"></a><span id="l13.1033" class="difflineat">@@ -3213,31 +3134,29 @@ NS_IMETHODIMP nsImapService::IssueComman</span>
<a href="#l13.1034"></a><span id="l13.1034">       urlSpec.Append(uidString);</span>
<a href="#l13.1035"></a><span id="l13.1035">       urlSpec.Append(&quot;&gt;&quot;);</span>
<a href="#l13.1036"></a><span id="l13.1036">       urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l13.1037"></a><span id="l13.1037">       urlSpec.Append(folderName);</span>
<a href="#l13.1038"></a><span id="l13.1038">       urlSpec.Append(&quot;&gt;&quot;);</span>
<a href="#l13.1039"></a><span id="l13.1039">       urlSpec.Append(uids);</span>
<a href="#l13.1040"></a><span id="l13.1040">       rv = mailNewsUrl-&gt;SetSpec(urlSpec);</span>
<a href="#l13.1041"></a><span id="l13.1041">       if (NS_SUCCEEDED(rv))</span>
<a href="#l13.1042"></a><span id="l13.1042" class="difflineminus">-        rv = GetImapConnectionAndLoadUrl(aClientEventTarget, imapUrl, nsnull, aURL);</span>
<a href="#l13.1043"></a><span id="l13.1043" class="difflineplus">+        rv = GetImapConnectionAndLoadUrl(imapUrl, nsnull, aURL);</span>
<a href="#l13.1044"></a><span id="l13.1044">     }</span>
<a href="#l13.1045"></a><span id="l13.1045">   } // if we have a url to run....</span>
<a href="#l13.1046"></a><span id="l13.1046"> </span>
<a href="#l13.1047"></a><span id="l13.1047">   return rv;</span>
<a href="#l13.1048"></a><span id="l13.1048"> }</span>
<a href="#l13.1049"></a><span id="l13.1049"> </span>
<a href="#l13.1050"></a><span id="l13.1050" class="difflineminus">-NS_IMETHODIMP nsImapService::FetchCustomMsgAttribute(nsIEventTarget *aClientEventTarget,</span>
<a href="#l13.1051"></a><span id="l13.1051" class="difflineminus">-                                                     nsIMsgFolder *anImapFolder,</span>
<a href="#l13.1052"></a><span id="l13.1052" class="difflineplus">+NS_IMETHODIMP nsImapService::FetchCustomMsgAttribute(nsIMsgFolder *anImapFolder,</span>
<a href="#l13.1053"></a><span id="l13.1053">                                                      nsIMsgWindow *aMsgWindow,</span>
<a href="#l13.1054"></a><span id="l13.1054">                                                      const nsACString &amp;aAttribute,</span>
<a href="#l13.1055"></a><span id="l13.1055">                                                      const nsACString &amp;uids,</span>
<a href="#l13.1056"></a><span id="l13.1056">                                                      nsIURI **aURL)</span>
<a href="#l13.1057"></a><span id="l13.1057"> {</span>
<a href="#l13.1058"></a><span id="l13.1058" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l13.1059"></a><span id="l13.1059">   NS_ENSURE_ARG_POINTER(anImapFolder);</span>
<a href="#l13.1060"></a><span id="l13.1060">   NS_ENSURE_ARG_POINTER(aMsgWindow);</span>
<a href="#l13.1061"></a><span id="l13.1061"> </span>
<a href="#l13.1062"></a><span id="l13.1062">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l13.1063"></a><span id="l13.1063">   nsCAutoString urlSpec;</span>
<a href="#l13.1064"></a><span id="l13.1064">   nsresult rv;</span>
<a href="#l13.1065"></a><span id="l13.1065">   char hierarchyDelimiter = GetHierarchyDelimiter(anImapFolder);</span>
<a href="#l13.1066"></a><span id="l13.1066">   rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), anImapFolder, </span>
<a href="#l13.1067"></a><span id="l13.1067" class="difflineat">@@ -3260,32 +3179,30 @@ NS_IMETHODIMP nsImapService::FetchCustom</span>
<a href="#l13.1068"></a><span id="l13.1068">       urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l13.1069"></a><span id="l13.1069">       urlSpec.Append(folderName);</span>
<a href="#l13.1070"></a><span id="l13.1070">       urlSpec.Append(&quot;&gt;&quot;);</span>
<a href="#l13.1071"></a><span id="l13.1071">       urlSpec.Append(uids);</span>
<a href="#l13.1072"></a><span id="l13.1072">       urlSpec.Append(&quot;&gt;&quot;);</span>
<a href="#l13.1073"></a><span id="l13.1073">       urlSpec.Append(aAttribute);</span>
<a href="#l13.1074"></a><span id="l13.1074">       rv = mailNewsUrl-&gt;SetSpec(urlSpec);</span>
<a href="#l13.1075"></a><span id="l13.1075">       if (NS_SUCCEEDED(rv))</span>
<a href="#l13.1076"></a><span id="l13.1076" class="difflineminus">-        rv = GetImapConnectionAndLoadUrl(aClientEventTarget, imapUrl, nsnull, aURL);</span>
<a href="#l13.1077"></a><span id="l13.1077" class="difflineplus">+        rv = GetImapConnectionAndLoadUrl(imapUrl, nsnull, aURL);</span>
<a href="#l13.1078"></a><span id="l13.1078">     }</span>
<a href="#l13.1079"></a><span id="l13.1079">   } // if we have a url to run....</span>
<a href="#l13.1080"></a><span id="l13.1080"> </span>
<a href="#l13.1081"></a><span id="l13.1081">   return rv;</span>
<a href="#l13.1082"></a><span id="l13.1082"> }</span>
<a href="#l13.1083"></a><span id="l13.1083"> </span>
<a href="#l13.1084"></a><span id="l13.1084" class="difflineminus">-NS_IMETHODIMP nsImapService::StoreCustomKeywords(nsIEventTarget *aClientEventTarget,</span>
<a href="#l13.1085"></a><span id="l13.1085" class="difflineminus">-                                                 nsIMsgFolder *anImapFolder,</span>
<a href="#l13.1086"></a><span id="l13.1086" class="difflineplus">+NS_IMETHODIMP nsImapService::StoreCustomKeywords(nsIMsgFolder *anImapFolder,</span>
<a href="#l13.1087"></a><span id="l13.1087">                                                  nsIMsgWindow *aMsgWindow,</span>
<a href="#l13.1088"></a><span id="l13.1088">                                                  const nsACString &amp;flagsToAdd,</span>
<a href="#l13.1089"></a><span id="l13.1089">                                                  const nsACString &amp;flagsToSubtract,</span>
<a href="#l13.1090"></a><span id="l13.1090">                                                  const nsACString &amp;uids,</span>
<a href="#l13.1091"></a><span id="l13.1091">                                                  nsIURI **aURL)</span>
<a href="#l13.1092"></a><span id="l13.1092"> {</span>
<a href="#l13.1093"></a><span id="l13.1093" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l13.1094"></a><span id="l13.1094">   NS_ENSURE_ARG_POINTER(anImapFolder);</span>
<a href="#l13.1095"></a><span id="l13.1095"> </span>
<a href="#l13.1096"></a><span id="l13.1096">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l13.1097"></a><span id="l13.1097">   nsCAutoString urlSpec;</span>
<a href="#l13.1098"></a><span id="l13.1098">   nsresult rv;</span>
<a href="#l13.1099"></a><span id="l13.1099">   char hierarchyDelimiter = GetHierarchyDelimiter(anImapFolder);</span>
<a href="#l13.1100"></a><span id="l13.1100">   rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), anImapFolder, nsnull, urlSpec, hierarchyDelimiter);</span>
<a href="#l13.1101"></a><span id="l13.1101"> </span>
<a href="#l13.1102"></a><span id="l13.1102" class="difflineat">@@ -3309,17 +3226,17 @@ NS_IMETHODIMP nsImapService::StoreCustom</span>
<a href="#l13.1103"></a><span id="l13.1103">       urlSpec.Append(&quot;&gt;&quot;);</span>
<a href="#l13.1104"></a><span id="l13.1104">       urlSpec.Append(uids);</span>
<a href="#l13.1105"></a><span id="l13.1105">       urlSpec.Append(&quot;&gt;&quot;);</span>
<a href="#l13.1106"></a><span id="l13.1106">       urlSpec.Append(flagsToAdd);</span>
<a href="#l13.1107"></a><span id="l13.1107">       urlSpec.Append(&quot;&gt;&quot;);</span>
<a href="#l13.1108"></a><span id="l13.1108">       urlSpec.Append(flagsToSubtract);</span>
<a href="#l13.1109"></a><span id="l13.1109">       rv = mailNewsUrl-&gt;SetSpec(urlSpec);</span>
<a href="#l13.1110"></a><span id="l13.1110">       if (NS_SUCCEEDED(rv))</span>
<a href="#l13.1111"></a><span id="l13.1111" class="difflineminus">-        rv = GetImapConnectionAndLoadUrl(aClientEventTarget, imapUrl, nsnull, aURL);</span>
<a href="#l13.1112"></a><span id="l13.1112" class="difflineplus">+        rv = GetImapConnectionAndLoadUrl(imapUrl, nsnull, aURL);</span>
<a href="#l13.1113"></a><span id="l13.1113">     }</span>
<a href="#l13.1114"></a><span id="l13.1114">   } // if we have a url to run....</span>
<a href="#l13.1115"></a><span id="l13.1115"> </span>
<a href="#l13.1116"></a><span id="l13.1116">   return rv;</span>
<a href="#l13.1117"></a><span id="l13.1117"> }</span>
<a href="#l13.1118"></a><span id="l13.1118"> </span>
<a href="#l13.1119"></a><span id="l13.1119"> </span>
<a href="#l13.1120"></a><span id="l13.1120"> NS_IMETHODIMP nsImapService::DownloadMessagesForOffline(const nsACString &amp;messageIds, </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/imap/src/nsImapService.h</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapService.h</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -90,50 +90,46 @@ protected:</span>
<a href="#l14.4"></a><span id="l14.4"> </span>
<a href="#l14.5"></a><span id="l14.5">   nsresult CreateStartOfImapUrl(const nsACString &amp;aImapURI,  // a RDF URI for the current message/folder, can be empty</span>
<a href="#l14.6"></a><span id="l14.6">                                 nsIImapUrl  **imapUrl,</span>
<a href="#l14.7"></a><span id="l14.7">                                 nsIMsgFolder *aImapFolder,</span>
<a href="#l14.8"></a><span id="l14.8">                                 nsIUrlListener *aUrlListener,</span>
<a href="#l14.9"></a><span id="l14.9">                                 nsACString &amp;urlSpec,</span>
<a href="#l14.10"></a><span id="l14.10">                                 char &amp;hierarchyDelimiter);</span>
<a href="#l14.11"></a><span id="l14.11"> </span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-  nsresult GetImapConnectionAndLoadUrl(nsIEventTarget *aClientEventTarget, </span>
<a href="#l14.13"></a><span id="l14.13" class="difflineminus">-                                       nsIImapUrl *aImapUrl,</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+  nsresult GetImapConnectionAndLoadUrl(nsIImapUrl *aImapUrl,</span>
<a href="#l14.15"></a><span id="l14.15">                                        nsISupports *aConsumer,</span>
<a href="#l14.16"></a><span id="l14.16">                                        nsIURI **aURL);</span>
<a href="#l14.17"></a><span id="l14.17"> </span>
<a href="#l14.18"></a><span id="l14.18">   nsresult SetImapUrlSink(nsIMsgFolder *aMsgFolder, nsIImapUrl *aImapUrl);</span>
<a href="#l14.19"></a><span id="l14.19"> </span>
<a href="#l14.20"></a><span id="l14.20">   nsresult FetchMimePart(nsIImapUrl *aImapUrl,</span>
<a href="#l14.21"></a><span id="l14.21">                          nsImapAction aImapAction,</span>
<a href="#l14.22"></a><span id="l14.22">                          nsIMsgFolder *aImapMailFolder, </span>
<a href="#l14.23"></a><span id="l14.23">                          nsIImapMessageSink *aImapMessage,</span>
<a href="#l14.24"></a><span id="l14.24">                          nsIURI **aURL,</span>
<a href="#l14.25"></a><span id="l14.25">                          nsISupports *aDisplayConsumer, </span>
<a href="#l14.26"></a><span id="l14.26">                          const nsACString &amp;messageIdentifierList,</span>
<a href="#l14.27"></a><span id="l14.27">                          const nsACString &amp;mimePart);</span>
<a href="#l14.28"></a><span id="l14.28"> </span>
<a href="#l14.29"></a><span id="l14.29" class="difflineminus">-  nsresult FolderCommand(nsIEventTarget *clientEventTarget, </span>
<a href="#l14.30"></a><span id="l14.30" class="difflineminus">-                         nsIMsgFolder *imapMailFolder,</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineplus">+  nsresult FolderCommand(nsIMsgFolder *imapMailFolder,</span>
<a href="#l14.32"></a><span id="l14.32">                          nsIUrlListener *urlListener,</span>
<a href="#l14.33"></a><span id="l14.33">                          const char *aCommand,</span>
<a href="#l14.34"></a><span id="l14.34">                          nsImapAction imapAction,</span>
<a href="#l14.35"></a><span id="l14.35">                          nsIMsgWindow *msgWindow,</span>
<a href="#l14.36"></a><span id="l14.36">                          nsIURI **url);</span>
<a href="#l14.37"></a><span id="l14.37"> </span>
<a href="#l14.38"></a><span id="l14.38" class="difflineminus">-  nsresult ChangeFolderSubscription(nsIEventTarget *eventTarget, </span>
<a href="#l14.39"></a><span id="l14.39" class="difflineminus">-                                    nsIMsgFolder *folder,</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineminus">-                                    const nsAString &amp;folderName, </span>
<a href="#l14.41"></a><span id="l14.41" class="difflineplus">+  nsresult ChangeFolderSubscription(nsIMsgFolder *folder,</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineplus">+                                    const nsAString &amp;folderName,</span>
<a href="#l14.43"></a><span id="l14.43">                                     const char *aCommand,</span>
<a href="#l14.44"></a><span id="l14.44">                                     nsIUrlListener *urlListener,</span>
<a href="#l14.45"></a><span id="l14.45">                                     nsIURI **url);</span>
<a href="#l14.46"></a><span id="l14.46"> </span>
<a href="#l14.47"></a><span id="l14.47" class="difflineminus">-  nsresult DiddleFlags(nsIEventTarget *aClientEventTarget,</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineminus">-                       nsIMsgFolder *aImapMailFolder, </span>
<a href="#l14.49"></a><span id="l14.49" class="difflineminus">-                       nsIUrlListener *aUrlListener, </span>
<a href="#l14.50"></a><span id="l14.50" class="difflineplus">+  nsresult DiddleFlags(nsIMsgFolder *aImapMailFolder,</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineplus">+                       nsIUrlListener *aUrlListener,</span>
<a href="#l14.52"></a><span id="l14.52">                        nsIURI **aURL,</span>
<a href="#l14.53"></a><span id="l14.53">                        const nsACString &amp;messageIdentifierList,</span>
<a href="#l14.54"></a><span id="l14.54">                        const char *howToDiddle,</span>
<a href="#l14.55"></a><span id="l14.55">                        imapMessageFlagsType flags,</span>
<a href="#l14.56"></a><span id="l14.56">                        bool messageIdsAreUID);</span>
<a href="#l14.57"></a><span id="l14.57"> </span>
<a href="#l14.58"></a><span id="l14.58">   nsresult OfflineAppendFromFile(nsIFile *aFile,</span>
<a href="#l14.59"></a><span id="l14.59">                                  nsIURI *aUrl,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/imap/src/nsImapUndoTxn.cpp</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapUndoTxn.cpp</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -55,27 +55,25 @@</span>
<a href="#l15.4"></a><span id="l15.4"> nsImapMoveCopyMsgTxn::nsImapMoveCopyMsgTxn() :</span>
<a href="#l15.5"></a><span id="l15.5">     m_idsAreUids(false), m_isMove(false), m_srcIsPop3(false)</span>
<a href="#l15.6"></a><span id="l15.6"> {</span>
<a href="#l15.7"></a><span id="l15.7"> }</span>
<a href="#l15.8"></a><span id="l15.8"> </span>
<a href="#l15.9"></a><span id="l15.9"> nsresult</span>
<a href="#l15.10"></a><span id="l15.10"> nsImapMoveCopyMsgTxn::Init(nsIMsgFolder* srcFolder, nsTArray&lt;nsMsgKey&gt;* srcKeyArray, </span>
<a href="#l15.11"></a><span id="l15.11">                            const char* srcMsgIdString, nsIMsgFolder* dstFolder,</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-                           bool idsAreUids, bool isMove,</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineminus">-                           nsIEventTarget* eventTarget)</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineplus">+                           bool idsAreUids, bool isMove)</span>
<a href="#l15.15"></a><span id="l15.15"> {</span>
<a href="#l15.16"></a><span id="l15.16">   nsresult rv;</span>
<a href="#l15.17"></a><span id="l15.17">   m_srcHdrs = do_CreateInstance(NS_SUPPORTSARRAY_CONTRACTID);</span>
<a href="#l15.18"></a><span id="l15.18">   m_srcMsgIdString = srcMsgIdString;</span>
<a href="#l15.19"></a><span id="l15.19">   m_idsAreUids = idsAreUids;</span>
<a href="#l15.20"></a><span id="l15.20">   m_isMove = isMove;</span>
<a href="#l15.21"></a><span id="l15.21">   m_srcFolder = do_GetWeakReference(srcFolder);</span>
<a href="#l15.22"></a><span id="l15.22">   m_dstFolder = do_GetWeakReference(dstFolder);</span>
<a href="#l15.23"></a><span id="l15.23" class="difflineminus">-  m_eventTarget = eventTarget;</span>
<a href="#l15.24"></a><span id="l15.24">   m_srcKeyArray = *srcKeyArray;</span>
<a href="#l15.25"></a><span id="l15.25">   m_dupKeyArray = *srcKeyArray;</span>
<a href="#l15.26"></a><span id="l15.26">   nsCString uri;</span>
<a href="#l15.27"></a><span id="l15.27">   rv = srcFolder-&gt;GetURI(uri);</span>
<a href="#l15.28"></a><span id="l15.28">   nsCString protocolType(uri);</span>
<a href="#l15.29"></a><span id="l15.29">   protocolType.SetLength(protocolType.FindChar(':'));</span>
<a href="#l15.30"></a><span id="l15.30">   nsCOMPtr&lt;nsIMsgDatabase&gt; srcDB;</span>
<a href="#l15.31"></a><span id="l15.31">   rv = srcFolder-&gt;GetMsgDatabase(getter_AddRefs(srcDB));</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineat">@@ -150,18 +148,17 @@ nsImapMoveCopyMsgTxn::UndoTransaction(vo</span>
<a href="#l15.33"></a><span id="l15.33">         return rv;</span>
<a href="#l15.34"></a><span id="l15.34">       nsCOMPtr&lt;nsIUrlListener&gt; srcListener = do_QueryInterface(srcFolder, &amp;rv);</span>
<a href="#l15.35"></a><span id="l15.35">       if (NS_FAILED(rv)) </span>
<a href="#l15.36"></a><span id="l15.36">         return rv;</span>
<a href="#l15.37"></a><span id="l15.37">       m_onStopListener =   do_GetWeakReference(srcListener);</span>
<a href="#l15.38"></a><span id="l15.38"> </span>
<a href="#l15.39"></a><span id="l15.39">       // ** make sure we are in the selected state; use lite select</span>
<a href="#l15.40"></a><span id="l15.40">       // folder so we won't hit performance hard</span>
<a href="#l15.41"></a><span id="l15.41" class="difflineminus">-      rv = imapService-&gt;LiteSelectFolder(m_eventTarget, srcFolder,</span>
<a href="#l15.42"></a><span id="l15.42" class="difflineminus">-        srcListener, nsnull, nsnull);</span>
<a href="#l15.43"></a><span id="l15.43" class="difflineplus">+      rv = imapService-&gt;LiteSelectFolder(srcFolder, srcListener, nsnull, nsnull);</span>
<a href="#l15.44"></a><span id="l15.44">       if (NS_FAILED(rv)) </span>
<a href="#l15.45"></a><span id="l15.45">         return rv;</span>
<a href="#l15.46"></a><span id="l15.46">       bool deletedMsgs = true; //default is true unless imapDelete model</span>
<a href="#l15.47"></a><span id="l15.47">       nsMsgImapDeleteModel deleteModel;</span>
<a href="#l15.48"></a><span id="l15.48">       rv = GetImapDeleteModel(srcFolder, &amp;deleteModel);</span>
<a href="#l15.49"></a><span id="l15.49"> </span>
<a href="#l15.50"></a><span id="l15.50">       // protect against a bogus undo txn without any source keys</span>
<a href="#l15.51"></a><span id="l15.51">       // see bug #179856 for details</span>
<a href="#l15.52"></a><span id="l15.52" class="difflineat">@@ -170,53 +167,53 @@ nsImapMoveCopyMsgTxn::UndoTransaction(vo</span>
<a href="#l15.53"></a><span id="l15.53">         return NS_ERROR_UNEXPECTED;</span>
<a href="#l15.54"></a><span id="l15.54"> </span>
<a href="#l15.55"></a><span id="l15.55">       if (!m_srcMsgIdString.IsEmpty())</span>
<a href="#l15.56"></a><span id="l15.56">       {</span>
<a href="#l15.57"></a><span id="l15.57">         if (NS_SUCCEEDED(rv) &amp;&amp; deleteModel == nsMsgImapDeleteModels::IMAPDelete)</span>
<a href="#l15.58"></a><span id="l15.58">           CheckForToggleDelete(srcFolder, m_srcKeyArray[0], &amp;deletedMsgs);</span>
<a href="#l15.59"></a><span id="l15.59"> </span>
<a href="#l15.60"></a><span id="l15.60">         if (deletedMsgs)</span>
<a href="#l15.61"></a><span id="l15.61" class="difflineminus">-          rv = imapService-&gt;SubtractMessageFlags(m_eventTarget, srcFolder, </span>
<a href="#l15.62"></a><span id="l15.62" class="difflineplus">+          rv = imapService-&gt;SubtractMessageFlags(srcFolder,</span>
<a href="#l15.63"></a><span id="l15.63">                                                  this, nsnull,</span>
<a href="#l15.64"></a><span id="l15.64">                                                  m_srcMsgIdString, </span>
<a href="#l15.65"></a><span id="l15.65">                                                  kImapMsgDeletedFlag,</span>
<a href="#l15.66"></a><span id="l15.66">                                                  m_idsAreUids);</span>
<a href="#l15.67"></a><span id="l15.67">         else</span>
<a href="#l15.68"></a><span id="l15.68" class="difflineminus">-          rv = imapService-&gt;AddMessageFlags(m_eventTarget, srcFolder,</span>
<a href="#l15.69"></a><span id="l15.69" class="difflineplus">+          rv = imapService-&gt;AddMessageFlags(srcFolder,</span>
<a href="#l15.70"></a><span id="l15.70">                                             srcListener, nsnull,</span>
<a href="#l15.71"></a><span id="l15.71">                                             m_srcMsgIdString,</span>
<a href="#l15.72"></a><span id="l15.72">                                             kImapMsgDeletedFlag,</span>
<a href="#l15.73"></a><span id="l15.73">                                             m_idsAreUids);</span>
<a href="#l15.74"></a><span id="l15.74">         if (NS_FAILED(rv)) </span>
<a href="#l15.75"></a><span id="l15.75">           return rv;</span>
<a href="#l15.76"></a><span id="l15.76"> </span>
<a href="#l15.77"></a><span id="l15.77">         finishInOnStopRunningUrl = true;</span>
<a href="#l15.78"></a><span id="l15.78">         if (deleteModel != nsMsgImapDeleteModels::IMAPDelete)</span>
<a href="#l15.79"></a><span id="l15.79" class="difflineminus">-          rv = imapService-&gt;GetHeaders(m_eventTarget, srcFolder,</span>
<a href="#l15.80"></a><span id="l15.80" class="difflineminus">-                                srcListener, nsnull, m_srcMsgIdString, true);</span>
<a href="#l15.81"></a><span id="l15.81" class="difflineplus">+          rv = imapService-&gt;GetHeaders(srcFolder, srcListener, nsnull,</span>
<a href="#l15.82"></a><span id="l15.82" class="difflineplus">+                                       m_srcMsgIdString, true);</span>
<a href="#l15.83"></a><span id="l15.83">       }</span>
<a href="#l15.84"></a><span id="l15.84">     }</span>
<a href="#l15.85"></a><span id="l15.85">   }</span>
<a href="#l15.86"></a><span id="l15.86">   if (!finishInOnStopRunningUrl &amp;&amp; !m_dstMsgIdString.IsEmpty())</span>
<a href="#l15.87"></a><span id="l15.87">   {</span>
<a href="#l15.88"></a><span id="l15.88">     nsCOMPtr&lt;nsIMsgFolder&gt; dstFolder = do_QueryReferent(m_dstFolder, &amp;rv);</span>
<a href="#l15.89"></a><span id="l15.89">     if (NS_FAILED(rv) || !dstFolder)</span>
<a href="#l15.90"></a><span id="l15.90">       return rv;</span>
<a href="#l15.91"></a><span id="l15.91"> </span>
<a href="#l15.92"></a><span id="l15.92">     nsCOMPtr&lt;nsIUrlListener&gt; dstListener;</span>
<a href="#l15.93"></a><span id="l15.93"> </span>
<a href="#l15.94"></a><span id="l15.94">     dstListener = do_QueryInterface(dstFolder, &amp;rv);</span>
<a href="#l15.95"></a><span id="l15.95">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.96"></a><span id="l15.96">     // ** make sure we are in the selected state; use lite select folder</span>
<a href="#l15.97"></a><span id="l15.97">     // so we won't potentially download a bunch of headers.</span>
<a href="#l15.98"></a><span id="l15.98" class="difflineminus">-    rv = imapService-&gt;LiteSelectFolder(m_eventTarget, dstFolder,</span>
<a href="#l15.99"></a><span id="l15.99" class="difflineplus">+    rv = imapService-&gt;LiteSelectFolder(dstFolder,</span>
<a href="#l15.100"></a><span id="l15.100">       dstListener, nsnull, nsnull);</span>
<a href="#l15.101"></a><span id="l15.101">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.102"></a><span id="l15.102" class="difflineminus">-    rv = imapService-&gt;AddMessageFlags(m_eventTarget, dstFolder, dstListener,</span>
<a href="#l15.103"></a><span id="l15.103" class="difflineplus">+    rv = imapService-&gt;AddMessageFlags(dstFolder, dstListener,</span>
<a href="#l15.104"></a><span id="l15.104">                                       nsnull, m_dstMsgIdString, </span>
<a href="#l15.105"></a><span id="l15.105">                                       kImapMsgDeletedFlag, m_idsAreUids);</span>
<a href="#l15.106"></a><span id="l15.106">   }</span>
<a href="#l15.107"></a><span id="l15.107">   return rv;</span>
<a href="#l15.108"></a><span id="l15.108"> }</span>
<a href="#l15.109"></a><span id="l15.109"> </span>
<a href="#l15.110"></a><span id="l15.110"> NS_IMETHODIMP</span>
<a href="#l15.111"></a><span id="l15.111"> nsImapMoveCopyMsgTxn::RedoTransaction(void)</span>
<a href="#l15.112"></a><span id="l15.112" class="difflineat">@@ -250,60 +247,58 @@ nsImapMoveCopyMsgTxn::RedoTransaction(vo</span>
<a href="#l15.113"></a><span id="l15.113">       if (m_srcKeyArray.IsEmpty())</span>
<a href="#l15.114"></a><span id="l15.114">         return NS_ERROR_UNEXPECTED;</span>
<a href="#l15.115"></a><span id="l15.115">       </span>
<a href="#l15.116"></a><span id="l15.116">       if (NS_SUCCEEDED(rv) &amp;&amp; deleteModel == nsMsgImapDeleteModels::IMAPDelete)</span>
<a href="#l15.117"></a><span id="l15.117">         rv = CheckForToggleDelete(srcFolder, m_srcKeyArray[0], &amp;deletedMsgs);</span>
<a href="#l15.118"></a><span id="l15.118">       </span>
<a href="#l15.119"></a><span id="l15.119">       // Make sure we are in the selected state; use lite select</span>
<a href="#l15.120"></a><span id="l15.120">       // folder so performance won't suffer.</span>
<a href="#l15.121"></a><span id="l15.121" class="difflineminus">-      rv = imapService-&gt;LiteSelectFolder(m_eventTarget, srcFolder,</span>
<a href="#l15.122"></a><span id="l15.122" class="difflineminus">-        srcListener, nsnull, nsnull);</span>
<a href="#l15.123"></a><span id="l15.123" class="difflineplus">+      rv = imapService-&gt;LiteSelectFolder(srcFolder, srcListener, nsnull, nsnull);</span>
<a href="#l15.124"></a><span id="l15.124">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.125"></a><span id="l15.125">       if (deletedMsgs)</span>
<a href="#l15.126"></a><span id="l15.126">       {</span>
<a href="#l15.127"></a><span id="l15.127" class="difflineminus">-        rv = imapService-&gt;SubtractMessageFlags(m_eventTarget, srcFolder,</span>
<a href="#l15.128"></a><span id="l15.128" class="difflineminus">-                                                srcListener, nsnull,</span>
<a href="#l15.129"></a><span id="l15.129" class="difflineminus">-                                                m_srcMsgIdString,</span>
<a href="#l15.130"></a><span id="l15.130" class="difflineminus">-                                                kImapMsgDeletedFlag,</span>
<a href="#l15.131"></a><span id="l15.131" class="difflineminus">-                                                m_idsAreUids);</span>
<a href="#l15.132"></a><span id="l15.132" class="difflineplus">+        rv = imapService-&gt;SubtractMessageFlags(srcFolder,</span>
<a href="#l15.133"></a><span id="l15.133" class="difflineplus">+                                               srcListener, nsnull,</span>
<a href="#l15.134"></a><span id="l15.134" class="difflineplus">+                                               m_srcMsgIdString,</span>
<a href="#l15.135"></a><span id="l15.135" class="difflineplus">+                                               kImapMsgDeletedFlag,</span>
<a href="#l15.136"></a><span id="l15.136" class="difflineplus">+                                               m_idsAreUids);</span>
<a href="#l15.137"></a><span id="l15.137">       }</span>
<a href="#l15.138"></a><span id="l15.138">       else</span>
<a href="#l15.139"></a><span id="l15.139">       {</span>
<a href="#l15.140"></a><span id="l15.140" class="difflineminus">-        rv = imapService-&gt;AddMessageFlags(m_eventTarget, srcFolder,</span>
<a href="#l15.141"></a><span id="l15.141" class="difflineplus">+        rv = imapService-&gt;AddMessageFlags(srcFolder,</span>
<a href="#l15.142"></a><span id="l15.142">                                           srcListener, nsnull, m_srcMsgIdString,</span>
<a href="#l15.143"></a><span id="l15.143">                                           kImapMsgDeletedFlag, m_idsAreUids);</span>
<a href="#l15.144"></a><span id="l15.144">       }</span>
<a href="#l15.145"></a><span id="l15.145">     }</span>
<a href="#l15.146"></a><span id="l15.146">   }</span>
<a href="#l15.147"></a><span id="l15.147">   if (!m_dstMsgIdString.IsEmpty())</span>
<a href="#l15.148"></a><span id="l15.148">   {</span>
<a href="#l15.149"></a><span id="l15.149">     nsCOMPtr&lt;nsIMsgFolder&gt; dstFolder = do_QueryReferent(m_dstFolder, &amp;rv);</span>
<a href="#l15.150"></a><span id="l15.150">     if (NS_FAILED(rv) || !dstFolder) return rv;</span>
<a href="#l15.151"></a><span id="l15.151"> </span>
<a href="#l15.152"></a><span id="l15.152">     nsCOMPtr&lt;nsIUrlListener&gt; dstListener;</span>
<a href="#l15.153"></a><span id="l15.153"> </span>
<a href="#l15.154"></a><span id="l15.154">     dstListener = do_QueryInterface(dstFolder, &amp;rv); </span>
<a href="#l15.155"></a><span id="l15.155">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.156"></a><span id="l15.156">     // ** make sure we are in the selected state; use lite select</span>
<a href="#l15.157"></a><span id="l15.157">     // folder so we won't hit performance hard</span>
<a href="#l15.158"></a><span id="l15.158" class="difflineminus">-    rv = imapService-&gt;LiteSelectFolder(m_eventTarget, dstFolder,</span>
<a href="#l15.159"></a><span id="l15.159" class="difflineminus">-      dstListener, nsnull, nsnull);</span>
<a href="#l15.160"></a><span id="l15.160" class="difflineplus">+    rv = imapService-&gt;LiteSelectFolder(dstFolder, dstListener, nsnull, nsnull);</span>
<a href="#l15.161"></a><span id="l15.161">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.162"></a><span id="l15.162" class="difflineminus">-    rv = imapService-&gt;SubtractMessageFlags(m_eventTarget, dstFolder,</span>
<a href="#l15.163"></a><span id="l15.163" class="difflineminus">-                                           dstListener, nsnull, </span>
<a href="#l15.164"></a><span id="l15.164" class="difflineplus">+    rv = imapService-&gt;SubtractMessageFlags(dstFolder,</span>
<a href="#l15.165"></a><span id="l15.165" class="difflineplus">+                                           dstListener, nsnull,</span>
<a href="#l15.166"></a><span id="l15.166">                                            m_dstMsgIdString,</span>
<a href="#l15.167"></a><span id="l15.167">                                            kImapMsgDeletedFlag,</span>
<a href="#l15.168"></a><span id="l15.168">                                            m_idsAreUids);</span>
<a href="#l15.169"></a><span id="l15.169">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.170"></a><span id="l15.170">     nsMsgImapDeleteModel deleteModel;</span>
<a href="#l15.171"></a><span id="l15.171">     rv = GetImapDeleteModel(dstFolder, &amp;deleteModel);</span>
<a href="#l15.172"></a><span id="l15.172">     if (NS_FAILED(rv) || deleteModel == nsMsgImapDeleteModels::MoveToTrash)</span>
<a href="#l15.173"></a><span id="l15.173">     {</span>
<a href="#l15.174"></a><span id="l15.174" class="difflineminus">-      rv = imapService-&gt;GetHeaders(m_eventTarget, dstFolder, dstListener, </span>
<a href="#l15.175"></a><span id="l15.175" class="difflineplus">+      rv = imapService-&gt;GetHeaders(dstFolder, dstListener, </span>
<a href="#l15.176"></a><span id="l15.176">                                    nsnull, m_dstMsgIdString, true);</span>
<a href="#l15.177"></a><span id="l15.177">     }</span>
<a href="#l15.178"></a><span id="l15.178">   }</span>
<a href="#l15.179"></a><span id="l15.179">   return rv;</span>
<a href="#l15.180"></a><span id="l15.180"> }</span>
<a href="#l15.181"></a><span id="l15.181"> </span>
<a href="#l15.182"></a><span id="l15.182"> nsresult</span>
<a href="#l15.183"></a><span id="l15.183"> nsImapMoveCopyMsgTxn::SetCopyResponseUid(const char* aMsgIdString)</span>
<a href="#l15.184"></a><span id="l15.184" class="difflineat">@@ -450,26 +445,25 @@ NS_IMETHODIMP nsImapMoveCopyMsgTxn::OnSt</span>
<a href="#l15.185"></a><span id="l15.185">     {</span>
<a href="#l15.186"></a><span id="l15.186">       PRInt32 extraStatus;</span>
<a href="#l15.187"></a><span id="l15.187">       imapUrl-&gt;GetExtraStatus(&amp;extraStatus);</span>
<a href="#l15.188"></a><span id="l15.188">       if (extraStatus != nsIImapUrl::ImapStatusNone)</span>
<a href="#l15.189"></a><span id="l15.189">       {</span>
<a href="#l15.190"></a><span id="l15.190">         // If subtracting the deleted flag didn't work, try</span>
<a href="#l15.191"></a><span id="l15.191">         // moving the message back from the target folder to the src folder</span>
<a href="#l15.192"></a><span id="l15.192">         if (!m_dstMsgIdString.IsEmpty())</span>
<a href="#l15.193"></a><span id="l15.193" class="difflineminus">-          imapService-&gt;OnlineMessageCopy(m_eventTarget,</span>
<a href="#l15.194"></a><span id="l15.194" class="difflineminus">-                                       dstFolder,</span>
<a href="#l15.195"></a><span id="l15.195" class="difflineminus">-                                       m_dstMsgIdString,</span>
<a href="#l15.196"></a><span id="l15.196" class="difflineminus">-                                       srcFolder,</span>
<a href="#l15.197"></a><span id="l15.197" class="difflineminus">-                                       true,</span>
<a href="#l15.198"></a><span id="l15.198" class="difflineminus">-                                       true,</span>
<a href="#l15.199"></a><span id="l15.199" class="difflineminus">-                                       nsnull, /* listener */</span>
<a href="#l15.200"></a><span id="l15.200" class="difflineminus">-                                       nsnull,</span>
<a href="#l15.201"></a><span id="l15.201" class="difflineminus">-                                       nsnull,</span>
<a href="#l15.202"></a><span id="l15.202" class="difflineminus">-                                       nsnull);</span>
<a href="#l15.203"></a><span id="l15.203" class="difflineplus">+          imapService-&gt;OnlineMessageCopy(dstFolder,</span>
<a href="#l15.204"></a><span id="l15.204" class="difflineplus">+                                         m_dstMsgIdString,</span>
<a href="#l15.205"></a><span id="l15.205" class="difflineplus">+                                         srcFolder,</span>
<a href="#l15.206"></a><span id="l15.206" class="difflineplus">+                                         true,</span>
<a href="#l15.207"></a><span id="l15.207" class="difflineplus">+                                         true,</span>
<a href="#l15.208"></a><span id="l15.208" class="difflineplus">+                                         nsnull, /* listener */</span>
<a href="#l15.209"></a><span id="l15.209" class="difflineplus">+                                         nsnull,</span>
<a href="#l15.210"></a><span id="l15.210" class="difflineplus">+                                         nsnull,</span>
<a href="#l15.211"></a><span id="l15.211" class="difflineplus">+                                         nsnull);</span>
<a href="#l15.212"></a><span id="l15.212">         else</span>
<a href="#l15.213"></a><span id="l15.213">         {</span>
<a href="#l15.214"></a><span id="l15.214">           // server doesn't support COPYUID, so we're going to update the dest</span>
<a href="#l15.215"></a><span id="l15.215">           // folder, and when that's done, use the db to find the messages</span>
<a href="#l15.216"></a><span id="l15.216">           // to move back, looking them up by message-id.</span>
<a href="#l15.217"></a><span id="l15.217">           nsCOMPtr&lt;nsIMsgImapMailFolder&gt; imapDest = do_QueryInterface(dstFolder);</span>
<a href="#l15.218"></a><span id="l15.218">           if (imapDest)</span>
<a href="#l15.219"></a><span id="l15.219">             imapDest-&gt;UpdateFolderWithListener(nsnull, this);</span>
<a href="#l15.220"></a><span id="l15.220" class="difflineat">@@ -478,21 +472,20 @@ NS_IMETHODIMP nsImapMoveCopyMsgTxn::OnSt</span>
<a href="#l15.221"></a><span id="l15.221">       else if (!m_dstMsgIdString.IsEmpty())</span>
<a href="#l15.222"></a><span id="l15.222">       {</span>
<a href="#l15.223"></a><span id="l15.223">         nsCOMPtr&lt;nsIUrlListener&gt; dstListener;</span>
<a href="#l15.224"></a><span id="l15.224"> </span>
<a href="#l15.225"></a><span id="l15.225">         dstListener = do_QueryInterface(dstFolder, &amp;rv);</span>
<a href="#l15.226"></a><span id="l15.226">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.227"></a><span id="l15.227">         // ** make sure we are in the selected state; use lite select folder</span>
<a href="#l15.228"></a><span id="l15.228">         // so we won't potentially download a bunch of headers.</span>
<a href="#l15.229"></a><span id="l15.229" class="difflineminus">-        rv = imapService-&gt;LiteSelectFolder(m_eventTarget, dstFolder,</span>
<a href="#l15.230"></a><span id="l15.230" class="difflineminus">-          dstListener, nsnull, nsnull);</span>
<a href="#l15.231"></a><span id="l15.231" class="difflineplus">+        rv = imapService-&gt;LiteSelectFolder(dstFolder, dstListener, nsnull, nsnull);</span>
<a href="#l15.232"></a><span id="l15.232">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.233"></a><span id="l15.233" class="difflineminus">-        rv = imapService-&gt;AddMessageFlags(m_eventTarget, dstFolder, dstListener,</span>
<a href="#l15.234"></a><span id="l15.234" class="difflineminus">-                                          nsnull, m_dstMsgIdString, </span>
<a href="#l15.235"></a><span id="l15.235" class="difflineplus">+        rv = imapService-&gt;AddMessageFlags(dstFolder, dstListener,</span>
<a href="#l15.236"></a><span id="l15.236" class="difflineplus">+                                          nsnull, m_dstMsgIdString,</span>
<a href="#l15.237"></a><span id="l15.237">                                           kImapMsgDeletedFlag, m_idsAreUids);</span>
<a href="#l15.238"></a><span id="l15.238">       }</span>
<a href="#l15.239"></a><span id="l15.239">     }</span>
<a href="#l15.240"></a><span id="l15.240">     else if (imapAction == nsIImapUrl::nsImapSelectFolder)</span>
<a href="#l15.241"></a><span id="l15.241">     {</span>
<a href="#l15.242"></a><span id="l15.242">       // Now we should have the headers from the dest folder.</span>
<a href="#l15.243"></a><span id="l15.243">       // Look them up and move them back to the source folder.</span>
<a href="#l15.244"></a><span id="l15.244">       PRUint32 count = m_srcMessageIds.Length();</span>
<a href="#l15.245"></a><span id="l15.245" class="difflineat">@@ -513,33 +506,32 @@ NS_IMETHODIMP nsImapMoveCopyMsgTxn::OnSt</span>
<a href="#l15.246"></a><span id="l15.246">           dstHdr-&gt;GetMessageKey(&amp;dstKey);</span>
<a href="#l15.247"></a><span id="l15.247">           dstKeys.AppendElement(dstKey);</span>
<a href="#l15.248"></a><span id="l15.248">         }</span>
<a href="#l15.249"></a><span id="l15.249">       }</span>
<a href="#l15.250"></a><span id="l15.250">       if (dstKeys.Length())</span>
<a href="#l15.251"></a><span id="l15.251">       {</span>
<a href="#l15.252"></a><span id="l15.252">         nsCAutoString uids;</span>
<a href="#l15.253"></a><span id="l15.253">         nsImapMailFolder::AllocateUidStringFromKeys(dstKeys.Elements(), dstKeys.Length(), uids);</span>
<a href="#l15.254"></a><span id="l15.254" class="difflineminus">-        rv = imapService-&gt;OnlineMessageCopy(m_eventTarget, dstFolder, uids, srcFolder,</span>
<a href="#l15.255"></a><span id="l15.255" class="difflineplus">+        rv = imapService-&gt;OnlineMessageCopy(dstFolder, uids, srcFolder,</span>
<a href="#l15.256"></a><span id="l15.256">                                             true, true, nsnull,</span>
<a href="#l15.257"></a><span id="l15.257">                                             nsnull, nsnull, nsnull);</span>
<a href="#l15.258"></a><span id="l15.258">       }</span>
<a href="#l15.259"></a><span id="l15.259">     }</span>
<a href="#l15.260"></a><span id="l15.260">   }</span>
<a href="#l15.261"></a><span id="l15.261">   return NS_OK;</span>
<a href="#l15.262"></a><span id="l15.262"> }</span>
<a href="#l15.263"></a><span id="l15.263"> </span>
<a href="#l15.264"></a><span id="l15.264"> nsImapOfflineTxn::nsImapOfflineTxn(nsIMsgFolder* srcFolder, nsTArray&lt;nsMsgKey&gt;* srcKeyArray,</span>
<a href="#l15.265"></a><span id="l15.265">                                    const char *srcMsgIdString, nsIMsgFolder* dstFolder,</span>
<a href="#l15.266"></a><span id="l15.266">                                    bool isMove, nsOfflineImapOperationType opType,</span>
<a href="#l15.267"></a><span id="l15.267" class="difflineminus">-                                   nsIMsgDBHdr *srcHdr,</span>
<a href="#l15.268"></a><span id="l15.268" class="difflineminus">-                                   nsIEventTarget* eventTarget)</span>
<a href="#l15.269"></a><span id="l15.269" class="difflineplus">+                                   nsIMsgDBHdr *srcHdr)</span>
<a href="#l15.270"></a><span id="l15.270"> {</span>
<a href="#l15.271"></a><span id="l15.271">   Init(srcFolder, srcKeyArray, srcMsgIdString, dstFolder, true,</span>
<a href="#l15.272"></a><span id="l15.272" class="difflineminus">-       isMove, eventTarget);</span>
<a href="#l15.273"></a><span id="l15.273" class="difflineplus">+       isMove);</span>
<a href="#l15.274"></a><span id="l15.274"> </span>
<a href="#l15.275"></a><span id="l15.275">   m_opType = opType; </span>
<a href="#l15.276"></a><span id="l15.276">   m_flags = 0;</span>
<a href="#l15.277"></a><span id="l15.277">   m_addFlags = false;</span>
<a href="#l15.278"></a><span id="l15.278">   m_header = srcHdr;</span>
<a href="#l15.279"></a><span id="l15.279">   if (opType == nsIMsgOfflineImapOperation::kDeletedMsg)</span>
<a href="#l15.280"></a><span id="l15.280">   {</span>
<a href="#l15.281"></a><span id="l15.281">     nsCOMPtr &lt;nsIMsgDatabase&gt; srcDB;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/imap/src/nsImapUndoTxn.h</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapUndoTxn.h</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -38,33 +38,31 @@</span>
<a href="#l16.4"></a><span id="l16.4"> #ifndef nsImapUndoTxn_h__</span>
<a href="#l16.5"></a><span id="l16.5"> #define nsImapUndoTxn_h__</span>
<a href="#l16.6"></a><span id="l16.6"> </span>
<a href="#l16.7"></a><span id="l16.7"> #include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l16.8"></a><span id="l16.8"> #include &quot;nsImapCore.h&quot;</span>
<a href="#l16.9"></a><span id="l16.9"> #include &quot;nsIImapService.h&quot;</span>
<a href="#l16.10"></a><span id="l16.10"> #include &quot;nsIImapIncomingServer.h&quot;</span>
<a href="#l16.11"></a><span id="l16.11"> #include &quot;nsIUrlListener.h&quot;</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-#include &quot;nsIEventTarget.h&quot;</span>
<a href="#l16.13"></a><span id="l16.13"> #include &quot;nsMsgTxn.h&quot;</span>
<a href="#l16.14"></a><span id="l16.14"> #include &quot;MailNewsTypes.h&quot;</span>
<a href="#l16.15"></a><span id="l16.15"> #include &quot;nsTArray.h&quot;</span>
<a href="#l16.16"></a><span id="l16.16"> #include &quot;nsIMsgOfflineImapOperation.h&quot;</span>
<a href="#l16.17"></a><span id="l16.17"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l16.18"></a><span id="l16.18"> #include &quot;nsWeakReference.h&quot;</span>
<a href="#l16.19"></a><span id="l16.19"> </span>
<a href="#l16.20"></a><span id="l16.20"> class nsImapMoveCopyMsgTxn : public nsMsgTxn, nsIUrlListener</span>
<a href="#l16.21"></a><span id="l16.21"> {</span>
<a href="#l16.22"></a><span id="l16.22"> public:</span>
<a href="#l16.23"></a><span id="l16.23"> </span>
<a href="#l16.24"></a><span id="l16.24">   nsImapMoveCopyMsgTxn();</span>
<a href="#l16.25"></a><span id="l16.25">   nsImapMoveCopyMsgTxn(nsIMsgFolder* srcFolder, nsTArray&lt;nsMsgKey&gt;* srcKeyArray,</span>
<a href="#l16.26"></a><span id="l16.26">                        const char* srcMsgIdString, nsIMsgFolder* dstFolder,</span>
<a href="#l16.27"></a><span id="l16.27" class="difflineminus">-                       bool isMove, </span>
<a href="#l16.28"></a><span id="l16.28" class="difflineminus">-                       nsIEventTarget *eventTarget);</span>
<a href="#l16.29"></a><span id="l16.29" class="difflineplus">+                       bool isMove);</span>
<a href="#l16.30"></a><span id="l16.30">   virtual ~nsImapMoveCopyMsgTxn();</span>
<a href="#l16.31"></a><span id="l16.31"> </span>
<a href="#l16.32"></a><span id="l16.32">   NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l16.33"></a><span id="l16.33">   NS_DECL_NSIURLLISTENER</span>
<a href="#l16.34"></a><span id="l16.34"> </span>
<a href="#l16.35"></a><span id="l16.35">   NS_IMETHOD UndoTransaction(void);</span>
<a href="#l16.36"></a><span id="l16.36">   NS_IMETHOD RedoTransaction(void);</span>
<a href="#l16.37"></a><span id="l16.37"> </span>
<a href="#l16.38"></a><span id="l16.38" class="difflineat">@@ -72,51 +70,48 @@ public:</span>
<a href="#l16.39"></a><span id="l16.39">   nsresult SetCopyResponseUid(const char *msgIdString);</span>
<a href="#l16.40"></a><span id="l16.40">   nsresult GetSrcKeyArray(nsTArray&lt;nsMsgKey&gt;&amp; srcKeyArray);</span>
<a href="#l16.41"></a><span id="l16.41">   void GetSrcMsgIds(nsCString &amp;srcMsgIds) {srcMsgIds = m_srcMsgIdString;}</span>
<a href="#l16.42"></a><span id="l16.42">   nsresult AddDstKey(nsMsgKey aKey);</span>
<a href="#l16.43"></a><span id="l16.43">   nsresult UndoMailboxDelete();</span>
<a href="#l16.44"></a><span id="l16.44">   nsresult RedoMailboxDelete();</span>
<a href="#l16.45"></a><span id="l16.45">   nsresult Init(nsIMsgFolder* srcFolder, nsTArray&lt;nsMsgKey&gt;* srcKeyArray,</span>
<a href="#l16.46"></a><span id="l16.46">                 const char* srcMsgIdString, nsIMsgFolder* dstFolder,</span>
<a href="#l16.47"></a><span id="l16.47" class="difflineminus">-                bool idsAreUids, bool isMove, </span>
<a href="#l16.48"></a><span id="l16.48" class="difflineminus">-                nsIEventTarget *eventTarget);</span>
<a href="#l16.49"></a><span id="l16.49" class="difflineplus">+                bool idsAreUids, bool isMove);</span>
<a href="#l16.50"></a><span id="l16.50"> </span>
<a href="#l16.51"></a><span id="l16.51"> protected:</span>
<a href="#l16.52"></a><span id="l16.52"> </span>
<a href="#l16.53"></a><span id="l16.53">   nsWeakPtr m_srcFolder;</span>
<a href="#l16.54"></a><span id="l16.54">   nsCOMPtr&lt;nsISupportsArray&gt; m_srcHdrs;</span>
<a href="#l16.55"></a><span id="l16.55">   nsTArray&lt;nsMsgKey&gt; m_dupKeyArray;</span>
<a href="#l16.56"></a><span id="l16.56">   nsTArray&lt;nsMsgKey&gt; m_srcKeyArray;</span>
<a href="#l16.57"></a><span id="l16.57">   nsTArray&lt;nsCString&gt; m_srcMessageIds;</span>
<a href="#l16.58"></a><span id="l16.58">   nsCString m_srcMsgIdString;</span>
<a href="#l16.59"></a><span id="l16.59">   nsWeakPtr m_dstFolder;</span>
<a href="#l16.60"></a><span id="l16.60">   nsCString m_dstMsgIdString;</span>
<a href="#l16.61"></a><span id="l16.61" class="difflineminus">-  nsCOMPtr&lt;nsIEventTarget&gt; m_eventTarget;</span>
<a href="#l16.62"></a><span id="l16.62">   bool m_idsAreUids;</span>
<a href="#l16.63"></a><span id="l16.63">   bool m_isMove;</span>
<a href="#l16.64"></a><span id="l16.64">   bool m_srcIsPop3;</span>
<a href="#l16.65"></a><span id="l16.65">   nsTArray&lt;PRUint32&gt; m_srcSizeArray;</span>
<a href="#l16.66"></a><span id="l16.66">   // this is used when we chain urls for imap undo, since &quot;this&quot; needs</span>
<a href="#l16.67"></a><span id="l16.67">   // to be the listener, but the folder may need to also be notified.</span>
<a href="#l16.68"></a><span id="l16.68">   nsWeakPtr m_onStopListener;</span>
<a href="#l16.69"></a><span id="l16.69"> </span>
<a href="#l16.70"></a><span id="l16.70">   nsresult GetImapDeleteModel(nsIMsgFolder* aFolder, nsMsgImapDeleteModel *aDeleteModel);</span>
<a href="#l16.71"></a><span id="l16.71"> };</span>
<a href="#l16.72"></a><span id="l16.72"> </span>
<a href="#l16.73"></a><span id="l16.73"> class nsImapOfflineTxn : public nsImapMoveCopyMsgTxn</span>
<a href="#l16.74"></a><span id="l16.74"> {</span>
<a href="#l16.75"></a><span id="l16.75"> public:</span>
<a href="#l16.76"></a><span id="l16.76">   nsImapOfflineTxn(nsIMsgFolder* srcFolder, nsTArray&lt;nsMsgKey&gt;* srcKeyArray,</span>
<a href="#l16.77"></a><span id="l16.77" class="difflineminus">-                   const char* srcMsgIdString, </span>
<a href="#l16.78"></a><span id="l16.78" class="difflineplus">+                   const char* srcMsgIdString,</span>
<a href="#l16.79"></a><span id="l16.79">                    nsIMsgFolder* dstFolder,</span>
<a href="#l16.80"></a><span id="l16.80">                    bool isMove,</span>
<a href="#l16.81"></a><span id="l16.81">                    nsOfflineImapOperationType opType,</span>
<a href="#l16.82"></a><span id="l16.82" class="difflineminus">-                   nsIMsgDBHdr *srcHdr,</span>
<a href="#l16.83"></a><span id="l16.83" class="difflineminus">-                   nsIEventTarget *eventTarge);</span>
<a href="#l16.84"></a><span id="l16.84" class="difflineplus">+                   nsIMsgDBHdr *srcHdr);</span>
<a href="#l16.85"></a><span id="l16.85">   virtual ~nsImapOfflineTxn();</span>
<a href="#l16.86"></a><span id="l16.86"> </span>
<a href="#l16.87"></a><span id="l16.87">   NS_IMETHOD UndoTransaction(void);</span>
<a href="#l16.88"></a><span id="l16.88">   NS_IMETHOD RedoTransaction(void);</span>
<a href="#l16.89"></a><span id="l16.89">   void SetAddFlags(bool addFlags) {m_addFlags = addFlags;}</span>
<a href="#l16.90"></a><span id="l16.90">   void SetFlags(PRUint32 flags) {m_flags = flags;}</span>
<a href="#l16.91"></a><span id="l16.91"> protected:</span>
<a href="#l16.92"></a><span id="l16.92">   nsOfflineImapOperationType m_opType;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_filterCustomHeaders.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_filterCustomHeaders.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -23,17 +23,17 @@ var tests = [</span>
<a href="#l17.4"></a><span id="l17.4">   setupTest,</span>
<a href="#l17.5"></a><span id="l17.5">   checkFilterResults,</span>
<a href="#l17.6"></a><span id="l17.6">   endTest</span>
<a href="#l17.7"></a><span id="l17.7"> ]</span>
<a href="#l17.8"></a><span id="l17.8"> </span>
<a href="#l17.9"></a><span id="l17.9"> function run_test()</span>
<a href="#l17.10"></a><span id="l17.10"> {</span>
<a href="#l17.11"></a><span id="l17.11"> </span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-// Create a test filter.</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+  // Create a test filter.</span>
<a href="#l17.14"></a><span id="l17.14">   let filterList = gIMAPIncomingServer.getFilterList(null);</span>
<a href="#l17.15"></a><span id="l17.15">   let filter = filterList.createFilter(&quot;test list-id&quot;);</span>
<a href="#l17.16"></a><span id="l17.16">   let searchTerm = filter.createTerm();</span>
<a href="#l17.17"></a><span id="l17.17">   searchTerm.attrib = Ci.nsMsgSearchAttrib.OtherHeader + 1;</span>
<a href="#l17.18"></a><span id="l17.18">   searchTerm.op = Ci.nsMsgSearchOp.Contains;</span>
<a href="#l17.19"></a><span id="l17.19">   let value = searchTerm.value;</span>
<a href="#l17.20"></a><span id="l17.20">   value.attrib = Ci.nsMsgSearchAttrib.OtherHeader;</span>
<a href="#l17.21"></a><span id="l17.21">   value.str = &quot;gnupg-users.gnupg.org&quot;;</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineat">@@ -48,16 +48,17 @@ function run_test()</span>
<a href="#l17.23"></a><span id="l17.23">   action.type = Ci.nsMsgFilterAction.MarkRead;</span>
<a href="#l17.24"></a><span id="l17.24">   filter.appendAction(action);</span>
<a href="#l17.25"></a><span id="l17.25">   filterList.insertFilterAt(0, filter);</span>
<a href="#l17.26"></a><span id="l17.26"> </span>
<a href="#l17.27"></a><span id="l17.27">   async_run_tests(tests);</span>
<a href="#l17.28"></a><span id="l17.28"> }</span>
<a href="#l17.29"></a><span id="l17.29"> </span>
<a href="#l17.30"></a><span id="l17.30"> function setupTest() {</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineplus">+  Services.prefs.setBoolPref(&quot;mail.server.default.autosync_offline_stores&quot;, false);</span>
<a href="#l17.32"></a><span id="l17.32">   let file = do_get_file(&quot;../../../data/bugmail19&quot;);</span>
<a href="#l17.33"></a><span id="l17.33">   let msgfileuri = Services.io.newFileURI(file).QueryInterface(Ci.nsIFileURL);</span>
<a href="#l17.34"></a><span id="l17.34"> </span>
<a href="#l17.35"></a><span id="l17.35">   gIMAPMailbox.addMessage(new imapMessage(msgfileuri.spec,</span>
<a href="#l17.36"></a><span id="l17.36">                                           gIMAPMailbox.uidnext++, []));</span>
<a href="#l17.37"></a><span id="l17.37">   gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l17.38"></a><span id="l17.38">   yield false;</span>
<a href="#l17.39"></a><span id="l17.39"> }</span>
<a href="#l17.40"></a><span id="l17.40" class="difflineat">@@ -65,16 +66,17 @@ function setupTest() {</span>
<a href="#l17.41"></a><span id="l17.41"> function checkFilterResults() {</span>
<a href="#l17.42"></a><span id="l17.42">   let msgHdr = firstMsgHdr(gIMAPInbox);</span>
<a href="#l17.43"></a><span id="l17.43">   do_check_true(msgHdr.isRead);</span>
<a href="#l17.44"></a><span id="l17.44">   yield true;</span>
<a href="#l17.45"></a><span id="l17.45"> }</span>
<a href="#l17.46"></a><span id="l17.46"> </span>
<a href="#l17.47"></a><span id="l17.47"> // Cleanup</span>
<a href="#l17.48"></a><span id="l17.48"> function endTest() {</span>
<a href="#l17.49"></a><span id="l17.49" class="difflineplus">+  gIMAPServer.performTest(&quot;UID STORE&quot;);</span>
<a href="#l17.50"></a><span id="l17.50">   teardownIMAPPump();</span>
<a href="#l17.51"></a><span id="l17.51"> }</span>
<a href="#l17.52"></a><span id="l17.52"> </span>
<a href="#l17.53"></a><span id="l17.53"> // get the first message header found in a folder</span>
<a href="#l17.54"></a><span id="l17.54"> function firstMsgHdr(folder) {</span>
<a href="#l17.55"></a><span id="l17.55">   let enumerator = folder.msgDatabase.EnumerateMessages();</span>
<a href="#l17.56"></a><span id="l17.56">   if (enumerator.hasMoreElements())</span>
<a href="#l17.57"></a><span id="l17.57">     return enumerator.getNext().QueryInterface(Ci.nsIMsgDBHdr);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapCopyTimeout.js</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapCopyTimeout.js</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -220,16 +220,17 @@ mfnListener =</span>
<a href="#l18.4"></a><span id="l18.4">       async_driver();</span>
<a href="#l18.5"></a><span id="l18.5">     gGotMsgAdded = true;</span>
<a href="#l18.6"></a><span id="l18.6">   },</span>
<a href="#l18.7"></a><span id="l18.7"> </span>
<a href="#l18.8"></a><span id="l18.8"> };</span>
<a href="#l18.9"></a><span id="l18.9"> </span>
<a href="#l18.10"></a><span id="l18.10"> function run_test()</span>
<a href="#l18.11"></a><span id="l18.11"> {</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineplus">+  Services.prefs.setBoolPref(&quot;mail.server.default.autosync_offline_stores&quot;, false);</span>
<a href="#l18.13"></a><span id="l18.13">   // Add folder listeners that will capture async events</span>
<a href="#l18.14"></a><span id="l18.14">   const nsIMFNService = Ci.nsIMsgFolderNotificationService;</span>
<a href="#l18.15"></a><span id="l18.15">   let MFNService = Cc[&quot;@mozilla.org/messenger/msgnotificationservice;1&quot;]</span>
<a href="#l18.16"></a><span id="l18.16">                       .getService(nsIMFNService);</span>
<a href="#l18.17"></a><span id="l18.17">   let flags =</span>
<a href="#l18.18"></a><span id="l18.18">         nsIMFNService.folderAdded |</span>
<a href="#l18.19"></a><span id="l18.19">         nsIMFNService.msgAdded;</span>
<a href="#l18.20"></a><span id="l18.20">   MFNService.addListener(mfnListener, flags);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapHighWater.js</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapHighWater.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -162,16 +162,17 @@ function doMoves() {</span>
<a href="#l19.4"></a><span id="l19.4">                                  CopyListener, dummyMsgWindow, true);</span>
<a href="#l19.5"></a><span id="l19.5">   yield false;</span>
<a href="#l19.6"></a><span id="l19.6">   gFolder1.msgDatabase.DeleteHeader(msgHdr, null, true, false);</span>
<a href="#l19.7"></a><span id="l19.7">   gIMAPInbox.updateFolderWithListener(null, UrlListener);</span>
<a href="#l19.8"></a><span id="l19.8">   yield false;</span>
<a href="#l19.9"></a><span id="l19.9">   // this should clear the dummy headers.</span>
<a href="#l19.10"></a><span id="l19.10">   gFolder1.updateFolderWithListener(dummyMsgWindow, UrlListener);</span>
<a href="#l19.11"></a><span id="l19.11">   yield false;</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineplus">+  let serverSink = gIMAPIncomingServer.QueryInterface(Ci.nsIImapServerSink);</span>
<a href="#l19.13"></a><span id="l19.13">   do_check_eq(gFolder1.msgDatabase.dBFolderInfo.highWater, 11);</span>
<a href="#l19.14"></a><span id="l19.14">   yield true;</span>
<a href="#l19.15"></a><span id="l19.15"> }</span>
<a href="#l19.16"></a><span id="l19.16"> </span>
<a href="#l19.17"></a><span id="l19.17"> var UrlListener =</span>
<a href="#l19.18"></a><span id="l19.18"> {</span>
<a href="#l19.19"></a><span id="l19.19">   OnStartRunningUrl: function(url) { },</span>
<a href="#l19.20"></a><span id="l19.20">   OnStopRunningUrl: function(url, rc)</span>
<a href="#l19.21"></a><span id="l19.21" class="difflineat">@@ -203,15 +204,17 @@ var tests = [</span>
<a href="#l19.22"></a><span id="l19.22"> ]</span>
<a href="#l19.23"></a><span id="l19.23"> </span>
<a href="#l19.24"></a><span id="l19.24"> function actually_run_test() {</span>
<a href="#l19.25"></a><span id="l19.25">   async_run_tests(tests);</span>
<a href="#l19.26"></a><span id="l19.26"> }</span>
<a href="#l19.27"></a><span id="l19.27"> </span>
<a href="#l19.28"></a><span id="l19.28"> function endTest()</span>
<a href="#l19.29"></a><span id="l19.29"> {</span>
<a href="#l19.30"></a><span id="l19.30" class="difflineminus">-  gIMAPIncomingServer.closeCachedConnections();</span>
<a href="#l19.31"></a><span id="l19.31" class="difflineplus">+  Services.io.offline = true;</span>
<a href="#l19.32"></a><span id="l19.32" class="difflineplus">+  gServer.performTest(&quot;LOGOUT&quot;);</span>
<a href="#l19.33"></a><span id="l19.33" class="difflineplus">+//  gIMAPIncomingServer.closeCachedConnections();</span>
<a href="#l19.34"></a><span id="l19.34">   gServer.stop();</span>
<a href="#l19.35"></a><span id="l19.35">   let thread = gThreadManager.currentThread;</span>
<a href="#l19.36"></a><span id="l19.36">   while (thread.hasPendingEvents())</span>
<a href="#l19.37"></a><span id="l19.37">     thread.processNextEvent(true);</span>
<a href="#l19.38"></a><span id="l19.38">   yield true;</span>
<a href="#l19.39"></a><span id="l19.39"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapMove.js</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapMove.js</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -14,17 +14,17 @@</span>
<a href="#l20.4"></a><span id="l20.4">  * The Original Code is mozilla.org code.</span>
<a href="#l20.5"></a><span id="l20.5">  *</span>
<a href="#l20.6"></a><span id="l20.6">  * The Initial Developer of the Original Code is</span>
<a href="#l20.7"></a><span id="l20.7">  * the Mozilla Foundation.</span>
<a href="#l20.8"></a><span id="l20.8">  * Portions created by the Initial Developer are Copyright (C) 2011</span>
<a href="#l20.9"></a><span id="l20.9">  * the Initial Developer. All Rights Reserved.</span>
<a href="#l20.10"></a><span id="l20.10">  *</span>
<a href="#l20.11"></a><span id="l20.11">  * Contributor(s):</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">- *   David Bienvenu &lt;bienvenu@mozillamessaging.com&gt;</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineplus">+ *   David Bienvenu &lt;bienvenu@mozilla.com&gt;</span>
<a href="#l20.14"></a><span id="l20.14">  *</span>
<a href="#l20.15"></a><span id="l20.15">  * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l20.16"></a><span id="l20.16">  * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l20.17"></a><span id="l20.17">  * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l20.18"></a><span id="l20.18">  * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l20.19"></a><span id="l20.19">  * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l20.20"></a><span id="l20.20">  * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l20.21"></a><span id="l20.21">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l20.22"></a><span id="l20.22" class="difflineat">@@ -32,22 +32,20 @@</span>
<a href="#l20.23"></a><span id="l20.23">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l20.24"></a><span id="l20.24">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l20.25"></a><span id="l20.25">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l20.26"></a><span id="l20.26">  *</span>
<a href="#l20.27"></a><span id="l20.27">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l20.28"></a><span id="l20.28"> </span>
<a href="#l20.29"></a><span id="l20.29"> // This tests that we use IMAP move if the IMAP server supports it.</span>
<a href="#l20.30"></a><span id="l20.30"> </span>
<a href="#l20.31"></a><span id="l20.31" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l20.32"></a><span id="l20.32" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l20.33"></a><span id="l20.33" class="difflineplus">+</span>
<a href="#l20.34"></a><span id="l20.34"> var gMessages = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l20.35"></a><span id="l20.35" class="difflineminus">-var gCopyService = Cc[&quot;@mozilla.org/messenger/messagecopyservice;1&quot;]</span>
<a href="#l20.36"></a><span id="l20.36" class="difflineminus">-                .getService(Ci.nsIMsgCopyService);</span>
<a href="#l20.37"></a><span id="l20.37" class="difflineminus">-const ioService = Cc[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l20.38"></a><span id="l20.38" class="difflineminus">-                     .getService(Ci.nsIIOService);</span>
<a href="#l20.39"></a><span id="l20.39" class="difflineminus">-</span>
<a href="#l20.40"></a><span id="l20.40"> </span>
<a href="#l20.41"></a><span id="l20.41"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l20.42"></a><span id="l20.42"> load(&quot;../../../resources/mailTestUtils.js&quot;);</span>
<a href="#l20.43"></a><span id="l20.43"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l20.44"></a><span id="l20.44"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l20.45"></a><span id="l20.45"> </span>
<a href="#l20.46"></a><span id="l20.46"> // IMAP pump</span>
<a href="#l20.47"></a><span id="l20.47"> load(&quot;../../../resources/IMAPpump.js&quot;);</span>
<a href="#l20.48"></a><span id="l20.48" class="difflineat">@@ -59,46 +57,44 @@ var tests = [</span>
<a href="#l20.49"></a><span id="l20.49">   startTest,</span>
<a href="#l20.50"></a><span id="l20.50">   doMove,</span>
<a href="#l20.51"></a><span id="l20.51">   testMove,</span>
<a href="#l20.52"></a><span id="l20.52">   endTest</span>
<a href="#l20.53"></a><span id="l20.53"> ];</span>
<a href="#l20.54"></a><span id="l20.54"> </span>
<a href="#l20.55"></a><span id="l20.55"> function startTest()</span>
<a href="#l20.56"></a><span id="l20.56"> {</span>
<a href="#l20.57"></a><span id="l20.57" class="difflineplus">+  Services.prefs.setBoolPref(&quot;mail.server.default.autosync_offline_stores&quot;, false);</span>
<a href="#l20.58"></a><span id="l20.58">   // Add folder listeners that will capture async events</span>
<a href="#l20.59"></a><span id="l20.59" class="difflineminus">-  const nsIMFNService = Ci.nsIMsgFolderNotificationService;</span>
<a href="#l20.60"></a><span id="l20.60" class="difflineminus">-  let MFNService = Cc[&quot;@mozilla.org/messenger/msgnotificationservice;1&quot;]</span>
<a href="#l20.61"></a><span id="l20.61" class="difflineminus">-                     .getService(nsIMFNService);</span>
<a href="#l20.62"></a><span id="l20.62" class="difflineminus">-  MFNService.addListener(mfnListener, nsIMFNService.folderAdded);</span>
<a href="#l20.63"></a><span id="l20.63" class="difflineplus">+  MailServices.mfn.addListener(mfnListener, MailServices.mfn.folderAdded);</span>
<a href="#l20.64"></a><span id="l20.64"> </span>
<a href="#l20.65"></a><span id="l20.65">   gIMAPIncomingServer.rootFolder.createSubfolder(&quot;folder 1&quot;, null);</span>
<a href="#l20.66"></a><span id="l20.66">   yield false;</span>
<a href="#l20.67"></a><span id="l20.67">   let messages = [];</span>
<a href="#l20.68"></a><span id="l20.68">   let gMessageGenerator = new MessageGenerator();</span>
<a href="#l20.69"></a><span id="l20.69">   messages = messages.concat(gMessageGenerator.makeMessage());</span>
<a href="#l20.70"></a><span id="l20.70">   gSynthMessage = messages[0];</span>
<a href="#l20.71"></a><span id="l20.71" class="difflineminus">-  let dataUri = ioService.newURI(&quot;data:text/plain;base64,&quot; +</span>
<a href="#l20.72"></a><span id="l20.72" class="difflineplus">+  let dataUri = Services.io.newURI(&quot;data:text/plain;base64,&quot; +</span>
<a href="#l20.73"></a><span id="l20.73">                   btoa(messages[0].toMessageString()),</span>
<a href="#l20.74"></a><span id="l20.74">                   null, null);</span>
<a href="#l20.75"></a><span id="l20.75">   let imapMsg = new imapMessage(dataUri.spec, gIMAPMailbox.uidnext++, []);</span>
<a href="#l20.76"></a><span id="l20.76">   gIMAPMailbox.addMessage(imapMsg);</span>
<a href="#l20.77"></a><span id="l20.77"> </span>
<a href="#l20.78"></a><span id="l20.78">   gIMAPInbox.updateFolderWithListener(null, UrlListener);</span>
<a href="#l20.79"></a><span id="l20.79">   yield false;</span>
<a href="#l20.80"></a><span id="l20.80"> }</span>
<a href="#l20.81"></a><span id="l20.81"> </span>
<a href="#l20.82"></a><span id="l20.82"> function doMove() {</span>
<a href="#l20.83"></a><span id="l20.83">   let rootFolder = gIMAPIncomingServer.rootFolder;</span>
<a href="#l20.84"></a><span id="l20.84">   gFolder1 = rootFolder.getChildNamed(&quot;folder 1&quot;)</span>
<a href="#l20.85"></a><span id="l20.85">                .QueryInterface(Components.interfaces.nsIMsgImapMailFolder);</span>
<a href="#l20.86"></a><span id="l20.86">   let msg = gIMAPInbox.msgDatabase.GetMsgHdrForKey(gIMAPMailbox.uidnext - 1);</span>
<a href="#l20.87"></a><span id="l20.87">   gMessages.appendElement(msg, false);</span>
<a href="#l20.88"></a><span id="l20.88">   gIMAPServer._test = true;</span>
<a href="#l20.89"></a><span id="l20.89" class="difflineminus">-  gCopyService.CopyMessages(gIMAPInbox, gMessages, gFolder1, true,</span>
<a href="#l20.90"></a><span id="l20.90" class="difflineplus">+  MailServices.copy.CopyMessages(gIMAPInbox, gMessages, gFolder1, true,</span>
<a href="#l20.91"></a><span id="l20.91">                             asyncCopyListener, null, false);</span>
<a href="#l20.92"></a><span id="l20.92">   gIMAPServer.performTest(&quot;UID MOVE&quot;);</span>
<a href="#l20.93"></a><span id="l20.93">   yield false;</span>
<a href="#l20.94"></a><span id="l20.94"> }</span>
<a href="#l20.95"></a><span id="l20.95"> </span>
<a href="#l20.96"></a><span id="l20.96"> function testMove() {</span>
<a href="#l20.97"></a><span id="l20.97">   do_check_eq(gIMAPInbox.getTotalMessages(false), 0);</span>
<a href="#l20.98"></a><span id="l20.98">   gFolder1.updateFolderWithListener(null, UrlListener);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_mailboxes.js</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_mailboxes.js</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -43,20 +43,18 @@ const gTestArray =</span>
<a href="#l21.4"></a><span id="l21.4">     // Check that we've subscribed to the boxes returned by LSUB. We also get</span>
<a href="#l21.5"></a><span id="l21.5">     // checking of proper i18n in mailboxes for free here.</span>
<a href="#l21.6"></a><span id="l21.6">     do_check_true(rootFolder.containsChildNamed(&quot;Inbox&quot;));</span>
<a href="#l21.7"></a><span id="l21.7">     do_check_true(rootFolder.containsChildNamed(&quot;I18N box\u00E1&quot;));</span>
<a href="#l21.8"></a><span id="l21.8">     // This is not a subscribed box, so we shouldn't be subscribing to it.</span>
<a href="#l21.9"></a><span id="l21.9">     do_check_false(rootFolder.containsChildNamed(&quot;Unsubscribed box&quot;));</span>
<a href="#l21.10"></a><span id="l21.10"> </span>
<a href="#l21.11"></a><span id="l21.11">     let i18nChild = rootFolder.getChildNamed(&quot;I18N box\u00E1&quot;);</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-    let uiThread =   Cc[&quot;@mozilla.org/thread-manager;1&quot;]</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineminus">-                        .getService(Ci.nsIThreadManager).mainThread;</span>
<a href="#l21.14"></a><span id="l21.14"> </span>
<a href="#l21.15"></a><span id="l21.15" class="difflineminus">-    gIMAPService.renameLeaf(uiThread, i18nChild, &quot;test \u00E4&quot;, UrlListener, null);</span>
<a href="#l21.16"></a><span id="l21.16" class="difflineplus">+    gIMAPService.renameLeaf(i18nChild, &quot;test \u00E4&quot;, UrlListener, null);</span>
<a href="#l21.17"></a><span id="l21.17">   },</span>
<a href="#l21.18"></a><span id="l21.18">   function checkRename() {</span>
<a href="#l21.19"></a><span id="l21.19">     do_check_true(rootFolder.containsChildNamed(&quot;test \u00E4&quot;));</span>
<a href="#l21.20"></a><span id="l21.20">     let newChild = rootFolder.getChildNamed(&quot;test \u00E4&quot;).</span>
<a href="#l21.21"></a><span id="l21.21">                    QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l21.22"></a><span id="l21.22">     newChild.updateFolderWithListener(null, UrlListener);</span>
<a href="#l21.23"></a><span id="l21.23">   },</span>
<a href="#l21.24"></a><span id="l21.24">   function checkEmptyFolder() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_preserveDataOnMove.js</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_preserveDataOnMove.js</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -162,16 +162,17 @@ mfnListener =</span>
<a href="#l22.4"></a><span id="l22.4">     dl('msgAdded with subject &lt;' + aMsg.subject + '&gt;')</span>
<a href="#l22.5"></a><span id="l22.5">     async_driver();</span>
<a href="#l22.6"></a><span id="l22.6">   },</span>
<a href="#l22.7"></a><span id="l22.7"> </span>
<a href="#l22.8"></a><span id="l22.8"> };</span>
<a href="#l22.9"></a><span id="l22.9"> </span>
<a href="#l22.10"></a><span id="l22.10"> function run_test()</span>
<a href="#l22.11"></a><span id="l22.11"> {</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineplus">+  Services.prefs.setBoolPref(&quot;mail.server.default.autosync_offline_stores&quot;, false);</span>
<a href="#l22.13"></a><span id="l22.13">   // Add folder listeners that will capture async events</span>
<a href="#l22.14"></a><span id="l22.14">   const nsIMFNService = Ci.nsIMsgFolderNotificationService;</span>
<a href="#l22.15"></a><span id="l22.15">   var MFNService = Cc[&quot;@mozilla.org/messenger/msgnotificationservice;1&quot;]</span>
<a href="#l22.16"></a><span id="l22.16">                       .getService(nsIMFNService);</span>
<a href="#l22.17"></a><span id="l22.17">   let flags =</span>
<a href="#l22.18"></a><span id="l22.18">         nsIMFNService.folderAdded |</span>
<a href="#l22.19"></a><span id="l22.19">         nsIMFNService.msgAdded;</span>
<a href="#l22.20"></a><span id="l22.20">   MFNService.addListener(mfnListener, flags);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_saveImapDraft.js</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_saveImapDraft.js</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -39,16 +39,18 @@</span>
<a href="#l23.4"></a><span id="l23.4">  * marked as unread.</span>
<a href="#l23.5"></a><span id="l23.5">  */</span>
<a href="#l23.6"></a><span id="l23.6"> </span>
<a href="#l23.7"></a><span id="l23.7"> // async support</span>
<a href="#l23.8"></a><span id="l23.8"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l23.9"></a><span id="l23.9"> load(&quot;../../../resources/mailTestUtils.js&quot;);</span>
<a href="#l23.10"></a><span id="l23.10"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l23.11"></a><span id="l23.11"> </span>
<a href="#l23.12"></a><span id="l23.12" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineplus">+</span>
<a href="#l23.14"></a><span id="l23.14"> // IMAP pump</span>
<a href="#l23.15"></a><span id="l23.15"> load(&quot;../../../resources/IMAPpump.js&quot;);</span>
<a href="#l23.16"></a><span id="l23.16"> </span>
<a href="#l23.17"></a><span id="l23.17"> setupIMAPPump();</span>
<a href="#l23.18"></a><span id="l23.18"> </span>
<a href="#l23.19"></a><span id="l23.19"> // Definition of tests</span>
<a href="#l23.20"></a><span id="l23.20"> </span>
<a href="#l23.21"></a><span id="l23.21"> var tests = [</span>
<a href="#l23.22"></a><span id="l23.22" class="difflineat">@@ -95,35 +97,38 @@ function saveDraft()</span>
<a href="#l23.23"></a><span id="l23.23">   progress.registerListener(progressListener);</span>
<a href="#l23.24"></a><span id="l23.24">   msgCompose.SendMsg(Ci.nsIMsgSend.nsMsgSaveAsDraft, identity, &quot;&quot;, null,</span>
<a href="#l23.25"></a><span id="l23.25">                      progress);</span>
<a href="#l23.26"></a><span id="l23.26">   yield false;</span>
<a href="#l23.27"></a><span id="l23.27"> }</span>
<a href="#l23.28"></a><span id="l23.28"> </span>
<a href="#l23.29"></a><span id="l23.29"> function updateDrafts()</span>
<a href="#l23.30"></a><span id="l23.30"> {</span>
<a href="#l23.31"></a><span id="l23.31" class="difflineplus">+  dump(&quot;updating drafts\n&quot;);</span>
<a href="#l23.32"></a><span id="l23.32">   gDraftsFolder.updateFolderWithListener(null, urlListener);</span>
<a href="#l23.33"></a><span id="l23.33">   yield false;</span>
<a href="#l23.34"></a><span id="l23.34"> }</span>
<a href="#l23.35"></a><span id="l23.35"> </span>
<a href="#l23.36"></a><span id="l23.36"> function checkResult()</span>
<a href="#l23.37"></a><span id="l23.37"> {</span>
<a href="#l23.38"></a><span id="l23.38" class="difflineplus">+  dump(&quot;checking result\n&quot;);</span>
<a href="#l23.39"></a><span id="l23.39">   do_check_eq(gDraftsFolder.getTotalMessages(false), 1);</span>
<a href="#l23.40"></a><span id="l23.40">   do_check_eq(gDraftsFolder.getNumUnread(false), 1);</span>
<a href="#l23.41"></a><span id="l23.41">   yield true;</span>
<a href="#l23.42"></a><span id="l23.42"> }</span>
<a href="#l23.43"></a><span id="l23.43"> </span>
<a href="#l23.44"></a><span id="l23.44"> function endTest()</span>
<a href="#l23.45"></a><span id="l23.45"> {</span>
<a href="#l23.46"></a><span id="l23.46">   teardownIMAPPump();</span>
<a href="#l23.47"></a><span id="l23.47">   yield true;</span>
<a href="#l23.48"></a><span id="l23.48"> }</span>
<a href="#l23.49"></a><span id="l23.49"> </span>
<a href="#l23.50"></a><span id="l23.50"> function run_test()</span>
<a href="#l23.51"></a><span id="l23.51"> {</span>
<a href="#l23.52"></a><span id="l23.52" class="difflineplus">+  Services.prefs.setBoolPref(&quot;mail.server.default.autosync_offline_stores&quot;, false);</span>
<a href="#l23.53"></a><span id="l23.53">   let server = gIMAPIncomingServer;</span>
<a href="#l23.54"></a><span id="l23.54"> </span>
<a href="#l23.55"></a><span id="l23.55">   // Add folder listeners that will capture async events</span>
<a href="#l23.56"></a><span id="l23.56">   const nsIMFNService = Ci.nsIMsgFolderNotificationService;</span>
<a href="#l23.57"></a><span id="l23.57">   let MFNService = Cc[&quot;@mozilla.org/messenger/msgnotificationservice;1&quot;]</span>
<a href="#l23.58"></a><span id="l23.58">                       .getService(nsIMFNService);</span>
<a href="#l23.59"></a><span id="l23.59"> </span>
<a href="#l23.60"></a><span id="l23.60">   let flags =</span>
<a href="#l23.61"></a><span id="l23.61" class="difflineat">@@ -138,16 +143,17 @@ function run_test()</span>
<a href="#l23.62"></a><span id="l23.62"> </span>
<a href="#l23.63"></a><span id="l23.63"> var urlListener = {</span>
<a href="#l23.64"></a><span id="l23.64">   OnStartRunningUrl: function _OnStartRunningUrl(aUrl) {</span>
<a href="#l23.65"></a><span id="l23.65">     // funny but this never seems to get called.</span>
<a href="#l23.66"></a><span id="l23.66">     dl('OnStartRunningUrl');</span>
<a href="#l23.67"></a><span id="l23.67">   },</span>
<a href="#l23.68"></a><span id="l23.68">   OnStopRunningUrl: function _OnStopRunningUrl(aUrl, aExitCode) {</span>
<a href="#l23.69"></a><span id="l23.69">     dl('OnStopRunningUrl');</span>
<a href="#l23.70"></a><span id="l23.70" class="difflineplus">+    dump(&quot;got on stop running url\n&quot;);</span>
<a href="#l23.71"></a><span id="l23.71">     async_driver();</span>
<a href="#l23.72"></a><span id="l23.72">   }</span>
<a href="#l23.73"></a><span id="l23.73"> };</span>
<a href="#l23.74"></a><span id="l23.74"> </span>
<a href="#l23.75"></a><span id="l23.75"> var mfnListener =</span>
<a href="#l23.76"></a><span id="l23.76"> {</span>
<a href="#l23.77"></a><span id="l23.77">   msgsMoveCopyCompleted: function (aMove, aSrcMsgs, aDestFolder, aDestMsgs)</span>
<a href="#l23.78"></a><span id="l23.78">   {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_saveTemplate.js</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_saveTemplate.js</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -136,16 +136,17 @@ mfnListener =</span>
<a href="#l24.4"></a><span id="l24.4">     do_check_eq(aMsg.folder.prettyName, &quot;Templates&quot;);</span>
<a href="#l24.5"></a><span id="l24.5">     async_driver();</span>
<a href="#l24.6"></a><span id="l24.6">   },</span>
<a href="#l24.7"></a><span id="l24.7"> };</span>
<a href="#l24.8"></a><span id="l24.8"> </span>
<a href="#l24.9"></a><span id="l24.9"> </span>
<a href="#l24.10"></a><span id="l24.10"> function run_test()</span>
<a href="#l24.11"></a><span id="l24.11"> {</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineplus">+  Services.prefs.setBoolPref(&quot;mail.server.default.autosync_offline_stores&quot;, false);</span>
<a href="#l24.13"></a><span id="l24.13">   async_run_tests(tests);</span>
<a href="#l24.14"></a><span id="l24.14"> }</span>
<a href="#l24.15"></a><span id="l24.15"> </span>
<a href="#l24.16"></a><span id="l24.16"> // get the first message header found in a folder</span>
<a href="#l24.17"></a><span id="l24.17"> function firstMsgHdr(folder) {</span>
<a href="#l24.18"></a><span id="l24.18">   let enumerator = folder.msgDatabase.EnumerateMessages();</span>
<a href="#l24.19"></a><span id="l24.19">   if (enumerator.hasMoreElements())</span>
<a href="#l24.20"></a><span id="l24.20">     return enumerator.getNext().QueryInterface(Ci.nsIMsgDBHdr);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mailnews/local/src/nsLocalUndoTxn.cpp</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mailnews/local/src/nsLocalUndoTxn.cpp</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -150,40 +150,35 @@ nsLocalMoveCopyMsgTxn::UndoImapDeleteFla</span>
<a href="#l25.4"></a><span id="l25.4">     PRUint32 i, count = keyArray.Length();</span>
<a href="#l25.5"></a><span id="l25.5">     urlListener = do_QueryInterface(folder, &amp;rv);</span>
<a href="#l25.6"></a><span id="l25.6">     for (i=0; i &lt; count; i++)</span>
<a href="#l25.7"></a><span id="l25.7">     {</span>
<a href="#l25.8"></a><span id="l25.8">       if (!msgIds.IsEmpty())</span>
<a href="#l25.9"></a><span id="l25.9">           msgIds.Append(',');</span>
<a href="#l25.10"></a><span id="l25.10">       msgIds.AppendInt((PRInt32) keyArray[i]);</span>
<a href="#l25.11"></a><span id="l25.11">     }</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-    nsCOMPtr&lt;nsIThread&gt; thread(do_GetCurrentThread());</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineminus">-    if (thread)</span>
<a href="#l25.14"></a><span id="l25.14" class="difflineminus">-    {</span>
<a href="#l25.15"></a><span id="l25.15" class="difflineminus">-      // This is to make sure that we are in the selected state</span>
<a href="#l25.16"></a><span id="l25.16" class="difflineminus">-      // when executing the imap url; we don't want to load the</span>
<a href="#l25.17"></a><span id="l25.17" class="difflineminus">-      // folder so use lite select to do the trick</span>
<a href="#l25.18"></a><span id="l25.18" class="difflineminus">-      rv = imapService-&gt;LiteSelectFolder(thread, folder,</span>
<a href="#l25.19"></a><span id="l25.19" class="difflineminus">-                                         urlListener, nsnull, nsnull);</span>
<a href="#l25.20"></a><span id="l25.20" class="difflineminus">-      if (!deleteFlag)</span>
<a href="#l25.21"></a><span id="l25.21" class="difflineminus">-          rv =imapService-&gt;AddMessageFlags(thread, folder,</span>
<a href="#l25.22"></a><span id="l25.22" class="difflineminus">-                                          urlListener, nsnull,</span>
<a href="#l25.23"></a><span id="l25.23" class="difflineminus">-                                          msgIds,</span>
<a href="#l25.24"></a><span id="l25.24" class="difflineminus">-                                          kImapMsgDeletedFlag,</span>
<a href="#l25.25"></a><span id="l25.25" class="difflineminus">-                                          true);</span>
<a href="#l25.26"></a><span id="l25.26" class="difflineminus">-      else</span>
<a href="#l25.27"></a><span id="l25.27" class="difflineminus">-          rv = imapService-&gt;SubtractMessageFlags(thread,</span>
<a href="#l25.28"></a><span id="l25.28" class="difflineminus">-                                                folder,</span>
<a href="#l25.29"></a><span id="l25.29" class="difflineminus">-                                           urlListener, nsnull,</span>
<a href="#l25.30"></a><span id="l25.30" class="difflineminus">-                                           msgIds,</span>
<a href="#l25.31"></a><span id="l25.31" class="difflineminus">-                                           kImapMsgDeletedFlag,</span>
<a href="#l25.32"></a><span id="l25.32" class="difflineminus">-                                           true);</span>
<a href="#l25.33"></a><span id="l25.33" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; m_msgWindow)</span>
<a href="#l25.34"></a><span id="l25.34" class="difflineminus">-          folder-&gt;UpdateFolder(m_msgWindow);</span>
<a href="#l25.35"></a><span id="l25.35" class="difflineminus">-    }</span>
<a href="#l25.36"></a><span id="l25.36" class="difflineplus">+    // This is to make sure that we are in the selected state</span>
<a href="#l25.37"></a><span id="l25.37" class="difflineplus">+    // when executing the imap url; we don't want to load the</span>
<a href="#l25.38"></a><span id="l25.38" class="difflineplus">+    // folder so use lite select to do the trick</span>
<a href="#l25.39"></a><span id="l25.39" class="difflineplus">+    rv = imapService-&gt;LiteSelectFolder(folder,</span>
<a href="#l25.40"></a><span id="l25.40" class="difflineplus">+                                       urlListener, nsnull, nsnull);</span>
<a href="#l25.41"></a><span id="l25.41" class="difflineplus">+    if (!deleteFlag)</span>
<a href="#l25.42"></a><span id="l25.42" class="difflineplus">+        rv =imapService-&gt;AddMessageFlags(folder,</span>
<a href="#l25.43"></a><span id="l25.43" class="difflineplus">+                                         urlListener, nsnull,</span>
<a href="#l25.44"></a><span id="l25.44" class="difflineplus">+                                         msgIds,</span>
<a href="#l25.45"></a><span id="l25.45" class="difflineplus">+                                         kImapMsgDeletedFlag,</span>
<a href="#l25.46"></a><span id="l25.46" class="difflineplus">+                                         true);</span>
<a href="#l25.47"></a><span id="l25.47" class="difflineplus">+    else</span>
<a href="#l25.48"></a><span id="l25.48" class="difflineplus">+        rv = imapService-&gt;SubtractMessageFlags(folder,</span>
<a href="#l25.49"></a><span id="l25.49" class="difflineplus">+                                               urlListener, nsnull,</span>
<a href="#l25.50"></a><span id="l25.50" class="difflineplus">+                                               msgIds,</span>
<a href="#l25.51"></a><span id="l25.51" class="difflineplus">+                                               kImapMsgDeletedFlag,</span>
<a href="#l25.52"></a><span id="l25.52" class="difflineplus">+                                               true);</span>
<a href="#l25.53"></a><span id="l25.53" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; m_msgWindow)</span>
<a href="#l25.54"></a><span id="l25.54" class="difflineplus">+        folder-&gt;UpdateFolder(m_msgWindow);</span>
<a href="#l25.55"></a><span id="l25.55">     rv = NS_OK; // always return NS_OK to indicate that the src is imap</span>
<a href="#l25.56"></a><span id="l25.56">   }</span>
<a href="#l25.57"></a><span id="l25.57">   else</span>
<a href="#l25.58"></a><span id="l25.58">     rv = NS_ERROR_FAILURE;</span>
<a href="#l25.59"></a><span id="l25.59">   return rv;</span>
<a href="#l25.60"></a><span id="l25.60"> }</span>
<a href="#l25.61"></a><span id="l25.61"> </span>
<a href="#l25.62"></a><span id="l25.62"> NS_IMETHODIMP</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/mailnews/test/resources/IMAPpump.js</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/mailnews/test/resources/IMAPpump.js</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -150,17 +150,21 @@ function setupIMAPPump(extensions)</span>
<a href="#l26.4"></a><span id="l26.4">   gIMAPMailbox = gIMAPDaemon.getMailbox(&quot;INBOX&quot;);</span>
<a href="#l26.5"></a><span id="l26.5">   gIMAPInbox instanceof Ci.nsIMsgImapMailFolder;</span>
<a href="#l26.6"></a><span id="l26.6"> }</span>
<a href="#l26.7"></a><span id="l26.7"> </span>
<a href="#l26.8"></a><span id="l26.8"> function teardownIMAPPump()</span>
<a href="#l26.9"></a><span id="l26.9"> {</span>
<a href="#l26.10"></a><span id="l26.10">   gIMAPInbox = null;</span>
<a href="#l26.11"></a><span id="l26.11">   gIMAPServer.resetTest();</span>
<a href="#l26.12"></a><span id="l26.12" class="difflineminus">-  gIMAPIncomingServer.closeCachedConnections();</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineplus">+  try {</span>
<a href="#l26.14"></a><span id="l26.14" class="difflineplus">+    gIMAPIncomingServer.closeCachedConnections();</span>
<a href="#l26.15"></a><span id="l26.15" class="difflineplus">+    let serverSink = gIMAPIncomingServer.QueryInterface(Ci.nsIImapServerSink);</span>
<a href="#l26.16"></a><span id="l26.16" class="difflineplus">+    serverSink.abortQueuedUrls();</span>
<a href="#l26.17"></a><span id="l26.17" class="difflineplus">+  } catch (ex) {dump(ex);}</span>
<a href="#l26.18"></a><span id="l26.18">   gIMAPServer.performTest();</span>
<a href="#l26.19"></a><span id="l26.19">   gIMAPServer.stop();</span>
<a href="#l26.20"></a><span id="l26.20">   let thread = gThreadManager.currentThread;</span>
<a href="#l26.21"></a><span id="l26.21">   while (thread.hasPendingEvents())</span>
<a href="#l26.22"></a><span id="l26.22">     thread.processNextEvent(true);</span>
<a href="#l26.23"></a><span id="l26.23"> }</span>
<a href="#l26.24"></a><span id="l26.24"> </span>
<a href="#l26.25"></a><span id="l26.25"> } // end run only once</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/mailnews/test/resources/messageInjection.js</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/mailnews/test/resources/messageInjection.js</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -190,19 +190,16 @@ function configure_message_injection(aIn</span>
<a href="#l27.4"></a><span id="l27.4">     //  that we set the pref above?)</span>
<a href="#l27.5"></a><span id="l27.5">     if (mis.injectionConfig.offline)</span>
<a href="#l27.6"></a><span id="l27.6">       mis.inboxFolder.setFlag(Ci.nsMsgFolderFlags.Offline);</span>
<a href="#l27.7"></a><span id="l27.7">     else</span>
<a href="#l27.8"></a><span id="l27.8">       mis.inboxFolder.clearFlag(Ci.nsMsgFolderFlags.Offline);</span>
<a href="#l27.9"></a><span id="l27.9">     _messageInjectionSetup.notifyListeners(&quot;onRealFolderCreated&quot;,</span>
<a href="#l27.10"></a><span id="l27.10">                                            [mis.inboxFolder]);</span>
<a href="#l27.11"></a><span id="l27.11"> </span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-    mis.mainThread = Cc[&quot;@mozilla.org/thread-manager;1&quot;]</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineminus">-                       .getService()</span>
<a href="#l27.14"></a><span id="l27.14" class="difflineminus">-                       .mainThread;</span>
<a href="#l27.15"></a><span id="l27.15">     mis.imapService = Cc[&quot;@mozilla.org/messenger/imapservice;1&quot;]</span>
<a href="#l27.16"></a><span id="l27.16">                         .getService(Ci.nsIImapService);</span>
<a href="#l27.17"></a><span id="l27.17"> </span>
<a href="#l27.18"></a><span id="l27.18">     mis.handleUriToRealFolder = {};</span>
<a href="#l27.19"></a><span id="l27.19">     mis.handleUriToFakeFolder = {};</span>
<a href="#l27.20"></a><span id="l27.20">     mis.realUriToFakeFolder = {};</span>
<a href="#l27.21"></a><span id="l27.21">     mis.realUriToFakeFolder[mis.inboxFolder.URI] =</span>
<a href="#l27.22"></a><span id="l27.22">       mis.daemon.getMailbox(&quot;INBOX&quot;);</span>
<a href="#l27.23"></a><span id="l27.23" class="difflineat">@@ -355,17 +352,16 @@ function make_empty_folder(aFolderName, </span>
<a href="#l27.24"></a><span id="l27.24">   else if (mis.injectionConfig.mode == &quot;imap&quot;) {</span>
<a href="#l27.25"></a><span id="l27.25">     let promise_completed = async_create_promise();</span>
<a href="#l27.26"></a><span id="l27.26"> </span>
<a href="#l27.27"></a><span id="l27.27">     testFolder = mis.rootFolder.URI + &quot;/&quot; + aFolderName;</span>
<a href="#l27.28"></a><span id="l27.28"> </span>
<a href="#l27.29"></a><span id="l27.29">     // Tell the IMAP service to create the folder, adding a listener that</span>
<a href="#l27.30"></a><span id="l27.30">     //  hooks up the 'handle' URI -&gt; actual folder mapping.</span>
<a href="#l27.31"></a><span id="l27.31">     mis.imapService.createFolder(</span>
<a href="#l27.32"></a><span id="l27.32" class="difflineminus">-      mis.mainThread,</span>
<a href="#l27.33"></a><span id="l27.33">       mis.rootFolder,</span>
<a href="#l27.34"></a><span id="l27.34">       aFolderName,</span>
<a href="#l27.35"></a><span id="l27.35">       new AsyncUrlListener(mis.rootFolder, function() {</span>
<a href="#l27.36"></a><span id="l27.36">         // get the newly created nsIMsgFolder folder</span>
<a href="#l27.37"></a><span id="l27.37">         let msgFolder = mis.rootFolder.getChildNamed(aFolderName);</span>
<a href="#l27.38"></a><span id="l27.38"> </span>
<a href="#l27.39"></a><span id="l27.39">         // XXX there is a bug that causes folders to be reported as ImapPublic</span>
<a href="#l27.40"></a><span id="l27.40">         //  when there is no namespace support by the IMAP server.  This is</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

