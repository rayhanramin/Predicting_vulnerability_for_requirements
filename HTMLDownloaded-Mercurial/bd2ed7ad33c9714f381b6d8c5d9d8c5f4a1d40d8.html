<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 25684:bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8" />
<meta property="og:url" content="/comm-central/rev/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8" />
<meta property="og:description" content="Bug 1515877 - Turn on ESLint in mailnews/addrbook; r=aceman" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8">shortlog</a> |
<a href="/comm-central/log/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8">files</a> |
changeset |
<a href="/comm-central/raw-rev/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8">raw</a>  | <a href="/comm-central/archive/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1515877">Bug 1515877</a> - Turn on ESLint in mailnews/addrbook; r=aceman
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#71;&#101;&#111;&#102;&#102;&#32;&#76;&#97;&#110;&#107;&#111;&#119;&#32;&#60;&#103;&#101;&#111;&#102;&#102;&#64;&#100;&#97;&#114;&#107;&#116;&#114;&#111;&#106;&#97;&#110;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 25 Jan 2019 17:32:10 +1300</td></tr>

<tr>
 <td>changeset 25684</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8">bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8</a></td>
</tr>



<tr>
<td>parent 25683</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/132113b4ce51c899bc8932f30401be73728f1268">132113b4ce51c899bc8932f30401be73728f1268</a>
</td>
</tr>

<tr>
<td>child 25685</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/881cf0d594f227667269c03cc35a09959d5f700d">881cf0d594f227667269c03cc35a09959d5f700d</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8">15414</a></td></tr>
<tr><td>push user</td><td>geoff@darktrojan.net</td></tr>
<tr><td>push date</td><td class="date age">Fri, 25 Jan 2019 04:32:46 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@881cf0d594f2 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=881cf0d594f227667269c03cc35a09959d5f700d">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=881cf0d594f227667269c03cc35a09959d5f700d&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=881cf0d594f227667269c03cc35a09959d5f700d&newProject=comm-central&newRevision=954fd69c1e3c2ccf7b4bdd1f32b53d261b55a9ef&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=881cf0d594f227667269c03cc35a09959d5f700d&newProject=comm-central&newRevision=954fd69c1e3c2ccf7b4bdd1f32b53d261b55a9ef&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=881cf0d594f227667269c03cc35a09959d5f700d&newProject=comm-central&newRevision=954fd69c1e3c2ccf7b4bdd1f32b53d261b55a9ef&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28aceman%29&revcount=50">aceman</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1515877">1515877</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1515877">Bug 1515877</a> - Turn on ESLint in mailnews/addrbook; r=aceman</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/.eslintignore">.eslintignore</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/.eslintignore">file</a> |
<a href="/comm-central/annotate/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/.eslintignore">annotate</a> |
<a href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/.eslintignore">diff</a> |
<a href="/comm-central/comparison/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/.eslintignore">comparison</a> |
<a href="/comm-central/log/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/.eslintignore">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/content/abAddressBookNameDialog.js">mailnews/addrbook/content/abAddressBookNameDialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/content/abAddressBookNameDialog.js">file</a> |
<a href="/comm-central/annotate/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/content/abAddressBookNameDialog.js">annotate</a> |
<a href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/content/abAddressBookNameDialog.js">diff</a> |
<a href="/comm-central/comparison/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/content/abAddressBookNameDialog.js">comparison</a> |
<a href="/comm-central/log/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/content/abAddressBookNameDialog.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/content/abDragDrop.js">mailnews/addrbook/content/abDragDrop.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/content/abDragDrop.js">file</a> |
<a href="/comm-central/annotate/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/content/abDragDrop.js">annotate</a> |
<a href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/content/abDragDrop.js">diff</a> |
<a href="/comm-central/comparison/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/content/abDragDrop.js">comparison</a> |
<a href="/comm-central/log/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/content/abDragDrop.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/content/abMailListDialog.js">mailnews/addrbook/content/abMailListDialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/content/abMailListDialog.js">file</a> |
<a href="/comm-central/annotate/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/content/abMailListDialog.js">annotate</a> |
<a href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/content/abMailListDialog.js">diff</a> |
<a href="/comm-central/comparison/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/content/abMailListDialog.js">comparison</a> |
<a href="/comm-central/log/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/content/abMailListDialog.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/content/abResultsPane.js">mailnews/addrbook/content/abResultsPane.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/content/abResultsPane.js">file</a> |
<a href="/comm-central/annotate/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/content/abResultsPane.js">annotate</a> |
<a href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/content/abResultsPane.js">diff</a> |
<a href="/comm-central/comparison/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/content/abResultsPane.js">comparison</a> |
<a href="/comm-central/log/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/content/abResultsPane.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/content/addrbookWidgets.xml">mailnews/addrbook/content/addrbookWidgets.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/content/addrbookWidgets.xml">file</a> |
<a href="/comm-central/annotate/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/content/addrbookWidgets.xml">annotate</a> |
<a href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/content/addrbookWidgets.xml">diff</a> |
<a href="/comm-central/comparison/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/content/addrbookWidgets.xml">comparison</a> |
<a href="/comm-central/log/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/content/addrbookWidgets.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/prefs/content/pref-directory-add.js">mailnews/addrbook/prefs/content/pref-directory-add.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/prefs/content/pref-directory-add.js">file</a> |
<a href="/comm-central/annotate/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/prefs/content/pref-directory-add.js">annotate</a> |
<a href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/prefs/content/pref-directory-add.js">diff</a> |
<a href="/comm-central/comparison/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/prefs/content/pref-directory-add.js">comparison</a> |
<a href="/comm-central/log/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/prefs/content/pref-directory-add.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/prefs/content/pref-editdirectories.js">mailnews/addrbook/prefs/content/pref-editdirectories.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/prefs/content/pref-editdirectories.js">file</a> |
<a href="/comm-central/annotate/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/prefs/content/pref-editdirectories.js">annotate</a> |
<a href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/prefs/content/pref-editdirectories.js">diff</a> |
<a href="/comm-central/comparison/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/prefs/content/pref-editdirectories.js">comparison</a> |
<a href="/comm-central/log/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/prefs/content/pref-editdirectories.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/src/nsAbAutoCompleteMyDomain.js">mailnews/addrbook/src/nsAbAutoCompleteMyDomain.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/src/nsAbAutoCompleteMyDomain.js">file</a> |
<a href="/comm-central/annotate/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/src/nsAbAutoCompleteMyDomain.js">annotate</a> |
<a href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/src/nsAbAutoCompleteMyDomain.js">diff</a> |
<a href="/comm-central/comparison/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/src/nsAbAutoCompleteMyDomain.js">comparison</a> |
<a href="/comm-central/log/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/src/nsAbAutoCompleteMyDomain.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/src/nsAbAutoCompleteSearch.js">mailnews/addrbook/src/nsAbAutoCompleteSearch.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/src/nsAbAutoCompleteSearch.js">file</a> |
<a href="/comm-central/annotate/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/src/nsAbAutoCompleteSearch.js">annotate</a> |
<a href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/src/nsAbAutoCompleteSearch.js">diff</a> |
<a href="/comm-central/comparison/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/src/nsAbAutoCompleteSearch.js">comparison</a> |
<a href="/comm-central/log/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/src/nsAbAutoCompleteSearch.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/src/nsAbLDAPAttributeMap.js">mailnews/addrbook/src/nsAbLDAPAttributeMap.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/src/nsAbLDAPAttributeMap.js">file</a> |
<a href="/comm-central/annotate/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/src/nsAbLDAPAttributeMap.js">annotate</a> |
<a href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/src/nsAbLDAPAttributeMap.js">diff</a> |
<a href="/comm-central/comparison/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/src/nsAbLDAPAttributeMap.js">comparison</a> |
<a href="/comm-central/log/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/src/nsAbLDAPAttributeMap.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/src/nsAbLDAPAutoCompleteSearch.js">mailnews/addrbook/src/nsAbLDAPAutoCompleteSearch.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/src/nsAbLDAPAutoCompleteSearch.js">file</a> |
<a href="/comm-central/annotate/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/src/nsAbLDAPAutoCompleteSearch.js">annotate</a> |
<a href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/src/nsAbLDAPAutoCompleteSearch.js">diff</a> |
<a href="/comm-central/comparison/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/src/nsAbLDAPAutoCompleteSearch.js">comparison</a> |
<a href="/comm-central/log/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/src/nsAbLDAPAutoCompleteSearch.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/.eslintrc.js">mailnews/addrbook/test/unit/.eslintrc.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/.eslintrc.js">file</a> |
<a href="/comm-central/annotate/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/.eslintrc.js">annotate</a> |
<a href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/.eslintrc.js">diff</a> |
<a href="/comm-central/comparison/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/.eslintrc.js">comparison</a> |
<a href="/comm-central/log/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/.eslintrc.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/data/bug534822prefs.js">mailnews/addrbook/test/unit/data/bug534822prefs.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/data/bug534822prefs.js">file</a> |
<a href="/comm-central/annotate/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/data/bug534822prefs.js">annotate</a> |
<a href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/data/bug534822prefs.js">diff</a> |
<a href="/comm-central/comparison/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/data/bug534822prefs.js">comparison</a> |
<a href="/comm-central/log/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/data/bug534822prefs.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/head_addrbook.js">mailnews/addrbook/test/unit/head_addrbook.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/head_addrbook.js">file</a> |
<a href="/comm-central/annotate/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/head_addrbook.js">annotate</a> |
<a href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/head_addrbook.js">diff</a> |
<a href="/comm-central/comparison/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/head_addrbook.js">comparison</a> |
<a href="/comm-central/log/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/head_addrbook.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_basic_nsIAbDirectory.js">mailnews/addrbook/test/unit/test_basic_nsIAbDirectory.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_basic_nsIAbDirectory.js">file</a> |
<a href="/comm-central/annotate/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_basic_nsIAbDirectory.js">annotate</a> |
<a href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_basic_nsIAbDirectory.js">diff</a> |
<a href="/comm-central/comparison/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_basic_nsIAbDirectory.js">comparison</a> |
<a href="/comm-central/log/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_basic_nsIAbDirectory.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_bug534822.js">mailnews/addrbook/test/unit/test_bug534822.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_bug534822.js">file</a> |
<a href="/comm-central/annotate/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_bug534822.js">annotate</a> |
<a href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_bug534822.js">diff</a> |
<a href="/comm-central/comparison/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_bug534822.js">comparison</a> |
<a href="/comm-central/log/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_bug534822.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_bug_448165.js">mailnews/addrbook/test/unit/test_bug_448165.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_bug_448165.js">file</a> |
<a href="/comm-central/annotate/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_bug_448165.js">annotate</a> |
<a href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_bug_448165.js">diff</a> |
<a href="/comm-central/comparison/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_bug_448165.js">comparison</a> |
<a href="/comm-central/log/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_bug_448165.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_cardForEmail.js">mailnews/addrbook/test/unit/test_cardForEmail.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_cardForEmail.js">file</a> |
<a href="/comm-central/annotate/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_cardForEmail.js">annotate</a> |
<a href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_cardForEmail.js">diff</a> |
<a href="/comm-central/comparison/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_cardForEmail.js">comparison</a> |
<a href="/comm-central/log/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_cardForEmail.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_collection.js">mailnews/addrbook/test/unit/test_collection.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_collection.js">file</a> |
<a href="/comm-central/annotate/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_collection.js">annotate</a> |
<a href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_collection.js">diff</a> |
<a href="/comm-central/comparison/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_collection.js">comparison</a> |
<a href="/comm-central/log/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_collection.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_collection_2.js">mailnews/addrbook/test/unit/test_collection_2.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_collection_2.js">file</a> |
<a href="/comm-central/annotate/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_collection_2.js">annotate</a> |
<a href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_collection_2.js">diff</a> |
<a href="/comm-central/comparison/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_collection_2.js">comparison</a> |
<a href="/comm-central/log/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_collection_2.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_db_enumerator.js">mailnews/addrbook/test/unit/test_db_enumerator.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_db_enumerator.js">file</a> |
<a href="/comm-central/annotate/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_db_enumerator.js">annotate</a> |
<a href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_db_enumerator.js">diff</a> |
<a href="/comm-central/comparison/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_db_enumerator.js">comparison</a> |
<a href="/comm-central/log/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_db_enumerator.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_ldap1.js">mailnews/addrbook/test/unit/test_ldap1.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_ldap1.js">file</a> |
<a href="/comm-central/annotate/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_ldap1.js">annotate</a> |
<a href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_ldap1.js">diff</a> |
<a href="/comm-central/comparison/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_ldap1.js">comparison</a> |
<a href="/comm-central/log/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_ldap1.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_ldap2.js">mailnews/addrbook/test/unit/test_ldap2.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_ldap2.js">file</a> |
<a href="/comm-central/annotate/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_ldap2.js">annotate</a> |
<a href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_ldap2.js">diff</a> |
<a href="/comm-central/comparison/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_ldap2.js">comparison</a> |
<a href="/comm-central/log/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_ldap2.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_ldapOffline.js">mailnews/addrbook/test/unit/test_ldapOffline.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_ldapOffline.js">file</a> |
<a href="/comm-central/annotate/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_ldapOffline.js">annotate</a> |
<a href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_ldapOffline.js">diff</a> |
<a href="/comm-central/comparison/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_ldapOffline.js">comparison</a> |
<a href="/comm-central/log/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_ldapOffline.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_mailList1.js">mailnews/addrbook/test/unit/test_mailList1.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_mailList1.js">file</a> |
<a href="/comm-central/annotate/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_mailList1.js">annotate</a> |
<a href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_mailList1.js">diff</a> |
<a href="/comm-central/comparison/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_mailList1.js">comparison</a> |
<a href="/comm-central/log/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_mailList1.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_notifications.js">mailnews/addrbook/test/unit/test_notifications.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_notifications.js">file</a> |
<a href="/comm-central/annotate/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_notifications.js">annotate</a> |
<a href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_notifications.js">diff</a> |
<a href="/comm-central/comparison/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_notifications.js">comparison</a> |
<a href="/comm-central/log/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_notifications.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_nsAbAutoCompleteMyDomain.js">mailnews/addrbook/test/unit/test_nsAbAutoCompleteMyDomain.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_nsAbAutoCompleteMyDomain.js">file</a> |
<a href="/comm-central/annotate/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_nsAbAutoCompleteMyDomain.js">annotate</a> |
<a href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_nsAbAutoCompleteMyDomain.js">diff</a> |
<a href="/comm-central/comparison/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_nsAbAutoCompleteMyDomain.js">comparison</a> |
<a href="/comm-central/log/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_nsAbAutoCompleteMyDomain.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch1.js">mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch1.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch1.js">file</a> |
<a href="/comm-central/annotate/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch1.js">annotate</a> |
<a href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch1.js">diff</a> |
<a href="/comm-central/comparison/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch1.js">comparison</a> |
<a href="/comm-central/log/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch1.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch2.js">mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch2.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch2.js">file</a> |
<a href="/comm-central/annotate/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch2.js">annotate</a> |
<a href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch2.js">diff</a> |
<a href="/comm-central/comparison/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch2.js">comparison</a> |
<a href="/comm-central/log/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch2.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch3.js">mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch3.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch3.js">file</a> |
<a href="/comm-central/annotate/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch3.js">annotate</a> |
<a href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch3.js">diff</a> |
<a href="/comm-central/comparison/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch3.js">comparison</a> |
<a href="/comm-central/log/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch3.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch4.js">mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch4.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch4.js">file</a> |
<a href="/comm-central/annotate/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch4.js">annotate</a> |
<a href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch4.js">diff</a> |
<a href="/comm-central/comparison/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch4.js">comparison</a> |
<a href="/comm-central/log/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch4.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch5.js">mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch5.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch5.js">file</a> |
<a href="/comm-central/annotate/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch5.js">annotate</a> |
<a href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch5.js">diff</a> |
<a href="/comm-central/comparison/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch5.js">comparison</a> |
<a href="/comm-central/log/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch5.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch6.js">mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch6.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch6.js">file</a> |
<a href="/comm-central/annotate/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch6.js">annotate</a> |
<a href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch6.js">diff</a> |
<a href="/comm-central/comparison/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch6.js">comparison</a> |
<a href="/comm-central/log/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch6.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch7.js">mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch7.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch7.js">file</a> |
<a href="/comm-central/annotate/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch7.js">annotate</a> |
<a href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch7.js">diff</a> |
<a href="/comm-central/comparison/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch7.js">comparison</a> |
<a href="/comm-central/log/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch7.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_nsAbManager1.js">mailnews/addrbook/test/unit/test_nsAbManager1.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_nsAbManager1.js">file</a> |
<a href="/comm-central/annotate/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_nsAbManager1.js">annotate</a> |
<a href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_nsAbManager1.js">diff</a> |
<a href="/comm-central/comparison/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_nsAbManager1.js">comparison</a> |
<a href="/comm-central/log/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_nsAbManager1.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_nsAbManager2.js">mailnews/addrbook/test/unit/test_nsAbManager2.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_nsAbManager2.js">file</a> |
<a href="/comm-central/annotate/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_nsAbManager2.js">annotate</a> |
<a href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_nsAbManager2.js">diff</a> |
<a href="/comm-central/comparison/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_nsAbManager2.js">comparison</a> |
<a href="/comm-central/log/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_nsAbManager2.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_nsAbManager3.js">mailnews/addrbook/test/unit/test_nsAbManager3.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_nsAbManager3.js">file</a> |
<a href="/comm-central/annotate/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_nsAbManager3.js">annotate</a> |
<a href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_nsAbManager3.js">diff</a> |
<a href="/comm-central/comparison/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_nsAbManager3.js">comparison</a> |
<a href="/comm-central/log/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_nsAbManager3.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_nsIAbCard.js">mailnews/addrbook/test/unit/test_nsIAbCard.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_nsIAbCard.js">file</a> |
<a href="/comm-central/annotate/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_nsIAbCard.js">annotate</a> |
<a href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_nsIAbCard.js">diff</a> |
<a href="/comm-central/comparison/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_nsIAbCard.js">comparison</a> |
<a href="/comm-central/log/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_nsIAbCard.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_uid.js">mailnews/addrbook/test/unit/test_uid.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_uid.js">file</a> |
<a href="/comm-central/annotate/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_uid.js">annotate</a> |
<a href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_uid.js">diff</a> |
<a href="/comm-central/comparison/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_uid.js">comparison</a> |
<a href="/comm-central/log/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_uid.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_uuid.js">mailnews/addrbook/test/unit/test_uuid.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_uuid.js">file</a> |
<a href="/comm-central/annotate/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_uuid.js">annotate</a> |
<a href="/comm-central/diff/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_uuid.js">diff</a> |
<a href="/comm-central/comparison/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_uuid.js">comparison</a> |
<a href="/comm-central/log/bd2ed7ad33c9714f381b6d8c5d9d8c5f4a1d40d8/mailnews/addrbook/test/unit/test_uuid.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/.eslintignore</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/.eslintignore</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -23,17 +23,16 @@ build/**</span>
<a href="#l1.4"></a><span id="l1.4"> chat/**</span>
<a href="#l1.5"></a><span id="l1.5"> editor/**</span>
<a href="#l1.6"></a><span id="l1.6"> im/**</span>
<a href="#l1.7"></a><span id="l1.7"> ldap/**</span>
<a href="#l1.8"></a><span id="l1.8"> suite/**</span>
<a href="#l1.9"></a><span id="l1.9"> </span>
<a href="#l1.10"></a><span id="l1.10"> # mailnews exclusions</span>
<a href="#l1.11"></a><span id="l1.11"> mailnews/mailnews.js</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-mailnews/addrbook/*</span>
<a href="#l1.13"></a><span id="l1.13"> mailnews/base/*</span>
<a href="#l1.14"></a><span id="l1.14"> mailnews/build/*</span>
<a href="#l1.15"></a><span id="l1.15"> mailnews/compose/*</span>
<a href="#l1.16"></a><span id="l1.16"> mailnews/db/*</span>
<a href="#l1.17"></a><span id="l1.17"> mailnews/imap/*</span>
<a href="#l1.18"></a><span id="l1.18"> mailnews/import/*</span>
<a href="#l1.19"></a><span id="l1.19"> mailnews/intl/*</span>
<a href="#l1.20"></a><span id="l1.20"> mailnews/jsaccount/*</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/addrbook/content/abAddressBookNameDialog.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/addrbook/content/abAddressBookNameDialog.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -1,30 +1,31 @@</span>
<a href="#l2.4"></a><span id="l2.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l2.5"></a><span id="l2.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l2.6"></a><span id="l2.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l2.7"></a><span id="l2.7"> </span>
<a href="#l2.8"></a><span id="l2.8"> ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l2.9"></a><span id="l2.9" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l2.10"></a><span id="l2.10" class="difflineplus">+var {</span>
<a href="#l2.11"></a><span id="l2.11" class="difflineplus">+  fixIterator,</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+} = ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;, null);</span>
<a href="#l2.13"></a><span id="l2.13"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l2.14"></a><span id="l2.14"> </span>
<a href="#l2.15"></a><span id="l2.15"> var gOkButton;</span>
<a href="#l2.16"></a><span id="l2.16"> var gNameInput;</span>
<a href="#l2.17"></a><span id="l2.17"> var gDirectory = null;</span>
<a href="#l2.18"></a><span id="l2.18"> </span>
<a href="#l2.19"></a><span id="l2.19"> var kPersonalAddressbookURI = &quot;moz-abmdbdirectory://abook.mab&quot;;</span>
<a href="#l2.20"></a><span id="l2.20"> var kCollectedAddressbookURI = &quot;moz-abmdbdirectory://history.mab&quot;;</span>
<a href="#l2.21"></a><span id="l2.21"> var kAllDirectoryRoot = &quot;moz-abdirectory://&quot;;</span>
<a href="#l2.22"></a><span id="l2.22"> var kPABDirectory = 2; // defined in nsDirPrefs.h</span>
<a href="#l2.23"></a><span id="l2.23"> </span>
<a href="#l2.24"></a><span id="l2.24" class="difflineminus">-function abNameOnLoad()</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineminus">-{</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineplus">+function abNameOnLoad() {</span>
<a href="#l2.27"></a><span id="l2.27">   // Get the document elements.</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineminus">-  gOkButton = document.documentElement.getButton('accept');</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineminus">-  gNameInput = document.getElementById('name');</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineplus">+  gOkButton = document.documentElement.getButton(&quot;accept&quot;);</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+  gNameInput = document.getElementById(&quot;name&quot;);</span>
<a href="#l2.32"></a><span id="l2.32"> </span>
<a href="#l2.33"></a><span id="l2.33">   // look in arguments[0] for parameters to see if we have a directory or not</span>
<a href="#l2.34"></a><span id="l2.34">   if (&quot;arguments&quot; in window &amp;&amp; window.arguments[0] &amp;&amp;</span>
<a href="#l2.35"></a><span id="l2.35">       &quot;selectedDirectory&quot; in window.arguments[0]) {</span>
<a href="#l2.36"></a><span id="l2.36">     gDirectory = window.arguments[0].selectedDirectory;</span>
<a href="#l2.37"></a><span id="l2.37">     gNameInput.value = gDirectory.dirName;</span>
<a href="#l2.38"></a><span id="l2.38">   }</span>
<a href="#l2.39"></a><span id="l2.39"> </span>
<a href="#l2.40"></a><span id="l2.40" class="difflineat">@@ -49,18 +50,17 @@ function abNameOnLoad()</span>
<a href="#l2.41"></a><span id="l2.41">     document.documentElement.buttons = &quot;accept&quot;;</span>
<a href="#l2.42"></a><span id="l2.42">     document.documentElement.removeAttribute(&quot;ondialogaccept&quot;);</span>
<a href="#l2.43"></a><span id="l2.43">   } else {</span>
<a href="#l2.44"></a><span id="l2.44">     gNameInput.focus();</span>
<a href="#l2.45"></a><span id="l2.45">     abNameDoOkEnabling();</span>
<a href="#l2.46"></a><span id="l2.46">   }</span>
<a href="#l2.47"></a><span id="l2.47"> }</span>
<a href="#l2.48"></a><span id="l2.48"> </span>
<a href="#l2.49"></a><span id="l2.49" class="difflineminus">-function abNameOKButton()</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineminus">-{</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineplus">+function abNameOKButton() {</span>
<a href="#l2.52"></a><span id="l2.52">   var newName = gNameInput.value.trim();</span>
<a href="#l2.53"></a><span id="l2.53"> </span>
<a href="#l2.54"></a><span id="l2.54">   // Do not allow an already existing name.</span>
<a href="#l2.55"></a><span id="l2.55">   for (let ab of fixIterator(MailServices.ab.directories,</span>
<a href="#l2.56"></a><span id="l2.56">                              Ci.nsIAbDirectory)) {</span>
<a href="#l2.57"></a><span id="l2.57">     if ((ab.dirName.toLowerCase() == newName.toLowerCase()) &amp;&amp;</span>
<a href="#l2.58"></a><span id="l2.58">         (!gDirectory || (ab.URI != gDirectory.URI))) {</span>
<a href="#l2.59"></a><span id="l2.59">       const kAlertTitle = document.getElementById(&quot;bundle_addressBook&quot;)</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineat">@@ -77,12 +77,11 @@ function abNameOKButton()</span>
<a href="#l2.61"></a><span id="l2.61">   if (gDirectory)</span>
<a href="#l2.62"></a><span id="l2.62">     gDirectory.dirName = newName;</span>
<a href="#l2.63"></a><span id="l2.63">   else</span>
<a href="#l2.64"></a><span id="l2.64">     MailServices.ab.newAddressBook(newName, &quot;&quot;, kPABDirectory);</span>
<a href="#l2.65"></a><span id="l2.65"> </span>
<a href="#l2.66"></a><span id="l2.66">   return true;</span>
<a href="#l2.67"></a><span id="l2.67"> }</span>
<a href="#l2.68"></a><span id="l2.68"> </span>
<a href="#l2.69"></a><span id="l2.69" class="difflineminus">-function abNameDoOkEnabling()</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineminus">-{</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineplus">+function abNameDoOkEnabling() {</span>
<a href="#l2.72"></a><span id="l2.72">   gOkButton.disabled = gNameInput.value.trim() == &quot;&quot;;</span>
<a href="#l2.73"></a><span id="l2.73"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/addrbook/content/abDragDrop.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/addrbook/content/abDragDrop.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -1,28 +1,31 @@</span>
<a href="#l3.4"></a><span id="l3.4"> /* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l3.5"></a><span id="l3.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l3.6"></a><span id="l3.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l3.7"></a><span id="l3.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l3.8"></a><span id="l3.8"> </span>
<a href="#l3.9"></a><span id="l3.9" class="difflineminus">-ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l3.10"></a><span id="l3.10" class="difflineplus">+/* import-globals-from ../../../mail/base/content/nsDragAndDrop.js */</span>
<a href="#l3.11"></a><span id="l3.11" class="difflineplus">+/* import-globals-from ../../../mail/components/addrbook/content/abCommon.js */</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+/* import-globals-from ../../../mail/components/compose/content/addressingWidgetOverlay.js */</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+/* import-globals-from abResultsPane.js */</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+</span>
<a href="#l3.15"></a><span id="l3.15"> ChromeUtils.import(&quot;resource://gre/modules/PluralForm.jsm&quot;);</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l3.17"></a><span id="l3.17"> </span>
<a href="#l3.18"></a><span id="l3.18"> // Returns the load context for the current window</span>
<a href="#l3.19"></a><span id="l3.19"> function getLoadContext() {</span>
<a href="#l3.20"></a><span id="l3.20">   return window.docShell.QueryInterface(Ci.nsILoadContext);</span>
<a href="#l3.21"></a><span id="l3.21"> }</span>
<a href="#l3.22"></a><span id="l3.22"> </span>
<a href="#l3.23"></a><span id="l3.23"> var abFlavorDataProvider = {</span>
<a href="#l3.24"></a><span id="l3.24">   QueryInterface: ChromeUtils.generateQI([Ci.nsIFlavorDataProvider]),</span>
<a href="#l3.25"></a><span id="l3.25"> </span>
<a href="#l3.26"></a><span id="l3.26" class="difflineminus">-  getFlavorData: function(aTransferable, aFlavor, aData, aDataLen)</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineminus">-  {</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineminus">-    if (aFlavor == &quot;application/x-moz-file-promise&quot;)</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineminus">-    {</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineplus">+  getFlavorData(aTransferable, aFlavor, aData, aDataLen) {</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+    if (aFlavor == &quot;application/x-moz-file-promise&quot;) {</span>
<a href="#l3.32"></a><span id="l3.32">       var primitive = {};</span>
<a href="#l3.33"></a><span id="l3.33">       aTransferable.getTransferData(&quot;text/vcard&quot;, primitive, {});</span>
<a href="#l3.34"></a><span id="l3.34">       var vCard = primitive.value.QueryInterface(Ci.nsISupportsString).data;</span>
<a href="#l3.35"></a><span id="l3.35">       aTransferable.getTransferData(&quot;application/x-moz-file-promise-dest-filename&quot;, primitive, {});</span>
<a href="#l3.36"></a><span id="l3.36">       var leafName = primitive.value.QueryInterface(Ci.nsISupportsString).data;</span>
<a href="#l3.37"></a><span id="l3.37">       aTransferable.getTransferData(&quot;application/x-moz-file-promise-dir&quot;, primitive, {});</span>
<a href="#l3.38"></a><span id="l3.38">       var localFile = primitive.value.QueryInterface(Ci.nsIFile).clone();</span>
<a href="#l3.39"></a><span id="l3.39">       localFile.append(leafName);</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineat">@@ -31,22 +34,21 @@ var abFlavorDataProvider = {</span>
<a href="#l3.41"></a><span id="l3.41">       ofStream.init(localFile, -1, -1, 0);</span>
<a href="#l3.42"></a><span id="l3.42">       var converter = Cc[&quot;@mozilla.org/intl/converter-output-stream;1&quot;].createInstance(Ci.nsIConverterOutputStream);</span>
<a href="#l3.43"></a><span id="l3.43">       converter.init(ofStream, null);</span>
<a href="#l3.44"></a><span id="l3.44">       converter.writeString(vCard);</span>
<a href="#l3.45"></a><span id="l3.45">       converter.close();</span>
<a href="#l3.46"></a><span id="l3.46"> </span>
<a href="#l3.47"></a><span id="l3.47">       aData.value = localFile;</span>
<a href="#l3.48"></a><span id="l3.48">     }</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineminus">-  }</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineplus">+  },</span>
<a href="#l3.51"></a><span id="l3.51"> };</span>
<a href="#l3.52"></a><span id="l3.52"> </span>
<a href="#l3.53"></a><span id="l3.53"> var abResultsPaneObserver = {</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineminus">-  onDragStart: function (aEvent, aXferData, aDragAction)</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineminus">-    {</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineplus">+  onDragStart(aEvent, aXferData, aDragAction) {</span>
<a href="#l3.57"></a><span id="l3.57">       var selectedRows = GetSelectedRows();</span>
<a href="#l3.58"></a><span id="l3.58"> </span>
<a href="#l3.59"></a><span id="l3.59">       if (!selectedRows)</span>
<a href="#l3.60"></a><span id="l3.60">         return;</span>
<a href="#l3.61"></a><span id="l3.61"> </span>
<a href="#l3.62"></a><span id="l3.62">       var selectedAddresses = GetSelectedAddresses();</span>
<a href="#l3.63"></a><span id="l3.63"> </span>
<a href="#l3.64"></a><span id="l3.64">       aXferData.data = new TransferData();</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineat">@@ -71,34 +73,30 @@ var abResultsPaneObserver = {</span>
<a href="#l3.66"></a><span id="l3.66">       var card = GetSelectedCard();</span>
<a href="#l3.67"></a><span id="l3.67">       if (card &amp;&amp; card.displayName) {</span>
<a href="#l3.68"></a><span id="l3.68">         let vCard = card.translateTo(&quot;vcard&quot;);</span>
<a href="#l3.69"></a><span id="l3.69">         aXferData.data.addDataForFlavour(&quot;text/vcard&quot;, decodeURIComponent(vCard));</span>
<a href="#l3.70"></a><span id="l3.70">         aXferData.data.addDataForFlavour(&quot;application/x-moz-file-promise-dest-filename&quot;, card.displayName + &quot;.vcf&quot;);</span>
<a href="#l3.71"></a><span id="l3.71">         aXferData.data.addDataForFlavour(&quot;application/x-moz-file-promise-url&quot;, &quot;data:text/vcard,&quot; + vCard);</span>
<a href="#l3.72"></a><span id="l3.72">         aXferData.data.addDataForFlavour(&quot;application/x-moz-file-promise&quot;, abFlavorDataProvider);</span>
<a href="#l3.73"></a><span id="l3.73">       }</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineminus">-    },</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineplus">+  },</span>
<a href="#l3.76"></a><span id="l3.76"> </span>
<a href="#l3.77"></a><span id="l3.77" class="difflineminus">-  onDrop: function (aEvent, aXferData, aDragSession)</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineminus">-    {</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineminus">-    },</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineplus">+  onDrop(aEvent, aXferData, aDragSession) {</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineplus">+  },</span>
<a href="#l3.82"></a><span id="l3.82"> </span>
<a href="#l3.83"></a><span id="l3.83" class="difflineminus">-  onDragExit: function (aEvent, aDragSession)</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineminus">-    {</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineminus">-    },</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineplus">+  onDragExit(aEvent, aDragSession) {</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineplus">+  },</span>
<a href="#l3.88"></a><span id="l3.88"> </span>
<a href="#l3.89"></a><span id="l3.89" class="difflineminus">-  onDragOver: function (aEvent, aFlavour, aDragSession)</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineminus">-    {</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineminus">-    },</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineplus">+  onDragOver(aEvent, aFlavour, aDragSession) {</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineplus">+  },</span>
<a href="#l3.94"></a><span id="l3.94"> </span>
<a href="#l3.95"></a><span id="l3.95" class="difflineminus">-  getSupportedFlavours: function ()</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineminus">-    {</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineminus">-      return null;</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineminus">-    }</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineplus">+  getSupportedFlavours() {</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineplus">+    return null;</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineplus">+  },</span>
<a href="#l3.102"></a><span id="l3.102"> };</span>
<a href="#l3.103"></a><span id="l3.103"> </span>
<a href="#l3.104"></a><span id="l3.104"> </span>
<a href="#l3.105"></a><span id="l3.105"> var dragService = Cc[&quot;@mozilla.org/widget/dragservice;1&quot;]</span>
<a href="#l3.106"></a><span id="l3.106">                     .getService(Ci.nsIDragService);</span>
<a href="#l3.107"></a><span id="l3.107"> </span>
<a href="#l3.108"></a><span id="l3.108"> var abDirTreeObserver = {</span>
<a href="#l3.109"></a><span id="l3.109">   /**</span>
<a href="#l3.110"></a><span id="l3.110" class="difflineat">@@ -121,18 +119,17 @@ var abDirTreeObserver = {</span>
<a href="#l3.111"></a><span id="l3.111">    *   (cards currently have to exist outside list for list to work correctly)</span>
<a href="#l3.112"></a><span id="l3.112">    *   mailing list      -&gt; different address book = MOVE only</span>
<a href="#l3.113"></a><span id="l3.113">    *   (lists currently need to have unique names)</span>
<a href="#l3.114"></a><span id="l3.114">    *   card in mailing list -&gt; parent mailing list = Not allowed</span>
<a href="#l3.115"></a><span id="l3.115">    *   card in mailing list -&gt; other mailing list  = MOVE or COPY</span>
<a href="#l3.116"></a><span id="l3.116">    *   card in mailing list -&gt; other address book  = MOVE or COPY</span>
<a href="#l3.117"></a><span id="l3.117">    *   read only directory item -&gt; anywhere        = COPY only</span>
<a href="#l3.118"></a><span id="l3.118">    */</span>
<a href="#l3.119"></a><span id="l3.119" class="difflineminus">-  canDrop: function(index, orientation, dataTransfer)</span>
<a href="#l3.120"></a><span id="l3.120" class="difflineminus">-  {</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineplus">+  canDrop(index, orientation, dataTransfer) {</span>
<a href="#l3.122"></a><span id="l3.122">     if (orientation != Ci.nsITreeView.DROP_ON)</span>
<a href="#l3.123"></a><span id="l3.123">       return false;</span>
<a href="#l3.124"></a><span id="l3.124">     if (!dataTransfer.types.includes(&quot;moz/abcard&quot;)) {</span>
<a href="#l3.125"></a><span id="l3.125">       return false;</span>
<a href="#l3.126"></a><span id="l3.126">     }</span>
<a href="#l3.127"></a><span id="l3.127"> </span>
<a href="#l3.128"></a><span id="l3.128">     let targetURI = gDirectoryTreeView.getDirectoryAtIndex(index).URI;</span>
<a href="#l3.129"></a><span id="l3.129"> </span>
<a href="#l3.130"></a><span id="l3.130" class="difflineat">@@ -164,65 +161,60 @@ var abDirTreeObserver = {</span>
<a href="#l3.131"></a><span id="l3.131"> </span>
<a href="#l3.132"></a><span id="l3.132">     // XXX Due to bug 373125/bug 349044 we can't specify a default action,</span>
<a href="#l3.133"></a><span id="l3.133">     // so we default to move and this means that the user would have to press</span>
<a href="#l3.134"></a><span id="l3.134">     // ctrl to copy which most users don't realize.</span>
<a href="#l3.135"></a><span id="l3.135">     //</span>
<a href="#l3.136"></a><span id="l3.136">     // If target directory is a mailing list, then only allow copies.</span>
<a href="#l3.137"></a><span id="l3.137">     //    if (targetDirectory.isMailList &amp;&amp;</span>
<a href="#l3.138"></a><span id="l3.138">     //   dragSession.dragAction != Ci.nsIDragService.DRAGDROP_ACTION_COPY)</span>
<a href="#l3.139"></a><span id="l3.139" class="difflineminus">-    //return false;</span>
<a href="#l3.140"></a><span id="l3.140" class="difflineplus">+    // return false;</span>
<a href="#l3.141"></a><span id="l3.141"> </span>
<a href="#l3.142"></a><span id="l3.142">     var srcDirectory = GetDirectoryFromURI(srcURI);</span>
<a href="#l3.143"></a><span id="l3.143"> </span>
<a href="#l3.144"></a><span id="l3.144">     // Only allow copy from read-only directories.</span>
<a href="#l3.145"></a><span id="l3.145">     if (srcDirectory.readOnly &amp;&amp;</span>
<a href="#l3.146"></a><span id="l3.146" class="difflineminus">-        dragSession.dragAction != Ci.</span>
<a href="#l3.147"></a><span id="l3.147" class="difflineminus">-                                  nsIDragService.DRAGDROP_ACTION_COPY)</span>
<a href="#l3.148"></a><span id="l3.148" class="difflineplus">+        dragSession.dragAction != Ci.nsIDragService.DRAGDROP_ACTION_COPY) {</span>
<a href="#l3.149"></a><span id="l3.149">       return false;</span>
<a href="#l3.150"></a><span id="l3.150" class="difflineplus">+    }</span>
<a href="#l3.151"></a><span id="l3.151"> </span>
<a href="#l3.152"></a><span id="l3.152">     // Go through the cards checking to see if one of them is a mailing list</span>
<a href="#l3.153"></a><span id="l3.153">     // (if we are attempting a copy) - we can't copy mailing lists as</span>
<a href="#l3.154"></a><span id="l3.154">     // that would give us duplicate names which isn't allowed at the</span>
<a href="#l3.155"></a><span id="l3.155">     // moment.</span>
<a href="#l3.156"></a><span id="l3.156">     var draggingMailList = false;</span>
<a href="#l3.157"></a><span id="l3.157"> </span>
<a href="#l3.158"></a><span id="l3.158">     // The data contains the a string of &quot;selected rows&quot;, eg.: &quot;1,2&quot;.</span>
<a href="#l3.159"></a><span id="l3.159">     var rows = dataTransfer.getData(&quot;moz/abcard&quot;).split(&quot;,&quot;).map(j =&gt; parseInt(j, 10));</span>
<a href="#l3.160"></a><span id="l3.160"> </span>
<a href="#l3.161"></a><span id="l3.161" class="difflineminus">-    for (var j = 0; j &lt; rows.length; j++)</span>
<a href="#l3.162"></a><span id="l3.162" class="difflineminus">-    {</span>
<a href="#l3.163"></a><span id="l3.163" class="difflineminus">-      if (gAbView.getCardFromRow(rows[j]).isMailList)</span>
<a href="#l3.164"></a><span id="l3.164" class="difflineminus">-      {</span>
<a href="#l3.165"></a><span id="l3.165" class="difflineplus">+    for (var j = 0; j &lt; rows.length; j++) {</span>
<a href="#l3.166"></a><span id="l3.166" class="difflineplus">+      if (gAbView.getCardFromRow(rows[j]).isMailList) {</span>
<a href="#l3.167"></a><span id="l3.167">         draggingMailList = true;</span>
<a href="#l3.168"></a><span id="l3.168">         break;</span>
<a href="#l3.169"></a><span id="l3.169">       }</span>
<a href="#l3.170"></a><span id="l3.170">     }</span>
<a href="#l3.171"></a><span id="l3.171"> </span>
<a href="#l3.172"></a><span id="l3.172">     // The rest of the cases - allow cards for copy or move, but only allow</span>
<a href="#l3.173"></a><span id="l3.173">     // move of mailing lists if we're not going into another mailing list.</span>
<a href="#l3.174"></a><span id="l3.174">     if (draggingMailList &amp;&amp;</span>
<a href="#l3.175"></a><span id="l3.175">         (targetDirectory.isMailList ||</span>
<a href="#l3.176"></a><span id="l3.176" class="difflineminus">-         dragSession.dragAction == Ci.</span>
<a href="#l3.177"></a><span id="l3.177" class="difflineminus">-                                   nsIDragService.DRAGDROP_ACTION_COPY))</span>
<a href="#l3.178"></a><span id="l3.178" class="difflineminus">-    {</span>
<a href="#l3.179"></a><span id="l3.179" class="difflineplus">+         dragSession.dragAction == Ci.nsIDragService.DRAGDROP_ACTION_COPY)) {</span>
<a href="#l3.180"></a><span id="l3.180">       return false;</span>
<a href="#l3.181"></a><span id="l3.181">     }</span>
<a href="#l3.182"></a><span id="l3.182"> </span>
<a href="#l3.183"></a><span id="l3.183">     dragSession.canDrop = true;</span>
<a href="#l3.184"></a><span id="l3.184">     return true;</span>
<a href="#l3.185"></a><span id="l3.185">   },</span>
<a href="#l3.186"></a><span id="l3.186"> </span>
<a href="#l3.187"></a><span id="l3.187">   /**</span>
<a href="#l3.188"></a><span id="l3.188">    * onDrop - we don't need to check again for correctness as the</span>
<a href="#l3.189"></a><span id="l3.189">    * tree view calls canDrop just before calling onDrop.</span>
<a href="#l3.190"></a><span id="l3.190">    *</span>
<a href="#l3.191"></a><span id="l3.191">    */</span>
<a href="#l3.192"></a><span id="l3.192" class="difflineminus">-  onDrop: function(index, orientation, dataTransfer)</span>
<a href="#l3.193"></a><span id="l3.193" class="difflineminus">-  {</span>
<a href="#l3.194"></a><span id="l3.194" class="difflineplus">+  onDrop(index, orientation, dataTransfer) {</span>
<a href="#l3.195"></a><span id="l3.195">     var dragSession = dragService.getCurrentSession();</span>
<a href="#l3.196"></a><span id="l3.196">     if (!dragSession)</span>
<a href="#l3.197"></a><span id="l3.197">       return;</span>
<a href="#l3.198"></a><span id="l3.198">     if (!dataTransfer.types.includes(&quot;moz/abcard&quot;)) {</span>
<a href="#l3.199"></a><span id="l3.199">       return;</span>
<a href="#l3.200"></a><span id="l3.200">     }</span>
<a href="#l3.201"></a><span id="l3.201"> </span>
<a href="#l3.202"></a><span id="l3.202">     let targetURI = gDirectoryTreeView.getDirectoryAtIndex(index).URI;</span>
<a href="#l3.203"></a><span id="l3.203" class="difflineat">@@ -238,18 +230,17 @@ var abDirTreeObserver = {</span>
<a href="#l3.204"></a><span id="l3.204">     // - it's not for if we are moving or not.</span>
<a href="#l3.205"></a><span id="l3.205">     var needToCopyCard = true;</span>
<a href="#l3.206"></a><span id="l3.206">     if (srcURI.length &gt; targetURI.length) {</span>
<a href="#l3.207"></a><span id="l3.207">       result = srcURI.split(targetURI);</span>
<a href="#l3.208"></a><span id="l3.208">       if (result[0] != srcURI) {</span>
<a href="#l3.209"></a><span id="l3.209">         // src directory is a mailing list on target directory, no need to copy card</span>
<a href="#l3.210"></a><span id="l3.210">         needToCopyCard = false;</span>
<a href="#l3.211"></a><span id="l3.211">       }</span>
<a href="#l3.212"></a><span id="l3.212" class="difflineminus">-    }</span>
<a href="#l3.213"></a><span id="l3.213" class="difflineminus">-    else {</span>
<a href="#l3.214"></a><span id="l3.214" class="difflineplus">+    } else {</span>
<a href="#l3.215"></a><span id="l3.215">       result = targetURI.split(srcURI);</span>
<a href="#l3.216"></a><span id="l3.216">       if (result[0] != targetURI) {</span>
<a href="#l3.217"></a><span id="l3.217">         // target directory is a mailing list on src directory, no need to copy card</span>
<a href="#l3.218"></a><span id="l3.218">         needToCopyCard = false;</span>
<a href="#l3.219"></a><span id="l3.219">       }</span>
<a href="#l3.220"></a><span id="l3.220">     }</span>
<a href="#l3.221"></a><span id="l3.221"> </span>
<a href="#l3.222"></a><span id="l3.222">     // if we still think we have to copy the card,</span>
<a href="#l3.223"></a><span id="l3.223" class="difflineat">@@ -315,105 +306,88 @@ var abDirTreeObserver = {</span>
<a href="#l3.224"></a><span id="l3.224"> </span>
<a href="#l3.225"></a><span id="l3.225">     if (srcURI == kAllDirectoryRoot + &quot;?&quot;) {</span>
<a href="#l3.226"></a><span id="l3.226">       SetAbView(srcURI);</span>
<a href="#l3.227"></a><span id="l3.227">     }</span>
<a href="#l3.228"></a><span id="l3.228"> </span>
<a href="#l3.229"></a><span id="l3.229">     document.getElementById(&quot;statusText&quot;).label = cardsTransferredText;</span>
<a href="#l3.230"></a><span id="l3.230">   },</span>
<a href="#l3.231"></a><span id="l3.231"> </span>
<a href="#l3.232"></a><span id="l3.232" class="difflineminus">-  onToggleOpenState: function()</span>
<a href="#l3.233"></a><span id="l3.233" class="difflineminus">-  {</span>
<a href="#l3.234"></a><span id="l3.234" class="difflineplus">+  onToggleOpenState() {</span>
<a href="#l3.235"></a><span id="l3.235">   },</span>
<a href="#l3.236"></a><span id="l3.236"> </span>
<a href="#l3.237"></a><span id="l3.237" class="difflineminus">-  onCycleHeader: function(colID, elt)</span>
<a href="#l3.238"></a><span id="l3.238" class="difflineminus">-  {</span>
<a href="#l3.239"></a><span id="l3.239" class="difflineplus">+  onCycleHeader(colID, elt) {</span>
<a href="#l3.240"></a><span id="l3.240">   },</span>
<a href="#l3.241"></a><span id="l3.241"> </span>
<a href="#l3.242"></a><span id="l3.242" class="difflineminus">-  onCycleCell: function(row, colID)</span>
<a href="#l3.243"></a><span id="l3.243" class="difflineminus">-  {</span>
<a href="#l3.244"></a><span id="l3.244" class="difflineplus">+  onCycleCell(row, colID) {</span>
<a href="#l3.245"></a><span id="l3.245">   },</span>
<a href="#l3.246"></a><span id="l3.246"> </span>
<a href="#l3.247"></a><span id="l3.247" class="difflineminus">-  onSelectionChanged: function()</span>
<a href="#l3.248"></a><span id="l3.248" class="difflineminus">-  {</span>
<a href="#l3.249"></a><span id="l3.249" class="difflineplus">+  onSelectionChanged() {</span>
<a href="#l3.250"></a><span id="l3.250">   },</span>
<a href="#l3.251"></a><span id="l3.251"> </span>
<a href="#l3.252"></a><span id="l3.252" class="difflineminus">-  onPerformAction: function(action)</span>
<a href="#l3.253"></a><span id="l3.253" class="difflineminus">-  {</span>
<a href="#l3.254"></a><span id="l3.254" class="difflineplus">+  onPerformAction(action) {</span>
<a href="#l3.255"></a><span id="l3.255">   },</span>
<a href="#l3.256"></a><span id="l3.256"> </span>
<a href="#l3.257"></a><span id="l3.257" class="difflineminus">-  onPerformActionOnRow: function(action, row)</span>
<a href="#l3.258"></a><span id="l3.258" class="difflineminus">-  {</span>
<a href="#l3.259"></a><span id="l3.259" class="difflineplus">+  onPerformActionOnRow(action, row) {</span>
<a href="#l3.260"></a><span id="l3.260">   },</span>
<a href="#l3.261"></a><span id="l3.261"> </span>
<a href="#l3.262"></a><span id="l3.262" class="difflineminus">-  onPerformActionOnCell: function(action, row, colID)</span>
<a href="#l3.263"></a><span id="l3.263" class="difflineminus">-  {</span>
<a href="#l3.264"></a><span id="l3.264" class="difflineminus">-  }</span>
<a href="#l3.265"></a><span id="l3.265" class="difflineminus">-}</span>
<a href="#l3.266"></a><span id="l3.266" class="difflineplus">+  onPerformActionOnCell(action, row, colID) {</span>
<a href="#l3.267"></a><span id="l3.267" class="difflineplus">+  },</span>
<a href="#l3.268"></a><span id="l3.268" class="difflineplus">+};</span>
<a href="#l3.269"></a><span id="l3.269"> </span>
<a href="#l3.270"></a><span id="l3.270" class="difflineminus">-function DragAddressOverTargetControl(event)</span>
<a href="#l3.271"></a><span id="l3.271" class="difflineminus">-{</span>
<a href="#l3.272"></a><span id="l3.272" class="difflineplus">+function DragAddressOverTargetControl(event) {</span>
<a href="#l3.273"></a><span id="l3.273">   var dragSession = gDragService.getCurrentSession();</span>
<a href="#l3.274"></a><span id="l3.274"> </span>
<a href="#l3.275"></a><span id="l3.275">   if (!dragSession.isDataFlavorSupported(&quot;text/x-moz-address&quot;))</span>
<a href="#l3.276"></a><span id="l3.276">      return;</span>
<a href="#l3.277"></a><span id="l3.277"> </span>
<a href="#l3.278"></a><span id="l3.278">   var trans = Cc[&quot;@mozilla.org/widget/transferable;1&quot;]</span>
<a href="#l3.279"></a><span id="l3.279">                 .createInstance(Ci.nsITransferable);</span>
<a href="#l3.280"></a><span id="l3.280">   trans.init(getLoadContext());</span>
<a href="#l3.281"></a><span id="l3.281">   trans.addDataFlavor(&quot;text/x-moz-address&quot;);</span>
<a href="#l3.282"></a><span id="l3.282"> </span>
<a href="#l3.283"></a><span id="l3.283">   var canDrop = true;</span>
<a href="#l3.284"></a><span id="l3.284"> </span>
<a href="#l3.285"></a><span id="l3.285" class="difflineminus">-  for ( var i = 0; i &lt; dragSession.numDropItems; ++i )</span>
<a href="#l3.286"></a><span id="l3.286" class="difflineminus">-  {</span>
<a href="#l3.287"></a><span id="l3.287" class="difflineminus">-    dragSession.getData ( trans, i );</span>
<a href="#l3.288"></a><span id="l3.288" class="difflineminus">-    var dataObj = new Object();</span>
<a href="#l3.289"></a><span id="l3.289" class="difflineminus">-    var bestFlavor = new Object();</span>
<a href="#l3.290"></a><span id="l3.290" class="difflineminus">-    var len = new Object();</span>
<a href="#l3.291"></a><span id="l3.291" class="difflineminus">-    try</span>
<a href="#l3.292"></a><span id="l3.292" class="difflineminus">-    {</span>
<a href="#l3.293"></a><span id="l3.293" class="difflineminus">-      trans.getAnyTransferData ( bestFlavor, dataObj, len );</span>
<a href="#l3.294"></a><span id="l3.294" class="difflineminus">-    }</span>
<a href="#l3.295"></a><span id="l3.295" class="difflineminus">-    catch (ex)</span>
<a href="#l3.296"></a><span id="l3.296" class="difflineminus">-    {</span>
<a href="#l3.297"></a><span id="l3.297" class="difflineplus">+  for (var i = 0; i &lt; dragSession.numDropItems; ++i) {</span>
<a href="#l3.298"></a><span id="l3.298" class="difflineplus">+    dragSession.getData(trans, i);</span>
<a href="#l3.299"></a><span id="l3.299" class="difflineplus">+    var dataObj = {};</span>
<a href="#l3.300"></a><span id="l3.300" class="difflineplus">+    var bestFlavor = {};</span>
<a href="#l3.301"></a><span id="l3.301" class="difflineplus">+    var len = {};</span>
<a href="#l3.302"></a><span id="l3.302" class="difflineplus">+    try {</span>
<a href="#l3.303"></a><span id="l3.303" class="difflineplus">+      trans.getAnyTransferData(bestFlavor, dataObj, len);</span>
<a href="#l3.304"></a><span id="l3.304" class="difflineplus">+    } catch (ex) {</span>
<a href="#l3.305"></a><span id="l3.305">       canDrop = false;</span>
<a href="#l3.306"></a><span id="l3.306">       break;</span>
<a href="#l3.307"></a><span id="l3.307">     }</span>
<a href="#l3.308"></a><span id="l3.308">   }</span>
<a href="#l3.309"></a><span id="l3.309">   dragSession.canDrop = canDrop;</span>
<a href="#l3.310"></a><span id="l3.310"> }</span>
<a href="#l3.311"></a><span id="l3.311"> </span>
<a href="#l3.312"></a><span id="l3.312" class="difflineminus">-function DropAddressOverTargetControl(event)</span>
<a href="#l3.313"></a><span id="l3.313" class="difflineminus">-{</span>
<a href="#l3.314"></a><span id="l3.314" class="difflineplus">+function DropAddressOverTargetControl(event) {</span>
<a href="#l3.315"></a><span id="l3.315">   var dragSession = gDragService.getCurrentSession();</span>
<a href="#l3.316"></a><span id="l3.316"> </span>
<a href="#l3.317"></a><span id="l3.317">   var trans = Cc[&quot;@mozilla.org/widget/transferable;1&quot;].createInstance(Ci.nsITransferable);</span>
<a href="#l3.318"></a><span id="l3.318">   trans.addDataFlavor(&quot;text/x-moz-address&quot;);</span>
<a href="#l3.319"></a><span id="l3.319"> </span>
<a href="#l3.320"></a><span id="l3.320" class="difflineminus">-  for ( var i = 0; i &lt; dragSession.numDropItems; ++i )</span>
<a href="#l3.321"></a><span id="l3.321" class="difflineminus">-  {</span>
<a href="#l3.322"></a><span id="l3.322" class="difflineminus">-    dragSession.getData ( trans, i );</span>
<a href="#l3.323"></a><span id="l3.323" class="difflineminus">-    var dataObj = new Object();</span>
<a href="#l3.324"></a><span id="l3.324" class="difflineminus">-    var bestFlavor = new Object();</span>
<a href="#l3.325"></a><span id="l3.325" class="difflineminus">-    var len = new Object();</span>
<a href="#l3.326"></a><span id="l3.326" class="difflineplus">+  for (var i = 0; i &lt; dragSession.numDropItems; ++i) {</span>
<a href="#l3.327"></a><span id="l3.327" class="difflineplus">+    dragSession.getData(trans, i);</span>
<a href="#l3.328"></a><span id="l3.328" class="difflineplus">+    var dataObj = {};</span>
<a href="#l3.329"></a><span id="l3.329" class="difflineplus">+    var bestFlavor = {};</span>
<a href="#l3.330"></a><span id="l3.330" class="difflineplus">+    var len = {};</span>
<a href="#l3.331"></a><span id="l3.331"> </span>
<a href="#l3.332"></a><span id="l3.332">     // Ensure we catch any empty data that may have slipped through</span>
<a href="#l3.333"></a><span id="l3.333" class="difflineminus">-    try</span>
<a href="#l3.334"></a><span id="l3.334" class="difflineminus">-    {</span>
<a href="#l3.335"></a><span id="l3.335" class="difflineminus">-      trans.getAnyTransferData ( bestFlavor, dataObj, len);</span>
<a href="#l3.336"></a><span id="l3.336" class="difflineminus">-    }</span>
<a href="#l3.337"></a><span id="l3.337" class="difflineminus">-    catch (ex)</span>
<a href="#l3.338"></a><span id="l3.338" class="difflineminus">-    {</span>
<a href="#l3.339"></a><span id="l3.339" class="difflineplus">+    try {</span>
<a href="#l3.340"></a><span id="l3.340" class="difflineplus">+      trans.getAnyTransferData(bestFlavor, dataObj, len);</span>
<a href="#l3.341"></a><span id="l3.341" class="difflineplus">+    } catch (ex) {</span>
<a href="#l3.342"></a><span id="l3.342">       continue;</span>
<a href="#l3.343"></a><span id="l3.343">     }</span>
<a href="#l3.344"></a><span id="l3.344"> </span>
<a href="#l3.345"></a><span id="l3.345" class="difflineminus">-    if ( dataObj )</span>
<a href="#l3.346"></a><span id="l3.346" class="difflineplus">+    if (dataObj)</span>
<a href="#l3.347"></a><span id="l3.347">       dataObj = dataObj.value.QueryInterface(Ci.nsISupportsString);</span>
<a href="#l3.348"></a><span id="l3.348" class="difflineminus">-    if ( !dataObj )</span>
<a href="#l3.349"></a><span id="l3.349" class="difflineplus">+    if (!dataObj)</span>
<a href="#l3.350"></a><span id="l3.350">       continue;</span>
<a href="#l3.351"></a><span id="l3.351"> </span>
<a href="#l3.352"></a><span id="l3.352">     // pull the address out of the data object</span>
<a href="#l3.353"></a><span id="l3.353">     var address = dataObj.data.substring(0, len.value);</span>
<a href="#l3.354"></a><span id="l3.354">     if (!address)</span>
<a href="#l3.355"></a><span id="l3.355">       continue;</span>
<a href="#l3.356"></a><span id="l3.356"> </span>
<a href="#l3.357"></a><span id="l3.357">     DropRecipient(address);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/addrbook/content/abMailListDialog.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/addrbook/content/abMailListDialog.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -1,224 +1,198 @@</span>
<a href="#l4.4"></a><span id="l4.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l4.5"></a><span id="l4.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l4.6"></a><span id="l4.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l4.7"></a><span id="l4.7"> </span>
<a href="#l4.8"></a><span id="l4.8" class="difflineplus">+/* import-globals-from ../../../mail/components/addrbook/content/abCommon.js */</span>
<a href="#l4.9"></a><span id="l4.9" class="difflineplus">+/* import-globals-from ../../../mail/components/compose/content/addressingWidgetOverlay.js */</span>
<a href="#l4.10"></a><span id="l4.10" class="difflineplus">+</span>
<a href="#l4.11"></a><span id="l4.11" class="difflineplus">+ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+</span>
<a href="#l4.14"></a><span id="l4.14"> top.MAX_RECIPIENTS = 1;</span>
<a href="#l4.15"></a><span id="l4.15"> var inputElementType = &quot;&quot;;</span>
<a href="#l4.16"></a><span id="l4.16"> </span>
<a href="#l4.17"></a><span id="l4.17"> var gListCard;</span>
<a href="#l4.18"></a><span id="l4.18"> var gEditList;</span>
<a href="#l4.19"></a><span id="l4.19"> var oldListName = &quot;&quot;;</span>
<a href="#l4.20"></a><span id="l4.20"> var gLoadListeners = [];</span>
<a href="#l4.21"></a><span id="l4.21"> var gSaveListeners = [];</span>
<a href="#l4.22"></a><span id="l4.22"> </span>
<a href="#l4.23"></a><span id="l4.23" class="difflineminus">-try</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineminus">-{</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineplus">+try {</span>
<a href="#l4.26"></a><span id="l4.26">   var gDragService = Cc[&quot;@mozilla.org/widget/dragservice;1&quot;]</span>
<a href="#l4.27"></a><span id="l4.27">                        .getService(Ci.nsIDragService);</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineminus">-}</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineminus">-catch (e)</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineminus">-{</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+} catch (e) {</span>
<a href="#l4.32"></a><span id="l4.32"> }</span>
<a href="#l4.33"></a><span id="l4.33"> </span>
<a href="#l4.34"></a><span id="l4.34"> // Returns the load context for the current window</span>
<a href="#l4.35"></a><span id="l4.35"> function getLoadContext() {</span>
<a href="#l4.36"></a><span id="l4.36">   return window.docShell.QueryInterface(Ci.nsILoadContext);</span>
<a href="#l4.37"></a><span id="l4.37"> }</span>
<a href="#l4.38"></a><span id="l4.38"> </span>
<a href="#l4.39"></a><span id="l4.39" class="difflineminus">-function mailingListExists(listname)</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineminus">-{</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineminus">-  if (MailServices.ab.mailListNameExists(listname))</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineminus">-  {</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineplus">+function mailingListExists(listname) {</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+  if (MailServices.ab.mailListNameExists(listname)) {</span>
<a href="#l4.45"></a><span id="l4.45">     Services.prompt.alert(window,</span>
<a href="#l4.46"></a><span id="l4.46">       gAddressBookBundle.getString(&quot;mailListNameExistsTitle&quot;),</span>
<a href="#l4.47"></a><span id="l4.47">       gAddressBookBundle.getString(&quot;mailListNameExistsMessage&quot;));</span>
<a href="#l4.48"></a><span id="l4.48">     return true;</span>
<a href="#l4.49"></a><span id="l4.49">   }</span>
<a href="#l4.50"></a><span id="l4.50">   return false;</span>
<a href="#l4.51"></a><span id="l4.51"> }</span>
<a href="#l4.52"></a><span id="l4.52"> </span>
<a href="#l4.53"></a><span id="l4.53" class="difflineminus">-function GetListValue(mailList, doAdd)</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineminus">-{</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineplus">+function GetListValue(mailList, doAdd) {</span>
<a href="#l4.56"></a><span id="l4.56">   var listname = document.getElementById(&quot;ListName&quot;).value.trim();</span>
<a href="#l4.57"></a><span id="l4.57"> </span>
<a href="#l4.58"></a><span id="l4.58" class="difflineminus">-  if (listname.length == 0)</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineminus">-  {</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineplus">+  if (listname.length == 0) {</span>
<a href="#l4.61"></a><span id="l4.61">     var alertText = gAddressBookBundle.getString(&quot;emptyListName&quot;);</span>
<a href="#l4.62"></a><span id="l4.62">     alert(alertText);</span>
<a href="#l4.63"></a><span id="l4.63">     return false;</span>
<a href="#l4.64"></a><span id="l4.64">   }</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineminus">-  else</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineminus">-  {</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineminus">-    var canonicalNewListName = listname.toLowerCase();</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineminus">-    var canonicalOldListName = oldListName.toLowerCase();</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineminus">-    if (doAdd)</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineminus">-    {</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineminus">-      if (mailingListExists(canonicalNewListName))</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineminus">-        return false;</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineminus">-    }</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineminus">-    else if (canonicalOldListName != canonicalNewListName)</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineminus">-    {</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineminus">-      if (mailingListExists(canonicalNewListName))</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineminus">-        return false;</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineminus">-    }</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineplus">+</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineplus">+  var canonicalNewListName = listname.toLowerCase();</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineplus">+  var canonicalOldListName = oldListName.toLowerCase();</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineplus">+  if (doAdd) {</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineplus">+    if (mailingListExists(canonicalNewListName))</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineplus">+      return false;</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineplus">+  } else if (canonicalOldListName != canonicalNewListName) {</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineplus">+    if (mailingListExists(canonicalNewListName))</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineplus">+      return false;</span>
<a href="#l4.88"></a><span id="l4.88">   }</span>
<a href="#l4.89"></a><span id="l4.89"> </span>
<a href="#l4.90"></a><span id="l4.90">   mailList.isMailList = true;</span>
<a href="#l4.91"></a><span id="l4.91">   mailList.dirName = listname;</span>
<a href="#l4.92"></a><span id="l4.92" class="difflineminus">-  mailList.listNickName = document.getElementById('ListNickName').value;</span>
<a href="#l4.93"></a><span id="l4.93" class="difflineminus">-  mailList.description = document.getElementById('ListDescription').value;</span>
<a href="#l4.94"></a><span id="l4.94" class="difflineplus">+  mailList.listNickName = document.getElementById(&quot;ListNickName&quot;).value;</span>
<a href="#l4.95"></a><span id="l4.95" class="difflineplus">+  mailList.description = document.getElementById(&quot;ListDescription&quot;).value;</span>
<a href="#l4.96"></a><span id="l4.96"> </span>
<a href="#l4.97"></a><span id="l4.97">   var oldTotal = mailList.addressLists.length;</span>
<a href="#l4.98"></a><span id="l4.98">   var i = 1;</span>
<a href="#l4.99"></a><span id="l4.99">   var pos = 0;</span>
<a href="#l4.100"></a><span id="l4.100">   var inputField, fieldValue, cardproperty;</span>
<a href="#l4.101"></a><span id="l4.101" class="difflineminus">-  while ((inputField = awGetInputElement(i)))</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineminus">-  {</span>
<a href="#l4.103"></a><span id="l4.103" class="difflineplus">+  while ((inputField = awGetInputElement(i))) {</span>
<a href="#l4.104"></a><span id="l4.104"> </span>
<a href="#l4.105"></a><span id="l4.105">     fieldValue = inputField.value;</span>
<a href="#l4.106"></a><span id="l4.106"> </span>
<a href="#l4.107"></a><span id="l4.107" class="difflineminus">-    if (doAdd || (!doAdd &amp;&amp; pos &gt;= oldTotal))</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineplus">+    if (doAdd || pos &gt;= oldTotal)</span>
<a href="#l4.109"></a><span id="l4.109">       cardproperty = Cc[&quot;@mozilla.org/addressbook/cardproperty;1&quot;].createInstance();</span>
<a href="#l4.110"></a><span id="l4.110">     else</span>
<a href="#l4.111"></a><span id="l4.111">       cardproperty = mailList.addressLists.queryElementAt(pos, Ci.nsIAbCard);</span>
<a href="#l4.112"></a><span id="l4.112"> </span>
<a href="#l4.113"></a><span id="l4.113" class="difflineminus">-    if (fieldValue == &quot;&quot;)</span>
<a href="#l4.114"></a><span id="l4.114" class="difflineminus">-    {</span>
<a href="#l4.115"></a><span id="l4.115" class="difflineplus">+    if (fieldValue == &quot;&quot;) {</span>
<a href="#l4.116"></a><span id="l4.116">       if (!doAdd &amp;&amp; cardproperty)</span>
<a href="#l4.117"></a><span id="l4.117" class="difflineminus">-      try</span>
<a href="#l4.118"></a><span id="l4.118" class="difflineminus">-      {</span>
<a href="#l4.119"></a><span id="l4.119" class="difflineplus">+      try {</span>
<a href="#l4.120"></a><span id="l4.120">         mailList.addressLists.removeElementAt(pos);</span>
<a href="#l4.121"></a><span id="l4.121">         --oldTotal;</span>
<a href="#l4.122"></a><span id="l4.122" class="difflineminus">-      }</span>
<a href="#l4.123"></a><span id="l4.123" class="difflineminus">-      catch(ex)</span>
<a href="#l4.124"></a><span id="l4.124" class="difflineminus">-      {</span>
<a href="#l4.125"></a><span id="l4.125" class="difflineplus">+      } catch (ex) {</span>
<a href="#l4.126"></a><span id="l4.126">         // Ignore attempting to remove an item</span>
<a href="#l4.127"></a><span id="l4.127">         // at a position greater than the number</span>
<a href="#l4.128"></a><span id="l4.128">         // of elements in the addressLists attribute</span>
<a href="#l4.129"></a><span id="l4.129">       }</span>
<a href="#l4.130"></a><span id="l4.130" class="difflineminus">-    }</span>
<a href="#l4.131"></a><span id="l4.131" class="difflineminus">-    else if (cardproperty)</span>
<a href="#l4.132"></a><span id="l4.132" class="difflineminus">-    {</span>
<a href="#l4.133"></a><span id="l4.133" class="difflineplus">+    } else if (cardproperty) {</span>
<a href="#l4.134"></a><span id="l4.134">       cardproperty = cardproperty.QueryInterface(Ci.nsIAbCard);</span>
<a href="#l4.135"></a><span id="l4.135" class="difflineminus">-      if (cardproperty)</span>
<a href="#l4.136"></a><span id="l4.136" class="difflineminus">-      {</span>
<a href="#l4.137"></a><span id="l4.137" class="difflineplus">+      if (cardproperty) {</span>
<a href="#l4.138"></a><span id="l4.138">         let addrObjects = MailServices.headerParser</span>
<a href="#l4.139"></a><span id="l4.139">                                       .makeFromDisplayAddress(fieldValue, {});</span>
<a href="#l4.140"></a><span id="l4.140" class="difflineminus">-        for (let j = 0; j &lt; addrObjects.length; j++)</span>
<a href="#l4.141"></a><span id="l4.141" class="difflineminus">-        {</span>
<a href="#l4.142"></a><span id="l4.142" class="difflineminus">-          if (j &gt; 0)</span>
<a href="#l4.143"></a><span id="l4.143" class="difflineminus">-          {</span>
<a href="#l4.144"></a><span id="l4.144" class="difflineplus">+        for (let j = 0; j &lt; addrObjects.length; j++) {</span>
<a href="#l4.145"></a><span id="l4.145" class="difflineplus">+          if (j &gt; 0) {</span>
<a href="#l4.146"></a><span id="l4.146">             cardproperty = Cc[&quot;@mozilla.org/addressbook/cardproperty;1&quot;].createInstance();</span>
<a href="#l4.147"></a><span id="l4.147">             cardproperty = cardproperty.QueryInterface(Ci.nsIAbCard);</span>
<a href="#l4.148"></a><span id="l4.148">           }</span>
<a href="#l4.149"></a><span id="l4.149">           cardproperty.primaryEmail = addrObjects[j].email;</span>
<a href="#l4.150"></a><span id="l4.150">           cardproperty.displayName = addrObjects[j].name || addrObjects[j].email;</span>
<a href="#l4.151"></a><span id="l4.151"> </span>
<a href="#l4.152"></a><span id="l4.152" class="difflineminus">-          if (doAdd || (doAdd == false &amp;&amp; pos &gt;= oldTotal))</span>
<a href="#l4.153"></a><span id="l4.153" class="difflineplus">+          if (doAdd || pos &gt;= oldTotal)</span>
<a href="#l4.154"></a><span id="l4.154">             mailList.addressLists.appendElement(cardproperty);</span>
<a href="#l4.155"></a><span id="l4.155">         }</span>
<a href="#l4.156"></a><span id="l4.156">         pos++;</span>
<a href="#l4.157"></a><span id="l4.157">       }</span>
<a href="#l4.158"></a><span id="l4.158">     }</span>
<a href="#l4.159"></a><span id="l4.159">     i++;</span>
<a href="#l4.160"></a><span id="l4.160">   }</span>
<a href="#l4.161"></a><span id="l4.161"> </span>
<a href="#l4.162"></a><span id="l4.162">   --i;</span>
<a href="#l4.163"></a><span id="l4.163"> </span>
<a href="#l4.164"></a><span id="l4.164" class="difflineminus">-  if (doAdd == false &amp;&amp; i &lt; oldTotal)</span>
<a href="#l4.165"></a><span id="l4.165" class="difflineminus">-  {</span>
<a href="#l4.166"></a><span id="l4.166" class="difflineplus">+  if (!doAdd &amp;&amp; i &lt; oldTotal) {</span>
<a href="#l4.167"></a><span id="l4.167">     for (var j = i; j &lt; oldTotal; j++)</span>
<a href="#l4.168"></a><span id="l4.168">       mailList.addressLists.removeElementAt(j);</span>
<a href="#l4.169"></a><span id="l4.169">   }</span>
<a href="#l4.170"></a><span id="l4.170">   return true;</span>
<a href="#l4.171"></a><span id="l4.171"> }</span>
<a href="#l4.172"></a><span id="l4.172"> </span>
<a href="#l4.173"></a><span id="l4.173" class="difflineminus">-function MailListOKButton()</span>
<a href="#l4.174"></a><span id="l4.174" class="difflineminus">-{</span>
<a href="#l4.175"></a><span id="l4.175" class="difflineminus">-  var popup = document.getElementById('abPopup');</span>
<a href="#l4.176"></a><span id="l4.176" class="difflineminus">-  if (popup)</span>
<a href="#l4.177"></a><span id="l4.177" class="difflineminus">-  {</span>
<a href="#l4.178"></a><span id="l4.178" class="difflineminus">-    var uri = popup.getAttribute('value');</span>
<a href="#l4.179"></a><span id="l4.179" class="difflineplus">+function MailListOKButton() {</span>
<a href="#l4.180"></a><span id="l4.180" class="difflineplus">+  var popup = document.getElementById(&quot;abPopup&quot;);</span>
<a href="#l4.181"></a><span id="l4.181" class="difflineplus">+  if (popup) {</span>
<a href="#l4.182"></a><span id="l4.182" class="difflineplus">+    var uri = popup.getAttribute(&quot;value&quot;);</span>
<a href="#l4.183"></a><span id="l4.183"> </span>
<a href="#l4.184"></a><span id="l4.184">     // FIX ME - hack to avoid crashing if no ab selected because of blank option bug from template</span>
<a href="#l4.185"></a><span id="l4.185">     // should be able to just remove this if we are not seeing blank lines in the ab popup</span>
<a href="#l4.186"></a><span id="l4.186">     if (!uri)</span>
<a href="#l4.187"></a><span id="l4.187">       return false;  // don't close window</span>
<a href="#l4.188"></a><span id="l4.188">     // -----</span>
<a href="#l4.189"></a><span id="l4.189"> </span>
<a href="#l4.190"></a><span id="l4.190" class="difflineminus">-    //Add mailing list to database</span>
<a href="#l4.191"></a><span id="l4.191" class="difflineplus">+    // Add mailing list to database</span>
<a href="#l4.192"></a><span id="l4.192">     var mailList = Cc[&quot;@mozilla.org/addressbook/directoryproperty;1&quot;].createInstance();</span>
<a href="#l4.193"></a><span id="l4.193">     mailList = mailList.QueryInterface(Ci.nsIAbDirectory);</span>
<a href="#l4.194"></a><span id="l4.194"> </span>
<a href="#l4.195"></a><span id="l4.195" class="difflineminus">-    if (GetListValue(mailList, true))</span>
<a href="#l4.196"></a><span id="l4.196" class="difflineminus">-    {</span>
<a href="#l4.197"></a><span id="l4.197" class="difflineplus">+    if (GetListValue(mailList, true)) {</span>
<a href="#l4.198"></a><span id="l4.198">       var parentDirectory = GetDirectoryFromURI(uri);</span>
<a href="#l4.199"></a><span id="l4.199">       mailList = parentDirectory.addMailList(mailList);</span>
<a href="#l4.200"></a><span id="l4.200">       NotifySaveListeners(mailList);</span>
<a href="#l4.201"></a><span id="l4.201" class="difflineplus">+    } else {</span>
<a href="#l4.202"></a><span id="l4.202" class="difflineplus">+      return false;</span>
<a href="#l4.203"></a><span id="l4.203">     }</span>
<a href="#l4.204"></a><span id="l4.204" class="difflineminus">-    else</span>
<a href="#l4.205"></a><span id="l4.205" class="difflineminus">-      return false;</span>
<a href="#l4.206"></a><span id="l4.206">   }</span>
<a href="#l4.207"></a><span id="l4.207"> </span>
<a href="#l4.208"></a><span id="l4.208">   return true;  // close the window</span>
<a href="#l4.209"></a><span id="l4.209"> }</span>
<a href="#l4.210"></a><span id="l4.210"> </span>
<a href="#l4.211"></a><span id="l4.211" class="difflineminus">-function OnLoadNewMailList()</span>
<a href="#l4.212"></a><span id="l4.212" class="difflineminus">-{</span>
<a href="#l4.213"></a><span id="l4.213" class="difflineplus">+function OnLoadNewMailList() {</span>
<a href="#l4.214"></a><span id="l4.214">   var selectedAB = null;</span>
<a href="#l4.215"></a><span id="l4.215"> </span>
<a href="#l4.216"></a><span id="l4.216">   InitCommonJS();</span>
<a href="#l4.217"></a><span id="l4.217"> </span>
<a href="#l4.218"></a><span id="l4.218" class="difflineminus">-  if (&quot;arguments&quot; in window &amp;&amp; window.arguments[0])</span>
<a href="#l4.219"></a><span id="l4.219" class="difflineminus">-  {</span>
<a href="#l4.220"></a><span id="l4.220" class="difflineplus">+  if (&quot;arguments&quot; in window &amp;&amp; window.arguments[0]) {</span>
<a href="#l4.221"></a><span id="l4.221">     var abURI = window.arguments[0].selectedAB;</span>
<a href="#l4.222"></a><span id="l4.222">     if (abURI &amp;&amp; abURI != kAllDirectoryRoot + &quot;?&quot;) {</span>
<a href="#l4.223"></a><span id="l4.223">       var directory = GetDirectoryFromURI(abURI);</span>
<a href="#l4.224"></a><span id="l4.224">       if (directory.isMailList) {</span>
<a href="#l4.225"></a><span id="l4.225">         var parentURI = GetParentDirectoryFromMailingListURI(abURI);</span>
<a href="#l4.226"></a><span id="l4.226">         if (parentURI) {</span>
<a href="#l4.227"></a><span id="l4.227">           selectedAB = parentURI;</span>
<a href="#l4.228"></a><span id="l4.228">         }</span>
<a href="#l4.229"></a><span id="l4.229" class="difflineminus">-      }</span>
<a href="#l4.230"></a><span id="l4.230" class="difflineminus">-      else if (directory.readOnly) {</span>
<a href="#l4.231"></a><span id="l4.231" class="difflineplus">+      } else if (directory.readOnly) {</span>
<a href="#l4.232"></a><span id="l4.232">         selectedAB = kPersonalAddressbookURI;</span>
<a href="#l4.233"></a><span id="l4.233" class="difflineminus">-      }</span>
<a href="#l4.234"></a><span id="l4.234" class="difflineminus">-      else {</span>
<a href="#l4.235"></a><span id="l4.235" class="difflineplus">+      } else {</span>
<a href="#l4.236"></a><span id="l4.236">         selectedAB = abURI;</span>
<a href="#l4.237"></a><span id="l4.237">       }</span>
<a href="#l4.238"></a><span id="l4.238">     }</span>
<a href="#l4.239"></a><span id="l4.239">   }</span>
<a href="#l4.240"></a><span id="l4.240"> </span>
<a href="#l4.241"></a><span id="l4.241">   if (!selectedAB)</span>
<a href="#l4.242"></a><span id="l4.242">     selectedAB = kPersonalAddressbookURI;</span>
<a href="#l4.243"></a><span id="l4.243"> </span>
<a href="#l4.244"></a><span id="l4.244">   // set popup with address book names</span>
<a href="#l4.245"></a><span id="l4.245" class="difflineminus">-  var abPopup = document.getElementById('abPopup');</span>
<a href="#l4.246"></a><span id="l4.246" class="difflineplus">+  var abPopup = document.getElementById(&quot;abPopup&quot;);</span>
<a href="#l4.247"></a><span id="l4.247">   abPopup.value = selectedAB;</span>
<a href="#l4.248"></a><span id="l4.248"> </span>
<a href="#l4.249"></a><span id="l4.249">   AppendNewRowAndSetFocus();</span>
<a href="#l4.250"></a><span id="l4.250">   awFitDummyRows(1);</span>
<a href="#l4.251"></a><span id="l4.251"> </span>
<a href="#l4.252"></a><span id="l4.252">   document.addEventListener(&quot;keypress&quot;, awDocumentKeyPress, true);</span>
<a href="#l4.253"></a><span id="l4.253"> </span>
<a href="#l4.254"></a><span id="l4.254">   // focus on first name</span>
<a href="#l4.255"></a><span id="l4.255" class="difflineminus">-  var listName = document.getElementById('ListName');</span>
<a href="#l4.256"></a><span id="l4.256" class="difflineplus">+  var listName = document.getElementById(&quot;ListName&quot;);</span>
<a href="#l4.257"></a><span id="l4.257">   if (listName)</span>
<a href="#l4.258"></a><span id="l4.258" class="difflineminus">-    setTimeout( function(firstTextBox) { firstTextBox.focus(); }, 0, listName );</span>
<a href="#l4.259"></a><span id="l4.259" class="difflineplus">+    setTimeout(function(firstTextBox) { firstTextBox.focus(); }, 0, listName);</span>
<a href="#l4.260"></a><span id="l4.260"> </span>
<a href="#l4.261"></a><span id="l4.261">   NotifyLoadListeners(directory);</span>
<a href="#l4.262"></a><span id="l4.262"> }</span>
<a href="#l4.263"></a><span id="l4.263"> </span>
<a href="#l4.264"></a><span id="l4.264" class="difflineminus">-function EditListOKButton()</span>
<a href="#l4.265"></a><span id="l4.265" class="difflineminus">-{</span>
<a href="#l4.266"></a><span id="l4.266" class="difflineminus">-  //edit mailing list in database</span>
<a href="#l4.267"></a><span id="l4.267" class="difflineminus">-  if (GetListValue(gEditList, false))</span>
<a href="#l4.268"></a><span id="l4.268" class="difflineminus">-  {</span>
<a href="#l4.269"></a><span id="l4.269" class="difflineplus">+function EditListOKButton() {</span>
<a href="#l4.270"></a><span id="l4.270" class="difflineplus">+  // edit mailing list in database</span>
<a href="#l4.271"></a><span id="l4.271" class="difflineplus">+  if (GetListValue(gEditList, false)) {</span>
<a href="#l4.272"></a><span id="l4.272">     if (gListCard) {</span>
<a href="#l4.273"></a><span id="l4.273">       // modify the list card (for the results pane) from the mailing list</span>
<a href="#l4.274"></a><span id="l4.274">       gListCard.displayName = gEditList.dirName;</span>
<a href="#l4.275"></a><span id="l4.275">       gListCard.lastName = gEditList.dirName;</span>
<a href="#l4.276"></a><span id="l4.276">       gListCard.setProperty(&quot;NickName&quot;, gEditList.listNickName);</span>
<a href="#l4.277"></a><span id="l4.277">       gListCard.setProperty(&quot;Notes&quot;, gEditList.description);</span>
<a href="#l4.278"></a><span id="l4.278">     }</span>
<a href="#l4.279"></a><span id="l4.279"> </span>
<a href="#l4.280"></a><span id="l4.280" class="difflineat">@@ -227,57 +201,53 @@ function EditListOKButton()</span>
<a href="#l4.281"></a><span id="l4.281"> </span>
<a href="#l4.282"></a><span id="l4.282">     window.arguments[0].refresh = true;</span>
<a href="#l4.283"></a><span id="l4.283">     return true;  // close the window</span>
<a href="#l4.284"></a><span id="l4.284">   }</span>
<a href="#l4.285"></a><span id="l4.285"> </span>
<a href="#l4.286"></a><span id="l4.286">   return false;</span>
<a href="#l4.287"></a><span id="l4.287"> }</span>
<a href="#l4.288"></a><span id="l4.288"> </span>
<a href="#l4.289"></a><span id="l4.289" class="difflineminus">-function OnLoadEditList()</span>
<a href="#l4.290"></a><span id="l4.290" class="difflineminus">-{</span>
<a href="#l4.291"></a><span id="l4.291" class="difflineplus">+function OnLoadEditList() {</span>
<a href="#l4.292"></a><span id="l4.292">   InitCommonJS();</span>
<a href="#l4.293"></a><span id="l4.293"> </span>
<a href="#l4.294"></a><span id="l4.294">   gListCard = window.arguments[0].abCard;</span>
<a href="#l4.295"></a><span id="l4.295">   var listUri  = window.arguments[0].listURI;</span>
<a href="#l4.296"></a><span id="l4.296"> </span>
<a href="#l4.297"></a><span id="l4.297">   gEditList = GetDirectoryFromURI(listUri);</span>
<a href="#l4.298"></a><span id="l4.298"> </span>
<a href="#l4.299"></a><span id="l4.299" class="difflineminus">-  document.getElementById('ListName').value = gEditList.dirName;</span>
<a href="#l4.300"></a><span id="l4.300" class="difflineminus">-  document.getElementById('ListNickName').value = gEditList.listNickName;</span>
<a href="#l4.301"></a><span id="l4.301" class="difflineminus">-  document.getElementById('ListDescription').value = gEditList.description;</span>
<a href="#l4.302"></a><span id="l4.302" class="difflineplus">+  document.getElementById(&quot;ListName&quot;).value = gEditList.dirName;</span>
<a href="#l4.303"></a><span id="l4.303" class="difflineplus">+  document.getElementById(&quot;ListNickName&quot;).value = gEditList.listNickName;</span>
<a href="#l4.304"></a><span id="l4.304" class="difflineplus">+  document.getElementById(&quot;ListDescription&quot;).value = gEditList.description;</span>
<a href="#l4.305"></a><span id="l4.305">   oldListName = gEditList.dirName;</span>
<a href="#l4.306"></a><span id="l4.306"> </span>
<a href="#l4.307"></a><span id="l4.307">   document.title = gAddressBookBundle.getFormattedString(&quot;mailingListTitleEdit&quot;, [oldListName]);</span>
<a href="#l4.308"></a><span id="l4.308"> </span>
<a href="#l4.309"></a><span id="l4.309" class="difflineminus">-  if (gEditList.addressLists)</span>
<a href="#l4.310"></a><span id="l4.310" class="difflineminus">-  {</span>
<a href="#l4.311"></a><span id="l4.311" class="difflineplus">+  if (gEditList.addressLists) {</span>
<a href="#l4.312"></a><span id="l4.312">     let total = gEditList.addressLists.length;</span>
<a href="#l4.313"></a><span id="l4.313" class="difflineminus">-    if (total)</span>
<a href="#l4.314"></a><span id="l4.314" class="difflineminus">-    {</span>
<a href="#l4.315"></a><span id="l4.315" class="difflineplus">+    if (total) {</span>
<a href="#l4.316"></a><span id="l4.316">       let listbox = document.getElementById(&quot;addressingWidget&quot;);</span>
<a href="#l4.317"></a><span id="l4.317">       let newListBoxNode = listbox.cloneNode(false);</span>
<a href="#l4.318"></a><span id="l4.318">       let templateNode = listbox.querySelector(&quot;richlistitem&quot;);</span>
<a href="#l4.319"></a><span id="l4.319"> </span>
<a href="#l4.320"></a><span id="l4.320">       top.MAX_RECIPIENTS = 0;</span>
<a href="#l4.321"></a><span id="l4.321" class="difflineminus">-      for (let i = 0; i &lt; total; i++)</span>
<a href="#l4.322"></a><span id="l4.322" class="difflineminus">-      {</span>
<a href="#l4.323"></a><span id="l4.323" class="difflineplus">+      for (let i = 0; i &lt; total; i++) {</span>
<a href="#l4.324"></a><span id="l4.324">         let card = gEditList.addressLists.queryElementAt(i, Ci.nsIAbCard);</span>
<a href="#l4.325"></a><span id="l4.325">         let address = MailServices.headerParser.makeMailboxObject(</span>
<a href="#l4.326"></a><span id="l4.326">           card.displayName, card.primaryEmail).toString();</span>
<a href="#l4.327"></a><span id="l4.327">         SetInputValue(address, newListBoxNode, templateNode);</span>
<a href="#l4.328"></a><span id="l4.328">       }</span>
<a href="#l4.329"></a><span id="l4.329">       listbox.parentNode.replaceChild(newListBoxNode, listbox);</span>
<a href="#l4.330"></a><span id="l4.330">     }</span>
<a href="#l4.331"></a><span id="l4.331">   }</span>
<a href="#l4.332"></a><span id="l4.332"> </span>
<a href="#l4.333"></a><span id="l4.333">   // Is this directory read-only? If so, we now need to set all the fields to</span>
<a href="#l4.334"></a><span id="l4.334">   // read-only.</span>
<a href="#l4.335"></a><span id="l4.335">   if (gEditList.readOnly) {</span>
<a href="#l4.336"></a><span id="l4.336" class="difflineminus">-    const kMailListFields = [ 'ListName', 'ListNickName', 'ListDescription' ];</span>
<a href="#l4.337"></a><span id="l4.337" class="difflineplus">+    const kMailListFields = [&quot;ListName&quot;, &quot;ListNickName&quot;, &quot;ListDescription&quot;];</span>
<a href="#l4.338"></a><span id="l4.338"> </span>
<a href="#l4.339"></a><span id="l4.339">     for (let i = 0; i &lt; kMailListFields.length; ++i)</span>
<a href="#l4.340"></a><span id="l4.340">       document.getElementById(kMailListFields[i]).readOnly = true;</span>
<a href="#l4.341"></a><span id="l4.341"> </span>
<a href="#l4.342"></a><span id="l4.342">     document.documentElement.buttons = &quot;accept&quot;;</span>
<a href="#l4.343"></a><span id="l4.343">     document.documentElement.removeAttribute(&quot;ondialogaccept&quot;);</span>
<a href="#l4.344"></a><span id="l4.344"> </span>
<a href="#l4.345"></a><span id="l4.345">     // Getting a sane read-only implementation for the addressing widget would</span>
<a href="#l4.346"></a><span id="l4.346" class="difflineat">@@ -292,308 +262,274 @@ function OnLoadEditList()</span>
<a href="#l4.347"></a><span id="l4.347">   // workaround for bug 118337 - for mailing lists that have more rows than fits inside</span>
<a href="#l4.348"></a><span id="l4.348">   // the display, the value of the textbox inside the new row isn't inherited into the input -</span>
<a href="#l4.349"></a><span id="l4.349">   // the first row then appears to be duplicated at the end although it is actually empty.</span>
<a href="#l4.350"></a><span id="l4.350">   // see awAppendNewRow which copies first row and clears it</span>
<a href="#l4.351"></a><span id="l4.351">   setTimeout(AppendLastRow, 0);</span>
<a href="#l4.352"></a><span id="l4.352">   NotifyLoadListeners(gEditList);</span>
<a href="#l4.353"></a><span id="l4.353"> }</span>
<a href="#l4.354"></a><span id="l4.354"> </span>
<a href="#l4.355"></a><span id="l4.355" class="difflineminus">-function AppendLastRow()</span>
<a href="#l4.356"></a><span id="l4.356" class="difflineminus">-{</span>
<a href="#l4.357"></a><span id="l4.357" class="difflineplus">+function AppendLastRow() {</span>
<a href="#l4.358"></a><span id="l4.358">   AppendNewRowAndSetFocus();</span>
<a href="#l4.359"></a><span id="l4.359">   awFitDummyRows(1);</span>
<a href="#l4.360"></a><span id="l4.360"> </span>
<a href="#l4.361"></a><span id="l4.361">   // focus on first name</span>
<a href="#l4.362"></a><span id="l4.362" class="difflineminus">-  var listName = document.getElementById('ListName');</span>
<a href="#l4.363"></a><span id="l4.363" class="difflineplus">+  var listName = document.getElementById(&quot;ListName&quot;);</span>
<a href="#l4.364"></a><span id="l4.364">   if (listName)</span>
<a href="#l4.365"></a><span id="l4.365">     listName.focus();</span>
<a href="#l4.366"></a><span id="l4.366"> }</span>
<a href="#l4.367"></a><span id="l4.367"> </span>
<a href="#l4.368"></a><span id="l4.368" class="difflineminus">-function AppendNewRowAndSetFocus()</span>
<a href="#l4.369"></a><span id="l4.369" class="difflineminus">-{</span>
<a href="#l4.370"></a><span id="l4.370" class="difflineplus">+function AppendNewRowAndSetFocus() {</span>
<a href="#l4.371"></a><span id="l4.371">   var lastInput = awGetInputElement(top.MAX_RECIPIENTS);</span>
<a href="#l4.372"></a><span id="l4.372">   if (lastInput &amp;&amp; lastInput.value)</span>
<a href="#l4.373"></a><span id="l4.373">     awAppendNewRow(true);</span>
<a href="#l4.374"></a><span id="l4.374">   else</span>
<a href="#l4.375"></a><span id="l4.375">     awSetFocus(top.MAX_RECIPIENTS, lastInput);</span>
<a href="#l4.376"></a><span id="l4.376"> }</span>
<a href="#l4.377"></a><span id="l4.377"> </span>
<a href="#l4.378"></a><span id="l4.378" class="difflineminus">-function SetInputValue(inputValue, parentNode, templateNode)</span>
<a href="#l4.379"></a><span id="l4.379" class="difflineminus">-{</span>
<a href="#l4.380"></a><span id="l4.380" class="difflineminus">-    top.MAX_RECIPIENTS++;</span>
<a href="#l4.381"></a><span id="l4.381" class="difflineplus">+function SetInputValue(inputValue, parentNode, templateNode) {</span>
<a href="#l4.382"></a><span id="l4.382" class="difflineplus">+  top.MAX_RECIPIENTS++;</span>
<a href="#l4.383"></a><span id="l4.383"> </span>
<a href="#l4.384"></a><span id="l4.384" class="difflineminus">-    var newNode = templateNode.cloneNode(true);</span>
<a href="#l4.385"></a><span id="l4.385" class="difflineminus">-    parentNode.appendChild(newNode); // we need to insert the new node before we set the value of the select element!</span>
<a href="#l4.386"></a><span id="l4.386" class="difflineplus">+  var newNode = templateNode.cloneNode(true);</span>
<a href="#l4.387"></a><span id="l4.387" class="difflineplus">+  parentNode.appendChild(newNode); // we need to insert the new node before we set the value of the select element!</span>
<a href="#l4.388"></a><span id="l4.388"> </span>
<a href="#l4.389"></a><span id="l4.389" class="difflineminus">-    var input = newNode.getElementsByTagName(awInputElementName());</span>
<a href="#l4.390"></a><span id="l4.390" class="difflineminus">-    if (input &amp;&amp; input.length == 1)</span>
<a href="#l4.391"></a><span id="l4.391" class="difflineminus">-    {</span>
<a href="#l4.392"></a><span id="l4.392" class="difflineminus">-    //We need to set the value using both setAttribute and .value else we will</span>
<a href="#l4.393"></a><span id="l4.393" class="difflineplus">+  var input = newNode.getElementsByTagName(awInputElementName());</span>
<a href="#l4.394"></a><span id="l4.394" class="difflineplus">+  if (input &amp;&amp; input.length == 1) {</span>
<a href="#l4.395"></a><span id="l4.395" class="difflineplus">+    // We need to set the value using both setAttribute and .value else we will</span>
<a href="#l4.396"></a><span id="l4.396">     // lose the content when the field is not visible. See bug 37435</span>
<a href="#l4.397"></a><span id="l4.397" class="difflineminus">-      input[0].setAttribute(&quot;value&quot;, inputValue);</span>
<a href="#l4.398"></a><span id="l4.398" class="difflineminus">-      input[0].value = inputValue;</span>
<a href="#l4.399"></a><span id="l4.399" class="difflineminus">-      input[0].setAttribute(&quot;id&quot;, &quot;addressCol1#&quot; + top.MAX_RECIPIENTS);</span>
<a href="#l4.400"></a><span id="l4.400" class="difflineplus">+    input[0].setAttribute(&quot;value&quot;, inputValue);</span>
<a href="#l4.401"></a><span id="l4.401" class="difflineplus">+    input[0].value = inputValue;</span>
<a href="#l4.402"></a><span id="l4.402" class="difflineplus">+    input[0].setAttribute(&quot;id&quot;, &quot;addressCol1#&quot; + top.MAX_RECIPIENTS);</span>
<a href="#l4.403"></a><span id="l4.403">   }</span>
<a href="#l4.404"></a><span id="l4.404"> }</span>
<a href="#l4.405"></a><span id="l4.405"> </span>
<a href="#l4.406"></a><span id="l4.406" class="difflineminus">-function awNotAnEmptyArea(event)</span>
<a href="#l4.407"></a><span id="l4.407" class="difflineminus">-{</span>
<a href="#l4.408"></a><span id="l4.408" class="difflineminus">-  //This is temporary until i figure out how to ensure to always having an empty space after the last row</span>
<a href="#l4.409"></a><span id="l4.409" class="difflineplus">+function awNotAnEmptyArea(event) {</span>
<a href="#l4.410"></a><span id="l4.410" class="difflineplus">+  // This is temporary until i figure out how to ensure to always having an empty space after the last row</span>
<a href="#l4.411"></a><span id="l4.411"> </span>
<a href="#l4.412"></a><span id="l4.412">   var lastInput = awGetInputElement(top.MAX_RECIPIENTS);</span>
<a href="#l4.413"></a><span id="l4.413">   if (lastInput &amp;&amp; lastInput.value)</span>
<a href="#l4.414"></a><span id="l4.414">     awAppendNewRow(false);</span>
<a href="#l4.415"></a><span id="l4.415"> </span>
<a href="#l4.416"></a><span id="l4.416">   event.stopPropagation();</span>
<a href="#l4.417"></a><span id="l4.417"> }</span>
<a href="#l4.418"></a><span id="l4.418"> </span>
<a href="#l4.419"></a><span id="l4.419" class="difflineminus">-function awClickEmptySpace(target, setFocus)</span>
<a href="#l4.420"></a><span id="l4.420" class="difflineminus">-{</span>
<a href="#l4.421"></a><span id="l4.421" class="difflineplus">+function awClickEmptySpace(target, setFocus) {</span>
<a href="#l4.422"></a><span id="l4.422">   if (target == null || target.localName != &quot;hbox&quot;)</span>
<a href="#l4.423"></a><span id="l4.423">     return;</span>
<a href="#l4.424"></a><span id="l4.424"> </span>
<a href="#l4.425"></a><span id="l4.425">   var lastInput = awGetInputElement(top.MAX_RECIPIENTS);</span>
<a href="#l4.426"></a><span id="l4.426"> </span>
<a href="#l4.427"></a><span id="l4.427">   if (lastInput &amp;&amp; lastInput.value)</span>
<a href="#l4.428"></a><span id="l4.428">     awAppendNewRow(setFocus);</span>
<a href="#l4.429"></a><span id="l4.429">   else</span>
<a href="#l4.430"></a><span id="l4.430">     if (setFocus)</span>
<a href="#l4.431"></a><span id="l4.431">       awSetFocus(top.MAX_RECIPIENTS, lastInput);</span>
<a href="#l4.432"></a><span id="l4.432"> }</span>
<a href="#l4.433"></a><span id="l4.433"> </span>
<a href="#l4.434"></a><span id="l4.434" class="difflineminus">-function awReturnHit(inputElement)</span>
<a href="#l4.435"></a><span id="l4.435" class="difflineminus">-{</span>
<a href="#l4.436"></a><span id="l4.436" class="difflineplus">+function awReturnHit(inputElement) {</span>
<a href="#l4.437"></a><span id="l4.437">   var row = awGetRowByInputElement(inputElement);</span>
<a href="#l4.438"></a><span id="l4.438" class="difflineminus">-  if (inputElement.value)</span>
<a href="#l4.439"></a><span id="l4.439" class="difflineminus">-  {</span>
<a href="#l4.440"></a><span id="l4.440" class="difflineminus">-    var nextInput = awGetInputElement(row+1);</span>
<a href="#l4.441"></a><span id="l4.441" class="difflineplus">+  if (inputElement.value) {</span>
<a href="#l4.442"></a><span id="l4.442" class="difflineplus">+    var nextInput = awGetInputElement(row + 1);</span>
<a href="#l4.443"></a><span id="l4.443">     if (!nextInput)</span>
<a href="#l4.444"></a><span id="l4.444">       awAppendNewRow(true);</span>
<a href="#l4.445"></a><span id="l4.445">     else</span>
<a href="#l4.446"></a><span id="l4.446" class="difflineminus">-      awSetFocus(row+1, nextInput);</span>
<a href="#l4.447"></a><span id="l4.447" class="difflineplus">+      awSetFocus(row + 1, nextInput);</span>
<a href="#l4.448"></a><span id="l4.448">   }</span>
<a href="#l4.449"></a><span id="l4.449"> }</span>
<a href="#l4.450"></a><span id="l4.450"> </span>
<a href="#l4.451"></a><span id="l4.451" class="difflineminus">-function awDeleteRow(rowToDelete)</span>
<a href="#l4.452"></a><span id="l4.452" class="difflineminus">-{</span>
<a href="#l4.453"></a><span id="l4.453" class="difflineplus">+function awDeleteRow(rowToDelete) {</span>
<a href="#l4.454"></a><span id="l4.454">   /* When we delete a row, we must reset the id of others row in order to not break the sequence */</span>
<a href="#l4.455"></a><span id="l4.455">   var maxRecipients = top.MAX_RECIPIENTS;</span>
<a href="#l4.456"></a><span id="l4.456">   awRemoveRow(rowToDelete);</span>
<a href="#l4.457"></a><span id="l4.457"> </span>
<a href="#l4.458"></a><span id="l4.458">   var numberOfCols = awGetNumberOfCols();</span>
<a href="#l4.459"></a><span id="l4.459" class="difflineminus">-  for (var row = rowToDelete + 1; row &lt;= maxRecipients; row ++)</span>
<a href="#l4.460"></a><span id="l4.460" class="difflineplus">+  for (var row = rowToDelete + 1; row &lt;= maxRecipients; row++)</span>
<a href="#l4.461"></a><span id="l4.461">     for (var col = 1; col &lt;= numberOfCols; col++)</span>
<a href="#l4.462"></a><span id="l4.462" class="difflineminus">-      awGetElementByCol(row, col).setAttribute(&quot;id&quot;, &quot;addressCol&quot; + (col) + &quot;#&quot; + (row-1));</span>
<a href="#l4.463"></a><span id="l4.463" class="difflineplus">+      awGetElementByCol(row, col).setAttribute(&quot;id&quot;, &quot;addressCol&quot; + (col) + &quot;#&quot; + (row - 1));</span>
<a href="#l4.464"></a><span id="l4.464"> </span>
<a href="#l4.465"></a><span id="l4.465">   awTestRowSequence();</span>
<a href="#l4.466"></a><span id="l4.466"> }</span>
<a href="#l4.467"></a><span id="l4.467"> </span>
<a href="#l4.468"></a><span id="l4.468" class="difflineminus">-function awInputChanged(inputElement)</span>
<a href="#l4.469"></a><span id="l4.469" class="difflineminus">-{</span>
<a href="#l4.470"></a><span id="l4.470" class="difflineplus">+function awInputChanged(inputElement) {</span>
<a href="#l4.471"></a><span id="l4.471"> //  AutoCompleteAddress(inputElement);</span>
<a href="#l4.472"></a><span id="l4.472"> </span>
<a href="#l4.473"></a><span id="l4.473" class="difflineminus">-  //Do we need to add a new row?</span>
<a href="#l4.474"></a><span id="l4.474" class="difflineplus">+  // Do we need to add a new row?</span>
<a href="#l4.475"></a><span id="l4.475">   var lastInput = awGetInputElement(top.MAX_RECIPIENTS);</span>
<a href="#l4.476"></a><span id="l4.476">   if (lastInput &amp;&amp; lastInput.value &amp;&amp; !top.doNotCreateANewRow)</span>
<a href="#l4.477"></a><span id="l4.477">     awAppendNewRow(false);</span>
<a href="#l4.478"></a><span id="l4.478">   top.doNotCreateANewRow = false;</span>
<a href="#l4.479"></a><span id="l4.479"> }</span>
<a href="#l4.480"></a><span id="l4.480"> </span>
<a href="#l4.481"></a><span id="l4.481" class="difflineminus">-function awInputElementName()</span>
<a href="#l4.482"></a><span id="l4.482" class="difflineminus">-{</span>
<a href="#l4.483"></a><span id="l4.483" class="difflineminus">-    if (inputElementType == &quot;&quot;)</span>
<a href="#l4.484"></a><span id="l4.484" class="difflineminus">-        inputElementType = document.getElementById(&quot;addressCol1#1&quot;).localName;</span>
<a href="#l4.485"></a><span id="l4.485" class="difflineminus">-    return inputElementType;</span>
<a href="#l4.486"></a><span id="l4.486" class="difflineplus">+function awInputElementName() {</span>
<a href="#l4.487"></a><span id="l4.487" class="difflineplus">+  if (inputElementType == &quot;&quot;)</span>
<a href="#l4.488"></a><span id="l4.488" class="difflineplus">+      inputElementType = document.getElementById(&quot;addressCol1#1&quot;).localName;</span>
<a href="#l4.489"></a><span id="l4.489" class="difflineplus">+  return inputElementType;</span>
<a href="#l4.490"></a><span id="l4.490"> }</span>
<a href="#l4.491"></a><span id="l4.491"> </span>
<a href="#l4.492"></a><span id="l4.492" class="difflineminus">-function awAppendNewRow(setFocus)</span>
<a href="#l4.493"></a><span id="l4.493" class="difflineminus">-{</span>
<a href="#l4.494"></a><span id="l4.494" class="difflineplus">+function awAppendNewRow(setFocus) {</span>
<a href="#l4.495"></a><span id="l4.495">   var body = document.getElementById(&quot;addressingWidget&quot;);</span>
<a href="#l4.496"></a><span id="l4.496">   var listitem1 = awGetListItem(1);</span>
<a href="#l4.497"></a><span id="l4.497"> </span>
<a href="#l4.498"></a><span id="l4.498" class="difflineminus">-  if (body &amp;&amp; listitem1)</span>
<a href="#l4.499"></a><span id="l4.499" class="difflineminus">-  {</span>
<a href="#l4.500"></a><span id="l4.500" class="difflineplus">+  if (body &amp;&amp; listitem1) {</span>
<a href="#l4.501"></a><span id="l4.501">     var nextDummy = awGetNextDummyRow();</span>
<a href="#l4.502"></a><span id="l4.502">     var newNode = listitem1.cloneNode(true);</span>
<a href="#l4.503"></a><span id="l4.503">     if (nextDummy)</span>
<a href="#l4.504"></a><span id="l4.504">       body.replaceChild(newNode, nextDummy);</span>
<a href="#l4.505"></a><span id="l4.505">     else</span>
<a href="#l4.506"></a><span id="l4.506">       body.appendChild(newNode);</span>
<a href="#l4.507"></a><span id="l4.507"> </span>
<a href="#l4.508"></a><span id="l4.508">     top.MAX_RECIPIENTS++;</span>
<a href="#l4.509"></a><span id="l4.509"> </span>
<a href="#l4.510"></a><span id="l4.510">     var input = newNode.getElementsByTagName(awInputElementName());</span>
<a href="#l4.511"></a><span id="l4.511" class="difflineminus">-    if (input &amp;&amp; input.length == 1)</span>
<a href="#l4.512"></a><span id="l4.512" class="difflineminus">-    {</span>
<a href="#l4.513"></a><span id="l4.513" class="difflineplus">+    if (input &amp;&amp; input.length == 1) {</span>
<a href="#l4.514"></a><span id="l4.514">       input[0].setAttribute(&quot;value&quot;, &quot;&quot;);</span>
<a href="#l4.515"></a><span id="l4.515">       input[0].setAttribute(&quot;id&quot;, &quot;addressCol1#&quot; + top.MAX_RECIPIENTS);</span>
<a href="#l4.516"></a><span id="l4.516"> </span>
<a href="#l4.517"></a><span id="l4.517" class="difflineminus">-      if (input[0].getAttribute('focused') != '')</span>
<a href="#l4.518"></a><span id="l4.518" class="difflineminus">-        input[0].removeAttribute('focused');</span>
<a href="#l4.519"></a><span id="l4.519" class="difflineplus">+      if (input[0].getAttribute(&quot;focused&quot;) != &quot;&quot;)</span>
<a href="#l4.520"></a><span id="l4.520" class="difflineplus">+        input[0].removeAttribute(&quot;focused&quot;);</span>
<a href="#l4.521"></a><span id="l4.521">     }</span>
<a href="#l4.522"></a><span id="l4.522">     // focus on new input widget</span>
<a href="#l4.523"></a><span id="l4.523" class="difflineminus">-    if (setFocus &amp;&amp; input )</span>
<a href="#l4.524"></a><span id="l4.524" class="difflineplus">+    if (setFocus &amp;&amp; input)</span>
<a href="#l4.525"></a><span id="l4.525">       awSetFocus(top.MAX_RECIPIENTS, input[0]);</span>
<a href="#l4.526"></a><span id="l4.526">   }</span>
<a href="#l4.527"></a><span id="l4.527"> }</span>
<a href="#l4.528"></a><span id="l4.528"> </span>
<a href="#l4.529"></a><span id="l4.529"> </span>
<a href="#l4.530"></a><span id="l4.530"> // functions for accessing the elements in the addressing widget</span>
<a href="#l4.531"></a><span id="l4.531"> </span>
<a href="#l4.532"></a><span id="l4.532" class="difflineminus">-function awGetInputElement(row)</span>
<a href="#l4.533"></a><span id="l4.533" class="difflineminus">-{</span>
<a href="#l4.534"></a><span id="l4.534" class="difflineminus">-    return document.getElementById(&quot;addressCol1#&quot; + row);</span>
<a href="#l4.535"></a><span id="l4.535" class="difflineplus">+function awGetInputElement(row) {</span>
<a href="#l4.536"></a><span id="l4.536" class="difflineplus">+  return document.getElementById(&quot;addressCol1#&quot; + row);</span>
<a href="#l4.537"></a><span id="l4.537"> }</span>
<a href="#l4.538"></a><span id="l4.538"> </span>
<a href="#l4.539"></a><span id="l4.539"> </span>
<a href="#l4.540"></a><span id="l4.540" class="difflineminus">-function _awSetFocus()</span>
<a href="#l4.541"></a><span id="l4.541" class="difflineminus">-{</span>
<a href="#l4.542"></a><span id="l4.542" class="difflineplus">+function _awSetFocus() {</span>
<a href="#l4.543"></a><span id="l4.543">   var listbox = document.getElementById(&quot;addressingWidget&quot;);</span>
<a href="#l4.544"></a><span id="l4.544" class="difflineminus">-  try</span>
<a href="#l4.545"></a><span id="l4.545" class="difflineminus">-  {</span>
<a href="#l4.546"></a><span id="l4.546" class="difflineplus">+  try {</span>
<a href="#l4.547"></a><span id="l4.547">     var theNewRow = awGetListItem(top.awRow);</span>
<a href="#l4.548"></a><span id="l4.548"> </span>
<a href="#l4.549"></a><span id="l4.549">     listbox.ensureElementIsVisible(theNewRow);</span>
<a href="#l4.550"></a><span id="l4.550">     top.awInputElement.focus();</span>
<a href="#l4.551"></a><span id="l4.551" class="difflineminus">-  }</span>
<a href="#l4.552"></a><span id="l4.552" class="difflineminus">-  catch(ex)</span>
<a href="#l4.553"></a><span id="l4.553" class="difflineminus">-  {</span>
<a href="#l4.554"></a><span id="l4.554" class="difflineminus">-    top.awFocusRetry ++;</span>
<a href="#l4.555"></a><span id="l4.555" class="difflineminus">-    if (top.awFocusRetry &lt; 8)</span>
<a href="#l4.556"></a><span id="l4.556" class="difflineminus">-    {</span>
<a href="#l4.557"></a><span id="l4.557" class="difflineplus">+  } catch (ex) {</span>
<a href="#l4.558"></a><span id="l4.558" class="difflineplus">+    top.awFocusRetry++;</span>
<a href="#l4.559"></a><span id="l4.559" class="difflineplus">+    if (top.awFocusRetry &lt; 8) {</span>
<a href="#l4.560"></a><span id="l4.560">       dump(&quot;_awSetFocus failed, try it again...\n&quot;);</span>
<a href="#l4.561"></a><span id="l4.561">       setTimeout(_awSetFocus, 0);</span>
<a href="#l4.562"></a><span id="l4.562" class="difflineplus">+    } else {</span>
<a href="#l4.563"></a><span id="l4.563" class="difflineplus">+      dump(&quot;_awSetFocus failed, forget about it!\n&quot;);</span>
<a href="#l4.564"></a><span id="l4.564">     }</span>
<a href="#l4.565"></a><span id="l4.565" class="difflineminus">-    else</span>
<a href="#l4.566"></a><span id="l4.566" class="difflineminus">-      dump(&quot;_awSetFocus failed, forget about it!\n&quot;);</span>
<a href="#l4.567"></a><span id="l4.567">   }</span>
<a href="#l4.568"></a><span id="l4.568"> }</span>
<a href="#l4.569"></a><span id="l4.569"> </span>
<a href="#l4.570"></a><span id="l4.570" class="difflineminus">-function awTabFromRecipient(element, event)</span>
<a href="#l4.571"></a><span id="l4.571" class="difflineminus">-{</span>
<a href="#l4.572"></a><span id="l4.572" class="difflineminus">-  //If we are the last element in the listbox, we don't want to create a new row.</span>
<a href="#l4.573"></a><span id="l4.573" class="difflineplus">+function awTabFromRecipient(element, event) {</span>
<a href="#l4.574"></a><span id="l4.574" class="difflineplus">+  // If we are the last element in the listbox, we don't want to create a new row.</span>
<a href="#l4.575"></a><span id="l4.575">   if (element == awGetInputElement(top.MAX_RECIPIENTS))</span>
<a href="#l4.576"></a><span id="l4.576">     top.doNotCreateANewRow = true;</span>
<a href="#l4.577"></a><span id="l4.577"> }</span>
<a href="#l4.578"></a><span id="l4.578"> </span>
<a href="#l4.579"></a><span id="l4.579" class="difflineminus">-function DragOverAddressListTree(event)</span>
<a href="#l4.580"></a><span id="l4.580" class="difflineminus">-{</span>
<a href="#l4.581"></a><span id="l4.581" class="difflineminus">-  var validFlavor = false;</span>
<a href="#l4.582"></a><span id="l4.582" class="difflineplus">+function DragOverAddressListTree(event) {</span>
<a href="#l4.583"></a><span id="l4.583">   var dragSession = gDragService.getCurrentSession();</span>
<a href="#l4.584"></a><span id="l4.584"> </span>
<a href="#l4.585"></a><span id="l4.585">   // XXX add support for other flavors here</span>
<a href="#l4.586"></a><span id="l4.586">   if (dragSession.isDataFlavorSupported(&quot;text/x-moz-address&quot;)) {</span>
<a href="#l4.587"></a><span id="l4.587">     dragSession.canDrop = true;</span>
<a href="#l4.588"></a><span id="l4.588">   }</span>
<a href="#l4.589"></a><span id="l4.589"> }</span>
<a href="#l4.590"></a><span id="l4.590"> </span>
<a href="#l4.591"></a><span id="l4.591" class="difflineminus">-function DropOnAddressListTree(event)</span>
<a href="#l4.592"></a><span id="l4.592" class="difflineminus">-{</span>
<a href="#l4.593"></a><span id="l4.593" class="difflineplus">+function DropOnAddressListTree(event) {</span>
<a href="#l4.594"></a><span id="l4.594">   let dragSession = gDragService.getCurrentSession();</span>
<a href="#l4.595"></a><span id="l4.595">   let trans;</span>
<a href="#l4.596"></a><span id="l4.596"> </span>
<a href="#l4.597"></a><span id="l4.597">   try {</span>
<a href="#l4.598"></a><span id="l4.598">    trans = Cc[&quot;@mozilla.org/widget/transferable;1&quot;].createInstance(Ci.nsITransferable);</span>
<a href="#l4.599"></a><span id="l4.599">    trans.init(getLoadContext());</span>
<a href="#l4.600"></a><span id="l4.600">    trans.addDataFlavor(&quot;text/x-moz-address&quot;);</span>
<a href="#l4.601"></a><span id="l4.601" class="difflineminus">-  }</span>
<a href="#l4.602"></a><span id="l4.602" class="difflineminus">-  catch (ex) {</span>
<a href="#l4.603"></a><span id="l4.603" class="difflineplus">+  } catch (ex) {</span>
<a href="#l4.604"></a><span id="l4.604">     return;</span>
<a href="#l4.605"></a><span id="l4.605">   }</span>
<a href="#l4.606"></a><span id="l4.606"> </span>
<a href="#l4.607"></a><span id="l4.607" class="difflineminus">-  for (let i = 0; i &lt; dragSession.numDropItems; ++i)</span>
<a href="#l4.608"></a><span id="l4.608" class="difflineminus">-  {</span>
<a href="#l4.609"></a><span id="l4.609" class="difflineplus">+  for (let i = 0; i &lt; dragSession.numDropItems; ++i) {</span>
<a href="#l4.610"></a><span id="l4.610">     dragSession.getData(trans, i);</span>
<a href="#l4.611"></a><span id="l4.611" class="difflineminus">-    let dataObj = new Object();</span>
<a href="#l4.612"></a><span id="l4.612" class="difflineminus">-    let bestFlavor = new Object();</span>
<a href="#l4.613"></a><span id="l4.613" class="difflineminus">-    let len = new Object();</span>
<a href="#l4.614"></a><span id="l4.614" class="difflineplus">+    let dataObj = {};</span>
<a href="#l4.615"></a><span id="l4.615" class="difflineplus">+    let bestFlavor = {};</span>
<a href="#l4.616"></a><span id="l4.616" class="difflineplus">+    let len = {};</span>
<a href="#l4.617"></a><span id="l4.617">     trans.getAnyTransferData(bestFlavor, dataObj, len);</span>
<a href="#l4.618"></a><span id="l4.618">     if (dataObj)</span>
<a href="#l4.619"></a><span id="l4.619">       dataObj = dataObj.value.QueryInterface(Ci.nsISupportsString);</span>
<a href="#l4.620"></a><span id="l4.620">     if (!dataObj)</span>
<a href="#l4.621"></a><span id="l4.621">       continue;</span>
<a href="#l4.622"></a><span id="l4.622"> </span>
<a href="#l4.623"></a><span id="l4.623">     // pull the URL out of the data object</span>
<a href="#l4.624"></a><span id="l4.624">     let address = dataObj.data.substring(0, len.value);</span>
<a href="#l4.625"></a><span id="l4.625">     if (!address)</span>
<a href="#l4.626"></a><span id="l4.626">       continue;</span>
<a href="#l4.627"></a><span id="l4.627"> </span>
<a href="#l4.628"></a><span id="l4.628">     DropListAddress(event.target, address);</span>
<a href="#l4.629"></a><span id="l4.629">   }</span>
<a href="#l4.630"></a><span id="l4.630"> }</span>
<a href="#l4.631"></a><span id="l4.631"> </span>
<a href="#l4.632"></a><span id="l4.632" class="difflineminus">-function DropListAddress(target, address)</span>
<a href="#l4.633"></a><span id="l4.633" class="difflineminus">-{</span>
<a href="#l4.634"></a><span id="l4.634" class="difflineplus">+function DropListAddress(target, address) {</span>
<a href="#l4.635"></a><span id="l4.635">   // Set focus on a new available, visible row.</span>
<a href="#l4.636"></a><span id="l4.636">   awClickEmptySpace(target, true);</span>
<a href="#l4.637"></a><span id="l4.637">   if (top.MAX_RECIPIENTS == 0)</span>
<a href="#l4.638"></a><span id="l4.638">     top.MAX_RECIPIENTS = 1;</span>
<a href="#l4.639"></a><span id="l4.639"> </span>
<a href="#l4.640"></a><span id="l4.640">   // Break apart the MIME-ready header address into individual addressees to</span>
<a href="#l4.641"></a><span id="l4.641">   // add to the dialog.</span>
<a href="#l4.642"></a><span id="l4.642">   let addresses = {}, names = {}, fullNames = {};</span>
<a href="#l4.643"></a><span id="l4.643">   MailServices.headerParser.parseHeadersWithArray(address, addresses, names,</span>
<a href="#l4.644"></a><span id="l4.644">     fullNames);</span>
<a href="#l4.645"></a><span id="l4.645" class="difflineminus">-  for (let full of fullNames.value)</span>
<a href="#l4.646"></a><span id="l4.646" class="difflineminus">-  {</span>
<a href="#l4.647"></a><span id="l4.647" class="difflineplus">+  for (let full of fullNames.value) {</span>
<a href="#l4.648"></a><span id="l4.648">     let lastInput = awGetInputElement(top.MAX_RECIPIENTS);</span>
<a href="#l4.649"></a><span id="l4.649">     lastInput.value = full;</span>
<a href="#l4.650"></a><span id="l4.650">     awAppendNewRow(true);</span>
<a href="#l4.651"></a><span id="l4.651">   }</span>
<a href="#l4.652"></a><span id="l4.652"> }</span>
<a href="#l4.653"></a><span id="l4.653"> </span>
<a href="#l4.654"></a><span id="l4.654"> /* Allows extensions to register a listener function for</span>
<a href="#l4.655"></a><span id="l4.655">  * when a mailing list is loaded.  The listener function</span>
<a href="#l4.656"></a><span id="l4.656">  * should take two parameters - the first being the</span>
<a href="#l4.657"></a><span id="l4.657">  * mailing list being loaded, the second one being the</span>
<a href="#l4.658"></a><span id="l4.658">  * current window document.</span>
<a href="#l4.659"></a><span id="l4.659">  */</span>
<a href="#l4.660"></a><span id="l4.660" class="difflineminus">-function RegisterLoadListener(aListener)</span>
<a href="#l4.661"></a><span id="l4.661" class="difflineminus">-{</span>
<a href="#l4.662"></a><span id="l4.662" class="difflineplus">+function RegisterLoadListener(aListener) {</span>
<a href="#l4.663"></a><span id="l4.663">   gLoadListeners.push(aListener);</span>
<a href="#l4.664"></a><span id="l4.664"> }</span>
<a href="#l4.665"></a><span id="l4.665"> </span>
<a href="#l4.666"></a><span id="l4.666"> /* Allows extensions to unload a load listener function.</span>
<a href="#l4.667"></a><span id="l4.667">  */</span>
<a href="#l4.668"></a><span id="l4.668" class="difflineminus">-function UnregisterLoadListener(aListener)</span>
<a href="#l4.669"></a><span id="l4.669" class="difflineminus">-{</span>
<a href="#l4.670"></a><span id="l4.670" class="difflineplus">+function UnregisterLoadListener(aListener) {</span>
<a href="#l4.671"></a><span id="l4.671">   var fIndex = gLoadListeners.indexOf(aListener);</span>
<a href="#l4.672"></a><span id="l4.672">   if (fIndex != -1)</span>
<a href="#l4.673"></a><span id="l4.673">     gLoadListeners.splice(fIndex, 1);</span>
<a href="#l4.674"></a><span id="l4.674"> }</span>
<a href="#l4.675"></a><span id="l4.675"> </span>
<a href="#l4.676"></a><span id="l4.676"> /* Allows extensions to register a listener function for</span>
<a href="#l4.677"></a><span id="l4.677">  * when a mailing list is saved.  Like a load listener,</span>
<a href="#l4.678"></a><span id="l4.678">  * the save listener should take two parameters: the first</span>
<a href="#l4.679"></a><span id="l4.679">  * being a copy of the mailing list that is being saved,</span>
<a href="#l4.680"></a><span id="l4.680">  * and the second being the current window document.</span>
<a href="#l4.681"></a><span id="l4.681">  */</span>
<a href="#l4.682"></a><span id="l4.682" class="difflineminus">-function RegisterSaveListener(aListener)</span>
<a href="#l4.683"></a><span id="l4.683" class="difflineminus">-{</span>
<a href="#l4.684"></a><span id="l4.684" class="difflineplus">+function RegisterSaveListener(aListener) {</span>
<a href="#l4.685"></a><span id="l4.685">   gSaveListeners.push(aListener);</span>
<a href="#l4.686"></a><span id="l4.686"> }</span>
<a href="#l4.687"></a><span id="l4.687"> </span>
<a href="#l4.688"></a><span id="l4.688"> /* Allows extensions to unload a save listener function.</span>
<a href="#l4.689"></a><span id="l4.689">  */</span>
<a href="#l4.690"></a><span id="l4.690" class="difflineminus">-function UnregisterSaveListener(aListener)</span>
<a href="#l4.691"></a><span id="l4.691" class="difflineminus">-{</span>
<a href="#l4.692"></a><span id="l4.692" class="difflineplus">+function UnregisterSaveListener(aListener) {</span>
<a href="#l4.693"></a><span id="l4.693">   var fIndex = gSaveListeners.indexOf(aListener);</span>
<a href="#l4.694"></a><span id="l4.694">   if (fIndex != -1)</span>
<a href="#l4.695"></a><span id="l4.695">     gSaveListeners.splice(fIndex, 1);</span>
<a href="#l4.696"></a><span id="l4.696"> }</span>
<a href="#l4.697"></a><span id="l4.697"> </span>
<a href="#l4.698"></a><span id="l4.698"> /* Notifies all load listeners.</span>
<a href="#l4.699"></a><span id="l4.699">  */</span>
<a href="#l4.700"></a><span id="l4.700" class="difflineminus">-function NotifyLoadListeners(aMailingList)</span>
<a href="#l4.701"></a><span id="l4.701" class="difflineminus">-{</span>
<a href="#l4.702"></a><span id="l4.702" class="difflineplus">+function NotifyLoadListeners(aMailingList) {</span>
<a href="#l4.703"></a><span id="l4.703">   for (let i = 0; i &lt; gLoadListeners.length; i++)</span>
<a href="#l4.704"></a><span id="l4.704">     gLoadListeners[i](aMailingList, document);</span>
<a href="#l4.705"></a><span id="l4.705"> }</span>
<a href="#l4.706"></a><span id="l4.706"> </span>
<a href="#l4.707"></a><span id="l4.707"> /* Notifies all save listeners.</span>
<a href="#l4.708"></a><span id="l4.708">  */</span>
<a href="#l4.709"></a><span id="l4.709" class="difflineminus">-function NotifySaveListeners(aMailingList)</span>
<a href="#l4.710"></a><span id="l4.710" class="difflineminus">-{</span>
<a href="#l4.711"></a><span id="l4.711" class="difflineplus">+function NotifySaveListeners(aMailingList) {</span>
<a href="#l4.712"></a><span id="l4.712">   for (let i = 0; i &lt; gSaveListeners.length; i++)</span>
<a href="#l4.713"></a><span id="l4.713">     gSaveListeners[i](aMailingList, document);</span>
<a href="#l4.714"></a><span id="l4.714"> }</span>
<a href="#l4.715"></a><span id="l4.715"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/addrbook/content/abResultsPane.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/addrbook/content/abResultsPane.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -1,47 +1,52 @@</span>
<a href="#l5.4"></a><span id="l5.4"> /* -*- Mode: javascript; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 2 ; js-indent-level: 2 -*- */</span>
<a href="#l5.5"></a><span id="l5.5"> /* vim: set ts=8 sts=2 et sw=2 tw=80: */</span>
<a href="#l5.6"></a><span id="l5.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l5.7"></a><span id="l5.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l5.8"></a><span id="l5.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l5.9"></a><span id="l5.9"> </span>
<a href="#l5.10"></a><span id="l5.10" class="difflineplus">+/* import-globals-from ../../../mail/components/addrbook/content/abCommon.js */</span>
<a href="#l5.11"></a><span id="l5.11" class="difflineplus">+/* globals GetAbViewListener */</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+// gCurFrame is SeaMonkey-only */</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+/* globals gCurFrame */</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+</span>
<a href="#l5.15"></a><span id="l5.15"> /**</span>
<a href="#l5.16"></a><span id="l5.16">  * Use of items in this file require:</span>
<a href="#l5.17"></a><span id="l5.17">  *</span>
<a href="#l5.18"></a><span id="l5.18">  * getSelectedDirectoryURI()</span>
<a href="#l5.19"></a><span id="l5.19">  *   returns the URI of the selected directory</span>
<a href="#l5.20"></a><span id="l5.20">  * AbResultsPaneDoubleClick(card)</span>
<a href="#l5.21"></a><span id="l5.21">  *   Is called when the results pane is double-clicked, with the clicked card.</span>
<a href="#l5.22"></a><span id="l5.22">  * AbEditCard(card)</span>
<a href="#l5.23"></a><span id="l5.23">  *   Is called when a card is to be edited, with the card as the parameter.</span>
<a href="#l5.24"></a><span id="l5.24">  *</span>
<a href="#l5.25"></a><span id="l5.25">  * The following function is only required if ResultsPaneController is used:</span>
<a href="#l5.26"></a><span id="l5.26">  *</span>
<a href="#l5.27"></a><span id="l5.27">  * goSetMenuValue()</span>
<a href="#l5.28"></a><span id="l5.28">  *   Core function in globalOverlay.js</span>
<a href="#l5.29"></a><span id="l5.29">  */</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineplus">+/* globals getSelectedDirectoryURI, AbResultsPaneDoubleClick, AbEditCard, goSetMenuValue */</span>
<a href="#l5.31"></a><span id="l5.31"> </span>
<a href="#l5.32"></a><span id="l5.32"> // List/card selections in the results pane.</span>
<a href="#l5.33"></a><span id="l5.33"> var kNothingSelected = 0;</span>
<a href="#l5.34"></a><span id="l5.34"> var kListsAndCards = 1;</span>
<a href="#l5.35"></a><span id="l5.35"> var kMultipleListsOnly = 2;</span>
<a href="#l5.36"></a><span id="l5.36"> var kSingleListOnly = 3;</span>
<a href="#l5.37"></a><span id="l5.37"> var kCardsOnly = 4;</span>
<a href="#l5.38"></a><span id="l5.38"> </span>
<a href="#l5.39"></a><span id="l5.39"> // Global Variables</span>
<a href="#l5.40"></a><span id="l5.40"> </span>
<a href="#l5.41"></a><span id="l5.41"> // gAbView holds an object with an nsIAbView interface</span>
<a href="#l5.42"></a><span id="l5.42"> var gAbView = null;</span>
<a href="#l5.43"></a><span id="l5.43"> // Holds a reference to the &quot;abResultsTree&quot; document element. Initially</span>
<a href="#l5.44"></a><span id="l5.44"> // set up by SetAbView.</span>
<a href="#l5.45"></a><span id="l5.45"> var gAbResultsTree = null;</span>
<a href="#l5.46"></a><span id="l5.46"> </span>
<a href="#l5.47"></a><span id="l5.47" class="difflineminus">-function SetAbView(aURI)</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineminus">-{</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineplus">+function SetAbView(aURI) {</span>
<a href="#l5.50"></a><span id="l5.50">   // If we don't have a URI, just clear the view and leave everything else</span>
<a href="#l5.51"></a><span id="l5.51">   // alone.</span>
<a href="#l5.52"></a><span id="l5.52">   if (!aURI) {</span>
<a href="#l5.53"></a><span id="l5.53">     gAbView.clearView();</span>
<a href="#l5.54"></a><span id="l5.54">     return;</span>
<a href="#l5.55"></a><span id="l5.55">   }</span>
<a href="#l5.56"></a><span id="l5.56"> </span>
<a href="#l5.57"></a><span id="l5.57">   // If we do have a URI, we want to allow updating the review even if the</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineat">@@ -53,18 +58,17 @@ function SetAbView(aURI)</span>
<a href="#l5.59"></a><span id="l5.59">   if (!gAbResultsTree) {</span>
<a href="#l5.60"></a><span id="l5.60">     gAbResultsTree = document.getElementById(&quot;abResultsTree&quot;);</span>
<a href="#l5.61"></a><span id="l5.61">     gAbResultsTree.controllers.appendController(ResultsPaneController);</span>
<a href="#l5.62"></a><span id="l5.62">   }</span>
<a href="#l5.63"></a><span id="l5.63"> </span>
<a href="#l5.64"></a><span id="l5.64">   if (gAbView) {</span>
<a href="#l5.65"></a><span id="l5.65">     sortColumn = gAbView.sortColumn;</span>
<a href="#l5.66"></a><span id="l5.66">     sortDirection = gAbView.sortDirection;</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineminus">-  }</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineminus">-  else {</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineplus">+  } else {</span>
<a href="#l5.70"></a><span id="l5.70">     if (gAbResultsTree.hasAttribute(&quot;sortCol&quot;))</span>
<a href="#l5.71"></a><span id="l5.71">       sortColumn = gAbResultsTree.getAttribute(&quot;sortCol&quot;);</span>
<a href="#l5.72"></a><span id="l5.72">     var sortColumnNode = document.getElementById(sortColumn);</span>
<a href="#l5.73"></a><span id="l5.73">     if (sortColumnNode &amp;&amp; sortColumnNode.hasAttribute(&quot;sortDirection&quot;))</span>
<a href="#l5.74"></a><span id="l5.74">       sortDirection = sortColumnNode.getAttribute(&quot;sortDirection&quot;);</span>
<a href="#l5.75"></a><span id="l5.75">   }</span>
<a href="#l5.76"></a><span id="l5.76"> </span>
<a href="#l5.77"></a><span id="l5.77">   var directory = GetDirectoryFromURI(aURI);</span>
<a href="#l5.78"></a><span id="l5.78" class="difflineat">@@ -98,46 +102,40 @@ function SetAbView(aURI)</span>
<a href="#l5.79"></a><span id="l5.79">       abResultsTree.hidden = false;</span>
<a href="#l5.80"></a><span id="l5.80">     if (cardViewOuterBox)</span>
<a href="#l5.81"></a><span id="l5.81">       cardViewOuterBox.hidden = false;</span>
<a href="#l5.82"></a><span id="l5.82">     if (blankResultsPaneMessageBox)</span>
<a href="#l5.83"></a><span id="l5.83">       blankResultsPaneMessageBox.hidden = true;</span>
<a href="#l5.84"></a><span id="l5.84">   }</span>
<a href="#l5.85"></a><span id="l5.85"> }</span>
<a href="#l5.86"></a><span id="l5.86"> </span>
<a href="#l5.87"></a><span id="l5.87" class="difflineminus">-function CloseAbView()</span>
<a href="#l5.88"></a><span id="l5.88" class="difflineminus">-{</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineplus">+function CloseAbView() {</span>
<a href="#l5.90"></a><span id="l5.90">   if (gAbView)</span>
<a href="#l5.91"></a><span id="l5.91">     gAbView.clearView();</span>
<a href="#l5.92"></a><span id="l5.92"> }</span>
<a href="#l5.93"></a><span id="l5.93"> </span>
<a href="#l5.94"></a><span id="l5.94" class="difflineminus">-function GetOneOrMoreCardsSelected()</span>
<a href="#l5.95"></a><span id="l5.95" class="difflineminus">-{</span>
<a href="#l5.96"></a><span id="l5.96" class="difflineplus">+function GetOneOrMoreCardsSelected() {</span>
<a href="#l5.97"></a><span id="l5.97">   return (gAbView &amp;&amp; (gAbView.selection.getRangeCount() &gt; 0));</span>
<a href="#l5.98"></a><span id="l5.98"> }</span>
<a href="#l5.99"></a><span id="l5.99"> </span>
<a href="#l5.100"></a><span id="l5.100" class="difflineminus">-function GetSelectedAddresses()</span>
<a href="#l5.101"></a><span id="l5.101" class="difflineminus">-{</span>
<a href="#l5.102"></a><span id="l5.102" class="difflineplus">+function GetSelectedAddresses() {</span>
<a href="#l5.103"></a><span id="l5.103">   return GetAddressesForCards(GetSelectedAbCards());</span>
<a href="#l5.104"></a><span id="l5.104"> }</span>
<a href="#l5.105"></a><span id="l5.105"> </span>
<a href="#l5.106"></a><span id="l5.106" class="difflineminus">-function GetNumSelectedCards()</span>
<a href="#l5.107"></a><span id="l5.107" class="difflineminus">-{</span>
<a href="#l5.108"></a><span id="l5.108" class="difflineplus">+function GetNumSelectedCards() {</span>
<a href="#l5.109"></a><span id="l5.109">  try {</span>
<a href="#l5.110"></a><span id="l5.110">    return gAbView.selection.count;</span>
<a href="#l5.111"></a><span id="l5.111" class="difflineminus">- }</span>
<a href="#l5.112"></a><span id="l5.112" class="difflineminus">- catch (ex) {</span>
<a href="#l5.113"></a><span id="l5.113" class="difflineplus">+ } catch (ex) {</span>
<a href="#l5.114"></a><span id="l5.114">  }</span>
<a href="#l5.115"></a><span id="l5.115"> </span>
<a href="#l5.116"></a><span id="l5.116">  // if something went wrong, return 0 for the count.</span>
<a href="#l5.117"></a><span id="l5.117">  return 0;</span>
<a href="#l5.118"></a><span id="l5.118"> }</span>
<a href="#l5.119"></a><span id="l5.119"> </span>
<a href="#l5.120"></a><span id="l5.120" class="difflineminus">-function GetSelectedCardTypes()</span>
<a href="#l5.121"></a><span id="l5.121" class="difflineminus">-{</span>
<a href="#l5.122"></a><span id="l5.122" class="difflineplus">+function GetSelectedCardTypes() {</span>
<a href="#l5.123"></a><span id="l5.123">   var cards = GetSelectedAbCards();</span>
<a href="#l5.124"></a><span id="l5.124">   if (!cards) {</span>
<a href="#l5.125"></a><span id="l5.125">     Cu.reportError(&quot;ERROR: GetSelectedCardTypes: |cards| is null.&quot;);</span>
<a href="#l5.126"></a><span id="l5.126">     return kNothingSelected; // no view</span>
<a href="#l5.127"></a><span id="l5.127">   }</span>
<a href="#l5.128"></a><span id="l5.128">   var count = cards.length;</span>
<a href="#l5.129"></a><span id="l5.129">   if (count == 0)</span>
<a href="#l5.130"></a><span id="l5.130">     return kNothingSelected;  // nothing selected</span>
<a href="#l5.131"></a><span id="l5.131" class="difflineat">@@ -147,54 +145,57 @@ function GetSelectedCardTypes()</span>
<a href="#l5.132"></a><span id="l5.132">   for (let i = 0; i &lt; count; i++) {</span>
<a href="#l5.133"></a><span id="l5.133">     // We can assume no values from GetSelectedAbCards will be null.</span>
<a href="#l5.134"></a><span id="l5.134">     if (cards[i].isMailList)</span>
<a href="#l5.135"></a><span id="l5.135">       mailingListCnt++;</span>
<a href="#l5.136"></a><span id="l5.136">     else</span>
<a href="#l5.137"></a><span id="l5.137">       cardCnt++;</span>
<a href="#l5.138"></a><span id="l5.138">   }</span>
<a href="#l5.139"></a><span id="l5.139"> </span>
<a href="#l5.140"></a><span id="l5.140" class="difflineminus">-  return (mailingListCnt == 0) ? kCardsOnly :</span>
<a href="#l5.141"></a><span id="l5.141" class="difflineminus">-           (cardCnt &gt; 0) ? kListsAndCards :</span>
<a href="#l5.142"></a><span id="l5.142" class="difflineminus">-             (mailingListCnt == 1) ? kSingleListOnly :</span>
<a href="#l5.143"></a><span id="l5.143" class="difflineminus">-               kMultipleListsOnly;</span>
<a href="#l5.144"></a><span id="l5.144" class="difflineplus">+  if (mailingListCnt == 0) {</span>
<a href="#l5.145"></a><span id="l5.145" class="difflineplus">+    return kCardsOnly;</span>
<a href="#l5.146"></a><span id="l5.146" class="difflineplus">+  }</span>
<a href="#l5.147"></a><span id="l5.147" class="difflineplus">+  if (cardCnt &gt; 0) {</span>
<a href="#l5.148"></a><span id="l5.148" class="difflineplus">+    return kListsAndCards;</span>
<a href="#l5.149"></a><span id="l5.149" class="difflineplus">+  }</span>
<a href="#l5.150"></a><span id="l5.150" class="difflineplus">+  if (mailingListCnt == 1) {</span>
<a href="#l5.151"></a><span id="l5.151" class="difflineplus">+    return kSingleListOnly;</span>
<a href="#l5.152"></a><span id="l5.152" class="difflineplus">+  }</span>
<a href="#l5.153"></a><span id="l5.153" class="difflineplus">+  return kMultipleListsOnly;</span>
<a href="#l5.154"></a><span id="l5.154"> }</span>
<a href="#l5.155"></a><span id="l5.155"> </span>
<a href="#l5.156"></a><span id="l5.156"> // NOTE, will return -1 if more than one card selected, or no cards selected.</span>
<a href="#l5.157"></a><span id="l5.157" class="difflineminus">-function GetSelectedCardIndex()</span>
<a href="#l5.158"></a><span id="l5.158" class="difflineminus">-{</span>
<a href="#l5.159"></a><span id="l5.159" class="difflineplus">+function GetSelectedCardIndex() {</span>
<a href="#l5.160"></a><span id="l5.160">   if (!gAbView)</span>
<a href="#l5.161"></a><span id="l5.161">     return -1;</span>
<a href="#l5.162"></a><span id="l5.162"> </span>
<a href="#l5.163"></a><span id="l5.163">   var treeSelection = gAbView.selection;</span>
<a href="#l5.164"></a><span id="l5.164">   if (treeSelection.getRangeCount() == 1) {</span>
<a href="#l5.165"></a><span id="l5.165" class="difflineminus">-    var start = new Object;</span>
<a href="#l5.166"></a><span id="l5.166" class="difflineminus">-    var end = new Object;</span>
<a href="#l5.167"></a><span id="l5.167" class="difflineplus">+    var start = {};</span>
<a href="#l5.168"></a><span id="l5.168" class="difflineplus">+    var end = {};</span>
<a href="#l5.169"></a><span id="l5.169">     treeSelection.getRangeAt(0, start, end);</span>
<a href="#l5.170"></a><span id="l5.170">     if (start.value == end.value)</span>
<a href="#l5.171"></a><span id="l5.171">       return start.value;</span>
<a href="#l5.172"></a><span id="l5.172">   }</span>
<a href="#l5.173"></a><span id="l5.173"> </span>
<a href="#l5.174"></a><span id="l5.174">   return -1;</span>
<a href="#l5.175"></a><span id="l5.175"> }</span>
<a href="#l5.176"></a><span id="l5.176"> </span>
<a href="#l5.177"></a><span id="l5.177"> // NOTE, returns the card if exactly one card is selected, null otherwise</span>
<a href="#l5.178"></a><span id="l5.178" class="difflineminus">-function GetSelectedCard()</span>
<a href="#l5.179"></a><span id="l5.179" class="difflineminus">-{</span>
<a href="#l5.180"></a><span id="l5.180" class="difflineplus">+function GetSelectedCard() {</span>
<a href="#l5.181"></a><span id="l5.181">   var index = GetSelectedCardIndex();</span>
<a href="#l5.182"></a><span id="l5.182">   return (index == -1) ? null : gAbView.getCardFromRow(index);</span>
<a href="#l5.183"></a><span id="l5.183"> }</span>
<a href="#l5.184"></a><span id="l5.184"> </span>
<a href="#l5.185"></a><span id="l5.185"> /**</span>
<a href="#l5.186"></a><span id="l5.186">  * Return a (possibly empty) list of cards</span>
<a href="#l5.187"></a><span id="l5.187">  *</span>
<a href="#l5.188"></a><span id="l5.188">  * It pushes only non-null/empty element, if any, into the returned list.</span>
<a href="#l5.189"></a><span id="l5.189">  */</span>
<a href="#l5.190"></a><span id="l5.190" class="difflineminus">-function GetSelectedAbCards()</span>
<a href="#l5.191"></a><span id="l5.191" class="difflineminus">-{</span>
<a href="#l5.192"></a><span id="l5.192" class="difflineplus">+function GetSelectedAbCards() {</span>
<a href="#l5.193"></a><span id="l5.193">   var abView = gAbView;</span>
<a href="#l5.194"></a><span id="l5.194"> </span>
<a href="#l5.195"></a><span id="l5.195">   // if sidebar is open, and addressbook panel is open and focused,</span>
<a href="#l5.196"></a><span id="l5.196">   // then use the ab view from sidebar (gCurFrame is from sidebarOverlay.js)</span>
<a href="#l5.197"></a><span id="l5.197">   if (document.getElementById(&quot;sidebar-box&quot;)) {</span>
<a href="#l5.198"></a><span id="l5.198">     const abPanelUrl =</span>
<a href="#l5.199"></a><span id="l5.199">       &quot;chrome://messenger/content/addressbook/addressbook-panel.xul&quot;;</span>
<a href="#l5.200"></a><span id="l5.200">     if (gCurFrame &amp;&amp;</span>
<a href="#l5.201"></a><span id="l5.201" class="difflineat">@@ -203,17 +204,16 @@ function GetSelectedAbCards()</span>
<a href="#l5.202"></a><span id="l5.202">       abView = gCurFrame.contentDocument.defaultView.gAbView;</span>
<a href="#l5.203"></a><span id="l5.203">   }</span>
<a href="#l5.204"></a><span id="l5.204"> </span>
<a href="#l5.205"></a><span id="l5.205">   if (!abView)</span>
<a href="#l5.206"></a><span id="l5.206">     return [];</span>
<a href="#l5.207"></a><span id="l5.207"> </span>
<a href="#l5.208"></a><span id="l5.208">   let cards = [];</span>
<a href="#l5.209"></a><span id="l5.209">   var count = abView.selection.getRangeCount();</span>
<a href="#l5.210"></a><span id="l5.210" class="difflineminus">-  var current = 0;</span>
<a href="#l5.211"></a><span id="l5.211">   for (let i = 0; i &lt; count; ++i) {</span>
<a href="#l5.212"></a><span id="l5.212">     let start = {};</span>
<a href="#l5.213"></a><span id="l5.213">     let end = {};</span>
<a href="#l5.214"></a><span id="l5.214"> </span>
<a href="#l5.215"></a><span id="l5.215">     abView.selection.getRangeAt(i, start, end);</span>
<a href="#l5.216"></a><span id="l5.216"> </span>
<a href="#l5.217"></a><span id="l5.217">     for (let j = start.value; j &lt;= end.value; ++j) {</span>
<a href="#l5.218"></a><span id="l5.218">       // avoid inserting null element into the list. GetRangeAt() may be buggy.</span>
<a href="#l5.219"></a><span id="l5.219" class="difflineat">@@ -225,51 +225,47 @@ function GetSelectedAbCards()</span>
<a href="#l5.220"></a><span id="l5.220">   }</span>
<a href="#l5.221"></a><span id="l5.221">   return cards;</span>
<a href="#l5.222"></a><span id="l5.222"> }</span>
<a href="#l5.223"></a><span id="l5.223"> </span>
<a href="#l5.224"></a><span id="l5.224"> // XXX todo</span>
<a href="#l5.225"></a><span id="l5.225"> // an optimization might be to make this return</span>
<a href="#l5.226"></a><span id="l5.226"> // the selected ranges, which would be faster</span>
<a href="#l5.227"></a><span id="l5.227"> // when the user does large selections, but for now, let's keep it simple.</span>
<a href="#l5.228"></a><span id="l5.228" class="difflineminus">-function GetSelectedRows()</span>
<a href="#l5.229"></a><span id="l5.229" class="difflineminus">-{</span>
<a href="#l5.230"></a><span id="l5.230" class="difflineplus">+function GetSelectedRows() {</span>
<a href="#l5.231"></a><span id="l5.231">   var selectedRows = &quot;&quot;;</span>
<a href="#l5.232"></a><span id="l5.232"> </span>
<a href="#l5.233"></a><span id="l5.233">   if (!gAbView)</span>
<a href="#l5.234"></a><span id="l5.234">     return selectedRows;</span>
<a href="#l5.235"></a><span id="l5.235"> </span>
<a href="#l5.236"></a><span id="l5.236">   var rangeCount = gAbView.selection.getRangeCount();</span>
<a href="#l5.237"></a><span id="l5.237">   for (let i = 0; i &lt; rangeCount; ++i) {</span>
<a href="#l5.238"></a><span id="l5.238" class="difflineminus">-    var start = new Object;</span>
<a href="#l5.239"></a><span id="l5.239" class="difflineminus">-    var end = new Object;</span>
<a href="#l5.240"></a><span id="l5.240" class="difflineplus">+    var start = {};</span>
<a href="#l5.241"></a><span id="l5.241" class="difflineplus">+    var end = {};</span>
<a href="#l5.242"></a><span id="l5.242">     gAbView.selection.getRangeAt(i, start, end);</span>
<a href="#l5.243"></a><span id="l5.243" class="difflineminus">-    for (let j = start.value;j &lt;= end.value; ++j) {</span>
<a href="#l5.244"></a><span id="l5.244" class="difflineplus">+    for (let j = start.value; j &lt;= end.value; ++j) {</span>
<a href="#l5.245"></a><span id="l5.245">       if (selectedRows)</span>
<a href="#l5.246"></a><span id="l5.246">         selectedRows += &quot;,&quot;;</span>
<a href="#l5.247"></a><span id="l5.247">       selectedRows += j;</span>
<a href="#l5.248"></a><span id="l5.248">     }</span>
<a href="#l5.249"></a><span id="l5.249">   }</span>
<a href="#l5.250"></a><span id="l5.250"> </span>
<a href="#l5.251"></a><span id="l5.251">   return selectedRows;</span>
<a href="#l5.252"></a><span id="l5.252"> }</span>
<a href="#l5.253"></a><span id="l5.253"> </span>
<a href="#l5.254"></a><span id="l5.254" class="difflineminus">-function AbSwapFirstNameLastName()</span>
<a href="#l5.255"></a><span id="l5.255" class="difflineminus">-{</span>
<a href="#l5.256"></a><span id="l5.256" class="difflineplus">+function AbSwapFirstNameLastName() {</span>
<a href="#l5.257"></a><span id="l5.257">   if (gAbView)</span>
<a href="#l5.258"></a><span id="l5.258">     gAbView.swapFirstNameLastName();</span>
<a href="#l5.259"></a><span id="l5.259"> }</span>
<a href="#l5.260"></a><span id="l5.260"> </span>
<a href="#l5.261"></a><span id="l5.261" class="difflineminus">-function AbEditSelectedCard()</span>
<a href="#l5.262"></a><span id="l5.262" class="difflineminus">-{</span>
<a href="#l5.263"></a><span id="l5.263" class="difflineplus">+function AbEditSelectedCard() {</span>
<a href="#l5.264"></a><span id="l5.264">   AbEditCard(GetSelectedCard());</span>
<a href="#l5.265"></a><span id="l5.265"> }</span>
<a href="#l5.266"></a><span id="l5.266"> </span>
<a href="#l5.267"></a><span id="l5.267" class="difflineminus">-function AbResultsPaneOnClick(event)</span>
<a href="#l5.268"></a><span id="l5.268" class="difflineminus">-{</span>
<a href="#l5.269"></a><span id="l5.269" class="difflineplus">+function AbResultsPaneOnClick(event) {</span>
<a href="#l5.270"></a><span id="l5.270">   // we only care about button 0 (left click) events</span>
<a href="#l5.271"></a><span id="l5.271">   if (event.button != 0) return;</span>
<a href="#l5.272"></a><span id="l5.272"> </span>
<a href="#l5.273"></a><span id="l5.273">   // all we need to worry about here is double clicks</span>
<a href="#l5.274"></a><span id="l5.274">   // and column header clicks.</span>
<a href="#l5.275"></a><span id="l5.275">   //</span>
<a href="#l5.276"></a><span id="l5.276">   // we get in here for clicks on the &quot;treecol&quot; (headers)</span>
<a href="#l5.277"></a><span id="l5.277">   // and the &quot;scrollbarbutton&quot; (scrollbar buttons)</span>
<a href="#l5.278"></a><span id="l5.278" class="difflineat">@@ -281,108 +277,98 @@ function AbResultsPaneOnClick(event)</span>
<a href="#l5.279"></a><span id="l5.279">     var sortDirection;</span>
<a href="#l5.280"></a><span id="l5.280">     var currentDirection = t.getAttribute(&quot;sortDirection&quot;);</span>
<a href="#l5.281"></a><span id="l5.281"> </span>
<a href="#l5.282"></a><span id="l5.282">     // Revert the sort order. If none is set, use Ascending.</span>
<a href="#l5.283"></a><span id="l5.283">     sortDirection = currentDirection == kDefaultAscending ?</span>
<a href="#l5.284"></a><span id="l5.284">                                         kDefaultDescending : kDefaultAscending;</span>
<a href="#l5.285"></a><span id="l5.285"> </span>
<a href="#l5.286"></a><span id="l5.286">     SortAndUpdateIndicators(t.id, sortDirection);</span>
<a href="#l5.287"></a><span id="l5.287" class="difflineminus">-  }</span>
<a href="#l5.288"></a><span id="l5.288" class="difflineminus">-  else if (t.localName == &quot;treechildren&quot;) {</span>
<a href="#l5.289"></a><span id="l5.289" class="difflineplus">+  } else if (t.localName == &quot;treechildren&quot;) {</span>
<a href="#l5.290"></a><span id="l5.290">     // figure out what row the click was in</span>
<a href="#l5.291"></a><span id="l5.291">     var row = gAbResultsTree.getRowAt(event.clientX, event.clientY);</span>
<a href="#l5.292"></a><span id="l5.292">     if (row == -1)</span>
<a href="#l5.293"></a><span id="l5.293">       return;</span>
<a href="#l5.294"></a><span id="l5.294"> </span>
<a href="#l5.295"></a><span id="l5.295">     if (event.detail == 2)</span>
<a href="#l5.296"></a><span id="l5.296">       AbResultsPaneDoubleClick(gAbView.getCardFromRow(row));</span>
<a href="#l5.297"></a><span id="l5.297">   }</span>
<a href="#l5.298"></a><span id="l5.298"> }</span>
<a href="#l5.299"></a><span id="l5.299"> </span>
<a href="#l5.300"></a><span id="l5.300" class="difflineminus">-function AbSortAscending()</span>
<a href="#l5.301"></a><span id="l5.301" class="difflineminus">-{</span>
<a href="#l5.302"></a><span id="l5.302" class="difflineplus">+function AbSortAscending() {</span>
<a href="#l5.303"></a><span id="l5.303">   var sortColumn = gAbResultsTree.getAttribute(&quot;sortCol&quot;);</span>
<a href="#l5.304"></a><span id="l5.304">   SortAndUpdateIndicators(sortColumn, kDefaultAscending);</span>
<a href="#l5.305"></a><span id="l5.305"> }</span>
<a href="#l5.306"></a><span id="l5.306"> </span>
<a href="#l5.307"></a><span id="l5.307" class="difflineminus">-function AbSortDescending()</span>
<a href="#l5.308"></a><span id="l5.308" class="difflineminus">-{</span>
<a href="#l5.309"></a><span id="l5.309" class="difflineplus">+function AbSortDescending() {</span>
<a href="#l5.310"></a><span id="l5.310">   var sortColumn = gAbResultsTree.getAttribute(&quot;sortCol&quot;);</span>
<a href="#l5.311"></a><span id="l5.311">   SortAndUpdateIndicators(sortColumn, kDefaultDescending);</span>
<a href="#l5.312"></a><span id="l5.312"> }</span>
<a href="#l5.313"></a><span id="l5.313"> </span>
<a href="#l5.314"></a><span id="l5.314" class="difflineminus">-function SortResultPane(sortColumn)</span>
<a href="#l5.315"></a><span id="l5.315" class="difflineminus">-{</span>
<a href="#l5.316"></a><span id="l5.316" class="difflineplus">+function SortResultPane(sortColumn) {</span>
<a href="#l5.317"></a><span id="l5.317">   var sortDirection = kDefaultAscending;</span>
<a href="#l5.318"></a><span id="l5.318">   if (gAbView)</span>
<a href="#l5.319"></a><span id="l5.319">      sortDirection = gAbView.sortDirection;</span>
<a href="#l5.320"></a><span id="l5.320"> </span>
<a href="#l5.321"></a><span id="l5.321">   SortAndUpdateIndicators(sortColumn, sortDirection);</span>
<a href="#l5.322"></a><span id="l5.322"> }</span>
<a href="#l5.323"></a><span id="l5.323"> </span>
<a href="#l5.324"></a><span id="l5.324" class="difflineminus">-function SortAndUpdateIndicators(sortColumn, sortDirection)</span>
<a href="#l5.325"></a><span id="l5.325" class="difflineminus">-{</span>
<a href="#l5.326"></a><span id="l5.326" class="difflineplus">+function SortAndUpdateIndicators(sortColumn, sortDirection) {</span>
<a href="#l5.327"></a><span id="l5.327">   UpdateSortIndicators(sortColumn, sortDirection);</span>
<a href="#l5.328"></a><span id="l5.328"> </span>
<a href="#l5.329"></a><span id="l5.329">   if (gAbView)</span>
<a href="#l5.330"></a><span id="l5.330">     gAbView.sortBy(sortColumn, sortDirection);</span>
<a href="#l5.331"></a><span id="l5.331"> }</span>
<a href="#l5.332"></a><span id="l5.332"> </span>
<a href="#l5.333"></a><span id="l5.333" class="difflineminus">-function UpdateSortIndicators(colID, sortDirection)</span>
<a href="#l5.334"></a><span id="l5.334" class="difflineminus">-{</span>
<a href="#l5.335"></a><span id="l5.335" class="difflineplus">+function UpdateSortIndicators(colID, sortDirection) {</span>
<a href="#l5.336"></a><span id="l5.336">   var sortedColumn = null;</span>
<a href="#l5.337"></a><span id="l5.337"> </span>
<a href="#l5.338"></a><span id="l5.338">   // set the sort indicator on the column we are sorted by</span>
<a href="#l5.339"></a><span id="l5.339">   if (colID) {</span>
<a href="#l5.340"></a><span id="l5.340">     sortedColumn = document.getElementById(colID);</span>
<a href="#l5.341"></a><span id="l5.341">     if (sortedColumn) {</span>
<a href="#l5.342"></a><span id="l5.342" class="difflineminus">-      sortedColumn.setAttribute(&quot;sortDirection&quot;,sortDirection);</span>
<a href="#l5.343"></a><span id="l5.343" class="difflineplus">+      sortedColumn.setAttribute(&quot;sortDirection&quot;, sortDirection);</span>
<a href="#l5.344"></a><span id="l5.344">       gAbResultsTree.setAttribute(&quot;sortCol&quot;, colID);</span>
<a href="#l5.345"></a><span id="l5.345">     }</span>
<a href="#l5.346"></a><span id="l5.346">   }</span>
<a href="#l5.347"></a><span id="l5.347"> </span>
<a href="#l5.348"></a><span id="l5.348">   // remove the sort indicator from all the columns</span>
<a href="#l5.349"></a><span id="l5.349">   // except the one we are sorted by</span>
<a href="#l5.350"></a><span id="l5.350">   var currCol = gAbResultsTree.firstChild.firstChild;</span>
<a href="#l5.351"></a><span id="l5.351">   while (currCol) {</span>
<a href="#l5.352"></a><span id="l5.352">     if (currCol != sortedColumn &amp;&amp; currCol.localName == &quot;treecol&quot;)</span>
<a href="#l5.353"></a><span id="l5.353">       currCol.removeAttribute(&quot;sortDirection&quot;);</span>
<a href="#l5.354"></a><span id="l5.354">     currCol = currCol.nextSibling;</span>
<a href="#l5.355"></a><span id="l5.355">   }</span>
<a href="#l5.356"></a><span id="l5.356"> }</span>
<a href="#l5.357"></a><span id="l5.357"> </span>
<a href="#l5.358"></a><span id="l5.358" class="difflineminus">-function InvalidateResultsPane()</span>
<a href="#l5.359"></a><span id="l5.359" class="difflineminus">-{</span>
<a href="#l5.360"></a><span id="l5.360" class="difflineplus">+function InvalidateResultsPane() {</span>
<a href="#l5.361"></a><span id="l5.361">   if (gAbResultsTree)</span>
<a href="#l5.362"></a><span id="l5.362">     gAbResultsTree.invalidate();</span>
<a href="#l5.363"></a><span id="l5.363"> }</span>
<a href="#l5.364"></a><span id="l5.364"> </span>
<a href="#l5.365"></a><span id="l5.365"> // Controller object for Results Pane</span>
<a href="#l5.366"></a><span id="l5.366" class="difflineminus">-var ResultsPaneController =</span>
<a href="#l5.367"></a><span id="l5.367" class="difflineminus">-{</span>
<a href="#l5.368"></a><span id="l5.368" class="difflineminus">-  supportsCommand: function(command)</span>
<a href="#l5.369"></a><span id="l5.369" class="difflineminus">-  {</span>
<a href="#l5.370"></a><span id="l5.370" class="difflineplus">+var ResultsPaneController = {</span>
<a href="#l5.371"></a><span id="l5.371" class="difflineplus">+  supportsCommand(command) {</span>
<a href="#l5.372"></a><span id="l5.372">     switch (command) {</span>
<a href="#l5.373"></a><span id="l5.373">       case &quot;cmd_selectAll&quot;:</span>
<a href="#l5.374"></a><span id="l5.374">       case &quot;cmd_delete&quot;:</span>
<a href="#l5.375"></a><span id="l5.375">       case &quot;button_delete&quot;:</span>
<a href="#l5.376"></a><span id="l5.376">       case &quot;cmd_printcardpreview&quot;:</span>
<a href="#l5.377"></a><span id="l5.377">       case &quot;cmd_printcard&quot;:</span>
<a href="#l5.378"></a><span id="l5.378">       case &quot;cmd_properties&quot;:</span>
<a href="#l5.379"></a><span id="l5.379">       case &quot;cmd_newlist&quot;:</span>
<a href="#l5.380"></a><span id="l5.380">       case &quot;cmd_newCard&quot;:</span>
<a href="#l5.381"></a><span id="l5.381">         return true;</span>
<a href="#l5.382"></a><span id="l5.382">       default:</span>
<a href="#l5.383"></a><span id="l5.383">         return false;</span>
<a href="#l5.384"></a><span id="l5.384">     }</span>
<a href="#l5.385"></a><span id="l5.385">   },</span>
<a href="#l5.386"></a><span id="l5.386"> </span>
<a href="#l5.387"></a><span id="l5.387" class="difflineminus">-  isCommandEnabled: function(command)</span>
<a href="#l5.388"></a><span id="l5.388" class="difflineminus">-  {</span>
<a href="#l5.389"></a><span id="l5.389" class="difflineplus">+  isCommandEnabled(command) {</span>
<a href="#l5.390"></a><span id="l5.390">     switch (command) {</span>
<a href="#l5.391"></a><span id="l5.391">       case &quot;cmd_selectAll&quot;:</span>
<a href="#l5.392"></a><span id="l5.392">         return true;</span>
<a href="#l5.393"></a><span id="l5.393">       case &quot;cmd_delete&quot;:</span>
<a href="#l5.394"></a><span id="l5.394">       case &quot;button_delete&quot;: {</span>
<a href="#l5.395"></a><span id="l5.395">         let numSelected;</span>
<a href="#l5.396"></a><span id="l5.396">         let enabled = false;</span>
<a href="#l5.397"></a><span id="l5.397">         if (gAbView &amp;&amp; gAbView.selection) {</span>
<a href="#l5.398"></a><span id="l5.398" class="difflineat">@@ -463,18 +449,17 @@ var ResultsPaneController =</span>
<a href="#l5.399"></a><span id="l5.399">       case &quot;cmd_newlist&quot;:</span>
<a href="#l5.400"></a><span id="l5.400">       case &quot;cmd_newCard&quot;:</span>
<a href="#l5.401"></a><span id="l5.401">         return true;</span>
<a href="#l5.402"></a><span id="l5.402">       default:</span>
<a href="#l5.403"></a><span id="l5.403">         return false;</span>
<a href="#l5.404"></a><span id="l5.404">     }</span>
<a href="#l5.405"></a><span id="l5.405">   },</span>
<a href="#l5.406"></a><span id="l5.406"> </span>
<a href="#l5.407"></a><span id="l5.407" class="difflineminus">-  doCommand: function(command)</span>
<a href="#l5.408"></a><span id="l5.408" class="difflineminus">-  {</span>
<a href="#l5.409"></a><span id="l5.409" class="difflineplus">+  doCommand(command) {</span>
<a href="#l5.410"></a><span id="l5.410">     switch (command) {</span>
<a href="#l5.411"></a><span id="l5.411">       case &quot;cmd_selectAll&quot;:</span>
<a href="#l5.412"></a><span id="l5.412">         if (gAbView)</span>
<a href="#l5.413"></a><span id="l5.413">           gAbView.selectAll();</span>
<a href="#l5.414"></a><span id="l5.414">         break;</span>
<a href="#l5.415"></a><span id="l5.415">       case &quot;cmd_delete&quot;:</span>
<a href="#l5.416"></a><span id="l5.416">       case &quot;button_delete&quot;:</span>
<a href="#l5.417"></a><span id="l5.417">         AbDelete();</span>
<a href="#l5.418"></a><span id="l5.418" class="difflineat">@@ -486,21 +471,19 @@ var ResultsPaneController =</span>
<a href="#l5.419"></a><span id="l5.419">         AbNewList();</span>
<a href="#l5.420"></a><span id="l5.420">         break;</span>
<a href="#l5.421"></a><span id="l5.421">       case &quot;cmd_newCard&quot;:</span>
<a href="#l5.422"></a><span id="l5.422">         AbNewCard();</span>
<a href="#l5.423"></a><span id="l5.423">         break;</span>
<a href="#l5.424"></a><span id="l5.424">     }</span>
<a href="#l5.425"></a><span id="l5.425">   },</span>
<a href="#l5.426"></a><span id="l5.426"> </span>
<a href="#l5.427"></a><span id="l5.427" class="difflineminus">-  onEvent: function(event)</span>
<a href="#l5.428"></a><span id="l5.428" class="difflineminus">-  {</span>
<a href="#l5.429"></a><span id="l5.429" class="difflineplus">+  onEvent(event) {</span>
<a href="#l5.430"></a><span id="l5.430">     // on blur events set the menu item texts back to the normal values</span>
<a href="#l5.431"></a><span id="l5.431">     if (event == &quot;blur&quot;)</span>
<a href="#l5.432"></a><span id="l5.432">       goSetMenuValue(&quot;cmd_delete&quot;, &quot;valueDefault&quot;);</span>
<a href="#l5.433"></a><span id="l5.433" class="difflineminus">-  }</span>
<a href="#l5.434"></a><span id="l5.434" class="difflineplus">+  },</span>
<a href="#l5.435"></a><span id="l5.435"> };</span>
<a href="#l5.436"></a><span id="l5.436"> </span>
<a href="#l5.437"></a><span id="l5.437" class="difflineminus">-function SelectFirstCard()</span>
<a href="#l5.438"></a><span id="l5.438" class="difflineminus">-{</span>
<a href="#l5.439"></a><span id="l5.439" class="difflineplus">+function SelectFirstCard() {</span>
<a href="#l5.440"></a><span id="l5.440">   if (gAbView &amp;&amp; gAbView.selection &amp;&amp; (gAbView.selection.count &gt; 0))</span>
<a href="#l5.441"></a><span id="l5.441">     gAbView.selection.select(0);</span>
<a href="#l5.442"></a><span id="l5.442"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/addrbook/content/addrbookWidgets.xml</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/addrbook/content/addrbookWidgets.xml</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -149,17 +149,17 @@</span>
<a href="#l6.4"></a><span id="l6.4"> </span>
<a href="#l6.5"></a><span id="l6.5">       &lt;method name=&quot;onItemRemoved&quot;&gt;</span>
<a href="#l6.6"></a><span id="l6.6">         &lt;parameter name=&quot;aParentDir&quot;/&gt;</span>
<a href="#l6.7"></a><span id="l6.7">         &lt;parameter name=&quot;aItem&quot;/&gt;</span>
<a href="#l6.8"></a><span id="l6.8">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l6.9"></a><span id="l6.9">           if (aItem instanceof Ci.nsIAbDirectory) {</span>
<a href="#l6.10"></a><span id="l6.10">             // Find the item in the list to remove.</span>
<a href="#l6.11"></a><span id="l6.11">             // We can't use indexOf here because we need loose equality.</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-            for (var index = this._directories.length; --index &gt;= 0; )</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+            for (var index = this._directories.length; --index &gt;= 0;)</span>
<a href="#l6.14"></a><span id="l6.14">               if (this._directories[index] == aItem)</span>
<a href="#l6.15"></a><span id="l6.15">                 break;</span>
<a href="#l6.16"></a><span id="l6.16">             if (index != -1) {</span>
<a href="#l6.17"></a><span id="l6.17">               this._directories.splice(index, 1);</span>
<a href="#l6.18"></a><span id="l6.18">               // Are we removing the selected directory?</span>
<a href="#l6.19"></a><span id="l6.19">               if (this.parentNode.selectedItem ==</span>
<a href="#l6.20"></a><span id="l6.20">                   this.removeChild(this.childNodes[index])) {</span>
<a href="#l6.21"></a><span id="l6.21">                 // If so, try to select the first directory, if available.</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineat">@@ -177,17 +177,17 @@</span>
<a href="#l6.23"></a><span id="l6.23">         &lt;parameter name=&quot;aItem&quot;/&gt;</span>
<a href="#l6.24"></a><span id="l6.24">         &lt;parameter name=&quot;aProperty&quot;/&gt;</span>
<a href="#l6.25"></a><span id="l6.25">         &lt;parameter name=&quot;aOldValue&quot;/&gt;</span>
<a href="#l6.26"></a><span id="l6.26">         &lt;parameter name=&quot;aNewValue&quot;/&gt;</span>
<a href="#l6.27"></a><span id="l6.27">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l6.28"></a><span id="l6.28">           if (aItem instanceof Ci.nsIAbDirectory) {</span>
<a href="#l6.29"></a><span id="l6.29">             // Find the item in the list to rename.</span>
<a href="#l6.30"></a><span id="l6.30">             // We can't use indexOf here because we need loose equality.</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-            for (var oldIndex = this._directories.length; --oldIndex &gt;= 0; )</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+            for (var oldIndex = this._directories.length; --oldIndex &gt;= 0;)</span>
<a href="#l6.33"></a><span id="l6.33">               if (this._directories[oldIndex] == aItem)</span>
<a href="#l6.34"></a><span id="l6.34">                 break;</span>
<a href="#l6.35"></a><span id="l6.35">             if (oldIndex != -1)</span>
<a href="#l6.36"></a><span id="l6.36">               this._rebuild();</span>
<a href="#l6.37"></a><span id="l6.37">           }</span>
<a href="#l6.38"></a><span id="l6.38">         ]]&gt;&lt;/body&gt;</span>
<a href="#l6.39"></a><span id="l6.39">       &lt;/method&gt;</span>
<a href="#l6.40"></a><span id="l6.40"> </span>
<a href="#l6.41"></a><span id="l6.41" class="difflineat">@@ -229,17 +229,17 @@</span>
<a href="#l6.42"></a><span id="l6.42"> </span>
<a href="#l6.43"></a><span id="l6.43">           this._directories.sort(this._compare);</span>
<a href="#l6.44"></a><span id="l6.44"> </span>
<a href="#l6.45"></a><span id="l6.45">           // Push mailing lists back appending them after their respective</span>
<a href="#l6.46"></a><span id="l6.46">           // containing addressbook.</span>
<a href="#l6.47"></a><span id="l6.47">           for (let d = this._directories.length - 1; d &gt;= 0; d--) {</span>
<a href="#l6.48"></a><span id="l6.48">             let abURI = this._directories[d].URI;</span>
<a href="#l6.49"></a><span id="l6.49">             if (abURI in lists) {</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineminus">-              lists[abURI].sort(function(a,b) { return a.dirName.localeCompare(b.dirName); });</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineplus">+              lists[abURI].sort(function(a, b) { return a.dirName.localeCompare(b.dirName); });</span>
<a href="#l6.52"></a><span id="l6.52">               let listIndex = d;</span>
<a href="#l6.53"></a><span id="l6.53">               for (let list of lists[abURI]) {</span>
<a href="#l6.54"></a><span id="l6.54">                 listIndex++;</span>
<a href="#l6.55"></a><span id="l6.55">                 this._directories.splice(listIndex, 0, list);</span>
<a href="#l6.56"></a><span id="l6.56">               }</span>
<a href="#l6.57"></a><span id="l6.57">               delete lists[abURI];</span>
<a href="#l6.58"></a><span id="l6.58">             }</span>
<a href="#l6.59"></a><span id="l6.59">           }</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineat">@@ -300,16 +300,18 @@</span>
<a href="#l6.61"></a><span id="l6.61">       &lt;property name=&quot;mapURL&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l6.62"></a><span id="l6.62">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l6.63"></a><span id="l6.63">           return this._createMapItURL();</span>
<a href="#l6.64"></a><span id="l6.64">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l6.65"></a><span id="l6.65">       &lt;/property&gt;</span>
<a href="#l6.66"></a><span id="l6.66"> </span>
<a href="#l6.67"></a><span id="l6.67">       &lt;constructor&gt;</span>
<a href="#l6.68"></a><span id="l6.68">         &lt;![CDATA[</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineplus">+          ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineplus">+</span>
<a href="#l6.71"></a><span id="l6.71">           this._setWidgetDisabled(true);</span>
<a href="#l6.72"></a><span id="l6.72">         ]]&gt;</span>
<a href="#l6.73"></a><span id="l6.73">       &lt;/constructor&gt;</span>
<a href="#l6.74"></a><span id="l6.74"> </span>
<a href="#l6.75"></a><span id="l6.75">       &lt;!--</span>
<a href="#l6.76"></a><span id="l6.76">         Initializes the necessary address data from an addressbook card.</span>
<a href="#l6.77"></a><span id="l6.77">         @param aCard        A nsIAbCard to get the address data from.</span>
<a href="#l6.78"></a><span id="l6.78">         @param aAddrPrefix  A prefix of the card properties to use. Use &quot;Home&quot; or &quot;Work&quot;.</span>
<a href="#l6.79"></a><span id="l6.79" class="difflineat">@@ -321,20 +323,20 @@</span>
<a href="#l6.80"></a><span id="l6.80">           let mapItURLFormat = this._getMapURLPref(0);</span>
<a href="#l6.81"></a><span id="l6.81">           let doNotShowMap = !mapItURLFormat || !aAddrPrefix || !aCard;</span>
<a href="#l6.82"></a><span id="l6.82">           this._setWidgetDisabled(doNotShowMap);</span>
<a href="#l6.83"></a><span id="l6.83">           if (doNotShowMap)</span>
<a href="#l6.84"></a><span id="l6.84">             return;</span>
<a href="#l6.85"></a><span id="l6.85"> </span>
<a href="#l6.86"></a><span id="l6.86">           this.setAttribute(&quot;map_address1&quot;, aCard.getProperty(aAddrPrefix + &quot;Address&quot;));</span>
<a href="#l6.87"></a><span id="l6.87">           this.setAttribute(&quot;map_address2&quot;, aCard.getProperty(aAddrPrefix + &quot;Address2&quot;));</span>
<a href="#l6.88"></a><span id="l6.88" class="difflineminus">-          this.setAttribute(&quot;map_city&quot;    , aCard.getProperty(aAddrPrefix + &quot;City&quot;));</span>
<a href="#l6.89"></a><span id="l6.89" class="difflineminus">-          this.setAttribute(&quot;map_state&quot;   , aCard.getProperty(aAddrPrefix + &quot;State&quot;));</span>
<a href="#l6.90"></a><span id="l6.90" class="difflineminus">-          this.setAttribute(&quot;map_zip&quot;     , aCard.getProperty(aAddrPrefix + &quot;ZipCode&quot;));</span>
<a href="#l6.91"></a><span id="l6.91" class="difflineminus">-          this.setAttribute(&quot;map_country&quot; , aCard.getProperty(aAddrPrefix + &quot;Country&quot;));</span>
<a href="#l6.92"></a><span id="l6.92" class="difflineplus">+          this.setAttribute(&quot;map_city&quot;, aCard.getProperty(aAddrPrefix + &quot;City&quot;));</span>
<a href="#l6.93"></a><span id="l6.93" class="difflineplus">+          this.setAttribute(&quot;map_state&quot;, aCard.getProperty(aAddrPrefix + &quot;State&quot;));</span>
<a href="#l6.94"></a><span id="l6.94" class="difflineplus">+          this.setAttribute(&quot;map_zip&quot;, aCard.getProperty(aAddrPrefix + &quot;ZipCode&quot;));</span>
<a href="#l6.95"></a><span id="l6.95" class="difflineplus">+          this.setAttribute(&quot;map_country&quot;, aCard.getProperty(aAddrPrefix + &quot;Country&quot;));</span>
<a href="#l6.96"></a><span id="l6.96">         ]]&gt;&lt;/body&gt;</span>
<a href="#l6.97"></a><span id="l6.97">       &lt;/method&gt;</span>
<a href="#l6.98"></a><span id="l6.98"> </span>
<a href="#l6.99"></a><span id="l6.99">       &lt;!--</span>
<a href="#l6.100"></a><span id="l6.100">         Initializes the necessary address data from passed in values.</span>
<a href="#l6.101"></a><span id="l6.101">         --&gt;</span>
<a href="#l6.102"></a><span id="l6.102">       &lt;method name=&quot;initMapAddress&quot;&gt;</span>
<a href="#l6.103"></a><span id="l6.103">         &lt;parameter name=&quot;aAddr1&quot;/&gt;</span>
<a href="#l6.104"></a><span id="l6.104" class="difflineat">@@ -347,20 +349,20 @@</span>
<a href="#l6.105"></a><span id="l6.105">           let mapItURLFormat = this._getMapURLPref(0);</span>
<a href="#l6.106"></a><span id="l6.106">           let doNotShowMap = !mapItURLFormat || !(aAddr1 + aAddr2 + aCity + aState + aZip + aCountry);</span>
<a href="#l6.107"></a><span id="l6.107">           this._setWidgetDisabled(doNotShowMap);</span>
<a href="#l6.108"></a><span id="l6.108">           if (doNotShowMap)</span>
<a href="#l6.109"></a><span id="l6.109">             return;</span>
<a href="#l6.110"></a><span id="l6.110"> </span>
<a href="#l6.111"></a><span id="l6.111">           this.setAttribute(&quot;map_address1&quot;, aAddr1);</span>
<a href="#l6.112"></a><span id="l6.112">           this.setAttribute(&quot;map_address2&quot;, aAddr2);</span>
<a href="#l6.113"></a><span id="l6.113" class="difflineminus">-          this.setAttribute(&quot;map_city&quot;    , aCity);</span>
<a href="#l6.114"></a><span id="l6.114" class="difflineminus">-          this.setAttribute(&quot;map_state&quot;   , aState);</span>
<a href="#l6.115"></a><span id="l6.115" class="difflineminus">-          this.setAttribute(&quot;map_zip&quot;     , aZip);</span>
<a href="#l6.116"></a><span id="l6.116" class="difflineminus">-          this.setAttribute(&quot;map_country&quot; , aCountry);</span>
<a href="#l6.117"></a><span id="l6.117" class="difflineplus">+          this.setAttribute(&quot;map_city&quot;, aCity);</span>
<a href="#l6.118"></a><span id="l6.118" class="difflineplus">+          this.setAttribute(&quot;map_state&quot;, aState);</span>
<a href="#l6.119"></a><span id="l6.119" class="difflineplus">+          this.setAttribute(&quot;map_zip&quot;, aZip);</span>
<a href="#l6.120"></a><span id="l6.120" class="difflineplus">+          this.setAttribute(&quot;map_country&quot;, aCountry);</span>
<a href="#l6.121"></a><span id="l6.121">         ]]&gt;&lt;/body&gt;</span>
<a href="#l6.122"></a><span id="l6.122">       &lt;/method&gt;</span>
<a href="#l6.123"></a><span id="l6.123"> </span>
<a href="#l6.124"></a><span id="l6.124">       &lt;!--</span>
<a href="#l6.125"></a><span id="l6.125">         Sets the disabled/enabled state of the parent widget (e.g. a button).</span>
<a href="#l6.126"></a><span id="l6.126">         --&gt;</span>
<a href="#l6.127"></a><span id="l6.127">       &lt;method name=&quot;_setWidgetDisabled&quot;&gt;</span>
<a href="#l6.128"></a><span id="l6.128">         &lt;parameter name=&quot;aDisabled&quot;/&gt;</span>
<a href="#l6.129"></a><span id="l6.129" class="difflineat">@@ -380,17 +382,18 @@</span>
<a href="#l6.130"></a><span id="l6.130">           let url = null;</span>
<a href="#l6.131"></a><span id="l6.131">           if (!aIndex) {</span>
<a href="#l6.132"></a><span id="l6.132">             url = Services.prefs.getComplexValue(&quot;mail.addr_book.mapit_url.format&quot;,</span>
<a href="#l6.133"></a><span id="l6.133">                                                  Ci.nsIPrefLocalizedString).data;</span>
<a href="#l6.134"></a><span id="l6.134">           } else {</span>
<a href="#l6.135"></a><span id="l6.135">             try {</span>
<a href="#l6.136"></a><span id="l6.136">               url = Services.prefs.getComplexValue(&quot;mail.addr_book.mapit_url.&quot; + aIndex + &quot;.format&quot;,</span>
<a href="#l6.137"></a><span id="l6.137">                                                    Ci.nsIPrefLocalizedString).data;</span>
<a href="#l6.138"></a><span id="l6.138" class="difflineminus">-            } catch (e) { }</span>
<a href="#l6.139"></a><span id="l6.139" class="difflineplus">+            } catch (e) {</span>
<a href="#l6.140"></a><span id="l6.140" class="difflineplus">+            }</span>
<a href="#l6.141"></a><span id="l6.141">           }</span>
<a href="#l6.142"></a><span id="l6.142"> </span>
<a href="#l6.143"></a><span id="l6.143">           return url;</span>
<a href="#l6.144"></a><span id="l6.144">         ]]&gt;&lt;/body&gt;</span>
<a href="#l6.145"></a><span id="l6.145">       &lt;/method&gt;</span>
<a href="#l6.146"></a><span id="l6.146"> </span>
<a href="#l6.147"></a><span id="l6.147">       &lt;!--</span>
<a href="#l6.148"></a><span id="l6.148">         Builds menuitem elements representing map services defined in prefs</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/addrbook/prefs/content/pref-directory-add.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/addrbook/prefs/content/pref-directory-add.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -1,18 +1,23 @@</span>
<a href="#l7.4"></a><span id="l7.4"> /* -*- Mode: Java; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l7.5"></a><span id="l7.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l7.6"></a><span id="l7.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l7.7"></a><span id="l7.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l7.8"></a><span id="l7.8"> </span>
<a href="#l7.9"></a><span id="l7.9"> </span>
<a href="#l7.10"></a><span id="l7.10"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l7.11"></a><span id="l7.11"> ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/hostnameUtils.jsm&quot;);</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+var {</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+  isLegalHostNameOrIP,</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+  cleanUpHostName,</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+} = ChromeUtils.import(&quot;resource:///modules/hostnameUtils.jsm&quot;, null);</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+var {</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+  fixIterator,</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+} = ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;, null);</span>
<a href="#l7.21"></a><span id="l7.21"> </span>
<a href="#l7.22"></a><span id="l7.22"> var gCurrentDirectory = null;</span>
<a href="#l7.23"></a><span id="l7.23"> var gReplicationBundle = null;</span>
<a href="#l7.24"></a><span id="l7.24"> var gReplicationService =</span>
<a href="#l7.25"></a><span id="l7.25">   Cc[&quot;@mozilla.org/addressbook/ldap-replication-service;1&quot;].</span>
<a href="#l7.26"></a><span id="l7.26">              getService(Ci.nsIAbLDAPReplicationService);</span>
<a href="#l7.27"></a><span id="l7.27"> var gReplicationCancelled = false;</span>
<a href="#l7.28"></a><span id="l7.28"> var gProgressText;</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineat">@@ -20,26 +25,24 @@ var gProgressMeter;</span>
<a href="#l7.30"></a><span id="l7.30"> var gDownloadInProgress = false;</span>
<a href="#l7.31"></a><span id="l7.31"> </span>
<a href="#l7.32"></a><span id="l7.32"> var kDefaultMaxHits = 100;</span>
<a href="#l7.33"></a><span id="l7.33"> var kDefaultLDAPPort = 389;</span>
<a href="#l7.34"></a><span id="l7.34"> var kDefaultSecureLDAPPort = 636;</span>
<a href="#l7.35"></a><span id="l7.35"> var kLDAPDirectory = 0;  // defined in nsDirPrefs.h</span>
<a href="#l7.36"></a><span id="l7.36"> </span>
<a href="#l7.37"></a><span id="l7.37"> var ldapOfflineObserver = {</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineminus">-  observe: function(subject, topic, state)</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineminus">-  {</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineplus">+  observe(subject, topic, state) {</span>
<a href="#l7.41"></a><span id="l7.41">     // sanity checks</span>
<a href="#l7.42"></a><span id="l7.42">     if (topic != &quot;network:offline-status-changed&quot;) return;</span>
<a href="#l7.43"></a><span id="l7.43">     setDownloadOfflineOnlineState(state == &quot;offline&quot;);</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineminus">-  }</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineminus">-}</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineplus">+  },</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineplus">+};</span>
<a href="#l7.48"></a><span id="l7.48"> </span>
<a href="#l7.49"></a><span id="l7.49" class="difflineminus">-function Startup()</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineminus">-{</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineplus">+function Startup() {</span>
<a href="#l7.52"></a><span id="l7.52">   gReplicationBundle = document.getElementById(&quot;bundle_replication&quot;);</span>
<a href="#l7.53"></a><span id="l7.53"> </span>
<a href="#l7.54"></a><span id="l7.54">   document.getElementById(&quot;download&quot;).label =</span>
<a href="#l7.55"></a><span id="l7.55">     gReplicationBundle.getString(&quot;downloadButton&quot;);</span>
<a href="#l7.56"></a><span id="l7.56">   document.getElementById(&quot;download&quot;).accessKey =</span>
<a href="#l7.57"></a><span id="l7.57">     gReplicationBundle.getString(&quot;downloadButton.accesskey&quot;);</span>
<a href="#l7.58"></a><span id="l7.58"> </span>
<a href="#l7.59"></a><span id="l7.59">   if (&quot;arguments&quot; in window &amp;&amp; window.arguments[0]) {</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineat">@@ -67,31 +70,29 @@ function Startup()</span>
<a href="#l7.61"></a><span id="l7.61">     }</span>
<a href="#l7.62"></a><span id="l7.62">   } else {</span>
<a href="#l7.63"></a><span id="l7.63">     document.title = gReplicationBundle.getString(&quot;directoryTitleNew&quot;);</span>
<a href="#l7.64"></a><span id="l7.64">     fillDefaultSettings();</span>
<a href="#l7.65"></a><span id="l7.65">     // Don't add observer here as it doesn't make any sense.</span>
<a href="#l7.66"></a><span id="l7.66">   }</span>
<a href="#l7.67"></a><span id="l7.67"> }</span>
<a href="#l7.68"></a><span id="l7.68"> </span>
<a href="#l7.69"></a><span id="l7.69" class="difflineminus">-function onUnload()</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineminus">-{</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineplus">+function onUnload() {</span>
<a href="#l7.72"></a><span id="l7.72">   if (&quot;arguments&quot; in window &amp;&amp;</span>
<a href="#l7.73"></a><span id="l7.73">       window.arguments[0] &amp;&amp;</span>
<a href="#l7.74"></a><span id="l7.74">       !Services.prefs.prefIsLocked(gCurrentDirectory.dirPrefId +</span>
<a href="#l7.75"></a><span id="l7.75">                                    &quot;.disable_button_download&quot;)) {</span>
<a href="#l7.76"></a><span id="l7.76">     // Remove the observer that we put in on dialog startup</span>
<a href="#l7.77"></a><span id="l7.77">     Services.obs.removeObserver(ldapOfflineObserver,</span>
<a href="#l7.78"></a><span id="l7.78">                                 &quot;network:offline-status-changed&quot;);</span>
<a href="#l7.79"></a><span id="l7.79">   }</span>
<a href="#l7.80"></a><span id="l7.80"> }</span>
<a href="#l7.81"></a><span id="l7.81"> </span>
<a href="#l7.82"></a><span id="l7.82"> var progressListener = {</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineminus">-  onStateChange: function(aWebProgress, aRequest, aStateFlags, aStatus)</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineminus">-  {</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineplus">+  onStateChange(aWebProgress, aRequest, aStateFlags, aStatus) {</span>
<a href="#l7.86"></a><span id="l7.86">     if (aStateFlags &amp; Ci.nsIWebProgressListener.STATE_START) {</span>
<a href="#l7.87"></a><span id="l7.87">       // start the spinning</span>
<a href="#l7.88"></a><span id="l7.88">       gProgressMeter.removeAttribute(&quot;value&quot;);</span>
<a href="#l7.89"></a><span id="l7.89">       gProgressText.value = gReplicationBundle.getString(aStatus ?</span>
<a href="#l7.90"></a><span id="l7.90">                                                          &quot;replicationStarted&quot; :</span>
<a href="#l7.91"></a><span id="l7.91">                                                          &quot;changesStarted&quot;);</span>
<a href="#l7.92"></a><span id="l7.92">       gDownloadInProgress = true;</span>
<a href="#l7.93"></a><span id="l7.93">       document.getElementById(&quot;download&quot;).label =</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineat">@@ -99,105 +100,98 @@ var progressListener = {</span>
<a href="#l7.95"></a><span id="l7.95">       document.getElementById(&quot;download&quot;).accessKey =</span>
<a href="#l7.96"></a><span id="l7.96">         gReplicationBundle.getString(&quot;cancelDownloadButton.accesskey&quot;);</span>
<a href="#l7.97"></a><span id="l7.97">     }</span>
<a href="#l7.98"></a><span id="l7.98"> </span>
<a href="#l7.99"></a><span id="l7.99">     if (aStateFlags &amp; Ci.nsIWebProgressListener.STATE_STOP) {</span>
<a href="#l7.100"></a><span id="l7.100">       EndDownload(aStatus);</span>
<a href="#l7.101"></a><span id="l7.101">     }</span>
<a href="#l7.102"></a><span id="l7.102">   },</span>
<a href="#l7.103"></a><span id="l7.103" class="difflineminus">-  onProgressChange: function(aWebProgress, aRequest, aCurSelfProgress, aMaxSelfProgress, aCurTotalProgress, aMaxTotalProgress)</span>
<a href="#l7.104"></a><span id="l7.104" class="difflineminus">-  {</span>
<a href="#l7.105"></a><span id="l7.105" class="difflineplus">+  onProgressChange(aWebProgress, aRequest, aCurSelfProgress, aMaxSelfProgress, aCurTotalProgress, aMaxTotalProgress) {</span>
<a href="#l7.106"></a><span id="l7.106">     gProgressText.value = gReplicationBundle.getFormattedString(&quot;currentCount&quot;,</span>
<a href="#l7.107"></a><span id="l7.107">                                                                 [aCurSelfProgress]);</span>
<a href="#l7.108"></a><span id="l7.108">   },</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineminus">-  onLocationChange: function(aWebProgress, aRequest, aLocation, aFlags)</span>
<a href="#l7.110"></a><span id="l7.110" class="difflineminus">-  {</span>
<a href="#l7.111"></a><span id="l7.111" class="difflineplus">+  onLocationChange(aWebProgress, aRequest, aLocation, aFlags) {</span>
<a href="#l7.112"></a><span id="l7.112">   },</span>
<a href="#l7.113"></a><span id="l7.113" class="difflineminus">-  onStatusChange: function(aWebProgress, aRequest, aStatus, aMessage)</span>
<a href="#l7.114"></a><span id="l7.114" class="difflineminus">-  {</span>
<a href="#l7.115"></a><span id="l7.115" class="difflineplus">+  onStatusChange(aWebProgress, aRequest, aStatus, aMessage) {</span>
<a href="#l7.116"></a><span id="l7.116">   },</span>
<a href="#l7.117"></a><span id="l7.117" class="difflineminus">-  onSecurityChange: function(aWebProgress, aRequest, state)</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineminus">-  {</span>
<a href="#l7.119"></a><span id="l7.119" class="difflineplus">+  onSecurityChange(aWebProgress, aRequest, state) {</span>
<a href="#l7.120"></a><span id="l7.120">   },</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineminus">-  onContentBlockingEvent: function(aWebProgress, aRequest, aEvent)</span>
<a href="#l7.122"></a><span id="l7.122" class="difflineminus">-  {</span>
<a href="#l7.123"></a><span id="l7.123" class="difflineplus">+  onContentBlockingEvent(aWebProgress, aRequest, aEvent) {</span>
<a href="#l7.124"></a><span id="l7.124">   },</span>
<a href="#l7.125"></a><span id="l7.125">   QueryInterface: ChromeUtils.generateQI([&quot;nsIWebProgressListener&quot;,</span>
<a href="#l7.126"></a><span id="l7.126">                                           &quot;nsISupportsWeakReference&quot;]),</span>
<a href="#l7.127"></a><span id="l7.127"> };</span>
<a href="#l7.128"></a><span id="l7.128"> </span>
<a href="#l7.129"></a><span id="l7.129" class="difflineminus">-function DownloadNow()</span>
<a href="#l7.130"></a><span id="l7.130" class="difflineminus">-{</span>
<a href="#l7.131"></a><span id="l7.131" class="difflineplus">+function DownloadNow() {</span>
<a href="#l7.132"></a><span id="l7.132">   if (!gDownloadInProgress) {</span>
<a href="#l7.133"></a><span id="l7.133">     gProgressText = document.getElementById(&quot;replicationProgressText&quot;);</span>
<a href="#l7.134"></a><span id="l7.134">     gProgressMeter = document.getElementById(&quot;replicationProgressMeter&quot;);</span>
<a href="#l7.135"></a><span id="l7.135"> </span>
<a href="#l7.136"></a><span id="l7.136">     gProgressText.hidden = false;</span>
<a href="#l7.137"></a><span id="l7.137">     gProgressMeter.hidden = false;</span>
<a href="#l7.138"></a><span id="l7.138">     gReplicationCancelled = false;</span>
<a href="#l7.139"></a><span id="l7.139"> </span>
<a href="#l7.140"></a><span id="l7.140">     try {</span>
<a href="#l7.141"></a><span id="l7.141">       if (gCurrentDirectory instanceof Ci.nsIAbLDAPDirectory)</span>
<a href="#l7.142"></a><span id="l7.142">         gReplicationService.startReplication(gCurrentDirectory,</span>
<a href="#l7.143"></a><span id="l7.143">                                              progressListener);</span>
<a href="#l7.144"></a><span id="l7.144">       else</span>
<a href="#l7.145"></a><span id="l7.145">         EndDownload(false);</span>
<a href="#l7.146"></a><span id="l7.146" class="difflineminus">-    }</span>
<a href="#l7.147"></a><span id="l7.147" class="difflineminus">-    catch (ex) {</span>
<a href="#l7.148"></a><span id="l7.148" class="difflineplus">+    } catch (ex) {</span>
<a href="#l7.149"></a><span id="l7.149">       EndDownload(false);</span>
<a href="#l7.150"></a><span id="l7.150">     }</span>
<a href="#l7.151"></a><span id="l7.151">   } else {</span>
<a href="#l7.152"></a><span id="l7.152">     gReplicationCancelled = true;</span>
<a href="#l7.153"></a><span id="l7.153">     try {</span>
<a href="#l7.154"></a><span id="l7.154">       gReplicationService.cancelReplication(gCurrentDirectory.dirPrefId);</span>
<a href="#l7.155"></a><span id="l7.155" class="difflineminus">-    }</span>
<a href="#l7.156"></a><span id="l7.156" class="difflineminus">-    catch (ex) {</span>
<a href="#l7.157"></a><span id="l7.157" class="difflineplus">+    } catch (ex) {</span>
<a href="#l7.158"></a><span id="l7.158">       // XXX todo</span>
<a href="#l7.159"></a><span id="l7.159">       // perhaps replication hasn't started yet?  This can happen if you hit cancel after attempting to replication when offline</span>
<a href="#l7.160"></a><span id="l7.160">       dump(&quot;unexpected failure while cancelling.  ex=&quot; + ex + &quot;\n&quot;);</span>
<a href="#l7.161"></a><span id="l7.161">     }</span>
<a href="#l7.162"></a><span id="l7.162">   }</span>
<a href="#l7.163"></a><span id="l7.163"> }</span>
<a href="#l7.164"></a><span id="l7.164"> </span>
<a href="#l7.165"></a><span id="l7.165" class="difflineminus">-function EndDownload(aStatus)</span>
<a href="#l7.166"></a><span id="l7.166" class="difflineminus">-{</span>
<a href="#l7.167"></a><span id="l7.167" class="difflineplus">+function EndDownload(aStatus) {</span>
<a href="#l7.168"></a><span id="l7.168">   document.getElementById(&quot;download&quot;).label =</span>
<a href="#l7.169"></a><span id="l7.169">     gReplicationBundle.getString(&quot;downloadButton&quot;);</span>
<a href="#l7.170"></a><span id="l7.170">   document.getElementById(&quot;download&quot;).accessKey =</span>
<a href="#l7.171"></a><span id="l7.171">     gReplicationBundle.getString(&quot;downloadButton.accesskey&quot;);</span>
<a href="#l7.172"></a><span id="l7.172"> </span>
<a href="#l7.173"></a><span id="l7.173">   // stop the spinning</span>
<a href="#l7.174"></a><span id="l7.174">   gProgressMeter.value = 100;</span>
<a href="#l7.175"></a><span id="l7.175">   gProgressMeter.hidden = true;</span>
<a href="#l7.176"></a><span id="l7.176"> </span>
<a href="#l7.177"></a><span id="l7.177">   gDownloadInProgress = false;</span>
<a href="#l7.178"></a><span id="l7.178" class="difflineminus">-  gProgressText.value =</span>
<a href="#l7.179"></a><span id="l7.179" class="difflineminus">-    gReplicationBundle.getString(aStatus ? &quot;replicationSucceeded&quot; :</span>
<a href="#l7.180"></a><span id="l7.180" class="difflineminus">-                                 gReplicationCancelled ? &quot;replicationCancelled&quot; :</span>
<a href="#l7.181"></a><span id="l7.181" class="difflineminus">-                                  &quot;replicationFailed&quot;);</span>
<a href="#l7.182"></a><span id="l7.182" class="difflineplus">+  if (aStatus) {</span>
<a href="#l7.183"></a><span id="l7.183" class="difflineplus">+    gProgressText.value = gReplicationBundle.getString(&quot;replicationSucceeded&quot;);</span>
<a href="#l7.184"></a><span id="l7.184" class="difflineplus">+  } else if (gReplicationCancelled) {</span>
<a href="#l7.185"></a><span id="l7.185" class="difflineplus">+    gProgressText.value = gReplicationBundle.getString(&quot;replicationCancelled&quot;);</span>
<a href="#l7.186"></a><span id="l7.186" class="difflineplus">+  } else {</span>
<a href="#l7.187"></a><span id="l7.187" class="difflineplus">+    gProgressText.value = gReplicationBundle.getString(&quot;replicationFailed&quot;);</span>
<a href="#l7.188"></a><span id="l7.188" class="difflineplus">+  }</span>
<a href="#l7.189"></a><span id="l7.189"> }</span>
<a href="#l7.190"></a><span id="l7.190"> </span>
<a href="#l7.191"></a><span id="l7.191"> // fill the settings panel with the data from the preferences.</span>
<a href="#l7.192"></a><span id="l7.192"> //</span>
<a href="#l7.193"></a><span id="l7.193" class="difflineminus">-function fillSettings()</span>
<a href="#l7.194"></a><span id="l7.194" class="difflineminus">-{</span>
<a href="#l7.195"></a><span id="l7.195" class="difflineplus">+function fillSettings() {</span>
<a href="#l7.196"></a><span id="l7.196">   document.getElementById(&quot;description&quot;).value = gCurrentDirectory.dirName;</span>
<a href="#l7.197"></a><span id="l7.197"> </span>
<a href="#l7.198"></a><span id="l7.198">   if (gCurrentDirectory instanceof Ci.nsIAbLDAPDirectory) {</span>
<a href="#l7.199"></a><span id="l7.199">     var ldapUrl = gCurrentDirectory.lDAPURL;</span>
<a href="#l7.200"></a><span id="l7.200"> </span>
<a href="#l7.201"></a><span id="l7.201">     document.getElementById(&quot;results&quot;).value = gCurrentDirectory.maxHits;</span>
<a href="#l7.202"></a><span id="l7.202">     document.getElementById(&quot;login&quot;).value = gCurrentDirectory.authDn;</span>
<a href="#l7.203"></a><span id="l7.203">     document.getElementById(&quot;hostname&quot;).value = ldapUrl.host;</span>
<a href="#l7.204"></a><span id="l7.204">     document.getElementById(&quot;basedn&quot;).value = ldapUrl.dn;</span>
<a href="#l7.205"></a><span id="l7.205">     document.getElementById(&quot;search&quot;).value = ldapUrl.filter;</span>
<a href="#l7.206"></a><span id="l7.206"> </span>
<a href="#l7.207"></a><span id="l7.207">     var sub = document.getElementById(&quot;sub&quot;);</span>
<a href="#l7.208"></a><span id="l7.208" class="difflineminus">-    switch(ldapUrl.scope) {</span>
<a href="#l7.209"></a><span id="l7.209" class="difflineplus">+    switch (ldapUrl.scope) {</span>
<a href="#l7.210"></a><span id="l7.210">     case Ci.nsILDAPURL.SCOPE_ONELEVEL:</span>
<a href="#l7.211"></a><span id="l7.211">       sub.radioGroup.selectedItem = document.getElementById(&quot;one&quot;);</span>
<a href="#l7.212"></a><span id="l7.212">       break;</span>
<a href="#l7.213"></a><span id="l7.213">     default:</span>
<a href="#l7.214"></a><span id="l7.214">       sub.radioGroup.selectedItem = sub;</span>
<a href="#l7.215"></a><span id="l7.215">       break;</span>
<a href="#l7.216"></a><span id="l7.216">     }</span>
<a href="#l7.217"></a><span id="l7.217"> </span>
<a href="#l7.218"></a><span id="l7.218" class="difflineat">@@ -206,90 +200,80 @@ function fillSettings()</span>
<a href="#l7.219"></a><span id="l7.219">     case &quot;GSSAPI&quot;:</span>
<a href="#l7.220"></a><span id="l7.220">       sasl.selectedItem = document.getElementById(&quot;GSSAPI&quot;);</span>
<a href="#l7.221"></a><span id="l7.221">       break;</span>
<a href="#l7.222"></a><span id="l7.222">     default:</span>
<a href="#l7.223"></a><span id="l7.223">       sasl.selectedItem = document.getElementById(&quot;Simple&quot;);</span>
<a href="#l7.224"></a><span id="l7.224">       break;</span>
<a href="#l7.225"></a><span id="l7.225">     }</span>
<a href="#l7.226"></a><span id="l7.226"> </span>
<a href="#l7.227"></a><span id="l7.227" class="difflineminus">-    var secure = ldapUrl.options &amp; ldapUrl.OPT_SECURE</span>
<a href="#l7.228"></a><span id="l7.228" class="difflineplus">+    var secure = ldapUrl.options &amp; ldapUrl.OPT_SECURE;</span>
<a href="#l7.229"></a><span id="l7.229">     if (secure)</span>
<a href="#l7.230"></a><span id="l7.230">       document.getElementById(&quot;secure&quot;).setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l7.231"></a><span id="l7.231"> </span>
<a href="#l7.232"></a><span id="l7.232">     if (ldapUrl.port == -1)</span>
<a href="#l7.233"></a><span id="l7.233">       document.getElementById(&quot;port&quot;).value =</span>
<a href="#l7.234"></a><span id="l7.234">         (secure ? kDefaultSecureLDAPPort : kDefaultLDAPPort);</span>
<a href="#l7.235"></a><span id="l7.235">     else</span>
<a href="#l7.236"></a><span id="l7.236">       document.getElementById(&quot;port&quot;).value = ldapUrl.port;</span>
<a href="#l7.237"></a><span id="l7.237">   }</span>
<a href="#l7.238"></a><span id="l7.238"> </span>
<a href="#l7.239"></a><span id="l7.239">   // check if any of the preferences for this server are locked.</span>
<a href="#l7.240"></a><span id="l7.240" class="difflineminus">-  //If they are locked disable them</span>
<a href="#l7.241"></a><span id="l7.241" class="difflineplus">+  // If they are locked disable them</span>
<a href="#l7.242"></a><span id="l7.242">   DisableUriFields(gCurrentDirectory.dirPrefId + &quot;.uri&quot;);</span>
<a href="#l7.243"></a><span id="l7.243">   DisableElementIfPrefIsLocked(gCurrentDirectory.dirPrefId + &quot;.description&quot;, &quot;description&quot;);</span>
<a href="#l7.244"></a><span id="l7.244">   DisableElementIfPrefIsLocked(gCurrentDirectory.dirPrefId + &quot;.disable_button_download&quot;, &quot;download&quot;);</span>
<a href="#l7.245"></a><span id="l7.245">   DisableElementIfPrefIsLocked(gCurrentDirectory.dirPrefId + &quot;.maxHits&quot;, &quot;results&quot;);</span>
<a href="#l7.246"></a><span id="l7.246">   DisableElementIfPrefIsLocked(gCurrentDirectory.dirPrefId + &quot;.auth.dn&quot;, &quot;login&quot;);</span>
<a href="#l7.247"></a><span id="l7.247"> }</span>
<a href="#l7.248"></a><span id="l7.248"> </span>
<a href="#l7.249"></a><span id="l7.249" class="difflineminus">-function DisableElementIfPrefIsLocked(aPrefName, aElementId)</span>
<a href="#l7.250"></a><span id="l7.250" class="difflineminus">-{</span>
<a href="#l7.251"></a><span id="l7.251" class="difflineplus">+function DisableElementIfPrefIsLocked(aPrefName, aElementId) {</span>
<a href="#l7.252"></a><span id="l7.252">   if (Services.prefs.prefIsLocked(aPrefName))</span>
<a href="#l7.253"></a><span id="l7.253" class="difflineminus">-    document.getElementById(aElementId).setAttribute('disabled', true);</span>
<a href="#l7.254"></a><span id="l7.254" class="difflineplus">+    document.getElementById(aElementId).setAttribute(&quot;disabled&quot;, true);</span>
<a href="#l7.255"></a><span id="l7.255"> }</span>
<a href="#l7.256"></a><span id="l7.256"> </span>
<a href="#l7.257"></a><span id="l7.257"> // disables all the text fields corresponding to the .uri pref.</span>
<a href="#l7.258"></a><span id="l7.258" class="difflineminus">-function DisableUriFields(aPrefName)</span>
<a href="#l7.259"></a><span id="l7.259" class="difflineminus">-{</span>
<a href="#l7.260"></a><span id="l7.260" class="difflineplus">+function DisableUriFields(aPrefName) {</span>
<a href="#l7.261"></a><span id="l7.261">   if (Services.prefs.prefIsLocked(aPrefName)) {</span>
<a href="#l7.262"></a><span id="l7.262">     let lockedElements = document.querySelectorAll('[disableiflocked=&quot;true&quot;]');</span>
<a href="#l7.263"></a><span id="l7.263">     for (let i = 0; i &lt; lockedElements.length; i++)</span>
<a href="#l7.264"></a><span id="l7.264" class="difflineminus">-      lockedElements[i].setAttribute('disabled', 'true');</span>
<a href="#l7.265"></a><span id="l7.265" class="difflineplus">+      lockedElements[i].setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l7.266"></a><span id="l7.266">   }</span>
<a href="#l7.267"></a><span id="l7.267"> }</span>
<a href="#l7.268"></a><span id="l7.268"> </span>
<a href="#l7.269"></a><span id="l7.269" class="difflineminus">-function onSecure()</span>
<a href="#l7.270"></a><span id="l7.270" class="difflineminus">-{</span>
<a href="#l7.271"></a><span id="l7.271" class="difflineplus">+function onSecure() {</span>
<a href="#l7.272"></a><span id="l7.272">   document.getElementById(&quot;port&quot;).value =</span>
<a href="#l7.273"></a><span id="l7.273">     document.getElementById(&quot;secure&quot;).checked ? kDefaultSecureLDAPPort :</span>
<a href="#l7.274"></a><span id="l7.274">                                                 kDefaultLDAPPort;</span>
<a href="#l7.275"></a><span id="l7.275"> }</span>
<a href="#l7.276"></a><span id="l7.276"> </span>
<a href="#l7.277"></a><span id="l7.277" class="difflineminus">-function fillDefaultSettings()</span>
<a href="#l7.278"></a><span id="l7.278" class="difflineminus">-{</span>
<a href="#l7.279"></a><span id="l7.279" class="difflineplus">+function fillDefaultSettings() {</span>
<a href="#l7.280"></a><span id="l7.280">   document.getElementById(&quot;port&quot;).value = kDefaultLDAPPort;</span>
<a href="#l7.281"></a><span id="l7.281">   document.getElementById(&quot;results&quot;).value = kDefaultMaxHits;</span>
<a href="#l7.282"></a><span id="l7.282">   var sub = document.getElementById(&quot;sub&quot;);</span>
<a href="#l7.283"></a><span id="l7.283">   sub.radioGroup.selectedItem = sub;</span>
<a href="#l7.284"></a><span id="l7.284"> </span>
<a href="#l7.285"></a><span id="l7.285">   // Disable the download button and add some text indicating why.</span>
<a href="#l7.286"></a><span id="l7.286">   document.getElementById(&quot;download&quot;).disabled = true;</span>
<a href="#l7.287"></a><span id="l7.287">   document.getElementById(&quot;downloadWarningMsg&quot;).hidden = false;</span>
<a href="#l7.288"></a><span id="l7.288">   document.getElementById(&quot;downloadWarningMsg&quot;).textContent = document.</span>
<a href="#l7.289"></a><span id="l7.289">                                       getElementById(&quot;bundle_addressBook&quot;).</span>
<a href="#l7.290"></a><span id="l7.290">                                       getString(&quot;abReplicationSaveSettings&quot;);</span>
<a href="#l7.291"></a><span id="l7.291"> }</span>
<a href="#l7.292"></a><span id="l7.292"> </span>
<a href="#l7.293"></a><span id="l7.293" class="difflineminus">-function hasCharacters(number)</span>
<a href="#l7.294"></a><span id="l7.294" class="difflineminus">-{</span>
<a href="#l7.295"></a><span id="l7.295" class="difflineplus">+function hasCharacters(number) {</span>
<a href="#l7.296"></a><span id="l7.296">   var re = /[0-9]/g;</span>
<a href="#l7.297"></a><span id="l7.297">   var num = number.match(re);</span>
<a href="#l7.298"></a><span id="l7.298" class="difflineminus">-  if(num &amp;&amp; (num.length == number.length))</span>
<a href="#l7.299"></a><span id="l7.299" class="difflineplus">+  if (num &amp;&amp; (num.length == number.length))</span>
<a href="#l7.300"></a><span id="l7.300">     return false;</span>
<a href="#l7.301"></a><span id="l7.301" class="difflineminus">-  else</span>
<a href="#l7.302"></a><span id="l7.302" class="difflineminus">-    return true;</span>
<a href="#l7.303"></a><span id="l7.303" class="difflineplus">+  return true;</span>
<a href="#l7.304"></a><span id="l7.304"> }</span>
<a href="#l7.305"></a><span id="l7.305"> </span>
<a href="#l7.306"></a><span id="l7.306" class="difflineminus">-function onAccept()</span>
<a href="#l7.307"></a><span id="l7.307" class="difflineminus">-{</span>
<a href="#l7.308"></a><span id="l7.308" class="difflineplus">+function onAccept() {</span>
<a href="#l7.309"></a><span id="l7.309">   try {</span>
<a href="#l7.310"></a><span id="l7.310" class="difflineminus">-    let pref_string_content = &quot;&quot;;</span>
<a href="#l7.311"></a><span id="l7.311" class="difflineminus">-    let pref_string_title = &quot;&quot;;</span>
<a href="#l7.312"></a><span id="l7.312" class="difflineminus">-</span>
<a href="#l7.313"></a><span id="l7.313">     let description = document.getElementById(&quot;description&quot;).value.trim();</span>
<a href="#l7.314"></a><span id="l7.314">     let hostname = cleanUpHostName(document.getElementById(&quot;hostname&quot;).value);</span>
<a href="#l7.315"></a><span id="l7.315">     let port = document.getElementById(&quot;port&quot;).value;</span>
<a href="#l7.316"></a><span id="l7.316">     let secure = document.getElementById(&quot;secure&quot;);</span>
<a href="#l7.317"></a><span id="l7.317">     let results = document.getElementById(&quot;results&quot;).value;</span>
<a href="#l7.318"></a><span id="l7.318">     let errorValue = null;</span>
<a href="#l7.319"></a><span id="l7.319">     let errorArg = null;</span>
<a href="#l7.320"></a><span id="l7.320">     let saslMechanism = &quot;&quot;;</span>
<a href="#l7.321"></a><span id="l7.321" class="difflineat">@@ -301,39 +285,40 @@ function onAccept()</span>
<a href="#l7.322"></a><span id="l7.322">         if ((ab.dirName.toLowerCase() == newName.toLowerCase()) &amp;&amp;</span>
<a href="#l7.323"></a><span id="l7.323">             (!gCurrentDirectory || (ab.URI != gCurrentDirectory.URI))) {</span>
<a href="#l7.324"></a><span id="l7.324">           return ab.dirName;</span>
<a href="#l7.325"></a><span id="l7.325">         }</span>
<a href="#l7.326"></a><span id="l7.326">       }</span>
<a href="#l7.327"></a><span id="l7.327">       return null;</span>
<a href="#l7.328"></a><span id="l7.328">     };</span>
<a href="#l7.329"></a><span id="l7.329"> </span>
<a href="#l7.330"></a><span id="l7.330" class="difflineminus">-    if (!description)</span>
<a href="#l7.331"></a><span id="l7.331" class="difflineplus">+    if (!description) {</span>
<a href="#l7.332"></a><span id="l7.332">       errorValue = &quot;invalidName&quot;;</span>
<a href="#l7.333"></a><span id="l7.333" class="difflineminus">-    else if ((errorArg = findDupeName(description))) {</span>
<a href="#l7.334"></a><span id="l7.334" class="difflineplus">+    } else if ((errorArg = findDupeName(description))) {</span>
<a href="#l7.335"></a><span id="l7.335">       errorValue = &quot;duplicateNameText&quot;;</span>
<a href="#l7.336"></a><span id="l7.336" class="difflineplus">+    } else if (!isLegalHostNameOrIP(hostname)) {</span>
<a href="#l7.337"></a><span id="l7.337" class="difflineplus">+      errorValue = &quot;invalidHostname&quot;;</span>
<a href="#l7.338"></a><span id="l7.338" class="difflineplus">+    } else if (port &amp;&amp; hasCharacters(port)) {</span>
<a href="#l7.339"></a><span id="l7.339" class="difflineplus">+      // XXX write isValidDn and call it on the dn string here?</span>
<a href="#l7.340"></a><span id="l7.340" class="difflineplus">+      errorValue = &quot;invalidPortNumber&quot;;</span>
<a href="#l7.341"></a><span id="l7.341" class="difflineplus">+    } else if (results &amp;&amp; hasCharacters(results)) {</span>
<a href="#l7.342"></a><span id="l7.342" class="difflineplus">+      errorValue = &quot;invalidResults&quot;;</span>
<a href="#l7.343"></a><span id="l7.343">     }</span>
<a href="#l7.344"></a><span id="l7.344" class="difflineminus">-    else if (!isLegalHostNameOrIP(hostname))</span>
<a href="#l7.345"></a><span id="l7.345" class="difflineminus">-      errorValue = &quot;invalidHostname&quot;;</span>
<a href="#l7.346"></a><span id="l7.346" class="difflineminus">-    // XXX write isValidDn and call it on the dn string here?</span>
<a href="#l7.347"></a><span id="l7.347" class="difflineminus">-    else if (port &amp;&amp; hasCharacters(port))</span>
<a href="#l7.348"></a><span id="l7.348" class="difflineminus">-      errorValue = &quot;invalidPortNumber&quot;;</span>
<a href="#l7.349"></a><span id="l7.349" class="difflineminus">-    else if (results &amp;&amp; hasCharacters(results))</span>
<a href="#l7.350"></a><span id="l7.350" class="difflineminus">-      errorValue = &quot;invalidResults&quot;;</span>
<a href="#l7.351"></a><span id="l7.351"> </span>
<a href="#l7.352"></a><span id="l7.352">     if (!errorValue) {</span>
<a href="#l7.353"></a><span id="l7.353">       // XXX Due to the LDAP c-sdk pass a dummy url to the IO service, then</span>
<a href="#l7.354"></a><span id="l7.354">       // update the parts (bug 473351).</span>
<a href="#l7.355"></a><span id="l7.355">       let ldapUrl = Services.io.newURI(</span>
<a href="#l7.356"></a><span id="l7.356">         (secure.checked ? &quot;ldaps://&quot; : &quot;ldap://&quot;) + &quot;localhost/dc=???&quot;)</span>
<a href="#l7.357"></a><span id="l7.357">         .QueryInterface(Ci.nsILDAPURL);</span>
<a href="#l7.358"></a><span id="l7.358"> </span>
<a href="#l7.359"></a><span id="l7.359" class="difflineminus">-      let newPort = port ? port :</span>
<a href="#l7.360"></a><span id="l7.360" class="difflineminus">-                          (secure.checked ? kDefaultSecureLDAPPort :</span>
<a href="#l7.361"></a><span id="l7.361" class="difflineminus">-                                            kDefaultLDAPPort);</span>
<a href="#l7.362"></a><span id="l7.362" class="difflineplus">+      let newPort = port;</span>
<a href="#l7.363"></a><span id="l7.363" class="difflineplus">+      if (!port) {</span>
<a href="#l7.364"></a><span id="l7.364" class="difflineplus">+        port = secure.checked ? kDefaultSecureLDAPPort : kDefaultLDAPPort;</span>
<a href="#l7.365"></a><span id="l7.365" class="difflineplus">+      }</span>
<a href="#l7.366"></a><span id="l7.366">       ldapUrl = ldapUrl.mutate()</span>
<a href="#l7.367"></a><span id="l7.367">                        .setHost(hostname)</span>
<a href="#l7.368"></a><span id="l7.368">                        .setPort(newPort)</span>
<a href="#l7.369"></a><span id="l7.369">                        .finalize()</span>
<a href="#l7.370"></a><span id="l7.370">                        .QueryInterface(Ci.nsILDAPURL);</span>
<a href="#l7.371"></a><span id="l7.371"> </span>
<a href="#l7.372"></a><span id="l7.372">       ldapUrl.dn = document.getElementById(&quot;basedn&quot;).value;</span>
<a href="#l7.373"></a><span id="l7.373">       ldapUrl.scope = document.getElementById(&quot;one&quot;).selected ?</span>
<a href="#l7.374"></a><span id="l7.374" class="difflineat">@@ -345,18 +330,17 @@ function onAccept()</span>
<a href="#l7.375"></a><span id="l7.375">         saslMechanism = &quot;GSSAPI&quot;;</span>
<a href="#l7.376"></a><span id="l7.376">       }</span>
<a href="#l7.377"></a><span id="l7.377"> </span>
<a href="#l7.378"></a><span id="l7.378">       // check if we are modifying an existing directory or adding a new directory</span>
<a href="#l7.379"></a><span id="l7.379">       if (gCurrentDirectory) {</span>
<a href="#l7.380"></a><span id="l7.380">         gCurrentDirectory.dirName = description;</span>
<a href="#l7.381"></a><span id="l7.381">         gCurrentDirectory.lDAPURL = ldapUrl.QueryInterface(Ci.nsILDAPURL);</span>
<a href="#l7.382"></a><span id="l7.382">         window.opener.gNewServerString = gCurrentDirectory.dirPrefId;</span>
<a href="#l7.383"></a><span id="l7.383" class="difflineminus">-      }</span>
<a href="#l7.384"></a><span id="l7.384" class="difflineminus">-      else { // adding a new directory</span>
<a href="#l7.385"></a><span id="l7.385" class="difflineplus">+      } else { // adding a new directory</span>
<a href="#l7.386"></a><span id="l7.386">         window.opener.gNewServerString =</span>
<a href="#l7.387"></a><span id="l7.387">           MailServices.ab.newAddressBook(description, ldapUrl.spec, kLDAPDirectory);</span>
<a href="#l7.388"></a><span id="l7.388">       }</span>
<a href="#l7.389"></a><span id="l7.389"> </span>
<a href="#l7.390"></a><span id="l7.390">       // XXX This is really annoying - both new/modify Address Book don't</span>
<a href="#l7.391"></a><span id="l7.391">       // give us back the new directory we just created - so go find it from</span>
<a href="#l7.392"></a><span id="l7.392">       // rdf so we can set a few final things up on it.</span>
<a href="#l7.393"></a><span id="l7.393">       var targetURI = &quot;moz-abldapdirectory://&quot; + window.opener.gNewServerString;</span>
<a href="#l7.394"></a><span id="l7.394" class="difflineat">@@ -372,47 +356,37 @@ function onAccept()</span>
<a href="#l7.395"></a><span id="l7.395">       // set window.opener.gUpdate to true so that LDAP Directory Servers</span>
<a href="#l7.396"></a><span id="l7.396">       // dialog gets updated</span>
<a href="#l7.397"></a><span id="l7.397">       window.opener.gUpdate = true;</span>
<a href="#l7.398"></a><span id="l7.398">     } else {</span>
<a href="#l7.399"></a><span id="l7.399">       let addressBookBundle = document.getElementById(&quot;bundle_addressBook&quot;);</span>
<a href="#l7.400"></a><span id="l7.400"> </span>
<a href="#l7.401"></a><span id="l7.401">       let errorText;</span>
<a href="#l7.402"></a><span id="l7.402">       if (errorArg)</span>
<a href="#l7.403"></a><span id="l7.403" class="difflineminus">-        errorText = addressBookBundle.getFormattedString(errorValue, [errorArg])</span>
<a href="#l7.404"></a><span id="l7.404" class="difflineplus">+        errorText = addressBookBundle.getFormattedString(errorValue, [errorArg]);</span>
<a href="#l7.405"></a><span id="l7.405">       else</span>
<a href="#l7.406"></a><span id="l7.406">         errorText = addressBookBundle.getString(errorValue);</span>
<a href="#l7.407"></a><span id="l7.407"> </span>
<a href="#l7.408"></a><span id="l7.408">       Services.prompt.alert(window, document.title, errorText);</span>
<a href="#l7.409"></a><span id="l7.409">       return false;</span>
<a href="#l7.410"></a><span id="l7.410">     }</span>
<a href="#l7.411"></a><span id="l7.411">   } catch (outer) {</span>
<a href="#l7.412"></a><span id="l7.412">     Cu.reportError(&quot;Internal error in pref-directory-add.js:onAccept() &quot; + outer);</span>
<a href="#l7.413"></a><span id="l7.413">   }</span>
<a href="#l7.414"></a><span id="l7.414">   return true;</span>
<a href="#l7.415"></a><span id="l7.415"> }</span>
<a href="#l7.416"></a><span id="l7.416"> </span>
<a href="#l7.417"></a><span id="l7.417" class="difflineminus">-function onCancel()</span>
<a href="#l7.418"></a><span id="l7.418" class="difflineminus">-{</span>
<a href="#l7.419"></a><span id="l7.419" class="difflineplus">+function onCancel() {</span>
<a href="#l7.420"></a><span id="l7.420">   window.opener.gUpdate = false;</span>
<a href="#l7.421"></a><span id="l7.421"> }</span>
<a href="#l7.422"></a><span id="l7.422"> </span>
<a href="#l7.423"></a><span id="l7.423" class="difflineminus">-</span>
<a href="#l7.424"></a><span id="l7.424" class="difflineminus">-// called by Help button in platform overlay</span>
<a href="#l7.425"></a><span id="l7.425" class="difflineminus">-function doHelpButton()</span>
<a href="#l7.426"></a><span id="l7.426" class="difflineminus">-{</span>
<a href="#l7.427"></a><span id="l7.427" class="difflineminus">-  openHelp(&quot;mail-ldap-properties&quot;);</span>
<a href="#l7.428"></a><span id="l7.428" class="difflineminus">-}</span>
<a href="#l7.429"></a><span id="l7.429" class="difflineminus">-</span>
<a href="#l7.430"></a><span id="l7.430"> // Sets the download button state for offline or online.</span>
<a href="#l7.431"></a><span id="l7.431"> // This function should only be called for ldap edit dialogs.</span>
<a href="#l7.432"></a><span id="l7.432" class="difflineminus">-function setDownloadOfflineOnlineState(isOffline)</span>
<a href="#l7.433"></a><span id="l7.433" class="difflineminus">-{</span>
<a href="#l7.434"></a><span id="l7.434" class="difflineminus">-  if (isOffline)</span>
<a href="#l7.435"></a><span id="l7.435" class="difflineminus">-  {</span>
<a href="#l7.436"></a><span id="l7.436" class="difflineplus">+function setDownloadOfflineOnlineState(isOffline) {</span>
<a href="#l7.437"></a><span id="l7.437" class="difflineplus">+  if (isOffline) {</span>
<a href="#l7.438"></a><span id="l7.438">     // Disable the download button and add some text indicating why.</span>
<a href="#l7.439"></a><span id="l7.439">     document.getElementById(&quot;downloadWarningMsg&quot;).textContent = document.</span>
<a href="#l7.440"></a><span id="l7.440">       getElementById(&quot;bundle_addressBook&quot;).</span>
<a href="#l7.441"></a><span id="l7.441">       getString(&quot;abReplicationOfflineWarning&quot;);</span>
<a href="#l7.442"></a><span id="l7.442">   }</span>
<a href="#l7.443"></a><span id="l7.443">   document.getElementById(&quot;downloadWarningMsg&quot;).hidden = !isOffline;</span>
<a href="#l7.444"></a><span id="l7.444">   document.getElementById(&quot;download&quot;).disabled = isOffline;</span>
<a href="#l7.445"></a><span id="l7.445"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/addrbook/prefs/content/pref-editdirectories.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/addrbook/prefs/content/pref-editdirectories.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -1,144 +1,132 @@</span>
<a href="#l8.4"></a><span id="l8.4"> /* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l8.5"></a><span id="l8.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l8.6"></a><span id="l8.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l8.7"></a><span id="l8.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l8.8"></a><span id="l8.8"> </span>
<a href="#l8.9"></a><span id="l8.9" class="difflineplus">+/* import-globals-from ../../../../mail/components/addrbook/content/abCommon.js */</span>
<a href="#l8.10"></a><span id="l8.10" class="difflineplus">+</span>
<a href="#l8.11"></a><span id="l8.11"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l8.12"></a><span id="l8.12"> ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l8.13"></a><span id="l8.13"> </span>
<a href="#l8.14"></a><span id="l8.14"> // Listener to refresh the list items if something changes. In all these</span>
<a href="#l8.15"></a><span id="l8.15"> // cases we just rebuild the list as it is easier than searching/adding in the</span>
<a href="#l8.16"></a><span id="l8.16"> // correct places an would be an infrequent operation.</span>
<a href="#l8.17"></a><span id="l8.17"> var gAddressBookAbListener = {</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineminus">-  onItemAdded: function(parentDir, item) {</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineminus">-    if (item instanceof Ci.nsIAbDirectory) {</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineminus">-      fillDirectoryList();</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineminus">-    }</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineminus">-  },</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineminus">-  onItemRemoved: function(parentDir, item) {</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+  onItemAdded(parentDir, item) {</span>
<a href="#l8.25"></a><span id="l8.25">     if (item instanceof Ci.nsIAbDirectory) {</span>
<a href="#l8.26"></a><span id="l8.26">       fillDirectoryList();</span>
<a href="#l8.27"></a><span id="l8.27">     }</span>
<a href="#l8.28"></a><span id="l8.28">   },</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineminus">-  onItemPropertyChanged: function(item, property, oldValue, newValue) {</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineplus">+  onItemRemoved(parentDir, item) {</span>
<a href="#l8.31"></a><span id="l8.31">     if (item instanceof Ci.nsIAbDirectory) {</span>
<a href="#l8.32"></a><span id="l8.32">       fillDirectoryList();</span>
<a href="#l8.33"></a><span id="l8.33">     }</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineminus">-  }</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineplus">+  },</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineplus">+  onItemPropertyChanged(item, property, oldValue, newValue) {</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineplus">+    if (item instanceof Ci.nsIAbDirectory) {</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineplus">+      fillDirectoryList();</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineplus">+    }</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineplus">+  },</span>
<a href="#l8.41"></a><span id="l8.41"> };</span>
<a href="#l8.42"></a><span id="l8.42"> </span>
<a href="#l8.43"></a><span id="l8.43" class="difflineminus">-function onInitEditDirectories()</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineminus">-{</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineplus">+function onInitEditDirectories() {</span>
<a href="#l8.46"></a><span id="l8.46">   // For AbDeleteDirectory in abCommon.js</span>
<a href="#l8.47"></a><span id="l8.47">   gAddressBookBundle = document.getElementById(&quot;bundle_addressBook&quot;);</span>
<a href="#l8.48"></a><span id="l8.48"> </span>
<a href="#l8.49"></a><span id="l8.49">   // If the pref is locked disable the &quot;Add&quot; button</span>
<a href="#l8.50"></a><span id="l8.50">   if (Services.prefs.prefIsLocked(&quot;ldap_2.disable_button_add&quot;))</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineminus">-    document.getElementById(&quot;addButton&quot;).setAttribute('disabled', true);</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineplus">+    document.getElementById(&quot;addButton&quot;).setAttribute(&quot;disabled&quot;, true);</span>
<a href="#l8.53"></a><span id="l8.53"> </span>
<a href="#l8.54"></a><span id="l8.54">   // Fill out the directory list</span>
<a href="#l8.55"></a><span id="l8.55">   fillDirectoryList();</span>
<a href="#l8.56"></a><span id="l8.56"> </span>
<a href="#l8.57"></a><span id="l8.57">   const nsIAbListener = Ci.nsIAbListener;</span>
<a href="#l8.58"></a><span id="l8.58">   // Add a listener so we can update correctly if the list should change</span>
<a href="#l8.59"></a><span id="l8.59">   MailServices.ab.addAddressBookListener(gAddressBookAbListener,</span>
<a href="#l8.60"></a><span id="l8.60">                                          nsIAbListener.itemAdded |</span>
<a href="#l8.61"></a><span id="l8.61">                                          nsIAbListener.directoryRemoved |</span>
<a href="#l8.62"></a><span id="l8.62">                                          nsIAbListener.itemChanged);</span>
<a href="#l8.63"></a><span id="l8.63"> }</span>
<a href="#l8.64"></a><span id="l8.64"> </span>
<a href="#l8.65"></a><span id="l8.65" class="difflineminus">-function onUninitEditDirectories()</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineminus">-{</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineplus">+function onUninitEditDirectories() {</span>
<a href="#l8.68"></a><span id="l8.68">   MailServices.ab.removeAddressBookListener(gAddressBookAbListener);</span>
<a href="#l8.69"></a><span id="l8.69"> }</span>
<a href="#l8.70"></a><span id="l8.70"> </span>
<a href="#l8.71"></a><span id="l8.71" class="difflineminus">-function fillDirectoryList()</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineminus">-{</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineplus">+function fillDirectoryList() {</span>
<a href="#l8.74"></a><span id="l8.74">   var abList = document.getElementById(&quot;directoriesList&quot;);</span>
<a href="#l8.75"></a><span id="l8.75"> </span>
<a href="#l8.76"></a><span id="l8.76">   // Empty out anything in the list</span>
<a href="#l8.77"></a><span id="l8.77">   while (abList.hasChildNodes())</span>
<a href="#l8.78"></a><span id="l8.78">     abList.lastChild.remove();</span>
<a href="#l8.79"></a><span id="l8.79"> </span>
<a href="#l8.80"></a><span id="l8.80">   // Init the address book list</span>
<a href="#l8.81"></a><span id="l8.81">   let directories = MailServices.ab.directories;</span>
<a href="#l8.82"></a><span id="l8.82">   let holdingArray = [];</span>
<a href="#l8.83"></a><span id="l8.83">   while (directories &amp;&amp; directories.hasMoreElements()) {</span>
<a href="#l8.84"></a><span id="l8.84">     let ab = directories.getNext();</span>
<a href="#l8.85"></a><span id="l8.85">     if (ab instanceof Ci.nsIAbDirectory &amp;&amp; ab.isRemote)</span>
<a href="#l8.86"></a><span id="l8.86">       holdingArray.push(ab);</span>
<a href="#l8.87"></a><span id="l8.87">   }</span>
<a href="#l8.88"></a><span id="l8.88"> </span>
<a href="#l8.89"></a><span id="l8.89" class="difflineminus">-  holdingArray.sort(function (a, b) { return a.dirName.localeCompare(b.dirName); });</span>
<a href="#l8.90"></a><span id="l8.90" class="difflineplus">+  holdingArray.sort(function(a, b) { return a.dirName.localeCompare(b.dirName); });</span>
<a href="#l8.91"></a><span id="l8.91"> </span>
<a href="#l8.92"></a><span id="l8.92" class="difflineminus">-  holdingArray.forEach(function (ab) {</span>
<a href="#l8.93"></a><span id="l8.93" class="difflineplus">+  holdingArray.forEach(function(ab) {</span>
<a href="#l8.94"></a><span id="l8.94">     let item = document.createElement(&quot;richlistitem&quot;);</span>
<a href="#l8.95"></a><span id="l8.95">     let label = document.createElement(&quot;label&quot;);</span>
<a href="#l8.96"></a><span id="l8.96">     label.setAttribute(&quot;value&quot;, ab.dirName);</span>
<a href="#l8.97"></a><span id="l8.97">     item.appendChild(label);</span>
<a href="#l8.98"></a><span id="l8.98">     item.setAttribute(&quot;value&quot;, ab.URI);</span>
<a href="#l8.99"></a><span id="l8.99"> </span>
<a href="#l8.100"></a><span id="l8.100">     abList.appendChild(item);</span>
<a href="#l8.101"></a><span id="l8.101">   });</span>
<a href="#l8.102"></a><span id="l8.102"> }</span>
<a href="#l8.103"></a><span id="l8.103"> </span>
<a href="#l8.104"></a><span id="l8.104" class="difflineminus">-function selectDirectory()</span>
<a href="#l8.105"></a><span id="l8.105" class="difflineminus">-{</span>
<a href="#l8.106"></a><span id="l8.106" class="difflineplus">+function selectDirectory() {</span>
<a href="#l8.107"></a><span id="l8.107">   var abList = document.getElementById(&quot;directoriesList&quot;);</span>
<a href="#l8.108"></a><span id="l8.108">   var editButton = document.getElementById(&quot;editButton&quot;);</span>
<a href="#l8.109"></a><span id="l8.109">   var removeButton = document.getElementById(&quot;removeButton&quot;);</span>
<a href="#l8.110"></a><span id="l8.110"> </span>
<a href="#l8.111"></a><span id="l8.111">   if (abList &amp;&amp; abList.selectedItem) {</span>
<a href="#l8.112"></a><span id="l8.112">     editButton.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l8.113"></a><span id="l8.113"> </span>
<a href="#l8.114"></a><span id="l8.114">     // If the disable delete button pref for the selected directory is set,</span>
<a href="#l8.115"></a><span id="l8.115">     // disable the delete button for that directory.</span>
<a href="#l8.116"></a><span id="l8.116" class="difflineminus">-    let disable = false;</span>
<a href="#l8.117"></a><span id="l8.117">     let ab = MailServices.ab.getDirectory(abList.value);</span>
<a href="#l8.118"></a><span id="l8.118" class="difflineminus">-    try {</span>
<a href="#l8.119"></a><span id="l8.119" class="difflineminus">-      disable = Services.prefs.getBoolPref(ab.dirPrefId + &quot;.disable_delete&quot;);</span>
<a href="#l8.120"></a><span id="l8.120" class="difflineminus">-    }</span>
<a href="#l8.121"></a><span id="l8.121" class="difflineminus">-    catch(ex){</span>
<a href="#l8.122"></a><span id="l8.122" class="difflineminus">-      // If this preference is not set, it's ok.</span>
<a href="#l8.123"></a><span id="l8.123" class="difflineminus">-    }</span>
<a href="#l8.124"></a><span id="l8.124" class="difflineplus">+    let disable = Services.prefs.getBoolPref(ab.dirPrefId + &quot;.disable_delete&quot;, false);</span>
<a href="#l8.125"></a><span id="l8.125">     if (disable)</span>
<a href="#l8.126"></a><span id="l8.126">       removeButton.setAttribute(&quot;disabled&quot;, true);</span>
<a href="#l8.127"></a><span id="l8.127">     else</span>
<a href="#l8.128"></a><span id="l8.128">       removeButton.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l8.129"></a><span id="l8.129" class="difflineminus">-  }</span>
<a href="#l8.130"></a><span id="l8.130" class="difflineminus">-  else {</span>
<a href="#l8.131"></a><span id="l8.131" class="difflineplus">+  } else {</span>
<a href="#l8.132"></a><span id="l8.132">     editButton.setAttribute(&quot;disabled&quot;, true);</span>
<a href="#l8.133"></a><span id="l8.133">     removeButton.setAttribute(&quot;disabled&quot;, true);</span>
<a href="#l8.134"></a><span id="l8.134">   }</span>
<a href="#l8.135"></a><span id="l8.135"> }</span>
<a href="#l8.136"></a><span id="l8.136"> </span>
<a href="#l8.137"></a><span id="l8.137" class="difflineminus">-function dblClickDirectory(event)</span>
<a href="#l8.138"></a><span id="l8.138" class="difflineminus">-{</span>
<a href="#l8.139"></a><span id="l8.139" class="difflineplus">+function dblClickDirectory(event) {</span>
<a href="#l8.140"></a><span id="l8.140">   // We only care about left click events.</span>
<a href="#l8.141"></a><span id="l8.141">   if (event.button != 0)</span>
<a href="#l8.142"></a><span id="l8.142">     return;</span>
<a href="#l8.143"></a><span id="l8.143"> </span>
<a href="#l8.144"></a><span id="l8.144">   editDirectory();</span>
<a href="#l8.145"></a><span id="l8.145"> }</span>
<a href="#l8.146"></a><span id="l8.146"> </span>
<a href="#l8.147"></a><span id="l8.147" class="difflineminus">-function editDirectory()</span>
<a href="#l8.148"></a><span id="l8.148" class="difflineminus">-{</span>
<a href="#l8.149"></a><span id="l8.149" class="difflineplus">+function editDirectory() {</span>
<a href="#l8.150"></a><span id="l8.150">   var abList = document.getElementById(&quot;directoriesList&quot;);</span>
<a href="#l8.151"></a><span id="l8.151"> </span>
<a href="#l8.152"></a><span id="l8.152">   if (abList &amp;&amp; abList.selectedItem) {</span>
<a href="#l8.153"></a><span id="l8.153">     let abURI = abList.value;</span>
<a href="#l8.154"></a><span id="l8.154">     let ab = MailServices.ab.getDirectory(abURI);</span>
<a href="#l8.155"></a><span id="l8.155"> </span>
<a href="#l8.156"></a><span id="l8.156">     window.openDialog(ab.propertiesChromeURI, &quot;editDirectory&quot;,</span>
<a href="#l8.157"></a><span id="l8.157">                       &quot;chrome,modal=yes,resizable=no&quot;,</span>
<a href="#l8.158"></a><span id="l8.158">                       { selectedDirectory: ab });</span>
<a href="#l8.159"></a><span id="l8.159">   }</span>
<a href="#l8.160"></a><span id="l8.160"> }</span>
<a href="#l8.161"></a><span id="l8.161"> </span>
<a href="#l8.162"></a><span id="l8.162" class="difflineminus">-function removeDirectory()</span>
<a href="#l8.163"></a><span id="l8.163" class="difflineminus">-{</span>
<a href="#l8.164"></a><span id="l8.164" class="difflineplus">+function removeDirectory() {</span>
<a href="#l8.165"></a><span id="l8.165">   var abList = document.getElementById(&quot;directoriesList&quot;);</span>
<a href="#l8.166"></a><span id="l8.166"> </span>
<a href="#l8.167"></a><span id="l8.167">   if (abList &amp;&amp; abList.selectedItem)</span>
<a href="#l8.168"></a><span id="l8.168">     AbDeleteDirectory(abList.value);</span>
<a href="#l8.169"></a><span id="l8.169"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbAutoCompleteMyDomain.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbAutoCompleteMyDomain.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -12,17 +12,17 @@ nsAbAutoCompleteMyDomain.prototype = {</span>
<a href="#l9.4"></a><span id="l9.4">   QueryInterface: ChromeUtils.generateQI([</span>
<a href="#l9.5"></a><span id="l9.5">       Ci.nsIAutoCompleteSearch]),</span>
<a href="#l9.6"></a><span id="l9.6"> </span>
<a href="#l9.7"></a><span id="l9.7">   cachedIdKey: &quot;&quot;,</span>
<a href="#l9.8"></a><span id="l9.8">   cachedIdentity: null,</span>
<a href="#l9.9"></a><span id="l9.9"> </span>
<a href="#l9.10"></a><span id="l9.10">   applicableHeaders: new Set([&quot;addr_to&quot;, &quot;addr_cc&quot;, &quot;addr_bcc&quot;, &quot;addr_reply&quot;]),</span>
<a href="#l9.11"></a><span id="l9.11"> </span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-  startSearch: function(aString, aSearchParam, aResult, aListener) {</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+  startSearch(aString, aSearchParam, aResult, aListener) {</span>
<a href="#l9.14"></a><span id="l9.14">     let params = aSearchParam ? JSON.parse(aSearchParam) : {};</span>
<a href="#l9.15"></a><span id="l9.15">     let applicable = (&quot;type&quot; in params) &amp;&amp; this.applicableHeaders.has(params.type);</span>
<a href="#l9.16"></a><span id="l9.16">     const ACR = Ci.nsIAutoCompleteResult;</span>
<a href="#l9.17"></a><span id="l9.17">     var address = null;</span>
<a href="#l9.18"></a><span id="l9.18">     if (applicable &amp;&amp; aString &amp;&amp; !aString.includes(&quot;,&quot;)) {</span>
<a href="#l9.19"></a><span id="l9.19">       if ((&quot;idKey&quot; in params) &amp;&amp; (params.idKey != this.cachedIdKey)) {</span>
<a href="#l9.20"></a><span id="l9.20">         this.cachedIdentity = MailServices.accounts.getIdentity(params.idKey);</span>
<a href="#l9.21"></a><span id="l9.21">         this.cachedIdKey = params.idKey;</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineat">@@ -33,26 +33,26 @@ nsAbAutoCompleteMyDomain.prototype = {</span>
<a href="#l9.23"></a><span id="l9.23">     }</span>
<a href="#l9.24"></a><span id="l9.24"> </span>
<a href="#l9.25"></a><span id="l9.25">     var result = {</span>
<a href="#l9.26"></a><span id="l9.26">       searchString: aString,</span>
<a href="#l9.27"></a><span id="l9.27">       searchResult: address ? ACR.RESULT_SUCCESS : ACR.RESULT_FAILURE,</span>
<a href="#l9.28"></a><span id="l9.28">       defaultIndex: -1,</span>
<a href="#l9.29"></a><span id="l9.29">       errorDescription: null,</span>
<a href="#l9.30"></a><span id="l9.30">       matchCount: address ? 1 : 0,</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineminus">-      getValueAt: function() { return address; },</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineminus">-      getLabelAt: function() { return this.getValueAt(); },</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineminus">-      getCommentAt: function() { return null; },</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineminus">-      getStyleAt: function() { return &quot;default-match&quot;; },</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineminus">-      getImageAt: function() { return null; },</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineminus">-      getFinalCompleteValueAt: function(aIndex) {</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineplus">+      getValueAt() { return address; },</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineplus">+      getLabelAt() { return this.getValueAt(); },</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineplus">+      getCommentAt() { return null; },</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineplus">+      getStyleAt() { return &quot;default-match&quot;; },</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineplus">+      getImageAt() { return null; },</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineplus">+      getFinalCompleteValueAt(aIndex) {</span>
<a href="#l9.43"></a><span id="l9.43">         return this.getValueAt(aIndex);</span>
<a href="#l9.44"></a><span id="l9.44">       },</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineminus">-      removeValueAt: function() {}</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineplus">+      removeValueAt() {},</span>
<a href="#l9.47"></a><span id="l9.47">     };</span>
<a href="#l9.48"></a><span id="l9.48">     aListener.onSearchResult(this, result);</span>
<a href="#l9.49"></a><span id="l9.49">   },</span>
<a href="#l9.50"></a><span id="l9.50"> </span>
<a href="#l9.51"></a><span id="l9.51" class="difflineminus">-  stopSearch: function() {}</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineplus">+  stopSearch() {},</span>
<a href="#l9.53"></a><span id="l9.53"> };</span>
<a href="#l9.54"></a><span id="l9.54"> </span>
<a href="#l9.55"></a><span id="l9.55"> var components = [nsAbAutoCompleteMyDomain];</span>
<a href="#l9.56"></a><span id="l9.56"> var NSGetFactory = XPCOMUtils.generateNSGetFactory(components);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbAutoCompleteSearch.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbAutoCompleteSearch.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -1,15 +1,20 @@</span>
<a href="#l10.4"></a><span id="l10.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l10.5"></a><span id="l10.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l10.6"></a><span id="l10.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l10.7"></a><span id="l10.7"> </span>
<a href="#l10.8"></a><span id="l10.8"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l10.9"></a><span id="l10.9"> ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l10.10"></a><span id="l10.10" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/ABQueryUtils.jsm&quot;);</span>
<a href="#l10.11"></a><span id="l10.11" class="difflineplus">+var {</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+  getSearchTokens,</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+  getModelQuery,</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+  modelQueryHasUserValue,</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+  generateQueryURI,</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+} = ChromeUtils.import(&quot;resource:///modules/ABQueryUtils.jsm&quot;, null);</span>
<a href="#l10.17"></a><span id="l10.17"> ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l10.18"></a><span id="l10.18"> </span>
<a href="#l10.19"></a><span id="l10.19"> var ACR = Ci.nsIAutoCompleteResult;</span>
<a href="#l10.20"></a><span id="l10.20"> var nsIAbAutoCompleteResult = Ci.nsIAbAutoCompleteResult;</span>
<a href="#l10.21"></a><span id="l10.21"> </span>
<a href="#l10.22"></a><span id="l10.22"> function nsAbAutoCompleteResult(aSearchString) {</span>
<a href="#l10.23"></a><span id="l10.23">   // Can't create this in the prototype as we'd get the same array for</span>
<a href="#l10.24"></a><span id="l10.24">   // all instances</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineat">@@ -33,57 +38,57 @@ nsAbAutoCompleteResult.prototype = {</span>
<a href="#l10.26"></a><span id="l10.26">   searchResult: ACR.RESULT_NOMATCH,</span>
<a href="#l10.27"></a><span id="l10.27">   defaultIndex: -1,</span>
<a href="#l10.28"></a><span id="l10.28">   errorDescription: null,</span>
<a href="#l10.29"></a><span id="l10.29"> </span>
<a href="#l10.30"></a><span id="l10.30">   get matchCount() {</span>
<a href="#l10.31"></a><span id="l10.31">     return this._searchResults.length;</span>
<a href="#l10.32"></a><span id="l10.32">   },</span>
<a href="#l10.33"></a><span id="l10.33"> </span>
<a href="#l10.34"></a><span id="l10.34" class="difflineminus">-  getValueAt: function getValueAt(aIndex) {</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineplus">+  getValueAt(aIndex) {</span>
<a href="#l10.36"></a><span id="l10.36">     return this._searchResults[aIndex].value;</span>
<a href="#l10.37"></a><span id="l10.37">   },</span>
<a href="#l10.38"></a><span id="l10.38"> </span>
<a href="#l10.39"></a><span id="l10.39" class="difflineminus">-  getLabelAt: function getLabelAt(aIndex) {</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineplus">+  getLabelAt(aIndex) {</span>
<a href="#l10.41"></a><span id="l10.41">     return this.getValueAt(aIndex);</span>
<a href="#l10.42"></a><span id="l10.42">   },</span>
<a href="#l10.43"></a><span id="l10.43"> </span>
<a href="#l10.44"></a><span id="l10.44" class="difflineminus">-  getCommentAt: function getCommentAt(aIndex) {</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineplus">+  getCommentAt(aIndex) {</span>
<a href="#l10.46"></a><span id="l10.46">     return this._searchResults[aIndex].comment;</span>
<a href="#l10.47"></a><span id="l10.47">   },</span>
<a href="#l10.48"></a><span id="l10.48"> </span>
<a href="#l10.49"></a><span id="l10.49" class="difflineminus">-  getStyleAt: function getStyleAt(aIndex) {</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineplus">+  getStyleAt(aIndex) {</span>
<a href="#l10.51"></a><span id="l10.51">     return &quot;local-abook&quot;;</span>
<a href="#l10.52"></a><span id="l10.52">   },</span>
<a href="#l10.53"></a><span id="l10.53"> </span>
<a href="#l10.54"></a><span id="l10.54" class="difflineminus">-  getImageAt: function getImageAt(aIndex) {</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineplus">+  getImageAt(aIndex) {</span>
<a href="#l10.56"></a><span id="l10.56">     return &quot;&quot;;</span>
<a href="#l10.57"></a><span id="l10.57">   },</span>
<a href="#l10.58"></a><span id="l10.58"> </span>
<a href="#l10.59"></a><span id="l10.59" class="difflineminus">-  getFinalCompleteValueAt: function(aIndex) {</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineplus">+  getFinalCompleteValueAt(aIndex) {</span>
<a href="#l10.61"></a><span id="l10.61">     return this.getValueAt(aIndex);</span>
<a href="#l10.62"></a><span id="l10.62">   },</span>
<a href="#l10.63"></a><span id="l10.63"> </span>
<a href="#l10.64"></a><span id="l10.64" class="difflineminus">-  removeValueAt: function removeValueAt(aRowIndex, aRemoveFromDB) {</span>
<a href="#l10.65"></a><span id="l10.65" class="difflineplus">+  removeValueAt(aRowIndex, aRemoveFromDB) {</span>
<a href="#l10.66"></a><span id="l10.66">   },</span>
<a href="#l10.67"></a><span id="l10.67"> </span>
<a href="#l10.68"></a><span id="l10.68">   // nsIAbAutoCompleteResult</span>
<a href="#l10.69"></a><span id="l10.69"> </span>
<a href="#l10.70"></a><span id="l10.70" class="difflineminus">-  getCardAt: function getCardAt(aIndex) {</span>
<a href="#l10.71"></a><span id="l10.71" class="difflineplus">+  getCardAt(aIndex) {</span>
<a href="#l10.72"></a><span id="l10.72">     return this._searchResults[aIndex].card;</span>
<a href="#l10.73"></a><span id="l10.73">   },</span>
<a href="#l10.74"></a><span id="l10.74"> </span>
<a href="#l10.75"></a><span id="l10.75" class="difflineminus">-  getEmailToUse: function getEmailToUse(aIndex) {</span>
<a href="#l10.76"></a><span id="l10.76" class="difflineplus">+  getEmailToUse(aIndex) {</span>
<a href="#l10.77"></a><span id="l10.77">     return this._searchResults[aIndex].emailToUse;</span>
<a href="#l10.78"></a><span id="l10.78">   },</span>
<a href="#l10.79"></a><span id="l10.79"> </span>
<a href="#l10.80"></a><span id="l10.80">   // nsISupports</span>
<a href="#l10.81"></a><span id="l10.81"> </span>
<a href="#l10.82"></a><span id="l10.82" class="difflineminus">-  QueryInterface: ChromeUtils.generateQI([ACR, nsIAbAutoCompleteResult])</span>
<a href="#l10.83"></a><span id="l10.83" class="difflineminus">-}</span>
<a href="#l10.84"></a><span id="l10.84" class="difflineplus">+  QueryInterface: ChromeUtils.generateQI([ACR, nsIAbAutoCompleteResult]),</span>
<a href="#l10.85"></a><span id="l10.85" class="difflineplus">+};</span>
<a href="#l10.86"></a><span id="l10.86"> </span>
<a href="#l10.87"></a><span id="l10.87"> function nsAbAutoCompleteSearch() {}</span>
<a href="#l10.88"></a><span id="l10.88"> </span>
<a href="#l10.89"></a><span id="l10.89"> nsAbAutoCompleteSearch.prototype = {</span>
<a href="#l10.90"></a><span id="l10.90">   // For component registration</span>
<a href="#l10.91"></a><span id="l10.91">   classID: Components.ID(&quot;2f946df9-114c-41fe-8899-81f10daf4f0c&quot;),</span>
<a href="#l10.92"></a><span id="l10.92"> </span>
<a href="#l10.93"></a><span id="l10.93">   // This is set from a preference,</span>
<a href="#l10.94"></a><span id="l10.94" class="difflineat">@@ -99,17 +104,17 @@ nsAbAutoCompleteSearch.prototype = {</span>
<a href="#l10.95"></a><span id="l10.95">   /**</span>
<a href="#l10.96"></a><span id="l10.96">    * Returns the popularity index for a given card. This takes account of a</span>
<a href="#l10.97"></a><span id="l10.97">    * translation bug whereby Thunderbird 2 stores its values in mork as</span>
<a href="#l10.98"></a><span id="l10.98">    * hexadecimal, and Thunderbird 3 stores as decimal.</span>
<a href="#l10.99"></a><span id="l10.99">    *</span>
<a href="#l10.100"></a><span id="l10.100">    * @param aDirectory  The directory that the card is in.</span>
<a href="#l10.101"></a><span id="l10.101">    * @param aCard       The card to return the popularity index for.</span>
<a href="#l10.102"></a><span id="l10.102">    */</span>
<a href="#l10.103"></a><span id="l10.103" class="difflineminus">-  _getPopularityIndex: function _getPopularityIndex(aDirectory, aCard) {</span>
<a href="#l10.104"></a><span id="l10.104" class="difflineplus">+  _getPopularityIndex(aDirectory, aCard) {</span>
<a href="#l10.105"></a><span id="l10.105">     let popularityValue = aCard.getProperty(&quot;PopularityIndex&quot;, &quot;0&quot;);</span>
<a href="#l10.106"></a><span id="l10.106">     let popularityIndex = parseInt(popularityValue);</span>
<a href="#l10.107"></a><span id="l10.107"> </span>
<a href="#l10.108"></a><span id="l10.108">     // If we haven't parsed it the first time round, parse it as hexadecimal</span>
<a href="#l10.109"></a><span id="l10.109">     // and repair so that we don't have to keep repairing.</span>
<a href="#l10.110"></a><span id="l10.110">     if (isNaN(popularityIndex)) {</span>
<a href="#l10.111"></a><span id="l10.111">       popularityIndex = parseInt(popularityValue, 16);</span>
<a href="#l10.112"></a><span id="l10.112"> </span>
<a href="#l10.113"></a><span id="l10.113" class="difflineat">@@ -117,18 +122,17 @@ nsAbAutoCompleteSearch.prototype = {</span>
<a href="#l10.114"></a><span id="l10.114">       if (isNaN(popularityIndex))</span>
<a href="#l10.115"></a><span id="l10.115">         popularityIndex = 0;</span>
<a href="#l10.116"></a><span id="l10.116"> </span>
<a href="#l10.117"></a><span id="l10.117">       // Now store this change so that we're not changing it each time around.</span>
<a href="#l10.118"></a><span id="l10.118">       if (!aDirectory.readOnly) {</span>
<a href="#l10.119"></a><span id="l10.119">         aCard.setProperty(&quot;PopularityIndex&quot;, popularityIndex);</span>
<a href="#l10.120"></a><span id="l10.120">         try {</span>
<a href="#l10.121"></a><span id="l10.121">           aDirectory.modifyCard(aCard);</span>
<a href="#l10.122"></a><span id="l10.122" class="difflineminus">-        }</span>
<a href="#l10.123"></a><span id="l10.123" class="difflineminus">-        catch (ex) {</span>
<a href="#l10.124"></a><span id="l10.124" class="difflineplus">+        } catch (ex) {</span>
<a href="#l10.125"></a><span id="l10.125">           Cu.reportError(ex);</span>
<a href="#l10.126"></a><span id="l10.126">         }</span>
<a href="#l10.127"></a><span id="l10.127">       }</span>
<a href="#l10.128"></a><span id="l10.128">     }</span>
<a href="#l10.129"></a><span id="l10.129">     return popularityIndex;</span>
<a href="#l10.130"></a><span id="l10.130">   },</span>
<a href="#l10.131"></a><span id="l10.131"> </span>
<a href="#l10.132"></a><span id="l10.132">   /**</span>
<a href="#l10.133"></a><span id="l10.133" class="difflineat">@@ -136,17 +140,17 @@ nsAbAutoCompleteSearch.prototype = {</span>
<a href="#l10.134"></a><span id="l10.134">    * results that match the beginning of a &quot;word&quot; in the result to score better</span>
<a href="#l10.135"></a><span id="l10.135">    * than a result that matches only in the middle of the word.</span>
<a href="#l10.136"></a><span id="l10.136">    *</span>
<a href="#l10.137"></a><span id="l10.137">    * @param aCard - the card whose score is being decided</span>
<a href="#l10.138"></a><span id="l10.138">    * @param aAddress - full lower-cased address, including display name and address</span>
<a href="#l10.139"></a><span id="l10.139">    * @param aSearchString - search string provided by user</span>
<a href="#l10.140"></a><span id="l10.140">    * @return a score; a higher score is better than a lower one</span>
<a href="#l10.141"></a><span id="l10.141">    */</span>
<a href="#l10.142"></a><span id="l10.142" class="difflineminus">-  _getScore: function(aCard, aAddress, aSearchString) {</span>
<a href="#l10.143"></a><span id="l10.143" class="difflineplus">+  _getScore(aCard, aAddress, aSearchString) {</span>
<a href="#l10.144"></a><span id="l10.144">     const BEST = 100;</span>
<a href="#l10.145"></a><span id="l10.145"> </span>
<a href="#l10.146"></a><span id="l10.146">     // We will firstly check if the search term provided by the user</span>
<a href="#l10.147"></a><span id="l10.147">     // is the nick name for the card or at least in the beginning of it.</span>
<a href="#l10.148"></a><span id="l10.148">     let nick = aCard.getProperty(&quot;NickName&quot;, &quot;&quot;).toLocaleLowerCase();</span>
<a href="#l10.149"></a><span id="l10.149">     aSearchString = aSearchString.toLocaleLowerCase();</span>
<a href="#l10.150"></a><span id="l10.150">     if (nick == aSearchString)</span>
<a href="#l10.151"></a><span id="l10.151">       return BEST + 1;</span>
<a href="#l10.152"></a><span id="l10.152" class="difflineat">@@ -179,36 +183,36 @@ nsAbAutoCompleteSearch.prototype = {</span>
<a href="#l10.153"></a><span id="l10.153">    * Searches cards in the given directory. If a card is matched (and isn't</span>
<a href="#l10.154"></a><span id="l10.154">    * a mailing list) then the function will add a result for each email address</span>
<a href="#l10.155"></a><span id="l10.155">    * that exists.</span>
<a href="#l10.156"></a><span id="l10.156">    *</span>
<a href="#l10.157"></a><span id="l10.157">    * @param searchQuery  The boolean search query to use.</span>
<a href="#l10.158"></a><span id="l10.158">    * @param directory    An nsIAbDirectory to search.</span>
<a href="#l10.159"></a><span id="l10.159">    * @param result       The result element to append results to.</span>
<a href="#l10.160"></a><span id="l10.160">    */</span>
<a href="#l10.161"></a><span id="l10.161" class="difflineminus">-  _searchCards: function(searchQuery, directory, result) {</span>
<a href="#l10.162"></a><span id="l10.162" class="difflineplus">+  _searchCards(searchQuery, directory, result) {</span>
<a href="#l10.163"></a><span id="l10.163">     let childCards;</span>
<a href="#l10.164"></a><span id="l10.164">     try {</span>
<a href="#l10.165"></a><span id="l10.165">       childCards = this._abManager.getDirectory(directory.URI + searchQuery).childCards;</span>
<a href="#l10.166"></a><span id="l10.166">     } catch (e) {</span>
<a href="#l10.167"></a><span id="l10.167">       Cu.reportError(&quot;Error running addressbook query '&quot; + searchQuery + &quot;': &quot; + e);</span>
<a href="#l10.168"></a><span id="l10.168">       return;</span>
<a href="#l10.169"></a><span id="l10.169">     }</span>
<a href="#l10.170"></a><span id="l10.170"> </span>
<a href="#l10.171"></a><span id="l10.171">     // Cache this values to save going through xpconnect each time</span>
<a href="#l10.172"></a><span id="l10.172">     var commentColumn = this._commentColumn == 1 ? directory.dirName : &quot;&quot;;</span>
<a href="#l10.173"></a><span id="l10.173"> </span>
<a href="#l10.174"></a><span id="l10.174">     // Now iterate through all the cards.</span>
<a href="#l10.175"></a><span id="l10.175">     while (childCards.hasMoreElements()) {</span>
<a href="#l10.176"></a><span id="l10.176">       var card = childCards.getNext();</span>
<a href="#l10.177"></a><span id="l10.177"> </span>
<a href="#l10.178"></a><span id="l10.178">       if (card instanceof Ci.nsIAbCard) {</span>
<a href="#l10.179"></a><span id="l10.179" class="difflineminus">-        if (card.isMailList)</span>
<a href="#l10.180"></a><span id="l10.180" class="difflineplus">+        if (card.isMailList) {</span>
<a href="#l10.181"></a><span id="l10.181">           this._addToResult(commentColumn, directory, card, &quot;&quot;, true, result);</span>
<a href="#l10.182"></a><span id="l10.182" class="difflineminus">-        else {</span>
<a href="#l10.183"></a><span id="l10.183" class="difflineplus">+        } else {</span>
<a href="#l10.184"></a><span id="l10.184">           let email = card.primaryEmail;</span>
<a href="#l10.185"></a><span id="l10.185">           if (email)</span>
<a href="#l10.186"></a><span id="l10.186">             this._addToResult(commentColumn, directory, card, email, true, result);</span>
<a href="#l10.187"></a><span id="l10.187"> </span>
<a href="#l10.188"></a><span id="l10.188">           email = card.getProperty(&quot;SecondEmail&quot;, &quot;&quot;);</span>
<a href="#l10.189"></a><span id="l10.189">           if (email)</span>
<a href="#l10.190"></a><span id="l10.190">             this._addToResult(commentColumn, directory, card, email, false, result);</span>
<a href="#l10.191"></a><span id="l10.191">         }</span>
<a href="#l10.192"></a><span id="l10.192" class="difflineat">@@ -222,17 +226,17 @@ nsAbAutoCompleteSearch.prototype = {</span>
<a href="#l10.193"></a><span id="l10.193">    * should still be included in the narrowed-down result.</span>
<a href="#l10.194"></a><span id="l10.194">    *</span>
<a href="#l10.195"></a><span id="l10.195">    * @param aCard        The card to check.</span>
<a href="#l10.196"></a><span id="l10.196">    * @param aEmailToUse  The email address to check against.</span>
<a href="#l10.197"></a><span id="l10.197">    * @param aSearchWords Array of words in the multi word search string.</span>
<a href="#l10.198"></a><span id="l10.198">    * @return             True if the card matches the search parameters, false</span>
<a href="#l10.199"></a><span id="l10.199">    *                     otherwise.</span>
<a href="#l10.200"></a><span id="l10.200">    */</span>
<a href="#l10.201"></a><span id="l10.201" class="difflineminus">-  _checkEntry: function _checkEntry(aCard, aEmailToUse, aSearchWords) {</span>
<a href="#l10.202"></a><span id="l10.202" class="difflineplus">+  _checkEntry(aCard, aEmailToUse, aSearchWords) {</span>
<a href="#l10.203"></a><span id="l10.203">     // Joining values of many fields in a single string so that a single</span>
<a href="#l10.204"></a><span id="l10.204">     // search query can be fired on all of them at once. Separating them</span>
<a href="#l10.205"></a><span id="l10.205">     // using spaces so that field1=&gt; &quot;abc&quot; and field2=&gt; &quot;def&quot; on joining</span>
<a href="#l10.206"></a><span id="l10.206">     // shouldn't return true on search for &quot;bcd&quot;.</span>
<a href="#l10.207"></a><span id="l10.207">     // Note: This should be constructed from model query pref using</span>
<a href="#l10.208"></a><span id="l10.208">     // getModelQuery(&quot;mail.addr_book.autocompletequery.format&quot;)</span>
<a href="#l10.209"></a><span id="l10.209">     // but for now we hard-code the default value equivalent of the pref here</span>
<a href="#l10.210"></a><span id="l10.210">     // or else bail out before and reconstruct the full c++ query if the pref</span>
<a href="#l10.211"></a><span id="l10.211" class="difflineat">@@ -257,17 +261,17 @@ nsAbAutoCompleteSearch.prototype = {</span>
<a href="#l10.212"></a><span id="l10.212">    * higher than the previous card.</span>
<a href="#l10.213"></a><span id="l10.213">    *</span>
<a href="#l10.214"></a><span id="l10.214">    * @param directory       The directory that the card is in.</span>
<a href="#l10.215"></a><span id="l10.215">    * @param card            The card that could be a duplicate.</span>
<a href="#l10.216"></a><span id="l10.216">    * @param lcEmailAddress  The emailAddress (name/address combination) to check</span>
<a href="#l10.217"></a><span id="l10.217">    *                        for duplicates against. Lowercased.</span>
<a href="#l10.218"></a><span id="l10.218">    * @param currentResults  The current results list.</span>
<a href="#l10.219"></a><span id="l10.219">    */</span>
<a href="#l10.220"></a><span id="l10.220" class="difflineminus">-  _checkDuplicate: function (directory, card, lcEmailAddress, currentResults) {</span>
<a href="#l10.221"></a><span id="l10.221" class="difflineplus">+  _checkDuplicate(directory, card, lcEmailAddress, currentResults) {</span>
<a href="#l10.222"></a><span id="l10.222">     let existingResult = currentResults._collectedValues.get(lcEmailAddress);</span>
<a href="#l10.223"></a><span id="l10.223">     if (!existingResult)</span>
<a href="#l10.224"></a><span id="l10.224">       return false;</span>
<a href="#l10.225"></a><span id="l10.225"> </span>
<a href="#l10.226"></a><span id="l10.226">     let popIndex = this._getPopularityIndex(directory, card);</span>
<a href="#l10.227"></a><span id="l10.227">     // It's a duplicate, is the new one more popular?</span>
<a href="#l10.228"></a><span id="l10.228">     if (popIndex &gt; existingResult.popularity) {</span>
<a href="#l10.229"></a><span id="l10.229">       // Yes it is, so delete this element, return false and allow</span>
<a href="#l10.230"></a><span id="l10.230" class="difflineat">@@ -289,18 +293,17 @@ nsAbAutoCompleteSearch.prototype = {</span>
<a href="#l10.231"></a><span id="l10.231">    * @param directory      The directory that the card is in.</span>
<a href="#l10.232"></a><span id="l10.232">    * @param card           The card being added to the results.</span>
<a href="#l10.233"></a><span id="l10.233">    * @param emailToUse     The email address from the card that should be used</span>
<a href="#l10.234"></a><span id="l10.234">    *                       for this result.</span>
<a href="#l10.235"></a><span id="l10.235">    * @param isPrimaryEmail Is the emailToUse the primary email? Set to true if</span>
<a href="#l10.236"></a><span id="l10.236">    *                       it is the case. For mailing lists set it to true.</span>
<a href="#l10.237"></a><span id="l10.237">    * @param result         The result to add the new entry to.</span>
<a href="#l10.238"></a><span id="l10.238">    */</span>
<a href="#l10.239"></a><span id="l10.239" class="difflineminus">-  _addToResult: function(commentColumn, directory, card,</span>
<a href="#l10.240"></a><span id="l10.240" class="difflineminus">-                         emailToUse, isPrimaryEmail, result) {</span>
<a href="#l10.241"></a><span id="l10.241" class="difflineplus">+  _addToResult(commentColumn, directory, card, emailToUse, isPrimaryEmail, result) {</span>
<a href="#l10.242"></a><span id="l10.242">     let mbox = this._parser.makeMailboxObject(card.displayName,</span>
<a href="#l10.243"></a><span id="l10.243">       card.isMailList ? card.getProperty(&quot;Notes&quot;, &quot;&quot;) || card.displayName :</span>
<a href="#l10.244"></a><span id="l10.244">                         emailToUse);</span>
<a href="#l10.245"></a><span id="l10.245">     if (!mbox.email)</span>
<a href="#l10.246"></a><span id="l10.246">       return;</span>
<a href="#l10.247"></a><span id="l10.247"> </span>
<a href="#l10.248"></a><span id="l10.248">     let emailAddress = mbox.toString();</span>
<a href="#l10.249"></a><span id="l10.249">     let lcEmailAddress = emailAddress.toLocaleLowerCase();</span>
<a href="#l10.250"></a><span id="l10.250" class="difflineat">@@ -308,36 +311,35 @@ nsAbAutoCompleteSearch.prototype = {</span>
<a href="#l10.251"></a><span id="l10.251">     // If it is a duplicate, then just return and don't add it. The</span>
<a href="#l10.252"></a><span id="l10.252">     // _checkDuplicate function deals with it all for us.</span>
<a href="#l10.253"></a><span id="l10.253">     if (this._checkDuplicate(directory, card, lcEmailAddress, result))</span>
<a href="#l10.254"></a><span id="l10.254">       return;</span>
<a href="#l10.255"></a><span id="l10.255"> </span>
<a href="#l10.256"></a><span id="l10.256">     result._collectedValues.set(lcEmailAddress, {</span>
<a href="#l10.257"></a><span id="l10.257">       value: emailAddress,</span>
<a href="#l10.258"></a><span id="l10.258">       comment: commentColumn,</span>
<a href="#l10.259"></a><span id="l10.259" class="difflineminus">-      card: card,</span>
<a href="#l10.260"></a><span id="l10.260" class="difflineminus">-      isPrimaryEmail: isPrimaryEmail,</span>
<a href="#l10.261"></a><span id="l10.261" class="difflineminus">-      emailToUse: emailToUse,</span>
<a href="#l10.262"></a><span id="l10.262" class="difflineplus">+      card,</span>
<a href="#l10.263"></a><span id="l10.263" class="difflineplus">+      isPrimaryEmail,</span>
<a href="#l10.264"></a><span id="l10.264" class="difflineplus">+      emailToUse,</span>
<a href="#l10.265"></a><span id="l10.265">       popularity: this._getPopularityIndex(directory, card),</span>
<a href="#l10.266"></a><span id="l10.266" class="difflineminus">-      score: this._getScore(card, lcEmailAddress, result.searchString)</span>
<a href="#l10.267"></a><span id="l10.267" class="difflineplus">+      score: this._getScore(card, lcEmailAddress, result.searchString),</span>
<a href="#l10.268"></a><span id="l10.268">     });</span>
<a href="#l10.269"></a><span id="l10.269">   },</span>
<a href="#l10.270"></a><span id="l10.270"> </span>
<a href="#l10.271"></a><span id="l10.271">   // nsIAutoCompleteSearch</span>
<a href="#l10.272"></a><span id="l10.272"> </span>
<a href="#l10.273"></a><span id="l10.273">   /**</span>
<a href="#l10.274"></a><span id="l10.274">    * Starts a search based on the given parameters.</span>
<a href="#l10.275"></a><span id="l10.275">    *</span>
<a href="#l10.276"></a><span id="l10.276">    * @see nsIAutoCompleteSearch for parameter details.</span>
<a href="#l10.277"></a><span id="l10.277">    *</span>
<a href="#l10.278"></a><span id="l10.278">    * It is expected that aSearchParam contains the identity (if any) to use</span>
<a href="#l10.279"></a><span id="l10.279">    * for determining if an address book should be autocompleted against.</span>
<a href="#l10.280"></a><span id="l10.280">    */</span>
<a href="#l10.281"></a><span id="l10.281" class="difflineminus">-  startSearch: function startSearch(aSearchString, aSearchParam,</span>
<a href="#l10.282"></a><span id="l10.282" class="difflineminus">-                                    aPreviousResult, aListener) {</span>
<a href="#l10.283"></a><span id="l10.283" class="difflineplus">+  startSearch(aSearchString, aSearchParam, aPreviousResult, aListener) {</span>
<a href="#l10.284"></a><span id="l10.284">     let params = aSearchParam ? JSON.parse(aSearchParam) : {};</span>
<a href="#l10.285"></a><span id="l10.285">     var result = new nsAbAutoCompleteResult(aSearchString);</span>
<a href="#l10.286"></a><span id="l10.286">     if ((&quot;type&quot; in params) &amp;&amp; !this.applicableHeaders.has(params.type)) {</span>
<a href="#l10.287"></a><span id="l10.287">       result.searchResult = ACR.RESULT_IGNORED;</span>
<a href="#l10.288"></a><span id="l10.288">       aListener.onSearchResult(this, result);</span>
<a href="#l10.289"></a><span id="l10.289">       return;</span>
<a href="#l10.290"></a><span id="l10.290">     }</span>
<a href="#l10.291"></a><span id="l10.291"> </span>
<a href="#l10.292"></a><span id="l10.292" class="difflineat">@@ -355,19 +357,17 @@ nsAbAutoCompleteSearch.prototype = {</span>
<a href="#l10.293"></a><span id="l10.293">     }</span>
<a href="#l10.294"></a><span id="l10.294"> </span>
<a href="#l10.295"></a><span id="l10.295">     // Array of all the terms from the fullString search query</span>
<a href="#l10.296"></a><span id="l10.296">     // (separated on the basis of spaces or exact terms on the</span>
<a href="#l10.297"></a><span id="l10.297">     // basis of quotes).</span>
<a href="#l10.298"></a><span id="l10.298">     let searchWords = getSearchTokens(fullString);</span>
<a href="#l10.299"></a><span id="l10.299"> </span>
<a href="#l10.300"></a><span id="l10.300">     // Find out about the comment column</span>
<a href="#l10.301"></a><span id="l10.301" class="difflineminus">-    try {</span>
<a href="#l10.302"></a><span id="l10.302" class="difflineminus">-      this._commentColumn = Services.prefs.getIntPref(&quot;mail.autoComplete.commentColumn&quot;);</span>
<a href="#l10.303"></a><span id="l10.303" class="difflineminus">-    } catch(e) { }</span>
<a href="#l10.304"></a><span id="l10.304" class="difflineplus">+    this._commentColumn = Services.prefs.getIntPref(&quot;mail.autoComplete.commentColumn&quot;, 0);</span>
<a href="#l10.305"></a><span id="l10.305"> </span>
<a href="#l10.306"></a><span id="l10.306">     if (aPreviousResult instanceof nsIAbAutoCompleteResult &amp;&amp;</span>
<a href="#l10.307"></a><span id="l10.307">         aSearchString.startsWith(aPreviousResult.searchString) &amp;&amp;</span>
<a href="#l10.308"></a><span id="l10.308">         aPreviousResult.searchResult == ACR.RESULT_SUCCESS &amp;&amp;</span>
<a href="#l10.309"></a><span id="l10.309">         !result._modelQueryHasUserValue &amp;&amp;</span>
<a href="#l10.310"></a><span id="l10.310">         result.modelQuery == aPreviousResult.modelQuery) {</span>
<a href="#l10.311"></a><span id="l10.311">       // We have successful previous matches, and model query has not changed since</span>
<a href="#l10.312"></a><span id="l10.312">       // previous search, therefore just iterate through the list of previous result</span>
<a href="#l10.313"></a><span id="l10.313" class="difflineat">@@ -383,29 +383,27 @@ nsAbAutoCompleteSearch.prototype = {</span>
<a href="#l10.314"></a><span id="l10.314">       for (let i = 0; i &lt; aPreviousResult.matchCount; ++i) {</span>
<a href="#l10.315"></a><span id="l10.315">         let card = aPreviousResult.getCardAt(i);</span>
<a href="#l10.316"></a><span id="l10.316">         let email = aPreviousResult.getEmailToUse(i);</span>
<a href="#l10.317"></a><span id="l10.317">         if (this._checkEntry(card, email, searchWords)) {</span>
<a href="#l10.318"></a><span id="l10.318">           // Add matches into the results array. We re-sort as needed later.</span>
<a href="#l10.319"></a><span id="l10.319">           result._searchResults.push({</span>
<a href="#l10.320"></a><span id="l10.320">             value: aPreviousResult.getValueAt(i),</span>
<a href="#l10.321"></a><span id="l10.321">             comment: aPreviousResult.getCommentAt(i),</span>
<a href="#l10.322"></a><span id="l10.322" class="difflineminus">-            card: card,</span>
<a href="#l10.323"></a><span id="l10.323" class="difflineplus">+            card,</span>
<a href="#l10.324"></a><span id="l10.324">             isPrimaryEmail: (card.primaryEmail == email),</span>
<a href="#l10.325"></a><span id="l10.325">             emailToUse: email,</span>
<a href="#l10.326"></a><span id="l10.326">             popularity: parseInt(card.getProperty(&quot;PopularityIndex&quot;, &quot;0&quot;)),</span>
<a href="#l10.327"></a><span id="l10.327">             score: this._getScore(card,</span>
<a href="#l10.328"></a><span id="l10.328">               aPreviousResult.getValueAt(i).toLocaleLowerCase(),</span>
<a href="#l10.329"></a><span id="l10.329" class="difflineminus">-              fullString)</span>
<a href="#l10.330"></a><span id="l10.330" class="difflineplus">+              fullString),</span>
<a href="#l10.331"></a><span id="l10.331">           });</span>
<a href="#l10.332"></a><span id="l10.332">         }</span>
<a href="#l10.333"></a><span id="l10.333">       }</span>
<a href="#l10.334"></a><span id="l10.334" class="difflineminus">-    }</span>
<a href="#l10.335"></a><span id="l10.335" class="difflineminus">-    else</span>
<a href="#l10.336"></a><span id="l10.336" class="difflineminus">-    {</span>
<a href="#l10.337"></a><span id="l10.337" class="difflineplus">+    } else {</span>
<a href="#l10.338"></a><span id="l10.338">       // Construct the search query from pref; using a query means we can</span>
<a href="#l10.339"></a><span id="l10.339">       // optimise on running the search through c++ which is better for string</span>
<a href="#l10.340"></a><span id="l10.340">       // comparisons (_checkEntry is relatively slow).</span>
<a href="#l10.341"></a><span id="l10.341">       // When user's fullstring search expression is a multiword query, search</span>
<a href="#l10.342"></a><span id="l10.342">       // for each word separately so that each result contains all the words</span>
<a href="#l10.343"></a><span id="l10.343">       // from the fullstring in the fields of the addressbook card</span>
<a href="#l10.344"></a><span id="l10.344">       // (see bug 558931 for explanations).</span>
<a href="#l10.345"></a><span id="l10.345">       // Use helper method to split up search query to multi-word search</span>
<a href="#l10.346"></a><span id="l10.346" class="difflineat">@@ -446,20 +444,20 @@ nsAbAutoCompleteSearch.prototype = {</span>
<a href="#l10.347"></a><span id="l10.347">     if (result.matchCount) {</span>
<a href="#l10.348"></a><span id="l10.348">       result.searchResult = ACR.RESULT_SUCCESS;</span>
<a href="#l10.349"></a><span id="l10.349">       result.defaultIndex = 0;</span>
<a href="#l10.350"></a><span id="l10.350">     }</span>
<a href="#l10.351"></a><span id="l10.351"> </span>
<a href="#l10.352"></a><span id="l10.352">     aListener.onSearchResult(this, result);</span>
<a href="#l10.353"></a><span id="l10.353">   },</span>
<a href="#l10.354"></a><span id="l10.354"> </span>
<a href="#l10.355"></a><span id="l10.355" class="difflineminus">-  stopSearch: function stopSearch() {</span>
<a href="#l10.356"></a><span id="l10.356" class="difflineplus">+  stopSearch() {</span>
<a href="#l10.357"></a><span id="l10.357">   },</span>
<a href="#l10.358"></a><span id="l10.358"> </span>
<a href="#l10.359"></a><span id="l10.359">   // nsISupports</span>
<a href="#l10.360"></a><span id="l10.360"> </span>
<a href="#l10.361"></a><span id="l10.361" class="difflineminus">-  QueryInterface: ChromeUtils.generateQI([Ci.nsIAutoCompleteSearch])</span>
<a href="#l10.362"></a><span id="l10.362" class="difflineplus">+  QueryInterface: ChromeUtils.generateQI([Ci.nsIAutoCompleteSearch]),</span>
<a href="#l10.363"></a><span id="l10.363"> };</span>
<a href="#l10.364"></a><span id="l10.364"> </span>
<a href="#l10.365"></a><span id="l10.365"> // Module</span>
<a href="#l10.366"></a><span id="l10.366"> </span>
<a href="#l10.367"></a><span id="l10.367"> var components = [nsAbAutoCompleteSearch];</span>
<a href="#l10.368"></a><span id="l10.368"> var NSGetFactory = XPCOMUtils.generateNSGetFactory(components);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPAttributeMap.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPAttributeMap.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -13,50 +13,49 @@ var NS_ABLDAPATTRIBUTEMAPSERVICE_CID = C</span>
<a href="#l11.4"></a><span id="l11.4"> function nsAbLDAPAttributeMap() {</span>
<a href="#l11.5"></a><span id="l11.5">   this.mPropertyMap = {};</span>
<a href="#l11.6"></a><span id="l11.6">   this.mAttrMap = {};</span>
<a href="#l11.7"></a><span id="l11.7"> }</span>
<a href="#l11.8"></a><span id="l11.8"> </span>
<a href="#l11.9"></a><span id="l11.9"> nsAbLDAPAttributeMap.prototype = {</span>
<a href="#l11.10"></a><span id="l11.10">   classID: NS_ABLDAPATTRIBUTEMAP_CID,</span>
<a href="#l11.11"></a><span id="l11.11"> </span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-  getAttributeList: function getAttributeList(aProperty) {</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+  getAttributeList(aProperty) {</span>
<a href="#l11.14"></a><span id="l11.14"> </span>
<a href="#l11.15"></a><span id="l11.15">     if (!(aProperty in this.mPropertyMap)) {</span>
<a href="#l11.16"></a><span id="l11.16">       return null;</span>
<a href="#l11.17"></a><span id="l11.17">     }</span>
<a href="#l11.18"></a><span id="l11.18"> </span>
<a href="#l11.19"></a><span id="l11.19">     // return the joined list</span>
<a href="#l11.20"></a><span id="l11.20">     return this.mPropertyMap[aProperty].join(&quot;,&quot;);</span>
<a href="#l11.21"></a><span id="l11.21">   },</span>
<a href="#l11.22"></a><span id="l11.22"> </span>
<a href="#l11.23"></a><span id="l11.23" class="difflineminus">-  getAttributes: function getAttributes(aProperty, aCount, aAttrs) {</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineplus">+  getAttributes(aProperty, aCount, aAttrs) {</span>
<a href="#l11.25"></a><span id="l11.25"> </span>
<a href="#l11.26"></a><span id="l11.26">     // fail if no entry for this</span>
<a href="#l11.27"></a><span id="l11.27">     if (!(aProperty in this.mPropertyMap)) {</span>
<a href="#l11.28"></a><span id="l11.28">       throw Cr.NS_ERROR_FAILURE;</span>
<a href="#l11.29"></a><span id="l11.29">     }</span>
<a href="#l11.30"></a><span id="l11.30"> </span>
<a href="#l11.31"></a><span id="l11.31">     aAttrs = this.mPropertyMap[aProperty];</span>
<a href="#l11.32"></a><span id="l11.32">     aCount = aAttrs.length;</span>
<a href="#l11.33"></a><span id="l11.33">     return aAttrs;</span>
<a href="#l11.34"></a><span id="l11.34">   },</span>
<a href="#l11.35"></a><span id="l11.35"> </span>
<a href="#l11.36"></a><span id="l11.36" class="difflineminus">-  getFirstAttribute: function getFirstAttribute(aProperty) {</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineplus">+  getFirstAttribute(aProperty) {</span>
<a href="#l11.38"></a><span id="l11.38"> </span>
<a href="#l11.39"></a><span id="l11.39">     // fail if no entry for this</span>
<a href="#l11.40"></a><span id="l11.40">     if (!(aProperty in this.mPropertyMap)) {</span>
<a href="#l11.41"></a><span id="l11.41">       return null;</span>
<a href="#l11.42"></a><span id="l11.42">     }</span>
<a href="#l11.43"></a><span id="l11.43"> </span>
<a href="#l11.44"></a><span id="l11.44">     return this.mPropertyMap[aProperty][0];</span>
<a href="#l11.45"></a><span id="l11.45">   },</span>
<a href="#l11.46"></a><span id="l11.46"> </span>
<a href="#l11.47"></a><span id="l11.47" class="difflineminus">-  setAttributeList: function setAttributeList(aProperty, aAttributeList,</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineminus">-                                              aAllowInconsistencies) {</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineplus">+  setAttributeList(aProperty, aAttributeList, aAllowInconsistencies) {</span>
<a href="#l11.50"></a><span id="l11.50"> </span>
<a href="#l11.51"></a><span id="l11.51">     var attrs = aAttributeList.split(&quot;,&quot;);</span>
<a href="#l11.52"></a><span id="l11.52"> </span>
<a href="#l11.53"></a><span id="l11.53">     // check to make sure this call won't allow multiple mappings to be</span>
<a href="#l11.54"></a><span id="l11.54">     // created, if requested</span>
<a href="#l11.55"></a><span id="l11.55">     if (!aAllowInconsistencies) {</span>
<a href="#l11.56"></a><span id="l11.56">       for (var attr of attrs) {</span>
<a href="#l11.57"></a><span id="l11.57">         if (attr in this.mAttrMap &amp;&amp; this.mAttrMap[attr] != aProperty) {</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineat">@@ -76,69 +75,68 @@ nsAbLDAPAttributeMap.prototype = {</span>
<a href="#l11.59"></a><span id="l11.59">     for (attr of attrs) {</span>
<a href="#l11.60"></a><span id="l11.60">       this.mAttrMap[attr] = aProperty;</span>
<a href="#l11.61"></a><span id="l11.61">     }</span>
<a href="#l11.62"></a><span id="l11.62"> </span>
<a href="#l11.63"></a><span id="l11.63">     // add them to the property map</span>
<a href="#l11.64"></a><span id="l11.64">     this.mPropertyMap[aProperty] = attrs;</span>
<a href="#l11.65"></a><span id="l11.65">   },</span>
<a href="#l11.66"></a><span id="l11.66"> </span>
<a href="#l11.67"></a><span id="l11.67" class="difflineminus">-  getProperty: function getProperty(aAttribute) {</span>
<a href="#l11.68"></a><span id="l11.68" class="difflineplus">+  getProperty(aAttribute) {</span>
<a href="#l11.69"></a><span id="l11.69"> </span>
<a href="#l11.70"></a><span id="l11.70">     if (!(aAttribute in this.mAttrMap)) {</span>
<a href="#l11.71"></a><span id="l11.71">       return null;</span>
<a href="#l11.72"></a><span id="l11.72">     }</span>
<a href="#l11.73"></a><span id="l11.73"> </span>
<a href="#l11.74"></a><span id="l11.74">     return this.mAttrMap[aAttribute];</span>
<a href="#l11.75"></a><span id="l11.75">   },</span>
<a href="#l11.76"></a><span id="l11.76"> </span>
<a href="#l11.77"></a><span id="l11.77" class="difflineminus">-  getAllCardAttributes: function getAllCardAttributes() {</span>
<a href="#l11.78"></a><span id="l11.78" class="difflineplus">+  getAllCardAttributes() {</span>
<a href="#l11.79"></a><span id="l11.79">     var attrs = [];</span>
<a href="#l11.80"></a><span id="l11.80">     for (var prop in this.mPropertyMap) {</span>
<a href="#l11.81"></a><span id="l11.81">       let attrArray = this.mPropertyMap[prop];</span>
<a href="#l11.82"></a><span id="l11.82">       attrs = attrs.concat(attrArray);</span>
<a href="#l11.83"></a><span id="l11.83">     }</span>
<a href="#l11.84"></a><span id="l11.84"> </span>
<a href="#l11.85"></a><span id="l11.85">     if (!attrs.length) {</span>
<a href="#l11.86"></a><span id="l11.86">       throw Cr.NS_ERROR_FAILURE;</span>
<a href="#l11.87"></a><span id="l11.87">     }</span>
<a href="#l11.88"></a><span id="l11.88"> </span>
<a href="#l11.89"></a><span id="l11.89">     return attrs.join(&quot;,&quot;);</span>
<a href="#l11.90"></a><span id="l11.90">   },</span>
<a href="#l11.91"></a><span id="l11.91"> </span>
<a href="#l11.92"></a><span id="l11.92" class="difflineminus">-  getAllCardProperties: function getAllCardProperties(aCount) {</span>
<a href="#l11.93"></a><span id="l11.93" class="difflineplus">+  getAllCardProperties(aCount) {</span>
<a href="#l11.94"></a><span id="l11.94"> </span>
<a href="#l11.95"></a><span id="l11.95">     var props = [];</span>
<a href="#l11.96"></a><span id="l11.96">     for (var prop in this.mPropertyMap) {</span>
<a href="#l11.97"></a><span id="l11.97">       props.push(prop);</span>
<a href="#l11.98"></a><span id="l11.98">     }</span>
<a href="#l11.99"></a><span id="l11.99"> </span>
<a href="#l11.100"></a><span id="l11.100">     aCount.value = props.length;</span>
<a href="#l11.101"></a><span id="l11.101">     return props;</span>
<a href="#l11.102"></a><span id="l11.102">   },</span>
<a href="#l11.103"></a><span id="l11.103"> </span>
<a href="#l11.104"></a><span id="l11.104" class="difflineminus">-  setFromPrefs: function setFromPrefs(aPrefBranchName) {</span>
<a href="#l11.105"></a><span id="l11.105" class="difflineplus">+  setFromPrefs(aPrefBranchName) {</span>
<a href="#l11.106"></a><span id="l11.106">     // get the right pref branch</span>
<a href="#l11.107"></a><span id="l11.107">     let branch = Services.prefs.getBranch(aPrefBranchName + &quot;.&quot;);</span>
<a href="#l11.108"></a><span id="l11.108"> </span>
<a href="#l11.109"></a><span id="l11.109">     // get the list of children</span>
<a href="#l11.110"></a><span id="l11.110">     var childCount = {};</span>
<a href="#l11.111"></a><span id="l11.111">     var children = branch.getChildList(&quot;&quot;, childCount);</span>
<a href="#l11.112"></a><span id="l11.112"> </span>
<a href="#l11.113"></a><span id="l11.113">     // do the actual sets</span>
<a href="#l11.114"></a><span id="l11.114">     for (var child of children) {</span>
<a href="#l11.115"></a><span id="l11.115">       this.setAttributeList(child, branch.getCharPref(child), true);</span>
<a href="#l11.116"></a><span id="l11.116">     }</span>
<a href="#l11.117"></a><span id="l11.117"> </span>
<a href="#l11.118"></a><span id="l11.118">     // ensure that everything is kosher</span>
<a href="#l11.119"></a><span id="l11.119">     this.checkState();</span>
<a href="#l11.120"></a><span id="l11.120">   },</span>
<a href="#l11.121"></a><span id="l11.121"> </span>
<a href="#l11.122"></a><span id="l11.122" class="difflineminus">-  setCardPropertiesFromLDAPMessage: function</span>
<a href="#l11.123"></a><span id="l11.123" class="difflineminus">-    setCardPropertiesFromLDAPMessage(aMessage, aCard) {</span>
<a href="#l11.124"></a><span id="l11.124" class="difflineplus">+  setCardPropertiesFromLDAPMessage(aMessage, aCard) {</span>
<a href="#l11.125"></a><span id="l11.125"> </span>
<a href="#l11.126"></a><span id="l11.126">     var cardValueWasSet = false;</span>
<a href="#l11.127"></a><span id="l11.127"> </span>
<a href="#l11.128"></a><span id="l11.128">     var msgAttrCount = {};</span>
<a href="#l11.129"></a><span id="l11.129">     var msgAttrs = aMessage.getAttributes(msgAttrCount);</span>
<a href="#l11.130"></a><span id="l11.130"> </span>
<a href="#l11.131"></a><span id="l11.131">     // downcase the array for comparison</span>
<a href="#l11.132"></a><span id="l11.132">     function toLower(a) { return a.toLowerCase(); }</span>
<a href="#l11.133"></a><span id="l11.133" class="difflineat">@@ -148,17 +146,17 @@ nsAbLDAPAttributeMap.prototype = {</span>
<a href="#l11.134"></a><span id="l11.134">     for (var prop in this.mPropertyMap) {</span>
<a href="#l11.135"></a><span id="l11.135"> </span>
<a href="#l11.136"></a><span id="l11.136">       // go through the list of possible attrs in precedence order</span>
<a href="#l11.137"></a><span id="l11.137">       for (var attr of this.mPropertyMap[prop]) {</span>
<a href="#l11.138"></a><span id="l11.138"> </span>
<a href="#l11.139"></a><span id="l11.139">         attr = attr.toLowerCase();</span>
<a href="#l11.140"></a><span id="l11.140"> </span>
<a href="#l11.141"></a><span id="l11.141">         // find the first attr that exists in this message</span>
<a href="#l11.142"></a><span id="l11.142" class="difflineminus">-        if (msgAttrs.indexOf(attr) != -1) {</span>
<a href="#l11.143"></a><span id="l11.143" class="difflineplus">+        if (msgAttrs.includes(attr)) {</span>
<a href="#l11.144"></a><span id="l11.144"> </span>
<a href="#l11.145"></a><span id="l11.145">           try {</span>
<a href="#l11.146"></a><span id="l11.146">             var values = aMessage.getValues(attr, {});</span>
<a href="#l11.147"></a><span id="l11.147">             // strip out the optional label from the labeledURI</span>
<a href="#l11.148"></a><span id="l11.148">             if (attr == &quot;labeleduri&quot; &amp;&amp; values[0]) {</span>
<a href="#l11.149"></a><span id="l11.149">               var index = values[0].indexOf(&quot; &quot;);</span>
<a href="#l11.150"></a><span id="l11.150">               if (index != -1)</span>
<a href="#l11.151"></a><span id="l11.151">                 values[0] = values[0].substring(0, index);</span>
<a href="#l11.152"></a><span id="l11.152" class="difflineat">@@ -172,59 +170,55 @@ nsAbLDAPAttributeMap.prototype = {</span>
<a href="#l11.153"></a><span id="l11.153">           }</span>
<a href="#l11.154"></a><span id="l11.154">         }</span>
<a href="#l11.155"></a><span id="l11.155">       }</span>
<a href="#l11.156"></a><span id="l11.156">     }</span>
<a href="#l11.157"></a><span id="l11.157"> </span>
<a href="#l11.158"></a><span id="l11.158">     if (!cardValueWasSet) {</span>
<a href="#l11.159"></a><span id="l11.159">       throw Cr.NS_ERROR_FAILURE;</span>
<a href="#l11.160"></a><span id="l11.160">     }</span>
<a href="#l11.161"></a><span id="l11.161" class="difflineminus">-</span>
<a href="#l11.162"></a><span id="l11.162" class="difflineminus">-    return;</span>
<a href="#l11.163"></a><span id="l11.163">   },</span>
<a href="#l11.164"></a><span id="l11.164"> </span>
<a href="#l11.165"></a><span id="l11.165" class="difflineminus">-  checkState: function checkState() {</span>
<a href="#l11.166"></a><span id="l11.166" class="difflineplus">+  checkState() {</span>
<a href="#l11.167"></a><span id="l11.167"> </span>
<a href="#l11.168"></a><span id="l11.168">     var attrsSeen = [];</span>
<a href="#l11.169"></a><span id="l11.169"> </span>
<a href="#l11.170"></a><span id="l11.170">     for (var prop in this.mPropertyMap) {</span>
<a href="#l11.171"></a><span id="l11.171">       let attrArray = this.mPropertyMap[prop];</span>
<a href="#l11.172"></a><span id="l11.172">       for (var attr of attrArray) {</span>
<a href="#l11.173"></a><span id="l11.173"> </span>
<a href="#l11.174"></a><span id="l11.174">         // multiple attributes that mapped to the empty string are permitted</span>
<a href="#l11.175"></a><span id="l11.175">         if (!attr.length) {</span>
<a href="#l11.176"></a><span id="l11.176">           continue;</span>
<a href="#l11.177"></a><span id="l11.177">         }</span>
<a href="#l11.178"></a><span id="l11.178"> </span>
<a href="#l11.179"></a><span id="l11.179">         // if we've seen this before, there's a problem</span>
<a href="#l11.180"></a><span id="l11.180" class="difflineminus">-        if (attrsSeen.indexOf(attr) != -1) {</span>
<a href="#l11.181"></a><span id="l11.181" class="difflineplus">+        if (attrsSeen.includes(attr)) {</span>
<a href="#l11.182"></a><span id="l11.182">           throw Cr.NS_ERROR_FAILURE;</span>
<a href="#l11.183"></a><span id="l11.183">         }</span>
<a href="#l11.184"></a><span id="l11.184"> </span>
<a href="#l11.185"></a><span id="l11.185">         // remember that we've seen it now</span>
<a href="#l11.186"></a><span id="l11.186">         attrsSeen.push(attr);</span>
<a href="#l11.187"></a><span id="l11.187">       }</span>
<a href="#l11.188"></a><span id="l11.188">     }</span>
<a href="#l11.189"></a><span id="l11.189" class="difflineminus">-</span>
<a href="#l11.190"></a><span id="l11.190" class="difflineminus">-    return;</span>
<a href="#l11.191"></a><span id="l11.191">   },</span>
<a href="#l11.192"></a><span id="l11.192"> </span>
<a href="#l11.193"></a><span id="l11.193" class="difflineminus">-  QueryInterface: ChromeUtils.generateQI([Ci.nsIAbLDAPAttributeMap])</span>
<a href="#l11.194"></a><span id="l11.194" class="difflineminus">-}</span>
<a href="#l11.195"></a><span id="l11.195" class="difflineplus">+  QueryInterface: ChromeUtils.generateQI([Ci.nsIAbLDAPAttributeMap]),</span>
<a href="#l11.196"></a><span id="l11.196" class="difflineplus">+};</span>
<a href="#l11.197"></a><span id="l11.197"> </span>
<a href="#l11.198"></a><span id="l11.198"> function nsAbLDAPAttributeMapService() {</span>
<a href="#l11.199"></a><span id="l11.199"> }</span>
<a href="#l11.200"></a><span id="l11.200"> </span>
<a href="#l11.201"></a><span id="l11.201"> nsAbLDAPAttributeMapService.prototype = {</span>
<a href="#l11.202"></a><span id="l11.202"> </span>
<a href="#l11.203"></a><span id="l11.203">   classID: NS_ABLDAPATTRIBUTEMAPSERVICE_CID,</span>
<a href="#l11.204"></a><span id="l11.204"> </span>
<a href="#l11.205"></a><span id="l11.205">   mAttrMaps: {},</span>
<a href="#l11.206"></a><span id="l11.206"> </span>
<a href="#l11.207"></a><span id="l11.207" class="difflineminus">-  getMapForPrefBranch: function getMapForPrefBranch(aPrefBranchName) {</span>
<a href="#l11.208"></a><span id="l11.208" class="difflineplus">+  getMapForPrefBranch(aPrefBranchName) {</span>
<a href="#l11.209"></a><span id="l11.209"> </span>
<a href="#l11.210"></a><span id="l11.210">     // if we've already got this map, return it</span>
<a href="#l11.211"></a><span id="l11.211">     if (aPrefBranchName in this.mAttrMaps) {</span>
<a href="#l11.212"></a><span id="l11.212">       return this.mAttrMaps[aPrefBranchName];</span>
<a href="#l11.213"></a><span id="l11.213">     }</span>
<a href="#l11.214"></a><span id="l11.214"> </span>
<a href="#l11.215"></a><span id="l11.215">     // otherwise, try and create it</span>
<a href="#l11.216"></a><span id="l11.216">     var attrMap = new nsAbLDAPAttributeMap();</span>
<a href="#l11.217"></a><span id="l11.217" class="difflineat">@@ -233,13 +227,13 @@ nsAbLDAPAttributeMapService.prototype = </span>
<a href="#l11.218"></a><span id="l11.218"> </span>
<a href="#l11.219"></a><span id="l11.219">     // cache</span>
<a href="#l11.220"></a><span id="l11.220">     this.mAttrMaps[aPrefBranchName] = attrMap;</span>
<a href="#l11.221"></a><span id="l11.221"> </span>
<a href="#l11.222"></a><span id="l11.222">     // and return</span>
<a href="#l11.223"></a><span id="l11.223">     return attrMap;</span>
<a href="#l11.224"></a><span id="l11.224">   },</span>
<a href="#l11.225"></a><span id="l11.225"> </span>
<a href="#l11.226"></a><span id="l11.226" class="difflineminus">-  QueryInterface: ChromeUtils.generateQI([Ci.nsIAbLDAPAttributeMapService])</span>
<a href="#l11.227"></a><span id="l11.227" class="difflineminus">-}</span>
<a href="#l11.228"></a><span id="l11.228" class="difflineplus">+  QueryInterface: ChromeUtils.generateQI([Ci.nsIAbLDAPAttributeMapService]),</span>
<a href="#l11.229"></a><span id="l11.229" class="difflineplus">+};</span>
<a href="#l11.230"></a><span id="l11.230"> </span>
<a href="#l11.231"></a><span id="l11.231"> var NSGetFactory = XPCOMUtils.generateNSGetFactory([nsAbLDAPAttributeMap, nsAbLDAPAttributeMapService]);</span>
<a href="#l11.232"></a><span id="l11.232"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPAutoCompleteSearch.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPAutoCompleteSearch.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -33,54 +33,54 @@ nsAbLDAPAutoCompleteResult.prototype = {</span>
<a href="#l12.4"></a><span id="l12.4">   searchResult: ACR.RESULT_NOMATCH,</span>
<a href="#l12.5"></a><span id="l12.5">   defaultIndex: -1,</span>
<a href="#l12.6"></a><span id="l12.6">   errorDescription: null,</span>
<a href="#l12.7"></a><span id="l12.7"> </span>
<a href="#l12.8"></a><span id="l12.8">   get matchCount() {</span>
<a href="#l12.9"></a><span id="l12.9">     return this._searchResults.length;</span>
<a href="#l12.10"></a><span id="l12.10">   },</span>
<a href="#l12.11"></a><span id="l12.11"> </span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-  getLabelAt: function getLabelAt(aIndex) {</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+  getLabelAt(aIndex) {</span>
<a href="#l12.14"></a><span id="l12.14">     return this.getValueAt(aIndex);</span>
<a href="#l12.15"></a><span id="l12.15">   },</span>
<a href="#l12.16"></a><span id="l12.16"> </span>
<a href="#l12.17"></a><span id="l12.17" class="difflineminus">-  getValueAt: function getValueAt(aIndex) {</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineplus">+  getValueAt(aIndex) {</span>
<a href="#l12.19"></a><span id="l12.19">     return this._searchResults[aIndex].value;</span>
<a href="#l12.20"></a><span id="l12.20">   },</span>
<a href="#l12.21"></a><span id="l12.21"> </span>
<a href="#l12.22"></a><span id="l12.22" class="difflineminus">-  getCommentAt: function getCommentAt(aIndex) {</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineplus">+  getCommentAt(aIndex) {</span>
<a href="#l12.24"></a><span id="l12.24">     return this._commentColumn;</span>
<a href="#l12.25"></a><span id="l12.25">   },</span>
<a href="#l12.26"></a><span id="l12.26"> </span>
<a href="#l12.27"></a><span id="l12.27" class="difflineminus">-  getStyleAt: function getStyleAt(aIndex) {</span>
<a href="#l12.28"></a><span id="l12.28" class="difflineplus">+  getStyleAt(aIndex) {</span>
<a href="#l12.29"></a><span id="l12.29">     return this.searchResult == ACR.RESULT_FAILURE ? &quot;remote-err&quot; :</span>
<a href="#l12.30"></a><span id="l12.30">                                                      &quot;remote-abook&quot;;</span>
<a href="#l12.31"></a><span id="l12.31">   },</span>
<a href="#l12.32"></a><span id="l12.32"> </span>
<a href="#l12.33"></a><span id="l12.33" class="difflineminus">-  getImageAt: function getImageAt(aIndex) {</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineplus">+  getImageAt(aIndex) {</span>
<a href="#l12.35"></a><span id="l12.35">     return &quot;&quot;;</span>
<a href="#l12.36"></a><span id="l12.36">   },</span>
<a href="#l12.37"></a><span id="l12.37"> </span>
<a href="#l12.38"></a><span id="l12.38" class="difflineminus">-  getFinalCompleteValueAt: function(aIndex) {</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineplus">+  getFinalCompleteValueAt(aIndex) {</span>
<a href="#l12.40"></a><span id="l12.40">     return this.getValueAt(aIndex);</span>
<a href="#l12.41"></a><span id="l12.41">   },</span>
<a href="#l12.42"></a><span id="l12.42"> </span>
<a href="#l12.43"></a><span id="l12.43" class="difflineminus">-  removeValueAt: function removeValueAt(aRowIndex, aRemoveFromDB) {</span>
<a href="#l12.44"></a><span id="l12.44" class="difflineplus">+  removeValueAt(aRowIndex, aRemoveFromDB) {</span>
<a href="#l12.45"></a><span id="l12.45">   },</span>
<a href="#l12.46"></a><span id="l12.46"> </span>
<a href="#l12.47"></a><span id="l12.47">   // nsIAbAutoCompleteResult</span>
<a href="#l12.48"></a><span id="l12.48"> </span>
<a href="#l12.49"></a><span id="l12.49" class="difflineminus">-  getCardAt: function getCardAt(aIndex) {</span>
<a href="#l12.50"></a><span id="l12.50" class="difflineplus">+  getCardAt(aIndex) {</span>
<a href="#l12.51"></a><span id="l12.51">     return this._searchResults[aIndex].card;</span>
<a href="#l12.52"></a><span id="l12.52">   },</span>
<a href="#l12.53"></a><span id="l12.53"> </span>
<a href="#l12.54"></a><span id="l12.54">   // nsISupports</span>
<a href="#l12.55"></a><span id="l12.55"> </span>
<a href="#l12.56"></a><span id="l12.56" class="difflineminus">-  QueryInterface: ChromeUtils.generateQI([ACR, nsIAbAutoCompleteResult])</span>
<a href="#l12.57"></a><span id="l12.57" class="difflineminus">-}</span>
<a href="#l12.58"></a><span id="l12.58" class="difflineplus">+  QueryInterface: ChromeUtils.generateQI([ACR, nsIAbAutoCompleteResult]),</span>
<a href="#l12.59"></a><span id="l12.59" class="difflineplus">+};</span>
<a href="#l12.60"></a><span id="l12.60"> </span>
<a href="#l12.61"></a><span id="l12.61"> function nsAbLDAPAutoCompleteSearch() {</span>
<a href="#l12.62"></a><span id="l12.62">   Services.obs.addObserver(this, &quot;quit-application&quot;);</span>
<a href="#l12.63"></a><span id="l12.63">   this._timer = Cc[&quot;@mozilla.org/timer;1&quot;]</span>
<a href="#l12.64"></a><span id="l12.64">                   .createInstance(Ci.nsITimer);</span>
<a href="#l12.65"></a><span id="l12.65"> }</span>
<a href="#l12.66"></a><span id="l12.66"> </span>
<a href="#l12.67"></a><span id="l12.67"> nsAbLDAPAutoCompleteSearch.prototype = {</span>
<a href="#l12.68"></a><span id="l12.68" class="difflineat">@@ -104,25 +104,25 @@ nsAbLDAPAutoCompleteSearch.prototype = {</span>
<a href="#l12.69"></a><span id="l12.69">   _listener: null,</span>
<a href="#l12.70"></a><span id="l12.70"> </span>
<a href="#l12.71"></a><span id="l12.71">   _parser: MailServices.headerParser,</span>
<a href="#l12.72"></a><span id="l12.72"> </span>
<a href="#l12.73"></a><span id="l12.73">   applicableHeaders: new Set([&quot;addr_to&quot;, &quot;addr_cc&quot;, &quot;addr_bcc&quot;, &quot;addr_reply&quot;]),</span>
<a href="#l12.74"></a><span id="l12.74"> </span>
<a href="#l12.75"></a><span id="l12.75">   // Private methods</span>
<a href="#l12.76"></a><span id="l12.76"> </span>
<a href="#l12.77"></a><span id="l12.77" class="difflineminus">-  _checkDuplicate: function _checkDuplicate(card, emailAddress) {</span>
<a href="#l12.78"></a><span id="l12.78" class="difflineplus">+  _checkDuplicate(card, emailAddress) {</span>
<a href="#l12.79"></a><span id="l12.79">     var lcEmailAddress = emailAddress.toLocaleLowerCase();</span>
<a href="#l12.80"></a><span id="l12.80"> </span>
<a href="#l12.81"></a><span id="l12.81">     return this._result._searchResults.some(function(result) {</span>
<a href="#l12.82"></a><span id="l12.82">       return result.value.toLocaleLowerCase() == lcEmailAddress;</span>
<a href="#l12.83"></a><span id="l12.83">     });</span>
<a href="#l12.84"></a><span id="l12.84">   },</span>
<a href="#l12.85"></a><span id="l12.85"> </span>
<a href="#l12.86"></a><span id="l12.86" class="difflineminus">-  _addToResult: function(card) {</span>
<a href="#l12.87"></a><span id="l12.87" class="difflineplus">+  _addToResult(card) {</span>
<a href="#l12.88"></a><span id="l12.88">     let mbox = this._parser.makeMailboxObject(card.displayName,</span>
<a href="#l12.89"></a><span id="l12.89">       card.isMailList ? card.getProperty(&quot;Notes&quot;, &quot;&quot;) || card.displayName :</span>
<a href="#l12.90"></a><span id="l12.90">                         card.primaryEmail);</span>
<a href="#l12.91"></a><span id="l12.91">     if (!mbox.email)</span>
<a href="#l12.92"></a><span id="l12.92">       return;</span>
<a href="#l12.93"></a><span id="l12.93"> </span>
<a href="#l12.94"></a><span id="l12.94">     let emailAddress = mbox.toString();</span>
<a href="#l12.95"></a><span id="l12.95"> </span>
<a href="#l12.96"></a><span id="l12.96" class="difflineat">@@ -136,23 +136,23 @@ nsAbLDAPAutoCompleteSearch.prototype = {</span>
<a href="#l12.97"></a><span id="l12.97"> </span>
<a href="#l12.98"></a><span id="l12.98">     // Next sort on full address</span>
<a href="#l12.99"></a><span id="l12.99">     while (insertPosition &lt; this._result._searchResults.length &amp;&amp;</span>
<a href="#l12.100"></a><span id="l12.100">            emailAddress &gt; this._result._searchResults[insertPosition].value)</span>
<a href="#l12.101"></a><span id="l12.101">       ++insertPosition;</span>
<a href="#l12.102"></a><span id="l12.102"> </span>
<a href="#l12.103"></a><span id="l12.103">     this._result._searchResults.splice(insertPosition, 0, {</span>
<a href="#l12.104"></a><span id="l12.104">       value: emailAddress,</span>
<a href="#l12.105"></a><span id="l12.105" class="difflineminus">-      card: card,</span>
<a href="#l12.106"></a><span id="l12.106" class="difflineplus">+      card,</span>
<a href="#l12.107"></a><span id="l12.107">     });</span>
<a href="#l12.108"></a><span id="l12.108">   },</span>
<a href="#l12.109"></a><span id="l12.109"> </span>
<a href="#l12.110"></a><span id="l12.110">   // nsIObserver</span>
<a href="#l12.111"></a><span id="l12.111"> </span>
<a href="#l12.112"></a><span id="l12.112" class="difflineminus">-  observe: function observer(subject, topic, data) {</span>
<a href="#l12.113"></a><span id="l12.113" class="difflineplus">+  observe(subject, topic, data) {</span>
<a href="#l12.114"></a><span id="l12.114">     if (topic == &quot;quit-application&quot;) {</span>
<a href="#l12.115"></a><span id="l12.115">       Services.obs.removeObserver(this, &quot;quit-application&quot;);</span>
<a href="#l12.116"></a><span id="l12.116">     } else if (topic != &quot;timer-callback&quot;) {</span>
<a href="#l12.117"></a><span id="l12.117">       return;</span>
<a href="#l12.118"></a><span id="l12.118">     }</span>
<a href="#l12.119"></a><span id="l12.119"> </span>
<a href="#l12.120"></a><span id="l12.120">     // Force the individual query items to null, so that the memory</span>
<a href="#l12.121"></a><span id="l12.121">     // gets collected straight away.</span>
<a href="#l12.122"></a><span id="l12.122" class="difflineat">@@ -160,18 +160,17 @@ nsAbLDAPAutoCompleteSearch.prototype = {</span>
<a href="#l12.123"></a><span id="l12.123">     this._book = null;</span>
<a href="#l12.124"></a><span id="l12.124">     this._context = -1;</span>
<a href="#l12.125"></a><span id="l12.125">     this._query = null;</span>
<a href="#l12.126"></a><span id="l12.126">     this._attributes = null;</span>
<a href="#l12.127"></a><span id="l12.127">   },</span>
<a href="#l12.128"></a><span id="l12.128"> </span>
<a href="#l12.129"></a><span id="l12.129">   // nsIAutoCompleteSearch</span>
<a href="#l12.130"></a><span id="l12.130"> </span>
<a href="#l12.131"></a><span id="l12.131" class="difflineminus">-  startSearch: function startSearch(aSearchString, aParam,</span>
<a href="#l12.132"></a><span id="l12.132" class="difflineminus">-                                    aPreviousResult, aListener) {</span>
<a href="#l12.133"></a><span id="l12.133" class="difflineplus">+  startSearch(aSearchString, aParam, aPreviousResult, aListener) {</span>
<a href="#l12.134"></a><span id="l12.134">     let params = JSON.parse(aParam) || {};</span>
<a href="#l12.135"></a><span id="l12.135">     let applicable = !(&quot;type&quot; in params) || this.applicableHeaders.has(params.type);</span>
<a href="#l12.136"></a><span id="l12.136"> </span>
<a href="#l12.137"></a><span id="l12.137">     this._result = new nsAbLDAPAutoCompleteResult(aSearchString);</span>
<a href="#l12.138"></a><span id="l12.138">     aSearchString = aSearchString.toLocaleLowerCase();</span>
<a href="#l12.139"></a><span id="l12.139"> </span>
<a href="#l12.140"></a><span id="l12.140">     // If the search string isn't value, or contains a comma, or the user</span>
<a href="#l12.141"></a><span id="l12.141">     // hasn't enabled autocomplete, then just return no matches / or the</span>
<a href="#l12.142"></a><span id="l12.142" class="difflineat">@@ -187,30 +186,28 @@ nsAbLDAPAutoCompleteSearch.prototype = {</span>
<a href="#l12.143"></a><span id="l12.143">     // The rules here: If the current identity has a directoryServer set, then</span>
<a href="#l12.144"></a><span id="l12.144">     // use that, otherwise, try the global preference instead.</span>
<a href="#l12.145"></a><span id="l12.145">     var acDirURI = null;</span>
<a href="#l12.146"></a><span id="l12.146">     var identity;</span>
<a href="#l12.147"></a><span id="l12.147"> </span>
<a href="#l12.148"></a><span id="l12.148">     if (&quot;idKey&quot; in params) {</span>
<a href="#l12.149"></a><span id="l12.149">       try {</span>
<a href="#l12.150"></a><span id="l12.150">         identity = MailServices.accounts.getIdentity(params.idKey);</span>
<a href="#l12.151"></a><span id="l12.151" class="difflineminus">-      }</span>
<a href="#l12.152"></a><span id="l12.152" class="difflineminus">-      catch(ex) {</span>
<a href="#l12.153"></a><span id="l12.153" class="difflineplus">+      } catch (ex) {</span>
<a href="#l12.154"></a><span id="l12.154">         Cu.reportError(&quot;Couldn't get specified identity, &quot; +</span>
<a href="#l12.155"></a><span id="l12.155">                        &quot;falling back to global settings&quot;);</span>
<a href="#l12.156"></a><span id="l12.156">       }</span>
<a href="#l12.157"></a><span id="l12.157">     }</span>
<a href="#l12.158"></a><span id="l12.158"> </span>
<a href="#l12.159"></a><span id="l12.159">     // Does the current identity override the global preference?</span>
<a href="#l12.160"></a><span id="l12.160" class="difflineminus">-    if (identity &amp;&amp; identity.overrideGlobalPref)</span>
<a href="#l12.161"></a><span id="l12.161" class="difflineplus">+    if (identity &amp;&amp; identity.overrideGlobalPref) {</span>
<a href="#l12.162"></a><span id="l12.162">       acDirURI = identity.directoryServer;</span>
<a href="#l12.163"></a><span id="l12.163" class="difflineminus">-    else {</span>
<a href="#l12.164"></a><span id="l12.164" class="difflineplus">+    } else if (Services.prefs.getBoolPref(&quot;ldap_2.autoComplete.useDirectory&quot;)) {</span>
<a href="#l12.165"></a><span id="l12.165">       // Try the global one</span>
<a href="#l12.166"></a><span id="l12.166" class="difflineminus">-      if (Services.prefs.getBoolPref(&quot;ldap_2.autoComplete.useDirectory&quot;))</span>
<a href="#l12.167"></a><span id="l12.167" class="difflineminus">-        acDirURI = Services.prefs.getCharPref(&quot;ldap_2.autoComplete.directoryServer&quot;);</span>
<a href="#l12.168"></a><span id="l12.168" class="difflineplus">+      acDirURI = Services.prefs.getCharPref(&quot;ldap_2.autoComplete.directoryServer&quot;);</span>
<a href="#l12.169"></a><span id="l12.169">     }</span>
<a href="#l12.170"></a><span id="l12.170"> </span>
<a href="#l12.171"></a><span id="l12.171">     if (!acDirURI || Services.io.offline) {</span>
<a href="#l12.172"></a><span id="l12.172">       // No directory to search or we are offline, send a no match and return.</span>
<a href="#l12.173"></a><span id="l12.173">       aListener.onSearchResult(this, this._result);</span>
<a href="#l12.174"></a><span id="l12.174">       return;</span>
<a href="#l12.175"></a><span id="l12.175">     }</span>
<a href="#l12.176"></a><span id="l12.176"> </span>
<a href="#l12.177"></a><span id="l12.177" class="difflineat">@@ -259,48 +256,47 @@ nsAbLDAPAutoCompleteSearch.prototype = {</span>
<a href="#l12.178"></a><span id="l12.178">     args.querySubDirectories = true;</span>
<a href="#l12.179"></a><span id="l12.179">     args.filter = filter;</span>
<a href="#l12.180"></a><span id="l12.180"> </span>
<a href="#l12.181"></a><span id="l12.181">     // Start the actual search</span>
<a href="#l12.182"></a><span id="l12.182">     this._context =</span>
<a href="#l12.183"></a><span id="l12.183">       this._query.doQuery(this._book, args, this, this._book.maxHits, 0);</span>
<a href="#l12.184"></a><span id="l12.184">   },</span>
<a href="#l12.185"></a><span id="l12.185"> </span>
<a href="#l12.186"></a><span id="l12.186" class="difflineminus">-  stopSearch: function stopSearch() {</span>
<a href="#l12.187"></a><span id="l12.187" class="difflineplus">+  stopSearch() {</span>
<a href="#l12.188"></a><span id="l12.188">     if (this._listener) {</span>
<a href="#l12.189"></a><span id="l12.189">       this._query.stopQuery(this._context);</span>
<a href="#l12.190"></a><span id="l12.190">       this._listener = null;</span>
<a href="#l12.191"></a><span id="l12.191">     }</span>
<a href="#l12.192"></a><span id="l12.192">   },</span>
<a href="#l12.193"></a><span id="l12.193"> </span>
<a href="#l12.194"></a><span id="l12.194">   // nsIAbDirSearchListener</span>
<a href="#l12.195"></a><span id="l12.195"> </span>
<a href="#l12.196"></a><span id="l12.196" class="difflineminus">-  onSearchFinished: function onSearchFinished(aResult, aErrorMsg) {</span>
<a href="#l12.197"></a><span id="l12.197" class="difflineplus">+  onSearchFinished(aResult, aErrorMsg) {</span>
<a href="#l12.198"></a><span id="l12.198">     if (!this._listener)</span>
<a href="#l12.199"></a><span id="l12.199">       return;</span>
<a href="#l12.200"></a><span id="l12.200"> </span>
<a href="#l12.201"></a><span id="l12.201">     if (aResult == nsIAbDirectoryQueryResultListener.queryResultComplete) {</span>
<a href="#l12.202"></a><span id="l12.202">       if (this._result.matchCount) {</span>
<a href="#l12.203"></a><span id="l12.203">         this._result.searchResult = ACR.RESULT_SUCCESS;</span>
<a href="#l12.204"></a><span id="l12.204">         this._result.defaultIndex = 0;</span>
<a href="#l12.205"></a><span id="l12.205" class="difflineminus">-      }</span>
<a href="#l12.206"></a><span id="l12.206" class="difflineminus">-      else</span>
<a href="#l12.207"></a><span id="l12.207" class="difflineplus">+      } else {</span>
<a href="#l12.208"></a><span id="l12.208">         this._result.searchResult = ACR.RESULT_NOMATCH;</span>
<a href="#l12.209"></a><span id="l12.209" class="difflineminus">-    }</span>
<a href="#l12.210"></a><span id="l12.210" class="difflineminus">-    else if (aResult == nsIAbDirectoryQueryResultListener.queryResultError) {</span>
<a href="#l12.211"></a><span id="l12.211" class="difflineplus">+      }</span>
<a href="#l12.212"></a><span id="l12.212" class="difflineplus">+    } else if (aResult == nsIAbDirectoryQueryResultListener.queryResultError) {</span>
<a href="#l12.213"></a><span id="l12.213">       this._result.searchResult = ACR.RESULT_FAILURE;</span>
<a href="#l12.214"></a><span id="l12.214">       this._result.defaultIndex = 0;</span>
<a href="#l12.215"></a><span id="l12.215">     }</span>
<a href="#l12.216"></a><span id="l12.216">     //    const long queryResultStopped  = 2;</span>
<a href="#l12.217"></a><span id="l12.217">     //    const long queryResultError    = 3;</span>
<a href="#l12.218"></a><span id="l12.218">     this._listener.onSearchResult(this, this._result);</span>
<a href="#l12.219"></a><span id="l12.219">     this._listener = null;</span>
<a href="#l12.220"></a><span id="l12.220">   },</span>
<a href="#l12.221"></a><span id="l12.221"> </span>
<a href="#l12.222"></a><span id="l12.222" class="difflineminus">-  onSearchFoundCard: function onSearchFoundCard(aCard) {</span>
<a href="#l12.223"></a><span id="l12.223" class="difflineplus">+  onSearchFoundCard(aCard) {</span>
<a href="#l12.224"></a><span id="l12.224">     if (!this._listener)</span>
<a href="#l12.225"></a><span id="l12.225">       return;</span>
<a href="#l12.226"></a><span id="l12.226"> </span>
<a href="#l12.227"></a><span id="l12.227">     this._addToResult(aCard);</span>
<a href="#l12.228"></a><span id="l12.228"> </span>
<a href="#l12.229"></a><span id="l12.229">     /* XXX autocomplete doesn't expect you to rearrange while searching</span>
<a href="#l12.230"></a><span id="l12.230">     if (this._result.matchCount)</span>
<a href="#l12.231"></a><span id="l12.231">       this._result.searchResult = ACR.RESULT_SUCCESS_ONGOING;</span>
<a href="#l12.232"></a><span id="l12.232" class="difflineat">@@ -310,14 +306,14 @@ nsAbLDAPAutoCompleteSearch.prototype = {</span>
<a href="#l12.233"></a><span id="l12.233">     this._listener.onSearchResult(this, this._result);</span>
<a href="#l12.234"></a><span id="l12.234">     */</span>
<a href="#l12.235"></a><span id="l12.235">   },</span>
<a href="#l12.236"></a><span id="l12.236"> </span>
<a href="#l12.237"></a><span id="l12.237">   // nsISupports</span>
<a href="#l12.238"></a><span id="l12.238"> </span>
<a href="#l12.239"></a><span id="l12.239">   QueryInterface: ChromeUtils.generateQI([Ci.nsIObserver,</span>
<a href="#l12.240"></a><span id="l12.240">                                           Ci.nsIAutoCompleteSearch,</span>
<a href="#l12.241"></a><span id="l12.241" class="difflineminus">-                                          Ci.nsIAbDirSearchListener])</span>
<a href="#l12.242"></a><span id="l12.242" class="difflineplus">+                                          Ci.nsIAbDirSearchListener]),</span>
<a href="#l12.243"></a><span id="l12.243"> };</span>
<a href="#l12.244"></a><span id="l12.244"> </span>
<a href="#l12.245"></a><span id="l12.245"> // Module</span>
<a href="#l12.246"></a><span id="l12.246"> </span>
<a href="#l12.247"></a><span id="l12.247"> var NSGetFactory = XPCOMUtils.generateNSGetFactory([nsAbLDAPAutoCompleteSearch]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1">new file mode 100644</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineminus">--- /dev/null</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineplus">+++ b/mailnews/addrbook/test/unit/.eslintrc.js</span>
<a href="#l13.4"></a><span id="l13.4" class="difflineat">@@ -0,0 +1,14 @@</span>
<a href="#l13.5"></a><span id="l13.5" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l13.6"></a><span id="l13.6" class="difflineplus">+</span>
<a href="#l13.7"></a><span id="l13.7" class="difflineplus">+module.exports = {</span>
<a href="#l13.8"></a><span id="l13.8" class="difflineplus">+  &quot;extends&quot;: &quot;plugin:mozilla/xpcshell-test&quot;,</span>
<a href="#l13.9"></a><span id="l13.9" class="difflineplus">+</span>
<a href="#l13.10"></a><span id="l13.10" class="difflineplus">+  &quot;rules&quot;: {</span>
<a href="#l13.11"></a><span id="l13.11" class="difflineplus">+    &quot;func-names&quot;: &quot;off&quot;,</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+    &quot;mozilla/import-headjs-globals&quot;: &quot;error&quot;,</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+    &quot;no-unused-vars&quot;: [&quot;error&quot;, {</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+      &quot;args&quot;: &quot;none&quot;,</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+      &quot;vars&quot;: &quot;all&quot;,</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineplus">+    }],</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineplus">+  },</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/data/bug534822prefs.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/data/bug534822prefs.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -1,3 +1,4 @@</span>
<a href="#l14.4"></a><span id="l14.4" class="difflineplus">+/* globals pref */</span>
<a href="#l14.5"></a><span id="l14.5"> pref(&quot;ldap_2.servers.extension.description&quot;, &quot;extension&quot;);</span>
<a href="#l14.6"></a><span id="l14.6"> pref(&quot;ldap_2.servers.extension.filename&quot;, &quot;ldap1.mab&quot;);</span>
<a href="#l14.7"></a><span id="l14.7"> pref(&quot;ldap_2.servers.extension.uri&quot;, &quot;ldap://test.invalid:389/o=invalid??sub&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/head_addrbook.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/head_addrbook.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -3,13 +3,14 @@ ChromeUtils.import(&quot;resource:///modules/</span>
<a href="#l15.4"></a><span id="l15.4"> ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l15.5"></a><span id="l15.5"> </span>
<a href="#l15.6"></a><span id="l15.6"> var CC = Components.Constructor;</span>
<a href="#l15.7"></a><span id="l15.7"> </span>
<a href="#l15.8"></a><span id="l15.8"> // Ensure the profile directory is set up</span>
<a href="#l15.9"></a><span id="l15.9"> do_get_profile();</span>
<a href="#l15.10"></a><span id="l15.10"> </span>
<a href="#l15.11"></a><span id="l15.11"> // Import the required setup scripts.</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineplus">+/* import-globals-from ../../../test/resources/abSetup.js */</span>
<a href="#l15.13"></a><span id="l15.13"> load(&quot;../../../resources/abSetup.js&quot;);</span>
<a href="#l15.14"></a><span id="l15.14"> </span>
<a href="#l15.15"></a><span id="l15.15"> registerCleanupFunction(function() {</span>
<a href="#l15.16"></a><span id="l15.16">   load(&quot;../../../resources/mailShutdown.js&quot;);</span>
<a href="#l15.17"></a><span id="l15.17"> });</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_basic_nsIAbDirectory.js</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_basic_nsIAbDirectory.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -102,9 +102,9 @@ function check_ab(abConfig) {</span>
<a href="#l16.4"></a><span id="l16.4"> }</span>
<a href="#l16.5"></a><span id="l16.5"> </span>
<a href="#l16.6"></a><span id="l16.6"> function run_test() {</span>
<a href="#l16.7"></a><span id="l16.7">   // Check the default personal address book</span>
<a href="#l16.8"></a><span id="l16.8">   check_ab(kPABData);</span>
<a href="#l16.9"></a><span id="l16.9"> </span>
<a href="#l16.10"></a><span id="l16.10">   // Check the default collected address book</span>
<a href="#l16.11"></a><span id="l16.11">   check_ab(kCABData);</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-};</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_bug534822.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_bug534822.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -14,29 +14,27 @@ function run_test() {</span>
<a href="#l17.4"></a><span id="l17.4">   specialPrefs = profileDir;</span>
<a href="#l17.5"></a><span id="l17.5">   specialPrefs.append(&quot;bug534822prefs.js&quot;);</span>
<a href="#l17.6"></a><span id="l17.6"> </span>
<a href="#l17.7"></a><span id="l17.7">   Services.prefs.readUserPrefsFromFile(specialPrefs);</span>
<a href="#l17.8"></a><span id="l17.8"> </span>
<a href="#l17.9"></a><span id="l17.9">   // Now load the ABs and check we've got all of them.</span>
<a href="#l17.10"></a><span id="l17.10">   let dirs = MailServices.ab.directories;</span>
<a href="#l17.11"></a><span id="l17.11"> </span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-  let dir;</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineminus">-</span>
<a href="#l17.14"></a><span id="l17.14">   let results = [</span>
<a href="#l17.15"></a><span id="l17.15">     { name: &quot;extension&quot;, result: false },</span>
<a href="#l17.16"></a><span id="l17.16">     { name: kPABData.dirName, result: false },</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineminus">-    { name: kCABData.dirName, result: false }</span>
<a href="#l17.18"></a><span id="l17.18" class="difflineplus">+    { name: kCABData.dirName, result: false },</span>
<a href="#l17.19"></a><span id="l17.19">   ];</span>
<a href="#l17.20"></a><span id="l17.20"> </span>
<a href="#l17.21"></a><span id="l17.21">   while (dirs.hasMoreElements()) {</span>
<a href="#l17.22"></a><span id="l17.22">     let dir = dirs.getNext().QueryInterface(Ci.nsIAbDirectory);</span>
<a href="#l17.23"></a><span id="l17.23"> </span>
<a href="#l17.24"></a><span id="l17.24">     for (let i = 0; i &lt; results.length; ++i) {</span>
<a href="#l17.25"></a><span id="l17.25">       if (results[i].name == dir.dirName) {</span>
<a href="#l17.26"></a><span id="l17.26">         Assert.ok(!results[i].result);</span>
<a href="#l17.27"></a><span id="l17.27">         results[i].result = true;</span>
<a href="#l17.28"></a><span id="l17.28">       }</span>
<a href="#l17.29"></a><span id="l17.29">     }</span>
<a href="#l17.30"></a><span id="l17.30">   }</span>
<a href="#l17.31"></a><span id="l17.31"> </span>
<a href="#l17.32"></a><span id="l17.32" class="difflineminus">-  results.forEach(function (result) { Assert.ok(result.result); });</span>
<a href="#l17.33"></a><span id="l17.33" class="difflineminus">-};</span>
<a href="#l17.34"></a><span id="l17.34" class="difflineplus">+  results.forEach(function(result) { Assert.ok(result.result); });</span>
<a href="#l17.35"></a><span id="l17.35" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_bug_448165.js</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_bug_448165.js</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -4,14 +4,13 @@</span>
<a href="#l18.4"></a><span id="l18.4">  */</span>
<a href="#l18.5"></a><span id="l18.5"> function run_test() {</span>
<a href="#l18.6"></a><span id="l18.6">   // get the Personal Address Book</span>
<a href="#l18.7"></a><span id="l18.7">   let pab = MailServices.ab.getDirectory(kPABData.URI);</span>
<a href="#l18.8"></a><span id="l18.8">   Assert.ok(pab instanceof Ci.nsIAbDirectory);</span>
<a href="#l18.9"></a><span id="l18.9">   try {</span>
<a href="#l18.10"></a><span id="l18.10">     pab.deleteCards(null); // this should throw an error</span>
<a href="#l18.11"></a><span id="l18.11">     do_throw(&quot;Error, deleteCards should throw an error when null is passed to it&quot;);</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-  }</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineminus">-  catch (e) {</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineplus">+  } catch (e) {</span>
<a href="#l18.15"></a><span id="l18.15">     // make sure the correct error message was thrown</span>
<a href="#l18.16"></a><span id="l18.16">     Assert.equal(e.result, Cr.NS_ERROR_INVALID_POINTER);</span>
<a href="#l18.17"></a><span id="l18.17">   }</span>
<a href="#l18.18"></a><span id="l18.18"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_cardForEmail.js</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_cardForEmail.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -75,20 +75,20 @@ function run_test() {</span>
<a href="#l19.4"></a><span id="l19.4">   card = AB.getCardFromProperty(&quot;JobTitle&quot;, &quot;jobtitle1&quot;, false);</span>
<a href="#l19.5"></a><span id="l19.5">   check_correct_card(card);</span>
<a href="#l19.6"></a><span id="l19.6"> </span>
<a href="#l19.7"></a><span id="l19.7">   var cards = AB.getCardsFromProperty(&quot;LastName&quot;, &quot;DOE&quot;, true);</span>
<a href="#l19.8"></a><span id="l19.8">   Assert.ok(!cards.hasMoreElements());</span>
<a href="#l19.9"></a><span id="l19.9"> </span>
<a href="#l19.10"></a><span id="l19.10">   cards = AB.getCardsFromProperty(&quot;LastName&quot;, &quot;Doe&quot;, true);</span>
<a href="#l19.11"></a><span id="l19.11">   var i = 0;</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-  var data = [ 'John', 'Jane' ];</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+  var data = [ &quot;John&quot;, &quot;Jane&quot; ];</span>
<a href="#l19.14"></a><span id="l19.14"> </span>
<a href="#l19.15"></a><span id="l19.15">   while (cards.hasMoreElements()) {</span>
<a href="#l19.16"></a><span id="l19.16">     i++;</span>
<a href="#l19.17"></a><span id="l19.17">     card = cards.getNext().QueryInterface(Ci.nsIAbCard);</span>
<a href="#l19.18"></a><span id="l19.18" class="difflineminus">-    Assert.equal(card.lastName, 'Doe');</span>
<a href="#l19.19"></a><span id="l19.19" class="difflineplus">+    Assert.equal(card.lastName, &quot;Doe&quot;);</span>
<a href="#l19.20"></a><span id="l19.20">     var index = data.indexOf(card.firstName);</span>
<a href="#l19.21"></a><span id="l19.21">     Assert.notEqual(index, -1);</span>
<a href="#l19.22"></a><span id="l19.22">     delete data[index];</span>
<a href="#l19.23"></a><span id="l19.23">   }</span>
<a href="#l19.24"></a><span id="l19.24">   Assert.equal(i, 2);</span>
<a href="#l19.25"></a><span id="l19.25" class="difflineminus">-};</span>
<a href="#l19.26"></a><span id="l19.26" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_collection.js</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_collection.js</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -182,54 +182,52 @@ var modifyEmailChecks =</span>
<a href="#l20.4"></a><span id="l20.4">       screenName: &quot;&quot; },</span>
<a href="#l20.5"></a><span id="l20.5">    ];</span>
<a href="#l20.6"></a><span id="l20.6"> </span>
<a href="#l20.7"></a><span id="l20.7"> var collectChecker = {</span>
<a href="#l20.8"></a><span id="l20.8">   addressCollect: null,</span>
<a href="#l20.9"></a><span id="l20.9">   AB: null,</span>
<a href="#l20.10"></a><span id="l20.10">   part: 0,</span>
<a href="#l20.11"></a><span id="l20.11"> </span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-  checkAddress : function (aDetails) {</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineplus">+  checkAddress(aDetails) {</span>
<a href="#l20.14"></a><span id="l20.14">     try {</span>
<a href="#l20.15"></a><span id="l20.15">       this.addressCollect.collectAddress(aDetails.emailHeader, true,</span>
<a href="#l20.16"></a><span id="l20.16">                                          aDetails.mailFormat);</span>
<a href="#l20.17"></a><span id="l20.17"> </span>
<a href="#l20.18"></a><span id="l20.18">       this.checkCardResult(aDetails, false);</span>
<a href="#l20.19"></a><span id="l20.19" class="difflineminus">-    }</span>
<a href="#l20.20"></a><span id="l20.20" class="difflineminus">-    catch (e) {</span>
<a href="#l20.21"></a><span id="l20.21" class="difflineplus">+    } catch (e) {</span>
<a href="#l20.22"></a><span id="l20.22">       throw &quot;FAILED in checkAddress emailHeader: &quot; + aDetails.emailHeader +</span>
<a href="#l20.23"></a><span id="l20.23">       &quot; part: &quot; + this.part + &quot; : &quot; + e;</span>
<a href="#l20.24"></a><span id="l20.24">     }</span>
<a href="#l20.25"></a><span id="l20.25">     ++this.part;</span>
<a href="#l20.26"></a><span id="l20.26">   },</span>
<a href="#l20.27"></a><span id="l20.27"> </span>
<a href="#l20.28"></a><span id="l20.28" class="difflineminus">-  checkAll : function (aDetailsArray) {</span>
<a href="#l20.29"></a><span id="l20.29" class="difflineplus">+  checkAll(aDetailsArray) {</span>
<a href="#l20.30"></a><span id="l20.30">     try {</span>
<a href="#l20.31"></a><span id="l20.31">       // Formulate the string to add.</span>
<a href="#l20.32"></a><span id="l20.32">       var emailHeader = &quot;&quot;;</span>
<a href="#l20.33"></a><span id="l20.33">       var i;</span>
<a href="#l20.34"></a><span id="l20.34"> </span>
<a href="#l20.35"></a><span id="l20.35">       for (i = 0; i &lt; aDetailsArray.length - 1; ++i)</span>
<a href="#l20.36"></a><span id="l20.36">         emailHeader += aDetailsArray[i].emailHeader + &quot;, &quot;;</span>
<a href="#l20.37"></a><span id="l20.37"> </span>
<a href="#l20.38"></a><span id="l20.38">       emailHeader += aDetailsArray[aDetailsArray.length - 1].emailHeader;</span>
<a href="#l20.39"></a><span id="l20.39"> </span>
<a href="#l20.40"></a><span id="l20.40">       // Now add it. In this case we just set the Mail format Type to unknown.</span>
<a href="#l20.41"></a><span id="l20.41">       this.addressCollect.collectAddress(emailHeader, true,</span>
<a href="#l20.42"></a><span id="l20.42">                                          nsIAbPMF.unknown);</span>
<a href="#l20.43"></a><span id="l20.43"> </span>
<a href="#l20.44"></a><span id="l20.44">       for (i = 0; i &lt; aDetailsArray.length; ++i)</span>
<a href="#l20.45"></a><span id="l20.45">         this.checkCardResult(aDetailsArray[i], true);</span>
<a href="#l20.46"></a><span id="l20.46" class="difflineminus">-    }</span>
<a href="#l20.47"></a><span id="l20.47" class="difflineminus">-    catch (e) {</span>
<a href="#l20.48"></a><span id="l20.48" class="difflineplus">+    } catch (e) {</span>
<a href="#l20.49"></a><span id="l20.49">       throw &quot;FAILED in checkAll item: &quot; + i + &quot; : &quot; + e;</span>
<a href="#l20.50"></a><span id="l20.50">     }</span>
<a href="#l20.51"></a><span id="l20.51">   },</span>
<a href="#l20.52"></a><span id="l20.52"> </span>
<a href="#l20.53"></a><span id="l20.53" class="difflineminus">-  checkCardResult : function (aDetails, overrideMailFormat) {</span>
<a href="#l20.54"></a><span id="l20.54" class="difflineplus">+  checkCardResult(aDetails, overrideMailFormat) {</span>
<a href="#l20.55"></a><span id="l20.55">     try {</span>
<a href="#l20.56"></a><span id="l20.56">       var card = this.AB.cardForEmailAddress(aDetails.primaryEmail);</span>
<a href="#l20.57"></a><span id="l20.57"> </span>
<a href="#l20.58"></a><span id="l20.58">       Assert.ok(card != null);</span>
<a href="#l20.59"></a><span id="l20.59"> </span>
<a href="#l20.60"></a><span id="l20.60">       if (&quot;secondEmail&quot; in aDetails)</span>
<a href="#l20.61"></a><span id="l20.61">         Assert.equal(card.getProperty(&quot;SecondEmail&quot;, &quot;BAD&quot;), aDetails.secondEmail);</span>
<a href="#l20.62"></a><span id="l20.62"> </span>
<a href="#l20.63"></a><span id="l20.63" class="difflineat">@@ -239,25 +237,23 @@ var collectChecker = {</span>
<a href="#l20.64"></a><span id="l20.64">         Assert.equal(card.getProperty(&quot;PreferMailFormat&quot;, &quot;BAD&quot;), aDetails.mailFormatOut);</span>
<a href="#l20.65"></a><span id="l20.65">       else</span>
<a href="#l20.66"></a><span id="l20.66">         Assert.equal(card.getProperty(&quot;PreferMailFormat&quot;, &quot;BAD&quot;), aDetails.mailFormat);</span>
<a href="#l20.67"></a><span id="l20.67"> </span>
<a href="#l20.68"></a><span id="l20.68">       Assert.equal(card.displayName, aDetails.displayName);</span>
<a href="#l20.69"></a><span id="l20.69">       Assert.equal(card.firstName, aDetails.firstName);</span>
<a href="#l20.70"></a><span id="l20.70">       Assert.equal(card.lastName, aDetails.lastName);</span>
<a href="#l20.71"></a><span id="l20.71">       Assert.equal(card.getProperty(&quot;_AimScreenName&quot;, &quot;&quot;), aDetails.screenName);</span>
<a href="#l20.72"></a><span id="l20.72" class="difflineminus">-    }</span>
<a href="#l20.73"></a><span id="l20.73" class="difflineminus">-    catch (e) {</span>
<a href="#l20.74"></a><span id="l20.74" class="difflineplus">+    } catch (e) {</span>
<a href="#l20.75"></a><span id="l20.75">       throw &quot;FAILED in checkCardResult emailHeader: &quot; + aDetails.emailHeader + &quot; : &quot; + e;</span>
<a href="#l20.76"></a><span id="l20.76">     }</span>
<a href="#l20.77"></a><span id="l20.77" class="difflineminus">-  }</span>
<a href="#l20.78"></a><span id="l20.78" class="difflineplus">+  },</span>
<a href="#l20.79"></a><span id="l20.79"> };</span>
<a href="#l20.80"></a><span id="l20.80"> </span>
<a href="#l20.81"></a><span id="l20.81" class="difflineminus">-function run_test()</span>
<a href="#l20.82"></a><span id="l20.82" class="difflineminus">-{</span>
<a href="#l20.83"></a><span id="l20.83" class="difflineplus">+function run_test() {</span>
<a href="#l20.84"></a><span id="l20.84">   // Test - Get the address collecter</span>
<a href="#l20.85"></a><span id="l20.85"> </span>
<a href="#l20.86"></a><span id="l20.86">   // XXX Getting all directories ensures we create all ABs because the</span>
<a href="#l20.87"></a><span id="l20.87">   // address collecter can't currently create ABs itself (bug 314448).</span>
<a href="#l20.88"></a><span id="l20.88">   MailServices.ab.directories;</span>
<a href="#l20.89"></a><span id="l20.89"> </span>
<a href="#l20.90"></a><span id="l20.90">   // Get the actual AB for the collector so we can check cards have been</span>
<a href="#l20.91"></a><span id="l20.91">   // added.</span>
<a href="#l20.92"></a><span id="l20.92" class="difflineat">@@ -359,24 +355,24 @@ function run_test()</span>
<a href="#l20.93"></a><span id="l20.93">                                                      true,</span>
<a href="#l20.94"></a><span id="l20.94">                                                      nsIAbPMF.unknown,</span>
<a href="#l20.95"></a><span id="l20.95">                                                      true);</span>
<a href="#l20.96"></a><span id="l20.96"> </span>
<a href="#l20.97"></a><span id="l20.97">   childCards = collectChecker.AB.childCards;</span>
<a href="#l20.98"></a><span id="l20.98">   var foundCards = [];</span>
<a href="#l20.99"></a><span id="l20.99"> </span>
<a href="#l20.100"></a><span id="l20.100">   while (childCards.hasMoreElements()) {</span>
<a href="#l20.101"></a><span id="l20.101" class="difflineminus">-    var card = childCards.getNext();</span>
<a href="#l20.102"></a><span id="l20.102" class="difflineplus">+    card = childCards.getNext();</span>
<a href="#l20.103"></a><span id="l20.103">     if (card instanceof Ci.nsIAbCard &amp;&amp;</span>
<a href="#l20.104"></a><span id="l20.104">         card.primaryEmail == kSingleAddress)</span>
<a href="#l20.105"></a><span id="l20.105">       foundCards.push(card);</span>
<a href="#l20.106"></a><span id="l20.106">   }</span>
<a href="#l20.107"></a><span id="l20.107"> </span>
<a href="#l20.108"></a><span id="l20.108">   Assert.equal(foundCards.length, 2);</span>
<a href="#l20.109"></a><span id="l20.109"> </span>
<a href="#l20.110"></a><span id="l20.110">   if (foundCards[0].displayName != kSingleDisplayName &amp;&amp;</span>
<a href="#l20.111"></a><span id="l20.111">       foundCards[1].displayName != kSingleDisplayName)</span>
<a href="#l20.112"></a><span id="l20.112">     do_throw(&quot;Error, collectSingleCard didn't create a new card&quot;);</span>
<a href="#l20.113"></a><span id="l20.113"> </span>
<a href="#l20.114"></a><span id="l20.114">   if (foundCards[0].displayName != &quot;&quot; &amp;&amp;</span>
<a href="#l20.115"></a><span id="l20.115">       foundCards[1].displayName != &quot;&quot;)</span>
<a href="#l20.116"></a><span id="l20.116">     do_throw(&quot;Error, collectSingleCard created ok, but other card does not exist&quot;);</span>
<a href="#l20.117"></a><span id="l20.117" class="difflineminus">-};</span>
<a href="#l20.118"></a><span id="l20.118" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_collection_2.js</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_collection_2.js</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -3,18 +3,17 @@</span>
<a href="#l21.4"></a><span id="l21.4">  * Test suite for the Address Collector Service part 2.</span>
<a href="#l21.5"></a><span id="l21.5">  *</span>
<a href="#l21.6"></a><span id="l21.6">  * This test checks that we don't collect addresses when they already exist</span>
<a href="#l21.7"></a><span id="l21.7">  * in other address books.</span>
<a href="#l21.8"></a><span id="l21.8">  */</span>
<a href="#l21.9"></a><span id="l21.9"> </span>
<a href="#l21.10"></a><span id="l21.10"> var nsIAbPMF = Ci.nsIAbPreferMailFormat;</span>
<a href="#l21.11"></a><span id="l21.11"> </span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-function run_test()</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineminus">-{</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineplus">+function run_test() {</span>
<a href="#l21.15"></a><span id="l21.15">   // Test - Get the address collecter</span>
<a href="#l21.16"></a><span id="l21.16"> </span>
<a href="#l21.17"></a><span id="l21.17">   // Get the actual collecter</span>
<a href="#l21.18"></a><span id="l21.18">   var addressCollect =</span>
<a href="#l21.19"></a><span id="l21.19">     Cc[&quot;@mozilla.org/addressbook/services/addressCollector;1&quot;]</span>
<a href="#l21.20"></a><span id="l21.20">       .getService(Ci.nsIAbAddressCollector);</span>
<a href="#l21.21"></a><span id="l21.21"> </span>
<a href="#l21.22"></a><span id="l21.22">   // Set the new pref afterwards to ensure we change correctly</span>
<a href="#l21.23"></a><span id="l21.23" class="difflineat">@@ -43,9 +42,9 @@ function run_test()</span>
<a href="#l21.24"></a><span id="l21.24"> </span>
<a href="#l21.25"></a><span id="l21.25">   Assert.equal(card.displayName, &quot;Other Book&quot;);</span>
<a href="#l21.26"></a><span id="l21.26">   Assert.equal(card.primaryEmail, &quot;other@book.invalid&quot;);</span>
<a href="#l21.27"></a><span id="l21.27"> </span>
<a href="#l21.28"></a><span id="l21.28">   // Check the CAB has no cards.</span>
<a href="#l21.29"></a><span id="l21.29">   let CAB = MailServices.ab.getDirectory(kCABData.URI);</span>
<a href="#l21.30"></a><span id="l21.30"> </span>
<a href="#l21.31"></a><span id="l21.31">   Assert.ok(!CAB.childCards.hasMoreElements());</span>
<a href="#l21.32"></a><span id="l21.32" class="difflineminus">-};</span>
<a href="#l21.33"></a><span id="l21.33" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_db_enumerator.js</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_db_enumerator.js</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -2,18 +2,17 @@</span>
<a href="#l22.4"></a><span id="l22.4">  * This test verifies that we don't crash if we have an enumerator on an</span>
<a href="#l22.5"></a><span id="l22.5">  * addr database and delete the underlying directory, which forces the ab</span>
<a href="#l22.6"></a><span id="l22.6">  * closed.</span>
<a href="#l22.7"></a><span id="l22.7">  */</span>
<a href="#l22.8"></a><span id="l22.8"> var ab_prefix       = &quot;test-537815-&quot;;</span>
<a href="#l22.9"></a><span id="l22.9"> var card_properties = { FirstName: &quot;01-first-3&quot;, LastName: &quot;02-last&quot;, PrimaryEmail: &quot;08-email-1@zindus.invalid&quot; };</span>
<a href="#l22.10"></a><span id="l22.10"> var max_addressbooks = 10;</span>
<a href="#l22.11"></a><span id="l22.11"> </span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-function bug_537815_fixture_setup()</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineminus">-{</span>
<a href="#l22.14"></a><span id="l22.14" class="difflineplus">+function bug_537815_fixture_setup() {</span>
<a href="#l22.15"></a><span id="l22.15">   let i, key;</span>
<a href="#l22.16"></a><span id="l22.16"> </span>
<a href="#l22.17"></a><span id="l22.17">   for (i = 1; i &lt;= max_addressbooks; i++) {</span>
<a href="#l22.18"></a><span id="l22.18">     let ab_name = ab_prefix + i;</span>
<a href="#l22.19"></a><span id="l22.19">     MailServices.ab.newAddressBook(ab_name, &quot;&quot;, 2);</span>
<a href="#l22.20"></a><span id="l22.20">     dump(&quot;created: &quot; + ab_name + &quot;\n&quot;);</span>
<a href="#l22.21"></a><span id="l22.21"> </span>
<a href="#l22.22"></a><span id="l22.22">     for (var j = 1; j &lt; 2; j++) {</span>
<a href="#l22.23"></a><span id="l22.23" class="difflineat">@@ -36,63 +35,58 @@ function bug_537815_fixture_setup()</span>
<a href="#l22.24"></a><span id="l22.24">           }</span>
<a href="#l22.25"></a><span id="l22.25">           dump(&quot;populated: &quot; + elem.dirName + &quot;\n&quot;);</span>
<a href="#l22.26"></a><span id="l22.26">         }</span>
<a href="#l22.27"></a><span id="l22.27">       }</span>
<a href="#l22.28"></a><span id="l22.28">     }</span>
<a href="#l22.29"></a><span id="l22.29">   }</span>
<a href="#l22.30"></a><span id="l22.30"> }</span>
<a href="#l22.31"></a><span id="l22.31"> </span>
<a href="#l22.32"></a><span id="l22.32" class="difflineminus">-function bug_537815_test()</span>
<a href="#l22.33"></a><span id="l22.33" class="difflineminus">-{</span>
<a href="#l22.34"></a><span id="l22.34" class="difflineplus">+function bug_537815_test() {</span>
<a href="#l22.35"></a><span id="l22.35">   let enm_dirs = MailServices.ab.directories;</span>
<a href="#l22.36"></a><span id="l22.36" class="difflineminus">-  let i, key;</span>
<a href="#l22.37"></a><span id="l22.37"> </span>
<a href="#l22.38"></a><span id="l22.38">   while (enm_dirs.hasMoreElements()) {</span>
<a href="#l22.39"></a><span id="l22.39">     let elem = enm_dirs.getNext().QueryInterface(Ci.nsIAbDirectory);</span>
<a href="#l22.40"></a><span id="l22.40">     let uri  = elem.URI;</span>
<a href="#l22.41"></a><span id="l22.41">     let dir  = MailServices.ab.getDirectory(uri);</span>
<a href="#l22.42"></a><span id="l22.42"> </span>
<a href="#l22.43"></a><span id="l22.43">     if (elem.dirName.startsWith(ab_prefix)) {</span>
<a href="#l22.44"></a><span id="l22.44">       let enm_cards = dir.childCards;</span>
<a href="#l22.45"></a><span id="l22.45"> </span>
<a href="#l22.46"></a><span id="l22.46">       while (enm_cards.hasMoreElements()) {</span>
<a href="#l22.47"></a><span id="l22.47">         let item = enm_cards.getNext();</span>
<a href="#l22.48"></a><span id="l22.48">         let abCard = item.QueryInterface(Ci.nsIAbCard);</span>
<a href="#l22.49"></a><span id="l22.49"> </span>
<a href="#l22.50"></a><span id="l22.50" class="difflineminus">-        for (i in card_properties) {</span>
<a href="#l22.51"></a><span id="l22.51" class="difflineminus">-          let value = abCard.getProperty(key, null);</span>
<a href="#l22.52"></a><span id="l22.52" class="difflineplus">+        for (let key in card_properties) {</span>
<a href="#l22.53"></a><span id="l22.53" class="difflineplus">+          abCard.getProperty(key, null);</span>
<a href="#l22.54"></a><span id="l22.54">         }</span>
<a href="#l22.55"></a><span id="l22.55">       }</span>
<a href="#l22.56"></a><span id="l22.56">       dump(&quot;visited all cards in: &quot; + elem.dirName + &quot;\n&quot;);</span>
<a href="#l22.57"></a><span id="l22.57">     }</span>
<a href="#l22.58"></a><span id="l22.58">   }</span>
<a href="#l22.59"></a><span id="l22.59"> }</span>
<a href="#l22.60"></a><span id="l22.60"> </span>
<a href="#l22.61"></a><span id="l22.61" class="difflineminus">-function test_bug_537815()</span>
<a href="#l22.62"></a><span id="l22.62" class="difflineminus">-{</span>
<a href="#l22.63"></a><span id="l22.63" class="difflineplus">+function test_bug_537815() {</span>
<a href="#l22.64"></a><span id="l22.64">   bug_537815_fixture_setup();</span>
<a href="#l22.65"></a><span id="l22.65">   bug_537815_test();</span>
<a href="#l22.66"></a><span id="l22.66">   bug_537815_fixture_tear_down();</span>
<a href="#l22.67"></a><span id="l22.67"> }</span>
<a href="#l22.68"></a><span id="l22.68"> </span>
<a href="#l22.69"></a><span id="l22.69" class="difflineminus">-function bug_537815_fixture_tear_down()</span>
<a href="#l22.70"></a><span id="l22.70" class="difflineminus">-{</span>
<a href="#l22.71"></a><span id="l22.71" class="difflineplus">+function bug_537815_fixture_tear_down() {</span>
<a href="#l22.72"></a><span id="l22.72">   let enm_dirs = MailServices.ab.directories;</span>
<a href="#l22.73"></a><span id="l22.73">   let a_uri = {};</span>
<a href="#l22.74"></a><span id="l22.74"> </span>
<a href="#l22.75"></a><span id="l22.75">   while (enm_dirs.hasMoreElements()) {</span>
<a href="#l22.76"></a><span id="l22.76">     let elem = enm_dirs.getNext().QueryInterface(Ci.nsIAbDirectory);</span>
<a href="#l22.77"></a><span id="l22.77"> </span>
<a href="#l22.78"></a><span id="l22.78">     if (elem.dirName.startsWith(ab_prefix)) {</span>
<a href="#l22.79"></a><span id="l22.79">       a_uri[elem.URI] = true;</span>
<a href="#l22.80"></a><span id="l22.80">       dump(&quot;to be deleted: &quot; + elem.dirName + &quot;\n&quot;);</span>
<a href="#l22.81"></a><span id="l22.81">     }</span>
<a href="#l22.82"></a><span id="l22.82">   }</span>
<a href="#l22.83"></a><span id="l22.83"> </span>
<a href="#l22.84"></a><span id="l22.84">   for (let uri in a_uri)</span>
<a href="#l22.85"></a><span id="l22.85">     MailServices.ab.deleteAddressBook(uri);</span>
<a href="#l22.86"></a><span id="l22.86"> }</span>
<a href="#l22.87"></a><span id="l22.87"> </span>
<a href="#l22.88"></a><span id="l22.88" class="difflineminus">-function run_test()</span>
<a href="#l22.89"></a><span id="l22.89" class="difflineminus">-{</span>
<a href="#l22.90"></a><span id="l22.90" class="difflineplus">+function run_test() {</span>
<a href="#l22.91"></a><span id="l22.91">   test_bug_537815();</span>
<a href="#l22.92"></a><span id="l22.92"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_ldap1.js</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_ldap1.js</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -30,18 +30,17 @@ function run_test() {</span>
<a href="#l23.4"></a><span id="l23.4"> </span>
<a href="#l23.5"></a><span id="l23.5">   Assert.equal(abDir.authDn, &quot;test\u00D0&quot;);</span>
<a href="#l23.6"></a><span id="l23.6"> </span>
<a href="#l23.7"></a><span id="l23.7">   // Test - searchDuringLocalAutocomplete</span>
<a href="#l23.8"></a><span id="l23.8"> </span>
<a href="#l23.9"></a><span id="l23.9">   // Set up an account and identity in the account manager</span>
<a href="#l23.10"></a><span id="l23.10">   let identity = MailServices.accounts.createIdentity();</span>
<a href="#l23.11"></a><span id="l23.11"> </span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-  const localAcTests =</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineminus">-    [</span>
<a href="#l23.14"></a><span id="l23.14" class="difflineplus">+  const localAcTests = [</span>
<a href="#l23.15"></a><span id="l23.15">      // Online checks</span>
<a href="#l23.16"></a><span id="l23.16">      { useDir: false, dirSer: &quot;&quot;,</span>
<a href="#l23.17"></a><span id="l23.17">        idOver: false, idSer: &quot;&quot;, idKey: &quot;&quot;,</span>
<a href="#l23.18"></a><span id="l23.18">        offline: false, result: false },</span>
<a href="#l23.19"></a><span id="l23.19">      { useDir: true, dirSer: abDir.dirPrefId,</span>
<a href="#l23.20"></a><span id="l23.20">        idOver: false, idSer: &quot;&quot;, idKey: &quot;&quot;,</span>
<a href="#l23.21"></a><span id="l23.21">        offline: false, result: false },</span>
<a href="#l23.22"></a><span id="l23.22">      // Offline checks with and without global prefs set, no identity key</span>
<a href="#l23.23"></a><span id="l23.23" class="difflineat">@@ -78,24 +77,24 @@ function run_test() {</span>
<a href="#l23.24"></a><span id="l23.24">        idOver: false, idSer: abDir.dirPrefId, idKey: identity.key,</span>
<a href="#l23.25"></a><span id="l23.25">        offline: true, result: false },</span>
<a href="#l23.26"></a><span id="l23.26">      // Offline checks, global prefs and identity ones</span>
<a href="#l23.27"></a><span id="l23.27">      { useDir: true, dirSer: kPABData.dirPrefID,</span>
<a href="#l23.28"></a><span id="l23.28">        idOver: true, idSer: abDir.dirPrefId, idKey: identity.key,</span>
<a href="#l23.29"></a><span id="l23.29">        offline: true, result: true },</span>
<a href="#l23.30"></a><span id="l23.30">      { useDir: true, dirSer: abDir.dirPrefId,</span>
<a href="#l23.31"></a><span id="l23.31">        idOver: true, idSer: kPABData.dirPrefID, idKey: identity.key,</span>
<a href="#l23.32"></a><span id="l23.32" class="difflineminus">-       offline: true, result: false }</span>
<a href="#l23.33"></a><span id="l23.33" class="difflineminus">-     ];</span>
<a href="#l23.34"></a><span id="l23.34" class="difflineplus">+       offline: true, result: false },</span>
<a href="#l23.35"></a><span id="l23.35" class="difflineplus">+  ];</span>
<a href="#l23.36"></a><span id="l23.36"> </span>
<a href="#l23.37"></a><span id="l23.37">   function checkAc(element, index, array) {</span>
<a href="#l23.38"></a><span id="l23.38">     dump(&quot;Testing index &quot; + index + &quot;\n&quot;);</span>
<a href="#l23.39"></a><span id="l23.39">     Services.prefs.setBoolPref(&quot;ldap_2.autoComplete.useDirectory&quot;, element.useDir);</span>
<a href="#l23.40"></a><span id="l23.40">     Services.prefs.setCharPref(&quot;ldap_2.autoComplete.directoryServer&quot;, element.dirSer);</span>
<a href="#l23.41"></a><span id="l23.41">     identity.overrideGlobalPref = element.idOver;</span>
<a href="#l23.42"></a><span id="l23.42">     identity.directoryServer = element.idSer;</span>
<a href="#l23.43"></a><span id="l23.43">     Services.io.offline = element.offline;</span>
<a href="#l23.44"></a><span id="l23.44"> </span>
<a href="#l23.45"></a><span id="l23.45">     Assert.equal(abDir.useForAutocomplete(element.idKey), element.result);</span>
<a href="#l23.46"></a><span id="l23.46">   }</span>
<a href="#l23.47"></a><span id="l23.47"> </span>
<a href="#l23.48"></a><span id="l23.48">   localAcTests.forEach(checkAc);</span>
<a href="#l23.49"></a><span id="l23.49" class="difflineminus">-};</span>
<a href="#l23.50"></a><span id="l23.50" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_ldap2.js</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_ldap2.js</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -30,9 +30,9 @@ function run_test() {</span>
<a href="#l24.4"></a><span id="l24.4">   Assert.equal(abDir.lDAPURL.spec, kLDAPTestSpec);</span>
<a href="#l24.5"></a><span id="l24.5">   Assert.ok(abDir.readOnly);</span>
<a href="#l24.6"></a><span id="l24.6"> </span>
<a href="#l24.7"></a><span id="l24.7">   // XXX I'd really like a better check than this, to check that searching</span>
<a href="#l24.8"></a><span id="l24.8">   // works correctly. However we haven't got the support for that at the moment</span>
<a href="#l24.9"></a><span id="l24.9">   // and this at least ensures that we get a consistent ascii based preference</span>
<a href="#l24.10"></a><span id="l24.10">   // for the directory.</span>
<a href="#l24.11"></a><span id="l24.11">   Assert.equal(abDir.dirPrefId, &quot;ldap_2.servers._nonascii&quot;);</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-};</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_ldapOffline.js</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_ldapOffline.js</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -36,18 +36,17 @@ function run_test() {</span>
<a href="#l25.4"></a><span id="l25.4">   // Now try and get the card that has been replicated for offline use.</span>
<a href="#l25.5"></a><span id="l25.5">   let childCards = abDir.childCards;</span>
<a href="#l25.6"></a><span id="l25.6">   let count = 0;</span>
<a href="#l25.7"></a><span id="l25.7"> </span>
<a href="#l25.8"></a><span id="l25.8">   // Make sure we clear any memory that is now loose, so that the crash would</span>
<a href="#l25.9"></a><span id="l25.9">   // be triggered.</span>
<a href="#l25.10"></a><span id="l25.10">   gc();</span>
<a href="#l25.11"></a><span id="l25.11"> </span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-  while (childCards.hasMoreElements())</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineminus">-  {</span>
<a href="#l25.14"></a><span id="l25.14" class="difflineplus">+  while (childCards.hasMoreElements()) {</span>
<a href="#l25.15"></a><span id="l25.15">     // Make sure everything is an nsIAbCard.</span>
<a href="#l25.16"></a><span id="l25.16">     childCards.getNext().QueryInterface(Ci.nsIAbCard);</span>
<a href="#l25.17"></a><span id="l25.17"> </span>
<a href="#l25.18"></a><span id="l25.18">     ++count;</span>
<a href="#l25.19"></a><span id="l25.19">   }</span>
<a href="#l25.20"></a><span id="l25.20"> </span>
<a href="#l25.21"></a><span id="l25.21">   Assert.equal(count, 4);</span>
<a href="#l25.22"></a><span id="l25.22"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_mailList1.js</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_mailList1.js</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -12,26 +12,26 @@ function checkLists(childNodes, number) </span>
<a href="#l26.4"></a><span id="l26.4"> </span>
<a href="#l26.5"></a><span id="l26.5">   for (var i = 0; i &lt; number; ++i)</span>
<a href="#l26.6"></a><span id="l26.6">     mailListArray[i] = null;</span>
<a href="#l26.7"></a><span id="l26.7"> </span>
<a href="#l26.8"></a><span id="l26.8">   // See comment above for matching requirements</span>
<a href="#l26.9"></a><span id="l26.9">   while (childNodes.hasMoreElements()) {</span>
<a href="#l26.10"></a><span id="l26.10">     var list = childNodes.getNext();</span>
<a href="#l26.11"></a><span id="l26.11">     if (list instanceof Ci.nsIAbDirectory &amp;&amp;</span>
<a href="#l26.12"></a><span id="l26.12" class="difflineminus">-        list.isMailList &amp;&amp; list.dirName.startsWith('TestList')) {</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineplus">+        list.isMailList &amp;&amp; list.dirName.startsWith(&quot;TestList&quot;)) {</span>
<a href="#l26.14"></a><span id="l26.14">       var index = list.dirName.substr(8, list.dirName.length - 8);</span>
<a href="#l26.15"></a><span id="l26.15">       Assert.equal(mailListArray[index - 1], null);</span>
<a href="#l26.16"></a><span id="l26.16">       Assert.equal(list.URI, kPABData.URI + &quot;/MailList&quot; + index);</span>
<a href="#l26.17"></a><span id="l26.17"> </span>
<a href="#l26.18"></a><span id="l26.18">       mailListArray[index - 1] = list;</span>
<a href="#l26.19"></a><span id="l26.19">     }</span>
<a href="#l26.20"></a><span id="l26.20">   }</span>
<a href="#l26.21"></a><span id="l26.21"> </span>
<a href="#l26.22"></a><span id="l26.22" class="difflineminus">-  mailListArray.forEach(function (value) { Assert.notEqual(value, null); });</span>
<a href="#l26.23"></a><span id="l26.23" class="difflineplus">+  mailListArray.forEach(function(value) { Assert.notEqual(value, null); });</span>
<a href="#l26.24"></a><span id="l26.24"> }</span>
<a href="#l26.25"></a><span id="l26.25"> </span>
<a href="#l26.26"></a><span id="l26.26"> function run_test() {</span>
<a href="#l26.27"></a><span id="l26.27">   // Create a new card</span>
<a href="#l26.28"></a><span id="l26.28">   // Test setup - copy the data file into place</span>
<a href="#l26.29"></a><span id="l26.29">   var testAB = do_get_file(&quot;../../../data/abLists1.mab&quot;);</span>
<a href="#l26.30"></a><span id="l26.30"> </span>
<a href="#l26.31"></a><span id="l26.31">   // Copy the file to the profile directory for a PAB</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_notifications.js</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_notifications.js</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -6,33 +6,31 @@</span>
<a href="#l27.4"></a><span id="l27.4">  * XXX Still to do:</span>
<a href="#l27.5"></a><span id="l27.5">  * - Editing a mailing list properties (name/nickname/notes)</span>
<a href="#l27.6"></a><span id="l27.6">  * - Adding, editing and deleting items in mailing lists</span>
<a href="#l27.7"></a><span id="l27.7">  */</span>
<a href="#l27.8"></a><span id="l27.8"> </span>
<a href="#l27.9"></a><span id="l27.9"> var abListener = {</span>
<a href="#l27.10"></a><span id="l27.10">   result: [],</span>
<a href="#l27.11"></a><span id="l27.11">   maxResults: 1,</span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-  onItemAdded: function (parentItem, item) {</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineplus">+  onItemAdded(parentItem, item) {</span>
<a href="#l27.14"></a><span id="l27.14">     Assert.ok(this.result.length &lt; this.maxResults);</span>
<a href="#l27.15"></a><span id="l27.15">     this.result.push([&quot;onItemAdded&quot;, parentItem, item]);</span>
<a href="#l27.16"></a><span id="l27.16">   },</span>
<a href="#l27.17"></a><span id="l27.17" class="difflineminus">-  onItemRemoved: function (parentItem, item) {</span>
<a href="#l27.18"></a><span id="l27.18" class="difflineplus">+  onItemRemoved(parentItem, item) {</span>
<a href="#l27.19"></a><span id="l27.19">     Assert.ok(this.result.length &lt; this.maxResults);</span>
<a href="#l27.20"></a><span id="l27.20">     this.result.push([&quot;onItemRemoved&quot;, parentItem, item]);</span>
<a href="#l27.21"></a><span id="l27.21">   },</span>
<a href="#l27.22"></a><span id="l27.22" class="difflineminus">-  onItemPropertyChanged: function (item, property, oldValue, newValue) {</span>
<a href="#l27.23"></a><span id="l27.23" class="difflineplus">+  onItemPropertyChanged(item, property, oldValue, newValue) {</span>
<a href="#l27.24"></a><span id="l27.24">     Assert.ok(this.result.length &lt; this.maxResults);</span>
<a href="#l27.25"></a><span id="l27.25">     this.result.push([&quot;onItemPropertyChanged&quot;, item, property, oldValue, newValue]);</span>
<a href="#l27.26"></a><span id="l27.26" class="difflineminus">-  }</span>
<a href="#l27.27"></a><span id="l27.27" class="difflineplus">+  },</span>
<a href="#l27.28"></a><span id="l27.28"> };</span>
<a href="#l27.29"></a><span id="l27.29"> </span>
<a href="#l27.30"></a><span id="l27.30"> function run_test() {</span>
<a href="#l27.31"></a><span id="l27.31" class="difflineminus">-  var i;</span>
<a href="#l27.32"></a><span id="l27.32" class="difflineminus">-</span>
<a href="#l27.33"></a><span id="l27.33">   // XXX Getting all directories ensures we create all ABs because the</span>
<a href="#l27.34"></a><span id="l27.34">   // address collecter can't currently create ABs itself (bug 314448).</span>
<a href="#l27.35"></a><span id="l27.35">   MailServices.ab.directories;</span>
<a href="#l27.36"></a><span id="l27.36"> </span>
<a href="#l27.37"></a><span id="l27.37">   // Add a listener</span>
<a href="#l27.38"></a><span id="l27.38">   MailServices.ab.addAddressBookListener(abListener, Ci.nsIAbListener.all);</span>
<a href="#l27.39"></a><span id="l27.39"> </span>
<a href="#l27.40"></a><span id="l27.40">   // Get the directory</span>
<a href="#l27.41"></a><span id="l27.41" class="difflineat">@@ -135,18 +133,18 @@ function run_test() {</span>
<a href="#l27.42"></a><span id="l27.42"> </span>
<a href="#l27.43"></a><span id="l27.43">   // Now verify the card and the directory</span>
<a href="#l27.44"></a><span id="l27.44">   card = abListener.result[0][2].QueryInterface(Ci.nsIAbCard);</span>
<a href="#l27.45"></a><span id="l27.45">   Assert.ok(card.isMailList);</span>
<a href="#l27.46"></a><span id="l27.46">   Assert.equal(card.displayName, &quot;TestList&quot;);</span>
<a href="#l27.47"></a><span id="l27.47">   Assert.equal(card.getProperty(&quot;Notes&quot;, &quot;BAD&quot;), &quot;testdescription&quot;);</span>
<a href="#l27.48"></a><span id="l27.48">   Assert.equal(card.getProperty(&quot;NickName&quot;, &quot;BAD&quot;), &quot;test&quot;);</span>
<a href="#l27.49"></a><span id="l27.49"> </span>
<a href="#l27.50"></a><span id="l27.50" class="difflineminus">-  var book = abListener.result[1][2].QueryInterface(Ci.nsIAbDirectory);</span>
<a href="#l27.51"></a><span id="l27.51" class="difflineplus">+  book = abListener.result[1][2].QueryInterface(Ci.nsIAbDirectory);</span>
<a href="#l27.52"></a><span id="l27.52">   Assert.ok(book.isMailList);</span>
<a href="#l27.53"></a><span id="l27.53">   Assert.equal(book.dirName, &quot;TestList&quot;);</span>
<a href="#l27.54"></a><span id="l27.54">   Assert.equal(book.listNickName, &quot;test&quot;);</span>
<a href="#l27.55"></a><span id="l27.55">   Assert.equal(book.description, &quot;testdescription&quot;);</span>
<a href="#l27.56"></a><span id="l27.56"> </span>
<a href="#l27.57"></a><span id="l27.57">   // Remove listener</span>
<a href="#l27.58"></a><span id="l27.58"> </span>
<a href="#l27.59"></a><span id="l27.59">   MailServices.ab.removeAddressBookListener(abListener);</span>
<a href="#l27.60"></a><span id="l27.60" class="difflineminus">-};</span>
<a href="#l27.61"></a><span id="l27.61" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_nsAbAutoCompleteMyDomain.js</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_nsAbAutoCompleteMyDomain.js</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -6,20 +6,20 @@</span>
<a href="#l28.4"></a><span id="l28.4"> var ACR = Ci.nsIAutoCompleteResult;</span>
<a href="#l28.5"></a><span id="l28.5"> </span>
<a href="#l28.6"></a><span id="l28.6"> function acObserver() {}</span>
<a href="#l28.7"></a><span id="l28.7"> </span>
<a href="#l28.8"></a><span id="l28.8"> acObserver.prototype = {</span>
<a href="#l28.9"></a><span id="l28.9">   _search: null,</span>
<a href="#l28.10"></a><span id="l28.10">   _result: null,</span>
<a href="#l28.11"></a><span id="l28.11"> </span>
<a href="#l28.12"></a><span id="l28.12" class="difflineminus">-  onSearchResult: function (aSearch, aResult) {</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineplus">+  onSearchResult(aSearch, aResult) {</span>
<a href="#l28.14"></a><span id="l28.14">     this._search = aSearch;</span>
<a href="#l28.15"></a><span id="l28.15">     this._result = aResult;</span>
<a href="#l28.16"></a><span id="l28.16" class="difflineminus">-  }</span>
<a href="#l28.17"></a><span id="l28.17" class="difflineplus">+  },</span>
<a href="#l28.18"></a><span id="l28.18"> };</span>
<a href="#l28.19"></a><span id="l28.19"> </span>
<a href="#l28.20"></a><span id="l28.20"> function run_test() {</span>
<a href="#l28.21"></a><span id="l28.21">   // Test - Create a new search component</span>
<a href="#l28.22"></a><span id="l28.22"> </span>
<a href="#l28.23"></a><span id="l28.23">   var acs = Cc[&quot;@mozilla.org/autocomplete/search;1?name=mydomain&quot;]</span>
<a href="#l28.24"></a><span id="l28.24">     .getService(Ci.nsIAutoCompleteSearch);</span>
<a href="#l28.25"></a><span id="l28.25"> </span>
<a href="#l28.26"></a><span id="l28.26" class="difflineat">@@ -114,9 +114,9 @@ function run_test() {</span>
<a href="#l28.27"></a><span id="l28.27">   Assert.equal(obs._result.errorDescription, null);</span>
<a href="#l28.28"></a><span id="l28.28">   Assert.equal(obs._result.matchCount, 1);</span>
<a href="#l28.29"></a><span id="l28.29"> </span>
<a href="#l28.30"></a><span id="l28.30">   Assert.equal(obs._result.getValueAt(0), &quot;test1@foo.invalid&quot;);</span>
<a href="#l28.31"></a><span id="l28.31">   Assert.equal(obs._result.getLabelAt(0), &quot;test1@foo.invalid&quot;);</span>
<a href="#l28.32"></a><span id="l28.32">   Assert.equal(obs._result.getCommentAt(0), null);</span>
<a href="#l28.33"></a><span id="l28.33">   Assert.equal(obs._result.getStyleAt(0), &quot;default-match&quot;);</span>
<a href="#l28.34"></a><span id="l28.34">   Assert.equal(obs._result.getImageAt(0), null);</span>
<a href="#l28.35"></a><span id="l28.35" class="difflineminus">-};</span>
<a href="#l28.36"></a><span id="l28.36" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch1.js</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch1.js</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -18,17 +18,17 @@ var results = [ { email: &quot;d &lt;ema@foo.inv</span>
<a href="#l29.4"></a><span id="l29.4">                   { email: &quot;disp &lt;e@foo.invalid&gt;&quot;, dirName: kPABData.dirName }, // 3</span>
<a href="#l29.5"></a><span id="l29.5">                   { email: &quot;displ &lt;em@foo.invalid&gt;&quot;, dirName: kPABData.dirName }, // 4</span>
<a href="#l29.6"></a><span id="l29.6">                   { email: &quot;DisplayName1 &lt;PrimaryEmail1@test.invalid&gt;&quot;, // 5</span>
<a href="#l29.7"></a><span id="l29.7">                     dirName: kCABData.dirName },</span>
<a href="#l29.8"></a><span id="l29.8">                   { email: &quot;t &lt;list&gt;&quot;, dirName: kPABData.dirName }, // 6</span>
<a href="#l29.9"></a><span id="l29.9">                   { email: &quot;te &lt;lis&gt;&quot;, dirName: kPABData.dirName }, // 7</span>
<a href="#l29.10"></a><span id="l29.10">                   { email: &quot;tes &lt;li&gt;&quot;, dirName: kPABData.dirName }, // 8</span>
<a href="#l29.11"></a><span id="l29.11">                    // this contact has a nickname of &quot;abcdef&quot;</span>
<a href="#l29.12"></a><span id="l29.12" class="difflineminus">-                  { email: &quot;test &lt;l&gt;&quot;, dirName: kPABData.dirName } // 9</span>
<a href="#l29.13"></a><span id="l29.13" class="difflineplus">+                  { email: &quot;test &lt;l&gt;&quot;, dirName: kPABData.dirName }, // 9</span>
<a href="#l29.14"></a><span id="l29.14">                 ];</span>
<a href="#l29.15"></a><span id="l29.15"> var firstNames = [ { search: &quot;f&quot;,      expected: [0, 1, 2, 3, 4, 5, 9] },</span>
<a href="#l29.16"></a><span id="l29.16">                      { search: &quot;fi&quot;,     expected: [0, 1, 3, 4, 5] },</span>
<a href="#l29.17"></a><span id="l29.17">                      { search: &quot;fir&quot;,    expected: [0, 1, 4, 5] },</span>
<a href="#l29.18"></a><span id="l29.18">                      { search: &quot;firs&quot;,   expected: [0, 1, 5] },</span>
<a href="#l29.19"></a><span id="l29.19">                      { search: &quot;first&quot;,  expected: [1, 5] },</span>
<a href="#l29.20"></a><span id="l29.20">                      { search: &quot;firstn&quot;, expected: [5] } ];</span>
<a href="#l29.21"></a><span id="l29.21"> </span>
<a href="#l29.22"></a><span id="l29.22" class="difflineat">@@ -62,133 +62,131 @@ var emails = [ { search: &quot;e&quot;,     expect</span>
<a href="#l29.23"></a><span id="l29.23"> // &quot;l&quot; case tested above</span>
<a href="#l29.24"></a><span id="l29.24"> var lists = [ { search: &quot;li&quot;, expected: [6, 7, 8, 0, 1, 2, 3, 4, 5] },</span>
<a href="#l29.25"></a><span id="l29.25">                 { search: &quot;lis&quot;, expected: [6, 7] },</span>
<a href="#l29.26"></a><span id="l29.26">                 { search: &quot;list&quot;, expected: [6] },</span>
<a href="#l29.27"></a><span id="l29.27">                 { search: &quot;t&quot;, expected: [6, 7, 8, 9, 0, 1, 4, 5] },</span>
<a href="#l29.28"></a><span id="l29.28">                 { search: &quot;te&quot;, expected: [7, 8, 9, 5] },</span>
<a href="#l29.29"></a><span id="l29.29">                 { search: &quot;tes&quot;, expected: [8, 9, 5] },</span>
<a href="#l29.30"></a><span id="l29.30">                 { search: &quot;test&quot;, expected: [9, 5] },</span>
<a href="#l29.31"></a><span id="l29.31" class="difflineminus">-                { search: &quot;abcdef&quot;, expected: [9] } // Bug 441586</span>
<a href="#l29.32"></a><span id="l29.32" class="difflineplus">+                { search: &quot;abcdef&quot;, expected: [9] }, // Bug 441586</span>
<a href="#l29.33"></a><span id="l29.33">               ];</span>
<a href="#l29.34"></a><span id="l29.34"> </span>
<a href="#l29.35"></a><span id="l29.35"> var bothNames = [ { search: &quot;f l&quot;,            expected: [0, 1, 2, 3, 4, 5, 9] },</span>
<a href="#l29.36"></a><span id="l29.36">                     { search: &quot;l f&quot;,            expected: [0, 1, 2, 3, 4, 5, 9] },</span>
<a href="#l29.37"></a><span id="l29.37">                     { search: &quot;firstn lastna&quot;,  expected: [5] },</span>
<a href="#l29.38"></a><span id="l29.38">                     { search: &quot;lastna firstna&quot;, expected: [5] } ];</span>
<a href="#l29.39"></a><span id="l29.39"> </span>
<a href="#l29.40"></a><span id="l29.40"> var inputs = [ firstNames, lastNames, displayNames, nickNames, emails,</span>
<a href="#l29.41"></a><span id="l29.41">                  lists, bothNames ];</span>
<a href="#l29.42"></a><span id="l29.42"> </span>
<a href="#l29.43"></a><span id="l29.43"> function acObserver() {}</span>
<a href="#l29.44"></a><span id="l29.44"> </span>
<a href="#l29.45"></a><span id="l29.45"> acObserver.prototype = {</span>
<a href="#l29.46"></a><span id="l29.46">   _search: null,</span>
<a href="#l29.47"></a><span id="l29.47">   _result: null,</span>
<a href="#l29.48"></a><span id="l29.48"> </span>
<a href="#l29.49"></a><span id="l29.49" class="difflineminus">-  onSearchResult: function (aSearch, aResult) {</span>
<a href="#l29.50"></a><span id="l29.50" class="difflineplus">+  onSearchResult(aSearch, aResult) {</span>
<a href="#l29.51"></a><span id="l29.51">     this._search = aSearch;</span>
<a href="#l29.52"></a><span id="l29.52">     this._result = aResult;</span>
<a href="#l29.53"></a><span id="l29.53" class="difflineminus">-  }</span>
<a href="#l29.54"></a><span id="l29.54" class="difflineplus">+  },</span>
<a href="#l29.55"></a><span id="l29.55"> };</span>
<a href="#l29.56"></a><span id="l29.56"> </span>
<a href="#l29.57"></a><span id="l29.57"> var PAB_CARD_DATA = [</span>
<a href="#l29.58"></a><span id="l29.58">   {</span>
<a href="#l29.59"></a><span id="l29.59">     &quot;FirstName&quot;: &quot;firs&quot;,</span>
<a href="#l29.60"></a><span id="l29.60">     &quot;LastName&quot;: &quot;lastn&quot;,</span>
<a href="#l29.61"></a><span id="l29.61">     &quot;DisplayName&quot;: &quot;d&quot;,</span>
<a href="#l29.62"></a><span id="l29.62">     &quot;NickName&quot;: &quot;ni&quot;,</span>
<a href="#l29.63"></a><span id="l29.63">     &quot;PrimaryEmail&quot;: &quot;ema@foo.invalid&quot;,</span>
<a href="#l29.64"></a><span id="l29.64">     &quot;PreferDisplayName&quot;: true,</span>
<a href="#l29.65"></a><span id="l29.65" class="difflineminus">-    &quot;PopularityIndex&quot;: 0</span>
<a href="#l29.66"></a><span id="l29.66" class="difflineplus">+    &quot;PopularityIndex&quot;: 0,</span>
<a href="#l29.67"></a><span id="l29.67">   },</span>
<a href="#l29.68"></a><span id="l29.68">   {</span>
<a href="#l29.69"></a><span id="l29.69">     &quot;FirstName&quot;: &quot;first&quot;,</span>
<a href="#l29.70"></a><span id="l29.70">     &quot;LastName&quot;: &quot;l&quot;,</span>
<a href="#l29.71"></a><span id="l29.71">     &quot;DisplayName&quot;: &quot;di&quot;,</span>
<a href="#l29.72"></a><span id="l29.72">     &quot;NickName&quot;: &quot;nic&quot;,</span>
<a href="#l29.73"></a><span id="l29.73">     &quot;PrimaryEmail&quot;: &quot;emai@foo.invalid&quot;,</span>
<a href="#l29.74"></a><span id="l29.74">     &quot;PreferDisplayName&quot;: true,</span>
<a href="#l29.75"></a><span id="l29.75" class="difflineminus">-    &quot;PopularityIndex&quot;: 0</span>
<a href="#l29.76"></a><span id="l29.76" class="difflineplus">+    &quot;PopularityIndex&quot;: 0,</span>
<a href="#l29.77"></a><span id="l29.77">   },</span>
<a href="#l29.78"></a><span id="l29.78">   {</span>
<a href="#l29.79"></a><span id="l29.79">     &quot;FirstName&quot;: &quot;f&quot;,</span>
<a href="#l29.80"></a><span id="l29.80">     &quot;LastName&quot;: &quot;la&quot;,</span>
<a href="#l29.81"></a><span id="l29.81">     &quot;DisplayName&quot;: &quot;dis&quot;,</span>
<a href="#l29.82"></a><span id="l29.82">     &quot;NickName&quot;: &quot;nick&quot;,</span>
<a href="#l29.83"></a><span id="l29.83">     &quot;PrimaryEmail&quot;: &quot;email@foo.invalid&quot;,</span>
<a href="#l29.84"></a><span id="l29.84">     &quot;PreferDisplayName&quot;: true,</span>
<a href="#l29.85"></a><span id="l29.85" class="difflineminus">-    &quot;PopularityIndex&quot;: 0</span>
<a href="#l29.86"></a><span id="l29.86" class="difflineplus">+    &quot;PopularityIndex&quot;: 0,</span>
<a href="#l29.87"></a><span id="l29.87">   },</span>
<a href="#l29.88"></a><span id="l29.88">   {</span>
<a href="#l29.89"></a><span id="l29.89">     &quot;FirstName&quot;: &quot;fi&quot;,</span>
<a href="#l29.90"></a><span id="l29.90">     &quot;LastName&quot;: &quot;las&quot;,</span>
<a href="#l29.91"></a><span id="l29.91">     &quot;DisplayName&quot;: &quot;disp&quot;,</span>
<a href="#l29.92"></a><span id="l29.92">     &quot;NickName&quot;: &quot;nickn&quot;,</span>
<a href="#l29.93"></a><span id="l29.93">     &quot;PrimaryEmail&quot;: &quot;e@foo.invalid&quot;,</span>
<a href="#l29.94"></a><span id="l29.94">     &quot;PreferDisplayName&quot;: true,</span>
<a href="#l29.95"></a><span id="l29.95" class="difflineminus">-    &quot;PopularityIndex&quot;: 0</span>
<a href="#l29.96"></a><span id="l29.96" class="difflineplus">+    &quot;PopularityIndex&quot;: 0,</span>
<a href="#l29.97"></a><span id="l29.97">   },</span>
<a href="#l29.98"></a><span id="l29.98">   {</span>
<a href="#l29.99"></a><span id="l29.99">     &quot;FirstName&quot;: &quot;fir&quot;,</span>
<a href="#l29.100"></a><span id="l29.100">     &quot;LastName&quot;: &quot;last&quot;,</span>
<a href="#l29.101"></a><span id="l29.101">     &quot;DisplayName&quot;: &quot;displ&quot;,</span>
<a href="#l29.102"></a><span id="l29.102">     &quot;NickName&quot;: &quot;n&quot;,</span>
<a href="#l29.103"></a><span id="l29.103">     &quot;PrimaryEmail&quot;: &quot;em@foo.invalid&quot;,</span>
<a href="#l29.104"></a><span id="l29.104">     &quot;PreferDisplayName&quot;: true,</span>
<a href="#l29.105"></a><span id="l29.105" class="difflineminus">-    &quot;PopularityIndex&quot;: 0</span>
<a href="#l29.106"></a><span id="l29.106" class="difflineminus">-  }</span>
<a href="#l29.107"></a><span id="l29.107" class="difflineplus">+    &quot;PopularityIndex&quot;: 0,</span>
<a href="#l29.108"></a><span id="l29.108" class="difflineplus">+  },</span>
<a href="#l29.109"></a><span id="l29.109"> ];</span>
<a href="#l29.110"></a><span id="l29.110"> </span>
<a href="#l29.111"></a><span id="l29.111"> var PAB_LIST_DATA =  [</span>
<a href="#l29.112"></a><span id="l29.112">   {</span>
<a href="#l29.113"></a><span id="l29.113" class="difflineminus">-    &quot;dirName&quot; : &quot;t&quot;,</span>
<a href="#l29.114"></a><span id="l29.114" class="difflineplus">+    &quot;dirName&quot;: &quot;t&quot;,</span>
<a href="#l29.115"></a><span id="l29.115">     &quot;listNickName&quot;: null,</span>
<a href="#l29.116"></a><span id="l29.116" class="difflineminus">-    &quot;description&quot;: &quot;list&quot;</span>
<a href="#l29.117"></a><span id="l29.117" class="difflineplus">+    &quot;description&quot;: &quot;list&quot;,</span>
<a href="#l29.118"></a><span id="l29.118">   },</span>
<a href="#l29.119"></a><span id="l29.119">   {</span>
<a href="#l29.120"></a><span id="l29.120" class="difflineminus">-    &quot;dirName&quot; : &quot;te&quot;,</span>
<a href="#l29.121"></a><span id="l29.121" class="difflineplus">+    &quot;dirName&quot;: &quot;te&quot;,</span>
<a href="#l29.122"></a><span id="l29.122">     &quot;listNickName&quot;: null,</span>
<a href="#l29.123"></a><span id="l29.123" class="difflineminus">-    &quot;description&quot;: &quot;lis&quot;</span>
<a href="#l29.124"></a><span id="l29.124" class="difflineplus">+    &quot;description&quot;: &quot;lis&quot;,</span>
<a href="#l29.125"></a><span id="l29.125">   },</span>
<a href="#l29.126"></a><span id="l29.126">   {</span>
<a href="#l29.127"></a><span id="l29.127" class="difflineminus">-    &quot;dirName&quot; : &quot;tes&quot;,</span>
<a href="#l29.128"></a><span id="l29.128" class="difflineplus">+    &quot;dirName&quot;: &quot;tes&quot;,</span>
<a href="#l29.129"></a><span id="l29.129">     &quot;listNickName&quot;: null,</span>
<a href="#l29.130"></a><span id="l29.130" class="difflineminus">-    &quot;description&quot;: &quot;li&quot;</span>
<a href="#l29.131"></a><span id="l29.131" class="difflineplus">+    &quot;description&quot;: &quot;li&quot;,</span>
<a href="#l29.132"></a><span id="l29.132">   },</span>
<a href="#l29.133"></a><span id="l29.133">   {</span>
<a href="#l29.134"></a><span id="l29.134" class="difflineminus">-    &quot;dirName&quot; : &quot;test&quot;,</span>
<a href="#l29.135"></a><span id="l29.135" class="difflineplus">+    &quot;dirName&quot;: &quot;test&quot;,</span>
<a href="#l29.136"></a><span id="l29.136">     &quot;listNickName&quot;: &quot;abcdef&quot;,</span>
<a href="#l29.137"></a><span id="l29.137" class="difflineminus">-    &quot;description&quot;: &quot;l&quot;</span>
<a href="#l29.138"></a><span id="l29.138" class="difflineminus">-  }</span>
<a href="#l29.139"></a><span id="l29.139" class="difflineplus">+    &quot;description&quot;: &quot;l&quot;,</span>
<a href="#l29.140"></a><span id="l29.140" class="difflineplus">+  },</span>
<a href="#l29.141"></a><span id="l29.141"> ];</span>
<a href="#l29.142"></a><span id="l29.142"> </span>
<a href="#l29.143"></a><span id="l29.143"> var CAB_CARD_DATA = [</span>
<a href="#l29.144"></a><span id="l29.144">   {</span>
<a href="#l29.145"></a><span id="l29.145">     &quot;FirstName&quot;: &quot;FirstName1&quot;,</span>
<a href="#l29.146"></a><span id="l29.146">     &quot;LastName&quot;: &quot;LastName1&quot;,</span>
<a href="#l29.147"></a><span id="l29.147">     &quot;DisplayName&quot;: &quot;DisplayName1&quot;,</span>
<a href="#l29.148"></a><span id="l29.148">     &quot;NickName&quot;: &quot;NickName1&quot;,</span>
<a href="#l29.149"></a><span id="l29.149">     &quot;PrimaryEmail&quot;: &quot;PrimaryEmail1@test.invalid&quot;,</span>
<a href="#l29.150"></a><span id="l29.150">     &quot;PreferDisplayName&quot;: true,</span>
<a href="#l29.151"></a><span id="l29.151" class="difflineminus">-    &quot;PopularityIndex&quot;: 0</span>
<a href="#l29.152"></a><span id="l29.152" class="difflineplus">+    &quot;PopularityIndex&quot;: 0,</span>
<a href="#l29.153"></a><span id="l29.153">   },</span>
<a href="#l29.154"></a><span id="l29.154">   {</span>
<a href="#l29.155"></a><span id="l29.155">     &quot;FirstName&quot;: &quot;Empty&quot;,</span>
<a href="#l29.156"></a><span id="l29.156">     &quot;LastName&quot;: &quot;Email&quot;,</span>
<a href="#l29.157"></a><span id="l29.157">     &quot;DisplayName&quot;: &quot;Empty Email&quot;,</span>
<a href="#l29.158"></a><span id="l29.158">     &quot;PreferDisplayName&quot;: true,</span>
<a href="#l29.159"></a><span id="l29.159" class="difflineminus">-    &quot;PopularityIndex&quot;: 0</span>
<a href="#l29.160"></a><span id="l29.160" class="difflineminus">-  }</span>
<a href="#l29.161"></a><span id="l29.161" class="difflineplus">+    &quot;PopularityIndex&quot;: 0,</span>
<a href="#l29.162"></a><span id="l29.162" class="difflineplus">+  },</span>
<a href="#l29.163"></a><span id="l29.163"> ];</span>
<a href="#l29.164"></a><span id="l29.164"> </span>
<a href="#l29.165"></a><span id="l29.165"> var CAB_LIST_DATA = [];</span>
<a href="#l29.166"></a><span id="l29.166"> </span>
<a href="#l29.167"></a><span id="l29.167" class="difflineminus">-var ABMDB_PREFIX = &quot;moz-abmdbdirectory://&quot;;</span>
<a href="#l29.168"></a><span id="l29.168" class="difflineminus">-</span>
<a href="#l29.169"></a><span id="l29.169"> function setupAddressBookData(aDirURI, aCardData, aMailListData) {</span>
<a href="#l29.170"></a><span id="l29.170">   let ab = MailServices.ab.getDirectory(aDirURI);</span>
<a href="#l29.171"></a><span id="l29.171"> </span>
<a href="#l29.172"></a><span id="l29.172">   // Getting all directories ensures we create all ABs because mailing</span>
<a href="#l29.173"></a><span id="l29.173">   // lists need help initialising themselves</span>
<a href="#l29.174"></a><span id="l29.174">   MailServices.ab.directories;</span>
<a href="#l29.175"></a><span id="l29.175"> </span>
<a href="#l29.176"></a><span id="l29.176">   let childCards0 = ab.childCards;</span>
<a href="#l29.177"></a><span id="l29.177" class="difflineat">@@ -213,17 +211,17 @@ function setupAddressBookData(aDirURI, a</span>
<a href="#l29.178"></a><span id="l29.178">     for (var prop in ld) {</span>
<a href="#l29.179"></a><span id="l29.179">       list[prop] = ld[prop];</span>
<a href="#l29.180"></a><span id="l29.180">     }</span>
<a href="#l29.181"></a><span id="l29.181">     ab.addMailList(list);</span>
<a href="#l29.182"></a><span id="l29.182">   });</span>
<a href="#l29.183"></a><span id="l29.183"> </span>
<a href="#l29.184"></a><span id="l29.184">   let childCards = ab.childCards;</span>
<a href="#l29.185"></a><span id="l29.185">   while (childCards.hasMoreElements()) {</span>
<a href="#l29.186"></a><span id="l29.186" class="difflineminus">-    let c = childCards.getNext().QueryInterface(Ci.nsIAbCard);</span>
<a href="#l29.187"></a><span id="l29.187" class="difflineplus">+    childCards.getNext().QueryInterface(Ci.nsIAbCard);</span>
<a href="#l29.188"></a><span id="l29.188">   }</span>
<a href="#l29.189"></a><span id="l29.189"> }</span>
<a href="#l29.190"></a><span id="l29.190"> </span>
<a href="#l29.191"></a><span id="l29.191"> function run_test() {</span>
<a href="#l29.192"></a><span id="l29.192">   // Set up addresses for in the personal address book.</span>
<a href="#l29.193"></a><span id="l29.193">   setupAddressBookData(kPABData.URI, PAB_CARD_DATA, PAB_LIST_DATA);</span>
<a href="#l29.194"></a><span id="l29.194">   // ... and collected addresses address book.</span>
<a href="#l29.195"></a><span id="l29.195">   setupAddressBookData(kCABData.URI, CAB_CARD_DATA, CAB_LIST_DATA);</span>
<a href="#l29.196"></a><span id="l29.196" class="difflineat">@@ -349,33 +347,33 @@ function run_test() {</span>
<a href="#l29.197"></a><span id="l29.197">   Assert.equal(obs._result.getImageAt(0), &quot;&quot;);</span>
<a href="#l29.198"></a><span id="l29.198"> </span>
<a href="#l29.199"></a><span id="l29.199">   // Now check multiple matches</span>
<a href="#l29.200"></a><span id="l29.200">   function checkInputItem(element, index, array) {</span>
<a href="#l29.201"></a><span id="l29.201">     let prevRes = obs._result;</span>
<a href="#l29.202"></a><span id="l29.202">     print(&quot;Search #&quot; + index + &quot;: search=&quot; + element.search);</span>
<a href="#l29.203"></a><span id="l29.203">     acs.startSearch(element.search, param, prevRes, obs);</span>
<a href="#l29.204"></a><span id="l29.204"> </span>
<a href="#l29.205"></a><span id="l29.205" class="difflineminus">-    for (var i = 0; i &lt; obs._result.matchCount; i++) {</span>
<a href="#l29.206"></a><span id="l29.206" class="difflineplus">+    for (let i = 0; i &lt; obs._result.matchCount; i++) {</span>
<a href="#l29.207"></a><span id="l29.207">       print(&quot;... got &quot; + i + &quot;: &quot; + obs._result.getValueAt(i));</span>
<a href="#l29.208"></a><span id="l29.208">     }</span>
<a href="#l29.209"></a><span id="l29.209"> </span>
<a href="#l29.210"></a><span id="l29.210" class="difflineminus">-    for (var i = 0; i &lt; element.expected.length; i++) {</span>
<a href="#l29.211"></a><span id="l29.211" class="difflineplus">+    for (let i = 0; i &lt; element.expected.length; i++) {</span>
<a href="#l29.212"></a><span id="l29.212">       print(&quot;... expected &quot; + i + &quot; (result &quot; + element.expected[i] + &quot;): &quot; +</span>
<a href="#l29.213"></a><span id="l29.213">             results[element.expected[i]].email);</span>
<a href="#l29.214"></a><span id="l29.214">     }</span>
<a href="#l29.215"></a><span id="l29.215"> </span>
<a href="#l29.216"></a><span id="l29.216">     Assert.equal(obs._search, acs);</span>
<a href="#l29.217"></a><span id="l29.217">     Assert.equal(obs._result.searchString, element.search);</span>
<a href="#l29.218"></a><span id="l29.218">     Assert.equal(obs._result.searchResult, ACR.RESULT_SUCCESS);</span>
<a href="#l29.219"></a><span id="l29.219">     Assert.equal(obs._result.errorDescription, null);</span>
<a href="#l29.220"></a><span id="l29.220">     Assert.equal(obs._result.matchCount, element.expected.length);</span>
<a href="#l29.221"></a><span id="l29.221">     Assert.equal(obs._result.defaultIndex, 0);</span>
<a href="#l29.222"></a><span id="l29.222"> </span>
<a href="#l29.223"></a><span id="l29.223" class="difflineminus">-    for (var i = 0; i &lt; element.expected.length; ++i) {</span>
<a href="#l29.224"></a><span id="l29.224" class="difflineplus">+    for (let i = 0; i &lt; element.expected.length; ++i) {</span>
<a href="#l29.225"></a><span id="l29.225">       Assert.equal(obs._result.getValueAt(i), results[element.expected[i]].email);</span>
<a href="#l29.226"></a><span id="l29.226">       Assert.equal(obs._result.getLabelAt(i), results[element.expected[i]].email);</span>
<a href="#l29.227"></a><span id="l29.227">       Assert.equal(obs._result.getCommentAt(i), results[element.expected[i]].dirName);</span>
<a href="#l29.228"></a><span id="l29.228">       Assert.equal(obs._result.getStyleAt(i), &quot;local-abook&quot;);</span>
<a href="#l29.229"></a><span id="l29.229">       Assert.equal(obs._result.getImageAt(i), &quot;&quot;);</span>
<a href="#l29.230"></a><span id="l29.230">     }</span>
<a href="#l29.231"></a><span id="l29.231">   }</span>
<a href="#l29.232"></a><span id="l29.232">   function checkInputSet(element, index, array) {</span>
<a href="#l29.233"></a><span id="l29.233" class="difflineat">@@ -420,9 +418,9 @@ function run_test() {</span>
<a href="#l29.234"></a><span id="l29.234">   const popularitySearch = [ { search: &quot;d&quot;,      expected: [1, 4, 2, 3, 0, 5, 9] },</span>
<a href="#l29.235"></a><span id="l29.235">                              { search: &quot;di&quot;,     expected: [1, 4, 2, 3, 5] },</span>
<a href="#l29.236"></a><span id="l29.236">                              { search: &quot;dis&quot;,    expected: [4, 2, 3, 5] },</span>
<a href="#l29.237"></a><span id="l29.237">                              { search: &quot;disp&quot;,   expected: [4, 3, 5] },</span>
<a href="#l29.238"></a><span id="l29.238">                              { search: &quot;displ&quot;,  expected: [4, 5] },</span>
<a href="#l29.239"></a><span id="l29.239">                              { search: &quot;displa&quot;, expected: [5] } ];</span>
<a href="#l29.240"></a><span id="l29.240"> </span>
<a href="#l29.241"></a><span id="l29.241">   popularitySearch.forEach(checkInputItem);</span>
<a href="#l29.242"></a><span id="l29.242" class="difflineminus">-};</span>
<a href="#l29.243"></a><span id="l29.243" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch2.js</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch2.js</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -3,17 +3,19 @@</span>
<a href="#l30.4"></a><span id="l30.4">  * Second Test suite for nsAbAutoCompleteSearch - test follow-on lookup after</span>
<a href="#l30.5"></a><span id="l30.5">  * a previous search.</span>
<a href="#l30.6"></a><span id="l30.6">  *</span>
<a href="#l30.7"></a><span id="l30.7">  * We run this test without address books, constructing manually ourselves,</span>
<a href="#l30.8"></a><span id="l30.8">  * so that we can ensure that we're not getting the data out of the address</span>
<a href="#l30.9"></a><span id="l30.9">  * books.</span>
<a href="#l30.10"></a><span id="l30.10">  */</span>
<a href="#l30.11"></a><span id="l30.11"> </span>
<a href="#l30.12"></a><span id="l30.12" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/ABQueryUtils.jsm&quot;);</span>
<a href="#l30.13"></a><span id="l30.13" class="difflineplus">+var {</span>
<a href="#l30.14"></a><span id="l30.14" class="difflineplus">+  getModelQuery,</span>
<a href="#l30.15"></a><span id="l30.15" class="difflineplus">+} = ChromeUtils.import(&quot;resource:///modules/ABQueryUtils.jsm&quot;, null);</span>
<a href="#l30.16"></a><span id="l30.16"> </span>
<a href="#l30.17"></a><span id="l30.17"> // taken from nsAbAutoCompleteSearch.js</span>
<a href="#l30.18"></a><span id="l30.18"> var ACR = Ci.nsIAutoCompleteResult;</span>
<a href="#l30.19"></a><span id="l30.19"> var nsIAbAutoCompleteResult = Ci.nsIAbAutoCompleteResult;</span>
<a href="#l30.20"></a><span id="l30.20"> </span>
<a href="#l30.21"></a><span id="l30.21"> function nsAbAutoCompleteResult(aSearchString) {</span>
<a href="#l30.22"></a><span id="l30.22">   // Can't create this in the prototype as we'd get the same array for</span>
<a href="#l30.23"></a><span id="l30.23">   // all instances</span>
<a href="#l30.24"></a><span id="l30.24" class="difflineat">@@ -52,17 +54,17 @@ nsAbAutoCompleteResult.prototype = {</span>
<a href="#l30.25"></a><span id="l30.25">   getStyleAt: function getStyleAt(aIndex) {</span>
<a href="#l30.26"></a><span id="l30.26">     return &quot;local-abook&quot;;</span>
<a href="#l30.27"></a><span id="l30.27">   },</span>
<a href="#l30.28"></a><span id="l30.28"> </span>
<a href="#l30.29"></a><span id="l30.29">   getImageAt: function getImageAt(aIndex) {</span>
<a href="#l30.30"></a><span id="l30.30">     return &quot;&quot;;</span>
<a href="#l30.31"></a><span id="l30.31">   },</span>
<a href="#l30.32"></a><span id="l30.32"> </span>
<a href="#l30.33"></a><span id="l30.33" class="difflineminus">-  getFinalCompleteValueAt: function(aIndex) {</span>
<a href="#l30.34"></a><span id="l30.34" class="difflineplus">+  getFinalCompleteValueAt(aIndex) {</span>
<a href="#l30.35"></a><span id="l30.35">     return this.getValueAt(aIndex);</span>
<a href="#l30.36"></a><span id="l30.36">   },</span>
<a href="#l30.37"></a><span id="l30.37"> </span>
<a href="#l30.38"></a><span id="l30.38">   removeValueAt: function removeValueAt(aRowIndex, aRemoveFromDB) {</span>
<a href="#l30.39"></a><span id="l30.39">   },</span>
<a href="#l30.40"></a><span id="l30.40"> </span>
<a href="#l30.41"></a><span id="l30.41">   // nsIAbAutoCompleteResult</span>
<a href="#l30.42"></a><span id="l30.42"> </span>
<a href="#l30.43"></a><span id="l30.43" class="difflineat">@@ -72,85 +74,54 @@ nsAbAutoCompleteResult.prototype = {</span>
<a href="#l30.44"></a><span id="l30.44"> </span>
<a href="#l30.45"></a><span id="l30.45">   getEmailToUse: function getEmailToUse(aIndex) {</span>
<a href="#l30.46"></a><span id="l30.46">     // For this test we can just use the primary email here.</span>
<a href="#l30.47"></a><span id="l30.47">     return this._searchResults[aIndex].card.primaryEmail;</span>
<a href="#l30.48"></a><span id="l30.48">   },</span>
<a href="#l30.49"></a><span id="l30.49"> </span>
<a href="#l30.50"></a><span id="l30.50">   // nsISupports</span>
<a href="#l30.51"></a><span id="l30.51"> </span>
<a href="#l30.52"></a><span id="l30.52" class="difflineminus">-  QueryInterface: ChromeUtils.generateQI([ACR, nsIAbAutoCompleteResult])</span>
<a href="#l30.53"></a><span id="l30.53" class="difflineminus">-}</span>
<a href="#l30.54"></a><span id="l30.54" class="difflineplus">+  QueryInterface: ChromeUtils.generateQI([ACR, nsIAbAutoCompleteResult]),</span>
<a href="#l30.55"></a><span id="l30.55" class="difflineplus">+};</span>
<a href="#l30.56"></a><span id="l30.56"> </span>
<a href="#l30.57"></a><span id="l30.57"> function createCard(chars, popularity) {</span>
<a href="#l30.58"></a><span id="l30.58">   var card = Cc[&quot;@mozilla.org/addressbook/cardproperty;1&quot;]</span>
<a href="#l30.59"></a><span id="l30.59">                .createInstance(Ci.nsIAbCard);</span>
<a href="#l30.60"></a><span id="l30.60"> </span>
<a href="#l30.61"></a><span id="l30.61">   card.firstName = &quot;firstName&quot;.slice(0, chars);</span>
<a href="#l30.62"></a><span id="l30.62">   card.lastName = &quot;lastName&quot;.slice(0, chars);</span>
<a href="#l30.63"></a><span id="l30.63">   card.displayName = &quot;displayName&quot;.slice(0, chars);</span>
<a href="#l30.64"></a><span id="l30.64">   card.primaryEmail = &quot;email&quot;.slice(0, chars) + &quot;@foo.invalid&quot;;</span>
<a href="#l30.65"></a><span id="l30.65">   card.setProperty(&quot;NickName&quot;, &quot;nickName&quot;.slice(0, chars));</span>
<a href="#l30.66"></a><span id="l30.66"> </span>
<a href="#l30.67"></a><span id="l30.67">   return card;</span>
<a href="#l30.68"></a><span id="l30.68"> }</span>
<a href="#l30.69"></a><span id="l30.69"> </span>
<a href="#l30.70"></a><span id="l30.70" class="difflineminus">-var lastSearchCards = [ createCard(1, 0), createCard(2, 0), createCard(3, 0) ];</span>
<a href="#l30.71"></a><span id="l30.71" class="difflineminus">-</span>
<a href="#l30.72"></a><span id="l30.72"> var results = [ { email: &quot;d &lt;e@foo.invalid&gt;&quot;, dirName: kPABData.dirName },</span>
<a href="#l30.73"></a><span id="l30.73">                   { email: &quot;di &lt;em@foo.invalid&gt;&quot;, dirName: kPABData.dirName },</span>
<a href="#l30.74"></a><span id="l30.74">                   { email: &quot;dis &lt;ema@foo.invalid&gt;&quot;, dirName: kPABData.dirName } ];</span>
<a href="#l30.75"></a><span id="l30.75"> </span>
<a href="#l30.76"></a><span id="l30.76"> var firstNames = [ { search: &quot;fi&quot;,     expected: [1, 2] },</span>
<a href="#l30.77"></a><span id="l30.77">                      { search: &quot;fir&quot;,    expected: [2] } ];</span>
<a href="#l30.78"></a><span id="l30.78"> </span>
<a href="#l30.79"></a><span id="l30.79"> var lastNames = [ { search: &quot;la&quot;,     expected: [1, 2] },</span>
<a href="#l30.80"></a><span id="l30.80">                     { search: &quot;las&quot;,    expected: [2] } ];</span>
<a href="#l30.81"></a><span id="l30.81"> </span>
<a href="#l30.82"></a><span id="l30.82" class="difflineminus">-var displayNames = [ { search: &quot;d&quot;,      expected: [5, 0, 1, 2, 3, 4] },</span>
<a href="#l30.83"></a><span id="l30.83" class="difflineminus">-                       { search: &quot;di&quot;,     expected: [5, 1, 2, 3, 4] },</span>
<a href="#l30.84"></a><span id="l30.84" class="difflineminus">-                       { search: &quot;dis&quot;,    expected: [5, 2, 3, 4] },</span>
<a href="#l30.85"></a><span id="l30.85" class="difflineminus">-                       { search: &quot;disp&quot;,   expected: [5, 3, 4]},</span>
<a href="#l30.86"></a><span id="l30.86" class="difflineminus">-                       { search: &quot;displ&quot;,  expected: [5, 4]},</span>
<a href="#l30.87"></a><span id="l30.87" class="difflineminus">-                       { search: &quot;displa&quot;, expected: [5]} ];</span>
<a href="#l30.88"></a><span id="l30.88" class="difflineminus">-</span>
<a href="#l30.89"></a><span id="l30.89" class="difflineminus">-var nickNames = [ { search: &quot;n&quot;,      expected: [5, 0, 1, 2, 3, 4] },</span>
<a href="#l30.90"></a><span id="l30.90" class="difflineminus">-                    { search: &quot;ni&quot;,     expected: [5, 0, 1, 2, 3] },</span>
<a href="#l30.91"></a><span id="l30.91" class="difflineminus">-                    { search: &quot;nic&quot;,    expected: [5, 1, 2, 3] },</span>
<a href="#l30.92"></a><span id="l30.92" class="difflineminus">-                    { search: &quot;nick&quot;,   expected: [5, 2, 3] },</span>
<a href="#l30.93"></a><span id="l30.93" class="difflineminus">-                    { search: &quot;nickn&quot;,  expected: [5, 3] },</span>
<a href="#l30.94"></a><span id="l30.94" class="difflineminus">-                    { search: &quot;nickna&quot;, expected: [5] } ];</span>
<a href="#l30.95"></a><span id="l30.95" class="difflineminus">-</span>
<a href="#l30.96"></a><span id="l30.96" class="difflineminus">-var emails = [ { search: &quot;e&quot;,     expected: [0, 1, 2, 3, 4] },</span>
<a href="#l30.97"></a><span id="l30.97" class="difflineminus">-                 { search: &quot;em&quot;,    expected: [0, 1, 2, 4] },</span>
<a href="#l30.98"></a><span id="l30.98" class="difflineminus">-                 { search: &quot;ema&quot;,   expected: [0, 1, 2] },</span>
<a href="#l30.99"></a><span id="l30.99" class="difflineminus">-                 { search: &quot;emai&quot;,  expected: [1, 2] },</span>
<a href="#l30.100"></a><span id="l30.100" class="difflineminus">-                 { search: &quot;email&quot;, expected: [2] } ];</span>
<a href="#l30.101"></a><span id="l30.101" class="difflineminus">-</span>
<a href="#l30.102"></a><span id="l30.102" class="difflineminus">-// &quot;l&quot; case tested above</span>
<a href="#l30.103"></a><span id="l30.103" class="difflineminus">-var lists = [ { search: &quot;li&quot;, expected: [6, 7, 8] },</span>
<a href="#l30.104"></a><span id="l30.104" class="difflineminus">-                { search: &quot;lis&quot;, expected: [6, 7] },</span>
<a href="#l30.105"></a><span id="l30.105" class="difflineminus">-                { search: &quot;list&quot;, expected: [6] },</span>
<a href="#l30.106"></a><span id="l30.106" class="difflineminus">-                { search: &quot;t&quot;, expected: [6, 7, 8, 9] },</span>
<a href="#l30.107"></a><span id="l30.107" class="difflineminus">-                { search: &quot;te&quot;, expected: [7, 8, 9] },</span>
<a href="#l30.108"></a><span id="l30.108" class="difflineminus">-                { search: &quot;tes&quot;, expected: [8, 9] },</span>
<a href="#l30.109"></a><span id="l30.109" class="difflineminus">-                { search: &quot;test&quot;, expected: [9] } ];</span>
<a href="#l30.110"></a><span id="l30.110" class="difflineminus">-</span>
<a href="#l30.111"></a><span id="l30.111" class="difflineminus">-var inputs = [ firstNames, lastNames];//, displayNames, nickNames, emails, lists ];</span>
<a href="#l30.112"></a><span id="l30.112" class="difflineplus">+var inputs = [firstNames, lastNames];</span>
<a href="#l30.113"></a><span id="l30.113"> </span>
<a href="#l30.114"></a><span id="l30.114"> function acObserver() {}</span>
<a href="#l30.115"></a><span id="l30.115"> </span>
<a href="#l30.116"></a><span id="l30.116"> acObserver.prototype = {</span>
<a href="#l30.117"></a><span id="l30.117">   _search: null,</span>
<a href="#l30.118"></a><span id="l30.118">   _result: null,</span>
<a href="#l30.119"></a><span id="l30.119"> </span>
<a href="#l30.120"></a><span id="l30.120" class="difflineminus">-  onSearchResult: function (aSearch, aResult) {</span>
<a href="#l30.121"></a><span id="l30.121" class="difflineplus">+  onSearchResult(aSearch, aResult) {</span>
<a href="#l30.122"></a><span id="l30.122">     this._search = aSearch;</span>
<a href="#l30.123"></a><span id="l30.123">     this._result = aResult;</span>
<a href="#l30.124"></a><span id="l30.124" class="difflineminus">-  }</span>
<a href="#l30.125"></a><span id="l30.125" class="difflineplus">+  },</span>
<a href="#l30.126"></a><span id="l30.126"> };</span>
<a href="#l30.127"></a><span id="l30.127"> </span>
<a href="#l30.128"></a><span id="l30.128"> function run_test() {</span>
<a href="#l30.129"></a><span id="l30.129">   // Test - Create a new search component</span>
<a href="#l30.130"></a><span id="l30.130"> </span>
<a href="#l30.131"></a><span id="l30.131">   var acs = Cc[&quot;@mozilla.org/autocomplete/search;1?name=addrbook&quot;]</span>
<a href="#l30.132"></a><span id="l30.132">     .getService(Ci.nsIAutoCompleteSearch);</span>
<a href="#l30.133"></a><span id="l30.133"> </span>
<a href="#l30.134"></a><span id="l30.134" class="difflineat">@@ -161,43 +132,43 @@ function run_test() {</span>
<a href="#l30.135"></a><span id="l30.135"> </span>
<a href="#l30.136"></a><span id="l30.136">   // Make up the last autocomplete result</span>
<a href="#l30.137"></a><span id="l30.137">   var lastResult = new nsAbAutoCompleteResult();</span>
<a href="#l30.138"></a><span id="l30.138"> </span>
<a href="#l30.139"></a><span id="l30.139">   lastResult.searchString = &quot;&quot;;</span>
<a href="#l30.140"></a><span id="l30.140">   lastResult.searchResult = ACR.RESULT_SUCCESS;</span>
<a href="#l30.141"></a><span id="l30.141">   lastResult.defaultIndex = 0;</span>
<a href="#l30.142"></a><span id="l30.142">   lastResult.errorDescription = null;</span>
<a href="#l30.143"></a><span id="l30.143" class="difflineminus">-  for (var i = 0; i &lt; results.length; ++i) {</span>
<a href="#l30.144"></a><span id="l30.144" class="difflineplus">+  for (let i = 0; i &lt; results.length; ++i) {</span>
<a href="#l30.145"></a><span id="l30.145">     lastResult._searchResults.push({</span>
<a href="#l30.146"></a><span id="l30.146">       value: results[i].email,</span>
<a href="#l30.147"></a><span id="l30.147">       comment: results[i].dirName,</span>
<a href="#l30.148"></a><span id="l30.148" class="difflineminus">-      card: createCard(i + 1, 0)</span>
<a href="#l30.149"></a><span id="l30.149" class="difflineplus">+      card: createCard(i + 1, 0),</span>
<a href="#l30.150"></a><span id="l30.150">     });</span>
<a href="#l30.151"></a><span id="l30.151">   }</span>
<a href="#l30.152"></a><span id="l30.152"> </span>
<a href="#l30.153"></a><span id="l30.153"> </span>
<a href="#l30.154"></a><span id="l30.154">   // Test - Matches</span>
<a href="#l30.155"></a><span id="l30.155"> </span>
<a href="#l30.156"></a><span id="l30.156">   // Now check multiple matches</span>
<a href="#l30.157"></a><span id="l30.157">   function checkInputItem(element, index, array) {</span>
<a href="#l30.158"></a><span id="l30.158">     acs.startSearch(element.search, JSON.stringify({ type: &quot;addr_to&quot;, idKey: &quot;&quot; }), lastResult, obs);</span>
<a href="#l30.159"></a><span id="l30.159"> </span>
<a href="#l30.160"></a><span id="l30.160">     Assert.equal(obs._search, acs);</span>
<a href="#l30.161"></a><span id="l30.161">     Assert.equal(obs._result.searchString, element.search);</span>
<a href="#l30.162"></a><span id="l30.162">     Assert.equal(obs._result.searchResult, ACR.RESULT_SUCCESS);</span>
<a href="#l30.163"></a><span id="l30.163">     Assert.equal(obs._result.errorDescription, null);</span>
<a href="#l30.164"></a><span id="l30.164">     Assert.equal(obs._result.matchCount, element.expected.length);</span>
<a href="#l30.165"></a><span id="l30.165"> </span>
<a href="#l30.166"></a><span id="l30.166" class="difflineminus">-    for (var i = 0; i &lt; element.expected.length; ++i) {</span>
<a href="#l30.167"></a><span id="l30.167" class="difflineplus">+    for (let i = 0; i &lt; element.expected.length; ++i) {</span>
<a href="#l30.168"></a><span id="l30.168">       Assert.equal(obs._result.getValueAt(i), results[element.expected[i]].email);</span>
<a href="#l30.169"></a><span id="l30.169">       Assert.equal(obs._result.getLabelAt(i), results[element.expected[i]].email);</span>
<a href="#l30.170"></a><span id="l30.170">       Assert.equal(obs._result.getCommentAt(i), results[element.expected[i]].dirName);</span>
<a href="#l30.171"></a><span id="l30.171">       Assert.equal(obs._result.getStyleAt(i), &quot;local-abook&quot;);</span>
<a href="#l30.172"></a><span id="l30.172">       Assert.equal(obs._result.getImageAt(i), &quot;&quot;);</span>
<a href="#l30.173"></a><span id="l30.173">     }</span>
<a href="#l30.174"></a><span id="l30.174">   }</span>
<a href="#l30.175"></a><span id="l30.175">   function checkInputSet(element, index, array) {</span>
<a href="#l30.176"></a><span id="l30.176">     element.forEach(checkInputItem);</span>
<a href="#l30.177"></a><span id="l30.177">   }</span>
<a href="#l30.178"></a><span id="l30.178"> </span>
<a href="#l30.179"></a><span id="l30.179">   inputs.forEach(checkInputSet);</span>
<a href="#l30.180"></a><span id="l30.180" class="difflineminus">-};</span>
<a href="#l30.181"></a><span id="l30.181" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch3.js</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch3.js</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -21,40 +21,39 @@ var cards = [</span>
<a href="#l31.4"></a><span id="l31.4">   { email: &quot;foo2@foo.invalid&quot;, displayName: &quot;di&quot;,</span>
<a href="#l31.5"></a><span id="l31.5">     popularityIndex: 3, firstName: &quot;first2&quot;, value: &quot;di &lt;foo2@foo.invalid&gt;&quot; },</span>
<a href="#l31.6"></a><span id="l31.6">   // this just tests we can search for the special chars '(' and ')', bug 749097</span>
<a href="#l31.7"></a><span id="l31.7">   { email: &quot;bracket@not.invalid&quot;, secondEmail: &quot;h@not.invalid&quot;, firstName: &quot;Mr.&quot;,</span>
<a href="#l31.8"></a><span id="l31.8">     displayName: &quot;Mr. (Bracket)&quot;, value: &quot;Mr. (Bracket) &lt;bracket@not.invalid&gt;&quot;,</span>
<a href="#l31.9"></a><span id="l31.9">     popularityIndex: 2 },</span>
<a href="#l31.10"></a><span id="l31.10">   { email: &quot;mr@(bracket).not.invalid&quot;, secondEmail: &quot;bracket@not.invalid&quot;,  firstName: &quot;Mr.&quot;,</span>
<a href="#l31.11"></a><span id="l31.11">     displayName: &quot;Mr. Bracket&quot;, value: &quot;Mr. Bracket &lt;mr@(bracket).not.invalid&gt;&quot;,</span>
<a href="#l31.12"></a><span id="l31.12" class="difflineminus">-    popularityIndex: 1 }</span>
<a href="#l31.13"></a><span id="l31.13" class="difflineplus">+    popularityIndex: 1 },</span>
<a href="#l31.14"></a><span id="l31.14"> ];</span>
<a href="#l31.15"></a><span id="l31.15"> </span>
<a href="#l31.16"></a><span id="l31.16"> var duplicates = [</span>
<a href="#l31.17"></a><span id="l31.17">   { search: &quot;test&quot;, expected: [1, 2] },</span>
<a href="#l31.18"></a><span id="l31.18">   { search: &quot;first&quot;, expected: [6, 5, 3] },</span>
<a href="#l31.19"></a><span id="l31.19" class="difflineminus">-  { search: &quot;(bracket)&quot;, expected: [7, 8] }</span>
<a href="#l31.20"></a><span id="l31.20" class="difflineplus">+  { search: &quot;(bracket)&quot;, expected: [7, 8] },</span>
<a href="#l31.21"></a><span id="l31.21"> ];</span>
<a href="#l31.22"></a><span id="l31.22"> </span>
<a href="#l31.23"></a><span id="l31.23"> </span>
<a href="#l31.24"></a><span id="l31.24"> function acObserver() {}</span>
<a href="#l31.25"></a><span id="l31.25"> </span>
<a href="#l31.26"></a><span id="l31.26"> acObserver.prototype = {</span>
<a href="#l31.27"></a><span id="l31.27">   _search: null,</span>
<a href="#l31.28"></a><span id="l31.28">   _result: null,</span>
<a href="#l31.29"></a><span id="l31.29"> </span>
<a href="#l31.30"></a><span id="l31.30" class="difflineminus">-  onSearchResult: function (aSearch, aResult) {</span>
<a href="#l31.31"></a><span id="l31.31" class="difflineplus">+  onSearchResult(aSearch, aResult) {</span>
<a href="#l31.32"></a><span id="l31.32">     this._search = aSearch;</span>
<a href="#l31.33"></a><span id="l31.33">     this._result = aResult;</span>
<a href="#l31.34"></a><span id="l31.34" class="difflineminus">-  }</span>
<a href="#l31.35"></a><span id="l31.35" class="difflineplus">+  },</span>
<a href="#l31.36"></a><span id="l31.36"> };</span>
<a href="#l31.37"></a><span id="l31.37"> </span>
<a href="#l31.38"></a><span id="l31.38" class="difflineminus">-function run_test()</span>
<a href="#l31.39"></a><span id="l31.39" class="difflineminus">-{</span>
<a href="#l31.40"></a><span id="l31.40" class="difflineplus">+function run_test() {</span>
<a href="#l31.41"></a><span id="l31.41">   // We set up the cards for this test manually as it is easier to set the</span>
<a href="#l31.42"></a><span id="l31.42">   // popularity index and we don't need many.</span>
<a href="#l31.43"></a><span id="l31.43"> </span>
<a href="#l31.44"></a><span id="l31.44">   // Ensure all the directories are initialised.</span>
<a href="#l31.45"></a><span id="l31.45">   MailServices.ab.directories;</span>
<a href="#l31.46"></a><span id="l31.46"> </span>
<a href="#l31.47"></a><span id="l31.47">   let ab = MailServices.ab.getDirectory(kPABData.URI);</span>
<a href="#l31.48"></a><span id="l31.48"> </span>
<a href="#l31.49"></a><span id="l31.49" class="difflineat">@@ -78,32 +77,32 @@ function run_test()</span>
<a href="#l31.50"></a><span id="l31.50">     .getService(Ci.nsIAutoCompleteSearch);</span>
<a href="#l31.51"></a><span id="l31.51"> </span>
<a href="#l31.52"></a><span id="l31.52">   var obs = new acObserver();</span>
<a href="#l31.53"></a><span id="l31.53"> </span>
<a href="#l31.54"></a><span id="l31.54">   function checkInputItem(element, index, array) {</span>
<a href="#l31.55"></a><span id="l31.55">     print(&quot;Search #&quot; + index + &quot;: search=&quot; + element.search);</span>
<a href="#l31.56"></a><span id="l31.56">     acs.startSearch(element.search, JSON.stringify({ type: &quot;addr_to&quot;  }), null, obs);</span>
<a href="#l31.57"></a><span id="l31.57"> </span>
<a href="#l31.58"></a><span id="l31.58" class="difflineminus">-    for (var i = 0; i &lt; obs._result.matchCount; i++) {</span>
<a href="#l31.59"></a><span id="l31.59" class="difflineplus">+    for (let i = 0; i &lt; obs._result.matchCount; i++) {</span>
<a href="#l31.60"></a><span id="l31.60">       print(&quot;... got &quot; + i + &quot;: &quot; + obs._result.getValueAt(i));</span>
<a href="#l31.61"></a><span id="l31.61">     }</span>
<a href="#l31.62"></a><span id="l31.62"> </span>
<a href="#l31.63"></a><span id="l31.63" class="difflineminus">-    for (var i = 0; i &lt; element.expected.length; i++) {</span>
<a href="#l31.64"></a><span id="l31.64" class="difflineplus">+    for (let i = 0; i &lt; element.expected.length; i++) {</span>
<a href="#l31.65"></a><span id="l31.65">       print(&quot;... expected &quot; + i + &quot; (card &quot; + element.expected[i] + &quot;): &quot; +</span>
<a href="#l31.66"></a><span id="l31.66">             cards[element.expected[i]].value);</span>
<a href="#l31.67"></a><span id="l31.67">     }</span>
<a href="#l31.68"></a><span id="l31.68"> </span>
<a href="#l31.69"></a><span id="l31.69">     Assert.equal(obs._search, acs);</span>
<a href="#l31.70"></a><span id="l31.70">     Assert.equal(obs._result.searchString, element.search);</span>
<a href="#l31.71"></a><span id="l31.71">     Assert.equal(obs._result.searchResult, ACR.RESULT_SUCCESS);</span>
<a href="#l31.72"></a><span id="l31.72">     Assert.equal(obs._result.errorDescription, null);</span>
<a href="#l31.73"></a><span id="l31.73">     Assert.equal(obs._result.matchCount, element.expected.length);</span>
<a href="#l31.74"></a><span id="l31.74"> </span>
<a href="#l31.75"></a><span id="l31.75" class="difflineminus">-    for (var i = 0; i &lt; element.expected.length; ++i) {</span>
<a href="#l31.76"></a><span id="l31.76" class="difflineplus">+    for (let i = 0; i &lt; element.expected.length; ++i) {</span>
<a href="#l31.77"></a><span id="l31.77">       Assert.equal(obs._result.getValueAt(i), cards[element.expected[i]].value);</span>
<a href="#l31.78"></a><span id="l31.78">       Assert.equal(obs._result.getLabelAt(i), cards[element.expected[i]].value);</span>
<a href="#l31.79"></a><span id="l31.79">       Assert.equal(obs._result.getCommentAt(i), &quot;&quot;);</span>
<a href="#l31.80"></a><span id="l31.80">       Assert.equal(obs._result.getStyleAt(i), &quot;local-abook&quot;);</span>
<a href="#l31.81"></a><span id="l31.81">       Assert.equal(obs._result.getImageAt(i), &quot;&quot;);</span>
<a href="#l31.82"></a><span id="l31.82">       obs._result.QueryInterface(Ci.nsIAbAutoCompleteResult);</span>
<a href="#l31.83"></a><span id="l31.83">       Assert.equal(obs._result.getCardAt(i).firstName,</span>
<a href="#l31.84"></a><span id="l31.84">                    cards[element.expected[i]].firstName);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch4.js</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch4.js</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -29,17 +29,17 @@ var cards = [</span>
<a href="#l32.4"></a><span id="l32.4">     displayName: &quot;2testsort&quot; },</span>
<a href="#l32.5"></a><span id="l32.5">   { email: &quot;d@test.invalid&quot;, secondEmail: &quot;e@test.invalid&quot;,</span>
<a href="#l32.6"></a><span id="l32.6">     displayName: &quot;2testsort&quot; },</span>
<a href="#l32.7"></a><span id="l32.7">   { email: &quot;g@test.invalid&quot;, secondEmail: &quot;f@test.invalid&quot;,</span>
<a href="#l32.8"></a><span id="l32.8">     displayName: &quot;3testsort&quot;, popularityIndex: 3 },</span>
<a href="#l32.9"></a><span id="l32.9">   { email: &quot;j@test.invalid&quot;, secondEmail: &quot;h@test.invalid&quot;,</span>
<a href="#l32.10"></a><span id="l32.10">     displayName: &quot;3testsort&quot;, popularityIndex: 5 },</span>
<a href="#l32.11"></a><span id="l32.11">   // Add a contact that matches, but has no email. Should not show up.</span>
<a href="#l32.12"></a><span id="l32.12" class="difflineminus">-  { displayName: &quot;primaryX&quot; }</span>
<a href="#l32.13"></a><span id="l32.13" class="difflineplus">+  { displayName: &quot;primaryX&quot; },</span>
<a href="#l32.14"></a><span id="l32.14"> ];</span>
<a href="#l32.15"></a><span id="l32.15"> </span>
<a href="#l32.16"></a><span id="l32.16"> // These are for the initial search</span>
<a href="#l32.17"></a><span id="l32.17"> var searches = [ &quot;primary&quot;, &quot;second&quot;, &quot;firstName&quot;, &quot;thename&quot;, &quot;sortbasic&quot;,</span>
<a href="#l32.18"></a><span id="l32.18">                    &quot;testsort&quot;, &quot;2testsort&quot;, &quot;3testsort&quot; ];</span>
<a href="#l32.19"></a><span id="l32.19"> </span>
<a href="#l32.20"></a><span id="l32.20"> var expectedResults = [ [ &quot;primary@test.invalid&quot;,</span>
<a href="#l32.21"></a><span id="l32.21">                             &quot;second@test.invalid&quot;], // searching for primary/second returns</span>
<a href="#l32.22"></a><span id="l32.22" class="difflineat">@@ -86,24 +86,23 @@ var reductionExpectedResults = [ [ &quot;bar1</span>
<a href="#l32.23"></a><span id="l32.23">                                    [ &quot;boo2@test.invalid&quot; ] ];</span>
<a href="#l32.24"></a><span id="l32.24"> </span>
<a href="#l32.25"></a><span id="l32.25"> function acObserver() {}</span>
<a href="#l32.26"></a><span id="l32.26"> </span>
<a href="#l32.27"></a><span id="l32.27"> acObserver.prototype = {</span>
<a href="#l32.28"></a><span id="l32.28">   _search: null,</span>
<a href="#l32.29"></a><span id="l32.29">   _result: null,</span>
<a href="#l32.30"></a><span id="l32.30"> </span>
<a href="#l32.31"></a><span id="l32.31" class="difflineminus">-  onSearchResult: function (aSearch, aResult) {</span>
<a href="#l32.32"></a><span id="l32.32" class="difflineplus">+  onSearchResult(aSearch, aResult) {</span>
<a href="#l32.33"></a><span id="l32.33">     this._search = aSearch;</span>
<a href="#l32.34"></a><span id="l32.34">     this._result = aResult;</span>
<a href="#l32.35"></a><span id="l32.35" class="difflineminus">-  }</span>
<a href="#l32.36"></a><span id="l32.36" class="difflineplus">+  },</span>
<a href="#l32.37"></a><span id="l32.37"> };</span>
<a href="#l32.38"></a><span id="l32.38"> </span>
<a href="#l32.39"></a><span id="l32.39" class="difflineminus">-function run_test()</span>
<a href="#l32.40"></a><span id="l32.40" class="difflineminus">-{</span>
<a href="#l32.41"></a><span id="l32.41" class="difflineplus">+function run_test() {</span>
<a href="#l32.42"></a><span id="l32.42">   // We set up the cards for this test manually as it is easier to set the</span>
<a href="#l32.43"></a><span id="l32.43">   // popularity index and we don't need many.</span>
<a href="#l32.44"></a><span id="l32.44"> </span>
<a href="#l32.45"></a><span id="l32.45">   // Ensure all the directories are initialised.</span>
<a href="#l32.46"></a><span id="l32.46">   MailServices.ab.directories;</span>
<a href="#l32.47"></a><span id="l32.47"> </span>
<a href="#l32.48"></a><span id="l32.48">   let ab = MailServices.ab.getDirectory(kPABData.URI);</span>
<a href="#l32.49"></a><span id="l32.49"> </span>
<a href="#l32.50"></a><span id="l32.50" class="difflineat">@@ -130,27 +129,27 @@ function run_test()</span>
<a href="#l32.51"></a><span id="l32.51">   var obs = new acObserver();</span>
<a href="#l32.52"></a><span id="l32.52"> </span>
<a href="#l32.53"></a><span id="l32.53">   print(&quot;Checking Initial Searches&quot;);</span>
<a href="#l32.54"></a><span id="l32.54"> </span>
<a href="#l32.55"></a><span id="l32.55">   function checkSearch(element, index, array) {</span>
<a href="#l32.56"></a><span id="l32.56">     print(&quot;Search #&quot; + index + &quot;: search=&quot; + element);</span>
<a href="#l32.57"></a><span id="l32.57">     acs.startSearch(element, JSON.stringify({ type: &quot;addr_to&quot;, idKey: &quot;&quot; }), null, obs);</span>
<a href="#l32.58"></a><span id="l32.58"> </span>
<a href="#l32.59"></a><span id="l32.59" class="difflineminus">-    for (var i = 0; i &lt; obs._result.matchCount; i++) {</span>
<a href="#l32.60"></a><span id="l32.60" class="difflineplus">+    for (let i = 0; i &lt; obs._result.matchCount; i++) {</span>
<a href="#l32.61"></a><span id="l32.61">       print(&quot;... got &quot; + i + &quot;: &quot; + obs._result.getValueAt(i));</span>
<a href="#l32.62"></a><span id="l32.62">     }</span>
<a href="#l32.63"></a><span id="l32.63"> </span>
<a href="#l32.64"></a><span id="l32.64">     Assert.equal(obs._search, acs);</span>
<a href="#l32.65"></a><span id="l32.65">     Assert.equal(obs._result.searchString, element);</span>
<a href="#l32.66"></a><span id="l32.66">     Assert.equal(obs._result.searchResult, ACR.RESULT_SUCCESS);</span>
<a href="#l32.67"></a><span id="l32.67">     Assert.equal(obs._result.errorDescription, null);</span>
<a href="#l32.68"></a><span id="l32.68">     Assert.equal(obs._result.matchCount, expectedResults[index].length);</span>
<a href="#l32.69"></a><span id="l32.69"> </span>
<a href="#l32.70"></a><span id="l32.70" class="difflineminus">-    for (var i = 0; i &lt; expectedResults[index].length; ++i) {</span>
<a href="#l32.71"></a><span id="l32.71" class="difflineplus">+    for (let i = 0; i &lt; expectedResults[index].length; ++i) {</span>
<a href="#l32.72"></a><span id="l32.72">       Assert.equal(obs._result.getValueAt(i), expectedResults[index][i]);</span>
<a href="#l32.73"></a><span id="l32.73">       Assert.equal(obs._result.getLabelAt(i), expectedResults[index][i]);</span>
<a href="#l32.74"></a><span id="l32.74">       Assert.equal(obs._result.getCommentAt(i), &quot;&quot;);</span>
<a href="#l32.75"></a><span id="l32.75">       Assert.equal(obs._result.getStyleAt(i), &quot;local-abook&quot;);</span>
<a href="#l32.76"></a><span id="l32.76">       Assert.equal(obs._result.getImageAt(i), &quot;&quot;);</span>
<a href="#l32.77"></a><span id="l32.77">       obs._result.QueryInterface(Ci.nsIAbAutoCompleteResult);</span>
<a href="#l32.78"></a><span id="l32.78">     }</span>
<a href="#l32.79"></a><span id="l32.79">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch5.js</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch5.js</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineat">@@ -32,20 +32,20 @@ var lastNames = [ { search: &quot;l&quot;,      ex</span>
<a href="#l33.4"></a><span id="l33.4"> var inputs = [ firstNames, lastNames];</span>
<a href="#l33.5"></a><span id="l33.5"> </span>
<a href="#l33.6"></a><span id="l33.6"> function acObserver() {}</span>
<a href="#l33.7"></a><span id="l33.7"> </span>
<a href="#l33.8"></a><span id="l33.8"> acObserver.prototype = {</span>
<a href="#l33.9"></a><span id="l33.9">   _search: null,</span>
<a href="#l33.10"></a><span id="l33.10">   _result: null,</span>
<a href="#l33.11"></a><span id="l33.11"> </span>
<a href="#l33.12"></a><span id="l33.12" class="difflineminus">-  onSearchResult: function (aSearch, aResult) {</span>
<a href="#l33.13"></a><span id="l33.13" class="difflineplus">+  onSearchResult(aSearch, aResult) {</span>
<a href="#l33.14"></a><span id="l33.14">     this._search = aSearch;</span>
<a href="#l33.15"></a><span id="l33.15">     this._result = aResult;</span>
<a href="#l33.16"></a><span id="l33.16" class="difflineminus">-  }</span>
<a href="#l33.17"></a><span id="l33.17" class="difflineplus">+  },</span>
<a href="#l33.18"></a><span id="l33.18"> };</span>
<a href="#l33.19"></a><span id="l33.19"> </span>
<a href="#l33.20"></a><span id="l33.20"> function run_test() {</span>
<a href="#l33.21"></a><span id="l33.21">   // Copy the data files into place</span>
<a href="#l33.22"></a><span id="l33.22">   let testAB = do_get_file(&quot;../../../data/tb2hexpopularity.mab&quot;);</span>
<a href="#l33.23"></a><span id="l33.23"> </span>
<a href="#l33.24"></a><span id="l33.24">   testAB.copyTo(do_get_profile(), kPABData.fileName);</span>
<a href="#l33.25"></a><span id="l33.25"> </span>
<a href="#l33.26"></a><span id="l33.26" class="difflineat">@@ -61,21 +61,21 @@ function run_test() {</span>
<a href="#l33.27"></a><span id="l33.27"> </span>
<a href="#l33.28"></a><span id="l33.28">   // Test - Matches</span>
<a href="#l33.29"></a><span id="l33.29"> </span>
<a href="#l33.30"></a><span id="l33.30">   // Now check multiple matches</span>
<a href="#l33.31"></a><span id="l33.31">   function checkInputItem(element, index, array) {</span>
<a href="#l33.32"></a><span id="l33.32">     print(&quot;Search #&quot; + index + &quot;: search=&quot; + element.search);</span>
<a href="#l33.33"></a><span id="l33.33">     acs.startSearch(element.search, JSON.stringify({ type: &quot;addr_to&quot; }), null, obs);</span>
<a href="#l33.34"></a><span id="l33.34"> </span>
<a href="#l33.35"></a><span id="l33.35" class="difflineminus">-    for (var i = 0; i &lt; obs._result.matchCount; i++) {</span>
<a href="#l33.36"></a><span id="l33.36" class="difflineplus">+    for (let i = 0; i &lt; obs._result.matchCount; i++) {</span>
<a href="#l33.37"></a><span id="l33.37">       print(&quot;... got &quot; + i + &quot;: &quot; + obs._result.getValueAt(i));</span>
<a href="#l33.38"></a><span id="l33.38">     }</span>
<a href="#l33.39"></a><span id="l33.39"> </span>
<a href="#l33.40"></a><span id="l33.40" class="difflineminus">-    for (var i = 0; i &lt; element.expected.length; i++) {</span>
<a href="#l33.41"></a><span id="l33.41" class="difflineplus">+    for (let i = 0; i &lt; element.expected.length; i++) {</span>
<a href="#l33.42"></a><span id="l33.42">       print(&quot;... expected &quot; + i + &quot; (card &quot; + element.expected[i] + &quot;): &quot; +</span>
<a href="#l33.43"></a><span id="l33.43">             results[element.expected[i]].email);</span>
<a href="#l33.44"></a><span id="l33.44">     }</span>
<a href="#l33.45"></a><span id="l33.45"> </span>
<a href="#l33.46"></a><span id="l33.46">     Assert.equal(obs._search, acs);</span>
<a href="#l33.47"></a><span id="l33.47">     Assert.equal(obs._result.searchString, element.search);</span>
<a href="#l33.48"></a><span id="l33.48">     Assert.equal(obs._result.searchResult, ACR.RESULT_SUCCESS);</span>
<a href="#l33.49"></a><span id="l33.49">     Assert.equal(obs._result.errorDescription, null);</span>
<a href="#l33.50"></a><span id="l33.50" class="difflineat">@@ -97,9 +97,9 @@ function run_test() {</span>
<a href="#l33.51"></a><span id="l33.51">       }</span>
<a href="#l33.52"></a><span id="l33.52">     }</span>
<a href="#l33.53"></a><span id="l33.53">   }</span>
<a href="#l33.54"></a><span id="l33.54">   function checkInputSet(element, index, array) {</span>
<a href="#l33.55"></a><span id="l33.55">     element.forEach(checkInputItem);</span>
<a href="#l33.56"></a><span id="l33.56">   }</span>
<a href="#l33.57"></a><span id="l33.57"> </span>
<a href="#l33.58"></a><span id="l33.58">   inputs.forEach(checkInputSet);</span>
<a href="#l33.59"></a><span id="l33.59" class="difflineminus">-};</span>
<a href="#l33.60"></a><span id="l33.60" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch6.js</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch6.js</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineat">@@ -3,135 +3,134 @@</span>
<a href="#l34.4"></a><span id="l34.4">  * Tests for for nsAbAutoCompleteSearch scoring.</span>
<a href="#l34.5"></a><span id="l34.5">  */</span>
<a href="#l34.6"></a><span id="l34.6"> </span>
<a href="#l34.7"></a><span id="l34.7"> var ACR = Ci.nsIAutoCompleteResult;</span>
<a href="#l34.8"></a><span id="l34.8"> </span>
<a href="#l34.9"></a><span id="l34.9"> var cards = [</span>
<a href="#l34.10"></a><span id="l34.10">   { // 0</span>
<a href="#l34.11"></a><span id="l34.11">     email: &quot;jd.who@example.com&quot;, displayName: &quot;John Doe (:xx)&quot;,</span>
<a href="#l34.12"></a><span id="l34.12" class="difflineminus">-    popularityIndex: 0, firstName: &quot;John&quot;, value: &quot;John Doe (:xx) &lt;jd.who@example.com&gt;&quot;</span>
<a href="#l34.13"></a><span id="l34.13" class="difflineplus">+    popularityIndex: 0, firstName: &quot;John&quot;, value: &quot;John Doe (:xx) &lt;jd.who@example.com&gt;&quot;,</span>
<a href="#l34.14"></a><span id="l34.14">   },</span>
<a href="#l34.15"></a><span id="l34.15"> </span>
<a href="#l34.16"></a><span id="l34.16">   { // 1</span>
<a href="#l34.17"></a><span id="l34.17">     email: &quot;janey_who@example.com&quot;, displayName: &quot;Jane Doe&quot;,</span>
<a href="#l34.18"></a><span id="l34.18" class="difflineminus">-    popularityIndex: 0, value: &quot;Jane Doe &lt;janey_who@example.com&gt;&quot;</span>
<a href="#l34.19"></a><span id="l34.19" class="difflineplus">+    popularityIndex: 0, value: &quot;Jane Doe &lt;janey_who@example.com&gt;&quot;,</span>
<a href="#l34.20"></a><span id="l34.20">   },</span>
<a href="#l34.21"></a><span id="l34.21"> </span>
<a href="#l34.22"></a><span id="l34.22">   { // 2</span>
<a href="#l34.23"></a><span id="l34.23">     email: &quot;pf@example.com&quot;, displayName: &quot;Paul \&quot;Shitbreak\&quot; Finch&quot;,</span>
<a href="#l34.24"></a><span id="l34.24" class="difflineminus">-    popularityIndex: 0, value: &quot;Paul \&quot;Shitbreak\&quot; Finch &lt;pf@example.com&gt;&quot;</span>
<a href="#l34.25"></a><span id="l34.25" class="difflineplus">+    popularityIndex: 0, value: &quot;Paul \&quot;Shitbreak\&quot; Finch &lt;pf@example.com&gt;&quot;,</span>
<a href="#l34.26"></a><span id="l34.26">   },</span>
<a href="#l34.27"></a><span id="l34.27"> </span>
<a href="#l34.28"></a><span id="l34.28">   { // 3</span>
<a href="#l34.29"></a><span id="l34.29">     email: &quot;js@example.com&quot;, displayName: &quot;Janine (Stifflers Mom)&quot;,</span>
<a href="#l34.30"></a><span id="l34.30" class="difflineminus">-    popularityIndex: 0, value: &quot;Janine (Stifflers Mom) &lt;js@example.com&gt;&quot;</span>
<a href="#l34.31"></a><span id="l34.31" class="difflineplus">+    popularityIndex: 0, value: &quot;Janine (Stifflers Mom) &lt;js@example.com&gt;&quot;,</span>
<a href="#l34.32"></a><span id="l34.32">   },</span>
<a href="#l34.33"></a><span id="l34.33"> </span>
<a href="#l34.34"></a><span id="l34.34">   { // 4</span>
<a href="#l34.35"></a><span id="l34.35">     email: &quot;ex0@example.com&quot;, displayName: &quot;Ajden&quot;,</span>
<a href="#l34.36"></a><span id="l34.36" class="difflineminus">-    popularityIndex: 0, value: &quot;Ajden &lt;ex0@example.com&gt;&quot;</span>
<a href="#l34.37"></a><span id="l34.37" class="difflineplus">+    popularityIndex: 0, value: &quot;Ajden &lt;ex0@example.com&gt;&quot;,</span>
<a href="#l34.38"></a><span id="l34.38">   },</span>
<a href="#l34.39"></a><span id="l34.39"> </span>
<a href="#l34.40"></a><span id="l34.40">   { // 5</span>
<a href="#l34.41"></a><span id="l34.41">     email: &quot;5@example.com&quot;, displayName: &quot;Foxx&quot;,</span>
<a href="#l34.42"></a><span id="l34.42" class="difflineminus">-    popularityIndex: 0, value: &quot;Foxx &lt;5@example.com&gt;&quot;</span>
<a href="#l34.43"></a><span id="l34.43" class="difflineplus">+    popularityIndex: 0, value: &quot;Foxx &lt;5@example.com&gt;&quot;,</span>
<a href="#l34.44"></a><span id="l34.44">   },</span>
<a href="#l34.45"></a><span id="l34.45"> </span>
<a href="#l34.46"></a><span id="l34.46">   { // 6</span>
<a href="#l34.47"></a><span id="l34.47">     email: &quot;6@example.com&quot;, displayName: &quot;thewho&quot;,</span>
<a href="#l34.48"></a><span id="l34.48" class="difflineminus">-    popularityIndex: 0, value: &quot;thewho &lt;6@example.com&gt;&quot;</span>
<a href="#l34.49"></a><span id="l34.49" class="difflineplus">+    popularityIndex: 0, value: &quot;thewho &lt;6@example.com&gt;&quot;,</span>
<a href="#l34.50"></a><span id="l34.50">   },</span>
<a href="#l34.51"></a><span id="l34.51"> </span>
<a href="#l34.52"></a><span id="l34.52">   { // 7</span>
<a href="#l34.53"></a><span id="l34.53">     email: &quot;7@example.com&quot;, displayName: &quot;fakeshit&quot;,</span>
<a href="#l34.54"></a><span id="l34.54" class="difflineminus">-    popularityIndex: 0, value: &quot;fakeshit &lt;7@example.com&gt;&quot;</span>
<a href="#l34.55"></a><span id="l34.55" class="difflineplus">+    popularityIndex: 0, value: &quot;fakeshit &lt;7@example.com&gt;&quot;,</span>
<a href="#l34.56"></a><span id="l34.56">   },</span>
<a href="#l34.57"></a><span id="l34.57"> </span>
<a href="#l34.58"></a><span id="l34.58">   { // 8</span>
<a href="#l34.59"></a><span id="l34.59">     email: &quot;8@example.com&quot;, displayName: &quot;mastiff&quot;,</span>
<a href="#l34.60"></a><span id="l34.60" class="difflineminus">-    popularityIndex: 0, value: &quot;mastiff &lt;8@example.com&gt;&quot;</span>
<a href="#l34.61"></a><span id="l34.61" class="difflineplus">+    popularityIndex: 0, value: &quot;mastiff &lt;8@example.com&gt;&quot;,</span>
<a href="#l34.62"></a><span id="l34.62">   },</span>
<a href="#l34.63"></a><span id="l34.63"> </span>
<a href="#l34.64"></a><span id="l34.64">   { // 9</span>
<a href="#l34.65"></a><span id="l34.65">     email: &quot;9@example.com&quot;, displayName: &quot;anyjohn&quot;,</span>
<a href="#l34.66"></a><span id="l34.66" class="difflineminus">-    popularityIndex: 0, value: &quot;anyjohn &lt;9@example.com&gt;&quot;</span>
<a href="#l34.67"></a><span id="l34.67" class="difflineplus">+    popularityIndex: 0, value: &quot;anyjohn &lt;9@example.com&gt;&quot;,</span>
<a href="#l34.68"></a><span id="l34.68">   },</span>
<a href="#l34.69"></a><span id="l34.69"> </span>
<a href="#l34.70"></a><span id="l34.70">   { // 10</span>
<a href="#l34.71"></a><span id="l34.71">     email: &quot;10@example.com&quot;, displayName: &quot;dsh l18n&quot;,</span>
<a href="#l34.72"></a><span id="l34.72" class="difflineminus">-    popularityIndex: 0, value: &quot;dsh l18n &lt;10@example.com&gt;&quot;</span>
<a href="#l34.73"></a><span id="l34.73" class="difflineplus">+    popularityIndex: 0, value: &quot;dsh l18n &lt;10@example.com&gt;&quot;,</span>
<a href="#l34.74"></a><span id="l34.74">   },</span>
<a href="#l34.75"></a><span id="l34.75"> </span>
<a href="#l34.76"></a><span id="l34.76">   { // 11</span>
<a href="#l34.77"></a><span id="l34.77">     email: &quot;11@example.com&quot;, displayName: &quot;paul mary&quot;,</span>
<a href="#l34.78"></a><span id="l34.78">     popularityIndex: 0, firstName: &quot;paul&quot;, lastName: &quot;mary meyer&quot;,</span>
<a href="#l34.79"></a><span id="l34.79" class="difflineminus">-    value: &quot;paul mary &lt;11@example.com&gt;&quot;</span>
<a href="#l34.80"></a><span id="l34.80" class="difflineplus">+    value: &quot;paul mary &lt;11@example.com&gt;&quot;,</span>
<a href="#l34.81"></a><span id="l34.81">   },</span>
<a href="#l34.82"></a><span id="l34.82"> </span>
<a href="#l34.83"></a><span id="l34.83">   { // 12</span>
<a href="#l34.84"></a><span id="l34.84">     email: &quot;12@example.com&quot;, displayName: &quot;paul meyer&quot;,</span>
<a href="#l34.85"></a><span id="l34.85">     popularityIndex: 0, firstName: &quot;paul&quot;, lastName: &quot;mary meyer&quot;,</span>
<a href="#l34.86"></a><span id="l34.86" class="difflineminus">-    value: &quot;paul meyer &lt;12@example.com&gt;&quot;</span>
<a href="#l34.87"></a><span id="l34.87" class="difflineplus">+    value: &quot;paul meyer &lt;12@example.com&gt;&quot;,</span>
<a href="#l34.88"></a><span id="l34.88">   },</span>
<a href="#l34.89"></a><span id="l34.89"> </span>
<a href="#l34.90"></a><span id="l34.90">   { // 13</span>
<a href="#l34.91"></a><span id="l34.91">     email: &quot;13@example.com&quot;, displayName: &quot;mr iron man (exp dev)&quot;,</span>
<a href="#l34.92"></a><span id="l34.92">     popularityIndex: 0, firstName: &quot;iron&quot;, lastName: &quot;man&quot;,</span>
<a href="#l34.93"></a><span id="l34.93" class="difflineminus">-    value: &quot;mr iron man (exp dev) &lt;13@example.com&gt;&quot;</span>
<a href="#l34.94"></a><span id="l34.94" class="difflineplus">+    value: &quot;mr iron man (exp dev) &lt;13@example.com&gt;&quot;,</span>
<a href="#l34.95"></a><span id="l34.95">   },</span>
<a href="#l34.96"></a><span id="l34.96"> </span>
<a href="#l34.97"></a><span id="l34.97">   { // 14</span>
<a href="#l34.98"></a><span id="l34.98">     email: &quot;14@example.com&quot;, displayName: &quot;michael&quot;,</span>
<a href="#l34.99"></a><span id="l34.99">     popularityIndex: 0, nickName: &quot;short&quot;,</span>
<a href="#l34.100"></a><span id="l34.100" class="difflineminus">-    value: &quot;michael &lt;14@example.com&gt;&quot;</span>
<a href="#l34.101"></a><span id="l34.101" class="difflineplus">+    value: &quot;michael &lt;14@example.com&gt;&quot;,</span>
<a href="#l34.102"></a><span id="l34.102">   },</span>
<a href="#l34.103"></a><span id="l34.103"> </span>
<a href="#l34.104"></a><span id="l34.104">   { // 15</span>
<a href="#l34.105"></a><span id="l34.105">     email: &quot;15@example.com&quot;, displayName: &quot;good boy&quot;,</span>
<a href="#l34.106"></a><span id="l34.106">     popularityIndex: 0, nickName: &quot;sh&quot;,</span>
<a href="#l34.107"></a><span id="l34.107" class="difflineminus">-    value: &quot;good boy &lt;15@example.com&gt;&quot;</span>
<a href="#l34.108"></a><span id="l34.108" class="difflineplus">+    value: &quot;good boy &lt;15@example.com&gt;&quot;,</span>
<a href="#l34.109"></a><span id="l34.109">   },</span>
<a href="#l34.110"></a><span id="l34.110"> </span>
<a href="#l34.111"></a><span id="l34.111">   { // 16</span>
<a href="#l34.112"></a><span id="l34.112">     email: &quot;16@example.com&quot;, displayName: &quot;sherlock holmes&quot;,</span>
<a href="#l34.113"></a><span id="l34.113" class="difflineminus">-    popularityIndex: 0, value: &quot;sherlock holmes &lt;16@example.com&gt;&quot;</span>
<a href="#l34.114"></a><span id="l34.114" class="difflineminus">-  }</span>
<a href="#l34.115"></a><span id="l34.115" class="difflineplus">+    popularityIndex: 0, value: &quot;sherlock holmes &lt;16@example.com&gt;&quot;,</span>
<a href="#l34.116"></a><span id="l34.116" class="difflineplus">+  },</span>
<a href="#l34.117"></a><span id="l34.117"> ];</span>
<a href="#l34.118"></a><span id="l34.118"> </span>
<a href="#l34.119"></a><span id="l34.119"> var inputs = [</span>
<a href="#l34.120"></a><span id="l34.120">   { search: &quot;john&quot;, expected: [0, 9] },</span>
<a href="#l34.121"></a><span id="l34.121">   { search: &quot;doe&quot;, expected: [1, 0] },</span>
<a href="#l34.122"></a><span id="l34.122">   { search: &quot;jd&quot;, expected: [0, 4] },</span>
<a href="#l34.123"></a><span id="l34.123">   { search: &quot;who&quot;, expected: [1, 0, 6] },</span>
<a href="#l34.124"></a><span id="l34.124">   { search: &quot;xx&quot;, expected: [0, 5] },</span>
<a href="#l34.125"></a><span id="l34.125">   { search: &quot;jan&quot;, expected: [1, 3] },</span>
<a href="#l34.126"></a><span id="l34.126">   // expecting nickname to score highest.</span>
<a href="#l34.127"></a><span id="l34.127">   { search: &quot;sh&quot;, expected: [15, 14, 2, 16, 10, 7] },</span>
<a href="#l34.128"></a><span id="l34.128" class="difflineminus">-  { search: &quot;st&quot;, expected: [3,8] },</span>
<a href="#l34.129"></a><span id="l34.129" class="difflineplus">+  { search: &quot;st&quot;, expected: [3, 8] },</span>
<a href="#l34.130"></a><span id="l34.130">   { search: &quot;paul mary&quot;, expected: [11, 12] },</span>
<a href="#l34.131"></a><span id="l34.131">   { search: &quot;\&quot;paul mary\&quot;&quot;, expected: [11] },</span>
<a href="#l34.132"></a><span id="l34.132">   { search: &quot;\&quot;iron man\&quot; mr \&quot;exp dev\&quot;&quot;, expected: [13] },</span>
<a href="#l34.133"></a><span id="l34.133" class="difflineminus">-  { search: &quot;short&quot;, expected: [14] }</span>
<a href="#l34.134"></a><span id="l34.134" class="difflineplus">+  { search: &quot;short&quot;, expected: [14] },</span>
<a href="#l34.135"></a><span id="l34.135"> ];</span>
<a href="#l34.136"></a><span id="l34.136"> </span>
<a href="#l34.137"></a><span id="l34.137"> function acObserver() {}</span>
<a href="#l34.138"></a><span id="l34.138"> </span>
<a href="#l34.139"></a><span id="l34.139"> acObserver.prototype = {</span>
<a href="#l34.140"></a><span id="l34.140">   _search: null,</span>
<a href="#l34.141"></a><span id="l34.141">   _result: null,</span>
<a href="#l34.142"></a><span id="l34.142"> </span>
<a href="#l34.143"></a><span id="l34.143" class="difflineminus">-  onSearchResult: function (aSearch, aResult) {</span>
<a href="#l34.144"></a><span id="l34.144" class="difflineplus">+  onSearchResult(aSearch, aResult) {</span>
<a href="#l34.145"></a><span id="l34.145">     this._search = aSearch;</span>
<a href="#l34.146"></a><span id="l34.146">     this._result = aResult;</span>
<a href="#l34.147"></a><span id="l34.147" class="difflineminus">-  }</span>
<a href="#l34.148"></a><span id="l34.148" class="difflineplus">+  },</span>
<a href="#l34.149"></a><span id="l34.149"> };</span>
<a href="#l34.150"></a><span id="l34.150"> </span>
<a href="#l34.151"></a><span id="l34.151" class="difflineminus">-function run_test()</span>
<a href="#l34.152"></a><span id="l34.152" class="difflineminus">-{</span>
<a href="#l34.153"></a><span id="l34.153" class="difflineplus">+function run_test() {</span>
<a href="#l34.154"></a><span id="l34.154">   // We set up the cards for this test manually as it is easier to set the</span>
<a href="#l34.155"></a><span id="l34.155">   // popularity index and we don't need many.</span>
<a href="#l34.156"></a><span id="l34.156"> </span>
<a href="#l34.157"></a><span id="l34.157">   // Ensure all the directories are initialised.</span>
<a href="#l34.158"></a><span id="l34.158">   MailServices.ab.directories;</span>
<a href="#l34.159"></a><span id="l34.159"> </span>
<a href="#l34.160"></a><span id="l34.160">   let ab = MailServices.ab.getDirectory(kPABData.URI);</span>
<a href="#l34.161"></a><span id="l34.161"> </span>
<a href="#l34.162"></a><span id="l34.162" class="difflineat">@@ -158,31 +157,31 @@ function run_test()</span>
<a href="#l34.163"></a><span id="l34.163">     .getService(Ci.nsIAutoCompleteSearch);</span>
<a href="#l34.164"></a><span id="l34.164"> </span>
<a href="#l34.165"></a><span id="l34.165">   var obs = new acObserver();</span>
<a href="#l34.166"></a><span id="l34.166"> </span>
<a href="#l34.167"></a><span id="l34.167">   function checkInputItem(element, index, array) {</span>
<a href="#l34.168"></a><span id="l34.168">     print(&quot;Search #&quot; + index + &quot;: search=&quot; + element.search);</span>
<a href="#l34.169"></a><span id="l34.169">     acs.startSearch(element.search, JSON.stringify({ type: &quot;addr_to&quot;  }), null, obs);</span>
<a href="#l34.170"></a><span id="l34.170"> </span>
<a href="#l34.171"></a><span id="l34.171" class="difflineminus">-    for (var i = 0; i &lt; obs._result.matchCount; i++) {</span>
<a href="#l34.172"></a><span id="l34.172" class="difflineplus">+    for (let i = 0; i &lt; obs._result.matchCount; i++) {</span>
<a href="#l34.173"></a><span id="l34.173">       print(&quot;... got &quot; + i + &quot;: &quot; + obs._result.getValueAt(i));</span>
<a href="#l34.174"></a><span id="l34.174">     }</span>
<a href="#l34.175"></a><span id="l34.175"> </span>
<a href="#l34.176"></a><span id="l34.176" class="difflineminus">-    for (var i = 0; i &lt; element.expected.length; i++) {</span>
<a href="#l34.177"></a><span id="l34.177" class="difflineplus">+    for (let i = 0; i &lt; element.expected.length; i++) {</span>
<a href="#l34.178"></a><span id="l34.178">       print(&quot;... expected &quot; + i + &quot; (card &quot; + element.expected[i] + &quot;): &quot; +</span>
<a href="#l34.179"></a><span id="l34.179">             cards[element.expected[i]].value);</span>
<a href="#l34.180"></a><span id="l34.180">     }</span>
<a href="#l34.181"></a><span id="l34.181"> </span>
<a href="#l34.182"></a><span id="l34.182">     Assert.equal(obs._search, acs);</span>
<a href="#l34.183"></a><span id="l34.183">     Assert.equal(obs._result.searchString, element.search);</span>
<a href="#l34.184"></a><span id="l34.184">     Assert.equal(obs._result.searchResult, ACR.RESULT_SUCCESS);</span>
<a href="#l34.185"></a><span id="l34.185">     Assert.equal(obs._result.errorDescription, null);</span>
<a href="#l34.186"></a><span id="l34.186">     Assert.equal(obs._result.matchCount, element.expected.length);</span>
<a href="#l34.187"></a><span id="l34.187"> </span>
<a href="#l34.188"></a><span id="l34.188" class="difflineminus">-    for (var i = 0; i &lt; element.expected.length; ++i) {</span>
<a href="#l34.189"></a><span id="l34.189" class="difflineplus">+    for (let i = 0; i &lt; element.expected.length; ++i) {</span>
<a href="#l34.190"></a><span id="l34.190">       Assert.equal(obs._result.getValueAt(i), cards[element.expected[i]].value);</span>
<a href="#l34.191"></a><span id="l34.191">       Assert.equal(obs._result.getLabelAt(i), cards[element.expected[i]].value);</span>
<a href="#l34.192"></a><span id="l34.192">     }</span>
<a href="#l34.193"></a><span id="l34.193">   }</span>
<a href="#l34.194"></a><span id="l34.194"> </span>
<a href="#l34.195"></a><span id="l34.195">   inputs.forEach(checkInputItem);</span>
<a href="#l34.196"></a><span id="l34.196"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch7.js</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch7.js</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineat">@@ -11,71 +11,69 @@ var ACR = Ci.nsIAutoCompleteResult;</span>
<a href="#l35.4"></a><span id="l35.4"> </span>
<a href="#l35.5"></a><span id="l35.5"> // Note the expected arrays are in expected sort order as well.</span>
<a href="#l35.6"></a><span id="l35.6"> </span>
<a href="#l35.7"></a><span id="l35.7"> var results =  [</span>
<a href="#l35.8"></a><span id="l35.8">   { email: &quot;Tomas Doe &lt;tomez.doe@foo.invalid&gt;&quot; }, // 0</span>
<a href="#l35.9"></a><span id="l35.9">   { email: &quot;Tomas Doe &lt;tomez.doe@foo2.invalid&gt;&quot; }, // 1</span>
<a href="#l35.10"></a><span id="l35.10">   { email: &quot;Tomas Doe &lt;tomez.doe@b.example.com&gt;&quot; }, // 2</span>
<a href="#l35.11"></a><span id="l35.11">   { email: &quot;Tomas Doe &lt;tomez.doe@a.example.com&gt;&quot; }, // 3</span>
<a href="#l35.12"></a><span id="l35.12" class="difflineminus">-  { email: &quot;Tomek Smith &lt;tomek@example.com&gt;&quot; } // 4</span>
<a href="#l35.13"></a><span id="l35.13" class="difflineminus">-]</span>
<a href="#l35.14"></a><span id="l35.14" class="difflineplus">+  { email: &quot;Tomek Smith &lt;tomek@example.com&gt;&quot; }, // 4</span>
<a href="#l35.15"></a><span id="l35.15" class="difflineplus">+];</span>
<a href="#l35.16"></a><span id="l35.16"> </span>
<a href="#l35.17"></a><span id="l35.17"> var inputs = [</span>
<a href="#l35.18"></a><span id="l35.18">   [</span>
<a href="#l35.19"></a><span id="l35.19">     { search: &quot;t&quot;,            expected: [2, 3, 0, 1, 4] },</span>
<a href="#l35.20"></a><span id="l35.20">     { search: &quot;tom&quot;,          expected: [0, 1, 2, 3, 4] },</span>
<a href="#l35.21"></a><span id="l35.21" class="difflineminus">-    { search: &quot;tomek&quot;,        expected: [4] }</span>
<a href="#l35.22"></a><span id="l35.22" class="difflineminus">-  ]</span>
<a href="#l35.23"></a><span id="l35.23" class="difflineplus">+    { search: &quot;tomek&quot;,        expected: [4] },</span>
<a href="#l35.24"></a><span id="l35.24" class="difflineplus">+  ],</span>
<a href="#l35.25"></a><span id="l35.25"> ];</span>
<a href="#l35.26"></a><span id="l35.26"> </span>
<a href="#l35.27"></a><span id="l35.27"> function acObserver() {}</span>
<a href="#l35.28"></a><span id="l35.28"> </span>
<a href="#l35.29"></a><span id="l35.29"> acObserver.prototype = {</span>
<a href="#l35.30"></a><span id="l35.30">   _search: null,</span>
<a href="#l35.31"></a><span id="l35.31">   _result: null,</span>
<a href="#l35.32"></a><span id="l35.32"> </span>
<a href="#l35.33"></a><span id="l35.33" class="difflineminus">-  onSearchResult: function (aSearch, aResult) {</span>
<a href="#l35.34"></a><span id="l35.34" class="difflineplus">+  onSearchResult(aSearch, aResult) {</span>
<a href="#l35.35"></a><span id="l35.35">     this._search = aSearch;</span>
<a href="#l35.36"></a><span id="l35.36">     this._result = aResult;</span>
<a href="#l35.37"></a><span id="l35.37" class="difflineminus">-  }</span>
<a href="#l35.38"></a><span id="l35.38" class="difflineplus">+  },</span>
<a href="#l35.39"></a><span id="l35.39"> };</span>
<a href="#l35.40"></a><span id="l35.40"> </span>
<a href="#l35.41"></a><span id="l35.41"> var PAB_CARD_DATA = [</span>
<a href="#l35.42"></a><span id="l35.42">   {</span>
<a href="#l35.43"></a><span id="l35.43">     &quot;FirstName&quot;: &quot;Tomas&quot;,</span>
<a href="#l35.44"></a><span id="l35.44">     &quot;LastName&quot;: &quot;Doe&quot;,</span>
<a href="#l35.45"></a><span id="l35.45">     &quot;DisplayName&quot;: &quot;Tomas Doe&quot;,</span>
<a href="#l35.46"></a><span id="l35.46">     &quot;NickName&quot;: &quot;tom&quot;,</span>
<a href="#l35.47"></a><span id="l35.47">     &quot;PrimaryEmail&quot;: &quot;tomez.doe@foo.invalid&quot;,</span>
<a href="#l35.48"></a><span id="l35.48">     &quot;SecondEmail&quot;: &quot;tomez.doe@foo2.invalid&quot;,</span>
<a href="#l35.49"></a><span id="l35.49">     &quot;PreferDisplayName&quot;: true,</span>
<a href="#l35.50"></a><span id="l35.50" class="difflineminus">-    &quot;PopularityIndex&quot;: 10</span>
<a href="#l35.51"></a><span id="l35.51" class="difflineplus">+    &quot;PopularityIndex&quot;: 10,</span>
<a href="#l35.52"></a><span id="l35.52">   },</span>
<a href="#l35.53"></a><span id="l35.53">   {</span>
<a href="#l35.54"></a><span id="l35.54">     &quot;FirstName&quot;: &quot;Tomas&quot;,</span>
<a href="#l35.55"></a><span id="l35.55">     &quot;LastName&quot;: &quot;Doe&quot;,</span>
<a href="#l35.56"></a><span id="l35.56">     &quot;DisplayName&quot;: &quot;Tomas Doe&quot;,</span>
<a href="#l35.57"></a><span id="l35.57">     &quot;PrimaryEmail&quot;: &quot;tomez.doe@b.example.com&quot;,</span>
<a href="#l35.58"></a><span id="l35.58">     &quot;SecondEmail&quot;: &quot;tomez.doe@a.example.com&quot;,</span>
<a href="#l35.59"></a><span id="l35.59">     &quot;PreferDisplayName&quot;: true,</span>
<a href="#l35.60"></a><span id="l35.60" class="difflineminus">-    &quot;PopularityIndex&quot;: 200</span>
<a href="#l35.61"></a><span id="l35.61" class="difflineplus">+    &quot;PopularityIndex&quot;: 200,</span>
<a href="#l35.62"></a><span id="l35.62">   },</span>
<a href="#l35.63"></a><span id="l35.63">   {</span>
<a href="#l35.64"></a><span id="l35.64">     &quot;FirstName&quot;: &quot;Tomek&quot;,</span>
<a href="#l35.65"></a><span id="l35.65">     &quot;LastName&quot;: &quot;Smith&quot;,</span>
<a href="#l35.66"></a><span id="l35.66">     &quot;DisplayName&quot;: &quot;Tomek Smith&quot;,</span>
<a href="#l35.67"></a><span id="l35.67">     &quot;PrimaryEmail&quot;: &quot;tomek@example.com&quot;,</span>
<a href="#l35.68"></a><span id="l35.68">     &quot;PreferDisplayName&quot;: true,</span>
<a href="#l35.69"></a><span id="l35.69" class="difflineminus">-    &quot;PopularityIndex&quot;: 3</span>
<a href="#l35.70"></a><span id="l35.70" class="difflineminus">-  }</span>
<a href="#l35.71"></a><span id="l35.71" class="difflineplus">+    &quot;PopularityIndex&quot;: 3,</span>
<a href="#l35.72"></a><span id="l35.72" class="difflineplus">+  },</span>
<a href="#l35.73"></a><span id="l35.73"> ];</span>
<a href="#l35.74"></a><span id="l35.74"> </span>
<a href="#l35.75"></a><span id="l35.75" class="difflineminus">-var ABMDB_PREFIX = &quot;moz-abmdbdirectory://&quot;;</span>
<a href="#l35.76"></a><span id="l35.76" class="difflineminus">-</span>
<a href="#l35.77"></a><span id="l35.77"> function setupAddressBookData(aDirURI, aCardData, aMailListData) {</span>
<a href="#l35.78"></a><span id="l35.78">   let ab = MailServices.ab.getDirectory(aDirURI);</span>
<a href="#l35.79"></a><span id="l35.79"> </span>
<a href="#l35.80"></a><span id="l35.80">   // Getting all directories ensures we create all ABs because mailing</span>
<a href="#l35.81"></a><span id="l35.81">   // lists need help initialising themselves</span>
<a href="#l35.82"></a><span id="l35.82">   MailServices.ab.directories;</span>
<a href="#l35.83"></a><span id="l35.83"> </span>
<a href="#l35.84"></a><span id="l35.84">   let childCards0 = ab.childCards;</span>
<a href="#l35.85"></a><span id="l35.85" class="difflineat">@@ -100,62 +98,60 @@ function setupAddressBookData(aDirURI, a</span>
<a href="#l35.86"></a><span id="l35.86">     for (var prop in ld) {</span>
<a href="#l35.87"></a><span id="l35.87">       list[prop] = ld[prop];</span>
<a href="#l35.88"></a><span id="l35.88">     }</span>
<a href="#l35.89"></a><span id="l35.89">     ab.addMailList(list);</span>
<a href="#l35.90"></a><span id="l35.90">   });</span>
<a href="#l35.91"></a><span id="l35.91"> </span>
<a href="#l35.92"></a><span id="l35.92">   let childCards = ab.childCards;</span>
<a href="#l35.93"></a><span id="l35.93">   while (childCards.hasMoreElements()) {</span>
<a href="#l35.94"></a><span id="l35.94" class="difflineminus">-    let c = childCards.getNext().QueryInterface(Ci.nsIAbCard);</span>
<a href="#l35.95"></a><span id="l35.95" class="difflineplus">+    childCards.getNext().QueryInterface(Ci.nsIAbCard);</span>
<a href="#l35.96"></a><span id="l35.96">   }</span>
<a href="#l35.97"></a><span id="l35.97"> }</span>
<a href="#l35.98"></a><span id="l35.98"> </span>
<a href="#l35.99"></a><span id="l35.99"> function run_test() {</span>
<a href="#l35.100"></a><span id="l35.100">   // Set up addresses for in the personal address book.</span>
<a href="#l35.101"></a><span id="l35.101">   setupAddressBookData(kPABData.URI, PAB_CARD_DATA, []);</span>
<a href="#l35.102"></a><span id="l35.102"> </span>
<a href="#l35.103"></a><span id="l35.103">   // Test - Create a new search component</span>
<a href="#l35.104"></a><span id="l35.104"> </span>
<a href="#l35.105"></a><span id="l35.105">   var acs = Cc[&quot;@mozilla.org/autocomplete/search;1?name=addrbook&quot;]</span>
<a href="#l35.106"></a><span id="l35.106">     .getService(Ci.nsIAutoCompleteSearch);</span>
<a href="#l35.107"></a><span id="l35.107"> </span>
<a href="#l35.108"></a><span id="l35.108">   var obs = new acObserver();</span>
<a href="#l35.109"></a><span id="l35.109" class="difflineminus">-  let obsNews = new acObserver();</span>
<a href="#l35.110"></a><span id="l35.110" class="difflineminus">-  let obsFollowup = new acObserver();</span>
<a href="#l35.111"></a><span id="l35.111"> </span>
<a href="#l35.112"></a><span id="l35.112">   let param = JSON.stringify({ type: &quot;addr_to&quot; });</span>
<a href="#l35.113"></a><span id="l35.113"> </span>
<a href="#l35.114"></a><span id="l35.114">   // Now check multiple matches</span>
<a href="#l35.115"></a><span id="l35.115">   function checkInputItem(element, index, array) {</span>
<a href="#l35.116"></a><span id="l35.116">     let prevRes = obs._result;</span>
<a href="#l35.117"></a><span id="l35.117">     print(&quot;Search #&quot; + index + &quot;: search=&quot; + element.search);</span>
<a href="#l35.118"></a><span id="l35.118">     acs.startSearch(element.search, param, prevRes, obs);</span>
<a href="#l35.119"></a><span id="l35.119"> </span>
<a href="#l35.120"></a><span id="l35.120" class="difflineminus">-    for (var i = 0; i &lt; obs._result.matchCount; i++) {</span>
<a href="#l35.121"></a><span id="l35.121" class="difflineplus">+    for (let i = 0; i &lt; obs._result.matchCount; i++) {</span>
<a href="#l35.122"></a><span id="l35.122">       print(&quot;... got &quot; + i + &quot;: &quot; + obs._result.getValueAt(i));</span>
<a href="#l35.123"></a><span id="l35.123">     }</span>
<a href="#l35.124"></a><span id="l35.124" class="difflineminus">-    for (var i = 0; i &lt; element.expected.length; i++) {</span>
<a href="#l35.125"></a><span id="l35.125" class="difflineplus">+    for (let i = 0; i &lt; element.expected.length; i++) {</span>
<a href="#l35.126"></a><span id="l35.126">       print(&quot;... expected &quot; + i + &quot; (result &quot; + element.expected[i] + &quot;): &quot; +</span>
<a href="#l35.127"></a><span id="l35.127">             results[element.expected[i]].email);</span>
<a href="#l35.128"></a><span id="l35.128">     }</span>
<a href="#l35.129"></a><span id="l35.129"> </span>
<a href="#l35.130"></a><span id="l35.130">     Assert.equal(obs._search, acs);</span>
<a href="#l35.131"></a><span id="l35.131">     Assert.equal(obs._result.searchString, element.search);</span>
<a href="#l35.132"></a><span id="l35.132">     Assert.equal(obs._result.searchResult, ACR.RESULT_SUCCESS);</span>
<a href="#l35.133"></a><span id="l35.133">     Assert.equal(obs._result.errorDescription, null);</span>
<a href="#l35.134"></a><span id="l35.134">     Assert.equal(obs._result.matchCount, element.expected.length);</span>
<a href="#l35.135"></a><span id="l35.135">     Assert.equal(obs._result.defaultIndex, 0);</span>
<a href="#l35.136"></a><span id="l35.136"> </span>
<a href="#l35.137"></a><span id="l35.137" class="difflineminus">-    for (var i = 0; i &lt; element.expected.length; ++i) {</span>
<a href="#l35.138"></a><span id="l35.138" class="difflineplus">+    for (let i = 0; i &lt; element.expected.length; ++i) {</span>
<a href="#l35.139"></a><span id="l35.139">       Assert.equal(obs._result.getValueAt(i), results[element.expected[i]].email);</span>
<a href="#l35.140"></a><span id="l35.140">       Assert.equal(obs._result.getLabelAt(i), results[element.expected[i]].email);</span>
<a href="#l35.141"></a><span id="l35.141">       Assert.equal(obs._result.getCommentAt(i), &quot;&quot;);</span>
<a href="#l35.142"></a><span id="l35.142">       Assert.equal(obs._result.getStyleAt(i), &quot;local-abook&quot;);</span>
<a href="#l35.143"></a><span id="l35.143">       Assert.equal(obs._result.getImageAt(i), &quot;&quot;);</span>
<a href="#l35.144"></a><span id="l35.144">     }</span>
<a href="#l35.145"></a><span id="l35.145">   }</span>
<a href="#l35.146"></a><span id="l35.146">   function checkInputSet(element, index, array) {</span>
<a href="#l35.147"></a><span id="l35.147">     element.forEach(checkInputItem);</span>
<a href="#l35.148"></a><span id="l35.148">   }</span>
<a href="#l35.149"></a><span id="l35.149"> </span>
<a href="#l35.150"></a><span id="l35.150">   inputs.forEach(checkInputSet);</span>
<a href="#l35.151"></a><span id="l35.151" class="difflineminus">-};</span>
<a href="#l35.152"></a><span id="l35.152" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l36.1"></a><span id="l36.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_nsAbManager1.js</span>
<a href="#l36.2"></a><span id="l36.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_nsAbManager1.js</span>
<a href="#l36.3"></a><span id="l36.3" class="difflineat">@@ -10,33 +10,33 @@ var gAblAll;</span>
<a href="#l36.4"></a><span id="l36.4"> var gAblSingle = new Array(numListenerOptions);</span>
<a href="#l36.5"></a><span id="l36.5"> </span>
<a href="#l36.6"></a><span id="l36.6"> function abL() {}</span>
<a href="#l36.7"></a><span id="l36.7"> </span>
<a href="#l36.8"></a><span id="l36.8"> abL.prototype = {</span>
<a href="#l36.9"></a><span id="l36.9">  mReceived: 0,</span>
<a href="#l36.10"></a><span id="l36.10">  mAutoRemoveItem: false,</span>
<a href="#l36.11"></a><span id="l36.11"> </span>
<a href="#l36.12"></a><span id="l36.12" class="difflineminus">-  onItemAdded: function (parentItem, item) {</span>
<a href="#l36.13"></a><span id="l36.13" class="difflineplus">+  onItemAdded(parentItem, item) {</span>
<a href="#l36.14"></a><span id="l36.14">     this.mReceived |= nsIAbListener.itemAdded;</span>
<a href="#l36.15"></a><span id="l36.15">     if (this.mAutoRemoveItem)</span>
<a href="#l36.16"></a><span id="l36.16">       MailServices.ab.removeAddressBookListener(this);</span>
<a href="#l36.17"></a><span id="l36.17">   },</span>
<a href="#l36.18"></a><span id="l36.18" class="difflineminus">-  onItemRemoved: function (parentItem, item) {</span>
<a href="#l36.19"></a><span id="l36.19" class="difflineplus">+  onItemRemoved(parentItem, item) {</span>
<a href="#l36.20"></a><span id="l36.20">     this.mReceived |=</span>
<a href="#l36.21"></a><span id="l36.21">       (item == MailServices.ab ? nsIAbListener.directoryRemoved :</span>
<a href="#l36.22"></a><span id="l36.22">                                  nsIAbListener.directoryItemRemoved);</span>
<a href="#l36.23"></a><span id="l36.23">     if (this.mAutoRemoveItem)</span>
<a href="#l36.24"></a><span id="l36.24">       MailServices.ab.removeAddressBookListener(this);</span>
<a href="#l36.25"></a><span id="l36.25">   },</span>
<a href="#l36.26"></a><span id="l36.26" class="difflineminus">-  onItemPropertyChanged: function (item, property, oldValue, newValue) {</span>
<a href="#l36.27"></a><span id="l36.27" class="difflineplus">+  onItemPropertyChanged(item, property, oldValue, newValue) {</span>
<a href="#l36.28"></a><span id="l36.28">     this.mReceived |= nsIAbListener.itemChanged;</span>
<a href="#l36.29"></a><span id="l36.29">     if (this.mAutoRemoveItem)</span>
<a href="#l36.30"></a><span id="l36.30">       MailServices.ab.removeAddressBookListener(this);</span>
<a href="#l36.31"></a><span id="l36.31" class="difflineminus">-  }</span>
<a href="#l36.32"></a><span id="l36.32" class="difflineplus">+  },</span>
<a href="#l36.33"></a><span id="l36.33"> };</span>
<a href="#l36.34"></a><span id="l36.34"> </span>
<a href="#l36.35"></a><span id="l36.35"> function NotifyAbManager() {</span>
<a href="#l36.36"></a><span id="l36.36">   MailServices.ab.notifyItemPropertyChanged(null, null, null, null);</span>
<a href="#l36.37"></a><span id="l36.37">   MailServices.ab.notifyDirectoryItemAdded(null, null);</span>
<a href="#l36.38"></a><span id="l36.38">   MailServices.ab.notifyDirectoryItemDeleted(null, null);</span>
<a href="#l36.39"></a><span id="l36.39">   // MailServices.ab just happens to be nsISupports derived and makes it easy for</span>
<a href="#l36.40"></a><span id="l36.40">   // us to distinguish between xxxItemDeleted and xxxDeleted.</span>
<a href="#l36.41"></a><span id="l36.41" class="difflineat">@@ -85,19 +85,19 @@ function run_test() {</span>
<a href="#l36.42"></a><span id="l36.42">     Assert.equal(gAblSingle[i].mReceived, 1 &lt;&lt; i);</span>
<a href="#l36.43"></a><span id="l36.43">     gAblSingle[i].mReceived = 0;</span>
<a href="#l36.44"></a><span id="l36.44">   }</span>
<a href="#l36.45"></a><span id="l36.45"> </span>
<a href="#l36.46"></a><span id="l36.46">   // Test - Ensure the single listeners have been removed.</span>
<a href="#l36.47"></a><span id="l36.47"> </span>
<a href="#l36.48"></a><span id="l36.48">   NotifyAbManager();</span>
<a href="#l36.49"></a><span id="l36.49"> </span>
<a href="#l36.50"></a><span id="l36.50" class="difflineminus">-  Assert.equal(gAblAll.mReceived, (1 &lt;&lt;  numListenerOptions) - 1);</span>
<a href="#l36.51"></a><span id="l36.51" class="difflineplus">+  Assert.equal(gAblAll.mReceived, (1 &lt;&lt; numListenerOptions) - 1);</span>
<a href="#l36.52"></a><span id="l36.52">   gAblAll.mReceived = 0;</span>
<a href="#l36.53"></a><span id="l36.53"> </span>
<a href="#l36.54"></a><span id="l36.54">   for (i = 0; i &lt; numListenerOptions; ++i) {</span>
<a href="#l36.55"></a><span id="l36.55">     Assert.equal(gAblSingle[i].mReceived, 0);</span>
<a href="#l36.56"></a><span id="l36.56">   }</span>
<a href="#l36.57"></a><span id="l36.57"> </span>
<a href="#l36.58"></a><span id="l36.58">   // Test - Remove main listener</span>
<a href="#l36.59"></a><span id="l36.59"> </span>
<a href="#l36.60"></a><span id="l36.60">   MailServices.ab.removeAddressBookListener(gAblAll);</span>
<a href="#l36.61"></a><span id="l36.61" class="difflineminus">-};</span>
<a href="#l36.62"></a><span id="l36.62" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l37.1"></a><span id="l37.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_nsAbManager2.js</span>
<a href="#l37.2"></a><span id="l37.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_nsAbManager2.js</span>
<a href="#l37.3"></a><span id="l37.3" class="difflineat">@@ -13,34 +13,34 @@ var gAblSingle = new Array(numListenerOp</span>
<a href="#l37.4"></a><span id="l37.4"> </span>
<a href="#l37.5"></a><span id="l37.5"> function abL() {}</span>
<a href="#l37.6"></a><span id="l37.6"> </span>
<a href="#l37.7"></a><span id="l37.7"> abL.prototype = {</span>
<a href="#l37.8"></a><span id="l37.8">  mReceived: 0,</span>
<a href="#l37.9"></a><span id="l37.9">  mDirectory: null,</span>
<a href="#l37.10"></a><span id="l37.10">  mAutoRemoveItem: false,</span>
<a href="#l37.11"></a><span id="l37.11"> </span>
<a href="#l37.12"></a><span id="l37.12" class="difflineminus">-  onItemAdded: function (parentItem, item) {</span>
<a href="#l37.13"></a><span id="l37.13" class="difflineplus">+  onItemAdded(parentItem, item) {</span>
<a href="#l37.14"></a><span id="l37.14">     this.mReceived |= nsIAbListener.itemAdded;</span>
<a href="#l37.15"></a><span id="l37.15">     this.mDirectory = item;</span>
<a href="#l37.16"></a><span id="l37.16">     if (this.mAutoRemoveItem)</span>
<a href="#l37.17"></a><span id="l37.17">       MailServices.ab.removeAddressBookListener(this);</span>
<a href="#l37.18"></a><span id="l37.18">   },</span>
<a href="#l37.19"></a><span id="l37.19" class="difflineminus">-  onItemRemoved: function (parentItem, item) {</span>
<a href="#l37.20"></a><span id="l37.20" class="difflineplus">+  onItemRemoved(parentItem, item) {</span>
<a href="#l37.21"></a><span id="l37.21">     this.mReceived |= nsIAbListener.directoryRemoved;</span>
<a href="#l37.22"></a><span id="l37.22">     this.mDirectory = item;</span>
<a href="#l37.23"></a><span id="l37.23">     if (this.mAutoRemoveItem)</span>
<a href="#l37.24"></a><span id="l37.24">       MailServices.ab.removeAddressBookListener(this);</span>
<a href="#l37.25"></a><span id="l37.25">   },</span>
<a href="#l37.26"></a><span id="l37.26" class="difflineminus">-  onItemPropertyChanged: function (item, property, oldValue, newValue) {</span>
<a href="#l37.27"></a><span id="l37.27" class="difflineplus">+  onItemPropertyChanged(item, property, oldValue, newValue) {</span>
<a href="#l37.28"></a><span id="l37.28">     this.mReceived |= nsIAbListener.itemChanged;</span>
<a href="#l37.29"></a><span id="l37.29">     this.mDirectory = item;</span>
<a href="#l37.30"></a><span id="l37.30">     if (this.mAutoRemoveItem)</span>
<a href="#l37.31"></a><span id="l37.31">       MailServices.ab.removeAddressBookListener(this);</span>
<a href="#l37.32"></a><span id="l37.32" class="difflineminus">-  }</span>
<a href="#l37.33"></a><span id="l37.33" class="difflineplus">+  },</span>
<a href="#l37.34"></a><span id="l37.34"> };</span>
<a href="#l37.35"></a><span id="l37.35"> </span>
<a href="#l37.36"></a><span id="l37.36"> function checkDirs(aDirs, aDirArray) {</span>
<a href="#l37.37"></a><span id="l37.37">   // Don't modify the passed in array.</span>
<a href="#l37.38"></a><span id="l37.38">   var dirArray = aDirArray.concat();</span>
<a href="#l37.39"></a><span id="l37.39"> </span>
<a href="#l37.40"></a><span id="l37.40">   while (aDirs.hasMoreElements()) {</span>
<a href="#l37.41"></a><span id="l37.41">     var dir = aDirs.getNext().QueryInterface(nsIAbDirectory);</span>
<a href="#l37.42"></a><span id="l37.42" class="difflineat">@@ -68,19 +68,19 @@ function addDirectory(dirName) {</span>
<a href="#l37.43"></a><span id="l37.43"> </span>
<a href="#l37.44"></a><span id="l37.44">   gAblAll.mReceived = 0;</span>
<a href="#l37.45"></a><span id="l37.45">   gAblAll.mDirectory = null;</span>
<a href="#l37.46"></a><span id="l37.46"> </span>
<a href="#l37.47"></a><span id="l37.47">   for (var i = 0; i &lt; numListenerOptions; ++i) {</span>
<a href="#l37.48"></a><span id="l37.48">     if (1 &lt;&lt; i == nsIAbListener.itemAdded) {</span>
<a href="#l37.49"></a><span id="l37.49">       Assert.equal(gAblSingle[i].mReceived, nsIAbListener.itemAdded);</span>
<a href="#l37.50"></a><span id="l37.50">       gAblSingle[i].mReceived = 0;</span>
<a href="#l37.51"></a><span id="l37.51" class="difflineplus">+    } else {</span>
<a href="#l37.52"></a><span id="l37.52" class="difflineplus">+      Assert.equal(gAblSingle[i].mReceived, 0);</span>
<a href="#l37.53"></a><span id="l37.53">     }</span>
<a href="#l37.54"></a><span id="l37.54" class="difflineminus">-    else</span>
<a href="#l37.55"></a><span id="l37.55" class="difflineminus">-      Assert.equal(gAblSingle[i].mReceived, 0);</span>
<a href="#l37.56"></a><span id="l37.56">   }</span>
<a href="#l37.57"></a><span id="l37.57"> </span>
<a href="#l37.58"></a><span id="l37.58">   return newDirectory;</span>
<a href="#l37.59"></a><span id="l37.59"> }</span>
<a href="#l37.60"></a><span id="l37.60"> </span>
<a href="#l37.61"></a><span id="l37.61"> function removeDirectory(directory) {</span>
<a href="#l37.62"></a><span id="l37.62">   // Remove the directory</span>
<a href="#l37.63"></a><span id="l37.63">   MailServices.ab.deleteAddressBook(directory.URI);</span>
<a href="#l37.64"></a><span id="l37.64" class="difflineat">@@ -91,19 +91,19 @@ function removeDirectory(directory) {</span>
<a href="#l37.65"></a><span id="l37.65"> </span>
<a href="#l37.66"></a><span id="l37.66">   gAblAll.mReceived = 0;</span>
<a href="#l37.67"></a><span id="l37.67">   gAblAll.mDirectory = null;</span>
<a href="#l37.68"></a><span id="l37.68"> </span>
<a href="#l37.69"></a><span id="l37.69">   for (var i = 0; i &lt; numListenerOptions; ++i) {</span>
<a href="#l37.70"></a><span id="l37.70">     if (1 &lt;&lt; i == nsIAbListener.directoryRemoved) {</span>
<a href="#l37.71"></a><span id="l37.71">       Assert.equal(gAblSingle[i].mReceived, nsIAbListener.directoryRemoved);</span>
<a href="#l37.72"></a><span id="l37.72">       gAblSingle[i].mReceived = 0;</span>
<a href="#l37.73"></a><span id="l37.73" class="difflineplus">+    } else {</span>
<a href="#l37.74"></a><span id="l37.74" class="difflineplus">+      Assert.equal(gAblSingle[i].mReceived, 0);</span>
<a href="#l37.75"></a><span id="l37.75">     }</span>
<a href="#l37.76"></a><span id="l37.76" class="difflineminus">-    else</span>
<a href="#l37.77"></a><span id="l37.77" class="difflineminus">-      Assert.equal(gAblSingle[i].mReceived, 0);</span>
<a href="#l37.78"></a><span id="l37.78">   }</span>
<a href="#l37.79"></a><span id="l37.79"> }</span>
<a href="#l37.80"></a><span id="l37.80"> </span>
<a href="#l37.81"></a><span id="l37.81"> function run_test() {</span>
<a href="#l37.82"></a><span id="l37.82">   var i;</span>
<a href="#l37.83"></a><span id="l37.83"> </span>
<a href="#l37.84"></a><span id="l37.84">   // Set up listeners</span>
<a href="#l37.85"></a><span id="l37.85">   gAblAll = new abL;</span>
<a href="#l37.86"></a><span id="l37.86" class="difflineat">@@ -160,11 +160,11 @@ function run_test() {</span>
<a href="#l37.87"></a><span id="l37.87"> </span>
<a href="#l37.88"></a><span id="l37.88">   // Test - Check new directory list</span>
<a href="#l37.89"></a><span id="l37.89">   checkDirs(MailServices.ab.directories, expectedABs);</span>
<a href="#l37.90"></a><span id="l37.90"> </span>
<a href="#l37.91"></a><span id="l37.91">   // Test - Clear the listeners down</span>
<a href="#l37.92"></a><span id="l37.92"> </span>
<a href="#l37.93"></a><span id="l37.93">   MailServices.ab.removeAddressBookListener(gAblAll);</span>
<a href="#l37.94"></a><span id="l37.94"> </span>
<a href="#l37.95"></a><span id="l37.95" class="difflineminus">-  for (i = 0; i&lt; numListenerOptions; ++i)</span>
<a href="#l37.96"></a><span id="l37.96" class="difflineplus">+  for (i = 0; i &lt; numListenerOptions; ++i)</span>
<a href="#l37.97"></a><span id="l37.97">     MailServices.ab.removeAddressBookListener(gAblSingle[i]);</span>
<a href="#l37.98"></a><span id="l37.98" class="difflineminus">-};</span>
<a href="#l37.99"></a><span id="l37.99" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l38.1"></a><span id="l38.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_nsAbManager3.js</span>
<a href="#l38.2"></a><span id="l38.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_nsAbManager3.js</span>
<a href="#l38.3"></a><span id="l38.3" class="difflineat">@@ -10,36 +10,36 @@ var gAbListener;</span>
<a href="#l38.4"></a><span id="l38.4"> </span>
<a href="#l38.5"></a><span id="l38.5"> function abListener() {</span>
<a href="#l38.6"></a><span id="l38.6"> }</span>
<a href="#l38.7"></a><span id="l38.7"> </span>
<a href="#l38.8"></a><span id="l38.8"> abListener.prototype = {</span>
<a href="#l38.9"></a><span id="l38.9">   mReceived: 0,</span>
<a href="#l38.10"></a><span id="l38.10">   mDirectory: null,</span>
<a href="#l38.11"></a><span id="l38.11"> </span>
<a href="#l38.12"></a><span id="l38.12" class="difflineminus">-  onItemAdded: function(aParentItem, aItem) {</span>
<a href="#l38.13"></a><span id="l38.13" class="difflineplus">+  onItemAdded(aParentItem, aItem) {</span>
<a href="#l38.14"></a><span id="l38.14">     this.mReceived |= Ci.nsIAbListener.itemAdded;</span>
<a href="#l38.15"></a><span id="l38.15">     this.mDirectory = aItem;</span>
<a href="#l38.16"></a><span id="l38.16">   },</span>
<a href="#l38.17"></a><span id="l38.17"> </span>
<a href="#l38.18"></a><span id="l38.18" class="difflineminus">-  onItemRemoved: function(aParentItem, aItem) {</span>
<a href="#l38.19"></a><span id="l38.19" class="difflineplus">+  onItemRemoved(aParentItem, aItem) {</span>
<a href="#l38.20"></a><span id="l38.20">     this.mReceived |= Ci.nsIAbListener.directoryRemoved;</span>
<a href="#l38.21"></a><span id="l38.21">     this.mDirectory = aItem;</span>
<a href="#l38.22"></a><span id="l38.22">   },</span>
<a href="#l38.23"></a><span id="l38.23"> </span>
<a href="#l38.24"></a><span id="l38.24" class="difflineminus">-  onItemPropertyChanged: function(aItem, aProperty, aOldValue, aNewValue) {</span>
<a href="#l38.25"></a><span id="l38.25" class="difflineplus">+  onItemPropertyChanged(aItem, aProperty, aOldValue, aNewValue) {</span>
<a href="#l38.26"></a><span id="l38.26">     this.mReceived |= Ci.nsIAbListener.itemChanged;</span>
<a href="#l38.27"></a><span id="l38.27">     this.mDirectory = aItem;</span>
<a href="#l38.28"></a><span id="l38.28">   },</span>
<a href="#l38.29"></a><span id="l38.29"> </span>
<a href="#l38.30"></a><span id="l38.30" class="difflineminus">-  reset: function() {</span>
<a href="#l38.31"></a><span id="l38.31" class="difflineplus">+  reset() {</span>
<a href="#l38.32"></a><span id="l38.32">     this.mReceived = 0;</span>
<a href="#l38.33"></a><span id="l38.33">     this.mDirectory = null;</span>
<a href="#l38.34"></a><span id="l38.34" class="difflineminus">-  }</span>
<a href="#l38.35"></a><span id="l38.35" class="difflineminus">-}</span>
<a href="#l38.36"></a><span id="l38.36" class="difflineplus">+  },</span>
<a href="#l38.37"></a><span id="l38.37" class="difflineplus">+};</span>
<a href="#l38.38"></a><span id="l38.38"> </span>
<a href="#l38.39"></a><span id="l38.39"> function addDirectory(dirName) {</span>
<a href="#l38.40"></a><span id="l38.40">   MailServices.ab.newAddressBook(dirName, &quot;&quot;, kPABData.dirType);</span>
<a href="#l38.41"></a><span id="l38.41"> </span>
<a href="#l38.42"></a><span id="l38.42">   Assert.equal(gAbListener.mReceived, Ci.nsIAbListener.itemAdded);</span>
<a href="#l38.43"></a><span id="l38.43"> </span>
<a href="#l38.44"></a><span id="l38.44">   let newDirectory = gAbListener.mDirectory.QueryInterface(Ci.nsIAbDirectory);</span>
<a href="#l38.45"></a><span id="l38.45">   Assert.equal(newDirectory.dirName, dirName);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l39.1"></a><span id="l39.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_nsIAbCard.js</span>
<a href="#l39.2"></a><span id="l39.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_nsIAbCard.js</span>
<a href="#l39.3"></a><span id="l39.3" class="difflineat">@@ -18,18 +18,17 @@ function run_test() {</span>
<a href="#l39.4"></a><span id="l39.4"> </span>
<a href="#l39.5"></a><span id="l39.5">   // Test - Get the directory</span>
<a href="#l39.6"></a><span id="l39.6">   let AB = MailServices.ab.getDirectory(kPABData.URI);</span>
<a href="#l39.7"></a><span id="l39.7"> </span>
<a href="#l39.8"></a><span id="l39.8">   var childCards = AB.childCards;</span>
<a href="#l39.9"></a><span id="l39.9">   var fullCard = null;</span>
<a href="#l39.10"></a><span id="l39.10">   var tempCard;</span>
<a href="#l39.11"></a><span id="l39.11"> </span>
<a href="#l39.12"></a><span id="l39.12" class="difflineminus">-  while (childCards.hasMoreElements())</span>
<a href="#l39.13"></a><span id="l39.13" class="difflineminus">-  {</span>
<a href="#l39.14"></a><span id="l39.14" class="difflineplus">+  while (childCards.hasMoreElements()) {</span>
<a href="#l39.15"></a><span id="l39.15">     tempCard = childCards.getNext();</span>
<a href="#l39.16"></a><span id="l39.16"> </span>
<a href="#l39.17"></a><span id="l39.17">     // We want the one with the right email...</span>
<a href="#l39.18"></a><span id="l39.18">     if (tempCard instanceof Ci.nsIAbCard &amp;&amp;</span>
<a href="#l39.19"></a><span id="l39.19">         tempCard.primaryEmail == &quot;PrimaryEmail1@test.invalid&quot;)</span>
<a href="#l39.20"></a><span id="l39.20">       fullCard = tempCard;</span>
<a href="#l39.21"></a><span id="l39.21">   }</span>
<a href="#l39.22"></a><span id="l39.22"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l40.1"></a><span id="l40.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_uid.js</span>
<a href="#l40.2"></a><span id="l40.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_uid.js</span>
<a href="#l40.3"></a><span id="l40.3" class="difflineat">@@ -92,17 +92,17 @@ add_task(async function newListUID() {</span>
<a href="#l40.4"></a><span id="l40.4">   ok(!!bookCards.find(c =&gt; c.UID == list.UID, &quot;New reference to list has the same UID&quot;));</span>
<a href="#l40.5"></a><span id="l40.5"> </span>
<a href="#l40.6"></a><span id="l40.6">   await checkFileForUID(list.UID, book.fileName);</span>
<a href="#l40.7"></a><span id="l40.7"> });</span>
<a href="#l40.8"></a><span id="l40.8"> </span>
<a href="#l40.9"></a><span id="l40.9"> // 3 seems to be the lowest number that works here. I don't know why.</span>
<a href="#l40.10"></a><span id="l40.10"> var count = 3;</span>
<a href="#l40.11"></a><span id="l40.11"> function newAddressBookFile() {</span>
<a href="#l40.12"></a><span id="l40.12" class="difflineminus">-  let foo = MailServices.ab.newAddressBook(`book${count}`, `moz-abmdbdirectory://abook-${count}.mab`, 2);</span>
<a href="#l40.13"></a><span id="l40.13" class="difflineplus">+  MailServices.ab.newAddressBook(`book${count}`, `moz-abmdbdirectory://abook-${count}.mab`, 2);</span>
<a href="#l40.14"></a><span id="l40.14"> </span>
<a href="#l40.15"></a><span id="l40.15">   let testAB = do_get_file(&quot;data/existing.mab&quot;);</span>
<a href="#l40.16"></a><span id="l40.16">   testAB.copyTo(profD, `abook-${count}.mab`);</span>
<a href="#l40.17"></a><span id="l40.17"> </span>
<a href="#l40.18"></a><span id="l40.18">   Services.prefs.setCharPref(`ldap_2.servers.book${count}.filename`, `abook-${count}.mab`);</span>
<a href="#l40.19"></a><span id="l40.19"> </span>
<a href="#l40.20"></a><span id="l40.20">   let book = MailServices.ab.getDirectory(`moz-abmdbdirectory://abook-${count}.mab`);</span>
<a href="#l40.21"></a><span id="l40.21">   equal(2, [...book.childCards].length);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l41.1"></a><span id="l41.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_uuid.js</span>
<a href="#l41.2"></a><span id="l41.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_uuid.js</span>
<a href="#l41.3"></a><span id="l41.3" class="difflineat">@@ -4,33 +4,33 @@</span>
<a href="#l41.4"></a><span id="l41.4"> </span>
<a href="#l41.5"></a><span id="l41.5"> /**</span>
<a href="#l41.6"></a><span id="l41.6">  * Checks that the directory follows the contract for UUIDs.</span>
<a href="#l41.7"></a><span id="l41.7">  *</span>
<a href="#l41.8"></a><span id="l41.8">  * If the directory is modifiable, it will be modified, although the net effect</span>
<a href="#l41.9"></a><span id="l41.9">  * will not change the state if the code works properly.</span>
<a href="#l41.10"></a><span id="l41.10">  */</span>
<a href="#l41.11"></a><span id="l41.11"> function check_directory(directory) {</span>
<a href="#l41.12"></a><span id="l41.12" class="difflineminus">-  var prefId = directory.dirPrefId + '&amp;' + directory.dirName;</span>
<a href="#l41.13"></a><span id="l41.13" class="difflineplus">+  var prefId = directory.dirPrefId + &quot;&amp;&quot; + directory.dirName;</span>
<a href="#l41.14"></a><span id="l41.14"> </span>
<a href="#l41.15"></a><span id="l41.15">   var testModification = !directory.readOnly;</span>
<a href="#l41.16"></a><span id="l41.16">   dump(&quot;Testing &quot; + prefId);</span>
<a href="#l41.17"></a><span id="l41.17">   if (testModification)</span>
<a href="#l41.18"></a><span id="l41.18">     dump(&quot; (with modifications)&quot;);</span>
<a href="#l41.19"></a><span id="l41.19">   dump(&quot;...\n&quot;);</span>
<a href="#l41.20"></a><span id="l41.20"> </span>
<a href="#l41.21"></a><span id="l41.21">   // Question 1: Is the UUID the preference ID?</span>
<a href="#l41.22"></a><span id="l41.22">   Assert.equal(prefId, directory.uuid);</span>
<a href="#l41.23"></a><span id="l41.23"> </span>
<a href="#l41.24"></a><span id="l41.24">   // Now we need to run through the cards, checking that each card meets the</span>
<a href="#l41.25"></a><span id="l41.25">   // requirements.</span>
<a href="#l41.26"></a><span id="l41.26">   var seenIds = [], cards = [];</span>
<a href="#l41.27"></a><span id="l41.27">   var enumerator = directory.childCards;</span>
<a href="#l41.28"></a><span id="l41.28">   while (enumerator.hasMoreElements()) {</span>
<a href="#l41.29"></a><span id="l41.29" class="difflineminus">-    var card = enumerator.getNext().QueryInterface(Ci.nsIAbCard);</span>
<a href="#l41.30"></a><span id="l41.30" class="difflineplus">+    let card = enumerator.getNext().QueryInterface(Ci.nsIAbCard);</span>
<a href="#l41.31"></a><span id="l41.31">     cards.push(card);</span>
<a href="#l41.32"></a><span id="l41.32"> </span>
<a href="#l41.33"></a><span id="l41.33">     // Question 2.1: Is the directory ID correct?</span>
<a href="#l41.34"></a><span id="l41.34">     Assert.equal(prefId, card.directoryId);</span>
<a href="#l41.35"></a><span id="l41.35"> </span>
<a href="#l41.36"></a><span id="l41.36">     // Question 2.2: Is the local ID unique and valid?</span>
<a href="#l41.37"></a><span id="l41.37">     Assert.notEqual(card.localId, &quot;&quot;);</span>
<a href="#l41.38"></a><span id="l41.38">     Assert.equal(seenIds.indexOf(card.localId), -1);</span>
<a href="#l41.39"></a><span id="l41.39" class="difflineat">@@ -42,17 +42,17 @@ function check_directory(directory) {</span>
<a href="#l41.40"></a><span id="l41.40"> </span>
<a href="#l41.41"></a><span id="l41.41">   // Question 3: Do cards returned via searches return UUIDs correctly?</span>
<a href="#l41.42"></a><span id="l41.42">   var uri = directory.URI;</span>
<a href="#l41.43"></a><span id="l41.43">   uri += &quot;?(or(DisplayName,=,a)(DisplayName,!=,a))&quot;;</span>
<a href="#l41.44"></a><span id="l41.44">   let search = MailServices.ab.getDirectory(uri);</span>
<a href="#l41.45"></a><span id="l41.45"> </span>
<a href="#l41.46"></a><span id="l41.46">   enumerator = search.childCards;</span>
<a href="#l41.47"></a><span id="l41.47">   while (enumerator.hasMoreElements()) {</span>
<a href="#l41.48"></a><span id="l41.48" class="difflineminus">-    var card = enumerator.getNext().QueryInterface(Ci.nsIAbCard);</span>
<a href="#l41.49"></a><span id="l41.49" class="difflineplus">+    let card = enumerator.getNext().QueryInterface(Ci.nsIAbCard);</span>
<a href="#l41.50"></a><span id="l41.50"> </span>
<a href="#l41.51"></a><span id="l41.51">     // Question 3.1: Is the directory ID correct?</span>
<a href="#l41.52"></a><span id="l41.52">     Assert.equal(prefId, card.directoryId);</span>
<a href="#l41.53"></a><span id="l41.53"> </span>
<a href="#l41.54"></a><span id="l41.54">     // Question 3.2: Is the local ID valid?</span>
<a href="#l41.55"></a><span id="l41.55">     Assert.notEqual(card.localId, &quot;&quot;);</span>
<a href="#l41.56"></a><span id="l41.56"> </span>
<a href="#l41.57"></a><span id="l41.57">     // Question 3.3: Is the format equal to generateUUID?</span>
<a href="#l41.58"></a><span id="l41.58" class="difflineat">@@ -78,17 +78,17 @@ function check_directory(directory) {</span>
<a href="#l41.59"></a><span id="l41.59"> </span>
<a href="#l41.60"></a><span id="l41.60">   // Remove the new card to be stable!</span>
<a href="#l41.61"></a><span id="l41.61">   var array = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l41.62"></a><span id="l41.62">   array.appendElement(newCard);</span>
<a href="#l41.63"></a><span id="l41.63">   directory.deleteCards(array);</span>
<a href="#l41.64"></a><span id="l41.64"> </span>
<a href="#l41.65"></a><span id="l41.65">   // We need to iterate over the array of cards to avoid any problems if someone</span>
<a href="#l41.66"></a><span id="l41.66">   // makes the childCards enumerator reflect changes to directory...</span>
<a href="#l41.67"></a><span id="l41.67" class="difflineminus">-  for (var card of cards) {</span>
<a href="#l41.68"></a><span id="l41.68" class="difflineplus">+  for (let card of cards) {</span>
<a href="#l41.69"></a><span id="l41.69">     // Question 5.1: Does deleting a card properly set the uids?</span>
<a href="#l41.70"></a><span id="l41.70">     var localId = card.localId;</span>
<a href="#l41.71"></a><span id="l41.71">     array.clear();</span>
<a href="#l41.72"></a><span id="l41.72">     array.appendElement(card);</span>
<a href="#l41.73"></a><span id="l41.73">     directory.deleteCards(array);</span>
<a href="#l41.74"></a><span id="l41.74">     Assert.equal(card.directoryId, &quot;&quot;);</span>
<a href="#l41.75"></a><span id="l41.75">     Assert.equal(card.localId, localId);</span>
<a href="#l41.76"></a><span id="l41.76"> </span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:32Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

