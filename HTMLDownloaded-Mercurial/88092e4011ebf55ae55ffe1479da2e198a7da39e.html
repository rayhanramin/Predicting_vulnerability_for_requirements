<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 2331:88092e4011ebf55ae55ffe1479da2e198a7da39e</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 88092e4011ebf55ae55ffe1479da2e198a7da39e" />
<meta property="og:url" content="/comm-central/rev/88092e4011ebf55ae55ffe1479da2e198a7da39e" />
<meta property="og:description" content="Fix part of bug 353492 - support multiple alarms per events/task, support absolute alarms with fixed date/time - Alarm Service/Monitor and random fixes. r=dbo,ssitter" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 88092e4011ebf55ae55ffe1479da2e198a7da39e 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/88092e4011ebf55ae55ffe1479da2e198a7da39e">shortlog</a> |
<a href="/comm-central/log/88092e4011ebf55ae55ffe1479da2e198a7da39e">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/88092e4011ebf55ae55ffe1479da2e198a7da39e">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/88092e4011ebf55ae55ffe1479da2e198a7da39e">files</a> |
changeset |
<a href="/comm-central/raw-rev/88092e4011ebf55ae55ffe1479da2e198a7da39e">raw</a>  | <a href="/comm-central/archive/88092e4011ebf55ae55ffe1479da2e198a7da39e.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
Fix part of <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=353492">bug 353492</a> - support multiple alarms per events/task, support absolute alarms with fixed date/time - Alarm Service/Monitor and random fixes. r=dbo,ssitter
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#80;&#104;&#105;&#108;&#105;&#112;&#112;&#32;&#75;&#101;&#119;&#105;&#115;&#99;&#104;&#32;&#60;&#109;&#111;&#122;&#105;&#108;&#108;&#97;&#64;&#107;&#101;&#119;&#105;&#115;&#46;&#99;&#104;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 02 Apr 2009 22:06:49 +0200</td></tr>

<tr>
 <td>changeset 2331</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/88092e4011ebf55ae55ffe1479da2e198a7da39e">88092e4011ebf55ae55ffe1479da2e198a7da39e</a></td>
</tr>



<tr>
<td>parent 2330</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/cce4879cdf36e9e866cdd65dd58028d592213eff">cce4879cdf36e9e866cdd65dd58028d592213eff</a>
</td>
</tr>

<tr>
<td>child 2332</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/750958a0d6c9d7e489396d0de66eca7056cdc1e8">750958a0d6c9d7e489396d0de66eca7056cdc1e8</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=88092e4011ebf55ae55ffe1479da2e198a7da39e">1887</a></td></tr>
<tr><td>push user</td><td>mozilla@kewis.ch</td></tr>
<tr><td>push date</td><td class="date age">Thu, 02 Apr 2009 20:17:24 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@88092e4011eb [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=88092e4011ebf55ae55ffe1479da2e198a7da39e">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=88092e4011ebf55ae55ffe1479da2e198a7da39e&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=88092e4011ebf55ae55ffe1479da2e198a7da39e&newProject=comm-central&newRevision=cce4879cdf36e9e866cdd65dd58028d592213eff&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=88092e4011ebf55ae55ffe1479da2e198a7da39e&newProject=comm-central&newRevision=cce4879cdf36e9e866cdd65dd58028d592213eff&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=88092e4011ebf55ae55ffe1479da2e198a7da39e&newProject=comm-central&newRevision=cce4879cdf36e9e866cdd65dd58028d592213eff&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28dbo%29&revcount=50">dbo</a>, <a href="/comm-central/log?rev=reviewer%28ssitter%29&revcount=50">ssitter</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=353492">353492</a></td></tr>




</table></div>

<div class="page_body description">Fix part of <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=353492">bug 353492</a> - support multiple alarms per events/task, support absolute alarms with fixed date/time - Alarm Service/Monitor and random fixes. r=dbo,ssitter</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/88092e4011ebf55ae55ffe1479da2e198a7da39e/calendar/base/content/calendar-alarm-dialog.js">calendar/base/content/calendar-alarm-dialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/88092e4011ebf55ae55ffe1479da2e198a7da39e/calendar/base/content/calendar-alarm-dialog.js">file</a> |
<a href="/comm-central/annotate/88092e4011ebf55ae55ffe1479da2e198a7da39e/calendar/base/content/calendar-alarm-dialog.js">annotate</a> |
<a href="/comm-central/diff/88092e4011ebf55ae55ffe1479da2e198a7da39e/calendar/base/content/calendar-alarm-dialog.js">diff</a> |
<a href="/comm-central/comparison/88092e4011ebf55ae55ffe1479da2e198a7da39e/calendar/base/content/calendar-alarm-dialog.js">comparison</a> |
<a href="/comm-central/log/88092e4011ebf55ae55ffe1479da2e198a7da39e/calendar/base/content/calendar-alarm-dialog.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/88092e4011ebf55ae55ffe1479da2e198a7da39e/calendar/base/content/calendar-alarm-widget.xml">calendar/base/content/calendar-alarm-widget.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/88092e4011ebf55ae55ffe1479da2e198a7da39e/calendar/base/content/calendar-alarm-widget.xml">file</a> |
<a href="/comm-central/annotate/88092e4011ebf55ae55ffe1479da2e198a7da39e/calendar/base/content/calendar-alarm-widget.xml">annotate</a> |
<a href="/comm-central/diff/88092e4011ebf55ae55ffe1479da2e198a7da39e/calendar/base/content/calendar-alarm-widget.xml">diff</a> |
<a href="/comm-central/comparison/88092e4011ebf55ae55ffe1479da2e198a7da39e/calendar/base/content/calendar-alarm-widget.xml">comparison</a> |
<a href="/comm-central/log/88092e4011ebf55ae55ffe1479da2e198a7da39e/calendar/base/content/calendar-alarm-widget.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/88092e4011ebf55ae55ffe1479da2e198a7da39e/calendar/base/content/dialogs/calendar-event-dialog-reminder.js">calendar/base/content/dialogs/calendar-event-dialog-reminder.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/88092e4011ebf55ae55ffe1479da2e198a7da39e/calendar/base/content/dialogs/calendar-event-dialog-reminder.js">file</a> |
<a href="/comm-central/annotate/88092e4011ebf55ae55ffe1479da2e198a7da39e/calendar/base/content/dialogs/calendar-event-dialog-reminder.js">annotate</a> |
<a href="/comm-central/diff/88092e4011ebf55ae55ffe1479da2e198a7da39e/calendar/base/content/dialogs/calendar-event-dialog-reminder.js">diff</a> |
<a href="/comm-central/comparison/88092e4011ebf55ae55ffe1479da2e198a7da39e/calendar/base/content/dialogs/calendar-event-dialog-reminder.js">comparison</a> |
<a href="/comm-central/log/88092e4011ebf55ae55ffe1479da2e198a7da39e/calendar/base/content/dialogs/calendar-event-dialog-reminder.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/88092e4011ebf55ae55ffe1479da2e198a7da39e/calendar/base/modules/calAlarmUtils.jsm">calendar/base/modules/calAlarmUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/88092e4011ebf55ae55ffe1479da2e198a7da39e/calendar/base/modules/calAlarmUtils.jsm">file</a> |
<a href="/comm-central/annotate/88092e4011ebf55ae55ffe1479da2e198a7da39e/calendar/base/modules/calAlarmUtils.jsm">annotate</a> |
<a href="/comm-central/diff/88092e4011ebf55ae55ffe1479da2e198a7da39e/calendar/base/modules/calAlarmUtils.jsm">diff</a> |
<a href="/comm-central/comparison/88092e4011ebf55ae55ffe1479da2e198a7da39e/calendar/base/modules/calAlarmUtils.jsm">comparison</a> |
<a href="/comm-central/log/88092e4011ebf55ae55ffe1479da2e198a7da39e/calendar/base/modules/calAlarmUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/88092e4011ebf55ae55ffe1479da2e198a7da39e/calendar/base/public/calIAlarmService.idl">calendar/base/public/calIAlarmService.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/88092e4011ebf55ae55ffe1479da2e198a7da39e/calendar/base/public/calIAlarmService.idl">file</a> |
<a href="/comm-central/annotate/88092e4011ebf55ae55ffe1479da2e198a7da39e/calendar/base/public/calIAlarmService.idl">annotate</a> |
<a href="/comm-central/diff/88092e4011ebf55ae55ffe1479da2e198a7da39e/calendar/base/public/calIAlarmService.idl">diff</a> |
<a href="/comm-central/comparison/88092e4011ebf55ae55ffe1479da2e198a7da39e/calendar/base/public/calIAlarmService.idl">comparison</a> |
<a href="/comm-central/log/88092e4011ebf55ae55ffe1479da2e198a7da39e/calendar/base/public/calIAlarmService.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/88092e4011ebf55ae55ffe1479da2e198a7da39e/calendar/base/src/calAlarm.js">calendar/base/src/calAlarm.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/88092e4011ebf55ae55ffe1479da2e198a7da39e/calendar/base/src/calAlarm.js">file</a> |
<a href="/comm-central/annotate/88092e4011ebf55ae55ffe1479da2e198a7da39e/calendar/base/src/calAlarm.js">annotate</a> |
<a href="/comm-central/diff/88092e4011ebf55ae55ffe1479da2e198a7da39e/calendar/base/src/calAlarm.js">diff</a> |
<a href="/comm-central/comparison/88092e4011ebf55ae55ffe1479da2e198a7da39e/calendar/base/src/calAlarm.js">comparison</a> |
<a href="/comm-central/log/88092e4011ebf55ae55ffe1479da2e198a7da39e/calendar/base/src/calAlarm.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/88092e4011ebf55ae55ffe1479da2e198a7da39e/calendar/base/src/calAlarmMonitor.js">calendar/base/src/calAlarmMonitor.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/88092e4011ebf55ae55ffe1479da2e198a7da39e/calendar/base/src/calAlarmMonitor.js">file</a> |
<a href="/comm-central/annotate/88092e4011ebf55ae55ffe1479da2e198a7da39e/calendar/base/src/calAlarmMonitor.js">annotate</a> |
<a href="/comm-central/diff/88092e4011ebf55ae55ffe1479da2e198a7da39e/calendar/base/src/calAlarmMonitor.js">diff</a> |
<a href="/comm-central/comparison/88092e4011ebf55ae55ffe1479da2e198a7da39e/calendar/base/src/calAlarmMonitor.js">comparison</a> |
<a href="/comm-central/log/88092e4011ebf55ae55ffe1479da2e198a7da39e/calendar/base/src/calAlarmMonitor.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/88092e4011ebf55ae55ffe1479da2e198a7da39e/calendar/base/src/calAlarmService.js">calendar/base/src/calAlarmService.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/88092e4011ebf55ae55ffe1479da2e198a7da39e/calendar/base/src/calAlarmService.js">file</a> |
<a href="/comm-central/annotate/88092e4011ebf55ae55ffe1479da2e198a7da39e/calendar/base/src/calAlarmService.js">annotate</a> |
<a href="/comm-central/diff/88092e4011ebf55ae55ffe1479da2e198a7da39e/calendar/base/src/calAlarmService.js">diff</a> |
<a href="/comm-central/comparison/88092e4011ebf55ae55ffe1479da2e198a7da39e/calendar/base/src/calAlarmService.js">comparison</a> |
<a href="/comm-central/log/88092e4011ebf55ae55ffe1479da2e198a7da39e/calendar/base/src/calAlarmService.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/calendar/base/content/calendar-alarm-dialog.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/calendar/base/content/calendar-alarm-dialog.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -58,41 +58,41 @@ function getAlarmService() {</span>
<a href="#l1.4"></a><span id="l1.4">  * @param event     The snooze event</span>
<a href="#l1.5"></a><span id="l1.5">  */</span>
<a href="#l1.6"></a><span id="l1.6"> function onSnoozeAlarm(event) {</span>
<a href="#l1.7"></a><span id="l1.7">     // reschedule alarm:</span>
<a href="#l1.8"></a><span id="l1.8">     var duration = Components.classes[&quot;@mozilla.org/calendar/duration;1&quot;]</span>
<a href="#l1.9"></a><span id="l1.9">                              .createInstance(Components.interfaces.calIDuration);</span>
<a href="#l1.10"></a><span id="l1.10">     duration.minutes = event.detail;</span>
<a href="#l1.11"></a><span id="l1.11">     duration.normalize();</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-    getAlarmService().snoozeAlarm(event.target.item, duration);</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+    getAlarmService().snoozeAlarm(event.target.item, event.target.alarm, duration);</span>
<a href="#l1.14"></a><span id="l1.14"> }</span>
<a href="#l1.15"></a><span id="l1.15"> </span>
<a href="#l1.16"></a><span id="l1.16"> /**</span>
<a href="#l1.17"></a><span id="l1.17">  * Event handler for the 'dismiss' event. Dismisses the given alarm using the</span>
<a href="#l1.18"></a><span id="l1.18">  * alarm service.</span>
<a href="#l1.19"></a><span id="l1.19">  *</span>
<a href="#l1.20"></a><span id="l1.20">  * @param event     The snooze event</span>
<a href="#l1.21"></a><span id="l1.21">  */</span>
<a href="#l1.22"></a><span id="l1.22"> function onDismissAlarm(event) {</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineminus">-    getAlarmService().dismissAlarm(event.target.item);</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineplus">+    getAlarmService().dismissAlarm(event.target.item, event.target.alarm);</span>
<a href="#l1.25"></a><span id="l1.25"> }</span>
<a href="#l1.26"></a><span id="l1.26"> </span>
<a href="#l1.27"></a><span id="l1.27"> /**</span>
<a href="#l1.28"></a><span id="l1.28">  * Called to dismiss all alarms in the alarm window.</span>
<a href="#l1.29"></a><span id="l1.29">  */</span>
<a href="#l1.30"></a><span id="l1.30"> function onDismissAllAlarms() {</span>
<a href="#l1.31"></a><span id="l1.31">     // removes widgets on the fly:</span>
<a href="#l1.32"></a><span id="l1.32">     var alarmRichlist = document.getElementById(&quot;alarm-richlist&quot;);</span>
<a href="#l1.33"></a><span id="l1.33"> </span>
<a href="#l1.34"></a><span id="l1.34">     // Make a copy of the child nodes as they get modified live</span>
<a href="#l1.35"></a><span id="l1.35">     for each (let node in Array.slice(alarmRichlist.childNodes)) {</span>
<a href="#l1.36"></a><span id="l1.36">         // Check if the node is a valid alarm and is still part of DOM</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineminus">-        if (node.item &amp;&amp; node.parentNode) {</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineminus">-            getAlarmService().dismissAlarm(node.item);</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineplus">+        if (node.parentNode &amp;&amp; node.item &amp;&amp; node.alarm) {</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+            getAlarmService().dismissAlarm(node.item, node.alarm);</span>
<a href="#l1.41"></a><span id="l1.41">         }</span>
<a href="#l1.42"></a><span id="l1.42">     }</span>
<a href="#l1.43"></a><span id="l1.43"> }</span>
<a href="#l1.44"></a><span id="l1.44"> </span>
<a href="#l1.45"></a><span id="l1.45"> /**</span>
<a href="#l1.46"></a><span id="l1.46">  * Event handler fired when the alarm widget's &quot;Details...&quot; label was clicked.</span>
<a href="#l1.47"></a><span id="l1.47">  * Open the event dialog in the most recent Sunbird or Thunderbird window</span>
<a href="#l1.48"></a><span id="l1.48">  *</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineat">@@ -162,19 +162,19 @@ function onFocusWindow() {</span>
<a href="#l1.50"></a><span id="l1.50">     }</span>
<a href="#l1.51"></a><span id="l1.51"> }</span>
<a href="#l1.52"></a><span id="l1.52"> </span>
<a href="#l1.53"></a><span id="l1.53"> /**</span>
<a href="#l1.54"></a><span id="l1.54">  * Timer callback to update all relative date labels</span>
<a href="#l1.55"></a><span id="l1.55">  */</span>
<a href="#l1.56"></a><span id="l1.56"> function updateRelativeDates() {</span>
<a href="#l1.57"></a><span id="l1.57">     var alarmRichlist = document.getElementById(&quot;alarm-richlist&quot;);</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineminus">-    for (var i = alarmRichlist.childNodes.length - 1; i &gt;= 0; i--) {</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineminus">-        if (alarmRichlist.childNodes[i].item) {</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineminus">-            alarmRichlist.childNodes[i].updateRelativeDateLabel();</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineplus">+    for each (let node in Array.slice(alarmRichlist.childNodes)) {</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineplus">+        if (node.item &amp;&amp; node.alarm) {</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineplus">+            node.updateRelativeDateLabel();</span>
<a href="#l1.64"></a><span id="l1.64">         }</span>
<a href="#l1.65"></a><span id="l1.65">     }</span>
<a href="#l1.66"></a><span id="l1.66"> }</span>
<a href="#l1.67"></a><span id="l1.67"> </span>
<a href="#l1.68"></a><span id="l1.68"> /**</span>
<a href="#l1.69"></a><span id="l1.69">  * Opens the alarm snooze popup, using the event to determine the position.</span>
<a href="#l1.70"></a><span id="l1.70">  * The given container item must be an object that has a function snoozeAlarm.</span>
<a href="#l1.71"></a><span id="l1.71">  * This function will be called with the chosen alarm duration in minutes.</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineat">@@ -203,70 +203,74 @@ function snoozeAllItems(aDurationMinutes</span>
<a href="#l1.73"></a><span id="l1.73">     duration.minutes = aDurationMinutes;</span>
<a href="#l1.74"></a><span id="l1.74">     duration.normalize();</span>
<a href="#l1.75"></a><span id="l1.75"> </span>
<a href="#l1.76"></a><span id="l1.76">     var alarmRichlist = document.getElementById(&quot;alarm-richlist&quot;);</span>
<a href="#l1.77"></a><span id="l1.77"> </span>
<a href="#l1.78"></a><span id="l1.78">     // Make a copy of the child nodes as they get modified live</span>
<a href="#l1.79"></a><span id="l1.79">     for each (let node in Array.slice(alarmRichlist.childNodes)) {</span>
<a href="#l1.80"></a><span id="l1.80">         // Check if the node is a valid alarm and is still part of DOM</span>
<a href="#l1.81"></a><span id="l1.81" class="difflineminus">-        if (node.item &amp;&amp; node.parentNode) {</span>
<a href="#l1.82"></a><span id="l1.82" class="difflineminus">-            getAlarmService().snoozeAlarm(node.item, duration);</span>
<a href="#l1.83"></a><span id="l1.83" class="difflineplus">+        if (node.parentNode &amp;&amp; node.item &amp;&amp; node.alarm) {</span>
<a href="#l1.84"></a><span id="l1.84" class="difflineplus">+            getAlarmService().snoozeAlarm(node.item, node.alarm, duration);</span>
<a href="#l1.85"></a><span id="l1.85">         }</span>
<a href="#l1.86"></a><span id="l1.86">     }</span>
<a href="#l1.87"></a><span id="l1.87"> }</span>
<a href="#l1.88"></a><span id="l1.88"> </span>
<a href="#l1.89"></a><span id="l1.89"> /**</span>
<a href="#l1.90"></a><span id="l1.90">  * Sets up the window title, counting the number of alarms in the window.</span>
<a href="#l1.91"></a><span id="l1.91">  */</span>
<a href="#l1.92"></a><span id="l1.92"> function setupTitle() {</span>
<a href="#l1.93"></a><span id="l1.93">     var alarmRichlist = document.getElementById(&quot;alarm-richlist&quot;);</span>
<a href="#l1.94"></a><span id="l1.94">     var reminders = alarmRichlist.childNodes.length;</span>
<a href="#l1.95"></a><span id="l1.95"> </span>
<a href="#l1.96"></a><span id="l1.96">     let title = PluralForm.get(reminders, calGetString(&quot;calendar&quot;, &quot;alarmWindowTitle.label&quot;));</span>
<a href="#l1.97"></a><span id="l1.97">     document.title = title.replace(&quot;#1&quot;, reminders);</span>
<a href="#l1.98"></a><span id="l1.98"> }</span>
<a href="#l1.99"></a><span id="l1.99"> </span>
<a href="#l1.100"></a><span id="l1.100"> /**</span>
<a href="#l1.101"></a><span id="l1.101" class="difflineminus">- * Add an alarm widget for the passed calendar item</span>
<a href="#l1.102"></a><span id="l1.102" class="difflineplus">+ * Add an alarm widget for the passed alarm and item.</span>
<a href="#l1.103"></a><span id="l1.103">  *</span>
<a href="#l1.104"></a><span id="l1.104">  * @param aItem       The calendar item to add a widget for.</span>
<a href="#l1.105"></a><span id="l1.105" class="difflineplus">+ * @param aAlarm      The alarm to add a widget for.</span>
<a href="#l1.106"></a><span id="l1.106">  */</span>
<a href="#l1.107"></a><span id="l1.107" class="difflineminus">-function addWidgetFor(aItem) {</span>
<a href="#l1.108"></a><span id="l1.108" class="difflineminus">-    var widget = document.createElement(&quot;calendar-alarm-widget&quot;);</span>
<a href="#l1.109"></a><span id="l1.109" class="difflineminus">-    var alarmRichlist = document.getElementById(&quot;alarm-richlist&quot;);</span>
<a href="#l1.110"></a><span id="l1.110" class="difflineplus">+function addWidgetFor(aItem, aAlarm) {</span>
<a href="#l1.111"></a><span id="l1.111" class="difflineplus">+    let widget = document.createElement(&quot;calendar-alarm-widget&quot;);</span>
<a href="#l1.112"></a><span id="l1.112" class="difflineplus">+    let alarmRichlist = document.getElementById(&quot;alarm-richlist&quot;);</span>
<a href="#l1.113"></a><span id="l1.113">     alarmRichlist.appendChild(widget);</span>
<a href="#l1.114"></a><span id="l1.114"> </span>
<a href="#l1.115"></a><span id="l1.115">     widget.item = aItem;</span>
<a href="#l1.116"></a><span id="l1.116" class="difflineplus">+    widget.alarm = aAlarm;</span>
<a href="#l1.117"></a><span id="l1.117">     widget.addEventListener(&quot;snooze&quot;, onSnoozeAlarm, false);</span>
<a href="#l1.118"></a><span id="l1.118">     widget.addEventListener(&quot;dismiss&quot;, onDismissAlarm, false);</span>
<a href="#l1.119"></a><span id="l1.119">     widget.addEventListener(&quot;itemdetails&quot;, onItemDetails, false);</span>
<a href="#l1.120"></a><span id="l1.120"> </span>
<a href="#l1.121"></a><span id="l1.121">     setupTitle();</span>
<a href="#l1.122"></a><span id="l1.122"> </span>
<a href="#l1.123"></a><span id="l1.123">     if (alarmRichlist.selectedIndex &lt; 0) {</span>
<a href="#l1.124"></a><span id="l1.124">         alarmRichlist.selectedIndex = 0;</span>
<a href="#l1.125"></a><span id="l1.125">     }</span>
<a href="#l1.126"></a><span id="l1.126"> </span>
<a href="#l1.127"></a><span id="l1.127">     window.focus();</span>
<a href="#l1.128"></a><span id="l1.128">     window.getAttention();</span>
<a href="#l1.129"></a><span id="l1.129"> }</span>
<a href="#l1.130"></a><span id="l1.130"> </span>
<a href="#l1.131"></a><span id="l1.131"> /**</span>
<a href="#l1.132"></a><span id="l1.132" class="difflineminus">- * Remove the alarm widget for the passed calendar item</span>
<a href="#l1.133"></a><span id="l1.133" class="difflineplus">+ * Remove the alarm widget for the passed alarm and item.</span>
<a href="#l1.134"></a><span id="l1.134">  *</span>
<a href="#l1.135"></a><span id="l1.135">  * @param aItem       The calendar item to remove the alarm widget for.</span>
<a href="#l1.136"></a><span id="l1.136" class="difflineplus">+ * @param aAlarm      The alarm to remove the widget for.</span>
<a href="#l1.137"></a><span id="l1.137">  */</span>
<a href="#l1.138"></a><span id="l1.138" class="difflineminus">-function removeWidgetFor(aItem) {</span>
<a href="#l1.139"></a><span id="l1.139" class="difflineminus">-    var hashId = aItem.hashId;</span>
<a href="#l1.140"></a><span id="l1.140" class="difflineminus">-    var alarmRichlist = document.getElementById(&quot;alarm-richlist&quot;);</span>
<a href="#l1.141"></a><span id="l1.141" class="difflineminus">-    var nodes = alarmRichlist.childNodes;</span>
<a href="#l1.142"></a><span id="l1.142" class="difflineplus">+function removeWidgetFor(aItem, aAlarm) {</span>
<a href="#l1.143"></a><span id="l1.143" class="difflineplus">+    let hashId = aItem.hashId;</span>
<a href="#l1.144"></a><span id="l1.144" class="difflineplus">+    let alarmRichlist = document.getElementById(&quot;alarm-richlist&quot;);</span>
<a href="#l1.145"></a><span id="l1.145" class="difflineplus">+    let nodes = alarmRichlist.childNodes;</span>
<a href="#l1.146"></a><span id="l1.146">     for (var i = nodes.length - 1; i &gt;= 0; --i) {</span>
<a href="#l1.147"></a><span id="l1.147">         var widget = nodes[i];</span>
<a href="#l1.148"></a><span id="l1.148" class="difflineminus">-        if (widget.item &amp;&amp; widget.item.hashId == hashId) {</span>
<a href="#l1.149"></a><span id="l1.149" class="difflineplus">+        if (widget.item &amp;&amp; widget.item.hashId == hashId &amp;&amp;</span>
<a href="#l1.150"></a><span id="l1.150" class="difflineplus">+            widget.alarm &amp;&amp; widget.alarm.icalString == aAlarm.icalString) {</span>
<a href="#l1.151"></a><span id="l1.151"> </span>
<a href="#l1.152"></a><span id="l1.152">             if (widget.selected) {</span>
<a href="#l1.153"></a><span id="l1.153">                 // Advance selection if needed</span>
<a href="#l1.154"></a><span id="l1.154">                 widget.control.selectedItem = widget.previousSibling ||</span>
<a href="#l1.155"></a><span id="l1.155">                                               widget.nextSibling;</span>
<a href="#l1.156"></a><span id="l1.156">             }</span>
<a href="#l1.157"></a><span id="l1.157"> </span>
<a href="#l1.158"></a><span id="l1.158">             widget.removeEventListener(&quot;snooze&quot;, onSnoozeAlarm, false);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/calendar/base/content/calendar-alarm-widget.xml</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/calendar/base/content/calendar-alarm-widget.xml</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -85,67 +85,79 @@</span>
<a href="#l2.4"></a><span id="l2.4">           &lt;xul:button anonid=&quot;alarm-dismiss-button&quot;</span>
<a href="#l2.5"></a><span id="l2.5">                       label=&quot;&amp;calendar.alarm.dismiss.label;&quot;</span>
<a href="#l2.6"></a><span id="l2.6">                       oncommand=&quot;dismissAlarm()&quot;/&gt;</span>
<a href="#l2.7"></a><span id="l2.7">         &lt;/xul:vbox&gt;</span>
<a href="#l2.8"></a><span id="l2.8">       &lt;/xul:hbox&gt;</span>
<a href="#l2.9"></a><span id="l2.9">     &lt;/content&gt;</span>
<a href="#l2.10"></a><span id="l2.10"> </span>
<a href="#l2.11"></a><span id="l2.11">     &lt;implementation&gt;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+      &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+      ]]&gt;&lt;/constructor&gt;</span>
<a href="#l2.15"></a><span id="l2.15">       &lt;field name=&quot;mItem&quot;&gt;null&lt;/field&gt;</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+      &lt;field name=&quot;mAlarm&quot;&gt;null&lt;/field&gt;</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+      &lt;property name=&quot;item&quot;</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+                onget=&quot;return this.mItem;&quot;</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+                onset=&quot;this.mItem = val; this.updateLabels(); return val;&quot;/&gt;</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineplus">+      &lt;property name=&quot;alarm&quot;</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineplus">+                onget=&quot;return this.mAlarm;&quot;</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineplus">+                onset=&quot;this.mAlarm = val; this.updateLabels(); return val;&quot;/&gt;</span>
<a href="#l2.24"></a><span id="l2.24"> </span>
<a href="#l2.25"></a><span id="l2.25" class="difflineminus">-      &lt;property name=&quot;item&quot;&gt;</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineminus">-        &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineminus">-          return this.mItem;</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineminus">-        ]]&gt;&lt;/getter&gt;</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineminus">-        &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineminus">-          this.mItem = val;</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-          var formatter = getDateFormatter();</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineminus">-          var titleLabel = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;alarm-title-label&quot;);</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineminus">-          var locationDescription = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;alarm-location-description&quot;);</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineminus">-          var dateLabel = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;alarm-date-label&quot;);</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+      &lt;method name=&quot;updateLabels&quot;&gt;</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+        &lt;!--</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+          -</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+          --&gt;</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+          if (!this.mItem || !this.mAlarm) {</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+              // Setup not complete, do nothing for now.</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineplus">+          }</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineplus">+</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineplus">+          let formatter = cal.getDateFormatter();</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineplus">+          let titleLabel = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;alarm-title-label&quot;);</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineplus">+          let locationDescription = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;alarm-location-description&quot;);</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineplus">+          let dateLabel = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;alarm-date-label&quot;);</span>
<a href="#l2.48"></a><span id="l2.48"> </span>
<a href="#l2.49"></a><span id="l2.49">           // Dates</span>
<a href="#l2.50"></a><span id="l2.50">           var startString = {};</span>
<a href="#l2.51"></a><span id="l2.51">           var endString = {};</span>
<a href="#l2.52"></a><span id="l2.52"> </span>
<a href="#l2.53"></a><span id="l2.53" class="difflineminus">-          if (isEvent(val)) {</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineminus">-              dateLabel.textContent = formatter.formatItemInterval(val);</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineminus">-          } else if (isToDo(val)) {</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineminus">-              var startDate = val.entryDate || val.dueDate;</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineminus">-              startDate = startDate.getInTimezone(calendarDefaultTimezone());</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineplus">+          if (cal.isEvent(this.mItem)) {</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineplus">+              dateLabel.textContent = formatter.formatItemInterval(this.mItem);</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineplus">+          } else if (cal.isToDo(this.mItem)) {</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineplus">+              let startDate = this.mItem.entryDate || this.mItem.dueDate;</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineplus">+              startDate = startDate.getInTimezone(cal.calendarDefaultTimezone());</span>
<a href="#l2.63"></a><span id="l2.63">               dateLabel.textContent = calGetString(&quot;calendar&quot;,</span>
<a href="#l2.64"></a><span id="l2.64">                                                    &quot;alarmStarts&quot;,</span>
<a href="#l2.65"></a><span id="l2.65">                                                    [formatter.formatDateTime(startDate)]);</span>
<a href="#l2.66"></a><span id="l2.66">           } else {</span>
<a href="#l2.67"></a><span id="l2.67">               throw Components.results.NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l2.68"></a><span id="l2.68">           }</span>
<a href="#l2.69"></a><span id="l2.69"> </span>
<a href="#l2.70"></a><span id="l2.70">           // Relative date</span>
<a href="#l2.71"></a><span id="l2.71">           this.updateRelativeDateLabel();</span>
<a href="#l2.72"></a><span id="l2.72"> </span>
<a href="#l2.73"></a><span id="l2.73">           // Title, location</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineminus">-          titleLabel.value = val.title || &quot;&quot;;</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineminus">-          locationDescription.value = val.getProperty(&quot;LOCATION&quot;) || &quot;&quot;;</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineplus">+          titleLabel.value = this.mItem.title || &quot;&quot;;</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineplus">+          locationDescription.value = this.mItem.getProperty(&quot;LOCATION&quot;) || &quot;&quot;;</span>
<a href="#l2.78"></a><span id="l2.78">           locationDescription.hidden = (locationDescription.value.length &lt; 1);</span>
<a href="#l2.79"></a><span id="l2.79"> </span>
<a href="#l2.80"></a><span id="l2.80">           document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;alarm-location-label&quot;).hidden =</span>
<a href="#l2.81"></a><span id="l2.81">               (locationDescription.value.length &lt; 1);</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineminus">-</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineminus">-          return val;</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineminus">-        ]]&gt;&lt;/setter&gt;</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineminus">-      &lt;/property&gt;</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineplus">+        ]]&gt;&lt;/body&gt;</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineplus">+      &lt;/method&gt;</span>
<a href="#l2.88"></a><span id="l2.88"> </span>
<a href="#l2.89"></a><span id="l2.89">       &lt;method name=&quot;updateRelativeDateLabel&quot;&gt;</span>
<a href="#l2.90"></a><span id="l2.90">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineminus">-          var formatter = Components.classes[&quot;@mozilla.org/calendar/datetime-formatter;1&quot;]</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineminus">-                                    .getService(Components.interfaces.calIDateTimeFormatter);</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineminus">-          var relativeDateLabel = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;alarm-relative-date-label&quot;);</span>
<a href="#l2.94"></a><span id="l2.94" class="difflineminus">-          var relativeDateString;</span>
<a href="#l2.95"></a><span id="l2.95" class="difflineminus">-          var startDate = (this.mItem.startDate || this.mItem.entryDate || this.mItem.dueDate);</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineplus">+          let formatter = cal.getDateFormatter();</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineplus">+          let item = this.mItem;</span>
<a href="#l2.98"></a><span id="l2.98" class="difflineplus">+          let relativeDateLabel = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;alarm-relative-date-label&quot;);</span>
<a href="#l2.99"></a><span id="l2.99" class="difflineplus">+          let relativeDateString;</span>
<a href="#l2.100"></a><span id="l2.100" class="difflineplus">+          let startDate = item[calGetStartDateProp(item)] || item[calGetEndDateProp(item)];</span>
<a href="#l2.101"></a><span id="l2.101">           startDate = startDate.getInTimezone(calendarDefaultTimezone());</span>
<a href="#l2.102"></a><span id="l2.102">           var currentDate = now();</span>
<a href="#l2.103"></a><span id="l2.103">           var sinceDayStart = (currentDate.hour * 3600) + (currentDate.minute * 60);</span>
<a href="#l2.104"></a><span id="l2.104"> </span>
<a href="#l2.105"></a><span id="l2.105">           currentDate.second = 0;</span>
<a href="#l2.106"></a><span id="l2.106">           startDate.second = 0;</span>
<a href="#l2.107"></a><span id="l2.107"> </span>
<a href="#l2.108"></a><span id="l2.108">           var sinceAlarm = currentDate.subtractDate(startDate).inSeconds;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-event-dialog-reminder.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-event-dialog-reminder.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -169,20 +169,17 @@ function setupRadioEnabledState(aDisable</span>
<a href="#l3.4"></a><span id="l3.4"> /**</span>
<a href="#l3.5"></a><span id="l3.5">  * Sets up the max reminders notification. Shows or hides the notification</span>
<a href="#l3.6"></a><span id="l3.6">  * depending on if the max reminders limit has been hit or not.</span>
<a href="#l3.7"></a><span id="l3.7">  */</span>
<a href="#l3.8"></a><span id="l3.8"> function setupMaxReminders() {</span>
<a href="#l3.9"></a><span id="l3.9">     let args = window.arguments[0];</span>
<a href="#l3.10"></a><span id="l3.10">     let listbox = document.getElementById(&quot;reminder-listbox&quot;);</span>
<a href="#l3.11"></a><span id="l3.11">     let notificationbox = document.getElementById(&quot;reminder-notifications&quot;);</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-    // TODO ALARMSUPPORT right now some of our backend still only supports one</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-    // alarm. Limit this in the UI to not confuse users too much.</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-    // let maxReminders = args.calendar.getProperty(&quot;capabilities.alarms.maxCount&quot;);</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">-    let maxReminders = 1;</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+    let maxReminders = args.calendar.getProperty(&quot;capabilities.alarms.maxCount&quot;);</span>
<a href="#l3.17"></a><span id="l3.17"> </span>
<a href="#l3.18"></a><span id="l3.18">     // != null is needed here to ensure cond to be true/false, instead of</span>
<a href="#l3.19"></a><span id="l3.19">     // true/null. The former is needed for setElementValue.</span>
<a href="#l3.20"></a><span id="l3.20">     let cond = (maxReminders != null &amp;&amp; listbox.childNodes.length &gt;= maxReminders);</span>
<a href="#l3.21"></a><span id="l3.21"> </span>
<a href="#l3.22"></a><span id="l3.22">     // If we hit the maximum number of reminders, show the error box and</span>
<a href="#l3.23"></a><span id="l3.23">     // disable the new button.</span>
<a href="#l3.24"></a><span id="l3.24">     setElementValue(&quot;reminder-new-button&quot;, cond &amp;&amp; &quot;true&quot;, &quot;disabled&quot;);</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineat">@@ -200,17 +197,22 @@ function setupMaxReminders() {</span>
<a href="#l3.26"></a><span id="l3.26">         notification.setAttribute(&quot;type&quot;, &quot;warning&quot;);</span>
<a href="#l3.27"></a><span id="l3.27">         notification.setAttribute(&quot;hideclose&quot;, &quot;true&quot;);</span>
<a href="#l3.28"></a><span id="l3.28">         setupMaxReminders.notification = notification;</span>
<a href="#l3.29"></a><span id="l3.29">     }</span>
<a href="#l3.30"></a><span id="l3.30"> </span>
<a href="#l3.31"></a><span id="l3.31">     if (cond) {</span>
<a href="#l3.32"></a><span id="l3.32">         notificationbox.appendChild(setupMaxReminders.notification);</span>
<a href="#l3.33"></a><span id="l3.33">     } else {</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineminus">-        notificationbox.removeNotification(setupMaxReminders.notification);</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+        try {</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+            notificationbox.removeNotification(setupMaxReminders.notification);</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+        } catch (e if e.code == e.NOT_FOUND_ERR) {</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+            // Its ok to swallow this, if the notification element hasn't been</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+            // added then the call will throw a DOM NOT_FOUND_ERR.</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+        }</span>
<a href="#l3.41"></a><span id="l3.41">     }</span>
<a href="#l3.42"></a><span id="l3.42"> }</span>
<a href="#l3.43"></a><span id="l3.43"> </span>
<a href="#l3.44"></a><span id="l3.44"> /**</span>
<a href="#l3.45"></a><span id="l3.45">  * Sets up a reminder listitem for the list of reminders applied to this item.</span>
<a href="#l3.46"></a><span id="l3.46">  *</span>
<a href="#l3.47"></a><span id="l3.47">  * @param aListItem     (optional) A reference listitem to set up. If not</span>
<a href="#l3.48"></a><span id="l3.48">  *                                   passed, a new listitem will be created.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/calendar/base/modules/calAlarmUtils.jsm</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/calendar/base/modules/calAlarmUtils.jsm</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -63,17 +63,17 @@ cal.alarms = {</span>
<a href="#l4.4"></a><span id="l4.4">         }</span>
<a href="#l4.5"></a><span id="l4.5">     },</span>
<a href="#l4.6"></a><span id="l4.6"> </span>
<a href="#l4.7"></a><span id="l4.7">     /**</span>
<a href="#l4.8"></a><span id="l4.8">      * Calculate the alarm date for a calIAlarm.</span>
<a href="#l4.9"></a><span id="l4.9">      *</span>
<a href="#l4.10"></a><span id="l4.10">      * @param aItem     The item used to calculate the alarm date.</span>
<a href="#l4.11"></a><span id="l4.11">      * @param aAlarm    The alarm to calculate the date for.</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-     * @return          The alarm offset.</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+     * @return          The alarm date.</span>
<a href="#l4.14"></a><span id="l4.14">      */</span>
<a href="#l4.15"></a><span id="l4.15">     calculateAlarmDate: function cal_alarm_calculateAlarmDate(aItem, aAlarm) {</span>
<a href="#l4.16"></a><span id="l4.16">         if (aAlarm.related == aAlarm.ALARM_RELATED_ABSOLUTE) {</span>
<a href="#l4.17"></a><span id="l4.17">             return aAlarm.alarmDate;</span>
<a href="#l4.18"></a><span id="l4.18">         } else {</span>
<a href="#l4.19"></a><span id="l4.19">             let returnDate;</span>
<a href="#l4.20"></a><span id="l4.20">             if (aAlarm.related == aAlarm.ALARM_RELATED_START) {</span>
<a href="#l4.21"></a><span id="l4.21">                 returnDate = aItem[cal.calGetStartDateProp(aItem)];</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/calendar/base/public/calIAlarmService.idl</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/calendar/base/public/calIAlarmService.idl</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -15,16 +15,17 @@</span>
<a href="#l5.4"></a><span id="l5.4">  *</span>
<a href="#l5.5"></a><span id="l5.5">  * The Initial Developer of the Original Code is Oracle Corporation</span>
<a href="#l5.6"></a><span id="l5.6">  * Portions created by the Initial Developer are Copyright (C) 2005</span>
<a href="#l5.7"></a><span id="l5.7">  * the Initial Developer. All Rights Reserved.</span>
<a href="#l5.8"></a><span id="l5.8">  *</span>
<a href="#l5.9"></a><span id="l5.9">  * Contributor(s):</span>
<a href="#l5.10"></a><span id="l5.10">  *   Stuart Parmenter &lt;stuart.parmenter@oracle.com&gt;</span>
<a href="#l5.11"></a><span id="l5.11">  *   Daniel Boelzle &lt;daniel.boelzle@sun.com&gt;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+ *   Philipp Kewisch &lt;mozilla@kewis.ch&gt;</span>
<a href="#l5.13"></a><span id="l5.13">  *</span>
<a href="#l5.14"></a><span id="l5.14">  * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l5.15"></a><span id="l5.15">  * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l5.16"></a><span id="l5.16">  * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l5.17"></a><span id="l5.17">  * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l5.18"></a><span id="l5.18">  * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l5.19"></a><span id="l5.19">  * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l5.20"></a><span id="l5.20">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineat">@@ -36,22 +37,27 @@</span>
<a href="#l5.22"></a><span id="l5.22">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l5.23"></a><span id="l5.23"> </span>
<a href="#l5.24"></a><span id="l5.24"> #include &quot;nsISupports.idl&quot;</span>
<a href="#l5.25"></a><span id="l5.25"> </span>
<a href="#l5.26"></a><span id="l5.26"> interface calIItemBase;</span>
<a href="#l5.27"></a><span id="l5.27"> interface calICalendar;</span>
<a href="#l5.28"></a><span id="l5.28"> interface calIDuration;</span>
<a href="#l5.29"></a><span id="l5.29"> interface calITimezone;</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineplus">+interface calIAlarm;</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+interface calIOperation;</span>
<a href="#l5.32"></a><span id="l5.32"> </span>
<a href="#l5.33"></a><span id="l5.33"> [scriptable,uuid(c9c97643-db45-4790-9441-05384ae5c272)]</span>
<a href="#l5.34"></a><span id="l5.34"> interface calIAlarmServiceObserver : nsISupports</span>
<a href="#l5.35"></a><span id="l5.35"> {</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineminus">-  /* Alarm has fired -- Bring up a dialog or play a sound */</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineminus">-  void onAlarm(in calIItemBase item);</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineplus">+  /**</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineplus">+   * Gets called when an alarm has fired. Depending on type of alarm, an</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineplus">+   * observer could bring up a dialog or play a sound.</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineplus">+   */</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineplus">+  void onAlarm(in calIItemBase item, in calIAlarm alarm);</span>
<a href="#l5.43"></a><span id="l5.43"> </span>
<a href="#l5.44"></a><span id="l5.44">   /**</span>
<a href="#l5.45"></a><span id="l5.45">    * Called if alarm(s) of a specific item are to be removed from</span>
<a href="#l5.46"></a><span id="l5.46">    * the alarm window.</span>
<a href="#l5.47"></a><span id="l5.47">    *</span>
<a href="#l5.48"></a><span id="l5.48">    * @param aItem corresponding item, maybe master item of recurring</span>
<a href="#l5.49"></a><span id="l5.49">    *              series (then all alarms belonging to this item are to</span>
<a href="#l5.50"></a><span id="l5.50">    *              be removed)</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineat">@@ -86,24 +92,31 @@ interface calIAlarmService : nsISupports</span>
<a href="#l5.52"></a><span id="l5.52"> </span>
<a href="#l5.53"></a><span id="l5.53">   /* add and remove observers that will be notified when an</span>
<a href="#l5.54"></a><span id="l5.54">      alarm has gone off.  It is up to the application to display</span>
<a href="#l5.55"></a><span id="l5.55">      the alarm.</span>
<a href="#l5.56"></a><span id="l5.56">   */</span>
<a href="#l5.57"></a><span id="l5.57">   void addObserver(in calIAlarmServiceObserver observer);</span>
<a href="#l5.58"></a><span id="l5.58">   void removeObserver(in calIAlarmServiceObserver observer);</span>
<a href="#l5.59"></a><span id="l5.59"> </span>
<a href="#l5.60"></a><span id="l5.60" class="difflineminus">-  /* Call to reschedule an alarm to be notified at a later point.</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineminus">-     This _will_ modify the event's alarmTime.  It will not currently</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineminus">-     change the way the alarm time was initially computed.</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineminus">-</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineminus">-     The alarm will instead fire at &quot;now + duration&quot;</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineminus">-</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineminus">-     This will cause an event to be scheduled even if it was not</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineminus">-     previously scheduled.</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineminus">-  */</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineminus">-  void snoozeAlarm(in calIItemBase item, in calIDuration duration);</span>
<a href="#l5.70"></a><span id="l5.70" class="difflineplus">+  /**</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineplus">+   * Call to reschedule an alarm to be notified at a later point. The alarm will</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineplus">+   * instead fire at &quot;now + duration&quot; This will cause an event to be scheduled</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineplus">+   * even if it was not previously scheduled.</span>
<a href="#l5.74"></a><span id="l5.74" class="difflineplus">+   *</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineplus">+   * @param item            The item the alarm belongs to.</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineplus">+   * @param alarm           The alarm to snooze.</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineplus">+   * @param duration        The duration in minutes to snooze for.</span>
<a href="#l5.78"></a><span id="l5.78" class="difflineplus">+   * @return                The operation that modifies the item to snooze the</span>
<a href="#l5.79"></a><span id="l5.79" class="difflineplus">+   *                        alarm.</span>
<a href="#l5.80"></a><span id="l5.80" class="difflineplus">+   */</span>
<a href="#l5.81"></a><span id="l5.81" class="difflineplus">+  calIOperation snoozeAlarm(in calIItemBase item, in calIAlarm alarm, in calIDuration duration);</span>
<a href="#l5.82"></a><span id="l5.82"> </span>
<a href="#l5.83"></a><span id="l5.83">   /**</span>
<a href="#l5.84"></a><span id="l5.84" class="difflineminus">-   * Dismisses an alarm corresponding to the passed item.</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineplus">+   * Dismisses the given alarm for the passed occurrence.</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineplus">+   *</span>
<a href="#l5.87"></a><span id="l5.87" class="difflineplus">+   * @param item            The item the alarm belongs to.</span>
<a href="#l5.88"></a><span id="l5.88" class="difflineplus">+   * @param alarm           The alarm to dismiss.</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineplus">+   * @return                The operation that modifies the item to dismiss the</span>
<a href="#l5.90"></a><span id="l5.90" class="difflineplus">+   *                        alarm.</span>
<a href="#l5.91"></a><span id="l5.91">    */</span>
<a href="#l5.92"></a><span id="l5.92" class="difflineminus">-  void dismissAlarm(in calIItemBase item);</span>
<a href="#l5.93"></a><span id="l5.93" class="difflineplus">+  calIOperation dismissAlarm(in calIItemBase item, in calIAlarm alarm);</span>
<a href="#l5.94"></a><span id="l5.94"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/calendar/base/src/calAlarm.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/calendar/base/src/calAlarm.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -37,16 +37,17 @@</span>
<a href="#l6.4"></a><span id="l6.4"> Components.utils.import(&quot;resource://gre/modules/PluralForm.jsm&quot;);</span>
<a href="#l6.5"></a><span id="l6.5"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l6.6"></a><span id="l6.6"> </span>
<a href="#l6.7"></a><span id="l6.7"> const ALARM_RELATED_ABSOLUTE = Components.interfaces.calIAlarm.ALARM_RELATED_ABSOLUTE;</span>
<a href="#l6.8"></a><span id="l6.8"> const ALARM_RELATED_START = Components.interfaces.calIAlarm.ALARM_RELATED_START;</span>
<a href="#l6.9"></a><span id="l6.9"> const ALARM_RELATED_END = Components.interfaces.calIAlarm.ALARM_RELATED_END;</span>
<a href="#l6.10"></a><span id="l6.10"> </span>
<a href="#l6.11"></a><span id="l6.11"> function calAlarm() {</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+    this.wrappedJSObject = this;</span>
<a href="#l6.13"></a><span id="l6.13">     this.mProperties = new calPropertyBag();</span>
<a href="#l6.14"></a><span id="l6.14">     this.mPropertyParams = {};</span>
<a href="#l6.15"></a><span id="l6.15">     this.mAttendees = [];</span>
<a href="#l6.16"></a><span id="l6.16">     this.mAttachments = [];</span>
<a href="#l6.17"></a><span id="l6.17"> }</span>
<a href="#l6.18"></a><span id="l6.18"> </span>
<a href="#l6.19"></a><span id="l6.19"> calAlarm.prototype = {</span>
<a href="#l6.20"></a><span id="l6.20"> </span>
<a href="#l6.21"></a><span id="l6.21" class="difflineat">@@ -483,31 +484,27 @@ calAlarm.prototype = {</span>
<a href="#l6.22"></a><span id="l6.22">             this.action = actionProp.value;</span>
<a href="#l6.23"></a><span id="l6.23">         } else {</span>
<a href="#l6.24"></a><span id="l6.24">             throw Components.results.NS_ERROR_INVALID_ARG;</span>
<a href="#l6.25"></a><span id="l6.25">         }</span>
<a href="#l6.26"></a><span id="l6.26"> </span>
<a href="#l6.27"></a><span id="l6.27">         if (triggerProp) {</span>
<a href="#l6.28"></a><span id="l6.28">             if (triggerProp.getParameter(&quot;VALUE&quot;) == &quot;DATE-TIME&quot;)  {</span>
<a href="#l6.29"></a><span id="l6.29">                 this.mAbsoluteDate = triggerProp.valueAsDatetime;</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineplus">+                this.related = ALARM_RELATED_ABSOLUTE;</span>
<a href="#l6.31"></a><span id="l6.31">             } else {</span>
<a href="#l6.32"></a><span id="l6.32">                 this.mOffset = cal.createDuration(triggerProp.valueAsIcalString);</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+                let related = triggerProp.getParameter(&quot;RELATED&quot;);</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+                this.related = (related == &quot;END&quot; ? ALARM_RELATED_END : ALARM_RELATED_START);</span>
<a href="#l6.36"></a><span id="l6.36">             }</span>
<a href="#l6.37"></a><span id="l6.37">         } else {</span>
<a href="#l6.38"></a><span id="l6.38">             throw Components.results.NS_ERROR_INVALID_ARG;</span>
<a href="#l6.39"></a><span id="l6.39">         }</span>
<a href="#l6.40"></a><span id="l6.40"> </span>
<a href="#l6.41"></a><span id="l6.41" class="difflineminus">-        // Set up alarm relation</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineminus">-        let related = triggerProp.getParameter(&quot;RELATED&quot;);</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineminus">-        if (related &amp;&amp; related == &quot;END&quot;) {</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineminus">-            this.related = ALARM_RELATED_END;</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineminus">-        } else {</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineminus">-            this.related = ALARM_RELATED_START;</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineminus">-        }</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineminus">-</span>
<a href="#l6.49"></a><span id="l6.49">         if (durationProp &amp;&amp; repeatProp) {</span>
<a href="#l6.50"></a><span id="l6.50">             this.duration = cal.createDuration(durationProp.valueAsIcalString);</span>
<a href="#l6.51"></a><span id="l6.51">             this.repeat = repeatProp.value;</span>
<a href="#l6.52"></a><span id="l6.52">         } else if (durationProp || repeatProp) {</span>
<a href="#l6.53"></a><span id="l6.53">             throw Components.results.NS_ERROR_INVALID_ARG;</span>
<a href="#l6.54"></a><span id="l6.54">         } else {</span>
<a href="#l6.55"></a><span id="l6.55">             this.duration = null;</span>
<a href="#l6.56"></a><span id="l6.56">             this.repeat = 0;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/calendar/base/src/calAlarmMonitor.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/calendar/base/src/calAlarmMonitor.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -15,151 +15,196 @@</span>
<a href="#l7.4"></a><span id="l7.4">  *</span>
<a href="#l7.5"></a><span id="l7.5">  * The Initial Developer of the Original Code is Oracle Corporation</span>
<a href="#l7.6"></a><span id="l7.6">  * Portions created by the Initial Developer are Copyright (C) 2005</span>
<a href="#l7.7"></a><span id="l7.7">  * the Initial Developer. All Rights Reserved.</span>
<a href="#l7.8"></a><span id="l7.8">  *</span>
<a href="#l7.9"></a><span id="l7.9">  * Contributor(s):</span>
<a href="#l7.10"></a><span id="l7.10">  *   Stuart Parmenter &lt;stuart.parmenter@oracle.com&gt;</span>
<a href="#l7.11"></a><span id="l7.11">  *   Daniel Boelzle &lt;daniel.boelzle@sun.com&gt;</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+ *   Philipp Kewisch &lt;mozilla@kewis.ch&gt;</span>
<a href="#l7.13"></a><span id="l7.13">  *</span>
<a href="#l7.14"></a><span id="l7.14">  * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l7.15"></a><span id="l7.15">  * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l7.16"></a><span id="l7.16">  * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l7.17"></a><span id="l7.17">  * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l7.18"></a><span id="l7.18">  * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l7.19"></a><span id="l7.19">  * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l7.20"></a><span id="l7.20">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l7.21"></a><span id="l7.21">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l7.22"></a><span id="l7.22">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l7.23"></a><span id="l7.23">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l7.24"></a><span id="l7.24">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l7.25"></a><span id="l7.25">  *</span>
<a href="#l7.26"></a><span id="l7.26">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l7.27"></a><span id="l7.27"> </span>
<a href="#l7.28"></a><span id="l7.28" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineplus">+</span>
<a href="#l7.30"></a><span id="l7.30"> function peekAlarmWindow() {</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">-    var windowMediator = Components.classes[&quot;@mozilla.org/appshell/window-mediator;1&quot;]</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+    let windowMediator = Components.classes[&quot;@mozilla.org/appshell/window-mediator;1&quot;]</span>
<a href="#l7.33"></a><span id="l7.33">                                    .getService(Components.interfaces.nsIWindowMediator);</span>
<a href="#l7.34"></a><span id="l7.34">     return windowMediator.getMostRecentWindow(&quot;Calendar:AlarmWindow&quot;);</span>
<a href="#l7.35"></a><span id="l7.35"> }</span>
<a href="#l7.36"></a><span id="l7.36"> </span>
<a href="#l7.37"></a><span id="l7.37" class="difflineminus">-function calAlarmServiceObserver() {</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineplus">+/**</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineplus">+ * The alarm monitor takes care of playing the alarm sound and opening one copy</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineplus">+ * of the calendar-alarm-dialog. Both depend on their respective prefs to be</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineplus">+ * set. This monitor is only used for DISPLAY type alarms.</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineplus">+ */</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineplus">+function calAlarmMonitor() {</span>
<a href="#l7.44"></a><span id="l7.44">     this.wrappedJSObject = this;</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineminus">-    this.mAlarmService = Components.classes[&quot;@mozilla.org/calendar/alarm-service;1&quot;]</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineminus">-                                   .getService(Components.interfaces.calIAlarmService);</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineminus">-    this.mAlarmItems = [];</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineplus">+    this.mAlarms = [];</span>
<a href="#l7.49"></a><span id="l7.49"> }</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineminus">-calAlarmServiceObserver.prototype = {</span>
<a href="#l7.51"></a><span id="l7.51"> </span>
<a href="#l7.52"></a><span id="l7.52" class="difflineminus">-    mAlarmService: null,</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineminus">-    mAlarmItems: null,</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineplus">+calAlarmMonitor.prototype = {</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineplus">+    mAlarms: null,</span>
<a href="#l7.56"></a><span id="l7.56"> </span>
<a href="#l7.57"></a><span id="l7.57">     // This is a work-around for the fact that there is a delay between when</span>
<a href="#l7.58"></a><span id="l7.58">     // we call openWindow and when it appears via getMostRecentWindow.  If an</span>
<a href="#l7.59"></a><span id="l7.59">     // alarm is fired in that time-frame, it will actually end up in another window.</span>
<a href="#l7.60"></a><span id="l7.60">     mWindowOpening: null,</span>
<a href="#l7.61"></a><span id="l7.61"> </span>
<a href="#l7.62"></a><span id="l7.62" class="difflineminus">-    //</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineminus">-    // calIAlarmServiceObserver</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineminus">-    //</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineminus">-    onAlarm: function caso_onAlarm(item) {</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineplus">+    QueryInterface: function cAM_QueryInterface(aIID) {</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineplus">+        return cal.doQueryInterface(this, calAlarmMonitor.prototype, aIID, null, this);</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineplus">+    },</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineplus">+</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineplus">+    /**</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineplus">+     * nsIClassInfo</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineplus">+     */</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineplus">+    getInterfaces: function cAM_getInterfaces(aCount) {</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineplus">+        let ifaces = [</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineplus">+            Components.interfaces.nsISupports,</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineplus">+            Components.interfaces.nsIObserver,</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineplus">+            Components.interfaces.calIAlarmServiceObserver</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineplus">+        ];</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineplus">+        aCount.value = ifaces.length;</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineplus">+        return ifaces;</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineplus">+    },</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineplus">+</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineplus">+    getHelperForLanguage: function cAM_getHelperForLanguage(aLanguage) {</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineplus">+        return null;</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineplus">+    },</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineplus">+</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineplus">+    contractID: &quot;@mozilla.org/calendar/alarm-monitor;1&quot;,</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineplus">+    classDescription: &quot;Calendar Alarm Monitor&quot;,</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineplus">+    classID: Components.ID(&quot;{4b7ae030-ed79-11d9-8cd6-0800200c9a66}&quot;),</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineplus">+    implementationLanguage: Components.interfaces.nsIProgrammingLanguage.JAVASCRIPT,</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineplus">+    flags: Components.interfaces.nsIClassInfo.SINGLETON,</span>
<a href="#l7.92"></a><span id="l7.92"> </span>
<a href="#l7.93"></a><span id="l7.93" class="difflineminus">-        this.mAlarmItems.push(item);</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineplus">+    /**</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineplus">+     * nsIObserver</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineplus">+     */</span>
<a href="#l7.97"></a><span id="l7.97" class="difflineplus">+    observe: function cAM_observe(aSubject, aTopic, aData) {</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineplus">+        let alarmService = Components.classes[&quot;@mozilla.org/calendar/alarm-service;1&quot;]</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineplus">+                                     .getService(Components.interfaces.calIAlarmService);</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineplus">+        switch (aTopic) {</span>
<a href="#l7.101"></a><span id="l7.101" class="difflineplus">+            case &quot;alarm-service-startup&quot;:</span>
<a href="#l7.102"></a><span id="l7.102" class="difflineplus">+                alarmService.addObserver(this);</span>
<a href="#l7.103"></a><span id="l7.103" class="difflineplus">+                break;</span>
<a href="#l7.104"></a><span id="l7.104" class="difflineplus">+            case &quot;alarm-service-shutdown&quot;:</span>
<a href="#l7.105"></a><span id="l7.105" class="difflineplus">+                alarmService.removeObserver(this);</span>
<a href="#l7.106"></a><span id="l7.106" class="difflineplus">+                break;</span>
<a href="#l7.107"></a><span id="l7.107" class="difflineplus">+        }</span>
<a href="#l7.108"></a><span id="l7.108" class="difflineplus">+    },</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineplus">+</span>
<a href="#l7.110"></a><span id="l7.110" class="difflineplus">+    /**</span>
<a href="#l7.111"></a><span id="l7.111" class="difflineplus">+     * calIAlarmServiceObserver</span>
<a href="#l7.112"></a><span id="l7.112" class="difflineplus">+     */</span>
<a href="#l7.113"></a><span id="l7.113" class="difflineplus">+    onAlarm: function cAM_onAlarm(aItem, aAlarm) {</span>
<a href="#l7.114"></a><span id="l7.114" class="difflineplus">+        if (aAlarm.action != &quot;DISPLAY&quot;) {</span>
<a href="#l7.115"></a><span id="l7.115" class="difflineplus">+            // This monitor only looks for DISPLAY alarms.</span>
<a href="#l7.116"></a><span id="l7.116" class="difflineplus">+            return;</span>
<a href="#l7.117"></a><span id="l7.117" class="difflineplus">+        }</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineplus">+</span>
<a href="#l7.119"></a><span id="l7.119" class="difflineplus">+        this.mAlarms.push([aItem, aAlarm]);</span>
<a href="#l7.120"></a><span id="l7.120"> </span>
<a href="#l7.121"></a><span id="l7.121">         if (getPrefSafe(&quot;calendar.alarms.playsound&quot;, true)) {</span>
<a href="#l7.122"></a><span id="l7.122" class="difflineminus">-            try {</span>
<a href="#l7.123"></a><span id="l7.123" class="difflineminus">-                var soundURL = getPrefSafe(&quot;calendar.alarms.soundURL&quot;, null);</span>
<a href="#l7.124"></a><span id="l7.124" class="difflineminus">-                var sound = Components.classes[&quot;@mozilla.org/sound;1&quot;]</span>
<a href="#l7.125"></a><span id="l7.125" class="difflineminus">-                                      .createInstance(Components.interfaces.nsISound);</span>
<a href="#l7.126"></a><span id="l7.126" class="difflineminus">-                sound.init();</span>
<a href="#l7.127"></a><span id="l7.127" class="difflineminus">-                if (soundURL &amp;&amp; soundURL.length &gt; 0) {</span>
<a href="#l7.128"></a><span id="l7.128" class="difflineminus">-                    soundURL = makeURL(soundURL);</span>
<a href="#l7.129"></a><span id="l7.129" class="difflineminus">-                    sound.play(soundURL);</span>
<a href="#l7.130"></a><span id="l7.130" class="difflineminus">-                } else {</span>
<a href="#l7.131"></a><span id="l7.131" class="difflineminus">-                    sound.beep();</span>
<a href="#l7.132"></a><span id="l7.132" class="difflineplus">+            // We want to make sure the user isn't flooded with alarms so we</span>
<a href="#l7.133"></a><span id="l7.133" class="difflineplus">+            // limit this using a preference. For example, if the user has 20</span>
<a href="#l7.134"></a><span id="l7.134" class="difflineplus">+            // events that fire an alarm in the same minute, then the alarm</span>
<a href="#l7.135"></a><span id="l7.135" class="difflineplus">+            // sound will only play 5 times. All alarms will be shown in the</span>
<a href="#l7.136"></a><span id="l7.136" class="difflineplus">+            // dialog nevertheless.</span>
<a href="#l7.137"></a><span id="l7.137" class="difflineplus">+            let maxAlarmSoundCount = cal.getPrefSafe(&quot;calendar.alarms.maxsoundsperminute&quot;, 5);</span>
<a href="#l7.138"></a><span id="l7.138" class="difflineplus">+            let now = new Date();</span>
<a href="#l7.139"></a><span id="l7.139" class="difflineplus">+</span>
<a href="#l7.140"></a><span id="l7.140" class="difflineplus">+            if (!this.mLastAlarmSoundDate ||</span>
<a href="#l7.141"></a><span id="l7.141" class="difflineplus">+                (now - this.mLastAlarmSoundDate &gt;= 60000)) {</span>
<a href="#l7.142"></a><span id="l7.142" class="difflineplus">+                // Last alarm was long enough ago, reset counters. Note</span>
<a href="#l7.143"></a><span id="l7.143" class="difflineplus">+                // subtracting JSDate results in microseconds.</span>
<a href="#l7.144"></a><span id="l7.144" class="difflineplus">+                this.mAlarmSoundCount = 0;</span>
<a href="#l7.145"></a><span id="l7.145" class="difflineplus">+                this.mLastAlarmSoundDate = now;</span>
<a href="#l7.146"></a><span id="l7.146" class="difflineplus">+            } else {</span>
<a href="#l7.147"></a><span id="l7.147" class="difflineplus">+                // Otherwise increase the counter</span>
<a href="#l7.148"></a><span id="l7.148" class="difflineplus">+                this.mAlarmSoundCount++;</span>
<a href="#l7.149"></a><span id="l7.149" class="difflineplus">+            }</span>
<a href="#l7.150"></a><span id="l7.150" class="difflineplus">+</span>
<a href="#l7.151"></a><span id="l7.151" class="difflineplus">+            if (maxAlarmSoundCount &gt; this.mAlarmSoundCount) {</span>
<a href="#l7.152"></a><span id="l7.152" class="difflineplus">+                // Only ring the alarm sound if we haven't hit the max count.</span>
<a href="#l7.153"></a><span id="l7.153" class="difflineplus">+                try {</span>
<a href="#l7.154"></a><span id="l7.154" class="difflineplus">+                    let soundURL = getPrefSafe(&quot;calendar.alarms.soundURL&quot;, null);</span>
<a href="#l7.155"></a><span id="l7.155" class="difflineplus">+                    let sound = Components.classes[&quot;@mozilla.org/sound;1&quot;]</span>
<a href="#l7.156"></a><span id="l7.156" class="difflineplus">+                                          .createInstance(Components.interfaces.nsISound);</span>
<a href="#l7.157"></a><span id="l7.157" class="difflineplus">+                    sound.init();</span>
<a href="#l7.158"></a><span id="l7.158" class="difflineplus">+                    if (soundURL &amp;&amp; soundURL.length &gt; 0) {</span>
<a href="#l7.159"></a><span id="l7.159" class="difflineplus">+                        soundURL = makeURL(soundURL);</span>
<a href="#l7.160"></a><span id="l7.160" class="difflineplus">+                        sound.play(soundURL);</span>
<a href="#l7.161"></a><span id="l7.161" class="difflineplus">+                    } else {</span>
<a href="#l7.162"></a><span id="l7.162" class="difflineplus">+                        sound.beep();</span>
<a href="#l7.163"></a><span id="l7.163" class="difflineplus">+                    }</span>
<a href="#l7.164"></a><span id="l7.164" class="difflineplus">+                } catch (exc) {</span>
<a href="#l7.165"></a><span id="l7.165" class="difflineplus">+                    cal.ERROR(&quot;Error playing alarm sound: &quot; + exc);</span>
<a href="#l7.166"></a><span id="l7.166">                 }</span>
<a href="#l7.167"></a><span id="l7.167" class="difflineminus">-            } catch (exc) {</span>
<a href="#l7.168"></a><span id="l7.168" class="difflineminus">-                Components.utils.reportError(exc);</span>
<a href="#l7.169"></a><span id="l7.169">             }</span>
<a href="#l7.170"></a><span id="l7.170">         }</span>
<a href="#l7.171"></a><span id="l7.171"> </span>
<a href="#l7.172"></a><span id="l7.172">         if (!getPrefSafe(&quot;calendar.alarms.show&quot;, true)) {</span>
<a href="#l7.173"></a><span id="l7.173">             return;</span>
<a href="#l7.174"></a><span id="l7.174">         }</span>
<a href="#l7.175"></a><span id="l7.175"> </span>
<a href="#l7.176"></a><span id="l7.176" class="difflineminus">-        var calAlarmWindow = peekAlarmWindow();</span>
<a href="#l7.177"></a><span id="l7.177" class="difflineplus">+        let calAlarmWindow = peekAlarmWindow();</span>
<a href="#l7.178"></a><span id="l7.178">         if (!calAlarmWindow  &amp;&amp; !this.mWindowOpening) {</span>
<a href="#l7.179"></a><span id="l7.179" class="difflineminus">-            var windowWatcher = Components.classes[&quot;@mozilla.org/embedcomp/window-watcher;1&quot;]</span>
<a href="#l7.180"></a><span id="l7.180" class="difflineplus">+            let windowWatcher = Components.classes[&quot;@mozilla.org/embedcomp/window-watcher;1&quot;]</span>
<a href="#l7.181"></a><span id="l7.181">                                           .getService(Components.interfaces.nsIWindowWatcher);</span>
<a href="#l7.182"></a><span id="l7.182">             this.mWindowOpening = windowWatcher.openWindow(</span>
<a href="#l7.183"></a><span id="l7.183">                 null,</span>
<a href="#l7.184"></a><span id="l7.184">                 &quot;chrome://calendar/content/calendar-alarm-dialog.xul&quot;,</span>
<a href="#l7.185"></a><span id="l7.185">                 &quot;_blank&quot;,</span>
<a href="#l7.186"></a><span id="l7.186">                 &quot;chrome,dialog=yes,all,resizable&quot;,</span>
<a href="#l7.187"></a><span id="l7.187">                 this);</span>
<a href="#l7.188"></a><span id="l7.188">         }</span>
<a href="#l7.189"></a><span id="l7.189">         if (!this.mWindowOpening) {</span>
<a href="#l7.190"></a><span id="l7.190" class="difflineminus">-            calAlarmWindow.addWidgetFor(item);</span>
<a href="#l7.191"></a><span id="l7.191" class="difflineplus">+            calAlarmWindow.addWidgetFor(aItem, aAlarm);</span>
<a href="#l7.192"></a><span id="l7.192">         }</span>
<a href="#l7.193"></a><span id="l7.193">     },</span>
<a href="#l7.194"></a><span id="l7.194"> </span>
<a href="#l7.195"></a><span id="l7.195" class="difflineminus">-    window_onLoad: function caso_window_onLoad() {</span>
<a href="#l7.196"></a><span id="l7.196" class="difflineminus">-        var calAlarmWindow = this.mWindowOpening;</span>
<a href="#l7.197"></a><span id="l7.197" class="difflineplus">+    window_onLoad: function cAM_window_onLoad() {</span>
<a href="#l7.198"></a><span id="l7.198" class="difflineplus">+        let calAlarmWindow = this.mWindowOpening;</span>
<a href="#l7.199"></a><span id="l7.199">         this.mWindowOpening = null;</span>
<a href="#l7.200"></a><span id="l7.200" class="difflineminus">-        for each (var item in this.mAlarmItems) {</span>
<a href="#l7.201"></a><span id="l7.201" class="difflineminus">-            calAlarmWindow.addWidgetFor(item);</span>
<a href="#l7.202"></a><span id="l7.202" class="difflineplus">+        for each (let [item, alarm] in this.mAlarms) {</span>
<a href="#l7.203"></a><span id="l7.203" class="difflineplus">+            calAlarmWindow.addWidgetFor(item, alarm);</span>
<a href="#l7.204"></a><span id="l7.204">         }</span>
<a href="#l7.205"></a><span id="l7.205">     },</span>
<a href="#l7.206"></a><span id="l7.206"> </span>
<a href="#l7.207"></a><span id="l7.207" class="difflineminus">-    onRemoveAlarmsByItem: function caso_onRemoveAlarmsByItem(item) {</span>
<a href="#l7.208"></a><span id="l7.208" class="difflineminus">-        var calAlarmWindow = peekAlarmWindow();</span>
<a href="#l7.209"></a><span id="l7.209" class="difflineminus">-        this.mAlarmItems = this.mAlarmItems.filter(</span>
<a href="#l7.210"></a><span id="l7.210" class="difflineminus">-            function(item_) {</span>
<a href="#l7.211"></a><span id="l7.211" class="difflineminus">-                var hashId_ = (item.recurrenceId ? item_.hashId</span>
<a href="#l7.212"></a><span id="l7.212" class="difflineminus">-                                                 : item_.parentItem.hashId);</span>
<a href="#l7.213"></a><span id="l7.213" class="difflineminus">-                var ret = (item.hashId != hashId_);</span>
<a href="#l7.214"></a><span id="l7.214" class="difflineminus">-                if (!ret &amp;&amp; calAlarmWindow) { // window is open</span>
<a href="#l7.215"></a><span id="l7.215" class="difflineminus">-                    calAlarmWindow.removeWidgetFor(item_);</span>
<a href="#l7.216"></a><span id="l7.216" class="difflineminus">-                }</span>
<a href="#l7.217"></a><span id="l7.217" class="difflineminus">-                return ret;</span>
<a href="#l7.218"></a><span id="l7.218" class="difflineminus">-            });</span>
<a href="#l7.219"></a><span id="l7.219" class="difflineplus">+    onRemoveAlarmsByItem: function cAM_onRemoveAlarmsByItem(aItem) {</span>
<a href="#l7.220"></a><span id="l7.220" class="difflineplus">+        let calAlarmWindow = peekAlarmWindow();</span>
<a href="#l7.221"></a><span id="l7.221" class="difflineplus">+        this.mAlarms = this.mAlarms.filter(function(itemAlarm) {</span>
<a href="#l7.222"></a><span id="l7.222" class="difflineplus">+            let [thisItem, alarm] = itemAlarm;</span>
<a href="#l7.223"></a><span id="l7.223" class="difflineplus">+            let ret = (aItem.hashId != thisItem.parentItem.hashId);</span>
<a href="#l7.224"></a><span id="l7.224" class="difflineplus">+            if (!ret &amp;&amp; calAlarmWindow) { // window is open</span>
<a href="#l7.225"></a><span id="l7.225" class="difflineplus">+                calAlarmWindow.removeWidgetFor(thisItem, alarm);</span>
<a href="#l7.226"></a><span id="l7.226" class="difflineplus">+            }</span>
<a href="#l7.227"></a><span id="l7.227" class="difflineplus">+            return ret;</span>
<a href="#l7.228"></a><span id="l7.228" class="difflineplus">+        });</span>
<a href="#l7.229"></a><span id="l7.229">     },</span>
<a href="#l7.230"></a><span id="l7.230"> </span>
<a href="#l7.231"></a><span id="l7.231" class="difflineminus">-    onRemoveAlarmsByCalendar: function caso_onRemoveAlarmsByCalendar(calendar) {</span>
<a href="#l7.232"></a><span id="l7.232" class="difflineminus">-        var calAlarmWindow = peekAlarmWindow();</span>
<a href="#l7.233"></a><span id="l7.233" class="difflineminus">-        this.mAlarmItems = this.mAlarmItems.filter(</span>
<a href="#l7.234"></a><span id="l7.234" class="difflineminus">-            function(item_) {</span>
<a href="#l7.235"></a><span id="l7.235" class="difflineminus">-                var ret = (calendar.id != item_.calendar.id);</span>
<a href="#l7.236"></a><span id="l7.236" class="difflineminus">-                if (!ret &amp;&amp; calAlarmWindow) { // window is open</span>
<a href="#l7.237"></a><span id="l7.237" class="difflineminus">-                    calAlarmWindow.removeWidgetFor(item_);</span>
<a href="#l7.238"></a><span id="l7.238" class="difflineminus">-                }</span>
<a href="#l7.239"></a><span id="l7.239" class="difflineminus">-                return ret;</span>
<a href="#l7.240"></a><span id="l7.240" class="difflineminus">-            });</span>
<a href="#l7.241"></a><span id="l7.241" class="difflineplus">+    onRemoveAlarmsByCalendar: function cAM_onRemoveAlarmsByCalendar(calendar) {</span>
<a href="#l7.242"></a><span id="l7.242" class="difflineplus">+        let calAlarmWindow = peekAlarmWindow();</span>
<a href="#l7.243"></a><span id="l7.243" class="difflineplus">+        this.mAlarms = this.mAlarms.filter(function(itemAlarm) {</span>
<a href="#l7.244"></a><span id="l7.244" class="difflineplus">+            let [thisItem, alarm] = itemAlarm;</span>
<a href="#l7.245"></a><span id="l7.245" class="difflineplus">+            let ret = (calendar.id != thisItem.calendar.id);</span>
<a href="#l7.246"></a><span id="l7.246" class="difflineplus">+</span>
<a href="#l7.247"></a><span id="l7.247" class="difflineplus">+            if (!ret &amp;&amp; calAlarmWindow) { // window is open</span>
<a href="#l7.248"></a><span id="l7.248" class="difflineplus">+                calAlarmWindow.removeWidgetFor(thisItem, alarm);</span>
<a href="#l7.249"></a><span id="l7.249" class="difflineplus">+            }</span>
<a href="#l7.250"></a><span id="l7.250" class="difflineplus">+            return ret;</span>
<a href="#l7.251"></a><span id="l7.251" class="difflineplus">+        });</span>
<a href="#l7.252"></a><span id="l7.252">     }</span>
<a href="#l7.253"></a><span id="l7.253"> };</span>
<a href="#l7.254"></a><span id="l7.254" class="difflineminus">-</span>
<a href="#l7.255"></a><span id="l7.255" class="difflineminus">-function calAlarmMonitor() {</span>
<a href="#l7.256"></a><span id="l7.256" class="difflineminus">-    this.mObserver = new calAlarmServiceObserver();</span>
<a href="#l7.257"></a><span id="l7.257" class="difflineminus">-}</span>
<a href="#l7.258"></a><span id="l7.258" class="difflineminus">-calAlarmMonitor.prototype = {</span>
<a href="#l7.259"></a><span id="l7.259" class="difflineminus">-    mObserver: null,</span>
<a href="#l7.260"></a><span id="l7.260" class="difflineminus">-</span>
<a href="#l7.261"></a><span id="l7.261" class="difflineminus">-    QueryInterface: function calAlarmMonitor_QueryInterface(iid) {</span>
<a href="#l7.262"></a><span id="l7.262" class="difflineminus">-        if (iid.equals(Components.interfaces.nsIObserver) ||</span>
<a href="#l7.263"></a><span id="l7.263" class="difflineminus">-            iid.equals(Components.interfaces.nsISupports)) {</span>
<a href="#l7.264"></a><span id="l7.264" class="difflineminus">-            return this;</span>
<a href="#l7.265"></a><span id="l7.265" class="difflineminus">-        }</span>
<a href="#l7.266"></a><span id="l7.266" class="difflineminus">-        throw Components.interfaces.NS_ERROR_NO_INTERFACE;</span>
<a href="#l7.267"></a><span id="l7.267" class="difflineminus">-    },</span>
<a href="#l7.268"></a><span id="l7.268" class="difflineminus">-</span>
<a href="#l7.269"></a><span id="l7.269" class="difflineminus">-    /* nsIObserver */</span>
<a href="#l7.270"></a><span id="l7.270" class="difflineminus">-    observe: function calAlarmMonitor_observe(subject, topic, data) {</span>
<a href="#l7.271"></a><span id="l7.271" class="difflineminus">-        switch (topic) {</span>
<a href="#l7.272"></a><span id="l7.272" class="difflineminus">-        case &quot;alarm-service-startup&quot;:</span>
<a href="#l7.273"></a><span id="l7.273" class="difflineminus">-            this.mObserver.mAlarmService.addObserver(this.mObserver);</span>
<a href="#l7.274"></a><span id="l7.274" class="difflineminus">-            break;</span>
<a href="#l7.275"></a><span id="l7.275" class="difflineminus">-</span>
<a href="#l7.276"></a><span id="l7.276" class="difflineminus">-        case &quot;alarm-service-shutdown&quot;:</span>
<a href="#l7.277"></a><span id="l7.277" class="difflineminus">-            this.mObserver.mAlarmService.removeObserver(this.mObserver);</span>
<a href="#l7.278"></a><span id="l7.278" class="difflineminus">-            break;</span>
<a href="#l7.279"></a><span id="l7.279" class="difflineminus">-        }</span>
<a href="#l7.280"></a><span id="l7.280" class="difflineminus">-    }</span>
<a href="#l7.281"></a><span id="l7.281" class="difflineminus">-};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/calendar/base/src/calAlarmService.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/calendar/base/src/calAlarmService.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -33,82 +33,84 @@</span>
<a href="#l8.4"></a><span id="l8.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l8.5"></a><span id="l8.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l8.6"></a><span id="l8.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l8.7"></a><span id="l8.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l8.8"></a><span id="l8.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l8.9"></a><span id="l8.9">  *</span>
<a href="#l8.10"></a><span id="l8.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l8.13"></a><span id="l8.13"> Components.utils.import(&quot;resource://calendar/modules/calAlarmUtils.jsm&quot;);</span>
<a href="#l8.14"></a><span id="l8.14"> </span>
<a href="#l8.15"></a><span id="l8.15"> const kHoursBetweenUpdates = 6;</span>
<a href="#l8.16"></a><span id="l8.16"> </span>
<a href="#l8.17"></a><span id="l8.17"> function nowUTC() {</span>
<a href="#l8.18"></a><span id="l8.18">     return jsDateToDateTime(new Date()).getInTimezone(UTC());</span>
<a href="#l8.19"></a><span id="l8.19"> }</span>
<a href="#l8.20"></a><span id="l8.20"> </span>
<a href="#l8.21"></a><span id="l8.21" class="difflineminus">-function newTimerWithCallback(callback, delay, repeating)</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineminus">-{</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineminus">-    var timer = Components.classes[&quot;@mozilla.org/timer;1&quot;].createInstance(Components.interfaces.nsITimer);</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineminus">-    </span>
<a href="#l8.25"></a><span id="l8.25" class="difflineminus">-    timer.initWithCallback(callback,</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineminus">-                           delay,</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineminus">-                           (repeating) ? timer.TYPE_REPEATING_PRECISE : timer.TYPE_ONE_SHOT);</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineplus">+function newTimerWithCallback(aCallback, aDelay, aRepeating) {</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineplus">+    let timer = Components.classes[&quot;@mozilla.org/timer;1&quot;]</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineplus">+                          .createInstance(Components.interfaces.nsITimer);</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineplus">+</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+    timer.initWithCallback(aCallback,</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineplus">+                           aDelay,</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+                           (aRepeating ? timer.TYPE_REPEATING_PRECISE : timer.TYPE_ONE_SHOT));</span>
<a href="#l8.35"></a><span id="l8.35">     return timer;</span>
<a href="#l8.36"></a><span id="l8.36"> }</span>
<a href="#l8.37"></a><span id="l8.37"> </span>
<a href="#l8.38"></a><span id="l8.38"> function calAlarmService() {</span>
<a href="#l8.39"></a><span id="l8.39">     this.wrappedJSObject = this;</span>
<a href="#l8.40"></a><span id="l8.40"> </span>
<a href="#l8.41"></a><span id="l8.41">     this.mLoadedCalendars = {};</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineminus">-    this.mTimerLookup = {};</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineplus">+    this.mTimerMap = {};</span>
<a href="#l8.44"></a><span id="l8.44">     this.mObservers = new calListenerBag(Components.interfaces.calIAlarmServiceObserver);</span>
<a href="#l8.45"></a><span id="l8.45"> </span>
<a href="#l8.46"></a><span id="l8.46">     this.calendarObserver = {</span>
<a href="#l8.47"></a><span id="l8.47">         alarmService: this,</span>
<a href="#l8.48"></a><span id="l8.48"> </span>
<a href="#l8.49"></a><span id="l8.49">         // calIObserver:</span>
<a href="#l8.50"></a><span id="l8.50">         onStartBatch: function() { },</span>
<a href="#l8.51"></a><span id="l8.51">         onEndBatch: function() { },</span>
<a href="#l8.52"></a><span id="l8.52">         onLoad: function co_onLoad(calendar) {</span>
<a href="#l8.53"></a><span id="l8.53">             // ignore any onLoad events until initial getItems() call of startup has finished:</span>
<a href="#l8.54"></a><span id="l8.54">             if (calendar &amp;&amp; this.alarmService.mLoadedCalendars[calendar.id]) {</span>
<a href="#l8.55"></a><span id="l8.55">                 // a refreshed calendar signals that it has been reloaded</span>
<a href="#l8.56"></a><span id="l8.56">                 // (and cannot notify detailed changes), thus reget all alarms of it:</span>
<a href="#l8.57"></a><span id="l8.57">                 this.alarmService.initAlarms([calendar]);</span>
<a href="#l8.58"></a><span id="l8.58">             }</span>
<a href="#l8.59"></a><span id="l8.59">         },</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineplus">+</span>
<a href="#l8.61"></a><span id="l8.61">         onAddItem: function(aItem) {</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineminus">-            var occs = [];</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineplus">+            let occs = [];</span>
<a href="#l8.64"></a><span id="l8.64">             if (aItem.recurrenceInfo) {</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineminus">-                var start = this.alarmService.mRangeEnd.clone();</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineplus">+                let start = this.alarmService.mRangeEnd.clone();</span>
<a href="#l8.67"></a><span id="l8.67">                 // We search 1 month in each direction for alarms.  Therefore,</span>
<a href="#l8.68"></a><span id="l8.68">                 // we need to go back 2 months from the end to get this right.</span>
<a href="#l8.69"></a><span id="l8.69">                 start.month -= 2;</span>
<a href="#l8.70"></a><span id="l8.70">                 occs = aItem.recurrenceInfo.getOccurrences(start, this.alarmService.mRangeEnd, 0, {});</span>
<a href="#l8.71"></a><span id="l8.71">             } else {</span>
<a href="#l8.72"></a><span id="l8.72">                 occs = [aItem];</span>
<a href="#l8.73"></a><span id="l8.73">             }</span>
<a href="#l8.74"></a><span id="l8.74"> </span>
<a href="#l8.75"></a><span id="l8.75" class="difflineminus">-            for each (var occ in occs) {</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineminus">-                this.alarmService.addAlarm(occ);</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineminus">-            }</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineplus">+            // Add an alarm for each occurrence</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineplus">+            occs.forEach(this.alarmService.addAlarmsForItem,</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineplus">+                         this.alarmService);</span>
<a href="#l8.81"></a><span id="l8.81">         },</span>
<a href="#l8.82"></a><span id="l8.82">         onModifyItem: function(aNewItem, aOldItem) {</span>
<a href="#l8.83"></a><span id="l8.83">             if (!aNewItem.recurrenceId) {</span>
<a href="#l8.84"></a><span id="l8.84">                 // deleting an occurrence currently calls modifyItem(newParent, *oldOccurrence*)</span>
<a href="#l8.85"></a><span id="l8.85">                 aOldItem = aOldItem.parentItem;</span>
<a href="#l8.86"></a><span id="l8.86">             }</span>
<a href="#l8.87"></a><span id="l8.87"> </span>
<a href="#l8.88"></a><span id="l8.88">             this.onDeleteItem(aOldItem);</span>
<a href="#l8.89"></a><span id="l8.89">             this.onAddItem(aNewItem);</span>
<a href="#l8.90"></a><span id="l8.90">         },</span>
<a href="#l8.91"></a><span id="l8.91">         onDeleteItem: function(aDeletedItem) {</span>
<a href="#l8.92"></a><span id="l8.92" class="difflineminus">-            this.alarmService.removeAlarm(aDeletedItem);</span>
<a href="#l8.93"></a><span id="l8.93" class="difflineplus">+            this.alarmService.removeAlarmsForItem(aDeletedItem);</span>
<a href="#l8.94"></a><span id="l8.94">         },</span>
<a href="#l8.95"></a><span id="l8.95">         onError: function(aCalendar, aErrNo, aMessage) {},</span>
<a href="#l8.96"></a><span id="l8.96">         onPropertyChanged: function(aCalendar, aName, aValue, aOldValue) {</span>
<a href="#l8.97"></a><span id="l8.97">             switch (aName) {</span>
<a href="#l8.98"></a><span id="l8.98">                 case &quot;suppressAlarms&quot;:</span>
<a href="#l8.99"></a><span id="l8.99">                 case &quot;disabled&quot;:</span>
<a href="#l8.100"></a><span id="l8.100">                     this.alarmService.initAlarms([aCalendar]);</span>
<a href="#l8.101"></a><span id="l8.101">                     break;</span>
<a href="#l8.102"></a><span id="l8.102" class="difflineat">@@ -132,464 +134,452 @@ function calAlarmService() {</span>
<a href="#l8.103"></a><span id="l8.103">             // there may still be dangling items (-&gt; alarm dialog),</span>
<a href="#l8.104"></a><span id="l8.104">             // dismissing those alarms may write data...</span>
<a href="#l8.105"></a><span id="l8.105">             this.alarmService.unobserveCalendar(aCalendar);</span>
<a href="#l8.106"></a><span id="l8.106">         },</span>
<a href="#l8.107"></a><span id="l8.107">         onCalendarDeleting: function(aCalendar) {}</span>
<a href="#l8.108"></a><span id="l8.108">     };</span>
<a href="#l8.109"></a><span id="l8.109"> }</span>
<a href="#l8.110"></a><span id="l8.110"> </span>
<a href="#l8.111"></a><span id="l8.111" class="difflineminus">-var calAlarmServiceClassInfo = {</span>
<a href="#l8.112"></a><span id="l8.112" class="difflineminus">-    getInterfaces: function (count) {</span>
<a href="#l8.113"></a><span id="l8.113" class="difflineminus">-        var ifaces = [</span>
<a href="#l8.114"></a><span id="l8.114" class="difflineplus">+calAlarmService.prototype = {</span>
<a href="#l8.115"></a><span id="l8.115" class="difflineplus">+    mRangeEnd: null,</span>
<a href="#l8.116"></a><span id="l8.116" class="difflineplus">+    mUpdateTimer: null,</span>
<a href="#l8.117"></a><span id="l8.117" class="difflineplus">+    mStarted: false,</span>
<a href="#l8.118"></a><span id="l8.118" class="difflineplus">+    mTimerMap: null,</span>
<a href="#l8.119"></a><span id="l8.119" class="difflineplus">+    mObservers: null,</span>
<a href="#l8.120"></a><span id="l8.120" class="difflineplus">+    mTimezone: null,</span>
<a href="#l8.121"></a><span id="l8.121" class="difflineplus">+</span>
<a href="#l8.122"></a><span id="l8.122" class="difflineplus">+    getInterfaces: function cAS_getInterfaces(aCount) {</span>
<a href="#l8.123"></a><span id="l8.123" class="difflineplus">+        let ifaces = [</span>
<a href="#l8.124"></a><span id="l8.124">             Components.interfaces.nsISupports,</span>
<a href="#l8.125"></a><span id="l8.125">             Components.interfaces.calIAlarmService,</span>
<a href="#l8.126"></a><span id="l8.126">             Components.interfaces.nsIObserver,</span>
<a href="#l8.127"></a><span id="l8.127">             Components.interfaces.nsIClassInfo</span>
<a href="#l8.128"></a><span id="l8.128">         ];</span>
<a href="#l8.129"></a><span id="l8.129" class="difflineminus">-        count.value = ifaces.length;</span>
<a href="#l8.130"></a><span id="l8.130" class="difflineplus">+        aCount.value = ifaces.length;</span>
<a href="#l8.131"></a><span id="l8.131">         return ifaces;</span>
<a href="#l8.132"></a><span id="l8.132">     },</span>
<a href="#l8.133"></a><span id="l8.133"> </span>
<a href="#l8.134"></a><span id="l8.134" class="difflineminus">-    getHelperForLanguage: function (language) {</span>
<a href="#l8.135"></a><span id="l8.135" class="difflineplus">+    getHelperForLanguage: function cAS_getHelperForLanguage(language) {</span>
<a href="#l8.136"></a><span id="l8.136">         return null;</span>
<a href="#l8.137"></a><span id="l8.137">     },</span>
<a href="#l8.138"></a><span id="l8.138"> </span>
<a href="#l8.139"></a><span id="l8.139" class="difflineplus">+    /**</span>
<a href="#l8.140"></a><span id="l8.140" class="difflineplus">+     * nsIClassInfo</span>
<a href="#l8.141"></a><span id="l8.141" class="difflineplus">+     */</span>
<a href="#l8.142"></a><span id="l8.142">     contractID: &quot;@mozilla.org/calendar/alarm-service;1&quot;,</span>
<a href="#l8.143"></a><span id="l8.143">     classDescription: &quot;Calendar Alarm Service&quot;,</span>
<a href="#l8.144"></a><span id="l8.144">     classID: Components.ID(&quot;{7a9200dd-6a64-4fff-a798-c5802186e2cc}&quot;),</span>
<a href="#l8.145"></a><span id="l8.145">     implementationLanguage: Components.interfaces.nsIProgrammingLanguage.JAVASCRIPT,</span>
<a href="#l8.146"></a><span id="l8.146" class="difflineminus">-    flags: Components.interfaces.nsIClassInfo.SINGLETON</span>
<a href="#l8.147"></a><span id="l8.147" class="difflineminus">-};</span>
<a href="#l8.148"></a><span id="l8.148" class="difflineminus">-</span>
<a href="#l8.149"></a><span id="l8.149" class="difflineminus">-calAlarmService.prototype = {</span>
<a href="#l8.150"></a><span id="l8.150" class="difflineminus">-    mRangeEnd: null,</span>
<a href="#l8.151"></a><span id="l8.151" class="difflineminus">-    mUpdateTimer: null,</span>
<a href="#l8.152"></a><span id="l8.152" class="difflineminus">-    mStarted: false,</span>
<a href="#l8.153"></a><span id="l8.153" class="difflineminus">-    mTimerLookup: null,</span>
<a href="#l8.154"></a><span id="l8.154" class="difflineminus">-    mObservers: null,</span>
<a href="#l8.155"></a><span id="l8.155" class="difflineplus">+    flags: Components.interfaces.nsIClassInfo.SINGLETON,</span>
<a href="#l8.156"></a><span id="l8.156"> </span>
<a href="#l8.157"></a><span id="l8.157" class="difflineminus">-    QueryInterface: function cas_QueryInterface(aIID) {</span>
<a href="#l8.158"></a><span id="l8.158" class="difflineminus">-        if (aIID.equals(Components.interfaces.nsIClassInfo))</span>
<a href="#l8.159"></a><span id="l8.159" class="difflineminus">-            return calAlarmServiceClassInfo;</span>
<a href="#l8.160"></a><span id="l8.160" class="difflineminus">-</span>
<a href="#l8.161"></a><span id="l8.161" class="difflineminus">-        if (!aIID.equals(Components.interfaces.nsISupports) &amp;&amp;</span>
<a href="#l8.162"></a><span id="l8.162" class="difflineminus">-            !aIID.equals(Components.interfaces.calIAlarmService) &amp;&amp;</span>
<a href="#l8.163"></a><span id="l8.163" class="difflineminus">-            !aIID.equals(Components.interfaces.nsIObserver))</span>
<a href="#l8.164"></a><span id="l8.164" class="difflineminus">-        {</span>
<a href="#l8.165"></a><span id="l8.165" class="difflineminus">-            throw Components.results.NS_ERROR_NO_INTERFACE;</span>
<a href="#l8.166"></a><span id="l8.166" class="difflineminus">-        }</span>
<a href="#l8.167"></a><span id="l8.167" class="difflineminus">-</span>
<a href="#l8.168"></a><span id="l8.168" class="difflineminus">-        return this;</span>
<a href="#l8.169"></a><span id="l8.169" class="difflineplus">+    QueryInterface: function cAS_QueryInterface(aIID) {</span>
<a href="#l8.170"></a><span id="l8.170" class="difflineplus">+        return doQueryInterface(this, calAlarmService.prototype, aIID, null, this);</span>
<a href="#l8.171"></a><span id="l8.171">     },</span>
<a href="#l8.172"></a><span id="l8.172"> </span>
<a href="#l8.173"></a><span id="l8.173" class="difflineminus">-    /* nsIObserver */</span>
<a href="#l8.174"></a><span id="l8.174" class="difflineminus">-    // This will also be called on app-startup, but nothing is done yet, to</span>
<a href="#l8.175"></a><span id="l8.175" class="difflineminus">-    // prevent unwanted dialogs etc. See bug 325476 and 413296 </span>
<a href="#l8.176"></a><span id="l8.176" class="difflineminus">-    observe: function cas_observe(subject, topic, data) {</span>
<a href="#l8.177"></a><span id="l8.177" class="difflineminus">-        if (topic == &quot;profile-after-change&quot; || topic == &quot;wake_notification&quot;) {</span>
<a href="#l8.178"></a><span id="l8.178" class="difflineplus">+    /**</span>
<a href="#l8.179"></a><span id="l8.179" class="difflineplus">+     * nsIObserver</span>
<a href="#l8.180"></a><span id="l8.180" class="difflineplus">+     */</span>
<a href="#l8.181"></a><span id="l8.181" class="difflineplus">+    observe: function cAS_observe(aSubject, aTopic, aData) {</span>
<a href="#l8.182"></a><span id="l8.182" class="difflineplus">+        // This will also be called on app-startup, but nothing is done yet, to</span>
<a href="#l8.183"></a><span id="l8.183" class="difflineplus">+        // prevent unwanted dialogs etc. See bug 325476 and 413296 </span>
<a href="#l8.184"></a><span id="l8.184" class="difflineplus">+        if (aTopic == &quot;profile-after-change&quot; || aTopic == &quot;wake_notification&quot;) {</span>
<a href="#l8.185"></a><span id="l8.185">             this.shutdown();</span>
<a href="#l8.186"></a><span id="l8.186">             this.startup();</span>
<a href="#l8.187"></a><span id="l8.187">         }</span>
<a href="#l8.188"></a><span id="l8.188" class="difflineminus">-        if (topic == &quot;xpcom-shutdown&quot;) {</span>
<a href="#l8.189"></a><span id="l8.189" class="difflineplus">+        if (aTopic == &quot;xpcom-shutdown&quot;) {</span>
<a href="#l8.190"></a><span id="l8.190">             this.shutdown();</span>
<a href="#l8.191"></a><span id="l8.191">         }</span>
<a href="#l8.192"></a><span id="l8.192">     },</span>
<a href="#l8.193"></a><span id="l8.193"> </span>
<a href="#l8.194"></a><span id="l8.194" class="difflineminus">-    /* calIAlarmService APIs */</span>
<a href="#l8.195"></a><span id="l8.195" class="difflineminus">-    mTimezone: null,</span>
<a href="#l8.196"></a><span id="l8.196" class="difflineminus">-    get timezone() {</span>
<a href="#l8.197"></a><span id="l8.197" class="difflineplus">+    /**</span>
<a href="#l8.198"></a><span id="l8.198" class="difflineplus">+     * calIAlarmService APIs</span>
<a href="#l8.199"></a><span id="l8.199" class="difflineplus">+     */</span>
<a href="#l8.200"></a><span id="l8.200" class="difflineplus">+    get timezone cAS_get_timezone() {</span>
<a href="#l8.201"></a><span id="l8.201" class="difflineplus">+        // TODO Do we really need this? Do we ever set the timezone to something</span>
<a href="#l8.202"></a><span id="l8.202" class="difflineplus">+        // different than the default timezone?</span>
<a href="#l8.203"></a><span id="l8.203">         return this.mTimezone || calendarDefaultTimezone();</span>
<a href="#l8.204"></a><span id="l8.204">     },</span>
<a href="#l8.205"></a><span id="l8.205"> </span>
<a href="#l8.206"></a><span id="l8.206" class="difflineminus">-    set timezone(aTimezone) {</span>
<a href="#l8.207"></a><span id="l8.207" class="difflineplus">+    set timezone cAS_set_timezone(aTimezone) {</span>
<a href="#l8.208"></a><span id="l8.208">         return (this.mTimezone = aTimezone);</span>
<a href="#l8.209"></a><span id="l8.209">     },</span>
<a href="#l8.210"></a><span id="l8.210"> </span>
<a href="#l8.211"></a><span id="l8.211" class="difflineminus">-    snoozeAlarm: function cas_snoozeAlarm(event, duration) {</span>
<a href="#l8.212"></a><span id="l8.212" class="difflineminus">-        /* modify the event for a new alarm time */</span>
<a href="#l8.213"></a><span id="l8.213" class="difflineplus">+    snoozeAlarm: function cAS_snoozeAlarm(aItem, aAlarm, aDuration) {</span>
<a href="#l8.214"></a><span id="l8.214" class="difflineplus">+        // Right now we only support snoozing all alarms for the given item for</span>
<a href="#l8.215"></a><span id="l8.215" class="difflineplus">+        // aDuration.</span>
<a href="#l8.216"></a><span id="l8.216" class="difflineplus">+</span>
<a href="#l8.217"></a><span id="l8.217">         // Make sure we're working with the parent, otherwise we'll accidentally</span>
<a href="#l8.218"></a><span id="l8.218">         // create an exception</span>
<a href="#l8.219"></a><span id="l8.219" class="difflineminus">-        var newEvent = event.parentItem.clone();</span>
<a href="#l8.220"></a><span id="l8.220" class="difflineminus">-        var alarmTime = nowUTC();</span>
<a href="#l8.221"></a><span id="l8.221" class="difflineplus">+        let newEvent = aItem.parentItem.clone();</span>
<a href="#l8.222"></a><span id="l8.222" class="difflineplus">+        let alarmTime = nowUTC();</span>
<a href="#l8.223"></a><span id="l8.223"> </span>
<a href="#l8.224"></a><span id="l8.224">         // Set the last acknowledged time to now.</span>
<a href="#l8.225"></a><span id="l8.225">         newEvent.alarmLastAck = alarmTime;</span>
<a href="#l8.226"></a><span id="l8.226"> </span>
<a href="#l8.227"></a><span id="l8.227">         alarmTime = alarmTime.clone();</span>
<a href="#l8.228"></a><span id="l8.228" class="difflineminus">-        alarmTime.addDuration(duration);</span>
<a href="#l8.229"></a><span id="l8.229" class="difflineplus">+        alarmTime.addDuration(aDuration);</span>
<a href="#l8.230"></a><span id="l8.230"> </span>
<a href="#l8.231"></a><span id="l8.231" class="difflineminus">-        if (event.parentItem != event) {</span>
<a href="#l8.232"></a><span id="l8.232" class="difflineplus">+        if (aItem.parentItem != aItem) {</span>
<a href="#l8.233"></a><span id="l8.233">             // This is the *really* hard case where we've snoozed a single</span>
<a href="#l8.234"></a><span id="l8.234">             // instance of a recurring event.  We need to not only know that</span>
<a href="#l8.235"></a><span id="l8.235">             // there was a snooze, but also which occurrence was snoozed.  Part</span>
<a href="#l8.236"></a><span id="l8.236">             // of me just wants to create a local db of snoozes here...</span>
<a href="#l8.237"></a><span id="l8.237" class="difflineminus">-            newEvent.setProperty(&quot;X-MOZ-SNOOZE-TIME-&quot; + event.recurrenceId.nativeTime,</span>
<a href="#l8.238"></a><span id="l8.238" class="difflineplus">+            newEvent.setProperty(&quot;X-MOZ-SNOOZE-TIME-&quot; + aItem.recurrenceId.nativeTime,</span>
<a href="#l8.239"></a><span id="l8.239">                                  alarmTime.icalString);</span>
<a href="#l8.240"></a><span id="l8.240">         } else {</span>
<a href="#l8.241"></a><span id="l8.241">             newEvent.setProperty(&quot;X-MOZ-SNOOZE-TIME&quot;, alarmTime.icalString);</span>
<a href="#l8.242"></a><span id="l8.242">         }</span>
<a href="#l8.243"></a><span id="l8.243">         // calling modifyItem will cause us to get the right callback</span>
<a href="#l8.244"></a><span id="l8.244">         // and update the alarm properly</span>
<a href="#l8.245"></a><span id="l8.245" class="difflineminus">-        newEvent.calendar.modifyItem(newEvent, event.parentItem, null);</span>
<a href="#l8.246"></a><span id="l8.246" class="difflineplus">+        return newEvent.calendar.modifyItem(newEvent, aItem.parentItem, null);</span>
<a href="#l8.247"></a><span id="l8.247">     },</span>
<a href="#l8.248"></a><span id="l8.248"> </span>
<a href="#l8.249"></a><span id="l8.249" class="difflineminus">-    dismissAlarm: function cas_dismissAlarm(item) {</span>
<a href="#l8.250"></a><span id="l8.250" class="difflineminus">-        var now = nowUTC();</span>
<a href="#l8.251"></a><span id="l8.251" class="difflineplus">+    dismissAlarm: function cAS_dismissAlarm(aItem, aAlarm) {</span>
<a href="#l8.252"></a><span id="l8.252" class="difflineplus">+        let now = nowUTC();</span>
<a href="#l8.253"></a><span id="l8.253">         // We want the parent item, otherwise we're going to accidentally create an</span>
<a href="#l8.254"></a><span id="l8.254">         // exception.  We've relnoted (for 0.1) the slightly odd behavior this can</span>
<a href="#l8.255"></a><span id="l8.255">         // cause if you move an event after dismissing an alarm</span>
<a href="#l8.256"></a><span id="l8.256" class="difflineminus">-        var oldParent = item.parentItem;</span>
<a href="#l8.257"></a><span id="l8.257" class="difflineminus">-        var newParent = oldParent.clone();</span>
<a href="#l8.258"></a><span id="l8.258" class="difflineplus">+        let oldParent = aItem.parentItem;</span>
<a href="#l8.259"></a><span id="l8.259" class="difflineplus">+        let newParent = oldParent.clone();</span>
<a href="#l8.260"></a><span id="l8.260">         newParent.alarmLastAck = now;</span>
<a href="#l8.261"></a><span id="l8.261">         // Make sure to clear out any snoozes that were here.</span>
<a href="#l8.262"></a><span id="l8.262" class="difflineminus">-        if (item.recurrenceId) {</span>
<a href="#l8.263"></a><span id="l8.263" class="difflineminus">-            newParent.deleteProperty(&quot;X-MOZ-SNOOZE-TIME-&quot; + item.recurrenceId.nativeTime);</span>
<a href="#l8.264"></a><span id="l8.264" class="difflineplus">+        if (aItem.recurrenceId) {</span>
<a href="#l8.265"></a><span id="l8.265" class="difflineplus">+            newParent.deleteProperty(&quot;X-MOZ-SNOOZE-TIME-&quot; + aItem.recurrenceId.nativeTime);</span>
<a href="#l8.266"></a><span id="l8.266">         } else {</span>
<a href="#l8.267"></a><span id="l8.267">             newParent.deleteProperty(&quot;X-MOZ-SNOOZE-TIME&quot;);</span>
<a href="#l8.268"></a><span id="l8.268">         }</span>
<a href="#l8.269"></a><span id="l8.269" class="difflineminus">-        newParent.calendar.modifyItem(newParent, oldParent, null);</span>
<a href="#l8.270"></a><span id="l8.270" class="difflineplus">+        return newParent.calendar.modifyItem(newParent, oldParent, null);</span>
<a href="#l8.271"></a><span id="l8.271">     },</span>
<a href="#l8.272"></a><span id="l8.272"> </span>
<a href="#l8.273"></a><span id="l8.273" class="difflineminus">-    addObserver: function cas_addObserver(aObserver) {</span>
<a href="#l8.274"></a><span id="l8.274" class="difflineplus">+    addObserver: function cAS_addObserver(aObserver) {</span>
<a href="#l8.275"></a><span id="l8.275">         this.mObservers.add(aObserver);</span>
<a href="#l8.276"></a><span id="l8.276">     },</span>
<a href="#l8.277"></a><span id="l8.277"> </span>
<a href="#l8.278"></a><span id="l8.278" class="difflineminus">-    removeObserver: function cas_removeObserver(aObserver) {</span>
<a href="#l8.279"></a><span id="l8.279" class="difflineplus">+    removeObserver: function cAS_removeObserver(aObserver) {</span>
<a href="#l8.280"></a><span id="l8.280">         this.mObservers.remove(aObserver);</span>
<a href="#l8.281"></a><span id="l8.281">     },</span>
<a href="#l8.282"></a><span id="l8.282"> </span>
<a href="#l8.283"></a><span id="l8.283" class="difflineminus">-    notifyObservers: function cas_notifyObservers(functionName, args) {</span>
<a href="#l8.284"></a><span id="l8.284" class="difflineminus">-        this.mObservers.notify(functionName, args);</span>
<a href="#l8.285"></a><span id="l8.285" class="difflineminus">-    },</span>
<a href="#l8.286"></a><span id="l8.286" class="difflineplus">+    startup: function cAS_startup() {</span>
<a href="#l8.287"></a><span id="l8.287" class="difflineplus">+        if (this.mStarted) {</span>
<a href="#l8.288"></a><span id="l8.288" class="difflineplus">+            return;</span>
<a href="#l8.289"></a><span id="l8.289" class="difflineplus">+        }</span>
<a href="#l8.290"></a><span id="l8.290"> </span>
<a href="#l8.291"></a><span id="l8.291" class="difflineminus">-    startup: function cas_startup() {</span>
<a href="#l8.292"></a><span id="l8.292" class="difflineminus">-        if (this.mStarted)</span>
<a href="#l8.293"></a><span id="l8.293" class="difflineminus">-            return;</span>
<a href="#l8.294"></a><span id="l8.294" class="difflineplus">+        cal.LOG(&quot;[calAlarmService] starting...&quot;);</span>
<a href="#l8.295"></a><span id="l8.295"> </span>
<a href="#l8.296"></a><span id="l8.296" class="difflineminus">-        LOG(&quot;[calAlarmService] starting...&quot;);</span>
<a href="#l8.297"></a><span id="l8.297" class="difflineminus">-</span>
<a href="#l8.298"></a><span id="l8.298" class="difflineminus">-        var observerSvc = Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l8.299"></a><span id="l8.299" class="difflineplus">+        let observerSvc = Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l8.300"></a><span id="l8.300">                           .getService</span>
<a href="#l8.301"></a><span id="l8.301">                           (Components.interfaces.nsIObserverService);</span>
<a href="#l8.302"></a><span id="l8.302"> </span>
<a href="#l8.303"></a><span id="l8.303">         observerSvc.addObserver(this, &quot;profile-after-change&quot;, false);</span>
<a href="#l8.304"></a><span id="l8.304">         observerSvc.addObserver(this, &quot;xpcom-shutdown&quot;, false);</span>
<a href="#l8.305"></a><span id="l8.305">         observerSvc.addObserver(this, &quot;wake_notification&quot;, false);</span>
<a href="#l8.306"></a><span id="l8.306"> </span>
<a href="#l8.307"></a><span id="l8.307">         /* Tell people that we're alive so they can start monitoring alarms.</span>
<a href="#l8.308"></a><span id="l8.308">          */</span>
<a href="#l8.309"></a><span id="l8.309" class="difflineminus">-        this.notifier = Components.classes[&quot;@mozilla.org/embedcomp/appstartup-notifier;1&quot;]</span>
<a href="#l8.310"></a><span id="l8.310" class="difflineminus">-                                  .getService(Components.interfaces.nsIObserver);</span>
<a href="#l8.311"></a><span id="l8.311" class="difflineminus">-        var notifier = this.notifier;</span>
<a href="#l8.312"></a><span id="l8.312" class="difflineplus">+        let notifier = Components.classes[&quot;@mozilla.org/embedcomp/appstartup-notifier;1&quot;]</span>
<a href="#l8.313"></a><span id="l8.313" class="difflineplus">+                                 .getService(Components.interfaces.nsIObserver);</span>
<a href="#l8.314"></a><span id="l8.314">         notifier.observe(null, &quot;alarm-service-startup&quot;, null);</span>
<a href="#l8.315"></a><span id="l8.315"> </span>
<a href="#l8.316"></a><span id="l8.316">         getCalendarManager().addObserver(this.calendarManagerObserver);</span>
<a href="#l8.317"></a><span id="l8.317"> </span>
<a href="#l8.318"></a><span id="l8.318" class="difflineminus">-        for each(var calendar in getCalendarManager().getCalendars({})) {</span>
<a href="#l8.319"></a><span id="l8.319" class="difflineplus">+        for each(let calendar in getCalendarManager().getCalendars({})) {</span>
<a href="#l8.320"></a><span id="l8.320">             this.observeCalendar(calendar);</span>
<a href="#l8.321"></a><span id="l8.321">         }</span>
<a href="#l8.322"></a><span id="l8.322"> </span>
<a href="#l8.323"></a><span id="l8.323">         /* set up a timer to update alarms every N hours */</span>
<a href="#l8.324"></a><span id="l8.324" class="difflineminus">-        var timerCallback = {</span>
<a href="#l8.325"></a><span id="l8.325" class="difflineplus">+        let timerCallback = {</span>
<a href="#l8.326"></a><span id="l8.326">             alarmService: this,</span>
<a href="#l8.327"></a><span id="l8.327">             notify: function timer_notify() {</span>
<a href="#l8.328"></a><span id="l8.328" class="difflineminus">-                var now = nowUTC();</span>
<a href="#l8.329"></a><span id="l8.329" class="difflineminus">-                var start;</span>
<a href="#l8.330"></a><span id="l8.330" class="difflineplus">+                let now = nowUTC();</span>
<a href="#l8.331"></a><span id="l8.331" class="difflineplus">+                let start;</span>
<a href="#l8.332"></a><span id="l8.332">                 if (!this.alarmService.mRangeEnd) {</span>
<a href="#l8.333"></a><span id="l8.333">                     // This is our first search for alarms.  We're going to look for</span>
<a href="#l8.334"></a><span id="l8.334">                     // alarms +/- 1 month from now.  If someone sets an alarm more than</span>
<a href="#l8.335"></a><span id="l8.335">                     // a month ahead of an event, or doesn't start Sunbird/Lightning</span>
<a href="#l8.336"></a><span id="l8.336">                     // for a month, they'll miss some, but that's a slim chance</span>
<a href="#l8.337"></a><span id="l8.337">                     start = now.clone();</span>
<a href="#l8.338"></a><span id="l8.338">                     start.month -= 1;</span>
<a href="#l8.339"></a><span id="l8.339">                 } else {</span>
<a href="#l8.340"></a><span id="l8.340">                     // This is a subsequent search, so we got all the past alarms before</span>
<a href="#l8.341"></a><span id="l8.341">                     start = this.alarmService.mRangeEnd.clone();</span>
<a href="#l8.342"></a><span id="l8.342">                 }</span>
<a href="#l8.343"></a><span id="l8.343" class="difflineminus">-                var until = now.clone();</span>
<a href="#l8.344"></a><span id="l8.344" class="difflineplus">+                let until = now.clone();</span>
<a href="#l8.345"></a><span id="l8.345">                 until.month += 1;</span>
<a href="#l8.346"></a><span id="l8.346">                 </span>
<a href="#l8.347"></a><span id="l8.347">                 // We don't set timers for every future alarm, only those within 6 hours</span>
<a href="#l8.348"></a><span id="l8.348" class="difflineminus">-                var end = now.clone();</span>
<a href="#l8.349"></a><span id="l8.349" class="difflineplus">+                let end = now.clone();</span>
<a href="#l8.350"></a><span id="l8.350">                 end.hour += kHoursBetweenUpdates;</span>
<a href="#l8.351"></a><span id="l8.351">                 this.alarmService.mRangeEnd = end.getInTimezone(UTC());</span>
<a href="#l8.352"></a><span id="l8.352"> </span>
<a href="#l8.353"></a><span id="l8.353">                 this.alarmService.findAlarms(getCalendarManager().getCalendars({}),</span>
<a href="#l8.354"></a><span id="l8.354">                                              start, until);</span>
<a href="#l8.355"></a><span id="l8.355">             }</span>
<a href="#l8.356"></a><span id="l8.356">         };</span>
<a href="#l8.357"></a><span id="l8.357">         timerCallback.notify();</span>
<a href="#l8.358"></a><span id="l8.358"> </span>
<a href="#l8.359"></a><span id="l8.359">         this.mUpdateTimer = newTimerWithCallback(timerCallback, kHoursBetweenUpdates * 3600000, true);</span>
<a href="#l8.360"></a><span id="l8.360"> </span>
<a href="#l8.361"></a><span id="l8.361">         this.mStarted = true;</span>
<a href="#l8.362"></a><span id="l8.362">     },</span>
<a href="#l8.363"></a><span id="l8.363"> </span>
<a href="#l8.364"></a><span id="l8.364" class="difflineminus">-    shutdown: function cas_shutdown() {</span>
<a href="#l8.365"></a><span id="l8.365" class="difflineplus">+    shutdown: function cAS_shutdown() {</span>
<a href="#l8.366"></a><span id="l8.366">         /* tell people that we're no longer running */</span>
<a href="#l8.367"></a><span id="l8.367" class="difflineminus">-        var notifier = this.notifier;</span>
<a href="#l8.368"></a><span id="l8.368" class="difflineplus">+        let notifier = Components.classes[&quot;@mozilla.org/embedcomp/appstartup-notifier;1&quot;]</span>
<a href="#l8.369"></a><span id="l8.369" class="difflineplus">+                                 .getService(Components.interfaces.nsIObserver);</span>
<a href="#l8.370"></a><span id="l8.370">         notifier.observe(null, &quot;alarm-service-shutdown&quot;, null);</span>
<a href="#l8.371"></a><span id="l8.371"> </span>
<a href="#l8.372"></a><span id="l8.372">         if (this.mUpdateTimer) {</span>
<a href="#l8.373"></a><span id="l8.373">             this.mUpdateTimer.cancel();</span>
<a href="#l8.374"></a><span id="l8.374">             this.mUpdateTimer = null;</span>
<a href="#l8.375"></a><span id="l8.375">         }</span>
<a href="#l8.376"></a><span id="l8.376" class="difflineplus">+        let calmgr = cal.getCalendarManager();</span>
<a href="#l8.377"></a><span id="l8.377">         </span>
<a href="#l8.378"></a><span id="l8.378" class="difflineminus">-        getCalendarManager().removeObserver(this.calendarManagerObserver);</span>
<a href="#l8.379"></a><span id="l8.379" class="difflineplus">+        calmgr.removeObserver(this.calendarManagerObserver);</span>
<a href="#l8.380"></a><span id="l8.380"> </span>
<a href="#l8.381"></a><span id="l8.381" class="difflineminus">-        for each (var cal in this.mTimerLookup) {</span>
<a href="#l8.382"></a><span id="l8.382" class="difflineminus">-            for each (var itemTimers in cal) {</span>
<a href="#l8.383"></a><span id="l8.383" class="difflineminus">-                for each (var timer in itemTimers) {</span>
<a href="#l8.384"></a><span id="l8.384" class="difflineminus">-                    if (timer instanceof Components.interfaces.nsITimer) {</span>
<a href="#l8.385"></a><span id="l8.385" class="difflineminus">-                        timer.cancel();</span>
<a href="#l8.386"></a><span id="l8.386" class="difflineminus">-                    }</span>
<a href="#l8.387"></a><span id="l8.387" class="difflineplus">+        for each (let calendarItemMap in this.mTimerMap) {</span>
<a href="#l8.388"></a><span id="l8.388" class="difflineplus">+            for each (let alarmMap in calendarItemMap) {</span>
<a href="#l8.389"></a><span id="l8.389" class="difflineplus">+                for each (let timer in alarmMap) {</span>
<a href="#l8.390"></a><span id="l8.390" class="difflineplus">+                    timer.cancel();</span>
<a href="#l8.391"></a><span id="l8.391">                 }</span>
<a href="#l8.392"></a><span id="l8.392">             }</span>
<a href="#l8.393"></a><span id="l8.393">         }</span>
<a href="#l8.394"></a><span id="l8.394" class="difflineminus">-        this.mTimerLookup = {};</span>
<a href="#l8.395"></a><span id="l8.395"> </span>
<a href="#l8.396"></a><span id="l8.396" class="difflineminus">-        for each(var calendar in getCalendarManager().getCalendars({})) {</span>
<a href="#l8.397"></a><span id="l8.397" class="difflineplus">+        this.mTimerMap = {};</span>
<a href="#l8.398"></a><span id="l8.398" class="difflineplus">+</span>
<a href="#l8.399"></a><span id="l8.399" class="difflineplus">+        for each (let calendar in calmgr.getCalendars({})) {</span>
<a href="#l8.400"></a><span id="l8.400">             this.unobserveCalendar(calendar);</span>
<a href="#l8.401"></a><span id="l8.401">         }</span>
<a href="#l8.402"></a><span id="l8.402"> </span>
<a href="#l8.403"></a><span id="l8.403" class="difflineminus">-        this.notifier = null;</span>
<a href="#l8.404"></a><span id="l8.404">         this.mRangeEnd = null;</span>
<a href="#l8.405"></a><span id="l8.405"> </span>
<a href="#l8.406"></a><span id="l8.406" class="difflineminus">-        var observerSvc = Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l8.407"></a><span id="l8.407" class="difflineminus">-                          .getService</span>
<a href="#l8.408"></a><span id="l8.408" class="difflineminus">-                          (Components.interfaces.nsIObserverService);</span>
<a href="#l8.409"></a><span id="l8.409" class="difflineplus">+        let observerSvc = Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l8.410"></a><span id="l8.410" class="difflineplus">+                          .getService(Components.interfaces.nsIObserverService);</span>
<a href="#l8.411"></a><span id="l8.411"> </span>
<a href="#l8.412"></a><span id="l8.412">         observerSvc.removeObserver(this, &quot;profile-after-change&quot;);</span>
<a href="#l8.413"></a><span id="l8.413">         observerSvc.removeObserver(this, &quot;xpcom-shutdown&quot;);</span>
<a href="#l8.414"></a><span id="l8.414">         observerSvc.removeObserver(this, &quot;wake_notification&quot;);</span>
<a href="#l8.415"></a><span id="l8.415"> </span>
<a href="#l8.416"></a><span id="l8.416">         this.mStarted = false;</span>
<a href="#l8.417"></a><span id="l8.417">     },</span>
<a href="#l8.418"></a><span id="l8.418"> </span>
<a href="#l8.419"></a><span id="l8.419" class="difflineminus">-    observeCalendar: function cas_observeCalendar(calendar) {</span>
<a href="#l8.420"></a><span id="l8.420" class="difflineplus">+    observeCalendar: function cAS_observeCalendar(calendar) {</span>
<a href="#l8.421"></a><span id="l8.421">         calendar.addObserver(this.calendarObserver);</span>
<a href="#l8.422"></a><span id="l8.422">     },</span>
<a href="#l8.423"></a><span id="l8.423"> </span>
<a href="#l8.424"></a><span id="l8.424" class="difflineminus">-    unobserveCalendar: function cas_unobserveCalendar(calendar) {</span>
<a href="#l8.425"></a><span id="l8.425" class="difflineplus">+    unobserveCalendar: function cAS_unobserveCalendar(calendar) {</span>
<a href="#l8.426"></a><span id="l8.426">         calendar.removeObserver(this.calendarObserver);</span>
<a href="#l8.427"></a><span id="l8.427">         this.disposeCalendarTimers([calendar]);</span>
<a href="#l8.428"></a><span id="l8.428" class="difflineminus">-        this.notifyObservers(&quot;onRemoveAlarmsByCalendar&quot;, [calendar]);</span>
<a href="#l8.429"></a><span id="l8.429" class="difflineplus">+        this.mObservers.notify(&quot;onRemoveAlarmsByCalendar&quot;, [calendar]);</span>
<a href="#l8.430"></a><span id="l8.430">     },</span>
<a href="#l8.431"></a><span id="l8.431"> </span>
<a href="#l8.432"></a><span id="l8.432" class="difflineminus">-    getAlarmDate: function cas_getAlarmTime(aItem) {</span>
<a href="#l8.433"></a><span id="l8.433" class="difflineminus">-        var alarmDate = null;</span>
<a href="#l8.434"></a><span id="l8.434" class="difflineminus">-        // TODO ALARMSUPPORT This will change as soon as we support multiple</span>
<a href="#l8.435"></a><span id="l8.435" class="difflineminus">-        // alarms. Get the first DISPLAY alarm for now.</span>
<a href="#l8.436"></a><span id="l8.436" class="difflineminus">-        let alarms = aItem.getAlarms({}).filter(function(x) x.action == &quot;DISPLAY&quot;);</span>
<a href="#l8.437"></a><span id="l8.437" class="difflineminus">-        let alarm = alarms[0];</span>
<a href="#l8.438"></a><span id="l8.438" class="difflineminus">-        if (!alarm) {</span>
<a href="#l8.439"></a><span id="l8.439" class="difflineminus">-            // No relative alarm available.</span>
<a href="#l8.440"></a><span id="l8.440" class="difflineminus">-            return null;</span>
<a href="#l8.441"></a><span id="l8.441" class="difflineminus">-        }</span>
<a href="#l8.442"></a><span id="l8.442" class="difflineminus">-        // END TODO ALARMSUPPORT</span>
<a href="#l8.443"></a><span id="l8.443" class="difflineminus">-        </span>
<a href="#l8.444"></a><span id="l8.444" class="difflineminus">-        let alarmDate = cal.alarms.calculateAlarmDate(aItem, alarm)</span>
<a href="#l8.445"></a><span id="l8.445" class="difflineminus">-        return (alarmDate ? alarmDate.getInTimezone(UTC()) : null);</span>
<a href="#l8.446"></a><span id="l8.446" class="difflineminus">-    },</span>
<a href="#l8.447"></a><span id="l8.447" class="difflineminus">-</span>
<a href="#l8.448"></a><span id="l8.448" class="difflineminus">-    addAlarm: function cas_addAlarm(aItem) {</span>
<a href="#l8.449"></a><span id="l8.449" class="difflineminus">-        // Get the alarm time</span>
<a href="#l8.450"></a><span id="l8.450" class="difflineminus">-        var alarmTime = this.getAlarmDate(aItem);</span>
<a href="#l8.451"></a><span id="l8.451" class="difflineminus">-        if (!alarmTime || (isToDo(aItem) &amp;&amp; aItem.isCompleted)) {</span>
<a href="#l8.452"></a><span id="l8.452" class="difflineminus">-            // If there is no alarm time, don't add the alarm. Also, if the item</span>
<a href="#l8.453"></a><span id="l8.453" class="difflineminus">-            // is a task and it is completed, don't add the alarm.</span>
<a href="#l8.454"></a><span id="l8.454" class="difflineplus">+    addAlarmsForItem: function cAS_addAlarmsForItem(aItem) {</span>
<a href="#l8.455"></a><span id="l8.455" class="difflineplus">+        if (cal.isToDo(aItem) &amp;&amp; aItem.isCompleted) {</span>
<a href="#l8.456"></a><span id="l8.456" class="difflineplus">+            // If this is a task and it is completed, don't add the alarm.</span>
<a href="#l8.457"></a><span id="l8.457">             return;</span>
<a href="#l8.458"></a><span id="l8.458">         }</span>
<a href="#l8.459"></a><span id="l8.459"> </span>
<a href="#l8.460"></a><span id="l8.460" class="difflineminus">-        // Check for snooze</span>
<a href="#l8.461"></a><span id="l8.461" class="difflineminus">-        var snoozeTime;</span>
<a href="#l8.462"></a><span id="l8.462" class="difflineminus">-        if (aItem.parentItem != aItem) {</span>
<a href="#l8.463"></a><span id="l8.463" class="difflineminus">-            snoozeTime = aItem.parentItem.getProperty(&quot;X-MOZ-SNOOZE-TIME-&quot;+aItem.recurrenceId.nativeTime)</span>
<a href="#l8.464"></a><span id="l8.464" class="difflineminus">-        } else {</span>
<a href="#l8.465"></a><span id="l8.465" class="difflineminus">-            snoozeTime = aItem.getProperty(&quot;X-MOZ-SNOOZE-TIME&quot;);</span>
<a href="#l8.466"></a><span id="l8.466" class="difflineminus">-        }</span>
<a href="#l8.467"></a><span id="l8.467" class="difflineplus">+        let alarms = aItem.getAlarms({});</span>
<a href="#l8.468"></a><span id="l8.468" class="difflineplus">+        for each (let alarm in alarms) {</span>
<a href="#l8.469"></a><span id="l8.469" class="difflineplus">+            let alarmDate = cal.alarms.calculateAlarmDate(aItem, alarm);</span>
<a href="#l8.470"></a><span id="l8.470"> </span>
<a href="#l8.471"></a><span id="l8.471" class="difflineminus">-        if (snoozeTime &amp;&amp; !(snoozeTime instanceof Components.interfaces.calIDateTime)) {</span>
<a href="#l8.472"></a><span id="l8.472" class="difflineminus">-            var time = createDateTime();</span>
<a href="#l8.473"></a><span id="l8.473" class="difflineminus">-            time.icalString = snoozeTime;</span>
<a href="#l8.474"></a><span id="l8.474" class="difflineminus">-            snoozeTime = time;</span>
<a href="#l8.475"></a><span id="l8.475" class="difflineminus">-        }</span>
<a href="#l8.476"></a><span id="l8.476" class="difflineminus">-        LOG(&quot;[calAlarmService] considering alarm for item: &quot; + aItem.title +</span>
<a href="#l8.477"></a><span id="l8.477" class="difflineminus">-            &quot; alarm time: &quot; + alarmTime + &quot; snooze time: &quot; + snoozeTime);</span>
<a href="#l8.478"></a><span id="l8.478" class="difflineminus">-</span>
<a href="#l8.479"></a><span id="l8.479" class="difflineminus">-        // If the alarm was snoozed, the snooze time is more important.</span>
<a href="#l8.480"></a><span id="l8.480" class="difflineminus">-        alarmTime = snoozeTime || alarmTime;</span>
<a href="#l8.481"></a><span id="l8.481" class="difflineplus">+            if (!alarmDate || alarm.action != &quot;DISPLAY&quot;) {</span>
<a href="#l8.482"></a><span id="l8.482" class="difflineplus">+                // Only take care of DISPLAY alarms with an alarm date.</span>
<a href="#l8.483"></a><span id="l8.483" class="difflineplus">+                continue;</span>
<a href="#l8.484"></a><span id="l8.484" class="difflineplus">+            }</span>
<a href="#l8.485"></a><span id="l8.485"> </span>
<a href="#l8.486"></a><span id="l8.486" class="difflineminus">-        var now = jsDateToDateTime(new Date());</span>
<a href="#l8.487"></a><span id="l8.487" class="difflineminus">-        if (alarmTime.timezone.isFloating) {</span>
<a href="#l8.488"></a><span id="l8.488" class="difflineminus">-            now = now.getInTimezone(calendarDefaultTimezone());</span>
<a href="#l8.489"></a><span id="l8.489" class="difflineminus">-            now.timezone = floating();</span>
<a href="#l8.490"></a><span id="l8.490" class="difflineminus">-        } else {</span>
<a href="#l8.491"></a><span id="l8.491" class="difflineminus">-            now = now.getInTimezone(UTC());</span>
<a href="#l8.492"></a><span id="l8.492" class="difflineminus">-        }</span>
<a href="#l8.493"></a><span id="l8.493" class="difflineminus">-        LOG(&quot;[calAlarmService] now is &quot; + now);</span>
<a href="#l8.494"></a><span id="l8.494" class="difflineminus">-        var callbackObj = {</span>
<a href="#l8.495"></a><span id="l8.495" class="difflineminus">-            alarmService: this,</span>
<a href="#l8.496"></a><span id="l8.496" class="difflineminus">-            item: aItem,</span>
<a href="#l8.497"></a><span id="l8.497" class="difflineminus">-            notify: function(timer) {</span>
<a href="#l8.498"></a><span id="l8.498" class="difflineminus">-                this.alarmService.alarmFired(this.item);</span>
<a href="#l8.499"></a><span id="l8.499" class="difflineminus">-                this.alarmService.removeTimers(this.item);</span>
<a href="#l8.500"></a><span id="l8.500" class="difflineplus">+            // Handle all day events.  This is kinda weird, because they don't have</span>
<a href="#l8.501"></a><span id="l8.501" class="difflineplus">+            // a well defined startTime.  We just consider the start/end to be</span>
<a href="#l8.502"></a><span id="l8.502" class="difflineplus">+            // midnight in the user's timezone.</span>
<a href="#l8.503"></a><span id="l8.503" class="difflineplus">+            if (alarmDate.isDate) {</span>
<a href="#l8.504"></a><span id="l8.504" class="difflineplus">+                alarmDate = alarmDate.getInTimezone(this.timezone);</span>
<a href="#l8.505"></a><span id="l8.505" class="difflineplus">+                alarmDate.isDate = false;</span>
<a href="#l8.506"></a><span id="l8.506">             }</span>
<a href="#l8.507"></a><span id="l8.507" class="difflineminus">-        };</span>
<a href="#l8.508"></a><span id="l8.508" class="difflineminus">-</span>
<a href="#l8.509"></a><span id="l8.509" class="difflineminus">-        if (alarmTime.compare(now) &gt;= 0) {</span>
<a href="#l8.510"></a><span id="l8.510" class="difflineminus">-            LOG(&quot;[calAlarmService] alarm is in the future.&quot;);</span>
<a href="#l8.511"></a><span id="l8.511" class="difflineminus">-            // We assume that future alarms haven't been acknowledged</span>
<a href="#l8.512"></a><span id="l8.512" class="difflineplus">+            alarmDate = alarmDate.getInTimezone(UTC());</span>
<a href="#l8.513"></a><span id="l8.513"> </span>
<a href="#l8.514"></a><span id="l8.514" class="difflineminus">-            // delay is in msec, so don't forget to multiply</span>
<a href="#l8.515"></a><span id="l8.515" class="difflineminus">-            var timeout = alarmTime.subtractDate(now).inSeconds * 1000;</span>
<a href="#l8.516"></a><span id="l8.516" class="difflineplus">+            // Check for snooze</span>
<a href="#l8.517"></a><span id="l8.517" class="difflineplus">+            let snoozeDate;</span>
<a href="#l8.518"></a><span id="l8.518" class="difflineplus">+            if (aItem.parentItem != aItem) {</span>
<a href="#l8.519"></a><span id="l8.519" class="difflineplus">+                snoozeDate = aItem.parentItem.getProperty(&quot;X-MOZ-SNOOZE-TIME-&quot; + aItem.recurrenceId.nativeTime)</span>
<a href="#l8.520"></a><span id="l8.520"> </span>
<a href="#l8.521"></a><span id="l8.521" class="difflineminus">-            var timeUntilRefresh = this.mRangeEnd.subtractDate(now).inSeconds * 1000;</span>
<a href="#l8.522"></a><span id="l8.522" class="difflineminus">-            if (timeUntilRefresh &lt; timeout) {</span>
<a href="#l8.523"></a><span id="l8.523" class="difflineminus">-                LOG(&quot;[calAlarmService] alarm is too late.&quot;);</span>
<a href="#l8.524"></a><span id="l8.524" class="difflineminus">-                // we'll get this alarm later.  No sense in keeping an extra timeout</span>
<a href="#l8.525"></a><span id="l8.525" class="difflineminus">-                return;</span>
<a href="#l8.526"></a><span id="l8.526" class="difflineplus">+            } else {</span>
<a href="#l8.527"></a><span id="l8.527" class="difflineplus">+                snoozeDate = aItem.getProperty(&quot;X-MOZ-SNOOZE-TIME&quot;);</span>
<a href="#l8.528"></a><span id="l8.528">             }</span>
<a href="#l8.529"></a><span id="l8.529"> </span>
<a href="#l8.530"></a><span id="l8.530" class="difflineminus">-            this.addTimer(aItem, newTimerWithCallback(callbackObj, timeout, false));</span>
<a href="#l8.531"></a><span id="l8.531" class="difflineminus">-            LOG(&quot;[calAlarmService] adding alarm timeout (&quot; + timeout + &quot;) for &quot; + aItem);</span>
<a href="#l8.532"></a><span id="l8.532" class="difflineminus">-        } else {</span>
<a href="#l8.533"></a><span id="l8.533" class="difflineminus">-            var lastAck = aItem.alarmLastAck || aItem.parentItem.alarmLastAck;</span>
<a href="#l8.534"></a><span id="l8.534" class="difflineminus">-            LOG(&quot;[calAlarmService] last ack was: &quot; + lastAck);</span>
<a href="#l8.535"></a><span id="l8.535" class="difflineminus">-            // This alarm is in the past.  See if it has been previously ack'd</span>
<a href="#l8.536"></a><span id="l8.536" class="difflineminus">-            if (lastAck &amp;&amp; lastAck.compare(alarmTime) &gt;= 0) {</span>
<a href="#l8.537"></a><span id="l8.537" class="difflineminus">-                LOG(&quot;[calAlarmService] &quot; + aItem.title + &quot; - alarm previously ackd.&quot;);</span>
<a href="#l8.538"></a><span id="l8.538" class="difflineminus">-                return;</span>
<a href="#l8.539"></a><span id="l8.539" class="difflineminus">-            } else { // Fire!</span>
<a href="#l8.540"></a><span id="l8.540" class="difflineminus">-                LOG(&quot;[calAlarmService] alarm is in the past and unack'd, firing now!&quot;);</span>
<a href="#l8.541"></a><span id="l8.541" class="difflineminus">-                this.alarmFired(aItem);</span>
<a href="#l8.542"></a><span id="l8.542" class="difflineplus">+            if (snoozeDate &amp;&amp; !(snoozeDate instanceof Components.interfaces.calIDateTime)) {</span>
<a href="#l8.543"></a><span id="l8.543" class="difflineplus">+                snoozeDate = cal.createDateTime(snoozeDate);</span>
<a href="#l8.544"></a><span id="l8.544" class="difflineplus">+            }</span>
<a href="#l8.545"></a><span id="l8.545" class="difflineplus">+            cal.LOG(&quot;[calAlarmService] considering alarm for item: &quot; + aItem.title +</span>
<a href="#l8.546"></a><span id="l8.546" class="difflineplus">+                &quot; alarm time: &quot; + alarmDate + &quot; snooze time: &quot; + snoozeDate);</span>
<a href="#l8.547"></a><span id="l8.547" class="difflineplus">+</span>
<a href="#l8.548"></a><span id="l8.548" class="difflineplus">+            // If the alarm was snoozed, the snooze time is more important.</span>
<a href="#l8.549"></a><span id="l8.549" class="difflineplus">+            alarmDate = snoozeDate || alarmDate;</span>
<a href="#l8.550"></a><span id="l8.550" class="difflineplus">+</span>
<a href="#l8.551"></a><span id="l8.551" class="difflineplus">+            let now = nowUTC();</span>
<a href="#l8.552"></a><span id="l8.552" class="difflineplus">+            if (alarmDate.timezone.isFloating) {</span>
<a href="#l8.553"></a><span id="l8.553" class="difflineplus">+                now = cal.now();</span>
<a href="#l8.554"></a><span id="l8.554" class="difflineplus">+                now.timezone = floating();</span>
<a href="#l8.555"></a><span id="l8.555" class="difflineplus">+            }</span>
<a href="#l8.556"></a><span id="l8.556" class="difflineplus">+</span>
<a href="#l8.557"></a><span id="l8.557" class="difflineplus">+            cal.LOG(&quot;[calAlarmService] now is &quot; + now);</span>
<a href="#l8.558"></a><span id="l8.558" class="difflineplus">+            if (alarmDate.compare(now) &gt;= 0) {</span>
<a href="#l8.559"></a><span id="l8.559" class="difflineplus">+                // We assume that future alarms haven't been acknowledged</span>
<a href="#l8.560"></a><span id="l8.560" class="difflineplus">+                cal.LOG(&quot;[calAlarmService] alarm is in the future.&quot;);</span>
<a href="#l8.561"></a><span id="l8.561" class="difflineplus">+</span>
<a href="#l8.562"></a><span id="l8.562" class="difflineplus">+                // Delay is in msec, so don't forget to multiply</span>
<a href="#l8.563"></a><span id="l8.563" class="difflineplus">+                let timeout = alarmDate.subtractDate(now).inSeconds * 1000;</span>
<a href="#l8.564"></a><span id="l8.564" class="difflineplus">+</span>
<a href="#l8.565"></a><span id="l8.565" class="difflineplus">+                // No sense in keeping an extra timeout for an alarm thats past</span>
<a href="#l8.566"></a><span id="l8.566" class="difflineplus">+                // our range.</span>
<a href="#l8.567"></a><span id="l8.567" class="difflineplus">+                let timeUntilRefresh = this.mRangeEnd.subtractDate(now).inSeconds * 1000;</span>
<a href="#l8.568"></a><span id="l8.568" class="difflineplus">+                if (timeUntilRefresh &lt; timeout) {</span>
<a href="#l8.569"></a><span id="l8.569" class="difflineplus">+                    cal.LOG(&quot;[calAlarmService] alarm is too late.&quot;);</span>
<a href="#l8.570"></a><span id="l8.570" class="difflineplus">+                    continue;</span>
<a href="#l8.571"></a><span id="l8.571" class="difflineplus">+                }</span>
<a href="#l8.572"></a><span id="l8.572" class="difflineplus">+</span>
<a href="#l8.573"></a><span id="l8.573" class="difflineplus">+                this.addTimer(aItem, alarm, timeout);</span>
<a href="#l8.574"></a><span id="l8.574" class="difflineplus">+            } else {</span>
<a href="#l8.575"></a><span id="l8.575" class="difflineplus">+                // This alarm is in the past.  See if it has been previously ack'd</span>
<a href="#l8.576"></a><span id="l8.576" class="difflineplus">+                let lastAck = aItem.alarmLastAck || aItem.parentItem.alarmLastAck;</span>
<a href="#l8.577"></a><span id="l8.577" class="difflineplus">+                cal.LOG(&quot;[calAlarmService] last ack was: &quot; + lastAck);</span>
<a href="#l8.578"></a><span id="l8.578" class="difflineplus">+</span>
<a href="#l8.579"></a><span id="l8.579" class="difflineplus">+                if (lastAck &amp;&amp; lastAck.compare(alarmDate) &gt;= 0) {</span>
<a href="#l8.580"></a><span id="l8.580" class="difflineplus">+                    // The alarm was previously dismissed or snoozed, no further</span>
<a href="#l8.581"></a><span id="l8.581" class="difflineplus">+                    // action required.</span>
<a href="#l8.582"></a><span id="l8.582" class="difflineplus">+                    cal.LOG(&quot;[calAlarmService] &quot; + aItem.title + &quot; - alarm previously ackd.&quot;);</span>
<a href="#l8.583"></a><span id="l8.583" class="difflineplus">+                    continue;</span>
<a href="#l8.584"></a><span id="l8.584" class="difflineplus">+                } else {</span>
<a href="#l8.585"></a><span id="l8.585" class="difflineplus">+                    // The alarm was not snoozed or dismissed, fire it now.</span>
<a href="#l8.586"></a><span id="l8.586" class="difflineplus">+                    cal.LOG(&quot;[calAlarmService] alarm is in the past and unack'd, firing now!&quot;);</span>
<a href="#l8.587"></a><span id="l8.587" class="difflineplus">+                    this.alarmFired(aItem, alarm);</span>
<a href="#l8.588"></a><span id="l8.588" class="difflineplus">+                }</span>
<a href="#l8.589"></a><span id="l8.589">             }</span>
<a href="#l8.590"></a><span id="l8.590">         }</span>
<a href="#l8.591"></a><span id="l8.591">     },</span>
<a href="#l8.592"></a><span id="l8.592"> </span>
<a href="#l8.593"></a><span id="l8.593" class="difflineminus">-    removeAlarm: function cas_removeAlarm(aItem) {</span>
<a href="#l8.594"></a><span id="l8.594" class="difflineplus">+    removeAlarmsForItem: function cAS_removeAlarmsForItem(aItem) {</span>
<a href="#l8.595"></a><span id="l8.595">         // make sure already fired alarms are purged out of the alarm window:</span>
<a href="#l8.596"></a><span id="l8.596" class="difflineminus">-        this.notifyObservers(&quot;onRemoveAlarmsByItem&quot;, [aItem]);</span>
<a href="#l8.597"></a><span id="l8.597" class="difflineminus">-        for each (var timer in this.removeTimers(aItem)) {</span>
<a href="#l8.598"></a><span id="l8.598" class="difflineminus">-            if (timer instanceof Components.interfaces.nsITimer) {</span>
<a href="#l8.599"></a><span id="l8.599" class="difflineminus">-                timer.cancel();</span>
<a href="#l8.600"></a><span id="l8.600" class="difflineminus">-            }</span>
<a href="#l8.601"></a><span id="l8.601" class="difflineplus">+        this.mObservers.notify(&quot;onRemoveAlarmsByItem&quot;, [aItem]);</span>
<a href="#l8.602"></a><span id="l8.602" class="difflineplus">+        // Purge alarms specifically for this item (i.e exception)</span>
<a href="#l8.603"></a><span id="l8.603" class="difflineplus">+        for each (let alarm in aItem.getAlarms({})) {</span>
<a href="#l8.604"></a><span id="l8.604" class="difflineplus">+            this.removeTimer(aItem, alarm);</span>
<a href="#l8.605"></a><span id="l8.605">         }</span>
<a href="#l8.606"></a><span id="l8.606">     },</span>
<a href="#l8.607"></a><span id="l8.607"> </span>
<a href="#l8.608"></a><span id="l8.608" class="difflineminus">-    addTimer: function cas_addTimer(aItem, aTimer) {</span>
<a href="#l8.609"></a><span id="l8.609" class="difflineminus">-        var cal = this.mTimerLookup[aItem.calendar.id];</span>
<a href="#l8.610"></a><span id="l8.610" class="difflineminus">-        if (!cal) {</span>
<a href="#l8.611"></a><span id="l8.611" class="difflineminus">-            cal = {};</span>
<a href="#l8.612"></a><span id="l8.612" class="difflineminus">-            this.mTimerLookup[aItem.calendar.id] = cal;</span>
<a href="#l8.613"></a><span id="l8.613" class="difflineminus">-        }</span>
<a href="#l8.614"></a><span id="l8.614" class="difflineminus">-        var itemTimers = cal[aItem.id];</span>
<a href="#l8.615"></a><span id="l8.615" class="difflineminus">-        if (!itemTimers) {</span>
<a href="#l8.616"></a><span id="l8.616" class="difflineminus">-            itemTimers = { mCount: 0 };</span>
<a href="#l8.617"></a><span id="l8.617" class="difflineminus">-            cal[aItem.id] = itemTimers;</span>
<a href="#l8.618"></a><span id="l8.618" class="difflineminus">-        }</span>
<a href="#l8.619"></a><span id="l8.619" class="difflineminus">-        var rid = aItem.recurrenceId;</span>
<a href="#l8.620"></a><span id="l8.620" class="difflineminus">-        itemTimers[rid ? rid.getInTimezone(UTC()).icalString : &quot;mTimer&quot;] = aTimer;</span>
<a href="#l8.621"></a><span id="l8.621" class="difflineminus">-        ++itemTimers.mCount;</span>
<a href="#l8.622"></a><span id="l8.622" class="difflineplus">+    addTimer: function cAS_addTimer(aItem, aAlarm, aTimeout) {</span>
<a href="#l8.623"></a><span id="l8.623" class="difflineplus">+        this.mTimerMap[aItem.calendar.id] =</span>
<a href="#l8.624"></a><span id="l8.624" class="difflineplus">+            this.mTimerMap[aItem.calendar.id] || {};</span>
<a href="#l8.625"></a><span id="l8.625" class="difflineplus">+        this.mTimerMap[aItem.calendar.id][aItem.hashId] =</span>
<a href="#l8.626"></a><span id="l8.626" class="difflineplus">+            this.mTimerMap[aItem.calendar.id][aItem.hashId] || {};</span>
<a href="#l8.627"></a><span id="l8.627" class="difflineplus">+</span>
<a href="#l8.628"></a><span id="l8.628" class="difflineplus">+        let self = this;</span>
<a href="#l8.629"></a><span id="l8.629" class="difflineplus">+        let alarmTimerCallback = {</span>
<a href="#l8.630"></a><span id="l8.630" class="difflineplus">+            notify: function aTC_notify() {</span>
<a href="#l8.631"></a><span id="l8.631" class="difflineplus">+                self.alarmFired(aItem, aAlarm);</span>
<a href="#l8.632"></a><span id="l8.632" class="difflineplus">+            }</span>
<a href="#l8.633"></a><span id="l8.633" class="difflineplus">+        };</span>
<a href="#l8.634"></a><span id="l8.634" class="difflineplus">+</span>
<a href="#l8.635"></a><span id="l8.635" class="difflineplus">+        let timer = newTimerWithCallback(alarmTimerCallback, aTimeout, false);</span>
<a href="#l8.636"></a><span id="l8.636" class="difflineplus">+        this.mTimerMap[aItem.calendar.id][aItem.hashId][aAlarm.icalString] = timer;</span>
<a href="#l8.637"></a><span id="l8.637">     },</span>
<a href="#l8.638"></a><span id="l8.638"> </span>
<a href="#l8.639"></a><span id="l8.639" class="difflineminus">-    removeTimers: function cas_removeTimers(aItem) {</span>
<a href="#l8.640"></a><span id="l8.640" class="difflineminus">-        var cal = this.mTimerLookup[aItem.calendar.id];</span>
<a href="#l8.641"></a><span id="l8.641" class="difflineminus">-        if (cal) {</span>
<a href="#l8.642"></a><span id="l8.642" class="difflineminus">-            var itemTimers = cal[aItem.id];</span>
<a href="#l8.643"></a><span id="l8.643" class="difflineminus">-            if (itemTimers) {</span>
<a href="#l8.644"></a><span id="l8.644" class="difflineminus">-                var rid = aItem.recurrenceId;</span>
<a href="#l8.645"></a><span id="l8.645" class="difflineminus">-                if (rid) {</span>
<a href="#l8.646"></a><span id="l8.646" class="difflineminus">-                    rid = rid.getInTimezone(UTC()).icalString;</span>
<a href="#l8.647"></a><span id="l8.647" class="difflineminus">-                    var timer = itemTimers[rid];</span>
<a href="#l8.648"></a><span id="l8.648" class="difflineminus">-                    if (timer) {</span>
<a href="#l8.649"></a><span id="l8.649" class="difflineminus">-                        delete itemTimers[rid];</span>
<a href="#l8.650"></a><span id="l8.650" class="difflineminus">-                        --itemTimers.mCount;</span>
<a href="#l8.651"></a><span id="l8.651" class="difflineminus">-                        if (itemTimers.mCount == 0) {</span>
<a href="#l8.652"></a><span id="l8.652" class="difflineminus">-                            delete cal[aItem.id];</span>
<a href="#l8.653"></a><span id="l8.653" class="difflineminus">-                        }</span>
<a href="#l8.654"></a><span id="l8.654" class="difflineminus">-                        return { mTimer: timer };</span>
<a href="#l8.655"></a><span id="l8.655" class="difflineminus">-                    }</span>
<a href="#l8.656"></a><span id="l8.656" class="difflineminus">-                } else {</span>
<a href="#l8.657"></a><span id="l8.657" class="difflineminus">-                    delete cal[aItem.id];</span>
<a href="#l8.658"></a><span id="l8.658" class="difflineminus">-                    return itemTimers;</span>
<a href="#l8.659"></a><span id="l8.659" class="difflineminus">-                }</span>
<a href="#l8.660"></a><span id="l8.660" class="difflineplus">+    removeTimer: function cAS_removeTimers(aItem, aAlarm) {</span>
<a href="#l8.661"></a><span id="l8.661" class="difflineplus">+            /* Is the calendar in the timer map */</span>
<a href="#l8.662"></a><span id="l8.662" class="difflineplus">+        if (aItem.calendar.id in this.mTimerMap &amp;&amp;</span>
<a href="#l8.663"></a><span id="l8.663" class="difflineplus">+            /* ...and is the item in the calendar map */</span>
<a href="#l8.664"></a><span id="l8.664" class="difflineplus">+            aItem.hashId in this.mTimerMap[aItem.calendar.id] &amp;&amp;</span>
<a href="#l8.665"></a><span id="l8.665" class="difflineplus">+            /* ...and is the alarm in the item map ? */</span>
<a href="#l8.666"></a><span id="l8.666" class="difflineplus">+            aAlarm.icalString in this.mTimerMap[aItem.calendar.id][aItem.hashId]) {</span>
<a href="#l8.667"></a><span id="l8.667" class="difflineplus">+</span>
<a href="#l8.668"></a><span id="l8.668" class="difflineplus">+            let timer = this.mTimerMap[aItem.calendar.id][aItem.hashId][aAlarm.icalString];</span>
<a href="#l8.669"></a><span id="l8.669" class="difflineplus">+            timer.cancel();</span>
<a href="#l8.670"></a><span id="l8.670" class="difflineplus">+</span>
<a href="#l8.671"></a><span id="l8.671" class="difflineplus">+            // Remove the alarm from the item map</span>
<a href="#l8.672"></a><span id="l8.672" class="difflineplus">+            delete this.mTimerMap[aItem.calendar.id][aItem.hashId][aAlarm.icalString];</span>
<a href="#l8.673"></a><span id="l8.673" class="difflineplus">+</span>
<a href="#l8.674"></a><span id="l8.674" class="difflineplus">+            // If the item map is empty, remove it from the calendar map</span>
<a href="#l8.675"></a><span id="l8.675" class="difflineplus">+            if (this.mTimerMap[aItem.calendar.id][aItem.hashId].toSource() == &quot;({})&quot;) {</span>
<a href="#l8.676"></a><span id="l8.676" class="difflineplus">+                delete this.mTimerMap[aItem.calendar.id][aItem.hashId];</span>
<a href="#l8.677"></a><span id="l8.677">             }</span>
<a href="#l8.678"></a><span id="l8.678" class="difflineminus">-        }</span>
<a href="#l8.679"></a><span id="l8.679" class="difflineminus">-        return {};</span>
<a href="#l8.680"></a><span id="l8.680" class="difflineminus">-    },</span>
<a href="#l8.681"></a><span id="l8.681"> </span>
<a href="#l8.682"></a><span id="l8.682" class="difflineminus">-    disposeCalendarTimers: function cas_removeCalendarTimers(aCalendars) {</span>
<a href="#l8.683"></a><span id="l8.683" class="difflineminus">-        for each (var cal in aCalendars) {</span>
<a href="#l8.684"></a><span id="l8.684" class="difflineminus">-            var calTimers = this.mTimerLookup[cal.id];</span>
<a href="#l8.685"></a><span id="l8.685" class="difflineminus">-            if (calTimers) {</span>
<a href="#l8.686"></a><span id="l8.686" class="difflineminus">-                for each (var itemTimers in calTimers) {</span>
<a href="#l8.687"></a><span id="l8.687" class="difflineminus">-                    for each (var timer in itemTimers) {</span>
<a href="#l8.688"></a><span id="l8.688" class="difflineminus">-                        if (timer instanceof Components.interfaces.nsITimer) {</span>
<a href="#l8.689"></a><span id="l8.689" class="difflineminus">-                            timer.cancel();</span>
<a href="#l8.690"></a><span id="l8.690" class="difflineminus">-                        }</span>
<a href="#l8.691"></a><span id="l8.691" class="difflineminus">-                    }</span>
<a href="#l8.692"></a><span id="l8.692" class="difflineminus">-                }</span>
<a href="#l8.693"></a><span id="l8.693" class="difflineminus">-                delete this.mTimerLookup[cal.id];</span>
<a href="#l8.694"></a><span id="l8.694" class="difflineplus">+            // If the calendar map is empty, remove it from the timer map</span>
<a href="#l8.695"></a><span id="l8.695" class="difflineplus">+            if (this.mTimerMap[aItem.calendar.id].toSource() == &quot;({})&quot;) {</span>
<a href="#l8.696"></a><span id="l8.696" class="difflineplus">+                delete this.mTimerMap[aItem.calendar.id];</span>
<a href="#l8.697"></a><span id="l8.697">             }</span>
<a href="#l8.698"></a><span id="l8.698">         }</span>
<a href="#l8.699"></a><span id="l8.699">     },</span>
<a href="#l8.700"></a><span id="l8.700" class="difflineplus">+                </span>
<a href="#l8.701"></a><span id="l8.701" class="difflineplus">+    disposeCalendarTimers: function cAS_removeCalendarTimers(aCalendars) {</span>
<a href="#l8.702"></a><span id="l8.702" class="difflineplus">+        for each (let calendar in aCalendars) {</span>
<a href="#l8.703"></a><span id="l8.703" class="difflineplus">+            for each (let itemTimerMap in this.mTimerMap[calendar.id]) {</span>
<a href="#l8.704"></a><span id="l8.704" class="difflineplus">+                for each (let timer in itemTimerMap) {</span>
<a href="#l8.705"></a><span id="l8.705" class="difflineplus">+                    timer.cancel();</span>
<a href="#l8.706"></a><span id="l8.706" class="difflineplus">+                }</span>
<a href="#l8.707"></a><span id="l8.707" class="difflineplus">+            }</span>
<a href="#l8.708"></a><span id="l8.708" class="difflineplus">+            delete this.mTimerMap[calendar.id]</span>
<a href="#l8.709"></a><span id="l8.709" class="difflineplus">+        }</span>
<a href="#l8.710"></a><span id="l8.710" class="difflineplus">+    },</span>
<a href="#l8.711"></a><span id="l8.711"> </span>
<a href="#l8.712"></a><span id="l8.712" class="difflineminus">-    findAlarms: function cas_findAlarms(calendars, start, until) {</span>
<a href="#l8.713"></a><span id="l8.713" class="difflineminus">-        var getListener = {</span>
<a href="#l8.714"></a><span id="l8.714" class="difflineplus">+    findAlarms: function cAS_findAlarms(aCalendars, aStart, aUntil) {</span>
<a href="#l8.715"></a><span id="l8.715" class="difflineplus">+        let getListener = {</span>
<a href="#l8.716"></a><span id="l8.716">             alarmService: this,</span>
<a href="#l8.717"></a><span id="l8.717" class="difflineminus">-            onOperationComplete: function(aCalendar, aStatus, aOperationType, aId, aDetail) {</span>
<a href="#l8.718"></a><span id="l8.718" class="difflineplus">+            onOperationComplete: function cAS_fA_onOperationComplete(aCalendar,</span>
<a href="#l8.719"></a><span id="l8.719" class="difflineplus">+                                                                     aStatus,</span>
<a href="#l8.720"></a><span id="l8.720" class="difflineplus">+                                                                     aOperationType,</span>
<a href="#l8.721"></a><span id="l8.721" class="difflineplus">+                                                                     aId,</span>
<a href="#l8.722"></a><span id="l8.722" class="difflineplus">+                                                                     aDetail) {</span>
<a href="#l8.723"></a><span id="l8.723">                 // calendar has been loaded, so until now, onLoad events can be ignored:</span>
<a href="#l8.724"></a><span id="l8.724">                 this.alarmService.mLoadedCalendars[aCalendar.id] = true;</span>
<a href="#l8.725"></a><span id="l8.725">             },</span>
<a href="#l8.726"></a><span id="l8.726" class="difflineminus">-            onGetResult: function(aCalendar, aStatus, aItemType, aDetail, aCount, aItems) {</span>
<a href="#l8.727"></a><span id="l8.727" class="difflineminus">-                for (var i = 0; i &lt; aCount; ++i) {</span>
<a href="#l8.728"></a><span id="l8.728" class="difflineminus">-                    var item = aItems[i];</span>
<a href="#l8.729"></a><span id="l8.729" class="difflineplus">+            onGetResult: function cAS_fA_onGetResult(aCalendar,</span>
<a href="#l8.730"></a><span id="l8.730" class="difflineplus">+                                                     aStatus,</span>
<a href="#l8.731"></a><span id="l8.731" class="difflineplus">+                                                     aItemType,</span>
<a href="#l8.732"></a><span id="l8.732" class="difflineplus">+                                                     aDetail,</span>
<a href="#l8.733"></a><span id="l8.733" class="difflineplus">+                                                     aCount,</span>
<a href="#l8.734"></a><span id="l8.734" class="difflineplus">+                                                     aItems) {</span>
<a href="#l8.735"></a><span id="l8.735" class="difflineplus">+                for each (let item in aItems) {</span>
<a href="#l8.736"></a><span id="l8.736">                     // assure we don't fire alarms twice, handle removed alarms as far as we can:</span>
<a href="#l8.737"></a><span id="l8.737">                     // e.g. we cannot purge removed items from ics files. XXX todo.</span>
<a href="#l8.738"></a><span id="l8.738" class="difflineminus">-                    this.alarmService.removeAlarm(item);</span>
<a href="#l8.739"></a><span id="l8.739" class="difflineminus">-                    this.alarmService.addAlarm(item);</span>
<a href="#l8.740"></a><span id="l8.740" class="difflineplus">+                    this.alarmService.removeAlarmsForItem(item);</span>
<a href="#l8.741"></a><span id="l8.741" class="difflineplus">+                    this.alarmService.addAlarmsForItem(item);</span>
<a href="#l8.742"></a><span id="l8.742">                 }</span>
<a href="#l8.743"></a><span id="l8.743">             }</span>
<a href="#l8.744"></a><span id="l8.744">         };</span>
<a href="#l8.745"></a><span id="l8.745"> </span>
<a href="#l8.746"></a><span id="l8.746">         const calICalendar = Components.interfaces.calICalendar;</span>
<a href="#l8.747"></a><span id="l8.747" class="difflineminus">-        var filter = calICalendar.ITEM_FILTER_COMPLETED_ALL |</span>
<a href="#l8.748"></a><span id="l8.748" class="difflineplus">+        let filter = calICalendar.ITEM_FILTER_COMPLETED_ALL |</span>
<a href="#l8.749"></a><span id="l8.749">                      calICalendar.ITEM_FILTER_CLASS_OCCURRENCES |</span>
<a href="#l8.750"></a><span id="l8.750">                      calICalendar.ITEM_FILTER_TYPE_ALL;</span>
<a href="#l8.751"></a><span id="l8.751"> </span>
<a href="#l8.752"></a><span id="l8.752" class="difflineminus">-        for each(var calendar in calendars) {</span>
<a href="#l8.753"></a><span id="l8.753" class="difflineplus">+        for each (let calendar in aCalendars) {</span>
<a href="#l8.754"></a><span id="l8.754">             // assuming that suppressAlarms does not change anymore until refresh:</span>
<a href="#l8.755"></a><span id="l8.755">             if (!calendar.getProperty(&quot;suppressAlarms&quot;) &amp;&amp;</span>
<a href="#l8.756"></a><span id="l8.756" class="difflineminus">-                (calendar.getProperty(&quot;capabilities.alarms.popup.supported&quot;) !== false) &amp;&amp;</span>
<a href="#l8.757"></a><span id="l8.757">                 !calendar.getProperty(&quot;disabled&quot;)) {</span>
<a href="#l8.758"></a><span id="l8.758" class="difflineminus">-                calendar.getItems(filter, 0, start, until, getListener);</span>
<a href="#l8.759"></a><span id="l8.759" class="difflineplus">+                calendar.getItems(filter, 0, aStart, aUntil, getListener);</span>
<a href="#l8.760"></a><span id="l8.760">             }</span>
<a href="#l8.761"></a><span id="l8.761">         }</span>
<a href="#l8.762"></a><span id="l8.762">     },</span>
<a href="#l8.763"></a><span id="l8.763"> </span>
<a href="#l8.764"></a><span id="l8.764" class="difflineminus">-    initAlarms: function cas_initAlarms(calendars) {</span>
<a href="#l8.765"></a><span id="l8.765" class="difflineplus">+    initAlarms: function cAS_initAlarms(aCalendars) {</span>
<a href="#l8.766"></a><span id="l8.766">         // Purge out all alarm timers belonging to the refreshed/loaded calendar:</span>
<a href="#l8.767"></a><span id="l8.767" class="difflineminus">-        this.disposeCalendarTimers(calendars);</span>
<a href="#l8.768"></a><span id="l8.768" class="difflineplus">+        this.disposeCalendarTimers(aCalendars);</span>
<a href="#l8.769"></a><span id="l8.769"> </span>
<a href="#l8.770"></a><span id="l8.770">         // Purge out all alarms from dialog belonging to the refreshed/loaded calendar:</span>
<a href="#l8.771"></a><span id="l8.771" class="difflineminus">-        this.notifyObservers(&quot;onRemoveAlarmsByCalendar&quot;, calendars);</span>
<a href="#l8.772"></a><span id="l8.772" class="difflineplus">+        this.mObservers.notify(&quot;onRemoveAlarmsByCalendar&quot;, aCalendars);</span>
<a href="#l8.773"></a><span id="l8.773"> </span>
<a href="#l8.774"></a><span id="l8.774">         // Total refresh similar to startup.  We're going to look for</span>
<a href="#l8.775"></a><span id="l8.775">         // alarms +/- 1 month from now.  If someone sets an alarm more than</span>
<a href="#l8.776"></a><span id="l8.776">         // a month ahead of an event, or doesn't start Sunbird/Lightning</span>
<a href="#l8.777"></a><span id="l8.777">         // for a month, they'll miss some, but that's a slim chance</span>
<a href="#l8.778"></a><span id="l8.778" class="difflineminus">-        var start = nowUTC();</span>
<a href="#l8.779"></a><span id="l8.779" class="difflineminus">-        var until = start.clone();</span>
<a href="#l8.780"></a><span id="l8.780" class="difflineplus">+        let start = nowUTC();</span>
<a href="#l8.781"></a><span id="l8.781" class="difflineplus">+        let until = start.clone();</span>
<a href="#l8.782"></a><span id="l8.782">         start.month -= 1;</span>
<a href="#l8.783"></a><span id="l8.783">         until.month += 1;</span>
<a href="#l8.784"></a><span id="l8.784" class="difflineminus">-        this.findAlarms(calendars, start, until);</span>
<a href="#l8.785"></a><span id="l8.785" class="difflineplus">+        this.findAlarms(aCalendars, start, until);</span>
<a href="#l8.786"></a><span id="l8.786">     },</span>
<a href="#l8.787"></a><span id="l8.787"> </span>
<a href="#l8.788"></a><span id="l8.788" class="difflineminus">-    alarmFired: function cas_alarmFired(event) {</span>
<a href="#l8.789"></a><span id="l8.789" class="difflineminus">-        if (event.calendar.getProperty(&quot;suppressAlarms&quot;) ||</span>
<a href="#l8.790"></a><span id="l8.790" class="difflineminus">-            event.calendar.getProperty(&quot;capabilities.alarms.popup.supported&quot;) === false) {</span>
<a href="#l8.791"></a><span id="l8.791" class="difflineminus">-            return;</span>
<a href="#l8.792"></a><span id="l8.792" class="difflineplus">+    alarmFired: function cAS_alarmFired(aItem, aAlarm) {</span>
<a href="#l8.793"></a><span id="l8.793" class="difflineplus">+        if (!aItem.calendar.getProperty(&quot;suppressAlarms&quot;) &amp;&amp;</span>
<a href="#l8.794"></a><span id="l8.794" class="difflineplus">+            !aItem.calendar.getProperty(&quot;disabled&quot;)) {</span>
<a href="#l8.795"></a><span id="l8.795" class="difflineplus">+            this.mObservers.notify(&quot;onAlarm&quot;, [aItem, aAlarm]);</span>
<a href="#l8.796"></a><span id="l8.796">         }</span>
<a href="#l8.797"></a><span id="l8.797" class="difflineminus">-        this.notifyObservers(&quot;onAlarm&quot;, [event]);</span>
<a href="#l8.798"></a><span id="l8.798">     }</span>
<a href="#l8.799"></a><span id="l8.799"> };</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

