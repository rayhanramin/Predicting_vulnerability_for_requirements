<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 8006:8f6268c4dc0a33c1428dce9ba8a0abd448996499</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 8f6268c4dc0a33c1428dce9ba8a0abd448996499" />
<meta property="og:url" content="/comm-central/rev/8f6268c4dc0a33c1428dce9ba8a0abd448996499" />
<meta property="og:description" content="make backend base and db [noscript] methods scriptable, bug 661682, r=rkent, sr=standard8" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 8f6268c4dc0a33c1428dce9ba8a0abd448996499 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/8f6268c4dc0a33c1428dce9ba8a0abd448996499">shortlog</a> |
<a href="/comm-central/log/8f6268c4dc0a33c1428dce9ba8a0abd448996499">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/8f6268c4dc0a33c1428dce9ba8a0abd448996499">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/8f6268c4dc0a33c1428dce9ba8a0abd448996499">files</a> |
changeset |
<a href="/comm-central/raw-rev/8f6268c4dc0a33c1428dce9ba8a0abd448996499">raw</a>  | <a href="/comm-central/archive/8f6268c4dc0a33c1428dce9ba8a0abd448996499.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
make backend base and db [noscript] methods scriptable, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=661682">bug 661682</a>, r=rkent, sr=standard8
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#68;&#97;&#118;&#105;&#100;&#32;&#66;&#105;&#101;&#110;&#118;&#101;&#110;&#117;&#32;&#60;&#98;&#105;&#101;&#110;&#118;&#101;&#110;&#117;&#64;&#110;&#118;&#101;&#110;&#116;&#117;&#114;&#101;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 24 Jun 2011 16:58:10 -0700</td></tr>

<tr>
 <td>changeset 8006</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/8f6268c4dc0a33c1428dce9ba8a0abd448996499">8f6268c4dc0a33c1428dce9ba8a0abd448996499</a></td>
</tr>



<tr>
<td>parent 8005</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/c6ae532c6e61dc60545982e05005c13a3877b860">c6ae532c6e61dc60545982e05005c13a3877b860</a>
</td>
</tr>

<tr>
<td>child 8007</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/8a841fad97059c903a75e300fd3b6c88ff3326ef">8a841fad97059c903a75e300fd3b6c88ff3326ef</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=8f6268c4dc0a33c1428dce9ba8a0abd448996499">6161</a></td></tr>
<tr><td>push user</td><td>bienvenu@nventure.com</td></tr>
<tr><td>push date</td><td class="date age">Fri, 24 Jun 2011 23:57:41 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@8f6268c4dc0a [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=8f6268c4dc0a33c1428dce9ba8a0abd448996499">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=8f6268c4dc0a33c1428dce9ba8a0abd448996499&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=8f6268c4dc0a33c1428dce9ba8a0abd448996499&newProject=comm-central&newRevision=8f6268c4dc0a33c1428dce9ba8a0abd448996499&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=8f6268c4dc0a33c1428dce9ba8a0abd448996499&newProject=comm-central&newRevision=8f6268c4dc0a33c1428dce9ba8a0abd448996499&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=8f6268c4dc0a33c1428dce9ba8a0abd448996499&newProject=comm-central&newRevision=8f6268c4dc0a33c1428dce9ba8a0abd448996499&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28rkent%29&revcount=50">rkent</a>, <a href="/comm-central/log?rev=reviewer%28standard8%29&revcount=50">standard8</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=661682">661682</a></td></tr>




</table></div>

<div class="page_body description">make backend base and db [noscript] methods scriptable, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=661682">bug 661682</a>, r=rkent, sr=standard8</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/public/Makefile.in">mailnews/base/public/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/public/Makefile.in">file</a> |
<a href="/comm-central/annotate/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/public/Makefile.in">annotate</a> |
<a href="/comm-central/diff/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/public/Makefile.in">diff</a> |
<a href="/comm-central/comparison/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/public/Makefile.in">comparison</a> |
<a href="/comm-central/log/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/public/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/public/nsIMsgHdr.idl">mailnews/base/public/nsIMsgHdr.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/public/nsIMsgHdr.idl">file</a> |
<a href="/comm-central/annotate/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/public/nsIMsgHdr.idl">annotate</a> |
<a href="/comm-central/diff/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/public/nsIMsgHdr.idl">diff</a> |
<a href="/comm-central/comparison/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/public/nsIMsgHdr.idl">comparison</a> |
<a href="/comm-central/log/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/public/nsIMsgHdr.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/public/nsIMsgKeyArray.idl">mailnews/base/public/nsIMsgKeyArray.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/public/nsIMsgKeyArray.idl">file</a> |
<a href="/comm-central/annotate/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/public/nsIMsgKeyArray.idl">annotate</a> |
<a href="/comm-central/diff/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/public/nsIMsgKeyArray.idl">diff</a> |
<a href="/comm-central/comparison/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/public/nsIMsgKeyArray.idl">comparison</a> |
<a href="/comm-central/log/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/public/nsIMsgKeyArray.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/public/nsIMsgMessageService.idl">mailnews/base/public/nsIMsgMessageService.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/public/nsIMsgMessageService.idl">file</a> |
<a href="/comm-central/annotate/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/public/nsIMsgMessageService.idl">annotate</a> |
<a href="/comm-central/diff/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/public/nsIMsgMessageService.idl">diff</a> |
<a href="/comm-central/comparison/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/public/nsIMsgMessageService.idl">comparison</a> |
<a href="/comm-central/log/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/public/nsIMsgMessageService.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/public/nsMsgBaseCID.h">mailnews/base/public/nsMsgBaseCID.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/public/nsMsgBaseCID.h">file</a> |
<a href="/comm-central/annotate/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/public/nsMsgBaseCID.h">annotate</a> |
<a href="/comm-central/diff/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/public/nsMsgBaseCID.h">diff</a> |
<a href="/comm-central/comparison/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/public/nsMsgBaseCID.h">comparison</a> |
<a href="/comm-central/log/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/public/nsMsgBaseCID.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/src/nsMsgDBView.cpp">mailnews/base/src/nsMsgDBView.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/src/nsMsgDBView.cpp">file</a> |
<a href="/comm-central/annotate/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/src/nsMsgDBView.cpp">annotate</a> |
<a href="/comm-central/diff/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/src/nsMsgDBView.cpp">diff</a> |
<a href="/comm-central/comparison/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/src/nsMsgDBView.cpp">comparison</a> |
<a href="/comm-central/log/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/src/nsMsgDBView.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/src/nsMsgFolderCompactor.cpp">mailnews/base/src/nsMsgFolderCompactor.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/src/nsMsgFolderCompactor.cpp">file</a> |
<a href="/comm-central/annotate/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/src/nsMsgFolderCompactor.cpp">annotate</a> |
<a href="/comm-central/diff/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/src/nsMsgFolderCompactor.cpp">diff</a> |
<a href="/comm-central/comparison/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/src/nsMsgFolderCompactor.cpp">comparison</a> |
<a href="/comm-central/log/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/src/nsMsgFolderCompactor.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/src/nsMsgFolderCompactor.h">mailnews/base/src/nsMsgFolderCompactor.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/src/nsMsgFolderCompactor.h">file</a> |
<a href="/comm-central/annotate/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/src/nsMsgFolderCompactor.h">annotate</a> |
<a href="/comm-central/diff/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/src/nsMsgFolderCompactor.h">diff</a> |
<a href="/comm-central/comparison/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/src/nsMsgFolderCompactor.h">comparison</a> |
<a href="/comm-central/log/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/src/nsMsgFolderCompactor.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/util/Makefile.in">mailnews/base/util/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/util/Makefile.in">file</a> |
<a href="/comm-central/annotate/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/util/Makefile.in">annotate</a> |
<a href="/comm-central/diff/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/util/Makefile.in">diff</a> |
<a href="/comm-central/comparison/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/util/Makefile.in">comparison</a> |
<a href="/comm-central/log/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/util/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/util/nsMsgDBFolder.cpp">mailnews/base/util/nsMsgDBFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/util/nsMsgDBFolder.cpp">file</a> |
<a href="/comm-central/annotate/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/util/nsMsgDBFolder.cpp">annotate</a> |
<a href="/comm-central/diff/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/util/nsMsgDBFolder.cpp">diff</a> |
<a href="/comm-central/comparison/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/util/nsMsgDBFolder.cpp">comparison</a> |
<a href="/comm-central/log/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/util/nsMsgDBFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/util/nsMsgDBFolder.h">mailnews/base/util/nsMsgDBFolder.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/util/nsMsgDBFolder.h">file</a> |
<a href="/comm-central/annotate/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/util/nsMsgDBFolder.h">annotate</a> |
<a href="/comm-central/diff/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/util/nsMsgDBFolder.h">diff</a> |
<a href="/comm-central/comparison/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/util/nsMsgDBFolder.h">comparison</a> |
<a href="/comm-central/log/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/util/nsMsgDBFolder.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/util/nsMsgKeyArray.cpp">mailnews/base/util/nsMsgKeyArray.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/util/nsMsgKeyArray.cpp">file</a> |
<a href="/comm-central/annotate/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/util/nsMsgKeyArray.cpp">annotate</a> |
<a href="/comm-central/diff/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/util/nsMsgKeyArray.cpp">diff</a> |
<a href="/comm-central/comparison/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/util/nsMsgKeyArray.cpp">comparison</a> |
<a href="/comm-central/log/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/util/nsMsgKeyArray.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/util/nsMsgKeyArray.h">mailnews/base/util/nsMsgKeyArray.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/util/nsMsgKeyArray.h">file</a> |
<a href="/comm-central/annotate/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/util/nsMsgKeyArray.h">annotate</a> |
<a href="/comm-central/diff/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/util/nsMsgKeyArray.h">diff</a> |
<a href="/comm-central/comparison/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/util/nsMsgKeyArray.h">comparison</a> |
<a href="/comm-central/log/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/util/nsMsgKeyArray.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/util/nsMsgReadStateTxn.cpp">mailnews/base/util/nsMsgReadStateTxn.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/util/nsMsgReadStateTxn.cpp">file</a> |
<a href="/comm-central/annotate/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/util/nsMsgReadStateTxn.cpp">annotate</a> |
<a href="/comm-central/diff/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/util/nsMsgReadStateTxn.cpp">diff</a> |
<a href="/comm-central/comparison/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/util/nsMsgReadStateTxn.cpp">comparison</a> |
<a href="/comm-central/log/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/util/nsMsgReadStateTxn.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/util/nsMsgReadStateTxn.h">mailnews/base/util/nsMsgReadStateTxn.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/util/nsMsgReadStateTxn.h">file</a> |
<a href="/comm-central/annotate/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/util/nsMsgReadStateTxn.h">annotate</a> |
<a href="/comm-central/diff/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/util/nsMsgReadStateTxn.h">diff</a> |
<a href="/comm-central/comparison/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/util/nsMsgReadStateTxn.h">comparison</a> |
<a href="/comm-central/log/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/base/util/nsMsgReadStateTxn.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/build/nsMailModule.cpp">mailnews/build/nsMailModule.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/build/nsMailModule.cpp">file</a> |
<a href="/comm-central/annotate/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/build/nsMailModule.cpp">annotate</a> |
<a href="/comm-central/diff/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/build/nsMailModule.cpp">diff</a> |
<a href="/comm-central/comparison/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/build/nsMailModule.cpp">comparison</a> |
<a href="/comm-central/log/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/build/nsMailModule.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/db/msgdb/public/nsIMsgDatabase.idl">mailnews/db/msgdb/public/nsIMsgDatabase.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/db/msgdb/public/nsIMsgDatabase.idl">file</a> |
<a href="/comm-central/annotate/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/db/msgdb/public/nsIMsgDatabase.idl">annotate</a> |
<a href="/comm-central/diff/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/db/msgdb/public/nsIMsgDatabase.idl">diff</a> |
<a href="/comm-central/comparison/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/db/msgdb/public/nsIMsgDatabase.idl">comparison</a> |
<a href="/comm-central/log/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/db/msgdb/public/nsIMsgDatabase.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/db/msgdb/public/nsMsgDatabase.h">mailnews/db/msgdb/public/nsMsgDatabase.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/db/msgdb/public/nsMsgDatabase.h">file</a> |
<a href="/comm-central/annotate/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/db/msgdb/public/nsMsgDatabase.h">annotate</a> |
<a href="/comm-central/diff/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/db/msgdb/public/nsMsgDatabase.h">diff</a> |
<a href="/comm-central/comparison/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/db/msgdb/public/nsMsgDatabase.h">comparison</a> |
<a href="/comm-central/log/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/db/msgdb/public/nsMsgDatabase.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/db/msgdb/public/nsNewsDatabase.h">mailnews/db/msgdb/public/nsNewsDatabase.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/db/msgdb/public/nsNewsDatabase.h">file</a> |
<a href="/comm-central/annotate/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/db/msgdb/public/nsNewsDatabase.h">annotate</a> |
<a href="/comm-central/diff/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/db/msgdb/public/nsNewsDatabase.h">diff</a> |
<a href="/comm-central/comparison/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/db/msgdb/public/nsNewsDatabase.h">comparison</a> |
<a href="/comm-central/log/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/db/msgdb/public/nsNewsDatabase.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/db/msgdb/src/nsMsgDatabase.cpp">mailnews/db/msgdb/src/nsMsgDatabase.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/db/msgdb/src/nsMsgDatabase.cpp">file</a> |
<a href="/comm-central/annotate/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/db/msgdb/src/nsMsgDatabase.cpp">annotate</a> |
<a href="/comm-central/diff/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/db/msgdb/src/nsMsgDatabase.cpp">diff</a> |
<a href="/comm-central/comparison/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/db/msgdb/src/nsMsgDatabase.cpp">comparison</a> |
<a href="/comm-central/log/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/db/msgdb/src/nsMsgDatabase.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/db/msgdb/src/nsMsgHdr.cpp">mailnews/db/msgdb/src/nsMsgHdr.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/db/msgdb/src/nsMsgHdr.cpp">file</a> |
<a href="/comm-central/annotate/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/db/msgdb/src/nsMsgHdr.cpp">annotate</a> |
<a href="/comm-central/diff/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/db/msgdb/src/nsMsgHdr.cpp">diff</a> |
<a href="/comm-central/comparison/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/db/msgdb/src/nsMsgHdr.cpp">comparison</a> |
<a href="/comm-central/log/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/db/msgdb/src/nsMsgHdr.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/db/msgdb/src/nsNewsDatabase.cpp">mailnews/db/msgdb/src/nsNewsDatabase.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/db/msgdb/src/nsNewsDatabase.cpp">file</a> |
<a href="/comm-central/annotate/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/db/msgdb/src/nsNewsDatabase.cpp">annotate</a> |
<a href="/comm-central/diff/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/db/msgdb/src/nsNewsDatabase.cpp">diff</a> |
<a href="/comm-central/comparison/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/db/msgdb/src/nsNewsDatabase.cpp">comparison</a> |
<a href="/comm-central/log/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/db/msgdb/src/nsNewsDatabase.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/imap/src/nsAutoSyncState.cpp">mailnews/imap/src/nsAutoSyncState.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/imap/src/nsAutoSyncState.cpp">file</a> |
<a href="/comm-central/annotate/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/imap/src/nsAutoSyncState.cpp">annotate</a> |
<a href="/comm-central/diff/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/imap/src/nsAutoSyncState.cpp">diff</a> |
<a href="/comm-central/comparison/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/imap/src/nsAutoSyncState.cpp">comparison</a> |
<a href="/comm-central/log/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/imap/src/nsAutoSyncState.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/imap/src/nsImapMailFolder.cpp">mailnews/imap/src/nsImapMailFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/imap/src/nsImapMailFolder.cpp">file</a> |
<a href="/comm-central/annotate/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/imap/src/nsImapMailFolder.cpp">annotate</a> |
<a href="/comm-central/diff/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/imap/src/nsImapMailFolder.cpp">diff</a> |
<a href="/comm-central/comparison/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/imap/src/nsImapMailFolder.cpp">comparison</a> |
<a href="/comm-central/log/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/imap/src/nsImapMailFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/imap/src/nsImapService.cpp">mailnews/imap/src/nsImapService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/imap/src/nsImapService.cpp">file</a> |
<a href="/comm-central/annotate/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/imap/src/nsImapService.cpp">annotate</a> |
<a href="/comm-central/diff/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/imap/src/nsImapService.cpp">diff</a> |
<a href="/comm-central/comparison/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/imap/src/nsImapService.cpp">comparison</a> |
<a href="/comm-central/log/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/imap/src/nsImapService.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/local/src/nsLocalMailFolder.cpp">mailnews/local/src/nsLocalMailFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/local/src/nsLocalMailFolder.cpp">file</a> |
<a href="/comm-central/annotate/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/local/src/nsLocalMailFolder.cpp">annotate</a> |
<a href="/comm-central/diff/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/local/src/nsLocalMailFolder.cpp">diff</a> |
<a href="/comm-central/comparison/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/local/src/nsLocalMailFolder.cpp">comparison</a> |
<a href="/comm-central/log/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/local/src/nsLocalMailFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/local/src/nsMailboxService.cpp">mailnews/local/src/nsMailboxService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/local/src/nsMailboxService.cpp">file</a> |
<a href="/comm-central/annotate/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/local/src/nsMailboxService.cpp">annotate</a> |
<a href="/comm-central/diff/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/local/src/nsMailboxService.cpp">diff</a> |
<a href="/comm-central/comparison/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/local/src/nsMailboxService.cpp">comparison</a> |
<a href="/comm-central/log/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/local/src/nsMailboxService.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/local/src/nsPop3IncomingServer.cpp">mailnews/local/src/nsPop3IncomingServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/local/src/nsPop3IncomingServer.cpp">file</a> |
<a href="/comm-central/annotate/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/local/src/nsPop3IncomingServer.cpp">annotate</a> |
<a href="/comm-central/diff/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/local/src/nsPop3IncomingServer.cpp">diff</a> |
<a href="/comm-central/comparison/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/local/src/nsPop3IncomingServer.cpp">comparison</a> |
<a href="/comm-central/log/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/local/src/nsPop3IncomingServer.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/mapi/mapihook/src/msgMapiImp.cpp">mailnews/mapi/mapihook/src/msgMapiImp.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/mapi/mapihook/src/msgMapiImp.cpp">file</a> |
<a href="/comm-central/annotate/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/mapi/mapihook/src/msgMapiImp.cpp">annotate</a> |
<a href="/comm-central/diff/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/mapi/mapihook/src/msgMapiImp.cpp">diff</a> |
<a href="/comm-central/comparison/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/mapi/mapihook/src/msgMapiImp.cpp">comparison</a> |
<a href="/comm-central/log/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/mapi/mapihook/src/msgMapiImp.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/news/src/nsNNTPArticleList.cpp">mailnews/news/src/nsNNTPArticleList.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/news/src/nsNNTPArticleList.cpp">file</a> |
<a href="/comm-central/annotate/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/news/src/nsNNTPArticleList.cpp">annotate</a> |
<a href="/comm-central/diff/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/news/src/nsNNTPArticleList.cpp">diff</a> |
<a href="/comm-central/comparison/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/news/src/nsNNTPArticleList.cpp">comparison</a> |
<a href="/comm-central/log/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/news/src/nsNNTPArticleList.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/news/src/nsNewsFolder.cpp">mailnews/news/src/nsNewsFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/news/src/nsNewsFolder.cpp">file</a> |
<a href="/comm-central/annotate/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/news/src/nsNewsFolder.cpp">annotate</a> |
<a href="/comm-central/diff/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/news/src/nsNewsFolder.cpp">diff</a> |
<a href="/comm-central/comparison/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/news/src/nsNewsFolder.cpp">comparison</a> |
<a href="/comm-central/log/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/news/src/nsNewsFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/news/src/nsNntpService.cpp">mailnews/news/src/nsNntpService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/news/src/nsNntpService.cpp">file</a> |
<a href="/comm-central/annotate/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/news/src/nsNntpService.cpp">annotate</a> |
<a href="/comm-central/diff/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/news/src/nsNntpService.cpp">diff</a> |
<a href="/comm-central/comparison/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/news/src/nsNntpService.cpp">comparison</a> |
<a href="/comm-central/log/8f6268c4dc0a33c1428dce9ba8a0abd448996499/mailnews/news/src/nsNntpService.cpp">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/base/public/Makefile.in</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/base/public/Makefile.in</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -62,16 +62,17 @@ XPIDLSRCS	= \</span>
<a href="#l1.4"></a><span id="l1.4"> 		nsIMsgAccount.idl \</span>
<a href="#l1.5"></a><span id="l1.5"> 		nsIMsgAccountManager.idl \</span>
<a href="#l1.6"></a><span id="l1.6"> 		nsIMsgFolder.idl \</span>
<a href="#l1.7"></a><span id="l1.7"> 		nsIMsgFolderCache.idl \</span>
<a href="#l1.8"></a><span id="l1.8"> 		nsIMsgFolderCacheElement.idl \</span>
<a href="#l1.9"></a><span id="l1.9"> 		nsIMsgFolderCompactor.idl \</span>
<a href="#l1.10"></a><span id="l1.10"> 		nsIMsgIdentity.idl \</span>
<a href="#l1.11"></a><span id="l1.11"> 		nsIMsgIncomingServer.idl \</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+		nsIMsgKeyArray.idl \</span>
<a href="#l1.13"></a><span id="l1.13"> 		nsIMsgMailSession.idl \</span>
<a href="#l1.14"></a><span id="l1.14"> 		nsIMsgMessageService.idl \</span>
<a href="#l1.15"></a><span id="l1.15"> 		nsIMsgTagService.idl \</span>
<a href="#l1.16"></a><span id="l1.16"> 		nsIMsgThread.idl \</span>
<a href="#l1.17"></a><span id="l1.17"> 		nsIUrlListener.idl \</span>
<a href="#l1.18"></a><span id="l1.18"> 		nsIMsgBiffManager.idl \</span>
<a href="#l1.19"></a><span id="l1.19"> 		nsIStatusBarBiffManager.idl \</span>
<a href="#l1.20"></a><span id="l1.20"> 		nsIMsgPurgeService.idl \</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/base/public/nsIMsgHdr.idl</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/base/public/nsIMsgHdr.idl</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -32,28 +32,22 @@</span>
<a href="#l2.4"></a><span id="l2.4">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l2.5"></a><span id="l2.5">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l2.6"></a><span id="l2.6">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l2.7"></a><span id="l2.7">  *</span>
<a href="#l2.8"></a><span id="l2.8">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l2.9"></a><span id="l2.9"> </span>
<a href="#l2.10"></a><span id="l2.10"> #include &quot;nsISupports.idl&quot;</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-%{C++</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-#include &quot;MailNewsTypes.h&quot;</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-%}</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineminus">-</span>
<a href="#l2.16"></a><span id="l2.16"> #include &quot;MailNewsTypes2.idl&quot;</span>
<a href="#l2.17"></a><span id="l2.17"> </span>
<a href="#l2.18"></a><span id="l2.18" class="difflineminus">-[ptr] native octetPtr(PRUint8);</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineminus">-</span>
<a href="#l2.20"></a><span id="l2.20"> interface nsIMsgFolder;</span>
<a href="#l2.21"></a><span id="l2.21"> interface nsIUTF8StringEnumerator;</span>
<a href="#l2.22"></a><span id="l2.22"> </span>
<a href="#l2.23"></a><span id="l2.23" class="difflineminus">-[scriptable, uuid(574611fe-f170-4eb4-a30c-a26e2c62703a)]</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineplus">+[scriptable, uuid(36adf826-73f4-48e7-a444-318242ea8a8e)]</span>
<a href="#l2.25"></a><span id="l2.25"> interface nsIMsgDBHdr : nsISupports</span>
<a href="#l2.26"></a><span id="l2.26"> {</span>
<a href="#l2.27"></a><span id="l2.27">     /* general property routines - I think this can retrieve any</span>
<a href="#l2.28"></a><span id="l2.28">        header in the db */</span>
<a href="#l2.29"></a><span id="l2.29">     AString getProperty(in string propertyName);</span>
<a href="#l2.30"></a><span id="l2.30">     void setProperty(in string propertyName, in AString propertyStr);</span>
<a href="#l2.31"></a><span id="l2.31">     void setStringProperty(in string propertyName, in string propertyValue);</span>
<a href="#l2.32"></a><span id="l2.32">     string getStringProperty(in string propertyName);</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineat">@@ -114,20 +108,23 @@ interface nsIMsgDBHdr : nsISupports</span>
<a href="#l2.34"></a><span id="l2.34">                         in unsigned long numAddresses);</span>
<a href="#l2.35"></a><span id="l2.35">     void setBCCListArray(in string names, in string addresses,</span>
<a href="#l2.36"></a><span id="l2.36">                          in unsigned long numAddresses);</span>
<a href="#l2.37"></a><span id="l2.37"> </span>
<a href="#l2.38"></a><span id="l2.38">     readonly attribute AString mime2DecodedAuthor;</span>
<a href="#l2.39"></a><span id="l2.39">     readonly attribute AString mime2DecodedSubject;</span>
<a href="#l2.40"></a><span id="l2.40">     readonly attribute AString mime2DecodedRecipients;</span>
<a href="#l2.41"></a><span id="l2.41"> </span>
<a href="#l2.42"></a><span id="l2.42" class="difflineminus">-    [noscript] void getAuthorCollationKey(out octetPtr key, out unsigned long len);</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineminus">-    [noscript] void getSubjectCollationKey(out octetPtr key, out unsigned long len);</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineminus">-    [noscript] void getRecipientsCollationKey(out octetPtr key, out unsigned long len);</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineminus">-    </span>
<a href="#l2.46"></a><span id="l2.46" class="difflineplus">+    void getAuthorCollationKey(out unsigned long aCount,</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineplus">+                              [array, size_is(aCount)] out octet aKey);</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineplus">+    void getSubjectCollationKey(out unsigned long aCount,</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineplus">+                                [array, size_is(aCount)] out octet aKey);</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineplus">+    void getRecipientsCollationKey(out unsigned long aCount,</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineplus">+                                  [array, size_is(aCount)] out octet aKey);</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineplus">+</span>
<a href="#l2.53"></a><span id="l2.53">     attribute string Charset;</span>
<a href="#l2.54"></a><span id="l2.54">     attribute nsMsgLabelValue label;</span>
<a href="#l2.55"></a><span id="l2.55">     attribute string accountKey;</span>
<a href="#l2.56"></a><span id="l2.56">     readonly attribute nsIMsgFolder folder;</span>
<a href="#l2.57"></a><span id="l2.57"> </span>
<a href="#l2.58"></a><span id="l2.58">     /// Enumerator for names of all database properties in the header.</span>
<a href="#l2.59"></a><span id="l2.59">     readonly attribute nsIUTF8StringEnumerator propertyEnumerator;</span>
<a href="#l2.60"></a><span id="l2.60"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1">new file mode 100644</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineminus">--- /dev/null</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineplus">+++ b/mailnews/base/public/nsIMsgKeyArray.idl</span>
<a href="#l3.4"></a><span id="l3.4" class="difflineat">@@ -0,0 +1,81 @@</span>
<a href="#l3.5"></a><span id="l3.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l3.6"></a><span id="l3.6" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l3.7"></a><span id="l3.7" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l3.8"></a><span id="l3.8" class="difflineplus">+ *</span>
<a href="#l3.9"></a><span id="l3.9" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l3.10"></a><span id="l3.10" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l3.11"></a><span id="l3.11" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+ *</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+ * License.</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+ *</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+  * The Original Code is mozilla.org code.</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+ *</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+ * The Mozilla Foundation.</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2011</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineplus">+ *</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+ *   David Bienvenu &lt;bienvenu@mozilla.com&gt;</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineplus">+ *</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+ *</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineplus">+</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+/**</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineplus">+ * This interface wraps an nsTArray&lt;nsMsgKey&gt; so that we can pass arrays</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineplus">+ * back and forth between c++ and js (or via xpconnect generally).</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineplus">+ */</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineplus">+</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineplus">+#include &quot;nsISupports.idl&quot;</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineplus">+#include &quot;MailNewsTypes2.idl&quot;</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineplus">+[scriptable, uuid(e8fcaada-64b7-4e39-9f1d-10ddb0f1de64)]</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineplus">+interface nsIMsgKeyArray : nsISupports {</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineplus">+  /**</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineplus">+   * Get the key at the specified 0-based array index.</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineplus">+   *</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineplus">+   * @param aIndex 0-based index.</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineplus">+   * @returns key at the specified index.</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineplus">+   */</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineplus">+  nsMsgKey getKeyAt(in long aIndex);</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineplus">+</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineplus">+  readonly attribute unsigned long length;</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineplus">+</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineplus">+  void setCapacity(in unsigned long aCapacity);</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineplus">+  /**</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineplus">+   * Adds a key to the end of the array</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineplus">+   * @param key to append to the array.</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineplus">+   */</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineplus">+  void appendElement(in nsMsgKey aMsgKey);</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineplus">+</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineplus">+  /**</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineplus">+   * Sort the array by key.</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineplus">+   */</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineplus">+  void sort();</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineplus">+</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineplus">+  /**</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineplus">+   * Retrieves the entire array in such a way that xpconnect can easily</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineplus">+   * create a js array of the keys.</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineplus">+   *</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineplus">+   * @returns array of the keys</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineplus">+   */</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineplus">+  void getArray(out unsigned long aCount,</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineplus">+           [array, size_is(aCount)] out nsMsgKey aKeys);</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineplus">+};</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/base/public/nsIMsgMessageService.idl</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/base/public/nsIMsgMessageService.idl</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -31,37 +31,33 @@</span>
<a href="#l4.4"></a><span id="l4.4">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l4.5"></a><span id="l4.5">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l4.6"></a><span id="l4.6">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l4.7"></a><span id="l4.7">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l4.8"></a><span id="l4.8">  *</span>
<a href="#l4.9"></a><span id="l4.9">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l4.10"></a><span id="l4.10"> </span>
<a href="#l4.11"></a><span id="l4.11"> #include &quot;nsISupports.idl&quot;</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+#include &quot;MailNewsTypes2.idl&quot;</span>
<a href="#l4.14"></a><span id="l4.14"> interface nsIURI;</span>
<a href="#l4.15"></a><span id="l4.15"> interface nsIUrlListener;</span>
<a href="#l4.16"></a><span id="l4.16"> interface nsIStreamListener;</span>
<a href="#l4.17"></a><span id="l4.17"> interface nsIMsgWindow;</span>
<a href="#l4.18"></a><span id="l4.18"> interface nsIFile;</span>
<a href="#l4.19"></a><span id="l4.19"> interface nsIMsgFolder;</span>
<a href="#l4.20"></a><span id="l4.20"> interface nsIMsgSearchSession;</span>
<a href="#l4.21"></a><span id="l4.21"> interface nsIMsgDBHdr;</span>
<a href="#l4.22"></a><span id="l4.22"> interface nsIStreamConverter;</span>
<a href="#l4.23"></a><span id="l4.23"> interface nsICacheEntryDescriptor;</span>
<a href="#l4.24"></a><span id="l4.24"> </span>
<a href="#l4.25"></a><span id="l4.25"> %{C++</span>
<a href="#l4.26"></a><span id="l4.26"> #include &quot;MailNewsTypes.h&quot;</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineminus">-#include &quot;nsTArray.h&quot;</span>
<a href="#l4.28"></a><span id="l4.28"> %}</span>
<a href="#l4.29"></a><span id="l4.29"> </span>
<a href="#l4.30"></a><span id="l4.30" class="difflineminus">-[ref] native nsMsgKeyArrayRef(nsTArray&lt;nsMsgKey&gt;);</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineminus">-</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineminus">-</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineminus">-[scriptable, uuid(5f173e8d-0046-4eec-b178-b850a7211654)]</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+[scriptable, uuid(ac7b56c2-cf42-4ee3-a3b1-9ae64a90861c)]</span>
<a href="#l4.35"></a><span id="l4.35"> interface nsIMsgMessageService : nsISupports {</span>
<a href="#l4.36"></a><span id="l4.36">      </span>
<a href="#l4.37"></a><span id="l4.37">   /**</span>
<a href="#l4.38"></a><span id="l4.38">    * If you want a handle on the running task, pass in a valid nsIURI </span>
<a href="#l4.39"></a><span id="l4.39">    * ptr. You can later interrupt this action by asking the netlib </span>
<a href="#l4.40"></a><span id="l4.40">    * service manager to interrupt the url you are given back. </span>
<a href="#l4.41"></a><span id="l4.41">    * Remember to release aURL when you are done with it. Pass nsnull</span>
<a href="#l4.42"></a><span id="l4.42">    * in for aURL if you don't care about the returned URL.</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineat">@@ -86,20 +82,25 @@ interface nsIMsgMessageService : nsISupp</span>
<a href="#l4.44"></a><span id="l4.44">    * Copy multiple messages at a time </span>
<a href="#l4.45"></a><span id="l4.45">    *</span>
<a href="#l4.46"></a><span id="l4.46">    * @param keys</span>
<a href="#l4.47"></a><span id="l4.47">    * @param srcFolder</span>
<a href="#l4.48"></a><span id="l4.48">    * @param aCopyListener</span>
<a href="#l4.49"></a><span id="l4.49">    * @param aMoveMessage</span>
<a href="#l4.50"></a><span id="l4.50">    * @param aUrlListener</span>
<a href="#l4.51"></a><span id="l4.51">    * @param aMsgWindow</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineminus">-   * @param aURL</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineplus">+   * @returns URI that's run to perform the copy</span>
<a href="#l4.54"></a><span id="l4.54">    */</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineminus">-  [noscript] void CopyMessages(in nsMsgKeyArrayRef keys, in nsIMsgFolder srcFolder, in nsIStreamListener aCopyListener, in boolean aMoveMessage,</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineminus">-               in nsIUrlListener aUrlListener, in nsIMsgWindow aMsgWindow, out nsIURI aURL);</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineplus">+  nsIURI CopyMessages(in unsigned long aNumKeys,</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineplus">+                      [array, size_is (aNumKeys)] in nsMsgKey aKeys,</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineplus">+                      in nsIMsgFolder srcFolder,</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineplus">+                      in nsIStreamListener aCopyListener,</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineplus">+                      in boolean aMoveMessage,</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineplus">+                      in nsIUrlListener aUrlListener,</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineplus">+                      in nsIMsgWindow aMsgWindow);</span>
<a href="#l4.64"></a><span id="l4.64"> </span>
<a href="#l4.65"></a><span id="l4.65">     </span>
<a href="#l4.66"></a><span id="l4.66">   /**</span>
<a href="#l4.67"></a><span id="l4.67">    * When you want a message displayed....</span>
<a href="#l4.68"></a><span id="l4.68">    *</span>
<a href="#l4.69"></a><span id="l4.69">    * @param aMessageURI Is a uri representing the message to display.</span>
<a href="#l4.70"></a><span id="l4.70">    * @param aDisplayConsumer Is (for now) an nsIDocShell which we'll use to load </span>
<a href="#l4.71"></a><span id="l4.71">    *                         the message into.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/base/public/nsMsgBaseCID.h</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/base/public/nsMsgBaseCID.h</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -279,16 +279,27 @@</span>
<a href="#l5.4"></a><span id="l5.4">   &quot;@mozilla.org/messenger/statusfeedback;1&quot;</span>
<a href="#l5.5"></a><span id="l5.5"> </span>
<a href="#l5.6"></a><span id="l5.6"> /* B1AA0820-D04B-11d2-8069-006008128C4E */</span>
<a href="#l5.7"></a><span id="l5.7"> #define NS_MSGSTATUSFEEDBACK_CID \</span>
<a href="#l5.8"></a><span id="l5.8"> { 0xbd85a417, 0x5433, 0x11d3, \</span>
<a href="#l5.9"></a><span id="l5.9">   {0x8a, 0xc5, 0x0, 0x60, 0xb0, 0xfc, 0x4, 0xd2} }</span>
<a href="#l5.10"></a><span id="l5.10"> </span>
<a href="#l5.11"></a><span id="l5.11"> //</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+// nsMsgKeyArray</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+//</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+#define NS_MSGKEYARRAY_CONTRACTID \</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+  &quot;@mozilla.org/messenger/msgkeyarray;1&quot;</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+/* 86989d1d-c8a1-4e8e-aae6-d0dabcacd8c2 */</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+#define NS_MSGKEYARRAY_CID \</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+{ 0x86989d1d, 0xc8a1, 0x4e8e, \</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+  {0xaa, 0xe6, 0xd0, 0xda, 0xbc, 0xac, 0xd8, 0xc2 }}</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineplus">+</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineplus">+//</span>
<a href="#l5.23"></a><span id="l5.23"> //nsMsgWindow</span>
<a href="#l5.24"></a><span id="l5.24"> //</span>
<a href="#l5.25"></a><span id="l5.25"> #define NS_MSGWINDOW_CONTRACTID \</span>
<a href="#l5.26"></a><span id="l5.26"> 	&quot;@mozilla.org/messenger/msgwindow;1&quot;</span>
<a href="#l5.27"></a><span id="l5.27"> </span>
<a href="#l5.28"></a><span id="l5.28"> /* BB460DFF-8BF0-11d3-8AFE-0060B0FC04D2*/</span>
<a href="#l5.29"></a><span id="l5.29"> #define NS_MSGWINDOW_CID \</span>
<a href="#l5.30"></a><span id="l5.30"> { 0xbb460dff, 0x8bf0, 0x11d3, \</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/base/src/nsMsgDBView.cpp</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgDBView.cpp</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -3760,17 +3760,18 @@ nsMsgDBView::FnSortIdKey(const void *pIt</span>
<a href="#l6.4"></a><span id="l6.4">     nsresult rv;</span>
<a href="#l6.5"></a><span id="l6.5">     viewSortInfo* sortInfo = (viewSortInfo *) privateData;</span>
<a href="#l6.6"></a><span id="l6.6"> </span>
<a href="#l6.7"></a><span id="l6.7">     IdKey** p1 = (IdKey**)pItem1;</span>
<a href="#l6.8"></a><span id="l6.8">     IdKey** p2 = (IdKey**)pItem2;</span>
<a href="#l6.9"></a><span id="l6.9"> </span>
<a href="#l6.10"></a><span id="l6.10">     nsIMsgDatabase *db = sortInfo-&gt;db;</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-    rv = db-&gt;CompareCollationKeys((*p1)-&gt;key, (*p1)-&gt;dword, (*p2)-&gt;key, (*p2)-&gt;dword, &amp;retVal);</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+    rv = db-&gt;CompareCollationKeys((*p1)-&gt;dword, (*p1)-&gt;key, (*p2)-&gt;dword,</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+                                  (*p2)-&gt;key, &amp;retVal);</span>
<a href="#l6.15"></a><span id="l6.15">     NS_ASSERTION(NS_SUCCEEDED(rv),&quot;compare failed&quot;);</span>
<a href="#l6.16"></a><span id="l6.16"> </span>
<a href="#l6.17"></a><span id="l6.17">     if (retVal)</span>
<a href="#l6.18"></a><span id="l6.18">       return sortInfo-&gt;ascendingSort ? retVal : -retVal;</span>
<a href="#l6.19"></a><span id="l6.19">     if (sortInfo-&gt;view-&gt;m_secondarySort == nsMsgViewSortType::byId)</span>
<a href="#l6.20"></a><span id="l6.20">       return (sortInfo-&gt;view-&gt;m_secondarySortOrder == nsMsgViewSortOrder::ascending &amp;&amp;</span>
<a href="#l6.21"></a><span id="l6.21">               (*p1)-&gt;id &gt;= (*p2)-&gt;id) ? 1 : -1;</span>
<a href="#l6.22"></a><span id="l6.22">     else</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineat">@@ -3785,17 +3786,18 @@ nsMsgDBView::FnSortIdKeyPtr(const void *</span>
<a href="#l6.24"></a><span id="l6.24">   nsresult rv;</span>
<a href="#l6.25"></a><span id="l6.25"> </span>
<a href="#l6.26"></a><span id="l6.26">   IdKeyPtr** p1 = (IdKeyPtr**)pItem1;</span>
<a href="#l6.27"></a><span id="l6.27">   IdKeyPtr** p2 = (IdKeyPtr**)pItem2;</span>
<a href="#l6.28"></a><span id="l6.28">   viewSortInfo* sortInfo = (viewSortInfo *) privateData;</span>
<a href="#l6.29"></a><span id="l6.29"> </span>
<a href="#l6.30"></a><span id="l6.30">   nsIMsgDatabase *db = sortInfo-&gt;db;</span>
<a href="#l6.31"></a><span id="l6.31"> </span>
<a href="#l6.32"></a><span id="l6.32" class="difflineminus">-  rv = db-&gt;CompareCollationKeys((*p1)-&gt;key, (*p1)-&gt;dword, (*p2)-&gt;key, (*p2)-&gt;dword, &amp;retVal);</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+  rv = db-&gt;CompareCollationKeys((*p1)-&gt;dword, (*p1)-&gt;key, (*p2)-&gt;dword,</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+                                (*p2)-&gt;key, &amp;retVal);</span>
<a href="#l6.35"></a><span id="l6.35">   NS_ASSERTION(NS_SUCCEEDED(rv),&quot;compare failed&quot;);</span>
<a href="#l6.36"></a><span id="l6.36"> </span>
<a href="#l6.37"></a><span id="l6.37">   if (retVal)</span>
<a href="#l6.38"></a><span id="l6.38">     return sortInfo-&gt;ascendingSort ? retVal : -retVal;</span>
<a href="#l6.39"></a><span id="l6.39"> </span>
<a href="#l6.40"></a><span id="l6.40">   if (sortInfo-&gt;view-&gt;m_secondarySort == nsMsgViewSortType::byId)</span>
<a href="#l6.41"></a><span id="l6.41">     return (sortInfo-&gt;view-&gt;m_secondarySortOrder == nsMsgViewSortOrder::ascending &amp;&amp;</span>
<a href="#l6.42"></a><span id="l6.42">             (*p1)-&gt;id &gt;= (*p2)-&gt;id) ? 1 : -1;</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineat">@@ -4117,59 +4119,59 @@ nsMsgDBView::GetCollationKey(nsIMsgDBHdr</span>
<a href="#l6.44"></a><span id="l6.44"> {</span>
<a href="#l6.45"></a><span id="l6.45">   nsresult rv;</span>
<a href="#l6.46"></a><span id="l6.46">   NS_ENSURE_ARG_POINTER(msgHdr);</span>
<a href="#l6.47"></a><span id="l6.47">   NS_ENSURE_ARG_POINTER(result);</span>
<a href="#l6.48"></a><span id="l6.48"> </span>
<a href="#l6.49"></a><span id="l6.49">   switch (sortType)</span>
<a href="#l6.50"></a><span id="l6.50">   {</span>
<a href="#l6.51"></a><span id="l6.51">     case nsMsgViewSortType::bySubject:</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineminus">-        rv = msgHdr-&gt;GetSubjectCollationKey(result, len);</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineplus">+        rv = msgHdr-&gt;GetSubjectCollationKey(len, result);</span>
<a href="#l6.54"></a><span id="l6.54">         break;</span>
<a href="#l6.55"></a><span id="l6.55">     case nsMsgViewSortType::byLocation:</span>
<a href="#l6.56"></a><span id="l6.56">         rv = GetLocationCollationKey(msgHdr, result, len);</span>
<a href="#l6.57"></a><span id="l6.57">         break;</span>
<a href="#l6.58"></a><span id="l6.58">     case nsMsgViewSortType::byRecipient:</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineminus">-        rv = msgHdr-&gt;GetRecipientsCollationKey(result, len);</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineplus">+        rv = msgHdr-&gt;GetRecipientsCollationKey(len, result);</span>
<a href="#l6.61"></a><span id="l6.61">         break;</span>
<a href="#l6.62"></a><span id="l6.62">     case nsMsgViewSortType::byAuthor:</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineminus">-        rv = msgHdr-&gt;GetAuthorCollationKey(result, len);</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineplus">+        rv = msgHdr-&gt;GetAuthorCollationKey(len, result);</span>
<a href="#l6.65"></a><span id="l6.65">         break;</span>
<a href="#l6.66"></a><span id="l6.66">     case nsMsgViewSortType::byAccount:</span>
<a href="#l6.67"></a><span id="l6.67">     case nsMsgViewSortType::byTags:</span>
<a href="#l6.68"></a><span id="l6.68">       {</span>
<a href="#l6.69"></a><span id="l6.69">         nsString str;</span>
<a href="#l6.70"></a><span id="l6.70">         nsCOMPtr &lt;nsIMsgDatabase&gt; dbToUse = m_db;</span>
<a href="#l6.71"></a><span id="l6.71"> </span>
<a href="#l6.72"></a><span id="l6.72">         if (!dbToUse) // probably search view</span>
<a href="#l6.73"></a><span id="l6.73">           GetDBForViewIndex(0, getter_AddRefs(dbToUse));</span>
<a href="#l6.74"></a><span id="l6.74"> </span>
<a href="#l6.75"></a><span id="l6.75">         rv = (sortType == nsMsgViewSortType::byAccount)</span>
<a href="#l6.76"></a><span id="l6.76">             ? FetchAccount(msgHdr, str)</span>
<a href="#l6.77"></a><span id="l6.77">             : FetchTags(msgHdr, str);</span>
<a href="#l6.78"></a><span id="l6.78"> </span>
<a href="#l6.79"></a><span id="l6.79">         if (NS_SUCCEEDED(rv) &amp;&amp; dbToUse)</span>
<a href="#l6.80"></a><span id="l6.80" class="difflineminus">-          rv = dbToUse-&gt;CreateCollationKey(str, result, len);</span>
<a href="#l6.81"></a><span id="l6.81" class="difflineplus">+          rv = dbToUse-&gt;CreateCollationKey(str, len, result);</span>
<a href="#l6.82"></a><span id="l6.82">       }</span>
<a href="#l6.83"></a><span id="l6.83">       break;</span>
<a href="#l6.84"></a><span id="l6.84">     case nsMsgViewSortType::byCustom:</span>
<a href="#l6.85"></a><span id="l6.85">       if (colHandler != nsnull)</span>
<a href="#l6.86"></a><span id="l6.86">       {</span>
<a href="#l6.87"></a><span id="l6.87">         nsAutoString strKey;</span>
<a href="#l6.88"></a><span id="l6.88">         rv = colHandler-&gt;GetSortStringForRow(msgHdr, strKey);</span>
<a href="#l6.89"></a><span id="l6.89">         NS_ASSERTION(NS_SUCCEEDED(rv),&quot;failed to get sort string for custom row&quot;);</span>
<a href="#l6.90"></a><span id="l6.90">         nsAutoString strTemp(strKey);</span>
<a href="#l6.91"></a><span id="l6.91"> </span>
<a href="#l6.92"></a><span id="l6.92">         nsCOMPtr &lt;nsIMsgDatabase&gt; dbToUse = m_db;</span>
<a href="#l6.93"></a><span id="l6.93">         if (!dbToUse) // probably search view</span>
<a href="#l6.94"></a><span id="l6.94">         {</span>
<a href="#l6.95"></a><span id="l6.95">           rv = GetDBForHeader(msgHdr, getter_AddRefs(dbToUse));</span>
<a href="#l6.96"></a><span id="l6.96">           NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l6.97"></a><span id="l6.97">         }</span>
<a href="#l6.98"></a><span id="l6.98" class="difflineminus">-        rv = dbToUse-&gt;CreateCollationKey(strKey, result, len);</span>
<a href="#l6.99"></a><span id="l6.99" class="difflineplus">+        rv = dbToUse-&gt;CreateCollationKey(strKey, len, result);</span>
<a href="#l6.100"></a><span id="l6.100">       }</span>
<a href="#l6.101"></a><span id="l6.101">       else</span>
<a href="#l6.102"></a><span id="l6.102">       {</span>
<a href="#l6.103"></a><span id="l6.103">         NS_ASSERTION(PR_FALSE,&quot;should not be here (Sort Type: byCustom (String), but no custom handler)&quot;);</span>
<a href="#l6.104"></a><span id="l6.104">         //rv = NS_ERROR_UNEXPECTED;</span>
<a href="#l6.105"></a><span id="l6.105">       }</span>
<a href="#l6.106"></a><span id="l6.106">       break;</span>
<a href="#l6.107"></a><span id="l6.107">     default:</span>
<a href="#l6.108"></a><span id="l6.108" class="difflineat">@@ -4200,17 +4202,17 @@ nsMsgDBView::GetLocationCollationKey(nsI</span>
<a href="#l6.109"></a><span id="l6.109">   nsCOMPtr &lt;nsIMsgDatabase&gt; dbToUse;</span>
<a href="#l6.110"></a><span id="l6.110">   rv = folder-&gt;GetMsgDatabase(getter_AddRefs(dbToUse));</span>
<a href="#l6.111"></a><span id="l6.111">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l6.112"></a><span id="l6.112"> </span>
<a href="#l6.113"></a><span id="l6.113">   nsString locationString;</span>
<a href="#l6.114"></a><span id="l6.114">   rv = folder-&gt;GetPrettiestName(locationString);</span>
<a href="#l6.115"></a><span id="l6.115">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l6.116"></a><span id="l6.116"> </span>
<a href="#l6.117"></a><span id="l6.117" class="difflineminus">-  return dbToUse-&gt;CreateCollationKey(locationString, result, len);</span>
<a href="#l6.118"></a><span id="l6.118" class="difflineplus">+  return dbToUse-&gt;CreateCollationKey(locationString, len, result);</span>
<a href="#l6.119"></a><span id="l6.119"> }</span>
<a href="#l6.120"></a><span id="l6.120"> </span>
<a href="#l6.121"></a><span id="l6.121"> nsresult nsMsgDBView::SaveSortInfo(nsMsgViewSortTypeValue sortType, nsMsgViewSortOrderValue sortOrder)</span>
<a href="#l6.122"></a><span id="l6.122"> {</span>
<a href="#l6.123"></a><span id="l6.123">   if (m_viewFolder)</span>
<a href="#l6.124"></a><span id="l6.124">   {</span>
<a href="#l6.125"></a><span id="l6.125">     nsCOMPtr &lt;nsIDBFolderInfo&gt; folderInfo;</span>
<a href="#l6.126"></a><span id="l6.126">     nsCOMPtr &lt;nsIMsgDatabase&gt; db;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/base/src/nsMsgFolderCompactor.cpp</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgFolderCompactor.cpp</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -33,41 +33,42 @@</span>
<a href="#l7.4"></a><span id="l7.4">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l7.5"></a><span id="l7.5">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l7.6"></a><span id="l7.6">  *</span>
<a href="#l7.7"></a><span id="l7.7">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l7.8"></a><span id="l7.8"> </span>
<a href="#l7.9"></a><span id="l7.9"> #include &quot;msgCore.h&quot;    // precompiled header...</span>
<a href="#l7.10"></a><span id="l7.10"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l7.11"></a><span id="l7.11"> #include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+#include &quot;nsAutoPtr.h&quot;</span>
<a href="#l7.13"></a><span id="l7.13"> #include &quot;nsILocalFile.h&quot;</span>
<a href="#l7.14"></a><span id="l7.14"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l7.15"></a><span id="l7.15"> #include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l7.16"></a><span id="l7.16"> #include &quot;nsIStreamListener.h&quot;</span>
<a href="#l7.17"></a><span id="l7.17"> #include &quot;nsIMsgMessageService.h&quot;</span>
<a href="#l7.18"></a><span id="l7.18"> #include &quot;nsMsgDBCID.h&quot;</span>
<a href="#l7.19"></a><span id="l7.19"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l7.20"></a><span id="l7.20"> #include &quot;nsISeekableStream.h&quot;</span>
<a href="#l7.21"></a><span id="l7.21"> #include &quot;nsIDBFolderInfo.h&quot;</span>
<a href="#l7.22"></a><span id="l7.22"> #include &quot;nsIDocShell.h&quot;</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineminus">-#include &quot;nsMsgFolderCompactor.h&quot;</span>
<a href="#l7.24"></a><span id="l7.24"> #include &quot;nsIPrompt.h&quot;</span>
<a href="#l7.25"></a><span id="l7.25"> #include &quot;nsIInterfaceRequestorUtils.h&quot;</span>
<a href="#l7.26"></a><span id="l7.26"> #include &quot;nsIMsgLocalMailFolder.h&quot;</span>
<a href="#l7.27"></a><span id="l7.27"> #include &quot;nsIMsgImapMailFolder.h&quot;</span>
<a href="#l7.28"></a><span id="l7.28"> #include &quot;nsMailHeaders.h&quot;</span>
<a href="#l7.29"></a><span id="l7.29"> #include &quot;nsMsgI18N.h&quot;</span>
<a href="#l7.30"></a><span id="l7.30"> #include &quot;prprf.h&quot;</span>
<a href="#l7.31"></a><span id="l7.31"> #include &quot;nsMsgLocalFolderHdrs.h&quot;</span>
<a href="#l7.32"></a><span id="l7.32"> #include &quot;nsIMsgDatabase.h&quot;</span>
<a href="#l7.33"></a><span id="l7.33"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l7.34"></a><span id="l7.34"> #include &quot;nsMsgMessageFlags.h&quot;</span>
<a href="#l7.35"></a><span id="l7.35"> #include &quot;nsIMsgStatusFeedback.h&quot;</span>
<a href="#l7.36"></a><span id="l7.36"> #include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l7.37"></a><span id="l7.37"> #include &quot;nsIMsgFolderNotificationService.h&quot;</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineplus">+#include &quot;nsMsgFolderCompactor.h&quot;</span>
<a href="#l7.39"></a><span id="l7.39"> </span>
<a href="#l7.40"></a><span id="l7.40"> //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l7.41"></a><span id="l7.41"> // nsFolderCompactState</span>
<a href="#l7.42"></a><span id="l7.42"> //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l7.43"></a><span id="l7.43"> </span>
<a href="#l7.44"></a><span id="l7.44"> NS_IMPL_ISUPPORTS5(nsFolderCompactState, nsIMsgFolderCompactor, nsIRequestObserver, nsIStreamListener, nsICopyMessageStreamListener, nsIUrlListener)</span>
<a href="#l7.45"></a><span id="l7.45"> </span>
<a href="#l7.46"></a><span id="l7.46"> nsFolderCompactState::nsFolderCompactState()</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineat">@@ -83,17 +84,16 @@ nsFolderCompactState::nsFolderCompactSta</span>
<a href="#l7.48"></a><span id="l7.48">   m_folderIndex = 0;</span>
<a href="#l7.49"></a><span id="l7.49">   m_startOfMsg = PR_TRUE;</span>
<a href="#l7.50"></a><span id="l7.50">   m_needStatusLine = PR_FALSE;</span>
<a href="#l7.51"></a><span id="l7.51"> }</span>
<a href="#l7.52"></a><span id="l7.52"> </span>
<a href="#l7.53"></a><span id="l7.53"> nsFolderCompactState::~nsFolderCompactState()</span>
<a href="#l7.54"></a><span id="l7.54"> {</span>
<a href="#l7.55"></a><span id="l7.55">   CloseOutputStream();</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineminus">-</span>
<a href="#l7.57"></a><span id="l7.57">   if (NS_FAILED(m_status))</span>
<a href="#l7.58"></a><span id="l7.58">   {</span>
<a href="#l7.59"></a><span id="l7.59">     CleanupTempFilesAfterError();</span>
<a href="#l7.60"></a><span id="l7.60">     // if for some reason we failed remove the temp folder and database</span>
<a href="#l7.61"></a><span id="l7.61">   }</span>
<a href="#l7.62"></a><span id="l7.62"> }</span>
<a href="#l7.63"></a><span id="l7.63"> </span>
<a href="#l7.64"></a><span id="l7.64"> void nsFolderCompactState::CloseOutputStream()</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineat">@@ -125,19 +125,20 @@ nsresult nsFolderCompactState::BuildMess</span>
<a href="#l7.66"></a><span id="l7.66">   return NS_OK;</span>
<a href="#l7.67"></a><span id="l7.67"> }</span>
<a href="#l7.68"></a><span id="l7.68"> </span>
<a href="#l7.69"></a><span id="l7.69"> </span>
<a href="#l7.70"></a><span id="l7.70"> nsresult</span>
<a href="#l7.71"></a><span id="l7.71"> nsFolderCompactState::InitDB(nsIMsgDatabase *db)</span>
<a href="#l7.72"></a><span id="l7.72"> {</span>
<a href="#l7.73"></a><span id="l7.73">   nsCOMPtr&lt;nsIMsgDatabase&gt; mailDBFactory;</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineplus">+  nsresult rv = db-&gt;ListAllKeys(m_keyArray);</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineplus">+  m_size = m_keyArray-&gt;m_keys.Length();</span>
<a href="#l7.77"></a><span id="l7.77"> </span>
<a href="#l7.78"></a><span id="l7.78" class="difflineminus">-  db-&gt;ListAllKeys(m_keyArray);</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineminus">-  nsresult rv;</span>
<a href="#l7.80"></a><span id="l7.80">   nsCOMPtr&lt;nsIMsgDBService&gt; msgDBService = do_GetService(NS_MSGDB_SERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l7.81"></a><span id="l7.81">   if (msgDBService) </span>
<a href="#l7.82"></a><span id="l7.82">   {</span>
<a href="#l7.83"></a><span id="l7.83">     nsresult folderOpen = msgDBService-&gt;OpenMailDBFromFile(m_file, PR_TRUE,</span>
<a href="#l7.84"></a><span id="l7.84">                                      PR_FALSE,</span>
<a href="#l7.85"></a><span id="l7.85">                                      getter_AddRefs(m_db));</span>
<a href="#l7.86"></a><span id="l7.86"> </span>
<a href="#l7.87"></a><span id="l7.87">     if(NS_FAILED(folderOpen) &amp;&amp;</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineat">@@ -297,28 +298,28 @@ nsFolderCompactState::Init(nsIMsgFolder </span>
<a href="#l7.89"></a><span id="l7.89">   m_file-&gt;InitWithFile(path);</span>
<a href="#l7.90"></a><span id="l7.90">   // need to make sure the temp file goes in the same real directory</span>
<a href="#l7.91"></a><span id="l7.91">   // as the original file, so resolve sym links.</span>
<a href="#l7.92"></a><span id="l7.92">   m_file-&gt;SetFollowLinks(PR_TRUE);</span>
<a href="#l7.93"></a><span id="l7.93"> </span>
<a href="#l7.94"></a><span id="l7.94">   m_file-&gt;SetNativeLeafName(NS_LITERAL_CSTRING(&quot;nstmp&quot;));</span>
<a href="#l7.95"></a><span id="l7.95">   m_file-&gt;CreateUnique(nsIFile::NORMAL_FILE_TYPE, 00600);   //make sure we are not crunching existing nstmp file</span>
<a href="#l7.96"></a><span id="l7.96">   m_window = aMsgWindow;</span>
<a href="#l7.97"></a><span id="l7.97" class="difflineminus">-  m_keyArray.Clear();</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineplus">+  m_keyArray = new nsMsgKeyArray;</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineplus">+  m_size = 0;</span>
<a href="#l7.100"></a><span id="l7.100">   m_totalMsgSize = 0;</span>
<a href="#l7.101"></a><span id="l7.101">   rv = InitDB(db);</span>
<a href="#l7.102"></a><span id="l7.102">   if (NS_FAILED(rv))</span>
<a href="#l7.103"></a><span id="l7.103">   {</span>
<a href="#l7.104"></a><span id="l7.104">     CleanupTempFilesAfterError();</span>
<a href="#l7.105"></a><span id="l7.105">     return rv;</span>
<a href="#l7.106"></a><span id="l7.106">   }</span>
<a href="#l7.107"></a><span id="l7.107"> </span>
<a href="#l7.108"></a><span id="l7.108" class="difflineminus">-  m_size = m_keyArray.Length();</span>
<a href="#l7.109"></a><span id="l7.109">   m_curIndex = 0;</span>
<a href="#l7.110"></a><span id="l7.110" class="difflineminus">-  </span>
<a href="#l7.111"></a><span id="l7.111" class="difflineplus">+</span>
<a href="#l7.112"></a><span id="l7.112">   rv = MsgNewBufferedFileOutputStream(getter_AddRefs(m_fileStream), m_file, -1, 00600);</span>
<a href="#l7.113"></a><span id="l7.113">   if (NS_FAILED(rv)) </span>
<a href="#l7.114"></a><span id="l7.114">     m_folder-&gt;ThrowAlertMsg(&quot;compactFolderWriteFailed&quot;, m_window);</span>
<a href="#l7.115"></a><span id="l7.115">   else</span>
<a href="#l7.116"></a><span id="l7.116">     rv = GetMessageServiceFromURI(nsDependentCString(baseMsgUri),</span>
<a href="#l7.117"></a><span id="l7.117">                                 getter_AddRefs(m_messageService));</span>
<a href="#l7.118"></a><span id="l7.118">   if (NS_FAILED(rv))</span>
<a href="#l7.119"></a><span id="l7.119">   {</span>
<a href="#l7.120"></a><span id="l7.120" class="difflineat">@@ -375,22 +376,23 @@ nsresult nsFolderCompactState::StartComp</span>
<a href="#l7.121"></a><span id="l7.121">   nsCOMPtr&lt;nsIMsgFolderNotificationService&gt;</span>
<a href="#l7.122"></a><span id="l7.122">     notifier(do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l7.123"></a><span id="l7.123">   if (notifier)</span>
<a href="#l7.124"></a><span id="l7.124">     notifier-&gt;NotifyItemEvent(m_folder,</span>
<a href="#l7.125"></a><span id="l7.125">                               NS_LITERAL_CSTRING(&quot;FolderCompactStart&quot;),</span>
<a href="#l7.126"></a><span id="l7.126">                               nsnull);</span>
<a href="#l7.127"></a><span id="l7.127">   if (m_size &gt; 0)</span>
<a href="#l7.128"></a><span id="l7.128">   {</span>
<a href="#l7.129"></a><span id="l7.129" class="difflineminus">-</span>
<a href="#l7.130"></a><span id="l7.130" class="difflineplus">+    nsCOMPtr&lt;nsIURI&gt; notUsed;</span>
<a href="#l7.131"></a><span id="l7.131">     ShowCompactingStatusMsg();</span>
<a href="#l7.132"></a><span id="l7.132">     AddRef();</span>
<a href="#l7.133"></a><span id="l7.133" class="difflineminus">-    rv = m_messageService-&gt;CopyMessages(m_keyArray, m_folder, this, PR_FALSE, nsnull, m_window, nsnull);</span>
<a href="#l7.134"></a><span id="l7.134" class="difflineminus">-    // m_curIndex = m_size;  // advance m_curIndex to the end - we're done</span>
<a href="#l7.135"></a><span id="l7.135" class="difflineminus">-</span>
<a href="#l7.136"></a><span id="l7.136" class="difflineplus">+    rv = m_messageService-&gt;CopyMessages(m_size, m_keyArray-&gt;m_keys.Elements(),</span>
<a href="#l7.137"></a><span id="l7.137" class="difflineplus">+                                        m_folder, this,</span>
<a href="#l7.138"></a><span id="l7.138" class="difflineplus">+                                        PR_FALSE, nsnull, m_window,</span>
<a href="#l7.139"></a><span id="l7.139" class="difflineplus">+                                        getter_AddRefs(notUsed));</span>
<a href="#l7.140"></a><span id="l7.140">   }</span>
<a href="#l7.141"></a><span id="l7.141">   else</span>
<a href="#l7.142"></a><span id="l7.142">   { // no messages to copy with</span>
<a href="#l7.143"></a><span id="l7.143">     FinishCompact();</span>
<a href="#l7.144"></a><span id="l7.144"> //    Release(); // we don't &quot;own&quot; ourselves yet.</span>
<a href="#l7.145"></a><span id="l7.145">   }</span>
<a href="#l7.146"></a><span id="l7.146">   return rv;</span>
<a href="#l7.147"></a><span id="l7.147"> }</span>
<a href="#l7.148"></a><span id="l7.148" class="difflineat">@@ -661,17 +663,17 @@ nsFolderCompactState::OnDataAvailable(ns</span>
<a href="#l7.149"></a><span id="l7.149">   PRUint32 statusOffset;</span>
<a href="#l7.150"></a><span id="l7.150">   nsCString msgHdrKeywords;</span>
<a href="#l7.151"></a><span id="l7.151"> </span>
<a href="#l7.152"></a><span id="l7.152">   if (m_startOfMsg)</span>
<a href="#l7.153"></a><span id="l7.153">   {</span>
<a href="#l7.154"></a><span id="l7.154">     m_statusOffset = 0;</span>
<a href="#l7.155"></a><span id="l7.155">     m_addedHeaderSize = 0;</span>
<a href="#l7.156"></a><span id="l7.156">     m_messageUri.Truncate(); // clear the previous message uri</span>
<a href="#l7.157"></a><span id="l7.157" class="difflineminus">-    if (NS_SUCCEEDED(BuildMessageURI(m_baseMessageUri.get(), m_keyArray[m_curIndex],</span>
<a href="#l7.158"></a><span id="l7.158" class="difflineplus">+    if (NS_SUCCEEDED(BuildMessageURI(m_baseMessageUri.get(), m_keyArray-&gt;m_keys[m_curIndex],</span>
<a href="#l7.159"></a><span id="l7.159">                                 m_messageUri)))</span>
<a href="#l7.160"></a><span id="l7.160">     {</span>
<a href="#l7.161"></a><span id="l7.161">       rv = GetMessage(getter_AddRefs(m_curSrcHdr));</span>
<a href="#l7.162"></a><span id="l7.162">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.163"></a><span id="l7.163">       if (m_curSrcHdr)</span>
<a href="#l7.164"></a><span id="l7.164">       {</span>
<a href="#l7.165"></a><span id="l7.165">         (void) m_curSrcHdr-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l7.166"></a><span id="l7.166">         (void) m_curSrcHdr-&gt;GetStatusOffset(&amp;statusOffset);</span>
<a href="#l7.167"></a><span id="l7.167" class="difflineat">@@ -882,52 +884,51 @@ nsOfflineStoreCompactState::~nsOfflineSt</span>
<a href="#l7.168"></a><span id="l7.168"> }</span>
<a href="#l7.169"></a><span id="l7.169"> </span>
<a href="#l7.170"></a><span id="l7.170"> </span>
<a href="#l7.171"></a><span id="l7.171"> nsresult</span>
<a href="#l7.172"></a><span id="l7.172"> nsOfflineStoreCompactState::InitDB(nsIMsgDatabase *db)</span>
<a href="#l7.173"></a><span id="l7.173"> {</span>
<a href="#l7.174"></a><span id="l7.174">   // Start with the list of messages we have offline as the possible</span>
<a href="#l7.175"></a><span id="l7.175">   // message to keep when compacting the offline store.</span>
<a href="#l7.176"></a><span id="l7.176" class="difflineminus">-  db-&gt;ListAllOfflineMsgs(&amp;m_keyArray);</span>
<a href="#l7.177"></a><span id="l7.177" class="difflineminus">-  // Filter out msgs that have the &quot;pendingRemoval&quot; attribute set.</span>
<a href="#l7.178"></a><span id="l7.178" class="difflineminus">-  nsCOMPtr&lt;nsIMsgDBHdr&gt; hdr;</span>
<a href="#l7.179"></a><span id="l7.179" class="difflineminus">-  nsString pendingRemoval;</span>
<a href="#l7.180"></a><span id="l7.180" class="difflineminus">-  for (PRInt32 i = m_keyArray.Length() - 1; i &gt;= 0; i--)</span>
<a href="#l7.181"></a><span id="l7.181" class="difflineminus">-  {</span>
<a href="#l7.182"></a><span id="l7.182" class="difflineminus">-    nsresult rv = db-&gt;GetMsgHdrForKey(m_keyArray[i], getter_AddRefs(hdr));</span>
<a href="#l7.183"></a><span id="l7.183" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.184"></a><span id="l7.184" class="difflineminus">-    hdr-&gt;GetProperty(&quot;pendingRemoval&quot;, pendingRemoval);</span>
<a href="#l7.185"></a><span id="l7.185" class="difflineminus">-    if (!pendingRemoval.IsEmpty())</span>
<a href="#l7.186"></a><span id="l7.186" class="difflineminus">-    {</span>
<a href="#l7.187"></a><span id="l7.187" class="difflineminus">-      m_keyArray.RemoveElementAt(i);</span>
<a href="#l7.188"></a><span id="l7.188" class="difflineminus">-      // Turn off offline flag for message, since after the compact is completed;</span>
<a href="#l7.189"></a><span id="l7.189" class="difflineminus">-      // we won't have the message in the offline store.</span>
<a href="#l7.190"></a><span id="l7.190" class="difflineminus">-      PRUint32 resultFlags;</span>
<a href="#l7.191"></a><span id="l7.191" class="difflineminus">-      hdr-&gt;AndFlags(~nsMsgMessageFlags::Offline, &amp;resultFlags);</span>
<a href="#l7.192"></a><span id="l7.192" class="difflineminus">-      // We need to clear this in case the user changes the offline retention</span>
<a href="#l7.193"></a><span id="l7.193" class="difflineminus">-      // settings.</span>
<a href="#l7.194"></a><span id="l7.194" class="difflineminus">-      hdr-&gt;SetStringProperty(&quot;pendingRemoval&quot;, &quot;&quot;);</span>
<a href="#l7.195"></a><span id="l7.195" class="difflineminus">-    }</span>
<a href="#l7.196"></a><span id="l7.196" class="difflineminus">-  }</span>
<a href="#l7.197"></a><span id="l7.197" class="difflineplus">+  db-&gt;ListAllOfflineMsgs(m_keyArray);</span>
<a href="#l7.198"></a><span id="l7.198" class="difflineplus">+  m_size = m_keyArray-&gt;m_keys.Length();</span>
<a href="#l7.199"></a><span id="l7.199">   m_db = db;</span>
<a href="#l7.200"></a><span id="l7.200">   return NS_OK;</span>
<a href="#l7.201"></a><span id="l7.201"> }</span>
<a href="#l7.202"></a><span id="l7.202"> </span>
<a href="#l7.203"></a><span id="l7.203"> /**</span>
<a href="#l7.204"></a><span id="l7.204">  * This will copy one message to the offline store, but if it fails to</span>
<a href="#l7.205"></a><span id="l7.205">  * copy the next message, it will keep trying messages until it finds one</span>
<a href="#l7.206"></a><span id="l7.206">  * it can copy, or it runs out of messages.</span>
<a href="#l7.207"></a><span id="l7.207">  */</span>
<a href="#l7.208"></a><span id="l7.208"> nsresult nsOfflineStoreCompactState::CopyNextMessage(PRBool &amp;done)</span>
<a href="#l7.209"></a><span id="l7.209"> {</span>
<a href="#l7.210"></a><span id="l7.210">   while (m_curIndex &lt; m_size)</span>
<a href="#l7.211"></a><span id="l7.211">   {</span>
<a href="#l7.212"></a><span id="l7.212" class="difflineplus">+    // Filter out msgs that have the &quot;pendingRemoval&quot; attribute set.</span>
<a href="#l7.213"></a><span id="l7.213" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDBHdr&gt; hdr;</span>
<a href="#l7.214"></a><span id="l7.214" class="difflineplus">+    nsString pendingRemoval;</span>
<a href="#l7.215"></a><span id="l7.215" class="difflineplus">+    nsresult rv = m_db-&gt;GetMsgHdrForKey(m_keyArray-&gt;m_keys[m_curIndex], getter_AddRefs(hdr));</span>
<a href="#l7.216"></a><span id="l7.216" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.217"></a><span id="l7.217" class="difflineplus">+    hdr-&gt;GetProperty(&quot;pendingRemoval&quot;, pendingRemoval);</span>
<a href="#l7.218"></a><span id="l7.218" class="difflineplus">+    if (!pendingRemoval.IsEmpty())</span>
<a href="#l7.219"></a><span id="l7.219" class="difflineplus">+    {</span>
<a href="#l7.220"></a><span id="l7.220" class="difflineplus">+      m_curIndex++;</span>
<a href="#l7.221"></a><span id="l7.221" class="difflineplus">+      // Turn off offline flag for message, since after the compact is completed;</span>
<a href="#l7.222"></a><span id="l7.222" class="difflineplus">+      // we won't have the message in the offline store.</span>
<a href="#l7.223"></a><span id="l7.223" class="difflineplus">+      PRUint32 resultFlags;</span>
<a href="#l7.224"></a><span id="l7.224" class="difflineplus">+      hdr-&gt;AndFlags(~nsMsgMessageFlags::Offline, &amp;resultFlags);</span>
<a href="#l7.225"></a><span id="l7.225" class="difflineplus">+      // We need to clear this in case the user changes the offline retention</span>
<a href="#l7.226"></a><span id="l7.226" class="difflineplus">+      // settings.</span>
<a href="#l7.227"></a><span id="l7.227" class="difflineplus">+      hdr-&gt;SetStringProperty(&quot;pendingRemoval&quot;, &quot;&quot;);</span>
<a href="#l7.228"></a><span id="l7.228" class="difflineplus">+      continue;</span>
<a href="#l7.229"></a><span id="l7.229" class="difflineplus">+    }</span>
<a href="#l7.230"></a><span id="l7.230">     m_messageUri.Truncate(); // clear the previous message uri</span>
<a href="#l7.231"></a><span id="l7.231" class="difflineminus">-    nsresult rv = BuildMessageURI(m_baseMessageUri.get(), m_keyArray[m_curIndex],</span>
<a href="#l7.232"></a><span id="l7.232" class="difflineplus">+    rv = BuildMessageURI(m_baseMessageUri.get(), m_keyArray-&gt;m_keys[m_curIndex],</span>
<a href="#l7.233"></a><span id="l7.233">                                   m_messageUri);</span>
<a href="#l7.234"></a><span id="l7.234">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.235"></a><span id="l7.235">     m_startOfMsg = PR_TRUE;</span>
<a href="#l7.236"></a><span id="l7.236">     nsCOMPtr&lt;nsISupports&gt; thisSupports;</span>
<a href="#l7.237"></a><span id="l7.237">     QueryInterface(NS_GET_IID(nsISupports), getter_AddRefs(thisSupports));</span>
<a href="#l7.238"></a><span id="l7.238">     rv = m_messageService-&gt;StreamMessage(m_messageUri.get(), thisSupports, m_window, nsnull,</span>
<a href="#l7.239"></a><span id="l7.239">                                     PR_FALSE, EmptyCString(), PR_TRUE, nsnull);</span>
<a href="#l7.240"></a><span id="l7.240">     // if copy fails, we clear the offline flag on the source message.</span>
<a href="#l7.241"></a><span id="l7.241" class="difflineat">@@ -1178,17 +1179,17 @@ nsOfflineStoreCompactState::OnDataAvaila</span>
<a href="#l7.242"></a><span id="l7.242"> </span>
<a href="#l7.243"></a><span id="l7.243">   nsresult rv = NS_OK;</span>
<a href="#l7.244"></a><span id="l7.244"> </span>
<a href="#l7.245"></a><span id="l7.245">   if (m_startOfMsg)</span>
<a href="#l7.246"></a><span id="l7.246">   {</span>
<a href="#l7.247"></a><span id="l7.247">     m_statusOffset = 0;</span>
<a href="#l7.248"></a><span id="l7.248">     m_offlineMsgSize = 0;</span>
<a href="#l7.249"></a><span id="l7.249">     m_messageUri.Truncate(); // clear the previous message uri</span>
<a href="#l7.250"></a><span id="l7.250" class="difflineminus">-    if (NS_SUCCEEDED(BuildMessageURI(m_baseMessageUri.get(), m_keyArray[m_curIndex],</span>
<a href="#l7.251"></a><span id="l7.251" class="difflineplus">+    if (NS_SUCCEEDED(BuildMessageURI(m_baseMessageUri.get(), m_keyArray-&gt;m_keys[m_curIndex],</span>
<a href="#l7.252"></a><span id="l7.252">                                 m_messageUri)))</span>
<a href="#l7.253"></a><span id="l7.253">     {</span>
<a href="#l7.254"></a><span id="l7.254">       rv = GetMessage(getter_AddRefs(m_curSrcHdr));</span>
<a href="#l7.255"></a><span id="l7.255">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.256"></a><span id="l7.256">     }</span>
<a href="#l7.257"></a><span id="l7.257">   }</span>
<a href="#l7.258"></a><span id="l7.258">   PRUint32 maxReadCount, readCount, writeCount;</span>
<a href="#l7.259"></a><span id="l7.259">   PRUint32 bytesWritten;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/base/src/nsMsgFolderCompactor.h</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgFolderCompactor.h</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -38,16 +38,17 @@</span>
<a href="#l8.4"></a><span id="l8.4"> #ifndef _nsMsgFolderCompactor_h</span>
<a href="#l8.5"></a><span id="l8.5"> #define _nsMsgFolderCompactor_h</span>
<a href="#l8.6"></a><span id="l8.6"> </span>
<a href="#l8.7"></a><span id="l8.7"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l8.8"></a><span id="l8.8"> #include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l8.9"></a><span id="l8.9"> #include &quot;nsIStreamListener.h&quot;</span>
<a href="#l8.10"></a><span id="l8.10"> #include &quot;nsIMsgFolderCompactor.h&quot;</span>
<a href="#l8.11"></a><span id="l8.11"> #include &quot;nsICopyMsgStreamListener.h&quot;</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+#include &quot;nsMsgKeyArray.h&quot;</span>
<a href="#l8.13"></a><span id="l8.13"> #include &quot;nsIMsgWindow.h&quot;</span>
<a href="#l8.14"></a><span id="l8.14"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l8.15"></a><span id="l8.15"> #include &quot;nsIMsgMessageService.h&quot;</span>
<a href="#l8.16"></a><span id="l8.16"> </span>
<a href="#l8.17"></a><span id="l8.17"> #define COMPACTOR_READ_BUFF_SIZE 16384</span>
<a href="#l8.18"></a><span id="l8.18"> </span>
<a href="#l8.19"></a><span id="l8.19"> class nsFolderCompactState : public nsIMsgFolderCompactor,</span>
<a href="#l8.20"></a><span id="l8.20">                              public nsIStreamListener,</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineat">@@ -83,18 +84,19 @@ protected:</span>
<a href="#l8.22"></a><span id="l8.22">   nsresult CompactNextFolder();</span>
<a href="#l8.23"></a><span id="l8.23"> </span>
<a href="#l8.24"></a><span id="l8.24">   nsCString m_baseMessageUri; // base message uri</span>
<a href="#l8.25"></a><span id="l8.25">   nsCString m_messageUri; // current message uri being copy</span>
<a href="#l8.26"></a><span id="l8.26">   nsCOMPtr&lt;nsIMsgFolder&gt; m_folder; // current folder being compact</span>
<a href="#l8.27"></a><span id="l8.27">   nsCOMPtr&lt;nsIMsgDatabase&gt; m_db; // new database for the compact folder</span>
<a href="#l8.28"></a><span id="l8.28">   nsCOMPtr &lt;nsILocalFile&gt; m_file; // new mailbox for the compact folder</span>
<a href="#l8.29"></a><span id="l8.29">   nsCOMPtr &lt;nsIOutputStream&gt; m_fileStream; // output file stream for writing</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineminus">-  nsTArray&lt;nsMsgKey&gt; m_keyArray; // all message keys need to be copied over</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-  PRInt32 m_size; // size of the message key array</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+  // all message keys that need to be copied over</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineplus">+  nsRefPtr&lt;nsMsgKeyArray&gt; m_keyArray;</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+  PRUint32 m_size;</span>
<a href="#l8.35"></a><span id="l8.35"> </span>
<a href="#l8.36"></a><span id="l8.36">    // sum of the sizes of the messages, accumulated as we visit each msg.</span>
<a href="#l8.37"></a><span id="l8.37">   PRUint32 m_totalMsgSize;</span>
<a href="#l8.38"></a><span id="l8.38"> </span>
<a href="#l8.39"></a><span id="l8.39">   PRInt32 m_curIndex; // index of the current copied message key in key array</span>
<a href="#l8.40"></a><span id="l8.40">   PRUint64 m_startOfNewMsg; // offset in mailbox of new message</span>
<a href="#l8.41"></a><span id="l8.41">   char m_dataBuffer[COMPACTOR_READ_BUFF_SIZE + 1]; // temp data buffer for copying message</span>
<a href="#l8.42"></a><span id="l8.42">   nsresult m_status; // the status of the copying operation</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/base/util/Makefile.in</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/base/util/Makefile.in</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -47,16 +47,17 @@ LIBRARY_NAME	= msgbsutl_s</span>
<a href="#l9.4"></a><span id="l9.4"> ifndef MOZ_INCOMPLETE_EXTERNAL_LINKAGE</span>
<a href="#l9.5"></a><span id="l9.5"> MOZILLA_INTERNAL_API = 1</span>
<a href="#l9.6"></a><span id="l9.6"> LIBXUL_LIBRARY = 1</span>
<a href="#l9.7"></a><span id="l9.7"> endif</span>
<a href="#l9.8"></a><span id="l9.8"> </span>
<a href="#l9.9"></a><span id="l9.9"> CPPSRCS		= \</span>
<a href="#l9.10"></a><span id="l9.10"> 		nsMsgLineBuffer.cpp \</span>
<a href="#l9.11"></a><span id="l9.11"> 		nsMsgDBFolder.cpp \</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+		nsMsgKeyArray.cpp \</span>
<a href="#l9.13"></a><span id="l9.13"> 		nsMsgKeySet.cpp \</span>
<a href="#l9.14"></a><span id="l9.14"> 		nsMsgIdentity.cpp \</span>
<a href="#l9.15"></a><span id="l9.15"> 		nsMsgIncomingServer.cpp \</span>
<a href="#l9.16"></a><span id="l9.16"> 		nsMsgUtils.cpp \</span>
<a href="#l9.17"></a><span id="l9.17"> 		nsMsgProtocol.cpp \</span>
<a href="#l9.18"></a><span id="l9.18"> 		nsMsgMailNewsUrl.cpp \</span>
<a href="#l9.19"></a><span id="l9.19"> 		nsMsgTxn.cpp \</span>
<a href="#l9.20"></a><span id="l9.20"> 		nsMsgI18N.cpp \</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineat">@@ -65,16 +66,17 @@ CPPSRCS		= \</span>
<a href="#l9.22"></a><span id="l9.22"> 		nsMsgCompressIStream.cpp \</span>
<a href="#l9.23"></a><span id="l9.23"> 		nsMsgCompressOStream.cpp \</span>
<a href="#l9.24"></a><span id="l9.24"> 		nsMsgReadStateTxn.cpp \</span>
<a href="#l9.25"></a><span id="l9.25"> 		nsStopwatch.cpp \</span>
<a href="#l9.26"></a><span id="l9.26"> 		$(NULL)</span>
<a href="#l9.27"></a><span id="l9.27"> </span>
<a href="#l9.28"></a><span id="l9.28"> EXPORTS		= \</span>
<a href="#l9.29"></a><span id="l9.29"> 		nsMsgLineBuffer.h \</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineplus">+		nsMsgKeyArray.h \</span>
<a href="#l9.31"></a><span id="l9.31"> 		nsMsgKeySet.h \</span>
<a href="#l9.32"></a><span id="l9.32"> 		nsMsgDBFolder.h \</span>
<a href="#l9.33"></a><span id="l9.33"> 		nsMsgDBFolderAtomList.h \</span>
<a href="#l9.34"></a><span id="l9.34"> 		nsMsgIdentity.h \</span>
<a href="#l9.35"></a><span id="l9.35"> 		nsMsgIncomingServer.h \</span>
<a href="#l9.36"></a><span id="l9.36"> 		nsMsgUtils.h \</span>
<a href="#l9.37"></a><span id="l9.37"> 		nsMsgProtocol.h \</span>
<a href="#l9.38"></a><span id="l9.38"> 		nsMsgMailNewsUrl.h \</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/base/util/nsMsgDBFolder.cpp</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgDBFolder.cpp</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -1410,62 +1410,74 @@ nsMsgDBFolder::AddMessageDispositionStat</span>
<a href="#l10.4"></a><span id="l10.4"> </span>
<a href="#l10.5"></a><span id="l10.5">   if (aDispositionFlag == nsIMsgFolder::nsMsgDispositionState_Replied)</span>
<a href="#l10.6"></a><span id="l10.6">     mDatabase-&gt;MarkReplied(msgKey, PR_TRUE, nsnull);</span>
<a href="#l10.7"></a><span id="l10.7">   else if (aDispositionFlag == nsIMsgFolder::nsMsgDispositionState_Forwarded)</span>
<a href="#l10.8"></a><span id="l10.8">     mDatabase-&gt;MarkForwarded(msgKey, PR_TRUE, nsnull);</span>
<a href="#l10.9"></a><span id="l10.9">   return NS_OK;</span>
<a href="#l10.10"></a><span id="l10.10"> }</span>
<a href="#l10.11"></a><span id="l10.11"> </span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+nsresult nsMsgDBFolder::AddMarkAllReadUndoAction(nsIMsgWindow *msgWindow,</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+                                                 nsMsgKey *thoseMarked,</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+                                                 PRUint32 numMarked)</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+{</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+  nsRefPtr&lt;nsMsgReadStateTxn&gt; readStateTxn = new nsMsgReadStateTxn();</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineplus">+  if (!readStateTxn)</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineplus">+    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineplus">+</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineplus">+  nsresult rv = readStateTxn-&gt;Init(this, numMarked, thoseMarked);</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineplus">+</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineplus">+  rv = readStateTxn-&gt;SetTransactionType(nsIMessenger::eMarkAllMsg);</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineplus">+</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineplus">+  nsCOMPtr&lt;nsITransactionManager&gt; txnMgr;</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineplus">+  rv = msgWindow-&gt;GetTransactionManager(getter_AddRefs(txnMgr));</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineplus">+</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineplus">+  rv = txnMgr-&gt;DoTransaction(readStateTxn);</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineplus">+  return rv;</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineplus">+}</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineplus">+</span>
<a href="#l10.35"></a><span id="l10.35"> NS_IMETHODIMP</span>
<a href="#l10.36"></a><span id="l10.36"> nsMsgDBFolder::MarkAllMessagesRead(nsIMsgWindow *aMsgWindow)</span>
<a href="#l10.37"></a><span id="l10.37"> {</span>
<a href="#l10.38"></a><span id="l10.38">   nsresult rv = GetDatabase();</span>
<a href="#l10.39"></a><span id="l10.39">   m_newMsgs.Clear();</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineminus">-  </span>
<a href="#l10.41"></a><span id="l10.41" class="difflineplus">+</span>
<a href="#l10.42"></a><span id="l10.42">   if (NS_SUCCEEDED(rv))</span>
<a href="#l10.43"></a><span id="l10.43">   {</span>
<a href="#l10.44"></a><span id="l10.44">     EnableNotifications(allMessageCountNotifications, PR_FALSE, PR_TRUE /*dbBatching*/);</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineminus">-    nsTArray&lt;nsMsgKey&gt; thoseMarked;</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineminus">-    rv = mDatabase-&gt;MarkAllRead(&amp;thoseMarked);</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineplus">+    nsMsgKey *thoseMarked;</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineplus">+    PRUint32 numMarked;</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineplus">+    rv = mDatabase-&gt;MarkAllRead(&amp;numMarked, &amp;thoseMarked);</span>
<a href="#l10.50"></a><span id="l10.50">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.51"></a><span id="l10.51">     EnableNotifications(allMessageCountNotifications, PR_TRUE, PR_TRUE /*dbBatching*/);</span>
<a href="#l10.52"></a><span id="l10.52"> </span>
<a href="#l10.53"></a><span id="l10.53">     // Setup a undo-state</span>
<a href="#l10.54"></a><span id="l10.54">     if (aMsgWindow)</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineminus">-    {</span>
<a href="#l10.56"></a><span id="l10.56" class="difflineminus">-      nsRefPtr&lt;nsMsgReadStateTxn&gt; readStateTxn = new nsMsgReadStateTxn();</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineminus">-      if (!readStateTxn)</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineminus">-        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineminus">-</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineminus">-      rv = readStateTxn-&gt;Init(this, thoseMarked);</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineminus">-</span>
<a href="#l10.63"></a><span id="l10.63" class="difflineminus">-      rv = readStateTxn-&gt;SetTransactionType(nsIMessenger::eMarkAllMsg);</span>
<a href="#l10.64"></a><span id="l10.64" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.65"></a><span id="l10.65" class="difflineminus">-</span>
<a href="#l10.66"></a><span id="l10.66" class="difflineminus">-      nsCOMPtr&lt;nsITransactionManager&gt; txnMgr;</span>
<a href="#l10.67"></a><span id="l10.67" class="difflineminus">-      rv = aMsgWindow-&gt;GetTransactionManager(getter_AddRefs(txnMgr));</span>
<a href="#l10.68"></a><span id="l10.68" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.69"></a><span id="l10.69" class="difflineminus">-</span>
<a href="#l10.70"></a><span id="l10.70" class="difflineminus">-      rv = txnMgr-&gt;DoTransaction(readStateTxn);</span>
<a href="#l10.71"></a><span id="l10.71" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.72"></a><span id="l10.72" class="difflineminus">-    }</span>
<a href="#l10.73"></a><span id="l10.73" class="difflineplus">+      rv = AddMarkAllReadUndoAction(aMsgWindow, thoseMarked, numMarked);</span>
<a href="#l10.74"></a><span id="l10.74" class="difflineplus">+    nsMemory::Free(thoseMarked);</span>
<a href="#l10.75"></a><span id="l10.75">   }</span>
<a href="#l10.76"></a><span id="l10.76"> </span>
<a href="#l10.77"></a><span id="l10.77">   SetHasNewMessages(PR_FALSE);</span>
<a href="#l10.78"></a><span id="l10.78" class="difflineminus">- </span>
<a href="#l10.79"></a><span id="l10.79">   return rv;</span>
<a href="#l10.80"></a><span id="l10.80"> }</span>
<a href="#l10.81"></a><span id="l10.81"> </span>
<a href="#l10.82"></a><span id="l10.82"> NS_IMETHODIMP nsMsgDBFolder::MarkThreadRead(nsIMsgThread *thread)</span>
<a href="#l10.83"></a><span id="l10.83"> {</span>
<a href="#l10.84"></a><span id="l10.84">   nsresult rv = GetDatabase();</span>
<a href="#l10.85"></a><span id="l10.85">   if(NS_SUCCEEDED(rv))</span>
<a href="#l10.86"></a><span id="l10.86" class="difflineminus">-    return mDatabase-&gt;MarkThreadRead(thread, nsnull, nsnull);</span>
<a href="#l10.87"></a><span id="l10.87" class="difflineplus">+  {</span>
<a href="#l10.88"></a><span id="l10.88" class="difflineplus">+    nsMsgKey *keys;</span>
<a href="#l10.89"></a><span id="l10.89" class="difflineplus">+    PRUint32 numKeys;</span>
<a href="#l10.90"></a><span id="l10.90" class="difflineplus">+    rv = mDatabase-&gt;MarkThreadRead(thread, nsnull, &amp;numKeys, &amp;keys);</span>
<a href="#l10.91"></a><span id="l10.91" class="difflineplus">+    nsMemory::Free(keys);</span>
<a href="#l10.92"></a><span id="l10.92" class="difflineplus">+  }</span>
<a href="#l10.93"></a><span id="l10.93">   return rv;</span>
<a href="#l10.94"></a><span id="l10.94"> }</span>
<a href="#l10.95"></a><span id="l10.95"> </span>
<a href="#l10.96"></a><span id="l10.96"> NS_IMETHODIMP</span>
<a href="#l10.97"></a><span id="l10.97"> nsMsgDBFolder::OnStartRunningUrl(nsIURI *aUrl)</span>
<a href="#l10.98"></a><span id="l10.98"> {</span>
<a href="#l10.99"></a><span id="l10.99">   return NS_OK;</span>
<a href="#l10.100"></a><span id="l10.100"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/base/util/nsMsgDBFolder.h</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgDBFolder.h</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -163,16 +163,18 @@ protected:</span>
<a href="#l11.4"></a><span id="l11.4">   nsresult CompactOfflineStore(nsIMsgWindow *inWindow, nsIUrlListener *aUrlListener);</span>
<a href="#l11.5"></a><span id="l11.5">   nsresult AutoCompact(nsIMsgWindow *aWindow);</span>
<a href="#l11.6"></a><span id="l11.6">   // this is a helper routine that ignores whether nsMsgMessageFlags::Offline is set for the folder</span>
<a href="#l11.7"></a><span id="l11.7">   nsresult MsgFitsDownloadCriteria(nsMsgKey msgKey, PRBool *result);</span>
<a href="#l11.8"></a><span id="l11.8">   nsresult GetPromptPurgeThreshold(PRBool *aPrompt);</span>
<a href="#l11.9"></a><span id="l11.9">   nsresult GetPurgeThreshold(PRInt32 *aThreshold);</span>
<a href="#l11.10"></a><span id="l11.10">   nsresult ApplyRetentionSettings(PRBool deleteViaFolder);</span>
<a href="#l11.11"></a><span id="l11.11">   PRBool   VerifyOfflineMessage(nsIMsgDBHdr *msgHdr, nsIInputStream *fileStream);</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+  nsresult AddMarkAllReadUndoAction(nsIMsgWindow *msgWindow,</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+                                    nsMsgKey *thoseMarked, PRUint32 numMarked);</span>
<a href="#l11.14"></a><span id="l11.14"> </span>
<a href="#l11.15"></a><span id="l11.15">   nsresult PerformBiffNotifications(void); // if there are new, non spam messages, do biff</span>
<a href="#l11.16"></a><span id="l11.16">   nsresult CloseDBIfFolderNotOpen();</span>
<a href="#l11.17"></a><span id="l11.17"> </span>
<a href="#l11.18"></a><span id="l11.18">   virtual nsresult SpamFilterClassifyMessage(const char *aURI, nsIMsgWindow *aMsgWindow, nsIJunkMailPlugin *aJunkMailPlugin);</span>
<a href="#l11.19"></a><span id="l11.19">   virtual nsresult SpamFilterClassifyMessages(const char **aURIArray, PRUint32 aURICount, nsIMsgWindow *aMsgWindow, nsIJunkMailPlugin *aJunkMailPlugin);</span>
<a href="#l11.20"></a><span id="l11.20">   // Helper function for Move code to call to update the MRU and MRM time.</span>
<a href="#l11.21"></a><span id="l11.21">   void    UpdateTimestamps(PRBool allowUndo);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1">new file mode 100644</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineminus">--- /dev/null</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineplus">+++ b/mailnews/base/util/nsMsgKeyArray.cpp</span>
<a href="#l12.4"></a><span id="l12.4" class="difflineat">@@ -0,0 +1,94 @@</span>
<a href="#l12.5"></a><span id="l12.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l12.6"></a><span id="l12.6" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l12.7"></a><span id="l12.7" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l12.8"></a><span id="l12.8" class="difflineplus">+ *</span>
<a href="#l12.9"></a><span id="l12.9" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l12.10"></a><span id="l12.10" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l12.11"></a><span id="l12.11" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+ *</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineplus">+ * License.</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineplus">+ *</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineplus">+ * The Original Code is MailNews nsMsgKeyArray</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineplus">+ *</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineplus">+ * the Mozilla Foundation.</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2011</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineplus">+ *</span>
<a href="#l12.26"></a><span id="l12.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l12.27"></a><span id="l12.27" class="difflineplus">+ *   David Bienvenu &lt;bienvenu@mozilla.com&gt;</span>
<a href="#l12.28"></a><span id="l12.28" class="difflineplus">+ *</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineplus">+ * either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineplus">+ * or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l12.40"></a><span id="l12.40" class="difflineplus">+ *</span>
<a href="#l12.41"></a><span id="l12.41" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l12.42"></a><span id="l12.42" class="difflineplus">+</span>
<a href="#l12.43"></a><span id="l12.43" class="difflineplus">+#include &quot;nsMsgKeyArray.h&quot;</span>
<a href="#l12.44"></a><span id="l12.44" class="difflineplus">+#include &quot;nsMemory.h&quot;</span>
<a href="#l12.45"></a><span id="l12.45" class="difflineplus">+</span>
<a href="#l12.46"></a><span id="l12.46" class="difflineplus">+NS_IMPL_ISUPPORTS1(nsMsgKeyArray, nsIMsgKeyArray)</span>
<a href="#l12.47"></a><span id="l12.47" class="difflineplus">+</span>
<a href="#l12.48"></a><span id="l12.48" class="difflineplus">+nsMsgKeyArray::nsMsgKeyArray()</span>
<a href="#l12.49"></a><span id="l12.49" class="difflineplus">+{</span>
<a href="#l12.50"></a><span id="l12.50" class="difflineplus">+}</span>
<a href="#l12.51"></a><span id="l12.51" class="difflineplus">+</span>
<a href="#l12.52"></a><span id="l12.52" class="difflineplus">+nsMsgKeyArray::~nsMsgKeyArray()</span>
<a href="#l12.53"></a><span id="l12.53" class="difflineplus">+{</span>
<a href="#l12.54"></a><span id="l12.54" class="difflineplus">+}</span>
<a href="#l12.55"></a><span id="l12.55" class="difflineplus">+</span>
<a href="#l12.56"></a><span id="l12.56" class="difflineplus">+NS_IMETHODIMP nsMsgKeyArray::Sort()</span>
<a href="#l12.57"></a><span id="l12.57" class="difflineplus">+{</span>
<a href="#l12.58"></a><span id="l12.58" class="difflineplus">+  m_keys.Sort();</span>
<a href="#l12.59"></a><span id="l12.59" class="difflineplus">+  return NS_OK;</span>
<a href="#l12.60"></a><span id="l12.60" class="difflineplus">+}</span>
<a href="#l12.61"></a><span id="l12.61" class="difflineplus">+</span>
<a href="#l12.62"></a><span id="l12.62" class="difflineplus">+NS_IMETHODIMP nsMsgKeyArray::GetKeyAt(PRInt32 aIndex, nsMsgKey *aKey)</span>
<a href="#l12.63"></a><span id="l12.63" class="difflineplus">+{</span>
<a href="#l12.64"></a><span id="l12.64" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aKey);</span>
<a href="#l12.65"></a><span id="l12.65" class="difflineplus">+  *aKey = m_keys[aIndex];</span>
<a href="#l12.66"></a><span id="l12.66" class="difflineplus">+  return NS_OK;</span>
<a href="#l12.67"></a><span id="l12.67" class="difflineplus">+}</span>
<a href="#l12.68"></a><span id="l12.68" class="difflineplus">+</span>
<a href="#l12.69"></a><span id="l12.69" class="difflineplus">+NS_IMETHODIMP nsMsgKeyArray::GetLength(PRUint32 *aLength)</span>
<a href="#l12.70"></a><span id="l12.70" class="difflineplus">+{</span>
<a href="#l12.71"></a><span id="l12.71" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aLength);</span>
<a href="#l12.72"></a><span id="l12.72" class="difflineplus">+  *aLength = m_keys.Length();</span>
<a href="#l12.73"></a><span id="l12.73" class="difflineplus">+  return NS_OK;</span>
<a href="#l12.74"></a><span id="l12.74" class="difflineplus">+}</span>
<a href="#l12.75"></a><span id="l12.75" class="difflineplus">+</span>
<a href="#l12.76"></a><span id="l12.76" class="difflineplus">+NS_IMETHODIMP nsMsgKeyArray::SetCapacity(PRUint32 aCapacity)</span>
<a href="#l12.77"></a><span id="l12.77" class="difflineplus">+{</span>
<a href="#l12.78"></a><span id="l12.78" class="difflineplus">+  m_keys.SetCapacity(aCapacity);</span>
<a href="#l12.79"></a><span id="l12.79" class="difflineplus">+  return NS_OK;</span>
<a href="#l12.80"></a><span id="l12.80" class="difflineplus">+}</span>
<a href="#l12.81"></a><span id="l12.81" class="difflineplus">+</span>
<a href="#l12.82"></a><span id="l12.82" class="difflineplus">+NS_IMETHODIMP nsMsgKeyArray::AppendElement(nsMsgKey aKey)</span>
<a href="#l12.83"></a><span id="l12.83" class="difflineplus">+{</span>
<a href="#l12.84"></a><span id="l12.84" class="difflineplus">+  m_keys.AppendElement(aKey);</span>
<a href="#l12.85"></a><span id="l12.85" class="difflineplus">+  return NS_OK;</span>
<a href="#l12.86"></a><span id="l12.86" class="difflineplus">+}</span>
<a href="#l12.87"></a><span id="l12.87" class="difflineplus">+</span>
<a href="#l12.88"></a><span id="l12.88" class="difflineplus">+NS_IMETHODIMP nsMsgKeyArray::GetArray(PRUint32 *aCount, nsMsgKey **aKeys)</span>
<a href="#l12.89"></a><span id="l12.89" class="difflineplus">+{</span>
<a href="#l12.90"></a><span id="l12.90" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aCount);</span>
<a href="#l12.91"></a><span id="l12.91" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aKeys);</span>
<a href="#l12.92"></a><span id="l12.92" class="difflineplus">+  *aCount = m_keys.Length();</span>
<a href="#l12.93"></a><span id="l12.93" class="difflineplus">+  *aKeys =</span>
<a href="#l12.94"></a><span id="l12.94" class="difflineplus">+    (nsMsgKey *) nsMemory::Clone(&amp;m_keys[0],</span>
<a href="#l12.95"></a><span id="l12.95" class="difflineplus">+                                 m_keys.Length() * sizeof(nsMsgKey));</span>
<a href="#l12.96"></a><span id="l12.96" class="difflineplus">+  return (*aKeys) ? NS_OK : NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l12.97"></a><span id="l12.97" class="difflineplus">+}</span>
<a href="#l12.98"></a><span id="l12.98" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1">new file mode 100644</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineminus">--- /dev/null</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineplus">+++ b/mailnews/base/util/nsMsgKeyArray.h</span>
<a href="#l13.4"></a><span id="l13.4" class="difflineat">@@ -0,0 +1,60 @@</span>
<a href="#l13.5"></a><span id="l13.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l13.6"></a><span id="l13.6" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l13.7"></a><span id="l13.7" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l13.8"></a><span id="l13.8" class="difflineplus">+ *</span>
<a href="#l13.9"></a><span id="l13.9" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l13.10"></a><span id="l13.10" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l13.11"></a><span id="l13.11" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+ *</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineplus">+ * License.</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineplus">+ *</span>
<a href="#l13.19"></a><span id="l13.19" class="difflineplus">+ * The Original Code is MailNews nsMsgKeyArray</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineplus">+ *</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineplus">+ * the Mozilla Foundation.</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2011</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineplus">+ *</span>
<a href="#l13.26"></a><span id="l13.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineplus">+ *   David Bienvenu &lt;bienvenu@mozilla.com&gt;</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineplus">+ *</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineplus">+ * either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineplus">+ * or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineplus">+ *</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineplus">+</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineplus">+#ifndef nsMsgKeyArray_h__</span>
<a href="#l13.44"></a><span id="l13.44" class="difflineplus">+#define nsMsgKeyArray_h__</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineplus">+</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineplus">+#include &quot;nsIMsgKeyArray.h&quot;</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineplus">+#include &quot;nsTArray.h&quot;</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineplus">+</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineplus">+/*</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineplus">+ * This class is a thin wrapper around an nsTArray&lt;nsMsgKey&gt;</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineplus">+ */</span>
<a href="#l13.52"></a><span id="l13.52" class="difflineplus">+class nsMsgKeyArray : public nsIMsgKeyArray</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineplus">+{</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineplus">+public:</span>
<a href="#l13.55"></a><span id="l13.55" class="difflineplus">+  nsMsgKeyArray();</span>
<a href="#l13.56"></a><span id="l13.56" class="difflineplus">+  virtual ~nsMsgKeyArray();</span>
<a href="#l13.57"></a><span id="l13.57" class="difflineplus">+</span>
<a href="#l13.58"></a><span id="l13.58" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l13.59"></a><span id="l13.59" class="difflineplus">+  NS_DECL_NSIMSGKEYARRAY</span>
<a href="#l13.60"></a><span id="l13.60" class="difflineplus">+</span>
<a href="#l13.61"></a><span id="l13.61" class="difflineplus">+  nsTArray&lt;nsMsgKey&gt; m_keys;</span>
<a href="#l13.62"></a><span id="l13.62" class="difflineplus">+};</span>
<a href="#l13.63"></a><span id="l13.63" class="difflineplus">+</span>
<a href="#l13.64"></a><span id="l13.64" class="difflineplus">+#endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/base/util/nsMsgReadStateTxn.cpp</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgReadStateTxn.cpp</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -47,23 +47,24 @@ nsMsgReadStateTxn::nsMsgReadStateTxn()</span>
<a href="#l14.4"></a><span id="l14.4"> {</span>
<a href="#l14.5"></a><span id="l14.5"> }</span>
<a href="#l14.6"></a><span id="l14.6"> </span>
<a href="#l14.7"></a><span id="l14.7"> nsMsgReadStateTxn::~nsMsgReadStateTxn()</span>
<a href="#l14.8"></a><span id="l14.8"> {</span>
<a href="#l14.9"></a><span id="l14.9"> }</span>
<a href="#l14.10"></a><span id="l14.10"> </span>
<a href="#l14.11"></a><span id="l14.11"> nsresult</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-nsMsgReadStateTxn::Init(nsIMsgFolder *aParentFolder, </span>
<a href="#l14.13"></a><span id="l14.13" class="difflineminus">-                        nsTArray&lt;nsMsgKey&gt; &amp; aMsgKeyArray)</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+nsMsgReadStateTxn::Init(nsIMsgFolder *aParentFolder,</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineplus">+                        PRUint32 aNumKeys,</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineplus">+                        nsMsgKey *aMsgKeyArray)</span>
<a href="#l14.17"></a><span id="l14.17"> {</span>
<a href="#l14.18"></a><span id="l14.18">   NS_ENSURE_ARG_POINTER(aParentFolder);</span>
<a href="#l14.19"></a><span id="l14.19"> </span>
<a href="#l14.20"></a><span id="l14.20">   mParentFolder = aParentFolder;</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineminus">-  aMsgKeyArray.SwapElements(mMarkedMessages);</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineplus">+  mMarkedMessages.AppendElements(aMsgKeyArray, aNumKeys);</span>
<a href="#l14.23"></a><span id="l14.23"> </span>
<a href="#l14.24"></a><span id="l14.24">   return nsMsgTxn::Init();</span>
<a href="#l14.25"></a><span id="l14.25"> }</span>
<a href="#l14.26"></a><span id="l14.26"> </span>
<a href="#l14.27"></a><span id="l14.27"> NS_IMETHODIMP </span>
<a href="#l14.28"></a><span id="l14.28"> nsMsgReadStateTxn::UndoTransaction()</span>
<a href="#l14.29"></a><span id="l14.29"> {</span>
<a href="#l14.30"></a><span id="l14.30">   return MarkMessages(PR_FALSE);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/base/util/nsMsgReadStateTxn.h</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgReadStateTxn.h</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -57,18 +57,19 @@</span>
<a href="#l15.4"></a><span id="l15.4"> // A mark-all transaction handler. Helper for redo/undo of message read states.</span>
<a href="#l15.5"></a><span id="l15.5"> //------------------------------------------------------------------------------</span>
<a href="#l15.6"></a><span id="l15.6"> class NS_MSG_BASE nsMsgReadStateTxn : public nsMsgTxn</span>
<a href="#l15.7"></a><span id="l15.7"> {</span>
<a href="#l15.8"></a><span id="l15.8"> public:</span>
<a href="#l15.9"></a><span id="l15.9">   nsMsgReadStateTxn();</span>
<a href="#l15.10"></a><span id="l15.10">   virtual ~nsMsgReadStateTxn();</span>
<a href="#l15.11"></a><span id="l15.11"> </span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-  nsresult Init(nsIMsgFolder *aParentFolder, </span>
<a href="#l15.13"></a><span id="l15.13" class="difflineminus">-                nsTArray&lt;nsMsgKey&gt; &amp; aMsgKeyArray);</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineplus">+  nsresult Init(nsIMsgFolder *aParentFolder,</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineplus">+                PRUint32 aNumKeys,</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineplus">+                nsMsgKey *aMsgKeyArray);</span>
<a href="#l15.17"></a><span id="l15.17">   NS_IMETHOD UndoTransaction();</span>
<a href="#l15.18"></a><span id="l15.18">   NS_IMETHOD RedoTransaction();</span>
<a href="#l15.19"></a><span id="l15.19"> </span>
<a href="#l15.20"></a><span id="l15.20"> protected:</span>
<a href="#l15.21"></a><span id="l15.21">   NS_IMETHOD MarkMessages(PRBool aAsRead);</span>
<a href="#l15.22"></a><span id="l15.22"> </span>
<a href="#l15.23"></a><span id="l15.23"> private:</span>
<a href="#l15.24"></a><span id="l15.24">   nsCOMPtr&lt;nsIMsgFolder&gt; mParentFolder;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/build/nsMailModule.cpp</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/build/nsMailModule.cpp</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -94,16 +94,17 @@</span>
<a href="#l16.4"></a><span id="l16.4"> #include &quot;nsMsgAccountManager.h&quot;</span>
<a href="#l16.5"></a><span id="l16.5"> #include &quot;nsMsgIdentity.h&quot;</span>
<a href="#l16.6"></a><span id="l16.6"> #include &quot;nsMsgIncomingServer.h&quot;</span>
<a href="#l16.7"></a><span id="l16.7"> #include &quot;nsMsgFolderDataSource.h&quot;</span>
<a href="#l16.8"></a><span id="l16.8"> #include &quot;nsMsgAccountManagerDS.h&quot;</span>
<a href="#l16.9"></a><span id="l16.9"> #include &quot;nsMsgBiffManager.h&quot;</span>
<a href="#l16.10"></a><span id="l16.10"> #include &quot;nsMsgPurgeService.h&quot;</span>
<a href="#l16.11"></a><span id="l16.11"> #include &quot;nsStatusBarBiffManager.h&quot;</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineplus">+#include &quot;nsMsgKeyArray.h&quot;</span>
<a href="#l16.13"></a><span id="l16.13"> #include &quot;nsCopyMessageStreamListener.h&quot;</span>
<a href="#l16.14"></a><span id="l16.14"> #include &quot;nsMsgCopyService.h&quot;</span>
<a href="#l16.15"></a><span id="l16.15"> #include &quot;nsMsgFolderCache.h&quot;</span>
<a href="#l16.16"></a><span id="l16.16"> #include &quot;nsMsgStatusFeedback.h&quot;</span>
<a href="#l16.17"></a><span id="l16.17"> #include &quot;nsMsgFilterService.h&quot;</span>
<a href="#l16.18"></a><span id="l16.18"> #include &quot;nsMsgWindow.h&quot;</span>
<a href="#l16.19"></a><span id="l16.19"> #include &quot;nsMsgServiceProvider.h&quot;</span>
<a href="#l16.20"></a><span id="l16.20"> #include &quot;nsSubscribeDataSource.h&quot;</span>
<a href="#l16.21"></a><span id="l16.21" class="difflineat">@@ -346,16 +347,17 @@ NS_GENERIC_FACTORY_CONSTRUCTOR(nsMsgSear</span>
<a href="#l16.22"></a><span id="l16.22"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsMsgFilterService)</span>
<a href="#l16.23"></a><span id="l16.23"> NS_GENERIC_FACTORY_CONSTRUCTOR_INIT(nsMsgBiffManager, Init)</span>
<a href="#l16.24"></a><span id="l16.24"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsMsgPurgeService)</span>
<a href="#l16.25"></a><span id="l16.25"> NS_GENERIC_FACTORY_CONSTRUCTOR_INIT(nsStatusBarBiffManager, Init)</span>
<a href="#l16.26"></a><span id="l16.26"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsCopyMessageStreamListener)</span>
<a href="#l16.27"></a><span id="l16.27"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsMsgCopyService)</span>
<a href="#l16.28"></a><span id="l16.28"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsMsgFolderCache)</span>
<a href="#l16.29"></a><span id="l16.29"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsMsgStatusFeedback)</span>
<a href="#l16.30"></a><span id="l16.30" class="difflineplus">+NS_GENERIC_FACTORY_CONSTRUCTOR(nsMsgKeyArray)</span>
<a href="#l16.31"></a><span id="l16.31"> NS_GENERIC_FACTORY_CONSTRUCTOR_INIT(nsMsgWindow,Init)</span>
<a href="#l16.32"></a><span id="l16.32"> NS_GENERIC_FACTORY_CONSTRUCTOR_INIT(nsMsgServiceProviderService, Init)</span>
<a href="#l16.33"></a><span id="l16.33"> NS_GENERIC_FACTORY_CONSTRUCTOR_INIT(nsSubscribeDataSource, Init)</span>
<a href="#l16.34"></a><span id="l16.34"> NS_GENERIC_FACTORY_CONSTRUCTOR_INIT(nsSubscribableServer, Init)</span>
<a href="#l16.35"></a><span id="l16.35"> #ifdef NS_PRINTING</span>
<a href="#l16.36"></a><span id="l16.36"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsMsgPrintEngine)</span>
<a href="#l16.37"></a><span id="l16.37"> #endif</span>
<a href="#l16.38"></a><span id="l16.38"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsFolderCompactState)</span>
<a href="#l16.39"></a><span id="l16.39" class="difflineat">@@ -411,16 +413,17 @@ NS_DEFINE_NAMED_CID(NS_MSGSEARCHVALIDITY</span>
<a href="#l16.40"></a><span id="l16.40"> NS_DEFINE_NAMED_CID(NS_MSGBIFFMANAGER_CID);</span>
<a href="#l16.41"></a><span id="l16.41"> NS_DEFINE_NAMED_CID(NS_MSGPURGESERVICE_CID);</span>
<a href="#l16.42"></a><span id="l16.42"> NS_DEFINE_NAMED_CID(NS_STATUSBARBIFFMANAGER_CID);</span>
<a href="#l16.43"></a><span id="l16.43"> NS_DEFINE_NAMED_CID(NS_COPYMESSAGESTREAMLISTENER_CID);</span>
<a href="#l16.44"></a><span id="l16.44"> NS_DEFINE_NAMED_CID(NS_MSGCOPYSERVICE_CID);</span>
<a href="#l16.45"></a><span id="l16.45"> NS_DEFINE_NAMED_CID(NS_MSGFOLDERCACHE_CID);</span>
<a href="#l16.46"></a><span id="l16.46"> NS_DEFINE_NAMED_CID(NS_MSGSTATUSFEEDBACK_CID);</span>
<a href="#l16.47"></a><span id="l16.47"> NS_DEFINE_NAMED_CID(NS_MSGWINDOW_CID);</span>
<a href="#l16.48"></a><span id="l16.48" class="difflineplus">+NS_DEFINE_NAMED_CID(NS_MSGKEYARRAY_CID);</span>
<a href="#l16.49"></a><span id="l16.49"> #ifdef NS_PRINTING</span>
<a href="#l16.50"></a><span id="l16.50"> NS_DEFINE_NAMED_CID(NS_MSG_PRINTENGINE_CID);</span>
<a href="#l16.51"></a><span id="l16.51"> #endif</span>
<a href="#l16.52"></a><span id="l16.52"> NS_DEFINE_NAMED_CID(NS_MSGSERVICEPROVIDERSERVICE_CID);</span>
<a href="#l16.53"></a><span id="l16.53"> NS_DEFINE_NAMED_CID(NS_SUBSCRIBEDATASOURCE_CID);</span>
<a href="#l16.54"></a><span id="l16.54"> NS_DEFINE_NAMED_CID(NS_SUBSCRIBABLESERVER_CID);</span>
<a href="#l16.55"></a><span id="l16.55"> NS_DEFINE_NAMED_CID(NS_MSGLOCALFOLDERCOMPACTOR_CID);</span>
<a href="#l16.56"></a><span id="l16.56"> NS_DEFINE_NAMED_CID(NS_MSG_OFFLINESTORECOMPACTOR_CID);</span>
<a href="#l16.57"></a><span id="l16.57" class="difflineat">@@ -806,16 +809,17 @@ const mozilla::Module::CIDEntry kMailNew</span>
<a href="#l16.58"></a><span id="l16.58">   { &amp;kNS_MSGSEARCHVALIDITYMANAGER_CID, false, NULL, nsMsgSearchValidityManagerConstructor},</span>
<a href="#l16.59"></a><span id="l16.59">   { &amp;kNS_MSGBIFFMANAGER_CID, false, NULL, nsMsgBiffManagerConstructor},</span>
<a href="#l16.60"></a><span id="l16.60">   { &amp;kNS_MSGPURGESERVICE_CID, false, NULL, nsMsgPurgeServiceConstructor},</span>
<a href="#l16.61"></a><span id="l16.61">   { &amp;kNS_STATUSBARBIFFMANAGER_CID, false, NULL, nsStatusBarBiffManagerConstructor},</span>
<a href="#l16.62"></a><span id="l16.62">   { &amp;kNS_COPYMESSAGESTREAMLISTENER_CID, false, NULL, nsCopyMessageStreamListenerConstructor},</span>
<a href="#l16.63"></a><span id="l16.63">   { &amp;kNS_MSGCOPYSERVICE_CID, false, NULL, nsMsgCopyServiceConstructor},</span>
<a href="#l16.64"></a><span id="l16.64">   { &amp;kNS_MSGFOLDERCACHE_CID, false, NULL, nsMsgFolderCacheConstructor},</span>
<a href="#l16.65"></a><span id="l16.65">   { &amp;kNS_MSGSTATUSFEEDBACK_CID, false, NULL, nsMsgStatusFeedbackConstructor},</span>
<a href="#l16.66"></a><span id="l16.66" class="difflineplus">+  { &amp;kNS_MSGKEYARRAY_CID, false, NULL, nsMsgKeyArrayConstructor},</span>
<a href="#l16.67"></a><span id="l16.67">   { &amp;kNS_MSGWINDOW_CID, false, NULL, nsMsgWindowConstructor},</span>
<a href="#l16.68"></a><span id="l16.68"> #ifdef NS_PRINTING</span>
<a href="#l16.69"></a><span id="l16.69">   { &amp;kNS_MSG_PRINTENGINE_CID, false, NULL, nsMsgPrintEngineConstructor},</span>
<a href="#l16.70"></a><span id="l16.70"> #endif</span>
<a href="#l16.71"></a><span id="l16.71">   { &amp;kNS_MSGSERVICEPROVIDERSERVICE_CID, false, NULL, nsMsgServiceProviderServiceConstructor},</span>
<a href="#l16.72"></a><span id="l16.72">   { &amp;kNS_SUBSCRIBEDATASOURCE_CID, false, NULL, nsSubscribeDataSourceConstructor},</span>
<a href="#l16.73"></a><span id="l16.73">   { &amp;kNS_SUBSCRIBABLESERVER_CID, false, NULL, nsSubscribableServerConstructor},</span>
<a href="#l16.74"></a><span id="l16.74">   { &amp;kNS_MSGLOCALFOLDERCOMPACTOR_CID, false, NULL, nsFolderCompactStateConstructor},</span>
<a href="#l16.75"></a><span id="l16.75" class="difflineat">@@ -1002,16 +1006,17 @@ const mozilla::Module::ContractIDEntry k</span>
<a href="#l16.76"></a><span id="l16.76">   { NS_MSGSEARCHVALIDITYMANAGER_CONTRACTID, &amp;kNS_MSGSEARCHVALIDITYMANAGER_CID },</span>
<a href="#l16.77"></a><span id="l16.77">   { NS_MSGBIFFMANAGER_CONTRACTID, &amp;kNS_MSGBIFFMANAGER_CID },</span>
<a href="#l16.78"></a><span id="l16.78">   { NS_MSGPURGESERVICE_CONTRACTID, &amp;kNS_MSGPURGESERVICE_CID },</span>
<a href="#l16.79"></a><span id="l16.79">   { NS_STATUSBARBIFFMANAGER_CONTRACTID, &amp;kNS_STATUSBARBIFFMANAGER_CID },</span>
<a href="#l16.80"></a><span id="l16.80">   { NS_COPYMESSAGESTREAMLISTENER_CONTRACTID, &amp;kNS_COPYMESSAGESTREAMLISTENER_CID },</span>
<a href="#l16.81"></a><span id="l16.81">   { NS_MSGCOPYSERVICE_CONTRACTID, &amp;kNS_MSGCOPYSERVICE_CID },</span>
<a href="#l16.82"></a><span id="l16.82">   { NS_MSGFOLDERCACHE_CONTRACTID, &amp;kNS_MSGFOLDERCACHE_CID },</span>
<a href="#l16.83"></a><span id="l16.83">   { NS_MSGSTATUSFEEDBACK_CONTRACTID, &amp;kNS_MSGSTATUSFEEDBACK_CID },</span>
<a href="#l16.84"></a><span id="l16.84" class="difflineplus">+  { NS_MSGKEYARRAY_CONTRACTID, &amp;kNS_MSGKEYARRAY_CID },</span>
<a href="#l16.85"></a><span id="l16.85">   { NS_MSGWINDOW_CONTRACTID, &amp;kNS_MSGWINDOW_CID },</span>
<a href="#l16.86"></a><span id="l16.86"> #ifdef NS_PRINTING</span>
<a href="#l16.87"></a><span id="l16.87">   { NS_MSGPRINTENGINE_CONTRACTID, &amp;kNS_MSG_PRINTENGINE_CID },</span>
<a href="#l16.88"></a><span id="l16.88"> #endif</span>
<a href="#l16.89"></a><span id="l16.89">   { NS_MSGSERVICEPROVIDERSERVICE_CONTRACTID, &amp;kNS_MSGSERVICEPROVIDERSERVICE_CID },</span>
<a href="#l16.90"></a><span id="l16.90">   { NS_SUBSCRIBEDATASOURCE_CONTRACTID, &amp;kNS_SUBSCRIBEDATASOURCE_CID },</span>
<a href="#l16.91"></a><span id="l16.91">   { NS_SUBSCRIBABLESERVER_CONTRACTID, &amp;kNS_SUBSCRIBABLESERVER_CID },</span>
<a href="#l16.92"></a><span id="l16.92">   { NS_MSGLOCALFOLDERCOMPACTOR_CONTRACTID, &amp;kNS_MSGLOCALFOLDERCOMPACTOR_CID },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/db/msgdb/public/nsIMsgDatabase.idl</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/db/msgdb/public/nsIMsgDatabase.idl</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -64,23 +64,22 @@</span>
<a href="#l17.4"></a><span id="l17.4"> </span>
<a href="#l17.5"></a><span id="l17.5"> interface nsIDBChangeListener;</span>
<a href="#l17.6"></a><span id="l17.6"> interface nsIMsgDBHdr;</span>
<a href="#l17.7"></a><span id="l17.7"> interface nsISimpleEnumerator;</span>
<a href="#l17.8"></a><span id="l17.8"> interface nsIMsgThread;</span>
<a href="#l17.9"></a><span id="l17.9"> interface nsIDBFolderInfo;</span>
<a href="#l17.10"></a><span id="l17.10"> interface nsIMsgOfflineImapOperation;</span>
<a href="#l17.11"></a><span id="l17.11"> interface nsIMsgFolder;</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineplus">+interface nsIMsgKeyArray;</span>
<a href="#l17.13"></a><span id="l17.13"> interface nsIOutputStream;</span>
<a href="#l17.14"></a><span id="l17.14"> interface nsIUrlListener;</span>
<a href="#l17.15"></a><span id="l17.15"> interface nsILocalFile;</span>
<a href="#l17.16"></a><span id="l17.16"> interface nsIArray;</span>
<a href="#l17.17"></a><span id="l17.17"> </span>
<a href="#l17.18"></a><span id="l17.18" class="difflineminus">-[ptr] native octetPtr(PRUint8);</span>
<a href="#l17.19"></a><span id="l17.19" class="difflineminus">-</span>
<a href="#l17.20"></a><span id="l17.20"> typedef unsigned long nsMsgRetainByPreference;</span>
<a href="#l17.21"></a><span id="l17.21"> </span>
<a href="#l17.22"></a><span id="l17.22"> </span>
<a href="#l17.23"></a><span id="l17.23"> [scriptable, uuid(b01d6b3b-78c2-4958-b836-2259c76dbc24)]</span>
<a href="#l17.24"></a><span id="l17.24"> </span>
<a href="#l17.25"></a><span id="l17.25"> interface nsIMsgRetentionSettings : nsISupports</span>
<a href="#l17.26"></a><span id="l17.26"> {</span>
<a href="#l17.27"></a><span id="l17.27">   const unsigned long nsMsgRetainAll = 1;</span>
<a href="#l17.28"></a><span id="l17.28" class="difflineat">@@ -262,17 +261,17 @@ interface nsIMsgDBService : nsISupports</span>
<a href="#l17.29"></a><span id="l17.29">    *</span>
<a href="#l17.30"></a><span id="l17.30">    * @param aFolder   The folder to get the cached (open) db for.</span>
<a href="#l17.31"></a><span id="l17.31">    *</span>
<a href="#l17.32"></a><span id="l17.32">    * @returns         null if the db isn't open, otherwise the db.</span>
<a href="#l17.33"></a><span id="l17.33">    */</span>
<a href="#l17.34"></a><span id="l17.34">   nsIMsgDatabase cachedDBForFolder(in nsIMsgFolder aFolder);</span>
<a href="#l17.35"></a><span id="l17.35"> };</span>
<a href="#l17.36"></a><span id="l17.36"> </span>
<a href="#l17.37"></a><span id="l17.37" class="difflineminus">-[scriptable, uuid(2DDC3EFE-743D-4b8c-B761-6ED75ED06737)]</span>
<a href="#l17.38"></a><span id="l17.38" class="difflineplus">+[scriptable, uuid(19719187-6a85-4807-aeb6-421115240ba1)]</span>
<a href="#l17.39"></a><span id="l17.39"> interface nsIMsgDatabase : nsIDBChangeAnnouncer {</span>
<a href="#l17.40"></a><span id="l17.40">   /**</span>
<a href="#l17.41"></a><span id="l17.41">    * Opens a database folder.</span>
<a href="#l17.42"></a><span id="l17.42">    *</span>
<a href="#l17.43"></a><span id="l17.43">    * @param aFolderName     The name of the folder to create.</span>
<a href="#l17.44"></a><span id="l17.44">    * @param aCreate         Whether or not the file should be created.</span>
<a href="#l17.45"></a><span id="l17.45">    * @param aLeaveInvalidDB Set to true if you do not want the database to be</span>
<a href="#l17.46"></a><span id="l17.46">    *                        deleted if it is invalid.</span>
<a href="#l17.47"></a><span id="l17.47" class="difflineat">@@ -310,17 +309,17 @@ interface nsIMsgDatabase : nsIDBChangeAn</span>
<a href="#l17.48"></a><span id="l17.48">   // a new header, fill in its properties, and then call AddNewHdrToDB.</span>
<a href="#l17.49"></a><span id="l17.49">   // AddNewHdrToDB will send notifications to any listeners.</span>
<a href="#l17.50"></a><span id="l17.50">   nsIMsgDBHdr CreateNewHdr(in nsMsgKey key);</span>
<a href="#l17.51"></a><span id="l17.51"> </span>
<a href="#l17.52"></a><span id="l17.52">   void AddNewHdrToDB(in nsIMsgDBHdr newHdr, in boolean notify);</span>
<a href="#l17.53"></a><span id="l17.53"> </span>
<a href="#l17.54"></a><span id="l17.54">   nsIMsgDBHdr CopyHdrFromExistingHdr(in nsMsgKey key, in nsIMsgDBHdr existingHdr, in boolean addHdrToDB);</span>
<a href="#l17.55"></a><span id="l17.55"> </span>
<a href="#l17.56"></a><span id="l17.56" class="difflineminus">-  [noscript] void ListAllKeys(in nsMsgKeyArrayRef outputKeys);</span>
<a href="#l17.57"></a><span id="l17.57" class="difflineplus">+  void ListAllKeys(in nsIMsgKeyArray array);</span>
<a href="#l17.58"></a><span id="l17.58"> </span>
<a href="#l17.59"></a><span id="l17.59">   nsISimpleEnumerator EnumerateMessages();</span>
<a href="#l17.60"></a><span id="l17.60">   nsISimpleEnumerator ReverseEnumerateMessages();</span>
<a href="#l17.61"></a><span id="l17.61">   nsISimpleEnumerator EnumerateThreads();</span>
<a href="#l17.62"></a><span id="l17.62"> </span>
<a href="#l17.63"></a><span id="l17.63">   /**</span>
<a href="#l17.64"></a><span id="l17.64">    * Get an enumerator for use with nextMatchingHdrs. The enumerator</span>
<a href="#l17.65"></a><span id="l17.65">    * will only return messages that match the passed-in search terms.</span>
<a href="#l17.66"></a><span id="l17.66" class="difflineat">@@ -398,34 +397,34 @@ interface nsIMsgDatabase : nsIDBChangeAn</span>
<a href="#l17.67"></a><span id="l17.67">                          in nsIDBChangeListener instigator);</span>
<a href="#l17.68"></a><span id="l17.68"> </span>
<a href="#l17.69"></a><span id="l17.69">   void MarkForwarded(in nsMsgKey key, in boolean bForwarded, </span>
<a href="#l17.70"></a><span id="l17.70">                            in nsIDBChangeListener instigator);</span>
<a href="#l17.71"></a><span id="l17.71"> </span>
<a href="#l17.72"></a><span id="l17.72">   void MarkHasAttachments(in nsMsgKey key, in boolean bHasAttachments, </span>
<a href="#l17.73"></a><span id="l17.73">                                 in nsIDBChangeListener instigator);</span>
<a href="#l17.74"></a><span id="l17.74"> </span>
<a href="#l17.75"></a><span id="l17.75" class="difflineminus">-  [noscript] void MarkThreadRead(in nsIMsgThread thread, </span>
<a href="#l17.76"></a><span id="l17.76" class="difflineminus">-					in nsIDBChangeListener instigator, in nsMsgKeyArrayPtr thoseMarked);</span>
<a href="#l17.77"></a><span id="l17.77" class="difflineplus">+  void MarkThreadRead(in nsIMsgThread thread, in nsIDBChangeListener instigator,</span>
<a href="#l17.78"></a><span id="l17.78" class="difflineplus">+                      out unsigned long aCount,</span>
<a href="#l17.79"></a><span id="l17.79" class="difflineplus">+                      [array, size_is(aCount)] out nsMsgKey aKeys);</span>
<a href="#l17.80"></a><span id="l17.80"> </span>
<a href="#l17.81"></a><span id="l17.81">   void MarkThreadIgnored(in nsIMsgThread thread, in nsMsgKey threadKey, in boolean bIgnored,</span>
<a href="#l17.82"></a><span id="l17.82">                                in nsIDBChangeListener instigator);</span>
<a href="#l17.83"></a><span id="l17.83">   void MarkThreadWatched(in nsIMsgThread thread, in nsMsgKey threadKey, in boolean bWatched,</span>
<a href="#l17.84"></a><span id="l17.84">                                in nsIDBChangeListener instigator);</span>
<a href="#l17.85"></a><span id="l17.85">   void MarkHeaderKilled(in nsIMsgDBHdr msg, in boolean bIgnored,</span>
<a href="#l17.86"></a><span id="l17.86">                         in nsIDBChangeListener instigator);</span>
<a href="#l17.87"></a><span id="l17.87"> </span>
<a href="#l17.88"></a><span id="l17.88">   boolean IsRead(in nsMsgKey key);</span>
<a href="#l17.89"></a><span id="l17.89">   boolean IsIgnored(in nsMsgKey key);</span>
<a href="#l17.90"></a><span id="l17.90">   boolean IsMarked(in nsMsgKey key);</span>
<a href="#l17.91"></a><span id="l17.91">   boolean HasAttachments(in nsMsgKey key);</span>
<a href="#l17.92"></a><span id="l17.92"> </span>
<a href="#l17.93"></a><span id="l17.93" class="difflineminus">-  [noscript] void MarkAllRead(in nsMsgKeyArrayPtr thoseMarked);</span>
<a href="#l17.94"></a><span id="l17.94" class="difflineminus">-</span>
<a href="#l17.95"></a><span id="l17.95" class="difflineminus">-  [noscript] void MarkReadByDate (in PRTime startDate, in PRTime endDate, in nsMsgKeyArrayPtr markedIds);</span>
<a href="#l17.96"></a><span id="l17.96" class="difflineplus">+  void MarkAllRead(out unsigned long aCount,</span>
<a href="#l17.97"></a><span id="l17.97" class="difflineplus">+                   [array, size_is(aCount)] out nsMsgKey aKeys);</span>
<a href="#l17.98"></a><span id="l17.98"> </span>
<a href="#l17.99"></a><span id="l17.99">   void deleteMessages(in unsigned long aNumKeys,</span>
<a href="#l17.100"></a><span id="l17.100">                       [array, size_is(aNumKeys)] in nsMsgKey nsMsgKeys,</span>
<a href="#l17.101"></a><span id="l17.101">                       in nsIDBChangeListener instigator);</span>
<a href="#l17.102"></a><span id="l17.102">   void DeleteMessage(in nsMsgKey key, </span>
<a href="#l17.103"></a><span id="l17.103">                            in nsIDBChangeListener instigator,</span>
<a href="#l17.104"></a><span id="l17.104">                            in boolean commit);</span>
<a href="#l17.105"></a><span id="l17.105">   void DeleteHeader(in nsIMsgDBHdr msgHdr, in nsIDBChangeListener instigator,</span>
<a href="#l17.106"></a><span id="l17.106" class="difflineat">@@ -492,17 +491,17 @@ interface nsIMsgDatabase : nsIDBChangeAn</span>
<a href="#l17.107"></a><span id="l17.107">   void EndBatch();</span>
<a href="#l17.108"></a><span id="l17.108">   // offline operations - we could move these into an offline operation interface</span>
<a href="#l17.109"></a><span id="l17.109">   // but it would have to be in nsMailDatabase, since local folders can be move destinations</span>
<a href="#l17.110"></a><span id="l17.110">   nsIMsgOfflineImapOperation GetOfflineOpForKey(in nsMsgKey messageKey, in boolean create);</span>
<a href="#l17.111"></a><span id="l17.111">   void  RemoveOfflineOp(in nsIMsgOfflineImapOperation op);</span>
<a href="#l17.112"></a><span id="l17.112">   nsISimpleEnumerator EnumerateOfflineOps();</span>
<a href="#l17.113"></a><span id="l17.113">   [noscript] void ListAllOfflineOpIds(in nsMsgKeyArrayPtr offlineOpIds);</span>
<a href="#l17.114"></a><span id="l17.114">   [noscript] void ListAllOfflineDeletes(in nsMsgKeyArrayPtr offlineDeletes);</span>
<a href="#l17.115"></a><span id="l17.115" class="difflineminus">-  [noscript] void ListAllOfflineMsgs(in nsMsgKeyArrayPtr offlineMsgs);</span>
<a href="#l17.116"></a><span id="l17.116" class="difflineplus">+  void ListAllOfflineMsgs(in nsIMsgKeyArray aKeys);</span>
<a href="#l17.117"></a><span id="l17.117"> </span>
<a href="#l17.118"></a><span id="l17.118">   void setAttributeOnPendingHdr(in nsIMsgDBHdr pendingHdr, in string property,</span>
<a href="#l17.119"></a><span id="l17.119">                                   in string propertyVal);</span>
<a href="#l17.120"></a><span id="l17.120"> </span>
<a href="#l17.121"></a><span id="l17.121">   void setUint32AttributeOnPendingHdr(in nsIMsgDBHdr pendingHdr, in string property,</span>
<a href="#l17.122"></a><span id="l17.122">                                   in unsigned long propertyVal);</span>
<a href="#l17.123"></a><span id="l17.123"> </span>
<a href="#l17.124"></a><span id="l17.124">   /**</span>
<a href="#l17.125"></a><span id="l17.125" class="difflineat">@@ -530,18 +529,22 @@ interface nsIMsgDatabase : nsIDBChangeAn</span>
<a href="#l17.126"></a><span id="l17.126">    */</span>
<a href="#l17.127"></a><span id="l17.127">   void updatePendingAttributes(in nsIMsgDBHdr aNewHdr);</span>
<a href="#l17.128"></a><span id="l17.128"> </span>
<a href="#l17.129"></a><span id="l17.129">   readonly attribute nsMsgKey lowWaterArticleNum;</span>
<a href="#l17.130"></a><span id="l17.130">   readonly attribute nsMsgKey highWaterArticleNum;</span>
<a href="#l17.131"></a><span id="l17.131">   attribute nsMsgKey nextPseudoMsgKey;   //for undo-redo of move pop-&gt;imap</span>
<a href="#l17.132"></a><span id="l17.132">   readonly attribute nsMsgKey nextFakeOfflineMsgKey; // for saving &quot;fake&quot; offline msg hdrs</span>
<a href="#l17.133"></a><span id="l17.133">   // for sorting</span>
<a href="#l17.134"></a><span id="l17.134" class="difflineminus">-  [noscript] void createCollationKey(in AString sourceString, out octetPtr key, out unsigned long len);</span>
<a href="#l17.135"></a><span id="l17.135" class="difflineminus">-  [noscript] long compareCollationKeys(in octetPtr key1, in unsigned long len1, in octetPtr key2, in unsigned long len2);</span>
<a href="#l17.136"></a><span id="l17.136" class="difflineplus">+  void createCollationKey(in AString sourceString, out unsigned long aCount,</span>
<a href="#l17.137"></a><span id="l17.137" class="difflineplus">+                          [array, size_is(aCount)] out octet aKey);</span>
<a href="#l17.138"></a><span id="l17.138" class="difflineplus">+  long compareCollationKeys(in unsigned long aLen1,</span>
<a href="#l17.139"></a><span id="l17.139" class="difflineplus">+                            [array, size_is(aLen1)] in octet key1,</span>
<a href="#l17.140"></a><span id="l17.140" class="difflineplus">+                            in unsigned long aLen2,</span>
<a href="#l17.141"></a><span id="l17.141" class="difflineplus">+                            [array, size_is(aLen2)] in octet key2);</span>
<a href="#l17.142"></a><span id="l17.142"> </span>
<a href="#l17.143"></a><span id="l17.143">   // when creating a view, the default sort order and view flags </span>
<a href="#l17.144"></a><span id="l17.144">   // use these for the default.  (this allows news to override, so that</span>
<a href="#l17.145"></a><span id="l17.145">   // news can be threaded by default)</span>
<a href="#l17.146"></a><span id="l17.146">   readonly attribute nsMsgViewFlagsTypeValue defaultViewFlags;</span>
<a href="#l17.147"></a><span id="l17.147">   readonly attribute nsMsgViewSortTypeValue  defaultSortType;</span>
<a href="#l17.148"></a><span id="l17.148">   readonly attribute nsMsgViewSortOrderValue defaultSortOrder;</span>
<a href="#l17.149"></a><span id="l17.149"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/db/msgdb/public/nsMsgDatabase.h</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/db/msgdb/public/nsMsgDatabase.h</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -36,31 +36,31 @@</span>
<a href="#l18.4"></a><span id="l18.4">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l18.5"></a><span id="l18.5"> </span>
<a href="#l18.6"></a><span id="l18.6"> #ifndef _nsMsgDatabase_H_</span>
<a href="#l18.7"></a><span id="l18.7"> #define _nsMsgDatabase_H_</span>
<a href="#l18.8"></a><span id="l18.8"> </span>
<a href="#l18.9"></a><span id="l18.9"> #include &quot;nsIMsgDatabase.h&quot;</span>
<a href="#l18.10"></a><span id="l18.10"> #include &quot;nsMsgHdr.h&quot;</span>
<a href="#l18.11"></a><span id="l18.11"> #include &quot;nsStringGlue.h&quot;</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineplus">+#include &quot;nsAutoPtr.h&quot;</span>
<a href="#l18.13"></a><span id="l18.13"> #include &quot;nsIDBChangeListener.h&quot;</span>
<a href="#l18.14"></a><span id="l18.14"> #include &quot;nsIDBChangeAnnouncer.h&quot;</span>
<a href="#l18.15"></a><span id="l18.15"> #include &quot;nsMsgMessageFlags.h&quot;</span>
<a href="#l18.16"></a><span id="l18.16"> #include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l18.17"></a><span id="l18.17"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l18.18"></a><span id="l18.18"> #include &quot;nsDBFolderInfo.h&quot;</span>
<a href="#l18.19"></a><span id="l18.19"> #include &quot;nsICollation.h&quot;</span>
<a href="#l18.20"></a><span id="l18.20"> #include &quot;nsIMsgSearchSession.h&quot;</span>
<a href="#l18.21"></a><span id="l18.21"> #include &quot;nsIMimeConverter.h&quot;</span>
<a href="#l18.22"></a><span id="l18.22"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l18.23"></a><span id="l18.23"> #include &quot;nsCOMArray.h&quot;</span>
<a href="#l18.24"></a><span id="l18.24"> #include &quot;pldhash.h&quot;</span>
<a href="#l18.25"></a><span id="l18.25"> #include &quot;nsTArray.h&quot;</span>
<a href="#l18.26"></a><span id="l18.26"> #include &quot;nsTObserverArray.h&quot;</span>
<a href="#l18.27"></a><span id="l18.27" class="difflineminus">-#include &quot;nsAutoPtr.h&quot;</span>
<a href="#l18.28"></a><span id="l18.28"> class ListContext;</span>
<a href="#l18.29"></a><span id="l18.29"> class nsMsgKeySet;</span>
<a href="#l18.30"></a><span id="l18.30"> class nsMsgThread;</span>
<a href="#l18.31"></a><span id="l18.31"> class nsIMsgThread;</span>
<a href="#l18.32"></a><span id="l18.32"> class nsIDBFolderInfo;</span>
<a href="#l18.33"></a><span id="l18.33"> class nsIMsgHeaderParser;</span>
<a href="#l18.34"></a><span id="l18.34"> </span>
<a href="#l18.35"></a><span id="l18.35"> const PRInt32 kMsgDBVersion = 1;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/db/msgdb/public/nsNewsDatabase.h</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/db/msgdb/public/nsNewsDatabase.h</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -61,17 +61,17 @@ public:</span>
<a href="#l19.4"></a><span id="l19.4">   virtual PRUint32 GetCurVersion();</span>
<a href="#l19.5"></a><span id="l19.5"> </span>
<a href="#l19.6"></a><span id="l19.6">   // methods to get and set docsets for ids.</span>
<a href="#l19.7"></a><span id="l19.7">   NS_IMETHOD  IsRead(nsMsgKey key, PRBool *pRead);</span>
<a href="#l19.8"></a><span id="l19.8">   virtual nsresult  IsHeaderRead(nsIMsgDBHdr *msgHdr, PRBool *pRead);</span>
<a href="#l19.9"></a><span id="l19.9"> </span>
<a href="#l19.10"></a><span id="l19.10">   NS_IMETHOD         GetHighWaterArticleNum(nsMsgKey *key);</span>
<a href="#l19.11"></a><span id="l19.11">   NS_IMETHOD         GetLowWaterArticleNum(nsMsgKey *key);</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-  NS_IMETHOD         MarkAllRead(nsTArray&lt;nsMsgKey&gt; *thoseMarked);</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+  NS_IMETHOD         MarkAllRead(PRUint32 *aNumMarked, nsMsgKey **thoseMarked);</span>
<a href="#l19.14"></a><span id="l19.14"> </span>
<a href="#l19.15"></a><span id="l19.15">   virtual nsresult    ExpireUpTo(nsMsgKey expireKey);</span>
<a href="#l19.16"></a><span id="l19.16">   virtual nsresult    ExpireRange(nsMsgKey startRange, nsMsgKey endRange);</span>
<a href="#l19.17"></a><span id="l19.17">  </span>
<a href="#l19.18"></a><span id="l19.18">   virtual PRBool      SetHdrReadFlag(nsIMsgDBHdr *msgHdr, PRBool bRead);</span>
<a href="#l19.19"></a><span id="l19.19">  </span>
<a href="#l19.20"></a><span id="l19.20">   virtual nsresult  AdjustExpungedBytesOnDelete(nsIMsgDBHdr *msgHdr);</span>
<a href="#l19.21"></a><span id="l19.21">   nsresult          SyncWithReadSet();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/db/msgdb/src/nsMsgDatabase.cpp</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/db/msgdb/src/nsMsgDatabase.cpp</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -64,16 +64,17 @@</span>
<a href="#l20.4"></a><span id="l20.4"> #include &quot;nsMsgMimeCID.h&quot;</span>
<a href="#l20.5"></a><span id="l20.5"> #include &quot;nsILocaleService.h&quot;</span>
<a href="#l20.6"></a><span id="l20.6"> #include &quot;nsMsgFolderFlags.h&quot;</span>
<a href="#l20.7"></a><span id="l20.7"> #include &quot;nsIMsgAccountManager.h&quot;</span>
<a href="#l20.8"></a><span id="l20.8"> #include &quot;nsIMsgFolderCache.h&quot;</span>
<a href="#l20.9"></a><span id="l20.9"> #include &quot;nsIMsgFolderCacheElement.h&quot;</span>
<a href="#l20.10"></a><span id="l20.10"> #include &quot;MailNewsTypes2.h&quot;</span>
<a href="#l20.11"></a><span id="l20.11"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineplus">+#include &quot;nsMsgKeyArray.h&quot;</span>
<a href="#l20.13"></a><span id="l20.13"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l20.14"></a><span id="l20.14"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l20.15"></a><span id="l20.15"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l20.16"></a><span id="l20.16"> #include &quot;nsMemory.h&quot;</span>
<a href="#l20.17"></a><span id="l20.17"> #include &quot;nsICollation.h&quot;</span>
<a href="#l20.18"></a><span id="l20.18"> #include &quot;nsCollationCID.h&quot;</span>
<a href="#l20.19"></a><span id="l20.19"> #include &quot;nsIPrefService.h&quot;</span>
<a href="#l20.20"></a><span id="l20.20"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l20.21"></a><span id="l20.21" class="difflineat">@@ -2158,45 +2159,51 @@ NS_IMETHODIMP nsMsgDatabase::MarkForward</span>
<a href="#l20.22"></a><span id="l20.22"> </span>
<a href="#l20.23"></a><span id="l20.23"> NS_IMETHODIMP nsMsgDatabase::MarkHasAttachments(nsMsgKey key, PRBool bHasAttachments,</span>
<a href="#l20.24"></a><span id="l20.24">                                                 nsIDBChangeListener *instigator)</span>
<a href="#l20.25"></a><span id="l20.25"> {</span>
<a href="#l20.26"></a><span id="l20.26">   return SetKeyFlag(key, bHasAttachments, nsMsgMessageFlags::Attachment, instigator);</span>
<a href="#l20.27"></a><span id="l20.27"> }</span>
<a href="#l20.28"></a><span id="l20.28"> </span>
<a href="#l20.29"></a><span id="l20.29"> NS_IMETHODIMP</span>
<a href="#l20.30"></a><span id="l20.30" class="difflineminus">-nsMsgDatabase::MarkThreadRead(nsIMsgThread *thread, nsIDBChangeListener *instigator, nsTArray&lt;nsMsgKey&gt; *thoseMarked)</span>
<a href="#l20.31"></a><span id="l20.31" class="difflineminus">-{</span>
<a href="#l20.32"></a><span id="l20.32" class="difflineminus">-  if (!thread)</span>
<a href="#l20.33"></a><span id="l20.33" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l20.34"></a><span id="l20.34" class="difflineplus">+nsMsgDatabase::MarkThreadRead(nsIMsgThread *thread, nsIDBChangeListener *instigator,</span>
<a href="#l20.35"></a><span id="l20.35" class="difflineplus">+                              PRUint32 *aNumMarked, nsMsgKey **aThoseMarked)</span>
<a href="#l20.36"></a><span id="l20.36" class="difflineplus">+{</span>
<a href="#l20.37"></a><span id="l20.37" class="difflineplus">+  NS_ENSURE_ARG_POINTER(thread);</span>
<a href="#l20.38"></a><span id="l20.38" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aNumMarked);</span>
<a href="#l20.39"></a><span id="l20.39" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aThoseMarked);</span>
<a href="#l20.40"></a><span id="l20.40">   nsresult rv = NS_OK;</span>
<a href="#l20.41"></a><span id="l20.41"> </span>
<a href="#l20.42"></a><span id="l20.42">   PRUint32 numChildren;</span>
<a href="#l20.43"></a><span id="l20.43" class="difflineplus">+  nsTArray&lt;nsMsgKey&gt; thoseMarked;</span>
<a href="#l20.44"></a><span id="l20.44">   thread-&gt;GetNumChildren(&amp;numChildren);</span>
<a href="#l20.45"></a><span id="l20.45">   for (PRUint32 curChildIndex = 0; curChildIndex &lt; numChildren; curChildIndex++)</span>
<a href="#l20.46"></a><span id="l20.46">   {</span>
<a href="#l20.47"></a><span id="l20.47">     nsCOMPtr &lt;nsIMsgDBHdr&gt; child;</span>
<a href="#l20.48"></a><span id="l20.48"> </span>
<a href="#l20.49"></a><span id="l20.49">     rv = thread-&gt;GetChildHdrAt(curChildIndex, getter_AddRefs(child));</span>
<a href="#l20.50"></a><span id="l20.50">     if (NS_SUCCEEDED(rv) &amp;&amp; child)</span>
<a href="#l20.51"></a><span id="l20.51">     {</span>
<a href="#l20.52"></a><span id="l20.52">       PRBool isRead = PR_TRUE;</span>
<a href="#l20.53"></a><span id="l20.53">       IsHeaderRead(child, &amp;isRead);</span>
<a href="#l20.54"></a><span id="l20.54">       if (!isRead)</span>
<a href="#l20.55"></a><span id="l20.55">       {</span>
<a href="#l20.56"></a><span id="l20.56" class="difflineminus">-        if (thoseMarked)</span>
<a href="#l20.57"></a><span id="l20.57" class="difflineminus">-        {</span>
<a href="#l20.58"></a><span id="l20.58" class="difflineminus">-          nsMsgKey key;</span>
<a href="#l20.59"></a><span id="l20.59" class="difflineminus">-          if (NS_SUCCEEDED(child-&gt;GetMessageKey(&amp;key)))</span>
<a href="#l20.60"></a><span id="l20.60" class="difflineminus">-            thoseMarked-&gt;AppendElement(key);</span>
<a href="#l20.61"></a><span id="l20.61" class="difflineminus">-        }</span>
<a href="#l20.62"></a><span id="l20.62" class="difflineplus">+        nsMsgKey key;</span>
<a href="#l20.63"></a><span id="l20.63" class="difflineplus">+        if (NS_SUCCEEDED(child-&gt;GetMessageKey(&amp;key)))</span>
<a href="#l20.64"></a><span id="l20.64" class="difflineplus">+          thoseMarked.AppendElement(key);</span>
<a href="#l20.65"></a><span id="l20.65">         MarkHdrRead(child, PR_TRUE, instigator);</span>
<a href="#l20.66"></a><span id="l20.66">       }</span>
<a href="#l20.67"></a><span id="l20.67">     }</span>
<a href="#l20.68"></a><span id="l20.68">   }</span>
<a href="#l20.69"></a><span id="l20.69" class="difflineplus">+  *aThoseMarked =</span>
<a href="#l20.70"></a><span id="l20.70" class="difflineplus">+    (nsMsgKey *) nsMemory::Clone(&amp;thoseMarked[0],</span>
<a href="#l20.71"></a><span id="l20.71" class="difflineplus">+                                 thoseMarked.Length() * sizeof(nsMsgKey));</span>
<a href="#l20.72"></a><span id="l20.72" class="difflineplus">+  *aNumMarked = thoseMarked.Length();</span>
<a href="#l20.73"></a><span id="l20.73" class="difflineplus">+  if (!*aThoseMarked)</span>
<a href="#l20.74"></a><span id="l20.74" class="difflineplus">+    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l20.75"></a><span id="l20.75"> </span>
<a href="#l20.76"></a><span id="l20.76">   return rv;</span>
<a href="#l20.77"></a><span id="l20.77"> }</span>
<a href="#l20.78"></a><span id="l20.78"> </span>
<a href="#l20.79"></a><span id="l20.79"> NS_IMETHODIMP</span>
<a href="#l20.80"></a><span id="l20.80"> nsMsgDatabase::MarkThreadIgnored(nsIMsgThread *thread, nsMsgKey threadKey, PRBool bIgnored,</span>
<a href="#l20.81"></a><span id="l20.81">                                  nsIDBChangeListener *instigator)</span>
<a href="#l20.82"></a><span id="l20.82"> {</span>
<a href="#l20.83"></a><span id="l20.83" class="difflineat">@@ -2582,104 +2589,64 @@ nsMsgDatabase::MarkHdrNotNew(nsIMsgDBHdr</span>
<a href="#l20.84"></a><span id="l20.84"> {</span>
<a href="#l20.85"></a><span id="l20.85">   NS_ENSURE_ARG_POINTER(aMsgHdr);</span>
<a href="#l20.86"></a><span id="l20.86">   nsMsgKey msgKey;</span>
<a href="#l20.87"></a><span id="l20.87">   aMsgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l20.88"></a><span id="l20.88">   m_newSet.RemoveElement(msgKey);</span>
<a href="#l20.89"></a><span id="l20.89">   return SetMsgHdrFlag(aMsgHdr, PR_FALSE, nsMsgMessageFlags::New, aInstigator);</span>
<a href="#l20.90"></a><span id="l20.90"> }</span>
<a href="#l20.91"></a><span id="l20.91"> </span>
<a href="#l20.92"></a><span id="l20.92" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::MarkAllRead(nsTArray&lt;nsMsgKey&gt; *thoseMarked)</span>
<a href="#l20.93"></a><span id="l20.93" class="difflineminus">-{</span>
<a href="#l20.94"></a><span id="l20.94" class="difflineminus">-  nsresult    rv;</span>
<a href="#l20.95"></a><span id="l20.95" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::MarkAllRead(PRUint32 *aNumKeys, nsMsgKey **aThoseMarked)</span>
<a href="#l20.96"></a><span id="l20.96" class="difflineplus">+{</span>
<a href="#l20.97"></a><span id="l20.97" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aNumKeys);</span>
<a href="#l20.98"></a><span id="l20.98" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aThoseMarked);</span>
<a href="#l20.99"></a><span id="l20.99">   nsMsgHdr  *pHeader;</span>
<a href="#l20.100"></a><span id="l20.100"> </span>
<a href="#l20.101"></a><span id="l20.101" class="difflineminus">-  nsCOMPtr &lt;nsISimpleEnumerator&gt; hdrs;</span>
<a href="#l20.102"></a><span id="l20.102" class="difflineminus">-  rv = EnumerateMessages(getter_AddRefs(hdrs));</span>
<a href="#l20.103"></a><span id="l20.103" class="difflineplus">+  nsCOMPtr&lt;nsISimpleEnumerator&gt; hdrs;</span>
<a href="#l20.104"></a><span id="l20.104" class="difflineplus">+  nsTArray&lt;nsMsgKey&gt; thoseMarked;</span>
<a href="#l20.105"></a><span id="l20.105" class="difflineplus">+  nsresult rv = EnumerateMessages(getter_AddRefs(hdrs));</span>
<a href="#l20.106"></a><span id="l20.106">   if (NS_FAILED(rv))</span>
<a href="#l20.107"></a><span id="l20.107">     return rv;</span>
<a href="#l20.108"></a><span id="l20.108">   PRBool hasMore = PR_FALSE;</span>
<a href="#l20.109"></a><span id="l20.109"> </span>
<a href="#l20.110"></a><span id="l20.110">   while (NS_SUCCEEDED(rv = hdrs-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore)</span>
<a href="#l20.111"></a><span id="l20.111">   {</span>
<a href="#l20.112"></a><span id="l20.112">     rv = hdrs-&gt;GetNext((nsISupports**)&amp;pHeader);</span>
<a href="#l20.113"></a><span id="l20.113">     NS_ASSERTION(NS_SUCCEEDED(rv), &quot;nsMsgDBEnumerator broken&quot;);</span>
<a href="#l20.114"></a><span id="l20.114">     if (NS_FAILED(rv))</span>
<a href="#l20.115"></a><span id="l20.115">       break;</span>
<a href="#l20.116"></a><span id="l20.116"> </span>
<a href="#l20.117"></a><span id="l20.117">     PRBool isRead;</span>
<a href="#l20.118"></a><span id="l20.118">     IsHeaderRead(pHeader, &amp;isRead);</span>
<a href="#l20.119"></a><span id="l20.119"> </span>
<a href="#l20.120"></a><span id="l20.120">     if (!isRead)</span>
<a href="#l20.121"></a><span id="l20.121">     {</span>
<a href="#l20.122"></a><span id="l20.122" class="difflineminus">-      if (thoseMarked)</span>
<a href="#l20.123"></a><span id="l20.123" class="difflineminus">-      {</span>
<a href="#l20.124"></a><span id="l20.124" class="difflineminus">-        nsMsgKey key;</span>
<a href="#l20.125"></a><span id="l20.125" class="difflineminus">-        (void)pHeader-&gt;GetMessageKey(&amp;key);</span>
<a href="#l20.126"></a><span id="l20.126" class="difflineminus">-        thoseMarked-&gt;AppendElement(key);</span>
<a href="#l20.127"></a><span id="l20.127" class="difflineminus">-      }</span>
<a href="#l20.128"></a><span id="l20.128" class="difflineplus">+      nsMsgKey key;</span>
<a href="#l20.129"></a><span id="l20.129" class="difflineplus">+      (void)pHeader-&gt;GetMessageKey(&amp;key);</span>
<a href="#l20.130"></a><span id="l20.130" class="difflineplus">+      thoseMarked.AppendElement(key);</span>
<a href="#l20.131"></a><span id="l20.131">       rv = MarkHdrRead(pHeader, PR_TRUE, nsnull);   // ### dmb - blow off error?</span>
<a href="#l20.132"></a><span id="l20.132">     }</span>
<a href="#l20.133"></a><span id="l20.133">     NS_RELEASE(pHeader);</span>
<a href="#l20.134"></a><span id="l20.134">   }</span>
<a href="#l20.135"></a><span id="l20.135" class="difflineplus">+  *aThoseMarked = (nsMsgKey *) nsMemory::Clone(&amp;thoseMarked[0],</span>
<a href="#l20.136"></a><span id="l20.136" class="difflineplus">+                                       thoseMarked.Length() * sizeof(nsMsgKey));</span>
<a href="#l20.137"></a><span id="l20.137" class="difflineplus">+  if (!*aThoseMarked)</span>
<a href="#l20.138"></a><span id="l20.138" class="difflineplus">+    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l20.139"></a><span id="l20.139" class="difflineplus">+  *aNumKeys = thoseMarked.Length();</span>
<a href="#l20.140"></a><span id="l20.140"> </span>
<a href="#l20.141"></a><span id="l20.141">   // force num new to 0.</span>
<a href="#l20.142"></a><span id="l20.142">   PRInt32 numUnreadMessages;</span>
<a href="#l20.143"></a><span id="l20.143"> </span>
<a href="#l20.144"></a><span id="l20.144">   rv = m_dbFolderInfo-&gt;GetNumUnreadMessages(&amp;numUnreadMessages);</span>
<a href="#l20.145"></a><span id="l20.145">   if (rv == NS_OK)</span>
<a href="#l20.146"></a><span id="l20.146">     m_dbFolderInfo-&gt;ChangeNumUnreadMessages(-numUnreadMessages);</span>
<a href="#l20.147"></a><span id="l20.147">   // caller will Commit the db, so no need to do it here.</span>
<a href="#l20.148"></a><span id="l20.148">   return rv;</span>
<a href="#l20.149"></a><span id="l20.149"> }</span>
<a href="#l20.150"></a><span id="l20.150"> </span>
<a href="#l20.151"></a><span id="l20.151" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::MarkReadByDate (PRTime startDate, PRTime endDate, nsTArray&lt;nsMsgKey&gt; *markedIds)</span>
<a href="#l20.152"></a><span id="l20.152" class="difflineminus">-{</span>
<a href="#l20.153"></a><span id="l20.153" class="difflineminus">-  nsresult rv;</span>
<a href="#l20.154"></a><span id="l20.154" class="difflineminus">-  nsMsgHdr  *pHeader;</span>
<a href="#l20.155"></a><span id="l20.155" class="difflineminus">-  PRInt32 numChanged = 0;</span>
<a href="#l20.156"></a><span id="l20.156" class="difflineminus">-</span>
<a href="#l20.157"></a><span id="l20.157" class="difflineminus">-  nsISimpleEnumerator* hdrs;</span>
<a href="#l20.158"></a><span id="l20.158" class="difflineminus">-  rv = EnumerateMessages(&amp;hdrs);</span>
<a href="#l20.159"></a><span id="l20.159" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l20.160"></a><span id="l20.160" class="difflineminus">-    return rv;</span>
<a href="#l20.161"></a><span id="l20.161" class="difflineminus">-</span>
<a href="#l20.162"></a><span id="l20.162" class="difflineminus">-  PRBool hasMore = PR_FALSE;</span>
<a href="#l20.163"></a><span id="l20.163" class="difflineminus">-</span>
<a href="#l20.164"></a><span id="l20.164" class="difflineminus">-  while (NS_SUCCEEDED(rv = hdrs-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore)</span>
<a href="#l20.165"></a><span id="l20.165" class="difflineminus">-  {</span>
<a href="#l20.166"></a><span id="l20.166" class="difflineminus">-    rv = hdrs-&gt;GetNext((nsISupports**)&amp;pHeader);</span>
<a href="#l20.167"></a><span id="l20.167" class="difflineminus">-    NS_ASSERTION(NS_SUCCEEDED(rv), &quot;nsMsgDBEnumerator broken&quot;);</span>
<a href="#l20.168"></a><span id="l20.168" class="difflineminus">-    if (NS_FAILED(rv)) break;</span>
<a href="#l20.169"></a><span id="l20.169" class="difflineminus">-</span>
<a href="#l20.170"></a><span id="l20.170" class="difflineminus">-    PRTime headerDate;</span>
<a href="#l20.171"></a><span id="l20.171" class="difflineminus">-    (void)pHeader-&gt;GetDate(&amp;headerDate);</span>
<a href="#l20.172"></a><span id="l20.172" class="difflineminus">-</span>
<a href="#l20.173"></a><span id="l20.173" class="difflineminus">-    if (headerDate &gt; startDate &amp;&amp; headerDate &lt;= endDate)</span>
<a href="#l20.174"></a><span id="l20.174" class="difflineminus">-    {</span>
<a href="#l20.175"></a><span id="l20.175" class="difflineminus">-      PRBool isRead;</span>
<a href="#l20.176"></a><span id="l20.176" class="difflineminus">-      nsMsgKey key;</span>
<a href="#l20.177"></a><span id="l20.177" class="difflineminus">-      (void)pHeader-&gt;GetMessageKey(&amp;key);</span>
<a href="#l20.178"></a><span id="l20.178" class="difflineminus">-      IsRead(key, &amp;isRead);</span>
<a href="#l20.179"></a><span id="l20.179" class="difflineminus">-      if (!isRead)</span>
<a href="#l20.180"></a><span id="l20.180" class="difflineminus">-      {</span>
<a href="#l20.181"></a><span id="l20.181" class="difflineminus">-        numChanged++;</span>
<a href="#l20.182"></a><span id="l20.182" class="difflineminus">-        if (markedIds)</span>
<a href="#l20.183"></a><span id="l20.183" class="difflineminus">-          markedIds-&gt;AppendElement(key);</span>
<a href="#l20.184"></a><span id="l20.184" class="difflineminus">-        rv = MarkHdrRead(pHeader, PR_TRUE, NULL);  // ### dmb - blow off error?</span>
<a href="#l20.185"></a><span id="l20.185" class="difflineminus">-      }</span>
<a href="#l20.186"></a><span id="l20.186" class="difflineminus">-    }</span>
<a href="#l20.187"></a><span id="l20.187" class="difflineminus">-    NS_RELEASE(pHeader);</span>
<a href="#l20.188"></a><span id="l20.188" class="difflineminus">-  }</span>
<a href="#l20.189"></a><span id="l20.189" class="difflineminus">-  if (numChanged &gt; 0)</span>
<a href="#l20.190"></a><span id="l20.190" class="difflineminus">-    Commit(nsMsgDBCommitType::kSmallCommit);</span>
<a href="#l20.191"></a><span id="l20.191" class="difflineminus">-  return rv;</span>
<a href="#l20.192"></a><span id="l20.192" class="difflineminus">-}</span>
<a href="#l20.193"></a><span id="l20.193" class="difflineminus">-</span>
<a href="#l20.194"></a><span id="l20.194" class="difflineminus">-</span>
<a href="#l20.195"></a><span id="l20.195"> NS_IMETHODIMP nsMsgDatabase::AddToNewList(nsMsgKey key)</span>
<a href="#l20.196"></a><span id="l20.196"> {</span>
<a href="#l20.197"></a><span id="l20.197">   // we add new keys in increasing order...</span>
<a href="#l20.198"></a><span id="l20.198">   if (m_newSet.IsEmpty() || (m_newSet[m_newSet.Length() - 1] &lt; key))</span>
<a href="#l20.199"></a><span id="l20.199">     m_newSet.AppendElement(key);</span>
<a href="#l20.200"></a><span id="l20.200">   return NS_OK;</span>
<a href="#l20.201"></a><span id="l20.201"> }</span>
<a href="#l20.202"></a><span id="l20.202"> </span>
<a href="#l20.203"></a><span id="l20.203" class="difflineat">@@ -3073,41 +3040,44 @@ nsMsgDatabase::SyncCounts()</span>
<a href="#l20.204"></a><span id="l20.204">   (void) m_dbFolderInfo-&gt;GetNumMessages(&amp;oldTotal);</span>
<a href="#l20.205"></a><span id="l20.205">   if (oldUnread != numUnread)</span>
<a href="#l20.206"></a><span id="l20.206">     m_dbFolderInfo-&gt;ChangeNumUnreadMessages(numUnread - oldUnread);</span>
<a href="#l20.207"></a><span id="l20.207">   if (oldTotal != numHdrs)</span>
<a href="#l20.208"></a><span id="l20.208">     m_dbFolderInfo-&gt;ChangeNumMessages(numHdrs - oldTotal);</span>
<a href="#l20.209"></a><span id="l20.209">   return NS_OK;</span>
<a href="#l20.210"></a><span id="l20.210"> }</span>
<a href="#l20.211"></a><span id="l20.211"> </span>
<a href="#l20.212"></a><span id="l20.212" class="difflineminus">-</span>
<a href="#l20.213"></a><span id="l20.213"> // resulting output array is sorted by key.</span>
<a href="#l20.214"></a><span id="l20.214" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::ListAllKeys(nsTArray&lt;nsMsgKey&gt; &amp;outputKeys)</span>
<a href="#l20.215"></a><span id="l20.215" class="difflineminus">-{</span>
<a href="#l20.216"></a><span id="l20.216" class="difflineminus">-  nsresult  err = NS_OK;</span>
<a href="#l20.217"></a><span id="l20.217" class="difflineminus">-  nsIMdbTableRowCursor *rowCursor;</span>
<a href="#l20.218"></a><span id="l20.218" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::ListAllKeys(nsIMsgKeyArray *aKeys)</span>
<a href="#l20.219"></a><span id="l20.219" class="difflineplus">+{</span>
<a href="#l20.220"></a><span id="l20.220" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aKeys);</span>
<a href="#l20.221"></a><span id="l20.221" class="difflineplus">+  nsresult  rv = NS_OK;</span>
<a href="#l20.222"></a><span id="l20.222" class="difflineplus">+  nsCOMPtr&lt;nsIMdbTableRowCursor&gt; rowCursor;</span>
<a href="#l20.223"></a><span id="l20.223">   if (m_mdbAllMsgHeadersTable)</span>
<a href="#l20.224"></a><span id="l20.224">   {</span>
<a href="#l20.225"></a><span id="l20.225" class="difflineminus">-    err = m_mdbAllMsgHeadersTable-&gt;GetTableRowCursor(GetEnv(), -1, &amp;rowCursor);</span>
<a href="#l20.226"></a><span id="l20.226" class="difflineminus">-    while (err == NS_OK &amp;&amp; rowCursor)</span>
<a href="#l20.227"></a><span id="l20.227" class="difflineplus">+    PRUint32 numMsgs = 0;</span>
<a href="#l20.228"></a><span id="l20.228" class="difflineplus">+    m_mdbAllMsgHeadersTable-&gt;GetCount(GetEnv(), &amp;numMsgs);</span>
<a href="#l20.229"></a><span id="l20.229" class="difflineplus">+    aKeys-&gt;SetCapacity(numMsgs);</span>
<a href="#l20.230"></a><span id="l20.230" class="difflineplus">+    rv = m_mdbAllMsgHeadersTable-&gt;GetTableRowCursor(GetEnv(), -1,</span>
<a href="#l20.231"></a><span id="l20.231" class="difflineplus">+                                                     getter_AddRefs(rowCursor));</span>
<a href="#l20.232"></a><span id="l20.232" class="difflineplus">+    while (NS_SUCCEEDED(rv) &amp;&amp; rowCursor)</span>
<a href="#l20.233"></a><span id="l20.233">     {</span>
<a href="#l20.234"></a><span id="l20.234">       mdbOid outOid;</span>
<a href="#l20.235"></a><span id="l20.235">       mdb_pos  outPos;</span>
<a href="#l20.236"></a><span id="l20.236"> </span>
<a href="#l20.237"></a><span id="l20.237" class="difflineminus">-      err = rowCursor-&gt;NextRowOid(GetEnv(), &amp;outOid, &amp;outPos);</span>
<a href="#l20.238"></a><span id="l20.238" class="difflineplus">+      rv = rowCursor-&gt;NextRowOid(GetEnv(), &amp;outOid, &amp;outPos);</span>
<a href="#l20.239"></a><span id="l20.239">       // is this right? Mork is returning a 0 id, but that should valid.</span>
<a href="#l20.240"></a><span id="l20.240">       if (outPos &lt; 0 || outOid.mOid_Id == (mdb_id) -1)</span>
<a href="#l20.241"></a><span id="l20.241">         break;</span>
<a href="#l20.242"></a><span id="l20.242" class="difflineminus">-      if (err == NS_OK)</span>
<a href="#l20.243"></a><span id="l20.243" class="difflineminus">-        outputKeys.AppendElement(outOid.mOid_Id);</span>
<a href="#l20.244"></a><span id="l20.244" class="difflineplus">+      if (NS_SUCCEEDED(rv))</span>
<a href="#l20.245"></a><span id="l20.245" class="difflineplus">+        aKeys-&gt;AppendElement(outOid.mOid_Id);</span>
<a href="#l20.246"></a><span id="l20.246">     }</span>
<a href="#l20.247"></a><span id="l20.247" class="difflineminus">-    rowCursor-&gt;Release();</span>
<a href="#l20.248"></a><span id="l20.248" class="difflineplus">+    aKeys-&gt;Sort();</span>
<a href="#l20.249"></a><span id="l20.249">   }</span>
<a href="#l20.250"></a><span id="l20.250" class="difflineminus">-  outputKeys.Sort();</span>
<a href="#l20.251"></a><span id="l20.251" class="difflineminus">-  return err;</span>
<a href="#l20.252"></a><span id="l20.252" class="difflineplus">+  return rv;</span>
<a href="#l20.253"></a><span id="l20.253"> }</span>
<a href="#l20.254"></a><span id="l20.254"> </span>
<a href="#l20.255"></a><span id="l20.255"> class nsMsgDBThreadEnumerator : public nsISimpleEnumerator, public nsIDBChangeListener</span>
<a href="#l20.256"></a><span id="l20.256"> {</span>
<a href="#l20.257"></a><span id="l20.257"> public:</span>
<a href="#l20.258"></a><span id="l20.258">     NS_DECL_ISUPPORTS</span>
<a href="#l20.259"></a><span id="l20.259"> </span>
<a href="#l20.260"></a><span id="l20.260">     // nsISimpleEnumerator methods:</span>
<a href="#l20.261"></a><span id="l20.261" class="difflineat">@@ -3568,17 +3538,17 @@ nsresult nsMsgDatabase::RowCellColumnToA</span>
<a href="#l20.262"></a><span id="l20.262">                                             getter_Copies(resultStr));</span>
<a href="#l20.263"></a><span id="l20.263">   if (NS_SUCCEEDED(rv) &amp;&amp; !resultStr.IsEmpty())</span>
<a href="#l20.264"></a><span id="l20.264">     rv = headerParser-&gt;ExtractHeaderAddressName(resultStr, name);</span>
<a href="#l20.265"></a><span id="l20.265">   else</span>
<a href="#l20.266"></a><span id="l20.266">     rv = headerParser-&gt;ExtractHeaderAddressName(nsDependentCString(cSender),</span>
<a href="#l20.267"></a><span id="l20.267">                                                      name);</span>
<a href="#l20.268"></a><span id="l20.268"> </span>
<a href="#l20.269"></a><span id="l20.269">   if (NS_SUCCEEDED(rv))</span>
<a href="#l20.270"></a><span id="l20.270" class="difflineminus">-    return CreateCollationKey(NS_ConvertUTF8toUTF16(name), result, len);</span>
<a href="#l20.271"></a><span id="l20.271" class="difflineplus">+    return CreateCollationKey(NS_ConvertUTF8toUTF16(name), len, result);</span>
<a href="#l20.272"></a><span id="l20.272"> </span>
<a href="#l20.273"></a><span id="l20.273">   return rv;</span>
<a href="#l20.274"></a><span id="l20.274"> }</span>
<a href="#l20.275"></a><span id="l20.275"> </span>
<a href="#l20.276"></a><span id="l20.276"> nsresult nsMsgDatabase::GetCollationKeyGenerator()</span>
<a href="#l20.277"></a><span id="l20.277"> {</span>
<a href="#l20.278"></a><span id="l20.278">   nsresult err = NS_OK;</span>
<a href="#l20.279"></a><span id="l20.279">   if (!m_collationKeyGenerator)</span>
<a href="#l20.280"></a><span id="l20.280" class="difflineat">@@ -3631,36 +3601,38 @@ nsresult nsMsgDatabase::RowCellColumnToC</span>
<a href="#l20.281"></a><span id="l20.281">       {</span>
<a href="#l20.282"></a><span id="l20.282">         m_dbFolderInfo-&gt;GetEffectiveCharacterSet(charSet);</span>
<a href="#l20.283"></a><span id="l20.283">       }</span>
<a href="#l20.284"></a><span id="l20.284"> </span>
<a href="#l20.285"></a><span id="l20.285">       err = m_mimeConverter-&gt;DecodeMimeHeaderToCharPtr(nakedString,</span>
<a href="#l20.286"></a><span id="l20.286">         charSet.get(), characterSetOverride, PR_TRUE,</span>
<a href="#l20.287"></a><span id="l20.287">         getter_Copies(decodedStr));</span>
<a href="#l20.288"></a><span id="l20.288">       if (NS_SUCCEEDED(err))</span>
<a href="#l20.289"></a><span id="l20.289" class="difflineminus">-        err = CreateCollationKey(NS_ConvertUTF8toUTF16(decodedStr), result, len);</span>
<a href="#l20.290"></a><span id="l20.290" class="difflineplus">+        err = CreateCollationKey(NS_ConvertUTF8toUTF16(decodedStr), len, result);</span>
<a href="#l20.291"></a><span id="l20.291">     }</span>
<a href="#l20.292"></a><span id="l20.292">   }</span>
<a href="#l20.293"></a><span id="l20.293">   return err;</span>
<a href="#l20.294"></a><span id="l20.294"> }</span>
<a href="#l20.295"></a><span id="l20.295"> </span>
<a href="#l20.296"></a><span id="l20.296"> NS_IMETHODIMP</span>
<a href="#l20.297"></a><span id="l20.297" class="difflineminus">-nsMsgDatabase::CompareCollationKeys(PRUint8 *key1, PRUint32 len1, PRUint8 *key2, PRUint32 len2, PRInt32 *result)</span>
<a href="#l20.298"></a><span id="l20.298" class="difflineplus">+nsMsgDatabase::CompareCollationKeys(PRUint32 len1, PRUint8 *key1, PRUint32 len2,</span>
<a href="#l20.299"></a><span id="l20.299" class="difflineplus">+                                    PRUint8 *key2, PRInt32 *result)</span>
<a href="#l20.300"></a><span id="l20.300"> {</span>
<a href="#l20.301"></a><span id="l20.301">   nsresult rv = GetCollationKeyGenerator();</span>
<a href="#l20.302"></a><span id="l20.302">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l20.303"></a><span id="l20.303">   if (!m_collationKeyGenerator) return NS_ERROR_FAILURE;</span>
<a href="#l20.304"></a><span id="l20.304"> </span>
<a href="#l20.305"></a><span id="l20.305">   rv = m_collationKeyGenerator-&gt;CompareRawSortKey(key1,len1,key2,len2,result);</span>
<a href="#l20.306"></a><span id="l20.306">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l20.307"></a><span id="l20.307">   return rv;</span>
<a href="#l20.308"></a><span id="l20.308"> }</span>
<a href="#l20.309"></a><span id="l20.309"> </span>
<a href="#l20.310"></a><span id="l20.310"> NS_IMETHODIMP</span>
<a href="#l20.311"></a><span id="l20.311" class="difflineminus">-nsMsgDatabase::CreateCollationKey(const nsAString&amp; sourceString, PRUint8 **result, PRUint32 *len)</span>
<a href="#l20.312"></a><span id="l20.312" class="difflineplus">+nsMsgDatabase::CreateCollationKey(const nsAString&amp; sourceString, PRUint32 *len,</span>
<a href="#l20.313"></a><span id="l20.313" class="difflineplus">+                                  PRUint8 **result)</span>
<a href="#l20.314"></a><span id="l20.314"> {</span>
<a href="#l20.315"></a><span id="l20.315">   nsresult err = GetCollationKeyGenerator();</span>
<a href="#l20.316"></a><span id="l20.316">   NS_ENSURE_SUCCESS(err,err);</span>
<a href="#l20.317"></a><span id="l20.317">   if (!m_collationKeyGenerator) return NS_ERROR_FAILURE;</span>
<a href="#l20.318"></a><span id="l20.318"> </span>
<a href="#l20.319"></a><span id="l20.319">   err = m_collationKeyGenerator-&gt;AllocateRawSortKey(nsICollation::kCollationCaseInSensitive, sourceString, result, len);</span>
<a href="#l20.320"></a><span id="l20.320">   NS_ENSURE_SUCCESS(err,err);</span>
<a href="#l20.321"></a><span id="l20.321">   return err;</span>
<a href="#l20.322"></a><span id="l20.322" class="difflineat">@@ -4801,18 +4773,19 @@ NS_IMETHODIMP nsMsgDatabase::GetOfflineO</span>
<a href="#l20.323"></a><span id="l20.323"> </span>
<a href="#l20.324"></a><span id="l20.324"> NS_IMETHODIMP  nsMsgDatabase::RemoveOfflineOp(nsIMsgOfflineImapOperation *op)</span>
<a href="#l20.325"></a><span id="l20.325"> {</span>
<a href="#l20.326"></a><span id="l20.326">   NS_ASSERTION(PR_FALSE, &quot;overridden by nsMailDatabase&quot;);</span>
<a href="#l20.327"></a><span id="l20.327">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l20.328"></a><span id="l20.328"> }</span>
<a href="#l20.329"></a><span id="l20.329"> </span>
<a href="#l20.330"></a><span id="l20.330"> </span>
<a href="#l20.331"></a><span id="l20.331" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::ListAllOfflineMsgs(nsTArray&lt;nsMsgKey&gt; *outputKeys)</span>
<a href="#l20.332"></a><span id="l20.332" class="difflineminus">-{</span>
<a href="#l20.333"></a><span id="l20.333" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::ListAllOfflineMsgs(nsIMsgKeyArray *aKeys)</span>
<a href="#l20.334"></a><span id="l20.334" class="difflineplus">+{</span>
<a href="#l20.335"></a><span id="l20.335" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aKeys);</span>
<a href="#l20.336"></a><span id="l20.336">   nsCOMPtr &lt;nsISimpleEnumerator&gt; enumerator;</span>
<a href="#l20.337"></a><span id="l20.337">   PRUint32 flag = nsMsgMessageFlags::Offline;</span>
<a href="#l20.338"></a><span id="l20.338">   // if we change this routine to return an enumerator that generates the keys</span>
<a href="#l20.339"></a><span id="l20.339">   // one by one, we'll need to somehow make a copy of flag for the enumerator</span>
<a href="#l20.340"></a><span id="l20.340">   // to own, since the enumerator will persist past the life of flag on the stack.</span>
<a href="#l20.341"></a><span id="l20.341">   nsresult rv = EnumerateMessagesWithFlag(getter_AddRefs(enumerator), &amp;flag);</span>
<a href="#l20.342"></a><span id="l20.342">   if (NS_SUCCEEDED(rv) &amp;&amp; enumerator)</span>
<a href="#l20.343"></a><span id="l20.343">   {</span>
<a href="#l20.344"></a><span id="l20.344" class="difflineat">@@ -4825,22 +4798,21 @@ NS_IMETHODIMP nsMsgDatabase::ListAllOffl</span>
<a href="#l20.345"></a><span id="l20.345">         return rv;</span>
<a href="#l20.346"></a><span id="l20.346"> </span>
<a href="#l20.347"></a><span id="l20.347">       // clear out db hdr, because it won't be valid when we get rid of the .msf file</span>
<a href="#l20.348"></a><span id="l20.348">       nsCOMPtr&lt;nsIMsgDBHdr&gt; dbMessage(do_QueryInterface(childSupports, &amp;rv));</span>
<a href="#l20.349"></a><span id="l20.349">       if(NS_SUCCEEDED(rv) &amp;&amp; dbMessage)</span>
<a href="#l20.350"></a><span id="l20.350">       {</span>
<a href="#l20.351"></a><span id="l20.351">         nsMsgKey msgKey;</span>
<a href="#l20.352"></a><span id="l20.352">         dbMessage-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l20.353"></a><span id="l20.353" class="difflineminus">-        outputKeys-&gt;AppendElement(msgKey);</span>
<a href="#l20.354"></a><span id="l20.354" class="difflineplus">+        aKeys-&gt;AppendElement(msgKey);</span>
<a href="#l20.355"></a><span id="l20.355">       }</span>
<a href="#l20.356"></a><span id="l20.356">     }</span>
<a href="#l20.357"></a><span id="l20.357">   }</span>
<a href="#l20.358"></a><span id="l20.358" class="difflineminus">-  outputKeys-&gt;Sort();</span>
<a href="#l20.359"></a><span id="l20.359" class="difflineminus">-</span>
<a href="#l20.360"></a><span id="l20.360" class="difflineplus">+  aKeys-&gt;Sort();</span>
<a href="#l20.361"></a><span id="l20.361">   return rv;</span>
<a href="#l20.362"></a><span id="l20.362"> }</span>
<a href="#l20.363"></a><span id="l20.363"> </span>
<a href="#l20.364"></a><span id="l20.364"> NS_IMETHODIMP nsMsgDatabase::EnumerateOfflineOps(nsISimpleEnumerator **enumerator)</span>
<a href="#l20.365"></a><span id="l20.365"> {</span>
<a href="#l20.366"></a><span id="l20.366">   NS_ASSERTION(PR_FALSE, &quot;overridden by nsMailDatabase&quot;);</span>
<a href="#l20.367"></a><span id="l20.367">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l20.368"></a><span id="l20.368"> }</span>
<a href="#l20.369"></a><span id="l20.369" class="difflineat">@@ -4908,20 +4880,24 @@ NS_IMETHODIMP nsMsgDatabase::GetNextFake</span>
<a href="#l20.370"></a><span id="l20.370"> }</span>
<a href="#l20.371"></a><span id="l20.371"> </span>
<a href="#l20.372"></a><span id="l20.372"> #ifdef DEBUG</span>
<a href="#l20.373"></a><span id="l20.373"> nsresult nsMsgDatabase::DumpContents()</span>
<a href="#l20.374"></a><span id="l20.374"> {</span>
<a href="#l20.375"></a><span id="l20.375">   nsMsgKey key;</span>
<a href="#l20.376"></a><span id="l20.376">   PRUint32 i;</span>
<a href="#l20.377"></a><span id="l20.377"> </span>
<a href="#l20.378"></a><span id="l20.378" class="difflineminus">-  nsTArray&lt;nsMsgKey&gt; keys;</span>
<a href="#l20.379"></a><span id="l20.379" class="difflineplus">+  nsRefPtr&lt;nsMsgKeyArray&gt; keys = new nsMsgKeyArray;</span>
<a href="#l20.380"></a><span id="l20.380" class="difflineplus">+  if (!keys)</span>
<a href="#l20.381"></a><span id="l20.381" class="difflineplus">+    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l20.382"></a><span id="l20.382">   nsresult rv = ListAllKeys(keys);</span>
<a href="#l20.383"></a><span id="l20.383" class="difflineminus">-  for (i = 0; i &lt; keys.Length(); i++) {</span>
<a href="#l20.384"></a><span id="l20.384" class="difflineminus">-    key = keys[i];</span>
<a href="#l20.385"></a><span id="l20.385" class="difflineplus">+  PRUint32 numKeys;</span>
<a href="#l20.386"></a><span id="l20.386" class="difflineplus">+  keys-&gt;GetLength(&amp;numKeys);</span>
<a href="#l20.387"></a><span id="l20.387" class="difflineplus">+  for (i = 0; i &lt; numKeys; i++) {</span>
<a href="#l20.388"></a><span id="l20.388" class="difflineplus">+    key = keys-&gt;m_keys[i];</span>
<a href="#l20.389"></a><span id="l20.389">     nsIMsgDBHdr *msg = NULL;</span>
<a href="#l20.390"></a><span id="l20.390">     rv = GetMsgHdrForKey(key, &amp;msg);</span>
<a href="#l20.391"></a><span id="l20.391">     nsMsgHdr* msgHdr = static_cast&lt;nsMsgHdr*&gt;(msg);      // closed system, cast ok</span>
<a href="#l20.392"></a><span id="l20.392">     if (NS_SUCCEEDED(rv))</span>
<a href="#l20.393"></a><span id="l20.393">     {</span>
<a href="#l20.394"></a><span id="l20.394">       nsCString author;</span>
<a href="#l20.395"></a><span id="l20.395">       nsCString subject;</span>
<a href="#l20.396"></a><span id="l20.396"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mailnews/db/msgdb/src/nsMsgHdr.cpp</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mailnews/db/msgdb/src/nsMsgHdr.cpp</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -719,27 +719,27 @@ NS_IMETHODIMP nsMsgHdr::GetMime2DecodedS</span>
<a href="#l21.4"></a><span id="l21.4"> }</span>
<a href="#l21.5"></a><span id="l21.5"> </span>
<a href="#l21.6"></a><span id="l21.6"> NS_IMETHODIMP nsMsgHdr::GetMime2DecodedRecipients(nsAString &amp;resultRecipients)</span>
<a href="#l21.7"></a><span id="l21.7"> {</span>
<a href="#l21.8"></a><span id="l21.8">   return m_mdb-&gt;RowCellColumnToMime2DecodedString(GetMDBRow(), m_mdb-&gt;m_recipientsColumnToken, resultRecipients);</span>
<a href="#l21.9"></a><span id="l21.9"> }</span>
<a href="#l21.10"></a><span id="l21.10"> </span>
<a href="#l21.11"></a><span id="l21.11"> </span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::GetAuthorCollationKey(PRUint8 **resultAuthor, PRUint32 *len)</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::GetAuthorCollationKey(PRUint32 *len, PRUint8 **resultAuthor)</span>
<a href="#l21.14"></a><span id="l21.14"> {</span>
<a href="#l21.15"></a><span id="l21.15">   return m_mdb-&gt;RowCellColumnToAddressCollationKey(GetMDBRow(), m_mdb-&gt;m_senderColumnToken, resultAuthor, len);</span>
<a href="#l21.16"></a><span id="l21.16"> }</span>
<a href="#l21.17"></a><span id="l21.17"> </span>
<a href="#l21.18"></a><span id="l21.18" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::GetSubjectCollationKey(PRUint8 **resultSubject, PRUint32 *len)</span>
<a href="#l21.19"></a><span id="l21.19" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::GetSubjectCollationKey(PRUint32 *len, PRUint8 **resultSubject)</span>
<a href="#l21.20"></a><span id="l21.20"> {</span>
<a href="#l21.21"></a><span id="l21.21">   return m_mdb-&gt;RowCellColumnToCollationKey(GetMDBRow(), m_mdb-&gt;m_subjectColumnToken, resultSubject, len);</span>
<a href="#l21.22"></a><span id="l21.22"> }</span>
<a href="#l21.23"></a><span id="l21.23"> </span>
<a href="#l21.24"></a><span id="l21.24" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::GetRecipientsCollationKey(PRUint8 **resultRecipients, PRUint32 *len)</span>
<a href="#l21.25"></a><span id="l21.25" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::GetRecipientsCollationKey(PRUint32 *len, PRUint8 **resultRecipients)</span>
<a href="#l21.26"></a><span id="l21.26"> {</span>
<a href="#l21.27"></a><span id="l21.27">   return m_mdb-&gt;RowCellColumnToCollationKey(GetMDBRow(), m_mdb-&gt;m_recipientsColumnToken, resultRecipients, len);</span>
<a href="#l21.28"></a><span id="l21.28"> }</span>
<a href="#l21.29"></a><span id="l21.29"> </span>
<a href="#l21.30"></a><span id="l21.30"> NS_IMETHODIMP nsMsgHdr::GetCharset(char **aCharset)</span>
<a href="#l21.31"></a><span id="l21.31"> {</span>
<a href="#l21.32"></a><span id="l21.32">   return m_mdb-&gt;RowCellColumnToCharPtr(GetMDBRow(), m_mdb-&gt;m_messageCharSetColumnToken, aCharset);</span>
<a href="#l21.33"></a><span id="l21.33"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mailnews/db/msgdb/src/nsNewsDatabase.cpp</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mailnews/db/msgdb/src/nsNewsDatabase.cpp</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -248,17 +248,18 @@ PRBool nsNewsDatabase::SetHdrReadFlag(ns</span>
<a href="#l22.4"></a><span id="l22.4"> </span>
<a href="#l22.5"></a><span id="l22.5">         rv = NotifyReadChanged(nsnull);</span>
<a href="#l22.6"></a><span id="l22.6">         if (NS_FAILED(rv)) return PR_FALSE;</span>
<a href="#l22.7"></a><span id="l22.7">       }</span>
<a href="#l22.8"></a><span id="l22.8">     }</span>
<a href="#l22.9"></a><span id="l22.9">     return PR_TRUE;</span>
<a href="#l22.10"></a><span id="l22.10"> }</span>
<a href="#l22.11"></a><span id="l22.11"> </span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-NS_IMETHODIMP nsNewsDatabase::MarkAllRead(nsTArray&lt;nsMsgKey&gt; *thoseMarked)</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineplus">+NS_IMETHODIMP nsNewsDatabase::MarkAllRead(PRUint32 *aNumMarked,</span>
<a href="#l22.14"></a><span id="l22.14" class="difflineplus">+                                          nsMsgKey **aThoseMarked)</span>
<a href="#l22.15"></a><span id="l22.15"> {</span>
<a href="#l22.16"></a><span id="l22.16">   nsMsgKey lowWater = nsMsgKey_None, highWater;</span>
<a href="#l22.17"></a><span id="l22.17">   nsCString knownArts;</span>
<a href="#l22.18"></a><span id="l22.18">   if (m_dbFolderInfo)</span>
<a href="#l22.19"></a><span id="l22.19">   {</span>
<a href="#l22.20"></a><span id="l22.20">     m_dbFolderInfo-&gt;GetKnownArtsSet(getter_Copies(knownArts));</span>
<a href="#l22.21"></a><span id="l22.21">     nsMsgKeySet *knownKeys = nsMsgKeySet::Create(knownArts.get());</span>
<a href="#l22.22"></a><span id="l22.22">     if (knownKeys)</span>
<a href="#l22.23"></a><span id="l22.23" class="difflineat">@@ -266,17 +267,17 @@ NS_IMETHODIMP nsNewsDatabase::MarkAllRea</span>
<a href="#l22.24"></a><span id="l22.24"> </span>
<a href="#l22.25"></a><span id="l22.25">     delete knownKeys;</span>
<a href="#l22.26"></a><span id="l22.26">   }</span>
<a href="#l22.27"></a><span id="l22.27">   if (lowWater == nsMsgKey_None)</span>
<a href="#l22.28"></a><span id="l22.28">     GetLowWaterArticleNum(&amp;lowWater);</span>
<a href="#l22.29"></a><span id="l22.29">   GetHighWaterArticleNum(&amp;highWater);</span>
<a href="#l22.30"></a><span id="l22.30">   if (lowWater &gt; 2)</span>
<a href="#l22.31"></a><span id="l22.31">     m_readSet-&gt;AddRange(1, lowWater - 1);</span>
<a href="#l22.32"></a><span id="l22.32" class="difflineminus">-  nsresult err = nsMsgDatabase::MarkAllRead(thoseMarked);</span>
<a href="#l22.33"></a><span id="l22.33" class="difflineplus">+  nsresult err = nsMsgDatabase::MarkAllRead(aNumMarked, aThoseMarked);</span>
<a href="#l22.34"></a><span id="l22.34">   if (NS_SUCCEEDED(err) &amp;&amp; 1 &lt;= highWater)</span>
<a href="#l22.35"></a><span id="l22.35">     m_readSet-&gt;AddRange(1, highWater); // mark everything read in newsrc.</span>
<a href="#l22.36"></a><span id="l22.36"> </span>
<a href="#l22.37"></a><span id="l22.37">   return err;</span>
<a href="#l22.38"></a><span id="l22.38"> }</span>
<a href="#l22.39"></a><span id="l22.39"> </span>
<a href="#l22.40"></a><span id="l22.40"> nsresult nsNewsDatabase::SyncWithReadSet()</span>
<a href="#l22.41"></a><span id="l22.41"> {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mailnews/imap/src/nsAutoSyncState.cpp</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mailnews/imap/src/nsAutoSyncState.cpp</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -33,16 +33,17 @@</span>
<a href="#l23.4"></a><span id="l23.4">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l23.5"></a><span id="l23.5">  *</span>
<a href="#l23.6"></a><span id="l23.6">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l23.7"></a><span id="l23.7"> </span>
<a href="#l23.8"></a><span id="l23.8"> #include &quot;nsAutoSyncState.h&quot;</span>
<a href="#l23.9"></a><span id="l23.9"> #include &quot;nsImapMailFolder.h&quot;</span>
<a href="#l23.10"></a><span id="l23.10"> #include &quot;nsMsgImapCID.h&quot;</span>
<a href="#l23.11"></a><span id="l23.11"> #include &quot;nsIMsgMailNewsUrl.h&quot;</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineplus">+#include &quot;nsMsgKeyArray.h&quot;</span>
<a href="#l23.13"></a><span id="l23.13"> #include &quot;nsIMsgWindow.h&quot;</span>
<a href="#l23.14"></a><span id="l23.14"> #include &quot;nsIMsgMailSession.h&quot;</span>
<a href="#l23.15"></a><span id="l23.15"> #include &quot;nsMsgFolderFlags.h&quot;</span>
<a href="#l23.16"></a><span id="l23.16"> #include &quot;nsIAutoSyncManager.h&quot;</span>
<a href="#l23.17"></a><span id="l23.17"> #include &quot;nsIAutoSyncMsgStrategy.h&quot;</span>
<a href="#l23.18"></a><span id="l23.18"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l23.19"></a><span id="l23.19"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l23.20"></a><span id="l23.20"> </span>
<a href="#l23.21"></a><span id="l23.21" class="difflineat">@@ -363,18 +364,20 @@ NS_IMETHODIMP nsAutoSyncState::ProcessEx</span>
<a href="#l23.22"></a><span id="l23.22">   nsCOMPtr&lt;nsIMsgDatabase&gt; database;</span>
<a href="#l23.23"></a><span id="l23.23">   rv = folder-&gt;GetMsgDatabase(getter_AddRefs(database));</span>
<a href="#l23.24"></a><span id="l23.24">   if (!database)</span>
<a href="#l23.25"></a><span id="l23.25">     return NS_ERROR_FAILURE;</span>
<a href="#l23.26"></a><span id="l23.26"> </span>
<a href="#l23.27"></a><span id="l23.27">   // create a queue to process existing headers for the first time</span>
<a href="#l23.28"></a><span id="l23.28">   if (mExistingHeadersQ.IsEmpty())</span>
<a href="#l23.29"></a><span id="l23.29">   {</span>
<a href="#l23.30"></a><span id="l23.30" class="difflineminus">-    rv = database-&gt;ListAllKeys(mExistingHeadersQ);</span>
<a href="#l23.31"></a><span id="l23.31" class="difflineplus">+    nsRefPtr&lt;nsMsgKeyArray&gt; keys = new nsMsgKeyArray;</span>
<a href="#l23.32"></a><span id="l23.32" class="difflineplus">+    rv = database-&gt;ListAllKeys(keys);</span>
<a href="#l23.33"></a><span id="l23.33">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.34"></a><span id="l23.34" class="difflineplus">+    mExistingHeadersQ.AppendElements(keys-&gt;m_keys);</span>
<a href="#l23.35"></a><span id="l23.35">     mProcessPointer = 0;</span>
<a href="#l23.36"></a><span id="l23.36">   }</span>
<a href="#l23.37"></a><span id="l23.37"> </span>
<a href="#l23.38"></a><span id="l23.38">   // process the existing headers and find the messages not downloaded yet</span>
<a href="#l23.39"></a><span id="l23.39">   PRUint32 lastIdx = mProcessPointer;</span>
<a href="#l23.40"></a><span id="l23.40">   nsTArray&lt;nsMsgKey&gt; msgKeys;</span>
<a href="#l23.41"></a><span id="l23.41">   PRUint32 keyCount = mExistingHeadersQ.Length();</span>
<a href="#l23.42"></a><span id="l23.42">   for (; mProcessPointer &lt; (lastIdx + aNumOfHdrsToProcess) &amp;&amp; mProcessPointer &lt; keyCount; mProcessPointer++)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -59,16 +59,17 @@</span>
<a href="#l24.4"></a><span id="l24.4"> #include &quot;nsMsgFolderFlags.h&quot;</span>
<a href="#l24.5"></a><span id="l24.5"> #include &quot;nsImapFlagAndUidState.h&quot;</span>
<a href="#l24.6"></a><span id="l24.6"> #include &quot;nsISeekableStream.h&quot;</span>
<a href="#l24.7"></a><span id="l24.7"> #include &quot;nsThreadUtils.h&quot;</span>
<a href="#l24.8"></a><span id="l24.8"> #include &quot;nsIImapUrl.h&quot;</span>
<a href="#l24.9"></a><span id="l24.9"> #include &quot;nsImapUtils.h&quot;</span>
<a href="#l24.10"></a><span id="l24.10"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l24.11"></a><span id="l24.11"> #include &quot;nsIMsgMailSession.h&quot;</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineplus">+#include &quot;nsMsgKeyArray.h&quot;</span>
<a href="#l24.13"></a><span id="l24.13"> #include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l24.14"></a><span id="l24.14"> #include &quot;nsMsgLocalCID.h&quot;</span>
<a href="#l24.15"></a><span id="l24.15"> #include &quot;nsImapUndoTxn.h&quot;</span>
<a href="#l24.16"></a><span id="l24.16"> #include &quot;nsIIMAPHostSessionList.h&quot;</span>
<a href="#l24.17"></a><span id="l24.17"> #include &quot;nsIMsgCopyService.h&quot;</span>
<a href="#l24.18"></a><span id="l24.18"> #include &quot;nsICopyMsgStreamListener.h&quot;</span>
<a href="#l24.19"></a><span id="l24.19"> #include &quot;nsImapStringBundle.h&quot;</span>
<a href="#l24.20"></a><span id="l24.20"> #include &quot;nsIMsgFolderCacheElement.h&quot;</span>
<a href="#l24.21"></a><span id="l24.21" class="difflineat">@@ -1949,63 +1950,49 @@ nsImapMailFolder::SetLabelForMessages(ns</span>
<a href="#l24.22"></a><span id="l24.22"> }</span>
<a href="#l24.23"></a><span id="l24.23"> </span>
<a href="#l24.24"></a><span id="l24.24"> NS_IMETHODIMP</span>
<a href="#l24.25"></a><span id="l24.25"> nsImapMailFolder::MarkAllMessagesRead(nsIMsgWindow *aMsgWindow)</span>
<a href="#l24.26"></a><span id="l24.26"> {</span>
<a href="#l24.27"></a><span id="l24.27">   nsresult rv = GetDatabase();</span>
<a href="#l24.28"></a><span id="l24.28">   if(NS_SUCCEEDED(rv))</span>
<a href="#l24.29"></a><span id="l24.29">   {</span>
<a href="#l24.30"></a><span id="l24.30" class="difflineminus">-    nsTArray&lt;nsMsgKey&gt; thoseMarked;</span>
<a href="#l24.31"></a><span id="l24.31" class="difflineplus">+    nsMsgKey *thoseMarked;</span>
<a href="#l24.32"></a><span id="l24.32" class="difflineplus">+    PRUint32 numMarked;</span>
<a href="#l24.33"></a><span id="l24.33">     EnableNotifications(allMessageCountNotifications, PR_FALSE, PR_TRUE /*dbBatching*/);</span>
<a href="#l24.34"></a><span id="l24.34" class="difflineminus">-    rv = mDatabase-&gt;MarkAllRead(&amp;thoseMarked);</span>
<a href="#l24.35"></a><span id="l24.35" class="difflineplus">+    rv = mDatabase-&gt;MarkAllRead(&amp;numMarked, &amp;thoseMarked);</span>
<a href="#l24.36"></a><span id="l24.36">     EnableNotifications(allMessageCountNotifications, PR_TRUE, PR_TRUE /*dbBatching*/);</span>
<a href="#l24.37"></a><span id="l24.37">     if (NS_SUCCEEDED(rv))</span>
<a href="#l24.38"></a><span id="l24.38">     {</span>
<a href="#l24.39"></a><span id="l24.39" class="difflineminus">-      rv = StoreImapFlags(kImapMsgSeenFlag, PR_TRUE, thoseMarked.Elements(),</span>
<a href="#l24.40"></a><span id="l24.40" class="difflineminus">-                          thoseMarked.Length(), nsnull);</span>
<a href="#l24.41"></a><span id="l24.41" class="difflineplus">+      rv = StoreImapFlags(kImapMsgSeenFlag, PR_TRUE, thoseMarked,</span>
<a href="#l24.42"></a><span id="l24.42" class="difflineplus">+                          numMarked, nsnull);</span>
<a href="#l24.43"></a><span id="l24.43">       mDatabase-&gt;Commit(nsMsgDBCommitType::kLargeCommit);</span>
<a href="#l24.44"></a><span id="l24.44" class="difflineminus">-      </span>
<a href="#l24.45"></a><span id="l24.45" class="difflineplus">+</span>
<a href="#l24.46"></a><span id="l24.46">       // Setup a undo-state</span>
<a href="#l24.47"></a><span id="l24.47">       if (aMsgWindow)</span>
<a href="#l24.48"></a><span id="l24.48" class="difflineminus">-      {</span>
<a href="#l24.49"></a><span id="l24.49" class="difflineminus">-        nsRefPtr&lt;nsMsgReadStateTxn&gt; readStateTxn = new nsMsgReadStateTxn();    </span>
<a href="#l24.50"></a><span id="l24.50" class="difflineminus">-        if (!readStateTxn)</span>
<a href="#l24.51"></a><span id="l24.51" class="difflineminus">-          return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l24.52"></a><span id="l24.52" class="difflineminus">-        </span>
<a href="#l24.53"></a><span id="l24.53" class="difflineminus">-        rv = readStateTxn-&gt;Init(this, thoseMarked);</span>
<a href="#l24.54"></a><span id="l24.54" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.55"></a><span id="l24.55" class="difflineminus">-</span>
<a href="#l24.56"></a><span id="l24.56" class="difflineminus">-        rv = readStateTxn-&gt;SetTransactionType(nsIMessenger::eMarkAllMsg);</span>
<a href="#l24.57"></a><span id="l24.57" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.58"></a><span id="l24.58" class="difflineminus">-</span>
<a href="#l24.59"></a><span id="l24.59" class="difflineminus">-        nsCOMPtr&lt;nsITransactionManager&gt; txnMgr;</span>
<a href="#l24.60"></a><span id="l24.60" class="difflineminus">-        rv = aMsgWindow-&gt;GetTransactionManager(getter_AddRefs(txnMgr));</span>
<a href="#l24.61"></a><span id="l24.61" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.62"></a><span id="l24.62" class="difflineminus">-        </span>
<a href="#l24.63"></a><span id="l24.63" class="difflineminus">-        rv = txnMgr-&gt;DoTransaction(readStateTxn);</span>
<a href="#l24.64"></a><span id="l24.64" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.65"></a><span id="l24.65" class="difflineminus">-      }</span>
<a href="#l24.66"></a><span id="l24.66" class="difflineplus">+        rv = AddMarkAllReadUndoAction(aMsgWindow, thoseMarked, numMarked);</span>
<a href="#l24.67"></a><span id="l24.67" class="difflineplus">+      nsMemory::Free(thoseMarked);</span>
<a href="#l24.68"></a><span id="l24.68">     }</span>
<a href="#l24.69"></a><span id="l24.69">   }</span>
<a href="#l24.70"></a><span id="l24.70">   return rv;</span>
<a href="#l24.71"></a><span id="l24.71"> }</span>
<a href="#l24.72"></a><span id="l24.72"> </span>
<a href="#l24.73"></a><span id="l24.73"> NS_IMETHODIMP nsImapMailFolder::MarkThreadRead(nsIMsgThread *thread)</span>
<a href="#l24.74"></a><span id="l24.74"> {</span>
<a href="#l24.75"></a><span id="l24.75">   nsresult rv = GetDatabase();</span>
<a href="#l24.76"></a><span id="l24.76">   if(NS_SUCCEEDED(rv))</span>
<a href="#l24.77"></a><span id="l24.77">   {</span>
<a href="#l24.78"></a><span id="l24.78" class="difflineminus">-    nsTArray&lt;nsMsgKey&gt; thoseMarked;</span>
<a href="#l24.79"></a><span id="l24.79" class="difflineminus">-    rv = mDatabase-&gt;MarkThreadRead(thread, nsnull, &amp;thoseMarked);</span>
<a href="#l24.80"></a><span id="l24.80" class="difflineplus">+    nsMsgKey *keys;</span>
<a href="#l24.81"></a><span id="l24.81" class="difflineplus">+    PRUint32 numKeys;</span>
<a href="#l24.82"></a><span id="l24.82" class="difflineplus">+    rv = mDatabase-&gt;MarkThreadRead(thread, nsnull, &amp;numKeys, &amp;keys);</span>
<a href="#l24.83"></a><span id="l24.83">     if (NS_SUCCEEDED(rv))</span>
<a href="#l24.84"></a><span id="l24.84">     {</span>
<a href="#l24.85"></a><span id="l24.85" class="difflineminus">-      rv = StoreImapFlags(kImapMsgSeenFlag, PR_TRUE, thoseMarked.Elements(),</span>
<a href="#l24.86"></a><span id="l24.86" class="difflineminus">-                          thoseMarked.Length(), nsnull);</span>
<a href="#l24.87"></a><span id="l24.87" class="difflineplus">+      rv = StoreImapFlags(kImapMsgSeenFlag, PR_TRUE, keys, numKeys, nsnull);</span>
<a href="#l24.88"></a><span id="l24.88">       mDatabase-&gt;Commit(nsMsgDBCommitType::kLargeCommit);</span>
<a href="#l24.89"></a><span id="l24.89" class="difflineplus">+      nsMemory::Free(keys);</span>
<a href="#l24.90"></a><span id="l24.90">     }</span>
<a href="#l24.91"></a><span id="l24.91">   }</span>
<a href="#l24.92"></a><span id="l24.92">   return rv;</span>
<a href="#l24.93"></a><span id="l24.93"> }</span>
<a href="#l24.94"></a><span id="l24.94"> </span>
<a href="#l24.95"></a><span id="l24.95"> </span>
<a href="#l24.96"></a><span id="l24.96"> NS_IMETHODIMP nsImapMailFolder::ReadFromFolderCacheElem(nsIMsgFolderCacheElement *element)</span>
<a href="#l24.97"></a><span id="l24.97"> {</span>
<a href="#l24.98"></a><span id="l24.98" class="difflineat">@@ -2721,18 +2708,23 @@ NS_IMETHODIMP nsImapMailFolder::UpdateIm</span>
<a href="#l24.99"></a><span id="l24.99">     {</span>
<a href="#l24.100"></a><span id="l24.100">       dbFolderInfo-&gt;GetImapUidValidity(&amp;imapUIDValidity);</span>
<a href="#l24.101"></a><span id="l24.101">       PRUint64 mailboxHighestModSeq;</span>
<a href="#l24.102"></a><span id="l24.102">       aSpec-&gt;GetHighestModSeq(&amp;mailboxHighestModSeq);</span>
<a href="#l24.103"></a><span id="l24.103">       char intStrBuf[40];</span>
<a href="#l24.104"></a><span id="l24.104">       PR_snprintf(intStrBuf, sizeof(intStrBuf), &quot;%llu&quot;,  mailboxHighestModSeq);</span>
<a href="#l24.105"></a><span id="l24.105">       dbFolderInfo-&gt;SetCharProperty(kModSeqPropertyName, nsDependentCString(intStrBuf));</span>
<a href="#l24.106"></a><span id="l24.106">     }</span>
<a href="#l24.107"></a><span id="l24.107" class="difflineminus">-    mDatabase-&gt;ListAllKeys(existingKeys);</span>
<a href="#l24.108"></a><span id="l24.108" class="difflineminus">-    PRInt32 keyCount = existingKeys.Length();</span>
<a href="#l24.109"></a><span id="l24.109" class="difflineplus">+    nsRefPtr&lt;nsMsgKeyArray&gt; keys = new nsMsgKeyArray;</span>
<a href="#l24.110"></a><span id="l24.110" class="difflineplus">+    if (!keys)</span>
<a href="#l24.111"></a><span id="l24.111" class="difflineplus">+      return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l24.112"></a><span id="l24.112" class="difflineplus">+    rv = mDatabase-&gt;ListAllKeys(keys);</span>
<a href="#l24.113"></a><span id="l24.113" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.114"></a><span id="l24.114" class="difflineplus">+    existingKeys.AppendElements(keys-&gt;m_keys);</span>
<a href="#l24.115"></a><span id="l24.115" class="difflineplus">+    PRUint32 keyCount = existingKeys.Length();</span>
<a href="#l24.116"></a><span id="l24.116">     mDatabase-&gt;ListAllOfflineDeletes(&amp;existingKeys);</span>
<a href="#l24.117"></a><span id="l24.117">     if (keyCount &lt; existingKeys.Length())</span>
<a href="#l24.118"></a><span id="l24.118">       existingKeys.Sort();</span>
<a href="#l24.119"></a><span id="l24.119">   }</span>
<a href="#l24.120"></a><span id="l24.120">   PRInt32 folderValidity;</span>
<a href="#l24.121"></a><span id="l24.121">   aSpec-&gt;GetFolder_UIDVALIDITY(&amp;folderValidity);</span>
<a href="#l24.122"></a><span id="l24.122">   nsCOMPtr &lt;nsIImapFlagAndUidState&gt; flagState;</span>
<a href="#l24.123"></a><span id="l24.123">   aSpec-&gt;GetFlagState(getter_AddRefs(flagState));</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mailnews/imap/src/nsImapService.cpp</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapService.cpp</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -764,25 +764,27 @@ NS_IMETHODIMP nsImapService::CopyMessage</span>
<a href="#l25.4"></a><span id="l25.4">         imapAction = nsIImapUrl::nsImapOnlineToOfflineMove; </span>
<a href="#l25.5"></a><span id="l25.5">       rv = FetchMessage(imapUrl,imapAction, folder, imapMessageSink,aMsgWindow, </span>
<a href="#l25.6"></a><span id="l25.6">                         streamSupport, msgKey, PR_FALSE, EmptyCString(), aURL);</span>
<a href="#l25.7"></a><span id="l25.7">     } // if we got an imap message sink</span>
<a href="#l25.8"></a><span id="l25.8">   } // if we decomposed the imap message </span>
<a href="#l25.9"></a><span id="l25.9">   return rv;</span>
<a href="#l25.10"></a><span id="l25.10"> }</span>
<a href="#l25.11"></a><span id="l25.11"> </span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-NS_IMETHODIMP nsImapService::CopyMessages(nsTArray&lt;nsMsgKey&gt; &amp;keys, </span>
<a href="#l25.13"></a><span id="l25.13" class="difflineminus">-                                          nsIMsgFolder *srcFolder, </span>
<a href="#l25.14"></a><span id="l25.14" class="difflineminus">-                                          nsIStreamListener *aMailboxCopy, </span>
<a href="#l25.15"></a><span id="l25.15" class="difflineplus">+NS_IMETHODIMP nsImapService::CopyMessages(PRUint32 aNumKeys,</span>
<a href="#l25.16"></a><span id="l25.16" class="difflineplus">+                                          nsMsgKey*aKeys,</span>
<a href="#l25.17"></a><span id="l25.17" class="difflineplus">+                                          nsIMsgFolder *srcFolder,</span>
<a href="#l25.18"></a><span id="l25.18" class="difflineplus">+                                          nsIStreamListener *aMailboxCopy,</span>
<a href="#l25.19"></a><span id="l25.19">                                           PRBool moveMessage,</span>
<a href="#l25.20"></a><span id="l25.20" class="difflineminus">-                                          nsIUrlListener *aUrlListener, </span>
<a href="#l25.21"></a><span id="l25.21" class="difflineplus">+                                          nsIUrlListener *aUrlListener,</span>
<a href="#l25.22"></a><span id="l25.22">                                           nsIMsgWindow *aMsgWindow, </span>
<a href="#l25.23"></a><span id="l25.23">                                           nsIURI **aURL)</span>
<a href="#l25.24"></a><span id="l25.24"> {</span>
<a href="#l25.25"></a><span id="l25.25">   NS_ENSURE_ARG_POINTER(aMailboxCopy);</span>
<a href="#l25.26"></a><span id="l25.26" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aKeys);</span>
<a href="#l25.27"></a><span id="l25.27"> </span>
<a href="#l25.28"></a><span id="l25.28">   nsresult rv;</span>
<a href="#l25.29"></a><span id="l25.29">   nsCOMPtr&lt;nsISupports&gt; streamSupport = do_QueryInterface(aMailboxCopy, &amp;rv);</span>
<a href="#l25.30"></a><span id="l25.30">   if (!streamSupport || NS_FAILED(rv)) </span>
<a href="#l25.31"></a><span id="l25.31">     return rv;</span>
<a href="#l25.32"></a><span id="l25.32">   </span>
<a href="#l25.33"></a><span id="l25.33">   nsCOMPtr&lt;nsIMsgFolder&gt; folder = srcFolder;</span>
<a href="#l25.34"></a><span id="l25.34">   nsCAutoString msgKey;</span>
<a href="#l25.35"></a><span id="l25.35" class="difflineat">@@ -790,21 +792,20 @@ NS_IMETHODIMP nsImapService::CopyMessage</span>
<a href="#l25.36"></a><span id="l25.36">   {</span>
<a href="#l25.37"></a><span id="l25.37">     nsCOMPtr&lt;nsIImapMessageSink&gt; imapMessageSink(do_QueryInterface(folder, &amp;rv));</span>
<a href="#l25.38"></a><span id="l25.38">     if (NS_SUCCEEDED(rv))</span>
<a href="#l25.39"></a><span id="l25.39">     {</span>
<a href="#l25.40"></a><span id="l25.40">       // we generate the uri for the first message so that way on down the line,</span>
<a href="#l25.41"></a><span id="l25.41">       // GetMessage in nsCopyMessageStreamListener will get an unescaped username</span>
<a href="#l25.42"></a><span id="l25.42">       // and be able to find the msg hdr. See bug 259656 for details</span>
<a href="#l25.43"></a><span id="l25.43">       nsCString uri;</span>
<a href="#l25.44"></a><span id="l25.44" class="difflineminus">-      srcFolder-&gt;GenerateMessageURI(keys[0], uri);</span>
<a href="#l25.45"></a><span id="l25.45" class="difflineplus">+      srcFolder-&gt;GenerateMessageURI(aKeys[0], uri);</span>
<a href="#l25.46"></a><span id="l25.46"> </span>
<a href="#l25.47"></a><span id="l25.47">       nsCString messageIds;</span>
<a href="#l25.48"></a><span id="l25.48" class="difflineminus">-      PRUint32 numKeys = keys.Length();</span>
<a href="#l25.49"></a><span id="l25.49" class="difflineminus">-      AllocateImapUidString(keys.Elements(), numKeys, nsnull, messageIds);</span>
<a href="#l25.50"></a><span id="l25.50" class="difflineplus">+      AllocateImapUidString(aKeys, aNumKeys, nsnull, messageIds);</span>
<a href="#l25.51"></a><span id="l25.51">       nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l25.52"></a><span id="l25.52">       nsCAutoString urlSpec;</span>
<a href="#l25.53"></a><span id="l25.53">       char hierarchyDelimiter = GetHierarchyDelimiter(folder);</span>
<a href="#l25.54"></a><span id="l25.54">       rv = CreateStartOfImapUrl(uri, getter_AddRefs(imapUrl), folder, aUrlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l25.55"></a><span id="l25.55">       nsImapAction action;</span>
<a href="#l25.56"></a><span id="l25.56">       if (moveMessage) // don't use ?: syntax here, it seems to break the Mac.</span>
<a href="#l25.57"></a><span id="l25.57">         action = nsIImapUrl::nsImapOnlineToOfflineMove;</span>
<a href="#l25.58"></a><span id="l25.58">       else</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/mailnews/local/src/nsLocalMailFolder.cpp</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/mailnews/local/src/nsLocalMailFolder.cpp</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -3016,17 +3016,21 @@ nsresult nsMsgLocalMailFolder::CopyMessa</span>
<a href="#l26.4"></a><span id="l26.4">     // before starting the next message. Only do this if the source folder</span>
<a href="#l26.5"></a><span id="l26.5">     // is a local folder, however. IMAP will handle calling StartMessage for</span>
<a href="#l26.6"></a><span id="l26.6">     // each message that gets downloaded, and news doesn't go through here</span>
<a href="#l26.7"></a><span id="l26.7">     // because news only downloads one message at a time, and this routine</span>
<a href="#l26.8"></a><span id="l26.8">     // is for multiple message copy.</span>
<a href="#l26.9"></a><span id="l26.9">     nsCOMPtr &lt;nsIMsgLocalMailFolder&gt; srcLocalFolder = do_QueryInterface(srcFolder);</span>
<a href="#l26.10"></a><span id="l26.10">     if (srcLocalFolder)</span>
<a href="#l26.11"></a><span id="l26.11">       StartMessage();</span>
<a href="#l26.12"></a><span id="l26.12" class="difflineminus">-    rv = mCopyState-&gt;m_messageService-&gt;CopyMessages(keyArray, srcFolder, streamListener, isMove, nsnull, aMsgWindow, nsnull);</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineplus">+    rv = mCopyState-&gt;m_messageService-&gt;CopyMessages(keyArray.Length(),</span>
<a href="#l26.14"></a><span id="l26.14" class="difflineplus">+                                                    keyArray.Elements(),</span>
<a href="#l26.15"></a><span id="l26.15" class="difflineplus">+                                                    srcFolder, streamListener,</span>
<a href="#l26.16"></a><span id="l26.16" class="difflineplus">+                                                    isMove, nsnull, aMsgWindow,</span>
<a href="#l26.17"></a><span id="l26.17" class="difflineplus">+                                                    nsnull);</span>
<a href="#l26.18"></a><span id="l26.18">   }</span>
<a href="#l26.19"></a><span id="l26.19">   return rv;</span>
<a href="#l26.20"></a><span id="l26.20"> }</span>
<a href="#l26.21"></a><span id="l26.21"> </span>
<a href="#l26.22"></a><span id="l26.22"> nsresult nsMsgLocalMailFolder::CopyMessageTo(nsISupports *message,</span>
<a href="#l26.23"></a><span id="l26.23">                                              nsIMsgFolder *dstFolder /* dst same as &quot;this&quot; */,</span>
<a href="#l26.24"></a><span id="l26.24">                                              nsIMsgWindow *aMsgWindow,</span>
<a href="#l26.25"></a><span id="l26.25">                                              PRBool isMove)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/mailnews/local/src/nsMailboxService.cpp</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/mailnews/local/src/nsMailboxService.cpp</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -120,52 +120,54 @@ nsresult nsMailboxService::CopyMessage(c</span>
<a href="#l27.4"></a><span id="l27.4">                               nsIURI **aURL)</span>
<a href="#l27.5"></a><span id="l27.5"> {</span>
<a href="#l27.6"></a><span id="l27.6">     nsMailboxAction mailboxAction = nsIMailboxUrl::ActionMoveMessage;</span>
<a href="#l27.7"></a><span id="l27.7">     if (!moveMessage)</span>
<a href="#l27.8"></a><span id="l27.8">         mailboxAction = nsIMailboxUrl::ActionCopyMessage;</span>
<a href="#l27.9"></a><span id="l27.9">   return FetchMessage(aSrcMailboxURI, aMailboxCopyHandler, aMsgWindow, aUrlListener, nsnull, mailboxAction, nsnull, aURL);</span>
<a href="#l27.10"></a><span id="l27.10"> }</span>
<a href="#l27.11"></a><span id="l27.11"> </span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-nsresult nsMailboxService::CopyMessages(nsTArray&lt;nsMsgKey&gt; &amp;msgKeys,</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineminus">-                              nsIMsgFolder *srcFolder,</span>
<a href="#l27.14"></a><span id="l27.14" class="difflineminus">-                              nsIStreamListener * aMailboxCopyHandler,</span>
<a href="#l27.15"></a><span id="l27.15" class="difflineminus">-                              PRBool moveMessage,</span>
<a href="#l27.16"></a><span id="l27.16" class="difflineminus">-                              nsIUrlListener * aUrlListener,</span>
<a href="#l27.17"></a><span id="l27.17" class="difflineminus">-                              nsIMsgWindow *aMsgWindow,</span>
<a href="#l27.18"></a><span id="l27.18" class="difflineminus">-                              nsIURI **aURL)</span>
<a href="#l27.19"></a><span id="l27.19" class="difflineplus">+nsresult nsMailboxService::CopyMessages(PRUint32 aNumKeys,</span>
<a href="#l27.20"></a><span id="l27.20" class="difflineplus">+                                        nsMsgKey* aMsgKeys,</span>
<a href="#l27.21"></a><span id="l27.21" class="difflineplus">+                                        nsIMsgFolder *srcFolder,</span>
<a href="#l27.22"></a><span id="l27.22" class="difflineplus">+                                        nsIStreamListener * aMailboxCopyHandler,</span>
<a href="#l27.23"></a><span id="l27.23" class="difflineplus">+                                        PRBool moveMessage,</span>
<a href="#l27.24"></a><span id="l27.24" class="difflineplus">+                                        nsIUrlListener * aUrlListener,</span>
<a href="#l27.25"></a><span id="l27.25" class="difflineplus">+                                        nsIMsgWindow *aMsgWindow,</span>
<a href="#l27.26"></a><span id="l27.26" class="difflineplus">+                                        nsIURI **aURL)</span>
<a href="#l27.27"></a><span id="l27.27"> {</span>
<a href="#l27.28"></a><span id="l27.28">   nsresult rv = NS_OK;</span>
<a href="#l27.29"></a><span id="l27.29">   NS_ENSURE_ARG(srcFolder);</span>
<a href="#l27.30"></a><span id="l27.30" class="difflineplus">+  NS_ENSURE_ARG(aMsgKeys);</span>
<a href="#l27.31"></a><span id="l27.31">   nsCOMPtr&lt;nsIMailboxUrl&gt; mailboxurl;</span>
<a href="#l27.32"></a><span id="l27.32"> </span>
<a href="#l27.33"></a><span id="l27.33">   nsMailboxAction actionToUse = nsIMailboxUrl::ActionMoveMessage;</span>
<a href="#l27.34"></a><span id="l27.34">   if (!moveMessage)</span>
<a href="#l27.35"></a><span id="l27.35">      actionToUse = nsIMailboxUrl::ActionCopyMessage;</span>
<a href="#l27.36"></a><span id="l27.36"> </span>
<a href="#l27.37"></a><span id="l27.37">   nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l27.38"></a><span id="l27.38">   nsCOMPtr &lt;nsIMsgDatabase&gt; db;</span>
<a href="#l27.39"></a><span id="l27.39">   srcFolder-&gt;GetMsgDatabase(getter_AddRefs(db));</span>
<a href="#l27.40"></a><span id="l27.40">   if (db)</span>
<a href="#l27.41"></a><span id="l27.41">   {</span>
<a href="#l27.42"></a><span id="l27.42" class="difflineminus">-    db-&gt;GetMsgHdrForKey(msgKeys[0], getter_AddRefs(msgHdr));</span>
<a href="#l27.43"></a><span id="l27.43" class="difflineplus">+    db-&gt;GetMsgHdrForKey(aMsgKeys[0], getter_AddRefs(msgHdr));</span>
<a href="#l27.44"></a><span id="l27.44">     if (msgHdr)</span>
<a href="#l27.45"></a><span id="l27.45">     {</span>
<a href="#l27.46"></a><span id="l27.46">       nsCString uri;</span>
<a href="#l27.47"></a><span id="l27.47">       srcFolder-&gt;GetUriForMsg(msgHdr, uri);</span>
<a href="#l27.48"></a><span id="l27.48">       rv = PrepareMessageUrl(uri.get(), aUrlListener, actionToUse , getter_AddRefs(mailboxurl), aMsgWindow);</span>
<a href="#l27.49"></a><span id="l27.49"> </span>
<a href="#l27.50"></a><span id="l27.50">       if (NS_SUCCEEDED(rv))</span>
<a href="#l27.51"></a><span id="l27.51">       {</span>
<a href="#l27.52"></a><span id="l27.52">         nsCOMPtr&lt;nsIURI&gt; url = do_QueryInterface(mailboxurl);</span>
<a href="#l27.53"></a><span id="l27.53">         nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgUrl (do_QueryInterface(url));</span>
<a href="#l27.54"></a><span id="l27.54">         nsCOMPtr&lt;nsIMailboxUrl&gt; mailboxUrl (do_QueryInterface(url));</span>
<a href="#l27.55"></a><span id="l27.55">         msgUrl-&gt;SetMsgWindow(aMsgWindow);</span>
<a href="#l27.56"></a><span id="l27.56"> </span>
<a href="#l27.57"></a><span id="l27.57" class="difflineminus">-        mailboxUrl-&gt;SetMoveCopyMsgKeys(msgKeys.Elements(), msgKeys.Length());</span>
<a href="#l27.58"></a><span id="l27.58" class="difflineplus">+        mailboxUrl-&gt;SetMoveCopyMsgKeys(aMsgKeys, aNumKeys);</span>
<a href="#l27.59"></a><span id="l27.59">         rv = RunMailboxUrl(url, aMailboxCopyHandler);</span>
<a href="#l27.60"></a><span id="l27.60">       }</span>
<a href="#l27.61"></a><span id="l27.61">     }</span>
<a href="#l27.62"></a><span id="l27.62">   }</span>
<a href="#l27.63"></a><span id="l27.63">   if (aURL &amp;&amp; mailboxurl)</span>
<a href="#l27.64"></a><span id="l27.64">     CallQueryInterface(mailboxurl, aURL);</span>
<a href="#l27.65"></a><span id="l27.65"> </span>
<a href="#l27.66"></a><span id="l27.66">   return rv;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/mailnews/local/src/nsPop3IncomingServer.cpp</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/mailnews/local/src/nsPop3IncomingServer.cpp</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -43,16 +43,18 @@</span>
<a href="#l28.4"></a><span id="l28.4"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l28.5"></a><span id="l28.5"> #include &quot;nsIPop3IncomingServer.h&quot;</span>
<a href="#l28.6"></a><span id="l28.6"> #include &quot;nsPop3IncomingServer.h&quot;</span>
<a href="#l28.7"></a><span id="l28.7"> #include &quot;nsIPop3Service.h&quot;</span>
<a href="#l28.8"></a><span id="l28.8"> #include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l28.9"></a><span id="l28.9"> #include &quot;nsMsgLocalCID.h&quot;</span>
<a href="#l28.10"></a><span id="l28.10"> #include &quot;nsMsgFolderFlags.h&quot;</span>
<a href="#l28.11"></a><span id="l28.11"> #include &quot;nsPop3Protocol.h&quot;</span>
<a href="#l28.12"></a><span id="l28.12" class="difflineplus">+#include &quot;nsAutoPtr.h&quot;</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineplus">+#include &quot;nsMsgKeyArray.h&quot;</span>
<a href="#l28.14"></a><span id="l28.14"> #include &quot;nsIMsgLocalMailFolder.h&quot;</span>
<a href="#l28.15"></a><span id="l28.15"> #include &quot;nsIMsgAccountManager.h&quot;</span>
<a href="#l28.16"></a><span id="l28.16"> #include &quot;nsIMsgMailNewsUrl.h&quot;</span>
<a href="#l28.17"></a><span id="l28.17"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l28.18"></a><span id="l28.18"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l28.19"></a><span id="l28.19"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l28.20"></a><span id="l28.20"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l28.21"></a><span id="l28.21"> </span>
<a href="#l28.22"></a><span id="l28.22" class="difflineat">@@ -188,20 +190,20 @@ NS_IMETHODIMP nsPop3IncomingServer::GetD</span>
<a href="#l28.23"></a><span id="l28.23">               if (subFolder)</span>
<a href="#l28.24"></a><span id="l28.24">               {</span>
<a href="#l28.25"></a><span id="l28.25">                 nsCOMPtr&lt;nsIMsgDatabase&gt; subFolderDB;</span>
<a href="#l28.26"></a><span id="l28.26">                 subFolder-&gt;GetMsgDatabase(getter_AddRefs(subFolderDB));</span>
<a href="#l28.27"></a><span id="l28.27">                 if (subFolderDB)</span>
<a href="#l28.28"></a><span id="l28.28">                 {</span>
<a href="#l28.29"></a><span id="l28.29">                   // Copy any messages in this sub-folder of the hidden</span>
<a href="#l28.30"></a><span id="l28.30">                   // account to the corresponding folder in Local Folders.</span>
<a href="#l28.31"></a><span id="l28.31" class="difflineminus">-                  nsTArray&lt;nsMsgKey&gt; keys;</span>
<a href="#l28.32"></a><span id="l28.32" class="difflineplus">+                  nsRefPtr&lt;nsMsgKeyArray&gt; keys = new nsMsgKeyArray;</span>
<a href="#l28.33"></a><span id="l28.33">                   rv = subFolderDB-&gt;ListAllKeys(keys);</span>
<a href="#l28.34"></a><span id="l28.34">                   nsCOMPtr&lt;nsIMutableArray&gt; hdrsToCopy(do_CreateInstance(NS_ARRAY_CONTRACTID));</span>
<a href="#l28.35"></a><span id="l28.35" class="difflineminus">-                  MsgGetHeadersFromKeys(subFolderDB, keys, hdrsToCopy);</span>
<a href="#l28.36"></a><span id="l28.36" class="difflineplus">+                  MsgGetHeadersFromKeys(subFolderDB, keys-&gt;m_keys, hdrsToCopy);</span>
<a href="#l28.37"></a><span id="l28.37">                   PRUint32 numHdrs = 0;</span>
<a href="#l28.38"></a><span id="l28.38">                   if (hdrsToCopy)</span>
<a href="#l28.39"></a><span id="l28.39">                     hdrsToCopy-&gt;GetLength(&amp;numHdrs);</span>
<a href="#l28.40"></a><span id="l28.40">                   if (numHdrs)</span>
<a href="#l28.41"></a><span id="l28.41">                   {</span>
<a href="#l28.42"></a><span id="l28.42">                     // Look for a folder with the same name in Local Folders.</span>
<a href="#l28.43"></a><span id="l28.43">                     nsCOMPtr&lt;nsIMsgFolder&gt; dest;</span>
<a href="#l28.44"></a><span id="l28.44">                     nsString folderName;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/mailnews/mapi/mapihook/src/msgMapiImp.cpp</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/mailnews/mapi/mapihook/src/msgMapiImp.cpp</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -52,16 +52,17 @@</span>
<a href="#l29.4"></a><span id="l29.4"> #include &quot;msgMapiHook.h&quot;</span>
<a href="#l29.5"></a><span id="l29.5"> #include &quot;nsStringGlue.h&quot;</span>
<a href="#l29.6"></a><span id="l29.6"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l29.7"></a><span id="l29.7"> #include &quot;nsISupports.h&quot;</span>
<a href="#l29.8"></a><span id="l29.8"> #include &quot;nsMsgCompCID.h&quot;</span>
<a href="#l29.9"></a><span id="l29.9"> #include &quot;nsIMsgDatabase.h&quot;</span>
<a href="#l29.10"></a><span id="l29.10"> #include &quot;nsMsgFolderFlags.h&quot;</span>
<a href="#l29.11"></a><span id="l29.11"> #include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l29.12"></a><span id="l29.12" class="difflineplus">+#include &quot;MailNewsTypes.h&quot;</span>
<a href="#l29.13"></a><span id="l29.13"> #include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l29.14"></a><span id="l29.14"> #include &quot;nsIMsgAccountManager.h&quot;</span>
<a href="#l29.15"></a><span id="l29.15"> #include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l29.16"></a><span id="l29.16"> #include &quot;nsIMsgImapMailFolder.h&quot;</span>
<a href="#l29.17"></a><span id="l29.17"> #include &lt;time.h&gt;</span>
<a href="#l29.18"></a><span id="l29.18"> #include &quot;nsIInputStream.h&quot;</span>
<a href="#l29.19"></a><span id="l29.19"> #include &quot;nsIMsgHeaderParser.h&quot;</span>
<a href="#l29.20"></a><span id="l29.20"> #include &quot;nsILineInputStream.h&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/mailnews/news/src/nsNNTPArticleList.cpp</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/mailnews/news/src/nsNNTPArticleList.cpp</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -35,16 +35,18 @@</span>
<a href="#l30.4"></a><span id="l30.4">  *</span>
<a href="#l30.5"></a><span id="l30.5">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l30.6"></a><span id="l30.6"> </span>
<a href="#l30.7"></a><span id="l30.7"> #include &quot;msgCore.h&quot;    // precompiled header...</span>
<a href="#l30.8"></a><span id="l30.8"> </span>
<a href="#l30.9"></a><span id="l30.9"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l30.10"></a><span id="l30.10"> #include &quot;nsNNTPArticleList.h&quot;</span>
<a href="#l30.11"></a><span id="l30.11"> #include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l30.12"></a><span id="l30.12" class="difflineplus">+#include &quot;nsAutoPtr.h&quot;</span>
<a href="#l30.13"></a><span id="l30.13" class="difflineplus">+#include &quot;nsMsgKeyArray.h&quot;</span>
<a href="#l30.14"></a><span id="l30.14"> </span>
<a href="#l30.15"></a><span id="l30.15"> NS_IMPL_ISUPPORTS1(nsNNTPArticleList, nsINNTPArticleList)</span>
<a href="#l30.16"></a><span id="l30.16"> </span>
<a href="#l30.17"></a><span id="l30.17"> nsNNTPArticleList::nsNNTPArticleList()</span>
<a href="#l30.18"></a><span id="l30.18"> {</span>
<a href="#l30.19"></a><span id="l30.19"> }</span>
<a href="#l30.20"></a><span id="l30.20"> </span>
<a href="#l30.21"></a><span id="l30.21"> nsNNTPArticleList::~nsNNTPArticleList()</span>
<a href="#l30.22"></a><span id="l30.22" class="difflineat">@@ -70,18 +72,20 @@ nsNNTPArticleList::Initialize(nsIMsgNews</span>
<a href="#l30.23"></a><span id="l30.23"> </span>
<a href="#l30.24"></a><span id="l30.24">     nsCOMPtr &lt;nsIMsgFolder&gt; folder = do_QueryInterface(m_newsFolder, &amp;rv);</span>
<a href="#l30.25"></a><span id="l30.25">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l30.26"></a><span id="l30.26"> </span>
<a href="#l30.27"></a><span id="l30.27">     rv = folder-&gt;GetMsgDatabase(getter_AddRefs(m_newsDB));</span>
<a href="#l30.28"></a><span id="l30.28">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l30.29"></a><span id="l30.29">     if (!m_newsDB) return NS_ERROR_UNEXPECTED;</span>
<a href="#l30.30"></a><span id="l30.30"> </span>
<a href="#l30.31"></a><span id="l30.31" class="difflineminus">-    rv = m_newsDB-&gt;ListAllKeys(m_idsInDB);</span>
<a href="#l30.32"></a><span id="l30.32" class="difflineplus">+    nsRefPtr&lt;nsMsgKeyArray&gt; keys = new nsMsgKeyArray;</span>
<a href="#l30.33"></a><span id="l30.33" class="difflineplus">+    rv = m_newsDB-&gt;ListAllKeys(keys);</span>
<a href="#l30.34"></a><span id="l30.34">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l30.35"></a><span id="l30.35" class="difflineplus">+    m_idsInDB.AppendElements(keys-&gt;m_keys);</span>
<a href="#l30.36"></a><span id="l30.36"> </span>
<a href="#l30.37"></a><span id="l30.37">     return NS_OK;</span>
<a href="#l30.38"></a><span id="l30.38"> }</span>
<a href="#l30.39"></a><span id="l30.39"> </span>
<a href="#l30.40"></a><span id="l30.40"> NS_IMETHODIMP</span>
<a href="#l30.41"></a><span id="l30.41"> nsNNTPArticleList::AddArticleKey(PRInt32 key)</span>
<a href="#l30.42"></a><span id="l30.42"> {</span>
<a href="#l30.43"></a><span id="l30.43"> #ifdef DEBUG</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/mailnews/news/src/nsNewsFolder.cpp</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/mailnews/news/src/nsNewsFolder.cpp</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -1678,17 +1678,17 @@ NS_IMETHODIMP nsMsgNewsFolder::RemoveMes</span>
<a href="#l31.4"></a><span id="l31.4">   }</span>
<a href="#l31.5"></a><span id="l31.5">   return mDatabase-&gt;DeleteMessage(key, nsnull, PR_FALSE);</span>
<a href="#l31.6"></a><span id="l31.6"> }</span>
<a href="#l31.7"></a><span id="l31.7"> </span>
<a href="#l31.8"></a><span id="l31.8"> NS_IMETHODIMP nsMsgNewsFolder::RemoveMessages(nsTArray&lt;nsMsgKey&gt; &amp;aMsgKeys)</span>
<a href="#l31.9"></a><span id="l31.9"> {</span>
<a href="#l31.10"></a><span id="l31.10">   nsresult rv = GetDatabase();</span>
<a href="#l31.11"></a><span id="l31.11">   NS_ENSURE_SUCCESS(rv, rv); // if GetDatabase succeeds, mDatabase will be non-null</span>
<a href="#l31.12"></a><span id="l31.12" class="difflineminus">-  </span>
<a href="#l31.13"></a><span id="l31.13" class="difflineplus">+</span>
<a href="#l31.14"></a><span id="l31.14">   // Notify listeners of a multiple message delete</span>
<a href="#l31.15"></a><span id="l31.15">   nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l31.16"></a><span id="l31.16"> </span>
<a href="#l31.17"></a><span id="l31.17">   if (notifier)</span>
<a href="#l31.18"></a><span id="l31.18">   {</span>
<a href="#l31.19"></a><span id="l31.19">     nsCOMPtr&lt;nsIMutableArray&gt; msgHdrs(do_CreateInstance(NS_ARRAY_CONTRACTID));</span>
<a href="#l31.20"></a><span id="l31.20">     rv = MsgGetHeadersFromKeys(mDatabase, aMsgKeys, msgHdrs);</span>
<a href="#l31.21"></a><span id="l31.21">     NS_ENSURE_SUCCESS(rv, rv);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/mailnews/news/src/nsNntpService.cpp</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/mailnews/news/src/nsNntpService.cpp</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -711,18 +711,23 @@ nsNntpService::CopyMessage(const char * </span>
<a href="#l32.4"></a><span id="l32.4">   nsCOMPtr&lt;nsISupports&gt; streamSupport = do_QueryInterface(aMailboxCopyHandler, &amp;rv);</span>
<a href="#l32.5"></a><span id="l32.5">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l32.6"></a><span id="l32.6"> </span>
<a href="#l32.7"></a><span id="l32.7">   rv = DisplayMessage(aSrcMessageURI, streamSupport, aMsgWindow, aUrlListener, nsnull, aURL);</span>
<a href="#l32.8"></a><span id="l32.8">   return rv;</span>
<a href="#l32.9"></a><span id="l32.9"> }</span>
<a href="#l32.10"></a><span id="l32.10"> </span>
<a href="#l32.11"></a><span id="l32.11"> NS_IMETHODIMP</span>
<a href="#l32.12"></a><span id="l32.12" class="difflineminus">-nsNntpService::CopyMessages(nsTArray&lt;nsMsgKey&gt; &amp;keys, nsIMsgFolder *srcFolder, nsIStreamListener * aMailboxCopyHandler, PRBool moveMessage,</span>
<a href="#l32.13"></a><span id="l32.13" class="difflineminus">-               nsIUrlListener * aUrlListener, nsIMsgWindow *aMsgWindow, nsIURI **aURL)</span>
<a href="#l32.14"></a><span id="l32.14" class="difflineplus">+nsNntpService::CopyMessages(PRUint32 aNumKeys, nsMsgKey *akeys,</span>
<a href="#l32.15"></a><span id="l32.15" class="difflineplus">+                            nsIMsgFolder *srcFolder,</span>
<a href="#l32.16"></a><span id="l32.16" class="difflineplus">+                            nsIStreamListener * aMailboxCopyHandler,</span>
<a href="#l32.17"></a><span id="l32.17" class="difflineplus">+                            PRBool moveMessage,</span>
<a href="#l32.18"></a><span id="l32.18" class="difflineplus">+                            nsIUrlListener * aUrlListener,</span>
<a href="#l32.19"></a><span id="l32.19" class="difflineplus">+                            nsIMsgWindow *aMsgWindow,</span>
<a href="#l32.20"></a><span id="l32.20" class="difflineplus">+                            nsIURI **aURL)</span>
<a href="#l32.21"></a><span id="l32.21"> {</span>
<a href="#l32.22"></a><span id="l32.22">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l32.23"></a><span id="l32.23"> }</span>
<a href="#l32.24"></a><span id="l32.24"> </span>
<a href="#l32.25"></a><span id="l32.25"> struct findNewsServerEntry {</span>
<a href="#l32.26"></a><span id="l32.26">   const char *newsgroup;</span>
<a href="#l32.27"></a><span id="l32.27">   nsINntpIncomingServer *server;</span>
<a href="#l32.28"></a><span id="l32.28"> };</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

