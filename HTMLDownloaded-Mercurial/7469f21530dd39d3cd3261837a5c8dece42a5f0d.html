<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 6584:7469f21530dd39d3cd3261837a5c8dece42a5f0d</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 7469f21530dd39d3cd3261837a5c8dece42a5f0d" />
<meta property="og:url" content="/comm-central/rev/7469f21530dd39d3cd3261837a5c8dece42a5f0d" />
<meta property="og:description" content="Bug 537900 - attachment code for apple encode isn't 64-bit compatible; r=Standard8 a=Standard8 for checkin to CLOSED TREE" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 7469f21530dd39d3cd3261837a5c8dece42a5f0d 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/7469f21530dd39d3cd3261837a5c8dece42a5f0d">shortlog</a> |
<a href="/comm-central/log/7469f21530dd39d3cd3261837a5c8dece42a5f0d">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/7469f21530dd39d3cd3261837a5c8dece42a5f0d">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/7469f21530dd39d3cd3261837a5c8dece42a5f0d">files</a> |
changeset |
<a href="/comm-central/raw-rev/7469f21530dd39d3cd3261837a5c8dece42a5f0d">raw</a>  | <a href="/comm-central/archive/7469f21530dd39d3cd3261837a5c8dece42a5f0d.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=537900">Bug 537900</a> - attachment code for apple encode isn't 64-bit compatible; r=Standard8 a=Standard8 for checkin to CLOSED TREE
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#77;&#97;&#107;&#111;&#116;&#111;&#32;&#75;&#97;&#116;&#111;&#32;&#60;&#109;&#95;&#107;&#97;&#116;&#111;&#64;&#103;&#97;&#50;&#46;&#115;&#111;&#45;&#110;&#101;&#116;&#46;&#110;&#101;&#46;&#106;&#112;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 25 Oct 2010 14:16:23 +0100</td></tr>

<tr>
 <td>changeset 6584</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/7469f21530dd39d3cd3261837a5c8dece42a5f0d">7469f21530dd39d3cd3261837a5c8dece42a5f0d</a></td>
</tr>



<tr>
<td>parent 6583</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/6bf6e5d776c24cabdd70b731146a7e855c0b4b7e">6bf6e5d776c24cabdd70b731146a7e855c0b4b7e</a>
</td>
</tr>

<tr>
<td>child 6585</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/65d2e55e4313ae5da2c8d32a7b44c8865a3835b5">65d2e55e4313ae5da2c8d32a7b44c8865a3835b5</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=7469f21530dd39d3cd3261837a5c8dece42a5f0d">5071</a></td></tr>
<tr><td>push user</td><td>bugzilla@standard8.plus.com</td></tr>
<tr><td>push date</td><td class="date age">Mon, 25 Oct 2010 13:19:50 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@7469f21530dd [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=7469f21530dd39d3cd3261837a5c8dece42a5f0d">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=7469f21530dd39d3cd3261837a5c8dece42a5f0d&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=7469f21530dd39d3cd3261837a5c8dece42a5f0d&newProject=comm-central&newRevision=02c02a7eeed85afca252b630f0e053e6a3a9fa34&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=7469f21530dd39d3cd3261837a5c8dece42a5f0d&newProject=comm-central&newRevision=02c02a7eeed85afca252b630f0e053e6a3a9fa34&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=7469f21530dd39d3cd3261837a5c8dece42a5f0d&newProject=comm-central&newRevision=02c02a7eeed85afca252b630f0e053e6a3a9fa34&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28Standard8%29&revcount=50">Standard8</a>, <a href="/comm-central/log?rev=reviewer%28Standard8%29&revcount=50">Standard8</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=537900">537900</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=537900">Bug 537900</a> - attachment code for apple encode isn't 64-bit compatible; r=Standard8 a=Standard8 for checkin to CLOSED TREE</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7469f21530dd39d3cd3261837a5c8dece42a5f0d/mailnews/compose/src/nsMsgAppleDouble.h">mailnews/compose/src/nsMsgAppleDouble.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7469f21530dd39d3cd3261837a5c8dece42a5f0d/mailnews/compose/src/nsMsgAppleDouble.h">file</a> |
<a href="/comm-central/annotate/7469f21530dd39d3cd3261837a5c8dece42a5f0d/mailnews/compose/src/nsMsgAppleDouble.h">annotate</a> |
<a href="/comm-central/diff/7469f21530dd39d3cd3261837a5c8dece42a5f0d/mailnews/compose/src/nsMsgAppleDouble.h">diff</a> |
<a href="/comm-central/comparison/7469f21530dd39d3cd3261837a5c8dece42a5f0d/mailnews/compose/src/nsMsgAppleDouble.h">comparison</a> |
<a href="/comm-central/log/7469f21530dd39d3cd3261837a5c8dece42a5f0d/mailnews/compose/src/nsMsgAppleDouble.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7469f21530dd39d3cd3261837a5c8dece42a5f0d/mailnews/compose/src/nsMsgAppleDoubleEncode.cpp">mailnews/compose/src/nsMsgAppleDoubleEncode.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7469f21530dd39d3cd3261837a5c8dece42a5f0d/mailnews/compose/src/nsMsgAppleDoubleEncode.cpp">file</a> |
<a href="/comm-central/annotate/7469f21530dd39d3cd3261837a5c8dece42a5f0d/mailnews/compose/src/nsMsgAppleDoubleEncode.cpp">annotate</a> |
<a href="/comm-central/diff/7469f21530dd39d3cd3261837a5c8dece42a5f0d/mailnews/compose/src/nsMsgAppleDoubleEncode.cpp">diff</a> |
<a href="/comm-central/comparison/7469f21530dd39d3cd3261837a5c8dece42a5f0d/mailnews/compose/src/nsMsgAppleDoubleEncode.cpp">comparison</a> |
<a href="/comm-central/log/7469f21530dd39d3cd3261837a5c8dece42a5f0d/mailnews/compose/src/nsMsgAppleDoubleEncode.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7469f21530dd39d3cd3261837a5c8dece42a5f0d/mailnews/compose/src/nsMsgAppleEncode.cpp">mailnews/compose/src/nsMsgAppleEncode.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7469f21530dd39d3cd3261837a5c8dece42a5f0d/mailnews/compose/src/nsMsgAppleEncode.cpp">file</a> |
<a href="/comm-central/annotate/7469f21530dd39d3cd3261837a5c8dece42a5f0d/mailnews/compose/src/nsMsgAppleEncode.cpp">annotate</a> |
<a href="/comm-central/diff/7469f21530dd39d3cd3261837a5c8dece42a5f0d/mailnews/compose/src/nsMsgAppleEncode.cpp">diff</a> |
<a href="/comm-central/comparison/7469f21530dd39d3cd3261837a5c8dece42a5f0d/mailnews/compose/src/nsMsgAppleEncode.cpp">comparison</a> |
<a href="/comm-central/log/7469f21530dd39d3cd3261837a5c8dece42a5f0d/mailnews/compose/src/nsMsgAppleEncode.cpp">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgAppleDouble.h</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgAppleDouble.h</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -50,16 +50,18 @@</span>
<a href="#l1.4"></a><span id="l1.4"> #ifndef AppleDouble_h</span>
<a href="#l1.5"></a><span id="l1.5"> #define AppleDouble_h</span>
<a href="#l1.6"></a><span id="l1.6"> </span>
<a href="#l1.7"></a><span id="l1.7"> #include &quot;msgCore.h&quot;</span>
<a href="#l1.8"></a><span id="l1.8"> #include &quot;nsComposeStrings.h&quot;</span>
<a href="#l1.9"></a><span id="l1.9"> #include &quot;nsIOutputStream.h&quot;</span>
<a href="#l1.10"></a><span id="l1.10"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+#include &lt;CoreServices/CoreServices.h&gt;</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+</span>
<a href="#l1.14"></a><span id="l1.14"> #define NOERR			0</span>
<a href="#l1.15"></a><span id="l1.15"> #define errDone			1</span>
<a href="#l1.16"></a><span id="l1.16"> 								/* Done with current operation.	*/</span>
<a href="#l1.17"></a><span id="l1.17"> #define errEOB			2</span>
<a href="#l1.18"></a><span id="l1.18"> 								/* 	End of a buffer.			*/</span>
<a href="#l1.19"></a><span id="l1.19"> #define errEOP			3	</span>
<a href="#l1.20"></a><span id="l1.20"> 								/* 	End of a Part.				*/</span>
<a href="#l1.21"></a><span id="l1.21"> </span>
<a href="#l1.22"></a><span id="l1.22" class="difflineat">@@ -78,20 +80,18 @@ enum</span>
<a href="#l1.23"></a><span id="l1.23"> 	kDoingHeaderPortion, </span>
<a href="#l1.24"></a><span id="l1.24"> 	kDoneHeaderPortion, </span>
<a href="#l1.25"></a><span id="l1.25"> 	kDoingDataPortion, </span>
<a href="#l1.26"></a><span id="l1.26"> 	kDoneDataPortion </span>
<a href="#l1.27"></a><span id="l1.27"> };</span>
<a href="#l1.28"></a><span id="l1.28"> </span>
<a href="#l1.29"></a><span id="l1.29"> typedef struct _appledouble_encode_object </span>
<a href="#l1.30"></a><span id="l1.30"> {</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-	char	fname[64];</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineminus">-	PRInt32	dirId; </span>
<a href="#l1.33"></a><span id="l1.33" class="difflineminus">-	PRInt16	vRefNum;</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineminus">-	PRInt16	fileId;				/* the id for the open file (data/resource fork) */</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineplus">+    char    fname[256];</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineplus">+    FSIORefNum fileId;				/* the id for the open file (data/resource fork) */</span>
<a href="#l1.37"></a><span id="l1.37"> </span>
<a href="#l1.38"></a><span id="l1.38"> 	int 	state;</span>
<a href="#l1.39"></a><span id="l1.39"> 	int		text_file_type;		/* if the file has a text file type with it.	*/</span>
<a href="#l1.40"></a><span id="l1.40"> 	char	*boundary;			/* the boundary string.							*/</span>
<a href="#l1.41"></a><span id="l1.41"> </span>
<a href="#l1.42"></a><span id="l1.42"> 	int		status;				/* the error code if anyerror happens.			*/</span>
<a href="#l1.43"></a><span id="l1.43"> 	char 	b_overflow[200];</span>
<a href="#l1.44"></a><span id="l1.44"> 	int		s_overflow;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgAppleDoubleEncode.cpp</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgAppleDoubleEncode.cpp</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -53,60 +53,43 @@</span>
<a href="#l2.4"></a><span id="l2.4"> #include &quot;nsMsgAppleCodes.h&quot;</span>
<a href="#l2.5"></a><span id="l2.5"> #include &quot;nsMsgCompUtils.h&quot;</span>
<a href="#l2.6"></a><span id="l2.6"> #include &quot;nsCExternalHandlerService.h&quot;</span>
<a href="#l2.7"></a><span id="l2.7"> #include &quot;nsIMIMEService.h&quot;</span>
<a href="#l2.8"></a><span id="l2.8"> #include &quot;nsMimeTypes.h&quot;</span>
<a href="#l2.9"></a><span id="l2.9"> #include &quot;prmem.h&quot;</span>
<a href="#l2.10"></a><span id="l2.10"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-#include &lt;Carbon/Carbon.h&gt;</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-OSStatus</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineminus">-PathToSpec(const UInt8 *path, FSSpec *spec)</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineminus">-{</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineminus">-  if (!spec)</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineminus">-    return -1;</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineminus">-</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineminus">-  // convert POSIX path to FSRef</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineminus">-  FSRef ref;</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineminus">-  OSStatus result = FSPathMakeRef(path, &amp;ref, NULL);</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineminus">-  if (result != noErr)</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineminus">-    return result;</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineminus">-</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineminus">-  // convert FSRef to FSSpec</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineminus">-  return FSGetCatalogInfo(&amp;ref, kFSCatInfoNone, NULL, NULL, spec, NULL);</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineminus">-}</span>
<a href="#l2.29"></a><span id="l2.29"> </span>
<a href="#l2.30"></a><span id="l2.30"> void	</span>
<a href="#l2.31"></a><span id="l2.31"> MacGetFileType(nsILocalFile   *fs, </span>
<a href="#l2.32"></a><span id="l2.32">                PRBool       *useDefault, </span>
<a href="#l2.33"></a><span id="l2.33">                char         **fileType, </span>
<a href="#l2.34"></a><span id="l2.34">                char         **encoding)</span>
<a href="#l2.35"></a><span id="l2.35"> {</span>
<a href="#l2.36"></a><span id="l2.36"> 	if ((fs == NULL) || (fileType == NULL) || (encoding == NULL))</span>
<a href="#l2.37"></a><span id="l2.37"> 		return;</span>
<a href="#l2.38"></a><span id="l2.38"> </span>
<a href="#l2.39"></a><span id="l2.39" class="difflineminus">-  PRBool exists;</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+  PRBool exists = PR_FALSE;</span>
<a href="#l2.41"></a><span id="l2.41">   fs-&gt;Exists(&amp;exists);</span>
<a href="#l2.42"></a><span id="l2.42">   if (!exists)</span>
<a href="#l2.43"></a><span id="l2.43">     return;</span>
<a href="#l2.44"></a><span id="l2.44"> </span>
<a href="#l2.45"></a><span id="l2.45"> 	*useDefault = TRUE;</span>
<a href="#l2.46"></a><span id="l2.46"> 	*fileType = NULL;</span>
<a href="#l2.47"></a><span id="l2.47"> 	*encoding = NULL;</span>
<a href="#l2.48"></a><span id="l2.48"> </span>
<a href="#l2.49"></a><span id="l2.49" class="difflineminus">-	FInfo		fndrInfo;</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineminus">-  FSSpec fsSpec;</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineminus">-  nsCString nativePath;</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineminus">-  fs-&gt;GetNativePath(nativePath);</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineminus">-  PathToSpec((UInt8 *)nativePath.get(), &amp;fsSpec);</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineminus">-  OSErr err = FSpGetFInfo (&amp;fsSpec, &amp;fndrInfo);</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineplus">+  nsCOMPtr&lt;nsILocalFileMac&gt; macFile = do_QueryInterface(fs);</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineplus">+  FSRef fsRef;</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineplus">+  FSCatalogInfo catalogInfo;</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineplus">+  OSErr err = errFileOpen;</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineplus">+  if (NS_SUCCEEDED(macFile-&gt;GetFSRef(&amp;fsRef)))</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineplus">+    err = ::FSGetCatalogInfo(&amp;fsRef, kFSCatInfoFinderInfo, &amp;catalogInfo, nsnull, nsnull, nsnull);</span>
<a href="#l2.61"></a><span id="l2.61"> </span>
<a href="#l2.62"></a><span id="l2.62" class="difflineminus">-  if ( (err != noErr) || (fndrInfo.fdType == 'TEXT') )</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineplus">+  if ( (err != noErr) || (((FileInfo*)(&amp;catalogInfo.finderInfo))-&gt;fileType == 'TEXT') )</span>
<a href="#l2.64"></a><span id="l2.64">     *fileType = strdup(APPLICATION_OCTET_STREAM);</span>
<a href="#l2.65"></a><span id="l2.65">   else</span>
<a href="#l2.66"></a><span id="l2.66">   {</span>
<a href="#l2.67"></a><span id="l2.67">     // At this point, we should call the mime service and</span>
<a href="#l2.68"></a><span id="l2.68">     // see what we can find out?</span>
<a href="#l2.69"></a><span id="l2.69">     nsresult      rv;</span>
<a href="#l2.70"></a><span id="l2.70">     nsCOMPtr &lt;nsIURI&gt; tURI;</span>
<a href="#l2.71"></a><span id="l2.71">     if (NS_SUCCEEDED(NS_NewFileURI(getter_AddRefs(tURI), fs)) &amp;&amp; tURI)</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineat">@@ -137,34 +120,33 @@ MacGetFileType(nsILocalFile   *fs,</span>
<a href="#l2.73"></a><span id="l2.73"> *	</span>
<a href="#l2.74"></a><span id="l2.74"> *	Setup the encode envirment</span>
<a href="#l2.75"></a><span id="l2.75"> */</span>
<a href="#l2.76"></a><span id="l2.76"> </span>
<a href="#l2.77"></a><span id="l2.77"> int ap_encode_init( appledouble_encode_object *p_ap_encode_obj,</span>
<a href="#l2.78"></a><span id="l2.78">                     const char                *fname,</span>
<a href="#l2.79"></a><span id="l2.79">                     char                      *separator)</span>
<a href="#l2.80"></a><span id="l2.80"> {</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineminus">-	FSSpec	fspec;</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineminus">-	</span>
<a href="#l2.83"></a><span id="l2.83">   nsCOMPtr &lt;nsILocalFile&gt; myFile;</span>
<a href="#l2.84"></a><span id="l2.84">   NS_NewNativeLocalFile(nsDependentCString(fname), PR_TRUE, getter_AddRefs(myFile));</span>
<a href="#l2.85"></a><span id="l2.85">   PRBool exists;</span>
<a href="#l2.86"></a><span id="l2.86">   if (myFile &amp;&amp; NS_SUCCEEDED(myFile-&gt;Exists(&amp;exists)) &amp;&amp; !exists)</span>
<a href="#l2.87"></a><span id="l2.87">     return -1;</span>
<a href="#l2.88"></a><span id="l2.88"> </span>
<a href="#l2.89"></a><span id="l2.89" class="difflineminus">-	PathToSpec((const UInt8 *)fname, &amp;fspec);</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineplus">+  nsCOMPtr&lt;nsILocalFileMac&gt; macFile = do_QueryInterface(myFile);</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineplus">+  nsCAutoString path;</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineplus">+  macFile-&gt;GetNativePath(path);</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineplus">+</span>
<a href="#l2.94"></a><span id="l2.94"> 	memset(p_ap_encode_obj, 0, sizeof(appledouble_encode_object));</span>
<a href="#l2.95"></a><span id="l2.95"> 	</span>
<a href="#l2.96"></a><span id="l2.96"> 	/*</span>
<a href="#l2.97"></a><span id="l2.97"> 	**	Fill out the source file inforamtion.</span>
<a href="#l2.98"></a><span id="l2.98"> 	*/	</span>
<a href="#l2.99"></a><span id="l2.99" class="difflineminus">-	memcpy(p_ap_encode_obj-&gt;fname, fspec.name+1, *fspec.name);</span>
<a href="#l2.100"></a><span id="l2.100" class="difflineminus">-	p_ap_encode_obj-&gt;fname[*fspec.name] = '\0';</span>
<a href="#l2.101"></a><span id="l2.101" class="difflineminus">-	p_ap_encode_obj-&gt;vRefNum = fspec.vRefNum;</span>
<a href="#l2.102"></a><span id="l2.102" class="difflineminus">-	p_ap_encode_obj-&gt;dirId   = fspec.parID;</span>
<a href="#l2.103"></a><span id="l2.103" class="difflineplus">+  memcpy(p_ap_encode_obj-&gt;fname, path.get(), path.Length());</span>
<a href="#l2.104"></a><span id="l2.104" class="difflineplus">+  p_ap_encode_obj-&gt;fname[path.Length()] = '\0';</span>
<a href="#l2.105"></a><span id="l2.105"> 	</span>
<a href="#l2.106"></a><span id="l2.106"> 	p_ap_encode_obj-&gt;boundary = strdup(separator);</span>
<a href="#l2.107"></a><span id="l2.107"> 	return noErr;</span>
<a href="#l2.108"></a><span id="l2.108"> }</span>
<a href="#l2.109"></a><span id="l2.109"> </span>
<a href="#l2.110"></a><span id="l2.110"> /*</span>
<a href="#l2.111"></a><span id="l2.111"> **	ap_encode_next</span>
<a href="#l2.112"></a><span id="l2.112"> **	--------------</span>
<a href="#l2.113"></a><span id="l2.113" class="difflineat">@@ -303,14 +285,14 @@ int ap_encode_end(</span>
<a href="#l2.114"></a><span id="l2.114"> {</span>
<a href="#l2.115"></a><span id="l2.115"> 	/*</span>
<a href="#l2.116"></a><span id="l2.116"> 	** clear up the apple doubler.</span>
<a href="#l2.117"></a><span id="l2.117"> 	*/</span>
<a href="#l2.118"></a><span id="l2.118"> 	if (p_ap_encode_obj == NULL)</span>
<a href="#l2.119"></a><span id="l2.119"> 		return noErr;</span>
<a href="#l2.120"></a><span id="l2.120"> </span>
<a href="#l2.121"></a><span id="l2.121"> 	if (p_ap_encode_obj-&gt;fileId)			/* close the file if it is open.	*/</span>
<a href="#l2.122"></a><span id="l2.122" class="difflineminus">-		FSClose(p_ap_encode_obj-&gt;fileId);</span>
<a href="#l2.123"></a><span id="l2.123" class="difflineplus">+    ::FSCloseFork(p_ap_encode_obj-&gt;fileId);</span>
<a href="#l2.124"></a><span id="l2.124"> </span>
<a href="#l2.125"></a><span id="l2.125"> 	PR_FREEIF(p_ap_encode_obj-&gt;boundary);		/* the boundary string.				*/</span>
<a href="#l2.126"></a><span id="l2.126"> 	</span>
<a href="#l2.127"></a><span id="l2.127"> 	return noErr;</span>
<a href="#l2.128"></a><span id="l2.128"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgAppleEncode.cpp</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgAppleEncode.cpp</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -49,18 +49,17 @@</span>
<a href="#l3.4"></a><span id="l3.4"> </span>
<a href="#l3.5"></a><span id="l3.5"> #include &quot;nscore.h&quot;</span>
<a href="#l3.6"></a><span id="l3.6"> #include &quot;msgCore.h&quot;</span>
<a href="#l3.7"></a><span id="l3.7"> #include &quot;nsMimeTypes.h&quot;</span>
<a href="#l3.8"></a><span id="l3.8"> #include &quot;prprf.h&quot;</span>
<a href="#l3.9"></a><span id="l3.9"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l3.10"></a><span id="l3.10"> #include &quot;nsMsgAppleDouble.h&quot;</span>
<a href="#l3.11"></a><span id="l3.11"> #include &quot;nsMsgAppleCodes.h&quot;</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-#include &lt;Carbon/Carbon.h&gt;</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+#include &quot;nsILocalFileMac.h&quot;</span>
<a href="#l3.15"></a><span id="l3.15"> </span>
<a href="#l3.16"></a><span id="l3.16"> /*</span>
<a href="#l3.17"></a><span id="l3.17"> **	Local Functions prototypes.</span>
<a href="#l3.18"></a><span id="l3.18"> */</span>
<a href="#l3.19"></a><span id="l3.19"> static int output64chunk( appledouble_encode_object* p_ap_encode_obj, </span>
<a href="#l3.20"></a><span id="l3.20"> 				int c1, int c2, int c3, int pads);</span>
<a href="#l3.21"></a><span id="l3.21"> 				</span>
<a href="#l3.22"></a><span id="l3.22"> static int to64(appledouble_encode_object* p_ap_encode_obj, </span>
<a href="#l3.23"></a><span id="l3.23" class="difflineat">@@ -144,37 +143,37 @@ int fill_apple_mime_header(</span>
<a href="#l3.24"></a><span id="l3.24"> 						tmpstr, </span>
<a href="#l3.25"></a><span id="l3.25"> 						strlen(tmpstr));</span>
<a href="#l3.26"></a><span id="l3.26"> 	return status;</span>
<a href="#l3.27"></a><span id="l3.27"> } </span>
<a href="#l3.28"></a><span id="l3.28"> </span>
<a href="#l3.29"></a><span id="l3.29"> int ap_encode_file_infor(</span>
<a href="#l3.30"></a><span id="l3.30"> 	appledouble_encode_object *p_ap_encode_obj)</span>
<a href="#l3.31"></a><span id="l3.31"> {</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineminus">-	CInfoPBRec cipbr;</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineminus">-	HFileInfo *fpb = (HFileInfo *)&amp;cipbr;</span>
<a href="#l3.34"></a><span id="l3.34"> 	ap_header	head;</span>
<a href="#l3.35"></a><span id="l3.35"> 	ap_entry 	entries[NUM_ENTRIES];</span>
<a href="#l3.36"></a><span id="l3.36"> 	ap_dates 	dates;</span>
<a href="#l3.37"></a><span id="l3.37"> 	short 		i;</span>
<a href="#l3.38"></a><span id="l3.38"> 	long 		comlen;</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineminus">-	DateTimeRec cur_time;</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineminus">-	unsigned 	long cur_secs;</span>
<a href="#l3.41"></a><span id="l3.41"> 	char 		comment[256];</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineminus">-	Str63		fname;</span>
<a href="#l3.43"></a><span id="l3.43"> 	int	 		status;</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+    </span>
<a href="#l3.45"></a><span id="l3.45" class="difflineplus">+    nsCOMPtr &lt;nsILocalFile&gt; resFile;</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineplus">+    NS_NewNativeLocalFile(nsDependentCString(p_ap_encode_obj-&gt;fname), PR_TRUE,</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineplus">+                          getter_AddRefs(resFile));</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineplus">+    if (!resFile)</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineplus">+        return errFileOpen;</span>
<a href="#l3.50"></a><span id="l3.50"> </span>
<a href="#l3.51"></a><span id="l3.51" class="difflineminus">-	strcpy((char *)fname+1,p_ap_encode_obj-&gt;fname);</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineminus">-	fname[0] = strlen(p_ap_encode_obj-&gt;fname);</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineminus">-	</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineminus">-	fpb-&gt;ioNamePtr = fname;</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineminus">-	fpb-&gt;ioDirID   = p_ap_encode_obj-&gt;dirId;</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineminus">-	fpb-&gt;ioVRefNum = p_ap_encode_obj-&gt;vRefNum;</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineminus">-	fpb-&gt;ioFDirIndex = 0;</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineminus">-	if (PBGetCatInfoSync(&amp;cipbr) != noErr) </span>
<a href="#l3.59"></a><span id="l3.59" class="difflineplus">+    FSRef ref;</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineplus">+    nsCOMPtr &lt;nsILocalFileMac&gt; macFile = do_QueryInterface(resFile);</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineplus">+    if (NS_FAILED(macFile-&gt;GetFSRef(&amp;ref)))</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineplus">+        return errFileOpen;</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineplus">+</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineplus">+    FSCatalogInfo catalogInfo;</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineplus">+    if (::FSGetCatalogInfo(&amp;ref, kFSCatInfoFinderInfo, &amp;catalogInfo, nsnull, nsnull, nsnull) != noErr)</span>
<a href="#l3.66"></a><span id="l3.66"> 	{</span>
<a href="#l3.67"></a><span id="l3.67"> 		return errFileOpen;</span>
<a href="#l3.68"></a><span id="l3.68"> 	}</span>
<a href="#l3.69"></a><span id="l3.69"> </span>
<a href="#l3.70"></a><span id="l3.70"> 	/* get a file comment, if possible */</span>
<a href="#l3.71"></a><span id="l3.71"> #if 1</span>
<a href="#l3.72"></a><span id="l3.72">     // Carbon doesn't support GetWDInfo(). (Bug 555684)</span>
<a href="#l3.73"></a><span id="l3.73"> </span>
<a href="#l3.74"></a><span id="l3.74" class="difflineat">@@ -218,107 +217,107 @@ int ap_encode_file_infor(</span>
<a href="#l3.75"></a><span id="l3.75"> 	head.entries = NUM_ENTRIES - 1;</span>
<a href="#l3.76"></a><span id="l3.76"> 	status = to64(p_ap_encode_obj,</span>
<a href="#l3.77"></a><span id="l3.77"> 					(char *) &amp;head,</span>
<a href="#l3.78"></a><span id="l3.78"> 					sizeof (head));				</span>
<a href="#l3.79"></a><span id="l3.79"> 	if (status != noErr)</span>
<a href="#l3.80"></a><span id="l3.80"> 		return status;</span>
<a href="#l3.81"></a><span id="l3.81"> </span>
<a href="#l3.82"></a><span id="l3.82"> 	/* write entry descriptors */</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineplus">+    nsCAutoString leafname;</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineplus">+    macFile-&gt;GetNativeLeafName(leafname);</span>
<a href="#l3.85"></a><span id="l3.85"> 	entries[0].offset = sizeof (head) + sizeof (ap_entry) * head.entries;</span>
<a href="#l3.86"></a><span id="l3.86"> 	entries[0].id 	= ENT_NAME;</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineminus">-	entries[0].length = *fpb-&gt;ioNamePtr;</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineplus">+    entries[0].length = leafname.Length();</span>
<a href="#l3.89"></a><span id="l3.89"> 	entries[1].id 	= ENT_FINFO;</span>
<a href="#l3.90"></a><span id="l3.90"> 	entries[1].length = sizeof (FInfo) + sizeof (FXInfo);</span>
<a href="#l3.91"></a><span id="l3.91"> 	entries[2].id 	= ENT_DATES;</span>
<a href="#l3.92"></a><span id="l3.92"> 	entries[2].length = sizeof (ap_dates);</span>
<a href="#l3.93"></a><span id="l3.93"> 	entries[3].id 	= ENT_COMMENT;</span>
<a href="#l3.94"></a><span id="l3.94"> 	entries[3].length = comlen;</span>
<a href="#l3.95"></a><span id="l3.95"> 	entries[4].id 	= ENT_RFORK;</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineminus">-	entries[4].length = fpb-&gt;ioFlRLgLen;</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineplus">+    entries[4].length = catalogInfo.rsrcLogicalSize;</span>
<a href="#l3.98"></a><span id="l3.98"> 	entries[5].id 	= ENT_DFORK;</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineminus">-	entries[5].length = fpb-&gt;ioFlLgLen;</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineplus">+    entries[5].length = catalogInfo.dataLogicalSize;</span>
<a href="#l3.101"></a><span id="l3.101"> </span>
<a href="#l3.102"></a><span id="l3.102"> 	/* correct the link in the entries. */</span>
<a href="#l3.103"></a><span id="l3.103"> 	for (i = 1; i &lt; NUM_ENTRIES; ++i) </span>
<a href="#l3.104"></a><span id="l3.104"> 	{</span>
<a href="#l3.105"></a><span id="l3.105"> 		entries[i].offset = entries[i-1].offset + entries[i-1].length;</span>
<a href="#l3.106"></a><span id="l3.106"> 	}</span>
<a href="#l3.107"></a><span id="l3.107"> 	status = to64(p_ap_encode_obj,</span>
<a href="#l3.108"></a><span id="l3.108"> 					(char *) entries,</span>
<a href="#l3.109"></a><span id="l3.109"> 					sizeof (ap_entry) * head.entries); </span>
<a href="#l3.110"></a><span id="l3.110"> 	if (status != noErr)</span>
<a href="#l3.111"></a><span id="l3.111"> 		return status;</span>
<a href="#l3.112"></a><span id="l3.112"> </span>
<a href="#l3.113"></a><span id="l3.113"> 	/* write name */</span>
<a href="#l3.114"></a><span id="l3.114"> 	status = to64(p_ap_encode_obj,</span>
<a href="#l3.115"></a><span id="l3.115" class="difflineminus">-					(char *) fpb-&gt;ioNamePtr + 1,</span>
<a href="#l3.116"></a><span id="l3.116" class="difflineminus">-					*fpb-&gt;ioNamePtr); </span>
<a href="#l3.117"></a><span id="l3.117" class="difflineplus">+					(char *) leafname.get(),</span>
<a href="#l3.118"></a><span id="l3.118" class="difflineplus">+					leafname.Length()); </span>
<a href="#l3.119"></a><span id="l3.119"> 	if (status != noErr)</span>
<a href="#l3.120"></a><span id="l3.120"> 		return status;</span>
<a href="#l3.121"></a><span id="l3.121"> 	</span>
<a href="#l3.122"></a><span id="l3.122"> 	/* write finder info */</span>
<a href="#l3.123"></a><span id="l3.123"> 	status = to64(p_ap_encode_obj,</span>
<a href="#l3.124"></a><span id="l3.124" class="difflineminus">-					(char *) &amp;fpb-&gt;ioFlFndrInfo,</span>
<a href="#l3.125"></a><span id="l3.125" class="difflineplus">+					(char *) &amp;catalogInfo.finderInfo,</span>
<a href="#l3.126"></a><span id="l3.126"> 					sizeof (FInfo));</span>
<a href="#l3.127"></a><span id="l3.127"> 	if (status != noErr)</span>
<a href="#l3.128"></a><span id="l3.128"> 		return status;</span>
<a href="#l3.129"></a><span id="l3.129"> 					  </span>
<a href="#l3.130"></a><span id="l3.130"> 	status = to64(p_ap_encode_obj,</span>
<a href="#l3.131"></a><span id="l3.131" class="difflineminus">-					(char *) &amp;fpb-&gt;ioFlXFndrInfo,</span>
<a href="#l3.132"></a><span id="l3.132" class="difflineplus">+					(char *) &amp;catalogInfo.extFinderInfo,</span>
<a href="#l3.133"></a><span id="l3.133"> 					sizeof (FXInfo));</span>
<a href="#l3.134"></a><span id="l3.134"> 	if (status != noErr)</span>
<a href="#l3.135"></a><span id="l3.135"> 		return status;</span>
<a href="#l3.136"></a><span id="l3.136"> </span>
<a href="#l3.137"></a><span id="l3.137"> 	/* write dates */</span>
<a href="#l3.138"></a><span id="l3.138" class="difflineminus">-	GetTime(&amp;cur_time);</span>
<a href="#l3.139"></a><span id="l3.139" class="difflineminus">-	DateToSeconds(&amp;cur_time, &amp;cur_secs);</span>
<a href="#l3.140"></a><span id="l3.140" class="difflineminus">-	dates.create = fpb-&gt;ioFlCrDat + CONVERT_TIME;</span>
<a href="#l3.141"></a><span id="l3.141" class="difflineminus">-	dates.modify = fpb-&gt;ioFlMdDat + CONVERT_TIME;</span>
<a href="#l3.142"></a><span id="l3.142" class="difflineminus">-	dates.backup = fpb-&gt;ioFlBkDat + CONVERT_TIME;</span>
<a href="#l3.143"></a><span id="l3.143" class="difflineminus">-	dates.access = cur_secs + CONVERT_TIME;</span>
<a href="#l3.144"></a><span id="l3.144" class="difflineplus">+    dates.create = catalogInfo.createDate.lowSeconds + CONVERT_TIME;</span>
<a href="#l3.145"></a><span id="l3.145" class="difflineplus">+    dates.modify = catalogInfo.contentModDate.lowSeconds + CONVERT_TIME;</span>
<a href="#l3.146"></a><span id="l3.146" class="difflineplus">+    dates.backup = catalogInfo.backupDate.lowSeconds + CONVERT_TIME;</span>
<a href="#l3.147"></a><span id="l3.147" class="difflineplus">+    dates.access = catalogInfo.accessDate.lowSeconds + CONVERT_TIME;</span>
<a href="#l3.148"></a><span id="l3.148"> 	status = to64(p_ap_encode_obj,</span>
<a href="#l3.149"></a><span id="l3.149"> 					(char *) &amp;dates,</span>
<a href="#l3.150"></a><span id="l3.150"> 					sizeof (ap_dates)); </span>
<a href="#l3.151"></a><span id="l3.151"> 	if (status != noErr)</span>
<a href="#l3.152"></a><span id="l3.152"> 		return status;</span>
<a href="#l3.153"></a><span id="l3.153"> 	</span>
<a href="#l3.154"></a><span id="l3.154"> 	/* write comment */</span>
<a href="#l3.155"></a><span id="l3.155"> 	if (comlen)</span>
<a href="#l3.156"></a><span id="l3.156"> 	{</span>
<a href="#l3.157"></a><span id="l3.157"> 		status = to64(p_ap_encode_obj,</span>
<a href="#l3.158"></a><span id="l3.158"> 					comment,</span>
<a href="#l3.159"></a><span id="l3.159"> 					comlen * sizeof(char));</span>
<a href="#l3.160"></a><span id="l3.160"> 	}</span>
<a href="#l3.161"></a><span id="l3.161"> 	/*</span>
<a href="#l3.162"></a><span id="l3.162"> 	**	Get some help information on deciding the file type.</span>
<a href="#l3.163"></a><span id="l3.163"> 	*/</span>
<a href="#l3.164"></a><span id="l3.164" class="difflineminus">-	if (fpb-&gt;ioFlFndrInfo.fdType == 'TEXT' || fpb-&gt;ioFlFndrInfo.fdType == 'text')</span>
<a href="#l3.165"></a><span id="l3.165" class="difflineplus">+    if (((FileInfo*)(&amp;catalogInfo.finderInfo))-&gt;fileType == 'TEXT' ||</span>
<a href="#l3.166"></a><span id="l3.166" class="difflineplus">+        ((FileInfo*)(&amp;catalogInfo.finderInfo))-&gt;fileType == 'text')</span>
<a href="#l3.167"></a><span id="l3.167"> 	{</span>
<a href="#l3.168"></a><span id="l3.168"> 		p_ap_encode_obj-&gt;text_file_type = true;</span>
<a href="#l3.169"></a><span id="l3.169"> 	}</span>
<a href="#l3.170"></a><span id="l3.170"> 	</span>
<a href="#l3.171"></a><span id="l3.171"> 	return status;	</span>
<a href="#l3.172"></a><span id="l3.172"> }</span>
<a href="#l3.173"></a><span id="l3.173"> /*</span>
<a href="#l3.174"></a><span id="l3.174"> **	ap_encode_header</span>
<a href="#l3.175"></a><span id="l3.175"> **</span>
<a href="#l3.176"></a><span id="l3.176"> **		encode the file header and the resource fork.</span>
<a href="#l3.177"></a><span id="l3.177"> **</span>
<a href="#l3.178"></a><span id="l3.178"> */</span>
<a href="#l3.179"></a><span id="l3.179"> int ap_encode_header(</span>
<a href="#l3.180"></a><span id="l3.180"> 	appledouble_encode_object* p_ap_encode_obj, </span>
<a href="#l3.181"></a><span id="l3.181"> 	PRBool  firstime)</span>
<a href="#l3.182"></a><span id="l3.182"> {</span>
<a href="#l3.183"></a><span id="l3.183" class="difflineminus">-	Str255 	name;</span>
<a href="#l3.184"></a><span id="l3.184"> 	char   	rd_buff[256];</span>
<a href="#l3.185"></a><span id="l3.185" class="difflineminus">-	short   fileId;</span>
<a href="#l3.186"></a><span id="l3.186" class="difflineplus">+    FSIORefNum fileId;</span>
<a href="#l3.187"></a><span id="l3.187"> 	OSErr	retval = noErr;</span>
<a href="#l3.188"></a><span id="l3.188"> 	int    	status;</span>
<a href="#l3.189"></a><span id="l3.189" class="difflineminus">-	long	inCount;</span>
<a href="#l3.190"></a><span id="l3.190" class="difflineplus">+    ByteCount inCount;</span>
<a href="#l3.191"></a><span id="l3.191"> 	</span>
<a href="#l3.192"></a><span id="l3.192"> 	if (firstime)</span>
<a href="#l3.193"></a><span id="l3.193"> 	{</span>
<a href="#l3.194"></a><span id="l3.194">     PL_strcpy(rd_buff, </span>
<a href="#l3.195"></a><span id="l3.195"> 			&quot;Content-Type: application/applefile\r\nContent-Transfer-Encoding: base64\r\n\r\n&quot;);</span>
<a href="#l3.196"></a><span id="l3.196"> 		status = write_stream(p_ap_encode_obj,</span>
<a href="#l3.197"></a><span id="l3.197"> 			 				rd_buff, </span>
<a href="#l3.198"></a><span id="l3.198"> 			 				strlen(rd_buff)); </span>
<a href="#l3.199"></a><span id="l3.199" class="difflineat">@@ -327,47 +326,55 @@ int ap_encode_header(</span>
<a href="#l3.200"></a><span id="l3.200"> 			</span>
<a href="#l3.201"></a><span id="l3.201"> 		status = ap_encode_file_infor(p_ap_encode_obj); </span>
<a href="#l3.202"></a><span id="l3.202"> 		if (status != noErr)</span>
<a href="#l3.203"></a><span id="l3.203"> 			return status;</span>
<a href="#l3.204"></a><span id="l3.204"> 		</span>
<a href="#l3.205"></a><span id="l3.205"> 		/*</span>
<a href="#l3.206"></a><span id="l3.206"> 		** preparing to encode the resource fork.</span>
<a href="#l3.207"></a><span id="l3.207"> 		*/</span>
<a href="#l3.208"></a><span id="l3.208" class="difflineminus">-		name[0] = strlen(p_ap_encode_obj-&gt;fname);</span>
<a href="#l3.209"></a><span id="l3.209" class="difflineminus">-		strcpy((char *)name+1, p_ap_encode_obj-&gt;fname);</span>
<a href="#l3.210"></a><span id="l3.210" class="difflineminus">-		if (HOpenRF(p_ap_encode_obj-&gt;vRefNum, p_ap_encode_obj-&gt;dirId,</span>
<a href="#l3.211"></a><span id="l3.211" class="difflineminus">-					name, fsRdPerm,</span>
<a href="#l3.212"></a><span id="l3.212" class="difflineminus">-					&amp;p_ap_encode_obj-&gt;fileId) != noErr)</span>
<a href="#l3.213"></a><span id="l3.213" class="difflineminus">-		{</span>
<a href="#l3.214"></a><span id="l3.214" class="difflineminus">-			return errFileOpen;			</span>
<a href="#l3.215"></a><span id="l3.215" class="difflineminus">-		}</span>
<a href="#l3.216"></a><span id="l3.216" class="difflineplus">+        nsCOMPtr &lt;nsILocalFile&gt; myFile;</span>
<a href="#l3.217"></a><span id="l3.217" class="difflineplus">+        NS_NewNativeLocalFile(nsDependentCString(p_ap_encode_obj-&gt;fname), PR_TRUE, getter_AddRefs(myFile));</span>
<a href="#l3.218"></a><span id="l3.218" class="difflineplus">+        if (!myFile)</span>
<a href="#l3.219"></a><span id="l3.219" class="difflineplus">+            return errFileOpen;</span>
<a href="#l3.220"></a><span id="l3.220" class="difflineplus">+</span>
<a href="#l3.221"></a><span id="l3.221" class="difflineplus">+        FSRef ref;</span>
<a href="#l3.222"></a><span id="l3.222" class="difflineplus">+        nsCOMPtr &lt;nsILocalFileMac&gt; macFile = do_QueryInterface(myFile);</span>
<a href="#l3.223"></a><span id="l3.223" class="difflineplus">+        if (NS_FAILED(macFile-&gt;GetFSRef(&amp;ref)))</span>
<a href="#l3.224"></a><span id="l3.224" class="difflineplus">+            return errFileOpen;</span>
<a href="#l3.225"></a><span id="l3.225" class="difflineplus">+</span>
<a href="#l3.226"></a><span id="l3.226" class="difflineplus">+        HFSUniStr255 forkName;</span>
<a href="#l3.227"></a><span id="l3.227" class="difflineplus">+        ::FSGetResourceForkName(&amp;forkName);</span>
<a href="#l3.228"></a><span id="l3.228" class="difflineplus">+        retval = ::FSOpenFork(&amp;ref, forkName.length, forkName.unicode, fsRdPerm, &amp;p_ap_encode_obj-&gt;fileId);</span>
<a href="#l3.229"></a><span id="l3.229" class="difflineplus">+        if (retval != noErr)</span>
<a href="#l3.230"></a><span id="l3.230" class="difflineplus">+            return retval;</span>
<a href="#l3.231"></a><span id="l3.231"> 	}</span>
<a href="#l3.232"></a><span id="l3.232"> </span>
<a href="#l3.233"></a><span id="l3.233"> 	fileId = p_ap_encode_obj-&gt;fileId;</span>
<a href="#l3.234"></a><span id="l3.234"> 	while (retval == noErr)</span>
<a href="#l3.235"></a><span id="l3.235"> 	{</span>
<a href="#l3.236"></a><span id="l3.236"> 		if (BUFF_LEFT(p_ap_encode_obj) &lt; 400)</span>
<a href="#l3.237"></a><span id="l3.237"> 			break;</span>
<a href="#l3.238"></a><span id="l3.238"> 			</span>
<a href="#l3.239"></a><span id="l3.239" class="difflineminus">-		inCount = 256;</span>
<a href="#l3.240"></a><span id="l3.240" class="difflineminus">-		retval = FSRead(fileId, &amp;inCount, rd_buff);</span>
<a href="#l3.241"></a><span id="l3.241" class="difflineplus">+        inCount = 0;</span>
<a href="#l3.242"></a><span id="l3.242" class="difflineplus">+        retval = ::FSReadFork(fileId, fsAtMark, 0, 256, rd_buff, &amp;inCount);</span>
<a href="#l3.243"></a><span id="l3.243"> 		if (inCount)</span>
<a href="#l3.244"></a><span id="l3.244"> 		{</span>
<a href="#l3.245"></a><span id="l3.245"> 			status = to64(p_ap_encode_obj,</span>
<a href="#l3.246"></a><span id="l3.246"> 							rd_buff,</span>
<a href="#l3.247"></a><span id="l3.247"> 							inCount);</span>
<a href="#l3.248"></a><span id="l3.248"> 			if (status != noErr)</span>
<a href="#l3.249"></a><span id="l3.249"> 				return status;</span>
<a href="#l3.250"></a><span id="l3.250"> 		}</span>
<a href="#l3.251"></a><span id="l3.251"> 	}</span>
<a href="#l3.252"></a><span id="l3.252"> 	</span>
<a href="#l3.253"></a><span id="l3.253"> 	if (retval == eofErr)</span>
<a href="#l3.254"></a><span id="l3.254"> 	{</span>
<a href="#l3.255"></a><span id="l3.255" class="difflineminus">-		FSClose(fileId);</span>
<a href="#l3.256"></a><span id="l3.256" class="difflineplus">+        ::FSCloseFork(fileId);</span>
<a href="#l3.257"></a><span id="l3.257" class="difflineplus">+        p_ap_encode_obj-&gt;fileId = 0;</span>
<a href="#l3.258"></a><span id="l3.258"> </span>
<a href="#l3.259"></a><span id="l3.259"> 		status = finish64(p_ap_encode_obj);</span>
<a href="#l3.260"></a><span id="l3.260"> 		if (status != noErr)</span>
<a href="#l3.261"></a><span id="l3.261"> 			return status;</span>
<a href="#l3.262"></a><span id="l3.262"> 		</span>
<a href="#l3.263"></a><span id="l3.263"> 		/*</span>
<a href="#l3.264"></a><span id="l3.264"> 		** write out the boundary </span>
<a href="#l3.265"></a><span id="l3.265"> 		*/</span>
<a href="#l3.266"></a><span id="l3.266" class="difflineat">@@ -449,103 +456,110 @@ static char *magic_look(char *inbuff, in</span>
<a href="#l3.267"></a><span id="l3.267"> **</span>
<a href="#l3.268"></a><span id="l3.268"> **		encode on the data fork.</span>
<a href="#l3.269"></a><span id="l3.269"> **</span>
<a href="#l3.270"></a><span id="l3.270"> */</span>
<a href="#l3.271"></a><span id="l3.271"> int ap_encode_data(</span>
<a href="#l3.272"></a><span id="l3.272"> 	appledouble_encode_object* p_ap_encode_obj, </span>
<a href="#l3.273"></a><span id="l3.273"> 	PRBool firstime)</span>
<a href="#l3.274"></a><span id="l3.274"> {</span>
<a href="#l3.275"></a><span id="l3.275" class="difflineminus">-	Str255		name;</span>
<a href="#l3.276"></a><span id="l3.276"> 	char   		rd_buff[256];</span>
<a href="#l3.277"></a><span id="l3.277" class="difflineminus">-	short		fileId;</span>
<a href="#l3.278"></a><span id="l3.278" class="difflineplus">+    FSIORefNum fileId;</span>
<a href="#l3.279"></a><span id="l3.279"> 	OSErr		retval = noErr;</span>
<a href="#l3.280"></a><span id="l3.280" class="difflineminus">-	long		in_count;</span>
<a href="#l3.281"></a><span id="l3.281" class="difflineplus">+    ByteCount in_count;</span>
<a href="#l3.282"></a><span id="l3.282"> 	int			status;</span>
<a href="#l3.283"></a><span id="l3.283"> 	</span>
<a href="#l3.284"></a><span id="l3.284"> 	if (firstime)</span>
<a href="#l3.285"></a><span id="l3.285"> 	{	</span>
<a href="#l3.286"></a><span id="l3.286"> 		char* magic_type;</span>
<a href="#l3.287"></a><span id="l3.287"> 			</span>
<a href="#l3.288"></a><span id="l3.288"> 		/*</span>
<a href="#l3.289"></a><span id="l3.289"> 		** preparing to encode the data fork.</span>
<a href="#l3.290"></a><span id="l3.290"> 		*/</span>
<a href="#l3.291"></a><span id="l3.291" class="difflineminus">-		name[0] = strlen(p_ap_encode_obj-&gt;fname);</span>
<a href="#l3.292"></a><span id="l3.292" class="difflineminus">-    PL_strcpy((char*)name+1, p_ap_encode_obj-&gt;fname);</span>
<a href="#l3.293"></a><span id="l3.293" class="difflineminus">-		if (HOpen( 	p_ap_encode_obj-&gt;vRefNum,</span>
<a href="#l3.294"></a><span id="l3.294" class="difflineminus">-					p_ap_encode_obj-&gt;dirId, </span>
<a href="#l3.295"></a><span id="l3.295" class="difflineminus">-					name, </span>
<a href="#l3.296"></a><span id="l3.296" class="difflineminus">-					fsRdPerm, </span>
<a href="#l3.297"></a><span id="l3.297" class="difflineminus">-					&amp;fileId) != noErr)</span>
<a href="#l3.298"></a><span id="l3.298" class="difflineminus">-		{</span>
<a href="#l3.299"></a><span id="l3.299" class="difflineminus">-			return errFileOpen;</span>
<a href="#l3.300"></a><span id="l3.300" class="difflineminus">-		}</span>
<a href="#l3.301"></a><span id="l3.301" class="difflineplus">+        nsCOMPtr &lt;nsILocalFile&gt; resFile;</span>
<a href="#l3.302"></a><span id="l3.302" class="difflineplus">+        NS_NewNativeLocalFile(nsDependentCString(p_ap_encode_obj-&gt;fname), PR_TRUE,</span>
<a href="#l3.303"></a><span id="l3.303" class="difflineplus">+                              getter_AddRefs(resFile));</span>
<a href="#l3.304"></a><span id="l3.304" class="difflineplus">+        if (!resFile)</span>
<a href="#l3.305"></a><span id="l3.305" class="difflineplus">+            return errFileOpen;</span>
<a href="#l3.306"></a><span id="l3.306" class="difflineplus">+</span>
<a href="#l3.307"></a><span id="l3.307" class="difflineplus">+        FSRef ref;</span>
<a href="#l3.308"></a><span id="l3.308" class="difflineplus">+        nsCOMPtr &lt;nsILocalFileMac&gt; macFile = do_QueryInterface(resFile);</span>
<a href="#l3.309"></a><span id="l3.309" class="difflineplus">+        if (NS_FAILED(macFile-&gt;GetFSRef(&amp;ref)))</span>
<a href="#l3.310"></a><span id="l3.310" class="difflineplus">+            return errFileOpen;</span>
<a href="#l3.311"></a><span id="l3.311" class="difflineplus">+</span>
<a href="#l3.312"></a><span id="l3.312" class="difflineplus">+        HFSUniStr255 forkName;</span>
<a href="#l3.313"></a><span id="l3.313" class="difflineplus">+        ::FSGetDataForkName(&amp;forkName);</span>
<a href="#l3.314"></a><span id="l3.314" class="difflineplus">+        retval = ::FSOpenFork(&amp;ref, forkName.length, forkName.unicode, fsRdPerm, &amp;fileId);</span>
<a href="#l3.315"></a><span id="l3.315" class="difflineplus">+        if (retval != noErr)</span>
<a href="#l3.316"></a><span id="l3.316" class="difflineplus">+            return retval;</span>
<a href="#l3.317"></a><span id="l3.317" class="difflineplus">+</span>
<a href="#l3.318"></a><span id="l3.318"> 		p_ap_encode_obj-&gt;fileId = fileId;</span>
<a href="#l3.319"></a><span id="l3.319"> 			</span>
<a href="#l3.320"></a><span id="l3.320"> 		</span>
<a href="#l3.321"></a><span id="l3.321"> 		if (!p_ap_encode_obj-&gt;text_file_type)</span>
<a href="#l3.322"></a><span id="l3.322"> 		{	</span>
<a href="#l3.323"></a><span id="l3.323">       /*</span>
<a href="#l3.324"></a><span id="l3.324">       **	do a smart check for the file type.</span>
<a href="#l3.325"></a><span id="l3.325">       */</span>
<a href="#l3.326"></a><span id="l3.326" class="difflineminus">-      in_count = 256;</span>
<a href="#l3.327"></a><span id="l3.327" class="difflineminus">-      retval 	 = FSRead(fileId, &amp;in_count, rd_buff);</span>
<a href="#l3.328"></a><span id="l3.328" class="difflineplus">+      in_count = 0;</span>
<a href="#l3.329"></a><span id="l3.329" class="difflineplus">+      retval = ::FSReadFork(fileId, fsFromStart, 0, 256, rd_buff, &amp;in_count);</span>
<a href="#l3.330"></a><span id="l3.330">       magic_type = magic_look(rd_buff, in_count);</span>
<a href="#l3.331"></a><span id="l3.331">       </span>
<a href="#l3.332"></a><span id="l3.332">       /* don't forget to rewind the index to start point. */ </span>
<a href="#l3.333"></a><span id="l3.333" class="difflineminus">-      SetFPos(fileId, fsFromStart, 0L);</span>
<a href="#l3.334"></a><span id="l3.334" class="difflineplus">+      ::FSSetForkPosition(fileId, fsFromStart, 0);</span>
<a href="#l3.335"></a><span id="l3.335">       /* and reset retVal just in case... */</span>
<a href="#l3.336"></a><span id="l3.336">       if (retval == eofErr)</span>
<a href="#l3.337"></a><span id="l3.337">         retval = noErr;</span>
<a href="#l3.338"></a><span id="l3.338"> 		}</span>
<a href="#l3.339"></a><span id="l3.339"> 		else</span>
<a href="#l3.340"></a><span id="l3.340"> 		{</span>
<a href="#l3.341"></a><span id="l3.341"> 			magic_type = text_type;		/* we already know it is a text type.	*/</span>
<a href="#l3.342"></a><span id="l3.342"> 		}</span>
<a href="#l3.343"></a><span id="l3.343"> </span>
<a href="#l3.344"></a><span id="l3.344"> 		/*</span>
<a href="#l3.345"></a><span id="l3.345"> 		**	the data portion header information.</span>
<a href="#l3.346"></a><span id="l3.346"> 		*/</span>
<a href="#l3.347"></a><span id="l3.347" class="difflineplus">+        nsCAutoString leafName;</span>
<a href="#l3.348"></a><span id="l3.348" class="difflineplus">+        resFile-&gt;GetNativeLeafName(leafName);</span>
<a href="#l3.349"></a><span id="l3.349"> 		PR_snprintf(rd_buff, sizeof(rd_buff),</span>
<a href="#l3.350"></a><span id="l3.350"> 			&quot;Content-Type: %s; name=\&quot;%s\&quot;&quot; CRLF &quot;Content-Transfer-Encoding: base64&quot; CRLF &quot;Content-Disposition: inline; filename=\&quot;%s\&quot;&quot;CRLF CRLF,</span>
<a href="#l3.351"></a><span id="l3.351"> 			magic_type,</span>
<a href="#l3.352"></a><span id="l3.352" class="difflineminus">-			p_ap_encode_obj-&gt;fname,</span>
<a href="#l3.353"></a><span id="l3.353" class="difflineminus">-			p_ap_encode_obj-&gt;fname);</span>
<a href="#l3.354"></a><span id="l3.354" class="difflineplus">+			leafName.get(),</span>
<a href="#l3.355"></a><span id="l3.355" class="difflineplus">+			leafName.get());</span>
<a href="#l3.356"></a><span id="l3.356"> 			</span>
<a href="#l3.357"></a><span id="l3.357"> 		status = write_stream(p_ap_encode_obj, </span>
<a href="#l3.358"></a><span id="l3.358"> 					rd_buff, </span>
<a href="#l3.359"></a><span id="l3.359"> 					strlen(rd_buff)); </span>
<a href="#l3.360"></a><span id="l3.360"> 		if (status != noErr)</span>
<a href="#l3.361"></a><span id="l3.361"> 			return status;</span>
<a href="#l3.362"></a><span id="l3.362"> 	}</span>
<a href="#l3.363"></a><span id="l3.363"> 	</span>
<a href="#l3.364"></a><span id="l3.364"> 	while (retval == noErr)</span>
<a href="#l3.365"></a><span id="l3.365"> 	{</span>
<a href="#l3.366"></a><span id="l3.366"> 		if (BUFF_LEFT(p_ap_encode_obj) &lt; 400)</span>
<a href="#l3.367"></a><span id="l3.367"> 			break;</span>
<a href="#l3.368"></a><span id="l3.368"> 			</span>
<a href="#l3.369"></a><span id="l3.369" class="difflineminus">-		in_count = 256;</span>
<a href="#l3.370"></a><span id="l3.370" class="difflineminus">-		retval = FSRead(p_ap_encode_obj-&gt;fileId, </span>
<a href="#l3.371"></a><span id="l3.371" class="difflineminus">-						&amp;in_count, </span>
<a href="#l3.372"></a><span id="l3.372" class="difflineminus">-						rd_buff);</span>
<a href="#l3.373"></a><span id="l3.373" class="difflineplus">+        in_count = 0;</span>
<a href="#l3.374"></a><span id="l3.374" class="difflineplus">+        retval = ::FSReadFork(p_ap_encode_obj-&gt;fileId, fsAtMark, 0, 256, rd_buff, &amp;in_count);</span>
<a href="#l3.375"></a><span id="l3.375"> 		if (in_count)</span>
<a href="#l3.376"></a><span id="l3.376"> 		{</span>
<a href="#l3.377"></a><span id="l3.377"> /*			replace(rd_buff, in_count, '\r', '\n');	 						*/</span>
<a href="#l3.378"></a><span id="l3.378"> /* ** may be need to do character set conversion here for localization.	**  */		</span>
<a href="#l3.379"></a><span id="l3.379"> 			status = to64(p_ap_encode_obj,</span>
<a href="#l3.380"></a><span id="l3.380"> 						rd_buff,</span>
<a href="#l3.381"></a><span id="l3.381"> 						in_count);</span>
<a href="#l3.382"></a><span id="l3.382"> 			if (status != noErr)</span>
<a href="#l3.383"></a><span id="l3.383"> 				return status;</span>
<a href="#l3.384"></a><span id="l3.384"> 		}</span>
<a href="#l3.385"></a><span id="l3.385"> 	}</span>
<a href="#l3.386"></a><span id="l3.386"> 	</span>
<a href="#l3.387"></a><span id="l3.387"> 	if (retval == eofErr)</span>
<a href="#l3.388"></a><span id="l3.388"> 	{</span>
<a href="#l3.389"></a><span id="l3.389" class="difflineminus">-		FSClose(p_ap_encode_obj-&gt;fileId);</span>
<a href="#l3.390"></a><span id="l3.390" class="difflineplus">+        ::FSCloseFork(p_ap_encode_obj-&gt;fileId);</span>
<a href="#l3.391"></a><span id="l3.391" class="difflineplus">+        p_ap_encode_obj-&gt;fileId = 0;</span>
<a href="#l3.392"></a><span id="l3.392"> </span>
<a href="#l3.393"></a><span id="l3.393"> 		status = finish64(p_ap_encode_obj);</span>
<a href="#l3.394"></a><span id="l3.394"> 		if (status != noErr)</span>
<a href="#l3.395"></a><span id="l3.395"> 			return status;</span>
<a href="#l3.396"></a><span id="l3.396"> 		</span>
<a href="#l3.397"></a><span id="l3.397"> 		/* write out the boundary 	*/</span>
<a href="#l3.398"></a><span id="l3.398"> 		</span>
<a href="#l3.399"></a><span id="l3.399"> 		PR_snprintf(rd_buff, sizeof(rd_buff),</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

