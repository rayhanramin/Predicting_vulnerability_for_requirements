<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 65:b9967a04b9bddf00934a4c5bac7e061cf733e44f</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ b9967a04b9bddf00934a4c5bac7e061cf733e44f" />
<meta property="og:url" content="/comm-central/rev/b9967a04b9bddf00934a4c5bac7e061cf733e44f" />
<meta property="og:description" content="Bug 413260 -- Refactor the Address Book (nsIAbCard refactors). r=Standard8, sr=dmose." />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / b9967a04b9bddf00934a4c5bac7e061cf733e44f 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/b9967a04b9bddf00934a4c5bac7e061cf733e44f">shortlog</a> |
<a href="/comm-central/log/b9967a04b9bddf00934a4c5bac7e061cf733e44f">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/b9967a04b9bddf00934a4c5bac7e061cf733e44f">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/b9967a04b9bddf00934a4c5bac7e061cf733e44f">files</a> |
changeset |
<a href="/comm-central/raw-rev/b9967a04b9bddf00934a4c5bac7e061cf733e44f">raw</a>  | <a href="/comm-central/archive/b9967a04b9bddf00934a4c5bac7e061cf733e44f.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=413260">Bug 413260</a> -- Refactor the Address Book (nsIAbCard refactors). r=Standard8, sr=dmose.
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#74;&#111;&#115;&#104;&#117;&#97;&#32;&#67;&#114;&#97;&#110;&#109;&#101;&#114;&#32;&#60;&#80;&#105;&#100;&#103;&#101;&#111;&#116;&#49;&#56;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 07 Aug 2008 08:45:06 -0400</td></tr>

<tr>
 <td>changeset 65</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/b9967a04b9bddf00934a4c5bac7e061cf733e44f">b9967a04b9bddf00934a4c5bac7e061cf733e44f</a></td>
</tr>



<tr>
<td>parent 64</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/9d26fe956df7e74b2c7b23bf7ea4cf7abdaa32d4">9d26fe956df7e74b2c7b23bf7ea4cf7abdaa32d4</a>
</td>
</tr>

<tr>
<td>child 66</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/9cbd14a19dfdf208a104ac87baa8c27c4f5a19c4">9cbd14a19dfdf208a104ac87baa8c27c4f5a19c4</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=b9967a04b9bddf00934a4c5bac7e061cf733e44f">59</a></td></tr>
<tr><td>push user</td><td>Pidgeot18@gmail.com</td></tr>
<tr><td>push date</td><td class="date age">Thu, 07 Aug 2008 12:46:38 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@b9967a04b9bd [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=b9967a04b9bddf00934a4c5bac7e061cf733e44f">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=b9967a04b9bddf00934a4c5bac7e061cf733e44f&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=b9967a04b9bddf00934a4c5bac7e061cf733e44f&newProject=comm-central&newRevision=b9967a04b9bddf00934a4c5bac7e061cf733e44f&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=b9967a04b9bddf00934a4c5bac7e061cf733e44f&newProject=comm-central&newRevision=b9967a04b9bddf00934a4c5bac7e061cf733e44f&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=b9967a04b9bddf00934a4c5bac7e061cf733e44f&newProject=comm-central&newRevision=b9967a04b9bddf00934a4c5bac7e061cf733e44f&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28Standard8%29&revcount=50">Standard8</a>, <a href="/comm-central/log?rev=reviewer%28dmose%29&revcount=50">dmose</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=413260">413260</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=413260">Bug 413260</a> -- Refactor the Address Book (nsIAbCard refactors). r=Standard8, sr=dmose.
This patch is pretty much guaranteed to bitrot anything dealing with the address book.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mail/base/content/mailWindowOverlay.js">mail/base/content/mailWindowOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mail/base/content/mailWindowOverlay.js">file</a> |
<a href="/comm-central/annotate/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mail/base/content/mailWindowOverlay.js">annotate</a> |
<a href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mail/base/content/mailWindowOverlay.js">diff</a> |
<a href="/comm-central/comparison/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mail/base/content/mailWindowOverlay.js">comparison</a> |
<a href="/comm-central/log/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mail/base/content/mailWindowOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mail/components/addrbook/content/abCardOverlay.js">mail/components/addrbook/content/abCardOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mail/components/addrbook/content/abCardOverlay.js">file</a> |
<a href="/comm-central/annotate/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mail/components/addrbook/content/abCardOverlay.js">annotate</a> |
<a href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mail/components/addrbook/content/abCardOverlay.js">diff</a> |
<a href="/comm-central/comparison/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mail/components/addrbook/content/abCardOverlay.js">comparison</a> |
<a href="/comm-central/log/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mail/components/addrbook/content/abCardOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mail/components/addrbook/content/abCardViewOverlay.js">mail/components/addrbook/content/abCardViewOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mail/components/addrbook/content/abCardViewOverlay.js">file</a> |
<a href="/comm-central/annotate/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mail/components/addrbook/content/abCardViewOverlay.js">annotate</a> |
<a href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mail/components/addrbook/content/abCardViewOverlay.js">diff</a> |
<a href="/comm-central/comparison/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mail/components/addrbook/content/abCardViewOverlay.js">comparison</a> |
<a href="/comm-central/log/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mail/components/addrbook/content/abCardViewOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mail/components/addrbook/content/addressbook.js">mail/components/addrbook/content/addressbook.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mail/components/addrbook/content/addressbook.js">file</a> |
<a href="/comm-central/annotate/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mail/components/addrbook/content/addressbook.js">annotate</a> |
<a href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mail/components/addrbook/content/addressbook.js">diff</a> |
<a href="/comm-central/comparison/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mail/components/addrbook/content/addressbook.js">comparison</a> |
<a href="/comm-central/log/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mail/components/addrbook/content/addressbook.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/public/Makefile.in">mailnews/addrbook/public/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/public/Makefile.in">file</a> |
<a href="/comm-central/annotate/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/public/Makefile.in">annotate</a> |
<a href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/public/Makefile.in">diff</a> |
<a href="/comm-central/comparison/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/public/Makefile.in">comparison</a> |
<a href="/comm-central/log/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/public/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/public/nsIAbCard.idl">mailnews/addrbook/public/nsIAbCard.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/public/nsIAbCard.idl">file</a> |
<a href="/comm-central/annotate/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/public/nsIAbCard.idl">annotate</a> |
<a href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/public/nsIAbCard.idl">diff</a> |
<a href="/comm-central/comparison/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/public/nsIAbCard.idl">comparison</a> |
<a href="/comm-central/log/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/public/nsIAbCard.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/public/nsIAbDirectory.idl">mailnews/addrbook/public/nsIAbDirectory.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/public/nsIAbDirectory.idl">file</a> |
<a href="/comm-central/annotate/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/public/nsIAbDirectory.idl">annotate</a> |
<a href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/public/nsIAbDirectory.idl">diff</a> |
<a href="/comm-central/comparison/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/public/nsIAbDirectory.idl">comparison</a> |
<a href="/comm-central/log/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/public/nsIAbDirectory.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/public/nsIAbItem.idl">mailnews/addrbook/public/nsIAbItem.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/public/nsIAbItem.idl">file</a> |
<a href="/comm-central/annotate/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/public/nsIAbItem.idl">annotate</a> |
<a href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/public/nsIAbItem.idl">diff</a> |
<a href="/comm-central/comparison/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/public/nsIAbItem.idl">comparison</a> |
<a href="/comm-central/log/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/public/nsIAbItem.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/public/nsIAbMDBCard.idl">mailnews/addrbook/public/nsIAbMDBCard.idl</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/public/nsIAbMDBCard.idl">diff</a> |
<a href="/comm-central/comparison/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/public/nsIAbMDBCard.idl">comparison</a> |
<a href="/comm-central/log/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/public/nsIAbMDBCard.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/public/nsIAddrDatabase.idl">mailnews/addrbook/public/nsIAddrDatabase.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/public/nsIAddrDatabase.idl">file</a> |
<a href="/comm-central/annotate/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/public/nsIAddrDatabase.idl">annotate</a> |
<a href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/public/nsIAddrDatabase.idl">diff</a> |
<a href="/comm-central/comparison/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/public/nsIAddrDatabase.idl">comparison</a> |
<a href="/comm-central/log/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/public/nsIAddrDatabase.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/resources/content/abCardOverlay.js">mailnews/addrbook/resources/content/abCardOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/resources/content/abCardOverlay.js">file</a> |
<a href="/comm-central/annotate/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/resources/content/abCardOverlay.js">annotate</a> |
<a href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/resources/content/abCardOverlay.js">diff</a> |
<a href="/comm-central/comparison/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/resources/content/abCardOverlay.js">comparison</a> |
<a href="/comm-central/log/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/resources/content/abCardOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/resources/content/abCardViewOverlay.js">mailnews/addrbook/resources/content/abCardViewOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/resources/content/abCardViewOverlay.js">file</a> |
<a href="/comm-central/annotate/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/resources/content/abCardViewOverlay.js">annotate</a> |
<a href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/resources/content/abCardViewOverlay.js">diff</a> |
<a href="/comm-central/comparison/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/resources/content/abCardViewOverlay.js">comparison</a> |
<a href="/comm-central/log/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/resources/content/abCardViewOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/resources/content/abMailListDialog.js">mailnews/addrbook/resources/content/abMailListDialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/resources/content/abMailListDialog.js">file</a> |
<a href="/comm-central/annotate/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/resources/content/abMailListDialog.js">annotate</a> |
<a href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/resources/content/abMailListDialog.js">diff</a> |
<a href="/comm-central/comparison/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/resources/content/abMailListDialog.js">comparison</a> |
<a href="/comm-central/log/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/resources/content/abMailListDialog.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/resources/content/addressbook.js">mailnews/addrbook/resources/content/addressbook.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/resources/content/addressbook.js">file</a> |
<a href="/comm-central/annotate/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/resources/content/addressbook.js">annotate</a> |
<a href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/resources/content/addressbook.js">diff</a> |
<a href="/comm-central/comparison/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/resources/content/addressbook.js">comparison</a> |
<a href="/comm-central/log/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/resources/content/addressbook.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbAddressCollecter.cpp">mailnews/addrbook/src/nsAbAddressCollecter.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbAddressCollecter.cpp">file</a> |
<a href="/comm-central/annotate/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbAddressCollecter.cpp">annotate</a> |
<a href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbAddressCollecter.cpp">diff</a> |
<a href="/comm-central/comparison/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbAddressCollecter.cpp">comparison</a> |
<a href="/comm-central/log/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbAddressCollecter.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbAutoCompleteSearch.js">mailnews/addrbook/src/nsAbAutoCompleteSearch.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbAutoCompleteSearch.js">file</a> |
<a href="/comm-central/annotate/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbAutoCompleteSearch.js">annotate</a> |
<a href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbAutoCompleteSearch.js">diff</a> |
<a href="/comm-central/comparison/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbAutoCompleteSearch.js">comparison</a> |
<a href="/comm-central/log/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbAutoCompleteSearch.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbAutoCompleteSession.cpp">mailnews/addrbook/src/nsAbAutoCompleteSession.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbAutoCompleteSession.cpp">file</a> |
<a href="/comm-central/annotate/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbAutoCompleteSession.cpp">annotate</a> |
<a href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbAutoCompleteSession.cpp">diff</a> |
<a href="/comm-central/comparison/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbAutoCompleteSession.cpp">comparison</a> |
<a href="/comm-central/log/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbAutoCompleteSession.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbCardProperty.cpp">mailnews/addrbook/src/nsAbCardProperty.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbCardProperty.cpp">file</a> |
<a href="/comm-central/annotate/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbCardProperty.cpp">annotate</a> |
<a href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbCardProperty.cpp">diff</a> |
<a href="/comm-central/comparison/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbCardProperty.cpp">comparison</a> |
<a href="/comm-central/log/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbCardProperty.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbCardProperty.h">mailnews/addrbook/src/nsAbCardProperty.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbCardProperty.h">file</a> |
<a href="/comm-central/annotate/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbCardProperty.h">annotate</a> |
<a href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbCardProperty.h">diff</a> |
<a href="/comm-central/comparison/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbCardProperty.h">comparison</a> |
<a href="/comm-central/log/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbCardProperty.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbDirectoryQuery.cpp">mailnews/addrbook/src/nsAbDirectoryQuery.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbDirectoryQuery.cpp">file</a> |
<a href="/comm-central/annotate/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbDirectoryQuery.cpp">annotate</a> |
<a href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbDirectoryQuery.cpp">diff</a> |
<a href="/comm-central/comparison/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbDirectoryQuery.cpp">comparison</a> |
<a href="/comm-central/log/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbDirectoryQuery.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbLDAPAttributeMap.js">mailnews/addrbook/src/nsAbLDAPAttributeMap.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbLDAPAttributeMap.js">file</a> |
<a href="/comm-central/annotate/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbLDAPAttributeMap.js">annotate</a> |
<a href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbLDAPAttributeMap.js">diff</a> |
<a href="/comm-central/comparison/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbLDAPAttributeMap.js">comparison</a> |
<a href="/comm-central/log/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbLDAPAttributeMap.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbLDAPCard.cpp">mailnews/addrbook/src/nsAbLDAPCard.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbLDAPCard.cpp">file</a> |
<a href="/comm-central/annotate/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbLDAPCard.cpp">annotate</a> |
<a href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbLDAPCard.cpp">diff</a> |
<a href="/comm-central/comparison/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbLDAPCard.cpp">comparison</a> |
<a href="/comm-central/log/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbLDAPCard.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbLDAPCard.h">mailnews/addrbook/src/nsAbLDAPCard.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbLDAPCard.h">file</a> |
<a href="/comm-central/annotate/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbLDAPCard.h">annotate</a> |
<a href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbLDAPCard.h">diff</a> |
<a href="/comm-central/comparison/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbLDAPCard.h">comparison</a> |
<a href="/comm-central/log/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbLDAPCard.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbLDAPReplicationData.cpp">mailnews/addrbook/src/nsAbLDAPReplicationData.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbLDAPReplicationData.cpp">file</a> |
<a href="/comm-central/annotate/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbLDAPReplicationData.cpp">annotate</a> |
<a href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbLDAPReplicationData.cpp">diff</a> |
<a href="/comm-central/comparison/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbLDAPReplicationData.cpp">comparison</a> |
<a href="/comm-central/log/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbLDAPReplicationData.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbMDBCard.cpp">mailnews/addrbook/src/nsAbMDBCard.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbMDBCard.cpp">file</a> |
<a href="/comm-central/annotate/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbMDBCard.cpp">annotate</a> |
<a href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbMDBCard.cpp">diff</a> |
<a href="/comm-central/comparison/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbMDBCard.cpp">comparison</a> |
<a href="/comm-central/log/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbMDBCard.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbMDBCard.h">mailnews/addrbook/src/nsAbMDBCard.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbMDBCard.h">file</a> |
<a href="/comm-central/annotate/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbMDBCard.h">annotate</a> |
<a href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbMDBCard.h">diff</a> |
<a href="/comm-central/comparison/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbMDBCard.h">comparison</a> |
<a href="/comm-central/log/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbMDBCard.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbMDBDirProperty.cpp">mailnews/addrbook/src/nsAbMDBDirProperty.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbMDBDirProperty.cpp">file</a> |
<a href="/comm-central/annotate/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbMDBDirProperty.cpp">annotate</a> |
<a href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbMDBDirProperty.cpp">diff</a> |
<a href="/comm-central/comparison/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbMDBDirProperty.cpp">comparison</a> |
<a href="/comm-central/log/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbMDBDirProperty.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbMDBDirectory.cpp">mailnews/addrbook/src/nsAbMDBDirectory.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbMDBDirectory.cpp">file</a> |
<a href="/comm-central/annotate/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbMDBDirectory.cpp">annotate</a> |
<a href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbMDBDirectory.cpp">diff</a> |
<a href="/comm-central/comparison/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbMDBDirectory.cpp">comparison</a> |
<a href="/comm-central/log/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbMDBDirectory.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbManager.cpp">mailnews/addrbook/src/nsAbManager.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbManager.cpp">file</a> |
<a href="/comm-central/annotate/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbManager.cpp">annotate</a> |
<a href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbManager.cpp">diff</a> |
<a href="/comm-central/comparison/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbManager.cpp">comparison</a> |
<a href="/comm-central/log/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbManager.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbOSXCard.mm">mailnews/addrbook/src/nsAbOSXCard.mm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbOSXCard.mm">file</a> |
<a href="/comm-central/annotate/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbOSXCard.mm">annotate</a> |
<a href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbOSXCard.mm">diff</a> |
<a href="/comm-central/comparison/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbOSXCard.mm">comparison</a> |
<a href="/comm-central/log/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbOSXCard.mm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbOSXUtils.h">mailnews/addrbook/src/nsAbOSXUtils.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbOSXUtils.h">file</a> |
<a href="/comm-central/annotate/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbOSXUtils.h">annotate</a> |
<a href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbOSXUtils.h">diff</a> |
<a href="/comm-central/comparison/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbOSXUtils.h">comparison</a> |
<a href="/comm-central/log/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbOSXUtils.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbOSXUtils.mm">mailnews/addrbook/src/nsAbOSXUtils.mm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbOSXUtils.mm">file</a> |
<a href="/comm-central/annotate/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbOSXUtils.mm">annotate</a> |
<a href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbOSXUtils.mm">diff</a> |
<a href="/comm-central/comparison/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbOSXUtils.mm">comparison</a> |
<a href="/comm-central/log/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbOSXUtils.mm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbOutlookCard.cpp">mailnews/addrbook/src/nsAbOutlookCard.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbOutlookCard.cpp">file</a> |
<a href="/comm-central/annotate/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbOutlookCard.cpp">annotate</a> |
<a href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbOutlookCard.cpp">diff</a> |
<a href="/comm-central/comparison/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbOutlookCard.cpp">comparison</a> |
<a href="/comm-central/log/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbOutlookCard.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbOutlookDirectory.cpp">mailnews/addrbook/src/nsAbOutlookDirectory.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbOutlookDirectory.cpp">file</a> |
<a href="/comm-central/annotate/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbOutlookDirectory.cpp">annotate</a> |
<a href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbOutlookDirectory.cpp">diff</a> |
<a href="/comm-central/comparison/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbOutlookDirectory.cpp">comparison</a> |
<a href="/comm-central/log/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbOutlookDirectory.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbView.cpp">mailnews/addrbook/src/nsAbView.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbView.cpp">file</a> |
<a href="/comm-central/annotate/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbView.cpp">annotate</a> |
<a href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbView.cpp">diff</a> |
<a href="/comm-central/comparison/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbView.cpp">comparison</a> |
<a href="/comm-central/log/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAbView.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAddbookProtocolHandler.cpp">mailnews/addrbook/src/nsAddbookProtocolHandler.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAddbookProtocolHandler.cpp">file</a> |
<a href="/comm-central/annotate/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAddbookProtocolHandler.cpp">annotate</a> |
<a href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAddbookProtocolHandler.cpp">diff</a> |
<a href="/comm-central/comparison/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAddbookProtocolHandler.cpp">comparison</a> |
<a href="/comm-central/log/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAddbookProtocolHandler.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAddrDatabase.cpp">mailnews/addrbook/src/nsAddrDatabase.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAddrDatabase.cpp">file</a> |
<a href="/comm-central/annotate/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAddrDatabase.cpp">annotate</a> |
<a href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAddrDatabase.cpp">diff</a> |
<a href="/comm-central/comparison/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAddrDatabase.cpp">comparison</a> |
<a href="/comm-central/log/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/src/nsAddrDatabase.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/test/unit/test_basic_nsIAbCard.js">mailnews/addrbook/test/unit/test_basic_nsIAbCard.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/test/unit/test_basic_nsIAbCard.js">file</a> |
<a href="/comm-central/annotate/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/test/unit/test_basic_nsIAbCard.js">annotate</a> |
<a href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/test/unit/test_basic_nsIAbCard.js">diff</a> |
<a href="/comm-central/comparison/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/test/unit/test_basic_nsIAbCard.js">comparison</a> |
<a href="/comm-central/log/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/test/unit/test_basic_nsIAbCard.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/test/unit/test_collection.js">mailnews/addrbook/test/unit/test_collection.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/test/unit/test_collection.js">file</a> |
<a href="/comm-central/annotate/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/test/unit/test_collection.js">annotate</a> |
<a href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/test/unit/test_collection.js">diff</a> |
<a href="/comm-central/comparison/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/test/unit/test_collection.js">comparison</a> |
<a href="/comm-central/log/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/test/unit/test_collection.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch1.js">mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch1.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch1.js">file</a> |
<a href="/comm-central/annotate/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch1.js">annotate</a> |
<a href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch1.js">diff</a> |
<a href="/comm-central/comparison/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch1.js">comparison</a> |
<a href="/comm-central/log/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch1.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch2.js">mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch2.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch2.js">file</a> |
<a href="/comm-central/annotate/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch2.js">annotate</a> |
<a href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch2.js">diff</a> |
<a href="/comm-central/comparison/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch2.js">comparison</a> |
<a href="/comm-central/log/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch2.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch3.js">mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch3.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch3.js">file</a> |
<a href="/comm-central/annotate/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch3.js">annotate</a> |
<a href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch3.js">diff</a> |
<a href="/comm-central/comparison/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch3.js">comparison</a> |
<a href="/comm-central/log/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch3.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/test/unit/test_nsIAbCard.js">mailnews/addrbook/test/unit/test_nsIAbCard.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/test/unit/test_nsIAbCard.js">file</a> |
<a href="/comm-central/annotate/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/test/unit/test_nsIAbCard.js">annotate</a> |
<a href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/test/unit/test_nsIAbCard.js">diff</a> |
<a href="/comm-central/comparison/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/test/unit/test_nsIAbCard.js">comparison</a> |
<a href="/comm-central/log/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/addrbook/test/unit/test_nsIAbCard.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/base/resources/content/mailWindowOverlay.js">mailnews/base/resources/content/mailWindowOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/base/resources/content/mailWindowOverlay.js">file</a> |
<a href="/comm-central/annotate/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/base/resources/content/mailWindowOverlay.js">annotate</a> |
<a href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/base/resources/content/mailWindowOverlay.js">diff</a> |
<a href="/comm-central/comparison/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/base/resources/content/mailWindowOverlay.js">comparison</a> |
<a href="/comm-central/log/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/base/resources/content/mailWindowOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/base/resources/content/msgHdrViewOverlay.js">mailnews/base/resources/content/msgHdrViewOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/base/resources/content/msgHdrViewOverlay.js">file</a> |
<a href="/comm-central/annotate/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/base/resources/content/msgHdrViewOverlay.js">annotate</a> |
<a href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/base/resources/content/msgHdrViewOverlay.js">diff</a> |
<a href="/comm-central/comparison/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/base/resources/content/msgHdrViewOverlay.js">comparison</a> |
<a href="/comm-central/log/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/base/resources/content/msgHdrViewOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/base/src/nsMsgContentPolicy.cpp">mailnews/base/src/nsMsgContentPolicy.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/base/src/nsMsgContentPolicy.cpp">file</a> |
<a href="/comm-central/annotate/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/base/src/nsMsgContentPolicy.cpp">annotate</a> |
<a href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/base/src/nsMsgContentPolicy.cpp">diff</a> |
<a href="/comm-central/comparison/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/base/src/nsMsgContentPolicy.cpp">comparison</a> |
<a href="/comm-central/log/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/base/src/nsMsgContentPolicy.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/compose/src/nsMsgCompose.cpp">mailnews/compose/src/nsMsgCompose.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/compose/src/nsMsgCompose.cpp">file</a> |
<a href="/comm-central/annotate/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/compose/src/nsMsgCompose.cpp">annotate</a> |
<a href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/compose/src/nsMsgCompose.cpp">diff</a> |
<a href="/comm-central/comparison/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/compose/src/nsMsgCompose.cpp">comparison</a> |
<a href="/comm-central/log/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/compose/src/nsMsgCompose.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/extensions/palmsync/src/nsAbIPCCard.cpp">mailnews/extensions/palmsync/src/nsAbIPCCard.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/extensions/palmsync/src/nsAbIPCCard.cpp">file</a> |
<a href="/comm-central/annotate/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/extensions/palmsync/src/nsAbIPCCard.cpp">annotate</a> |
<a href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/extensions/palmsync/src/nsAbIPCCard.cpp">diff</a> |
<a href="/comm-central/comparison/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/extensions/palmsync/src/nsAbIPCCard.cpp">comparison</a> |
<a href="/comm-central/log/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/extensions/palmsync/src/nsAbIPCCard.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/extensions/palmsync/src/nsAbIPCCard.h">mailnews/extensions/palmsync/src/nsAbIPCCard.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/extensions/palmsync/src/nsAbIPCCard.h">file</a> |
<a href="/comm-central/annotate/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/extensions/palmsync/src/nsAbIPCCard.h">annotate</a> |
<a href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/extensions/palmsync/src/nsAbIPCCard.h">diff</a> |
<a href="/comm-central/comparison/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/extensions/palmsync/src/nsAbIPCCard.h">comparison</a> |
<a href="/comm-central/log/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/extensions/palmsync/src/nsAbIPCCard.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/extensions/palmsync/src/nsAbPalmSync.cpp">mailnews/extensions/palmsync/src/nsAbPalmSync.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/extensions/palmsync/src/nsAbPalmSync.cpp">file</a> |
<a href="/comm-central/annotate/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/extensions/palmsync/src/nsAbPalmSync.cpp">annotate</a> |
<a href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/extensions/palmsync/src/nsAbPalmSync.cpp">diff</a> |
<a href="/comm-central/comparison/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/extensions/palmsync/src/nsAbPalmSync.cpp">comparison</a> |
<a href="/comm-central/log/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/extensions/palmsync/src/nsAbPalmSync.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/extensions/palmsync/src/nsAbPalmSync.h">mailnews/extensions/palmsync/src/nsAbPalmSync.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/extensions/palmsync/src/nsAbPalmSync.h">file</a> |
<a href="/comm-central/annotate/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/extensions/palmsync/src/nsAbPalmSync.h">annotate</a> |
<a href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/extensions/palmsync/src/nsAbPalmSync.h">diff</a> |
<a href="/comm-central/comparison/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/extensions/palmsync/src/nsAbPalmSync.h">comparison</a> |
<a href="/comm-central/log/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/extensions/palmsync/src/nsAbPalmSync.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/import/src/nsImportFieldMap.cpp">mailnews/import/src/nsImportFieldMap.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/import/src/nsImportFieldMap.cpp">file</a> |
<a href="/comm-central/annotate/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/import/src/nsImportFieldMap.cpp">annotate</a> |
<a href="/comm-central/diff/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/import/src/nsImportFieldMap.cpp">diff</a> |
<a href="/comm-central/comparison/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/import/src/nsImportFieldMap.cpp">comparison</a> |
<a href="/comm-central/log/b9967a04b9bddf00934a4c5bac7e061cf733e44f/mailnews/import/src/nsImportFieldMap.cpp">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/base/content/mailWindowOverlay.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/base/content/mailWindowOverlay.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -2561,17 +2561,17 @@ function allowRemoteContentForSender()</span>
<a href="#l1.4"></a><span id="l1.4">     if (addrbook instanceof Components.interfaces.nsIAbMDBDirectory)</span>
<a href="#l1.5"></a><span id="l1.5">       cardForEmailAddress = addrbook.cardForEmailAddress(authorEmailAddress);</span>
<a href="#l1.6"></a><span id="l1.6">   }</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8">   var allowRemoteContent = false;</span>
<a href="#l1.9"></a><span id="l1.9">   if (cardForEmailAddress &amp;&amp; addrbook instanceof Components.interfaces.nsIAbDirectory)</span>
<a href="#l1.10"></a><span id="l1.10">   {</span>
<a href="#l1.11"></a><span id="l1.11">     // set the property for remote content</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-    cardForEmailAddress.allowRemoteContent = true;</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+    cardForEmailAddress.setProperty(&quot;AllowRemoteContent&quot;, true);</span>
<a href="#l1.14"></a><span id="l1.14">     addrbook.modifyCard(cardForEmailAddress);</span>
<a href="#l1.15"></a><span id="l1.15">     allowRemoteContent = true;</span>
<a href="#l1.16"></a><span id="l1.16">   }</span>
<a href="#l1.17"></a><span id="l1.17">   else</span>
<a href="#l1.18"></a><span id="l1.18">   {</span>
<a href="#l1.19"></a><span id="l1.19">     var args = {primaryEmail:authorEmailAddress, displayName:names.value[0],</span>
<a href="#l1.20"></a><span id="l1.20">                 allowRemoteContent:true};</span>
<a href="#l1.21"></a><span id="l1.21">     // create a new card and set the property</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/components/addrbook/content/abCardOverlay.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/components/addrbook/content/abCardOverlay.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -42,56 +42,56 @@ const kNonVcardFields =</span>
<a href="#l2.4"></a><span id="l2.4"> </span>
<a href="#l2.5"></a><span id="l2.5"> const kPhoneticFields =</span>
<a href="#l2.6"></a><span id="l2.6">         [&quot;PhoneticLastName&quot;, &quot;PhoneticLabel1&quot;, &quot;PhoneticSpacer1&quot;,</span>
<a href="#l2.7"></a><span id="l2.7">          &quot;PhoneticFirstName&quot;, &quot;PhoneticLabel2&quot;, &quot;PhoneticSpacer2&quot;];</span>
<a href="#l2.8"></a><span id="l2.8"> </span>
<a href="#l2.9"></a><span id="l2.9"> // Item is |[dialogField, cardProperty]|.</span>
<a href="#l2.10"></a><span id="l2.10"> const kVcardFields =</span>
<a href="#l2.11"></a><span id="l2.11">         [ // Contact &gt; Name</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-         [&quot;FirstName&quot;, &quot;firstName&quot;],</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-         [&quot;LastName&quot;, &quot;lastName&quot;],</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-         [&quot;DisplayName&quot;, &quot;displayName&quot;],</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineminus">-         [&quot;NickName&quot;, &quot;nickName&quot;],</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+         [&quot;FirstName&quot;, &quot;FirstName&quot;],</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+         [&quot;LastName&quot;, &quot;LastName&quot;],</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+         [&quot;DisplayName&quot;, &quot;DisplayName&quot;],</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+         [&quot;NickName&quot;, &quot;NickName&quot;],</span>
<a href="#l2.20"></a><span id="l2.20">           // Contact &gt; Internet</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineminus">-         [&quot;PrimaryEmail&quot;, &quot;primaryEmail&quot;],</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineminus">-         [&quot;SecondEmail&quot;, &quot;secondEmail&quot;],</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineminus">-         [&quot;ScreenName&quot;, &quot;aimScreenName&quot;], // NB: AIM.</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineplus">+         [&quot;PrimaryEmail&quot;, &quot;PrimaryEmail&quot;],</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineplus">+         [&quot;SecondEmail&quot;, &quot;SecondEmail&quot;],</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineplus">+         [&quot;ScreenName&quot;, &quot;_AimScreenName&quot;], // NB: AIM.</span>
<a href="#l2.27"></a><span id="l2.27">           // Contact &gt; Phones</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineminus">-         [&quot;WorkPhone&quot;, &quot;workPhone&quot;],</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineminus">-         [&quot;HomePhone&quot;, &quot;homePhone&quot;],</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineminus">-         [&quot;FaxNumber&quot;, &quot;faxNumber&quot;],</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-         [&quot;PagerNumber&quot;, &quot;pagerNumber&quot;],</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineminus">-         [&quot;CellularNumber&quot;, &quot;cellularNumber&quot;],</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+         [&quot;WorkPhone&quot;, &quot;WorkPhone&quot;],</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+         [&quot;HomePhone&quot;, &quot;HomePhone&quot;],</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+         [&quot;FaxNumber&quot;, &quot;FaxNumber&quot;],</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+         [&quot;PagerNumber&quot;, &quot;PagerNumber&quot;],</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+         [&quot;CellularNumber&quot;, &quot;CellularNumber&quot;],</span>
<a href="#l2.38"></a><span id="l2.38">           // Address &gt; Home</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineminus">-         [&quot;HomeAddress&quot;, &quot;homeAddress&quot;],</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineminus">-         [&quot;HomeAddress2&quot;, &quot;homeAddress2&quot;],</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineminus">-         [&quot;HomeCity&quot;, &quot;homeCity&quot;],</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineminus">-         [&quot;HomeState&quot;, &quot;homeState&quot;],</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineminus">-         [&quot;HomeZipCode&quot;, &quot;homeZipCode&quot;],</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineminus">-         [&quot;HomeCountry&quot;, &quot;homeCountry&quot;],</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineminus">-         [&quot;WebPage2&quot;, &quot;webPage2&quot;],</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineplus">+         [&quot;HomeAddress&quot;, &quot;HomeAddress&quot;],</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineplus">+         [&quot;HomeAddress2&quot;, &quot;HomeAddress2&quot;],</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineplus">+         [&quot;HomeCity&quot;, &quot;HomeCity&quot;],</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineplus">+         [&quot;HomeState&quot;, &quot;HomeState&quot;],</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineplus">+         [&quot;HomeZipCode&quot;, &quot;HomeZipCode&quot;],</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineplus">+         [&quot;HomeCountry&quot;, &quot;HomeCountry&quot;],</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineplus">+         [&quot;WebPage2&quot;, &quot;WebPage2&quot;],</span>
<a href="#l2.53"></a><span id="l2.53">           // Address &gt; Work</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineminus">-         [&quot;JobTitle&quot;, &quot;jobTitle&quot;],</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineminus">-         [&quot;Department&quot;, &quot;department&quot;],</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineminus">-         [&quot;Company&quot;, &quot;company&quot;],</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineminus">-         [&quot;WorkAddress&quot;, &quot;workAddress&quot;],</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineminus">-         [&quot;WorkAddress2&quot;, &quot;workAddress2&quot;],</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineminus">-         [&quot;WorkCity&quot;, &quot;workCity&quot;],</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineminus">-         [&quot;WorkState&quot;, &quot;workState&quot;],</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineminus">-         [&quot;WorkZipCode&quot;, &quot;workZipCode&quot;],</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineminus">-         [&quot;WorkCountry&quot;, &quot;workCountry&quot;],</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineminus">-         [&quot;WebPage1&quot;, &quot;webPage1&quot;],</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineplus">+         [&quot;JobTitle&quot;, &quot;JobTitle&quot;],</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineplus">+         [&quot;Department&quot;, &quot;Department&quot;],</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineplus">+         [&quot;Company&quot;, &quot;Company&quot;],</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineplus">+         [&quot;WorkAddress&quot;, &quot;WorkAddress&quot;],</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineplus">+         [&quot;WorkAddress2&quot;, &quot;WorkAddress2&quot;],</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineplus">+         [&quot;WorkCity&quot;, &quot;WorkCity&quot;],</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineplus">+         [&quot;WorkState&quot;, &quot;WorkState&quot;],</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineplus">+         [&quot;WorkZipCode&quot;, &quot;WorkZipCode&quot;],</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineplus">+         [&quot;WorkCountry&quot;, &quot;WorkCountry&quot;],</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineplus">+         [&quot;WebPage1&quot;, &quot;WebPage1&quot;],</span>
<a href="#l2.74"></a><span id="l2.74">           // Other &gt; (custom)</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineminus">-         [&quot;Custom1&quot;, &quot;custom1&quot;],</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineminus">-         [&quot;Custom2&quot;, &quot;custom2&quot;],</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineminus">-         [&quot;Custom3&quot;, &quot;custom3&quot;],</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineminus">-         [&quot;Custom4&quot;, &quot;custom4&quot;],</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineplus">+         [&quot;Custom1&quot;, &quot;Custom1&quot;],</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineplus">+         [&quot;Custom2&quot;, &quot;Custom2&quot;],</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineplus">+         [&quot;Custom3&quot;, &quot;Custom3&quot;],</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineplus">+         [&quot;Custom4&quot;, &quot;Custom4&quot;],</span>
<a href="#l2.83"></a><span id="l2.83">           // Other &gt; Notes</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineminus">-         [&quot;Notes&quot;, &quot;notes&quot;]];</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineplus">+         [&quot;Notes&quot;, &quot;Notes&quot;]];</span>
<a href="#l2.86"></a><span id="l2.86"> </span>
<a href="#l2.87"></a><span id="l2.87"> var gEditCard;</span>
<a href="#l2.88"></a><span id="l2.88"> var gOnSaveListeners = new Array();</span>
<a href="#l2.89"></a><span id="l2.89"> var gOkCallback = null;</span>
<a href="#l2.90"></a><span id="l2.90"> var gHideABPicker = false;</span>
<a href="#l2.91"></a><span id="l2.91"> </span>
<a href="#l2.92"></a><span id="l2.92"> function OnLoadNewCard()</span>
<a href="#l2.93"></a><span id="l2.93"> {</span>
<a href="#l2.94"></a><span id="l2.94" class="difflineat">@@ -132,22 +132,21 @@ function OnLoadNewCard()</span>
<a href="#l2.95"></a><span id="l2.95">       gEditCard.card.displayName = window.arguments[0].displayName;</span>
<a href="#l2.96"></a><span id="l2.96">       // if we've got a display name, don't generate</span>
<a href="#l2.97"></a><span id="l2.97">       // a display name (and stomp on the existing display name)</span>
<a href="#l2.98"></a><span id="l2.98">       // when the user types a first or last name</span>
<a href="#l2.99"></a><span id="l2.99">       if (gEditCard.card.displayName.length)</span>
<a href="#l2.100"></a><span id="l2.100">         gEditCard.generateDisplayName = false;</span>
<a href="#l2.101"></a><span id="l2.101">     }</span>
<a href="#l2.102"></a><span id="l2.102">     if (&quot;aimScreenName&quot; in window.arguments[0])</span>
<a href="#l2.103"></a><span id="l2.103" class="difflineminus">-      gEditCard.card.aimScreenName = window.arguments[0].aimScreenName;</span>
<a href="#l2.104"></a><span id="l2.104" class="difflineminus">-    </span>
<a href="#l2.105"></a><span id="l2.105" class="difflineminus">-    if (&quot;allowRemoteContent&quot; in window.arguments[0]) {</span>
<a href="#l2.106"></a><span id="l2.106" class="difflineminus">-      gEditCard.card.allowRemoteContent = window.arguments[0].allowRemoteContent;</span>
<a href="#l2.107"></a><span id="l2.107" class="difflineminus">-      window.arguments[0].allowRemoteContent = false;</span>
<a href="#l2.108"></a><span id="l2.108" class="difflineminus">-    }</span>
<a href="#l2.109"></a><span id="l2.109" class="difflineplus">+      gEditCard.card.setProperty(&quot;_AimScreenName&quot;,</span>
<a href="#l2.110"></a><span id="l2.110" class="difflineplus">+                                 window.arguments[0].aimScreenName);</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineplus">+    if (&quot;allowRemoteContent&quot; in window.arguments[0])</span>
<a href="#l2.112"></a><span id="l2.112" class="difflineplus">+      gEditCard.card.setProperty(&quot;AllowRemoteContent&quot;,</span>
<a href="#l2.113"></a><span id="l2.113" class="difflineplus">+                                 window.arguments[0].allowRemoteContent);</span>
<a href="#l2.114"></a><span id="l2.114"> </span>
<a href="#l2.115"></a><span id="l2.115">     if (&quot;okCallback&quot; in window.arguments[0])</span>
<a href="#l2.116"></a><span id="l2.116">       gOkCallback = window.arguments[0].okCallback;</span>
<a href="#l2.117"></a><span id="l2.117"> </span>
<a href="#l2.118"></a><span id="l2.118">     if (&quot;escapedVCardStr&quot; in window.arguments[0]) {</span>
<a href="#l2.119"></a><span id="l2.119">       // hide non vcard values</span>
<a href="#l2.120"></a><span id="l2.120">       HideNonVcardFields();</span>
<a href="#l2.121"></a><span id="l2.121">       gEditCard.card =</span>
<a href="#l2.122"></a><span id="l2.122" class="difflineat">@@ -365,17 +364,17 @@ function InitEditCard()</span>
<a href="#l2.123"></a><span id="l2.123"> </span>
<a href="#l2.124"></a><span id="l2.124"> function NewCardOKButton()</span>
<a href="#l2.125"></a><span id="l2.125"> {</span>
<a href="#l2.126"></a><span id="l2.126">   if (gOkCallback)</span>
<a href="#l2.127"></a><span id="l2.127">   {</span>
<a href="#l2.128"></a><span id="l2.128">     if (!CheckAndSetCardValues(gEditCard.card, document, true))</span>
<a href="#l2.129"></a><span id="l2.129">       return false;  // don't close window</span>
<a href="#l2.130"></a><span id="l2.130"> </span>
<a href="#l2.131"></a><span id="l2.131" class="difflineminus">-    gOkCallback(gEditCard.card.convertToEscapedVCard());</span>
<a href="#l2.132"></a><span id="l2.132" class="difflineplus">+    gOkCallback(gEditCard.card.translateTo(&quot;vcard&quot;));</span>
<a href="#l2.133"></a><span id="l2.133">     return true;  // close the window</span>
<a href="#l2.134"></a><span id="l2.134">   }</span>
<a href="#l2.135"></a><span id="l2.135"> </span>
<a href="#l2.136"></a><span id="l2.136">   var popup = document.getElementById('abPopup');</span>
<a href="#l2.137"></a><span id="l2.137">   if ( popup )</span>
<a href="#l2.138"></a><span id="l2.138">   {</span>
<a href="#l2.139"></a><span id="l2.139">     var uri = popup.getAttribute('value');</span>
<a href="#l2.140"></a><span id="l2.140"> </span>
<a href="#l2.141"></a><span id="l2.141" class="difflineat">@@ -390,46 +389,49 @@ function NewCardOKButton()</span>
<a href="#l2.142"></a><span id="l2.142">       if (!CheckAndSetCardValues(gEditCard.card, document, true))</span>
<a href="#l2.143"></a><span id="l2.143">         return false;  // don't close window</span>
<a href="#l2.144"></a><span id="l2.144"> </span>
<a href="#l2.145"></a><span id="l2.145">       // replace gEditCard.card with the card we added</span>
<a href="#l2.146"></a><span id="l2.146">       // so that save listeners can get / set attributes on</span>
<a href="#l2.147"></a><span id="l2.147">       // the card that got created.</span>
<a href="#l2.148"></a><span id="l2.148">       gEditCard.card = GetDirectoryFromURI(uri).addCard(gEditCard.card);</span>
<a href="#l2.149"></a><span id="l2.149">       NotifySaveListeners();</span>
<a href="#l2.150"></a><span id="l2.150" class="difflineminus">-      if (&quot;arguments&quot; in window &amp;&amp; window.arguments[0])</span>
<a href="#l2.151"></a><span id="l2.151" class="difflineminus">-        window.arguments[0].allowRemoteContent = gEditCard.card.allowRemoteContent;</span>
<a href="#l2.152"></a><span id="l2.152" class="difflineplus">+      if (&quot;arguments&quot; in window &amp;&amp; window.arguments[0]) {</span>
<a href="#l2.153"></a><span id="l2.153" class="difflineplus">+        window.arguments[0].allowRemoteContent =</span>
<a href="#l2.154"></a><span id="l2.154" class="difflineplus">+          gEditCard.card.getProperty(&quot;AllowRemoteContent&quot;, false);</span>
<a href="#l2.155"></a><span id="l2.155" class="difflineplus">+      }</span>
<a href="#l2.156"></a><span id="l2.156">     }</span>
<a href="#l2.157"></a><span id="l2.157">   }</span>
<a href="#l2.158"></a><span id="l2.158"> </span>
<a href="#l2.159"></a><span id="l2.159">   return true;  // close the window</span>
<a href="#l2.160"></a><span id="l2.160"> }</span>
<a href="#l2.161"></a><span id="l2.161"> </span>
<a href="#l2.162"></a><span id="l2.162"> // Move the data from the cardproperty to the dialog</span>
<a href="#l2.163"></a><span id="l2.163"> function GetCardValues(cardproperty, doc)</span>
<a href="#l2.164"></a><span id="l2.164"> {</span>
<a href="#l2.165"></a><span id="l2.165">   if (!cardproperty)</span>
<a href="#l2.166"></a><span id="l2.166">     return;</span>
<a href="#l2.167"></a><span id="l2.167"> </span>
<a href="#l2.168"></a><span id="l2.168" class="difflineminus">-  for (var i = kVcardFields.length; i-- &gt; 0; )</span>
<a href="#l2.169"></a><span id="l2.169" class="difflineplus">+  for (var i = kVcardFields.length; i-- &gt; 0; ) {</span>
<a href="#l2.170"></a><span id="l2.170">     doc.getElementById(kVcardFields[i][0]).value =</span>
<a href="#l2.171"></a><span id="l2.171" class="difflineminus">-      cardproperty[kVcardFields[i][1]];</span>
<a href="#l2.172"></a><span id="l2.172" class="difflineplus">+      cardproperty.getProperty(kVcardFields[i][1], &quot;&quot;);</span>
<a href="#l2.173"></a><span id="l2.173" class="difflineplus">+  }</span>
<a href="#l2.174"></a><span id="l2.174"> </span>
<a href="#l2.175"></a><span id="l2.175">   var popup = document.getElementById(&quot;PreferMailFormatPopup&quot;);</span>
<a href="#l2.176"></a><span id="l2.176">   if (popup)</span>
<a href="#l2.177"></a><span id="l2.177" class="difflineminus">-    popup.value = cardproperty.preferMailFormat;</span>
<a href="#l2.178"></a><span id="l2.178" class="difflineplus">+    popup.value = cardproperty.getProperty(&quot;PreferMailFormat&quot;, &quot;&quot;);</span>
<a href="#l2.179"></a><span id="l2.179">     </span>
<a href="#l2.180"></a><span id="l2.180">   var allowRemoteContentEl = document.getElementById(&quot;allowRemoteContent&quot;);</span>
<a href="#l2.181"></a><span id="l2.181">   if (allowRemoteContentEl)</span>
<a href="#l2.182"></a><span id="l2.182" class="difflineminus">-    allowRemoteContentEl.checked = cardproperty.allowRemoteContent;</span>
<a href="#l2.183"></a><span id="l2.183" class="difflineplus">+    allowRemoteContentEl.checked = cardproperty.getProperty(&quot;AllowRemoteContent&quot;, false);</span>
<a href="#l2.184"></a><span id="l2.184"> </span>
<a href="#l2.185"></a><span id="l2.185">   // get phonetic fields if exist</span>
<a href="#l2.186"></a><span id="l2.186">   try {</span>
<a href="#l2.187"></a><span id="l2.187" class="difflineminus">-    doc.getElementById(&quot;PhoneticFirstName&quot;).value = cardproperty.phoneticFirstName;</span>
<a href="#l2.188"></a><span id="l2.188" class="difflineminus">-    doc.getElementById(&quot;PhoneticLastName&quot;).value = cardproperty.phoneticLastName;</span>
<a href="#l2.189"></a><span id="l2.189" class="difflineplus">+    doc.getElementById(&quot;PhoneticFirstName&quot;).value = cardproperty.getProperty(&quot;PhoneticFirstName&quot;, &quot;&quot;);</span>
<a href="#l2.190"></a><span id="l2.190" class="difflineplus">+    doc.getElementById(&quot;PhoneticLastName&quot;).value = cardproperty.getProperty(&quot;PhoneticLastName&quot;, &quot;&quot;);</span>
<a href="#l2.191"></a><span id="l2.191">   }</span>
<a href="#l2.192"></a><span id="l2.192">   catch (ex) {}</span>
<a href="#l2.193"></a><span id="l2.193"> }</span>
<a href="#l2.194"></a><span id="l2.194"> </span>
<a href="#l2.195"></a><span id="l2.195"> // when the ab card dialog is being loaded to show a vCard,</span>
<a href="#l2.196"></a><span id="l2.196"> // hide the fields which aren't supported</span>
<a href="#l2.197"></a><span id="l2.197"> // by vCard so the user does not try to edit them.</span>
<a href="#l2.198"></a><span id="l2.198"> function HideNonVcardFields()</span>
<a href="#l2.199"></a><span id="l2.199" class="difflineat">@@ -446,31 +448,31 @@ function CheckAndSetCardValues(cardprope</span>
<a href="#l2.200"></a><span id="l2.200">   // If requested, check the required data presence.</span>
<a href="#l2.201"></a><span id="l2.201">   if (check &amp;&amp; !CheckCardRequiredDataPresence(document))</span>
<a href="#l2.202"></a><span id="l2.202">     return false;</span>
<a href="#l2.203"></a><span id="l2.203"> </span>
<a href="#l2.204"></a><span id="l2.204">   if (!cardproperty)</span>
<a href="#l2.205"></a><span id="l2.205">     return true;</span>
<a href="#l2.206"></a><span id="l2.206"> </span>
<a href="#l2.207"></a><span id="l2.207">   for (var i = kVcardFields.length; i-- &gt; 0; )</span>
<a href="#l2.208"></a><span id="l2.208" class="difflineminus">-    cardproperty[kVcardFields[i][1]] =</span>
<a href="#l2.209"></a><span id="l2.209" class="difflineminus">-      doc.getElementById(kVcardFields[i][0]).value;</span>
<a href="#l2.210"></a><span id="l2.210" class="difflineplus">+    cardproperty.setProperty(kVcardFields[i][1],</span>
<a href="#l2.211"></a><span id="l2.211" class="difflineplus">+      doc.getElementById(kVcardFields[i][0]).value);</span>
<a href="#l2.212"></a><span id="l2.212"> </span>
<a href="#l2.213"></a><span id="l2.213">   var popup = document.getElementById(&quot;PreferMailFormatPopup&quot;);</span>
<a href="#l2.214"></a><span id="l2.214">   if (popup)</span>
<a href="#l2.215"></a><span id="l2.215" class="difflineminus">-    cardproperty.preferMailFormat = popup.value;</span>
<a href="#l2.216"></a><span id="l2.216" class="difflineplus">+    cardproperty.setProperty(&quot;PreferMailFormat&quot;, popup.value);</span>
<a href="#l2.217"></a><span id="l2.217">     </span>
<a href="#l2.218"></a><span id="l2.218">   var allowRemoteContentEl = document.getElementById(&quot;allowRemoteContent&quot;);</span>
<a href="#l2.219"></a><span id="l2.219">   if (allowRemoteContentEl)</span>
<a href="#l2.220"></a><span id="l2.220" class="difflineminus">-    cardproperty.allowRemoteContent = allowRemoteContentEl.checked;</span>
<a href="#l2.221"></a><span id="l2.221" class="difflineplus">+    cardproperty.setProperty(&quot;AllowRemoteContent&quot;, allowRemoteContentEl.checked);</span>
<a href="#l2.222"></a><span id="l2.222">     </span>
<a href="#l2.223"></a><span id="l2.223">   // set phonetic fields if exist</span>
<a href="#l2.224"></a><span id="l2.224">   try {</span>
<a href="#l2.225"></a><span id="l2.225" class="difflineminus">-    cardproperty.phoneticFirstName = doc.getElementById(&quot;PhoneticFirstName&quot;).value;</span>
<a href="#l2.226"></a><span id="l2.226" class="difflineminus">-    cardproperty.phoneticLastName = doc.getElementById(&quot;PhoneticLastName&quot;).value;</span>
<a href="#l2.227"></a><span id="l2.227" class="difflineplus">+    cardproperty.setProperty(&quot;PhoneticFirstName&quot;, doc.getElementById(&quot;PhoneticFirstName&quot;).value);</span>
<a href="#l2.228"></a><span id="l2.228" class="difflineplus">+    cardproperty.setProperty(&quot;PhoneticLastName&quot;, doc.getElementById(&quot;PhoneticLastName&quot;).value);</span>
<a href="#l2.229"></a><span id="l2.229">   }</span>
<a href="#l2.230"></a><span id="l2.230">   catch (ex) {}</span>
<a href="#l2.231"></a><span id="l2.231"> </span>
<a href="#l2.232"></a><span id="l2.232">   return true;</span>
<a href="#l2.233"></a><span id="l2.233"> }</span>
<a href="#l2.234"></a><span id="l2.234"> </span>
<a href="#l2.235"></a><span id="l2.235"> function CleanUpWebPage(webPage)</span>
<a href="#l2.236"></a><span id="l2.236"> {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/components/addrbook/content/abCardViewOverlay.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/components/addrbook/content/abCardViewOverlay.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -186,19 +186,30 @@ function GetAddressesFromURI(uri)</span>
<a href="#l3.4"></a><span id="l3.4">   return addresses;</span>
<a href="#l3.5"></a><span id="l3.5"> }</span>
<a href="#l3.6"></a><span id="l3.6"> </span>
<a href="#l3.7"></a><span id="l3.7"> function GoIM()</span>
<a href="#l3.8"></a><span id="l3.8"> {</span>
<a href="#l3.9"></a><span id="l3.9">   LaunchUrl(top.cvData.cvAimPresence.getAttribute(&quot;url&quot;));</span>
<a href="#l3.10"></a><span id="l3.10"> }</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-function DisplayCardViewPane(card)</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+function DisplayCardViewPane(realCard)</span>
<a href="#l3.14"></a><span id="l3.14"> {</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">-  var generatedName = card.generateName(gPrefs.getIntPref(&quot;mail.addr_book.lastnamefirst&quot;));</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+  var generatedName = realCard.generateName(gPrefs.getIntPref(&quot;mail.addr_book.lastnamefirst&quot;));</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+  // This will become neater when bug 312116 is fixed...</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+  // (card.property instead of card.getProperty(&quot;Property&quot;))</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+  var card = { getProperty : function (prop) {</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+                 return realCard.getProperty(prop, &quot;&quot;);</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+               },</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+               primaryEmail : realCard.primaryEmail,</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+               displayName : realCard.displayName,</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineplus">+               isMailList : realCard.isMailList,</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineplus">+               mailListURI : realCard.mailListURI</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+  };</span>
<a href="#l3.28"></a><span id="l3.28"> </span>
<a href="#l3.29"></a><span id="l3.29">   var data = top.cvData;</span>
<a href="#l3.30"></a><span id="l3.30">   var visible;</span>
<a href="#l3.31"></a><span id="l3.31"> </span>
<a href="#l3.32"></a><span id="l3.32">   var titleString;</span>
<a href="#l3.33"></a><span id="l3.33">   if (generatedName == &quot;&quot;)</span>
<a href="#l3.34"></a><span id="l3.34">     titleString = card.primaryEmail;  // if no generatedName, use email</span>
<a href="#l3.35"></a><span id="l3.35">   else</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineat">@@ -206,17 +217,17 @@ function DisplayCardViewPane(card)</span>
<a href="#l3.37"></a><span id="l3.37"> </span>
<a href="#l3.38"></a><span id="l3.38">   // set fields in card view pane</span>
<a href="#l3.39"></a><span id="l3.39">   if (card.isMailList)</span>
<a href="#l3.40"></a><span id="l3.40">     cvSetNode(data.CardTitle, gAddressBookBundle.getFormattedString(&quot;viewListTitle&quot;, [generatedName]));</span>
<a href="#l3.41"></a><span id="l3.41">   else</span>
<a href="#l3.42"></a><span id="l3.42">     cvSetNode(data.CardTitle, gAddressBookBundle.getFormattedString(&quot;viewCardTitle&quot;, [titleString]));</span>
<a href="#l3.43"></a><span id="l3.43"> </span>
<a href="#l3.44"></a><span id="l3.44">   // Contact section</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineminus">-  cvSetNodeWithLabel(data.cvNickname, zNickname, card.nickName);</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineplus">+  cvSetNodeWithLabel(data.cvNickname, zNickname, card.getProperty(&quot;NickName&quot;));</span>
<a href="#l3.47"></a><span id="l3.47"> </span>
<a href="#l3.48"></a><span id="l3.48">   if (card.isMailList) {</span>
<a href="#l3.49"></a><span id="l3.49">     // email1, display name and screenname always hidden when a mailing list.</span>
<a href="#l3.50"></a><span id="l3.50">     cvSetVisible(data.cvDisplayName, false);</span>
<a href="#l3.51"></a><span id="l3.51">     cvSetVisible(data.cvEmail1Box, false);</span>
<a href="#l3.52"></a><span id="l3.52">     cvSetVisible(data.cvScreennameBox, false);</span>
<a href="#l3.53"></a><span id="l3.53"> </span>
<a href="#l3.54"></a><span id="l3.54">     visible = HandleLink(data.cvListName, zListName, card.displayName, data.cvListNameBox, &quot;mailto:&quot; + encodeURIComponent(GenerateAddressFromCard(card))) || visible;</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineat">@@ -225,122 +236,163 @@ function DisplayCardViewPane(card)</span>
<a href="#l3.56"></a><span id="l3.56">     // listname always hidden if not a mailing list</span>
<a href="#l3.57"></a><span id="l3.57">     cvSetVisible(data.cvListNameBox, false);</span>
<a href="#l3.58"></a><span id="l3.58"> </span>
<a href="#l3.59"></a><span id="l3.59">     cvSetNodeWithLabel(data.cvDisplayName, zDisplayName, card.displayName);</span>
<a href="#l3.60"></a><span id="l3.60"> </span>
<a href="#l3.61"></a><span id="l3.61">     visible = HandleLink(data.cvEmail1, zPrimaryEmail, card.primaryEmail, data.cvEmail1Box, &quot;mailto:&quot; + card.primaryEmail) || visible;</span>
<a href="#l3.62"></a><span id="l3.62">   }</span>
<a href="#l3.63"></a><span id="l3.63"> </span>
<a href="#l3.64"></a><span id="l3.64" class="difflineminus">-  var goimURL = &quot;aim:goim?screenname=&quot; + card.aimScreenName;</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineminus">-  var hasScreenName = HandleLink(data.cvScreenname, zScreenName, card.aimScreenName, data.cvScreennameBox, goimURL);</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineplus">+  var goimURL = &quot;aim:goim?screenname=&quot; + card.getProperty(&quot;_AimScreenName&quot;);</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineplus">+  var hasScreenName = HandleLink(data.cvScreenname, zScreenName,</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineplus">+                                 card.getProperty(&quot;_AimScreenName&quot;),</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineplus">+                                 data.cvScreennameBox, goimURL);</span>
<a href="#l3.70"></a><span id="l3.70"> </span>
<a href="#l3.71"></a><span id="l3.71">   data.cvAimPresence.removeAttribute(&quot;src&quot;);</span>
<a href="#l3.72"></a><span id="l3.72">   data.cvAimPresence.removeAttribute(&quot;url&quot;);</span>
<a href="#l3.73"></a><span id="l3.73">   data.cvAimPresence.setAttribute(&quot;width&quot;,&quot;0&quot;);</span>
<a href="#l3.74"></a><span id="l3.74"> </span>
<a href="#l3.75"></a><span id="l3.75"> #if 0</span>
<a href="#l3.76"></a><span id="l3.76">     // for now, disable the presence check since we don't really support this anymore but we may again in the future.</span>
<a href="#l3.77"></a><span id="l3.77">     // I'm leaving the code here for historical reference. See Bug #295726.</span>
<a href="#l3.78"></a><span id="l3.78">     data.cvAimPresence.setAttribute(&quot;src&quot;,&quot;http://big.oscar.aol.com:80/&quot; + card.aimScreenName + &quot;?on_url=http://ncmail.netscape.com/include/nc/images/online.gif&amp;off_url=http://ncmail.netscape.com/include/nc/images/offline.gif&quot;);</span>
<a href="#l3.79"></a><span id="l3.79">     data.cvAimPresence.setAttribute(&quot;url&quot;, goimURL);</span>
<a href="#l3.80"></a><span id="l3.80">     data.cvAimPresence.setAttribute(&quot;width&quot;,&quot;16&quot;);</span>
<a href="#l3.81"></a><span id="l3.81"> #endif</span>
<a href="#l3.82"></a><span id="l3.82"> </span>
<a href="#l3.83"></a><span id="l3.83" class="difflineminus">-  visible = hasScreenName || visible;</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineminus">-  visible = HandleLink(data.cvEmail2, zSecondaryEmail, card.secondEmail, data.cvEmail2Box, &quot;mailto:&quot; + card.secondEmail) || visible;</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineplus">+   visible = hasScreenName || visible;</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineplus">+   visible = HandleLink(data.cvEmail2, zSecondaryEmail,</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineplus">+                        card.getProperty(&quot;SecondEmail&quot;), data.cvEmail2Box,</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineplus">+                        &quot;mailto:&quot; + card.getProperty(&quot;SecondEmail&quot;)) || visible;</span>
<a href="#l3.89"></a><span id="l3.89"> </span>
<a href="#l3.90"></a><span id="l3.90" class="difflineminus">-  // Home section</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineminus">-  visible = cvSetNode(data.cvHomeAddress, card.homeAddress);</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineminus">-  visible = cvSetNode(data.cvHomeAddress2, card.homeAddress2) || visible;</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineminus">-  visible = cvSetCityStateZip(data.cvHomeCityStZip, card.homeCity, card.homeState, card.homeZipCode) || visible;</span>
<a href="#l3.94"></a><span id="l3.94" class="difflineminus">-  visible = cvSetNode(data.cvHomeCountry, card.homeCountry) || visible;</span>
<a href="#l3.95"></a><span id="l3.95" class="difflineminus">-        if (visible) {</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineminus">-          var homeMapItUrl = CreateMapItURL(card.homeAddress, card.homeAddress2, card.homeCity, card.homeState, card.homeZipCode, card.homeCountry);</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineminus">-          if (homeMapItUrl) {</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineminus">-      cvSetVisible(data.cvbHomeMapItBox, true);</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineminus">-            data.cvHomeMapIt.setAttribute('url', homeMapItUrl);</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineminus">-          }</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineminus">-          else {</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineminus">-      cvSetVisible(data.cvbHomeMapItBox, false);</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineminus">-          }</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineminus">-        }</span>
<a href="#l3.105"></a><span id="l3.105" class="difflineminus">-        else {</span>
<a href="#l3.106"></a><span id="l3.106" class="difflineplus">+   // Home section</span>
<a href="#l3.107"></a><span id="l3.107" class="difflineplus">+   visible = cvSetNode(data.cvHomeAddress, card.getProperty(&quot;HomeAddress&quot;));</span>
<a href="#l3.108"></a><span id="l3.108" class="difflineplus">+   visible = cvSetNode(data.cvHomeAddress2, card.getProperty(&quot;HomeAddress2&quot;)) ||</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineplus">+             visible;</span>
<a href="#l3.110"></a><span id="l3.110" class="difflineplus">+   visible = cvSetCityStateZip(data.cvHomeCityStZip,</span>
<a href="#l3.111"></a><span id="l3.111" class="difflineplus">+                               card.getProperty(&quot;HomeCity&quot;),</span>
<a href="#l3.112"></a><span id="l3.112" class="difflineplus">+                               card.getProperty(&quot;HomeState&quot;),</span>
<a href="#l3.113"></a><span id="l3.113" class="difflineplus">+                               card.getProperty(&quot;HomeZipCode&quot;)) || visible;</span>
<a href="#l3.114"></a><span id="l3.114" class="difflineplus">+   visible = cvSetNode(data.cvHomeCountry, card.getProperty(&quot;HomeCountry&quot;)) ||</span>
<a href="#l3.115"></a><span id="l3.115" class="difflineplus">+             visible;</span>
<a href="#l3.116"></a><span id="l3.116" class="difflineplus">+   if (visible) {</span>
<a href="#l3.117"></a><span id="l3.117" class="difflineplus">+     var homeMapItUrl = CreateMapItURL(card.getProperty(&quot;HomeAddress&quot;),</span>
<a href="#l3.118"></a><span id="l3.118" class="difflineplus">+                                       card.getProperty(&quot;HomeAddress2&quot;),</span>
<a href="#l3.119"></a><span id="l3.119" class="difflineplus">+                                       card.getProperty(&quot;HomeCity&quot;),</span>
<a href="#l3.120"></a><span id="l3.120" class="difflineplus">+                                       card.getProperty(&quot;HomeState&quot;),</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineplus">+                                       card.getProperty(&quot;HomeZipCode&quot;),</span>
<a href="#l3.122"></a><span id="l3.122" class="difflineplus">+                                       card.getProperty(&quot;HomeCountry&quot;));</span>
<a href="#l3.123"></a><span id="l3.123" class="difflineplus">+    if (homeMapItUrl) {</span>
<a href="#l3.124"></a><span id="l3.124" class="difflineplus">+       cvSetVisible(data.cvbHomeMapItBox, true);</span>
<a href="#l3.125"></a><span id="l3.125" class="difflineplus">+       data.cvHomeMapIt.setAttribute('url', homeMapItUrl);</span>
<a href="#l3.126"></a><span id="l3.126" class="difflineplus">+    } else {</span>
<a href="#l3.127"></a><span id="l3.127" class="difflineplus">+       cvSetVisible(data.cvbHomeMapItBox, false);</span>
<a href="#l3.128"></a><span id="l3.128" class="difflineplus">+    }</span>
<a href="#l3.129"></a><span id="l3.129" class="difflineplus">+  } else {</span>
<a href="#l3.130"></a><span id="l3.130">     cvSetVisible(data.cvbHomeMapItBox, false);</span>
<a href="#l3.131"></a><span id="l3.131" class="difflineminus">-        }</span>
<a href="#l3.132"></a><span id="l3.132" class="difflineplus">+  }</span>
<a href="#l3.133"></a><span id="l3.133"> </span>
<a href="#l3.134"></a><span id="l3.134" class="difflineminus">-  visible = HandleLink(data.cvHomeWebPage, &quot;&quot;, card.webPage2, data.cvHomeWebPageBox, card.webPage2) || visible;</span>
<a href="#l3.135"></a><span id="l3.135" class="difflineplus">+  visible = HandleLink(data.cvHomeWebPage, &quot;&quot;, card.getProperty(&quot;WebPage2&quot;),</span>
<a href="#l3.136"></a><span id="l3.136" class="difflineplus">+                       data.cvHomeWebPageBox, card.getProperty(&quot;WebPage2&quot;)) ||</span>
<a href="#l3.137"></a><span id="l3.137" class="difflineplus">+            visible;</span>
<a href="#l3.138"></a><span id="l3.138"> </span>
<a href="#l3.139"></a><span id="l3.139">   cvSetVisible(data.cvhHome, visible);</span>
<a href="#l3.140"></a><span id="l3.140">   cvSetVisible(data.cvbHome, visible);</span>
<a href="#l3.141"></a><span id="l3.141">   if (card.isMailList) {</span>
<a href="#l3.142"></a><span id="l3.142">     // Description section</span>
<a href="#l3.143"></a><span id="l3.143" class="difflineminus">-    visible = cvSetNode(data.cvDescription, card.notes)</span>
<a href="#l3.144"></a><span id="l3.144" class="difflineplus">+    visible = cvSetNode(data.cvDescription, card.getProperty(&quot;Notes&quot;))</span>
<a href="#l3.145"></a><span id="l3.145">     cvSetVisible(data.cvbDescription, visible);</span>
<a href="#l3.146"></a><span id="l3.146"> </span>
<a href="#l3.147"></a><span id="l3.147">     // Addresses section</span>
<a href="#l3.148"></a><span id="l3.148">     visible = cvAddAddressNodes(data.cvAddresses, card.mailListURI);</span>
<a href="#l3.149"></a><span id="l3.149">     cvSetVisible(data.cvbAddresses, visible);</span>
<a href="#l3.150"></a><span id="l3.150"> </span>
<a href="#l3.151"></a><span id="l3.151">     // Other section, not shown for mailing lists.</span>
<a href="#l3.152"></a><span id="l3.152">     cvSetVisible(data.cvbOther, false);</span>
<a href="#l3.153"></a><span id="l3.153">   }</span>
<a href="#l3.154"></a><span id="l3.154">   else {</span>
<a href="#l3.155"></a><span id="l3.155">     // Other section</span>
<a href="#l3.156"></a><span id="l3.156" class="difflineminus">-    visible = cvSetNodeWithLabel(data.cvCustom1, zCustom1, card.custom1);</span>
<a href="#l3.157"></a><span id="l3.157" class="difflineminus">-    visible = cvSetNodeWithLabel(data.cvCustom2, zCustom2, card.custom2) || visible;</span>
<a href="#l3.158"></a><span id="l3.158" class="difflineminus">-    visible = cvSetNodeWithLabel(data.cvCustom3, zCustom3, card.custom3) || visible;</span>
<a href="#l3.159"></a><span id="l3.159" class="difflineminus">-    visible = cvSetNodeWithLabel(data.cvCustom4, zCustom4, card.custom4) || visible;</span>
<a href="#l3.160"></a><span id="l3.160" class="difflineminus">-    visible = cvSetNode(data.cvNotes, card.notes) || visible;</span>
<a href="#l3.161"></a><span id="l3.161" class="difflineplus">+    visible = cvSetNodeWithLabel(data.cvCustom1, zCustom1,</span>
<a href="#l3.162"></a><span id="l3.162" class="difflineplus">+                                 card.getProperty(&quot;Custom1&quot;));</span>
<a href="#l3.163"></a><span id="l3.163" class="difflineplus">+    visible = cvSetNodeWithLabel(data.cvCustom2, zCustom2,</span>
<a href="#l3.164"></a><span id="l3.164" class="difflineplus">+                                 card.getProperty(&quot;Custom2&quot;)) || visible;</span>
<a href="#l3.165"></a><span id="l3.165" class="difflineplus">+    visible = cvSetNodeWithLabel(data.cvCustom3, zCustom3,</span>
<a href="#l3.166"></a><span id="l3.166" class="difflineplus">+                                 card.getProperty(&quot;Custom3&quot;)) || visible;</span>
<a href="#l3.167"></a><span id="l3.167" class="difflineplus">+    visible = cvSetNodeWithLabel(data.cvCustom4, zCustom4,</span>
<a href="#l3.168"></a><span id="l3.168" class="difflineplus">+                                 card.getProperty(&quot;Custom4&quot;)) || visible;</span>
<a href="#l3.169"></a><span id="l3.169" class="difflineplus">+    visible = cvSetNode(data.cvNotes, card.getProperty(&quot;Notes&quot;)) || visible;</span>
<a href="#l3.170"></a><span id="l3.170">     visible = setBuddyIcon(card, data.cvBuddyIcon) || visible;</span>
<a href="#l3.171"></a><span id="l3.171"> </span>
<a href="#l3.172"></a><span id="l3.172">     cvSetVisible(data.cvhOther, visible);</span>
<a href="#l3.173"></a><span id="l3.173">     cvSetVisible(data.cvbOther, visible);</span>
<a href="#l3.174"></a><span id="l3.174"> </span>
<a href="#l3.175"></a><span id="l3.175">     // hide description section, not show for non-mailing lists</span>
<a href="#l3.176"></a><span id="l3.176">     cvSetVisible(data.cvbDescription, false);</span>
<a href="#l3.177"></a><span id="l3.177"> </span>
<a href="#l3.178"></a><span id="l3.178">     // hide addresses section, not show for non-mailing lists</span>
<a href="#l3.179"></a><span id="l3.179">     cvSetVisible(data.cvbAddresses, false);</span>
<a href="#l3.180"></a><span id="l3.180">   }</span>
<a href="#l3.181"></a><span id="l3.181"> </span>
<a href="#l3.182"></a><span id="l3.182">   // Phone section</span>
<a href="#l3.183"></a><span id="l3.183" class="difflineminus">-  visible = cvSetNodeWithLabel(data.cvPhWork, zWork, card.workPhone);</span>
<a href="#l3.184"></a><span id="l3.184" class="difflineminus">-  visible = cvSetNodeWithLabel(data.cvPhHome, zHome, card.homePhone) || visible;</span>
<a href="#l3.185"></a><span id="l3.185" class="difflineminus">-  visible = cvSetNodeWithLabel(data.cvPhFax, zFax, card.faxNumber) || visible;</span>
<a href="#l3.186"></a><span id="l3.186" class="difflineminus">-  visible = cvSetNodeWithLabel(data.cvPhCellular, zCellular, card.cellularNumber) || visible;</span>
<a href="#l3.187"></a><span id="l3.187" class="difflineminus">-  visible = cvSetNodeWithLabel(data.cvPhPager, zPager, card.pagerNumber) || visible;</span>
<a href="#l3.188"></a><span id="l3.188" class="difflineplus">+  visible = cvSetNodeWithLabel(data.cvPhWork, zWork,</span>
<a href="#l3.189"></a><span id="l3.189" class="difflineplus">+                               card.getProperty(&quot;WorkPhone&quot;));</span>
<a href="#l3.190"></a><span id="l3.190" class="difflineplus">+  visible = cvSetNodeWithLabel(data.cvPhHome, zHome,</span>
<a href="#l3.191"></a><span id="l3.191" class="difflineplus">+                               card.getProperty(&quot;HomePhone&quot;)) || visible;</span>
<a href="#l3.192"></a><span id="l3.192" class="difflineplus">+  visible = cvSetNodeWithLabel(data.cvPhFax, zFax,</span>
<a href="#l3.193"></a><span id="l3.193" class="difflineplus">+                               card.getProperty(&quot;FaxNumber&quot;)) || visible;</span>
<a href="#l3.194"></a><span id="l3.194" class="difflineplus">+  visible = cvSetNodeWithLabel(data.cvPhCellular, zCellular,</span>
<a href="#l3.195"></a><span id="l3.195" class="difflineplus">+                               card.getProperty(&quot;CellularNumber&quot;)) || visible;</span>
<a href="#l3.196"></a><span id="l3.196" class="difflineplus">+  visible = cvSetNodeWithLabel(data.cvPhPager, zPager,</span>
<a href="#l3.197"></a><span id="l3.197" class="difflineplus">+                               card.getProperty(&quot;PagerNumber&quot;)) || visible;</span>
<a href="#l3.198"></a><span id="l3.198">   cvSetVisible(data.cvhPhone, visible);</span>
<a href="#l3.199"></a><span id="l3.199">   cvSetVisible(data.cvbPhone, visible);</span>
<a href="#l3.200"></a><span id="l3.200">   // Work section</span>
<a href="#l3.201"></a><span id="l3.201" class="difflineminus">-  visible = cvSetNode(data.cvJobTitle, card.jobTitle);</span>
<a href="#l3.202"></a><span id="l3.202" class="difflineminus">-  visible = cvSetNode(data.cvDepartment, card.department) || visible;</span>
<a href="#l3.203"></a><span id="l3.203" class="difflineminus">-  visible = cvSetNode(data.cvCompany, card.company) || visible;</span>
<a href="#l3.204"></a><span id="l3.204" class="difflineplus">+  visible = cvSetNode(data.cvJobTitle, card.getProperty(&quot;JobTitle&quot;));</span>
<a href="#l3.205"></a><span id="l3.205" class="difflineplus">+  visible = cvSetNode(data.cvDepartment, card.getProperty(&quot;Department&quot;)) ||</span>
<a href="#l3.206"></a><span id="l3.206" class="difflineplus">+            visible;</span>
<a href="#l3.207"></a><span id="l3.207" class="difflineplus">+  visible = cvSetNode(data.cvCompany, card.getProperty(&quot;Company&quot;)) || visible;</span>
<a href="#l3.208"></a><span id="l3.208"> </span>
<a href="#l3.209"></a><span id="l3.209" class="difflineminus">-        var addressVisible = cvSetNode(data.cvWorkAddress, card.workAddress);</span>
<a href="#l3.210"></a><span id="l3.210" class="difflineminus">-  addressVisible = cvSetNode(data.cvWorkAddress2, card.workAddress2) || addressVisible;</span>
<a href="#l3.211"></a><span id="l3.211" class="difflineminus">-  addressVisible = cvSetCityStateZip(data.cvWorkCityStZip, card.workCity, card.workState, card.workZipCode) || addressVisible;</span>
<a href="#l3.212"></a><span id="l3.212" class="difflineminus">-  addressVisible = cvSetNode(data.cvWorkCountry, card.workCountry) || addressVisible;</span>
<a href="#l3.213"></a><span id="l3.213" class="difflineplus">+  var addressVisible = cvSetNode(data.cvWorkAddress,</span>
<a href="#l3.214"></a><span id="l3.214" class="difflineplus">+                                 card.getProperty(&quot;WorkAddress&quot;));</span>
<a href="#l3.215"></a><span id="l3.215" class="difflineplus">+  addressVisible = cvSetNode(data.cvWorkAddress2,</span>
<a href="#l3.216"></a><span id="l3.216" class="difflineplus">+                             card.getProperty(&quot;WorkAddress2&quot;)) ||</span>
<a href="#l3.217"></a><span id="l3.217" class="difflineplus">+                   addressVisible;</span>
<a href="#l3.218"></a><span id="l3.218" class="difflineplus">+  addressVisible = cvSetCityStateZip(data.cvWorkCityStZip,</span>
<a href="#l3.219"></a><span id="l3.219" class="difflineplus">+                                     card.getProperty(&quot;WorkCity&quot;),</span>
<a href="#l3.220"></a><span id="l3.220" class="difflineplus">+                                     card.getProperty(&quot;WorkState&quot;),</span>
<a href="#l3.221"></a><span id="l3.221" class="difflineplus">+                                     card.getProperty(&quot;WorkZipCode&quot;)) ||</span>
<a href="#l3.222"></a><span id="l3.222" class="difflineplus">+                   addressVisible;</span>
<a href="#l3.223"></a><span id="l3.223" class="difflineplus">+  addressVisible = cvSetNode(data.cvWorkCountry,</span>
<a href="#l3.224"></a><span id="l3.224" class="difflineplus">+                             card.getProperty(&quot;WorkCountry&quot;)) || addressVisible;</span>
<a href="#l3.225"></a><span id="l3.225"> </span>
<a href="#l3.226"></a><span id="l3.226">         if (addressVisible) {</span>
<a href="#l3.227"></a><span id="l3.227" class="difflineminus">-          var workMapItUrl = CreateMapItURL(card.workAddress, card.workAddress2, card.workCity, card.workState, card.workZipCode, card.workCountry);</span>
<a href="#l3.228"></a><span id="l3.228" class="difflineplus">+          var workMapItUrl = CreateMapItURL(card.getProperty(&quot;WorkAddress&quot;),</span>
<a href="#l3.229"></a><span id="l3.229" class="difflineplus">+                                            card.getProperty(&quot;WorkAddress2&quot;),</span>
<a href="#l3.230"></a><span id="l3.230" class="difflineplus">+                                            card.getProperty(&quot;WorkCity&quot;),</span>
<a href="#l3.231"></a><span id="l3.231" class="difflineplus">+                                            card.getProperty(&quot;WorkState&quot;),</span>
<a href="#l3.232"></a><span id="l3.232" class="difflineplus">+                                            card.getProperty(&quot;WorkZipCode&quot;),</span>
<a href="#l3.233"></a><span id="l3.233" class="difflineplus">+                                            card.getProperty(&quot;WorkCountry&quot;));</span>
<a href="#l3.234"></a><span id="l3.234">           data.cvWorkMapIt.setAttribute('url', workMapItUrl);</span>
<a href="#l3.235"></a><span id="l3.235">           if (workMapItUrl) {</span>
<a href="#l3.236"></a><span id="l3.236">       cvSetVisible(data.cvbWorkMapItBox, true);</span>
<a href="#l3.237"></a><span id="l3.237">             data.cvWorkMapIt.setAttribute('url', workMapItUrl);</span>
<a href="#l3.238"></a><span id="l3.238">           }</span>
<a href="#l3.239"></a><span id="l3.239">           else {</span>
<a href="#l3.240"></a><span id="l3.240">       cvSetVisible(data.cvbWorkMapItBox, false);</span>
<a href="#l3.241"></a><span id="l3.241">           }</span>
<a href="#l3.242"></a><span id="l3.242">         }</span>
<a href="#l3.243"></a><span id="l3.243">         else {</span>
<a href="#l3.244"></a><span id="l3.244">     cvSetVisible(data.cvbWorkMapItBox, false);</span>
<a href="#l3.245"></a><span id="l3.245">         }</span>
<a href="#l3.246"></a><span id="l3.246"> </span>
<a href="#l3.247"></a><span id="l3.247" class="difflineminus">-        visible = HandleLink(data.cvWorkWebPage, &quot;&quot;, card.webPage1, data.cvWorkWebPageBox, card.webPage1) || addressVisible || visible;</span>
<a href="#l3.248"></a><span id="l3.248" class="difflineplus">+        visible = HandleLink(data.cvWorkWebPage, &quot;&quot;,</span>
<a href="#l3.249"></a><span id="l3.249" class="difflineplus">+                             card.getProperty(&quot;WebPage1&quot;),</span>
<a href="#l3.250"></a><span id="l3.250" class="difflineplus">+                             data.cvWorkWebPageBox,</span>
<a href="#l3.251"></a><span id="l3.251" class="difflineplus">+                             card.getProperty(&quot;WebPage1&quot;)) || addressVisible ||</span>
<a href="#l3.252"></a><span id="l3.252" class="difflineplus">+                             visible;</span>
<a href="#l3.253"></a><span id="l3.253"> </span>
<a href="#l3.254"></a><span id="l3.254">   cvSetVisible(data.cvhWork, visible);</span>
<a href="#l3.255"></a><span id="l3.255">   cvSetVisible(data.cvbWork, visible);</span>
<a href="#l3.256"></a><span id="l3.256"> </span>
<a href="#l3.257"></a><span id="l3.257">   // make the card view box visible</span>
<a href="#l3.258"></a><span id="l3.258">   cvSetVisible(top.cvData.CardViewBox, true);</span>
<a href="#l3.259"></a><span id="l3.259"> }</span>
<a href="#l3.260"></a><span id="l3.260"> </span>
<a href="#l3.261"></a><span id="l3.261" class="difflineat">@@ -353,17 +405,17 @@ function setBuddyIcon(card, buddyIcon)</span>
<a href="#l3.262"></a><span id="l3.262">         // lazily create these file urls, and keep them around</span>
<a href="#l3.263"></a><span id="l3.263">         var dirService = Components.classes[&quot;@mozilla.org/file/directory_service;1&quot;]</span>
<a href="#l3.264"></a><span id="l3.264">             .getService(Components.interfaces.nsIProperties);</span>
<a href="#l3.265"></a><span id="l3.265">         var profileDir = dirService.get(&quot;ProfD&quot;, Components.interfaces.nsIFile);</span>
<a href="#l3.266"></a><span id="l3.266">         gProfileDirURL = gIOService.newFileURI(profileDir);</span>
<a href="#l3.267"></a><span id="l3.267">       }</span>
<a href="#l3.268"></a><span id="l3.268"> </span>
<a href="#l3.269"></a><span id="l3.269">       // if we did have a buddy icon on disk for this screenname, this would be the file url spec for it</span>
<a href="#l3.270"></a><span id="l3.270" class="difflineminus">-      var iconURLStr = gProfileDirURL.spec + &quot;/NIM/&quot; + myScreenName + &quot;/picture/&quot; + card.aimScreenName + &quot;.gif&quot;;</span>
<a href="#l3.271"></a><span id="l3.271" class="difflineplus">+      var iconURLStr = gProfileDirURL.spec + &quot;/NIM/&quot; + myScreenName + &quot;/picture/&quot; + card.getProperty(&quot;_AimScreenName&quot;) + &quot;.gif&quot;;</span>
<a href="#l3.272"></a><span id="l3.272"> </span>
<a href="#l3.273"></a><span id="l3.273">       // check if the file exists</span>
<a href="#l3.274"></a><span id="l3.274">       var file = gFileHandler.getFileFromURLSpec(iconURLStr);</span>
<a href="#l3.275"></a><span id="l3.275"> </span>
<a href="#l3.276"></a><span id="l3.276">       // check if the file exists</span>
<a href="#l3.277"></a><span id="l3.277">       // is this a perf hit?  (how expensive is stat()?)</span>
<a href="#l3.278"></a><span id="l3.278">       if (file.exists()) {</span>
<a href="#l3.279"></a><span id="l3.279">         buddyIcon.setAttribute(&quot;src&quot;, iconURLStr);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/components/addrbook/content/addressbook.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/components/addrbook/content/addressbook.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -352,18 +352,17 @@ function AbPrintCard()</span>
<a href="#l4.4"></a><span id="l4.4"> </span>
<a href="#l4.5"></a><span id="l4.5"> function AbPrintPreviewCard()</span>
<a href="#l4.6"></a><span id="l4.6"> {</span>
<a href="#l4.7"></a><span id="l4.7">   AbPrintCardInternal(true, Components.interfaces.nsIMsgPrintEngine.MNAB_PRINTPREVIEW_AB_CARD);</span>
<a href="#l4.8"></a><span id="l4.8"> }</span>
<a href="#l4.9"></a><span id="l4.9"> </span>
<a href="#l4.10"></a><span id="l4.10"> function CreatePrintCardUrl(card)</span>
<a href="#l4.11"></a><span id="l4.11"> {</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-  var url = &quot;data:application/xml;base64,&quot; + card.convertToBase64EncodedXML();</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-  return url;</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+  return &quot;data:application/xml;base64,&quot; + card.translateTo(&quot;base64xml&quot;);</span>
<a href="#l4.15"></a><span id="l4.15"> }</span>
<a href="#l4.16"></a><span id="l4.16"> </span>
<a href="#l4.17"></a><span id="l4.17"> function AbPrintAddressBookInternal(doPrintPreview, msgType)</span>
<a href="#l4.18"></a><span id="l4.18"> {</span>
<a href="#l4.19"></a><span id="l4.19">   var uri = GetSelectedDirectory();</span>
<a href="#l4.20"></a><span id="l4.20">   if (!uri)</span>
<a href="#l4.21"></a><span id="l4.21">     return;</span>
<a href="#l4.22"></a><span id="l4.22"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/addrbook/public/Makefile.in</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/addrbook/public/Makefile.in</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -43,19 +43,19 @@ VPATH		= @srcdir@</span>
<a href="#l5.4"></a><span id="l5.4"> </span>
<a href="#l5.5"></a><span id="l5.5"> include $(DEPTH)/config/autoconf.mk</span>
<a href="#l5.6"></a><span id="l5.6"> </span>
<a href="#l5.7"></a><span id="l5.7"> MODULE		= addrbook</span>
<a href="#l5.8"></a><span id="l5.8"> </span>
<a href="#l5.9"></a><span id="l5.9"> XPIDLSRCS	= \</span>
<a href="#l5.10"></a><span id="l5.10"> 		nsIAbListener.idl \</span>
<a href="#l5.11"></a><span id="l5.11"> 		nsIAbDirectory.idl \</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+		nsIAbItem.idl \</span>
<a href="#l5.13"></a><span id="l5.13"> 		nsIAbCard.idl \</span>
<a href="#l5.14"></a><span id="l5.14"> 		nsIAbMDBDirectory.idl \</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineminus">-		nsIAbMDBCard.idl \</span>
<a href="#l5.16"></a><span id="l5.16"> 		nsIAddrDBAnnouncer.idl \</span>
<a href="#l5.17"></a><span id="l5.17"> 		nsIAddrDBListener.idl \</span>
<a href="#l5.18"></a><span id="l5.18"> 		nsIAddrDatabase.idl \</span>
<a href="#l5.19"></a><span id="l5.19"> 		nsIAbManager.idl \</span>
<a href="#l5.20"></a><span id="l5.20"> 		nsIAbAddressCollecter.idl \</span>
<a href="#l5.21"></a><span id="l5.21"> 		nsIAddbookUrl.idl \</span>
<a href="#l5.22"></a><span id="l5.22"> 		nsIAbDirFactory.idl	\</span>
<a href="#l5.23"></a><span id="l5.23"> 		nsIAbDirFactoryService.idl	\</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/addrbook/public/nsIAbCard.idl</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/addrbook/public/nsIAbCard.idl</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -15,164 +15,293 @@</span>
<a href="#l6.4"></a><span id="l6.4">  * The Original Code is mozilla.org code.</span>
<a href="#l6.5"></a><span id="l6.5">  *</span>
<a href="#l6.6"></a><span id="l6.6">  * The Initial Developer of the Original Code is</span>
<a href="#l6.7"></a><span id="l6.7">  * Netscape Communications Corporation.</span>
<a href="#l6.8"></a><span id="l6.8">  * Portions created by the Initial Developer are Copyright (C) 1998</span>
<a href="#l6.9"></a><span id="l6.9">  * the Initial Developer. All Rights Reserved.</span>
<a href="#l6.10"></a><span id="l6.10">  *</span>
<a href="#l6.11"></a><span id="l6.11">  * Contributor(s):</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+ *  Mark Banner &lt;bugzilla@standard8.plus.com&gt;</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+ *  Joshua Cranmer &lt;Pidgeot18@gmail.com&gt;</span>
<a href="#l6.14"></a><span id="l6.14">  *</span>
<a href="#l6.15"></a><span id="l6.15">  * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l6.16"></a><span id="l6.16">  * either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l6.17"></a><span id="l6.17">  * or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l6.18"></a><span id="l6.18">  * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l6.19"></a><span id="l6.19">  * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l6.20"></a><span id="l6.20">  * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l6.21"></a><span id="l6.21">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l6.22"></a><span id="l6.22">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l6.23"></a><span id="l6.23">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l6.24"></a><span id="l6.24">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l6.25"></a><span id="l6.25">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l6.26"></a><span id="l6.26">  *</span>
<a href="#l6.27"></a><span id="l6.27">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l6.28"></a><span id="l6.28">  </span>
<a href="#l6.29"></a><span id="l6.29"> #include &quot;nsISupports.idl&quot;</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineplus">+#include &quot;nsIAbItem.idl&quot;</span>
<a href="#l6.31"></a><span id="l6.31"> </span>
<a href="#l6.32"></a><span id="l6.32" class="difflineminus">-interface nsIStringBundle;</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+interface nsISimpleEnumerator;</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+interface nsIVariant;</span>
<a href="#l6.35"></a><span id="l6.35"> </span>
<a href="#l6.36"></a><span id="l6.36"> [scriptable, uuid(97448252-F189-11d4-A422-001083003D0C)]</span>
<a href="#l6.37"></a><span id="l6.37"> interface nsIAbPreferMailFormat {</span>
<a href="#l6.38"></a><span id="l6.38">     const unsigned long unknown   = 0;</span>
<a href="#l6.39"></a><span id="l6.39">     const unsigned long plaintext = 1;</span>
<a href="#l6.40"></a><span id="l6.40">     const unsigned long html      = 2;</span>
<a href="#l6.41"></a><span id="l6.41"> };</span>
<a href="#l6.42"></a><span id="l6.42"> </span>
<a href="#l6.43"></a><span id="l6.43" class="difflineminus">-[scriptable, uuid(193d5026-7d1e-41b4-9fc3-c57d4a4937f3)]</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineminus">-interface nsIAbCard : nsISupports {</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineminus">-  // Card properties</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineplus">+/**</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineplus">+ * An interface representing an address book card.</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineplus">+ *</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineplus">+ * Fundamentally, it is a collection of properties. Modifying a property in</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineplus">+ * some way on a card does not change the backend used to store the card; the</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineplus">+ * directory is required to do make the changes here.</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineplus">+ *</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineplus">+ * The following are the core properties that are used:</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineplus">+ * - Names:</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineplus">+ *   - FirstName, LastName</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineplus">+ *   - PhoneticFirstName, PhoneticLastName</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineplus">+ *   - DisplayName, NickName</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineplus">+ *   - SpouseName, FamilyName</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineplus">+ * - PrimaryEmail, SecondEmail</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineplus">+ * - Home Contact:</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineplus">+ *   - HomeAddress, HomeAddress2, HomeCity, HomeState, HomeZipCode, HomeCountry</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineplus">+ *   - HomePhone, HomePhoneType</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineplus">+ * - Work contact. Same as home, but with `Work' instead of `Home'</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineplus">+ * - Other Contact:</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineplus">+ *   - FaxNumber, FaxNumberType</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineplus">+ *   - PagerNumber, PagerNumberType</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineplus">+ *   - CellularNumber, CellularNumberType</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineplus">+ * - JobTitle, Department, Company</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineplus">+ * - _AimScreenName</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineplus">+ * - Dates:</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineplus">+ *   - AnniversaryYear, AnniversaryMonth, AnniversaryDay</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineplus">+ *   - BirthYear, BirthMonth, BirthDay</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineplus">+ * - WebPage1 (work), WebPage2 (home)</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineplus">+ * - Custom1, Custom2, Custom3, Custom4</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineplus">+ * - Notes</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineplus">+ * - Integral properties:</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineplus">+ *   - LastModifiedDate</span>
<a href="#l6.78"></a><span id="l6.78" class="difflineplus">+ *   - PopularityIndex</span>
<a href="#l6.79"></a><span id="l6.79" class="difflineplus">+ *   - PreferMailFormat (see nsIAbPreferMailFormat)</span>
<a href="#l6.80"></a><span id="l6.80" class="difflineplus">+ * - Boolean properties:</span>
<a href="#l6.81"></a><span id="l6.81" class="difflineplus">+ *   - AllowRemoteContent</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineplus">+ */</span>
<a href="#l6.83"></a><span id="l6.83" class="difflineplus">+[scriptable, uuid(f5646fba-3d20-4fdf-90fb-9f2ee9899dbb)]</span>
<a href="#l6.84"></a><span id="l6.84" class="difflineplus">+interface nsIAbCard : nsIAbItem {</span>
<a href="#l6.85"></a><span id="l6.85" class="difflineplus">+  /**</span>
<a href="#l6.86"></a><span id="l6.86" class="difflineplus">+   * A list of all the properties that this card has as an enumerator, whose</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineplus">+   * members are all nsIProperty objects.</span>
<a href="#l6.88"></a><span id="l6.88" class="difflineplus">+   */</span>
<a href="#l6.89"></a><span id="l6.89" class="difflineplus">+  readonly attribute nsISimpleEnumerator properties;</span>
<a href="#l6.90"></a><span id="l6.90" class="difflineplus">+</span>
<a href="#l6.91"></a><span id="l6.91" class="difflineplus">+  /**</span>
<a href="#l6.92"></a><span id="l6.92" class="difflineplus">+   * Returns a property for the given name.</span>
<a href="#l6.93"></a><span id="l6.93" class="difflineplus">+   *</span>
<a href="#l6.94"></a><span id="l6.94" class="difflineplus">+   * @param name             The case-sensitive name of the property to get.</span>
<a href="#l6.95"></a><span id="l6.95" class="difflineplus">+   * @param defaultValue     The value to return if the property does not exist.</span>
<a href="#l6.96"></a><span id="l6.96" class="difflineplus">+   * @exception NS_ERROR_NOT_AVAILABLE if the named property does not exist.</span>
<a href="#l6.97"></a><span id="l6.97" class="difflineplus">+   * @exception NS_ERROR_CANNOT_CONVERT_DATA if the property cannot be converted</span>
<a href="#l6.98"></a><span id="l6.98" class="difflineplus">+   *                                         to the desired type.</span>
<a href="#l6.99"></a><span id="l6.99" class="difflineplus">+   */</span>
<a href="#l6.100"></a><span id="l6.100" class="difflineplus">+  nsIVariant getProperty(in AUTF8String name, in nsIVariant defaultValue);</span>
<a href="#l6.101"></a><span id="l6.101" class="difflineplus">+  /**</span>
<a href="#l6.102"></a><span id="l6.102" class="difflineplus">+   * @{</span>
<a href="#l6.103"></a><span id="l6.103" class="difflineplus">+   * Returns a property for the given name.</span>
<a href="#l6.104"></a><span id="l6.104" class="difflineplus">+   *</span>
<a href="#l6.105"></a><span id="l6.105" class="difflineplus">+   * These functions convert values in the same manner as the default</span>
<a href="#l6.106"></a><span id="l6.106" class="difflineplus">+   * implementation of nsIVariant. Of particular note is that boolean variables</span>
<a href="#l6.107"></a><span id="l6.107" class="difflineplus">+   * are converted to integers as in C/C++ (true is a non-zero value), so that</span>
<a href="#l6.108"></a><span id="l6.108" class="difflineplus">+   * false will be converted to a string of &quot;0&quot; and not &quot;false.&quot;</span>
<a href="#l6.109"></a><span id="l6.109" class="difflineplus">+   *</span>
<a href="#l6.110"></a><span id="l6.110" class="difflineplus">+   * These functions are marked [noscript] since xpconnect performs automatic</span>
<a href="#l6.111"></a><span id="l6.111" class="difflineplus">+   * type conversion on nsIVariants such that they are not needed for scripts,</span>
<a href="#l6.112"></a><span id="l6.112" class="difflineplus">+   * only for C++ callers.</span>
<a href="#l6.113"></a><span id="l6.113" class="difflineplus">+   *</span>
<a href="#l6.114"></a><span id="l6.114" class="difflineplus">+   * @param name             The case-sensitive name of the property to get.</span>
<a href="#l6.115"></a><span id="l6.115" class="difflineplus">+   * @exception NS_ERROR_NOT_AVAILABLE if the named property does not exist.</span>
<a href="#l6.116"></a><span id="l6.116" class="difflineplus">+   * @exception NS_ERROR_CANNOT_CONVERT_DATA if the property cannot be converted</span>
<a href="#l6.117"></a><span id="l6.117" class="difflineplus">+   *                                         to the desired type.</span>
<a href="#l6.118"></a><span id="l6.118" class="difflineplus">+   */</span>
<a href="#l6.119"></a><span id="l6.119" class="difflineplus">+  [noscript] AString getPropertyAsAString(in string name);</span>
<a href="#l6.120"></a><span id="l6.120" class="difflineplus">+  [noscript] AUTF8String getPropertyAsAUTF8String(in string name);</span>
<a href="#l6.121"></a><span id="l6.121" class="difflineplus">+  [noscript] PRUint32 getPropertyAsUint32(in string name);</span>
<a href="#l6.122"></a><span id="l6.122" class="difflineplus">+  [noscript] boolean getPropertyAsBool(in string name);</span>
<a href="#l6.123"></a><span id="l6.123" class="difflineplus">+  /** @} */</span>
<a href="#l6.124"></a><span id="l6.124" class="difflineplus">+</span>
<a href="#l6.125"></a><span id="l6.125" class="difflineplus">+  /**</span>
<a href="#l6.126"></a><span id="l6.126" class="difflineplus">+   * @{</span>
<a href="#l6.127"></a><span id="l6.127" class="difflineplus">+   * Assigns the given to value to the property of the given name.</span>
<a href="#l6.128"></a><span id="l6.128" class="difflineplus">+   *</span>
<a href="#l6.129"></a><span id="l6.129" class="difflineplus">+   * Should the property exist, its value will be overwritten. An</span>
<a href="#l6.130"></a><span id="l6.130" class="difflineplus">+   * implementation may impose additional semantic constraints for certain</span>
<a href="#l6.131"></a><span id="l6.131" class="difflineplus">+   * properties. However, such constraints might not be checked by this method.</span>
<a href="#l6.132"></a><span id="l6.132" class="difflineplus">+   *</span>
<a href="#l6.133"></a><span id="l6.133" class="difflineplus">+   * These functions convert values in the same manner as the default</span>
<a href="#l6.134"></a><span id="l6.134" class="difflineplus">+   * implementation of nsIVariant.</span>
<a href="#l6.135"></a><span id="l6.135" class="difflineplus">+   * </span>
<a href="#l6.136"></a><span id="l6.136" class="difflineplus">+   * @warning A value MUST be convertible to a string; if this convention is not</span>
<a href="#l6.137"></a><span id="l6.137" class="difflineplus">+   * followed, consumers of cards may fail unpredictably or return incorrect</span>
<a href="#l6.138"></a><span id="l6.138" class="difflineplus">+   * results.</span>
<a href="#l6.139"></a><span id="l6.139" class="difflineplus">+   *</span>
<a href="#l6.140"></a><span id="l6.140" class="difflineplus">+   * The non-variant functions are marked [noscript] since xpconnect uses</span>
<a href="#l6.141"></a><span id="l6.141" class="difflineplus">+   * magic with nsIVariant such that the other functions are not needed,</span>
<a href="#l6.142"></a><span id="l6.142" class="difflineplus">+   * although C++ does need them.</span>
<a href="#l6.143"></a><span id="l6.143" class="difflineplus">+   *</span>
<a href="#l6.144"></a><span id="l6.144" class="difflineplus">+   * @param name             The case-sensitive name of the property to set.</span>
<a href="#l6.145"></a><span id="l6.145" class="difflineplus">+   * @param value            The new value of the property.</span>
<a href="#l6.146"></a><span id="l6.146" class="difflineplus">+   */</span>
<a href="#l6.147"></a><span id="l6.147" class="difflineplus">+  void setProperty(in AUTF8String name, in nsIVariant value);</span>
<a href="#l6.148"></a><span id="l6.148" class="difflineplus">+  [noscript] void setPropertyAsAString(in string name, in AString value);</span>
<a href="#l6.149"></a><span id="l6.149" class="difflineplus">+  [noscript] void setPropertyAsAUTF8String(in string name, in AUTF8String value);</span>
<a href="#l6.150"></a><span id="l6.150" class="difflineplus">+  [noscript] void setPropertyAsUint32(in string name, in PRUint32 value);</span>
<a href="#l6.151"></a><span id="l6.151" class="difflineplus">+  [noscript] void setPropertyAsBool(in string name, in boolean value);</span>
<a href="#l6.152"></a><span id="l6.152" class="difflineplus">+  /** @} */</span>
<a href="#l6.153"></a><span id="l6.153" class="difflineplus">+</span>
<a href="#l6.154"></a><span id="l6.154" class="difflineplus">+  /**</span>
<a href="#l6.155"></a><span id="l6.155" class="difflineplus">+   * Deletes the property with the given name.</span>
<a href="#l6.156"></a><span id="l6.156" class="difflineplus">+   *</span>
<a href="#l6.157"></a><span id="l6.157" class="difflineplus">+   * Some properties may not be deleted. However, the implementation will not</span>
<a href="#l6.158"></a><span id="l6.158" class="difflineplus">+   * check this constraint at this method. If such a property is deleted, an</span>
<a href="#l6.159"></a><span id="l6.159" class="difflineplus">+   * error may be thrown when the card is modified at the database level.</span>
<a href="#l6.160"></a><span id="l6.160" class="difflineplus">+   *</span>
<a href="#l6.161"></a><span id="l6.161" class="difflineplus">+   * @param name             The case-sensitive name of the property to set.</span>
<a href="#l6.162"></a><span id="l6.162" class="difflineplus">+   */</span>
<a href="#l6.163"></a><span id="l6.163" class="difflineplus">+  void deleteProperty(in AUTF8String name);</span>
<a href="#l6.164"></a><span id="l6.164" class="difflineplus">+ </span>
<a href="#l6.165"></a><span id="l6.165" class="difflineplus">+  /**</span>
<a href="#l6.166"></a><span id="l6.166" class="difflineplus">+   * @{</span>
<a href="#l6.167"></a><span id="l6.167" class="difflineplus">+   * These properties are shorthand for getProperty and setProperty.</span>
<a href="#l6.168"></a><span id="l6.168" class="difflineplus">+   */</span>
<a href="#l6.169"></a><span id="l6.169">   attribute AString firstName;</span>
<a href="#l6.170"></a><span id="l6.170">   attribute AString lastName;</span>
<a href="#l6.171"></a><span id="l6.171" class="difflineminus">-  attribute AString phoneticFirstName;</span>
<a href="#l6.172"></a><span id="l6.172" class="difflineminus">-  attribute AString phoneticLastName;</span>
<a href="#l6.173"></a><span id="l6.173">   attribute AString displayName;</span>
<a href="#l6.174"></a><span id="l6.174" class="difflineminus">-  attribute AString nickName;</span>
<a href="#l6.175"></a><span id="l6.175">   attribute AString primaryEmail;</span>
<a href="#l6.176"></a><span id="l6.176" class="difflineminus">-  attribute AString secondEmail;</span>
<a href="#l6.177"></a><span id="l6.177" class="difflineminus">-  attribute AString workPhone;</span>
<a href="#l6.178"></a><span id="l6.178" class="difflineminus">-  attribute AString homePhone;</span>
<a href="#l6.179"></a><span id="l6.179" class="difflineminus">-  attribute AString faxNumber;</span>
<a href="#l6.180"></a><span id="l6.180" class="difflineminus">-  attribute AString pagerNumber;</span>
<a href="#l6.181"></a><span id="l6.181" class="difflineminus">-  attribute AString cellularNumber;</span>
<a href="#l6.182"></a><span id="l6.182" class="difflineminus">-  attribute AString workPhoneType;</span>
<a href="#l6.183"></a><span id="l6.183" class="difflineminus">-  attribute AString homePhoneType;</span>
<a href="#l6.184"></a><span id="l6.184" class="difflineminus">-  attribute AString faxNumberType;</span>
<a href="#l6.185"></a><span id="l6.185" class="difflineminus">-  attribute AString pagerNumberType;</span>
<a href="#l6.186"></a><span id="l6.186" class="difflineminus">-  attribute AString cellularNumberType;</span>
<a href="#l6.187"></a><span id="l6.187" class="difflineminus">-  attribute AString homeAddress;</span>
<a href="#l6.188"></a><span id="l6.188" class="difflineminus">-  attribute AString homeAddress2;</span>
<a href="#l6.189"></a><span id="l6.189" class="difflineminus">-  attribute AString homeCity;</span>
<a href="#l6.190"></a><span id="l6.190" class="difflineminus">-  attribute AString homeState;</span>
<a href="#l6.191"></a><span id="l6.191" class="difflineminus">-  attribute AString homeZipCode;</span>
<a href="#l6.192"></a><span id="l6.192" class="difflineminus">-  attribute AString homeCountry;</span>
<a href="#l6.193"></a><span id="l6.193" class="difflineminus">-  attribute AString workAddress;</span>
<a href="#l6.194"></a><span id="l6.194" class="difflineminus">-  attribute AString workAddress2;</span>
<a href="#l6.195"></a><span id="l6.195" class="difflineminus">-  attribute AString workCity;</span>
<a href="#l6.196"></a><span id="l6.196" class="difflineminus">-  attribute AString workState;</span>
<a href="#l6.197"></a><span id="l6.197" class="difflineminus">-  attribute AString workZipCode;</span>
<a href="#l6.198"></a><span id="l6.198" class="difflineminus">-  attribute AString workCountry;</span>
<a href="#l6.199"></a><span id="l6.199" class="difflineminus">-  attribute AString jobTitle;</span>
<a href="#l6.200"></a><span id="l6.200" class="difflineminus">-  attribute AString department;</span>
<a href="#l6.201"></a><span id="l6.201" class="difflineminus">-  attribute AString company;</span>
<a href="#l6.202"></a><span id="l6.202" class="difflineminus">-  attribute AString aimScreenName;</span>
<a href="#l6.203"></a><span id="l6.203" class="difflineminus">-  attribute AString anniversaryYear;</span>
<a href="#l6.204"></a><span id="l6.204" class="difflineminus">-  attribute AString anniversaryMonth;</span>
<a href="#l6.205"></a><span id="l6.205" class="difflineminus">-  attribute AString anniversaryDay;</span>
<a href="#l6.206"></a><span id="l6.206" class="difflineminus">-  attribute AString spouseName;</span>
<a href="#l6.207"></a><span id="l6.207" class="difflineminus">-  attribute AString familyName;</span>
<a href="#l6.208"></a><span id="l6.208" class="difflineminus">-  attribute AString defaultAddress;</span>
<a href="#l6.209"></a><span id="l6.209" class="difflineminus">-  attribute AString category;</span>
<a href="#l6.210"></a><span id="l6.210" class="difflineminus">-  /**</span>
<a href="#l6.211"></a><span id="l6.211" class="difflineminus">-   * webPage1 is work web page</span>
<a href="#l6.212"></a><span id="l6.212" class="difflineminus">-   */</span>
<a href="#l6.213"></a><span id="l6.213" class="difflineminus">-  attribute AString webPage1;</span>
<a href="#l6.214"></a><span id="l6.214" class="difflineminus">-  /**</span>
<a href="#l6.215"></a><span id="l6.215" class="difflineminus">-   * webPage2 is home web page</span>
<a href="#l6.216"></a><span id="l6.216" class="difflineminus">-   */</span>
<a href="#l6.217"></a><span id="l6.217" class="difflineminus">-  attribute AString webPage2;</span>
<a href="#l6.218"></a><span id="l6.218" class="difflineminus">-  attribute AString birthYear;</span>
<a href="#l6.219"></a><span id="l6.219" class="difflineminus">-  attribute AString birthMonth;</span>
<a href="#l6.220"></a><span id="l6.220" class="difflineminus">-  attribute AString birthDay;</span>
<a href="#l6.221"></a><span id="l6.221" class="difflineminus">-  attribute AString custom1;</span>
<a href="#l6.222"></a><span id="l6.222" class="difflineminus">-  attribute AString custom2;</span>
<a href="#l6.223"></a><span id="l6.223" class="difflineminus">-  attribute AString custom3;</span>
<a href="#l6.224"></a><span id="l6.224" class="difflineminus">-  attribute AString custom4;</span>
<a href="#l6.225"></a><span id="l6.225" class="difflineminus">-  attribute AString notes;</span>
<a href="#l6.226"></a><span id="l6.226" class="difflineminus">-  attribute unsigned long lastModifiedDate;</span>
<a href="#l6.227"></a><span id="l6.227" class="difflineminus">-  /**</span>
<a href="#l6.228"></a><span id="l6.228" class="difflineminus">-   * Popularity Index is bumped every time e-mail is sent to this recipient</span>
<a href="#l6.229"></a><span id="l6.229" class="difflineminus">-   */</span>
<a href="#l6.230"></a><span id="l6.230" class="difflineminus">-  attribute unsigned long popularityIndex;</span>
<a href="#l6.231"></a><span id="l6.231" class="difflineminus">-  attribute unsigned long preferMailFormat;</span>
<a href="#l6.232"></a><span id="l6.232" class="difflineminus">-  attribute boolean isMailList;</span>
<a href="#l6.233"></a><span id="l6.233" class="difflineminus">-  /**</span>
<a href="#l6.234"></a><span id="l6.234" class="difflineminus">-   * If isMailList is true then mailListURI</span>
<a href="#l6.235"></a><span id="l6.235" class="difflineminus">-   * will contain the URI of the associated</span>
<a href="#l6.236"></a><span id="l6.236" class="difflineminus">-   * mail list</span>
<a href="#l6.237"></a><span id="l6.237" class="difflineminus">-   */</span>
<a href="#l6.238"></a><span id="l6.238" class="difflineminus">-  attribute string mailListURI;</span>
<a href="#l6.239"></a><span id="l6.239" class="difflineminus">-  /**</span>
<a href="#l6.240"></a><span id="l6.240" class="difflineminus">-   * allowRemoteContent to be displayed in HTML mail received from this contact</span>
<a href="#l6.241"></a><span id="l6.241" class="difflineminus">-   */</span>
<a href="#l6.242"></a><span id="l6.242" class="difflineminus">-  attribute boolean allowRemoteContent;</span>
<a href="#l6.243"></a><span id="l6.243" class="difflineminus">-</span>
<a href="#l6.244"></a><span id="l6.244" class="difflineminus">-  AString getCardValue(in string name);</span>
<a href="#l6.245"></a><span id="l6.245" class="difflineminus">-</span>
<a href="#l6.246"></a><span id="l6.246" class="difflineminus">-  void setCardValue(in string attrname, in AString value);</span>
<a href="#l6.247"></a><span id="l6.247" class="difflineplus">+  /** @} */</span>
<a href="#l6.248"></a><span id="l6.248"> </span>
<a href="#l6.249"></a><span id="l6.249">   /**</span>
<a href="#l6.250"></a><span id="l6.250" class="difflineminus">-   * This function will copy all values from one card to another.</span>
<a href="#l6.251"></a><span id="l6.251" class="difflineminus">-   *</span>
<a href="#l6.252"></a><span id="l6.252" class="difflineminus">-   * @param  srcCard  The source card to copy values from.</span>
<a href="#l6.253"></a><span id="l6.253" class="difflineminus">-   */</span>
<a href="#l6.254"></a><span id="l6.254" class="difflineminus">-  void copy(in nsIAbCard srcCard);</span>
<a href="#l6.255"></a><span id="l6.255" class="difflineminus">-</span>
<a href="#l6.256"></a><span id="l6.256" class="difflineminus">-  boolean equals(in nsIAbCard card);</span>
<a href="#l6.257"></a><span id="l6.257" class="difflineminus">-</span>
<a href="#l6.258"></a><span id="l6.258" class="difflineminus">-  string convertToBase64EncodedXML();</span>
<a href="#l6.259"></a><span id="l6.259" class="difflineminus">-  AString convertToXMLPrintData();</span>
<a href="#l6.260"></a><span id="l6.260" class="difflineminus">-  string convertToEscapedVCard();</span>
<a href="#l6.261"></a><span id="l6.261" class="difflineminus">-</span>
<a href="#l6.262"></a><span id="l6.262" class="difflineminus">-  /** </span>
<a href="#l6.263"></a><span id="l6.263" class="difflineminus">-   * Generate a name from the card for display purposes. Using the firstName,</span>
<a href="#l6.264"></a><span id="l6.264" class="difflineminus">-   * lastName and the displayName. We allow the caller to cache the pref value,</span>
<a href="#l6.265"></a><span id="l6.265" class="difflineminus">-   * so we don't have to go to prefs every time.</span>
<a href="#l6.266"></a><span id="l6.266" class="difflineminus">-   *</span>
<a href="#l6.267"></a><span id="l6.267" class="difflineminus">-   * The format follows the &quot;mail.addr_book.lastnamefirst&quot; pref values:</span>
<a href="#l6.268"></a><span id="l6.268" class="difflineplus">+   * Translates a card into a specific format.</span>
<a href="#l6.269"></a><span id="l6.269" class="difflineplus">+   * The following types are supported:</span>
<a href="#l6.270"></a><span id="l6.270" class="difflineplus">+   * - base64xml</span>
<a href="#l6.271"></a><span id="l6.271" class="difflineplus">+   * - xml</span>
<a href="#l6.272"></a><span id="l6.272" class="difflineplus">+   * - vcard</span>
<a href="#l6.273"></a><span id="l6.273">    *</span>
<a href="#l6.274"></a><span id="l6.274" class="difflineminus">-   * 0 = generated name is displayName</span>
<a href="#l6.275"></a><span id="l6.275" class="difflineminus">-   * 1 = lastFirst, formatted following lastFirstFormat</span>
<a href="#l6.276"></a><span id="l6.276" class="difflineminus">-   * 2 = firstLast, formatted following firstLastFormat</span>
<a href="#l6.277"></a><span id="l6.277" class="difflineminus">-   *</span>
<a href="#l6.278"></a><span id="l6.278" class="difflineminus">-   * lastFirstFormat and firstLastFormat are defined in addressBook.properties.</span>
<a href="#l6.279"></a><span id="l6.279" class="difflineminus">-   *</span>
<a href="#l6.280"></a><span id="l6.280" class="difflineminus">-   * @param  aGenerateFormat The format to generate as per the above definition.</span>
<a href="#l6.281"></a><span id="l6.281" class="difflineminus">-   * @param  aBundle         An optional parameter that is a pointer to a string</span>
<a href="#l6.282"></a><span id="l6.282" class="difflineminus">-   *                         bundle that holds:</span>
<a href="#l6.283"></a><span id="l6.283" class="difflineminus">-   *           chrome://messenger/locale/addressbook/addressBook.properties</span>
<a href="#l6.284"></a><span id="l6.284" class="difflineminus">-   *                         If this bundle is not supplied, then the function</span>
<a href="#l6.285"></a><span id="l6.285" class="difflineminus">-   *                         will obtain the bundle itself. If cached by the</span>
<a href="#l6.286"></a><span id="l6.286" class="difflineminus">-   *                         caller and supplied to this function, then</span>
<a href="#l6.287"></a><span id="l6.287" class="difflineminus">-   *                         performance will be improved over many calls.</span>
<a href="#l6.288"></a><span id="l6.288" class="difflineminus">-   * @return                 A string containing the generated name.</span>
<a href="#l6.289"></a><span id="l6.289" class="difflineplus">+   * @param  aType          The type of item to translate the card into.</span>
<a href="#l6.290"></a><span id="l6.290" class="difflineplus">+   * @return                A string containing the translated card.</span>
<a href="#l6.291"></a><span id="l6.291" class="difflineplus">+   * @exception NS_ERROR_ILLEGAL_VALUE if we do not recognize the type.</span>
<a href="#l6.292"></a><span id="l6.292">    */</span>
<a href="#l6.293"></a><span id="l6.293" class="difflineminus">-  AString generateName(in long aGenerateFormat,</span>
<a href="#l6.294"></a><span id="l6.294" class="difflineminus">-                       [optional] in nsIStringBundle aBundle);</span>
<a href="#l6.295"></a><span id="l6.295" class="difflineplus">+  AUTF8String translateTo(in AUTF8String aType);</span>
<a href="#l6.296"></a><span id="l6.296" class="difflineplus">+</span>
<a href="#l6.297"></a><span id="l6.297" class="difflineplus">+  /**</span>
<a href="#l6.298"></a><span id="l6.298" class="difflineplus">+   * Translates a card from the specified format</span>
<a href="#l6.299"></a><span id="l6.299" class="difflineplus">+   */</span>
<a href="#l6.300"></a><span id="l6.300" class="difflineplus">+  //void translateFrom(in AUTF8String aType, in AUTF8String aData);</span>
<a href="#l6.301"></a><span id="l6.301"> </span>
<a href="#l6.302"></a><span id="l6.302">   /** </span>
<a href="#l6.303"></a><span id="l6.303">    * Generate a phonetic name from the card, using the firstName and lastName</span>
<a href="#l6.304"></a><span id="l6.304">    * values.</span>
<a href="#l6.305"></a><span id="l6.305">    *</span>
<a href="#l6.306"></a><span id="l6.306">    * @param  aLastNameFirst  Set to True to put the last name before the first.</span>
<a href="#l6.307"></a><span id="l6.307">    * @return                 A string containing the generated phonetic name.</span>
<a href="#l6.308"></a><span id="l6.308">    */</span>
<a href="#l6.309"></a><span id="l6.309">   AString generatePhoneticName(in boolean aLastNameFirst);</span>
<a href="#l6.310"></a><span id="l6.310" class="difflineplus">+</span>
<a href="#l6.311"></a><span id="l6.311" class="difflineplus">+  /**</span>
<a href="#l6.312"></a><span id="l6.312" class="difflineplus">+   * This function will copy all values from one card to another.</span>
<a href="#l6.313"></a><span id="l6.313" class="difflineplus">+   *</span>
<a href="#l6.314"></a><span id="l6.314" class="difflineplus">+   * @param  srcCard         The source card to copy values from.</span>
<a href="#l6.315"></a><span id="l6.315" class="difflineplus">+   */</span>
<a href="#l6.316"></a><span id="l6.316" class="difflineplus">+  void copy(in nsIAbCard aSrcCard);</span>
<a href="#l6.317"></a><span id="l6.317" class="difflineplus">+</span>
<a href="#l6.318"></a><span id="l6.318" class="difflineplus">+  /**</span>
<a href="#l6.319"></a><span id="l6.319" class="difflineplus">+   * Returns true if this card is equal to the other card.</span>
<a href="#l6.320"></a><span id="l6.320" class="difflineplus">+   *</span>
<a href="#l6.321"></a><span id="l6.321" class="difflineplus">+   * The default implementation defines equal as this card pointing to the</span>
<a href="#l6.322"></a><span id="l6.322" class="difflineplus">+   * same object as @arg aCard; another implementation defines it as equality of</span>
<a href="#l6.323"></a><span id="l6.323" class="difflineplus">+   * properties and values.</span>
<a href="#l6.324"></a><span id="l6.324" class="difflineplus">+   *</span>
<a href="#l6.325"></a><span id="l6.325" class="difflineplus">+   * @warning The exact nature of equality is still undefined, and actual</span>
<a href="#l6.326"></a><span id="l6.326" class="difflineplus">+   *          results may not match theoretical results. Most notably, the code</span>
<a href="#l6.327"></a><span id="l6.327" class="difflineplus">+   *          &lt;tt&gt;a.equals(b) == b.equals(a)&lt;/tt&gt; might not return true. In</span>
<a href="#l6.328"></a><span id="l6.328" class="difflineplus">+   *          particular, calling equals on cards from different address books</span>
<a href="#l6.329"></a><span id="l6.329" class="difflineplus">+   *          may return inaccurate results.</span>
<a href="#l6.330"></a><span id="l6.330" class="difflineplus">+   *          </span>
<a href="#l6.331"></a><span id="l6.331" class="difflineplus">+   *</span>
<a href="#l6.332"></a><span id="l6.332" class="difflineplus">+   * @return                 Equality, as defined above.</span>
<a href="#l6.333"></a><span id="l6.333" class="difflineplus">+   * @param  aCard           The card to compare against.</span>
<a href="#l6.334"></a><span id="l6.334" class="difflineplus">+   */</span>
<a href="#l6.335"></a><span id="l6.335" class="difflineplus">+  boolean equals(in nsIAbCard aCard);</span>
<a href="#l6.336"></a><span id="l6.336" class="difflineplus">+</span>
<a href="#l6.337"></a><span id="l6.337" class="difflineplus">+  // PROPERTIES TO BE DELETED AS PART OF REWRITE</span>
<a href="#l6.338"></a><span id="l6.338" class="difflineplus">+</span>
<a href="#l6.339"></a><span id="l6.339" class="difflineplus">+  attribute boolean isMailList;</span>
<a href="#l6.340"></a><span id="l6.340" class="difflineplus">+  /**</span>
<a href="#l6.341"></a><span id="l6.341" class="difflineplus">+   * If isMailList is true then mailListURI</span>
<a href="#l6.342"></a><span id="l6.342" class="difflineplus">+   * will contain the URI of the associated</span>
<a href="#l6.343"></a><span id="l6.343" class="difflineplus">+   * mail list</span>
<a href="#l6.344"></a><span id="l6.344" class="difflineplus">+   */</span>
<a href="#l6.345"></a><span id="l6.345" class="difflineplus">+  attribute string mailListURI;</span>
<a href="#l6.346"></a><span id="l6.346"> };</span>
<a href="#l6.347"></a><span id="l6.347" class="difflineplus">+</span>
<a href="#l6.348"></a><span id="l6.348" class="difflineplus">+%{C++</span>
<a href="#l6.349"></a><span id="l6.349" class="difflineplus">+// A nice list of properties for the benefit of C++ clients</span>
<a href="#l6.350"></a><span id="l6.350" class="difflineplus">+#define kFirstNameProperty          &quot;FirstName&quot;</span>
<a href="#l6.351"></a><span id="l6.351" class="difflineplus">+#define kLastNameProperty           &quot;LastName&quot;</span>
<a href="#l6.352"></a><span id="l6.352" class="difflineplus">+#define kDisplayNameProperty        &quot;DisplayName&quot;</span>
<a href="#l6.353"></a><span id="l6.353" class="difflineplus">+#define kNicknameProperty           &quot;NickName&quot;</span>
<a href="#l6.354"></a><span id="l6.354" class="difflineplus">+#define kPriEmailProperty           &quot;PrimaryEmail&quot;</span>
<a href="#l6.355"></a><span id="l6.355" class="difflineplus">+#define kPreferMailFormatProperty   &quot;PreferMailFormat&quot;</span>
<a href="#l6.356"></a><span id="l6.356" class="difflineplus">+#define kLastModifiedDateProperty   &quot;LastModifiedDate&quot;</span>
<a href="#l6.357"></a><span id="l6.357" class="difflineplus">+#define kPopularityIndexProperty    &quot;PopularityIndex&quot;</span>
<a href="#l6.358"></a><span id="l6.358" class="difflineplus">+#define kAllowRemoteContentProperty &quot;AllowRemoteContent&quot;</span>
<a href="#l6.359"></a><span id="l6.359" class="difflineplus">+</span>
<a href="#l6.360"></a><span id="l6.360" class="difflineplus">+#define kPhoneticFirstNameProperty  &quot;PhoneticFirstName&quot;</span>
<a href="#l6.361"></a><span id="l6.361" class="difflineplus">+#define kPhoneticLastNameProperty   &quot;PhoneticLastName&quot;</span>
<a href="#l6.362"></a><span id="l6.362" class="difflineplus">+#define kSpouseNameProperty         &quot;SpouseName&quot;</span>
<a href="#l6.363"></a><span id="l6.363" class="difflineplus">+#define kFamilyNameProperty         &quot;FamilyName&quot;</span>
<a href="#l6.364"></a><span id="l6.364" class="difflineplus">+#define k2ndEmailProperty           &quot;SecondEmail&quot;</span>
<a href="#l6.365"></a><span id="l6.365" class="difflineplus">+</span>
<a href="#l6.366"></a><span id="l6.366" class="difflineplus">+#define kHomeAddressProperty        &quot;HomeAddress&quot;</span>
<a href="#l6.367"></a><span id="l6.367" class="difflineplus">+#define kHomeAddress2Property       &quot;HomeAddress2&quot;</span>
<a href="#l6.368"></a><span id="l6.368" class="difflineplus">+#define kHomeCityProperty           &quot;HomeCity&quot;</span>
<a href="#l6.369"></a><span id="l6.369" class="difflineplus">+#define kHomeStateProperty          &quot;HomeState&quot;</span>
<a href="#l6.370"></a><span id="l6.370" class="difflineplus">+#define kHomeZipCodeProperty        &quot;HomeZipCode&quot;</span>
<a href="#l6.371"></a><span id="l6.371" class="difflineplus">+#define kHomeCountryProperty        &quot;HomeCountry&quot;</span>
<a href="#l6.372"></a><span id="l6.372" class="difflineplus">+#define kHomeWebPageProperty        &quot;WebPage2&quot;</span>
<a href="#l6.373"></a><span id="l6.373" class="difflineplus">+</span>
<a href="#l6.374"></a><span id="l6.374" class="difflineplus">+#define kWorkAddressProperty        &quot;WorkAddress&quot;</span>
<a href="#l6.375"></a><span id="l6.375" class="difflineplus">+#define kWorkAddress2Property       &quot;WorkAddress2&quot;</span>
<a href="#l6.376"></a><span id="l6.376" class="difflineplus">+#define kWorkCityProperty           &quot;WorkCity&quot;</span>
<a href="#l6.377"></a><span id="l6.377" class="difflineplus">+#define kWorkStateProperty          &quot;WorkState&quot;</span>
<a href="#l6.378"></a><span id="l6.378" class="difflineplus">+#define kWorkZipCodeProperty        &quot;WorkZipCode&quot;</span>
<a href="#l6.379"></a><span id="l6.379" class="difflineplus">+#define kWorkCountryProperty        &quot;WorkCountry&quot;</span>
<a href="#l6.380"></a><span id="l6.380" class="difflineplus">+#define kWorkWebPageProperty        &quot;WebPage1&quot;</span>
<a href="#l6.381"></a><span id="l6.381" class="difflineplus">+</span>
<a href="#l6.382"></a><span id="l6.382" class="difflineplus">+#define kHomePhoneProperty          &quot;HomePhone&quot;</span>
<a href="#l6.383"></a><span id="l6.383" class="difflineplus">+#define kHomePhoneTypeProperty      &quot;HomePhoneType&quot;</span>
<a href="#l6.384"></a><span id="l6.384" class="difflineplus">+#define kWorkPhoneProperty          &quot;WorkPhone&quot;</span>
<a href="#l6.385"></a><span id="l6.385" class="difflineplus">+#define kWorkPhoneTypeProperty      &quot;WorkPhoneType&quot;</span>
<a href="#l6.386"></a><span id="l6.386" class="difflineplus">+#define kFaxProperty                &quot;FaxNumber&quot;</span>
<a href="#l6.387"></a><span id="l6.387" class="difflineplus">+#define kFaxTypeProperty            &quot;FaxNumberType&quot;</span>
<a href="#l6.388"></a><span id="l6.388" class="difflineplus">+#define kPagerTypeProperty          &quot;PagerNumberType&quot;</span>
<a href="#l6.389"></a><span id="l6.389" class="difflineplus">+#define kPagerProperty              &quot;PagerNumber&quot;</span>
<a href="#l6.390"></a><span id="l6.390" class="difflineplus">+#define kCellularProperty           &quot;CellularNumber&quot;</span>
<a href="#l6.391"></a><span id="l6.391" class="difflineplus">+#define kCellularTypeProperty       &quot;CellularNumberType&quot;</span>
<a href="#l6.392"></a><span id="l6.392" class="difflineplus">+</span>
<a href="#l6.393"></a><span id="l6.393" class="difflineplus">+#define kJobTitleProperty           &quot;JobTitle&quot;</span>
<a href="#l6.394"></a><span id="l6.394" class="difflineplus">+#define kDepartmentProperty         &quot;Department&quot;</span>
<a href="#l6.395"></a><span id="l6.395" class="difflineplus">+#define kCompanyProperty            &quot;Company&quot;</span>
<a href="#l6.396"></a><span id="l6.396" class="difflineplus">+#define kScreenNameProperty         &quot;_AimScreenName&quot;</span>
<a href="#l6.397"></a><span id="l6.397" class="difflineplus">+#define kCustom1Property            &quot;Custom1&quot;</span>
<a href="#l6.398"></a><span id="l6.398" class="difflineplus">+#define kCustom2Property            &quot;Custom2&quot;</span>
<a href="#l6.399"></a><span id="l6.399" class="difflineplus">+#define kCustom3Property            &quot;Custom3&quot;</span>
<a href="#l6.400"></a><span id="l6.400" class="difflineplus">+#define kCustom4Property            &quot;Custom4&quot;</span>
<a href="#l6.401"></a><span id="l6.401" class="difflineplus">+#define kNotesProperty              &quot;Notes&quot;</span>
<a href="#l6.402"></a><span id="l6.402" class="difflineplus">+</span>
<a href="#l6.403"></a><span id="l6.403" class="difflineplus">+#define kAnniversaryYearProperty    &quot;AnniversaryYear&quot;</span>
<a href="#l6.404"></a><span id="l6.404" class="difflineplus">+#define kAnniversaryMonthProperty   &quot;AnniversaryMonth&quot;</span>
<a href="#l6.405"></a><span id="l6.405" class="difflineplus">+#define kAnniversaryDayProperty     &quot;AnniversaryDay&quot;</span>
<a href="#l6.406"></a><span id="l6.406" class="difflineplus">+#define kBirthYearProperty          &quot;BirthYear&quot;</span>
<a href="#l6.407"></a><span id="l6.407" class="difflineplus">+#define kBirthMonthProperty         &quot;BirthMonth&quot;</span>
<a href="#l6.408"></a><span id="l6.408" class="difflineplus">+#define kBirthDayProperty           &quot;BirthDay&quot;</span>
<a href="#l6.409"></a><span id="l6.409" class="difflineplus">+%}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/addrbook/public/nsIAbDirectory.idl</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/addrbook/public/nsIAbDirectory.idl</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -134,19 +134,22 @@ interface nsIAbDirectory : nsISupports {</span>
<a href="#l7.4"></a><span id="l7.4">   // NS_ERROR_NOT_AVAILABLE exception if the card</span>
<a href="#l7.5"></a><span id="l7.5">   // cannot be found.</span>
<a href="#l7.6"></a><span id="l7.6">   boolean hasCard(in nsIAbCard cards);</span>
<a href="#l7.7"></a><span id="l7.7"> </span>
<a href="#l7.8"></a><span id="l7.8">   // Check if directory contains directory</span>
<a href="#l7.9"></a><span id="l7.9">   boolean hasDirectory(in nsIAbDirectory dir);</span>
<a href="#l7.10"></a><span id="l7.10"> </span>
<a href="#l7.11"></a><span id="l7.11">   /**</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-   * Adds a card to the database. card may be an abstract card.</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+   * Adds a card to the database.</span>
<a href="#l7.14"></a><span id="l7.14">    *</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineminus">-   * @return &quot;Real&quot; card (eg nsIAbMDBCard) that can be used for some</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+   * This card does not need to be of the same type as the database, e.g., one</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+   * can add an nsIAbLDAPCard to an nsIAbMDBDirectory.</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+   *</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+   * @return &quot;Real&quot; card (eg nsIAbLDAPCard) that can be used for some</span>
<a href="#l7.20"></a><span id="l7.20">    *         extra functions.</span>
<a href="#l7.21"></a><span id="l7.21">    */</span>
<a href="#l7.22"></a><span id="l7.22">   nsIAbCard addCard(in nsIAbCard card);</span>
<a href="#l7.23"></a><span id="l7.23"> </span>
<a href="#l7.24"></a><span id="l7.24">   /**</span>
<a href="#l7.25"></a><span id="l7.25">    * Modifies a card in the database to match that supplied.</span>
<a href="#l7.26"></a><span id="l7.26">    */</span>
<a href="#l7.27"></a><span id="l7.27">   void modifyCard(in nsIAbCard modifiedCard);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1">new file mode 100644</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineminus">--- /dev/null</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineplus">+++ b/mailnews/addrbook/public/nsIAbItem.idl</span>
<a href="#l8.4"></a><span id="l8.4" class="difflineat">@@ -0,0 +1,107 @@</span>
<a href="#l8.5"></a><span id="l8.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l8.6"></a><span id="l8.6" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l8.7"></a><span id="l8.7" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l8.8"></a><span id="l8.8" class="difflineplus">+ *</span>
<a href="#l8.9"></a><span id="l8.9" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l8.10"></a><span id="l8.10" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l8.11"></a><span id="l8.11" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+ *</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+ * License.</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+ *</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineplus">+ *</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineplus">+ * Netscape Communications Corporation.</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineplus">+ *</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineplus">+ *  Mark Banner &lt;bugzilla@standard8.plus.com&gt;</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineplus">+ *  Joshua Cranmer &lt;Pidgeot18@gmail.com&gt;</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineplus">+ *</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineplus">+ * either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+ * or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineplus">+ *</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineplus">+</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineplus">+#include &quot;nsISupports.idl&quot;</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineplus">+</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineplus">+interface nsIMsgHeaderParser;</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineplus">+interface nsIStringBundle;</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineplus">+</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineplus">+/**</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineplus">+ * A containable item for address books.</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+ */</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineplus">+[scriptable, uuid(f7320616-3139-419b-a7c3-37441da3caf3)]</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineplus">+interface nsIAbItem : nsISupports {</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineplus">+  /**</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineplus">+   * @{</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineplus">+   * These constants reflect the possible values of the</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineplus">+   * mail.addr_book.lastnamefirst preferences. They are intended to be used in</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineplus">+   * generateName, defined below.</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineplus">+   */</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineplus">+   const unsigned long GENERATE_DISPLAY_NAME = 0;</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineplus">+   const unsigned long GENERATE_LAST_FIRST_ORDER = 1;</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineplus">+   const unsigned long GENERATE_FIRST_LAST_ORDER = 2;</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineplus">+   /** @} */</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineplus">+</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineplus">+  /** </span>
<a href="#l8.66"></a><span id="l8.66" class="difflineplus">+   * Generate a name from the item for display purposes.</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineplus">+   *</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineplus">+   * If this item is an nsIAbCard, then it will use the aGenerateFormat option</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineplus">+   * to determine the string to return.</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineplus">+   * If this item is not an nsIAbCard, then the aGenerateFormat option may be</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineplus">+   * ignored, and the displayName of the item returned.</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineplus">+   *</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineplus">+   * @param  aGenerateFormat The format to generate as per the GENERATE_*</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineplus">+   *                         constants above.</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineplus">+   * @param  aBundle         An optional parameter that is a pointer to a string</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineplus">+   *                         bundle that holds:</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineplus">+   *           chrome://messenger/locale/addressbook/addressBook.properties</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineplus">+   *                         If this bundle is not supplied, then the function</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineplus">+   *                         will obtain the bundle itself. If cached by the</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineplus">+   *                         caller and supplied to this function, then</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineplus">+   *                         performance will be improved over many calls.</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineplus">+   * @return                 A string containing the generated name.</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineplus">+   */</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineplus">+  AString generateName(in long aGenerateFormat,</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineplus">+                       [optional] in nsIStringBundle aBundle);</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineplus">+</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineplus">+  /**</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineplus">+   * Generate a formatted email address from the card, that can be used for</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineplus">+   * sending emails.</span>
<a href="#l8.90"></a><span id="l8.90" class="difflineplus">+   *</span>
<a href="#l8.91"></a><span id="l8.91" class="difflineplus">+   * @param  aExpandList     If this card is a list, and this parameter is set</span>
<a href="#l8.92"></a><span id="l8.92" class="difflineplus">+   *                         to true, then the list will be expanded to include</span>
<a href="#l8.93"></a><span id="l8.93" class="difflineplus">+   *                         the emails of the cards within the list.</span>
<a href="#l8.94"></a><span id="l8.94" class="difflineplus">+   * @param  aGroupMailLists If this card (or the items within this card) is a</span>
<a href="#l8.95"></a><span id="l8.95" class="difflineplus">+   *                         list, and this is set to true, then the list will</span>
<a href="#l8.96"></a><span id="l8.96" class="difflineplus">+   *                         be expanded in the RFC 2822 group format</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineplus">+   *                         &quot;displayname : email1 ; email2 ; etc&quot;.</span>
<a href="#l8.98"></a><span id="l8.98" class="difflineplus">+   * @param  aHeaderParser   An optional parameter pointing to the</span>
<a href="#l8.99"></a><span id="l8.99" class="difflineplus">+   *                         nsIMsgHeaderParser service. If this is not supplied</span>
<a href="#l8.100"></a><span id="l8.100" class="difflineplus">+   *                         the function will obtain the service itself. If</span>
<a href="#l8.101"></a><span id="l8.101" class="difflineplus">+   *                         cached by the called and supplied to this function,</span>
<a href="#l8.102"></a><span id="l8.102" class="difflineplus">+   *                         then performance will be improved over many calls.</span>
<a href="#l8.103"></a><span id="l8.103" class="difflineplus">+   * @return                 A string containing a comma-separated list of</span>
<a href="#l8.104"></a><span id="l8.104" class="difflineplus">+   *                         formatted addresses.</span>
<a href="#l8.105"></a><span id="l8.105" class="difflineplus">+   */</span>
<a href="#l8.106"></a><span id="l8.106" class="difflineplus">+  //AString generateFormattedEmail(in boolean aExpandList,</span>
<a href="#l8.107"></a><span id="l8.107" class="difflineplus">+  //                               in boolean aAsGroupMailLists,</span>
<a href="#l8.108"></a><span id="l8.108" class="difflineplus">+  //                               [optional] in nsIMsgHeaderParser aHeaderParser);</span>
<a href="#l8.109"></a><span id="l8.109" class="difflineplus">+</span>
<a href="#l8.110"></a><span id="l8.110" class="difflineplus">+};</span>
<a href="#l8.111"></a><span id="l8.111" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1">deleted file mode 100644</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineminus">--- a/mailnews/addrbook/public/nsIAbMDBCard.idl</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineplus">+++ /dev/null</span>
<a href="#l9.4"></a><span id="l9.4" class="difflineat">@@ -1,58 +0,0 @@</span>
<a href="#l9.5"></a><span id="l9.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l9.6"></a><span id="l9.6" class="difflineminus">-/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l9.7"></a><span id="l9.7" class="difflineminus">- * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l9.8"></a><span id="l9.8" class="difflineminus">- *</span>
<a href="#l9.9"></a><span id="l9.9" class="difflineminus">- * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l9.10"></a><span id="l9.10" class="difflineminus">- * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l9.11"></a><span id="l9.11" class="difflineminus">- * the License. You may obtain a copy of the License at</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">- * http://www.mozilla.org/MPL/</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">- *</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineminus">- * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineminus">- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineminus">- * for the specific language governing rights and limitations under the</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineminus">- * License.</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineminus">- *</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineminus">- * The Original Code is mozilla.org code.</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineminus">- *</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineminus">- * The Initial Developer of the Original Code is</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineminus">- * Netscape Communications Corporation.</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineminus">- * Portions created by the Initial Developer are Copyright (C) 2001</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineminus">- * the Initial Developer. All Rights Reserved.</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineminus">- *</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineminus">- * Contributor(s):</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineminus">- *   Paul Sandoz &lt;paul.sandoz@sun.com&gt;</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineminus">- *</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineminus">- * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineminus">- * either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineminus">- * or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineminus">- * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineminus">- * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineminus">- * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineminus">- * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineminus">- * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineminus">- * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineminus">- * the provisions above, a recipient may use your version of this file under</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineminus">- * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineminus">- *</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineminus">- * ***** END LICENSE BLOCK ***** */</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineminus">-</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineminus">-</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineminus">-#include &quot;nsISupports.idl&quot;</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineminus">-</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineminus">-interface nsIAddrDatabase;</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineminus">-</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineminus">-[scriptable, uuid(3ed862c5-7007-49fc-8834-094e1c71baab)]</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineminus">-interface nsIAbMDBCard : nsISupports {</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineminus">-	// used by the absync code</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineminus">-	attribute unsigned long key;</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineminus">-</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineminus">-	// DB specific methods</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineminus">-    attribute unsigned long dbTableID;</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineminus">-    attribute unsigned long dbRowID;</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineminus">-</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineminus">-	void setAbDatabase(in nsIAddrDatabase database);</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineminus">-</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineminus">-	wstring getStringAttribute(in string name);</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineminus">-	void setStringAttribute(in string name, in wstring value);</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineminus">-};</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/addrbook/public/nsIAddrDatabase.idl</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/addrbook/public/nsIAddrDatabase.idl</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -52,74 +52,17 @@ interface nsIArray;</span>
<a href="#l10.4"></a><span id="l10.4"> // to the mozilla addressbook, and weren't in 4.x and aren't specified in</span>
<a href="#l10.5"></a><span id="l10.5"> // RFC 2789.  used when exporting and import LDIF</span>
<a href="#l10.6"></a><span id="l10.6"> // see nsTextAddress.cpp, nsAddressBook.cpp</span>
<a href="#l10.7"></a><span id="l10.7"> #define MOZ_AB_LDIF_PREFIX &quot;mozilla&quot;</span>
<a href="#l10.8"></a><span id="l10.8"> </span>
<a href="#l10.9"></a><span id="l10.9"> // note, GeneratedName is not a real column</span>
<a href="#l10.10"></a><span id="l10.10"> // if you change any of this, make sure to change </span>
<a href="#l10.11"></a><span id="l10.11"> // Get / Set CardValue in nsAbCardProperty.cpp</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-#define kFirstNameColumn          &quot;FirstName&quot;</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-#define kLastNameColumn           &quot;LastName&quot;</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineminus">-#define kPhoneticFirstNameColumn  &quot;PhoneticFirstName&quot;</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineminus">-#define kPhoneticLastNameColumn   &quot;PhoneticLastName&quot;</span>
<a href="#l10.16"></a><span id="l10.16"> #define kPhoneticNameColumn       &quot;_PhoneticName&quot;</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineminus">-#define kDisplayNameColumn        &quot;DisplayName&quot;</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineminus">-#define kNicknameColumn           &quot;NickName&quot;</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineminus">-#define kPriEmailColumn           &quot;PrimaryEmail&quot;</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineminus">-#define k2ndEmailColumn           &quot;SecondEmail&quot;</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineminus">-#define kPreferMailFormatColumn   &quot;PreferMailFormat&quot;</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineminus">-#define kPopularityIndexColumn    &quot;PopularityIndex&quot;</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineminus">-#define kAllowRemoteContentColumn &quot;AllowRemoteContent&quot;</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineminus">-#define kWorkPhoneColumn          &quot;WorkPhone&quot;</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineminus">-#define kHomePhoneColumn          &quot;HomePhone&quot;</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineminus">-#define kFaxColumn                &quot;FaxNumber&quot;</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineminus">-#define kPagerColumn              &quot;PagerNumber&quot;</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineminus">-#define kCellularColumn           &quot;CellularNumber&quot;</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineminus">-#define kWorkPhoneTypeColumn      &quot;WorkPhoneType&quot;</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineminus">-#define kHomePhoneTypeColumn      &quot;HomePhoneType&quot;</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineminus">-#define kFaxTypeColumn            &quot;FaxNumberType&quot;</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineminus">-#define kPagerTypeColumn          &quot;PagerNumberType&quot;</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineminus">-#define kCellularTypeColumn       &quot;CellularNumberType&quot;</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineminus">-#define kHomeAddressColumn        &quot;HomeAddress&quot;</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineminus">-#define kHomeAddress2Column       &quot;HomeAddress2&quot;</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineminus">-#define kHomeCityColumn           &quot;HomeCity&quot;</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineminus">-#define kHomeStateColumn          &quot;HomeState&quot;</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineminus">-#define kHomeZipCodeColumn        &quot;HomeZipCode&quot;</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineminus">-#define kHomeCountryColumn        &quot;HomeCountry&quot;</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineminus">-#define kWorkAddressColumn        &quot;WorkAddress&quot;</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineminus">-#define kWorkAddress2Column       &quot;WorkAddress2&quot;</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineminus">-#define kWorkCityColumn           &quot;WorkCity&quot;</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineminus">-#define kWorkStateColumn          &quot;WorkState&quot;</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineminus">-#define kWorkZipCodeColumn        &quot;WorkZipCode&quot;</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineminus">-#define kWorkCountryColumn        &quot;WorkCountry&quot;</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineminus">-#define kJobTitleColumn           &quot;JobTitle&quot;</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineminus">-#define kDepartmentColumn         &quot;Department&quot;</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineminus">-#define kCompanyColumn            &quot;Company&quot;</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineminus">-#define kAimScreenNameColumn      &quot;_AimScreenName&quot;</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineminus">-#define kAnniversaryYearColumn    &quot;AnniversaryYear&quot;</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineminus">-#define kAnniversaryMonthColumn   &quot;AnniversaryMonth&quot;</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineminus">-#define kAnniversaryDayColumn     &quot;AnniversaryDay&quot;</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineminus">-#define kSpouseNameColumn         &quot;SpouseName&quot;</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineminus">-#define kFamilyNameColumn         &quot;FamilyName&quot;</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineminus">-#define kDefaultAddressColumn     &quot;DefaultAddress&quot;</span>
<a href="#l10.56"></a><span id="l10.56" class="difflineminus">-#define kCategoryColumn           &quot;Category&quot;</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineminus">-// webPage1 is work web page</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineminus">-#define kWebPage1Column           &quot;WebPage1&quot;</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineminus">-// webPage2 is home web page</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineminus">-#define kWebPage2Column           &quot;WebPage2&quot;</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineminus">-#define kBirthYearColumn          &quot;BirthYear&quot;</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineminus">-#define kBirthMonthColumn         &quot;BirthMonth&quot;</span>
<a href="#l10.63"></a><span id="l10.63" class="difflineminus">-#define kBirthDayColumn           &quot;BirthDay&quot;</span>
<a href="#l10.64"></a><span id="l10.64" class="difflineminus">-#define kCustom1Column            &quot;Custom1&quot;</span>
<a href="#l10.65"></a><span id="l10.65" class="difflineminus">-#define kCustom2Column            &quot;Custom2&quot;</span>
<a href="#l10.66"></a><span id="l10.66" class="difflineminus">-#define kCustom3Column            &quot;Custom3&quot;</span>
<a href="#l10.67"></a><span id="l10.67" class="difflineminus">-#define kCustom4Column            &quot;Custom4&quot;</span>
<a href="#l10.68"></a><span id="l10.68" class="difflineminus">-#define kNotesColumn              &quot;Notes&quot;</span>
<a href="#l10.69"></a><span id="l10.69" class="difflineminus">-#define kLastModifiedDateColumn   &quot;LastModifiedDate&quot;</span>
<a href="#l10.70"></a><span id="l10.70"> #define kAddressCharSetColumn     &quot;AddrCharSet&quot;</span>
<a href="#l10.71"></a><span id="l10.71"> #define kMailListName             &quot;ListName&quot;</span>
<a href="#l10.72"></a><span id="l10.72"> #define kMailListNickName         &quot;ListNickName&quot;</span>
<a href="#l10.73"></a><span id="l10.73"> #define kMailListDescription      &quot;ListDescription&quot;</span>
<a href="#l10.74"></a><span id="l10.74"> #define kMailListTotalAddresses   &quot;ListTotalAddresses&quot;</span>
<a href="#l10.75"></a><span id="l10.75"> // not shown in the UI</span>
<a href="#l10.76"></a><span id="l10.76"> #define kLowerPriEmailColumn      &quot;LowercasePrimaryEmail&quot;</span>
<a href="#l10.77"></a><span id="l10.77"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/addrbook/resources/content/abCardOverlay.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/addrbook/resources/content/abCardOverlay.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -42,56 +42,56 @@ const kNonVcardFields =</span>
<a href="#l11.4"></a><span id="l11.4"> </span>
<a href="#l11.5"></a><span id="l11.5"> const kPhoneticFields =</span>
<a href="#l11.6"></a><span id="l11.6">         [&quot;PhoneticLastName&quot;, &quot;PhoneticLabel1&quot;, &quot;PhoneticSpacer1&quot;,</span>
<a href="#l11.7"></a><span id="l11.7">          &quot;PhoneticFirstName&quot;, &quot;PhoneticLabel2&quot;, &quot;PhoneticSpacer2&quot;];</span>
<a href="#l11.8"></a><span id="l11.8"> </span>
<a href="#l11.9"></a><span id="l11.9"> // Item is |[dialogField, cardProperty]|.</span>
<a href="#l11.10"></a><span id="l11.10"> const kVcardFields =</span>
<a href="#l11.11"></a><span id="l11.11">         [ // Contact &gt; Name</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-         [&quot;FirstName&quot;, &quot;firstName&quot;],</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-         [&quot;LastName&quot;, &quot;lastName&quot;],</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineminus">-         [&quot;DisplayName&quot;, &quot;displayName&quot;],</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineminus">-         [&quot;NickName&quot;, &quot;nickName&quot;],</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineplus">+         [&quot;FirstName&quot;, &quot;FirstName&quot;],</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineplus">+         [&quot;LastName&quot;, &quot;LastName&quot;],</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineplus">+         [&quot;DisplayName&quot;, &quot;DisplayName&quot;],</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineplus">+         [&quot;NickName&quot;, &quot;NickName&quot;],</span>
<a href="#l11.20"></a><span id="l11.20">           // Contact &gt; Internet</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineminus">-         [&quot;PrimaryEmail&quot;, &quot;primaryEmail&quot;],</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineminus">-         [&quot;SecondEmail&quot;, &quot;secondEmail&quot;],</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineminus">-         [&quot;ScreenName&quot;, &quot;aimScreenName&quot;], // NB: AIM.</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineplus">+         [&quot;PrimaryEmail&quot;, &quot;PrimaryEmail&quot;],</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineplus">+         [&quot;SecondEmail&quot;, &quot;SecondEmail&quot;],</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineplus">+         [&quot;ScreenName&quot;, &quot;_AimScreenName&quot;], // NB: AIM.</span>
<a href="#l11.27"></a><span id="l11.27">           // Contact &gt; Phones</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineminus">-         [&quot;WorkPhone&quot;, &quot;workPhone&quot;],</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineminus">-         [&quot;HomePhone&quot;, &quot;homePhone&quot;],</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineminus">-         [&quot;FaxNumber&quot;, &quot;faxNumber&quot;],</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineminus">-         [&quot;PagerNumber&quot;, &quot;pagerNumber&quot;],</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineminus">-         [&quot;CellularNumber&quot;, &quot;cellularNumber&quot;],</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineplus">+         [&quot;WorkPhone&quot;, &quot;WorkPhone&quot;],</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineplus">+         [&quot;HomePhone&quot;, &quot;HomePhone&quot;],</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineplus">+         [&quot;FaxNumber&quot;, &quot;FaxNumber&quot;],</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineplus">+         [&quot;PagerNumber&quot;, &quot;PagerNumber&quot;],</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineplus">+         [&quot;CellularNumber&quot;, &quot;CellularNumber&quot;],</span>
<a href="#l11.38"></a><span id="l11.38">           // Address &gt; Home</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineminus">-         [&quot;HomeAddress&quot;, &quot;homeAddress&quot;],</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineminus">-         [&quot;HomeAddress2&quot;, &quot;homeAddress2&quot;],</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineminus">-         [&quot;HomeCity&quot;, &quot;homeCity&quot;],</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineminus">-         [&quot;HomeState&quot;, &quot;homeState&quot;],</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineminus">-         [&quot;HomeZipCode&quot;, &quot;homeZipCode&quot;],</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineminus">-         [&quot;HomeCountry&quot;, &quot;homeCountry&quot;],</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineminus">-         [&quot;WebPage2&quot;, &quot;webPage2&quot;],</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineplus">+         [&quot;HomeAddress&quot;, &quot;HomeAddress&quot;],</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineplus">+         [&quot;HomeAddress2&quot;, &quot;HomeAddress2&quot;],</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineplus">+         [&quot;HomeCity&quot;, &quot;HomeCity&quot;],</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineplus">+         [&quot;HomeState&quot;, &quot;HomeState&quot;],</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineplus">+         [&quot;HomeZipCode&quot;, &quot;HomeZipCode&quot;],</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineplus">+         [&quot;HomeCountry&quot;, &quot;HomeCountry&quot;],</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineplus">+         [&quot;WebPage2&quot;, &quot;WebPage2&quot;],</span>
<a href="#l11.53"></a><span id="l11.53">           // Address &gt; Work</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineminus">-         [&quot;JobTitle&quot;, &quot;jobTitle&quot;],</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineminus">-         [&quot;Department&quot;, &quot;department&quot;],</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineminus">-         [&quot;Company&quot;, &quot;company&quot;],</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineminus">-         [&quot;WorkAddress&quot;, &quot;workAddress&quot;],</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineminus">-         [&quot;WorkAddress2&quot;, &quot;workAddress2&quot;],</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineminus">-         [&quot;WorkCity&quot;, &quot;workCity&quot;],</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineminus">-         [&quot;WorkState&quot;, &quot;workState&quot;],</span>
<a href="#l11.61"></a><span id="l11.61" class="difflineminus">-         [&quot;WorkZipCode&quot;, &quot;workZipCode&quot;],</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineminus">-         [&quot;WorkCountry&quot;, &quot;workCountry&quot;],</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineminus">-         [&quot;WebPage1&quot;, &quot;webPage1&quot;],</span>
<a href="#l11.64"></a><span id="l11.64" class="difflineplus">+         [&quot;JobTitle&quot;, &quot;JobTitle&quot;],</span>
<a href="#l11.65"></a><span id="l11.65" class="difflineplus">+         [&quot;Department&quot;, &quot;Department&quot;],</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineplus">+         [&quot;Company&quot;, &quot;Company&quot;],</span>
<a href="#l11.67"></a><span id="l11.67" class="difflineplus">+         [&quot;WorkAddress&quot;, &quot;WorkAddress&quot;],</span>
<a href="#l11.68"></a><span id="l11.68" class="difflineplus">+         [&quot;WorkAddress2&quot;, &quot;WorkAddress2&quot;],</span>
<a href="#l11.69"></a><span id="l11.69" class="difflineplus">+         [&quot;WorkCity&quot;, &quot;WorkCity&quot;],</span>
<a href="#l11.70"></a><span id="l11.70" class="difflineplus">+         [&quot;WorkState&quot;, &quot;WorkState&quot;],</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineplus">+         [&quot;WorkZipCode&quot;, &quot;WorkZipCode&quot;],</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineplus">+         [&quot;WorkCountry&quot;, &quot;WorkCountry&quot;],</span>
<a href="#l11.73"></a><span id="l11.73" class="difflineplus">+         [&quot;WebPage1&quot;, &quot;WebPage1&quot;],</span>
<a href="#l11.74"></a><span id="l11.74">           // Other &gt; (custom)</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineminus">-         [&quot;Custom1&quot;, &quot;custom1&quot;],</span>
<a href="#l11.76"></a><span id="l11.76" class="difflineminus">-         [&quot;Custom2&quot;, &quot;custom2&quot;],</span>
<a href="#l11.77"></a><span id="l11.77" class="difflineminus">-         [&quot;Custom3&quot;, &quot;custom3&quot;],</span>
<a href="#l11.78"></a><span id="l11.78" class="difflineminus">-         [&quot;Custom4&quot;, &quot;custom4&quot;],</span>
<a href="#l11.79"></a><span id="l11.79" class="difflineplus">+         [&quot;Custom1&quot;, &quot;Custom1&quot;],</span>
<a href="#l11.80"></a><span id="l11.80" class="difflineplus">+         [&quot;Custom2&quot;, &quot;Custom2&quot;],</span>
<a href="#l11.81"></a><span id="l11.81" class="difflineplus">+         [&quot;Custom3&quot;, &quot;Custom3&quot;],</span>
<a href="#l11.82"></a><span id="l11.82" class="difflineplus">+         [&quot;Custom4&quot;, &quot;Custom4&quot;],</span>
<a href="#l11.83"></a><span id="l11.83">           // Other &gt; Notes</span>
<a href="#l11.84"></a><span id="l11.84" class="difflineminus">-         [&quot;Notes&quot;, &quot;notes&quot;]];</span>
<a href="#l11.85"></a><span id="l11.85" class="difflineplus">+         [&quot;Notes&quot;, &quot;Notes&quot;]];</span>
<a href="#l11.86"></a><span id="l11.86"> </span>
<a href="#l11.87"></a><span id="l11.87"> var gEditCard;</span>
<a href="#l11.88"></a><span id="l11.88"> var gOnSaveListeners = new Array();</span>
<a href="#l11.89"></a><span id="l11.89"> var gOkCallback = null;</span>
<a href="#l11.90"></a><span id="l11.90"> var gHideABPicker = false;</span>
<a href="#l11.91"></a><span id="l11.91"> </span>
<a href="#l11.92"></a><span id="l11.92"> function OnLoadNewCard()</span>
<a href="#l11.93"></a><span id="l11.93"> {</span>
<a href="#l11.94"></a><span id="l11.94" class="difflineat">@@ -132,22 +132,22 @@ function OnLoadNewCard()</span>
<a href="#l11.95"></a><span id="l11.95">       gEditCard.card.displayName = window.arguments[0].displayName;</span>
<a href="#l11.96"></a><span id="l11.96">       // if we've got a display name, don't generate</span>
<a href="#l11.97"></a><span id="l11.97">       // a display name (and stomp on the existing display name)</span>
<a href="#l11.98"></a><span id="l11.98">       // when the user types a first or last name</span>
<a href="#l11.99"></a><span id="l11.99">       if (gEditCard.card.displayName.length)</span>
<a href="#l11.100"></a><span id="l11.100">         gEditCard.generateDisplayName = false;</span>
<a href="#l11.101"></a><span id="l11.101">     }</span>
<a href="#l11.102"></a><span id="l11.102">     if (&quot;aimScreenName&quot; in window.arguments[0])</span>
<a href="#l11.103"></a><span id="l11.103" class="difflineminus">-      gEditCard.card.aimScreenName = window.arguments[0].aimScreenName;</span>
<a href="#l11.104"></a><span id="l11.104" class="difflineplus">+      gEditCard.card.setProperty(&quot;_AimScreenName&quot;,</span>
<a href="#l11.105"></a><span id="l11.105" class="difflineplus">+                                 window.arguments[0].aimScreenName);</span>
<a href="#l11.106"></a><span id="l11.106">     </span>
<a href="#l11.107"></a><span id="l11.107" class="difflineminus">-    if (&quot;allowRemoteContent&quot; in window.arguments[0]) {</span>
<a href="#l11.108"></a><span id="l11.108" class="difflineminus">-      gEditCard.card.allowRemoteContent = window.arguments[0].allowRemoteContent;</span>
<a href="#l11.109"></a><span id="l11.109" class="difflineminus">-      window.arguments[0].allowRemoteContent = false;</span>
<a href="#l11.110"></a><span id="l11.110" class="difflineminus">-    }</span>
<a href="#l11.111"></a><span id="l11.111" class="difflineplus">+    if (&quot;allowRemoteContent&quot; in window.arguments[0])</span>
<a href="#l11.112"></a><span id="l11.112" class="difflineplus">+      gEditCard.card.setProperty(&quot;AllowRemoteContent&quot;,</span>
<a href="#l11.113"></a><span id="l11.113" class="difflineplus">+                                 window.arguments[0].allowRemoteContent);</span>
<a href="#l11.114"></a><span id="l11.114"> </span>
<a href="#l11.115"></a><span id="l11.115">     if (&quot;okCallback&quot; in window.arguments[0])</span>
<a href="#l11.116"></a><span id="l11.116">       gOkCallback = window.arguments[0].okCallback;</span>
<a href="#l11.117"></a><span id="l11.117"> </span>
<a href="#l11.118"></a><span id="l11.118">     if (&quot;escapedVCardStr&quot; in window.arguments[0]) {</span>
<a href="#l11.119"></a><span id="l11.119">       // hide non vcard values</span>
<a href="#l11.120"></a><span id="l11.120">       HideNonVcardFields();</span>
<a href="#l11.121"></a><span id="l11.121">       gEditCard.card =</span>
<a href="#l11.122"></a><span id="l11.122" class="difflineat">@@ -363,17 +363,17 @@ function InitEditCard()</span>
<a href="#l11.123"></a><span id="l11.123"> </span>
<a href="#l11.124"></a><span id="l11.124"> function NewCardOKButton()</span>
<a href="#l11.125"></a><span id="l11.125"> {</span>
<a href="#l11.126"></a><span id="l11.126">   if (gOkCallback)</span>
<a href="#l11.127"></a><span id="l11.127">   {</span>
<a href="#l11.128"></a><span id="l11.128">     if (!CheckAndSetCardValues(gEditCard.card, document, true))</span>
<a href="#l11.129"></a><span id="l11.129">       return false;  // don't close window</span>
<a href="#l11.130"></a><span id="l11.130"> </span>
<a href="#l11.131"></a><span id="l11.131" class="difflineminus">-    gOkCallback(gEditCard.card.convertToEscapedVCard());</span>
<a href="#l11.132"></a><span id="l11.132" class="difflineplus">+    gOkCallback(gEditCard.card.translateTo(&quot;vcard&quot;));</span>
<a href="#l11.133"></a><span id="l11.133">     return true;  // close the window</span>
<a href="#l11.134"></a><span id="l11.134">   }</span>
<a href="#l11.135"></a><span id="l11.135"> </span>
<a href="#l11.136"></a><span id="l11.136">   var popup = document.getElementById('abPopup');</span>
<a href="#l11.137"></a><span id="l11.137">   if ( popup )</span>
<a href="#l11.138"></a><span id="l11.138">   {</span>
<a href="#l11.139"></a><span id="l11.139">     var uri = popup.getAttribute('value');</span>
<a href="#l11.140"></a><span id="l11.140"> </span>
<a href="#l11.141"></a><span id="l11.141" class="difflineat">@@ -389,45 +389,47 @@ function NewCardOKButton()</span>
<a href="#l11.142"></a><span id="l11.142">         return false;  // don't close window</span>
<a href="#l11.143"></a><span id="l11.143"> </span>
<a href="#l11.144"></a><span id="l11.144">       // replace gEditCard.card with the card we added</span>
<a href="#l11.145"></a><span id="l11.145">       // so that save listeners can get / set attributes on</span>
<a href="#l11.146"></a><span id="l11.146">       // the card that got created.</span>
<a href="#l11.147"></a><span id="l11.147">       gEditCard.card = GetDirectoryFromURI(uri).addCard(gEditCard.card);</span>
<a href="#l11.148"></a><span id="l11.148">       NotifySaveListeners();</span>
<a href="#l11.149"></a><span id="l11.149">       if (&quot;arguments&quot; in window &amp;&amp; window.arguments[0])</span>
<a href="#l11.150"></a><span id="l11.150" class="difflineminus">-        window.arguments[0].allowRemoteContent = gEditCard.card.allowRemoteContent;</span>
<a href="#l11.151"></a><span id="l11.151" class="difflineplus">+        window.arguments[0].allowRemoteContent =</span>
<a href="#l11.152"></a><span id="l11.152" class="difflineplus">+          gEditCard.card.getProperty(&quot;AllowRemoteContent&quot;, false));</span>
<a href="#l11.153"></a><span id="l11.153">     }</span>
<a href="#l11.154"></a><span id="l11.154">   }</span>
<a href="#l11.155"></a><span id="l11.155"> </span>
<a href="#l11.156"></a><span id="l11.156">   return true;  // close the window</span>
<a href="#l11.157"></a><span id="l11.157"> }</span>
<a href="#l11.158"></a><span id="l11.158"> </span>
<a href="#l11.159"></a><span id="l11.159"> // Move the data from the cardproperty to the dialog</span>
<a href="#l11.160"></a><span id="l11.160"> function GetCardValues(cardproperty, doc)</span>
<a href="#l11.161"></a><span id="l11.161"> {</span>
<a href="#l11.162"></a><span id="l11.162">   if (!cardproperty)</span>
<a href="#l11.163"></a><span id="l11.163">     return;</span>
<a href="#l11.164"></a><span id="l11.164"> </span>
<a href="#l11.165"></a><span id="l11.165" class="difflineminus">-  for (var i = kVcardFields.length; i-- &gt; 0; )</span>
<a href="#l11.166"></a><span id="l11.166" class="difflineplus">+  for (var i = kVcardFields.length; i-- &gt; 0; ) {</span>
<a href="#l11.167"></a><span id="l11.167">     doc.getElementById(kVcardFields[i][0]).value =</span>
<a href="#l11.168"></a><span id="l11.168" class="difflineminus">-      cardproperty[kVcardFields[i][1]];</span>
<a href="#l11.169"></a><span id="l11.169" class="difflineplus">+      cardproperty.getProperty(kVcardFields[i][1], &quot;&quot;);</span>
<a href="#l11.170"></a><span id="l11.170" class="difflineplus">+  }</span>
<a href="#l11.171"></a><span id="l11.171"> </span>
<a href="#l11.172"></a><span id="l11.172">   var popup = document.getElementById(&quot;PreferMailFormatPopup&quot;);</span>
<a href="#l11.173"></a><span id="l11.173">   if (popup)</span>
<a href="#l11.174"></a><span id="l11.174" class="difflineminus">-    popup.value = cardproperty.preferMailFormat;</span>
<a href="#l11.175"></a><span id="l11.175" class="difflineplus">+    popup.value = cardproperty.getProperty(&quot;PreferMailFormat&quot;, &quot;&quot;);</span>
<a href="#l11.176"></a><span id="l11.176">     </span>
<a href="#l11.177"></a><span id="l11.177">   var allowRemoteContentEl = document.getElementById(&quot;allowRemoteContent&quot;);</span>
<a href="#l11.178"></a><span id="l11.178">   if (allowRemoteContentEl)</span>
<a href="#l11.179"></a><span id="l11.179" class="difflineminus">-    allowRemoteContentEl.checked = cardproperty.allowRemoteContent;</span>
<a href="#l11.180"></a><span id="l11.180" class="difflineplus">+    allowRemoteContentEl.checked = cardproperty.getProperty(&quot;AllowRemoteContent&quot;, false);</span>
<a href="#l11.181"></a><span id="l11.181"> </span>
<a href="#l11.182"></a><span id="l11.182">   // get phonetic fields if exist</span>
<a href="#l11.183"></a><span id="l11.183">   try {</span>
<a href="#l11.184"></a><span id="l11.184" class="difflineminus">-    doc.getElementById(&quot;PhoneticFirstName&quot;).value = cardproperty.phoneticFirstName;</span>
<a href="#l11.185"></a><span id="l11.185" class="difflineminus">-    doc.getElementById(&quot;PhoneticLastName&quot;).value = cardproperty.phoneticLastName;</span>
<a href="#l11.186"></a><span id="l11.186" class="difflineplus">+    doc.getElementById(&quot;PhoneticFirstName&quot;).value = cardproperty.getProperty(&quot;PhoneticFirstName&quot;, &quot;&quot;);</span>
<a href="#l11.187"></a><span id="l11.187" class="difflineplus">+    doc.getElementById(&quot;PhoneticLastName&quot;).value = cardproperty.getProperty(&quot;PhoneticLastName&quot;, &quot;&quot;);</span>
<a href="#l11.188"></a><span id="l11.188">   }</span>
<a href="#l11.189"></a><span id="l11.189">   catch (ex) {}</span>
<a href="#l11.190"></a><span id="l11.190"> }</span>
<a href="#l11.191"></a><span id="l11.191"> </span>
<a href="#l11.192"></a><span id="l11.192"> // when the ab card dialog is being loaded to show a vCard,</span>
<a href="#l11.193"></a><span id="l11.193"> // hide the fields which aren't supported</span>
<a href="#l11.194"></a><span id="l11.194"> // by vCard so the user does not try to edit them.</span>
<a href="#l11.195"></a><span id="l11.195"> function HideNonVcardFields()</span>
<a href="#l11.196"></a><span id="l11.196" class="difflineat">@@ -444,31 +446,31 @@ function CheckAndSetCardValues(cardprope</span>
<a href="#l11.197"></a><span id="l11.197">   // If requested, check the required data presence.</span>
<a href="#l11.198"></a><span id="l11.198">   if (check &amp;&amp; !CheckCardRequiredDataPresence(document))</span>
<a href="#l11.199"></a><span id="l11.199">     return false;</span>
<a href="#l11.200"></a><span id="l11.200"> </span>
<a href="#l11.201"></a><span id="l11.201">   if (!cardproperty)</span>
<a href="#l11.202"></a><span id="l11.202">     return true;</span>
<a href="#l11.203"></a><span id="l11.203"> </span>
<a href="#l11.204"></a><span id="l11.204">   for (var i = kVcardFields.length; i-- &gt; 0; )</span>
<a href="#l11.205"></a><span id="l11.205" class="difflineminus">-    cardproperty[kVcardFields[i][1]] =</span>
<a href="#l11.206"></a><span id="l11.206" class="difflineminus">-      doc.getElementById(kVcardFields[i][0]).value;</span>
<a href="#l11.207"></a><span id="l11.207" class="difflineplus">+    cardproperty.setProperty(kVcardFields[i][1],</span>
<a href="#l11.208"></a><span id="l11.208" class="difflineplus">+      doc.getElementById(kVcardFields[i][0]).value);</span>
<a href="#l11.209"></a><span id="l11.209"> </span>
<a href="#l11.210"></a><span id="l11.210">   var popup = document.getElementById(&quot;PreferMailFormatPopup&quot;);</span>
<a href="#l11.211"></a><span id="l11.211">   if (popup)</span>
<a href="#l11.212"></a><span id="l11.212" class="difflineminus">-    cardproperty.preferMailFormat = popup.value;</span>
<a href="#l11.213"></a><span id="l11.213" class="difflineplus">+    cardproperty.setProperty(&quot;PreferMailFormat&quot;, popup.value);</span>
<a href="#l11.214"></a><span id="l11.214">     </span>
<a href="#l11.215"></a><span id="l11.215">   var allowRemoteContentEl = document.getElementById(&quot;allowRemoteContent&quot;);</span>
<a href="#l11.216"></a><span id="l11.216">   if (allowRemoteContentEl)</span>
<a href="#l11.217"></a><span id="l11.217" class="difflineminus">-    cardproperty.allowRemoteContent = allowRemoteContentEl.checked;    </span>
<a href="#l11.218"></a><span id="l11.218" class="difflineplus">+    cardproperty.setProperty(&quot;AllowRemoteContent&quot;, allowRemoteContentEl.checked);</span>
<a href="#l11.219"></a><span id="l11.219"> </span>
<a href="#l11.220"></a><span id="l11.220">   // set phonetic fields if exist</span>
<a href="#l11.221"></a><span id="l11.221">   try {</span>
<a href="#l11.222"></a><span id="l11.222" class="difflineminus">-    cardproperty.phoneticFirstName = doc.getElementById(&quot;PhoneticFirstName&quot;).value;</span>
<a href="#l11.223"></a><span id="l11.223" class="difflineminus">-    cardproperty.phoneticLastName = doc.getElementById(&quot;PhoneticLastName&quot;).value;</span>
<a href="#l11.224"></a><span id="l11.224" class="difflineplus">+    cardproperty.setProperty(&quot;PhoneticFirstName&quot;, doc.getElementById(&quot;PhoneticFirstName&quot;).value);</span>
<a href="#l11.225"></a><span id="l11.225" class="difflineplus">+    cardproperty.setProperty(&quot;PhoneticLastName&quot;, doc.getElementById(&quot;PhoneticLastName&quot;).value);</span>
<a href="#l11.226"></a><span id="l11.226">   }</span>
<a href="#l11.227"></a><span id="l11.227">   catch (ex) {}</span>
<a href="#l11.228"></a><span id="l11.228"> </span>
<a href="#l11.229"></a><span id="l11.229">   return true;</span>
<a href="#l11.230"></a><span id="l11.230"> }</span>
<a href="#l11.231"></a><span id="l11.231"> </span>
<a href="#l11.232"></a><span id="l11.232"> function CleanUpWebPage(webPage)</span>
<a href="#l11.233"></a><span id="l11.233"> {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/addrbook/resources/content/abCardViewOverlay.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/addrbook/resources/content/abCardViewOverlay.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -185,37 +185,45 @@ function GetAddressesFromURI(uri)</span>
<a href="#l12.4"></a><span id="l12.4">   return addresses;</span>
<a href="#l12.5"></a><span id="l12.5"> }</span>
<a href="#l12.6"></a><span id="l12.6"> </span>
<a href="#l12.7"></a><span id="l12.7"> function GoIM()</span>
<a href="#l12.8"></a><span id="l12.8"> {</span>
<a href="#l12.9"></a><span id="l12.9">   LaunchUrl(top.cvData.cvAimPresence.getAttribute(&quot;url&quot;));</span>
<a href="#l12.10"></a><span id="l12.10"> }</span>
<a href="#l12.11"></a><span id="l12.11"> </span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-function DisplayCardViewPane(card)</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+function DisplayCardViewPane(realCard)</span>
<a href="#l12.14"></a><span id="l12.14"> {</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineminus">-  var generatedName = card.generateName(gPrefs.getIntPref(&quot;mail.addr_book.lastnamefirst&quot;));</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineplus">+  var generatedName = realCard.generateName(gPrefs.getIntPref(&quot;mail.addr_book.lastnamefirst&quot;));</span>
<a href="#l12.17"></a><span id="l12.17"> 		</span>
<a href="#l12.18"></a><span id="l12.18">   var data = top.cvData;</span>
<a href="#l12.19"></a><span id="l12.19">   var visible;</span>
<a href="#l12.20"></a><span id="l12.20"> </span>
<a href="#l12.21"></a><span id="l12.21" class="difflineplus">+  var card = { getProperty : function (prop) {</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineplus">+                 return realCard.getProperty(prop, &quot;&quot;);</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineplus">+               },</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineplus">+               primaryEmail : realCard.primaryEmail,</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineplus">+               displayName : realCard.displayName,</span>
<a href="#l12.26"></a><span id="l12.26" class="difflineplus">+               isMailList : realCard.isMailList,</span>
<a href="#l12.27"></a><span id="l12.27" class="difflineplus">+               mailListURI : realCard.mailListURI</span>
<a href="#l12.28"></a><span id="l12.28" class="difflineplus">+  };</span>
<a href="#l12.29"></a><span id="l12.29">   var titleString;</span>
<a href="#l12.30"></a><span id="l12.30">   if (generatedName == &quot;&quot;)</span>
<a href="#l12.31"></a><span id="l12.31">     titleString = card.primaryEmail;  // if no generatedName, use email</span>
<a href="#l12.32"></a><span id="l12.32">   else</span>
<a href="#l12.33"></a><span id="l12.33">     titleString = generatedName;</span>
<a href="#l12.34"></a><span id="l12.34"> </span>
<a href="#l12.35"></a><span id="l12.35">   // set fields in card view pane</span>
<a href="#l12.36"></a><span id="l12.36">   if (card.isMailList)</span>
<a href="#l12.37"></a><span id="l12.37">     cvSetNode(data.CardTitle, gAddressBookBundle.getFormattedString(&quot;viewListTitle&quot;, [generatedName]));</span>
<a href="#l12.38"></a><span id="l12.38">   else</span>
<a href="#l12.39"></a><span id="l12.39">     cvSetNode(data.CardTitle, gAddressBookBundle.getFormattedString(&quot;viewCardTitle&quot;, [titleString]));</span>
<a href="#l12.40"></a><span id="l12.40"> 	</span>
<a href="#l12.41"></a><span id="l12.41">   // Contact section</span>
<a href="#l12.42"></a><span id="l12.42" class="difflineminus">-  cvSetNodeWithLabel(data.cvNickname, zNickname, card.nickName);</span>
<a href="#l12.43"></a><span id="l12.43" class="difflineplus">+  cvSetNodeWithLabel(data.cvNickname, zNickname, card.getProperty(&quot;NickName&quot;));</span>
<a href="#l12.44"></a><span id="l12.44"> </span>
<a href="#l12.45"></a><span id="l12.45">   if (card.isMailList) {</span>
<a href="#l12.46"></a><span id="l12.46">     // email1, display name and screenname always hidden when a mailing list.</span>
<a href="#l12.47"></a><span id="l12.47">     cvSetVisible(data.cvDisplayName, false);</span>
<a href="#l12.48"></a><span id="l12.48">     cvSetVisible(data.cvEmail1Box, false);</span>
<a href="#l12.49"></a><span id="l12.49">     cvSetVisible(data.cvScreennameBox, false);</span>
<a href="#l12.50"></a><span id="l12.50"> </span>
<a href="#l12.51"></a><span id="l12.51">     visible = HandleLink(data.cvListName, zListName, card.displayName, data.cvListNameBox, &quot;mailto:&quot; + encodeURIComponent(GenerateAddressFromCard(card))) || visible;</span>
<a href="#l12.52"></a><span id="l12.52" class="difflineat">@@ -225,121 +233,121 @@ function DisplayCardViewPane(card)</span>
<a href="#l12.53"></a><span id="l12.53">     cvSetVisible(data.cvListNameBox, false);</span>
<a href="#l12.54"></a><span id="l12.54"> </span>
<a href="#l12.55"></a><span id="l12.55">     cvSetNodeWithLabel(data.cvDisplayName, zDisplayName, card.displayName);</span>
<a href="#l12.56"></a><span id="l12.56"> </span>
<a href="#l12.57"></a><span id="l12.57">     visible = HandleLink(data.cvEmail1, zPrimaryEmail, card.primaryEmail, data.cvEmail1Box, &quot;mailto:&quot; + card.primaryEmail) || visible;</span>
<a href="#l12.58"></a><span id="l12.58">   }</span>
<a href="#l12.59"></a><span id="l12.59"> </span>
<a href="#l12.60"></a><span id="l12.60">   var onlineCheckAllowed = gPrefs.getBoolPref(&quot;mail.addr_book.im.onlineCheckAllowed&quot;);</span>
<a href="#l12.61"></a><span id="l12.61" class="difflineminus">-  var goimURL = &quot;aim:goim?screenname=&quot; + card.aimScreenName;</span>
<a href="#l12.62"></a><span id="l12.62" class="difflineminus">-  var hasScreenName = HandleLink(data.cvScreenname, zScreenName, card.aimScreenName, data.cvScreennameBox, goimURL);</span>
<a href="#l12.63"></a><span id="l12.63" class="difflineplus">+  var goimURL = &quot;aim:goim?screenname=&quot; + card.getProperty(&quot;_AimScreenName&quot;);</span>
<a href="#l12.64"></a><span id="l12.64" class="difflineplus">+  var hasScreenName = HandleLink(data.cvScreenname, zScreenName, card.getProperty(&quot;_AimScreenName&quot;), data.cvScreennameBox, goimURL);</span>
<a href="#l12.65"></a><span id="l12.65"> </span>
<a href="#l12.66"></a><span id="l12.66">   if (!onlineCheckAllowed || !hasScreenName || gIOService.offline) {</span>
<a href="#l12.67"></a><span id="l12.67">     data.cvAimPresence.removeAttribute(&quot;src&quot;);</span>
<a href="#l12.68"></a><span id="l12.68">     data.cvAimPresence.removeAttribute(&quot;url&quot;);</span>
<a href="#l12.69"></a><span id="l12.69">     data.cvAimPresence.setAttribute(&quot;width&quot;,&quot;0&quot;);</span>
<a href="#l12.70"></a><span id="l12.70">   }</span>
<a href="#l12.71"></a><span id="l12.71">   else {</span>
<a href="#l12.72"></a><span id="l12.72" class="difflineminus">-    data.cvAimPresence.setAttribute(&quot;src&quot;,&quot;http://big.oscar.aol.com:80/&quot; + card.aimScreenName + &quot;?on_url=http://ncmail.netscape.com/include/nc/images/online.gif&amp;off_url=http://ncmail.netscape.com/include/nc/images/offline.gif&quot;);   </span>
<a href="#l12.73"></a><span id="l12.73" class="difflineplus">+    data.cvAimPresence.setAttribute(&quot;src&quot;,&quot;http://big.oscar.aol.com:80/&quot; + card.getProperty(&quot;_AimScreenName&quot;) + &quot;?on_url=http://ncmail.netscape.com/include/nc/images/online.gif&amp;off_url=http://ncmail.netscape.com/include/nc/images/offline.gif&quot;);   </span>
<a href="#l12.74"></a><span id="l12.74">     data.cvAimPresence.setAttribute(&quot;url&quot;, goimURL);</span>
<a href="#l12.75"></a><span id="l12.75">     data.cvAimPresence.setAttribute(&quot;width&quot;,&quot;16&quot;);</span>
<a href="#l12.76"></a><span id="l12.76">   }</span>
<a href="#l12.77"></a><span id="l12.77"> </span>
<a href="#l12.78"></a><span id="l12.78">   visible = hasScreenName || visible;</span>
<a href="#l12.79"></a><span id="l12.79" class="difflineminus">-  visible = HandleLink(data.cvEmail2, zSecondaryEmail, card.secondEmail, data.cvEmail2Box, &quot;mailto:&quot; + card.secondEmail) || visible;</span>
<a href="#l12.80"></a><span id="l12.80" class="difflineplus">+  visible = HandleLink(data.cvEmail2, zSecondaryEmail, card.getProperty(&quot;SecondEmail&quot;), data.cvEmail2Box, &quot;mailto:&quot; + card.getProperty(&quot;SecondEmail&quot;)) || visible;</span>
<a href="#l12.81"></a><span id="l12.81"> </span>
<a href="#l12.82"></a><span id="l12.82"> 	// Home section</span>
<a href="#l12.83"></a><span id="l12.83" class="difflineminus">-	visible = cvSetNode(data.cvHomeAddress, card.homeAddress);</span>
<a href="#l12.84"></a><span id="l12.84" class="difflineminus">-	visible = cvSetNode(data.cvHomeAddress2, card.homeAddress2) || visible;</span>
<a href="#l12.85"></a><span id="l12.85" class="difflineminus">-	visible = cvSetCityStateZip(data.cvHomeCityStZip, card.homeCity, card.homeState, card.homeZipCode) || visible;</span>
<a href="#l12.86"></a><span id="l12.86" class="difflineminus">-	visible = cvSetNode(data.cvHomeCountry, card.homeCountry) || visible;</span>
<a href="#l12.87"></a><span id="l12.87" class="difflineplus">+	visible = cvSetNode(data.cvHomeAddress, card.getProperty(&quot;HomeAddress&quot;));</span>
<a href="#l12.88"></a><span id="l12.88" class="difflineplus">+	visible = cvSetNode(data.cvHomeAddress2, card.getProperty(&quot;HomeAddress2&quot;)) || visible;</span>
<a href="#l12.89"></a><span id="l12.89" class="difflineplus">+	visible = cvSetCityStateZip(data.cvHomeCityStZip, card.getProperty(&quot;HomeCity&quot;), card.getProperty(&quot;HomeState&quot;), card.getProperty(&quot;HomeZipCode&quot;)) || visible;</span>
<a href="#l12.90"></a><span id="l12.90" class="difflineplus">+	visible = cvSetNode(data.cvHomeCountry, card.getProperty(&quot;HomeCountry&quot;)) || visible;</span>
<a href="#l12.91"></a><span id="l12.91">         if (visible) {</span>
<a href="#l12.92"></a><span id="l12.92" class="difflineminus">-          var homeMapItUrl = CreateMapItURL(card.homeAddress, card.homeAddress2, card.homeCity, card.homeState, card.homeZipCode, card.homeCountry);</span>
<a href="#l12.93"></a><span id="l12.93" class="difflineplus">+          var homeMapItUrl = CreateMapItURL(card.getProperty(&quot;HomeAddress&quot;), card.getProperty(&quot;HomeAddress2&quot;), card.getProperty(&quot;HomeCity&quot;), card.getProperty(&quot;HomeState&quot;), card.getProperty(&quot;HomeZipCode&quot;), card.getProperty(&quot;HomeCountry&quot;));</span>
<a href="#l12.94"></a><span id="l12.94">           if (homeMapItUrl) {</span>
<a href="#l12.95"></a><span id="l12.95"> 	    cvSetVisible(data.cvbHomeMapItBox, true);</span>
<a href="#l12.96"></a><span id="l12.96">             data.cvHomeMapIt.setAttribute('url', homeMapItUrl);</span>
<a href="#l12.97"></a><span id="l12.97">           }</span>
<a href="#l12.98"></a><span id="l12.98">           else {</span>
<a href="#l12.99"></a><span id="l12.99"> 	    cvSetVisible(data.cvbHomeMapItBox, false);</span>
<a href="#l12.100"></a><span id="l12.100">           }</span>
<a href="#l12.101"></a><span id="l12.101">         }</span>
<a href="#l12.102"></a><span id="l12.102">         else {</span>
<a href="#l12.103"></a><span id="l12.103"> 	  cvSetVisible(data.cvbHomeMapItBox, false);</span>
<a href="#l12.104"></a><span id="l12.104">         }</span>
<a href="#l12.105"></a><span id="l12.105"> </span>
<a href="#l12.106"></a><span id="l12.106" class="difflineminus">-  visible = HandleLink(data.cvHomeWebPage, &quot;&quot;, card.webPage2, data.cvHomeWebPageBox, card.webPage2) || visible;</span>
<a href="#l12.107"></a><span id="l12.107" class="difflineplus">+  visible = HandleLink(data.cvHomeWebPage, &quot;&quot;, card.getProperty(&quot;WebPage2&quot;), data.cvHomeWebPageBox, card.getProperty(&quot;WebPage2&quot;)) || visible;</span>
<a href="#l12.108"></a><span id="l12.108"> </span>
<a href="#l12.109"></a><span id="l12.109"> 	cvSetVisible(data.cvhHome, visible);</span>
<a href="#l12.110"></a><span id="l12.110"> 	cvSetVisible(data.cvbHome, visible);</span>
<a href="#l12.111"></a><span id="l12.111">   if (card.isMailList) {</span>
<a href="#l12.112"></a><span id="l12.112">     // Description section</span>
<a href="#l12.113"></a><span id="l12.113" class="difflineminus">-	  visible = cvSetNode(data.cvDescription, card.notes)</span>
<a href="#l12.114"></a><span id="l12.114" class="difflineplus">+	  visible = cvSetNode(data.cvDescription, card.getProperty(&quot;Notes&quot;))</span>
<a href="#l12.115"></a><span id="l12.115">   	cvSetVisible(data.cvbDescription, visible);</span>
<a href="#l12.116"></a><span id="l12.116"> </span>
<a href="#l12.117"></a><span id="l12.117">     // Addresses section</span>
<a href="#l12.118"></a><span id="l12.118"> 	  visible = cvAddAddressNodes(data.cvAddresses, card.mailListURI);</span>
<a href="#l12.119"></a><span id="l12.119">   	cvSetVisible(data.cvbAddresses, visible);</span>
<a href="#l12.120"></a><span id="l12.120">  </span>
<a href="#l12.121"></a><span id="l12.121">     // Other section, not shown for mailing lists.</span>
<a href="#l12.122"></a><span id="l12.122">     cvSetVisible(data.cvbOther, false);</span>
<a href="#l12.123"></a><span id="l12.123">   }</span>
<a href="#l12.124"></a><span id="l12.124">   else {</span>
<a href="#l12.125"></a><span id="l12.125"> 	  // Other section</span>
<a href="#l12.126"></a><span id="l12.126" class="difflineminus">-	  visible = cvSetNodeWithLabel(data.cvCustom1, zCustom1, card.custom1);</span>
<a href="#l12.127"></a><span id="l12.127" class="difflineminus">-	  visible = cvSetNodeWithLabel(data.cvCustom2, zCustom2, card.custom2) || visible;</span>
<a href="#l12.128"></a><span id="l12.128" class="difflineminus">-	  visible = cvSetNodeWithLabel(data.cvCustom3, zCustom3, card.custom3) || visible;</span>
<a href="#l12.129"></a><span id="l12.129" class="difflineminus">-	  visible = cvSetNodeWithLabel(data.cvCustom4, zCustom4, card.custom4) || visible;</span>
<a href="#l12.130"></a><span id="l12.130" class="difflineminus">-	  visible = cvSetNode(data.cvNotes, card.notes) || visible;</span>
<a href="#l12.131"></a><span id="l12.131" class="difflineplus">+	  visible = cvSetNodeWithLabel(data.cvCustom1, zCustom1, card.getProperty(&quot;Custom1&quot;));</span>
<a href="#l12.132"></a><span id="l12.132" class="difflineplus">+	  visible = cvSetNodeWithLabel(data.cvCustom2, zCustom2, card.getProperty(&quot;Custom2&quot;)) || visible;</span>
<a href="#l12.133"></a><span id="l12.133" class="difflineplus">+	  visible = cvSetNodeWithLabel(data.cvCustom3, zCustom3, card.getProperty(&quot;Custom3&quot;)) || visible;</span>
<a href="#l12.134"></a><span id="l12.134" class="difflineplus">+	  visible = cvSetNodeWithLabel(data.cvCustom4, zCustom4, card.getProperty(&quot;Custom4&quot;)) || visible;</span>
<a href="#l12.135"></a><span id="l12.135" class="difflineplus">+	  visible = cvSetNode(data.cvNotes, card.getProperty(&quot;Notes&quot;)) || visible;</span>
<a href="#l12.136"></a><span id="l12.136">     visible = setBuddyIcon(card, data.cvBuddyIcon) || visible;</span>
<a href="#l12.137"></a><span id="l12.137"> </span>
<a href="#l12.138"></a><span id="l12.138">     cvSetVisible(data.cvhOther, visible);</span>
<a href="#l12.139"></a><span id="l12.139">     cvSetVisible(data.cvbOther, visible);</span>
<a href="#l12.140"></a><span id="l12.140"> </span>
<a href="#l12.141"></a><span id="l12.141">     // hide description section, not show for non-mailing lists</span>
<a href="#l12.142"></a><span id="l12.142">     cvSetVisible(data.cvbDescription, false);</span>
<a href="#l12.143"></a><span id="l12.143"> </span>
<a href="#l12.144"></a><span id="l12.144">     // hide addresses section, not show for non-mailing lists</span>
<a href="#l12.145"></a><span id="l12.145">     cvSetVisible(data.cvbAddresses, false);</span>
<a href="#l12.146"></a><span id="l12.146">   }</span>
<a href="#l12.147"></a><span id="l12.147"> </span>
<a href="#l12.148"></a><span id="l12.148"> 	// Phone section</span>
<a href="#l12.149"></a><span id="l12.149" class="difflineminus">-	visible = cvSetNodeWithLabel(data.cvPhWork, zWork, card.workPhone);</span>
<a href="#l12.150"></a><span id="l12.150" class="difflineminus">-	visible = cvSetNodeWithLabel(data.cvPhHome, zHome, card.homePhone) || visible;</span>
<a href="#l12.151"></a><span id="l12.151" class="difflineminus">-	visible = cvSetNodeWithLabel(data.cvPhFax, zFax, card.faxNumber) || visible;</span>
<a href="#l12.152"></a><span id="l12.152" class="difflineminus">-	visible = cvSetNodeWithLabel(data.cvPhCellular, zCellular, card.cellularNumber) || visible;</span>
<a href="#l12.153"></a><span id="l12.153" class="difflineminus">-	visible = cvSetNodeWithLabel(data.cvPhPager, zPager, card.pagerNumber) || visible;</span>
<a href="#l12.154"></a><span id="l12.154" class="difflineplus">+	visible = cvSetNodeWithLabel(data.cvPhWork, zWork, card.getProperty(&quot;WorkPhone&quot;));</span>
<a href="#l12.155"></a><span id="l12.155" class="difflineplus">+	visible = cvSetNodeWithLabel(data.cvPhHome, zHome, card.getProperty(&quot;HomePhone&quot;)) || visible;</span>
<a href="#l12.156"></a><span id="l12.156" class="difflineplus">+	visible = cvSetNodeWithLabel(data.cvPhFax, zFax, card.getProperty(&quot;FaxNumber&quot;)) || visible;</span>
<a href="#l12.157"></a><span id="l12.157" class="difflineplus">+	visible = cvSetNodeWithLabel(data.cvPhCellular, zCellular, card.getProperty(&quot;CellularNumber&quot;)) || visible;</span>
<a href="#l12.158"></a><span id="l12.158" class="difflineplus">+	visible = cvSetNodeWithLabel(data.cvPhPager, zPager, card.getProperty(&quot;PagerNumber&quot;)) || visible;</span>
<a href="#l12.159"></a><span id="l12.159"> 	cvSetVisible(data.cvhPhone, visible);</span>
<a href="#l12.160"></a><span id="l12.160"> 	cvSetVisible(data.cvbPhone, visible);</span>
<a href="#l12.161"></a><span id="l12.161"> 	// Work section</span>
<a href="#l12.162"></a><span id="l12.162" class="difflineminus">-	visible = cvSetNode(data.cvJobTitle, card.jobTitle);</span>
<a href="#l12.163"></a><span id="l12.163" class="difflineminus">-	visible = cvSetNode(data.cvDepartment, card.department) || visible;</span>
<a href="#l12.164"></a><span id="l12.164" class="difflineminus">-	visible = cvSetNode(data.cvCompany, card.company) || visible;</span>
<a href="#l12.165"></a><span id="l12.165" class="difflineplus">+	visible = cvSetNode(data.cvJobTitle, card.getProperty(&quot;JobTitle&quot;));</span>
<a href="#l12.166"></a><span id="l12.166" class="difflineplus">+	visible = cvSetNode(data.cvDepartment, card.getProperty(&quot;Department&quot;)) || visible;</span>
<a href="#l12.167"></a><span id="l12.167" class="difflineplus">+	visible = cvSetNode(data.cvCompany, card.getProperty(&quot;Company&quot;)) || visible;</span>
<a href="#l12.168"></a><span id="l12.168">         </span>
<a href="#l12.169"></a><span id="l12.169" class="difflineminus">-        var addressVisible = cvSetNode(data.cvWorkAddress, card.workAddress);</span>
<a href="#l12.170"></a><span id="l12.170" class="difflineminus">-	addressVisible = cvSetNode(data.cvWorkAddress2, card.workAddress2) || addressVisible;</span>
<a href="#l12.171"></a><span id="l12.171" class="difflineminus">-	addressVisible = cvSetCityStateZip(data.cvWorkCityStZip, card.workCity, card.workState, card.workZipCode) || addressVisible;</span>
<a href="#l12.172"></a><span id="l12.172" class="difflineminus">-	addressVisible = cvSetNode(data.cvWorkCountry, card.workCountry) || addressVisible;</span>
<a href="#l12.173"></a><span id="l12.173" class="difflineplus">+        var addressVisible = cvSetNode(data.cvWorkAddress, card.getProperty(&quot;WorkAddress&quot;));</span>
<a href="#l12.174"></a><span id="l12.174" class="difflineplus">+	addressVisible = cvSetNode(data.cvWorkAddress2, card.getProperty(&quot;WorkAddress2&quot;)) || addressVisible;</span>
<a href="#l12.175"></a><span id="l12.175" class="difflineplus">+	addressVisible = cvSetCityStateZip(data.cvWorkCityStZip, card.getProperty(&quot;WorkCity&quot;), card.getProperty(&quot;WorkState&quot;), card.getProperty(&quot;WorkZipCode&quot;)) || addressVisible;</span>
<a href="#l12.176"></a><span id="l12.176" class="difflineplus">+	addressVisible = cvSetNode(data.cvWorkCountry, card.getProperty(&quot;WorkCountry&quot;)) || addressVisible;</span>
<a href="#l12.177"></a><span id="l12.177"> </span>
<a href="#l12.178"></a><span id="l12.178">         if (addressVisible) {</span>
<a href="#l12.179"></a><span id="l12.179" class="difflineminus">-          var workMapItUrl = CreateMapItURL(card.workAddress, card.workAddress2, card.workCity, card.workState, card.workZipCode, card.workCountry);</span>
<a href="#l12.180"></a><span id="l12.180" class="difflineplus">+          var workMapItUrl = CreateMapItURL(card.getProperty(&quot;WorkAddress&quot;), card.getProperty(&quot;WorkAddress2&quot;), card.getProperty(&quot;WorkCity&quot;), card.getProperty(&quot;WorkState&quot;), card.getProperty(&quot;WorkZipCode&quot;), card.getProperty(&quot;WorkCountry&quot;));</span>
<a href="#l12.181"></a><span id="l12.181">           data.cvWorkMapIt.setAttribute('url', workMapItUrl);</span>
<a href="#l12.182"></a><span id="l12.182">           if (workMapItUrl) {</span>
<a href="#l12.183"></a><span id="l12.183"> 	    cvSetVisible(data.cvbWorkMapItBox, true);</span>
<a href="#l12.184"></a><span id="l12.184">             data.cvWorkMapIt.setAttribute('url', workMapItUrl);</span>
<a href="#l12.185"></a><span id="l12.185">           }</span>
<a href="#l12.186"></a><span id="l12.186">           else {</span>
<a href="#l12.187"></a><span id="l12.187"> 	    cvSetVisible(data.cvbWorkMapItBox, false);</span>
<a href="#l12.188"></a><span id="l12.188">           }</span>
<a href="#l12.189"></a><span id="l12.189">         }</span>
<a href="#l12.190"></a><span id="l12.190">         else {</span>
<a href="#l12.191"></a><span id="l12.191"> 	  cvSetVisible(data.cvbWorkMapItBox, false);</span>
<a href="#l12.192"></a><span id="l12.192">         }</span>
<a href="#l12.193"></a><span id="l12.193"> </span>
<a href="#l12.194"></a><span id="l12.194" class="difflineminus">-        visible = HandleLink(data.cvWorkWebPage, &quot;&quot;, card.webPage1, data.cvWorkWebPageBox, card.webPage1) || addressVisible || visible;</span>
<a href="#l12.195"></a><span id="l12.195" class="difflineplus">+        visible = HandleLink(data.cvWorkWebPage, &quot;&quot;, card.getProperty(&quot;WebPage1&quot;), data.cvWorkWebPageBox, card.getProperty(&quot;WebPage1&quot;)) || addressVisible || visible;</span>
<a href="#l12.196"></a><span id="l12.196"> </span>
<a href="#l12.197"></a><span id="l12.197"> 	cvSetVisible(data.cvhWork, visible);</span>
<a href="#l12.198"></a><span id="l12.198"> 	cvSetVisible(data.cvbWork, visible);</span>
<a href="#l12.199"></a><span id="l12.199"> </span>
<a href="#l12.200"></a><span id="l12.200"> 	// make the card view box visible</span>
<a href="#l12.201"></a><span id="l12.201"> 	cvSetVisible(top.cvData.CardViewBox, true);</span>
<a href="#l12.202"></a><span id="l12.202"> }</span>
<a href="#l12.203"></a><span id="l12.203"> </span>
<a href="#l12.204"></a><span id="l12.204" class="difflineat">@@ -352,17 +360,17 @@ function setBuddyIcon(card, buddyIcon)</span>
<a href="#l12.205"></a><span id="l12.205">         // lazily create these file urls, and keep them around</span>
<a href="#l12.206"></a><span id="l12.206">         var dirService = Components.classes[&quot;@mozilla.org/file/directory_service;1&quot;]</span>
<a href="#l12.207"></a><span id="l12.207">             .getService(Components.interfaces.nsIProperties);</span>
<a href="#l12.208"></a><span id="l12.208">         var profileDir = dirService.get(&quot;ProfD&quot;, Components.interfaces.nsIFile);</span>
<a href="#l12.209"></a><span id="l12.209">         gProfileDirURL = gIOService.newFileURI(profileDir);</span>
<a href="#l12.210"></a><span id="l12.210">       }</span>
<a href="#l12.211"></a><span id="l12.211"> </span>
<a href="#l12.212"></a><span id="l12.212">       // if we did have a buddy icon on disk for this screenname, this would be the file url spec for it</span>
<a href="#l12.213"></a><span id="l12.213" class="difflineminus">-      var iconURLStr = gProfileDirURL.spec + &quot;/NIM/&quot; + myScreenName + &quot;/picture/&quot; + card.aimScreenName + &quot;.gif&quot;;</span>
<a href="#l12.214"></a><span id="l12.214" class="difflineplus">+      var iconURLStr = gProfileDirURL.spec + &quot;/NIM/&quot; + myScreenName + &quot;/picture/&quot; + card.getProperty(&quot;_AimScreenName&quot;) + &quot;.gif&quot;;</span>
<a href="#l12.215"></a><span id="l12.215"> </span>
<a href="#l12.216"></a><span id="l12.216">       // check if the file exists</span>
<a href="#l12.217"></a><span id="l12.217">       var file = gFileHandler.getFileFromURLSpec(iconURLStr);</span>
<a href="#l12.218"></a><span id="l12.218">             </span>
<a href="#l12.219"></a><span id="l12.219">       // check if the file exists</span>
<a href="#l12.220"></a><span id="l12.220">       // is this a perf hit?  (how expensive is stat()?)</span>
<a href="#l12.221"></a><span id="l12.221">       if (file.exists()) {</span>
<a href="#l12.222"></a><span id="l12.222">         buddyIcon.setAttribute(&quot;src&quot;, iconURLStr);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/addrbook/resources/content/abMailListDialog.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/addrbook/resources/content/abMailListDialog.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -255,18 +255,18 @@ function EditListOKButton()</span>
<a href="#l13.4"></a><span id="l13.4"> {</span>
<a href="#l13.5"></a><span id="l13.5">   //edit mailing list in database</span>
<a href="#l13.6"></a><span id="l13.6">   if (GetListValue(gEditList, false))</span>
<a href="#l13.7"></a><span id="l13.7">   {</span>
<a href="#l13.8"></a><span id="l13.8">     if (gListCard) {</span>
<a href="#l13.9"></a><span id="l13.9">       // modify the list card (for the results pane) from the mailing list </span>
<a href="#l13.10"></a><span id="l13.10">       gListCard.displayName = gEditList.dirName;</span>
<a href="#l13.11"></a><span id="l13.11">       gListCard.lastName = gEditList.dirName;</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-      gListCard.nickName = gEditList.listNickName;</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-      gListCard.notes = gEditList.description;</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+      gListCard.setProperty(&quot;NickName&quot;, gEditList.listNickName);</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+      gListCard.setProperty(&quot;Notes&quot;, gEditList.description);</span>
<a href="#l13.16"></a><span id="l13.16">     }</span>
<a href="#l13.17"></a><span id="l13.17"> </span>
<a href="#l13.18"></a><span id="l13.18">     gEditList.editMailListToDatabase(gListCard);</span>
<a href="#l13.19"></a><span id="l13.19"> </span>
<a href="#l13.20"></a><span id="l13.20">     if (gOkCallback)</span>
<a href="#l13.21"></a><span id="l13.21">       gOkCallback();</span>
<a href="#l13.22"></a><span id="l13.22">     return true;  // close the window</span>
<a href="#l13.23"></a><span id="l13.23">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/addrbook/resources/content/addressbook.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/addrbook/resources/content/addressbook.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -337,18 +337,17 @@ function AbPrintCard()</span>
<a href="#l14.4"></a><span id="l14.4"> </span>
<a href="#l14.5"></a><span id="l14.5"> function AbPrintPreviewCard()</span>
<a href="#l14.6"></a><span id="l14.6"> {</span>
<a href="#l14.7"></a><span id="l14.7">   AbPrintCardInternal(true, Components.interfaces.nsIMsgPrintEngine.MNAB_PRINTPREVIEW_AB_CARD);</span>
<a href="#l14.8"></a><span id="l14.8"> }</span>
<a href="#l14.9"></a><span id="l14.9"> </span>
<a href="#l14.10"></a><span id="l14.10"> function CreatePrintCardUrl(card)</span>
<a href="#l14.11"></a><span id="l14.11"> {</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-  var url = &quot;data:application/xml;base64,&quot; + card.convertToBase64EncodedXML();</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineminus">-  return url;</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+  return &quot;data:application/xml;base64,&quot; + card.translateTo(&quot;base64xml&quot;);</span>
<a href="#l14.15"></a><span id="l14.15"> }</span>
<a href="#l14.16"></a><span id="l14.16"> </span>
<a href="#l14.17"></a><span id="l14.17"> function AbPrintAddressBookInternal(doPrintPreview, msgType)</span>
<a href="#l14.18"></a><span id="l14.18"> {</span>
<a href="#l14.19"></a><span id="l14.19">   var uri = GetSelectedDirectory();</span>
<a href="#l14.20"></a><span id="l14.20">   if (!uri)</span>
<a href="#l14.21"></a><span id="l14.21">     return;</span>
<a href="#l14.22"></a><span id="l14.22"> </span>
<a href="#l14.23"></a><span id="l14.23" class="difflineat">@@ -630,17 +629,17 @@ function AbIMSelected()</span>
<a href="#l14.24"></a><span id="l14.24"> {</span>
<a href="#l14.25"></a><span id="l14.25">   var cards = GetSelectedAbCards();</span>
<a href="#l14.26"></a><span id="l14.26">   var count = cards.length;</span>
<a href="#l14.27"></a><span id="l14.27"> </span>
<a href="#l14.28"></a><span id="l14.28">   var screennames;</span>
<a href="#l14.29"></a><span id="l14.29">   var screennameCount = 0;</span>
<a href="#l14.30"></a><span id="l14.30"> </span>
<a href="#l14.31"></a><span id="l14.31">   for (var i=0;i&lt;count;i++) {</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineminus">-    var screenname = cards[i].aimScreenName;</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineplus">+    var screenname = cards[i].getProperty(&quot;_AimScreenName&quot;, &quot;&quot;);</span>
<a href="#l14.34"></a><span id="l14.34">     if (screenname) {</span>
<a href="#l14.35"></a><span id="l14.35">       if (screennameCount == 0)</span>
<a href="#l14.36"></a><span id="l14.36">         screennames = screenname;</span>
<a href="#l14.37"></a><span id="l14.37">       else</span>
<a href="#l14.38"></a><span id="l14.38">         screennames += &quot;,&quot; + screenname;</span>
<a href="#l14.39"></a><span id="l14.39"> </span>
<a href="#l14.40"></a><span id="l14.40">       screennameCount++</span>
<a href="#l14.41"></a><span id="l14.41">     }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbAddressCollecter.cpp</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbAddressCollecter.cpp</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -125,41 +125,40 @@ NS_IMETHODIMP nsAbAddressCollecter::Coll</span>
<a href="#l15.4"></a><span id="l15.4">     if (curAddress.IsEmpty())</span>
<a href="#l15.5"></a><span id="l15.5">       continue;</span>
<a href="#l15.6"></a><span id="l15.6"> </span>
<a href="#l15.7"></a><span id="l15.7"> </span>
<a href="#l15.8"></a><span id="l15.8">     nsCOMPtr &lt;nsIAbCard&gt; existingCard;</span>
<a href="#l15.9"></a><span id="l15.9">     nsCOMPtr &lt;nsIAbCard&gt; cardInstance;</span>
<a href="#l15.10"></a><span id="l15.10">     PRBool emailAddressIn2ndEmailColumn = PR_FALSE;</span>
<a href="#l15.11"></a><span id="l15.11"> </span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-    rv = GetCardFromAttribute(NS_LITERAL_CSTRING(kPriEmailColumn), curAddress,</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+    rv = GetCardFromAttribute(NS_LITERAL_CSTRING(kPriEmailProperty), curAddress,</span>
<a href="#l15.14"></a><span id="l15.14">                               getter_AddRefs(existingCard));</span>
<a href="#l15.15"></a><span id="l15.15">     // We've not found a card, but is this address actually in the additional</span>
<a href="#l15.16"></a><span id="l15.16">     // email column?</span>
<a href="#l15.17"></a><span id="l15.17">     if (!existingCard)</span>
<a href="#l15.18"></a><span id="l15.18">     {</span>
<a href="#l15.19"></a><span id="l15.19" class="difflineminus">-      rv = GetCardFromAttribute(NS_LITERAL_CSTRING(k2ndEmailColumn), curAddress,</span>
<a href="#l15.20"></a><span id="l15.20" class="difflineplus">+      rv = GetCardFromAttribute(NS_LITERAL_CSTRING(k2ndEmailProperty), curAddress,</span>
<a href="#l15.21"></a><span id="l15.21">                                 getter_AddRefs(existingCard));</span>
<a href="#l15.22"></a><span id="l15.22">       if (existingCard)</span>
<a href="#l15.23"></a><span id="l15.23">         emailAddressIn2ndEmailColumn = PR_TRUE;</span>
<a href="#l15.24"></a><span id="l15.24">     }</span>
<a href="#l15.25"></a><span id="l15.25"> </span>
<a href="#l15.26"></a><span id="l15.26">     if (!existingCard &amp;&amp; aCreateCard)</span>
<a href="#l15.27"></a><span id="l15.27">     {</span>
<a href="#l15.28"></a><span id="l15.28">       nsCOMPtr&lt;nsIAbCard&gt; senderCard = do_CreateInstance(NS_ABCARDPROPERTY_CONTRACTID, &amp;rv);</span>
<a href="#l15.29"></a><span id="l15.29">       if (NS_SUCCEEDED(rv) &amp;&amp; senderCard &amp;&amp; m_directory)</span>
<a href="#l15.30"></a><span id="l15.30">       {</span>
<a href="#l15.31"></a><span id="l15.31">         // Set up the fields for the new card.</span>
<a href="#l15.32"></a><span id="l15.32">         SetNamesForCard(senderCard, unquotedName);</span>
<a href="#l15.33"></a><span id="l15.33">         AutoCollectScreenName(senderCard, curAddress);</span>
<a href="#l15.34"></a><span id="l15.34"> </span>
<a href="#l15.35"></a><span id="l15.35">         if (NS_SUCCEEDED(senderCard-&gt;SetPrimaryEmail(NS_ConvertUTF8toUTF16(curAddress))))</span>
<a href="#l15.36"></a><span id="l15.36">         {</span>
<a href="#l15.37"></a><span id="l15.37" class="difflineminus">-          if (aSendFormat != nsIAbPreferMailFormat::unknown)</span>
<a href="#l15.38"></a><span id="l15.38" class="difflineminus">-            senderCard-&gt;SetPreferMailFormat(aSendFormat);</span>
<a href="#l15.39"></a><span id="l15.39" class="difflineplus">+          senderCard-&gt;SetPropertyAsUint32(kPreferMailFormatProperty, aSendFormat);</span>
<a href="#l15.40"></a><span id="l15.40"> </span>
<a href="#l15.41"></a><span id="l15.41">           nsCOMPtr&lt;nsIAbCard&gt; addedCard;</span>
<a href="#l15.42"></a><span id="l15.42">           rv = m_directory-&gt;AddCard(senderCard, getter_AddRefs(addedCard));</span>
<a href="#l15.43"></a><span id="l15.43">           NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed to add card&quot;);</span>
<a href="#l15.44"></a><span id="l15.44">         }</span>
<a href="#l15.45"></a><span id="l15.45">       }</span>
<a href="#l15.46"></a><span id="l15.46">     }</span>
<a href="#l15.47"></a><span id="l15.47">     else if (existingCard &amp;&amp; !emailAddressIn2ndEmailColumn) { </span>
<a href="#l15.48"></a><span id="l15.48" class="difflineat">@@ -170,22 +169,22 @@ NS_IMETHODIMP nsAbAddressCollecter::Coll</span>
<a href="#l15.49"></a><span id="l15.49">       existingCard-&gt;GetDisplayName(displayName);</span>
<a href="#l15.50"></a><span id="l15.50">       // If we already have a display name, don't set the names on the card.</span>
<a href="#l15.51"></a><span id="l15.51">       if (displayName.IsEmpty() &amp;&amp; !unquotedName.IsEmpty())</span>
<a href="#l15.52"></a><span id="l15.52">         modifiedCard = SetNamesForCard(existingCard, unquotedName);</span>
<a href="#l15.53"></a><span id="l15.53"> </span>
<a href="#l15.54"></a><span id="l15.54">       if (aSendFormat != nsIAbPreferMailFormat::unknown)</span>
<a href="#l15.55"></a><span id="l15.55">       {</span>
<a href="#l15.56"></a><span id="l15.56">         PRUint32 currentFormat;</span>
<a href="#l15.57"></a><span id="l15.57" class="difflineminus">-        rv = existingCard-&gt;GetPreferMailFormat(&amp;currentFormat);</span>
<a href="#l15.58"></a><span id="l15.58" class="difflineplus">+        rv = existingCard-&gt;GetPropertyAsUint32(kPreferMailFormatProperty, &amp;currentFormat);</span>
<a href="#l15.59"></a><span id="l15.59">         NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed to get preferred mail format&quot;);</span>
<a href="#l15.60"></a><span id="l15.60"> </span>
<a href="#l15.61"></a><span id="l15.61">         // we only want to update the AB if the current format is unknown</span>
<a href="#l15.62"></a><span id="l15.62">         if (currentFormat == nsIAbPreferMailFormat::unknown &amp;&amp;</span>
<a href="#l15.63"></a><span id="l15.63" class="difflineminus">-            NS_SUCCEEDED(existingCard-&gt;SetPreferMailFormat(aSendFormat)))</span>
<a href="#l15.64"></a><span id="l15.64" class="difflineplus">+            NS_SUCCEEDED(existingCard-&gt;SetPropertyAsUint32(kPreferMailFormatProperty, aSendFormat)))</span>
<a href="#l15.65"></a><span id="l15.65">           modifiedCard = PR_TRUE;</span>
<a href="#l15.66"></a><span id="l15.66">       }</span>
<a href="#l15.67"></a><span id="l15.67"> </span>
<a href="#l15.68"></a><span id="l15.68">       if (modifiedCard &amp;&amp; m_directory)</span>
<a href="#l15.69"></a><span id="l15.69">         m_directory-&gt;ModifyCard(existingCard);</span>
<a href="#l15.70"></a><span id="l15.70">     }</span>
<a href="#l15.71"></a><span id="l15.71">   } </span>
<a href="#l15.72"></a><span id="l15.72"> </span>
<a href="#l15.73"></a><span id="l15.73" class="difflineat">@@ -211,17 +210,17 @@ nsAbAddressCollecter::AutoCollectScreenN</span>
<a href="#l15.74"></a><span id="l15.74">   // username in </span>
<a href="#l15.75"></a><span id="l15.75">   // username@aol.com (America Online)</span>
<a href="#l15.76"></a><span id="l15.76">   // username@cs.com (Compuserve)</span>
<a href="#l15.77"></a><span id="l15.77">   // username@netscape.net (Netscape webmail)</span>
<a href="#l15.78"></a><span id="l15.78">   // are all AIM screennames.  autocollect that info.</span>
<a href="#l15.79"></a><span id="l15.79">   if (!domain.IsEmpty() &amp;&amp;</span>
<a href="#l15.80"></a><span id="l15.80">       (domain.Equals(&quot;aol.com&quot;) || domain.Equals(&quot;cs.com&quot;) ||</span>
<a href="#l15.81"></a><span id="l15.81">        domain.Equals(&quot;netscape.net&quot;)))</span>
<a href="#l15.82"></a><span id="l15.82" class="difflineminus">-    aCard-&gt;SetAimScreenName(NS_ConvertUTF8toUTF16(Substring(aEmail, 0, atPos)));</span>
<a href="#l15.83"></a><span id="l15.83" class="difflineplus">+    aCard-&gt;SetPropertyAsAUTF8String(kScreenNameProperty, Substring(aEmail, 0, atPos));</span>
<a href="#l15.84"></a><span id="l15.84"> }</span>
<a href="#l15.85"></a><span id="l15.85"> </span>
<a href="#l15.86"></a><span id="l15.86"> // Returns true if the card was modified successfully.</span>
<a href="#l15.87"></a><span id="l15.87"> PRBool</span>
<a href="#l15.88"></a><span id="l15.88"> nsAbAddressCollecter::SetNamesForCard(nsIAbCard *aSenderCard,</span>
<a href="#l15.89"></a><span id="l15.89">                                       const nsCString &amp;aFullName)</span>
<a href="#l15.90"></a><span id="l15.90"> {</span>
<a href="#l15.91"></a><span id="l15.91">   nsCString firstName;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbAutoCompleteSearch.js</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbAutoCompleteSearch.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -128,47 +128,51 @@ nsAbAutoCompleteSearch.prototype = {</span>
<a href="#l16.4"></a><span id="l16.4"> </span>
<a href="#l16.5"></a><span id="l16.5">   // fullString is the full search string.</span>
<a href="#l16.6"></a><span id="l16.6">   // firstWord is the first word of the search string.</span>
<a href="#l16.7"></a><span id="l16.7">   // rest is anything after the first word.</span>
<a href="#l16.8"></a><span id="l16.8">   _checkEntry: function _checkEntry(card, fullString, firstWord, rest) {</span>
<a href="#l16.9"></a><span id="l16.9">     var i;</span>
<a href="#l16.10"></a><span id="l16.10">     if (card.isMailList) {</span>
<a href="#l16.11"></a><span id="l16.11">       return card.displayName.toLocaleLowerCase().lastIndexOf(fullString, 0) == 0 ||</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-        card.notes.toLocaleLowerCase().lastIndexOf(fullString, 0) == 0 ||</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineminus">-        card.nickName.toLocaleLowerCase().lastIndexOf(fullString, 0) == 0;</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineplus">+        card.getProperty(&quot;Notes&quot;, &quot;&quot;).toLocaleLowerCase().lastIndexOf(fullString, 0) == 0 ||</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineplus">+        card.getProperty(&quot;NickName&quot;, &quot;&quot;).toLocaleLowerCase().lastIndexOf(fullString, 0) == 0;</span>
<a href="#l16.16"></a><span id="l16.16">     }</span>
<a href="#l16.17"></a><span id="l16.17"> </span>
<a href="#l16.18"></a><span id="l16.18" class="difflineminus">-    if (card.nickName.toLocaleLowerCase().lastIndexOf(fullString, 0) == 0 ||</span>
<a href="#l16.19"></a><span id="l16.19" class="difflineminus">-        card.displayName.toLocaleLowerCase().lastIndexOf(fullString, 0) == 0 ||</span>
<a href="#l16.20"></a><span id="l16.20" class="difflineminus">-        card.firstName.toLocaleLowerCase().lastIndexOf(fullString, 0) == 0 ||</span>
<a href="#l16.21"></a><span id="l16.21" class="difflineminus">-        card.lastName.toLocaleLowerCase().lastIndexOf(fullString, 0) == 0 ||</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineplus">+    var firstName = card.firstName.toLocaleLowerCase();</span>
<a href="#l16.23"></a><span id="l16.23" class="difflineplus">+    var lastName = card.lastName.toLocaleLowerCase();</span>
<a href="#l16.24"></a><span id="l16.24" class="difflineplus">+    if (card.displayName.toLocaleLowerCase().lastIndexOf(fullString, 0) == 0 ||</span>
<a href="#l16.25"></a><span id="l16.25" class="difflineplus">+        firstName.lastIndexOf(fullString, 0) == 0 ||</span>
<a href="#l16.26"></a><span id="l16.26" class="difflineplus">+        lastName.lastIndexOf(fullString, 0) == 0 ||</span>
<a href="#l16.27"></a><span id="l16.27">         card.primaryEmail.toLocaleLowerCase().lastIndexOf(fullString, 0) == 0)</span>
<a href="#l16.28"></a><span id="l16.28">       return true;</span>
<a href="#l16.29"></a><span id="l16.29"> </span>
<a href="#l16.30"></a><span id="l16.30">     if (firstWord &amp;&amp; rest &amp;&amp;</span>
<a href="#l16.31"></a><span id="l16.31" class="difflineminus">-        ((card.firstName.toLocaleLowerCase().lastIndexOf(firstWord, 0) == 0 &amp;&amp;</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineminus">-          card.lastName.toLocaleLowerCase().lastIndexOf(rest, 0) == 0) ||</span>
<a href="#l16.33"></a><span id="l16.33" class="difflineminus">-         (card.firstName.toLocaleLowerCase().lastIndexOf(rest, 0) == 0 &amp;&amp;</span>
<a href="#l16.34"></a><span id="l16.34" class="difflineminus">-          card.lastName.toLocaleLowerCase().lastIndexOf(firstWord, 0) == 0)))</span>
<a href="#l16.35"></a><span id="l16.35" class="difflineplus">+        ((firstName.lastIndexOf(firstWord, 0) == 0 &amp;&amp;</span>
<a href="#l16.36"></a><span id="l16.36" class="difflineplus">+          lastName.lastIndexOf(rest, 0) == 0) ||</span>
<a href="#l16.37"></a><span id="l16.37" class="difflineplus">+         (firstName.lastIndexOf(rest, 0) == 0 &amp;&amp;</span>
<a href="#l16.38"></a><span id="l16.38" class="difflineplus">+          lastName.lastIndexOf(firstWord, 0) == 0)))</span>
<a href="#l16.39"></a><span id="l16.39" class="difflineplus">+      return true;</span>
<a href="#l16.40"></a><span id="l16.40" class="difflineplus">+</span>
<a href="#l16.41"></a><span id="l16.41" class="difflineplus">+    if (card.getProperty(&quot;NickName&quot;, &quot;&quot;).toLocaleLowerCase().lastIndexOf(fullString, 0) == 0)</span>
<a href="#l16.42"></a><span id="l16.42">       return true;</span>
<a href="#l16.43"></a><span id="l16.43"> </span>
<a href="#l16.44"></a><span id="l16.44">     return false;</span>
<a href="#l16.45"></a><span id="l16.45">   },</span>
<a href="#l16.46"></a><span id="l16.46"> </span>
<a href="#l16.47"></a><span id="l16.47">   _checkDuplicate: function _checkDuplicate(card, emailAddress, currentResults) {</span>
<a href="#l16.48"></a><span id="l16.48">     var lcEmailAddress = emailAddress.toLocaleLowerCase();</span>
<a href="#l16.49"></a><span id="l16.49"> </span>
<a href="#l16.50"></a><span id="l16.50" class="difflineplus">+    var popIndex = parseInt(card.getProperty(&quot;PopularityIndex&quot;, &quot;0&quot;));</span>
<a href="#l16.51"></a><span id="l16.51">     for (var i = 0; i &lt; currentResults._searchResults.length; ++i) {</span>
<a href="#l16.52"></a><span id="l16.52">       if (currentResults._searchResults[i].value.toLocaleLowerCase() ==</span>
<a href="#l16.53"></a><span id="l16.53">           lcEmailAddress)</span>
<a href="#l16.54"></a><span id="l16.54">       {</span>
<a href="#l16.55"></a><span id="l16.55">         // It's a duplicate, is the new one is more popular?</span>
<a href="#l16.56"></a><span id="l16.56" class="difflineminus">-        if (card.popularityIndex &gt;</span>
<a href="#l16.57"></a><span id="l16.57" class="difflineminus">-            currentResults._searchResults[i].card.popularityIndex) {</span>
<a href="#l16.58"></a><span id="l16.58" class="difflineplus">+        if (popIndex &gt; currentResults._searchResults[i].popularity) {</span>
<a href="#l16.59"></a><span id="l16.59">           // Yes it is, so delete this element, return false and allow</span>
<a href="#l16.60"></a><span id="l16.60">           // _addToResult to sort the new element into the correct place.</span>
<a href="#l16.61"></a><span id="l16.61">           currentResults._searchResults.splice(i, 1);</span>
<a href="#l16.62"></a><span id="l16.62">           return false;</span>
<a href="#l16.63"></a><span id="l16.63">         }</span>
<a href="#l16.64"></a><span id="l16.64">         // Not more popular, but still a duplicate. Return true and _addToResult</span>
<a href="#l16.65"></a><span id="l16.65">         // will just forget about it.</span>
<a href="#l16.66"></a><span id="l16.66">         return true;</span>
<a href="#l16.67"></a><span id="l16.67" class="difflineat">@@ -176,50 +180,52 @@ nsAbAutoCompleteSearch.prototype = {</span>
<a href="#l16.68"></a><span id="l16.68">     }</span>
<a href="#l16.69"></a><span id="l16.69">     return false;</span>
<a href="#l16.70"></a><span id="l16.70">   },</span>
<a href="#l16.71"></a><span id="l16.71"> </span>
<a href="#l16.72"></a><span id="l16.72">   _addToResult: function _addToResult(commentColumn, card, result) {</span>
<a href="#l16.73"></a><span id="l16.73">     var emailAddress =</span>
<a href="#l16.74"></a><span id="l16.74">       this._parser.makeFullAddress(card.displayName,</span>
<a href="#l16.75"></a><span id="l16.75">                                    card.isMailList ?</span>
<a href="#l16.76"></a><span id="l16.76" class="difflineminus">-                                   card.notes || card.displayName :</span>
<a href="#l16.77"></a><span id="l16.77" class="difflineplus">+                                   card.getProperty(&quot;Notes&quot;, &quot;&quot;) || card.displayName :</span>
<a href="#l16.78"></a><span id="l16.78">                                    card.primaryEmail);</span>
<a href="#l16.79"></a><span id="l16.79"> </span>
<a href="#l16.80"></a><span id="l16.80">     // The old code used to try it manually. I think if the parser can't work</span>
<a href="#l16.81"></a><span id="l16.81">     // out the address from what we've supplied, then its busted and we're not</span>
<a href="#l16.82"></a><span id="l16.82">     // going to do any better doing it manually.</span>
<a href="#l16.83"></a><span id="l16.83">     if (!emailAddress)</span>
<a href="#l16.84"></a><span id="l16.84">       return;</span>
<a href="#l16.85"></a><span id="l16.85"> </span>
<a href="#l16.86"></a><span id="l16.86">     // If it is a duplicate, then just return and don't add it. The</span>
<a href="#l16.87"></a><span id="l16.87">     // _checkDuplicate function deals with it all for us.</span>
<a href="#l16.88"></a><span id="l16.88">     if (this._checkDuplicate(card, emailAddress, result))</span>
<a href="#l16.89"></a><span id="l16.89">       return;</span>
<a href="#l16.90"></a><span id="l16.90"> </span>
<a href="#l16.91"></a><span id="l16.91">     // Find out where to insert the card.</span>
<a href="#l16.92"></a><span id="l16.92">     var insertPosition = 0;</span>
<a href="#l16.93"></a><span id="l16.93" class="difflineminus">-    var cardPopularityIndex = card.popularityIndex;</span>
<a href="#l16.94"></a><span id="l16.94" class="difflineplus">+    // Hack - mork adds in as a string, but we want to get as an integer...</span>
<a href="#l16.95"></a><span id="l16.95" class="difflineplus">+    var cardPopularityIndex = parseInt(card.getProperty(&quot;PopularityIndex&quot;, &quot;0&quot;));</span>
<a href="#l16.96"></a><span id="l16.96"> </span>
<a href="#l16.97"></a><span id="l16.97">     while (insertPosition &lt; result._searchResults.length &amp;&amp;</span>
<a href="#l16.98"></a><span id="l16.98">            cardPopularityIndex &lt;</span>
<a href="#l16.99"></a><span id="l16.99" class="difflineminus">-           result._searchResults[insertPosition].card.popularityIndex)</span>
<a href="#l16.100"></a><span id="l16.100" class="difflineplus">+           result._searchResults[insertPosition].popularity)</span>
<a href="#l16.101"></a><span id="l16.101">       ++insertPosition;</span>
<a href="#l16.102"></a><span id="l16.102"> </span>
<a href="#l16.103"></a><span id="l16.103">     // Next sort on full address</span>
<a href="#l16.104"></a><span id="l16.104">     while (insertPosition &lt; result._searchResults.length &amp;&amp;</span>
<a href="#l16.105"></a><span id="l16.105">            cardPopularityIndex ==</span>
<a href="#l16.106"></a><span id="l16.106" class="difflineminus">-           result._searchResults[insertPosition].card.popularityIndex &amp;&amp;</span>
<a href="#l16.107"></a><span id="l16.107" class="difflineplus">+           result._searchResults[insertPosition].popularity &amp;&amp;</span>
<a href="#l16.108"></a><span id="l16.108">            emailAddress &gt; result._searchResults[insertPosition].value)</span>
<a href="#l16.109"></a><span id="l16.109">       ++insertPosition;</span>
<a href="#l16.110"></a><span id="l16.110"> </span>
<a href="#l16.111"></a><span id="l16.111">     result._searchResults.splice(insertPosition, 0, {</span>
<a href="#l16.112"></a><span id="l16.112">       value: emailAddress,</span>
<a href="#l16.113"></a><span id="l16.113">       comment: commentColumn,</span>
<a href="#l16.114"></a><span id="l16.114" class="difflineminus">-      card: card</span>
<a href="#l16.115"></a><span id="l16.115" class="difflineplus">+      card: card,</span>
<a href="#l16.116"></a><span id="l16.116" class="difflineplus">+      popularity: cardPopularityIndex</span>
<a href="#l16.117"></a><span id="l16.117">     });</span>
<a href="#l16.118"></a><span id="l16.118">   },</span>
<a href="#l16.119"></a><span id="l16.119"> </span>
<a href="#l16.120"></a><span id="l16.120">   // nsIAutoCompleteSearch</span>
<a href="#l16.121"></a><span id="l16.121">   startSearch: function startSearch(aSearchString, aSearchParam,</span>
<a href="#l16.122"></a><span id="l16.122">                                     aPreviousResult, aListener) {</span>
<a href="#l16.123"></a><span id="l16.123">     var result = new nsAbAutoCompleteResult(aSearchString);</span>
<a href="#l16.124"></a><span id="l16.124"> </span>
<a href="#l16.125"></a><span id="l16.125" class="difflineat">@@ -264,17 +270,18 @@ nsAbAutoCompleteSearch.prototype = {</span>
<a href="#l16.126"></a><span id="l16.126">         if (this._checkEntry(aPreviousResult.getCardAt(i), fullString,</span>
<a href="#l16.127"></a><span id="l16.127">                              firstWord, rest))</span>
<a href="#l16.128"></a><span id="l16.128">           // If it matches, just add it straight onto the array, these will</span>
<a href="#l16.129"></a><span id="l16.129">           // already be in order because the previous search returned them</span>
<a href="#l16.130"></a><span id="l16.130">           // in the correct order.</span>
<a href="#l16.131"></a><span id="l16.131">           result._searchResults.push({</span>
<a href="#l16.132"></a><span id="l16.132">             value: aPreviousResult.getValueAt(i),</span>
<a href="#l16.133"></a><span id="l16.133">             comment: aPreviousResult.getCommentAt(i),</span>
<a href="#l16.134"></a><span id="l16.134" class="difflineminus">-            card: aPreviousResult.getCardAt(i)</span>
<a href="#l16.135"></a><span id="l16.135" class="difflineplus">+            card: aPreviousResult.getCardAt(i),</span>
<a href="#l16.136"></a><span id="l16.136" class="difflineplus">+            popularity: parseInt(aPreviousResult.getCardAt(i).getProperty(&quot;PopularityIndex&quot;, &quot;0&quot;))</span>
<a href="#l16.137"></a><span id="l16.137">           });</span>
<a href="#l16.138"></a><span id="l16.138">       }</span>
<a href="#l16.139"></a><span id="l16.139">     }</span>
<a href="#l16.140"></a><span id="l16.140">     else</span>
<a href="#l16.141"></a><span id="l16.141">     {</span>
<a href="#l16.142"></a><span id="l16.142">       // Now do the searching</span>
<a href="#l16.143"></a><span id="l16.143">       var allABs = Components.classes[&quot;@mozilla.org/abmanager;1&quot;]</span>
<a href="#l16.144"></a><span id="l16.144">                              .getService(Components.interfaces.nsIAbManager)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbAutoCompleteSession.cpp</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbAutoCompleteSession.cpp</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -364,31 +364,31 @@ nsresult nsAbAutoCompleteSession::Search</span>
<a href="#l17.4"></a><span id="l17.4">           PRUint32 popularityIndex = 0;</span>
<a href="#l17.5"></a><span id="l17.5">           PRBool bIsMailList;</span>
<a href="#l17.6"></a><span id="l17.6"> </span>
<a href="#l17.7"></a><span id="l17.7">           rv = card-&gt;GetIsMailList(&amp;bIsMailList);</span>
<a href="#l17.8"></a><span id="l17.8">           if (NS_FAILED(rv))</span>
<a href="#l17.9"></a><span id="l17.9">             continue;</span>
<a href="#l17.10"></a><span id="l17.10">           if (bIsMailList)</span>
<a href="#l17.11"></a><span id="l17.11">           {</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-            rv = card-&gt;GetNotes(pNotesStr);</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+            rv = card-&gt;GetPropertyAsAString(kNotesProperty, pNotesStr);</span>
<a href="#l17.14"></a><span id="l17.14">             if (NS_FAILED(rv))</span>
<a href="#l17.15"></a><span id="l17.15">               continue;</span>
<a href="#l17.16"></a><span id="l17.16">           }</span>
<a href="#l17.17"></a><span id="l17.17">           else</span>
<a href="#l17.18"></a><span id="l17.18">           {</span>
<a href="#l17.19"></a><span id="l17.19">             for (i = 0 ; i &lt; MAX_NUMBER_OF_EMAIL_ADDRESSES; i ++)</span>
<a href="#l17.20"></a><span id="l17.20">             {</span>
<a href="#l17.21"></a><span id="l17.21">               switch (i)</span>
<a href="#l17.22"></a><span id="l17.22">               {</span>
<a href="#l17.23"></a><span id="l17.23">                 case 0:</span>
<a href="#l17.24"></a><span id="l17.24">                   rv = card-&gt;GetPrimaryEmail(pEmailStr[i]);</span>
<a href="#l17.25"></a><span id="l17.25">                   break;</span>
<a href="#l17.26"></a><span id="l17.26">                 case 1:</span>
<a href="#l17.27"></a><span id="l17.27" class="difflineminus">-                  rv = card-&gt;GetSecondEmail(pEmailStr[i]);</span>
<a href="#l17.28"></a><span id="l17.28" class="difflineplus">+                  rv = card-&gt;GetPropertyAsAString(k2ndEmailProperty, pEmailStr[i]);</span>
<a href="#l17.29"></a><span id="l17.29">                   break;</span>
<a href="#l17.30"></a><span id="l17.30">                 default:</span>
<a href="#l17.31"></a><span id="l17.31">                   return NS_ERROR_FAILURE;</span>
<a href="#l17.32"></a><span id="l17.32">               }</span>
<a href="#l17.33"></a><span id="l17.33">               if (NS_FAILED(rv))</span>
<a href="#l17.34"></a><span id="l17.34">                 continue;</span>
<a href="#l17.35"></a><span id="l17.35"> </span>
<a href="#l17.36"></a><span id="l17.36">               // Don't bother with card without an email address</span>
<a href="#l17.37"></a><span id="l17.37" class="difflineat">@@ -399,36 +399,32 @@ nsresult nsAbAutoCompleteSession::Search</span>
<a href="#l17.38"></a><span id="l17.38">               if (pEmailStr[i].FindChar('@') &lt;= 0)</span>
<a href="#l17.39"></a><span id="l17.39">                 pEmailStr[i].Truncate();</span>
<a href="#l17.40"></a><span id="l17.40">             }</span>
<a href="#l17.41"></a><span id="l17.41">             if (pEmailStr[0].IsEmpty() &amp;&amp; pEmailStr[1].IsEmpty())</span>
<a href="#l17.42"></a><span id="l17.42">               continue;</span>
<a href="#l17.43"></a><span id="l17.43">           }</span>
<a href="#l17.44"></a><span id="l17.44"> </span>
<a href="#l17.45"></a><span id="l17.45">           // Now, retrieve the user name and nickname</span>
<a href="#l17.46"></a><span id="l17.46" class="difflineminus">-          rv = card-&gt;GetDisplayName(pDisplayNameStr);</span>
<a href="#l17.47"></a><span id="l17.47" class="difflineminus">-          if (NS_FAILED(rv))</span>
<a href="#l17.48"></a><span id="l17.48" class="difflineminus">-              continue;</span>
<a href="#l17.49"></a><span id="l17.49" class="difflineminus">-          rv = card-&gt;GetFirstName(pFirstNameStr);</span>
<a href="#l17.50"></a><span id="l17.50" class="difflineminus">-          if (NS_FAILED(rv))</span>
<a href="#l17.51"></a><span id="l17.51" class="difflineminus">-              continue;</span>
<a href="#l17.52"></a><span id="l17.52" class="difflineminus">-          rv = card-&gt;GetLastName(pLastNameStr);</span>
<a href="#l17.53"></a><span id="l17.53" class="difflineminus">-          if (NS_FAILED(rv))</span>
<a href="#l17.54"></a><span id="l17.54" class="difflineminus">-              continue;</span>
<a href="#l17.55"></a><span id="l17.55" class="difflineminus">-          rv = card-&gt;GetNickName(pNickNameStr);</span>
<a href="#l17.56"></a><span id="l17.56" class="difflineminus">-          if (NS_FAILED(rv))</span>
<a href="#l17.57"></a><span id="l17.57" class="difflineminus">-              continue;</span>
<a href="#l17.58"></a><span id="l17.58" class="difflineplus">+          (void)card-&gt;GetDisplayName(pDisplayNameStr);</span>
<a href="#l17.59"></a><span id="l17.59" class="difflineplus">+          (void)card-&gt;GetFirstName(pFirstNameStr);</span>
<a href="#l17.60"></a><span id="l17.60" class="difflineplus">+          (void)card-&gt;GetLastName(pLastNameStr);</span>
<a href="#l17.61"></a><span id="l17.61" class="difflineplus">+</span>
<a href="#l17.62"></a><span id="l17.62" class="difflineplus">+          (void)card-&gt;GetPropertyAsAString(kNicknameProperty, pNickNameStr);</span>
<a href="#l17.63"></a><span id="l17.63"> </span>
<a href="#l17.64"></a><span id="l17.64" class="difflineminus">-          (void) card-&gt;GetPopularityIndex(&amp;popularityIndex);</span>
<a href="#l17.65"></a><span id="l17.65" class="difflineplus">+          (void)card-&gt;GetPropertyAsUint32(kPopularityIndexProperty,</span>
<a href="#l17.66"></a><span id="l17.66" class="difflineplus">+                                          &amp;popularityIndex);</span>
<a href="#l17.67"></a><span id="l17.67"> </span>
<a href="#l17.68"></a><span id="l17.68" class="difflineminus">-          // in the address book a mailing list does not have an email address field. However,</span>
<a href="#l17.69"></a><span id="l17.69" class="difflineminus">-          // we do &quot;fix up&quot; mailing lists in the UI sometimes to look like &quot;My List &lt;My List&gt;&quot;</span>
<a href="#l17.70"></a><span id="l17.70" class="difflineminus">-          // if we are looking up an address and we are comparing it to a mailing list to see if it is a match</span>
<a href="#l17.71"></a><span id="l17.71" class="difflineminus">-          // instead of just looking for an exact match on &quot;My List&quot;, hijack the unused email address field </span>
<a href="#l17.72"></a><span id="l17.72" class="difflineminus">-          // and use that to test against &quot;My List &lt;My List&gt;&quot;</span>
<a href="#l17.73"></a><span id="l17.73" class="difflineplus">+          // In the address book a mailing list does not have an email address</span>
<a href="#l17.74"></a><span id="l17.74" class="difflineplus">+          // field. However, we do &quot;fix up&quot; mailing lists in the UI sometimes to</span>
<a href="#l17.75"></a><span id="l17.75" class="difflineplus">+          // look like &quot;My List &lt;My List&gt;.&quot; If we are looking up an address, and</span>
<a href="#l17.76"></a><span id="l17.76" class="difflineplus">+          // we are comparing it to a mailing list to see if it is a match,</span>
<a href="#l17.77"></a><span id="l17.77" class="difflineplus">+          // instead of just looking for an exact match on &quot;My List&quot;, hijack the</span>
<a href="#l17.78"></a><span id="l17.78" class="difflineplus">+          // unused email address field and use that to test against</span>
<a href="#l17.79"></a><span id="l17.79" class="difflineplus">+          // &quot;My List &lt;My List&gt;&quot;</span>
<a href="#l17.80"></a><span id="l17.80">           if (bIsMailList)</span>
<a href="#l17.81"></a><span id="l17.81">             mParser-&gt;MakeFullAddress(pDisplayNameStr, pDisplayNameStr, pEmailStr[0]);</span>
<a href="#l17.82"></a><span id="l17.82"> </span>
<a href="#l17.83"></a><span id="l17.83">           for (i = 0 ; i &lt; MAX_NUMBER_OF_EMAIL_ADDRESSES; i ++)</span>
<a href="#l17.84"></a><span id="l17.84">           {</span>
<a href="#l17.85"></a><span id="l17.85">             if (!bIsMailList &amp;&amp; pEmailStr[i].IsEmpty())</span>
<a href="#l17.86"></a><span id="l17.86">               continue;</span>
<a href="#l17.87"></a><span id="l17.87"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbCardProperty.cpp</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbCardProperty.cpp</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -18,16 +18,17 @@</span>
<a href="#l18.4"></a><span id="l18.4">  * Netscape Communications Corporation.</span>
<a href="#l18.5"></a><span id="l18.5">  * Portions created by the Initial Developer are Copyright (C) 1998</span>
<a href="#l18.6"></a><span id="l18.6">  * the Initial Developer. All Rights Reserved.</span>
<a href="#l18.7"></a><span id="l18.7">  *</span>
<a href="#l18.8"></a><span id="l18.8">  * Contributor(s):</span>
<a href="#l18.9"></a><span id="l18.9">  *   Seth Spitzer &lt;sspitzer@netscape.com&gt;</span>
<a href="#l18.10"></a><span id="l18.10">  *   Pierre Phaneuf &lt;pp@ludusdesign.com&gt;</span>
<a href="#l18.11"></a><span id="l18.11">  *   Mark Banner &lt;mark@standard8.demon.co.uk&gt;</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineplus">+ *   Joshua Cranmer &lt;Pidgeot18@gmail.com&gt;</span>
<a href="#l18.13"></a><span id="l18.13">  *</span>
<a href="#l18.14"></a><span id="l18.14">  * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l18.15"></a><span id="l18.15">  * either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l18.16"></a><span id="l18.16">  * or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l18.17"></a><span id="l18.17">  * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l18.18"></a><span id="l18.18">  * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l18.19"></a><span id="l18.19">  * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l18.20"></a><span id="l18.20">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l18.21"></a><span id="l18.21" class="difflineat">@@ -53,132 +54,100 @@</span>
<a href="#l18.22"></a><span id="l18.22"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l18.23"></a><span id="l18.23"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l18.24"></a><span id="l18.24"> #include &quot;nsMemory.h&quot;</span>
<a href="#l18.25"></a><span id="l18.25"> #include &quot;nsVCardObj.h&quot;</span>
<a href="#l18.26"></a><span id="l18.26"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l18.27"></a><span id="l18.27"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l18.28"></a><span id="l18.28"> #include &quot;mozITXTToHTMLConv.h&quot;</span>
<a href="#l18.29"></a><span id="l18.29"> </span>
<a href="#l18.30"></a><span id="l18.30" class="difflineplus">+#include &quot;nsIProperty.h&quot;</span>
<a href="#l18.31"></a><span id="l18.31" class="difflineplus">+#include &quot;nsCOMArray.h&quot;</span>
<a href="#l18.32"></a><span id="l18.32" class="difflineplus">+#include &quot;nsArrayEnumerator.h&quot;</span>
<a href="#l18.33"></a><span id="l18.33" class="difflineplus">+</span>
<a href="#l18.34"></a><span id="l18.34"> #define PREF_MAIL_ADDR_BOOK_LASTNAMEFIRST &quot;mail.addr_book.lastnamefirst&quot;</span>
<a href="#l18.35"></a><span id="l18.35" class="difflineminus">-#define kDisplayName 0</span>
<a href="#l18.36"></a><span id="l18.36" class="difflineminus">-#define kLastFirst   1</span>
<a href="#l18.37"></a><span id="l18.37" class="difflineminus">-#define kFirstLast   2</span>
<a href="#l18.38"></a><span id="l18.38"> </span>
<a href="#l18.39"></a><span id="l18.39"> const char sAddrbookProperties[] = &quot;chrome://messenger/locale/addressbook/addressBook.properties&quot;;</span>
<a href="#l18.40"></a><span id="l18.40"> </span>
<a href="#l18.41"></a><span id="l18.41"> enum EAppendType {</span>
<a href="#l18.42"></a><span id="l18.42">   eAppendLine,</span>
<a href="#l18.43"></a><span id="l18.43">   eAppendLabel,</span>
<a href="#l18.44"></a><span id="l18.44">   eAppendCityStateZip</span>
<a href="#l18.45"></a><span id="l18.45"> };</span>
<a href="#l18.46"></a><span id="l18.46"> </span>
<a href="#l18.47"></a><span id="l18.47"> struct AppendItem {</span>
<a href="#l18.48"></a><span id="l18.48">   const char *mColumn;</span>
<a href="#l18.49"></a><span id="l18.49" class="difflineminus">-  const char *mLabel;</span>
<a href="#l18.50"></a><span id="l18.50" class="difflineplus">+  const char* mLabel;</span>
<a href="#l18.51"></a><span id="l18.51">   EAppendType mAppendType;</span>
<a href="#l18.52"></a><span id="l18.52"> };</span>
<a href="#l18.53"></a><span id="l18.53"> </span>
<a href="#l18.54"></a><span id="l18.54"> static const AppendItem NAME_ATTRS_ARRAY[] = {</span>
<a href="#l18.55"></a><span id="l18.55" class="difflineminus">-	{kDisplayNameColumn, &quot;propertyDisplayName&quot;, eAppendLabel},</span>
<a href="#l18.56"></a><span id="l18.56" class="difflineminus">-	{kNicknameColumn, &quot;propertyNickname&quot;, eAppendLabel},</span>
<a href="#l18.57"></a><span id="l18.57" class="difflineminus">-	{kPriEmailColumn, &quot;&quot;, eAppendLine},</span>
<a href="#l18.58"></a><span id="l18.58" class="difflineminus">-	{k2ndEmailColumn, &quot;&quot;, eAppendLine},</span>
<a href="#l18.59"></a><span id="l18.59" class="difflineminus">-  {kAimScreenNameColumn, &quot;propertyScreenName&quot;, eAppendLabel},</span>
<a href="#l18.60"></a><span id="l18.60" class="difflineplus">+  {kDisplayNameProperty, &quot;propertyDisplayName&quot;, eAppendLabel},</span>
<a href="#l18.61"></a><span id="l18.61" class="difflineplus">+  {kNicknameProperty, &quot;propertyNickname&quot;, eAppendLabel},</span>
<a href="#l18.62"></a><span id="l18.62" class="difflineplus">+  {kPriEmailProperty, &quot;&quot;, eAppendLine},</span>
<a href="#l18.63"></a><span id="l18.63" class="difflineplus">+  {k2ndEmailProperty, &quot;&quot;, eAppendLine},</span>
<a href="#l18.64"></a><span id="l18.64" class="difflineplus">+  {kScreenNameProperty, &quot;propertyScreenName&quot;, eAppendLabel}</span>
<a href="#l18.65"></a><span id="l18.65"> };</span>
<a href="#l18.66"></a><span id="l18.66"> </span>
<a href="#l18.67"></a><span id="l18.67"> static const AppendItem PHONE_ATTRS_ARRAY[] = {</span>
<a href="#l18.68"></a><span id="l18.68" class="difflineminus">-	{kWorkPhoneColumn, &quot;propertyWork&quot;, eAppendLabel},</span>
<a href="#l18.69"></a><span id="l18.69" class="difflineminus">-	{kHomePhoneColumn, &quot;propertyHome&quot;, eAppendLabel},</span>
<a href="#l18.70"></a><span id="l18.70" class="difflineminus">-	{kFaxColumn, &quot;propertyFax&quot;, eAppendLabel},</span>
<a href="#l18.71"></a><span id="l18.71" class="difflineminus">-	{kPagerColumn, &quot;propertyPager&quot;, eAppendLabel},</span>
<a href="#l18.72"></a><span id="l18.72" class="difflineminus">-	{kCellularColumn, &quot;propertyCellular&quot;, eAppendLabel}</span>
<a href="#l18.73"></a><span id="l18.73" class="difflineplus">+  {kWorkPhoneProperty, &quot;propertyWork&quot;, eAppendLabel},</span>
<a href="#l18.74"></a><span id="l18.74" class="difflineplus">+  {kHomePhoneProperty, &quot;propertyHome&quot;, eAppendLabel},</span>
<a href="#l18.75"></a><span id="l18.75" class="difflineplus">+  {kFaxProperty, &quot;propertyFax&quot;, eAppendLabel},</span>
<a href="#l18.76"></a><span id="l18.76" class="difflineplus">+  {kPagerProperty, &quot;propertyPager&quot;, eAppendLabel},</span>
<a href="#l18.77"></a><span id="l18.77" class="difflineplus">+  {kCellularProperty, &quot;propertyCellular&quot;, eAppendLabel}</span>
<a href="#l18.78"></a><span id="l18.78"> };</span>
<a href="#l18.79"></a><span id="l18.79"> </span>
<a href="#l18.80"></a><span id="l18.80"> static const AppendItem HOME_ATTRS_ARRAY[] = {</span>
<a href="#l18.81"></a><span id="l18.81" class="difflineminus">-	{kHomeAddressColumn, &quot;&quot;, eAppendLine},</span>
<a href="#l18.82"></a><span id="l18.82" class="difflineminus">-	{kHomeAddress2Column, &quot;&quot;, eAppendLine},</span>
<a href="#l18.83"></a><span id="l18.83" class="difflineminus">-	{kHomeCityColumn, &quot;&quot;, eAppendCityStateZip},</span>
<a href="#l18.84"></a><span id="l18.84" class="difflineminus">-	{kHomeCountryColumn, &quot;&quot;, eAppendLine},</span>
<a href="#l18.85"></a><span id="l18.85" class="difflineminus">-	{kWebPage2Column, &quot;&quot;, eAppendLine}</span>
<a href="#l18.86"></a><span id="l18.86" class="difflineplus">+  {kHomeAddressProperty, &quot;&quot;, eAppendLine},</span>
<a href="#l18.87"></a><span id="l18.87" class="difflineplus">+  {kHomeAddress2Property, &quot;&quot;, eAppendLine},</span>
<a href="#l18.88"></a><span id="l18.88" class="difflineplus">+  {kHomeCityProperty, &quot;&quot;, eAppendCityStateZip},</span>
<a href="#l18.89"></a><span id="l18.89" class="difflineplus">+  {kHomeCountryProperty, &quot;&quot;, eAppendLine},</span>
<a href="#l18.90"></a><span id="l18.90" class="difflineplus">+  {kHomeWebPageProperty, &quot;&quot;, eAppendLine}</span>
<a href="#l18.91"></a><span id="l18.91"> };</span>
<a href="#l18.92"></a><span id="l18.92"> </span>
<a href="#l18.93"></a><span id="l18.93"> static const AppendItem WORK_ATTRS_ARRAY[] = {</span>
<a href="#l18.94"></a><span id="l18.94" class="difflineminus">-	{kJobTitleColumn, &quot;&quot;, eAppendLine},</span>
<a href="#l18.95"></a><span id="l18.95" class="difflineminus">-	{kDepartmentColumn, &quot;&quot;, eAppendLine},</span>
<a href="#l18.96"></a><span id="l18.96" class="difflineminus">-	{kCompanyColumn, &quot;&quot;, eAppendLine},</span>
<a href="#l18.97"></a><span id="l18.97" class="difflineminus">-	{kWorkAddressColumn, &quot;&quot;, eAppendLine},</span>
<a href="#l18.98"></a><span id="l18.98" class="difflineminus">-	{kWorkAddress2Column, &quot;&quot;, eAppendLine},</span>
<a href="#l18.99"></a><span id="l18.99" class="difflineminus">-	{kWorkCityColumn, &quot;&quot;, eAppendCityStateZip},</span>
<a href="#l18.100"></a><span id="l18.100" class="difflineminus">-	{kWorkCountryColumn, &quot;&quot;, eAppendLine},</span>
<a href="#l18.101"></a><span id="l18.101" class="difflineminus">-	{kWebPage1Column, &quot;&quot;, eAppendLine}</span>
<a href="#l18.102"></a><span id="l18.102" class="difflineplus">+  {kJobTitleProperty, &quot;&quot;, eAppendLine},</span>
<a href="#l18.103"></a><span id="l18.103" class="difflineplus">+  {kDepartmentProperty, &quot;&quot;, eAppendLine},</span>
<a href="#l18.104"></a><span id="l18.104" class="difflineplus">+  {kCompanyProperty, &quot;&quot;, eAppendLine},</span>
<a href="#l18.105"></a><span id="l18.105" class="difflineplus">+  {kWorkAddressProperty, &quot;&quot;, eAppendLine},</span>
<a href="#l18.106"></a><span id="l18.106" class="difflineplus">+  {kWorkAddress2Property, &quot;&quot;, eAppendLine},</span>
<a href="#l18.107"></a><span id="l18.107" class="difflineplus">+  {kWorkCityProperty, &quot;&quot;, eAppendCityStateZip},</span>
<a href="#l18.108"></a><span id="l18.108" class="difflineplus">+  {kWorkCountryProperty, &quot;&quot;, eAppendLine},</span>
<a href="#l18.109"></a><span id="l18.109" class="difflineplus">+  {kWorkWebPageProperty, &quot;&quot;, eAppendLine}</span>
<a href="#l18.110"></a><span id="l18.110"> };</span>
<a href="#l18.111"></a><span id="l18.111"> </span>
<a href="#l18.112"></a><span id="l18.112"> static const AppendItem CUSTOM_ATTRS_ARRAY[] = {</span>
<a href="#l18.113"></a><span id="l18.113" class="difflineminus">-	{kCustom1Column, &quot;propertyCustom1&quot;, eAppendLabel},</span>
<a href="#l18.114"></a><span id="l18.114" class="difflineminus">-	{kCustom2Column, &quot;propertyCustom2&quot;, eAppendLabel},</span>
<a href="#l18.115"></a><span id="l18.115" class="difflineminus">-	{kCustom3Column, &quot;propertyCustom3&quot;, eAppendLabel},</span>
<a href="#l18.116"></a><span id="l18.116" class="difflineminus">-	{kCustom4Column, &quot;propertyCustom4&quot;, eAppendLabel},</span>
<a href="#l18.117"></a><span id="l18.117" class="difflineminus">-	{kNotesColumn, &quot;&quot;, eAppendLine}</span>
<a href="#l18.118"></a><span id="l18.118" class="difflineplus">+  {kCustom1Property, &quot;propertyCustom1&quot;, eAppendLabel},</span>
<a href="#l18.119"></a><span id="l18.119" class="difflineplus">+  {kCustom2Property, &quot;propertyCustom2&quot;, eAppendLabel},</span>
<a href="#l18.120"></a><span id="l18.120" class="difflineplus">+  {kCustom3Property, &quot;propertyCustom3&quot;, eAppendLabel},</span>
<a href="#l18.121"></a><span id="l18.121" class="difflineplus">+  {kCustom4Property, &quot;propertyCustom4&quot;, eAppendLabel},</span>
<a href="#l18.122"></a><span id="l18.122" class="difflineplus">+  {kNotesProperty, &quot;&quot;, eAppendLine}</span>
<a href="#l18.123"></a><span id="l18.123"> };</span>
<a href="#l18.124"></a><span id="l18.124"> </span>
<a href="#l18.125"></a><span id="l18.125" class="difflineminus">-nsAbCardProperty::nsAbCardProperty(void)</span>
<a href="#l18.126"></a><span id="l18.126" class="difflineplus">+nsAbCardProperty::nsAbCardProperty()</span>
<a href="#l18.127"></a><span id="l18.127" class="difflineplus">+  : m_IsMailList(PR_FALSE)</span>
<a href="#l18.128"></a><span id="l18.128"> {</span>
<a href="#l18.129"></a><span id="l18.129" class="difflineminus">-  m_LastModDate = 0;</span>
<a href="#l18.130"></a><span id="l18.130" class="difflineplus">+  m_properties.Init();</span>
<a href="#l18.131"></a><span id="l18.131"> </span>
<a href="#l18.132"></a><span id="l18.132" class="difflineminus">-  m_PreferMailFormat = nsIAbPreferMailFormat::unknown;</span>
<a href="#l18.133"></a><span id="l18.133" class="difflineminus">-  m_PopularityIndex = 0;</span>
<a href="#l18.134"></a><span id="l18.134" class="difflineminus">-  m_AllowRemoteContent = PR_FALSE;</span>
<a href="#l18.135"></a><span id="l18.135" class="difflineminus">-  m_IsMailList = PR_FALSE;</span>
<a href="#l18.136"></a><span id="l18.136" class="difflineplus">+  // Initialize some default properties</span>
<a href="#l18.137"></a><span id="l18.137" class="difflineplus">+  SetPropertyAsUint32(kPreferMailFormatProperty, nsIAbPreferMailFormat::unknown);</span>
<a href="#l18.138"></a><span id="l18.138" class="difflineplus">+  SetPropertyAsUint32(kPopularityIndexProperty, 0);</span>
<a href="#l18.139"></a><span id="l18.139" class="difflineplus">+  // Uninitialized...</span>
<a href="#l18.140"></a><span id="l18.140" class="difflineplus">+  SetPropertyAsUint32(kLastModifiedDateProperty, 0);</span>
<a href="#l18.141"></a><span id="l18.141" class="difflineplus">+  SetPropertyAsBool(kAllowRemoteContentProperty, PR_FALSE);</span>
<a href="#l18.142"></a><span id="l18.142"> }</span>
<a href="#l18.143"></a><span id="l18.143"> </span>
<a href="#l18.144"></a><span id="l18.144"> nsAbCardProperty::~nsAbCardProperty(void)</span>
<a href="#l18.145"></a><span id="l18.145"> {</span>
<a href="#l18.146"></a><span id="l18.146"> }</span>
<a href="#l18.147"></a><span id="l18.147"> </span>
<a href="#l18.148"></a><span id="l18.148"> NS_IMPL_ISUPPORTS1(nsAbCardProperty, nsIAbCard)</span>
<a href="#l18.149"></a><span id="l18.149"> </span>
<a href="#l18.150"></a><span id="l18.150"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l18.151"></a><span id="l18.151"> </span>
<a href="#l18.152"></a><span id="l18.152" class="difflineminus">-NS_IMETHODIMP nsAbCardProperty::GetPopularityIndex(PRUint32 *aPopularityIndex)</span>
<a href="#l18.153"></a><span id="l18.153" class="difflineminus">-{</span>
<a href="#l18.154"></a><span id="l18.154" class="difflineminus">-  *aPopularityIndex = m_PopularityIndex;</span>
<a href="#l18.155"></a><span id="l18.155" class="difflineminus">-  return NS_OK;</span>
<a href="#l18.156"></a><span id="l18.156" class="difflineminus">-}</span>
<a href="#l18.157"></a><span id="l18.157" class="difflineminus">-</span>
<a href="#l18.158"></a><span id="l18.158" class="difflineminus">-NS_IMETHODIMP nsAbCardProperty::SetPopularityIndex(PRUint32 aPopularityIndex)</span>
<a href="#l18.159"></a><span id="l18.159" class="difflineminus">-{</span>
<a href="#l18.160"></a><span id="l18.160" class="difflineminus">-  m_PopularityIndex = aPopularityIndex;</span>
<a href="#l18.161"></a><span id="l18.161" class="difflineminus">-  return NS_OK;</span>
<a href="#l18.162"></a><span id="l18.162" class="difflineminus">-}</span>
<a href="#l18.163"></a><span id="l18.163" class="difflineminus">-</span>
<a href="#l18.164"></a><span id="l18.164" class="difflineminus">-NS_IMETHODIMP nsAbCardProperty::GetAllowRemoteContent(PRBool *aAllowRemoteContent)</span>
<a href="#l18.165"></a><span id="l18.165" class="difflineminus">-{</span>
<a href="#l18.166"></a><span id="l18.166" class="difflineminus">-  *aAllowRemoteContent = m_AllowRemoteContent;</span>
<a href="#l18.167"></a><span id="l18.167" class="difflineminus">-  return NS_OK;</span>
<a href="#l18.168"></a><span id="l18.168" class="difflineminus">-}</span>
<a href="#l18.169"></a><span id="l18.169" class="difflineminus">-</span>
<a href="#l18.170"></a><span id="l18.170" class="difflineminus">-NS_IMETHODIMP nsAbCardProperty::SetAllowRemoteContent(PRBool aAllowRemoteContent)</span>
<a href="#l18.171"></a><span id="l18.171" class="difflineminus">-{</span>
<a href="#l18.172"></a><span id="l18.172" class="difflineminus">-  m_AllowRemoteContent = aAllowRemoteContent;</span>
<a href="#l18.173"></a><span id="l18.173" class="difflineminus">-  return NS_OK;</span>
<a href="#l18.174"></a><span id="l18.174" class="difflineminus">-}</span>
<a href="#l18.175"></a><span id="l18.175" class="difflineminus">-</span>
<a href="#l18.176"></a><span id="l18.176" class="difflineminus">-NS_IMETHODIMP nsAbCardProperty::GetPreferMailFormat(PRUint32 *aFormat)</span>
<a href="#l18.177"></a><span id="l18.177" class="difflineminus">-{</span>
<a href="#l18.178"></a><span id="l18.178" class="difflineminus">-  *aFormat = m_PreferMailFormat;</span>
<a href="#l18.179"></a><span id="l18.179" class="difflineminus">-  return NS_OK;</span>
<a href="#l18.180"></a><span id="l18.180" class="difflineminus">-}</span>
<a href="#l18.181"></a><span id="l18.181" class="difflineminus">-</span>
<a href="#l18.182"></a><span id="l18.182" class="difflineminus">-NS_IMETHODIMP nsAbCardProperty::SetPreferMailFormat(PRUint32 aFormat)</span>
<a href="#l18.183"></a><span id="l18.183" class="difflineminus">-{</span>
<a href="#l18.184"></a><span id="l18.184" class="difflineminus">-  m_PreferMailFormat = aFormat;</span>
<a href="#l18.185"></a><span id="l18.185" class="difflineminus">-  return NS_OK;</span>
<a href="#l18.186"></a><span id="l18.186" class="difflineminus">-}</span>
<a href="#l18.187"></a><span id="l18.187" class="difflineminus">-</span>
<a href="#l18.188"></a><span id="l18.188"> NS_IMETHODIMP nsAbCardProperty::GetIsMailList(PRBool *aIsMailList)</span>
<a href="#l18.189"></a><span id="l18.189"> {</span>
<a href="#l18.190"></a><span id="l18.190">     *aIsMailList = m_IsMailList;</span>
<a href="#l18.191"></a><span id="l18.191">     return NS_OK;</span>
<a href="#l18.192"></a><span id="l18.192"> }</span>
<a href="#l18.193"></a><span id="l18.193"> </span>
<a href="#l18.194"></a><span id="l18.194"> NS_IMETHODIMP nsAbCardProperty::SetIsMailList(PRBool aIsMailList)</span>
<a href="#l18.195"></a><span id="l18.195"> {</span>
<a href="#l18.196"></a><span id="l18.196" class="difflineat">@@ -203,744 +172,233 @@ NS_IMETHODIMP nsAbCardProperty::SetMailL</span>
<a href="#l18.197"></a><span id="l18.197">   {</span>
<a href="#l18.198"></a><span id="l18.198">     m_MailListURI = aMailListURI;</span>
<a href="#l18.199"></a><span id="l18.199">     return NS_OK;</span>
<a href="#l18.200"></a><span id="l18.200">   }</span>
<a href="#l18.201"></a><span id="l18.201">   else</span>
<a href="#l18.202"></a><span id="l18.202">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l18.203"></a><span id="l18.203"> }</span>
<a href="#l18.204"></a><span id="l18.204"> </span>
<a href="#l18.205"></a><span id="l18.205" class="difflineminus">-NS_IMETHODIMP nsAbCardProperty::GetCardValue(const char *attrname, nsAString &amp;value)</span>
<a href="#l18.206"></a><span id="l18.206" class="difflineplus">+///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l18.207"></a><span id="l18.207" class="difflineplus">+// Property bag portion of nsAbCardProperty</span>
<a href="#l18.208"></a><span id="l18.208" class="difflineplus">+///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l18.209"></a><span id="l18.209" class="difflineplus">+</span>
<a href="#l18.210"></a><span id="l18.210" class="difflineplus">+class nsAbSimpleProperty : public nsIProperty {</span>
<a href="#l18.211"></a><span id="l18.211" class="difflineplus">+public:</span>
<a href="#l18.212"></a><span id="l18.212" class="difflineplus">+    nsAbSimpleProperty(const nsACString&amp; aName, nsIVariant* aValue)</span>
<a href="#l18.213"></a><span id="l18.213" class="difflineplus">+        : mName(aName), mValue(aValue)</span>
<a href="#l18.214"></a><span id="l18.214" class="difflineplus">+    {</span>
<a href="#l18.215"></a><span id="l18.215" class="difflineplus">+    }</span>
<a href="#l18.216"></a><span id="l18.216" class="difflineplus">+</span>
<a href="#l18.217"></a><span id="l18.217" class="difflineplus">+    NS_DECL_ISUPPORTS</span>
<a href="#l18.218"></a><span id="l18.218" class="difflineplus">+    NS_DECL_NSIPROPERTY</span>
<a href="#l18.219"></a><span id="l18.219" class="difflineplus">+protected:</span>
<a href="#l18.220"></a><span id="l18.220" class="difflineplus">+    nsCString mName;</span>
<a href="#l18.221"></a><span id="l18.221" class="difflineplus">+    nsCOMPtr&lt;nsIVariant&gt; mValue;</span>
<a href="#l18.222"></a><span id="l18.222" class="difflineplus">+};</span>
<a href="#l18.223"></a><span id="l18.223" class="difflineplus">+</span>
<a href="#l18.224"></a><span id="l18.224" class="difflineplus">+NS_IMPL_ISUPPORTS1(nsAbSimpleProperty, nsIProperty)</span>
<a href="#l18.225"></a><span id="l18.225" class="difflineplus">+</span>
<a href="#l18.226"></a><span id="l18.226" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l18.227"></a><span id="l18.227" class="difflineplus">+nsAbSimpleProperty::GetName(nsAString&amp; aName)</span>
<a href="#l18.228"></a><span id="l18.228" class="difflineplus">+{</span>
<a href="#l18.229"></a><span id="l18.229" class="difflineplus">+    aName.Assign(NS_ConvertUTF8toUTF16(mName));</span>
<a href="#l18.230"></a><span id="l18.230" class="difflineplus">+    return NS_OK;</span>
<a href="#l18.231"></a><span id="l18.231" class="difflineplus">+}</span>
<a href="#l18.232"></a><span id="l18.232" class="difflineplus">+</span>
<a href="#l18.233"></a><span id="l18.233" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l18.234"></a><span id="l18.234" class="difflineplus">+nsAbSimpleProperty::GetValue(nsIVariant* *aValue)</span>
<a href="#l18.235"></a><span id="l18.235"> {</span>
<a href="#l18.236"></a><span id="l18.236" class="difflineminus">-  NS_ENSURE_ARG_POINTER(attrname);</span>
<a href="#l18.237"></a><span id="l18.237" class="difflineplus">+    NS_IF_ADDREF(*aValue = mValue);</span>
<a href="#l18.238"></a><span id="l18.238" class="difflineplus">+    return NS_OK;</span>
<a href="#l18.239"></a><span id="l18.239" class="difflineplus">+}</span>
<a href="#l18.240"></a><span id="l18.240" class="difflineplus">+</span>
<a href="#l18.241"></a><span id="l18.241" class="difflineplus">+PR_STATIC_CALLBACK(PLDHashOperator)</span>
<a href="#l18.242"></a><span id="l18.242" class="difflineplus">+PropertyHashToArrayFunc (const nsACString &amp;aKey, nsIVariant* aData, void *userArg)</span>
<a href="#l18.243"></a><span id="l18.243" class="difflineplus">+{</span>
<a href="#l18.244"></a><span id="l18.244" class="difflineplus">+  nsCOMArray&lt;nsIProperty&gt;* propertyArray = static_cast&lt;nsCOMArray&lt;nsIProperty&gt; *&gt;(userArg);</span>
<a href="#l18.245"></a><span id="l18.245" class="difflineplus">+  propertyArray-&gt;AppendObject(new nsAbSimpleProperty(aKey, aData));</span>
<a href="#l18.246"></a><span id="l18.246" class="difflineplus">+  return PL_DHASH_NEXT;</span>
<a href="#l18.247"></a><span id="l18.247" class="difflineplus">+}</span>
<a href="#l18.248"></a><span id="l18.248"> </span>
<a href="#l18.249"></a><span id="l18.249" class="difflineminus">-  nsresult rv = NS_OK;</span>
<a href="#l18.250"></a><span id="l18.250" class="difflineplus">+NS_IMETHODIMP nsAbCardProperty::GetProperties(nsISimpleEnumerator **props)</span>
<a href="#l18.251"></a><span id="l18.251" class="difflineplus">+{</span>
<a href="#l18.252"></a><span id="l18.252" class="difflineplus">+  nsCOMArray&lt;nsIProperty&gt; propertyArray(m_properties.Count());</span>
<a href="#l18.253"></a><span id="l18.253" class="difflineplus">+  m_properties.EnumerateRead(PropertyHashToArrayFunc, &amp;propertyArray);</span>
<a href="#l18.254"></a><span id="l18.254" class="difflineplus">+  return NS_NewArrayEnumerator(props, propertyArray);</span>
<a href="#l18.255"></a><span id="l18.255" class="difflineplus">+}</span>
<a href="#l18.256"></a><span id="l18.256" class="difflineplus">+</span>
<a href="#l18.257"></a><span id="l18.257" class="difflineplus">+NS_IMETHODIMP nsAbCardProperty::GetProperty(const nsACString &amp;name,</span>
<a href="#l18.258"></a><span id="l18.258" class="difflineplus">+                                            nsIVariant *defaultValue,</span>
<a href="#l18.259"></a><span id="l18.259" class="difflineplus">+                                            nsIVariant **value)</span>
<a href="#l18.260"></a><span id="l18.260" class="difflineplus">+{</span>
<a href="#l18.261"></a><span id="l18.261" class="difflineplus">+  if (!m_properties.Get(name, value))</span>
<a href="#l18.262"></a><span id="l18.262" class="difflineplus">+    NS_ADDREF(*value = defaultValue);</span>
<a href="#l18.263"></a><span id="l18.263" class="difflineplus">+  return NS_OK;</span>
<a href="#l18.264"></a><span id="l18.264" class="difflineplus">+}</span>
<a href="#l18.265"></a><span id="l18.265" class="difflineplus">+</span>
<a href="#l18.266"></a><span id="l18.266" class="difflineplus">+NS_IMETHODIMP nsAbCardProperty::GetPropertyAsAString(const char *name, nsAString &amp;value) </span>
<a href="#l18.267"></a><span id="l18.267" class="difflineplus">+{</span>
<a href="#l18.268"></a><span id="l18.268" class="difflineplus">+  nsCOMPtr&lt;nsIVariant&gt; variant;</span>
<a href="#l18.269"></a><span id="l18.269" class="difflineplus">+  return m_properties.Get(nsDependentCString(name), getter_AddRefs(variant)) ?</span>
<a href="#l18.270"></a><span id="l18.270" class="difflineplus">+    variant-&gt;GetAsAString(value) : NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l18.271"></a><span id="l18.271" class="difflineplus">+}</span>
<a href="#l18.272"></a><span id="l18.272"> </span>
<a href="#l18.273"></a><span id="l18.273" class="difflineminus">-  switch (attrname[0]) {</span>
<a href="#l18.274"></a><span id="l18.274" class="difflineminus">-    case '_': // _AimScreenName</span>
<a href="#l18.275"></a><span id="l18.275" class="difflineminus">-      rv = GetAimScreenName(value);</span>
<a href="#l18.276"></a><span id="l18.276" class="difflineminus">-      break;</span>
<a href="#l18.277"></a><span id="l18.277" class="difflineminus">-    case 'A':</span>
<a href="#l18.278"></a><span id="l18.278" class="difflineminus">-      // AllowRemoteContent, AnniversaryYear, AnniversaryMonth, AnniversaryDay</span>
<a href="#l18.279"></a><span id="l18.279" class="difflineminus">-      switch (attrname[11]) {</span>
<a href="#l18.280"></a><span id="l18.280" class="difflineminus">-        case 'C':</span>
<a href="#l18.281"></a><span id="l18.281" class="difflineminus">-        {</span>
<a href="#l18.282"></a><span id="l18.282" class="difflineminus">-          PRBool allowRemoteContent = PR_FALSE;</span>
<a href="#l18.283"></a><span id="l18.283" class="difflineminus">-          GetAllowRemoteContent(&amp;allowRemoteContent);</span>
<a href="#l18.284"></a><span id="l18.284" class="difflineminus">-          value = allowRemoteContent ? NS_LITERAL_STRING(&quot;true&quot;) :</span>
<a href="#l18.285"></a><span id="l18.285" class="difflineminus">-                                       NS_LITERAL_STRING(&quot;false&quot;);</span>
<a href="#l18.286"></a><span id="l18.286" class="difflineminus">-          break;</span>
<a href="#l18.287"></a><span id="l18.287" class="difflineminus">-        }</span>
<a href="#l18.288"></a><span id="l18.288" class="difflineminus">-        case 'Y':</span>
<a href="#l18.289"></a><span id="l18.289" class="difflineminus">-          rv = GetAnniversaryYear(value);</span>
<a href="#l18.290"></a><span id="l18.290" class="difflineminus">-          break;</span>
<a href="#l18.291"></a><span id="l18.291" class="difflineminus">-        case 'M':</span>
<a href="#l18.292"></a><span id="l18.292" class="difflineminus">-          rv = GetAnniversaryMonth(value);</span>
<a href="#l18.293"></a><span id="l18.293" class="difflineminus">-          break;</span>
<a href="#l18.294"></a><span id="l18.294" class="difflineminus">-        case 'D':</span>
<a href="#l18.295"></a><span id="l18.295" class="difflineminus">-          rv = GetAnniversaryDay(value);</span>
<a href="#l18.296"></a><span id="l18.296" class="difflineminus">-          break;</span>
<a href="#l18.297"></a><span id="l18.297" class="difflineminus">-        default:</span>
<a href="#l18.298"></a><span id="l18.298" class="difflineminus">-      rv = NS_ERROR_UNEXPECTED;</span>
<a href="#l18.299"></a><span id="l18.299" class="difflineminus">-      break;</span>
<a href="#l18.300"></a><span id="l18.300" class="difflineminus">-      }</span>
<a href="#l18.301"></a><span id="l18.301" class="difflineminus">-      break;</span>
<a href="#l18.302"></a><span id="l18.302" class="difflineminus">-    case 'B':</span>
<a href="#l18.303"></a><span id="l18.303" class="difflineminus">-      // BirthYear, BirthMonth, BirthDay</span>
<a href="#l18.304"></a><span id="l18.304" class="difflineminus">-      switch (attrname[5]) {</span>
<a href="#l18.305"></a><span id="l18.305" class="difflineminus">-        case 'Y':</span>
<a href="#l18.306"></a><span id="l18.306" class="difflineminus">-          rv = GetBirthYear(value);</span>
<a href="#l18.307"></a><span id="l18.307" class="difflineminus">-          break;</span>
<a href="#l18.308"></a><span id="l18.308" class="difflineminus">-        case 'M':</span>
<a href="#l18.309"></a><span id="l18.309" class="difflineminus">-          rv = GetBirthMonth(value);</span>
<a href="#l18.310"></a><span id="l18.310" class="difflineminus">-          break;</span>
<a href="#l18.311"></a><span id="l18.311" class="difflineminus">-        case 'D':</span>
<a href="#l18.312"></a><span id="l18.312" class="difflineminus">-          rv = GetBirthDay(value);</span>
<a href="#l18.313"></a><span id="l18.313" class="difflineminus">-          break;</span>
<a href="#l18.314"></a><span id="l18.314" class="difflineminus">-        default:</span>
<a href="#l18.315"></a><span id="l18.315" class="difflineminus">-          rv = NS_ERROR_UNEXPECTED;</span>
<a href="#l18.316"></a><span id="l18.316" class="difflineminus">-          break;</span>
<a href="#l18.317"></a><span id="l18.317" class="difflineminus">-      }</span>
<a href="#l18.318"></a><span id="l18.318" class="difflineminus">-      break;</span>
<a href="#l18.319"></a><span id="l18.319" class="difflineminus">-    case 'C':</span>
<a href="#l18.320"></a><span id="l18.320" class="difflineminus">-      switch (attrname[1]) {</span>
<a href="#l18.321"></a><span id="l18.321" class="difflineminus">-        case 'o':</span>
<a href="#l18.322"></a><span id="l18.322" class="difflineminus">-          rv = GetCompany(value);</span>
<a href="#l18.323"></a><span id="l18.323" class="difflineminus">-          break;</span>
<a href="#l18.324"></a><span id="l18.324" class="difflineminus">-        case 'a': // Category</span>
<a href="#l18.325"></a><span id="l18.325" class="difflineminus">-          rv = GetCategory(value);</span>
<a href="#l18.326"></a><span id="l18.326" class="difflineminus">-          break;</span>
<a href="#l18.327"></a><span id="l18.327" class="difflineminus">-        case 'e':</span>
<a href="#l18.328"></a><span id="l18.328" class="difflineminus">-          if (strlen(attrname) &lt;= 14)</span>
<a href="#l18.329"></a><span id="l18.329" class="difflineminus">-          rv = GetCellularNumber(value);</span>
<a href="#l18.330"></a><span id="l18.330" class="difflineminus">-          else</span>
<a href="#l18.331"></a><span id="l18.331" class="difflineminus">-            rv = GetCellularNumberType(value);</span>
<a href="#l18.332"></a><span id="l18.332" class="difflineminus">-          break;</span>
<a href="#l18.333"></a><span id="l18.333" class="difflineminus">-        case 'u':</span>
<a href="#l18.334"></a><span id="l18.334" class="difflineminus">-          switch (attrname[6]) {</span>
<a href="#l18.335"></a><span id="l18.335" class="difflineminus">-            case '1':</span>
<a href="#l18.336"></a><span id="l18.336" class="difflineminus">-              rv = GetCustom1(value);</span>
<a href="#l18.337"></a><span id="l18.337" class="difflineminus">-              break;</span>
<a href="#l18.338"></a><span id="l18.338" class="difflineminus">-            case '2':</span>
<a href="#l18.339"></a><span id="l18.339" class="difflineminus">-              rv = GetCustom2(value);</span>
<a href="#l18.340"></a><span id="l18.340" class="difflineminus">-              break;</span>
<a href="#l18.341"></a><span id="l18.341" class="difflineminus">-            case '3':</span>
<a href="#l18.342"></a><span id="l18.342" class="difflineminus">-              rv = GetCustom3(value);</span>
<a href="#l18.343"></a><span id="l18.343" class="difflineminus">-              break;</span>
<a href="#l18.344"></a><span id="l18.344" class="difflineminus">-            case '4':</span>
<a href="#l18.345"></a><span id="l18.345" class="difflineminus">-              rv = GetCustom4(value);</span>
<a href="#l18.346"></a><span id="l18.346" class="difflineminus">-              break;</span>
<a href="#l18.347"></a><span id="l18.347" class="difflineminus">-            default:</span>
<a href="#l18.348"></a><span id="l18.348" class="difflineminus">-              rv = NS_ERROR_UNEXPECTED;</span>
<a href="#l18.349"></a><span id="l18.349" class="difflineminus">-              break;</span>
<a href="#l18.350"></a><span id="l18.350" class="difflineminus">-          }</span>
<a href="#l18.351"></a><span id="l18.351" class="difflineminus">-          break;</span>
<a href="#l18.352"></a><span id="l18.352" class="difflineminus">-        default:</span>
<a href="#l18.353"></a><span id="l18.353" class="difflineminus">-          rv = NS_ERROR_UNEXPECTED;</span>
<a href="#l18.354"></a><span id="l18.354" class="difflineminus">-          break;</span>
<a href="#l18.355"></a><span id="l18.355" class="difflineminus">-      }</span>
<a href="#l18.356"></a><span id="l18.356" class="difflineminus">-      break;</span>
<a href="#l18.357"></a><span id="l18.357" class="difflineminus">-    case 'D':</span>
<a href="#l18.358"></a><span id="l18.358" class="difflineminus">-      if (attrname[1] == 'i')</span>
<a href="#l18.359"></a><span id="l18.359" class="difflineminus">-        rv = GetDisplayName(value);</span>
<a href="#l18.360"></a><span id="l18.360" class="difflineminus">-      else if (attrname[2] == 'f')</span>
<a href="#l18.361"></a><span id="l18.361" class="difflineminus">-        rv = GetDefaultAddress(value);</span>
<a href="#l18.362"></a><span id="l18.362" class="difflineminus">-      else</span>
<a href="#l18.363"></a><span id="l18.363" class="difflineminus">-        rv = GetDepartment(value);</span>
<a href="#l18.364"></a><span id="l18.364" class="difflineminus">-      break;</span>
<a href="#l18.365"></a><span id="l18.365" class="difflineminus">-    case 'F':</span>
<a href="#l18.366"></a><span id="l18.366" class="difflineminus">-      switch (attrname[1]) {</span>
<a href="#l18.367"></a><span id="l18.367" class="difflineminus">-      case 'i':</span>
<a href="#l18.368"></a><span id="l18.368" class="difflineminus">-        rv = GetFirstName(value);</span>
<a href="#l18.369"></a><span id="l18.369" class="difflineminus">-        break;</span>
<a href="#l18.370"></a><span id="l18.370" class="difflineminus">-      case 'a':</span>
<a href="#l18.371"></a><span id="l18.371" class="difflineminus">-        if ((attrname[2] == 'x'))</span>
<a href="#l18.372"></a><span id="l18.372" class="difflineminus">-          if (strlen(attrname) &lt;= 9)</span>
<a href="#l18.373"></a><span id="l18.373" class="difflineminus">-        rv = GetFaxNumber(value);</span>
<a href="#l18.374"></a><span id="l18.374" class="difflineminus">-          else</span>
<a href="#l18.375"></a><span id="l18.375" class="difflineminus">-            rv = GetFaxNumberType(value);</span>
<a href="#l18.376"></a><span id="l18.376" class="difflineminus">-        else</span>
<a href="#l18.377"></a><span id="l18.377" class="difflineminus">-          rv = GetFamilyName(value);</span>
<a href="#l18.378"></a><span id="l18.378" class="difflineminus">-        break;</span>
<a href="#l18.379"></a><span id="l18.379" class="difflineminus">-      default:</span>
<a href="#l18.380"></a><span id="l18.380" class="difflineminus">-        rv = NS_ERROR_UNEXPECTED;</span>
<a href="#l18.381"></a><span id="l18.381" class="difflineminus">-        break;</span>
<a href="#l18.382"></a><span id="l18.382" class="difflineminus">-      }</span>
<a href="#l18.383"></a><span id="l18.383" class="difflineminus">-      break;</span>
<a href="#l18.384"></a><span id="l18.384" class="difflineminus">-    case 'H':</span>
<a href="#l18.385"></a><span id="l18.385" class="difflineminus">-      switch (attrname[4]) {</span>
<a href="#l18.386"></a><span id="l18.386" class="difflineminus">-        case 'A':</span>
<a href="#l18.387"></a><span id="l18.387" class="difflineminus">-          if (attrname[11] == '\0')</span>
<a href="#l18.388"></a><span id="l18.388" class="difflineminus">-            rv = GetHomeAddress(value);</span>
<a href="#l18.389"></a><span id="l18.389" class="difflineminus">-          else</span>
<a href="#l18.390"></a><span id="l18.390" class="difflineminus">-            rv = GetHomeAddress2(value);</span>
<a href="#l18.391"></a><span id="l18.391" class="difflineminus">-          break;</span>
<a href="#l18.392"></a><span id="l18.392" class="difflineminus">-        case 'C':</span>
<a href="#l18.393"></a><span id="l18.393" class="difflineminus">-          if (attrname[5] == 'i')</span>
<a href="#l18.394"></a><span id="l18.394" class="difflineminus">-            rv = GetHomeCity(value);</span>
<a href="#l18.395"></a><span id="l18.395" class="difflineminus">-          else</span>
<a href="#l18.396"></a><span id="l18.396" class="difflineminus">-            rv = GetHomeCountry(value);</span>
<a href="#l18.397"></a><span id="l18.397" class="difflineminus">-          break;</span>
<a href="#l18.398"></a><span id="l18.398" class="difflineminus">-        case 'P':</span>
<a href="#l18.399"></a><span id="l18.399" class="difflineminus">-          if (strlen(attrname) &lt;= 9)</span>
<a href="#l18.400"></a><span id="l18.400" class="difflineminus">-          rv = GetHomePhone(value);</span>
<a href="#l18.401"></a><span id="l18.401" class="difflineminus">-          else</span>
<a href="#l18.402"></a><span id="l18.402" class="difflineminus">-            rv = GetHomePhoneType(value);</span>
<a href="#l18.403"></a><span id="l18.403" class="difflineminus">-          break;</span>
<a href="#l18.404"></a><span id="l18.404" class="difflineminus">-        case 'S':</span>
<a href="#l18.405"></a><span id="l18.405" class="difflineminus">-          rv = GetHomeState(value);</span>
<a href="#l18.406"></a><span id="l18.406" class="difflineminus">-          break;</span>
<a href="#l18.407"></a><span id="l18.407" class="difflineminus">-        case 'Z':</span>
<a href="#l18.408"></a><span id="l18.408" class="difflineminus">-          rv = GetHomeZipCode(value);</span>
<a href="#l18.409"></a><span id="l18.409" class="difflineminus">-          break;</span>
<a href="#l18.410"></a><span id="l18.410" class="difflineminus">-        default:</span>
<a href="#l18.411"></a><span id="l18.411" class="difflineminus">-          rv = NS_ERROR_UNEXPECTED;</span>
<a href="#l18.412"></a><span id="l18.412" class="difflineminus">-          break;</span>
<a href="#l18.413"></a><span id="l18.413" class="difflineminus">-      }</span>
<a href="#l18.414"></a><span id="l18.414" class="difflineminus">-      break;</span>
<a href="#l18.415"></a><span id="l18.415" class="difflineminus">-    case 'J':</span>
<a href="#l18.416"></a><span id="l18.416" class="difflineminus">-      rv = GetJobTitle(value);</span>
<a href="#l18.417"></a><span id="l18.417" class="difflineminus">-      break;</span>
<a href="#l18.418"></a><span id="l18.418" class="difflineminus">-    case 'L':</span>
<a href="#l18.419"></a><span id="l18.419" class="difflineminus">-      if (attrname[1] == 'a') {</span>
<a href="#l18.420"></a><span id="l18.420" class="difflineminus">-        if (attrname[4] == 'N')</span>
<a href="#l18.421"></a><span id="l18.421" class="difflineminus">-          rv = GetLastName(value);</span>
<a href="#l18.422"></a><span id="l18.422" class="difflineminus">-        else {</span>
<a href="#l18.423"></a><span id="l18.423" class="difflineminus">-          // XXX todo</span>
<a href="#l18.424"></a><span id="l18.424" class="difflineminus">-          // fix me?  LDAP code gets here</span>
<a href="#l18.425"></a><span id="l18.425" class="difflineminus">-          PRUint32 lastModifiedDate;</span>
<a href="#l18.426"></a><span id="l18.426" class="difflineminus">-          rv = GetLastModifiedDate(&amp;lastModifiedDate);</span>
<a href="#l18.427"></a><span id="l18.427" class="difflineminus">-          value.AssignLiteral(&quot;0Z&quot;);</span>
<a href="#l18.428"></a><span id="l18.428" class="difflineminus">-        }</span>
<a href="#l18.429"></a><span id="l18.429" class="difflineminus">-      }</span>
<a href="#l18.430"></a><span id="l18.430" class="difflineminus">-      else</span>
<a href="#l18.431"></a><span id="l18.431" class="difflineminus">-        rv = NS_ERROR_UNEXPECTED;</span>
<a href="#l18.432"></a><span id="l18.432" class="difflineminus">-      break;</span>
<a href="#l18.433"></a><span id="l18.433" class="difflineminus">-    case 'N':</span>
<a href="#l18.434"></a><span id="l18.434" class="difflineminus">-      if (attrname[1] == 'o')</span>
<a href="#l18.435"></a><span id="l18.435" class="difflineminus">-        rv = GetNotes(value);</span>
<a href="#l18.436"></a><span id="l18.436" class="difflineminus">-      else</span>
<a href="#l18.437"></a><span id="l18.437" class="difflineminus">-        rv = GetNickName(value);</span>
<a href="#l18.438"></a><span id="l18.438" class="difflineminus">-      break;</span>
<a href="#l18.439"></a><span id="l18.439" class="difflineminus">-    case 'P':</span>
<a href="#l18.440"></a><span id="l18.440" class="difflineminus">-      switch (attrname[2]) {</span>
<a href="#l18.441"></a><span id="l18.441" class="difflineminus">-        case 'e':</span>
<a href="#l18.442"></a><span id="l18.442" class="difflineminus">-        {</span>
<a href="#l18.443"></a><span id="l18.443" class="difflineminus">-          PRUint32 format;</span>
<a href="#l18.444"></a><span id="l18.444" class="difflineminus">-          rv = GetPreferMailFormat(&amp;format);</span>
<a href="#l18.445"></a><span id="l18.445" class="difflineplus">+NS_IMETHODIMP nsAbCardProperty::GetPropertyAsAUTF8String(const char *name, nsACString &amp;value) </span>
<a href="#l18.446"></a><span id="l18.446" class="difflineplus">+{</span>
<a href="#l18.447"></a><span id="l18.447" class="difflineplus">+  nsCOMPtr&lt;nsIVariant&gt; variant;</span>
<a href="#l18.448"></a><span id="l18.448" class="difflineplus">+  return m_properties.Get(nsDependentCString(name), getter_AddRefs(variant)) ?</span>
<a href="#l18.449"></a><span id="l18.449" class="difflineplus">+    variant-&gt;GetAsAUTF8String(value) : NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l18.450"></a><span id="l18.450" class="difflineplus">+}</span>
<a href="#l18.451"></a><span id="l18.451" class="difflineplus">+</span>
<a href="#l18.452"></a><span id="l18.452" class="difflineplus">+NS_IMETHODIMP nsAbCardProperty::GetPropertyAsUint32(const char *name, PRUint32 *value) </span>
<a href="#l18.453"></a><span id="l18.453" class="difflineplus">+{</span>
<a href="#l18.454"></a><span id="l18.454" class="difflineplus">+  nsCOMPtr&lt;nsIVariant&gt; variant;</span>
<a href="#l18.455"></a><span id="l18.455" class="difflineplus">+  return m_properties.Get(nsDependentCString(name), getter_AddRefs(variant)) ?</span>
<a href="#l18.456"></a><span id="l18.456" class="difflineplus">+    variant-&gt;GetAsUint32(value) : NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l18.457"></a><span id="l18.457" class="difflineplus">+}</span>
<a href="#l18.458"></a><span id="l18.458" class="difflineplus">+</span>
<a href="#l18.459"></a><span id="l18.459" class="difflineplus">+NS_IMETHODIMP nsAbCardProperty::GetPropertyAsBool(const char *name, PRBool *value) </span>
<a href="#l18.460"></a><span id="l18.460" class="difflineplus">+{</span>
<a href="#l18.461"></a><span id="l18.461" class="difflineplus">+  nsCOMPtr&lt;nsIVariant&gt; variant;</span>
<a href="#l18.462"></a><span id="l18.462" class="difflineplus">+  return m_properties.Get(nsDependentCString(name), getter_AddRefs(variant)) ?</span>
<a href="#l18.463"></a><span id="l18.463" class="difflineplus">+    variant-&gt;GetAsBool(value) : NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l18.464"></a><span id="l18.464" class="difflineplus">+}</span>
<a href="#l18.465"></a><span id="l18.465" class="difflineplus">+</span>
<a href="#l18.466"></a><span id="l18.466" class="difflineplus">+NS_IMETHODIMP nsAbCardProperty::SetProperty(const nsACString &amp;name, nsIVariant *value)</span>
<a href="#l18.467"></a><span id="l18.467" class="difflineplus">+{</span>
<a href="#l18.468"></a><span id="l18.468" class="difflineplus">+  return m_properties.Put(name, value);</span>
<a href="#l18.469"></a><span id="l18.469" class="difflineplus">+}</span>
<a href="#l18.470"></a><span id="l18.470" class="difflineplus">+</span>
<a href="#l18.471"></a><span id="l18.471" class="difflineplus">+NS_IMETHODIMP nsAbCardProperty::SetPropertyAsAString(const char *name, const nsAString &amp;value) </span>
<a href="#l18.472"></a><span id="l18.472" class="difflineplus">+{</span>
<a href="#l18.473"></a><span id="l18.473" class="difflineplus">+  nsCOMPtr&lt;nsIWritableVariant&gt; variant = do_CreateInstance(NS_VARIANT_CONTRACTID);</span>
<a href="#l18.474"></a><span id="l18.474" class="difflineplus">+  variant-&gt;SetAsAString(value);</span>
<a href="#l18.475"></a><span id="l18.475" class="difflineplus">+  return m_properties.Put(nsDependentCString(name), variant);</span>
<a href="#l18.476"></a><span id="l18.476" class="difflineplus">+}</span>
<a href="#l18.477"></a><span id="l18.477"> </span>
<a href="#l18.478"></a><span id="l18.478" class="difflineminus">-          switch (format) {</span>
<a href="#l18.479"></a><span id="l18.479" class="difflineminus">-            case nsIAbPreferMailFormat::html:</span>
<a href="#l18.480"></a><span id="l18.480" class="difflineminus">-              value.AssignLiteral(&quot;html&quot;);</span>
<a href="#l18.481"></a><span id="l18.481" class="difflineminus">-              break;</span>
<a href="#l18.482"></a><span id="l18.482" class="difflineminus">-            case nsIAbPreferMailFormat::plaintext:</span>
<a href="#l18.483"></a><span id="l18.483" class="difflineminus">-              value.AssignLiteral(&quot;plaintext&quot;);</span>
<a href="#l18.484"></a><span id="l18.484" class="difflineminus">-              break;</span>
<a href="#l18.485"></a><span id="l18.485" class="difflineminus">-            case nsIAbPreferMailFormat::unknown:</span>
<a href="#l18.486"></a><span id="l18.486" class="difflineminus">-            default :</span>
<a href="#l18.487"></a><span id="l18.487" class="difflineminus">-              value.AssignLiteral(&quot;unknown&quot;);</span>
<a href="#l18.488"></a><span id="l18.488" class="difflineminus">-              break;</span>
<a href="#l18.489"></a><span id="l18.489" class="difflineminus">-          }</span>
<a href="#l18.490"></a><span id="l18.490" class="difflineminus">-          break;</span>
<a href="#l18.491"></a><span id="l18.491" class="difflineminus">-        }</span>
<a href="#l18.492"></a><span id="l18.492" class="difflineminus">-        case 'g':</span>
<a href="#l18.493"></a><span id="l18.493" class="difflineminus">-          if (strlen(attrname) &lt;= 11)</span>
<a href="#l18.494"></a><span id="l18.494" class="difflineminus">-          rv = GetPagerNumber(value);</span>
<a href="#l18.495"></a><span id="l18.495" class="difflineminus">-          else</span>
<a href="#l18.496"></a><span id="l18.496" class="difflineminus">-            rv = GetPagerNumberType(value);</span>
<a href="#l18.497"></a><span id="l18.497" class="difflineminus">-          break;</span>
<a href="#l18.498"></a><span id="l18.498" class="difflineminus">-        case 'i':</span>
<a href="#l18.499"></a><span id="l18.499" class="difflineminus">-          rv = GetPrimaryEmail(value);</span>
<a href="#l18.500"></a><span id="l18.500" class="difflineminus">-          break;</span>
<a href="#l18.501"></a><span id="l18.501" class="difflineminus">-        case 'o':</span>
<a href="#l18.502"></a><span id="l18.502" class="difflineminus">-          if (attrname[8] == 'L')</span>
<a href="#l18.503"></a><span id="l18.503" class="difflineminus">-            rv = GetPhoneticLastName(value);</span>
<a href="#l18.504"></a><span id="l18.504" class="difflineminus">-          else if (attrname[8] == 'F')</span>
<a href="#l18.505"></a><span id="l18.505" class="difflineminus">-            rv = GetPhoneticFirstName(value);</span>
<a href="#l18.506"></a><span id="l18.506" class="difflineminus">-          break;</span>
<a href="#l18.507"></a><span id="l18.507" class="difflineminus">-        default:</span>
<a href="#l18.508"></a><span id="l18.508" class="difflineminus">-          rv = NS_ERROR_UNEXPECTED;</span>
<a href="#l18.509"></a><span id="l18.509" class="difflineminus">-          break;</span>
<a href="#l18.510"></a><span id="l18.510" class="difflineminus">-      }</span>
<a href="#l18.511"></a><span id="l18.511" class="difflineminus">-      break;</span>
<a href="#l18.512"></a><span id="l18.512" class="difflineminus">-    case 'S':</span>
<a href="#l18.513"></a><span id="l18.513" class="difflineminus">-      if (attrname[1] == 'e')</span>
<a href="#l18.514"></a><span id="l18.514" class="difflineminus">-      rv = GetSecondEmail(value);</span>
<a href="#l18.515"></a><span id="l18.515" class="difflineminus">-      else</span>
<a href="#l18.516"></a><span id="l18.516" class="difflineminus">-        rv = GetSpouseName(value);</span>
<a href="#l18.517"></a><span id="l18.517" class="difflineminus">-      break;</span>
<a href="#l18.518"></a><span id="l18.518" class="difflineminus">-    case 'W':</span>
<a href="#l18.519"></a><span id="l18.519" class="difflineminus">-      if (attrname[1] == 'e') {</span>
<a href="#l18.520"></a><span id="l18.520" class="difflineminus">-        if (attrname[7] == '1')</span>
<a href="#l18.521"></a><span id="l18.521" class="difflineminus">-          rv = GetWebPage1(value);</span>
<a href="#l18.522"></a><span id="l18.522" class="difflineminus">-        else</span>
<a href="#l18.523"></a><span id="l18.523" class="difflineminus">-          rv = GetWebPage2(value);</span>
<a href="#l18.524"></a><span id="l18.524" class="difflineminus">-      }</span>
<a href="#l18.525"></a><span id="l18.525" class="difflineminus">-      else {</span>
<a href="#l18.526"></a><span id="l18.526" class="difflineminus">-        switch (attrname[4]) {</span>
<a href="#l18.527"></a><span id="l18.527" class="difflineminus">-          case 'A':</span>
<a href="#l18.528"></a><span id="l18.528" class="difflineminus">-            if (attrname[11] == '\0')</span>
<a href="#l18.529"></a><span id="l18.529" class="difflineminus">-              rv = GetWorkAddress(value);</span>
<a href="#l18.530"></a><span id="l18.530" class="difflineminus">-            else</span>
<a href="#l18.531"></a><span id="l18.531" class="difflineminus">-              rv = GetWorkAddress2(value);</span>
<a href="#l18.532"></a><span id="l18.532" class="difflineminus">-            break;</span>
<a href="#l18.533"></a><span id="l18.533" class="difflineminus">-          case 'C':</span>
<a href="#l18.534"></a><span id="l18.534" class="difflineminus">-            if (attrname[5] == 'i')</span>
<a href="#l18.535"></a><span id="l18.535" class="difflineminus">-              rv = GetWorkCity(value);</span>
<a href="#l18.536"></a><span id="l18.536" class="difflineminus">-            else</span>
<a href="#l18.537"></a><span id="l18.537" class="difflineminus">-              rv = GetWorkCountry(value);</span>
<a href="#l18.538"></a><span id="l18.538" class="difflineminus">-            break;</span>
<a href="#l18.539"></a><span id="l18.539" class="difflineminus">-          case 'P':</span>
<a href="#l18.540"></a><span id="l18.540" class="difflineminus">-            if (strlen(attrname) &lt;= 9)</span>
<a href="#l18.541"></a><span id="l18.541" class="difflineminus">-            rv = GetWorkPhone(value);</span>
<a href="#l18.542"></a><span id="l18.542" class="difflineminus">-            else</span>
<a href="#l18.543"></a><span id="l18.543" class="difflineminus">-              rv = GetWorkPhoneType(value);</span>
<a href="#l18.544"></a><span id="l18.544" class="difflineminus">-            break;</span>
<a href="#l18.545"></a><span id="l18.545" class="difflineminus">-          case 'S':</span>
<a href="#l18.546"></a><span id="l18.546" class="difflineminus">-            rv = GetWorkState(value);</span>
<a href="#l18.547"></a><span id="l18.547" class="difflineminus">-            break;</span>
<a href="#l18.548"></a><span id="l18.548" class="difflineminus">-          case 'Z':</span>
<a href="#l18.549"></a><span id="l18.549" class="difflineminus">-            rv = GetWorkZipCode(value);</span>
<a href="#l18.550"></a><span id="l18.550" class="difflineminus">-            break;</span>
<a href="#l18.551"></a><span id="l18.551" class="difflineminus">-          default:</span>
<a href="#l18.552"></a><span id="l18.552" class="difflineminus">-            rv = NS_ERROR_UNEXPECTED;</span>
<a href="#l18.553"></a><span id="l18.553" class="difflineminus">-            break;</span>
<a href="#l18.554"></a><span id="l18.554" class="difflineminus">-        }</span>
<a href="#l18.555"></a><span id="l18.555" class="difflineminus">-      }</span>
<a href="#l18.556"></a><span id="l18.556" class="difflineminus">-      break;</span>
<a href="#l18.557"></a><span id="l18.557" class="difflineminus">-    default:</span>
<a href="#l18.558"></a><span id="l18.558" class="difflineminus">-      rv = NS_ERROR_UNEXPECTED;</span>
<a href="#l18.559"></a><span id="l18.559" class="difflineminus">-      break;</span>
<a href="#l18.560"></a><span id="l18.560" class="difflineplus">+NS_IMETHODIMP nsAbCardProperty::SetPropertyAsAUTF8String(const char *name, const nsACString &amp;value) </span>
<a href="#l18.561"></a><span id="l18.561" class="difflineplus">+{</span>
<a href="#l18.562"></a><span id="l18.562" class="difflineplus">+  nsCOMPtr&lt;nsIWritableVariant&gt; variant = do_CreateInstance(NS_VARIANT_CONTRACTID);</span>
<a href="#l18.563"></a><span id="l18.563" class="difflineplus">+  variant-&gt;SetAsAUTF8String(value);</span>
<a href="#l18.564"></a><span id="l18.564" class="difflineplus">+  return m_properties.Put(nsDependentCString(name), variant);</span>
<a href="#l18.565"></a><span id="l18.565" class="difflineplus">+}</span>
<a href="#l18.566"></a><span id="l18.566" class="difflineplus">+</span>
<a href="#l18.567"></a><span id="l18.567" class="difflineplus">+NS_IMETHODIMP nsAbCardProperty::SetPropertyAsUint32(const char *name, PRUint32 value) </span>
<a href="#l18.568"></a><span id="l18.568" class="difflineplus">+{</span>
<a href="#l18.569"></a><span id="l18.569" class="difflineplus">+  nsCOMPtr&lt;nsIWritableVariant&gt; variant = do_CreateInstance(NS_VARIANT_CONTRACTID);</span>
<a href="#l18.570"></a><span id="l18.570" class="difflineplus">+  variant-&gt;SetAsUint32(value);</span>
<a href="#l18.571"></a><span id="l18.571" class="difflineplus">+  return m_properties.Put(nsDependentCString(name), variant);</span>
<a href="#l18.572"></a><span id="l18.572" class="difflineplus">+}</span>
<a href="#l18.573"></a><span id="l18.573" class="difflineplus">+</span>
<a href="#l18.574"></a><span id="l18.574" class="difflineplus">+NS_IMETHODIMP nsAbCardProperty::SetPropertyAsBool(const char *name, PRBool value) </span>
<a href="#l18.575"></a><span id="l18.575" class="difflineplus">+{</span>
<a href="#l18.576"></a><span id="l18.576" class="difflineplus">+  nsCOMPtr&lt;nsIWritableVariant&gt; variant = do_CreateInstance(NS_VARIANT_CONTRACTID);</span>
<a href="#l18.577"></a><span id="l18.577" class="difflineplus">+  variant-&gt;SetAsBool(value);</span>
<a href="#l18.578"></a><span id="l18.578" class="difflineplus">+  return m_properties.Put(nsDependentCString(name), variant);</span>
<a href="#l18.579"></a><span id="l18.579" class="difflineplus">+}</span>
<a href="#l18.580"></a><span id="l18.580" class="difflineplus">+</span>
<a href="#l18.581"></a><span id="l18.581" class="difflineplus">+NS_IMETHODIMP nsAbCardProperty::DeleteProperty(const nsACString &amp;name)</span>
<a href="#l18.582"></a><span id="l18.582" class="difflineplus">+{</span>
<a href="#l18.583"></a><span id="l18.583" class="difflineplus">+  m_properties.Remove(name);</span>
<a href="#l18.584"></a><span id="l18.584" class="difflineplus">+  return NS_OK;</span>
<a href="#l18.585"></a><span id="l18.585" class="difflineplus">+}</span>
<a href="#l18.586"></a><span id="l18.586" class="difflineplus">+</span>
<a href="#l18.587"></a><span id="l18.587" class="difflineplus">+NS_IMETHODIMP nsAbCardProperty::GetFirstName(nsAString &amp;aString)</span>
<a href="#l18.588"></a><span id="l18.588" class="difflineplus">+{</span>
<a href="#l18.589"></a><span id="l18.589" class="difflineplus">+  nsresult rv = GetPropertyAsAString(kFirstNameProperty, aString);</span>
<a href="#l18.590"></a><span id="l18.590" class="difflineplus">+  if (rv == NS_ERROR_NOT_AVAILABLE)</span>
<a href="#l18.591"></a><span id="l18.591" class="difflineplus">+  {</span>
<a href="#l18.592"></a><span id="l18.592" class="difflineplus">+    aString.Truncate();</span>
<a href="#l18.593"></a><span id="l18.593" class="difflineplus">+    return NS_OK;</span>
<a href="#l18.594"></a><span id="l18.594">   }</span>
<a href="#l18.595"></a><span id="l18.595" class="difflineminus">-</span>
<a href="#l18.596"></a><span id="l18.596" class="difflineminus">-  // don't assert here, as failure is expected in certain cases</span>
<a href="#l18.597"></a><span id="l18.597" class="difflineminus">-  // we call GetCardValue() from nsAbView::Init() to determine if the</span>
<a href="#l18.598"></a><span id="l18.598" class="difflineminus">-  // saved sortColumn is valid or not.</span>
<a href="#l18.599"></a><span id="l18.599">   return rv;</span>
<a href="#l18.600"></a><span id="l18.600"> }</span>
<a href="#l18.601"></a><span id="l18.601"> </span>
<a href="#l18.602"></a><span id="l18.602" class="difflineminus">-NS_IMETHODIMP nsAbCardProperty::SetCardValue(const char *attrname, const nsAString &amp;value)</span>
<a href="#l18.603"></a><span id="l18.603" class="difflineplus">+NS_IMETHODIMP nsAbCardProperty::SetFirstName(const nsAString &amp;aString)</span>
<a href="#l18.604"></a><span id="l18.604"> {</span>
<a href="#l18.605"></a><span id="l18.605" class="difflineminus">-  NS_ENSURE_ARG_POINTER(attrname);</span>
<a href="#l18.606"></a><span id="l18.606" class="difflineminus">-</span>
<a href="#l18.607"></a><span id="l18.607" class="difflineminus">-  nsresult rv = NS_OK;</span>
<a href="#l18.608"></a><span id="l18.608" class="difflineplus">+  return SetPropertyAsAString(kFirstNameProperty, aString);</span>
<a href="#l18.609"></a><span id="l18.609" class="difflineplus">+}</span>
<a href="#l18.610"></a><span id="l18.610"> </span>
<a href="#l18.611"></a><span id="l18.611" class="difflineminus">-  switch (attrname[0]) {</span>
<a href="#l18.612"></a><span id="l18.612" class="difflineminus">-    case '_': // _AimScreenName</span>
<a href="#l18.613"></a><span id="l18.613" class="difflineminus">-      rv = SetAimScreenName(value);</span>
<a href="#l18.614"></a><span id="l18.614" class="difflineminus">-      break;</span>
<a href="#l18.615"></a><span id="l18.615" class="difflineminus">-    case 'A':</span>
<a href="#l18.616"></a><span id="l18.616" class="difflineminus">-      // AllowRemoteContent, AnniversaryYear, AnniversaryMonth, AnniversaryDay</span>
<a href="#l18.617"></a><span id="l18.617" class="difflineminus">-      switch (attrname[11]) {</span>
<a href="#l18.618"></a><span id="l18.618" class="difflineminus">-        case 'C':</span>
<a href="#l18.619"></a><span id="l18.619" class="difflineminus">-            SetAllowRemoteContent(value.First() == 't' || value.First() == 'T');</span>
<a href="#l18.620"></a><span id="l18.620" class="difflineminus">-          break;</span>
<a href="#l18.621"></a><span id="l18.621" class="difflineminus">-        case 'Y':</span>
<a href="#l18.622"></a><span id="l18.622" class="difflineminus">-          rv = SetAnniversaryYear(value);</span>
<a href="#l18.623"></a><span id="l18.623" class="difflineminus">-          break;</span>
<a href="#l18.624"></a><span id="l18.624" class="difflineminus">-        case 'M':</span>
<a href="#l18.625"></a><span id="l18.625" class="difflineminus">-          rv = SetAnniversaryMonth(value);</span>
<a href="#l18.626"></a><span id="l18.626" class="difflineminus">-          break;</span>
<a href="#l18.627"></a><span id="l18.627" class="difflineminus">-        case 'D':</span>
<a href="#l18.628"></a><span id="l18.628" class="difflineminus">-          rv = SetAnniversaryDay(value);</span>
<a href="#l18.629"></a><span id="l18.629" class="difflineminus">-          break;</span>
<a href="#l18.630"></a><span id="l18.630" class="difflineminus">-        default:</span>
<a href="#l18.631"></a><span id="l18.631" class="difflineminus">-          rv = NS_ERROR_UNEXPECTED;</span>
<a href="#l18.632"></a><span id="l18.632" class="difflineminus">-          break;</span>
<a href="#l18.633"></a><span id="l18.633" class="difflineminus">-      }</span>
<a href="#l18.634"></a><span id="l18.634" class="difflineminus">-      break;</span>
<a href="#l18.635"></a><span id="l18.635" class="difflineminus">-    case 'B':</span>
<a href="#l18.636"></a><span id="l18.636" class="difflineminus">-      // BirthYear, BirthMonth, BirthDay</span>
<a href="#l18.637"></a><span id="l18.637" class="difflineminus">-      switch (attrname[5]) {</span>
<a href="#l18.638"></a><span id="l18.638" class="difflineminus">-        case 'Y':</span>
<a href="#l18.639"></a><span id="l18.639" class="difflineminus">-          rv = SetBirthYear(value);</span>
<a href="#l18.640"></a><span id="l18.640" class="difflineminus">-          break;</span>
<a href="#l18.641"></a><span id="l18.641" class="difflineminus">-        case 'M':</span>
<a href="#l18.642"></a><span id="l18.642" class="difflineminus">-          rv = SetBirthMonth(value);</span>
<a href="#l18.643"></a><span id="l18.643" class="difflineminus">-          break;</span>
<a href="#l18.644"></a><span id="l18.644" class="difflineminus">-        case 'D':</span>
<a href="#l18.645"></a><span id="l18.645" class="difflineminus">-          rv = SetBirthDay(value);</span>
<a href="#l18.646"></a><span id="l18.646" class="difflineminus">-          break;</span>
<a href="#l18.647"></a><span id="l18.647" class="difflineminus">-        default:</span>
<a href="#l18.648"></a><span id="l18.648" class="difflineminus">-          rv = NS_ERROR_UNEXPECTED;</span>
<a href="#l18.649"></a><span id="l18.649" class="difflineminus">-          break;</span>
<a href="#l18.650"></a><span id="l18.650" class="difflineminus">-      }</span>
<a href="#l18.651"></a><span id="l18.651" class="difflineminus">-      break;</span>
<a href="#l18.652"></a><span id="l18.652" class="difflineminus">-    case 'C':</span>
<a href="#l18.653"></a><span id="l18.653" class="difflineminus">-      switch (attrname[1]) {</span>
<a href="#l18.654"></a><span id="l18.654" class="difflineminus">-        case 'o':</span>
<a href="#l18.655"></a><span id="l18.655" class="difflineminus">-          rv = SetCompany(value);</span>
<a href="#l18.656"></a><span id="l18.656" class="difflineminus">-          break;</span>
<a href="#l18.657"></a><span id="l18.657" class="difflineminus">-        case 'a': // Category</span>
<a href="#l18.658"></a><span id="l18.658" class="difflineminus">-          rv = SetCategory(value);</span>
<a href="#l18.659"></a><span id="l18.659" class="difflineminus">-          break;</span>
<a href="#l18.660"></a><span id="l18.660" class="difflineminus">-        case 'e':</span>
<a href="#l18.661"></a><span id="l18.661" class="difflineminus">-          if (strlen(attrname) &lt;= 14)</span>
<a href="#l18.662"></a><span id="l18.662" class="difflineminus">-          rv = SetCellularNumber(value);</span>
<a href="#l18.663"></a><span id="l18.663" class="difflineminus">-          else</span>
<a href="#l18.664"></a><span id="l18.664" class="difflineminus">-            rv = SetCellularNumberType(value);</span>
<a href="#l18.665"></a><span id="l18.665" class="difflineminus">-          break;</span>
<a href="#l18.666"></a><span id="l18.666" class="difflineminus">-        case 'u':</span>
<a href="#l18.667"></a><span id="l18.667" class="difflineminus">-          switch (attrname[6]) {</span>
<a href="#l18.668"></a><span id="l18.668" class="difflineminus">-            case '1':</span>
<a href="#l18.669"></a><span id="l18.669" class="difflineminus">-              rv = SetCustom1(value);</span>
<a href="#l18.670"></a><span id="l18.670" class="difflineminus">-              break;</span>
<a href="#l18.671"></a><span id="l18.671" class="difflineminus">-            case '2':</span>
<a href="#l18.672"></a><span id="l18.672" class="difflineminus">-              rv = SetCustom2(value);</span>
<a href="#l18.673"></a><span id="l18.673" class="difflineminus">-              break;</span>
<a href="#l18.674"></a><span id="l18.674" class="difflineminus">-            case '3':</span>
<a href="#l18.675"></a><span id="l18.675" class="difflineminus">-              rv = SetCustom3(value);</span>
<a href="#l18.676"></a><span id="l18.676" class="difflineminus">-              break;</span>
<a href="#l18.677"></a><span id="l18.677" class="difflineminus">-            case '4':</span>
<a href="#l18.678"></a><span id="l18.678" class="difflineminus">-              rv = SetCustom4(value);</span>
<a href="#l18.679"></a><span id="l18.679" class="difflineminus">-              break;</span>
<a href="#l18.680"></a><span id="l18.680" class="difflineminus">-            default:</span>
<a href="#l18.681"></a><span id="l18.681" class="difflineminus">-              rv = NS_ERROR_UNEXPECTED;</span>
<a href="#l18.682"></a><span id="l18.682" class="difflineminus">-              break;</span>
<a href="#l18.683"></a><span id="l18.683" class="difflineminus">-          }</span>
<a href="#l18.684"></a><span id="l18.684" class="difflineminus">-          break;</span>
<a href="#l18.685"></a><span id="l18.685" class="difflineminus">-        default:</span>
<a href="#l18.686"></a><span id="l18.686" class="difflineminus">-          rv = NS_ERROR_UNEXPECTED;</span>
<a href="#l18.687"></a><span id="l18.687" class="difflineminus">-          break;</span>
<a href="#l18.688"></a><span id="l18.688" class="difflineminus">-      }</span>
<a href="#l18.689"></a><span id="l18.689" class="difflineminus">-      break;</span>
<a href="#l18.690"></a><span id="l18.690" class="difflineminus">-    case 'D':</span>
<a href="#l18.691"></a><span id="l18.691" class="difflineminus">-      if (attrname[1] == 'i')</span>
<a href="#l18.692"></a><span id="l18.692" class="difflineminus">-        rv = SetDisplayName(value);</span>
<a href="#l18.693"></a><span id="l18.693" class="difflineminus">-      else if (attrname[2] == 'f')</span>
<a href="#l18.694"></a><span id="l18.694" class="difflineminus">-        rv = SetDefaultAddress(value);</span>
<a href="#l18.695"></a><span id="l18.695" class="difflineminus">-      else</span>
<a href="#l18.696"></a><span id="l18.696" class="difflineminus">-        rv = SetDepartment(value);</span>
<a href="#l18.697"></a><span id="l18.697" class="difflineminus">-      break;</span>
<a href="#l18.698"></a><span id="l18.698" class="difflineminus">-    case 'F':</span>
<a href="#l18.699"></a><span id="l18.699" class="difflineminus">-      switch (attrname[1]) {</span>
<a href="#l18.700"></a><span id="l18.700" class="difflineminus">-      case 'i':</span>
<a href="#l18.701"></a><span id="l18.701" class="difflineminus">-        rv = SetFirstName(value);</span>
<a href="#l18.702"></a><span id="l18.702" class="difflineminus">-        break;</span>
<a href="#l18.703"></a><span id="l18.703" class="difflineminus">-      case 'a':</span>
<a href="#l18.704"></a><span id="l18.704" class="difflineminus">-        if ((attrname[2] == 'x'))</span>
<a href="#l18.705"></a><span id="l18.705" class="difflineminus">-          if (strlen(attrname) &lt;= 9)</span>
<a href="#l18.706"></a><span id="l18.706" class="difflineminus">-        rv = SetFaxNumber(value);</span>
<a href="#l18.707"></a><span id="l18.707" class="difflineminus">-          else</span>
<a href="#l18.708"></a><span id="l18.708" class="difflineminus">-            rv = SetFaxNumberType(value);</span>
<a href="#l18.709"></a><span id="l18.709" class="difflineminus">-        else</span>
<a href="#l18.710"></a><span id="l18.710" class="difflineminus">-          rv = SetFamilyName(value);</span>
<a href="#l18.711"></a><span id="l18.711" class="difflineminus">-        break;</span>
<a href="#l18.712"></a><span id="l18.712" class="difflineminus">-      default:</span>
<a href="#l18.713"></a><span id="l18.713" class="difflineminus">-        rv = NS_ERROR_UNEXPECTED;</span>
<a href="#l18.714"></a><span id="l18.714" class="difflineminus">-        break;</span>
<a href="#l18.715"></a><span id="l18.715" class="difflineminus">-      }</span>
<a href="#l18.716"></a><span id="l18.716" class="difflineminus">-      break;</span>
<a href="#l18.717"></a><span id="l18.717" class="difflineminus">-    case 'H':</span>
<a href="#l18.718"></a><span id="l18.718" class="difflineminus">-      switch (attrname[4]) {</span>
<a href="#l18.719"></a><span id="l18.719" class="difflineminus">-        case 'A':</span>
<a href="#l18.720"></a><span id="l18.720" class="difflineminus">-          if (attrname[11] == '\0')</span>
<a href="#l18.721"></a><span id="l18.721" class="difflineminus">-            rv = SetHomeAddress(value);</span>
<a href="#l18.722"></a><span id="l18.722" class="difflineminus">-          else</span>
<a href="#l18.723"></a><span id="l18.723" class="difflineminus">-            rv = SetHomeAddress2(value);</span>
<a href="#l18.724"></a><span id="l18.724" class="difflineminus">-          break;</span>
<a href="#l18.725"></a><span id="l18.725" class="difflineminus">-        case 'C':</span>
<a href="#l18.726"></a><span id="l18.726" class="difflineminus">-          if (attrname[5] == 'i')</span>
<a href="#l18.727"></a><span id="l18.727" class="difflineminus">-            rv = SetHomeCity(value);</span>
<a href="#l18.728"></a><span id="l18.728" class="difflineminus">-          else</span>
<a href="#l18.729"></a><span id="l18.729" class="difflineminus">-            rv = SetHomeCountry(value);</span>
<a href="#l18.730"></a><span id="l18.730" class="difflineminus">-          break;</span>
<a href="#l18.731"></a><span id="l18.731" class="difflineminus">-        case 'P':</span>
<a href="#l18.732"></a><span id="l18.732" class="difflineminus">-          if (strlen(attrname) &lt;= 9)</span>
<a href="#l18.733"></a><span id="l18.733" class="difflineminus">-          rv = SetHomePhone(value);</span>
<a href="#l18.734"></a><span id="l18.734" class="difflineminus">-          else</span>
<a href="#l18.735"></a><span id="l18.735" class="difflineminus">-            rv = SetHomePhoneType(value);</span>
<a href="#l18.736"></a><span id="l18.736" class="difflineminus">-          break;</span>
<a href="#l18.737"></a><span id="l18.737" class="difflineminus">-        case 'S':</span>
<a href="#l18.738"></a><span id="l18.738" class="difflineminus">-          rv = SetHomeState(value);</span>
<a href="#l18.739"></a><span id="l18.739" class="difflineminus">-          break;</span>
<a href="#l18.740"></a><span id="l18.740" class="difflineminus">-        case 'Z':</span>
<a href="#l18.741"></a><span id="l18.741" class="difflineminus">-          rv = SetHomeZipCode(value);</span>
<a href="#l18.742"></a><span id="l18.742" class="difflineminus">-          break;</span>
<a href="#l18.743"></a><span id="l18.743" class="difflineminus">-        default:</span>
<a href="#l18.744"></a><span id="l18.744" class="difflineminus">-          rv = NS_ERROR_UNEXPECTED;</span>
<a href="#l18.745"></a><span id="l18.745" class="difflineminus">-          break;</span>
<a href="#l18.746"></a><span id="l18.746" class="difflineminus">-      }</span>
<a href="#l18.747"></a><span id="l18.747" class="difflineminus">-      break;</span>
<a href="#l18.748"></a><span id="l18.748" class="difflineminus">-    case 'J':</span>
<a href="#l18.749"></a><span id="l18.749" class="difflineminus">-      rv = SetJobTitle(value);</span>
<a href="#l18.750"></a><span id="l18.750" class="difflineminus">-      break;</span>
<a href="#l18.751"></a><span id="l18.751" class="difflineminus">-    case 'L':</span>
<a href="#l18.752"></a><span id="l18.752" class="difflineminus">-      if (attrname[1] == 'a') {</span>
<a href="#l18.753"></a><span id="l18.753" class="difflineminus">-        if (attrname[4] == 'N')</span>
<a href="#l18.754"></a><span id="l18.754" class="difflineminus">-          rv = SetLastName(value);</span>
<a href="#l18.755"></a><span id="l18.755" class="difflineminus">-        else {</span>
<a href="#l18.756"></a><span id="l18.756" class="difflineminus">-          // XXX todo</span>
<a href="#l18.757"></a><span id="l18.757" class="difflineminus">-          // fix me?  LDAP code gets here</span>
<a href="#l18.758"></a><span id="l18.758" class="difflineminus">-          rv = SetLastModifiedDate(0);</span>
<a href="#l18.759"></a><span id="l18.759" class="difflineminus">-        }</span>
<a href="#l18.760"></a><span id="l18.760" class="difflineminus">-      }</span>
<a href="#l18.761"></a><span id="l18.761" class="difflineminus">-      else</span>
<a href="#l18.762"></a><span id="l18.762" class="difflineminus">-        rv = NS_ERROR_UNEXPECTED;</span>
<a href="#l18.763"></a><span id="l18.763" class="difflineminus">-      break;</span>
<a href="#l18.764"></a><span id="l18.764" class="difflineminus">-    case 'N':</span>
<a href="#l18.765"></a><span id="l18.765" class="difflineminus">-      if (attrname[1] == 'o')</span>
<a href="#l18.766"></a><span id="l18.766" class="difflineminus">-        rv = SetNotes(value);</span>
<a href="#l18.767"></a><span id="l18.767" class="difflineminus">-      else</span>
<a href="#l18.768"></a><span id="l18.768" class="difflineminus">-        rv = SetNickName(value);</span>
<a href="#l18.769"></a><span id="l18.769" class="difflineminus">-      break;</span>
<a href="#l18.770"></a><span id="l18.770" class="difflineminus">-    case 'P':</span>
<a href="#l18.771"></a><span id="l18.771" class="difflineminus">-      switch (attrname[2]) {</span>
<a href="#l18.772"></a><span id="l18.772" class="difflineminus">-        case 'e':</span>
<a href="#l18.773"></a><span id="l18.773" class="difflineminus">-          switch (value.First()) {</span>
<a href="#l18.774"></a><span id="l18.774" class="difflineminus">-            case 't':    // &quot;true&quot;</span>
<a href="#l18.775"></a><span id="l18.775" class="difflineminus">-            case 'T':</span>
<a href="#l18.776"></a><span id="l18.776" class="difflineminus">-              rv = SetPreferMailFormat(nsIAbPreferMailFormat::html);</span>
<a href="#l18.777"></a><span id="l18.777" class="difflineminus">-              break;</span>
<a href="#l18.778"></a><span id="l18.778" class="difflineminus">-            case 'f':    // &quot;false&quot;</span>
<a href="#l18.779"></a><span id="l18.779" class="difflineminus">-            case 'F':</span>
<a href="#l18.780"></a><span id="l18.780" class="difflineminus">-              rv = SetPreferMailFormat(nsIAbPreferMailFormat::plaintext);</span>
<a href="#l18.781"></a><span id="l18.781" class="difflineminus">-              break;</span>
<a href="#l18.782"></a><span id="l18.782" class="difflineminus">-            default:</span>
<a href="#l18.783"></a><span id="l18.783" class="difflineminus">-              rv = SetPreferMailFormat(nsIAbPreferMailFormat::unknown);</span>
<a href="#l18.784"></a><span id="l18.784" class="difflineminus">-              break;</span>
<a href="#l18.785"></a><span id="l18.785" class="difflineminus">-          }</span>
<a href="#l18.786"></a><span id="l18.786" class="difflineminus">-          break;</span>
<a href="#l18.787"></a><span id="l18.787" class="difflineminus">-        case 'g':</span>
<a href="#l18.788"></a><span id="l18.788" class="difflineminus">-          if (strlen(attrname) &lt;= 11)</span>
<a href="#l18.789"></a><span id="l18.789" class="difflineminus">-          rv = SetPagerNumber(value);</span>
<a href="#l18.790"></a><span id="l18.790" class="difflineminus">-          else</span>
<a href="#l18.791"></a><span id="l18.791" class="difflineminus">-            rv = SetPagerNumberType(value);</span>
<a href="#l18.792"></a><span id="l18.792" class="difflineminus">-          break;</span>
<a href="#l18.793"></a><span id="l18.793" class="difflineminus">-        case 'i':</span>
<a href="#l18.794"></a><span id="l18.794" class="difflineminus">-          rv = SetPrimaryEmail(value);</span>
<a href="#l18.795"></a><span id="l18.795" class="difflineminus">-          break;</span>
<a href="#l18.796"></a><span id="l18.796" class="difflineminus">-        case 'o':</span>
<a href="#l18.797"></a><span id="l18.797" class="difflineminus">-          if (attrname[8] == 'L')</span>
<a href="#l18.798"></a><span id="l18.798" class="difflineminus">-            rv = SetPhoneticLastName(value);</span>
<a href="#l18.799"></a><span id="l18.799" class="difflineminus">-          else if (attrname[8] == 'F')</span>
<a href="#l18.800"></a><span id="l18.800" class="difflineminus">-            rv = SetPhoneticFirstName(value);</span>
<a href="#l18.801"></a><span id="l18.801" class="difflineminus">-          break;</span>
<a href="#l18.802"></a><span id="l18.802" class="difflineminus">-        default:</span>
<a href="#l18.803"></a><span id="l18.803" class="difflineminus">-          rv = NS_ERROR_UNEXPECTED;</span>
<a href="#l18.804"></a><span id="l18.804" class="difflineminus">-          break;</span>
<a href="#l18.805"></a><span id="l18.805" class="difflineminus">-      }</span>
<a href="#l18.806"></a><span id="l18.806" class="difflineminus">-      break;</span>
<a href="#l18.807"></a><span id="l18.807" class="difflineminus">-    case 'S':</span>
<a href="#l18.808"></a><span id="l18.808" class="difflineminus">-      if (attrname[1] == 'e')</span>
<a href="#l18.809"></a><span id="l18.809" class="difflineminus">-      rv = SetSecondEmail(value);</span>
<a href="#l18.810"></a><span id="l18.810" class="difflineminus">-      else</span>
<a href="#l18.811"></a><span id="l18.811" class="difflineminus">-        rv = SetSpouseName(value);</span>
<a href="#l18.812"></a><span id="l18.812" class="difflineminus">-      break;</span>
<a href="#l18.813"></a><span id="l18.813" class="difflineminus">-    case 'W':</span>
<a href="#l18.814"></a><span id="l18.814" class="difflineminus">-      if (attrname[1] == 'e') {</span>
<a href="#l18.815"></a><span id="l18.815" class="difflineminus">-        if (attrname[7] == '1')</span>
<a href="#l18.816"></a><span id="l18.816" class="difflineminus">-          rv = SetWebPage1(value);</span>
<a href="#l18.817"></a><span id="l18.817" class="difflineminus">-        else</span>
<a href="#l18.818"></a><span id="l18.818" class="difflineminus">-          rv = SetWebPage2(value);</span>
<a href="#l18.819"></a><span id="l18.819" class="difflineminus">-      }</span>
<a href="#l18.820"></a><span id="l18.820" class="difflineminus">-      else {</span>
<a href="#l18.821"></a><span id="l18.821" class="difflineminus">-        switch (attrname[4]) {</span>
<a href="#l18.822"></a><span id="l18.822" class="difflineminus">-          case 'A':</span>
<a href="#l18.823"></a><span id="l18.823" class="difflineminus">-            if (attrname[11] == '\0')</span>
<a href="#l18.824"></a><span id="l18.824" class="difflineminus">-              rv = SetWorkAddress(value);</span>
<a href="#l18.825"></a><span id="l18.825" class="difflineminus">-            else</span>
<a href="#l18.826"></a><span id="l18.826" class="difflineminus">-              rv = SetWorkAddress2(value);</span>
<a href="#l18.827"></a><span id="l18.827" class="difflineminus">-            break;</span>
<a href="#l18.828"></a><span id="l18.828" class="difflineminus">-          case 'C':</span>
<a href="#l18.829"></a><span id="l18.829" class="difflineminus">-            if (attrname[5] == 'i')</span>
<a href="#l18.830"></a><span id="l18.830" class="difflineminus">-              rv = SetWorkCity(value);</span>
<a href="#l18.831"></a><span id="l18.831" class="difflineminus">-            else</span>
<a href="#l18.832"></a><span id="l18.832" class="difflineminus">-              rv = SetWorkCountry(value);</span>
<a href="#l18.833"></a><span id="l18.833" class="difflineminus">-            break;</span>
<a href="#l18.834"></a><span id="l18.834" class="difflineminus">-          case 'P':</span>
<a href="#l18.835"></a><span id="l18.835" class="difflineminus">-            if (strlen(attrname) &lt;= 9)</span>
<a href="#l18.836"></a><span id="l18.836" class="difflineminus">-            rv = SetWorkPhone(value);</span>
<a href="#l18.837"></a><span id="l18.837" class="difflineminus">-            else</span>
<a href="#l18.838"></a><span id="l18.838" class="difflineminus">-              rv = SetWorkPhoneType(value);</span>
<a href="#l18.839"></a><span id="l18.839" class="difflineminus">-            break;</span>
<a href="#l18.840"></a><span id="l18.840" class="difflineminus">-          case 'S':</span>
<a href="#l18.841"></a><span id="l18.841" class="difflineminus">-            rv = SetWorkState(value);</span>
<a href="#l18.842"></a><span id="l18.842" class="difflineminus">-            break;</span>
<a href="#l18.843"></a><span id="l18.843" class="difflineminus">-          case 'Z':</span>
<a href="#l18.844"></a><span id="l18.844" class="difflineminus">-            rv = SetWorkZipCode(value);</span>
<a href="#l18.845"></a><span id="l18.845" class="difflineminus">-            break;</span>
<a href="#l18.846"></a><span id="l18.846" class="difflineminus">-          default:</span>
<a href="#l18.847"></a><span id="l18.847" class="difflineminus">-            rv = NS_ERROR_UNEXPECTED;</span>
<a href="#l18.848"></a><span id="l18.848" class="difflineminus">-            break;</span>
<a href="#l18.849"></a><span id="l18.849" class="difflineminus">-        }</span>
<a href="#l18.850"></a><span id="l18.850" class="difflineminus">-      }</span>
<a href="#l18.851"></a><span id="l18.851" class="difflineminus">-      break;</span>
<a href="#l18.852"></a><span id="l18.852" class="difflineminus">-    default:</span>
<a href="#l18.853"></a><span id="l18.853" class="difflineminus">-      rv = NS_ERROR_UNEXPECTED;</span>
<a href="#l18.854"></a><span id="l18.854" class="difflineminus">-      break;</span>
<a href="#l18.855"></a><span id="l18.855" class="difflineplus">+NS_IMETHODIMP nsAbCardProperty::GetLastName(nsAString &amp;aString)</span>
<a href="#l18.856"></a><span id="l18.856" class="difflineplus">+{</span>
<a href="#l18.857"></a><span id="l18.857" class="difflineplus">+  nsresult rv = GetPropertyAsAString(kLastNameProperty, aString);</span>
<a href="#l18.858"></a><span id="l18.858" class="difflineplus">+  if (rv == NS_ERROR_NOT_AVAILABLE)</span>
<a href="#l18.859"></a><span id="l18.859" class="difflineplus">+  {</span>
<a href="#l18.860"></a><span id="l18.860" class="difflineplus">+    aString.Truncate();</span>
<a href="#l18.861"></a><span id="l18.861" class="difflineplus">+    return NS_OK;</span>
<a href="#l18.862"></a><span id="l18.862">   }</span>
<a href="#l18.863"></a><span id="l18.863" class="difflineminus">-</span>
<a href="#l18.864"></a><span id="l18.864" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l18.865"></a><span id="l18.865">   return rv;</span>
<a href="#l18.866"></a><span id="l18.866"> }</span>
<a href="#l18.867"></a><span id="l18.867"> </span>
<a href="#l18.868"></a><span id="l18.868" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l18.869"></a><span id="l18.869" class="difflineminus">-nsAbCardProperty::GetLastModifiedDate(PRUint32 *aLastModifiedDate)</span>
<a href="#l18.870"></a><span id="l18.870" class="difflineplus">+NS_IMETHODIMP nsAbCardProperty::SetLastName(const nsAString &amp;aString)</span>
<a href="#l18.871"></a><span id="l18.871"> {</span>
<a href="#l18.872"></a><span id="l18.872" class="difflineminus">-  *aLastModifiedDate = m_LastModDate;</span>
<a href="#l18.873"></a><span id="l18.873" class="difflineminus">-  return NS_OK;</span>
<a href="#l18.874"></a><span id="l18.874" class="difflineplus">+  return SetPropertyAsAString(kLastNameProperty, aString);</span>
<a href="#l18.875"></a><span id="l18.875"> }</span>
<a href="#l18.876"></a><span id="l18.876"> </span>
<a href="#l18.877"></a><span id="l18.877" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l18.878"></a><span id="l18.878" class="difflineminus">-nsAbCardProperty::SetLastModifiedDate(PRUint32 aLastModifiedDate)</span>
<a href="#l18.879"></a><span id="l18.879" class="difflineplus">+NS_IMETHODIMP nsAbCardProperty::GetDisplayName(nsAString &amp;aString)</span>
<a href="#l18.880"></a><span id="l18.880"> {</span>
<a href="#l18.881"></a><span id="l18.881" class="difflineminus">-  m_LastModDate = aLastModifiedDate;</span>
<a href="#l18.882"></a><span id="l18.882" class="difflineminus">-  return NS_OK;</span>
<a href="#l18.883"></a><span id="l18.883" class="difflineminus">-}</span>
<a href="#l18.884"></a><span id="l18.884" class="difflineminus">-</span>
<a href="#l18.885"></a><span id="l18.885" class="difflineminus">-#define GET_SET_STR_ATTR(_method, _member)                             \</span>
<a href="#l18.886"></a><span id="l18.886" class="difflineminus">-NS_IMETHODIMP nsAbCardProperty::Get##_method(nsAString &amp;aString)       \</span>
<a href="#l18.887"></a><span id="l18.887" class="difflineminus">-{                                                                      \</span>
<a href="#l18.888"></a><span id="l18.888" class="difflineminus">-  aString = _member;                                                   \</span>
<a href="#l18.889"></a><span id="l18.889" class="difflineminus">-  return NS_OK;                                                        \</span>
<a href="#l18.890"></a><span id="l18.890" class="difflineminus">-}                                                                      \</span>
<a href="#l18.891"></a><span id="l18.891" class="difflineminus">-NS_IMETHODIMP nsAbCardProperty::Set##_method(const nsAString &amp;aString) \</span>
<a href="#l18.892"></a><span id="l18.892" class="difflineminus">-{                                                                      \</span>
<a href="#l18.893"></a><span id="l18.893" class="difflineminus">-  _member = aString;                                                   \</span>
<a href="#l18.894"></a><span id="l18.894" class="difflineminus">- return NS_OK;                                                         \</span>
<a href="#l18.895"></a><span id="l18.895" class="difflineplus">+  nsresult rv = GetPropertyAsAString(kDisplayNameProperty, aString);</span>
<a href="#l18.896"></a><span id="l18.896" class="difflineplus">+  if (rv == NS_ERROR_NOT_AVAILABLE)</span>
<a href="#l18.897"></a><span id="l18.897" class="difflineplus">+  {</span>
<a href="#l18.898"></a><span id="l18.898" class="difflineplus">+    aString.Truncate();</span>
<a href="#l18.899"></a><span id="l18.899" class="difflineplus">+    return NS_OK;</span>
<a href="#l18.900"></a><span id="l18.900" class="difflineplus">+  }</span>
<a href="#l18.901"></a><span id="l18.901" class="difflineplus">+  return rv;</span>
<a href="#l18.902"></a><span id="l18.902"> }</span>
<a href="#l18.903"></a><span id="l18.903"> </span>
<a href="#l18.904"></a><span id="l18.904" class="difflineminus">-GET_SET_STR_ATTR(FirstName, m_FirstName)</span>
<a href="#l18.905"></a><span id="l18.905" class="difflineminus">-GET_SET_STR_ATTR(LastName, m_LastName)</span>
<a href="#l18.906"></a><span id="l18.906" class="difflineminus">-GET_SET_STR_ATTR(PhoneticFirstName, m_PhoneticFirstName)</span>
<a href="#l18.907"></a><span id="l18.907" class="difflineminus">-GET_SET_STR_ATTR(PhoneticLastName, m_PhoneticLastName)</span>
<a href="#l18.908"></a><span id="l18.908" class="difflineminus">-GET_SET_STR_ATTR(DisplayName, m_DisplayName)</span>
<a href="#l18.909"></a><span id="l18.909" class="difflineminus">-GET_SET_STR_ATTR(NickName, m_NickName)</span>
<a href="#l18.910"></a><span id="l18.910" class="difflineminus">-GET_SET_STR_ATTR(PrimaryEmail, m_PrimaryEmail)</span>
<a href="#l18.911"></a><span id="l18.911" class="difflineminus">-GET_SET_STR_ATTR(SecondEmail, m_SecondEmail)</span>
<a href="#l18.912"></a><span id="l18.912" class="difflineminus">-GET_SET_STR_ATTR(WorkPhone, m_WorkPhone)</span>
<a href="#l18.913"></a><span id="l18.913" class="difflineminus">-GET_SET_STR_ATTR(HomePhone, m_HomePhone)</span>
<a href="#l18.914"></a><span id="l18.914" class="difflineminus">-GET_SET_STR_ATTR(FaxNumber, m_FaxNumber)</span>
<a href="#l18.915"></a><span id="l18.915" class="difflineminus">-GET_SET_STR_ATTR(PagerNumber, m_PagerNumber)</span>
<a href="#l18.916"></a><span id="l18.916" class="difflineminus">-GET_SET_STR_ATTR(CellularNumber, m_CellularNumber)</span>
<a href="#l18.917"></a><span id="l18.917" class="difflineminus">-GET_SET_STR_ATTR(WorkPhoneType, m_WorkPhoneType)</span>
<a href="#l18.918"></a><span id="l18.918" class="difflineminus">-GET_SET_STR_ATTR(HomePhoneType, m_HomePhoneType)</span>
<a href="#l18.919"></a><span id="l18.919" class="difflineminus">-GET_SET_STR_ATTR(FaxNumberType, m_FaxNumberType)</span>
<a href="#l18.920"></a><span id="l18.920" class="difflineminus">-GET_SET_STR_ATTR(PagerNumberType, m_PagerNumberType)</span>
<a href="#l18.921"></a><span id="l18.921" class="difflineminus">-GET_SET_STR_ATTR(CellularNumberType, m_CellularNumberType)</span>
<a href="#l18.922"></a><span id="l18.922" class="difflineminus">-GET_SET_STR_ATTR(HomeAddress, m_HomeAddress)</span>
<a href="#l18.923"></a><span id="l18.923" class="difflineminus">-GET_SET_STR_ATTR(HomeAddress2, m_HomeAddress2)</span>
<a href="#l18.924"></a><span id="l18.924" class="difflineminus">-GET_SET_STR_ATTR(HomeCity, m_HomeCity)</span>
<a href="#l18.925"></a><span id="l18.925" class="difflineminus">-GET_SET_STR_ATTR(HomeState, m_HomeState)</span>
<a href="#l18.926"></a><span id="l18.926" class="difflineminus">-GET_SET_STR_ATTR(HomeZipCode, m_HomeZipCode)</span>
<a href="#l18.927"></a><span id="l18.927" class="difflineminus">-GET_SET_STR_ATTR(HomeCountry, m_HomeCountry)</span>
<a href="#l18.928"></a><span id="l18.928" class="difflineminus">-GET_SET_STR_ATTR(WorkAddress, m_WorkAddress)</span>
<a href="#l18.929"></a><span id="l18.929" class="difflineminus">-GET_SET_STR_ATTR(WorkAddress2, m_WorkAddress2)</span>
<a href="#l18.930"></a><span id="l18.930" class="difflineminus">-GET_SET_STR_ATTR(WorkCity, m_WorkCity)</span>
<a href="#l18.931"></a><span id="l18.931" class="difflineminus">-GET_SET_STR_ATTR(WorkState, m_WorkState)</span>
<a href="#l18.932"></a><span id="l18.932" class="difflineminus">-GET_SET_STR_ATTR(WorkZipCode, m_WorkZipCode)</span>
<a href="#l18.933"></a><span id="l18.933" class="difflineminus">-GET_SET_STR_ATTR(WorkCountry, m_WorkCountry)</span>
<a href="#l18.934"></a><span id="l18.934" class="difflineminus">-GET_SET_STR_ATTR(JobTitle, m_JobTitle)</span>
<a href="#l18.935"></a><span id="l18.935" class="difflineminus">-GET_SET_STR_ATTR(Department, m_Department)</span>
<a href="#l18.936"></a><span id="l18.936" class="difflineminus">-GET_SET_STR_ATTR(Company, m_Company)</span>
<a href="#l18.937"></a><span id="l18.937" class="difflineminus">-GET_SET_STR_ATTR(AimScreenName, m_AimScreenName)</span>
<a href="#l18.938"></a><span id="l18.938" class="difflineminus">-GET_SET_STR_ATTR(AnniversaryYear, m_AnniversaryYear)</span>
<a href="#l18.939"></a><span id="l18.939" class="difflineminus">-GET_SET_STR_ATTR(AnniversaryMonth, m_AnniversaryMonth)</span>
<a href="#l18.940"></a><span id="l18.940" class="difflineminus">-GET_SET_STR_ATTR(AnniversaryDay, m_AnniversaryDay)</span>
<a href="#l18.941"></a><span id="l18.941" class="difflineminus">-GET_SET_STR_ATTR(SpouseName, m_SpouseName)</span>
<a href="#l18.942"></a><span id="l18.942" class="difflineminus">-GET_SET_STR_ATTR(FamilyName, m_FamilyName)</span>
<a href="#l18.943"></a><span id="l18.943" class="difflineminus">-GET_SET_STR_ATTR(DefaultAddress, m_DefaultAddress)</span>
<a href="#l18.944"></a><span id="l18.944" class="difflineminus">-GET_SET_STR_ATTR(Category, m_Category)</span>
<a href="#l18.945"></a><span id="l18.945" class="difflineminus">-GET_SET_STR_ATTR(WebPage1, m_WebPage1)</span>
<a href="#l18.946"></a><span id="l18.946" class="difflineminus">-GET_SET_STR_ATTR(WebPage2, m_WebPage2)</span>
<a href="#l18.947"></a><span id="l18.947" class="difflineminus">-GET_SET_STR_ATTR(BirthYear, m_BirthYear)</span>
<a href="#l18.948"></a><span id="l18.948" class="difflineminus">-GET_SET_STR_ATTR(BirthMonth, m_BirthMonth)</span>
<a href="#l18.949"></a><span id="l18.949" class="difflineminus">-GET_SET_STR_ATTR(BirthDay, m_BirthDay)</span>
<a href="#l18.950"></a><span id="l18.950" class="difflineminus">-GET_SET_STR_ATTR(Custom1, m_Custom1)</span>
<a href="#l18.951"></a><span id="l18.951" class="difflineminus">-GET_SET_STR_ATTR(Custom2, m_Custom2)</span>
<a href="#l18.952"></a><span id="l18.952" class="difflineminus">-GET_SET_STR_ATTR(Custom3, m_Custom3)</span>
<a href="#l18.953"></a><span id="l18.953" class="difflineminus">-GET_SET_STR_ATTR(Custom4, m_Custom4)</span>
<a href="#l18.954"></a><span id="l18.954" class="difflineminus">-GET_SET_STR_ATTR(Notes, m_Note)</span>
<a href="#l18.955"></a><span id="l18.955" class="difflineplus">+NS_IMETHODIMP nsAbCardProperty::SetDisplayName(const nsAString &amp;aString)</span>
<a href="#l18.956"></a><span id="l18.956" class="difflineplus">+{</span>
<a href="#l18.957"></a><span id="l18.957" class="difflineplus">+  return SetPropertyAsAString(kDisplayNameProperty, aString);</span>
<a href="#l18.958"></a><span id="l18.958" class="difflineplus">+}</span>
<a href="#l18.959"></a><span id="l18.959" class="difflineplus">+</span>
<a href="#l18.960"></a><span id="l18.960" class="difflineplus">+NS_IMETHODIMP nsAbCardProperty::GetPrimaryEmail(nsAString &amp;aString)</span>
<a href="#l18.961"></a><span id="l18.961" class="difflineplus">+{</span>
<a href="#l18.962"></a><span id="l18.962" class="difflineplus">+  nsresult rv = GetPropertyAsAString(kPriEmailProperty, aString);</span>
<a href="#l18.963"></a><span id="l18.963" class="difflineplus">+  if (rv == NS_ERROR_NOT_AVAILABLE)</span>
<a href="#l18.964"></a><span id="l18.964" class="difflineplus">+  {</span>
<a href="#l18.965"></a><span id="l18.965" class="difflineplus">+    aString.Truncate();</span>
<a href="#l18.966"></a><span id="l18.966" class="difflineplus">+    return NS_OK;</span>
<a href="#l18.967"></a><span id="l18.967" class="difflineplus">+  }</span>
<a href="#l18.968"></a><span id="l18.968" class="difflineplus">+  return rv;</span>
<a href="#l18.969"></a><span id="l18.969" class="difflineplus">+}</span>
<a href="#l18.970"></a><span id="l18.970" class="difflineplus">+</span>
<a href="#l18.971"></a><span id="l18.971" class="difflineplus">+NS_IMETHODIMP nsAbCardProperty::SetPrimaryEmail(const nsAString &amp;aString)</span>
<a href="#l18.972"></a><span id="l18.972" class="difflineplus">+{</span>
<a href="#l18.973"></a><span id="l18.973" class="difflineplus">+  return SetPropertyAsAString(kPriEmailProperty, aString);</span>
<a href="#l18.974"></a><span id="l18.974" class="difflineplus">+}</span>
<a href="#l18.975"></a><span id="l18.975"> </span>
<a href="#l18.976"></a><span id="l18.976"> // This function may be overriden by derived classes for</span>
<a href="#l18.977"></a><span id="l18.977"> // nsAb*Card specific implementations.</span>
<a href="#l18.978"></a><span id="l18.978"> NS_IMETHODIMP nsAbCardProperty::Copy(nsIAbCard* srcCard)</span>
<a href="#l18.979"></a><span id="l18.979"> {</span>
<a href="#l18.980"></a><span id="l18.980">   NS_ENSURE_ARG_POINTER(srcCard);</span>
<a href="#l18.981"></a><span id="l18.981"> </span>
<a href="#l18.982"></a><span id="l18.982" class="difflineminus">-  nsString str;</span>
<a href="#l18.983"></a><span id="l18.983" class="difflineminus">-  srcCard-&gt;GetFirstName(str);</span>
<a href="#l18.984"></a><span id="l18.984" class="difflineminus">-  SetFirstName(str);</span>
<a href="#l18.985"></a><span id="l18.985" class="difflineplus">+  nsCOMPtr&lt;nsISimpleEnumerator&gt; properties;</span>
<a href="#l18.986"></a><span id="l18.986" class="difflineplus">+  nsresult rv = srcCard-&gt;GetProperties(getter_AddRefs(properties));</span>
<a href="#l18.987"></a><span id="l18.987" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.988"></a><span id="l18.988"> </span>
<a href="#l18.989"></a><span id="l18.989" class="difflineminus">-  srcCard-&gt;GetLastName(str);</span>
<a href="#l18.990"></a><span id="l18.990" class="difflineminus">-  SetLastName(str);</span>
<a href="#l18.991"></a><span id="l18.991" class="difflineminus">-  srcCard-&gt;GetPhoneticFirstName(str);</span>
<a href="#l18.992"></a><span id="l18.992" class="difflineminus">-  SetPhoneticFirstName(str);</span>
<a href="#l18.993"></a><span id="l18.993" class="difflineminus">-  srcCard-&gt;GetPhoneticLastName(str);</span>
<a href="#l18.994"></a><span id="l18.994" class="difflineminus">-  SetPhoneticLastName(str);</span>
<a href="#l18.995"></a><span id="l18.995" class="difflineminus">-  srcCard-&gt;GetDisplayName(str);</span>
<a href="#l18.996"></a><span id="l18.996" class="difflineminus">-  SetDisplayName(str);</span>
<a href="#l18.997"></a><span id="l18.997" class="difflineminus">-  srcCard-&gt;GetNickName(str);</span>
<a href="#l18.998"></a><span id="l18.998" class="difflineminus">-  SetNickName(str);</span>
<a href="#l18.999"></a><span id="l18.999" class="difflineminus">-  srcCard-&gt;GetPrimaryEmail(str);</span>
<a href="#l18.1000"></a><span id="l18.1000" class="difflineminus">-  SetPrimaryEmail(str);</span>
<a href="#l18.1001"></a><span id="l18.1001" class="difflineminus">-  srcCard-&gt;GetSecondEmail(str);</span>
<a href="#l18.1002"></a><span id="l18.1002" class="difflineminus">-  SetSecondEmail(str);</span>
<a href="#l18.1003"></a><span id="l18.1003" class="difflineminus">-</span>
<a href="#l18.1004"></a><span id="l18.1004" class="difflineminus">-  PRUint32 format = nsIAbPreferMailFormat::unknown;</span>
<a href="#l18.1005"></a><span id="l18.1005" class="difflineminus">-  srcCard-&gt;GetPreferMailFormat(&amp;format);</span>
<a href="#l18.1006"></a><span id="l18.1006" class="difflineminus">-  SetPreferMailFormat(format);</span>
<a href="#l18.1007"></a><span id="l18.1007" class="difflineminus">-</span>
<a href="#l18.1008"></a><span id="l18.1008" class="difflineminus">-  PRUint32 popularityIndex = 0;</span>
<a href="#l18.1009"></a><span id="l18.1009" class="difflineminus">-  srcCard-&gt;GetPopularityIndex(&amp;popularityIndex);</span>
<a href="#l18.1010"></a><span id="l18.1010" class="difflineminus">-  SetPopularityIndex(popularityIndex);</span>
<a href="#l18.1011"></a><span id="l18.1011" class="difflineminus">-</span>
<a href="#l18.1012"></a><span id="l18.1012" class="difflineminus">-  PRBool allowRemoteContent = PR_FALSE;</span>
<a href="#l18.1013"></a><span id="l18.1013" class="difflineminus">-  srcCard-&gt;GetAllowRemoteContent(&amp;allowRemoteContent);</span>
<a href="#l18.1014"></a><span id="l18.1014" class="difflineminus">-  SetAllowRemoteContent(allowRemoteContent);</span>
<a href="#l18.1015"></a><span id="l18.1015" class="difflineplus">+  PRBool hasMore;</span>
<a href="#l18.1016"></a><span id="l18.1016" class="difflineplus">+  nsCOMPtr&lt;nsISupports&gt; result;</span>
<a href="#l18.1017"></a><span id="l18.1017" class="difflineplus">+  while (NS_SUCCEEDED(rv = properties-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore)</span>
<a href="#l18.1018"></a><span id="l18.1018" class="difflineplus">+  {</span>
<a href="#l18.1019"></a><span id="l18.1019" class="difflineplus">+    rv = properties-&gt;GetNext(getter_AddRefs(result));</span>
<a href="#l18.1020"></a><span id="l18.1020" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1021"></a><span id="l18.1021"> </span>
<a href="#l18.1022"></a><span id="l18.1022" class="difflineminus">-  srcCard-&gt;GetWorkPhone(str);</span>
<a href="#l18.1023"></a><span id="l18.1023" class="difflineminus">-  SetWorkPhone(str);</span>
<a href="#l18.1024"></a><span id="l18.1024" class="difflineminus">-  srcCard-&gt;GetHomePhone(str);</span>
<a href="#l18.1025"></a><span id="l18.1025" class="difflineminus">-  SetHomePhone(str);</span>
<a href="#l18.1026"></a><span id="l18.1026" class="difflineminus">-  srcCard-&gt;GetFaxNumber(str);</span>
<a href="#l18.1027"></a><span id="l18.1027" class="difflineminus">-  SetFaxNumber(str);</span>
<a href="#l18.1028"></a><span id="l18.1028" class="difflineminus">-  srcCard-&gt;GetPagerNumber(str);</span>
<a href="#l18.1029"></a><span id="l18.1029" class="difflineminus">-  SetPagerNumber(str);</span>
<a href="#l18.1030"></a><span id="l18.1030" class="difflineminus">-  srcCard-&gt;GetCellularNumber(str);</span>
<a href="#l18.1031"></a><span id="l18.1031" class="difflineminus">-  SetCellularNumber(str);</span>
<a href="#l18.1032"></a><span id="l18.1032" class="difflineminus">-  srcCard-&gt;GetWorkPhoneType(str);</span>
<a href="#l18.1033"></a><span id="l18.1033" class="difflineminus">-  SetWorkPhoneType(str);</span>
<a href="#l18.1034"></a><span id="l18.1034" class="difflineminus">-  srcCard-&gt;GetHomePhoneType(str);</span>
<a href="#l18.1035"></a><span id="l18.1035" class="difflineminus">-  SetHomePhoneType(str);</span>
<a href="#l18.1036"></a><span id="l18.1036" class="difflineminus">-  srcCard-&gt;GetFaxNumberType(str);</span>
<a href="#l18.1037"></a><span id="l18.1037" class="difflineminus">-  SetFaxNumberType(str);</span>
<a href="#l18.1038"></a><span id="l18.1038" class="difflineminus">-  srcCard-&gt;GetPagerNumberType(str);</span>
<a href="#l18.1039"></a><span id="l18.1039" class="difflineminus">-  SetPagerNumberType(str);</span>
<a href="#l18.1040"></a><span id="l18.1040" class="difflineminus">-  srcCard-&gt;GetCellularNumberType(str);</span>
<a href="#l18.1041"></a><span id="l18.1041" class="difflineminus">-  SetCellularNumberType(str);</span>
<a href="#l18.1042"></a><span id="l18.1042" class="difflineminus">-  srcCard-&gt;GetHomeAddress(str);</span>
<a href="#l18.1043"></a><span id="l18.1043" class="difflineminus">-  SetHomeAddress(str);</span>
<a href="#l18.1044"></a><span id="l18.1044" class="difflineminus">-  srcCard-&gt;GetHomeAddress2(str);</span>
<a href="#l18.1045"></a><span id="l18.1045" class="difflineminus">-  SetHomeAddress2(str);</span>
<a href="#l18.1046"></a><span id="l18.1046" class="difflineminus">-  srcCard-&gt;GetHomeCity(str);</span>
<a href="#l18.1047"></a><span id="l18.1047" class="difflineminus">-  SetHomeCity(str);</span>
<a href="#l18.1048"></a><span id="l18.1048" class="difflineminus">-  srcCard-&gt;GetHomeState(str);</span>
<a href="#l18.1049"></a><span id="l18.1049" class="difflineminus">-  SetHomeState(str);</span>
<a href="#l18.1050"></a><span id="l18.1050" class="difflineminus">-  srcCard-&gt;GetHomeZipCode(str);</span>
<a href="#l18.1051"></a><span id="l18.1051" class="difflineminus">-  SetHomeZipCode(str);</span>
<a href="#l18.1052"></a><span id="l18.1052" class="difflineminus">-  srcCard-&gt;GetHomeCountry(str);</span>
<a href="#l18.1053"></a><span id="l18.1053" class="difflineminus">-  SetHomeCountry(str);</span>
<a href="#l18.1054"></a><span id="l18.1054" class="difflineminus">-  srcCard-&gt;GetWorkAddress(str);</span>
<a href="#l18.1055"></a><span id="l18.1055" class="difflineminus">-  SetWorkAddress(str);</span>
<a href="#l18.1056"></a><span id="l18.1056" class="difflineminus">-  srcCard-&gt;GetWorkAddress2(str);</span>
<a href="#l18.1057"></a><span id="l18.1057" class="difflineminus">-  SetWorkAddress2(str);</span>
<a href="#l18.1058"></a><span id="l18.1058" class="difflineminus">-  srcCard-&gt;GetWorkCity(str);</span>
<a href="#l18.1059"></a><span id="l18.1059" class="difflineminus">-  SetWorkCity(str);</span>
<a href="#l18.1060"></a><span id="l18.1060" class="difflineminus">-  srcCard-&gt;GetWorkState(str);</span>
<a href="#l18.1061"></a><span id="l18.1061" class="difflineminus">-  SetWorkState(str);</span>
<a href="#l18.1062"></a><span id="l18.1062" class="difflineminus">-  srcCard-&gt;GetWorkZipCode(str);</span>
<a href="#l18.1063"></a><span id="l18.1063" class="difflineminus">-  SetWorkZipCode(str);</span>
<a href="#l18.1064"></a><span id="l18.1064" class="difflineminus">-  srcCard-&gt;GetWorkCountry(str);</span>
<a href="#l18.1065"></a><span id="l18.1065" class="difflineminus">-  SetWorkCountry(str);</span>
<a href="#l18.1066"></a><span id="l18.1066" class="difflineminus">-  srcCard-&gt;GetJobTitle(str);</span>
<a href="#l18.1067"></a><span id="l18.1067" class="difflineminus">-  SetJobTitle(str);</span>
<a href="#l18.1068"></a><span id="l18.1068" class="difflineminus">-  srcCard-&gt;GetDepartment(str);</span>
<a href="#l18.1069"></a><span id="l18.1069" class="difflineminus">-  SetDepartment(str);</span>
<a href="#l18.1070"></a><span id="l18.1070" class="difflineminus">-  srcCard-&gt;GetCompany(str);</span>
<a href="#l18.1071"></a><span id="l18.1071" class="difflineminus">-  SetCompany(str);</span>
<a href="#l18.1072"></a><span id="l18.1072" class="difflineminus">-  srcCard-&gt;GetAimScreenName(str);</span>
<a href="#l18.1073"></a><span id="l18.1073" class="difflineminus">-  SetAimScreenName(str);</span>
<a href="#l18.1074"></a><span id="l18.1074" class="difflineplus">+    nsCOMPtr&lt;nsIProperty&gt; property = do_QueryInterface(result, &amp;rv);</span>
<a href="#l18.1075"></a><span id="l18.1075" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1076"></a><span id="l18.1076"> </span>
<a href="#l18.1077"></a><span id="l18.1077" class="difflineminus">-  srcCard-&gt;GetAnniversaryYear(str);</span>
<a href="#l18.1078"></a><span id="l18.1078" class="difflineminus">-  SetAnniversaryYear(str);</span>
<a href="#l18.1079"></a><span id="l18.1079" class="difflineminus">-  srcCard-&gt;GetAnniversaryMonth(str);</span>
<a href="#l18.1080"></a><span id="l18.1080" class="difflineminus">-  SetAnniversaryMonth(str);</span>
<a href="#l18.1081"></a><span id="l18.1081" class="difflineminus">-  srcCard-&gt;GetAnniversaryDay(str);</span>
<a href="#l18.1082"></a><span id="l18.1082" class="difflineminus">-  SetAnniversaryDay(str);</span>
<a href="#l18.1083"></a><span id="l18.1083" class="difflineminus">-  srcCard-&gt;GetSpouseName(str);</span>
<a href="#l18.1084"></a><span id="l18.1084" class="difflineminus">-  SetSpouseName(str);</span>
<a href="#l18.1085"></a><span id="l18.1085" class="difflineminus">-  srcCard-&gt;GetFamilyName(str);</span>
<a href="#l18.1086"></a><span id="l18.1086" class="difflineminus">-  SetFamilyName(str);</span>
<a href="#l18.1087"></a><span id="l18.1087" class="difflineminus">-  srcCard-&gt;GetDefaultAddress(str);</span>
<a href="#l18.1088"></a><span id="l18.1088" class="difflineminus">-  SetDefaultAddress(str);</span>
<a href="#l18.1089"></a><span id="l18.1089" class="difflineminus">-  srcCard-&gt;GetCategory(str);</span>
<a href="#l18.1090"></a><span id="l18.1090" class="difflineminus">-  SetCategory(str);</span>
<a href="#l18.1091"></a><span id="l18.1091" class="difflineplus">+    nsAutoString name;</span>
<a href="#l18.1092"></a><span id="l18.1092" class="difflineplus">+    property-&gt;GetName(name);</span>
<a href="#l18.1093"></a><span id="l18.1093" class="difflineplus">+    nsCOMPtr&lt;nsIVariant&gt; value;</span>
<a href="#l18.1094"></a><span id="l18.1094" class="difflineplus">+    property-&gt;GetValue(getter_AddRefs(value));</span>
<a href="#l18.1095"></a><span id="l18.1095"> </span>
<a href="#l18.1096"></a><span id="l18.1096" class="difflineminus">-  srcCard-&gt;GetWebPage1(str);</span>
<a href="#l18.1097"></a><span id="l18.1097" class="difflineminus">-  SetWebPage1(str);</span>
<a href="#l18.1098"></a><span id="l18.1098" class="difflineminus">-  srcCard-&gt;GetWebPage2(str);</span>
<a href="#l18.1099"></a><span id="l18.1099" class="difflineminus">-  SetWebPage2(str);</span>
<a href="#l18.1100"></a><span id="l18.1100" class="difflineminus">-  srcCard-&gt;GetBirthYear(str);</span>
<a href="#l18.1101"></a><span id="l18.1101" class="difflineminus">-  SetBirthYear(str);</span>
<a href="#l18.1102"></a><span id="l18.1102" class="difflineminus">-  srcCard-&gt;GetBirthMonth(str);</span>
<a href="#l18.1103"></a><span id="l18.1103" class="difflineminus">-  SetBirthMonth(str);</span>
<a href="#l18.1104"></a><span id="l18.1104" class="difflineminus">-  srcCard-&gt;GetBirthDay(str);</span>
<a href="#l18.1105"></a><span id="l18.1105" class="difflineminus">-  SetBirthDay(str);</span>
<a href="#l18.1106"></a><span id="l18.1106" class="difflineminus">-  srcCard-&gt;GetCustom1(str);</span>
<a href="#l18.1107"></a><span id="l18.1107" class="difflineminus">-  SetCustom1(str);</span>
<a href="#l18.1108"></a><span id="l18.1108" class="difflineminus">-  srcCard-&gt;GetCustom2(str);</span>
<a href="#l18.1109"></a><span id="l18.1109" class="difflineminus">-  SetCustom2(str);</span>
<a href="#l18.1110"></a><span id="l18.1110" class="difflineminus">-  srcCard-&gt;GetCustom3(str);</span>
<a href="#l18.1111"></a><span id="l18.1111" class="difflineminus">-  SetCustom3(str);</span>
<a href="#l18.1112"></a><span id="l18.1112" class="difflineminus">-  srcCard-&gt;GetCustom4(str);</span>
<a href="#l18.1113"></a><span id="l18.1113" class="difflineminus">-  SetCustom4(str);</span>
<a href="#l18.1114"></a><span id="l18.1114" class="difflineminus">-  srcCard-&gt;GetNotes(str);</span>
<a href="#l18.1115"></a><span id="l18.1115" class="difflineminus">-  SetNotes(str);</span>
<a href="#l18.1116"></a><span id="l18.1116" class="difflineplus">+    SetProperty(NS_ConvertUTF16toUTF8(name), value);</span>
<a href="#l18.1117"></a><span id="l18.1117" class="difflineplus">+  }</span>
<a href="#l18.1118"></a><span id="l18.1118" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1119"></a><span id="l18.1119"> </span>
<a href="#l18.1120"></a><span id="l18.1120">   PRBool isMailList;</span>
<a href="#l18.1121"></a><span id="l18.1121">   srcCard-&gt;GetIsMailList(&amp;isMailList);</span>
<a href="#l18.1122"></a><span id="l18.1122">   SetIsMailList(isMailList);</span>
<a href="#l18.1123"></a><span id="l18.1123"> </span>
<a href="#l18.1124"></a><span id="l18.1124">   nsCString mailListURI;</span>
<a href="#l18.1125"></a><span id="l18.1125">   srcCard-&gt;GetMailListURI(getter_Copies(mailListURI));</span>
<a href="#l18.1126"></a><span id="l18.1126">   SetMailListURI(mailListURI.get());</span>
<a href="#l18.1127"></a><span id="l18.1127" class="difflineat">@@ -949,26 +407,50 @@ NS_IMETHODIMP nsAbCardProperty::Copy(nsI</span>
<a href="#l18.1128"></a><span id="l18.1128"> }</span>
<a href="#l18.1129"></a><span id="l18.1129"> </span>
<a href="#l18.1130"></a><span id="l18.1130"> NS_IMETHODIMP nsAbCardProperty::Equals(nsIAbCard *card, PRBool *result)</span>
<a href="#l18.1131"></a><span id="l18.1131"> {</span>
<a href="#l18.1132"></a><span id="l18.1132">   *result = (card == this);</span>
<a href="#l18.1133"></a><span id="l18.1133">   return NS_OK;</span>
<a href="#l18.1134"></a><span id="l18.1134"> }</span>
<a href="#l18.1135"></a><span id="l18.1135"> </span>
<a href="#l18.1136"></a><span id="l18.1136" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l18.1137"></a><span id="l18.1137" class="difflineplus">+// The following methods are other views of a card</span>
<a href="#l18.1138"></a><span id="l18.1138" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l18.1139"></a><span id="l18.1139" class="difflineplus">+</span>
<a href="#l18.1140"></a><span id="l18.1140" class="difflineplus">+// XXX: Use the category manager instead of this file to implement these</span>
<a href="#l18.1141"></a><span id="l18.1141" class="difflineplus">+NS_IMETHODIMP nsAbCardProperty::TranslateTo(const nsACString &amp;type, nsACString &amp;result)</span>
<a href="#l18.1142"></a><span id="l18.1142" class="difflineplus">+{</span>
<a href="#l18.1143"></a><span id="l18.1143" class="difflineplus">+  if (type.EqualsLiteral(&quot;base64&quot;))</span>
<a href="#l18.1144"></a><span id="l18.1144" class="difflineplus">+    return ConvertToBase64EncodedXML(result);</span>
<a href="#l18.1145"></a><span id="l18.1145" class="difflineplus">+  else if (type.EqualsLiteral(&quot;xml&quot;))</span>
<a href="#l18.1146"></a><span id="l18.1146" class="difflineplus">+  {</span>
<a href="#l18.1147"></a><span id="l18.1147" class="difflineplus">+    nsString utf16String;</span>
<a href="#l18.1148"></a><span id="l18.1148" class="difflineplus">+    nsresult rv = ConvertToXMLPrintData(utf16String);</span>
<a href="#l18.1149"></a><span id="l18.1149" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1150"></a><span id="l18.1150" class="difflineplus">+    result = NS_ConvertUTF16toUTF8(utf16String);</span>
<a href="#l18.1151"></a><span id="l18.1151" class="difflineplus">+    return NS_OK;</span>
<a href="#l18.1152"></a><span id="l18.1152" class="difflineplus">+  }</span>
<a href="#l18.1153"></a><span id="l18.1153" class="difflineplus">+  else if (type.EqualsLiteral(&quot;vcard&quot;))</span>
<a href="#l18.1154"></a><span id="l18.1154" class="difflineplus">+    return ConvertToEscapedVCard(result);</span>
<a href="#l18.1155"></a><span id="l18.1155" class="difflineplus">+</span>
<a href="#l18.1156"></a><span id="l18.1156" class="difflineplus">+  return NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l18.1157"></a><span id="l18.1157" class="difflineplus">+}</span>
<a href="#l18.1158"></a><span id="l18.1158" class="difflineplus">+//</span>
<a href="#l18.1159"></a><span id="l18.1159"> static VObject* myAddPropValue(VObject *o, const char *propName, const PRUnichar *propValue, PRBool *aCardHasData)</span>
<a href="#l18.1160"></a><span id="l18.1160"> {</span>
<a href="#l18.1161"></a><span id="l18.1161">     if (aCardHasData)</span>
<a href="#l18.1162"></a><span id="l18.1162">         *aCardHasData = PR_TRUE;</span>
<a href="#l18.1163"></a><span id="l18.1163">     return addPropValue(o, propName, NS_ConvertUTF16toUTF8(propValue).get());</span>
<a href="#l18.1164"></a><span id="l18.1164"> }</span>
<a href="#l18.1165"></a><span id="l18.1165"> </span>
<a href="#l18.1166"></a><span id="l18.1166" class="difflineminus">-NS_IMETHODIMP nsAbCardProperty::ConvertToEscapedVCard(char **aResult)</span>
<a href="#l18.1167"></a><span id="l18.1167" class="difflineplus">+nsresult nsAbCardProperty::ConvertToEscapedVCard(nsACString &amp;aResult)</span>
<a href="#l18.1168"></a><span id="l18.1168"> {</span>
<a href="#l18.1169"></a><span id="l18.1169">     nsString str;</span>
<a href="#l18.1170"></a><span id="l18.1170" class="difflineplus">+    nsresult rv;</span>
<a href="#l18.1171"></a><span id="l18.1171">     PRBool vCardHasData = PR_FALSE;</span>
<a href="#l18.1172"></a><span id="l18.1172">     VObject* vObj = newVObject(VCCardProp);</span>
<a href="#l18.1173"></a><span id="l18.1173">     VObject* t;</span>
<a href="#l18.1174"></a><span id="l18.1174"> </span>
<a href="#l18.1175"></a><span id="l18.1175">     // [comment from 4.x]</span>
<a href="#l18.1176"></a><span id="l18.1176">     // Big flame coming....so Vobject is not designed at all to work with  an array of</span>
<a href="#l18.1177"></a><span id="l18.1177">     // attribute values. It wants you to have all of the attributes easily available. You</span>
<a href="#l18.1178"></a><span id="l18.1178">     // cannot add one attribute at a time as you find them to the vobject. Why? Because</span>
<a href="#l18.1179"></a><span id="l18.1179" class="difflineat">@@ -995,81 +477,81 @@ NS_IMETHODIMP nsAbCardProperty::ConvertT</span>
<a href="#l18.1180"></a><span id="l18.1180">     (void)GetFirstName(str);</span>
<a href="#l18.1181"></a><span id="l18.1181">     if (!str.IsEmpty()) {</span>
<a href="#l18.1182"></a><span id="l18.1182">         t = isAPropertyOf(vObj, VCNameProp);</span>
<a href="#l18.1183"></a><span id="l18.1183">         if (!t)</span>
<a href="#l18.1184"></a><span id="l18.1184">             t = addProp(vObj, VCNameProp);</span>
<a href="#l18.1185"></a><span id="l18.1185">         myAddPropValue(t, VCGivenNameProp, str.get(), &amp;vCardHasData);</span>
<a href="#l18.1186"></a><span id="l18.1186">     }</span>
<a href="#l18.1187"></a><span id="l18.1187"> </span>
<a href="#l18.1188"></a><span id="l18.1188" class="difflineminus">-    (void)GetCompany(str);</span>
<a href="#l18.1189"></a><span id="l18.1189" class="difflineminus">-    if (!str.IsEmpty())</span>
<a href="#l18.1190"></a><span id="l18.1190" class="difflineplus">+    rv = GetPropertyAsAString(kCompanyProperty, str);</span>
<a href="#l18.1191"></a><span id="l18.1191" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; !str.IsEmpty())</span>
<a href="#l18.1192"></a><span id="l18.1192">     {</span>
<a href="#l18.1193"></a><span id="l18.1193">         t = isAPropertyOf(vObj, VCOrgProp);</span>
<a href="#l18.1194"></a><span id="l18.1194">         if (!t)</span>
<a href="#l18.1195"></a><span id="l18.1195">             t = addProp(vObj, VCOrgProp);</span>
<a href="#l18.1196"></a><span id="l18.1196">         myAddPropValue(t, VCOrgNameProp, str.get(), &amp;vCardHasData);</span>
<a href="#l18.1197"></a><span id="l18.1197">     }</span>
<a href="#l18.1198"></a><span id="l18.1198"> </span>
<a href="#l18.1199"></a><span id="l18.1199" class="difflineminus">-    (void)GetDepartment(str);</span>
<a href="#l18.1200"></a><span id="l18.1200" class="difflineminus">-    if (!str.IsEmpty())</span>
<a href="#l18.1201"></a><span id="l18.1201" class="difflineplus">+    rv = GetPropertyAsAString(kDepartmentProperty, str);</span>
<a href="#l18.1202"></a><span id="l18.1202" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; !str.IsEmpty())</span>
<a href="#l18.1203"></a><span id="l18.1203">     {</span>
<a href="#l18.1204"></a><span id="l18.1204">         t = isAPropertyOf(vObj, VCOrgProp);</span>
<a href="#l18.1205"></a><span id="l18.1205">         if (!t)</span>
<a href="#l18.1206"></a><span id="l18.1206">             t = addProp(vObj, VCOrgProp);</span>
<a href="#l18.1207"></a><span id="l18.1207">         myAddPropValue(t, VCOrgUnitProp, str.get(), &amp;vCardHasData);</span>
<a href="#l18.1208"></a><span id="l18.1208">     }</span>
<a href="#l18.1209"></a><span id="l18.1209"> </span>
<a href="#l18.1210"></a><span id="l18.1210" class="difflineminus">-    (void)GetWorkAddress2(str);</span>
<a href="#l18.1211"></a><span id="l18.1211" class="difflineminus">-    if (!str.IsEmpty())</span>
<a href="#l18.1212"></a><span id="l18.1212" class="difflineplus">+    rv = GetPropertyAsAString(kWorkAddress2Property, str);</span>
<a href="#l18.1213"></a><span id="l18.1213" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; !str.IsEmpty())</span>
<a href="#l18.1214"></a><span id="l18.1214">     {</span>
<a href="#l18.1215"></a><span id="l18.1215">         t = isAPropertyOf(vObj, VCAdrProp);</span>
<a href="#l18.1216"></a><span id="l18.1216">         if  (!t)</span>
<a href="#l18.1217"></a><span id="l18.1217">             t = addProp(vObj, VCAdrProp);</span>
<a href="#l18.1218"></a><span id="l18.1218">         myAddPropValue(t, VCPostalBoxProp, str.get(), &amp;vCardHasData);</span>
<a href="#l18.1219"></a><span id="l18.1219">     }</span>
<a href="#l18.1220"></a><span id="l18.1220"> </span>
<a href="#l18.1221"></a><span id="l18.1221" class="difflineminus">-    (void)GetWorkAddress(str);</span>
<a href="#l18.1222"></a><span id="l18.1222" class="difflineminus">-    if (!str.IsEmpty())</span>
<a href="#l18.1223"></a><span id="l18.1223" class="difflineplus">+    rv = GetPropertyAsAString(kWorkAddressProperty, str);</span>
<a href="#l18.1224"></a><span id="l18.1224" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; !str.IsEmpty())</span>
<a href="#l18.1225"></a><span id="l18.1225">     {</span>
<a href="#l18.1226"></a><span id="l18.1226">         t = isAPropertyOf(vObj, VCAdrProp);</span>
<a href="#l18.1227"></a><span id="l18.1227">         if  (!t)</span>
<a href="#l18.1228"></a><span id="l18.1228">             t = addProp(vObj, VCAdrProp);</span>
<a href="#l18.1229"></a><span id="l18.1229">         myAddPropValue(t, VCStreetAddressProp, str.get(), &amp;vCardHasData);</span>
<a href="#l18.1230"></a><span id="l18.1230">     }</span>
<a href="#l18.1231"></a><span id="l18.1231"> </span>
<a href="#l18.1232"></a><span id="l18.1232" class="difflineminus">-    (void)GetWorkCity(str);</span>
<a href="#l18.1233"></a><span id="l18.1233" class="difflineminus">-    if (!str.IsEmpty())</span>
<a href="#l18.1234"></a><span id="l18.1234" class="difflineplus">+    rv = GetPropertyAsAString(kWorkCityProperty, str);</span>
<a href="#l18.1235"></a><span id="l18.1235" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; !str.IsEmpty())</span>
<a href="#l18.1236"></a><span id="l18.1236">     {</span>
<a href="#l18.1237"></a><span id="l18.1237">         t = isAPropertyOf(vObj, VCAdrProp);</span>
<a href="#l18.1238"></a><span id="l18.1238">         if  (!t)</span>
<a href="#l18.1239"></a><span id="l18.1239">             t = addProp(vObj, VCAdrProp);</span>
<a href="#l18.1240"></a><span id="l18.1240">         myAddPropValue(t, VCCityProp, str.get(), &amp;vCardHasData);</span>
<a href="#l18.1241"></a><span id="l18.1241">     }</span>
<a href="#l18.1242"></a><span id="l18.1242"> </span>
<a href="#l18.1243"></a><span id="l18.1243" class="difflineminus">-    (void)GetWorkState(str);</span>
<a href="#l18.1244"></a><span id="l18.1244" class="difflineminus">-    if (!str.IsEmpty())</span>
<a href="#l18.1245"></a><span id="l18.1245" class="difflineplus">+    rv = GetPropertyAsAString(kWorkStateProperty, str);</span>
<a href="#l18.1246"></a><span id="l18.1246" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; !str.IsEmpty())</span>
<a href="#l18.1247"></a><span id="l18.1247">     {</span>
<a href="#l18.1248"></a><span id="l18.1248">         t = isAPropertyOf(vObj, VCAdrProp);</span>
<a href="#l18.1249"></a><span id="l18.1249">         if  (!t)</span>
<a href="#l18.1250"></a><span id="l18.1250">             t = addProp(vObj, VCAdrProp);</span>
<a href="#l18.1251"></a><span id="l18.1251">         myAddPropValue(t, VCRegionProp, str.get(), &amp;vCardHasData);</span>
<a href="#l18.1252"></a><span id="l18.1252">     }</span>
<a href="#l18.1253"></a><span id="l18.1253"> </span>
<a href="#l18.1254"></a><span id="l18.1254" class="difflineminus">-    (void)GetWorkZipCode(str);</span>
<a href="#l18.1255"></a><span id="l18.1255" class="difflineminus">-    if (!str.IsEmpty())</span>
<a href="#l18.1256"></a><span id="l18.1256" class="difflineplus">+    rv = GetPropertyAsAString(kWorkZipCodeProperty, str);</span>
<a href="#l18.1257"></a><span id="l18.1257" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; !str.IsEmpty())</span>
<a href="#l18.1258"></a><span id="l18.1258">     {</span>
<a href="#l18.1259"></a><span id="l18.1259">         t = isAPropertyOf(vObj, VCAdrProp);</span>
<a href="#l18.1260"></a><span id="l18.1260">         if  (!t)</span>
<a href="#l18.1261"></a><span id="l18.1261">             t = addProp(vObj, VCAdrProp);</span>
<a href="#l18.1262"></a><span id="l18.1262">         myAddPropValue(t, VCPostalCodeProp, str.get(), &amp;vCardHasData);</span>
<a href="#l18.1263"></a><span id="l18.1263">     }</span>
<a href="#l18.1264"></a><span id="l18.1264"> </span>
<a href="#l18.1265"></a><span id="l18.1265" class="difflineminus">-    (void)GetWorkCountry(str);</span>
<a href="#l18.1266"></a><span id="l18.1266" class="difflineminus">-    if (!str.IsEmpty())</span>
<a href="#l18.1267"></a><span id="l18.1267" class="difflineplus">+    rv = GetPropertyAsAString(kWorkCountryProperty, str);</span>
<a href="#l18.1268"></a><span id="l18.1268" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; !str.IsEmpty())</span>
<a href="#l18.1269"></a><span id="l18.1269">     {</span>
<a href="#l18.1270"></a><span id="l18.1270">         t = isAPropertyOf(vObj, VCAdrProp);</span>
<a href="#l18.1271"></a><span id="l18.1271">         if  (!t)</span>
<a href="#l18.1272"></a><span id="l18.1272">             t = addProp(vObj, VCAdrProp);</span>
<a href="#l18.1273"></a><span id="l18.1273">         myAddPropValue(t, VCCountryNameProp, str.get(), &amp;vCardHasData);</span>
<a href="#l18.1274"></a><span id="l18.1274">     }</span>
<a href="#l18.1275"></a><span id="l18.1275">     else</span>
<a href="#l18.1276"></a><span id="l18.1276">     {</span>
<a href="#l18.1277"></a><span id="l18.1277" class="difflineat">@@ -1077,103 +559,103 @@ NS_IMETHODIMP nsAbCardProperty::ConvertT</span>
<a href="#l18.1278"></a><span id="l18.1278">         t = isAPropertyOf(vObj, VCAdrProp);</span>
<a href="#l18.1279"></a><span id="l18.1279">         if (t)</span>
<a href="#l18.1280"></a><span id="l18.1280">         {</span>
<a href="#l18.1281"></a><span id="l18.1281">             addProp(t, VCDomesticProp);</span>
<a href="#l18.1282"></a><span id="l18.1282">         }</span>
<a href="#l18.1283"></a><span id="l18.1283">     }</span>
<a href="#l18.1284"></a><span id="l18.1284"> </span>
<a href="#l18.1285"></a><span id="l18.1285">     (void)GetPrimaryEmail(str);</span>
<a href="#l18.1286"></a><span id="l18.1286" class="difflineminus">-    if (!str.IsEmpty())</span>
<a href="#l18.1287"></a><span id="l18.1287" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; !str.IsEmpty())</span>
<a href="#l18.1288"></a><span id="l18.1288">     {</span>
<a href="#l18.1289"></a><span id="l18.1289">         t = myAddPropValue(vObj, VCEmailAddressProp, str.get(), &amp;vCardHasData);</span>
<a href="#l18.1290"></a><span id="l18.1290">         addProp(t, VCInternetProp);</span>
<a href="#l18.1291"></a><span id="l18.1291">     }</span>
<a href="#l18.1292"></a><span id="l18.1292"> </span>
<a href="#l18.1293"></a><span id="l18.1293" class="difflineminus">-    (void)GetJobTitle(str);</span>
<a href="#l18.1294"></a><span id="l18.1294" class="difflineminus">-    if (!str.IsEmpty())</span>
<a href="#l18.1295"></a><span id="l18.1295" class="difflineplus">+    rv = GetPropertyAsAString(kJobTitleProperty, str);</span>
<a href="#l18.1296"></a><span id="l18.1296" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; !str.IsEmpty())</span>
<a href="#l18.1297"></a><span id="l18.1297">     {</span>
<a href="#l18.1298"></a><span id="l18.1298">         myAddPropValue(vObj, VCTitleProp, str.get(), &amp;vCardHasData);</span>
<a href="#l18.1299"></a><span id="l18.1299">     }</span>
<a href="#l18.1300"></a><span id="l18.1300"> </span>
<a href="#l18.1301"></a><span id="l18.1301" class="difflineminus">-    (void)GetWorkPhone(str);</span>
<a href="#l18.1302"></a><span id="l18.1302" class="difflineminus">-    if (!str.IsEmpty())</span>
<a href="#l18.1303"></a><span id="l18.1303" class="difflineplus">+    rv = GetPropertyAsAString(kWorkPhoneProperty, str);</span>
<a href="#l18.1304"></a><span id="l18.1304" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; !str.IsEmpty())</span>
<a href="#l18.1305"></a><span id="l18.1305">     {</span>
<a href="#l18.1306"></a><span id="l18.1306">         t = myAddPropValue(vObj, VCTelephoneProp, str.get(), &amp;vCardHasData);</span>
<a href="#l18.1307"></a><span id="l18.1307">         addProp(t, VCWorkProp);</span>
<a href="#l18.1308"></a><span id="l18.1308">     }</span>
<a href="#l18.1309"></a><span id="l18.1309"> </span>
<a href="#l18.1310"></a><span id="l18.1310" class="difflineminus">-    (void)GetFaxNumber(str);</span>
<a href="#l18.1311"></a><span id="l18.1311" class="difflineminus">-    if (!str.IsEmpty())</span>
<a href="#l18.1312"></a><span id="l18.1312" class="difflineplus">+    rv = GetPropertyAsAString(kFaxProperty, str);</span>
<a href="#l18.1313"></a><span id="l18.1313" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; !str.IsEmpty())</span>
<a href="#l18.1314"></a><span id="l18.1314">     {</span>
<a href="#l18.1315"></a><span id="l18.1315">         t = myAddPropValue(vObj, VCTelephoneProp, str.get(), &amp;vCardHasData);</span>
<a href="#l18.1316"></a><span id="l18.1316">         addProp(t, VCFaxProp);</span>
<a href="#l18.1317"></a><span id="l18.1317">     }</span>
<a href="#l18.1318"></a><span id="l18.1318"> </span>
<a href="#l18.1319"></a><span id="l18.1319" class="difflineminus">-    (void)GetPagerNumber(str);</span>
<a href="#l18.1320"></a><span id="l18.1320" class="difflineminus">-    if (!str.IsEmpty())</span>
<a href="#l18.1321"></a><span id="l18.1321" class="difflineplus">+    rv = GetPropertyAsAString(kPagerProperty, str);</span>
<a href="#l18.1322"></a><span id="l18.1322" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; !str.IsEmpty())</span>
<a href="#l18.1323"></a><span id="l18.1323">     {</span>
<a href="#l18.1324"></a><span id="l18.1324">         t = myAddPropValue(vObj, VCTelephoneProp, str.get(), &amp;vCardHasData);</span>
<a href="#l18.1325"></a><span id="l18.1325">         addProp(t, VCPagerProp);</span>
<a href="#l18.1326"></a><span id="l18.1326">     }</span>
<a href="#l18.1327"></a><span id="l18.1327"> </span>
<a href="#l18.1328"></a><span id="l18.1328" class="difflineminus">-    (void)GetHomePhone(str);</span>
<a href="#l18.1329"></a><span id="l18.1329" class="difflineminus">-    if (!str.IsEmpty())</span>
<a href="#l18.1330"></a><span id="l18.1330" class="difflineplus">+    rv = GetPropertyAsAString(kHomePhoneProperty, str);</span>
<a href="#l18.1331"></a><span id="l18.1331" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; !str.IsEmpty())</span>
<a href="#l18.1332"></a><span id="l18.1332">     {</span>
<a href="#l18.1333"></a><span id="l18.1333">         t = myAddPropValue(vObj, VCTelephoneProp, str.get(), &amp;vCardHasData);</span>
<a href="#l18.1334"></a><span id="l18.1334">         addProp(t, VCHomeProp);</span>
<a href="#l18.1335"></a><span id="l18.1335">     }</span>
<a href="#l18.1336"></a><span id="l18.1336"> </span>
<a href="#l18.1337"></a><span id="l18.1337" class="difflineminus">-    (void)GetCellularNumber(str);</span>
<a href="#l18.1338"></a><span id="l18.1338" class="difflineminus">-    if (!str.IsEmpty())</span>
<a href="#l18.1339"></a><span id="l18.1339" class="difflineplus">+    rv = GetPropertyAsAString(kCellularProperty, str);</span>
<a href="#l18.1340"></a><span id="l18.1340" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; !str.IsEmpty())</span>
<a href="#l18.1341"></a><span id="l18.1341">     {</span>
<a href="#l18.1342"></a><span id="l18.1342">         t = myAddPropValue(vObj, VCTelephoneProp, str.get(), &amp;vCardHasData);</span>
<a href="#l18.1343"></a><span id="l18.1343">         addProp(t, VCCellularProp);</span>
<a href="#l18.1344"></a><span id="l18.1344">     }</span>
<a href="#l18.1345"></a><span id="l18.1345"> </span>
<a href="#l18.1346"></a><span id="l18.1346" class="difflineminus">-    (void)GetNotes(str);</span>
<a href="#l18.1347"></a><span id="l18.1347" class="difflineminus">-    if (!str.IsEmpty())</span>
<a href="#l18.1348"></a><span id="l18.1348" class="difflineplus">+    rv = GetPropertyAsAString(kNotesProperty, str);</span>
<a href="#l18.1349"></a><span id="l18.1349" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; !str.IsEmpty())</span>
<a href="#l18.1350"></a><span id="l18.1350">     {</span>
<a href="#l18.1351"></a><span id="l18.1351">         myAddPropValue(vObj, VCNoteProp, str.get(), &amp;vCardHasData);</span>
<a href="#l18.1352"></a><span id="l18.1352">     }</span>
<a href="#l18.1353"></a><span id="l18.1353"> </span>
<a href="#l18.1354"></a><span id="l18.1354">     PRUint32 format;</span>
<a href="#l18.1355"></a><span id="l18.1355" class="difflineminus">-    (void)GetPreferMailFormat(&amp;format);</span>
<a href="#l18.1356"></a><span id="l18.1356" class="difflineminus">-    if (format == nsIAbPreferMailFormat::html) {</span>
<a href="#l18.1357"></a><span id="l18.1357" class="difflineplus">+    rv = GetPropertyAsUint32(kPreferMailFormatProperty, &amp;format);</span>
<a href="#l18.1358"></a><span id="l18.1358" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; format == nsIAbPreferMailFormat::html) {</span>
<a href="#l18.1359"></a><span id="l18.1359">         myAddPropValue(vObj, VCUseHTML, NS_LITERAL_STRING(&quot;TRUE&quot;).get(), &amp;vCardHasData);</span>
<a href="#l18.1360"></a><span id="l18.1360">     }</span>
<a href="#l18.1361"></a><span id="l18.1361" class="difflineminus">-    else if (format == nsIAbPreferMailFormat::plaintext) {</span>
<a href="#l18.1362"></a><span id="l18.1362" class="difflineplus">+    else if (NS_SUCCEEDED(rv) &amp;&amp; format == nsIAbPreferMailFormat::plaintext) {</span>
<a href="#l18.1363"></a><span id="l18.1363">         myAddPropValue(vObj, VCUseHTML, NS_LITERAL_STRING(&quot;FALSE&quot;).get(), &amp;vCardHasData);</span>
<a href="#l18.1364"></a><span id="l18.1364">     }</span>
<a href="#l18.1365"></a><span id="l18.1365"> </span>
<a href="#l18.1366"></a><span id="l18.1366" class="difflineminus">-    (void)GetWebPage1(str);</span>
<a href="#l18.1367"></a><span id="l18.1367" class="difflineminus">-    if (!str.IsEmpty())</span>
<a href="#l18.1368"></a><span id="l18.1368" class="difflineplus">+    rv = GetPropertyAsAString(kWorkWebPageProperty, str);</span>
<a href="#l18.1369"></a><span id="l18.1369" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; !str.IsEmpty())</span>
<a href="#l18.1370"></a><span id="l18.1370">     {</span>
<a href="#l18.1371"></a><span id="l18.1371">         myAddPropValue(vObj, VCURLProp, str.get(), &amp;vCardHasData);</span>
<a href="#l18.1372"></a><span id="l18.1372">     }</span>
<a href="#l18.1373"></a><span id="l18.1373"> </span>
<a href="#l18.1374"></a><span id="l18.1374">     myAddPropValue(vObj, VCVersionProp, NS_LITERAL_STRING(&quot;2.1&quot;).get(), nsnull);</span>
<a href="#l18.1375"></a><span id="l18.1375"> </span>
<a href="#l18.1376"></a><span id="l18.1376">     if (!vCardHasData) {</span>
<a href="#l18.1377"></a><span id="l18.1377" class="difflineminus">-        *aResult = PL_strdup(&quot;&quot;);</span>
<a href="#l18.1378"></a><span id="l18.1378" class="difflineplus">+        aResult.Truncate();</span>
<a href="#l18.1379"></a><span id="l18.1379">         return NS_OK;</span>
<a href="#l18.1380"></a><span id="l18.1380">     }</span>
<a href="#l18.1381"></a><span id="l18.1381"> </span>
<a href="#l18.1382"></a><span id="l18.1382">     int len = 0;</span>
<a href="#l18.1383"></a><span id="l18.1383">     char *vCard = writeMemVObject(0, &amp;len, vObj);</span>
<a href="#l18.1384"></a><span id="l18.1384">     if (vObj)</span>
<a href="#l18.1385"></a><span id="l18.1385">         cleanVObject(vObj);</span>
<a href="#l18.1386"></a><span id="l18.1386"> </span>
<a href="#l18.1387"></a><span id="l18.1387">     nsCString escResult;</span>
<a href="#l18.1388"></a><span id="l18.1388">     MsgEscapeString(nsDependentCString(vCard), nsINetUtil::ESCAPE_URL_PATH, escResult);</span>
<a href="#l18.1389"></a><span id="l18.1389" class="difflineminus">-    *aResult = strdup(escResult.get());</span>
<a href="#l18.1390"></a><span id="l18.1390" class="difflineminus">-    return (*aResult ? NS_OK : NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l18.1391"></a><span id="l18.1391" class="difflineplus">+    aResult = escResult;</span>
<a href="#l18.1392"></a><span id="l18.1392" class="difflineplus">+    return NS_OK;</span>
<a href="#l18.1393"></a><span id="l18.1393"> }</span>
<a href="#l18.1394"></a><span id="l18.1394"> </span>
<a href="#l18.1395"></a><span id="l18.1395" class="difflineminus">-NS_IMETHODIMP nsAbCardProperty::ConvertToBase64EncodedXML(char **result)</span>
<a href="#l18.1396"></a><span id="l18.1396" class="difflineplus">+nsresult nsAbCardProperty::ConvertToBase64EncodedXML(nsACString &amp;result)</span>
<a href="#l18.1397"></a><span id="l18.1397"> {</span>
<a href="#l18.1398"></a><span id="l18.1398">   nsresult rv;</span>
<a href="#l18.1399"></a><span id="l18.1399">   nsString xmlStr;</span>
<a href="#l18.1400"></a><span id="l18.1400"> </span>
<a href="#l18.1401"></a><span id="l18.1401">   xmlStr.AppendLiteral(&quot;&lt;?xml version=\&quot;1.0\&quot;?&gt;\n&quot;</span>
<a href="#l18.1402"></a><span id="l18.1402">                        &quot;&lt;?xml-stylesheet type=\&quot;text/css\&quot; href=\&quot;chrome://messenger/content/addressbook/print.css\&quot;?&gt;\n&quot;</span>
<a href="#l18.1403"></a><span id="l18.1403">                        &quot;&lt;directory&gt;\n&quot;);</span>
<a href="#l18.1404"></a><span id="l18.1404"> </span>
<a href="#l18.1405"></a><span id="l18.1405" class="difflineat">@@ -1195,21 +677,21 @@ NS_IMETHODIMP nsAbCardProperty::ConvertT</span>
<a href="#l18.1406"></a><span id="l18.1406"> </span>
<a href="#l18.1407"></a><span id="l18.1407">   nsString xmlSubstr;</span>
<a href="#l18.1408"></a><span id="l18.1408">   rv = ConvertToXMLPrintData(xmlSubstr);</span>
<a href="#l18.1409"></a><span id="l18.1409">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l18.1410"></a><span id="l18.1410"> </span>
<a href="#l18.1411"></a><span id="l18.1411">   xmlStr.Append(xmlSubstr);</span>
<a href="#l18.1412"></a><span id="l18.1412">   xmlStr.AppendLiteral(&quot;&lt;/directory&gt;\n&quot;);</span>
<a href="#l18.1413"></a><span id="l18.1413"> </span>
<a href="#l18.1414"></a><span id="l18.1414" class="difflineminus">-  *result = PL_Base64Encode(NS_ConvertUTF16toUTF8(xmlStr).get(), 0, nsnull);</span>
<a href="#l18.1415"></a><span id="l18.1415" class="difflineminus">-  return (*result ? NS_OK : NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l18.1416"></a><span id="l18.1416" class="difflineplus">+  result.Adopt(PL_Base64Encode(NS_ConvertUTF16toUTF8(xmlStr).get(), 0, nsnull));</span>
<a href="#l18.1417"></a><span id="l18.1417" class="difflineplus">+  return NS_OK;</span>
<a href="#l18.1418"></a><span id="l18.1418"> }</span>
<a href="#l18.1419"></a><span id="l18.1419"> </span>
<a href="#l18.1420"></a><span id="l18.1420" class="difflineminus">-NS_IMETHODIMP nsAbCardProperty::ConvertToXMLPrintData(nsAString &amp;aXMLSubstr)</span>
<a href="#l18.1421"></a><span id="l18.1421" class="difflineplus">+nsresult nsAbCardProperty::ConvertToXMLPrintData(nsAString &amp;aXMLSubstr)</span>
<a href="#l18.1422"></a><span id="l18.1422"> {</span>
<a href="#l18.1423"></a><span id="l18.1423">   nsresult rv;</span>
<a href="#l18.1424"></a><span id="l18.1424">   nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch = do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l18.1425"></a><span id="l18.1425">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l18.1426"></a><span id="l18.1426"> </span>
<a href="#l18.1427"></a><span id="l18.1427">   PRInt32 generatedNameFormat;</span>
<a href="#l18.1428"></a><span id="l18.1428">   rv = prefBranch-&gt;GetIntPref(PREF_MAIL_ADDR_BOOK_LASTNAMEFIRST, &amp;generatedNameFormat);</span>
<a href="#l18.1429"></a><span id="l18.1429">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1430"></a><span id="l18.1430" class="difflineat">@@ -1237,18 +719,17 @@ NS_IMETHODIMP nsAbCardProperty::ConvertT</span>
<a href="#l18.1431"></a><span id="l18.1431">   if (!generatedName.IsEmpty()) {</span>
<a href="#l18.1432"></a><span id="l18.1432">     rv = conv-&gt;ScanTXT(generatedName.get(), mozITXTToHTMLConv::kEntities,</span>
<a href="#l18.1433"></a><span id="l18.1433">                        getter_Copies(safeText));</span>
<a href="#l18.1434"></a><span id="l18.1434">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l18.1435"></a><span id="l18.1435">   }</span>
<a href="#l18.1436"></a><span id="l18.1436"> </span>
<a href="#l18.1437"></a><span id="l18.1437">   if (safeText.IsEmpty()) {</span>
<a href="#l18.1438"></a><span id="l18.1438">     nsAutoString primaryEmail;</span>
<a href="#l18.1439"></a><span id="l18.1439" class="difflineminus">-    rv = GetCardValue(kPriEmailColumn, primaryEmail);</span>
<a href="#l18.1440"></a><span id="l18.1440" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l18.1441"></a><span id="l18.1441" class="difflineplus">+    GetPrimaryEmail(primaryEmail);</span>
<a href="#l18.1442"></a><span id="l18.1442"> </span>
<a href="#l18.1443"></a><span id="l18.1443">     // use ScanTXT to convert &lt; &gt; &amp; to safe values.</span>
<a href="#l18.1444"></a><span id="l18.1444">     rv = conv-&gt;ScanTXT(primaryEmail.get(), mozITXTToHTMLConv::kEntities,</span>
<a href="#l18.1445"></a><span id="l18.1445">                        getter_Copies(safeText));</span>
<a href="#l18.1446"></a><span id="l18.1446">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l18.1447"></a><span id="l18.1447">   }</span>
<a href="#l18.1448"></a><span id="l18.1448">   xmlStr.Append(safeText);</span>
<a href="#l18.1449"></a><span id="l18.1449"> </span>
<a href="#l18.1450"></a><span id="l18.1450" class="difflineat">@@ -1309,18 +790,17 @@ NS_IMETHODIMP nsAbCardProperty::ConvertT</span>
<a href="#l18.1451"></a><span id="l18.1451">           nsString safeText;</span>
<a href="#l18.1452"></a><span id="l18.1452">           rv = conv-&gt;ScanTXT(displayName.get(), mozITXTToHTMLConv::kEntities,</span>
<a href="#l18.1453"></a><span id="l18.1453">                              getter_Copies(safeText));</span>
<a href="#l18.1454"></a><span id="l18.1454">           NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l18.1455"></a><span id="l18.1455">           xmlStr.Append(safeText);</span>
<a href="#l18.1456"></a><span id="l18.1456"> </span>
<a href="#l18.1457"></a><span id="l18.1457">           xmlStr.AppendLiteral(&quot; &amp;lt;&quot;);</span>
<a href="#l18.1458"></a><span id="l18.1458"> </span>
<a href="#l18.1459"></a><span id="l18.1459" class="difflineminus">-          rv = listCard-&gt;GetPrimaryEmail(primaryEmail);</span>
<a href="#l18.1460"></a><span id="l18.1460" class="difflineminus">-          NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l18.1461"></a><span id="l18.1461" class="difflineplus">+          listCard-&gt;GetPrimaryEmail(primaryEmail);</span>
<a href="#l18.1462"></a><span id="l18.1462"> </span>
<a href="#l18.1463"></a><span id="l18.1463">           // use ScanTXT to convert &lt; &gt; &amp; to safe values.</span>
<a href="#l18.1464"></a><span id="l18.1464">           rv = conv-&gt;ScanTXT(primaryEmail.get(), mozITXTToHTMLConv::kEntities,</span>
<a href="#l18.1465"></a><span id="l18.1465">                              getter_Copies(safeText));</span>
<a href="#l18.1466"></a><span id="l18.1466">           NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l18.1467"></a><span id="l18.1467">           xmlStr.Append(safeText);</span>
<a href="#l18.1468"></a><span id="l18.1468"> </span>
<a href="#l18.1469"></a><span id="l18.1469">           xmlStr.AppendLiteral(&quot;&amp;gt;&lt;/PrimaryEmail&gt;\n&quot;);</span>
<a href="#l18.1470"></a><span id="l18.1470" class="difflineat">@@ -1337,59 +817,33 @@ NS_IMETHODIMP nsAbCardProperty::ConvertT</span>
<a href="#l18.1471"></a><span id="l18.1471"> </span>
<a href="#l18.1472"></a><span id="l18.1472">   xmlStr.AppendLiteral(&quot;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&quot;);</span>
<a href="#l18.1473"></a><span id="l18.1473"> </span>
<a href="#l18.1474"></a><span id="l18.1474">   aXMLSubstr = xmlStr;</span>
<a href="#l18.1475"></a><span id="l18.1475"> </span>
<a href="#l18.1476"></a><span id="l18.1476">   return NS_OK;</span>
<a href="#l18.1477"></a><span id="l18.1477"> }</span>
<a href="#l18.1478"></a><span id="l18.1478"> </span>
<a href="#l18.1479"></a><span id="l18.1479" class="difflineminus">-nsresult nsAbCardProperty::AppendData(const char *aAttrName, mozITXTToHTMLConv *aConv, nsString &amp;aResult)</span>
<a href="#l18.1480"></a><span id="l18.1480" class="difflineminus">-{</span>
<a href="#l18.1481"></a><span id="l18.1481" class="difflineminus">-  nsString attrValue;</span>
<a href="#l18.1482"></a><span id="l18.1482" class="difflineminus">-  nsresult rv = GetCardValue(aAttrName, attrValue);</span>
<a href="#l18.1483"></a><span id="l18.1483" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l18.1484"></a><span id="l18.1484" class="difflineminus">-</span>
<a href="#l18.1485"></a><span id="l18.1485" class="difflineminus">-  if (attrValue.IsEmpty())</span>
<a href="#l18.1486"></a><span id="l18.1486" class="difflineminus">-    return NS_OK;</span>
<a href="#l18.1487"></a><span id="l18.1487" class="difflineminus">-</span>
<a href="#l18.1488"></a><span id="l18.1488" class="difflineminus">-  aResult.Append(PRUnichar('&lt;'));</span>
<a href="#l18.1489"></a><span id="l18.1489" class="difflineminus">-  aResult.Append(NS_ConvertASCIItoUTF16(aAttrName));</span>
<a href="#l18.1490"></a><span id="l18.1490" class="difflineminus">-  aResult.Append(PRUnichar('&gt;'));</span>
<a href="#l18.1491"></a><span id="l18.1491" class="difflineminus">-</span>
<a href="#l18.1492"></a><span id="l18.1492" class="difflineminus">-  // use ScanTXT to convert &lt; &gt; &amp; to safe values.</span>
<a href="#l18.1493"></a><span id="l18.1493" class="difflineminus">-  nsString safeText;</span>
<a href="#l18.1494"></a><span id="l18.1494" class="difflineminus">-  rv = aConv-&gt;ScanTXT(attrValue.get(), mozITXTToHTMLConv::kEntities, getter_Copies(safeText));</span>
<a href="#l18.1495"></a><span id="l18.1495" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l18.1496"></a><span id="l18.1496" class="difflineminus">-  aResult.Append(safeText);</span>
<a href="#l18.1497"></a><span id="l18.1497" class="difflineminus">-</span>
<a href="#l18.1498"></a><span id="l18.1498" class="difflineminus">-  aResult.AppendLiteral(&quot;&lt;/&quot;);</span>
<a href="#l18.1499"></a><span id="l18.1499" class="difflineminus">-  aResult.Append(NS_ConvertASCIItoUTF16(aAttrName));</span>
<a href="#l18.1500"></a><span id="l18.1500" class="difflineminus">-  aResult.Append(PRUnichar('&gt;'));</span>
<a href="#l18.1501"></a><span id="l18.1501" class="difflineminus">-</span>
<a href="#l18.1502"></a><span id="l18.1502" class="difflineminus">-  return NS_OK;</span>
<a href="#l18.1503"></a><span id="l18.1503" class="difflineminus">-}</span>
<a href="#l18.1504"></a><span id="l18.1504" class="difflineminus">-</span>
<a href="#l18.1505"></a><span id="l18.1505"> nsresult nsAbCardProperty::AppendSection(const AppendItem *aArray, PRInt16 aCount, const nsString&amp; aHeading,</span>
<a href="#l18.1506"></a><span id="l18.1506">                                          nsIStringBundle *aBundle,</span>
<a href="#l18.1507"></a><span id="l18.1507">                                          mozITXTToHTMLConv *aConv,</span>
<a href="#l18.1508"></a><span id="l18.1508">                                          nsString &amp;aResult)</span>
<a href="#l18.1509"></a><span id="l18.1509"> {</span>
<a href="#l18.1510"></a><span id="l18.1510">   nsresult rv = NS_OK;</span>
<a href="#l18.1511"></a><span id="l18.1511"> </span>
<a href="#l18.1512"></a><span id="l18.1512">   aResult.AppendLiteral(&quot;&lt;section&gt;&quot;);</span>
<a href="#l18.1513"></a><span id="l18.1513"> </span>
<a href="#l18.1514"></a><span id="l18.1514">   nsString attrValue;</span>
<a href="#l18.1515"></a><span id="l18.1515">   PRBool sectionIsEmpty = PR_TRUE;</span>
<a href="#l18.1516"></a><span id="l18.1516"> </span>
<a href="#l18.1517"></a><span id="l18.1517">   PRInt16 i = 0;</span>
<a href="#l18.1518"></a><span id="l18.1518">   for (i=0;i&lt;aCount;i++) {</span>
<a href="#l18.1519"></a><span id="l18.1519" class="difflineminus">-    rv = GetCardValue(aArray[i].mColumn, attrValue);</span>
<a href="#l18.1520"></a><span id="l18.1520" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l18.1521"></a><span id="l18.1521" class="difflineminus">-    sectionIsEmpty &amp;= attrValue.IsEmpty();</span>
<a href="#l18.1522"></a><span id="l18.1522" class="difflineplus">+    rv = GetPropertyAsAString(aArray[i].mColumn, attrValue);</span>
<a href="#l18.1523"></a><span id="l18.1523" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; !attrValue.IsEmpty())</span>
<a href="#l18.1524"></a><span id="l18.1524" class="difflineplus">+      sectionIsEmpty = PR_FALSE;</span>
<a href="#l18.1525"></a><span id="l18.1525">   }</span>
<a href="#l18.1526"></a><span id="l18.1526"> </span>
<a href="#l18.1527"></a><span id="l18.1527">   if (!sectionIsEmpty &amp;&amp; !aHeading.IsEmpty()) {</span>
<a href="#l18.1528"></a><span id="l18.1528">     nsString heading;</span>
<a href="#l18.1529"></a><span id="l18.1529">     rv = aBundle-&gt;GetStringFromName(aHeading.get(), getter_Copies(heading));</span>
<a href="#l18.1530"></a><span id="l18.1530">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1531"></a><span id="l18.1531"> </span>
<a href="#l18.1532"></a><span id="l18.1532">     aResult.AppendLiteral(&quot;&lt;sectiontitle&gt;&quot;);</span>
<a href="#l18.1533"></a><span id="l18.1533" class="difflineat">@@ -1425,59 +879,54 @@ nsresult nsAbCardProperty::AppendSection</span>
<a href="#l18.1534"></a><span id="l18.1534"> </span>
<a href="#l18.1535"></a><span id="l18.1535"> nsresult nsAbCardProperty::AppendLine(const AppendItem &amp;aItem,</span>
<a href="#l18.1536"></a><span id="l18.1536">                                       mozITXTToHTMLConv *aConv,</span>
<a href="#l18.1537"></a><span id="l18.1537">                                       nsString &amp;aResult)</span>
<a href="#l18.1538"></a><span id="l18.1538"> {</span>
<a href="#l18.1539"></a><span id="l18.1539">   NS_ENSURE_ARG_POINTER(aConv);</span>
<a href="#l18.1540"></a><span id="l18.1540"> </span>
<a href="#l18.1541"></a><span id="l18.1541">   nsString attrValue;</span>
<a href="#l18.1542"></a><span id="l18.1542" class="difflineminus">-  nsresult rv = GetCardValue(aItem.mColumn, attrValue);</span>
<a href="#l18.1543"></a><span id="l18.1543" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l18.1544"></a><span id="l18.1544" class="difflineplus">+  nsresult rv = GetPropertyAsAString(aItem.mColumn, attrValue);</span>
<a href="#l18.1545"></a><span id="l18.1545"> </span>
<a href="#l18.1546"></a><span id="l18.1546" class="difflineminus">-  if (attrValue.IsEmpty())</span>
<a href="#l18.1547"></a><span id="l18.1547" class="difflineplus">+  if (NS_FAILED(rv) || attrValue.IsEmpty())</span>
<a href="#l18.1548"></a><span id="l18.1548">     return NS_OK;</span>
<a href="#l18.1549"></a><span id="l18.1549"> </span>
<a href="#l18.1550"></a><span id="l18.1550">   aResult.Append(PRUnichar('&lt;'));</span>
<a href="#l18.1551"></a><span id="l18.1551" class="difflineminus">-  aResult.Append(NS_ConvertASCIItoUTF16(aItem.mColumn));</span>
<a href="#l18.1552"></a><span id="l18.1552" class="difflineplus">+  aResult.Append(NS_ConvertUTF8toUTF16(aItem.mColumn));</span>
<a href="#l18.1553"></a><span id="l18.1553">   aResult.Append(PRUnichar('&gt;'));</span>
<a href="#l18.1554"></a><span id="l18.1554"> </span>
<a href="#l18.1555"></a><span id="l18.1555">   // use ScanTXT to convert &lt; &gt; &amp; to safe values.</span>
<a href="#l18.1556"></a><span id="l18.1556">   nsString safeText;</span>
<a href="#l18.1557"></a><span id="l18.1557">   rv = aConv-&gt;ScanTXT(attrValue.get(), mozITXTToHTMLConv::kEntities, getter_Copies(safeText));</span>
<a href="#l18.1558"></a><span id="l18.1558">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l18.1559"></a><span id="l18.1559">   aResult.Append(safeText);</span>
<a href="#l18.1560"></a><span id="l18.1560"> </span>
<a href="#l18.1561"></a><span id="l18.1561">   aResult.AppendLiteral(&quot;&lt;/&quot;);</span>
<a href="#l18.1562"></a><span id="l18.1562" class="difflineminus">-  aResult.Append(NS_ConvertASCIItoUTF16(aItem.mColumn));</span>
<a href="#l18.1563"></a><span id="l18.1563" class="difflineplus">+  aResult.Append(NS_ConvertUTF8toUTF16(aItem.mColumn));</span>
<a href="#l18.1564"></a><span id="l18.1564">   aResult.Append(PRUnichar('&gt;'));</span>
<a href="#l18.1565"></a><span id="l18.1565"> </span>
<a href="#l18.1566"></a><span id="l18.1566">   return NS_OK;</span>
<a href="#l18.1567"></a><span id="l18.1567"> }</span>
<a href="#l18.1568"></a><span id="l18.1568"> </span>
<a href="#l18.1569"></a><span id="l18.1569"> nsresult nsAbCardProperty::AppendLabel(const AppendItem &amp;aItem,</span>
<a href="#l18.1570"></a><span id="l18.1570">                                        nsIStringBundle *aBundle,</span>
<a href="#l18.1571"></a><span id="l18.1571">                                        mozITXTToHTMLConv *aConv,</span>
<a href="#l18.1572"></a><span id="l18.1572">                                        nsString &amp;aResult)</span>
<a href="#l18.1573"></a><span id="l18.1573"> {</span>
<a href="#l18.1574"></a><span id="l18.1574">   NS_ENSURE_ARG_POINTER(aBundle);</span>
<a href="#l18.1575"></a><span id="l18.1575"> </span>
<a href="#l18.1576"></a><span id="l18.1576">   nsresult rv;</span>
<a href="#l18.1577"></a><span id="l18.1577" class="difflineminus">-</span>
<a href="#l18.1578"></a><span id="l18.1578" class="difflineminus">-  nsString label;</span>
<a href="#l18.1579"></a><span id="l18.1579" class="difflineminus">-</span>
<a href="#l18.1580"></a><span id="l18.1580" class="difflineminus">-  nsString attrValue;</span>
<a href="#l18.1581"></a><span id="l18.1581" class="difflineplus">+  nsString label, attrValue;</span>
<a href="#l18.1582"></a><span id="l18.1582"> </span>
<a href="#l18.1583"></a><span id="l18.1583" class="difflineminus">-  rv = GetCardValue(aItem.mColumn, attrValue);</span>
<a href="#l18.1584"></a><span id="l18.1584" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l18.1585"></a><span id="l18.1585" class="difflineplus">+  rv = GetPropertyAsAString(aItem.mColumn, attrValue);</span>
<a href="#l18.1586"></a><span id="l18.1586"> </span>
<a href="#l18.1587"></a><span id="l18.1587" class="difflineminus">-  if (attrValue.IsEmpty())</span>
<a href="#l18.1588"></a><span id="l18.1588" class="difflineplus">+  if (NS_FAILED(rv) || attrValue.IsEmpty())</span>
<a href="#l18.1589"></a><span id="l18.1589">     return NS_OK;</span>
<a href="#l18.1590"></a><span id="l18.1590"> </span>
<a href="#l18.1591"></a><span id="l18.1591" class="difflineminus">-  rv = aBundle-&gt;GetStringFromName(NS_ConvertASCIItoUTF16(aItem.mLabel).get(), getter_Copies(label));</span>
<a href="#l18.1592"></a><span id="l18.1592" class="difflineplus">+  rv = aBundle-&gt;GetStringFromName(NS_ConvertUTF8toUTF16(aItem.mLabel).get(), getter_Copies(label));</span>
<a href="#l18.1593"></a><span id="l18.1593">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1594"></a><span id="l18.1594"> </span>
<a href="#l18.1595"></a><span id="l18.1595">   aResult.AppendLiteral(&quot;&lt;labelrow&gt;&lt;label&gt;&quot;);</span>
<a href="#l18.1596"></a><span id="l18.1596"> </span>
<a href="#l18.1597"></a><span id="l18.1597">   aResult.Append(label);</span>
<a href="#l18.1598"></a><span id="l18.1598">   aResult.AppendLiteral(&quot;: &lt;/label&gt;&quot;);</span>
<a href="#l18.1599"></a><span id="l18.1599"> </span>
<a href="#l18.1600"></a><span id="l18.1600">   rv = AppendLine(aItem, aConv, aResult);</span>
<a href="#l18.1601"></a><span id="l18.1601" class="difflineat">@@ -1492,39 +941,39 @@ nsresult nsAbCardProperty::AppendCitySta</span>
<a href="#l18.1602"></a><span id="l18.1602">                                               nsIStringBundle *aBundle,</span>
<a href="#l18.1603"></a><span id="l18.1603">                                               mozITXTToHTMLConv *aConv,</span>
<a href="#l18.1604"></a><span id="l18.1604">                                               nsString &amp;aResult)</span>
<a href="#l18.1605"></a><span id="l18.1605"> {</span>
<a href="#l18.1606"></a><span id="l18.1606">   NS_ENSURE_ARG_POINTER(aBundle);</span>
<a href="#l18.1607"></a><span id="l18.1607"> </span>
<a href="#l18.1608"></a><span id="l18.1608">   nsresult rv;</span>
<a href="#l18.1609"></a><span id="l18.1609">   AppendItem item;</span>
<a href="#l18.1610"></a><span id="l18.1610" class="difflineminus">-  const char *stateCol, *zipCol;</span>
<a href="#l18.1611"></a><span id="l18.1611" class="difflineplus">+  const char *statePropName, *zipPropName;</span>
<a href="#l18.1612"></a><span id="l18.1612"> </span>
<a href="#l18.1613"></a><span id="l18.1613" class="difflineminus">-  if (strcmp(aItem.mColumn, kHomeCityColumn) == 0) {</span>
<a href="#l18.1614"></a><span id="l18.1614" class="difflineminus">-    stateCol = kHomeStateColumn;</span>
<a href="#l18.1615"></a><span id="l18.1615" class="difflineminus">-    zipCol = kHomeZipCodeColumn;</span>
<a href="#l18.1616"></a><span id="l18.1616" class="difflineplus">+  if (strcmp(aItem.mColumn, kHomeCityProperty) == 0) {</span>
<a href="#l18.1617"></a><span id="l18.1617" class="difflineplus">+    statePropName = kHomeStateProperty;</span>
<a href="#l18.1618"></a><span id="l18.1618" class="difflineplus">+    zipPropName = kHomeZipCodeProperty;</span>
<a href="#l18.1619"></a><span id="l18.1619">   }</span>
<a href="#l18.1620"></a><span id="l18.1620">   else {</span>
<a href="#l18.1621"></a><span id="l18.1621" class="difflineminus">-    stateCol = kWorkStateColumn;</span>
<a href="#l18.1622"></a><span id="l18.1622" class="difflineminus">-    zipCol = kWorkZipCodeColumn;</span>
<a href="#l18.1623"></a><span id="l18.1623" class="difflineplus">+    statePropName = kWorkStateProperty;</span>
<a href="#l18.1624"></a><span id="l18.1624" class="difflineplus">+    zipPropName = kWorkZipCodeProperty;</span>
<a href="#l18.1625"></a><span id="l18.1625">   }</span>
<a href="#l18.1626"></a><span id="l18.1626"> </span>
<a href="#l18.1627"></a><span id="l18.1627">   nsAutoString cityResult, stateResult, zipResult;</span>
<a href="#l18.1628"></a><span id="l18.1628"> </span>
<a href="#l18.1629"></a><span id="l18.1629">   rv = AppendLine(aItem, aConv, cityResult);</span>
<a href="#l18.1630"></a><span id="l18.1630">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l18.1631"></a><span id="l18.1631"> </span>
<a href="#l18.1632"></a><span id="l18.1632" class="difflineminus">-  item.mColumn = stateCol;</span>
<a href="#l18.1633"></a><span id="l18.1633" class="difflineplus">+  item.mColumn = statePropName;</span>
<a href="#l18.1634"></a><span id="l18.1634">   item.mLabel = &quot;&quot;;</span>
<a href="#l18.1635"></a><span id="l18.1635"> </span>
<a href="#l18.1636"></a><span id="l18.1636">   rv = AppendLine(item, aConv, stateResult);</span>
<a href="#l18.1637"></a><span id="l18.1637">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l18.1638"></a><span id="l18.1638"> </span>
<a href="#l18.1639"></a><span id="l18.1639" class="difflineminus">-  item.mColumn = zipCol;</span>
<a href="#l18.1640"></a><span id="l18.1640" class="difflineplus">+  item.mColumn = zipPropName;</span>
<a href="#l18.1641"></a><span id="l18.1641"> </span>
<a href="#l18.1642"></a><span id="l18.1642">   rv = AppendLine(item, aConv, zipResult);</span>
<a href="#l18.1643"></a><span id="l18.1643">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l18.1644"></a><span id="l18.1644"> </span>
<a href="#l18.1645"></a><span id="l18.1645">   nsString formattedString;</span>
<a href="#l18.1646"></a><span id="l18.1646"> </span>
<a href="#l18.1647"></a><span id="l18.1647">   if (!cityResult.IsEmpty() &amp;&amp; !stateResult.IsEmpty() &amp;&amp; !zipResult.IsEmpty()) {</span>
<a href="#l18.1648"></a><span id="l18.1648">     const PRUnichar *formatStrings[] = { cityResult.get(), stateResult.get(), zipResult.get() };</span>
<a href="#l18.1649"></a><span id="l18.1649" class="difflineat">@@ -1555,79 +1004,88 @@ nsresult nsAbCardProperty::AppendCitySta</span>
<a href="#l18.1650"></a><span id="l18.1650"> </span>
<a href="#l18.1651"></a><span id="l18.1651">   return NS_OK;</span>
<a href="#l18.1652"></a><span id="l18.1652"> }</span>
<a href="#l18.1653"></a><span id="l18.1653"> </span>
<a href="#l18.1654"></a><span id="l18.1654"> NS_IMETHODIMP nsAbCardProperty::GenerateName(PRInt32 aGenerateFormat,</span>
<a href="#l18.1655"></a><span id="l18.1655">                                              nsIStringBundle* aBundle,</span>
<a href="#l18.1656"></a><span id="l18.1656">                                              nsAString &amp;aResult)</span>
<a href="#l18.1657"></a><span id="l18.1657"> {</span>
<a href="#l18.1658"></a><span id="l18.1658" class="difflineplus">+  // Cache the first and last names</span>
<a href="#l18.1659"></a><span id="l18.1659" class="difflineplus">+  nsAutoString firstName, lastName;</span>
<a href="#l18.1660"></a><span id="l18.1660" class="difflineplus">+  GetFirstName(firstName);</span>
<a href="#l18.1661"></a><span id="l18.1661" class="difflineplus">+  GetLastName(lastName);</span>
<a href="#l18.1662"></a><span id="l18.1662" class="difflineplus">+</span>
<a href="#l18.1663"></a><span id="l18.1663">   // No need to check for aBundle present straight away, only do that if we're</span>
<a href="#l18.1664"></a><span id="l18.1664">   // actually going to use it.</span>
<a href="#l18.1665"></a><span id="l18.1665" class="difflineminus">-  if (aGenerateFormat == kDisplayName)</span>
<a href="#l18.1666"></a><span id="l18.1666" class="difflineminus">-    aResult = m_DisplayName;</span>
<a href="#l18.1667"></a><span id="l18.1667" class="difflineminus">-  else if (m_LastName.IsEmpty())</span>
<a href="#l18.1668"></a><span id="l18.1668" class="difflineminus">-    aResult = m_FirstName;</span>
<a href="#l18.1669"></a><span id="l18.1669" class="difflineminus">-  else if (m_FirstName.IsEmpty())</span>
<a href="#l18.1670"></a><span id="l18.1670" class="difflineminus">-    aResult = m_LastName;</span>
<a href="#l18.1671"></a><span id="l18.1671" class="difflineplus">+  if (aGenerateFormat == GENERATE_DISPLAY_NAME)</span>
<a href="#l18.1672"></a><span id="l18.1672" class="difflineplus">+    GetDisplayName(aResult);</span>
<a href="#l18.1673"></a><span id="l18.1673" class="difflineplus">+  else if (lastName.IsEmpty())</span>
<a href="#l18.1674"></a><span id="l18.1674" class="difflineplus">+    aResult = firstName;</span>
<a href="#l18.1675"></a><span id="l18.1675" class="difflineplus">+  else if (firstName.IsEmpty())</span>
<a href="#l18.1676"></a><span id="l18.1676" class="difflineplus">+    aResult = lastName;</span>
<a href="#l18.1677"></a><span id="l18.1677">   else {</span>
<a href="#l18.1678"></a><span id="l18.1678">     nsresult rv;</span>
<a href="#l18.1679"></a><span id="l18.1679">     nsCOMPtr&lt;nsIStringBundle&gt; bundle(aBundle);</span>
<a href="#l18.1680"></a><span id="l18.1680">     if (!bundle) {</span>
<a href="#l18.1681"></a><span id="l18.1681">       nsCOMPtr&lt;nsIStringBundleService&gt; stringBundleService =</span>
<a href="#l18.1682"></a><span id="l18.1682">         do_GetService(NS_STRINGBUNDLE_CONTRACTID, &amp;rv); </span>
<a href="#l18.1683"></a><span id="l18.1683">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1684"></a><span id="l18.1684">         </span>
<a href="#l18.1685"></a><span id="l18.1685">       rv = stringBundleService-&gt;CreateBundle(sAddrbookProperties,</span>
<a href="#l18.1686"></a><span id="l18.1686">                                              getter_AddRefs(bundle));</span>
<a href="#l18.1687"></a><span id="l18.1687">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1688"></a><span id="l18.1688">     }</span>
<a href="#l18.1689"></a><span id="l18.1689"> </span>
<a href="#l18.1690"></a><span id="l18.1690">     nsString result;</span>
<a href="#l18.1691"></a><span id="l18.1691"> </span>
<a href="#l18.1692"></a><span id="l18.1692" class="difflineminus">-    if (aGenerateFormat == kLastFirst) {</span>
<a href="#l18.1693"></a><span id="l18.1693" class="difflineminus">-      const PRUnichar *stringParams[2] = {m_LastName.get(), m_FirstName.get()};</span>
<a href="#l18.1694"></a><span id="l18.1694" class="difflineplus">+    if (aGenerateFormat == GENERATE_LAST_FIRST_ORDER) {</span>
<a href="#l18.1695"></a><span id="l18.1695" class="difflineplus">+      const PRUnichar *stringParams[2] = {lastName.get(), firstName.get()};</span>
<a href="#l18.1696"></a><span id="l18.1696"> </span>
<a href="#l18.1697"></a><span id="l18.1697">       rv = bundle-&gt;FormatStringFromName(NS_LITERAL_STRING(&quot;lastFirstFormat&quot;).get(),</span>
<a href="#l18.1698"></a><span id="l18.1698">                                         stringParams, 2, getter_Copies(result));</span>
<a href="#l18.1699"></a><span id="l18.1699">     }</span>
<a href="#l18.1700"></a><span id="l18.1700">     else {</span>
<a href="#l18.1701"></a><span id="l18.1701" class="difflineminus">-      const PRUnichar *stringParams[2] = {m_FirstName.get(), m_LastName.get()};</span>
<a href="#l18.1702"></a><span id="l18.1702" class="difflineplus">+      const PRUnichar *stringParams[2] = {firstName.get(), lastName.get()};</span>
<a href="#l18.1703"></a><span id="l18.1703">         </span>
<a href="#l18.1704"></a><span id="l18.1704">       rv = bundle-&gt;FormatStringFromName(NS_LITERAL_STRING(&quot;firstLastFormat&quot;).get(),</span>
<a href="#l18.1705"></a><span id="l18.1705">                                         stringParams, 2, getter_Copies(result));</span>
<a href="#l18.1706"></a><span id="l18.1706">     }</span>
<a href="#l18.1707"></a><span id="l18.1707">     NS_ENSURE_SUCCESS(rv, rv); </span>
<a href="#l18.1708"></a><span id="l18.1708"> </span>
<a href="#l18.1709"></a><span id="l18.1709">     aResult.Assign(result);</span>
<a href="#l18.1710"></a><span id="l18.1710">   }</span>
<a href="#l18.1711"></a><span id="l18.1711">   </span>
<a href="#l18.1712"></a><span id="l18.1712">   if (aResult.IsEmpty())</span>
<a href="#l18.1713"></a><span id="l18.1713">   {</span>
<a href="#l18.1714"></a><span id="l18.1714">     // see bug #211078</span>
<a href="#l18.1715"></a><span id="l18.1715">     // if there is no generated name at this point</span>
<a href="#l18.1716"></a><span id="l18.1716">     // use the userid from the email address</span>
<a href="#l18.1717"></a><span id="l18.1717">     // it is better than nothing.</span>
<a href="#l18.1718"></a><span id="l18.1718" class="difflineminus">-    aResult = m_PrimaryEmail;</span>
<a href="#l18.1719"></a><span id="l18.1719" class="difflineplus">+    GetPrimaryEmail(aResult);</span>
<a href="#l18.1720"></a><span id="l18.1720">     PRInt32 index = aResult.FindChar('@');</span>
<a href="#l18.1721"></a><span id="l18.1721">     if (index != -1)</span>
<a href="#l18.1722"></a><span id="l18.1722">       aResult.SetLength(index);</span>
<a href="#l18.1723"></a><span id="l18.1723">   }</span>
<a href="#l18.1724"></a><span id="l18.1724"> </span>
<a href="#l18.1725"></a><span id="l18.1725">   return NS_OK;</span>
<a href="#l18.1726"></a><span id="l18.1726"> }</span>
<a href="#l18.1727"></a><span id="l18.1727"> </span>
<a href="#l18.1728"></a><span id="l18.1728"> NS_IMETHODIMP nsAbCardProperty::GeneratePhoneticName(PRBool aLastNameFirst,</span>
<a href="#l18.1729"></a><span id="l18.1729">                                                      nsAString &amp;aResult)</span>
<a href="#l18.1730"></a><span id="l18.1730"> {</span>
<a href="#l18.1731"></a><span id="l18.1731" class="difflineplus">+  nsAutoString firstName, lastName;</span>
<a href="#l18.1732"></a><span id="l18.1732" class="difflineplus">+  GetPropertyAsAString(kPhoneticFirstNameProperty, firstName);</span>
<a href="#l18.1733"></a><span id="l18.1733" class="difflineplus">+  GetPropertyAsAString(kPhoneticLastNameProperty, lastName);</span>
<a href="#l18.1734"></a><span id="l18.1734" class="difflineplus">+</span>
<a href="#l18.1735"></a><span id="l18.1735">   if (aLastNameFirst)</span>
<a href="#l18.1736"></a><span id="l18.1736">   {</span>
<a href="#l18.1737"></a><span id="l18.1737" class="difflineminus">-    aResult = m_PhoneticLastName;</span>
<a href="#l18.1738"></a><span id="l18.1738" class="difflineminus">-    aResult += m_PhoneticFirstName;</span>
<a href="#l18.1739"></a><span id="l18.1739" class="difflineplus">+    aResult = lastName;</span>
<a href="#l18.1740"></a><span id="l18.1740" class="difflineplus">+    aResult += firstName;</span>
<a href="#l18.1741"></a><span id="l18.1741">   }</span>
<a href="#l18.1742"></a><span id="l18.1742">   else</span>
<a href="#l18.1743"></a><span id="l18.1743">   {</span>
<a href="#l18.1744"></a><span id="l18.1744" class="difflineminus">-    aResult = m_PhoneticFirstName;</span>
<a href="#l18.1745"></a><span id="l18.1745" class="difflineminus">-    aResult += m_PhoneticLastName;</span>
<a href="#l18.1746"></a><span id="l18.1746" class="difflineplus">+    aResult = firstName;</span>
<a href="#l18.1747"></a><span id="l18.1747" class="difflineplus">+    aResult += lastName;</span>
<a href="#l18.1748"></a><span id="l18.1748">   }</span>
<a href="#l18.1749"></a><span id="l18.1749"> </span>
<a href="#l18.1750"></a><span id="l18.1750">   return NS_OK;</span>
<a href="#l18.1751"></a><span id="l18.1751"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbCardProperty.h</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbCardProperty.h</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -44,96 +44,48 @@</span>
<a href="#l19.4"></a><span id="l19.4"> </span>
<a href="#l19.5"></a><span id="l19.5"> #ifndef nsAbCardProperty_h__</span>
<a href="#l19.6"></a><span id="l19.6"> #define nsAbCardProperty_h__</span>
<a href="#l19.7"></a><span id="l19.7"> </span>
<a href="#l19.8"></a><span id="l19.8"> #include &quot;nsIAbCard.h&quot;  </span>
<a href="#l19.9"></a><span id="l19.9"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l19.10"></a><span id="l19.10"> #include &quot;nsStringGlue.h&quot;</span>
<a href="#l19.11"></a><span id="l19.11"> </span>
<a href="#l19.12"></a><span id="l19.12" class="difflineplus">+#include &quot;nsInterfaceHashtable.h&quot;</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+#include &quot;nsIVariant.h&quot;</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineplus">+</span>
<a href="#l19.15"></a><span id="l19.15"> class nsIStringBundle;</span>
<a href="#l19.16"></a><span id="l19.16"> class mozITXTToHTMLConv;</span>
<a href="#l19.17"></a><span id="l19.17"> struct AppendItem;</span>
<a href="#l19.18"></a><span id="l19.18"> </span>
<a href="#l19.19"></a><span id="l19.19">  /* </span>
<a href="#l19.20"></a><span id="l19.20">   * Address Book Card Property</span>
<a href="#l19.21"></a><span id="l19.21">   */ </span>
<a href="#l19.22"></a><span id="l19.22"> </span>
<a href="#l19.23"></a><span id="l19.23"> class nsAbCardProperty: public nsIAbCard</span>
<a href="#l19.24"></a><span id="l19.24"> {</span>
<a href="#l19.25"></a><span id="l19.25"> public: </span>
<a href="#l19.26"></a><span id="l19.26" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l19.27"></a><span id="l19.27" class="difflineplus">+  NS_DECL_NSIABCARD</span>
<a href="#l19.28"></a><span id="l19.28" class="difflineplus">+  NS_DECL_NSIABITEM</span>
<a href="#l19.29"></a><span id="l19.29"> </span>
<a href="#l19.30"></a><span id="l19.30" class="difflineminus">-	NS_DECL_ISUPPORTS</span>
<a href="#l19.31"></a><span id="l19.31" class="difflineminus">-	NS_DECL_NSIABCARD</span>
<a href="#l19.32"></a><span id="l19.32" class="difflineminus">-</span>
<a href="#l19.33"></a><span id="l19.33" class="difflineminus">-	nsAbCardProperty(void);</span>
<a href="#l19.34"></a><span id="l19.34" class="difflineminus">-	virtual ~nsAbCardProperty(void);</span>
<a href="#l19.35"></a><span id="l19.35" class="difflineplus">+  nsAbCardProperty();</span>
<a href="#l19.36"></a><span id="l19.36" class="difflineplus">+  virtual ~nsAbCardProperty(void);</span>
<a href="#l19.37"></a><span id="l19.37"> </span>
<a href="#l19.38"></a><span id="l19.38"> protected:</span>
<a href="#l19.39"></a><span id="l19.39" class="difflineminus">-</span>
<a href="#l19.40"></a><span id="l19.40" class="difflineminus">-	nsString m_PhoneticFirstName;</span>
<a href="#l19.41"></a><span id="l19.41" class="difflineminus">-	nsString m_PhoneticLastName;</span>
<a href="#l19.42"></a><span id="l19.42" class="difflineminus">-	nsString m_FirstName;</span>
<a href="#l19.43"></a><span id="l19.43" class="difflineminus">-	nsString m_LastName;</span>
<a href="#l19.44"></a><span id="l19.44" class="difflineminus">-	nsString m_DisplayName;</span>
<a href="#l19.45"></a><span id="l19.45" class="difflineminus">-	nsString m_NickName;</span>
<a href="#l19.46"></a><span id="l19.46" class="difflineminus">-	nsString m_PrimaryEmail;</span>
<a href="#l19.47"></a><span id="l19.47" class="difflineminus">-	nsString m_SecondEmail;</span>
<a href="#l19.48"></a><span id="l19.48" class="difflineminus">-	nsString m_WorkPhone;</span>
<a href="#l19.49"></a><span id="l19.49" class="difflineminus">-	nsString m_HomePhone;</span>
<a href="#l19.50"></a><span id="l19.50" class="difflineminus">-	nsString m_FaxNumber;</span>
<a href="#l19.51"></a><span id="l19.51" class="difflineminus">-	nsString m_PagerNumber;</span>
<a href="#l19.52"></a><span id="l19.52" class="difflineminus">-	nsString m_CellularNumber;</span>
<a href="#l19.53"></a><span id="l19.53" class="difflineminus">-  nsString m_WorkPhoneType;</span>
<a href="#l19.54"></a><span id="l19.54" class="difflineminus">-  nsString m_HomePhoneType;</span>
<a href="#l19.55"></a><span id="l19.55" class="difflineminus">-  nsString m_FaxNumberType;</span>
<a href="#l19.56"></a><span id="l19.56" class="difflineminus">-  nsString m_PagerNumberType;</span>
<a href="#l19.57"></a><span id="l19.57" class="difflineminus">-  nsString m_CellularNumberType;</span>
<a href="#l19.58"></a><span id="l19.58" class="difflineminus">-	nsString m_HomeAddress;</span>
<a href="#l19.59"></a><span id="l19.59" class="difflineminus">-	nsString m_HomeAddress2;</span>
<a href="#l19.60"></a><span id="l19.60" class="difflineminus">-	nsString m_HomeCity;</span>
<a href="#l19.61"></a><span id="l19.61" class="difflineminus">-	nsString m_HomeState;</span>
<a href="#l19.62"></a><span id="l19.62" class="difflineminus">-	nsString m_HomeZipCode;</span>
<a href="#l19.63"></a><span id="l19.63" class="difflineminus">-	nsString m_HomeCountry;</span>
<a href="#l19.64"></a><span id="l19.64" class="difflineminus">-	nsString m_WorkAddress;</span>
<a href="#l19.65"></a><span id="l19.65" class="difflineminus">-	nsString m_WorkAddress2;</span>
<a href="#l19.66"></a><span id="l19.66" class="difflineminus">-	nsString m_WorkCity;</span>
<a href="#l19.67"></a><span id="l19.67" class="difflineminus">-	nsString m_WorkState;</span>
<a href="#l19.68"></a><span id="l19.68" class="difflineminus">-	nsString m_WorkZipCode;</span>
<a href="#l19.69"></a><span id="l19.69" class="difflineminus">-	nsString m_WorkCountry;</span>
<a href="#l19.70"></a><span id="l19.70" class="difflineminus">-	nsString m_JobTitle;</span>
<a href="#l19.71"></a><span id="l19.71" class="difflineminus">-	nsString m_Department;</span>
<a href="#l19.72"></a><span id="l19.72" class="difflineminus">-	nsString m_Company;</span>
<a href="#l19.73"></a><span id="l19.73" class="difflineminus">-  nsString m_AimScreenName;</span>
<a href="#l19.74"></a><span id="l19.74" class="difflineminus">-  nsString m_AnniversaryYear;</span>
<a href="#l19.75"></a><span id="l19.75" class="difflineminus">-  nsString m_AnniversaryMonth;</span>
<a href="#l19.76"></a><span id="l19.76" class="difflineminus">-  nsString m_AnniversaryDay;</span>
<a href="#l19.77"></a><span id="l19.77" class="difflineminus">-  nsString m_SpouseName;</span>
<a href="#l19.78"></a><span id="l19.78" class="difflineminus">-  nsString m_FamilyName;</span>
<a href="#l19.79"></a><span id="l19.79" class="difflineminus">-  nsString m_DefaultAddress;</span>
<a href="#l19.80"></a><span id="l19.80" class="difflineminus">-  nsString m_Category;</span>
<a href="#l19.81"></a><span id="l19.81" class="difflineminus">-	nsString m_WebPage1;</span>
<a href="#l19.82"></a><span id="l19.82" class="difflineminus">-	nsString m_WebPage2;</span>
<a href="#l19.83"></a><span id="l19.83" class="difflineminus">-	nsString m_BirthYear;</span>
<a href="#l19.84"></a><span id="l19.84" class="difflineminus">-	nsString m_BirthMonth;</span>
<a href="#l19.85"></a><span id="l19.85" class="difflineminus">-	nsString m_BirthDay;</span>
<a href="#l19.86"></a><span id="l19.86" class="difflineminus">-	nsString m_Custom1;</span>
<a href="#l19.87"></a><span id="l19.87" class="difflineminus">-	nsString m_Custom2;</span>
<a href="#l19.88"></a><span id="l19.88" class="difflineminus">-	nsString m_Custom3;</span>
<a href="#l19.89"></a><span id="l19.89" class="difflineminus">-	nsString m_Custom4;</span>
<a href="#l19.90"></a><span id="l19.90" class="difflineminus">-	nsString m_Note;</span>
<a href="#l19.91"></a><span id="l19.91" class="difflineminus">-	PRUint32 m_LastModDate;</span>
<a href="#l19.92"></a><span id="l19.92" class="difflineminus">-	PRUint32 m_PreferMailFormat;</span>
<a href="#l19.93"></a><span id="l19.93" class="difflineminus">-	PRUint32 m_PopularityIndex;</span>
<a href="#l19.94"></a><span id="l19.94" class="difflineminus">-  PRBool   m_AllowRemoteContent;</span>
<a href="#l19.95"></a><span id="l19.95" class="difflineminus">-</span>
<a href="#l19.96"></a><span id="l19.96"> 	PRBool   m_IsMailList;</span>
<a href="#l19.97"></a><span id="l19.97"> 	nsCString m_MailListURI;</span>
<a href="#l19.98"></a><span id="l19.98"> </span>
<a href="#l19.99"></a><span id="l19.99" class="difflineplus">+  // Store most of the properties here</span>
<a href="#l19.100"></a><span id="l19.100" class="difflineplus">+  nsInterfaceHashtable&lt;nsCStringHashKey, nsIVariant&gt; m_properties;</span>
<a href="#l19.101"></a><span id="l19.101" class="difflineplus">+</span>
<a href="#l19.102"></a><span id="l19.102"> private:</span>
<a href="#l19.103"></a><span id="l19.103" class="difflineminus">-  nsresult AppendData(const char *aAttrName, mozITXTToHTMLConv *aConv, nsString &amp;aResult);</span>
<a href="#l19.104"></a><span id="l19.104">   nsresult AppendSection(const AppendItem *aArray, PRInt16 aCount, const nsString&amp; aHeading, nsIStringBundle *aBundle, mozITXTToHTMLConv *aConv, nsString &amp;aResult);</span>
<a href="#l19.105"></a><span id="l19.105">   nsresult AppendLine(const AppendItem &amp;aItem, mozITXTToHTMLConv *aConv, nsString &amp;aResult);</span>
<a href="#l19.106"></a><span id="l19.106">   nsresult AppendLabel(const AppendItem &amp;aItem, nsIStringBundle *aBundle, mozITXTToHTMLConv *aConv, nsString &amp;aResult);</span>
<a href="#l19.107"></a><span id="l19.107">   nsresult AppendCityStateZip(const AppendItem &amp;aItem, nsIStringBundle *aBundle, mozITXTToHTMLConv *aConv, nsString &amp;aResult);</span>
<a href="#l19.108"></a><span id="l19.108" class="difflineplus">+</span>
<a href="#l19.109"></a><span id="l19.109" class="difflineplus">+  nsresult ConvertToBase64EncodedXML(nsACString &amp;result);</span>
<a href="#l19.110"></a><span id="l19.110" class="difflineplus">+  nsresult ConvertToXMLPrintData(nsAString &amp;result);</span>
<a href="#l19.111"></a><span id="l19.111" class="difflineplus">+  nsresult ConvertToEscapedVCard(nsACString &amp;result);</span>
<a href="#l19.112"></a><span id="l19.112"> };</span>
<a href="#l19.113"></a><span id="l19.113"> </span>
<a href="#l19.114"></a><span id="l19.114"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbDirectoryQuery.cpp</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbDirectoryQuery.cpp</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -450,18 +450,17 @@ nsresult nsAbDirectoryQuery::matchCardCo</span>
<a href="#l20.4"></a><span id="l20.4"> </span>
<a href="#l20.5"></a><span id="l20.5">     if (name.Equals (&quot;card:nsIAbCard&quot;))</span>
<a href="#l20.6"></a><span id="l20.6">     {</span>
<a href="#l20.7"></a><span id="l20.7">       *matchFound = (conditionType == nsIAbBooleanConditionTypes::Exists);</span>
<a href="#l20.8"></a><span id="l20.8">       return NS_OK;</span>
<a href="#l20.9"></a><span id="l20.9">     }</span>
<a href="#l20.10"></a><span id="l20.10"> </span>
<a href="#l20.11"></a><span id="l20.11">     nsString value;</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-    rv = card-&gt;GetCardValue(name.get(), value);</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineplus">+    (void)card-&gt;GetPropertyAsAString(name.get(), value);</span>
<a href="#l20.15"></a><span id="l20.15"> </span>
<a href="#l20.16"></a><span id="l20.16">     if (value.IsEmpty())</span>
<a href="#l20.17"></a><span id="l20.17">     {</span>
<a href="#l20.18"></a><span id="l20.18">       *matchFound = (conditionType == nsIAbBooleanConditionTypes::DoesNotExist) ?</span>
<a href="#l20.19"></a><span id="l20.19">           PR_TRUE : PR_FALSE;</span>
<a href="#l20.20"></a><span id="l20.20">       return NS_OK;</span>
<a href="#l20.21"></a><span id="l20.21">     }</span>
<a href="#l20.22"></a><span id="l20.22"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPAttributeMap.js</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPAttributeMap.js</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -183,17 +183,17 @@ nsAbLDAPAttributeMap.prototype = {</span>
<a href="#l21.4"></a><span id="l21.4"> </span>
<a href="#l21.5"></a><span id="l21.5">         attr = attr.toLowerCase();</span>
<a href="#l21.6"></a><span id="l21.6"> </span>
<a href="#l21.7"></a><span id="l21.7">         // find the first attr that exists in this message</span>
<a href="#l21.8"></a><span id="l21.8">         if (msgAttrs.indexOf(attr) != -1) {</span>
<a href="#l21.9"></a><span id="l21.9">           </span>
<a href="#l21.10"></a><span id="l21.10">           try {</span>
<a href="#l21.11"></a><span id="l21.11">             var values = aMessage.getValues(attr, {});</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-            aCard.setCardValue(prop, values[0]);</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+            aCard.setProperty(prop, values[0]);</span>
<a href="#l21.14"></a><span id="l21.14"> </span>
<a href="#l21.15"></a><span id="l21.15">             cardValueWasSet = true;</span>
<a href="#l21.16"></a><span id="l21.16">             break;</span>
<a href="#l21.17"></a><span id="l21.17">           } catch (ex) {</span>
<a href="#l21.18"></a><span id="l21.18">             // ignore any errors getting message values or setting card values</span>
<a href="#l21.19"></a><span id="l21.19">           }</span>
<a href="#l21.20"></a><span id="l21.20">         }</span>
<a href="#l21.21"></a><span id="l21.21">       }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPCard.cpp</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPCard.cpp</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -47,16 +47,18 @@</span>
<a href="#l22.4"></a><span id="l22.4"> #include &quot;nsIAbLDAPAttributeMap.h&quot;</span>
<a href="#l22.5"></a><span id="l22.5"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l22.6"></a><span id="l22.6"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l22.7"></a><span id="l22.7"> #include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l22.8"></a><span id="l22.8"> #include &quot;nsAbUtils.h&quot;</span>
<a href="#l22.9"></a><span id="l22.9"> </span>
<a href="#l22.10"></a><span id="l22.10"> #include &lt;stdio.h&gt;</span>
<a href="#l22.11"></a><span id="l22.11"> </span>
<a href="#l22.12"></a><span id="l22.12" class="difflineplus">+#define kDNColumn &quot;DN&quot;</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineplus">+</span>
<a href="#l22.14"></a><span id="l22.14"> nsAbLDAPCard::nsAbLDAPCard()</span>
<a href="#l22.15"></a><span id="l22.15"> {</span>
<a href="#l22.16"></a><span id="l22.16"> }</span>
<a href="#l22.17"></a><span id="l22.17"> </span>
<a href="#l22.18"></a><span id="l22.18"> nsAbLDAPCard::~nsAbLDAPCard()</span>
<a href="#l22.19"></a><span id="l22.19"> {</span>
<a href="#l22.20"></a><span id="l22.20"> }</span>
<a href="#l22.21"></a><span id="l22.21"> </span>
<a href="#l22.22"></a><span id="l22.22" class="difflineat">@@ -141,65 +143,64 @@ NS_IMETHODIMP nsAbLDAPCard::GetLDAPMessa</span>
<a href="#l22.23"></a><span id="l22.23"> </span>
<a href="#l22.24"></a><span id="l22.24">   // Add card properties</span>
<a href="#l22.25"></a><span id="l22.25">   CharPtrArrayGuard props;</span>
<a href="#l22.26"></a><span id="l22.26">   rv = aAttributeMap-&gt;GetAllCardProperties(props.GetSizeAddr(),</span>
<a href="#l22.27"></a><span id="l22.27">     props.GetArrayAddr());</span>
<a href="#l22.28"></a><span id="l22.28">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.29"></a><span id="l22.29"> </span>
<a href="#l22.30"></a><span id="l22.30">   nsCAutoString attr;</span>
<a href="#l22.31"></a><span id="l22.31" class="difflineminus">-  nsString propvalue;</span>
<a href="#l22.32"></a><span id="l22.32" class="difflineplus">+  nsCString propvalue;</span>
<a href="#l22.33"></a><span id="l22.33">   for (PRUint32 i = 0; i &lt; props.GetSize(); ++i)</span>
<a href="#l22.34"></a><span id="l22.34">   {</span>
<a href="#l22.35"></a><span id="l22.35">     // Skip some attributes that don't map to LDAP.</span>
<a href="#l22.36"></a><span id="l22.36">     //</span>
<a href="#l22.37"></a><span id="l22.37">     // BirthYear : by default this is mapped to 'birthyear',</span>
<a href="#l22.38"></a><span id="l22.38">     // which is not part of mozillaAbPersonAlpha</span>
<a href="#l22.39"></a><span id="l22.39">     //</span>
<a href="#l22.40"></a><span id="l22.40">     // LastModifiedDate : by default this is mapped to 'modifytimestamp',</span>
<a href="#l22.41"></a><span id="l22.41">     // which cannot be modified</span>
<a href="#l22.42"></a><span id="l22.42">     //</span>
<a href="#l22.43"></a><span id="l22.43">     // PreferMailFormat : by default this is mapped to 'mozillaUseHtmlMail',</span>
<a href="#l22.44"></a><span id="l22.44">     // which is a boolean, not plaintext/html/unknown</span>
<a href="#l22.45"></a><span id="l22.45" class="difflineminus">-    if (!strcmp(props[i], &quot;BirthYear&quot;) ||</span>
<a href="#l22.46"></a><span id="l22.46" class="difflineminus">-        !strcmp(props[i], &quot;LastModifiedDate&quot;) ||</span>
<a href="#l22.47"></a><span id="l22.47" class="difflineminus">-        !strcmp(props[i], &quot;PreferMailFormat&quot;))</span>
<a href="#l22.48"></a><span id="l22.48" class="difflineplus">+    if (!strcmp(props[i], kBirthYearProperty) ||</span>
<a href="#l22.49"></a><span id="l22.49" class="difflineplus">+        !strcmp(props[i], kLastModifiedDateProperty) ||</span>
<a href="#l22.50"></a><span id="l22.50" class="difflineplus">+        !strcmp(props[i], kPreferMailFormatProperty))</span>
<a href="#l22.51"></a><span id="l22.51">       continue;</span>
<a href="#l22.52"></a><span id="l22.52">     </span>
<a href="#l22.53"></a><span id="l22.53">     rv = aAttributeMap-&gt;GetFirstAttribute(nsDependentCString(props[i]),</span>
<a href="#l22.54"></a><span id="l22.54">       attr);</span>
<a href="#l22.55"></a><span id="l22.55">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.56"></a><span id="l22.56">     ToLowerCase(attr);</span>
<a href="#l22.57"></a><span id="l22.57"> </span>
<a href="#l22.58"></a><span id="l22.58">     // If the property is not mapped to an attribute, skip it.</span>
<a href="#l22.59"></a><span id="l22.59">     if (attr.IsEmpty())</span>
<a href="#l22.60"></a><span id="l22.60">       continue;</span>
<a href="#l22.61"></a><span id="l22.61">  </span>
<a href="#l22.62"></a><span id="l22.62" class="difflineminus">-    rv = GetCardValue(props[i], propvalue);</span>
<a href="#l22.63"></a><span id="l22.63" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.64"></a><span id="l22.64" class="difflineminus">-</span>
<a href="#l22.65"></a><span id="l22.65">     nsCOMPtr&lt;nsILDAPModification&gt; mod =</span>
<a href="#l22.66"></a><span id="l22.66">       do_CreateInstance(&quot;@mozilla.org/network/ldap-modification;1&quot;, &amp;rv);</span>
<a href="#l22.67"></a><span id="l22.67">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.68"></a><span id="l22.68">    </span>
<a href="#l22.69"></a><span id="l22.69" class="difflineminus">-    if (!propvalue.IsEmpty())</span>
<a href="#l22.70"></a><span id="l22.70" class="difflineplus">+    rv = GetPropertyAsAUTF8String(props[i], propvalue);</span>
<a href="#l22.71"></a><span id="l22.71" class="difflineplus">+</span>
<a href="#l22.72"></a><span id="l22.72" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp;!propvalue.IsEmpty())</span>
<a href="#l22.73"></a><span id="l22.73">     {</span>
<a href="#l22.74"></a><span id="l22.74">       // If the new value is not empty, add/update it</span>
<a href="#l22.75"></a><span id="l22.75">       nsCOMPtr&lt;nsILDAPBERValue&gt; value =</span>
<a href="#l22.76"></a><span id="l22.76">         do_CreateInstance(&quot;@mozilla.org/network/ldap-ber-value;1&quot;, &amp;rv);</span>
<a href="#l22.77"></a><span id="l22.77">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.78"></a><span id="l22.78"> </span>
<a href="#l22.79"></a><span id="l22.79" class="difflineminus">-      rv = value-&gt;SetFromUTF8(NS_ConvertUTF16toUTF8(propvalue));</span>
<a href="#l22.80"></a><span id="l22.80" class="difflineplus">+      rv = value-&gt;SetFromUTF8(propvalue);</span>
<a href="#l22.81"></a><span id="l22.81">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.82"></a><span id="l22.82">  </span>
<a href="#l22.83"></a><span id="l22.83">       rv = mod-&gt;SetUpModificationOneValue(aType, attr, value);</span>
<a href="#l22.84"></a><span id="l22.84">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.85"></a><span id="l22.85">     </span>
<a href="#l22.86"></a><span id="l22.86">       printf(&quot;LDAP : setting attribute %s (%s) to '%s'\n&quot;, attr.get(),</span>
<a href="#l22.87"></a><span id="l22.87" class="difflineminus">-        props[i], NS_ConvertUTF16toUTF8(propvalue).get());</span>
<a href="#l22.88"></a><span id="l22.88" class="difflineplus">+        props[i], propvalue.get());</span>
<a href="#l22.89"></a><span id="l22.89">       modArray-&gt;AppendElement(mod, PR_FALSE);</span>
<a href="#l22.90"></a><span id="l22.90">       if (m_attributes.IndexOf(attr) != -1)</span>
<a href="#l22.91"></a><span id="l22.91">         m_attributes.AppendCString(attr);</span>
<a href="#l22.92"></a><span id="l22.92"> </span>
<a href="#l22.93"></a><span id="l22.93">     }</span>
<a href="#l22.94"></a><span id="l22.94">     else if ((aType == nsILDAPModification::MOD_REPLACE) &amp;&amp;</span>
<a href="#l22.95"></a><span id="l22.95">                (m_attributes.IndexOf(attr) != -1))</span>
<a href="#l22.96"></a><span id="l22.96">     {</span>
<a href="#l22.97"></a><span id="l22.97" class="difflineat">@@ -227,73 +228,70 @@ NS_IMETHODIMP nsAbLDAPCard::BuildRdn(nsI</span>
<a href="#l22.98"></a><span id="l22.98">                                      const PRUint32 aAttrCount,</span>
<a href="#l22.99"></a><span id="l22.99">                                      const char **aAttributes,</span>
<a href="#l22.100"></a><span id="l22.100">                                      nsACString &amp;aRdn)</span>
<a href="#l22.101"></a><span id="l22.101"> {</span>
<a href="#l22.102"></a><span id="l22.102">   NS_ENSURE_ARG_POINTER(aAttributeMap);</span>
<a href="#l22.103"></a><span id="l22.103">   NS_ENSURE_ARG_POINTER(aAttributes);</span>
<a href="#l22.104"></a><span id="l22.104">   </span>
<a href="#l22.105"></a><span id="l22.105">   nsresult rv;</span>
<a href="#l22.106"></a><span id="l22.106" class="difflineminus">-  nsCAutoString attr;</span>
<a href="#l22.107"></a><span id="l22.107" class="difflineplus">+  nsCString attr;</span>
<a href="#l22.108"></a><span id="l22.108">   nsCAutoString prop;</span>
<a href="#l22.109"></a><span id="l22.109" class="difflineminus">-  nsString propvalue;</span>
<a href="#l22.110"></a><span id="l22.110" class="difflineplus">+  nsCString propvalue;</span>
<a href="#l22.111"></a><span id="l22.111"> </span>
<a href="#l22.112"></a><span id="l22.112">   aRdn.Truncate();</span>
<a href="#l22.113"></a><span id="l22.113">   for (PRUint32 i = 0; i &lt; aAttrCount; ++i)</span>
<a href="#l22.114"></a><span id="l22.114">   {</span>
<a href="#l22.115"></a><span id="l22.115">     attr.Assign(nsDependentCString(aAttributes[i]));</span>
<a href="#l22.116"></a><span id="l22.116">    </span>
<a href="#l22.117"></a><span id="l22.117">     // Lookup the property corresponding to the attribute</span>
<a href="#l22.118"></a><span id="l22.118">     rv = aAttributeMap-&gt;GetProperty(attr, prop);</span>
<a href="#l22.119"></a><span id="l22.119">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.120"></a><span id="l22.120"> </span>
<a href="#l22.121"></a><span id="l22.121">     // Get the property value</span>
<a href="#l22.122"></a><span id="l22.122" class="difflineminus">-    rv = GetCardValue(prop.get(), propvalue);</span>
<a href="#l22.123"></a><span id="l22.123" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.124"></a><span id="l22.124" class="difflineplus">+    rv = GetPropertyAsAUTF8String(prop.get(), propvalue);</span>
<a href="#l22.125"></a><span id="l22.125"> </span>
<a href="#l22.126"></a><span id="l22.126">     // XXX The case where an attribute needed to build the Relative</span>
<a href="#l22.127"></a><span id="l22.127">     // Distinguished Name is not set needs to be handled by the caller,</span>
<a href="#l22.128"></a><span id="l22.128">     // so as to let the user know what is missing.</span>
<a href="#l22.129"></a><span id="l22.129" class="difflineminus">-    if (propvalue.IsEmpty())</span>
<a href="#l22.130"></a><span id="l22.130" class="difflineplus">+    if (NS_FAILED(rv) || propvalue.IsEmpty())</span>
<a href="#l22.131"></a><span id="l22.131">     {</span>
<a href="#l22.132"></a><span id="l22.132">       NS_ERROR(&quot;nsAbLDAPCard::BuildRdn: a required attribute is not set&quot;);</span>
<a href="#l22.133"></a><span id="l22.133">       return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l22.134"></a><span id="l22.134">     }</span>
<a href="#l22.135"></a><span id="l22.135">   </span>
<a href="#l22.136"></a><span id="l22.136">     aRdn.Append(attr);</span>
<a href="#l22.137"></a><span id="l22.137">     aRdn.AppendLiteral(&quot;=&quot;);</span>
<a href="#l22.138"></a><span id="l22.138" class="difflineminus">-    aRdn.Append(NS_ConvertUTF16toUTF8(propvalue));</span>
<a href="#l22.139"></a><span id="l22.139" class="difflineplus">+    aRdn.Append(propvalue);</span>
<a href="#l22.140"></a><span id="l22.140">     if (i &lt; aAttrCount - 1)</span>
<a href="#l22.141"></a><span id="l22.141">       aRdn.AppendLiteral(&quot;+&quot;);</span>
<a href="#l22.142"></a><span id="l22.142">   }</span>
<a href="#l22.143"></a><span id="l22.143">   return NS_OK;</span>
<a href="#l22.144"></a><span id="l22.144"> }</span>
<a href="#l22.145"></a><span id="l22.145"> </span>
<a href="#l22.146"></a><span id="l22.146"> NS_IMETHODIMP nsAbLDAPCard::GetDn(nsACString &amp;aDN)</span>
<a href="#l22.147"></a><span id="l22.147"> {</span>
<a href="#l22.148"></a><span id="l22.148" class="difflineminus">-  aDN = m_dn;</span>
<a href="#l22.149"></a><span id="l22.149" class="difflineminus">-  return NS_OK;</span>
<a href="#l22.150"></a><span id="l22.150" class="difflineplus">+  return GetPropertyAsAUTF8String(kDNColumn, aDN);</span>
<a href="#l22.151"></a><span id="l22.151"> }</span>
<a href="#l22.152"></a><span id="l22.152"> </span>
<a href="#l22.153"></a><span id="l22.153"> NS_IMETHODIMP nsAbLDAPCard::SetDn(const nsACString &amp;aDN)</span>
<a href="#l22.154"></a><span id="l22.154"> {</span>
<a href="#l22.155"></a><span id="l22.155" class="difflineminus">-  m_dn = aDN;</span>
<a href="#l22.156"></a><span id="l22.156" class="difflineminus">-  return NS_OK;</span>
<a href="#l22.157"></a><span id="l22.157" class="difflineplus">+  return SetPropertyAsAUTF8String(kDNColumn, aDN);</span>
<a href="#l22.158"></a><span id="l22.158"> }</span>
<a href="#l22.159"></a><span id="l22.159"> </span>
<a href="#l22.160"></a><span id="l22.160"> NS_IMETHODIMP nsAbLDAPCard::SetMetaProperties(nsILDAPMessage *aMessage)</span>
<a href="#l22.161"></a><span id="l22.161"> {</span>
<a href="#l22.162"></a><span id="l22.162">   NS_ENSURE_ARG_POINTER(aMessage);</span>
<a href="#l22.163"></a><span id="l22.163">   </span>
<a href="#l22.164"></a><span id="l22.164">   // Get DN</span>
<a href="#l22.165"></a><span id="l22.165">   nsCAutoString dn;</span>
<a href="#l22.166"></a><span id="l22.166">   nsresult rv = aMessage-&gt;GetDn(dn);</span>
<a href="#l22.167"></a><span id="l22.167">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.168"></a><span id="l22.168"> </span>
<a href="#l22.169"></a><span id="l22.169" class="difflineminus">-  m_dn = dn;</span>
<a href="#l22.170"></a><span id="l22.170" class="difflineplus">+  SetDn(dn);</span>
<a href="#l22.171"></a><span id="l22.171"> </span>
<a href="#l22.172"></a><span id="l22.172">   // Get the list of set attributes</span>
<a href="#l22.173"></a><span id="l22.173">   CharPtrArrayGuard attrs;</span>
<a href="#l22.174"></a><span id="l22.174">   rv = aMessage-&gt;GetAttributes(attrs.GetSizeAddr(), attrs.GetArrayAddr());</span>
<a href="#l22.175"></a><span id="l22.175">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.176"></a><span id="l22.176">  </span>
<a href="#l22.177"></a><span id="l22.177">   nsCAutoString attr;</span>
<a href="#l22.178"></a><span id="l22.178">   m_attributes.Clear();</span>
<a href="#l22.179"></a><span id="l22.179" class="difflineat">@@ -316,9 +314,8 @@ NS_IMETHODIMP nsAbLDAPCard::SetMetaPrope</span>
<a href="#l22.180"></a><span id="l22.180">   {</span>
<a href="#l22.181"></a><span id="l22.181">     oclass.Assign(NS_LossyConvertUTF16toASCII(nsDependentString(vals[i])));</span>
<a href="#l22.182"></a><span id="l22.182">     ToLowerCase(oclass);</span>
<a href="#l22.183"></a><span id="l22.183">     m_objectClass.AppendCString(oclass);</span>
<a href="#l22.184"></a><span id="l22.184">   }</span>
<a href="#l22.185"></a><span id="l22.185"> </span>
<a href="#l22.186"></a><span id="l22.186">   return NS_OK;</span>
<a href="#l22.187"></a><span id="l22.187"> }</span>
<a href="#l22.188"></a><span id="l22.188" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPCard.h</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPCard.h</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -53,14 +53,13 @@ class nsAbLDAPCard : public nsAbCardProp</span>
<a href="#l23.4"></a><span id="l23.4"> public:</span>
<a href="#l23.5"></a><span id="l23.5">   NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l23.6"></a><span id="l23.6">   NS_DECL_NSIABLDAPCARD</span>
<a href="#l23.7"></a><span id="l23.7"> </span>
<a href="#l23.8"></a><span id="l23.8">   nsAbLDAPCard();</span>
<a href="#l23.9"></a><span id="l23.9">   virtual ~nsAbLDAPCard();</span>
<a href="#l23.10"></a><span id="l23.10"> </span>
<a href="#l23.11"></a><span id="l23.11"> protected:</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-  nsCString m_dn;</span>
<a href="#l23.13"></a><span id="l23.13">   nsCStringArray m_attributes;</span>
<a href="#l23.14"></a><span id="l23.14">   nsCStringArray m_objectClass;</span>
<a href="#l23.15"></a><span id="l23.15"> };</span>
<a href="#l23.16"></a><span id="l23.16"> </span>
<a href="#l23.17"></a><span id="l23.17"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPReplicationData.cpp</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPReplicationData.cpp</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -37,17 +37,16 @@</span>
<a href="#l24.4"></a><span id="l24.4">  *</span>
<a href="#l24.5"></a><span id="l24.5">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l24.6"></a><span id="l24.6"> </span>
<a href="#l24.7"></a><span id="l24.7"> #include &quot;nsILDAPMessage.h&quot;</span>
<a href="#l24.8"></a><span id="l24.8"> #include &quot;nsAbLDAPReplicationData.h&quot;</span>
<a href="#l24.9"></a><span id="l24.9"> #include &quot;nsIAbCard.h&quot;</span>
<a href="#l24.10"></a><span id="l24.10"> #include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l24.11"></a><span id="l24.11"> #include &quot;nsAbUtils.h&quot;</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-#include &quot;nsIAbMDBCard.h&quot;</span>
<a href="#l24.13"></a><span id="l24.13"> #include &quot;nsAbLDAPReplicationQuery.h&quot;</span>
<a href="#l24.14"></a><span id="l24.14"> #include &quot;nsProxiedService.h&quot;</span>
<a href="#l24.15"></a><span id="l24.15"> #include &quot;nsIRDFService.h&quot;</span>
<a href="#l24.16"></a><span id="l24.16"> #include &quot;nsIRDFResource.h&quot;</span>
<a href="#l24.17"></a><span id="l24.17"> #include &quot;nsILDAPErrors.h&quot;</span>
<a href="#l24.18"></a><span id="l24.18"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l24.19"></a><span id="l24.19"> #include &quot;nsXPCOMCIDInternal.h&quot;</span>
<a href="#l24.20"></a><span id="l24.20"> </span>
<a href="#l24.21"></a><span id="l24.21" class="difflineat">@@ -274,24 +273,18 @@ nsresult nsAbLDAPProcessReplicationData:</span>
<a href="#l24.22"></a><span id="l24.22">     if (!mReplicationDB || !mDBOpen)</span>
<a href="#l24.23"></a><span id="l24.23">         return NS_ERROR_FAILURE;</span>
<a href="#l24.24"></a><span id="l24.24"> </span>
<a href="#l24.25"></a><span id="l24.25">     nsresult rv = NS_OK;</span>
<a href="#l24.26"></a><span id="l24.26"> </span>
<a href="#l24.27"></a><span id="l24.27">     // Although we would may naturally create an nsIAbLDAPCard here, we don't</span>
<a href="#l24.28"></a><span id="l24.28">     // need to as we are writing this straight to the database, so just create</span>
<a href="#l24.29"></a><span id="l24.29">     // the database version instead.</span>
<a href="#l24.30"></a><span id="l24.30" class="difflineminus">-    nsCOMPtr&lt;nsIAbMDBCard&gt; dbCard(do_CreateInstance(NS_ABMDBCARD_CONTRACTID,</span>
<a href="#l24.31"></a><span id="l24.31" class="difflineminus">-                                                    &amp;rv));</span>
<a href="#l24.32"></a><span id="l24.32" class="difflineminus">-    if (NS_FAILED(rv)) {</span>
<a href="#l24.33"></a><span id="l24.33" class="difflineminus">-      Abort();</span>
<a href="#l24.34"></a><span id="l24.34" class="difflineminus">-      return rv;</span>
<a href="#l24.35"></a><span id="l24.35" class="difflineminus">-    }</span>
<a href="#l24.36"></a><span id="l24.36" class="difflineminus">-</span>
<a href="#l24.37"></a><span id="l24.37" class="difflineminus">-    nsCOMPtr&lt;nsIAbCard&gt; newCard(do_QueryInterface(dbCard, &amp;rv));</span>
<a href="#l24.38"></a><span id="l24.38" class="difflineplus">+    nsCOMPtr&lt;nsIAbCard&gt; newCard(do_CreateInstance(NS_ABMDBCARD_CONTRACTID,</span>
<a href="#l24.39"></a><span id="l24.39" class="difflineplus">+                                                  &amp;rv));</span>
<a href="#l24.40"></a><span id="l24.40">     if (NS_FAILED(rv)) {</span>
<a href="#l24.41"></a><span id="l24.41">       Abort();</span>
<a href="#l24.42"></a><span id="l24.42">       return rv;</span>
<a href="#l24.43"></a><span id="l24.43">     }</span>
<a href="#l24.44"></a><span id="l24.44"> </span>
<a href="#l24.45"></a><span id="l24.45">     rv = mAttrMap-&gt;SetCardPropertiesFromLDAPMessage(aMessage, newCard);</span>
<a href="#l24.46"></a><span id="l24.46">     if (NS_FAILED(rv))</span>
<a href="#l24.47"></a><span id="l24.47">     {</span>
<a href="#l24.48"></a><span id="l24.48" class="difflineat">@@ -307,24 +300,17 @@ nsresult nsAbLDAPProcessReplicationData:</span>
<a href="#l24.49"></a><span id="l24.49">         return rv;</span>
<a href="#l24.50"></a><span id="l24.50">     }</span>
<a href="#l24.51"></a><span id="l24.51"> </span>
<a href="#l24.52"></a><span id="l24.52">     // now set the attribute for the DN of the entry in the card in the DB</span>
<a href="#l24.53"></a><span id="l24.53">     nsCAutoString authDN;</span>
<a href="#l24.54"></a><span id="l24.54">     rv = aMessage-&gt;GetDn(authDN);</span>
<a href="#l24.55"></a><span id="l24.55">     if(NS_SUCCEEDED(rv) &amp;&amp; !authDN.IsEmpty())</span>
<a href="#l24.56"></a><span id="l24.56">     {</span>
<a href="#l24.57"></a><span id="l24.57" class="difflineminus">-        dbCard-&gt;SetAbDatabase(mReplicationDB);</span>
<a href="#l24.58"></a><span id="l24.58" class="difflineminus">-        dbCard-&gt;SetStringAttribute(&quot;_DN&quot;, NS_ConvertUTF8toUTF16(authDN).get());</span>
<a href="#l24.59"></a><span id="l24.59" class="difflineminus">-    }</span>
<a href="#l24.60"></a><span id="l24.60" class="difflineminus">-</span>
<a href="#l24.61"></a><span id="l24.61" class="difflineminus">-    newCard = do_QueryInterface(dbCard, &amp;rv);</span>
<a href="#l24.62"></a><span id="l24.62" class="difflineminus">-    if(NS_FAILED(rv)) {</span>
<a href="#l24.63"></a><span id="l24.63" class="difflineminus">-        Abort();</span>
<a href="#l24.64"></a><span id="l24.64" class="difflineminus">-        return rv;</span>
<a href="#l24.65"></a><span id="l24.65" class="difflineplus">+        newCard-&gt;SetPropertyAsAUTF8String(&quot;_DN&quot;, authDN);</span>
<a href="#l24.66"></a><span id="l24.66">     }</span>
<a href="#l24.67"></a><span id="l24.67"> </span>
<a href="#l24.68"></a><span id="l24.68">     rv = mReplicationDB-&gt;EditCard(newCard, PR_FALSE, nsnull);</span>
<a href="#l24.69"></a><span id="l24.69">     if(NS_FAILED(rv)) {</span>
<a href="#l24.70"></a><span id="l24.70">         Abort();</span>
<a href="#l24.71"></a><span id="l24.71">         return rv;</span>
<a href="#l24.72"></a><span id="l24.72">     }</span>
<a href="#l24.73"></a><span id="l24.73">     </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbMDBCard.cpp</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbMDBCard.cpp</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -34,119 +34,52 @@</span>
<a href="#l25.4"></a><span id="l25.4">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l25.5"></a><span id="l25.5">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l25.6"></a><span id="l25.6">  *</span>
<a href="#l25.7"></a><span id="l25.7">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l25.8"></a><span id="l25.8"> </span>
<a href="#l25.9"></a><span id="l25.9"> #include &quot;nsAbMDBCard.h&quot;</span>
<a href="#l25.10"></a><span id="l25.10"> </span>
<a href="#l25.11"></a><span id="l25.11"> nsAbMDBCard::nsAbMDBCard(void)</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-  : m_key(0),</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineminus">-    m_dbTableID(0),</span>
<a href="#l25.14"></a><span id="l25.14" class="difflineminus">-    m_dbRowID(0)</span>
<a href="#l25.15"></a><span id="l25.15"> {</span>
<a href="#l25.16"></a><span id="l25.16"> }</span>
<a href="#l25.17"></a><span id="l25.17"> </span>
<a href="#l25.18"></a><span id="l25.18"> nsAbMDBCard::~nsAbMDBCard(void)</span>
<a href="#l25.19"></a><span id="l25.19"> {</span>
<a href="#l25.20"></a><span id="l25.20"> }</span>
<a href="#l25.21"></a><span id="l25.21"> </span>
<a href="#l25.22"></a><span id="l25.22" class="difflineminus">-NS_IMPL_ISUPPORTS_INHERITED1(nsAbMDBCard, nsAbCardProperty, nsIAbMDBCard)</span>
<a href="#l25.23"></a><span id="l25.23" class="difflineminus">-</span>
<a href="#l25.24"></a><span id="l25.24" class="difflineminus">-NS_IMETHODIMP nsAbMDBCard::GetDbTableID(PRUint32 *aDbTableID)</span>
<a href="#l25.25"></a><span id="l25.25" class="difflineminus">-{</span>
<a href="#l25.26"></a><span id="l25.26" class="difflineminus">-  *aDbTableID = m_dbTableID;</span>
<a href="#l25.27"></a><span id="l25.27" class="difflineminus">-  return NS_OK;</span>
<a href="#l25.28"></a><span id="l25.28" class="difflineminus">-}</span>
<a href="#l25.29"></a><span id="l25.29" class="difflineminus">-</span>
<a href="#l25.30"></a><span id="l25.30" class="difflineminus">-NS_IMETHODIMP nsAbMDBCard::SetDbTableID(PRUint32 aDbTableID)</span>
<a href="#l25.31"></a><span id="l25.31" class="difflineminus">-{</span>
<a href="#l25.32"></a><span id="l25.32" class="difflineminus">-  m_dbTableID = aDbTableID;</span>
<a href="#l25.33"></a><span id="l25.33" class="difflineminus">-  return NS_OK;</span>
<a href="#l25.34"></a><span id="l25.34" class="difflineminus">-}</span>
<a href="#l25.35"></a><span id="l25.35" class="difflineminus">-</span>
<a href="#l25.36"></a><span id="l25.36" class="difflineminus">-NS_IMETHODIMP nsAbMDBCard::GetDbRowID(PRUint32 *aDbRowID)</span>
<a href="#l25.37"></a><span id="l25.37" class="difflineminus">-{</span>
<a href="#l25.38"></a><span id="l25.38" class="difflineminus">-  *aDbRowID = m_dbRowID;</span>
<a href="#l25.39"></a><span id="l25.39" class="difflineminus">-  return NS_OK;</span>
<a href="#l25.40"></a><span id="l25.40" class="difflineminus">-}</span>
<a href="#l25.41"></a><span id="l25.41" class="difflineminus">-</span>
<a href="#l25.42"></a><span id="l25.42" class="difflineminus">-NS_IMETHODIMP nsAbMDBCard::SetDbRowID(PRUint32 aDbRowID)</span>
<a href="#l25.43"></a><span id="l25.43" class="difflineminus">-{</span>
<a href="#l25.44"></a><span id="l25.44" class="difflineminus">-  m_dbRowID = aDbRowID;</span>
<a href="#l25.45"></a><span id="l25.45" class="difflineminus">-  return NS_OK;</span>
<a href="#l25.46"></a><span id="l25.46" class="difflineminus">-}</span>
<a href="#l25.47"></a><span id="l25.47" class="difflineminus">-</span>
<a href="#l25.48"></a><span id="l25.48" class="difflineminus">-NS_IMETHODIMP nsAbMDBCard::GetKey(PRUint32 *aKey)</span>
<a href="#l25.49"></a><span id="l25.49" class="difflineminus">-{</span>
<a href="#l25.50"></a><span id="l25.50" class="difflineminus">-  *aKey = m_key;</span>
<a href="#l25.51"></a><span id="l25.51" class="difflineminus">-  return NS_OK;</span>
<a href="#l25.52"></a><span id="l25.52" class="difflineminus">-}</span>
<a href="#l25.53"></a><span id="l25.53" class="difflineminus">-</span>
<a href="#l25.54"></a><span id="l25.54" class="difflineminus">-NS_IMETHODIMP nsAbMDBCard::SetKey(PRUint32 key)</span>
<a href="#l25.55"></a><span id="l25.55" class="difflineminus">-{</span>
<a href="#l25.56"></a><span id="l25.56" class="difflineminus">-  m_key = key;</span>
<a href="#l25.57"></a><span id="l25.57" class="difflineminus">-  return NS_OK;</span>
<a href="#l25.58"></a><span id="l25.58" class="difflineminus">-}</span>
<a href="#l25.59"></a><span id="l25.59" class="difflineminus">-</span>
<a href="#l25.60"></a><span id="l25.60" class="difflineminus">-NS_IMETHODIMP nsAbMDBCard::SetAbDatabase(nsIAddrDatabase* database)</span>
<a href="#l25.61"></a><span id="l25.61" class="difflineminus">-{</span>
<a href="#l25.62"></a><span id="l25.62" class="difflineminus">-  mCardDatabase = database;</span>
<a href="#l25.63"></a><span id="l25.63" class="difflineminus">-  return NS_OK;</span>
<a href="#l25.64"></a><span id="l25.64" class="difflineminus">-}</span>
<a href="#l25.65"></a><span id="l25.65" class="difflineminus">-</span>
<a href="#l25.66"></a><span id="l25.66" class="difflineminus">-NS_IMETHODIMP nsAbMDBCard::SetStringAttribute(const char *name, const PRUnichar *value)</span>
<a href="#l25.67"></a><span id="l25.67" class="difflineminus">-{</span>
<a href="#l25.68"></a><span id="l25.68" class="difflineminus">-  NS_ASSERTION(mCardDatabase, &quot;no db&quot;);</span>
<a href="#l25.69"></a><span id="l25.69" class="difflineminus">-  if (!mCardDatabase)</span>
<a href="#l25.70"></a><span id="l25.70" class="difflineminus">-    return NS_ERROR_UNEXPECTED;</span>
<a href="#l25.71"></a><span id="l25.71" class="difflineminus">-</span>
<a href="#l25.72"></a><span id="l25.72" class="difflineminus">-  return mCardDatabase-&gt;SetCardValue(this, name, value, PR_TRUE /* notify */);</span>
<a href="#l25.73"></a><span id="l25.73" class="difflineminus">-}  </span>
<a href="#l25.74"></a><span id="l25.74" class="difflineminus">-</span>
<a href="#l25.75"></a><span id="l25.75" class="difflineminus">-NS_IMETHODIMP nsAbMDBCard::GetStringAttribute(const char *name, PRUnichar **value)</span>
<a href="#l25.76"></a><span id="l25.76" class="difflineminus">-{</span>
<a href="#l25.77"></a><span id="l25.77" class="difflineminus">-  NS_ASSERTION(mCardDatabase, &quot;no db&quot;);</span>
<a href="#l25.78"></a><span id="l25.78" class="difflineminus">-  if (!mCardDatabase)</span>
<a href="#l25.79"></a><span id="l25.79" class="difflineminus">-    return NS_ERROR_UNEXPECTED;</span>
<a href="#l25.80"></a><span id="l25.80" class="difflineminus">-</span>
<a href="#l25.81"></a><span id="l25.81" class="difflineminus">-  return mCardDatabase-&gt;GetCardValue(this, name, value);</span>
<a href="#l25.82"></a><span id="l25.82" class="difflineminus">-}</span>
<a href="#l25.83"></a><span id="l25.83" class="difflineplus">+NS_IMPL_ISUPPORTS_INHERITED0(nsAbMDBCard, nsAbCardProperty)</span>
<a href="#l25.84"></a><span id="l25.84"> </span>
<a href="#l25.85"></a><span id="l25.85"> NS_IMETHODIMP nsAbMDBCard::Equals(nsIAbCard *card, PRBool *result)</span>
<a href="#l25.86"></a><span id="l25.86"> {</span>
<a href="#l25.87"></a><span id="l25.87" class="difflineminus">-  nsresult rv;</span>
<a href="#l25.88"></a><span id="l25.88" class="difflineminus">-</span>
<a href="#l25.89"></a><span id="l25.89">   if (this == card) {</span>
<a href="#l25.90"></a><span id="l25.90">     *result = PR_TRUE;</span>
<a href="#l25.91"></a><span id="l25.91">     return NS_OK;</span>
<a href="#l25.92"></a><span id="l25.92">   }</span>
<a href="#l25.93"></a><span id="l25.93"> </span>
<a href="#l25.94"></a><span id="l25.94" class="difflineminus">-  // the reason we need this card at all is that multiple nsIAbCards</span>
<a href="#l25.95"></a><span id="l25.95" class="difflineminus">-  // can exist for a given mdbcard</span>
<a href="#l25.96"></a><span id="l25.96" class="difflineminus">-  nsCOMPtr &lt;nsIAbMDBCard&gt; mdbcard = do_QueryInterface(card, &amp;rv);</span>
<a href="#l25.97"></a><span id="l25.97" class="difflineminus">-  if (NS_FAILED(rv) || !mdbcard) {</span>
<a href="#l25.98"></a><span id="l25.98" class="difflineminus">-    // XXX using ldap can get us here, we need to fix how the listeners work</span>
<a href="#l25.99"></a><span id="l25.99" class="difflineplus">+  // If we have the same directory, we will equal the other card merely given</span>
<a href="#l25.100"></a><span id="l25.100" class="difflineplus">+  // the row IDs. If not, we are never equal. But we are dumb in that we don't</span>
<a href="#l25.101"></a><span id="l25.101" class="difflineplus">+  // know who our directory is, which may change in the future. For now,</span>
<a href="#l25.102"></a><span id="l25.102" class="difflineplus">+  // however, the only known users of this method are for locating us in a list</span>
<a href="#l25.103"></a><span id="l25.103" class="difflineplus">+  // of cards, most commonly mailing lists; a warning on the IDL has also</span>
<a href="#l25.104"></a><span id="l25.104" class="difflineplus">+  // notified consumers that this method is not generally safe to use. In this</span>
<a href="#l25.105"></a><span id="l25.105" class="difflineplus">+  // respect, it is safe to assume that the directory portion is satisified when</span>
<a href="#l25.106"></a><span id="l25.106" class="difflineplus">+  // making this call.</span>
<a href="#l25.107"></a><span id="l25.107" class="difflineplus">+  // However, if we make the wrong assumption, one of two things will happen.</span>
<a href="#l25.108"></a><span id="l25.108" class="difflineplus">+  // If the other directory is a local address book, we could return a spurious</span>
<a href="#l25.109"></a><span id="l25.109" class="difflineplus">+  // true result. If not, then DbRowID should be unset and we can definitively</span>
<a href="#l25.110"></a><span id="l25.110" class="difflineplus">+  // return false.</span>
<a href="#l25.111"></a><span id="l25.111" class="difflineplus">+</span>
<a href="#l25.112"></a><span id="l25.112" class="difflineplus">+  PRUint32 row;</span>
<a href="#l25.113"></a><span id="l25.113" class="difflineplus">+  nsresult rv = card-&gt;GetPropertyAsUint32(&quot;DbRowID&quot;, &amp;row);</span>
<a href="#l25.114"></a><span id="l25.114" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l25.115"></a><span id="l25.115" class="difflineplus">+  {</span>
<a href="#l25.116"></a><span id="l25.116">     *result = PR_FALSE;</span>
<a href="#l25.117"></a><span id="l25.117">     return NS_OK;</span>
<a href="#l25.118"></a><span id="l25.118">   }</span>
<a href="#l25.119"></a><span id="l25.119"> </span>
<a href="#l25.120"></a><span id="l25.120" class="difflineminus">-  // XXX todo</span>
<a href="#l25.121"></a><span id="l25.121" class="difflineminus">-  // optimize this code, key might be enough</span>
<a href="#l25.122"></a><span id="l25.122" class="difflineminus">-  PRUint32 dbRowID;</span>
<a href="#l25.123"></a><span id="l25.123" class="difflineminus">-  rv = mdbcard-&gt;GetDbRowID(&amp;dbRowID);</span>
<a href="#l25.124"></a><span id="l25.124" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l25.125"></a><span id="l25.125" class="difflineplus">+  PRUint32 ourRow;</span>
<a href="#l25.126"></a><span id="l25.126" class="difflineplus">+  rv = GetPropertyAsUint32(&quot;DbRowID&quot;, &amp;ourRow);</span>
<a href="#l25.127"></a><span id="l25.127" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.128"></a><span id="l25.128"> </span>
<a href="#l25.129"></a><span id="l25.129" class="difflineminus">-  PRUint32 dbTableID;</span>
<a href="#l25.130"></a><span id="l25.130" class="difflineminus">-  rv = mdbcard-&gt;GetDbTableID(&amp;dbTableID);</span>
<a href="#l25.131"></a><span id="l25.131" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l25.132"></a><span id="l25.132" class="difflineminus">-</span>
<a href="#l25.133"></a><span id="l25.133" class="difflineminus">-  PRUint32 key;</span>
<a href="#l25.134"></a><span id="l25.134" class="difflineminus">-  rv = mdbcard-&gt;GetKey(&amp;key);</span>
<a href="#l25.135"></a><span id="l25.135" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l25.136"></a><span id="l25.136" class="difflineminus">-</span>
<a href="#l25.137"></a><span id="l25.137" class="difflineminus">-  if (dbRowID == m_dbRowID &amp;&amp; dbTableID == m_dbTableID &amp;&amp; key == m_key)</span>
<a href="#l25.138"></a><span id="l25.138" class="difflineminus">-    *result = PR_TRUE;</span>
<a href="#l25.139"></a><span id="l25.139" class="difflineminus">-  else</span>
<a href="#l25.140"></a><span id="l25.140" class="difflineminus">-    *result = PR_FALSE;</span>
<a href="#l25.141"></a><span id="l25.141" class="difflineplus">+  *result = (row == ourRow);</span>
<a href="#l25.142"></a><span id="l25.142">   return NS_OK;</span>
<a href="#l25.143"></a><span id="l25.143"> }</span>
<a href="#l25.144"></a><span id="l25.144" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbMDBCard.h</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbMDBCard.h</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -34,34 +34,23 @@</span>
<a href="#l26.4"></a><span id="l26.4">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l26.5"></a><span id="l26.5">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l26.6"></a><span id="l26.6">  *</span>
<a href="#l26.7"></a><span id="l26.7">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l26.8"></a><span id="l26.8"> </span>
<a href="#l26.9"></a><span id="l26.9"> #ifndef nsAbMDBCard_h__</span>
<a href="#l26.10"></a><span id="l26.10"> #define nsAbMDBCard_h__</span>
<a href="#l26.11"></a><span id="l26.11"> </span>
<a href="#l26.12"></a><span id="l26.12" class="difflineminus">-#include &quot;nsIAbMDBCard.h&quot;</span>
<a href="#l26.13"></a><span id="l26.13"> #include &quot;nsAbCardProperty.h&quot;</span>
<a href="#l26.14"></a><span id="l26.14"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l26.15"></a><span id="l26.15" class="difflineminus">-#include &quot;nsIAddrDatabase.h&quot;</span>
<a href="#l26.16"></a><span id="l26.16"> </span>
<a href="#l26.17"></a><span id="l26.17" class="difflineminus">-class nsAbMDBCard: public nsIAbMDBCard,</span>
<a href="#l26.18"></a><span id="l26.18" class="difflineminus">-                   public nsAbCardProperty</span>
<a href="#l26.19"></a><span id="l26.19" class="difflineplus">+class nsAbMDBCard: public nsAbCardProperty</span>
<a href="#l26.20"></a><span id="l26.20"> {</span>
<a href="#l26.21"></a><span id="l26.21"> public:</span>
<a href="#l26.22"></a><span id="l26.22">   NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l26.23"></a><span id="l26.23" class="difflineminus">-  NS_DECL_NSIABMDBCARD</span>
<a href="#l26.24"></a><span id="l26.24"> </span>
<a href="#l26.25"></a><span id="l26.25">   nsAbMDBCard(void);</span>
<a href="#l26.26"></a><span id="l26.26">   virtual ~nsAbMDBCard(void);</span>
<a href="#l26.27"></a><span id="l26.27"> </span>
<a href="#l26.28"></a><span id="l26.28">   NS_IMETHOD Equals(nsIAbCard *card, PRBool *result);</span>
<a href="#l26.29"></a><span id="l26.29" class="difflineminus">-</span>
<a href="#l26.30"></a><span id="l26.30" class="difflineminus">-protected:</span>
<a href="#l26.31"></a><span id="l26.31" class="difflineminus">-  PRUint32 m_key;</span>
<a href="#l26.32"></a><span id="l26.32" class="difflineminus">-  PRUint32 m_dbTableID;</span>
<a href="#l26.33"></a><span id="l26.33" class="difflineminus">-  PRUint32 m_dbRowID;</span>
<a href="#l26.34"></a><span id="l26.34" class="difflineminus">-</span>
<a href="#l26.35"></a><span id="l26.35" class="difflineminus">-  nsCOMPtr&lt;nsIAddrDatabase&gt; mCardDatabase;</span>
<a href="#l26.36"></a><span id="l26.36"> };</span>
<a href="#l26.37"></a><span id="l26.37"> </span>
<a href="#l26.38"></a><span id="l26.38"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbMDBDirProperty.cpp</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbMDBDirProperty.cpp</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -43,17 +43,16 @@</span>
<a href="#l27.4"></a><span id="l27.4"> #include &quot;nsIServiceManager.h&quot;</span>
<a href="#l27.5"></a><span id="l27.5"> #include &quot;nsRDFCID.h&quot;</span>
<a href="#l27.6"></a><span id="l27.6"> #include &quot;nsStringGlue.h&quot;</span>
<a href="#l27.7"></a><span id="l27.7"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l27.8"></a><span id="l27.8"> #include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l27.9"></a><span id="l27.9"> #include &quot;nsAddrDatabase.h&quot;</span>
<a href="#l27.10"></a><span id="l27.10"> #include &quot;nsIAbCard.h&quot;</span>
<a href="#l27.11"></a><span id="l27.11"> #include &quot;nsIAbListener.h&quot;</span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-#include &quot;nsIAbMDBCard.h&quot;</span>
<a href="#l27.13"></a><span id="l27.13"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l27.14"></a><span id="l27.14"> #include &quot;mdb.h&quot;</span>
<a href="#l27.15"></a><span id="l27.15"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l27.16"></a><span id="l27.16"> </span>
<a href="#l27.17"></a><span id="l27.17"> nsAbMDBDirProperty::nsAbMDBDirProperty(void)</span>
<a href="#l27.18"></a><span id="l27.18"> {</span>
<a href="#l27.19"></a><span id="l27.19">   m_dbRowID = 0;</span>
<a href="#l27.20"></a><span id="l27.20"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbMDBDirectory.cpp</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbMDBDirectory.cpp</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -39,17 +39,16 @@</span>
<a href="#l28.4"></a><span id="l28.4"> </span>
<a href="#l28.5"></a><span id="l28.5"> #include &quot;nsAbMDBDirectory.h&quot; </span>
<a href="#l28.6"></a><span id="l28.6"> #include &quot;nsIRDFService.h&quot;</span>
<a href="#l28.7"></a><span id="l28.7"> #include &quot;nsRDFCID.h&quot;</span>
<a href="#l28.8"></a><span id="l28.8"> #include &quot;nsStringGlue.h&quot;</span>
<a href="#l28.9"></a><span id="l28.9"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l28.10"></a><span id="l28.10"> #include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l28.11"></a><span id="l28.11"> #include &quot;nsAddrDatabase.h&quot;</span>
<a href="#l28.12"></a><span id="l28.12" class="difflineminus">-#include &quot;nsIAbMDBCard.h&quot;</span>
<a href="#l28.13"></a><span id="l28.13"> #include &quot;nsIAbListener.h&quot;</span>
<a href="#l28.14"></a><span id="l28.14"> #include &quot;nsIAbManager.h&quot;</span>
<a href="#l28.15"></a><span id="l28.15"> #include &quot;nsIURL.h&quot;</span>
<a href="#l28.16"></a><span id="l28.16"> #include &quot;nsNetCID.h&quot;</span>
<a href="#l28.17"></a><span id="l28.17"> #include &quot;nsAbDirectoryQuery.h&quot;</span>
<a href="#l28.18"></a><span id="l28.18"> #include &quot;nsIAbDirectoryQueryProxy.h&quot;</span>
<a href="#l28.19"></a><span id="l28.19"> #include &quot;nsAbQueryStringToExpression.h&quot;</span>
<a href="#l28.20"></a><span id="l28.20"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l28.21"></a><span id="l28.21" class="difflineat">@@ -499,54 +498,51 @@ NS_IMETHODIMP nsAbMDBDirectory::DeleteCa</span>
<a href="#l28.22"></a><span id="l28.22">     PRUint32 i;</span>
<a href="#l28.23"></a><span id="l28.23">     rv = aCards-&gt;GetLength(&amp;cardCount);</span>
<a href="#l28.24"></a><span id="l28.24">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l28.25"></a><span id="l28.25">     for (i = 0; i &lt; cardCount; i++)</span>
<a href="#l28.26"></a><span id="l28.26">     {</span>
<a href="#l28.27"></a><span id="l28.27">       nsCOMPtr&lt;nsIAbCard&gt; card(do_QueryElementAt(aCards, i, &amp;rv));</span>
<a href="#l28.28"></a><span id="l28.28">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l28.29"></a><span id="l28.29"> </span>
<a href="#l28.30"></a><span id="l28.30" class="difflineminus">-      nsCOMPtr&lt;nsIAbMDBCard&gt; dbcard(do_QueryInterface(card, &amp;rv));</span>
<a href="#l28.31"></a><span id="l28.31" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l28.32"></a><span id="l28.32" class="difflineminus">-</span>
<a href="#l28.33"></a><span id="l28.33">       if (card)</span>
<a href="#l28.34"></a><span id="l28.34">       {</span>
<a href="#l28.35"></a><span id="l28.35" class="difflineplus">+        PRUint32 rowID;</span>
<a href="#l28.36"></a><span id="l28.36" class="difflineplus">+        rv = card-&gt;GetPropertyAsUint32(&quot;DbRowID&quot;, &amp;rowID);</span>
<a href="#l28.37"></a><span id="l28.37" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l28.38"></a><span id="l28.38" class="difflineplus">+</span>
<a href="#l28.39"></a><span id="l28.39">         if (m_IsMailList)</span>
<a href="#l28.40"></a><span id="l28.40">         {</span>
<a href="#l28.41"></a><span id="l28.41">           mDatabase-&gt;DeleteCardFromMailList(this, card, PR_TRUE);</span>
<a href="#l28.42"></a><span id="l28.42"> </span>
<a href="#l28.43"></a><span id="l28.43">           PRUint32 cardTotal = 0;</span>
<a href="#l28.44"></a><span id="l28.44">           PRInt32 i;</span>
<a href="#l28.45"></a><span id="l28.45">           if (m_AddressList)</span>
<a href="#l28.46"></a><span id="l28.46">             rv = m_AddressList-&gt;GetLength(&amp;cardTotal);</span>
<a href="#l28.47"></a><span id="l28.47">           for (i = cardTotal - 1; i &gt;= 0; i--)</span>
<a href="#l28.48"></a><span id="l28.48">           {            </span>
<a href="#l28.49"></a><span id="l28.49" class="difflineminus">-            nsCOMPtr&lt;nsIAbMDBCard&gt; dbarrayCard(do_QueryElementAt(m_AddressList, i, &amp;rv));</span>
<a href="#l28.50"></a><span id="l28.50" class="difflineminus">-            if (dbarrayCard)</span>
<a href="#l28.51"></a><span id="l28.51" class="difflineplus">+            nsCOMPtr&lt;nsIAbCard&gt; arrayCard(do_QueryElementAt(m_AddressList, i, &amp;rv));</span>
<a href="#l28.52"></a><span id="l28.52" class="difflineplus">+            if (arrayCard)</span>
<a href="#l28.53"></a><span id="l28.53">             {</span>
<a href="#l28.54"></a><span id="l28.54" class="difflineminus">-              PRUint32 tableID, rowID, cardTableID, cardRowID; </span>
<a href="#l28.55"></a><span id="l28.55" class="difflineminus">-              dbarrayCard-&gt;GetDbTableID(&amp;tableID);</span>
<a href="#l28.56"></a><span id="l28.56" class="difflineminus">-              dbarrayCard-&gt;GetDbRowID(&amp;rowID);</span>
<a href="#l28.57"></a><span id="l28.57" class="difflineminus">-              dbcard-&gt;GetDbTableID(&amp;cardTableID);</span>
<a href="#l28.58"></a><span id="l28.58" class="difflineminus">-              dbcard-&gt;GetDbRowID(&amp;cardRowID);</span>
<a href="#l28.59"></a><span id="l28.59" class="difflineminus">-              if (tableID == cardTableID &amp;&amp; rowID == cardRowID)</span>
<a href="#l28.60"></a><span id="l28.60" class="difflineplus">+              // No card can have a row ID of 0</span>
<a href="#l28.61"></a><span id="l28.61" class="difflineplus">+              PRUint32 arrayRowID = 0;</span>
<a href="#l28.62"></a><span id="l28.62" class="difflineplus">+              arrayCard-&gt;GetPropertyAsUint32(&quot;DbRowID&quot;, &amp;arrayRowID);</span>
<a href="#l28.63"></a><span id="l28.63" class="difflineplus">+              if (rowID == arrayRowID)</span>
<a href="#l28.64"></a><span id="l28.64">                 m_AddressList-&gt;RemoveElementAt(i);</span>
<a href="#l28.65"></a><span id="l28.65">             }</span>
<a href="#l28.66"></a><span id="l28.66">           }</span>
<a href="#l28.67"></a><span id="l28.67">         }</span>
<a href="#l28.68"></a><span id="l28.68">         else</span>
<a href="#l28.69"></a><span id="l28.69">         {</span>
<a href="#l28.70"></a><span id="l28.70">           mDatabase-&gt;DeleteCard(card, PR_TRUE, this);</span>
<a href="#l28.71"></a><span id="l28.71">           PRBool bIsMailList = PR_FALSE;</span>
<a href="#l28.72"></a><span id="l28.72">           card-&gt;GetIsMailList(&amp;bIsMailList);</span>
<a href="#l28.73"></a><span id="l28.73">           if (bIsMailList)</span>
<a href="#l28.74"></a><span id="l28.74">           {</span>
<a href="#l28.75"></a><span id="l28.75">             //to do, get mailing list dir side uri and notify rdf to remove it</span>
<a href="#l28.76"></a><span id="l28.76" class="difflineminus">-            PRUint32 rowID;</span>
<a href="#l28.77"></a><span id="l28.77" class="difflineminus">-            dbcard-&gt;GetDbRowID(&amp;rowID);</span>
<a href="#l28.78"></a><span id="l28.78">             nsCAutoString listUri(mURI);</span>
<a href="#l28.79"></a><span id="l28.79">             listUri.AppendLiteral(&quot;/MailList&quot;);</span>
<a href="#l28.80"></a><span id="l28.80">             listUri.AppendInt(rowID);</span>
<a href="#l28.81"></a><span id="l28.81">             if (!listUri.IsEmpty())</span>
<a href="#l28.82"></a><span id="l28.82">             {</span>
<a href="#l28.83"></a><span id="l28.83">               nsresult rv = NS_OK;</span>
<a href="#l28.84"></a><span id="l28.84">               nsCOMPtr&lt;nsIRDFService&gt; rdfService = </span>
<a href="#l28.85"></a><span id="l28.85">                        do_GetService(&quot;@mozilla.org/rdf/rdf-service;1&quot;, &amp;rv);</span>
<a href="#l28.86"></a><span id="l28.86" class="difflineat">@@ -692,42 +688,25 @@ NS_IMETHODIMP nsAbMDBDirectory::AddCard(</span>
<a href="#l28.87"></a><span id="l28.87"> </span>
<a href="#l28.88"></a><span id="l28.88">   nsresult rv = NS_OK;</span>
<a href="#l28.89"></a><span id="l28.89">   if (!mDatabase)</span>
<a href="#l28.90"></a><span id="l28.90">     rv = GetAbDatabase();</span>
<a href="#l28.91"></a><span id="l28.91"> </span>
<a href="#l28.92"></a><span id="l28.92">   if (NS_FAILED(rv) || !mDatabase)</span>
<a href="#l28.93"></a><span id="l28.93">     return NS_ERROR_FAILURE;</span>
<a href="#l28.94"></a><span id="l28.94"> </span>
<a href="#l28.95"></a><span id="l28.95" class="difflineminus">-  nsCOMPtr&lt;nsIAbCard&gt; newCard;</span>
<a href="#l28.96"></a><span id="l28.96" class="difflineminus">-  nsCOMPtr&lt;nsIAbMDBCard&gt; dbcard;</span>
<a href="#l28.97"></a><span id="l28.97" class="difflineminus">-</span>
<a href="#l28.98"></a><span id="l28.98" class="difflineminus">-  dbcard = do_QueryInterface(card, &amp;rv);</span>
<a href="#l28.99"></a><span id="l28.99" class="difflineminus">-  if (NS_FAILED(rv) || !dbcard) {</span>
<a href="#l28.100"></a><span id="l28.100" class="difflineminus">-    dbcard = do_CreateInstance(NS_ABMDBCARD_CONTRACTID, &amp;rv);</span>
<a href="#l28.101"></a><span id="l28.101" class="difflineplus">+  if (m_IsMailList)</span>
<a href="#l28.102"></a><span id="l28.102" class="difflineplus">+    rv = mDatabase-&gt;CreateNewListCardAndAddToDB(this, m_dbRowID, card, PR_TRUE /* notify */);</span>
<a href="#l28.103"></a><span id="l28.103" class="difflineplus">+  else</span>
<a href="#l28.104"></a><span id="l28.104" class="difflineplus">+    rv = mDatabase-&gt;CreateNewCardAndAddToDB(card, PR_TRUE, this);</span>
<a href="#l28.105"></a><span id="l28.105">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l28.106"></a><span id="l28.106"> </span>
<a href="#l28.107"></a><span id="l28.107" class="difflineminus">-    newCard = do_QueryInterface(dbcard, &amp;rv);</span>
<a href="#l28.108"></a><span id="l28.108" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l28.109"></a><span id="l28.109" class="difflineminus">-  </span>
<a href="#l28.110"></a><span id="l28.110" class="difflineminus">-    rv = newCard-&gt;Copy(card);</span>
<a href="#l28.111"></a><span id="l28.111" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l28.112"></a><span id="l28.112" class="difflineminus">-  }</span>
<a href="#l28.113"></a><span id="l28.113" class="difflineminus">-  else {</span>
<a href="#l28.114"></a><span id="l28.114" class="difflineminus">-    newCard = card;</span>
<a href="#l28.115"></a><span id="l28.115" class="difflineminus">-  }</span>
<a href="#l28.116"></a><span id="l28.116" class="difflineminus">-</span>
<a href="#l28.117"></a><span id="l28.117" class="difflineminus">-  dbcard-&gt;SetAbDatabase (mDatabase);</span>
<a href="#l28.118"></a><span id="l28.118" class="difflineminus">-  if (m_IsMailList)</span>
<a href="#l28.119"></a><span id="l28.119" class="difflineminus">-    mDatabase-&gt;CreateNewListCardAndAddToDB(this, m_dbRowID, newCard, PR_TRUE /* notify */);</span>
<a href="#l28.120"></a><span id="l28.120" class="difflineminus">-  else</span>
<a href="#l28.121"></a><span id="l28.121" class="difflineminus">-    mDatabase-&gt;CreateNewCardAndAddToDB(newCard, PR_TRUE, this);</span>
<a href="#l28.122"></a><span id="l28.122">   mDatabase-&gt;Commit(nsAddrDBCommitType::kLargeCommit);</span>
<a href="#l28.123"></a><span id="l28.123"> </span>
<a href="#l28.124"></a><span id="l28.124" class="difflineminus">-  NS_IF_ADDREF(*addedCard = newCard);</span>
<a href="#l28.125"></a><span id="l28.125" class="difflineplus">+  NS_IF_ADDREF(*addedCard = card);</span>
<a href="#l28.126"></a><span id="l28.126">   return NS_OK;</span>
<a href="#l28.127"></a><span id="l28.127"> }</span>
<a href="#l28.128"></a><span id="l28.128"> </span>
<a href="#l28.129"></a><span id="l28.129"> NS_IMETHODIMP nsAbMDBDirectory::ModifyCard(nsIAbCard *aModifiedCard)</span>
<a href="#l28.130"></a><span id="l28.130"> {</span>
<a href="#l28.131"></a><span id="l28.131">   NS_ENSURE_ARG_POINTER(aModifiedCard);</span>
<a href="#l28.132"></a><span id="l28.132"> </span>
<a href="#l28.133"></a><span id="l28.133">   nsresult rv;</span>
<a href="#l28.134"></a><span id="l28.134" class="difflineat">@@ -753,36 +732,28 @@ NS_IMETHODIMP nsAbMDBDirectory::DropCard</span>
<a href="#l28.135"></a><span id="l28.135"> </span>
<a href="#l28.136"></a><span id="l28.136">   if (!mDatabase)</span>
<a href="#l28.137"></a><span id="l28.137">     rv = GetAbDatabase();</span>
<a href="#l28.138"></a><span id="l28.138"> </span>
<a href="#l28.139"></a><span id="l28.139">   if (NS_FAILED(rv) || !mDatabase)</span>
<a href="#l28.140"></a><span id="l28.140">     return NS_ERROR_FAILURE;</span>
<a href="#l28.141"></a><span id="l28.141"> </span>
<a href="#l28.142"></a><span id="l28.142">   nsCOMPtr&lt;nsIAbCard&gt; newCard;</span>
<a href="#l28.143"></a><span id="l28.143" class="difflineminus">-  nsCOMPtr&lt;nsIAbMDBCard&gt; dbcard;</span>
<a href="#l28.144"></a><span id="l28.144"> </span>
<a href="#l28.145"></a><span id="l28.145">   if (needToCopyCard) {</span>
<a href="#l28.146"></a><span id="l28.146" class="difflineminus">-    dbcard = do_CreateInstance(NS_ABMDBCARD_CONTRACTID, &amp;rv);</span>
<a href="#l28.147"></a><span id="l28.147" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l28.148"></a><span id="l28.148" class="difflineplus">+    newCard = do_CreateInstance(NS_ABMDBCARD_CONTRACTID, &amp;rv);</span>
<a href="#l28.149"></a><span id="l28.149" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l28.150"></a><span id="l28.150"> </span>
<a href="#l28.151"></a><span id="l28.151" class="difflineminus">-    newCard = do_QueryInterface(dbcard, &amp;rv);</span>
<a href="#l28.152"></a><span id="l28.152" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l28.153"></a><span id="l28.153" class="difflineminus">-  </span>
<a href="#l28.154"></a><span id="l28.154">     rv = newCard-&gt;Copy(aCard);</span>
<a href="#l28.155"></a><span id="l28.155" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l28.156"></a><span id="l28.156" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l28.157"></a><span id="l28.157">   }</span>
<a href="#l28.158"></a><span id="l28.158">   else {</span>
<a href="#l28.159"></a><span id="l28.159" class="difflineminus">-    dbcard = do_QueryInterface(aCard, &amp;rv);</span>
<a href="#l28.160"></a><span id="l28.160" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l28.161"></a><span id="l28.161">     newCard = aCard;</span>
<a href="#l28.162"></a><span id="l28.162">   }  </span>
<a href="#l28.163"></a><span id="l28.163"> </span>
<a href="#l28.164"></a><span id="l28.164" class="difflineminus">-  dbcard-&gt;SetAbDatabase(mDatabase);</span>
<a href="#l28.165"></a><span id="l28.165" class="difflineminus">-</span>
<a href="#l28.166"></a><span id="l28.166">   if (m_IsMailList) {</span>
<a href="#l28.167"></a><span id="l28.167">     if (needToCopyCard) {</span>
<a href="#l28.168"></a><span id="l28.168">       nsCOMPtr &lt;nsIMdbRow&gt; cardRow;</span>
<a href="#l28.169"></a><span id="l28.169">       // if card doesn't exist in db, add the card to the directory that </span>
<a href="#l28.170"></a><span id="l28.170">       // contains the mailing list.</span>
<a href="#l28.171"></a><span id="l28.171">       mDatabase-&gt;FindRowByCard(newCard, getter_AddRefs(cardRow));</span>
<a href="#l28.172"></a><span id="l28.172">       if (!cardRow)</span>
<a href="#l28.173"></a><span id="l28.173">         mDatabase-&gt;CreateNewCardAndAddToDB(newCard, PR_TRUE /* notify */, this);</span>
<a href="#l28.174"></a><span id="l28.174" class="difflineat">@@ -1086,13 +1057,13 @@ NS_IMETHODIMP nsAbMDBDirectory::CardForE</span>
<a href="#l28.175"></a><span id="l28.175">   if (!*aAbCard) </span>
<a href="#l28.176"></a><span id="l28.176">   {</span>
<a href="#l28.177"></a><span id="l28.177">     // fix for bug #187239</span>
<a href="#l28.178"></a><span id="l28.178">     // didn't find it as the primary email?  try again, with k2ndEmailColumn (&quot;Additional Email&quot;)</span>
<a href="#l28.179"></a><span id="l28.179">     // </span>
<a href="#l28.180"></a><span id="l28.180">     // TODO bug #198731</span>
<a href="#l28.181"></a><span id="l28.181">     // unlike the kPriEmailColumn, we don't have kLower2ndEmailColumn</span>
<a href="#l28.182"></a><span id="l28.182">     // so we will still suffer from bug #196777 for &quot;additional emails&quot;</span>
<a href="#l28.183"></a><span id="l28.183" class="difflineminus">-    mDatabase-&gt;GetCardFromAttribute(this, k2ndEmailColumn, aEmailAddress, PR_TRUE /* caseInsensitive, see bug #191798 */, aAbCard);</span>
<a href="#l28.184"></a><span id="l28.184" class="difflineplus">+    mDatabase-&gt;GetCardFromAttribute(this, k2ndEmailProperty, aEmailAddress, PR_TRUE /* caseInsensitive, see bug #191798 */, aAbCard);</span>
<a href="#l28.185"></a><span id="l28.185">   }</span>
<a href="#l28.186"></a><span id="l28.186"> </span>
<a href="#l28.187"></a><span id="l28.187">   return NS_OK;</span>
<a href="#l28.188"></a><span id="l28.188"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbManager.cpp</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbManager.cpp</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -65,17 +65,17 @@</span>
<a href="#l29.4"></a><span id="l29.4"> #include &quot;nsICommandLine.h&quot;</span>
<a href="#l29.5"></a><span id="l29.5"> #include &quot;nsILocalFile.h&quot;</span>
<a href="#l29.6"></a><span id="l29.6"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l29.7"></a><span id="l29.7"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l29.8"></a><span id="l29.8"> #include &quot;nsDirectoryServiceUtils.h&quot;</span>
<a href="#l29.9"></a><span id="l29.9"> </span>
<a href="#l29.10"></a><span id="l29.10"> struct ExportAttributesTableStruct</span>
<a href="#l29.11"></a><span id="l29.11"> {</span>
<a href="#l29.12"></a><span id="l29.12" class="difflineminus">-  const char* abColName;</span>
<a href="#l29.13"></a><span id="l29.13" class="difflineplus">+  const char* abPropertyName;</span>
<a href="#l29.14"></a><span id="l29.14">   PRUint32 plainTextStringID;</span>
<a href="#l29.15"></a><span id="l29.15"> };</span>
<a href="#l29.16"></a><span id="l29.16"> </span>
<a href="#l29.17"></a><span id="l29.17"> // our schema is not fixed yet, but we still want some sort of objectclass</span>
<a href="#l29.18"></a><span id="l29.18"> // for now, use obsolete in the class name, hinting that this will change</span>
<a href="#l29.19"></a><span id="l29.19"> // see bugs bug #116692 and #118454</span>
<a href="#l29.20"></a><span id="l29.20"> #define MOZ_AB_OBJECTCLASS &quot;mozillaAbPersonAlpha&quot;</span>
<a href="#l29.21"></a><span id="l29.21"> </span>
<a href="#l29.22"></a><span id="l29.22" class="difflineat">@@ -89,67 +89,65 @@ struct ExportAttributesTableStruct</span>
<a href="#l29.23"></a><span id="l29.23"> // here's how we're coming up with the ldapPropertyName values</span>
<a href="#l29.24"></a><span id="l29.24"> // if they are specified in RFC 2798, use them</span>
<a href="#l29.25"></a><span id="l29.25"> // else use the 4.x LDIF attribute names (for example, &quot;xmozillanickname&quot;</span>
<a href="#l29.26"></a><span id="l29.26"> // as we want to allow export from mozilla back to 4.x, and other apps</span>
<a href="#l29.27"></a><span id="l29.27"> // are probably out there that can handle 4.x LDIF)</span>
<a href="#l29.28"></a><span id="l29.28"> // else use the MOZ_AB_LDIF_PREFIX prefix, see nsIAddrDatabase.idl</span>
<a href="#l29.29"></a><span id="l29.29"> </span>
<a href="#l29.30"></a><span id="l29.30"> const ExportAttributesTableStruct EXPORT_ATTRIBUTES_TABLE[] = {</span>
<a href="#l29.31"></a><span id="l29.31" class="difflineminus">-  {kFirstNameColumn, 2100},</span>
<a href="#l29.32"></a><span id="l29.32" class="difflineminus">-  {kLastNameColumn, 2101},</span>
<a href="#l29.33"></a><span id="l29.33" class="difflineminus">-  {kDisplayNameColumn, 2102},</span>
<a href="#l29.34"></a><span id="l29.34" class="difflineminus">-  {kNicknameColumn, 2103},</span>
<a href="#l29.35"></a><span id="l29.35" class="difflineminus">-  {kPriEmailColumn, 2104},</span>
<a href="#l29.36"></a><span id="l29.36" class="difflineminus">-  {k2ndEmailColumn, 2105},</span>
<a href="#l29.37"></a><span id="l29.37" class="difflineminus">-  {kAimScreenNameColumn},</span>
<a href="#l29.38"></a><span id="l29.38" class="difflineminus">-  {kPreferMailFormatColumn},</span>
<a href="#l29.39"></a><span id="l29.39" class="difflineminus">-  {kLastModifiedDateColumn},</span>
<a href="#l29.40"></a><span id="l29.40" class="difflineminus">-  {kWorkPhoneColumn, 2106},</span>
<a href="#l29.41"></a><span id="l29.41" class="difflineminus">-  {kWorkPhoneTypeColumn},</span>
<a href="#l29.42"></a><span id="l29.42" class="difflineminus">-  {kHomePhoneColumn, 2107},</span>
<a href="#l29.43"></a><span id="l29.43" class="difflineminus">-  {kHomePhoneTypeColumn},</span>
<a href="#l29.44"></a><span id="l29.44" class="difflineminus">-  {kFaxColumn, 2108},</span>
<a href="#l29.45"></a><span id="l29.45" class="difflineminus">-  {kFaxTypeColumn},</span>
<a href="#l29.46"></a><span id="l29.46" class="difflineminus">-  {kPagerColumn, 2109},</span>
<a href="#l29.47"></a><span id="l29.47" class="difflineminus">-  {kPagerTypeColumn},</span>
<a href="#l29.48"></a><span id="l29.48" class="difflineminus">-  {kCellularColumn, 2110},</span>
<a href="#l29.49"></a><span id="l29.49" class="difflineminus">-  {kCellularTypeColumn},</span>
<a href="#l29.50"></a><span id="l29.50" class="difflineminus">-  {kHomeAddressColumn, 2111},</span>
<a href="#l29.51"></a><span id="l29.51" class="difflineminus">-  {kHomeAddress2Column, 2112},</span>
<a href="#l29.52"></a><span id="l29.52" class="difflineminus">-  {kHomeCityColumn, 2113},</span>
<a href="#l29.53"></a><span id="l29.53" class="difflineminus">-  {kHomeStateColumn, 2114},</span>
<a href="#l29.54"></a><span id="l29.54" class="difflineminus">-  {kHomeZipCodeColumn, 2115},</span>
<a href="#l29.55"></a><span id="l29.55" class="difflineminus">-  {kHomeCountryColumn, 2116},</span>
<a href="#l29.56"></a><span id="l29.56" class="difflineminus">-  {kWorkAddressColumn, 2117},</span>
<a href="#l29.57"></a><span id="l29.57" class="difflineminus">-  {kWorkAddress2Column, 2118},</span>
<a href="#l29.58"></a><span id="l29.58" class="difflineminus">-  {kWorkCityColumn, 2119},</span>
<a href="#l29.59"></a><span id="l29.59" class="difflineminus">-  {kWorkStateColumn, 2120},</span>
<a href="#l29.60"></a><span id="l29.60" class="difflineminus">-  {kWorkZipCodeColumn, 2121},</span>
<a href="#l29.61"></a><span id="l29.61" class="difflineminus">-  {kWorkCountryColumn, 2122},</span>
<a href="#l29.62"></a><span id="l29.62" class="difflineminus">-  {kJobTitleColumn, 2123},</span>
<a href="#l29.63"></a><span id="l29.63" class="difflineminus">-  {kDepartmentColumn, 2124},</span>
<a href="#l29.64"></a><span id="l29.64" class="difflineminus">-  {kCompanyColumn, 2125},</span>
<a href="#l29.65"></a><span id="l29.65" class="difflineminus">-  {kWebPage1Column, 2126},</span>
<a href="#l29.66"></a><span id="l29.66" class="difflineminus">-  {kWebPage2Column, 2127},</span>
<a href="#l29.67"></a><span id="l29.67" class="difflineminus">-  {kBirthYearColumn, 2128}, // unused for now</span>
<a href="#l29.68"></a><span id="l29.68" class="difflineminus">-  {kBirthMonthColumn, 2129}, // unused for now</span>
<a href="#l29.69"></a><span id="l29.69" class="difflineminus">-  {kBirthDayColumn, 2130}, // unused for now</span>
<a href="#l29.70"></a><span id="l29.70" class="difflineminus">-  {kCustom1Column, 2131},</span>
<a href="#l29.71"></a><span id="l29.71" class="difflineminus">-  {kCustom2Column, 2132},</span>
<a href="#l29.72"></a><span id="l29.72" class="difflineminus">-  {kCustom3Column, 2133},</span>
<a href="#l29.73"></a><span id="l29.73" class="difflineminus">-  {kCustom4Column, 2134},</span>
<a href="#l29.74"></a><span id="l29.74" class="difflineminus">-  {kNotesColumn, 2135},</span>
<a href="#l29.75"></a><span id="l29.75" class="difflineminus">-  {kAnniversaryYearColumn},</span>
<a href="#l29.76"></a><span id="l29.76" class="difflineminus">-  {kAnniversaryMonthColumn},</span>
<a href="#l29.77"></a><span id="l29.77" class="difflineminus">-  {kAnniversaryDayColumn},</span>
<a href="#l29.78"></a><span id="l29.78" class="difflineminus">-  {kSpouseNameColumn},</span>
<a href="#l29.79"></a><span id="l29.79" class="difflineminus">-  {kFamilyNameColumn},</span>
<a href="#l29.80"></a><span id="l29.80" class="difflineminus">-  {kDefaultAddressColumn},</span>
<a href="#l29.81"></a><span id="l29.81" class="difflineminus">-  {kCategoryColumn},</span>
<a href="#l29.82"></a><span id="l29.82" class="difflineplus">+  {kFirstNameProperty, 2100},</span>
<a href="#l29.83"></a><span id="l29.83" class="difflineplus">+  {kLastNameProperty, 2101},</span>
<a href="#l29.84"></a><span id="l29.84" class="difflineplus">+  {kDisplayNameProperty, 2102},</span>
<a href="#l29.85"></a><span id="l29.85" class="difflineplus">+  {kNicknameProperty, 2103},</span>
<a href="#l29.86"></a><span id="l29.86" class="difflineplus">+  {kPriEmailProperty, 2104},</span>
<a href="#l29.87"></a><span id="l29.87" class="difflineplus">+  {k2ndEmailProperty, 2105},</span>
<a href="#l29.88"></a><span id="l29.88" class="difflineplus">+  {kScreenNameProperty},</span>
<a href="#l29.89"></a><span id="l29.89" class="difflineplus">+  {kPreferMailFormatProperty},</span>
<a href="#l29.90"></a><span id="l29.90" class="difflineplus">+  {kLastModifiedDateProperty},</span>
<a href="#l29.91"></a><span id="l29.91" class="difflineplus">+  {kWorkPhoneProperty, 2106},</span>
<a href="#l29.92"></a><span id="l29.92" class="difflineplus">+  {kWorkPhoneTypeProperty},</span>
<a href="#l29.93"></a><span id="l29.93" class="difflineplus">+  {kHomePhoneProperty, 2107},</span>
<a href="#l29.94"></a><span id="l29.94" class="difflineplus">+  {kHomePhoneTypeProperty},</span>
<a href="#l29.95"></a><span id="l29.95" class="difflineplus">+  {kFaxProperty, 2108},</span>
<a href="#l29.96"></a><span id="l29.96" class="difflineplus">+  {kFaxTypeProperty},</span>
<a href="#l29.97"></a><span id="l29.97" class="difflineplus">+  {kPagerProperty, 2109},</span>
<a href="#l29.98"></a><span id="l29.98" class="difflineplus">+  {kPagerTypeProperty},</span>
<a href="#l29.99"></a><span id="l29.99" class="difflineplus">+  {kCellularProperty, 2110},</span>
<a href="#l29.100"></a><span id="l29.100" class="difflineplus">+  {kCellularTypeProperty},</span>
<a href="#l29.101"></a><span id="l29.101" class="difflineplus">+  {kHomeAddressProperty, 2111},</span>
<a href="#l29.102"></a><span id="l29.102" class="difflineplus">+  {kHomeAddress2Property, 2112},</span>
<a href="#l29.103"></a><span id="l29.103" class="difflineplus">+  {kHomeCityProperty, 2113},</span>
<a href="#l29.104"></a><span id="l29.104" class="difflineplus">+  {kHomeStateProperty, 2114},</span>
<a href="#l29.105"></a><span id="l29.105" class="difflineplus">+  {kHomeZipCodeProperty, 2115},</span>
<a href="#l29.106"></a><span id="l29.106" class="difflineplus">+  {kHomeCountryProperty, 2116},</span>
<a href="#l29.107"></a><span id="l29.107" class="difflineplus">+  {kWorkAddressProperty, 2117},</span>
<a href="#l29.108"></a><span id="l29.108" class="difflineplus">+  {kWorkAddress2Property, 2118},</span>
<a href="#l29.109"></a><span id="l29.109" class="difflineplus">+  {kWorkCityProperty, 2119},</span>
<a href="#l29.110"></a><span id="l29.110" class="difflineplus">+  {kWorkStateProperty, 2120},</span>
<a href="#l29.111"></a><span id="l29.111" class="difflineplus">+  {kWorkZipCodeProperty, 2121},</span>
<a href="#l29.112"></a><span id="l29.112" class="difflineplus">+  {kWorkCountryProperty, 2122},</span>
<a href="#l29.113"></a><span id="l29.113" class="difflineplus">+  {kJobTitleProperty, 2123},</span>
<a href="#l29.114"></a><span id="l29.114" class="difflineplus">+  {kDepartmentProperty, 2124},</span>
<a href="#l29.115"></a><span id="l29.115" class="difflineplus">+  {kCompanyProperty, 2125},</span>
<a href="#l29.116"></a><span id="l29.116" class="difflineplus">+  {kWorkWebPageProperty, 2126},</span>
<a href="#l29.117"></a><span id="l29.117" class="difflineplus">+  {kHomeWebPageProperty, 2127},</span>
<a href="#l29.118"></a><span id="l29.118" class="difflineplus">+  {kBirthYearProperty, 2128}, // unused for now</span>
<a href="#l29.119"></a><span id="l29.119" class="difflineplus">+  {kBirthMonthProperty, 2129}, // unused for now</span>
<a href="#l29.120"></a><span id="l29.120" class="difflineplus">+  {kBirthDayProperty, 2130}, // unused for now</span>
<a href="#l29.121"></a><span id="l29.121" class="difflineplus">+  {kCustom1Property, 2131},</span>
<a href="#l29.122"></a><span id="l29.122" class="difflineplus">+  {kCustom2Property, 2132},</span>
<a href="#l29.123"></a><span id="l29.123" class="difflineplus">+  {kCustom3Property, 2133},</span>
<a href="#l29.124"></a><span id="l29.124" class="difflineplus">+  {kCustom4Property, 2134},</span>
<a href="#l29.125"></a><span id="l29.125" class="difflineplus">+  {kNotesProperty, 2135},</span>
<a href="#l29.126"></a><span id="l29.126" class="difflineplus">+  {kAnniversaryYearProperty},</span>
<a href="#l29.127"></a><span id="l29.127" class="difflineplus">+  {kAnniversaryMonthProperty},</span>
<a href="#l29.128"></a><span id="l29.128" class="difflineplus">+  {kAnniversaryDayProperty},</span>
<a href="#l29.129"></a><span id="l29.129" class="difflineplus">+  {kSpouseNameProperty},</span>
<a href="#l29.130"></a><span id="l29.130" class="difflineplus">+  {kFamilyNameProperty},</span>
<a href="#l29.131"></a><span id="l29.131"> };</span>
<a href="#l29.132"></a><span id="l29.132"> </span>
<a href="#l29.133"></a><span id="l29.133"> //</span>
<a href="#l29.134"></a><span id="l29.134"> // nsAbManager</span>
<a href="#l29.135"></a><span id="l29.135"> //</span>
<a href="#l29.136"></a><span id="l29.136"> nsAbManager::nsAbManager()</span>
<a href="#l29.137"></a><span id="l29.137"> {</span>
<a href="#l29.138"></a><span id="l29.138"> }</span>
<a href="#l29.139"></a><span id="l29.139" class="difflineat">@@ -618,19 +616,19 @@ nsAbManager::ExportDirectoryToDelimitedT</span>
<a href="#l29.140"></a><span id="l29.140">           // use LDIF for that.</span>
<a href="#l29.141"></a><span id="l29.141">         }</span>
<a href="#l29.142"></a><span id="l29.142">         else {</span>
<a href="#l29.143"></a><span id="l29.143">           nsString value;</span>
<a href="#l29.144"></a><span id="l29.144">           nsCString valueCStr;</span>
<a href="#l29.145"></a><span id="l29.145"> </span>
<a href="#l29.146"></a><span id="l29.146">           for (i = 0; i &lt; NS_ARRAY_LENGTH(EXPORT_ATTRIBUTES_TABLE); i++) {</span>
<a href="#l29.147"></a><span id="l29.147">             if (EXPORT_ATTRIBUTES_TABLE[i].plainTextStringID != 0) {</span>
<a href="#l29.148"></a><span id="l29.148" class="difflineminus">-              rv = card-&gt;GetCardValue(EXPORT_ATTRIBUTES_TABLE[i].abColName,</span>
<a href="#l29.149"></a><span id="l29.149" class="difflineminus">-                                      value);</span>
<a href="#l29.150"></a><span id="l29.150" class="difflineminus">-              NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l29.151"></a><span id="l29.151" class="difflineplus">+              rv = card-&gt;GetPropertyAsAString(EXPORT_ATTRIBUTES_TABLE[i].abPropertyName, value);</span>
<a href="#l29.152"></a><span id="l29.152" class="difflineplus">+              if (NS_FAILED(rv))</span>
<a href="#l29.153"></a><span id="l29.153" class="difflineplus">+                value.Truncate();</span>
<a href="#l29.154"></a><span id="l29.154"> </span>
<a href="#l29.155"></a><span id="l29.155">               // If a string contains at least one comma, tab or double quote then</span>
<a href="#l29.156"></a><span id="l29.156">               // we need to quote the entire string. Also if double quote is part</span>
<a href="#l29.157"></a><span id="l29.157">               // of the string we need to quote the double quote(s) as well.</span>
<a href="#l29.158"></a><span id="l29.158">               nsAutoString newValue(value);</span>
<a href="#l29.159"></a><span id="l29.159">               PRBool needsQuotes = PR_FALSE;</span>
<a href="#l29.160"></a><span id="l29.160">               if(newValue.FindChar('&quot;') != -1)</span>
<a href="#l29.161"></a><span id="l29.161">               {</span>
<a href="#l29.162"></a><span id="l29.162" class="difflineat">@@ -786,25 +784,25 @@ nsAbManager::ExportDirectoryToLDIF(nsIAb</span>
<a href="#l29.163"></a><span id="l29.163">           if (length != writeCount)</span>
<a href="#l29.164"></a><span id="l29.164">             return NS_ERROR_FAILURE;</span>
<a href="#l29.165"></a><span id="l29.165"> </span>
<a href="#l29.166"></a><span id="l29.166">           valueCStr.Truncate();</span>
<a href="#l29.167"></a><span id="l29.167"> </span>
<a href="#l29.168"></a><span id="l29.168">           nsCAutoString ldapAttribute;</span>
<a href="#l29.169"></a><span id="l29.169"> </span>
<a href="#l29.170"></a><span id="l29.170">           for (i = 0; i &lt; NS_ARRAY_LENGTH(EXPORT_ATTRIBUTES_TABLE); i++) {</span>
<a href="#l29.171"></a><span id="l29.171" class="difflineminus">-            if (NS_SUCCEEDED(attrMap-&gt;GetFirstAttribute(nsDependentCString(EXPORT_ATTRIBUTES_TABLE[i].abColName),</span>
<a href="#l29.172"></a><span id="l29.172" class="difflineplus">+            if (NS_SUCCEEDED(attrMap-&gt;GetFirstAttribute(nsDependentCString(EXPORT_ATTRIBUTES_TABLE[i].abPropertyName),</span>
<a href="#l29.173"></a><span id="l29.173">                                                         ldapAttribute)) &amp;&amp;</span>
<a href="#l29.174"></a><span id="l29.174">                 !ldapAttribute.IsEmpty()) {</span>
<a href="#l29.175"></a><span id="l29.175"> </span>
<a href="#l29.176"></a><span id="l29.176" class="difflineminus">-              rv = card-&gt;GetCardValue(EXPORT_ATTRIBUTES_TABLE[i].abColName,</span>
<a href="#l29.177"></a><span id="l29.177" class="difflineminus">-                                      value);</span>
<a href="#l29.178"></a><span id="l29.178" class="difflineminus">-              NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l29.179"></a><span id="l29.179" class="difflineplus">+              rv = card-&gt;GetPropertyAsAString(EXPORT_ATTRIBUTES_TABLE[i].abPropertyName, value);</span>
<a href="#l29.180"></a><span id="l29.180" class="difflineplus">+              if (NS_FAILED(rv))</span>
<a href="#l29.181"></a><span id="l29.181" class="difflineplus">+                value.Truncate();</span>
<a href="#l29.182"></a><span id="l29.182"> </span>
<a href="#l29.183"></a><span id="l29.183" class="difflineminus">-              if (!PL_strcmp(EXPORT_ATTRIBUTES_TABLE[i].abColName, kPreferMailFormatColumn)) {</span>
<a href="#l29.184"></a><span id="l29.184" class="difflineplus">+              if (!PL_strcmp(EXPORT_ATTRIBUTES_TABLE[i].abPropertyName, kPreferMailFormatProperty)) {</span>
<a href="#l29.185"></a><span id="l29.185">                 if (value.Equals(NS_LITERAL_STRING(&quot;html&quot;).get()))</span>
<a href="#l29.186"></a><span id="l29.186">                   value.AssignLiteral(&quot;true&quot;);</span>
<a href="#l29.187"></a><span id="l29.187">                 else if (value.Equals(NS_LITERAL_STRING(&quot;plaintext&quot;).get()))</span>
<a href="#l29.188"></a><span id="l29.188">                   value.AssignLiteral(&quot;false&quot;);</span>
<a href="#l29.189"></a><span id="l29.189">                 else</span>
<a href="#l29.190"></a><span id="l29.190">                   value.Truncate(); // unknown.</span>
<a href="#l29.191"></a><span id="l29.191">               }</span>
<a href="#l29.192"></a><span id="l29.192"> </span>
<a href="#l29.193"></a><span id="l29.193" class="difflineat">@@ -857,50 +855,46 @@ nsresult nsAbManager::AppendLDIFForMailL</span>
<a href="#l29.194"></a><span id="l29.194"> </span>
<a href="#l29.195"></a><span id="l29.195">   rv = AppendDNForCard(&quot;dn&quot;, aCard, aAttrMap, aResult);</span>
<a href="#l29.196"></a><span id="l29.196">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l29.197"></a><span id="l29.197"> </span>
<a href="#l29.198"></a><span id="l29.198">   aResult += MSG_LINEBREAK \</span>
<a href="#l29.199"></a><span id="l29.199">              &quot;objectclass: top&quot; MSG_LINEBREAK \</span>
<a href="#l29.200"></a><span id="l29.200">              &quot;objectclass: groupOfNames&quot; MSG_LINEBREAK;</span>
<a href="#l29.201"></a><span id="l29.201"> </span>
<a href="#l29.202"></a><span id="l29.202" class="difflineminus">-  rv = aCard-&gt;GetCardValue(kDisplayNameColumn, attrValue);</span>
<a href="#l29.203"></a><span id="l29.203" class="difflineplus">+  rv = aCard-&gt;GetDisplayName(attrValue);</span>
<a href="#l29.204"></a><span id="l29.204">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l29.205"></a><span id="l29.205"> </span>
<a href="#l29.206"></a><span id="l29.206">   nsCAutoString ldapAttributeName;</span>
<a href="#l29.207"></a><span id="l29.207"> </span>
<a href="#l29.208"></a><span id="l29.208" class="difflineminus">-  rv = aAttrMap-&gt;GetFirstAttribute(NS_LITERAL_CSTRING(kDisplayNameColumn),</span>
<a href="#l29.209"></a><span id="l29.209" class="difflineplus">+  rv = aAttrMap-&gt;GetFirstAttribute(NS_LITERAL_CSTRING(kDisplayNameProperty),</span>
<a href="#l29.210"></a><span id="l29.210">                                   ldapAttributeName);</span>
<a href="#l29.211"></a><span id="l29.211">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l29.212"></a><span id="l29.212"> </span>
<a href="#l29.213"></a><span id="l29.213">   rv = AppendProperty(ldapAttributeName.get(), attrValue.get(), aResult);</span>
<a href="#l29.214"></a><span id="l29.214">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l29.215"></a><span id="l29.215">   aResult += MSG_LINEBREAK;</span>
<a href="#l29.216"></a><span id="l29.216"> </span>
<a href="#l29.217"></a><span id="l29.217" class="difflineminus">-  rv = aAttrMap-&gt;GetFirstAttribute(NS_LITERAL_CSTRING(kNicknameColumn),</span>
<a href="#l29.218"></a><span id="l29.218" class="difflineplus">+  rv = aAttrMap-&gt;GetFirstAttribute(NS_LITERAL_CSTRING(kNicknameProperty),</span>
<a href="#l29.219"></a><span id="l29.219">                                   ldapAttributeName);</span>
<a href="#l29.220"></a><span id="l29.220">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l29.221"></a><span id="l29.221"> </span>
<a href="#l29.222"></a><span id="l29.222" class="difflineminus">-  rv = aCard-&gt;GetCardValue(kNicknameColumn, attrValue);</span>
<a href="#l29.223"></a><span id="l29.223" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l29.224"></a><span id="l29.224" class="difflineminus">-</span>
<a href="#l29.225"></a><span id="l29.225" class="difflineminus">-  if (!attrValue.IsEmpty()) {</span>
<a href="#l29.226"></a><span id="l29.226" class="difflineplus">+  rv = aCard-&gt;GetPropertyAsAString(kNicknameProperty, attrValue);</span>
<a href="#l29.227"></a><span id="l29.227" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; !attrValue.IsEmpty()) {</span>
<a href="#l29.228"></a><span id="l29.228">     rv = AppendProperty(ldapAttributeName.get(), attrValue.get(), aResult);</span>
<a href="#l29.229"></a><span id="l29.229">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l29.230"></a><span id="l29.230">     aResult += MSG_LINEBREAK;</span>
<a href="#l29.231"></a><span id="l29.231">   }</span>
<a href="#l29.232"></a><span id="l29.232"> </span>
<a href="#l29.233"></a><span id="l29.233" class="difflineminus">-  rv = aAttrMap-&gt;GetFirstAttribute(NS_LITERAL_CSTRING(kNotesColumn),</span>
<a href="#l29.234"></a><span id="l29.234" class="difflineplus">+  rv = aAttrMap-&gt;GetFirstAttribute(NS_LITERAL_CSTRING(kNotesProperty),</span>
<a href="#l29.235"></a><span id="l29.235">                                   ldapAttributeName);</span>
<a href="#l29.236"></a><span id="l29.236">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l29.237"></a><span id="l29.237"> </span>
<a href="#l29.238"></a><span id="l29.238" class="difflineminus">-  rv = aCard-&gt;GetCardValue(kNotesColumn, attrValue);</span>
<a href="#l29.239"></a><span id="l29.239" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l29.240"></a><span id="l29.240" class="difflineminus">-</span>
<a href="#l29.241"></a><span id="l29.241" class="difflineminus">-  if (!attrValue.IsEmpty()) {</span>
<a href="#l29.242"></a><span id="l29.242" class="difflineplus">+  rv = aCard-&gt;GetPropertyAsAString(kNotesProperty, attrValue);</span>
<a href="#l29.243"></a><span id="l29.243" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; !attrValue.IsEmpty()) {</span>
<a href="#l29.244"></a><span id="l29.244">     rv = AppendProperty(ldapAttributeName.get(), attrValue.get(), aResult);</span>
<a href="#l29.245"></a><span id="l29.245">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l29.246"></a><span id="l29.246">     aResult += MSG_LINEBREAK;</span>
<a href="#l29.247"></a><span id="l29.247">   }</span>
<a href="#l29.248"></a><span id="l29.248"> </span>
<a href="#l29.249"></a><span id="l29.249">   nsCOMPtr&lt;nsIRDFService&gt; rdfService = do_GetService(&quot;@mozilla.org/rdf/rdf-service;1&quot;, &amp;rv);</span>
<a href="#l29.250"></a><span id="l29.250">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l29.251"></a><span id="l29.251"> </span>
<a href="#l29.252"></a><span id="l29.252" class="difflineat">@@ -939,38 +933,38 @@ nsresult nsAbManager::AppendLDIFForMailL</span>
<a href="#l29.253"></a><span id="l29.253"> }</span>
<a href="#l29.254"></a><span id="l29.254"> </span>
<a href="#l29.255"></a><span id="l29.255"> nsresult nsAbManager::AppendDNForCard(const char *aProperty, nsIAbCard *aCard, nsIAbLDAPAttributeMap *aAttrMap, nsACString &amp;aResult)</span>
<a href="#l29.256"></a><span id="l29.256"> {</span>
<a href="#l29.257"></a><span id="l29.257">   nsString email;</span>
<a href="#l29.258"></a><span id="l29.258">   nsString displayName;</span>
<a href="#l29.259"></a><span id="l29.259">   nsCAutoString ldapAttributeName;</span>
<a href="#l29.260"></a><span id="l29.260"> </span>
<a href="#l29.261"></a><span id="l29.261" class="difflineminus">-  nsresult rv = aCard-&gt;GetCardValue(kPriEmailColumn, email);</span>
<a href="#l29.262"></a><span id="l29.262" class="difflineplus">+  nsresult rv = aCard-&gt;GetPrimaryEmail(email);</span>
<a href="#l29.263"></a><span id="l29.263">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l29.264"></a><span id="l29.264"> </span>
<a href="#l29.265"></a><span id="l29.265" class="difflineminus">-  rv = aCard-&gt;GetCardValue(kDisplayNameColumn, displayName);</span>
<a href="#l29.266"></a><span id="l29.266" class="difflineplus">+  rv = aCard-&gt;GetDisplayName(displayName);</span>
<a href="#l29.267"></a><span id="l29.267">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l29.268"></a><span id="l29.268"> </span>
<a href="#l29.269"></a><span id="l29.269">   nsString cnStr;</span>
<a href="#l29.270"></a><span id="l29.270"> </span>
<a href="#l29.271"></a><span id="l29.271" class="difflineminus">-  rv = aAttrMap-&gt;GetFirstAttribute(NS_LITERAL_CSTRING(kDisplayNameColumn),</span>
<a href="#l29.272"></a><span id="l29.272" class="difflineplus">+  rv = aAttrMap-&gt;GetFirstAttribute(NS_LITERAL_CSTRING(kDisplayNameProperty),</span>
<a href="#l29.273"></a><span id="l29.273">                                    ldapAttributeName);</span>
<a href="#l29.274"></a><span id="l29.274">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l29.275"></a><span id="l29.275"> </span>
<a href="#l29.276"></a><span id="l29.276">   if (!displayName.IsEmpty()) {</span>
<a href="#l29.277"></a><span id="l29.277">     cnStr += NS_ConvertUTF8toUTF16(ldapAttributeName).get();</span>
<a href="#l29.278"></a><span id="l29.278">     cnStr.AppendLiteral(&quot;=&quot;);</span>
<a href="#l29.279"></a><span id="l29.279">     cnStr.Append(displayName);</span>
<a href="#l29.280"></a><span id="l29.280">     if (!email.IsEmpty()) {</span>
<a href="#l29.281"></a><span id="l29.281">       cnStr.AppendLiteral(&quot;,&quot;);</span>
<a href="#l29.282"></a><span id="l29.282">     }</span>
<a href="#l29.283"></a><span id="l29.283">   }</span>
<a href="#l29.284"></a><span id="l29.284"> </span>
<a href="#l29.285"></a><span id="l29.285" class="difflineminus">-  rv = aAttrMap-&gt;GetFirstAttribute(NS_LITERAL_CSTRING(kPriEmailColumn),</span>
<a href="#l29.286"></a><span id="l29.286" class="difflineplus">+  rv = aAttrMap-&gt;GetFirstAttribute(NS_LITERAL_CSTRING(kPriEmailProperty),</span>
<a href="#l29.287"></a><span id="l29.287">                                    ldapAttributeName);</span>
<a href="#l29.288"></a><span id="l29.288">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l29.289"></a><span id="l29.289"> </span>
<a href="#l29.290"></a><span id="l29.290">   if (!email.IsEmpty()) {</span>
<a href="#l29.291"></a><span id="l29.291">     cnStr += NS_ConvertUTF8toUTF16(ldapAttributeName).get();</span>
<a href="#l29.292"></a><span id="l29.292">     cnStr.AppendLiteral(&quot;=&quot;);</span>
<a href="#l29.293"></a><span id="l29.293">     cnStr.Append(email);</span>
<a href="#l29.294"></a><span id="l29.294">   }</span>
<a href="#l29.295"></a><span id="l29.295" class="difflineat">@@ -1044,77 +1038,77 @@ char *getCString(VObject *vObj)</span>
<a href="#l29.296"></a><span id="l29.296">         return fakeCString(vObjectUStringZValue(vObj));</span>
<a href="#l29.297"></a><span id="l29.297">     if (VALUE_TYPE(vObj) == VCVT_STRINGZ)</span>
<a href="#l29.298"></a><span id="l29.298">         return PL_strdup(vObjectStringZValue(vObj));</span>
<a href="#l29.299"></a><span id="l29.299">     return NULL;</span>
<a href="#l29.300"></a><span id="l29.300"> }</span>
<a href="#l29.301"></a><span id="l29.301"> </span>
<a href="#l29.302"></a><span id="l29.302"> static void convertNameValue(VObject *vObj, nsIAbCard *aCard)</span>
<a href="#l29.303"></a><span id="l29.303"> {</span>
<a href="#l29.304"></a><span id="l29.304" class="difflineminus">-  const char *cardColName = NULL;</span>
<a href="#l29.305"></a><span id="l29.305" class="difflineplus">+  const char *cardPropName = NULL;</span>
<a href="#l29.306"></a><span id="l29.306"> </span>
<a href="#l29.307"></a><span id="l29.307">   // if the vCard property is not a root property then we need to determine its exact property.</span>
<a href="#l29.308"></a><span id="l29.308">   // a good example of this is VCTelephoneProp, this prop has four objects underneath it:</span>
<a href="#l29.309"></a><span id="l29.309">   // fax, work and home and cellular.</span>
<a href="#l29.310"></a><span id="l29.310">   if (PL_strcasecmp(VCCityProp, vObjectName(vObj)) == 0)</span>
<a href="#l29.311"></a><span id="l29.311" class="difflineminus">-      cardColName = kWorkCityColumn;</span>
<a href="#l29.312"></a><span id="l29.312" class="difflineplus">+      cardPropName = kWorkCityProperty;</span>
<a href="#l29.313"></a><span id="l29.313">   else if (PL_strcasecmp(VCTelephoneProp, vObjectName(vObj)) == 0)</span>
<a href="#l29.314"></a><span id="l29.314">   {</span>
<a href="#l29.315"></a><span id="l29.315">       if (isAPropertyOf(vObj, VCFaxProp))</span>
<a href="#l29.316"></a><span id="l29.316" class="difflineminus">-          cardColName = kFaxColumn;</span>
<a href="#l29.317"></a><span id="l29.317" class="difflineplus">+          cardPropName = kFaxProperty;</span>
<a href="#l29.318"></a><span id="l29.318">       else if (isAPropertyOf(vObj, VCWorkProp))</span>
<a href="#l29.319"></a><span id="l29.319" class="difflineminus">-          cardColName = kWorkPhoneColumn;</span>
<a href="#l29.320"></a><span id="l29.320" class="difflineplus">+          cardPropName = kWorkPhoneProperty;</span>
<a href="#l29.321"></a><span id="l29.321">       else if (isAPropertyOf(vObj, VCHomeProp))</span>
<a href="#l29.322"></a><span id="l29.322" class="difflineminus">-          cardColName = kHomePhoneColumn;</span>
<a href="#l29.323"></a><span id="l29.323" class="difflineplus">+          cardPropName = kHomePhoneProperty;</span>
<a href="#l29.324"></a><span id="l29.324">       else if (isAPropertyOf(vObj, VCCellularProp))</span>
<a href="#l29.325"></a><span id="l29.325" class="difflineminus">-          cardColName = kCellularColumn;</span>
<a href="#l29.326"></a><span id="l29.326" class="difflineplus">+          cardPropName = kCellularProperty;</span>
<a href="#l29.327"></a><span id="l29.327">       else if (isAPropertyOf(vObj, VCPagerProp))</span>
<a href="#l29.328"></a><span id="l29.328" class="difflineminus">-          cardColName = kPagerColumn;</span>
<a href="#l29.329"></a><span id="l29.329" class="difflineplus">+          cardPropName = kPagerProperty;</span>
<a href="#l29.330"></a><span id="l29.330">       else</span>
<a href="#l29.331"></a><span id="l29.331">           return;</span>
<a href="#l29.332"></a><span id="l29.332">   }</span>
<a href="#l29.333"></a><span id="l29.333">   else if (PL_strcasecmp(VCEmailAddressProp, vObjectName(vObj)) == 0)</span>
<a href="#l29.334"></a><span id="l29.334" class="difflineminus">-      cardColName = kPriEmailColumn;</span>
<a href="#l29.335"></a><span id="l29.335" class="difflineplus">+      cardPropName = kPriEmailProperty;</span>
<a href="#l29.336"></a><span id="l29.336">   else if (PL_strcasecmp(VCFamilyNameProp, vObjectName(vObj)) == 0)</span>
<a href="#l29.337"></a><span id="l29.337" class="difflineminus">-      cardColName = kLastNameColumn;</span>
<a href="#l29.338"></a><span id="l29.338" class="difflineplus">+      cardPropName = kLastNameProperty;</span>
<a href="#l29.339"></a><span id="l29.339">   else if (PL_strcasecmp(VCFullNameProp, vObjectName(vObj)) == 0)</span>
<a href="#l29.340"></a><span id="l29.340" class="difflineminus">-      cardColName = kDisplayNameColumn;</span>
<a href="#l29.341"></a><span id="l29.341" class="difflineplus">+      cardPropName = kDisplayNameProperty;</span>
<a href="#l29.342"></a><span id="l29.342">   else if (PL_strcasecmp(VCGivenNameProp, vObjectName(vObj)) == 0)</span>
<a href="#l29.343"></a><span id="l29.343" class="difflineminus">-      cardColName = kFirstNameColumn;</span>
<a href="#l29.344"></a><span id="l29.344" class="difflineplus">+      cardPropName = kFirstNameProperty;</span>
<a href="#l29.345"></a><span id="l29.345">   else if (PL_strcasecmp(VCOrgNameProp, vObjectName(vObj)) == 0)</span>
<a href="#l29.346"></a><span id="l29.346" class="difflineminus">-      cardColName = kCompanyColumn;</span>
<a href="#l29.347"></a><span id="l29.347" class="difflineplus">+      cardPropName = kCompanyProperty;</span>
<a href="#l29.348"></a><span id="l29.348">   else if (PL_strcasecmp(VCOrgUnitProp, vObjectName(vObj)) == 0)</span>
<a href="#l29.349"></a><span id="l29.349" class="difflineminus">-      cardColName = kDepartmentColumn;</span>
<a href="#l29.350"></a><span id="l29.350" class="difflineplus">+      cardPropName = kDepartmentProperty;</span>
<a href="#l29.351"></a><span id="l29.351">   else if (PL_strcasecmp(VCPostalCodeProp, vObjectName(vObj)) == 0)</span>
<a href="#l29.352"></a><span id="l29.352" class="difflineminus">-      cardColName = kWorkZipCodeColumn;</span>
<a href="#l29.353"></a><span id="l29.353" class="difflineplus">+      cardPropName = kWorkZipCodeProperty;</span>
<a href="#l29.354"></a><span id="l29.354">   else if (PL_strcasecmp(VCRegionProp, vObjectName(vObj)) == 0)</span>
<a href="#l29.355"></a><span id="l29.355" class="difflineminus">-      cardColName = kWorkStateColumn;</span>
<a href="#l29.356"></a><span id="l29.356" class="difflineplus">+      cardPropName = kWorkStateProperty;</span>
<a href="#l29.357"></a><span id="l29.357">   else if (PL_strcasecmp(VCStreetAddressProp, vObjectName(vObj)) == 0)</span>
<a href="#l29.358"></a><span id="l29.358" class="difflineminus">-      cardColName = kWorkAddressColumn;</span>
<a href="#l29.359"></a><span id="l29.359" class="difflineplus">+      cardPropName = kWorkAddressProperty;</span>
<a href="#l29.360"></a><span id="l29.360">   else if (PL_strcasecmp(VCPostalBoxProp, vObjectName(vObj)) == 0)</span>
<a href="#l29.361"></a><span id="l29.361" class="difflineminus">-      cardColName = kWorkAddress2Column;</span>
<a href="#l29.362"></a><span id="l29.362" class="difflineplus">+      cardPropName = kWorkAddress2Property;</span>
<a href="#l29.363"></a><span id="l29.363">   else if (PL_strcasecmp(VCCountryNameProp, vObjectName(vObj)) == 0)</span>
<a href="#l29.364"></a><span id="l29.364" class="difflineminus">-      cardColName = kWorkCountryColumn;</span>
<a href="#l29.365"></a><span id="l29.365" class="difflineplus">+      cardPropName = kWorkCountryProperty;</span>
<a href="#l29.366"></a><span id="l29.366">   else if (PL_strcasecmp(VCTitleProp, vObjectName(vObj)) == 0)</span>
<a href="#l29.367"></a><span id="l29.367" class="difflineminus">-      cardColName = kJobTitleColumn;</span>
<a href="#l29.368"></a><span id="l29.368" class="difflineplus">+      cardPropName = kJobTitleProperty;</span>
<a href="#l29.369"></a><span id="l29.369">   else if (PL_strcasecmp(VCUseHTML, vObjectName(vObj)) == 0)</span>
<a href="#l29.370"></a><span id="l29.370" class="difflineminus">-      cardColName = kPreferMailFormatColumn;</span>
<a href="#l29.371"></a><span id="l29.371" class="difflineplus">+      cardPropName = kPreferMailFormatProperty;</span>
<a href="#l29.372"></a><span id="l29.372">   else if (PL_strcasecmp(VCNoteProp, vObjectName(vObj)) == 0)</span>
<a href="#l29.373"></a><span id="l29.373" class="difflineminus">-      cardColName = kNotesColumn;</span>
<a href="#l29.374"></a><span id="l29.374" class="difflineplus">+      cardPropName = kNotesProperty;</span>
<a href="#l29.375"></a><span id="l29.375">   else if (PL_strcasecmp(VCURLProp, vObjectName(vObj)) == 0)</span>
<a href="#l29.376"></a><span id="l29.376" class="difflineminus">-      cardColName = kWebPage1Column;</span>
<a href="#l29.377"></a><span id="l29.377" class="difflineplus">+      cardPropName = kWorkWebPageProperty;</span>
<a href="#l29.378"></a><span id="l29.378">   else</span>
<a href="#l29.379"></a><span id="l29.379">       return;</span>
<a href="#l29.380"></a><span id="l29.380"> </span>
<a href="#l29.381"></a><span id="l29.381">   if (!VALUE_TYPE(vObj))</span>
<a href="#l29.382"></a><span id="l29.382">       return;</span>
<a href="#l29.383"></a><span id="l29.383"> </span>
<a href="#l29.384"></a><span id="l29.384" class="difflineminus">-  char *cardColValue = getCString(vObj);</span>
<a href="#l29.385"></a><span id="l29.385" class="difflineminus">-  aCard-&gt;SetCardValue(cardColName, NS_ConvertUTF8toUTF16(cardColValue));</span>
<a href="#l29.386"></a><span id="l29.386" class="difflineminus">-  PR_FREEIF(cardColValue);</span>
<a href="#l29.387"></a><span id="l29.387" class="difflineplus">+  char *cardPropValue = getCString(vObj);</span>
<a href="#l29.388"></a><span id="l29.388" class="difflineplus">+  aCard-&gt;SetPropertyAsAUTF8String(cardPropName, nsDependentCString(cardPropValue));</span>
<a href="#l29.389"></a><span id="l29.389" class="difflineplus">+  PR_FREEIF(cardPropValue);</span>
<a href="#l29.390"></a><span id="l29.390">   return;</span>
<a href="#l29.391"></a><span id="l29.391"> }</span>
<a href="#l29.392"></a><span id="l29.392"> </span>
<a href="#l29.393"></a><span id="l29.393"> static void convertFromVObject(VObject *vObj, nsIAbCard *aCard)</span>
<a href="#l29.394"></a><span id="l29.394"> {</span>
<a href="#l29.395"></a><span id="l29.395">     if (vObj)</span>
<a href="#l29.396"></a><span id="l29.396">     {</span>
<a href="#l29.397"></a><span id="l29.397">         VObjectIterator t;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbOSXCard.mm</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbOSXCard.mm</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -69,84 +69,85 @@ GetPropertType(ABRecord *aCard, NSString</span>
<a href="#l30.4"></a><span id="l30.4">     propertyType = [ABPerson typeOfProperty:aProperty];</span>
<a href="#l30.5"></a><span id="l30.5">   else if ([aCard isKindOfClass:[ABGroup class]])</span>
<a href="#l30.6"></a><span id="l30.6">     propertyType = [ABGroup typeOfProperty:aProperty];</span>
<a href="#l30.7"></a><span id="l30.7">   return propertyType;</span>
<a href="#l30.8"></a><span id="l30.8"> }</span>
<a href="#l30.9"></a><span id="l30.9"> #endif</span>
<a href="#l30.10"></a><span id="l30.10"> </span>
<a href="#l30.11"></a><span id="l30.11"> static void</span>
<a href="#l30.12"></a><span id="l30.12" class="difflineminus">-SetStringProperty(nsAbOSXCard *aCard, nsString &amp;aValue, nsString &amp;aMember,</span>
<a href="#l30.13"></a><span id="l30.13" class="difflineminus">-                  const char *aMemberName, PRBool aNotify,</span>
<a href="#l30.14"></a><span id="l30.14" class="difflineminus">-                  nsIAbManager *aAbManager)</span>
<a href="#l30.15"></a><span id="l30.15" class="difflineplus">+SetStringProperty(nsAbOSXCard *aCard, nsString &amp;aValue, const char *aMemberName,</span>
<a href="#l30.16"></a><span id="l30.16" class="difflineplus">+                  PRBool aNotify, nsIAbManager *aAbManager)</span>
<a href="#l30.17"></a><span id="l30.17"> {</span>
<a href="#l30.18"></a><span id="l30.18" class="difflineplus">+  nsString oldValue;</span>
<a href="#l30.19"></a><span id="l30.19" class="difflineplus">+  nsresult rv = aCard-&gt;GetPropertyAsAString(aMemberName, oldValue);</span>
<a href="#l30.20"></a><span id="l30.20" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l30.21"></a><span id="l30.21" class="difflineplus">+    oldValue.Truncate();</span>
<a href="#l30.22"></a><span id="l30.22" class="difflineplus">+</span>
<a href="#l30.23"></a><span id="l30.23">   if (!aNotify) {</span>
<a href="#l30.24"></a><span id="l30.24" class="difflineminus">-    aMember = aValue;</span>
<a href="#l30.25"></a><span id="l30.25" class="difflineplus">+    aCard-&gt;SetPropertyAsAString(aMemberName, aValue);</span>
<a href="#l30.26"></a><span id="l30.26">   }</span>
<a href="#l30.27"></a><span id="l30.27" class="difflineminus">-  else if (!aMember.Equals(aValue)) {</span>
<a href="#l30.28"></a><span id="l30.28" class="difflineminus">-    nsString oldValue(aMember);</span>
<a href="#l30.29"></a><span id="l30.29" class="difflineminus">-    aMember = aValue;</span>
<a href="#l30.30"></a><span id="l30.30" class="difflineplus">+  else if (!oldValue.Equals(aValue)) {</span>
<a href="#l30.31"></a><span id="l30.31" class="difflineplus">+    aCard-&gt;SetPropertyAsAString(aMemberName, aValue);</span>
<a href="#l30.32"></a><span id="l30.32">     </span>
<a href="#l30.33"></a><span id="l30.33">     nsISupports *supports = NS_ISUPPORTS_CAST(nsRDFResource*, aCard);</span>
<a href="#l30.34"></a><span id="l30.34">     aAbManager-&gt;NotifyItemPropertyChanged(supports, aMemberName,</span>
<a href="#l30.35"></a><span id="l30.35" class="difflineminus">-                                        oldValue.get(), aMember.get());</span>
<a href="#l30.36"></a><span id="l30.36" class="difflineplus">+                                          oldValue.get(), aValue.get());</span>
<a href="#l30.37"></a><span id="l30.37">   }</span>
<a href="#l30.38"></a><span id="l30.38"> }</span>
<a href="#l30.39"></a><span id="l30.39"> </span>
<a href="#l30.40"></a><span id="l30.40"> static void</span>
<a href="#l30.41"></a><span id="l30.41" class="difflineminus">-SetStringProperty(nsAbOSXCard *aCard, NSString *aValue, nsString &amp;aMember,</span>
<a href="#l30.42"></a><span id="l30.42" class="difflineminus">-                  const char *aMemberName, PRBool aNotify,</span>
<a href="#l30.43"></a><span id="l30.43" class="difflineminus">-                  nsIAbManager *aAbManager)</span>
<a href="#l30.44"></a><span id="l30.44" class="difflineplus">+SetStringProperty(nsAbOSXCard *aCard, NSString *aValue, const char *aMemberName,</span>
<a href="#l30.45"></a><span id="l30.45" class="difflineplus">+                  PRBool aNotify, nsIAbManager *aAbManager)</span>
<a href="#l30.46"></a><span id="l30.46"> {</span>
<a href="#l30.47"></a><span id="l30.47">   nsAutoString value;</span>
<a href="#l30.48"></a><span id="l30.48">   if (aValue)</span>
<a href="#l30.49"></a><span id="l30.49">     AppendToString(aValue, value);</span>
<a href="#l30.50"></a><span id="l30.50"> </span>
<a href="#l30.51"></a><span id="l30.51" class="difflineminus">-  SetStringProperty(aCard, value, aMember, aMemberName, aNotify, aAbManager);</span>
<a href="#l30.52"></a><span id="l30.52" class="difflineplus">+  SetStringProperty(aCard, value, aMemberName, aNotify, aAbManager);</span>
<a href="#l30.53"></a><span id="l30.53"> }</span>
<a href="#l30.54"></a><span id="l30.54"> </span>
<a href="#l30.55"></a><span id="l30.55"> static void</span>
<a href="#l30.56"></a><span id="l30.56"> MapStringProperty(nsAbOSXCard *aCard, ABRecord *aOSXCard, NSString *aProperty,</span>
<a href="#l30.57"></a><span id="l30.57" class="difflineminus">-                  nsString &amp;aMember, const char *aMemberName, PRBool aNotify,</span>
<a href="#l30.58"></a><span id="l30.58" class="difflineplus">+                  const char *aMemberName, PRBool aNotify,</span>
<a href="#l30.59"></a><span id="l30.59">                   nsIAbManager *aAbManager)</span>
<a href="#l30.60"></a><span id="l30.60"> {</span>
<a href="#l30.61"></a><span id="l30.61">   NS_ASSERTION(aProperty, &quot;This is bad! You asked for an unresolved symbol.&quot;);</span>
<a href="#l30.62"></a><span id="l30.62">   NS_ASSERTION(GetPropertType(aOSXCard, aProperty) == kABStringProperty,</span>
<a href="#l30.63"></a><span id="l30.63">                &quot;Wrong type!&quot;);</span>
<a href="#l30.64"></a><span id="l30.64">   </span>
<a href="#l30.65"></a><span id="l30.65" class="difflineminus">-  SetStringProperty(aCard, [aOSXCard valueForProperty:aProperty], aMember,</span>
<a href="#l30.66"></a><span id="l30.66" class="difflineminus">-                    aMemberName, aNotify, aAbManager);</span>
<a href="#l30.67"></a><span id="l30.67" class="difflineplus">+  SetStringProperty(aCard, [aOSXCard valueForProperty:aProperty], aMemberName,</span>
<a href="#l30.68"></a><span id="l30.68" class="difflineplus">+                    aNotify, aAbManager);</span>
<a href="#l30.69"></a><span id="l30.69"> }</span>
<a href="#l30.70"></a><span id="l30.70"> </span>
<a href="#l30.71"></a><span id="l30.71"> static ABMutableMultiValue*</span>
<a href="#l30.72"></a><span id="l30.72"> GetMultiValue(ABRecord *aCard, NSString *aProperty)</span>
<a href="#l30.73"></a><span id="l30.73"> {</span>
<a href="#l30.74"></a><span id="l30.74">   NS_ASSERTION(aProperty, &quot;This is bad! You asked for an unresolved symbol.&quot;);</span>
<a href="#l30.75"></a><span id="l30.75">   NS_ASSERTION(GetPropertType(aCard, aProperty) &amp; kABMultiValueMask,</span>
<a href="#l30.76"></a><span id="l30.76">                &quot;Wrong type!&quot;);</span>
<a href="#l30.77"></a><span id="l30.77">   </span>
<a href="#l30.78"></a><span id="l30.78">   return [aCard valueForProperty:aProperty];</span>
<a href="#l30.79"></a><span id="l30.79"> }</span>
<a href="#l30.80"></a><span id="l30.80"> </span>
<a href="#l30.81"></a><span id="l30.81"> static void</span>
<a href="#l30.82"></a><span id="l30.82" class="difflineminus">-MapDate(nsAbOSXCard *aCard, NSDate *aDate, nsString &amp;aYear,</span>
<a href="#l30.83"></a><span id="l30.83" class="difflineminus">-        const char *aYearName, nsString &amp;aMonth, const char *aMonthName,</span>
<a href="#l30.84"></a><span id="l30.84" class="difflineminus">-        nsString &amp;aDay, const char *aDayName, PRBool aNotify,</span>
<a href="#l30.85"></a><span id="l30.85" class="difflineplus">+MapDate(nsAbOSXCard *aCard, NSDate *aDate, const char *aYearPropName,</span>
<a href="#l30.86"></a><span id="l30.86" class="difflineplus">+        const char *aMonthPropName, const char *aDayPropName, PRBool aNotify,</span>
<a href="#l30.87"></a><span id="l30.87">         nsIAbManager *aAbManager)</span>
<a href="#l30.88"></a><span id="l30.88"> {</span>
<a href="#l30.89"></a><span id="l30.89">   // XXX Should we pass a format and timezone?</span>
<a href="#l30.90"></a><span id="l30.90">   NSCalendarDate *date = [aDate dateWithCalendarFormat:nil timeZone:nil];</span>
<a href="#l30.91"></a><span id="l30.91">   </span>
<a href="#l30.92"></a><span id="l30.92">   nsAutoString value;</span>
<a href="#l30.93"></a><span id="l30.93">   value.AppendInt([date yearOfCommonEra]);</span>
<a href="#l30.94"></a><span id="l30.94" class="difflineminus">-  SetStringProperty(aCard, value, aYear, aYearName, aNotify, aAbManager);</span>
<a href="#l30.95"></a><span id="l30.95" class="difflineplus">+  SetStringProperty(aCard, value, aYearPropName, aNotify, aAbManager);</span>
<a href="#l30.96"></a><span id="l30.96">   value.AppendInt([date monthOfYear]);</span>
<a href="#l30.97"></a><span id="l30.97" class="difflineminus">-  SetStringProperty(aCard, value, aMonth, aMonthName, aNotify, aAbManager);</span>
<a href="#l30.98"></a><span id="l30.98" class="difflineplus">+  SetStringProperty(aCard, value, aMonthPropName, aNotify, aAbManager);</span>
<a href="#l30.99"></a><span id="l30.99">   value.AppendInt([date dayOfWeek]);</span>
<a href="#l30.100"></a><span id="l30.100" class="difflineminus">-  SetStringProperty(aCard, value, aDay, aDayName, aNotify, aAbManager);</span>
<a href="#l30.101"></a><span id="l30.101" class="difflineplus">+  SetStringProperty(aCard, value, aDayPropName, aNotify, aAbManager);</span>
<a href="#l30.102"></a><span id="l30.102"> }</span>
<a href="#l30.103"></a><span id="l30.103"> </span>
<a href="#l30.104"></a><span id="l30.104"> static PRBool</span>
<a href="#l30.105"></a><span id="l30.105"> MapMultiValue(nsAbOSXCard *aCard, ABRecord *aOSXCard,</span>
<a href="#l30.106"></a><span id="l30.106">               const nsAbOSXPropertyMap &amp;aMap, PRBool aNotify,</span>
<a href="#l30.107"></a><span id="l30.107">               nsIAbManager *aAbManager)</span>
<a href="#l30.108"></a><span id="l30.108"> {</span>
<a href="#l30.109"></a><span id="l30.109">   ABMultiValue *value = GetMultiValue(aOSXCard, aMap.mOSXProperty);</span>
<a href="#l30.110"></a><span id="l30.110" class="difflineat">@@ -154,18 +155,18 @@ MapMultiValue(nsAbOSXCard *aCard, ABReco</span>
<a href="#l30.111"></a><span id="l30.111">     unsigned int j;</span>
<a href="#l30.112"></a><span id="l30.112">     unsigned int count = [value count];</span>
<a href="#l30.113"></a><span id="l30.113">     for (j = 0; j &lt; count; ++j) {</span>
<a href="#l30.114"></a><span id="l30.114">       if ([[value labelAtIndex:j] isEqualToString:aMap.mOSXLabel]) {</span>
<a href="#l30.115"></a><span id="l30.115">         NSString *stringValue = (aMap.mOSXKey)</span>
<a href="#l30.116"></a><span id="l30.116">           ? [[value valueAtIndex:j] objectForKey:aMap.mOSXKey]</span>
<a href="#l30.117"></a><span id="l30.117">           : [value valueAtIndex:j];</span>
<a href="#l30.118"></a><span id="l30.118">         </span>
<a href="#l30.119"></a><span id="l30.119" class="difflineminus">-        SetStringProperty(aCard, stringValue, aCard-&gt;*(aMap.mProperty),</span>
<a href="#l30.120"></a><span id="l30.120" class="difflineminus">-                          aMap.mPropertyName, aNotify, aAbManager);</span>
<a href="#l30.121"></a><span id="l30.121" class="difflineplus">+        SetStringProperty(aCard, stringValue, aMap.mPropertyName, aNotify,</span>
<a href="#l30.122"></a><span id="l30.122" class="difflineplus">+                          aAbManager);</span>
<a href="#l30.123"></a><span id="l30.123">         </span>
<a href="#l30.124"></a><span id="l30.124">         return PR_TRUE;</span>
<a href="#l30.125"></a><span id="l30.125">       }</span>
<a href="#l30.126"></a><span id="l30.126">     }</span>
<a href="#l30.127"></a><span id="l30.127">   }</span>
<a href="#l30.128"></a><span id="l30.128">   </span>
<a href="#l30.129"></a><span id="l30.129">   return PR_FALSE;</span>
<a href="#l30.130"></a><span id="l30.130"> }</span>
<a href="#l30.131"></a><span id="l30.131" class="difflineat">@@ -198,20 +199,20 @@ nsAbOSXCard::Update(PRBool aNotify)</span>
<a href="#l30.132"></a><span id="l30.132">     abManager = do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l30.133"></a><span id="l30.133">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.134"></a><span id="l30.134">   }</span>
<a href="#l30.135"></a><span id="l30.135"> </span>
<a href="#l30.136"></a><span id="l30.136">   if ([card isKindOfClass:[ABGroup class]]) {</span>
<a href="#l30.137"></a><span id="l30.137">     m_IsMailList = PR_TRUE;</span>
<a href="#l30.138"></a><span id="l30.138">     m_MailListURI.AssignLiteral(NS_ABOSXDIRECTORY_URI_PREFIX);</span>
<a href="#l30.139"></a><span id="l30.139">     m_MailListURI.Append(uid);</span>
<a href="#l30.140"></a><span id="l30.140" class="difflineminus">-    MapStringProperty(this, card, kABGroupNameProperty, m_DisplayName,</span>
<a href="#l30.141"></a><span id="l30.141" class="difflineminus">-                      &quot;DisplayName&quot;, aNotify, abManager);</span>
<a href="#l30.142"></a><span id="l30.142" class="difflineminus">-    MapStringProperty(this, card, kABGroupNameProperty, m_LastName,</span>
<a href="#l30.143"></a><span id="l30.143" class="difflineminus">-                      &quot;LastName&quot;, aNotify, abManager);</span>
<a href="#l30.144"></a><span id="l30.144" class="difflineplus">+    MapStringProperty(this, card, kABGroupNameProperty, &quot;DisplayName&quot;, aNotify,</span>
<a href="#l30.145"></a><span id="l30.145" class="difflineplus">+                      abManager);</span>
<a href="#l30.146"></a><span id="l30.146" class="difflineplus">+    MapStringProperty(this, card, kABGroupNameProperty, &quot;LastName&quot;, aNotify,</span>
<a href="#l30.147"></a><span id="l30.147" class="difflineplus">+                      abManager);</span>
<a href="#l30.148"></a><span id="l30.148"> </span>
<a href="#l30.149"></a><span id="l30.149">     return NS_OK;</span>
<a href="#l30.150"></a><span id="l30.150">   }</span>
<a href="#l30.151"></a><span id="l30.151">   </span>
<a href="#l30.152"></a><span id="l30.152">   PRBool foundHome = PR_FALSE, foundWork = PR_FALSE;</span>
<a href="#l30.153"></a><span id="l30.153">   </span>
<a href="#l30.154"></a><span id="l30.154">   PRUint32 i;</span>
<a href="#l30.155"></a><span id="l30.155">   for (i = 0; i &lt; nsAbOSXUtils::kPropertyMapSize; ++i) {</span>
<a href="#l30.156"></a><span id="l30.156" class="difflineat">@@ -225,49 +226,56 @@ nsAbOSXCard::Update(PRBool aNotify)</span>
<a href="#l30.157"></a><span id="l30.157">         if (propertyMap.mOSXLabel == kABAddressHomeLabel) </span>
<a href="#l30.158"></a><span id="l30.158">           foundHome = PR_TRUE;</span>
<a href="#l30.159"></a><span id="l30.159">         else</span>
<a href="#l30.160"></a><span id="l30.160">           foundWork = PR_TRUE;</span>
<a href="#l30.161"></a><span id="l30.161">       }</span>
<a href="#l30.162"></a><span id="l30.162">     }</span>
<a href="#l30.163"></a><span id="l30.163">     else {</span>
<a href="#l30.164"></a><span id="l30.164">       MapStringProperty(this, card, propertyMap.mOSXProperty,</span>
<a href="#l30.165"></a><span id="l30.165" class="difflineminus">-                        this-&gt;*(propertyMap.mProperty),</span>
<a href="#l30.166"></a><span id="l30.166">                         propertyMap.mPropertyName, aNotify, abManager);</span>
<a href="#l30.167"></a><span id="l30.167">     }</span>
<a href="#l30.168"></a><span id="l30.168">   }</span>
<a href="#l30.169"></a><span id="l30.169">   </span>
<a href="#l30.170"></a><span id="l30.170">   int flags = 0;</span>
<a href="#l30.171"></a><span id="l30.171">   if (kABPersonFlags)</span>
<a href="#l30.172"></a><span id="l30.172">     flags = [[card valueForProperty:kABPersonFlags] intValue];</span>
<a href="#l30.173"></a><span id="l30.173">   </span>
<a href="#l30.174"></a><span id="l30.174"> #define SET_STRING(_value, _name, _notify, _session) \</span>
<a href="#l30.175"></a><span id="l30.175" class="difflineminus">-  SetStringProperty(this, _value, m_##_name, #_name, _notify, _session)</span>
<a href="#l30.176"></a><span id="l30.176" class="difflineplus">+  SetStringProperty(this, _value, #_name, _notify, _session)</span>
<a href="#l30.177"></a><span id="l30.177">     </span>
<a href="#l30.178"></a><span id="l30.178">     // If kABShowAsCompany is set we use the company name as display name.</span>
<a href="#l30.179"></a><span id="l30.179">     if (kABPersonFlags &amp;&amp; (flags &amp; kABShowAsCompany)) {</span>
<a href="#l30.180"></a><span id="l30.180" class="difflineminus">-      SET_STRING(m_Company, DisplayName, aNotify, abManager);</span>
<a href="#l30.181"></a><span id="l30.181" class="difflineplus">+      nsString company;</span>
<a href="#l30.182"></a><span id="l30.182" class="difflineplus">+      nsresult rv = GetPropertyAsAString(kCompanyProperty, company);</span>
<a href="#l30.183"></a><span id="l30.183" class="difflineplus">+      if (NS_FAILED(rv))</span>
<a href="#l30.184"></a><span id="l30.184" class="difflineplus">+        company.Truncate();</span>
<a href="#l30.185"></a><span id="l30.185" class="difflineplus">+      SET_STRING(company, DisplayName, aNotify, abManager);</span>
<a href="#l30.186"></a><span id="l30.186">     }</span>
<a href="#l30.187"></a><span id="l30.187">   else {</span>
<a href="#l30.188"></a><span id="l30.188">     // Use the order used in the OS X address book to set DisplayName.</span>
<a href="#l30.189"></a><span id="l30.189">     int order = kABPersonFlags &amp;&amp; (flags &amp; kABNameOrderingMask);</span>
<a href="#l30.190"></a><span id="l30.190">     if (kABPersonFlags &amp;&amp; (order == kABDefaultNameOrdering)) {</span>
<a href="#l30.191"></a><span id="l30.191">       order = [addressBook defaultNameOrdering];</span>
<a href="#l30.192"></a><span id="l30.192">     }</span>
<a href="#l30.193"></a><span id="l30.193">     </span>
<a href="#l30.194"></a><span id="l30.194" class="difflineminus">-    nsAutoString displayName;</span>
<a href="#l30.195"></a><span id="l30.195" class="difflineplus">+    nsAutoString displayName, tempName;</span>
<a href="#l30.196"></a><span id="l30.196">     if (kABPersonFlags &amp;&amp; (order == kABFirstNameFirst)) {</span>
<a href="#l30.197"></a><span id="l30.197" class="difflineminus">-      displayName.Append(m_FirstName);</span>
<a href="#l30.198"></a><span id="l30.198" class="difflineplus">+      GetFirstName(tempName);</span>
<a href="#l30.199"></a><span id="l30.199" class="difflineplus">+      displayName.Append(tempName);</span>
<a href="#l30.200"></a><span id="l30.200">       displayName.Append(' ');</span>
<a href="#l30.201"></a><span id="l30.201" class="difflineminus">-      displayName.Append(m_LastName);</span>
<a href="#l30.202"></a><span id="l30.202" class="difflineplus">+      GetLastName(tempName);</span>
<a href="#l30.203"></a><span id="l30.203" class="difflineplus">+      displayName.Append(tempName);</span>
<a href="#l30.204"></a><span id="l30.204">     }</span>
<a href="#l30.205"></a><span id="l30.205">     else {</span>
<a href="#l30.206"></a><span id="l30.206" class="difflineminus">-      displayName.Append(m_LastName);</span>
<a href="#l30.207"></a><span id="l30.207" class="difflineplus">+      GetLastName(tempName);</span>
<a href="#l30.208"></a><span id="l30.208" class="difflineplus">+      displayName.Append(tempName);</span>
<a href="#l30.209"></a><span id="l30.209">       displayName.Append(' ');</span>
<a href="#l30.210"></a><span id="l30.210" class="difflineminus">-      displayName.Append(m_FirstName);</span>
<a href="#l30.211"></a><span id="l30.211" class="difflineplus">+      GetFirstName(tempName);</span>
<a href="#l30.212"></a><span id="l30.212" class="difflineplus">+      displayName.Append(tempName);</span>
<a href="#l30.213"></a><span id="l30.213">     }</span>
<a href="#l30.214"></a><span id="l30.214">     SET_STRING(displayName, DisplayName, aNotify, abManager);</span>
<a href="#l30.215"></a><span id="l30.215">   }</span>
<a href="#l30.216"></a><span id="l30.216">   </span>
<a href="#l30.217"></a><span id="l30.217">   ABMultiValue *value = GetMultiValue(card, kABEmailProperty);</span>
<a href="#l30.218"></a><span id="l30.218">   if (value) {</span>
<a href="#l30.219"></a><span id="l30.219">     unsigned int count = [value count];</span>
<a href="#l30.220"></a><span id="l30.220">     if (count &gt; 0) {</span>
<a href="#l30.221"></a><span id="l30.221" class="difflineat">@@ -322,18 +330,18 @@ nsAbOSXCard::Update(PRBool aNotify)</span>
<a href="#l30.222"></a><span id="l30.222">       </span>
<a href="#l30.223"></a><span id="l30.223">       if (j &lt; count)</span>
<a href="#l30.224"></a><span id="l30.224">         SET_STRING([value valueAtIndex:j], AimScreenName, aNotify,</span>
<a href="#l30.225"></a><span id="l30.225">                    abManager);</span>
<a href="#l30.226"></a><span id="l30.226">     }</span>
<a href="#l30.227"></a><span id="l30.227">   }</span>
<a href="#l30.228"></a><span id="l30.228">   </span>
<a href="#l30.229"></a><span id="l30.229"> #define MAP_DATE(_date, _name, _notify, _session) \</span>
<a href="#l30.230"></a><span id="l30.230" class="difflineminus">-  MapDate(this, _date, m_##_name##Year, #_name&quot;Year&quot;, m_##_name##Month, \</span>
<a href="#l30.231"></a><span id="l30.231" class="difflineminus">-#_name&quot;Month&quot;, m_##_name##Day, #_name&quot;Day&quot;, _notify, _session)</span>
<a href="#l30.232"></a><span id="l30.232" class="difflineplus">+  MapDate(this, _date, #_name&quot;Year&quot;, #_name&quot;Month&quot;, #_name&quot;Day&quot;, _notify, \</span>
<a href="#l30.233"></a><span id="l30.233" class="difflineplus">+  _session)</span>
<a href="#l30.234"></a><span id="l30.234">     </span>
<a href="#l30.235"></a><span id="l30.235">     NSDate *date = [card valueForProperty:kABBirthdayProperty];</span>
<a href="#l30.236"></a><span id="l30.236">   if (date)</span>
<a href="#l30.237"></a><span id="l30.237">     MAP_DATE(date, Birth, aNotify, abManager);</span>
<a href="#l30.238"></a><span id="l30.238">   </span>
<a href="#l30.239"></a><span id="l30.239">   if (kABOtherDatesProperty) {</span>
<a href="#l30.240"></a><span id="l30.240">     value = GetMultiValue(card, kABOtherDatesProperty);</span>
<a href="#l30.241"></a><span id="l30.241">     if (value) {</span>
<a href="#l30.242"></a><span id="l30.242" class="difflineat">@@ -350,13 +358,14 @@ nsAbOSXCard::Update(PRBool aNotify)</span>
<a href="#l30.243"></a><span id="l30.243">       }</span>
<a href="#l30.244"></a><span id="l30.244">     }</span>
<a href="#l30.245"></a><span id="l30.245">   }</span>
<a href="#l30.246"></a><span id="l30.246"> #undef MAP_DATE</span>
<a href="#l30.247"></a><span id="l30.247"> #undef SET_STRING</span>
<a href="#l30.248"></a><span id="l30.248">   </span>
<a href="#l30.249"></a><span id="l30.249">   date = [card valueForProperty:kABModificationDateProperty];</span>
<a href="#l30.250"></a><span id="l30.250">   if (date) </span>
<a href="#l30.251"></a><span id="l30.251" class="difflineminus">-    m_LastModDate = PRUint32([date timeIntervalSince1970]);</span>
<a href="#l30.252"></a><span id="l30.252" class="difflineplus">+    SetPropertyAsUint32(&quot;LastModifiedDate&quot;,</span>
<a href="#l30.253"></a><span id="l30.253" class="difflineplus">+                        PRUint32([date timeIntervalSince1970]));</span>
<a href="#l30.254"></a><span id="l30.254">     // XXX No way to notify about this?</span>
<a href="#l30.255"></a><span id="l30.255">   </span>
<a href="#l30.256"></a><span id="l30.256">   return NS_OK;</span>
<a href="#l30.257"></a><span id="l30.257"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbOSXUtils.h</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbOSXUtils.h</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -52,17 +52,16 @@ void AppendToString(const NSString *aStr</span>
<a href="#l31.4"></a><span id="l31.4"> void AssignToString(const NSString *aString, nsString &amp;aResult);</span>
<a href="#l31.5"></a><span id="l31.5"> void AppendToCString(const NSString *aString, nsCString &amp;aResult);</span>
<a href="#l31.6"></a><span id="l31.6"> </span>
<a href="#l31.7"></a><span id="l31.7"> struct nsAbOSXPropertyMap</span>
<a href="#l31.8"></a><span id="l31.8"> {</span>
<a href="#l31.9"></a><span id="l31.9">     NSString * const mOSXProperty;</span>
<a href="#l31.10"></a><span id="l31.10">     NSString * const mOSXLabel;</span>
<a href="#l31.11"></a><span id="l31.11">     NSString * const mOSXKey;</span>
<a href="#l31.12"></a><span id="l31.12" class="difflineminus">-    nsString nsAbCardProperty::*mProperty;</span>
<a href="#l31.13"></a><span id="l31.13">     const char *mPropertyName;</span>
<a href="#l31.14"></a><span id="l31.14"> };</span>
<a href="#l31.15"></a><span id="l31.15"> </span>
<a href="#l31.16"></a><span id="l31.16"> class nsAbOSXUtils</span>
<a href="#l31.17"></a><span id="l31.17"> {</span>
<a href="#l31.18"></a><span id="l31.18"> public:</span>
<a href="#l31.19"></a><span id="l31.19">     static const nsAbOSXPropertyMap kPropertyMap[];</span>
<a href="#l31.20"></a><span id="l31.20">     static const PRUint32 kPropertyMapSize;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbOSXUtils.mm</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbOSXUtils.mm</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -89,17 +89,17 @@ AppendToCString(const NSString *aString,</span>
<a href="#l32.4"></a><span id="l32.4">         }</span>
<a href="#l32.5"></a><span id="l32.5">     }</span>
<a href="#l32.6"></a><span id="l32.6"> }</span>
<a href="#l32.7"></a><span id="l32.7"> </span>
<a href="#l32.8"></a><span id="l32.8"> // Some properties can't be easily mapped back and forth.</span>
<a href="#l32.9"></a><span id="l32.9"> #define DONT_MAP(moz_name, osx_property, osx_label, osx_key)</span>
<a href="#l32.10"></a><span id="l32.10"> </span>
<a href="#l32.11"></a><span id="l32.11"> #define DEFINE_PROPERTY(moz_name, osx_property, osx_label, osx_key) \</span>
<a href="#l32.12"></a><span id="l32.12" class="difflineminus">-    { osx_property, osx_label, osx_key, &amp;nsAbOSXCard::m_##moz_name, #moz_name },</span>
<a href="#l32.13"></a><span id="l32.13" class="difflineplus">+    { osx_property, osx_label, osx_key, #moz_name },</span>
<a href="#l32.14"></a><span id="l32.14"> </span>
<a href="#l32.15"></a><span id="l32.15"> const nsAbOSXPropertyMap nsAbOSXUtils::kPropertyMap[] = {</span>
<a href="#l32.16"></a><span id="l32.16">     DEFINE_PROPERTY(FirstName, kABFirstNameProperty, nil, nil)</span>
<a href="#l32.17"></a><span id="l32.17">     DEFINE_PROPERTY(LastName, kABLastNameProperty, nil, nil)</span>
<a href="#l32.18"></a><span id="l32.18">     DONT_MAP(&quot;DisplayName&quot;, nil, nil, nil)</span>
<a href="#l32.19"></a><span id="l32.19">     DEFINE_PROPERTY(PhoneticFirstName, kABFirstNamePhoneticProperty, nil, nil)</span>
<a href="#l32.20"></a><span id="l32.20">     DEFINE_PROPERTY(PhoneticLastName, kABLastNamePhoneticProperty, nil, nil)</span>
<a href="#l32.21"></a><span id="l32.21">     DEFINE_PROPERTY(NickName, kABNicknameProperty, nil, nil)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbOutlookCard.cpp</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbOutlookCard.cpp</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineat">@@ -104,68 +104,68 @@ nsresult nsAbOutlookCard::Init(const cha</span>
<a href="#l33.4"></a><span id="l33.4">     mMapiData-&gt;Assign(entry) ;</span>
<a href="#l33.5"></a><span id="l33.5">     nsStringArray unichars ;</span>
<a href="#l33.6"></a><span id="l33.6">     ULONG i = 0 ;</span>
<a href="#l33.7"></a><span id="l33.7"> </span>
<a href="#l33.8"></a><span id="l33.8">     if (mapiAddBook-&gt;GetPropertiesUString(*mMapiData, OutlookCardMAPIProps, index_LastProp, unichars)) {</span>
<a href="#l33.9"></a><span id="l33.9">         SetFirstName(*unichars[index_FirstName]);</span>
<a href="#l33.10"></a><span id="l33.10">         SetLastName(*unichars[index_LastName]);</span>
<a href="#l33.11"></a><span id="l33.11">         SetDisplayName(*unichars[index_DisplayName]);</span>
<a href="#l33.12"></a><span id="l33.12" class="difflineminus">-        SetNickName(*unichars[index_NickName]);</span>
<a href="#l33.13"></a><span id="l33.13">         SetPrimaryEmail(*unichars[index_EmailAddress]);</span>
<a href="#l33.14"></a><span id="l33.14" class="difflineminus">-        SetWorkPhone(*unichars[index_WorkPhoneNumber]);</span>
<a href="#l33.15"></a><span id="l33.15" class="difflineminus">-        SetHomePhone(*unichars[index_HomePhoneNumber]);</span>
<a href="#l33.16"></a><span id="l33.16" class="difflineminus">-        SetFaxNumber(*unichars[index_WorkFaxNumber]);</span>
<a href="#l33.17"></a><span id="l33.17" class="difflineminus">-        SetPagerNumber(*unichars[index_PagerNumber]);</span>
<a href="#l33.18"></a><span id="l33.18" class="difflineminus">-        SetCellularNumber(*unichars[index_MobileNumber]);</span>
<a href="#l33.19"></a><span id="l33.19" class="difflineminus">-        SetHomeCity(*unichars[index_HomeCity]);</span>
<a href="#l33.20"></a><span id="l33.20" class="difflineminus">-        SetHomeState(*unichars[index_HomeState]);</span>
<a href="#l33.21"></a><span id="l33.21" class="difflineminus">-        SetHomeZipCode(*unichars[index_HomeZip]);</span>
<a href="#l33.22"></a><span id="l33.22" class="difflineminus">-        SetHomeCountry(*unichars[index_HomeCountry]);</span>
<a href="#l33.23"></a><span id="l33.23" class="difflineminus">-        SetWorkCity(*unichars[index_WorkCity]);</span>
<a href="#l33.24"></a><span id="l33.24" class="difflineminus">-        SetWorkState(*unichars[index_WorkState]);</span>
<a href="#l33.25"></a><span id="l33.25" class="difflineminus">-        SetWorkZipCode(*unichars[index_WorkZip]);</span>
<a href="#l33.26"></a><span id="l33.26" class="difflineminus">-        SetWorkCountry(*unichars[index_WorkCountry]);</span>
<a href="#l33.27"></a><span id="l33.27" class="difflineminus">-        SetJobTitle(*unichars[index_JobTitle]);</span>
<a href="#l33.28"></a><span id="l33.28" class="difflineminus">-        SetDepartment(*unichars[index_Department]);</span>
<a href="#l33.29"></a><span id="l33.29" class="difflineminus">-        SetCompany(*unichars[index_Company]);</span>
<a href="#l33.30"></a><span id="l33.30" class="difflineminus">-        SetWebPage1(*unichars[index_WorkWebPage]);</span>
<a href="#l33.31"></a><span id="l33.31" class="difflineminus">-        SetWebPage2(*unichars[index_HomeWebPage]);</span>
<a href="#l33.32"></a><span id="l33.32" class="difflineminus">-        SetNotes(*unichars[index_Comments]);</span>
<a href="#l33.33"></a><span id="l33.33" class="difflineplus">+        SetPropertyAsAString(kNicknameProperty, *unichars[index_NickName]);</span>
<a href="#l33.34"></a><span id="l33.34" class="difflineplus">+        SetPropertyAsAString(kWorkPhoneProperty, *unichars[index_WorkPhoneNumber]);</span>
<a href="#l33.35"></a><span id="l33.35" class="difflineplus">+        SetPropertyAsAString(kHomePhoneProperty, *unichars[index_HomePhoneNumber]);</span>
<a href="#l33.36"></a><span id="l33.36" class="difflineplus">+        SetPropertyAsAString(kFaxProperty, *unichars[index_WorkFaxNumber]);</span>
<a href="#l33.37"></a><span id="l33.37" class="difflineplus">+        SetPropertyAsAString(kPagerProperty, *unichars[index_PagerNumber]);</span>
<a href="#l33.38"></a><span id="l33.38" class="difflineplus">+        SetPropertyAsAString(kCellularProperty, *unichars[index_MobileNumber]);</span>
<a href="#l33.39"></a><span id="l33.39" class="difflineplus">+        SetPropertyAsAString(kHomeCityProperty, *unichars[index_HomeCity]);</span>
<a href="#l33.40"></a><span id="l33.40" class="difflineplus">+        SetPropertyAsAString(kHomeStateProperty, *unichars[index_HomeState]);</span>
<a href="#l33.41"></a><span id="l33.41" class="difflineplus">+        SetPropertyAsAString(kHomeZipCodeProperty, *unichars[index_HomeZip]);</span>
<a href="#l33.42"></a><span id="l33.42" class="difflineplus">+        SetPropertyAsAString(kHomeCountryProperty, *unichars[index_HomeCountry]);</span>
<a href="#l33.43"></a><span id="l33.43" class="difflineplus">+        SetPropertyAsAString(kWorkCityProperty, *unichars[index_WorkCity]);</span>
<a href="#l33.44"></a><span id="l33.44" class="difflineplus">+        SetPropertyAsAString(kWorkStateProperty, *unichars[index_WorkState]);</span>
<a href="#l33.45"></a><span id="l33.45" class="difflineplus">+        SetPropertyAsAString(kWorkZipCodeProperty, *unichars[index_WorkZip]);</span>
<a href="#l33.46"></a><span id="l33.46" class="difflineplus">+        SetPropertyAsAString(kWorkCountryProperty, *unichars[index_WorkCountry]);</span>
<a href="#l33.47"></a><span id="l33.47" class="difflineplus">+        SetPropertyAsAString(kJobTitleProperty, *unichars[index_JobTitle]);</span>
<a href="#l33.48"></a><span id="l33.48" class="difflineplus">+        SetPropertyAsAString(kDepartmentProperty, *unichars[index_Department]);</span>
<a href="#l33.49"></a><span id="l33.49" class="difflineplus">+        SetPropertyAsAString(kCompanyProperty, *unichars[index_Company]);</span>
<a href="#l33.50"></a><span id="l33.50" class="difflineplus">+        SetPropertyAsAString(kWorkWebPageProperty, *unichars[index_WorkWebPage]);</span>
<a href="#l33.51"></a><span id="l33.51" class="difflineplus">+        SetPropertyAsAString(kHomeWebPageProperty, *unichars[index_HomeWebPage]);</span>
<a href="#l33.52"></a><span id="l33.52" class="difflineplus">+        SetPropertyAsAString(kNotesProperty, *unichars[index_Comments]);</span>
<a href="#l33.53"></a><span id="l33.53">     }</span>
<a href="#l33.54"></a><span id="l33.54">     ULONG cardType = 0 ;</span>
<a href="#l33.55"></a><span id="l33.55">     nsCAutoString normalChars ;</span>
<a href="#l33.56"></a><span id="l33.56">     </span>
<a href="#l33.57"></a><span id="l33.57">     if (mapiAddBook-&gt;GetPropertyLong(*mMapiData, PR_OBJECT_TYPE, cardType)) {</span>
<a href="#l33.58"></a><span id="l33.58">         SetIsMailList(cardType == MAPI_DISTLIST) ;</span>
<a href="#l33.59"></a><span id="l33.59">         if (cardType == MAPI_DISTLIST) {</span>
<a href="#l33.60"></a><span id="l33.60">             buildAbWinUri(kOutlookDirectoryScheme, mAbWinType, normalChars) ;</span>
<a href="#l33.61"></a><span id="l33.61">             normalChars.Append(entry) ;</span>
<a href="#l33.62"></a><span id="l33.62">             SetMailListURI(normalChars.get()) ;</span>
<a href="#l33.63"></a><span id="l33.63">         }</span>
<a href="#l33.64"></a><span id="l33.64">     }</span>
<a href="#l33.65"></a><span id="l33.65">     nsAutoString unichar ;</span>
<a href="#l33.66"></a><span id="l33.66">     nsAutoString unicharBis ;</span>
<a href="#l33.67"></a><span id="l33.67"> </span>
<a href="#l33.68"></a><span id="l33.68">     if (mapiAddBook-&gt;GetPropertyUString(*mMapiData, PR_HOME_ADDRESS_STREET_W, unichar)) {</span>
<a href="#l33.69"></a><span id="l33.69" class="difflineminus">-        splitString(unichar, unicharBis) ;</span>
<a href="#l33.70"></a><span id="l33.70" class="difflineminus">-        SetHomeAddress(unichar) ;</span>
<a href="#l33.71"></a><span id="l33.71" class="difflineminus">-        SetHomeAddress2(unicharBis) ;</span>
<a href="#l33.72"></a><span id="l33.72" class="difflineplus">+        splitString(unichar, unicharBis);</span>
<a href="#l33.73"></a><span id="l33.73" class="difflineplus">+        SetPropertyAsAString(kHomeAddressProperty, unichar);</span>
<a href="#l33.74"></a><span id="l33.74" class="difflineplus">+        SetPropertyAsAString(kHomeAddress2Property, unicharBis);</span>
<a href="#l33.75"></a><span id="l33.75">     }</span>
<a href="#l33.76"></a><span id="l33.76">     if (mapiAddBook-&gt;GetPropertyUString(*mMapiData, PR_BUSINESS_ADDRESS_STREET_W, unichar)) {</span>
<a href="#l33.77"></a><span id="l33.77" class="difflineminus">-        splitString(unichar, unicharBis) ;</span>
<a href="#l33.78"></a><span id="l33.78" class="difflineminus">-        SetWorkAddress(unichar) ;</span>
<a href="#l33.79"></a><span id="l33.79" class="difflineminus">-        SetWorkAddress2(unicharBis) ;</span>
<a href="#l33.80"></a><span id="l33.80" class="difflineplus">+        splitString(unichar, unicharBis);</span>
<a href="#l33.81"></a><span id="l33.81" class="difflineplus">+        SetPropertyAsAString(kWorkAddressProperty, unichar);</span>
<a href="#l33.82"></a><span id="l33.82" class="difflineplus">+        SetPropertyAsAString(kWorkAddress2Property, unicharBis);</span>
<a href="#l33.83"></a><span id="l33.83">     }</span>
<a href="#l33.84"></a><span id="l33.84">     WORD year = 0 ;</span>
<a href="#l33.85"></a><span id="l33.85">     WORD month = 0 ;</span>
<a href="#l33.86"></a><span id="l33.86">     WORD day = 0 ;</span>
<a href="#l33.87"></a><span id="l33.87"> </span>
<a href="#l33.88"></a><span id="l33.88">     if (mapiAddBook-&gt;GetPropertyDate(*mMapiData, PR_BIRTHDAY, year, month, day)) {</span>
<a href="#l33.89"></a><span id="l33.89">         wordToUnicode(year, unichar);</span>
<a href="#l33.90"></a><span id="l33.90" class="difflineminus">-        SetBirthYear(unichar);</span>
<a href="#l33.91"></a><span id="l33.91" class="difflineplus">+        SetPropertyAsAString(kBirthYearProperty, unichar);</span>
<a href="#l33.92"></a><span id="l33.92">         wordToUnicode(month, unichar);</span>
<a href="#l33.93"></a><span id="l33.93" class="difflineminus">-        SetBirthMonth(unichar);</span>
<a href="#l33.94"></a><span id="l33.94" class="difflineplus">+        SetPropertyAsAString(kBirthMonthProperty, unichar);</span>
<a href="#l33.95"></a><span id="l33.95">         wordToUnicode(day, unichar);</span>
<a href="#l33.96"></a><span id="l33.96" class="difflineminus">-        SetBirthDay(unichar);</span>
<a href="#l33.97"></a><span id="l33.97" class="difflineplus">+        SetPropertyAsAString(kBirthDayProperty, unichar);</span>
<a href="#l33.98"></a><span id="l33.98">     }</span>
<a href="#l33.99"></a><span id="l33.99">     return retCode ;</span>
<a href="#l33.100"></a><span id="l33.100"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbOutlookDirectory.cpp</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbOutlookDirectory.cpp</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineat">@@ -524,92 +524,54 @@ NS_IMETHODIMP nsAbOutlookDirectory::Edit</span>
<a href="#l34.4"></a><span id="l34.4"> }</span>
<a href="#l34.5"></a><span id="l34.5"> </span>
<a href="#l34.6"></a><span id="l34.6"> struct OutlookTableAttr</span>
<a href="#l34.7"></a><span id="l34.7"> {</span>
<a href="#l34.8"></a><span id="l34.8">     const char *mOuterName ;</span>
<a href="#l34.9"></a><span id="l34.9">     ULONG mMapiProp ;</span>
<a href="#l34.10"></a><span id="l34.10"> } ;</span>
<a href="#l34.11"></a><span id="l34.11"> </span>
<a href="#l34.12"></a><span id="l34.12" class="difflineminus">-/*static const OutlookTableAttr OutlookTableStringToProp [] = </span>
<a href="#l34.13"></a><span id="l34.13" class="difflineminus">-{</span>
<a href="#l34.14"></a><span id="l34.14" class="difflineminus">-{&quot;FirstName&quot;, PR_GIVEN_NAME_W},</span>
<a href="#l34.15"></a><span id="l34.15" class="difflineminus">-{&quot;LastName&quot;, PR_SURNAME_W},</span>
<a href="#l34.16"></a><span id="l34.16" class="difflineminus">-{&quot;DisplayName&quot;, PR_DISPLAY_NAME_W},</span>
<a href="#l34.17"></a><span id="l34.17" class="difflineminus">-{&quot;NickName&quot;, PR_NICKNAME_W},</span>
<a href="#l34.18"></a><span id="l34.18" class="difflineminus">-{&quot;PrimaryEmail&quot;, PR_EMAIL_ADDRESS_W},</span>
<a href="#l34.19"></a><span id="l34.19" class="difflineminus">-{&quot;WorkPhone&quot;, PR_BUSINESS_TELEPHONE_NUMBER_W},</span>
<a href="#l34.20"></a><span id="l34.20" class="difflineminus">-{&quot;HomePhone&quot;, PR_HOME_TELEPHONE_NUMBER_W},</span>
<a href="#l34.21"></a><span id="l34.21" class="difflineminus">-{&quot;FaxNumber&quot;, PR_BUSINESS_FAX_NUMBER_W},</span>
<a href="#l34.22"></a><span id="l34.22" class="difflineminus">-{&quot;PagerNumber&quot;, PR_PAGER_TELEPHONE_NUMBER_W},</span>
<a href="#l34.23"></a><span id="l34.23" class="difflineminus">-{&quot;CellularNumber&quot;, PR_MOBILE_TELEPHONE_NUMBER_W},</span>
<a href="#l34.24"></a><span id="l34.24" class="difflineminus">-{&quot;HomeAddress&quot;, PR_HOME_ADDRESS_STREET_W},</span>
<a href="#l34.25"></a><span id="l34.25" class="difflineminus">-{&quot;HomeCity&quot;, PR_HOME_ADDRESS_CITY_W},</span>
<a href="#l34.26"></a><span id="l34.26" class="difflineminus">-{&quot;HomeState&quot;, PR_HOME_ADDRESS_STATE_OR_PROVINCE_W},</span>
<a href="#l34.27"></a><span id="l34.27" class="difflineminus">-{&quot;HomeZipCode&quot;, PR_HOME_ADDRESS_POSTAL_CODE_W},</span>
<a href="#l34.28"></a><span id="l34.28" class="difflineminus">-{&quot;HomeCountry&quot;, PR_HOME_ADDRESS_COUNTRY_W},</span>
<a href="#l34.29"></a><span id="l34.29" class="difflineminus">-{&quot;WorkAddress&quot;, PR_BUSINESS_ADDRESS_STREET_W}, </span>
<a href="#l34.30"></a><span id="l34.30" class="difflineminus">-{&quot;WorkCity&quot;, PR_BUSINESS_ADDRESS_CITY_W},</span>
<a href="#l34.31"></a><span id="l34.31" class="difflineminus">-{&quot;WorkState&quot;, PR_BUSINESS_ADDRESS_STATE_OR_PROVINCE_W},</span>
<a href="#l34.32"></a><span id="l34.32" class="difflineminus">-{&quot;WorkZipCode&quot;, PR_BUSINESS_ADDRESS_POSTAL_CODE_W},</span>
<a href="#l34.33"></a><span id="l34.33" class="difflineminus">-{&quot;WorkCountry&quot;, PR_BUSINESS_ADDRESS_COUNTRY_W},</span>
<a href="#l34.34"></a><span id="l34.34" class="difflineminus">-{&quot;JobTitle&quot;, PR_TITLE_W},</span>
<a href="#l34.35"></a><span id="l34.35" class="difflineminus">-{&quot;Department&quot;, PR_DEPARTMENT_NAME_W},</span>
<a href="#l34.36"></a><span id="l34.36" class="difflineminus">-{&quot;Company&quot;, PR_COMPANY_NAME_W},</span>
<a href="#l34.37"></a><span id="l34.37" class="difflineminus">-{&quot;WebPage1&quot;, PR_BUSINESS_HOME_PAGE_W},</span>
<a href="#l34.38"></a><span id="l34.38" class="difflineminus">-{&quot;WebPage2&quot;, PR_PERSONAL_HOME_PAGE_W},</span>
<a href="#l34.39"></a><span id="l34.39" class="difflineminus">-// For the moment, we don't support querying on the birthday</span>
<a href="#l34.40"></a><span id="l34.40" class="difflineminus">-// sub-elements.</span>
<a href="#l34.41"></a><span id="l34.41" class="difflineminus">-#if 0</span>
<a href="#l34.42"></a><span id="l34.42" class="difflineminus">-{&quot;BirthYear&quot;, PR_BIRTHDAY},</span>
<a href="#l34.43"></a><span id="l34.43" class="difflineminus">-{&quot;BirthMonth&quot;, PR_BIRTHDAY}, </span>
<a href="#l34.44"></a><span id="l34.44" class="difflineminus">-{&quot;BirthDay&quot;, PR_BIRTHDAY},</span>
<a href="#l34.45"></a><span id="l34.45" class="difflineminus">-#endif // 0</span>
<a href="#l34.46"></a><span id="l34.46" class="difflineminus">-{&quot;Notes&quot;, PR_COMMENT_W}</span>
<a href="#l34.47"></a><span id="l34.47" class="difflineminus">-} ;*/</span>
<a href="#l34.48"></a><span id="l34.48" class="difflineminus">-</span>
<a href="#l34.49"></a><span id="l34.49"> // Here, we are forced to use the Ascii versions of the properties</span>
<a href="#l34.50"></a><span id="l34.50"> // instead of the widechar ones, because the content restriction</span>
<a href="#l34.51"></a><span id="l34.51"> // operators do not work on unicode strings in mapi.</span>
<a href="#l34.52"></a><span id="l34.52"> static const OutlookTableAttr OutlookTableStringToProp [] = </span>
<a href="#l34.53"></a><span id="l34.53"> {</span>
<a href="#l34.54"></a><span id="l34.54" class="difflineminus">-    // replace &quot;PrimaryEmail&quot; with kPriEmailColumn etc.</span>
<a href="#l34.55"></a><span id="l34.55" class="difflineminus">-    {&quot;FirstName&quot;, PR_GIVEN_NAME_A},</span>
<a href="#l34.56"></a><span id="l34.56" class="difflineminus">-    {&quot;LastName&quot;, PR_SURNAME_A},</span>
<a href="#l34.57"></a><span id="l34.57" class="difflineminus">-    {&quot;DisplayName&quot;, PR_DISPLAY_NAME_A},</span>
<a href="#l34.58"></a><span id="l34.58" class="difflineminus">-    {&quot;NickName&quot;, PR_NICKNAME_A},</span>
<a href="#l34.59"></a><span id="l34.59" class="difflineminus">-    {&quot;PrimaryEmail&quot;, PR_EMAIL_ADDRESS_A},</span>
<a href="#l34.60"></a><span id="l34.60" class="difflineminus">-    {&quot;WorkPhone&quot;, PR_BUSINESS_TELEPHONE_NUMBER_A},</span>
<a href="#l34.61"></a><span id="l34.61" class="difflineminus">-    {&quot;HomePhone&quot;, PR_HOME_TELEPHONE_NUMBER_A},</span>
<a href="#l34.62"></a><span id="l34.62" class="difflineminus">-    {&quot;FaxNumber&quot;, PR_BUSINESS_FAX_NUMBER_A},</span>
<a href="#l34.63"></a><span id="l34.63" class="difflineminus">-    {&quot;PagerNumber&quot;, PR_PAGER_TELEPHONE_NUMBER_A},</span>
<a href="#l34.64"></a><span id="l34.64" class="difflineminus">-    {&quot;CellularNumber&quot;, PR_MOBILE_TELEPHONE_NUMBER_A},</span>
<a href="#l34.65"></a><span id="l34.65" class="difflineminus">-    {&quot;HomeAddress&quot;, PR_HOME_ADDRESS_STREET_A},</span>
<a href="#l34.66"></a><span id="l34.66" class="difflineminus">-    {&quot;HomeCity&quot;, PR_HOME_ADDRESS_CITY_A},</span>
<a href="#l34.67"></a><span id="l34.67" class="difflineminus">-    {&quot;HomeState&quot;, PR_HOME_ADDRESS_STATE_OR_PROVINCE_A},</span>
<a href="#l34.68"></a><span id="l34.68" class="difflineminus">-    {&quot;HomeZipCode&quot;, PR_HOME_ADDRESS_POSTAL_CODE_A},</span>
<a href="#l34.69"></a><span id="l34.69" class="difflineminus">-    {&quot;HomeCountry&quot;, PR_HOME_ADDRESS_COUNTRY_A},</span>
<a href="#l34.70"></a><span id="l34.70" class="difflineminus">-    {&quot;WorkAddress&quot;, PR_BUSINESS_ADDRESS_STREET_A}, </span>
<a href="#l34.71"></a><span id="l34.71" class="difflineminus">-    {&quot;WorkCity&quot;, PR_BUSINESS_ADDRESS_CITY_A},</span>
<a href="#l34.72"></a><span id="l34.72" class="difflineminus">-    {&quot;WorkState&quot;, PR_BUSINESS_ADDRESS_STATE_OR_PROVINCE_A},</span>
<a href="#l34.73"></a><span id="l34.73" class="difflineminus">-    {&quot;WorkZipCode&quot;, PR_BUSINESS_ADDRESS_POSTAL_CODE_A},</span>
<a href="#l34.74"></a><span id="l34.74" class="difflineminus">-    {&quot;WorkCountry&quot;, PR_BUSINESS_ADDRESS_COUNTRY_A},</span>
<a href="#l34.75"></a><span id="l34.75" class="difflineminus">-    {&quot;JobTitle&quot;, PR_TITLE_A},</span>
<a href="#l34.76"></a><span id="l34.76" class="difflineminus">-    {&quot;Department&quot;, PR_DEPARTMENT_NAME_A},</span>
<a href="#l34.77"></a><span id="l34.77" class="difflineminus">-    {&quot;Company&quot;, PR_COMPANY_NAME_A},</span>
<a href="#l34.78"></a><span id="l34.78" class="difflineminus">-    {&quot;WebPage1&quot;, PR_BUSINESS_HOME_PAGE_A},</span>
<a href="#l34.79"></a><span id="l34.79" class="difflineminus">-    {&quot;WebPage2&quot;, PR_PERSONAL_HOME_PAGE_A},</span>
<a href="#l34.80"></a><span id="l34.80" class="difflineplus">+    {kFirstNameProperty, PR_GIVEN_NAME_A},</span>
<a href="#l34.81"></a><span id="l34.81" class="difflineplus">+    {kLastNameProperty, PR_SURNAME_A},</span>
<a href="#l34.82"></a><span id="l34.82" class="difflineplus">+    {kDisplayNameProperty, PR_DISPLAY_NAME_A},</span>
<a href="#l34.83"></a><span id="l34.83" class="difflineplus">+    {kNicknameProperty, PR_NICKNAME_A},</span>
<a href="#l34.84"></a><span id="l34.84" class="difflineplus">+    {kPriEmailProperty, PR_EMAIL_ADDRESS_A},</span>
<a href="#l34.85"></a><span id="l34.85" class="difflineplus">+    {kWorkPhoneProperty, PR_BUSINESS_TELEPHONE_NUMBER_A},</span>
<a href="#l34.86"></a><span id="l34.86" class="difflineplus">+    {kHomePhoneProperty, PR_HOME_TELEPHONE_NUMBER_A},</span>
<a href="#l34.87"></a><span id="l34.87" class="difflineplus">+    {kFaxProperty, PR_BUSINESS_FAX_NUMBER_A},</span>
<a href="#l34.88"></a><span id="l34.88" class="difflineplus">+    {kPagerProperty, PR_PAGER_TELEPHONE_NUMBER_A},</span>
<a href="#l34.89"></a><span id="l34.89" class="difflineplus">+    {kCellularProperty, PR_MOBILE_TELEPHONE_NUMBER_A},</span>
<a href="#l34.90"></a><span id="l34.90" class="difflineplus">+    {kHomeAddressProperty, PR_HOME_ADDRESS_STREET_A},</span>
<a href="#l34.91"></a><span id="l34.91" class="difflineplus">+    {kHomeCityProperty, PR_HOME_ADDRESS_CITY_A},</span>
<a href="#l34.92"></a><span id="l34.92" class="difflineplus">+    {kHomeStateProperty, PR_HOME_ADDRESS_STATE_OR_PROVINCE_A},</span>
<a href="#l34.93"></a><span id="l34.93" class="difflineplus">+    {kHomeZipCodeProperty, PR_HOME_ADDRESS_POSTAL_CODE_A},</span>
<a href="#l34.94"></a><span id="l34.94" class="difflineplus">+    {kHomeCountryProperty, PR_HOME_ADDRESS_COUNTRY_A},</span>
<a href="#l34.95"></a><span id="l34.95" class="difflineplus">+    {kWorkAddressProperty, PR_BUSINESS_ADDRESS_STREET_A}, </span>
<a href="#l34.96"></a><span id="l34.96" class="difflineplus">+    {kWorkCityProperty, PR_BUSINESS_ADDRESS_CITY_A},</span>
<a href="#l34.97"></a><span id="l34.97" class="difflineplus">+    {kWorkStateProperty, PR_BUSINESS_ADDRESS_STATE_OR_PROVINCE_A},</span>
<a href="#l34.98"></a><span id="l34.98" class="difflineplus">+    {kWorkZipCodeProperty, PR_BUSINESS_ADDRESS_POSTAL_CODE_A},</span>
<a href="#l34.99"></a><span id="l34.99" class="difflineplus">+    {kWorkCountryProperty, PR_BUSINESS_ADDRESS_COUNTRY_A},</span>
<a href="#l34.100"></a><span id="l34.100" class="difflineplus">+    {kJobTitleProperty, PR_TITLE_A},</span>
<a href="#l34.101"></a><span id="l34.101" class="difflineplus">+    {kDepartmentProperty, PR_DEPARTMENT_NAME_A},</span>
<a href="#l34.102"></a><span id="l34.102" class="difflineplus">+    {kCompanyProperty, PR_COMPANY_NAME_A},</span>
<a href="#l34.103"></a><span id="l34.103" class="difflineplus">+    {kWorkWebPageProperty, PR_BUSINESS_HOME_PAGE_A},</span>
<a href="#l34.104"></a><span id="l34.104" class="difflineplus">+    {kHomeWebPageProperty, PR_PERSONAL_HOME_PAGE_A},</span>
<a href="#l34.105"></a><span id="l34.105">     // For the moment, we don't support querying on the birthday</span>
<a href="#l34.106"></a><span id="l34.106">     // sub-elements.</span>
<a href="#l34.107"></a><span id="l34.107"> #if 0</span>
<a href="#l34.108"></a><span id="l34.108" class="difflineminus">-    {&quot;BirthYear&quot;, PR_BIRTHDAY},</span>
<a href="#l34.109"></a><span id="l34.109" class="difflineminus">-    {&quot;BirthMonth&quot;, PR_BIRTHDAY}, </span>
<a href="#l34.110"></a><span id="l34.110" class="difflineminus">-    {&quot;BirthDay&quot;, PR_BIRTHDAY},</span>
<a href="#l34.111"></a><span id="l34.111" class="difflineplus">+    {kBirthYearProperty, PR_BIRTHDAY},</span>
<a href="#l34.112"></a><span id="l34.112" class="difflineplus">+    {kBirthMonthProperty, PR_BIRTHDAY}, </span>
<a href="#l34.113"></a><span id="l34.113" class="difflineplus">+    {kBirthDayProperty, PR_BIRTHDAY},</span>
<a href="#l34.114"></a><span id="l34.114"> #endif // 0</span>
<a href="#l34.115"></a><span id="l34.115" class="difflineminus">-    {&quot;Notes&quot;, PR_COMMENT_A}</span>
<a href="#l34.116"></a><span id="l34.116" class="difflineplus">+    {kNotesProperty, PR_COMMENT_A}</span>
<a href="#l34.117"></a><span id="l34.117"> } ;</span>
<a href="#l34.118"></a><span id="l34.118"> </span>
<a href="#l34.119"></a><span id="l34.119"> static const PRUint32 OutlookTableNbProps = sizeof(OutlookTableStringToProp) /</span>
<a href="#l34.120"></a><span id="l34.120">                                             sizeof(OutlookTableStringToProp [0]) ;</span>
<a href="#l34.121"></a><span id="l34.121"> </span>
<a href="#l34.122"></a><span id="l34.122"> static ULONG findPropertyTag(const char *aName) {</span>
<a href="#l34.123"></a><span id="l34.123">     PRUint32 i = 0 ;</span>
<a href="#l34.124"></a><span id="l34.124">     </span>
<a href="#l34.125"></a><span id="l34.125" class="difflineat">@@ -1405,78 +1367,83 @@ NS_IMETHODIMP nsAbOutlookDirectory::Modi</span>
<a href="#l34.126"></a><span id="l34.126">                                      properties[index_DisplayName]);</span>
<a href="#l34.127"></a><span id="l34.127">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l34.128"></a><span id="l34.128"> </span>
<a href="#l34.129"></a><span id="l34.129">     if (*properties[index_DisplayName].get() == 0) {</span>
<a href="#l34.130"></a><span id="l34.130">       aModifiedCard-&gt;GetPrimaryEmail(properties[index_DisplayName]);</span>
<a href="#l34.131"></a><span id="l34.131">     }</span>
<a href="#l34.132"></a><span id="l34.132">   }</span>
<a href="#l34.133"></a><span id="l34.133">   aModifiedCard-&gt;SetDisplayName(properties[index_DisplayName]);</span>
<a href="#l34.134"></a><span id="l34.134" class="difflineminus">-  aModifiedCard-&gt;GetNickName(properties[index_NickName]);</span>
<a href="#l34.135"></a><span id="l34.135">   aModifiedCard-&gt;GetPrimaryEmail(properties[index_EmailAddress]);</span>
<a href="#l34.136"></a><span id="l34.136" class="difflineminus">-  aModifiedCard-&gt;GetWorkPhone(properties[index_WorkPhoneNumber]);</span>
<a href="#l34.137"></a><span id="l34.137" class="difflineminus">-  aModifiedCard-&gt;GetHomePhone(properties[index_HomePhoneNumber]);</span>
<a href="#l34.138"></a><span id="l34.138" class="difflineminus">-  aModifiedCard-&gt;GetFaxNumber(properties[index_WorkFaxNumber]);</span>
<a href="#l34.139"></a><span id="l34.139" class="difflineminus">-  aModifiedCard-&gt;GetPagerNumber(properties[index_PagerNumber]);</span>
<a href="#l34.140"></a><span id="l34.140" class="difflineminus">-  aModifiedCard-&gt;GetCellularNumber(properties[index_MobileNumber]);</span>
<a href="#l34.141"></a><span id="l34.141" class="difflineminus">-  aModifiedCard-&gt;GetHomeCity(properties[index_HomeCity]);</span>
<a href="#l34.142"></a><span id="l34.142" class="difflineminus">-  aModifiedCard-&gt;GetHomeState(properties[index_HomeState]);</span>
<a href="#l34.143"></a><span id="l34.143" class="difflineminus">-  aModifiedCard-&gt;GetHomeZipCode(properties[index_HomeZip]);</span>
<a href="#l34.144"></a><span id="l34.144" class="difflineminus">-  aModifiedCard-&gt;GetHomeCountry(properties[index_HomeCountry]);</span>
<a href="#l34.145"></a><span id="l34.145" class="difflineminus">-  aModifiedCard-&gt;GetWorkCity(properties[index_WorkCity]);</span>
<a href="#l34.146"></a><span id="l34.146" class="difflineminus">-  aModifiedCard-&gt;GetWorkState(properties[index_WorkState]);</span>
<a href="#l34.147"></a><span id="l34.147" class="difflineminus">-  aModifiedCard-&gt;GetWorkZipCode(properties[index_WorkZip]);</span>
<a href="#l34.148"></a><span id="l34.148" class="difflineminus">-  aModifiedCard-&gt;GetWorkCountry(properties[index_WorkCountry]);</span>
<a href="#l34.149"></a><span id="l34.149" class="difflineminus">-  aModifiedCard-&gt;GetJobTitle(properties[index_JobTitle]);</span>
<a href="#l34.150"></a><span id="l34.150" class="difflineminus">-  aModifiedCard-&gt;GetDepartment(properties[index_Department]);</span>
<a href="#l34.151"></a><span id="l34.151" class="difflineminus">-  aModifiedCard-&gt;GetCompany(properties[index_Company]);</span>
<a href="#l34.152"></a><span id="l34.152" class="difflineminus">-  aModifiedCard-&gt;GetWebPage1(properties[index_WorkWebPage]);</span>
<a href="#l34.153"></a><span id="l34.153" class="difflineminus">-  aModifiedCard-&gt;GetWebPage2(properties[index_HomeWebPage]);</span>
<a href="#l34.154"></a><span id="l34.154" class="difflineminus">-  aModifiedCard-&gt;GetNotes(properties[index_Comments]);</span>
<a href="#l34.155"></a><span id="l34.155" class="difflineplus">+  aModifiedCard-&gt;GetPropertyAsAString(kNicknameProperty, properties[index_NickName]);</span>
<a href="#l34.156"></a><span id="l34.156" class="difflineplus">+  aModifiedCard-&gt;GetPropertyAsAString(kWorkPhoneProperty, properties[index_WorkPhoneNumber]);</span>
<a href="#l34.157"></a><span id="l34.157" class="difflineplus">+  aModifiedCard-&gt;GetPropertyAsAString(kHomePhoneProperty, properties[index_HomePhoneNumber]);</span>
<a href="#l34.158"></a><span id="l34.158" class="difflineplus">+  aModifiedCard-&gt;GetPropertyAsAString(kFaxProperty, properties[index_WorkFaxNumber]);</span>
<a href="#l34.159"></a><span id="l34.159" class="difflineplus">+  aModifiedCard-&gt;GetPropertyAsAString(kPagerProperty, properties[index_PagerNumber]);</span>
<a href="#l34.160"></a><span id="l34.160" class="difflineplus">+  aModifiedCard-&gt;GetPropertyAsAString(kCellularProperty, properties[index_MobileNumber]);</span>
<a href="#l34.161"></a><span id="l34.161" class="difflineplus">+  aModifiedCard-&gt;GetPropertyAsAString(kHomeCityProperty, properties[index_HomeCity]);</span>
<a href="#l34.162"></a><span id="l34.162" class="difflineplus">+  aModifiedCard-&gt;GetPropertyAsAString(kHomeStateProperty, properties[index_HomeState]);</span>
<a href="#l34.163"></a><span id="l34.163" class="difflineplus">+  aModifiedCard-&gt;GetPropertyAsAString(kHomeZipCodeProperty, properties[index_HomeZip]);</span>
<a href="#l34.164"></a><span id="l34.164" class="difflineplus">+  aModifiedCard-&gt;GetPropertyAsAString(kHomeCountryProperty, properties[index_HomeCountry]);</span>
<a href="#l34.165"></a><span id="l34.165" class="difflineplus">+  aModifiedCard-&gt;GetPropertyAsAString(kWorkCityProperty, properties[index_WorkCity]);</span>
<a href="#l34.166"></a><span id="l34.166" class="difflineplus">+  aModifiedCard-&gt;GetPropertyAsAString(kWorkStateProperty, properties[index_WorkState]);</span>
<a href="#l34.167"></a><span id="l34.167" class="difflineplus">+  aModifiedCard-&gt;GetPropertyAsAString(kWorkZipCodeProperty, properties[index_WorkZip]);</span>
<a href="#l34.168"></a><span id="l34.168" class="difflineplus">+  aModifiedCard-&gt;GetPropertyAsAString(kWorkCountryProperty, properties[index_WorkCountry]);</span>
<a href="#l34.169"></a><span id="l34.169" class="difflineplus">+  aModifiedCard-&gt;GetPropertyAsAString(kJobTitleProperty, properties[index_JobTitle]);</span>
<a href="#l34.170"></a><span id="l34.170" class="difflineplus">+  aModifiedCard-&gt;GetPropertyAsAString(kDepartmentProperty, properties[index_Department]);</span>
<a href="#l34.171"></a><span id="l34.171" class="difflineplus">+  aModifiedCard-&gt;GetPropertyAsAString(kCompanyProperty, properties[index_Company]);</span>
<a href="#l34.172"></a><span id="l34.172" class="difflineplus">+  aModifiedCard-&gt;GetPropertyAsAString(kWorkWebPageProperty, properties[index_WorkWebPage]);</span>
<a href="#l34.173"></a><span id="l34.173" class="difflineplus">+  aModifiedCard-&gt;GetPropertyAsAString(kHomeWebPageProperty, properties[index_HomeWebPage]);</span>
<a href="#l34.174"></a><span id="l34.174" class="difflineplus">+  aModifiedCard-&gt;GetPropertyAsAString(kNotesProperty, properties[index_Comments]);</span>
<a href="#l34.175"></a><span id="l34.175">   if (!mapiAddBook-&gt;SetPropertiesUString(*mMapiData, OutlookCardMAPIProps,</span>
<a href="#l34.176"></a><span id="l34.176">                                          index_LastProp, properties)) {</span>
<a href="#l34.177"></a><span id="l34.177">     PRINTF((&quot;Cannot set general properties.\n&quot;)) ;</span>
<a href="#l34.178"></a><span id="l34.178">   }</span>
<a href="#l34.179"></a><span id="l34.179"> </span>
<a href="#l34.180"></a><span id="l34.180">   delete [] properties;</span>
<a href="#l34.181"></a><span id="l34.181">   nsString unichar;</span>
<a href="#l34.182"></a><span id="l34.182">   nsString unichar2;</span>
<a href="#l34.183"></a><span id="l34.183">   WORD year = 0;</span>
<a href="#l34.184"></a><span id="l34.184">   WORD month = 0;</span>
<a href="#l34.185"></a><span id="l34.185">   WORD day = 0;</span>
<a href="#l34.186"></a><span id="l34.186"> </span>
<a href="#l34.187"></a><span id="l34.187" class="difflineminus">-  aModifiedCard-&gt;GetHomeAddress(unichar);</span>
<a href="#l34.188"></a><span id="l34.188" class="difflineminus">-  aModifiedCard-&gt;GetHomeAddress2(unichar2);</span>
<a href="#l34.189"></a><span id="l34.189" class="difflineplus">+  aModifiedCard-&gt;GetPropertyAsAString(kHomeAddressProperty, unichar);</span>
<a href="#l34.190"></a><span id="l34.190" class="difflineplus">+  aModifiedCard-&gt;GetPropertyAsAString(kHomeAddress2Property, unichar2);</span>
<a href="#l34.191"></a><span id="l34.191"> </span>
<a href="#l34.192"></a><span id="l34.192">   utility.Assign(unichar.get());</span>
<a href="#l34.193"></a><span id="l34.193">   if (!utility.IsEmpty())</span>
<a href="#l34.194"></a><span id="l34.194">     utility.AppendLiteral(&quot;\r\n&quot;);</span>
<a href="#l34.195"></a><span id="l34.195"> </span>
<a href="#l34.196"></a><span id="l34.196">   utility.Append(unichar2.get());</span>
<a href="#l34.197"></a><span id="l34.197">   if (!mapiAddBook-&gt;SetPropertyUString(*mMapiData, PR_HOME_ADDRESS_STREET_W, utility.get())) {</span>
<a href="#l34.198"></a><span id="l34.198">     PRINTF((&quot;Cannot set home address.\n&quot;)) ;</span>
<a href="#l34.199"></a><span id="l34.199">   }</span>
<a href="#l34.200"></a><span id="l34.200"> </span>
<a href="#l34.201"></a><span id="l34.201" class="difflineminus">-  aModifiedCard-&gt;GetWorkAddress(unichar);</span>
<a href="#l34.202"></a><span id="l34.202" class="difflineminus">-  aModifiedCard-&gt;GetWorkAddress2(unichar2);</span>
<a href="#l34.203"></a><span id="l34.203" class="difflineplus">+  unichar.Truncate();</span>
<a href="#l34.204"></a><span id="l34.204" class="difflineplus">+  aModifiedCard-&gt;GetPropertyAsAString(kWorkAddressProperty, unichar);</span>
<a href="#l34.205"></a><span id="l34.205" class="difflineplus">+  unichar2.Truncate();</span>
<a href="#l34.206"></a><span id="l34.206" class="difflineplus">+  aModifiedCard-&gt;GetPropertyAsAString(kWorkAddress2Property, unichar2);</span>
<a href="#l34.207"></a><span id="l34.207"> </span>
<a href="#l34.208"></a><span id="l34.208">   utility.Assign(unichar.get());</span>
<a href="#l34.209"></a><span id="l34.209">   if (!utility.IsEmpty())</span>
<a href="#l34.210"></a><span id="l34.210">     utility.AppendLiteral(&quot;\r\n&quot;);</span>
<a href="#l34.211"></a><span id="l34.211"> </span>
<a href="#l34.212"></a><span id="l34.212">   utility.Append(unichar2.get());</span>
<a href="#l34.213"></a><span id="l34.213">   if (!mapiAddBook-&gt;SetPropertyUString(*mMapiData, PR_BUSINESS_ADDRESS_STREET_W, utility.get())) {</span>
<a href="#l34.214"></a><span id="l34.214">     PRINTF((&quot;Cannot set work address.\n&quot;)) ;</span>
<a href="#l34.215"></a><span id="l34.215">   }</span>
<a href="#l34.216"></a><span id="l34.216"> </span>
<a href="#l34.217"></a><span id="l34.217" class="difflineminus">-  aModifiedCard-&gt;GetBirthYear(unichar);</span>
<a href="#l34.218"></a><span id="l34.218" class="difflineplus">+  unichar.Truncate();</span>
<a href="#l34.219"></a><span id="l34.219" class="difflineplus">+  aModifiedCard-&gt;GetPropertyAsAString(kBirthYearProperty, unichar);</span>
<a href="#l34.220"></a><span id="l34.220">   UnicodeToWord(unichar.get(), year);</span>
<a href="#l34.221"></a><span id="l34.221" class="difflineminus">-  aModifiedCard-&gt;GetBirthMonth(unichar);</span>
<a href="#l34.222"></a><span id="l34.222" class="difflineplus">+  unichar.Truncate();</span>
<a href="#l34.223"></a><span id="l34.223" class="difflineplus">+  aModifiedCard-&gt;GetPropertyAsAString(kBirthMonthProperty, unichar);</span>
<a href="#l34.224"></a><span id="l34.224">   UnicodeToWord(unichar.get(), month);</span>
<a href="#l34.225"></a><span id="l34.225" class="difflineminus">-  aModifiedCard-&gt;GetBirthDay(unichar);</span>
<a href="#l34.226"></a><span id="l34.226" class="difflineplus">+  unichar.Truncate();</span>
<a href="#l34.227"></a><span id="l34.227" class="difflineplus">+  aModifiedCard-&gt;GetPropertyAsAString(kBirthDayProperty, unichar);</span>
<a href="#l34.228"></a><span id="l34.228">   UnicodeToWord(unichar.get(), day);</span>
<a href="#l34.229"></a><span id="l34.229">   if (!mapiAddBook-&gt;SetPropertyDate(*mMapiData, PR_BIRTHDAY, year, month, day)) {</span>
<a href="#l34.230"></a><span id="l34.230">     PRINTF((&quot;Cannot set date.\n&quot;)) ;</span>
<a href="#l34.231"></a><span id="l34.231">   }</span>
<a href="#l34.232"></a><span id="l34.232"> </span>
<a href="#l34.233"></a><span id="l34.233">   return retCode;</span>
<a href="#l34.234"></a><span id="l34.234"> }</span>
<a href="#l34.235"></a><span id="l34.235"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbView.cpp</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbView.cpp</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineat">@@ -436,17 +436,22 @@ nsresult nsAbView::GetCardValue(nsIAbCar</span>
<a href="#l35.4"></a><span id="l35.4">   // else, standard column (like PrimaryEmail and _AimScreenName)</span>
<a href="#l35.5"></a><span id="l35.5">   if (colID[0] == PRUnichar('G'))</span>
<a href="#l35.6"></a><span id="l35.6">     return card-&gt;GenerateName(mGeneratedNameFormat, mABBundle, _retval);</span>
<a href="#l35.7"></a><span id="l35.7"> </span>
<a href="#l35.8"></a><span id="l35.8">   if (colID[0] == PRUnichar('_') &amp;&amp; colID[1] == PRUnichar('P'))</span>
<a href="#l35.9"></a><span id="l35.9">     // use LN/FN order for the phonetic name</span>
<a href="#l35.10"></a><span id="l35.10">     return card-&gt;GeneratePhoneticName(PR_TRUE, _retval);</span>
<a href="#l35.11"></a><span id="l35.11"> </span>
<a href="#l35.12"></a><span id="l35.12" class="difflineminus">-  return card-&gt;GetCardValue(NS_LossyConvertUTF16toASCII(colID).get(), _retval);</span>
<a href="#l35.13"></a><span id="l35.13" class="difflineplus">+  nsresult rv = card-&gt;GetPropertyAsAString(NS_ConvertUTF16toUTF8(colID).get(), _retval);</span>
<a href="#l35.14"></a><span id="l35.14" class="difflineplus">+  if (rv == NS_ERROR_NOT_AVAILABLE) {</span>
<a href="#l35.15"></a><span id="l35.15" class="difflineplus">+    rv = NS_OK;</span>
<a href="#l35.16"></a><span id="l35.16" class="difflineplus">+    _retval.Truncate();</span>
<a href="#l35.17"></a><span id="l35.17" class="difflineplus">+  }</span>
<a href="#l35.18"></a><span id="l35.18" class="difflineplus">+  return rv;</span>
<a href="#l35.19"></a><span id="l35.19"> }</span>
<a href="#l35.20"></a><span id="l35.20"> </span>
<a href="#l35.21"></a><span id="l35.21"> nsresult nsAbView::RefreshTree()</span>
<a href="#l35.22"></a><span id="l35.22"> {</span>
<a href="#l35.23"></a><span id="l35.23">   nsresult rv;</span>
<a href="#l35.24"></a><span id="l35.24"> </span>
<a href="#l35.25"></a><span id="l35.25">   // the PREF_MAIL_ADDR_BOOK_LASTNAMEFIRST pref affects how the GeneratedName column looks.</span>
<a href="#l35.26"></a><span id="l35.26">   // so if the GeneratedName is our primary or secondary sort,</span>
<a href="#l35.27"></a><span id="l35.27" class="difflineat">@@ -460,17 +465,17 @@ nsresult nsAbView::RefreshTree()</span>
<a href="#l35.28"></a><span id="l35.28">   //</span>
<a href="#l35.29"></a><span id="l35.29">   // one day, we can get fancy and remember what the secondary sort is.</span>
<a href="#l35.30"></a><span id="l35.30">   // we do that, we can fix this code.  at best, it will turn a sort into a invalidate.</span>
<a href="#l35.31"></a><span id="l35.31">   // </span>
<a href="#l35.32"></a><span id="l35.32">   // if neither the primary nor the secondary sorts are GeneratedName (or kPhoneticNameColumn), </span>
<a href="#l35.33"></a><span id="l35.33">   // all we have to do is invalidate (to show the new GeneratedNames), </span>
<a href="#l35.34"></a><span id="l35.34">   // but the sort will not change.</span>
<a href="#l35.35"></a><span id="l35.35">   if (mSortColumn.EqualsLiteral(GENERATED_NAME_COLUMN_ID) ||</span>
<a href="#l35.36"></a><span id="l35.36" class="difflineminus">-      mSortColumn.EqualsLiteral(kPriEmailColumn) ||</span>
<a href="#l35.37"></a><span id="l35.37" class="difflineplus">+      mSortColumn.EqualsLiteral(kPriEmailProperty) ||</span>
<a href="#l35.38"></a><span id="l35.38">       mSortColumn.EqualsLiteral(kPhoneticNameColumn)) {</span>
<a href="#l35.39"></a><span id="l35.39">     rv = SortBy(mSortColumn.get(), mSortDirection.get());</span>
<a href="#l35.40"></a><span id="l35.40">   }</span>
<a href="#l35.41"></a><span id="l35.41">   else {</span>
<a href="#l35.42"></a><span id="l35.42">     rv = InvalidateTree(ALL_ROWS);</span>
<a href="#l35.43"></a><span id="l35.43"> </span>
<a href="#l35.44"></a><span id="l35.44">     // Although the selection hasn't changed, the card that is selected may need</span>
<a href="#l35.45"></a><span id="l35.45">     // to be displayed differently, therefore pretend that the selection has</span>
<a href="#l35.46"></a><span id="l35.46" class="difflineat">@@ -764,17 +769,17 @@ nsresult nsAbView::GenerateCollationKeys</span>
<a href="#l35.47"></a><span id="l35.47">   PR_FREEIF(abcard-&gt;primaryCollationKey);</span>
<a href="#l35.48"></a><span id="l35.48">   rv = mCollationKeyGenerator-&gt;AllocateRawSortKey(nsICollation::kCollationCaseInSensitive,</span>
<a href="#l35.49"></a><span id="l35.49">     value, &amp;(abcard-&gt;primaryCollationKey), &amp;(abcard-&gt;primaryCollationKeyLen));</span>
<a href="#l35.50"></a><span id="l35.50">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l35.51"></a><span id="l35.51">   </span>
<a href="#l35.52"></a><span id="l35.52">   // Hardcode email to be our secondary key. As we are doing this, just call</span>
<a href="#l35.53"></a><span id="l35.53">   // the card's GetCardValue direct, rather than our own function which will</span>
<a href="#l35.54"></a><span id="l35.54">   // end up doing the same as then we can save a bit of time.</span>
<a href="#l35.55"></a><span id="l35.55" class="difflineminus">-  rv = abcard-&gt;card-&gt;GetCardValue(NS_LITERAL_CSTRING(kPriEmailColumn).get(), value);</span>
<a href="#l35.56"></a><span id="l35.56" class="difflineplus">+  rv = abcard-&gt;card-&gt;GetPrimaryEmail(value);</span>
<a href="#l35.57"></a><span id="l35.57">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l35.58"></a><span id="l35.58">   </span>
<a href="#l35.59"></a><span id="l35.59">   PR_FREEIF(abcard-&gt;secondaryCollationKey);</span>
<a href="#l35.60"></a><span id="l35.60">   rv = mCollationKeyGenerator-&gt;AllocateRawSortKey(nsICollation::kCollationCaseInSensitive,</span>
<a href="#l35.61"></a><span id="l35.61">     value, &amp;(abcard-&gt;secondaryCollationKey), &amp;(abcard-&gt;secondaryCollationKeyLen));</span>
<a href="#l35.62"></a><span id="l35.62">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l35.63"></a><span id="l35.63">   return rv;</span>
<a href="#l35.64"></a><span id="l35.64"> }</span>
<a href="#l35.65"></a><span id="l35.65" class="difflineat">@@ -1232,24 +1237,24 @@ NS_IMETHODIMP nsAbView::SwapFirstNameLas</span>
<a href="#l35.66"></a><span id="l35.66">             else</span>
<a href="#l35.67"></a><span id="l35.67">             {</span>
<a href="#l35.68"></a><span id="l35.68">               if (dn.Equals(dnFnLn))</span>
<a href="#l35.69"></a><span id="l35.69">                 abCard-&gt;SetDisplayName(dnLnFn);</span>
<a href="#l35.70"></a><span id="l35.70">             }</span>
<a href="#l35.71"></a><span id="l35.71">           }</span>
<a href="#l35.72"></a><span id="l35.72"> </span>
<a href="#l35.73"></a><span id="l35.73">           // swap phonetic names</span>
<a href="#l35.74"></a><span id="l35.74" class="difflineminus">-          rv = abCard-&gt;GetPhoneticFirstName(fn);</span>
<a href="#l35.75"></a><span id="l35.75" class="difflineplus">+          rv = abCard-&gt;GetPropertyAsAString(kPhoneticFirstNameProperty, fn);</span>
<a href="#l35.76"></a><span id="l35.76">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l35.77"></a><span id="l35.77" class="difflineminus">-          rv = abCard-&gt;GetPhoneticLastName(ln);</span>
<a href="#l35.78"></a><span id="l35.78" class="difflineplus">+          rv = abCard-&gt;GetPropertyAsAString(kPhoneticLastNameProperty, ln);</span>
<a href="#l35.79"></a><span id="l35.79">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l35.80"></a><span id="l35.80">           if (!fn.IsEmpty() || !ln.IsEmpty())</span>
<a href="#l35.81"></a><span id="l35.81">           {</span>
<a href="#l35.82"></a><span id="l35.82" class="difflineminus">-            abCard-&gt;SetPhoneticFirstName(ln);</span>
<a href="#l35.83"></a><span id="l35.83" class="difflineminus">-            abCard-&gt;SetPhoneticLastName(fn);</span>
<a href="#l35.84"></a><span id="l35.84" class="difflineplus">+            abCard-&gt;SetPropertyAsAString(kPhoneticFirstNameProperty, ln);</span>
<a href="#l35.85"></a><span id="l35.85" class="difflineplus">+            abCard-&gt;SetPropertyAsAString(kPhoneticLastNameProperty, fn);</span>
<a href="#l35.86"></a><span id="l35.86">           }</span>
<a href="#l35.87"></a><span id="l35.87">         }</span>
<a href="#l35.88"></a><span id="l35.88">       }</span>
<a href="#l35.89"></a><span id="l35.89">     }</span>
<a href="#l35.90"></a><span id="l35.90">   }</span>
<a href="#l35.91"></a><span id="l35.91">   // update the tree</span>
<a href="#l35.92"></a><span id="l35.92">   // re-sort if either generated or phonetic name is primary or secondary sort,</span>
<a href="#l35.93"></a><span id="l35.93">   // otherwise invalidate to reflect the change</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l36.1"></a><span id="l36.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAddbookProtocolHandler.cpp</span>
<a href="#l36.2"></a><span id="l36.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAddbookProtocolHandler.cpp</span>
<a href="#l36.3"></a><span id="l36.3" class="difflineat">@@ -44,17 +44,16 @@</span>
<a href="#l36.4"></a><span id="l36.4"> #include &quot;nsAddbookProtocolHandler.h&quot;</span>
<a href="#l36.5"></a><span id="l36.5"> </span>
<a href="#l36.6"></a><span id="l36.6"> #include &quot;nsAddbookUrl.h&quot;</span>
<a href="#l36.7"></a><span id="l36.7"> #include &quot;nsAddbookProtocolHandler.h&quot;</span>
<a href="#l36.8"></a><span id="l36.8"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l36.9"></a><span id="l36.9"> #include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l36.10"></a><span id="l36.10"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l36.11"></a><span id="l36.11"> #include &quot;nsStringStream.h&quot;</span>
<a href="#l36.12"></a><span id="l36.12" class="difflineminus">-#include &quot;nsIAbMDBCard.h&quot;</span>
<a href="#l36.13"></a><span id="l36.13"> #include &quot;nsIAbDirectory.h&quot;</span>
<a href="#l36.14"></a><span id="l36.14"> #include &quot;nsIRDFResource.h&quot;</span>
<a href="#l36.15"></a><span id="l36.15"> #include &quot;nsIRDFService.h&quot;</span>
<a href="#l36.16"></a><span id="l36.16"> #include &quot;nsRDFCID.h&quot;</span>
<a href="#l36.17"></a><span id="l36.17"> #include &quot;prmem.h&quot;</span>
<a href="#l36.18"></a><span id="l36.18"> #include &quot;nsIAbView.h&quot;</span>
<a href="#l36.19"></a><span id="l36.19"> #include &quot;nsITreeView.h&quot;</span>
<a href="#l36.20"></a><span id="l36.20"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l36.21"></a><span id="l36.21" class="difflineat">@@ -298,22 +297,22 @@ nsAddbookProtocolHandler::BuildDirectory</span>
<a href="#l36.22"></a><span id="l36.22">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l36.23"></a><span id="l36.23">   treeView-&gt;GetRowCount(&amp;numRows);</span>
<a href="#l36.24"></a><span id="l36.24">   </span>
<a href="#l36.25"></a><span id="l36.25">   for (PRInt32 row = 0; row &lt; numRows; row++)</span>
<a href="#l36.26"></a><span id="l36.26">   {</span>
<a href="#l36.27"></a><span id="l36.27">     </span>
<a href="#l36.28"></a><span id="l36.28">     nsCOMPtr &lt;nsIAbCard&gt; card;</span>
<a href="#l36.29"></a><span id="l36.29">     view-&gt;GetCardFromRow(row, getter_AddRefs(card));</span>
<a href="#l36.30"></a><span id="l36.30" class="difflineminus">-    nsString xmlSubstr;</span>
<a href="#l36.31"></a><span id="l36.31" class="difflineplus">+    nsCString xmlSubstr;</span>
<a href="#l36.32"></a><span id="l36.32"> </span>
<a href="#l36.33"></a><span id="l36.33" class="difflineminus">-    rv = card-&gt;ConvertToXMLPrintData(xmlSubstr);</span>
<a href="#l36.34"></a><span id="l36.34" class="difflineplus">+    rv = card-&gt;TranslateTo(NS_LITERAL_CSTRING(&quot;xml&quot;), xmlSubstr);</span>
<a href="#l36.35"></a><span id="l36.35">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l36.36"></a><span id="l36.36"> </span>
<a href="#l36.37"></a><span id="l36.37">     aOutput.AppendLiteral(&quot;&lt;separator/&gt;&quot;);</span>
<a href="#l36.38"></a><span id="l36.38" class="difflineminus">-    aOutput.Append(xmlSubstr);</span>
<a href="#l36.39"></a><span id="l36.39" class="difflineplus">+    aOutput.Append(NS_ConvertUTF8toUTF16(xmlSubstr));</span>
<a href="#l36.40"></a><span id="l36.40">     aOutput.AppendLiteral(&quot;&lt;separator/&gt;&quot;);</span>
<a href="#l36.41"></a><span id="l36.41">   }</span>
<a href="#l36.42"></a><span id="l36.42"> </span>
<a href="#l36.43"></a><span id="l36.43">   aOutput.AppendLiteral(&quot;&lt;/directory&gt;\n&quot;);</span>
<a href="#l36.44"></a><span id="l36.44"> </span>
<a href="#l36.45"></a><span id="l36.45">   return NS_OK;</span>
<a href="#l36.46"></a><span id="l36.46"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l37.1"></a><span id="l37.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAddrDatabase.cpp</span>
<a href="#l37.2"></a><span id="l37.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAddrDatabase.cpp</span>
<a href="#l37.3"></a><span id="l37.3" class="difflineat">@@ -17,16 +17,17 @@</span>
<a href="#l37.4"></a><span id="l37.4">  * The Initial Developer of the Original Code is</span>
<a href="#l37.5"></a><span id="l37.5">  * Netscape Communications Corporation.</span>
<a href="#l37.6"></a><span id="l37.6">  * Portions created by the Initial Developer are Copyright (C) 1999</span>
<a href="#l37.7"></a><span id="l37.7">  * the Initial Developer. All Rights Reserved.</span>
<a href="#l37.8"></a><span id="l37.8">  *</span>
<a href="#l37.9"></a><span id="l37.9">  * Contributor(s):</span>
<a href="#l37.10"></a><span id="l37.10">  *   Pierre Phaneuf &lt;pp@ludusdesign.com&gt;</span>
<a href="#l37.11"></a><span id="l37.11">  *   Mark Banner &lt;mark@standard8.demon.co.uk&gt;</span>
<a href="#l37.12"></a><span id="l37.12" class="difflineplus">+ *   Joshua Cranmer &lt;Pidgeot18@gmail.com&gt;</span>
<a href="#l37.13"></a><span id="l37.13">  *</span>
<a href="#l37.14"></a><span id="l37.14">  * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l37.15"></a><span id="l37.15">  * either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l37.16"></a><span id="l37.16">  * or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l37.17"></a><span id="l37.17">  * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l37.18"></a><span id="l37.18">  * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l37.19"></a><span id="l37.19">  * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l37.20"></a><span id="l37.20">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l37.21"></a><span id="l37.21" class="difflineat">@@ -40,17 +41,16 @@</span>
<a href="#l37.22"></a><span id="l37.22"> // this file implements the nsAddrDatabase interface using the MDB Interface.</span>
<a href="#l37.23"></a><span id="l37.23"> </span>
<a href="#l37.24"></a><span id="l37.24"> #include &quot;nsAddrDatabase.h&quot;</span>
<a href="#l37.25"></a><span id="l37.25"> #include &quot;nsStringGlue.h&quot;</span>
<a href="#l37.26"></a><span id="l37.26"> #include &quot;nsAutoPtr.h&quot;</span>
<a href="#l37.27"></a><span id="l37.27"> #include &quot;nsRDFCID.h&quot;</span>
<a href="#l37.28"></a><span id="l37.28"> #include &quot;nsUnicharUtils.h&quot;</span>
<a href="#l37.29"></a><span id="l37.29"> #include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l37.30"></a><span id="l37.30" class="difflineminus">-#include &quot;nsIAbMDBCard.h&quot;</span>
<a href="#l37.31"></a><span id="l37.31"> #include &quot;nsIAbMDBDirectory.h&quot;</span>
<a href="#l37.32"></a><span id="l37.32"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l37.33"></a><span id="l37.33"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l37.34"></a><span id="l37.34"> #include &quot;nsRDFCID.h&quot;</span>
<a href="#l37.35"></a><span id="l37.35"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l37.36"></a><span id="l37.36"> #include &quot;nsMorkCID.h&quot;</span>
<a href="#l37.37"></a><span id="l37.37"> #include &quot;nsIMdbFactoryFactory.h&quot;</span>
<a href="#l37.38"></a><span id="l37.38"> #include &quot;nsIRDFService.h&quot;</span>
<a href="#l37.39"></a><span id="l37.39" class="difflineat">@@ -59,16 +59,18 @@</span>
<a href="#l37.40"></a><span id="l37.40"> #include &quot;prprf.h&quot;</span>
<a href="#l37.41"></a><span id="l37.41"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l37.42"></a><span id="l37.42"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l37.43"></a><span id="l37.43"> #include &quot;nsIPromptService.h&quot;</span>
<a href="#l37.44"></a><span id="l37.44"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l37.45"></a><span id="l37.45"> #include &quot;nsIFile.h&quot;</span>
<a href="#l37.46"></a><span id="l37.46"> #include &quot;nsEmbedCID.h&quot;</span>
<a href="#l37.47"></a><span id="l37.47"> #include &quot;nsXPCOMCIDInternal.h&quot;</span>
<a href="#l37.48"></a><span id="l37.48" class="difflineplus">+#include &quot;nsIProperty.h&quot;</span>
<a href="#l37.49"></a><span id="l37.49" class="difflineplus">+#include &quot;nsIVariant.h&quot;</span>
<a href="#l37.50"></a><span id="l37.50"> </span>
<a href="#l37.51"></a><span id="l37.51"> #define ID_PAB_TABLE            1</span>
<a href="#l37.52"></a><span id="l37.52"> #define ID_DELETEDCARDS_TABLE           2</span>
<a href="#l37.53"></a><span id="l37.53"> </span>
<a href="#l37.54"></a><span id="l37.54"> const PRInt32 kAddressBookDBVersion = 1;</span>
<a href="#l37.55"></a><span id="l37.55"> </span>
<a href="#l37.56"></a><span id="l37.56"> static const char kPabTableKind[] = &quot;ns:addrbk:db:table:kind:pab&quot;;</span>
<a href="#l37.57"></a><span id="l37.57"> static const char kDeletedCardsTableKind[] = &quot;ns:addrbk:db:table:kind:deleted&quot;; // this table is used to keep the deleted cards</span>
<a href="#l37.58"></a><span id="l37.58" class="difflineat">@@ -80,16 +82,17 @@ static const char kDataRowScope[] = &quot;ns:</span>
<a href="#l37.59"></a><span id="l37.59"> #define DATAROW_ROWID 1</span>
<a href="#l37.60"></a><span id="l37.60"> </span>
<a href="#l37.61"></a><span id="l37.61"> #define COLUMN_STR_MAX 16</span>
<a href="#l37.62"></a><span id="l37.62"> </span>
<a href="#l37.63"></a><span id="l37.63"> #define PURGE_CUTOFF_COUNT 50</span>
<a href="#l37.64"></a><span id="l37.64"> </span>
<a href="#l37.65"></a><span id="l37.65"> static const char kRecordKeyColumn[] = &quot;RecordKey&quot;;</span>
<a href="#l37.66"></a><span id="l37.66"> static const char kLastRecordKeyColumn[] = &quot;LastRecordKey&quot;;</span>
<a href="#l37.67"></a><span id="l37.67" class="difflineplus">+static const char kRowIDProperty[] = &quot;DbRowID&quot;;</span>
<a href="#l37.68"></a><span id="l37.68"> </span>
<a href="#l37.69"></a><span id="l37.69"> static const char kMailListTotalLists[] = &quot;ListTotalLists&quot;;    // total number of mail list in a mailing list</span>
<a href="#l37.70"></a><span id="l37.70"> static const char kLowerListNameColumn[] = &quot;LowercaseListName&quot;;</span>
<a href="#l37.71"></a><span id="l37.71"> </span>
<a href="#l37.72"></a><span id="l37.72"> struct mdbOid gAddressBookTableOID;</span>
<a href="#l37.73"></a><span id="l37.73"> </span>
<a href="#l37.74"></a><span id="l37.74"> static const char kMailListAddressFormat[] = &quot;Address%d&quot;;</span>
<a href="#l37.75"></a><span id="l37.75"> </span>
<a href="#l37.76"></a><span id="l37.76" class="difflineat">@@ -1117,72 +1120,70 @@ nsresult nsAddrDatabase::InitMDBInfo()</span>
<a href="#l37.77"></a><span id="l37.77">     m_mdbTokensInitialized = PR_TRUE;</span>
<a href="#l37.78"></a><span id="l37.78">     err = m_mdbStore-&gt;StringToToken(m_mdbEnv, kCardRowScope, &amp;m_CardRowScopeToken);</span>
<a href="#l37.79"></a><span id="l37.79">     err = m_mdbStore-&gt;StringToToken(m_mdbEnv, kListRowScope, &amp;m_ListRowScopeToken);</span>
<a href="#l37.80"></a><span id="l37.80">     err = m_mdbStore-&gt;StringToToken(m_mdbEnv, kDataRowScope, &amp;m_DataRowScopeToken);</span>
<a href="#l37.81"></a><span id="l37.81">     gAddressBookTableOID.mOid_Scope = m_CardRowScopeToken;</span>
<a href="#l37.82"></a><span id="l37.82">     gAddressBookTableOID.mOid_Id = ID_PAB_TABLE;</span>
<a href="#l37.83"></a><span id="l37.83">     if (NS_SUCCEEDED(err))</span>
<a href="#l37.84"></a><span id="l37.84">     {</span>
<a href="#l37.85"></a><span id="l37.85" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kFirstNameColumn, &amp;m_FirstNameColumnToken);</span>
<a href="#l37.86"></a><span id="l37.86" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kLastNameColumn, &amp;m_LastNameColumnToken);</span>
<a href="#l37.87"></a><span id="l37.87" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kPhoneticFirstNameColumn, &amp;m_PhoneticFirstNameColumnToken);</span>
<a href="#l37.88"></a><span id="l37.88" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kPhoneticLastNameColumn, &amp;m_PhoneticLastNameColumnToken);</span>
<a href="#l37.89"></a><span id="l37.89" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kDisplayNameColumn, &amp;m_DisplayNameColumnToken);</span>
<a href="#l37.90"></a><span id="l37.90" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kNicknameColumn, &amp;m_NickNameColumnToken);</span>
<a href="#l37.91"></a><span id="l37.91" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kPriEmailColumn, &amp;m_PriEmailColumnToken);</span>
<a href="#l37.92"></a><span id="l37.92" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kFirstNameProperty, &amp;m_FirstNameColumnToken);</span>
<a href="#l37.93"></a><span id="l37.93" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kLastNameProperty, &amp;m_LastNameColumnToken);</span>
<a href="#l37.94"></a><span id="l37.94" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kPhoneticFirstNameProperty, &amp;m_PhoneticFirstNameColumnToken);</span>
<a href="#l37.95"></a><span id="l37.95" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kPhoneticLastNameProperty, &amp;m_PhoneticLastNameColumnToken);</span>
<a href="#l37.96"></a><span id="l37.96" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kDisplayNameProperty, &amp;m_DisplayNameColumnToken);</span>
<a href="#l37.97"></a><span id="l37.97" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kNicknameProperty, &amp;m_NickNameColumnToken);</span>
<a href="#l37.98"></a><span id="l37.98" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kPriEmailProperty, &amp;m_PriEmailColumnToken);</span>
<a href="#l37.99"></a><span id="l37.99">       m_mdbStore-&gt;StringToToken(m_mdbEnv,  kLowerPriEmailColumn, &amp;m_LowerPriEmailColumnToken);</span>
<a href="#l37.100"></a><span id="l37.100" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  k2ndEmailColumn, &amp;m_2ndEmailColumnToken);</span>
<a href="#l37.101"></a><span id="l37.101" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kPreferMailFormatColumn, &amp;m_MailFormatColumnToken);</span>
<a href="#l37.102"></a><span id="l37.102" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kPopularityIndexColumn, &amp;m_PopularityIndexColumnToken);</span>
<a href="#l37.103"></a><span id="l37.103" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kAllowRemoteContentColumn, &amp;m_AllowRemoteContentColumnToken);</span>
<a href="#l37.104"></a><span id="l37.104" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kWorkPhoneColumn, &amp;m_WorkPhoneColumnToken);</span>
<a href="#l37.105"></a><span id="l37.105" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kHomePhoneColumn, &amp;m_HomePhoneColumnToken);</span>
<a href="#l37.106"></a><span id="l37.106" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kFaxColumn, &amp;m_FaxColumnToken);</span>
<a href="#l37.107"></a><span id="l37.107" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kPagerColumn, &amp;m_PagerColumnToken);</span>
<a href="#l37.108"></a><span id="l37.108" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kCellularColumn, &amp;m_CellularColumnToken);</span>
<a href="#l37.109"></a><span id="l37.109" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kWorkPhoneTypeColumn, &amp;m_WorkPhoneTypeColumnToken);</span>
<a href="#l37.110"></a><span id="l37.110" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kHomePhoneTypeColumn, &amp;m_HomePhoneTypeColumnToken);</span>
<a href="#l37.111"></a><span id="l37.111" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kFaxTypeColumn, &amp;m_FaxTypeColumnToken);</span>
<a href="#l37.112"></a><span id="l37.112" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kPagerTypeColumn, &amp;m_PagerTypeColumnToken);</span>
<a href="#l37.113"></a><span id="l37.113" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kCellularTypeColumn, &amp;m_CellularTypeColumnToken);</span>
<a href="#l37.114"></a><span id="l37.114" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kHomeAddressColumn, &amp;m_HomeAddressColumnToken);</span>
<a href="#l37.115"></a><span id="l37.115" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kHomeAddress2Column, &amp;m_HomeAddress2ColumnToken);</span>
<a href="#l37.116"></a><span id="l37.116" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kHomeCityColumn, &amp;m_HomeCityColumnToken);</span>
<a href="#l37.117"></a><span id="l37.117" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kHomeStateColumn, &amp;m_HomeStateColumnToken);</span>
<a href="#l37.118"></a><span id="l37.118" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kHomeZipCodeColumn, &amp;m_HomeZipCodeColumnToken);</span>
<a href="#l37.119"></a><span id="l37.119" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kHomeCountryColumn, &amp;m_HomeCountryColumnToken);</span>
<a href="#l37.120"></a><span id="l37.120" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kWorkAddressColumn, &amp;m_WorkAddressColumnToken);</span>
<a href="#l37.121"></a><span id="l37.121" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kWorkAddress2Column, &amp;m_WorkAddress2ColumnToken);</span>
<a href="#l37.122"></a><span id="l37.122" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kWorkCityColumn, &amp;m_WorkCityColumnToken);</span>
<a href="#l37.123"></a><span id="l37.123" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kWorkStateColumn, &amp;m_WorkStateColumnToken);</span>
<a href="#l37.124"></a><span id="l37.124" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kWorkZipCodeColumn, &amp;m_WorkZipCodeColumnToken);</span>
<a href="#l37.125"></a><span id="l37.125" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kWorkCountryColumn, &amp;m_WorkCountryColumnToken);</span>
<a href="#l37.126"></a><span id="l37.126" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kJobTitleColumn, &amp;m_JobTitleColumnToken);</span>
<a href="#l37.127"></a><span id="l37.127" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kDepartmentColumn, &amp;m_DepartmentColumnToken);</span>
<a href="#l37.128"></a><span id="l37.128" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kCompanyColumn, &amp;m_CompanyColumnToken);</span>
<a href="#l37.129"></a><span id="l37.129" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kAimScreenNameColumn, &amp;m_AimScreenNameColumnToken);</span>
<a href="#l37.130"></a><span id="l37.130" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kAnniversaryYearColumn, &amp;m_AnniversaryYearColumnToken);</span>
<a href="#l37.131"></a><span id="l37.131" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kAnniversaryMonthColumn, &amp;m_AnniversaryMonthColumnToken);</span>
<a href="#l37.132"></a><span id="l37.132" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kAnniversaryDayColumn, &amp;m_AnniversaryDayColumnToken);</span>
<a href="#l37.133"></a><span id="l37.133" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kSpouseNameColumn, &amp;m_SpouseNameColumnToken);</span>
<a href="#l37.134"></a><span id="l37.134" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kFamilyNameColumn, &amp;m_FamilyNameColumnToken);</span>
<a href="#l37.135"></a><span id="l37.135" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kDefaultAddressColumn, &amp;m_DefaultAddressColumnToken);</span>
<a href="#l37.136"></a><span id="l37.136" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kCategoryColumn, &amp;m_CategoryColumnToken);</span>
<a href="#l37.137"></a><span id="l37.137" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kWebPage1Column, &amp;m_WebPage1ColumnToken);</span>
<a href="#l37.138"></a><span id="l37.138" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kWebPage2Column, &amp;m_WebPage2ColumnToken);</span>
<a href="#l37.139"></a><span id="l37.139" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kBirthYearColumn, &amp;m_BirthYearColumnToken);</span>
<a href="#l37.140"></a><span id="l37.140" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kBirthMonthColumn, &amp;m_BirthMonthColumnToken);</span>
<a href="#l37.141"></a><span id="l37.141" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kBirthDayColumn, &amp;m_BirthDayColumnToken);</span>
<a href="#l37.142"></a><span id="l37.142" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kCustom1Column, &amp;m_Custom1ColumnToken);</span>
<a href="#l37.143"></a><span id="l37.143" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kCustom2Column, &amp;m_Custom2ColumnToken);</span>
<a href="#l37.144"></a><span id="l37.144" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kCustom3Column, &amp;m_Custom3ColumnToken);</span>
<a href="#l37.145"></a><span id="l37.145" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kCustom4Column, &amp;m_Custom4ColumnToken);</span>
<a href="#l37.146"></a><span id="l37.146" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kNotesColumn, &amp;m_NotesColumnToken);</span>
<a href="#l37.147"></a><span id="l37.147" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kLastModifiedDateColumn, &amp;m_LastModDateColumnToken);</span>
<a href="#l37.148"></a><span id="l37.148" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv,  k2ndEmailProperty, &amp;m_2ndEmailColumnToken);</span>
<a href="#l37.149"></a><span id="l37.149" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kPreferMailFormatProperty, &amp;m_MailFormatColumnToken);</span>
<a href="#l37.150"></a><span id="l37.150" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kPopularityIndexProperty, &amp;m_PopularityIndexColumnToken);</span>
<a href="#l37.151"></a><span id="l37.151" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kAllowRemoteContentProperty, &amp;m_AllowRemoteContentColumnToken);</span>
<a href="#l37.152"></a><span id="l37.152" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kWorkPhoneProperty, &amp;m_WorkPhoneColumnToken);</span>
<a href="#l37.153"></a><span id="l37.153" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kHomePhoneProperty, &amp;m_HomePhoneColumnToken);</span>
<a href="#l37.154"></a><span id="l37.154" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kFaxProperty, &amp;m_FaxColumnToken);</span>
<a href="#l37.155"></a><span id="l37.155" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kPagerProperty, &amp;m_PagerColumnToken);</span>
<a href="#l37.156"></a><span id="l37.156" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kCellularProperty, &amp;m_CellularColumnToken);</span>
<a href="#l37.157"></a><span id="l37.157" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kWorkPhoneTypeProperty, &amp;m_WorkPhoneTypeColumnToken);</span>
<a href="#l37.158"></a><span id="l37.158" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kHomePhoneTypeProperty, &amp;m_HomePhoneTypeColumnToken);</span>
<a href="#l37.159"></a><span id="l37.159" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kFaxTypeProperty, &amp;m_FaxTypeColumnToken);</span>
<a href="#l37.160"></a><span id="l37.160" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kPagerTypeProperty, &amp;m_PagerTypeColumnToken);</span>
<a href="#l37.161"></a><span id="l37.161" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kCellularTypeProperty, &amp;m_CellularTypeColumnToken);</span>
<a href="#l37.162"></a><span id="l37.162" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kHomeAddressProperty, &amp;m_HomeAddressColumnToken);</span>
<a href="#l37.163"></a><span id="l37.163" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kHomeAddress2Property, &amp;m_HomeAddress2ColumnToken);</span>
<a href="#l37.164"></a><span id="l37.164" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kHomeCityProperty, &amp;m_HomeCityColumnToken);</span>
<a href="#l37.165"></a><span id="l37.165" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kHomeStateProperty, &amp;m_HomeStateColumnToken);</span>
<a href="#l37.166"></a><span id="l37.166" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kHomeZipCodeProperty, &amp;m_HomeZipCodeColumnToken);</span>
<a href="#l37.167"></a><span id="l37.167" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kHomeCountryProperty, &amp;m_HomeCountryColumnToken);</span>
<a href="#l37.168"></a><span id="l37.168" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kWorkAddressProperty, &amp;m_WorkAddressColumnToken);</span>
<a href="#l37.169"></a><span id="l37.169" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kWorkAddress2Property, &amp;m_WorkAddress2ColumnToken);</span>
<a href="#l37.170"></a><span id="l37.170" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kWorkCityProperty, &amp;m_WorkCityColumnToken);</span>
<a href="#l37.171"></a><span id="l37.171" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kWorkStateProperty, &amp;m_WorkStateColumnToken);</span>
<a href="#l37.172"></a><span id="l37.172" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kWorkZipCodeProperty, &amp;m_WorkZipCodeColumnToken);</span>
<a href="#l37.173"></a><span id="l37.173" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kWorkCountryProperty, &amp;m_WorkCountryColumnToken);</span>
<a href="#l37.174"></a><span id="l37.174" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kJobTitleProperty, &amp;m_JobTitleColumnToken);</span>
<a href="#l37.175"></a><span id="l37.175" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kDepartmentProperty, &amp;m_DepartmentColumnToken);</span>
<a href="#l37.176"></a><span id="l37.176" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kCompanyProperty, &amp;m_CompanyColumnToken);</span>
<a href="#l37.177"></a><span id="l37.177" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kScreenNameProperty, &amp;m_AimScreenNameColumnToken);</span>
<a href="#l37.178"></a><span id="l37.178" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kAnniversaryYearProperty, &amp;m_AnniversaryYearColumnToken);</span>
<a href="#l37.179"></a><span id="l37.179" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kAnniversaryMonthProperty, &amp;m_AnniversaryMonthColumnToken);</span>
<a href="#l37.180"></a><span id="l37.180" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kAnniversaryDayProperty, &amp;m_AnniversaryDayColumnToken);</span>
<a href="#l37.181"></a><span id="l37.181" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kSpouseNameProperty, &amp;m_SpouseNameColumnToken);</span>
<a href="#l37.182"></a><span id="l37.182" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kFamilyNameProperty, &amp;m_FamilyNameColumnToken);</span>
<a href="#l37.183"></a><span id="l37.183" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kWorkWebPageProperty, &amp;m_WebPage1ColumnToken);</span>
<a href="#l37.184"></a><span id="l37.184" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kHomeWebPageProperty, &amp;m_WebPage2ColumnToken);</span>
<a href="#l37.185"></a><span id="l37.185" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kBirthYearProperty, &amp;m_BirthYearColumnToken);</span>
<a href="#l37.186"></a><span id="l37.186" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kBirthMonthProperty, &amp;m_BirthMonthColumnToken);</span>
<a href="#l37.187"></a><span id="l37.187" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kBirthDayProperty, &amp;m_BirthDayColumnToken);</span>
<a href="#l37.188"></a><span id="l37.188" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kCustom1Property, &amp;m_Custom1ColumnToken);</span>
<a href="#l37.189"></a><span id="l37.189" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kCustom2Property, &amp;m_Custom2ColumnToken);</span>
<a href="#l37.190"></a><span id="l37.190" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kCustom3Property, &amp;m_Custom3ColumnToken);</span>
<a href="#l37.191"></a><span id="l37.191" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kCustom4Property, &amp;m_Custom4ColumnToken);</span>
<a href="#l37.192"></a><span id="l37.192" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kNotesProperty, &amp;m_NotesColumnToken);</span>
<a href="#l37.193"></a><span id="l37.193" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kLastModifiedDateProperty, &amp;m_LastModDateColumnToken);</span>
<a href="#l37.194"></a><span id="l37.194">       m_mdbStore-&gt;StringToToken(m_mdbEnv,  kRecordKeyColumn, &amp;m_RecordKeyColumnToken);</span>
<a href="#l37.195"></a><span id="l37.195">       m_mdbStore-&gt;StringToToken(m_mdbEnv,  kAddressCharSetColumn, &amp;m_AddressCharSetColumnToken);</span>
<a href="#l37.196"></a><span id="l37.196">       m_mdbStore-&gt;StringToToken(m_mdbEnv,  kLastRecordKeyColumn, &amp;m_LastRecordKeyColumnToken);</span>
<a href="#l37.197"></a><span id="l37.197"> </span>
<a href="#l37.198"></a><span id="l37.198">       err = m_mdbStore-&gt;StringToToken(m_mdbEnv, kPabTableKind, &amp;m_PabTableKind);</span>
<a href="#l37.199"></a><span id="l37.199"> </span>
<a href="#l37.200"></a><span id="l37.200">       m_mdbStore-&gt;StringToToken(m_mdbEnv,  kMailListName, &amp;m_ListNameColumnToken);</span>
<a href="#l37.201"></a><span id="l37.201">       m_mdbStore-&gt;StringToToken(m_mdbEnv,  kMailListNickName, &amp;m_ListNickNameColumnToken);</span>
<a href="#l37.202"></a><span id="l37.202" class="difflineat">@@ -1209,205 +1210,64 @@ nsresult nsAddrDatabase::AddRecordKeyCol</span>
<a href="#l37.203"></a><span id="l37.203">     UpdateLastRecordKey();</span>
<a href="#l37.204"></a><span id="l37.204">     return err;</span>
<a href="#l37.205"></a><span id="l37.205">   }</span>
<a href="#l37.206"></a><span id="l37.206">   return NS_ERROR_NULL_POINTER;</span>
<a href="#l37.207"></a><span id="l37.207"> }</span>
<a href="#l37.208"></a><span id="l37.208"> </span>
<a href="#l37.209"></a><span id="l37.209"> nsresult nsAddrDatabase::AddAttributeColumnsToRow(nsIAbCard *card, nsIMdbRow *cardRow)</span>
<a href="#l37.210"></a><span id="l37.210"> {</span>
<a href="#l37.211"></a><span id="l37.211" class="difflineminus">-  nsresult err = NS_OK;</span>
<a href="#l37.212"></a><span id="l37.212" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l37.213"></a><span id="l37.213"> </span>
<a href="#l37.214"></a><span id="l37.214">   if ((!card &amp;&amp; !cardRow) || !m_mdbEnv)</span>
<a href="#l37.215"></a><span id="l37.215">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l37.216"></a><span id="l37.216"> </span>
<a href="#l37.217"></a><span id="l37.217" class="difflineminus">-  mdbOid rowOid, tableOid;</span>
<a href="#l37.218"></a><span id="l37.218" class="difflineminus">-  m_mdbPabTable-&gt;GetOid(m_mdbEnv, &amp;tableOid);</span>
<a href="#l37.219"></a><span id="l37.219" class="difflineplus">+  mdbOid rowOid;</span>
<a href="#l37.220"></a><span id="l37.220">   cardRow-&gt;GetOid(m_mdbEnv, &amp;rowOid);</span>
<a href="#l37.221"></a><span id="l37.221"> </span>
<a href="#l37.222"></a><span id="l37.222" class="difflineminus">-  nsCOMPtr&lt;nsIAbMDBCard&gt; dbcard(do_QueryInterface(card, &amp;err));</span>
<a href="#l37.223"></a><span id="l37.223" class="difflineminus">-  if(NS_SUCCEEDED(err) &amp;&amp; dbcard)</span>
<a href="#l37.224"></a><span id="l37.224" class="difflineminus">-  {</span>
<a href="#l37.225"></a><span id="l37.225" class="difflineminus">-    dbcard-&gt;SetDbTableID(tableOid.mOid_Id);</span>
<a href="#l37.226"></a><span id="l37.226" class="difflineminus">-    dbcard-&gt;SetDbRowID(rowOid.mOid_Id);</span>
<a href="#l37.227"></a><span id="l37.227" class="difflineminus">-  }</span>
<a href="#l37.228"></a><span id="l37.228" class="difflineplus">+  card-&gt;SetPropertyAsUint32(kRowIDProperty, rowOid.mOid_Id);</span>
<a href="#l37.229"></a><span id="l37.229" class="difflineplus">+</span>
<a href="#l37.230"></a><span id="l37.230">   // add the row to the singleton table.</span>
<a href="#l37.231"></a><span id="l37.231">   if (card &amp;&amp; cardRow)</span>
<a href="#l37.232"></a><span id="l37.232">   {</span>
<a href="#l37.233"></a><span id="l37.233" class="difflineminus">-    nsString unicodeStr;</span>
<a href="#l37.234"></a><span id="l37.234" class="difflineminus">-    card-&gt;GetFirstName(unicodeStr);</span>
<a href="#l37.235"></a><span id="l37.235" class="difflineminus">-    AddFirstName(cardRow, NS_ConvertUTF16toUTF8(unicodeStr).get());</span>
<a href="#l37.236"></a><span id="l37.236" class="difflineminus">-</span>
<a href="#l37.237"></a><span id="l37.237" class="difflineminus">-    card-&gt;GetLastName(unicodeStr);</span>
<a href="#l37.238"></a><span id="l37.238" class="difflineminus">-    AddLastName(cardRow, NS_ConvertUTF16toUTF8(unicodeStr).get());</span>
<a href="#l37.239"></a><span id="l37.239" class="difflineminus">-</span>
<a href="#l37.240"></a><span id="l37.240" class="difflineminus">-    card-&gt;GetPhoneticFirstName(unicodeStr);</span>
<a href="#l37.241"></a><span id="l37.241" class="difflineminus">-    AddPhoneticFirstName(cardRow, NS_ConvertUTF16toUTF8(unicodeStr).get());</span>
<a href="#l37.242"></a><span id="l37.242" class="difflineminus">-</span>
<a href="#l37.243"></a><span id="l37.243" class="difflineminus">-    card-&gt;GetPhoneticLastName(unicodeStr);</span>
<a href="#l37.244"></a><span id="l37.244" class="difflineminus">-    AddPhoneticLastName(cardRow, NS_ConvertUTF16toUTF8(unicodeStr).get());</span>
<a href="#l37.245"></a><span id="l37.245" class="difflineminus">-</span>
<a href="#l37.246"></a><span id="l37.246" class="difflineminus">-    card-&gt;GetDisplayName(unicodeStr);</span>
<a href="#l37.247"></a><span id="l37.247" class="difflineminus">-    AddDisplayName(cardRow, NS_ConvertUTF16toUTF8(unicodeStr).get());</span>
<a href="#l37.248"></a><span id="l37.248" class="difflineminus">-</span>
<a href="#l37.249"></a><span id="l37.249" class="difflineminus">-    card-&gt;GetNickName(unicodeStr);</span>
<a href="#l37.250"></a><span id="l37.250" class="difflineminus">-    AddNickName(cardRow, NS_ConvertUTF16toUTF8(unicodeStr).get());</span>
<a href="#l37.251"></a><span id="l37.251" class="difflineminus">-</span>
<a href="#l37.252"></a><span id="l37.252" class="difflineminus">-    card-&gt;GetPrimaryEmail(unicodeStr);</span>
<a href="#l37.253"></a><span id="l37.253" class="difflineminus">-    if (!unicodeStr.IsEmpty())</span>
<a href="#l37.254"></a><span id="l37.254" class="difflineminus">-      AddUnicodeToColumn(cardRow, m_PriEmailColumnToken, m_LowerPriEmailColumnToken, unicodeStr.get());</span>
<a href="#l37.255"></a><span id="l37.255" class="difflineminus">-</span>
<a href="#l37.256"></a><span id="l37.256" class="difflineminus">-    card-&gt;GetSecondEmail(unicodeStr);</span>
<a href="#l37.257"></a><span id="l37.257" class="difflineminus">-    Add2ndEmail(cardRow, NS_ConvertUTF16toUTF8(unicodeStr).get());</span>
<a href="#l37.258"></a><span id="l37.258" class="difflineminus">-</span>
<a href="#l37.259"></a><span id="l37.259" class="difflineminus">-    PRUint32 format = nsIAbPreferMailFormat::unknown;</span>
<a href="#l37.260"></a><span id="l37.260" class="difflineminus">-    card-&gt;GetPreferMailFormat(&amp;format);</span>
<a href="#l37.261"></a><span id="l37.261" class="difflineminus">-    AddPreferMailFormat(cardRow, format);</span>
<a href="#l37.262"></a><span id="l37.262" class="difflineminus">-</span>
<a href="#l37.263"></a><span id="l37.263" class="difflineminus">-    PRUint32 popularityIndex = 0;</span>
<a href="#l37.264"></a><span id="l37.264" class="difflineminus">-    card-&gt;GetPopularityIndex(&amp;popularityIndex);</span>
<a href="#l37.265"></a><span id="l37.265" class="difflineminus">-    AddPopularityIndex(cardRow, popularityIndex);</span>
<a href="#l37.266"></a><span id="l37.266" class="difflineminus">-</span>
<a href="#l37.267"></a><span id="l37.267" class="difflineminus">-    PRBool allowRemoteContent = PR_FALSE;</span>
<a href="#l37.268"></a><span id="l37.268" class="difflineminus">-    card-&gt;GetAllowRemoteContent(&amp;allowRemoteContent);</span>
<a href="#l37.269"></a><span id="l37.269" class="difflineminus">-    AddAllowRemoteContent(cardRow, allowRemoteContent);</span>
<a href="#l37.270"></a><span id="l37.270" class="difflineminus">-</span>
<a href="#l37.271"></a><span id="l37.271" class="difflineminus">-    card-&gt;GetWorkPhone(unicodeStr);</span>
<a href="#l37.272"></a><span id="l37.272" class="difflineminus">-    AddWorkPhone(cardRow, NS_ConvertUTF16toUTF8(unicodeStr).get());</span>
<a href="#l37.273"></a><span id="l37.273" class="difflineminus">-</span>
<a href="#l37.274"></a><span id="l37.274" class="difflineminus">-    card-&gt;GetHomePhone(unicodeStr);</span>
<a href="#l37.275"></a><span id="l37.275" class="difflineminus">-    AddHomePhone(cardRow, NS_ConvertUTF16toUTF8(unicodeStr).get());</span>
<a href="#l37.276"></a><span id="l37.276" class="difflineminus">-</span>
<a href="#l37.277"></a><span id="l37.277" class="difflineminus">-    card-&gt;GetFaxNumber(unicodeStr);</span>
<a href="#l37.278"></a><span id="l37.278" class="difflineminus">-    AddFaxNumber(cardRow, NS_ConvertUTF16toUTF8(unicodeStr).get());</span>
<a href="#l37.279"></a><span id="l37.279" class="difflineminus">-</span>
<a href="#l37.280"></a><span id="l37.280" class="difflineminus">-    card-&gt;GetPagerNumber(unicodeStr);</span>
<a href="#l37.281"></a><span id="l37.281" class="difflineminus">-    AddPagerNumber(cardRow,NS_ConvertUTF16toUTF8(unicodeStr).get());</span>
<a href="#l37.282"></a><span id="l37.282" class="difflineminus">-</span>
<a href="#l37.283"></a><span id="l37.283" class="difflineminus">-    card-&gt;GetCellularNumber(unicodeStr);</span>
<a href="#l37.284"></a><span id="l37.284" class="difflineminus">-    AddCellularNumber(cardRow,NS_ConvertUTF16toUTF8(unicodeStr).get());</span>
<a href="#l37.285"></a><span id="l37.285" class="difflineminus">-</span>
<a href="#l37.286"></a><span id="l37.286" class="difflineminus">-    card-&gt;GetWorkPhoneType(unicodeStr);</span>
<a href="#l37.287"></a><span id="l37.287" class="difflineminus">-    AddWorkPhoneType(cardRow, NS_ConvertUTF16toUTF8(unicodeStr).get());</span>
<a href="#l37.288"></a><span id="l37.288" class="difflineminus">-</span>
<a href="#l37.289"></a><span id="l37.289" class="difflineminus">-    card-&gt;GetHomePhoneType(unicodeStr);</span>
<a href="#l37.290"></a><span id="l37.290" class="difflineminus">-    AddHomePhoneType(cardRow, NS_ConvertUTF16toUTF8(unicodeStr).get());</span>
<a href="#l37.291"></a><span id="l37.291" class="difflineminus">-</span>
<a href="#l37.292"></a><span id="l37.292" class="difflineminus">-    card-&gt;GetFaxNumberType(unicodeStr);</span>
<a href="#l37.293"></a><span id="l37.293" class="difflineminus">-    AddFaxNumberType(cardRow, NS_ConvertUTF16toUTF8(unicodeStr).get());</span>
<a href="#l37.294"></a><span id="l37.294" class="difflineminus">-</span>
<a href="#l37.295"></a><span id="l37.295" class="difflineminus">-    card-&gt;GetPagerNumberType(unicodeStr);</span>
<a href="#l37.296"></a><span id="l37.296" class="difflineminus">-    AddPagerNumberType(cardRow,NS_ConvertUTF16toUTF8(unicodeStr).get());</span>
<a href="#l37.297"></a><span id="l37.297" class="difflineminus">-</span>
<a href="#l37.298"></a><span id="l37.298" class="difflineminus">-    card-&gt;GetCellularNumberType(unicodeStr);</span>
<a href="#l37.299"></a><span id="l37.299" class="difflineminus">-    AddCellularNumberType(cardRow,NS_ConvertUTF16toUTF8(unicodeStr).get());</span>
<a href="#l37.300"></a><span id="l37.300" class="difflineminus">-</span>
<a href="#l37.301"></a><span id="l37.301" class="difflineminus">-    card-&gt;GetHomeAddress(unicodeStr);</span>
<a href="#l37.302"></a><span id="l37.302" class="difflineminus">-    AddHomeAddress(cardRow, NS_ConvertUTF16toUTF8(unicodeStr).get());</span>
<a href="#l37.303"></a><span id="l37.303" class="difflineminus">-</span>
<a href="#l37.304"></a><span id="l37.304" class="difflineminus">-    card-&gt;GetHomeAddress2(unicodeStr);</span>
<a href="#l37.305"></a><span id="l37.305" class="difflineminus">-    AddHomeAddress2(cardRow, NS_ConvertUTF16toUTF8(unicodeStr).get());</span>
<a href="#l37.306"></a><span id="l37.306" class="difflineminus">-</span>
<a href="#l37.307"></a><span id="l37.307" class="difflineminus">-    card-&gt;GetHomeCity(unicodeStr);</span>
<a href="#l37.308"></a><span id="l37.308" class="difflineminus">-    AddHomeCity(cardRow, NS_ConvertUTF16toUTF8(unicodeStr).get());</span>
<a href="#l37.309"></a><span id="l37.309" class="difflineminus">-</span>
<a href="#l37.310"></a><span id="l37.310" class="difflineminus">-    card-&gt;GetHomeState(unicodeStr);</span>
<a href="#l37.311"></a><span id="l37.311" class="difflineminus">-    AddHomeState(cardRow, NS_ConvertUTF16toUTF8(unicodeStr).get());</span>
<a href="#l37.312"></a><span id="l37.312" class="difflineminus">-</span>
<a href="#l37.313"></a><span id="l37.313" class="difflineminus">-    card-&gt;GetHomeZipCode(unicodeStr);</span>
<a href="#l37.314"></a><span id="l37.314" class="difflineminus">-    AddHomeZipCode(cardRow, NS_ConvertUTF16toUTF8(unicodeStr).get());</span>
<a href="#l37.315"></a><span id="l37.315" class="difflineminus">-</span>
<a href="#l37.316"></a><span id="l37.316" class="difflineminus">-    card-&gt;GetHomeCountry(unicodeStr);</span>
<a href="#l37.317"></a><span id="l37.317" class="difflineminus">-    AddHomeCountry(cardRow, NS_ConvertUTF16toUTF8(unicodeStr).get());</span>
<a href="#l37.318"></a><span id="l37.318" class="difflineminus">-</span>
<a href="#l37.319"></a><span id="l37.319" class="difflineminus">-    card-&gt;GetWorkAddress(unicodeStr);</span>
<a href="#l37.320"></a><span id="l37.320" class="difflineminus">-    AddWorkAddress(cardRow, NS_ConvertUTF16toUTF8(unicodeStr).get());</span>
<a href="#l37.321"></a><span id="l37.321" class="difflineminus">-</span>
<a href="#l37.322"></a><span id="l37.322" class="difflineminus">-    card-&gt;GetWorkAddress2(unicodeStr);</span>
<a href="#l37.323"></a><span id="l37.323" class="difflineminus">-    AddWorkAddress2(cardRow, NS_ConvertUTF16toUTF8(unicodeStr).get());</span>
<a href="#l37.324"></a><span id="l37.324" class="difflineminus">-</span>
<a href="#l37.325"></a><span id="l37.325" class="difflineminus">-    card-&gt;GetWorkCity(unicodeStr);</span>
<a href="#l37.326"></a><span id="l37.326" class="difflineminus">-    AddWorkCity(cardRow, NS_ConvertUTF16toUTF8(unicodeStr).get());</span>
<a href="#l37.327"></a><span id="l37.327" class="difflineminus">-</span>
<a href="#l37.328"></a><span id="l37.328" class="difflineminus">-    card-&gt;GetWorkState(unicodeStr);</span>
<a href="#l37.329"></a><span id="l37.329" class="difflineminus">-    AddWorkState(cardRow, NS_ConvertUTF16toUTF8(unicodeStr).get());</span>
<a href="#l37.330"></a><span id="l37.330" class="difflineminus">-</span>
<a href="#l37.331"></a><span id="l37.331" class="difflineminus">-    card-&gt;GetWorkZipCode(unicodeStr);</span>
<a href="#l37.332"></a><span id="l37.332" class="difflineminus">-    AddWorkZipCode(cardRow, NS_ConvertUTF16toUTF8(unicodeStr).get());</span>
<a href="#l37.333"></a><span id="l37.333" class="difflineminus">-</span>
<a href="#l37.334"></a><span id="l37.334" class="difflineminus">-    card-&gt;GetWorkCountry(unicodeStr);</span>
<a href="#l37.335"></a><span id="l37.335" class="difflineminus">-    AddWorkCountry(cardRow, NS_ConvertUTF16toUTF8(unicodeStr).get());</span>
<a href="#l37.336"></a><span id="l37.336" class="difflineminus">-</span>
<a href="#l37.337"></a><span id="l37.337" class="difflineminus">-    card-&gt;GetJobTitle(unicodeStr);</span>
<a href="#l37.338"></a><span id="l37.338" class="difflineminus">-    AddJobTitle(cardRow, NS_ConvertUTF16toUTF8(unicodeStr).get());</span>
<a href="#l37.339"></a><span id="l37.339" class="difflineminus">-</span>
<a href="#l37.340"></a><span id="l37.340" class="difflineminus">-    card-&gt;GetDepartment(unicodeStr);</span>
<a href="#l37.341"></a><span id="l37.341" class="difflineminus">-    AddDepartment(cardRow, NS_ConvertUTF16toUTF8(unicodeStr).get());</span>
<a href="#l37.342"></a><span id="l37.342" class="difflineminus">-</span>
<a href="#l37.343"></a><span id="l37.343" class="difflineminus">-    card-&gt;GetCompany(unicodeStr);</span>
<a href="#l37.344"></a><span id="l37.344" class="difflineminus">-    AddCompany(cardRow, NS_ConvertUTF16toUTF8(unicodeStr).get());</span>
<a href="#l37.345"></a><span id="l37.345" class="difflineminus">-</span>
<a href="#l37.346"></a><span id="l37.346" class="difflineminus">-    // AimScreenName</span>
<a href="#l37.347"></a><span id="l37.347" class="difflineminus">-    card-&gt;GetAimScreenName(unicodeStr);</span>
<a href="#l37.348"></a><span id="l37.348" class="difflineminus">-    AddAimScreenName(cardRow, NS_ConvertUTF16toUTF8(unicodeStr).get());</span>
<a href="#l37.349"></a><span id="l37.349" class="difflineminus">-</span>
<a href="#l37.350"></a><span id="l37.350" class="difflineminus">-    card-&gt;GetAnniversaryYear(unicodeStr);</span>
<a href="#l37.351"></a><span id="l37.351" class="difflineminus">-    AddAnniversaryYear(cardRow, NS_ConvertUTF16toUTF8(unicodeStr).get());</span>
<a href="#l37.352"></a><span id="l37.352" class="difflineminus">-</span>
<a href="#l37.353"></a><span id="l37.353" class="difflineminus">-    card-&gt;GetAnniversaryMonth(unicodeStr);</span>
<a href="#l37.354"></a><span id="l37.354" class="difflineminus">-    AddAnniversaryMonth(cardRow, NS_ConvertUTF16toUTF8(unicodeStr).get());</span>
<a href="#l37.355"></a><span id="l37.355" class="difflineminus">-</span>
<a href="#l37.356"></a><span id="l37.356" class="difflineminus">-    card-&gt;GetAnniversaryDay(unicodeStr);</span>
<a href="#l37.357"></a><span id="l37.357" class="difflineminus">-    AddAnniversaryDay(cardRow, NS_ConvertUTF16toUTF8(unicodeStr).get());</span>
<a href="#l37.358"></a><span id="l37.358" class="difflineminus">-</span>
<a href="#l37.359"></a><span id="l37.359" class="difflineminus">-    card-&gt;GetSpouseName(unicodeStr);</span>
<a href="#l37.360"></a><span id="l37.360" class="difflineminus">-    AddSpouseName(cardRow, NS_ConvertUTF16toUTF8(unicodeStr).get());</span>
<a href="#l37.361"></a><span id="l37.361" class="difflineminus">-</span>
<a href="#l37.362"></a><span id="l37.362" class="difflineminus">-    card-&gt;GetFamilyName(unicodeStr);</span>
<a href="#l37.363"></a><span id="l37.363" class="difflineminus">-    AddFamilyName(cardRow, NS_ConvertUTF16toUTF8(unicodeStr).get());</span>
<a href="#l37.364"></a><span id="l37.364" class="difflineminus">-</span>
<a href="#l37.365"></a><span id="l37.365" class="difflineminus">-    card-&gt;GetDefaultAddress(unicodeStr);</span>
<a href="#l37.366"></a><span id="l37.366" class="difflineminus">-    AddDefaultAddress(cardRow, NS_ConvertUTF16toUTF8(unicodeStr).get());</span>
<a href="#l37.367"></a><span id="l37.367" class="difflineminus">-</span>
<a href="#l37.368"></a><span id="l37.368" class="difflineminus">-    card-&gt;GetCategory(unicodeStr);</span>
<a href="#l37.369"></a><span id="l37.369" class="difflineminus">-    AddCategory(cardRow, NS_ConvertUTF16toUTF8(unicodeStr).get());</span>
<a href="#l37.370"></a><span id="l37.370" class="difflineminus">-</span>
<a href="#l37.371"></a><span id="l37.371" class="difflineminus">-    card-&gt;GetWebPage1(unicodeStr);</span>
<a href="#l37.372"></a><span id="l37.372" class="difflineminus">-    AddWebPage1(cardRow,NS_ConvertUTF16toUTF8(unicodeStr).get());</span>
<a href="#l37.373"></a><span id="l37.373" class="difflineminus">-</span>
<a href="#l37.374"></a><span id="l37.374" class="difflineminus">-    card-&gt;GetWebPage2(unicodeStr);</span>
<a href="#l37.375"></a><span id="l37.375" class="difflineminus">-    AddWebPage2(cardRow, NS_ConvertUTF16toUTF8(unicodeStr).get());</span>
<a href="#l37.376"></a><span id="l37.376" class="difflineminus">-</span>
<a href="#l37.377"></a><span id="l37.377" class="difflineminus">-    card-&gt;GetBirthYear(unicodeStr);</span>
<a href="#l37.378"></a><span id="l37.378" class="difflineminus">-    AddBirthYear(cardRow, NS_ConvertUTF16toUTF8(unicodeStr).get());</span>
<a href="#l37.379"></a><span id="l37.379" class="difflineminus">-</span>
<a href="#l37.380"></a><span id="l37.380" class="difflineminus">-    card-&gt;GetBirthMonth(unicodeStr);</span>
<a href="#l37.381"></a><span id="l37.381" class="difflineminus">-    AddBirthMonth(cardRow, NS_ConvertUTF16toUTF8(unicodeStr).get());</span>
<a href="#l37.382"></a><span id="l37.382" class="difflineminus">-</span>
<a href="#l37.383"></a><span id="l37.383" class="difflineminus">-    card-&gt;GetBirthDay(unicodeStr);</span>
<a href="#l37.384"></a><span id="l37.384" class="difflineminus">-    AddBirthDay(cardRow, NS_ConvertUTF16toUTF8(unicodeStr).get());</span>
<a href="#l37.385"></a><span id="l37.385" class="difflineminus">-</span>
<a href="#l37.386"></a><span id="l37.386" class="difflineminus">-    card-&gt;GetCustom1(unicodeStr);</span>
<a href="#l37.387"></a><span id="l37.387" class="difflineminus">-    AddCustom1(cardRow,NS_ConvertUTF16toUTF8(unicodeStr).get());</span>
<a href="#l37.388"></a><span id="l37.388" class="difflineminus">-</span>
<a href="#l37.389"></a><span id="l37.389" class="difflineminus">-    card-&gt;GetCustom2(unicodeStr);</span>
<a href="#l37.390"></a><span id="l37.390" class="difflineminus">-    AddCustom2(cardRow, NS_ConvertUTF16toUTF8(unicodeStr).get());</span>
<a href="#l37.391"></a><span id="l37.391" class="difflineminus">-</span>
<a href="#l37.392"></a><span id="l37.392" class="difflineminus">-    card-&gt;GetCustom3(unicodeStr);</span>
<a href="#l37.393"></a><span id="l37.393" class="difflineminus">-    AddCustom3(cardRow, NS_ConvertUTF16toUTF8(unicodeStr).get());</span>
<a href="#l37.394"></a><span id="l37.394" class="difflineminus">-</span>
<a href="#l37.395"></a><span id="l37.395" class="difflineminus">-    card-&gt;GetCustom4(unicodeStr);</span>
<a href="#l37.396"></a><span id="l37.396" class="difflineminus">-    AddCustom4(cardRow, NS_ConvertUTF16toUTF8(unicodeStr).get());</span>
<a href="#l37.397"></a><span id="l37.397" class="difflineminus">-</span>
<a href="#l37.398"></a><span id="l37.398" class="difflineminus">-    card-&gt;GetNotes(unicodeStr);</span>
<a href="#l37.399"></a><span id="l37.399" class="difflineminus">-    AddNotes(cardRow, NS_ConvertUTF16toUTF8(unicodeStr).get());</span>
<a href="#l37.400"></a><span id="l37.400" class="difflineminus">-</span>
<a href="#l37.401"></a><span id="l37.401" class="difflineminus">-    PRUint32 lastModDate = 0;</span>
<a href="#l37.402"></a><span id="l37.402" class="difflineminus">-    card-&gt;GetLastModifiedDate(&amp;lastModDate);</span>
<a href="#l37.403"></a><span id="l37.403" class="difflineminus">-    AddIntColumn(cardRow, m_LastModDateColumnToken, lastModDate);</span>
<a href="#l37.404"></a><span id="l37.404" class="difflineplus">+    nsCOMPtr&lt;nsISimpleEnumerator&gt; properties;</span>
<a href="#l37.405"></a><span id="l37.405" class="difflineplus">+    rv = card-&gt;GetProperties(getter_AddRefs(properties));</span>
<a href="#l37.406"></a><span id="l37.406" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l37.407"></a><span id="l37.407" class="difflineplus">+</span>
<a href="#l37.408"></a><span id="l37.408" class="difflineplus">+    PRBool hasMore;</span>
<a href="#l37.409"></a><span id="l37.409" class="difflineplus">+    while (NS_SUCCEEDED(properties-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore)</span>
<a href="#l37.410"></a><span id="l37.410" class="difflineplus">+    {</span>
<a href="#l37.411"></a><span id="l37.411" class="difflineplus">+      nsCOMPtr&lt;nsISupports&gt; next;</span>
<a href="#l37.412"></a><span id="l37.412" class="difflineplus">+      rv = properties-&gt;GetNext(getter_AddRefs(next));</span>
<a href="#l37.413"></a><span id="l37.413" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l37.414"></a><span id="l37.414" class="difflineplus">+</span>
<a href="#l37.415"></a><span id="l37.415" class="difflineplus">+      nsCOMPtr&lt;nsIProperty&gt; prop = do_QueryInterface(next);</span>
<a href="#l37.416"></a><span id="l37.416" class="difflineplus">+      nsAutoString name;</span>
<a href="#l37.417"></a><span id="l37.417" class="difflineplus">+      prop-&gt;GetName(name);</span>
<a href="#l37.418"></a><span id="l37.418" class="difflineplus">+</span>
<a href="#l37.419"></a><span id="l37.419" class="difflineplus">+      nsCOMPtr&lt;nsIVariant&gt; variant;</span>
<a href="#l37.420"></a><span id="l37.420" class="difflineplus">+      prop-&gt;GetValue(getter_AddRefs(variant));</span>
<a href="#l37.421"></a><span id="l37.421" class="difflineplus">+      </span>
<a href="#l37.422"></a><span id="l37.422" class="difflineplus">+      // We can't get as a char * because that messes up UTF8 stuff</span>
<a href="#l37.423"></a><span id="l37.423" class="difflineplus">+      nsCAutoString value;</span>
<a href="#l37.424"></a><span id="l37.424" class="difflineplus">+      variant-&gt;GetAsAUTF8String(value);</span>
<a href="#l37.425"></a><span id="l37.425" class="difflineplus">+</span>
<a href="#l37.426"></a><span id="l37.426" class="difflineplus">+      mdb_token token;</span>
<a href="#l37.427"></a><span id="l37.427" class="difflineplus">+      rv = m_mdbStore-&gt;StringToToken(m_mdbEnv, NS_ConvertUTF16toUTF8(name).get(), &amp;token);</span>
<a href="#l37.428"></a><span id="l37.428" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l37.429"></a><span id="l37.429" class="difflineplus">+ </span>
<a href="#l37.430"></a><span id="l37.430" class="difflineplus">+      rv = AddCharStringColumn(cardRow, token, value.get());</span>
<a href="#l37.431"></a><span id="l37.431" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l37.432"></a><span id="l37.432" class="difflineplus">+    }</span>
<a href="#l37.433"></a><span id="l37.433" class="difflineplus">+</span>
<a href="#l37.434"></a><span id="l37.434" class="difflineplus">+    // Primary email is special: it is stored lowercase as well as in its</span>
<a href="#l37.435"></a><span id="l37.435" class="difflineplus">+    // original format.</span>
<a href="#l37.436"></a><span id="l37.436" class="difflineplus">+    nsAutoString primaryEmail;</span>
<a href="#l37.437"></a><span id="l37.437" class="difflineplus">+    card-&gt;GetPrimaryEmail(primaryEmail);</span>
<a href="#l37.438"></a><span id="l37.438" class="difflineplus">+    AddPrimaryEmail(cardRow, NS_ConvertUTF16toUTF8(primaryEmail).get());</span>
<a href="#l37.439"></a><span id="l37.439">   }</span>
<a href="#l37.440"></a><span id="l37.440"> </span>
<a href="#l37.441"></a><span id="l37.441">   return NS_OK;</span>
<a href="#l37.442"></a><span id="l37.442"> }</span>
<a href="#l37.443"></a><span id="l37.443"> </span>
<a href="#l37.444"></a><span id="l37.444"> NS_IMETHODIMP nsAddrDatabase::CreateNewCardAndAddToDB(nsIAbCard *aNewCard, PRBool aNotify /* = FALSE */, nsIAbDirectory *aParent)</span>
<a href="#l37.445"></a><span id="l37.445"> {</span>
<a href="#l37.446"></a><span id="l37.446">   nsCOMPtr &lt;nsIMdbRow&gt; cardRow;</span>
<a href="#l37.447"></a><span id="l37.447" class="difflineat">@@ -1419,21 +1279,18 @@ NS_IMETHODIMP nsAddrDatabase::CreateNewC</span>
<a href="#l37.448"></a><span id="l37.448">   if (NS_SUCCEEDED(rv) &amp;&amp; cardRow)</span>
<a href="#l37.449"></a><span id="l37.449">   {</span>
<a href="#l37.450"></a><span id="l37.450">     AddAttributeColumnsToRow(aNewCard, cardRow);</span>
<a href="#l37.451"></a><span id="l37.451">     AddRecordKeyColumnToRow(cardRow);</span>
<a href="#l37.452"></a><span id="l37.452"> </span>
<a href="#l37.453"></a><span id="l37.453">     // we need to do this for dnd</span>
<a href="#l37.454"></a><span id="l37.454">     PRUint32 key = 0;</span>
<a href="#l37.455"></a><span id="l37.455">     rv = GetIntColumn(cardRow, m_RecordKeyColumnToken, &amp;key, 0);</span>
<a href="#l37.456"></a><span id="l37.456" class="difflineminus">-    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l37.457"></a><span id="l37.457" class="difflineminus">-      nsCOMPtr&lt;nsIAbMDBCard&gt; dbnewCard = do_QueryInterface(aNewCard);</span>
<a href="#l37.458"></a><span id="l37.458" class="difflineminus">-      if (dbnewCard)</span>
<a href="#l37.459"></a><span id="l37.459" class="difflineminus">-        dbnewCard-&gt;SetKey(key);</span>
<a href="#l37.460"></a><span id="l37.460" class="difflineminus">-    }</span>
<a href="#l37.461"></a><span id="l37.461" class="difflineplus">+    if (NS_SUCCEEDED(rv))</span>
<a href="#l37.462"></a><span id="l37.462" class="difflineplus">+      aNewCard-&gt;SetPropertyAsUint32(kRecordKeyColumn, key);</span>
<a href="#l37.463"></a><span id="l37.463"> </span>
<a href="#l37.464"></a><span id="l37.464">     mdb_err merror = m_mdbPabTable-&gt;AddRow(m_mdbEnv, cardRow);</span>
<a href="#l37.465"></a><span id="l37.465">     if (merror != NS_OK) return NS_ERROR_FAILURE;</span>
<a href="#l37.466"></a><span id="l37.466"> </span>
<a href="#l37.467"></a><span id="l37.467">   }</span>
<a href="#l37.468"></a><span id="l37.468">   else</span>
<a href="#l37.469"></a><span id="l37.469">     return rv;</span>
<a href="#l37.470"></a><span id="l37.470"> </span>
<a href="#l37.471"></a><span id="l37.471" class="difflineat">@@ -1522,17 +1379,17 @@ NS_IMETHODIMP nsAddrDatabase::AddListCar</span>
<a href="#l37.472"></a><span id="l37.472">   nsresult    err = NS_OK;</span>
<a href="#l37.473"></a><span id="l37.473">   nsString email;</span>
<a href="#l37.474"></a><span id="l37.474">   aPCard-&gt;GetPrimaryEmail(email);</span>
<a href="#l37.475"></a><span id="l37.475">   if (!email.IsEmpty())</span>
<a href="#l37.476"></a><span id="l37.476">   {</span>
<a href="#l37.477"></a><span id="l37.477">     nsIMdbRow    *pCardRow = nsnull;</span>
<a href="#l37.478"></a><span id="l37.478">     // Please DO NOT change the 3rd param of GetRowFromAttribute() call to</span>
<a href="#l37.479"></a><span id="l37.479">     // PR_TRUE (ie, case insensitive) without reading bugs #128535 and #121478.</span>
<a href="#l37.480"></a><span id="l37.480" class="difflineminus">-    err = GetRowFromAttribute(kPriEmailColumn, NS_ConvertUTF16toUTF8(email),</span>
<a href="#l37.481"></a><span id="l37.481" class="difflineplus">+    err = GetRowFromAttribute(kPriEmailProperty, NS_ConvertUTF16toUTF8(email),</span>
<a href="#l37.482"></a><span id="l37.482">                               PR_FALSE /* retain case */, &amp;pCardRow);</span>
<a href="#l37.483"></a><span id="l37.483">     PRBool cardWasAdded = PR_FALSE;</span>
<a href="#l37.484"></a><span id="l37.484">     if (NS_FAILED(err) || !pCardRow)</span>
<a href="#l37.485"></a><span id="l37.485">     {</span>
<a href="#l37.486"></a><span id="l37.486">       //New Email, then add a new row with this email</span>
<a href="#l37.487"></a><span id="l37.487">       err  = GetNewRow(&amp;pCardRow);</span>
<a href="#l37.488"></a><span id="l37.488"> </span>
<a href="#l37.489"></a><span id="l37.489">       if (NS_SUCCEEDED(err) &amp;&amp; pCardRow)</span>
<a href="#l37.490"></a><span id="l37.490" class="difflineat">@@ -1782,21 +1639,19 @@ NS_IMETHODIMP nsAddrDatabase::DeleteCard</span>
<a href="#l37.491"></a><span id="l37.491">   aCard-&gt;GetIsMailList(&amp;bIsMailList);</span>
<a href="#l37.492"></a><span id="l37.492"> </span>
<a href="#l37.493"></a><span id="l37.493">   // get the right row</span>
<a href="#l37.494"></a><span id="l37.494">   nsIMdbRow* pCardRow = nsnull;</span>
<a href="#l37.495"></a><span id="l37.495">   mdbOid rowOid;</span>
<a href="#l37.496"></a><span id="l37.496"> </span>
<a href="#l37.497"></a><span id="l37.497">   rowOid.mOid_Scope = bIsMailList ? m_ListRowScopeToken : m_CardRowScopeToken;</span>
<a href="#l37.498"></a><span id="l37.498"> </span>
<a href="#l37.499"></a><span id="l37.499" class="difflineminus">-  nsCOMPtr&lt;nsIAbMDBCard&gt; dbcard(do_QueryInterface(aCard, &amp;err));</span>
<a href="#l37.500"></a><span id="l37.500" class="difflineplus">+  err = aCard-&gt;GetPropertyAsUint32(kRowIDProperty, &amp;rowOid.mOid_Id);</span>
<a href="#l37.501"></a><span id="l37.501">   NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l37.502"></a><span id="l37.502"> </span>
<a href="#l37.503"></a><span id="l37.503" class="difflineminus">-  dbcard-&gt;GetDbRowID((PRUint32*)&amp;rowOid.mOid_Id);</span>
<a href="#l37.504"></a><span id="l37.504" class="difflineminus">-</span>
<a href="#l37.505"></a><span id="l37.505">   err = m_mdbStore-&gt;GetRow(m_mdbEnv, &amp;rowOid, &amp;pCardRow);</span>
<a href="#l37.506"></a><span id="l37.506">   NS_ENSURE_SUCCESS(err,err);</span>
<a href="#l37.507"></a><span id="l37.507">   if (!pCardRow)</span>
<a href="#l37.508"></a><span id="l37.508">     return NS_OK;</span>
<a href="#l37.509"></a><span id="l37.509"> </span>
<a href="#l37.510"></a><span id="l37.510">   // Add the deleted card to the deletedcards table</span>
<a href="#l37.511"></a><span id="l37.511">   nsCOMPtr &lt;nsIMdbRow&gt; cardRow;</span>
<a href="#l37.512"></a><span id="l37.512">   AddRowToDeletedCardsTable(aCard, getter_AddRefs(cardRow));</span>
<a href="#l37.513"></a><span id="l37.513" class="difflineat">@@ -1889,20 +1744,19 @@ NS_IMETHODIMP nsAddrDatabase::DeleteCard</span>
<a href="#l37.514"></a><span id="l37.514"> </span>
<a href="#l37.515"></a><span id="l37.515">   err = m_mdbStore-&gt;GetRow(m_mdbEnv, &amp;listRowOid, &amp;pListRow);</span>
<a href="#l37.516"></a><span id="l37.516">   NS_ENSURE_SUCCESS(err,err);</span>
<a href="#l37.517"></a><span id="l37.517">   if (!pListRow)</span>
<a href="#l37.518"></a><span id="l37.518">     return NS_OK;</span>
<a href="#l37.519"></a><span id="l37.519"> </span>
<a href="#l37.520"></a><span id="l37.520">   PRUint32 cardRowID;</span>
<a href="#l37.521"></a><span id="l37.521"> </span>
<a href="#l37.522"></a><span id="l37.522" class="difflineminus">-  nsCOMPtr&lt;nsIAbMDBCard&gt; dbcard(do_QueryInterface(card, &amp;err));</span>
<a href="#l37.523"></a><span id="l37.523" class="difflineminus">-  if(NS_FAILED(err) || !dbcard)</span>
<a href="#l37.524"></a><span id="l37.524" class="difflineplus">+  err = card-&gt;GetPropertyAsUint32(kRowIDProperty, &amp;cardRowID);</span>
<a href="#l37.525"></a><span id="l37.525" class="difflineplus">+  if (NS_FAILED(err))</span>
<a href="#l37.526"></a><span id="l37.526">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l37.527"></a><span id="l37.527" class="difflineminus">-  dbcard-&gt;GetDbRowID(&amp;cardRowID);</span>
<a href="#l37.528"></a><span id="l37.528"> </span>
<a href="#l37.529"></a><span id="l37.529">   err = DeleteCardFromListRow(pListRow, cardRowID);</span>
<a href="#l37.530"></a><span id="l37.530">   if (NS_SUCCEEDED(err) &amp;&amp; aNotify) {</span>
<a href="#l37.531"></a><span id="l37.531">     NotifyCardEntryChange(AB_NotifyDeleted, card, mailList);</span>
<a href="#l37.532"></a><span id="l37.532">   }</span>
<a href="#l37.533"></a><span id="l37.533">   NS_RELEASE(pListRow);</span>
<a href="#l37.534"></a><span id="l37.534">   return NS_OK;</span>
<a href="#l37.535"></a><span id="l37.535"> }</span>
<a href="#l37.536"></a><span id="l37.536" class="difflineat">@@ -1916,21 +1770,19 @@ NS_IMETHODIMP nsAddrDatabase::SetCardVal</span>
<a href="#l37.537"></a><span id="l37.537">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l37.538"></a><span id="l37.538"> </span>
<a href="#l37.539"></a><span id="l37.539">   nsresult rv = NS_OK;</span>
<a href="#l37.540"></a><span id="l37.540"> </span>
<a href="#l37.541"></a><span id="l37.541">   nsCOMPtr &lt;nsIMdbRow&gt; cardRow;</span>
<a href="#l37.542"></a><span id="l37.542">   mdbOid rowOid;</span>
<a href="#l37.543"></a><span id="l37.543">   rowOid.mOid_Scope = m_CardRowScopeToken;</span>
<a href="#l37.544"></a><span id="l37.544"> </span>
<a href="#l37.545"></a><span id="l37.545" class="difflineminus">-  // XXX todo</span>
<a href="#l37.546"></a><span id="l37.546" class="difflineminus">-  // it might be that the caller always has a nsIAbMDBCard</span>
<a href="#l37.547"></a><span id="l37.547" class="difflineminus">-  nsCOMPtr&lt;nsIAbMDBCard&gt; dbcard = do_QueryInterface(card, &amp;rv);</span>
<a href="#l37.548"></a><span id="l37.548" class="difflineplus">+  // it might be that the caller always has a nsAbMDBCard</span>
<a href="#l37.549"></a><span id="l37.549" class="difflineplus">+  rv = card-&gt;GetPropertyAsUint32(kRowIDProperty, &amp;rowOid.mOid_Id);</span>
<a href="#l37.550"></a><span id="l37.550">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l37.551"></a><span id="l37.551" class="difflineminus">-  dbcard-&gt;GetDbRowID((PRUint32*)&amp;rowOid.mOid_Id);</span>
<a href="#l37.552"></a><span id="l37.552"> </span>
<a href="#l37.553"></a><span id="l37.553">   rv = m_mdbStore-&gt;GetRow(m_mdbEnv, &amp;rowOid, getter_AddRefs(cardRow));</span>
<a href="#l37.554"></a><span id="l37.554">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l37.555"></a><span id="l37.555"> </span>
<a href="#l37.556"></a><span id="l37.556">   if (!cardRow)</span>
<a href="#l37.557"></a><span id="l37.557">     return NS_OK;</span>
<a href="#l37.558"></a><span id="l37.558"> </span>
<a href="#l37.559"></a><span id="l37.559">   mdb_token token;</span>
<a href="#l37.560"></a><span id="l37.560" class="difflineat">@@ -1946,21 +1798,19 @@ NS_IMETHODIMP nsAddrDatabase::GetCardVal</span>
<a href="#l37.561"></a><span id="l37.561">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l37.562"></a><span id="l37.562"> </span>
<a href="#l37.563"></a><span id="l37.563">   nsresult rv = NS_OK;</span>
<a href="#l37.564"></a><span id="l37.564"> </span>
<a href="#l37.565"></a><span id="l37.565">   nsCOMPtr &lt;nsIMdbRow&gt; cardRow;</span>
<a href="#l37.566"></a><span id="l37.566">   mdbOid rowOid;</span>
<a href="#l37.567"></a><span id="l37.567">   rowOid.mOid_Scope = m_CardRowScopeToken;</span>
<a href="#l37.568"></a><span id="l37.568"> </span>
<a href="#l37.569"></a><span id="l37.569" class="difflineminus">-  // XXX todo</span>
<a href="#l37.570"></a><span id="l37.570" class="difflineminus">-  // it might be that the caller always has a nsIAbMDBCard</span>
<a href="#l37.571"></a><span id="l37.571" class="difflineminus">-  nsCOMPtr&lt;nsIAbMDBCard&gt; dbcard = do_QueryInterface(card, &amp;rv);</span>
<a href="#l37.572"></a><span id="l37.572" class="difflineplus">+  // it might be that the caller always has a nsAbMDBCard</span>
<a href="#l37.573"></a><span id="l37.573" class="difflineplus">+  rv = card-&gt;GetPropertyAsUint32(kRowIDProperty, &amp;rowOid.mOid_Id);</span>
<a href="#l37.574"></a><span id="l37.574">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l37.575"></a><span id="l37.575" class="difflineminus">-  dbcard-&gt;GetDbRowID((PRUint32*)&amp;rowOid.mOid_Id);</span>
<a href="#l37.576"></a><span id="l37.576"> </span>
<a href="#l37.577"></a><span id="l37.577">   rv = m_mdbStore-&gt;GetRow(m_mdbEnv, &amp;rowOid, getter_AddRefs(cardRow));</span>
<a href="#l37.578"></a><span id="l37.578">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l37.579"></a><span id="l37.579"> </span>
<a href="#l37.580"></a><span id="l37.580">   if (!cardRow) {</span>
<a href="#l37.581"></a><span id="l37.581">     *value = nsnull;</span>
<a href="#l37.582"></a><span id="l37.582">     // this can happen when adding cards when editing a mailing list</span>
<a href="#l37.583"></a><span id="l37.583">     return NS_OK;</span>
<a href="#l37.584"></a><span id="l37.584" class="difflineat">@@ -2095,20 +1945,19 @@ NS_IMETHODIMP nsAddrDatabase::EditCard(n</span>
<a href="#l37.585"></a><span id="l37.585"> </span>
<a href="#l37.586"></a><span id="l37.586">   nsCOMPtr &lt;nsIMdbRow&gt; cardRow;</span>
<a href="#l37.587"></a><span id="l37.587">   mdbOid rowOid;</span>
<a href="#l37.588"></a><span id="l37.588">   rowOid.mOid_Scope = m_CardRowScopeToken;</span>
<a href="#l37.589"></a><span id="l37.589"> </span>
<a href="#l37.590"></a><span id="l37.590">   PRUint32 nowInSeconds;</span>
<a href="#l37.591"></a><span id="l37.591">   PRTime now = PR_Now();</span>
<a href="#l37.592"></a><span id="l37.592">   PRTime2Seconds(now, &amp;nowInSeconds);</span>
<a href="#l37.593"></a><span id="l37.593" class="difflineminus">-  aCard-&gt;SetLastModifiedDate(nowInSeconds);</span>
<a href="#l37.594"></a><span id="l37.594" class="difflineminus">-  nsCOMPtr&lt;nsIAbMDBCard&gt; dbcard(do_QueryInterface(aCard, &amp;err));</span>
<a href="#l37.595"></a><span id="l37.595" class="difflineplus">+  aCard-&gt;SetPropertyAsUint32(kLastModifiedDateProperty, nowInSeconds);</span>
<a href="#l37.596"></a><span id="l37.596" class="difflineplus">+  err = aCard-&gt;GetPropertyAsUint32(kRowIDProperty, &amp;rowOid.mOid_Id);</span>
<a href="#l37.597"></a><span id="l37.597">   NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l37.598"></a><span id="l37.598" class="difflineminus">-  dbcard-&gt;GetDbRowID((PRUint32*)&amp;rowOid.mOid_Id);</span>
<a href="#l37.599"></a><span id="l37.599"> </span>
<a href="#l37.600"></a><span id="l37.600">   err = m_mdbStore-&gt;GetRow(m_mdbEnv, &amp;rowOid, getter_AddRefs(cardRow));</span>
<a href="#l37.601"></a><span id="l37.601">   NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l37.602"></a><span id="l37.602"> </span>
<a href="#l37.603"></a><span id="l37.603">   if (!cardRow)</span>
<a href="#l37.604"></a><span id="l37.604">     return NS_OK;</span>
<a href="#l37.605"></a><span id="l37.605"> </span>
<a href="#l37.606"></a><span id="l37.606">   err = AddAttributeColumnsToRow(aCard, cardRow);</span>
<a href="#l37.607"></a><span id="l37.607" class="difflineat">@@ -2132,19 +1981,18 @@ NS_IMETHODIMP nsAddrDatabase::ContainsCa</span>
<a href="#l37.608"></a><span id="l37.608"> </span>
<a href="#l37.609"></a><span id="l37.609">     card-&gt;GetIsMailList(&amp;bIsMailList);</span>
<a href="#l37.610"></a><span id="l37.610"> </span>
<a href="#l37.611"></a><span id="l37.611">     if (bIsMailList)</span>
<a href="#l37.612"></a><span id="l37.612">         rowOid.mOid_Scope = m_ListRowScopeToken;</span>
<a href="#l37.613"></a><span id="l37.613">     else</span>
<a href="#l37.614"></a><span id="l37.614">         rowOid.mOid_Scope = m_CardRowScopeToken;</span>
<a href="#l37.615"></a><span id="l37.615"> </span>
<a href="#l37.616"></a><span id="l37.616" class="difflineminus">-    nsCOMPtr&lt;nsIAbMDBCard&gt; dbcard(do_QueryInterface(card, &amp;err));</span>
<a href="#l37.617"></a><span id="l37.617" class="difflineplus">+    err = card-&gt;GetPropertyAsUint32(kRowIDProperty, &amp;rowOid.mOid_Id);</span>
<a href="#l37.618"></a><span id="l37.618">     NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l37.619"></a><span id="l37.619" class="difflineminus">-    dbcard-&gt;GetDbRowID((PRUint32*)&amp;rowOid.mOid_Id);</span>
<a href="#l37.620"></a><span id="l37.620"> </span>
<a href="#l37.621"></a><span id="l37.621">     err = m_mdbPabTable-&gt;HasOid(m_mdbEnv, &amp;rowOid, &amp;hasOid);</span>
<a href="#l37.622"></a><span id="l37.622">     if (NS_SUCCEEDED(err))</span>
<a href="#l37.623"></a><span id="l37.623">     {</span>
<a href="#l37.624"></a><span id="l37.624">         *hasCard = hasOid;</span>
<a href="#l37.625"></a><span id="l37.625">     }</span>
<a href="#l37.626"></a><span id="l37.626"> </span>
<a href="#l37.627"></a><span id="l37.627">     return err;</span>
<a href="#l37.628"></a><span id="l37.628" class="difflineat">@@ -2277,17 +2125,17 @@ NS_IMETHODIMP nsAddrDatabase::AddLdifLis</span>
<a href="#l37.629"></a><span id="l37.629">   nsCAutoString valueString(value);</span>
<a href="#l37.630"></a><span id="l37.630">   nsCAutoString email;</span>
<a href="#l37.631"></a><span id="l37.631">   PRInt32 emailPos = valueString.Find(&quot;mail=&quot;);</span>
<a href="#l37.632"></a><span id="l37.632">   emailPos += strlen(&quot;mail=&quot;);</span>
<a href="#l37.633"></a><span id="l37.633">   email = Substring(valueString, emailPos);</span>
<a href="#l37.634"></a><span id="l37.634">   nsCOMPtr &lt;nsIMdbRow&gt; cardRow;</span>
<a href="#l37.635"></a><span id="l37.635">   // Please DO NOT change the 3rd param of GetRowFromAttribute() call to</span>
<a href="#l37.636"></a><span id="l37.636">   // PR_TRUE (ie, case insensitive) without reading bugs #128535 and #121478.</span>
<a href="#l37.637"></a><span id="l37.637" class="difflineminus">-  nsresult rv = GetRowFromAttribute(kPriEmailColumn, email, PR_FALSE /* retain case */,</span>
<a href="#l37.638"></a><span id="l37.638" class="difflineplus">+  nsresult rv = GetRowFromAttribute(kPriEmailProperty, email, PR_FALSE /* retain case */,</span>
<a href="#l37.639"></a><span id="l37.639">                                     getter_AddRefs(cardRow));</span>
<a href="#l37.640"></a><span id="l37.640">   if (NS_SUCCEEDED(rv) &amp;&amp; cardRow)</span>
<a href="#l37.641"></a><span id="l37.641">   {</span>
<a href="#l37.642"></a><span id="l37.642">     mdbOid outOid;</span>
<a href="#l37.643"></a><span id="l37.643">     mdb_id rowID = 0;</span>
<a href="#l37.644"></a><span id="l37.644">     if (cardRow-&gt;GetOid(m_mdbEnv, &amp;outOid) == NS_OK)</span>
<a href="#l37.645"></a><span id="l37.645">       rowID = outOid.mOid_Id;</span>
<a href="#l37.646"></a><span id="l37.646"> </span>
<a href="#l37.647"></a><span id="l37.647" class="difflineat">@@ -2532,335 +2380,64 @@ nsresult nsAddrDatabase::AddLowercaseCol</span>
<a href="#l37.648"></a><span id="l37.648">     ToLowerCase(newUnicodeString);</span>
<a href="#l37.649"></a><span id="l37.649">     rv = AddCharStringColumn(row, columnToken, NS_ConvertUTF16toUTF8(newUnicodeString).get());</span>
<a href="#l37.650"></a><span id="l37.650">   }</span>
<a href="#l37.651"></a><span id="l37.651">   return rv;</span>
<a href="#l37.652"></a><span id="l37.652"> }</span>
<a href="#l37.653"></a><span id="l37.653"> </span>
<a href="#l37.654"></a><span id="l37.654"> NS_IMETHODIMP nsAddrDatabase::InitCardFromRow(nsIAbCard *newCard, nsIMdbRow* cardRow)</span>
<a href="#l37.655"></a><span id="l37.655"> {</span>
<a href="#l37.656"></a><span id="l37.656" class="difflineminus">-    nsresult    err = NS_OK;</span>
<a href="#l37.657"></a><span id="l37.657" class="difflineminus">-    if (!newCard || !cardRow)</span>
<a href="#l37.658"></a><span id="l37.658" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l37.659"></a><span id="l37.659" class="difflineminus">-</span>
<a href="#l37.660"></a><span id="l37.660" class="difflineminus">-  nsAutoString tempString;</span>
<a href="#l37.661"></a><span id="l37.661" class="difflineminus">-</span>
<a href="#l37.662"></a><span id="l37.662" class="difflineminus">-  // FIX ME</span>
<a href="#l37.663"></a><span id="l37.663" class="difflineminus">-  // there is no reason to set / copy all these attributes on the card, when we'll never even</span>
<a href="#l37.664"></a><span id="l37.664" class="difflineminus">-  // ask for them.</span>
<a href="#l37.665"></a><span id="l37.665" class="difflineminus">-    err = GetStringColumn(cardRow, m_FirstNameColumnToken, tempString);</span>
<a href="#l37.666"></a><span id="l37.666" class="difflineminus">-    if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty())</span>
<a href="#l37.667"></a><span id="l37.667" class="difflineminus">-    {</span>
<a href="#l37.668"></a><span id="l37.668" class="difflineminus">-        newCard-&gt;SetFirstName(tempString);</span>
<a href="#l37.669"></a><span id="l37.669" class="difflineminus">-    }</span>
<a href="#l37.670"></a><span id="l37.670" class="difflineminus">-</span>
<a href="#l37.671"></a><span id="l37.671" class="difflineminus">-    err = GetStringColumn(cardRow, m_LastNameColumnToken, tempString);</span>
<a href="#l37.672"></a><span id="l37.672" class="difflineminus">-    if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty())</span>
<a href="#l37.673"></a><span id="l37.673" class="difflineminus">-    {</span>
<a href="#l37.674"></a><span id="l37.674" class="difflineminus">-        newCard-&gt;SetLastName(tempString);</span>
<a href="#l37.675"></a><span id="l37.675" class="difflineminus">-    }</span>
<a href="#l37.676"></a><span id="l37.676" class="difflineminus">-</span>
<a href="#l37.677"></a><span id="l37.677" class="difflineminus">-    err = GetStringColumn(cardRow, m_PhoneticFirstNameColumnToken, tempString);</span>
<a href="#l37.678"></a><span id="l37.678" class="difflineminus">-    if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty())</span>
<a href="#l37.679"></a><span id="l37.679" class="difflineminus">-    {</span>
<a href="#l37.680"></a><span id="l37.680" class="difflineminus">-        newCard-&gt;SetPhoneticFirstName(tempString);</span>
<a href="#l37.681"></a><span id="l37.681" class="difflineminus">-    }</span>
<a href="#l37.682"></a><span id="l37.682" class="difflineminus">-</span>
<a href="#l37.683"></a><span id="l37.683" class="difflineminus">-    err = GetStringColumn(cardRow, m_PhoneticLastNameColumnToken, tempString);</span>
<a href="#l37.684"></a><span id="l37.684" class="difflineminus">-    if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty())</span>
<a href="#l37.685"></a><span id="l37.685" class="difflineminus">-    {</span>
<a href="#l37.686"></a><span id="l37.686" class="difflineminus">-        newCard-&gt;SetPhoneticLastName(tempString);</span>
<a href="#l37.687"></a><span id="l37.687" class="difflineminus">-    }</span>
<a href="#l37.688"></a><span id="l37.688" class="difflineminus">-</span>
<a href="#l37.689"></a><span id="l37.689" class="difflineminus">-    err = GetStringColumn(cardRow, m_DisplayNameColumnToken, tempString);</span>
<a href="#l37.690"></a><span id="l37.690" class="difflineminus">-    if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty())</span>
<a href="#l37.691"></a><span id="l37.691" class="difflineminus">-    {</span>
<a href="#l37.692"></a><span id="l37.692" class="difflineminus">-        newCard-&gt;SetDisplayName(tempString);</span>
<a href="#l37.693"></a><span id="l37.693" class="difflineminus">-    }</span>
<a href="#l37.694"></a><span id="l37.694" class="difflineminus">-</span>
<a href="#l37.695"></a><span id="l37.695" class="difflineminus">-    err = GetStringColumn(cardRow, m_NickNameColumnToken, tempString);</span>
<a href="#l37.696"></a><span id="l37.696" class="difflineminus">-    if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty())</span>
<a href="#l37.697"></a><span id="l37.697" class="difflineminus">-    {</span>
<a href="#l37.698"></a><span id="l37.698" class="difflineminus">-        newCard-&gt;SetNickName(tempString);</span>
<a href="#l37.699"></a><span id="l37.699" class="difflineminus">-    }</span>
<a href="#l37.700"></a><span id="l37.700" class="difflineminus">-</span>
<a href="#l37.701"></a><span id="l37.701" class="difflineminus">-    err = GetStringColumn(cardRow, m_PriEmailColumnToken, tempString);</span>
<a href="#l37.702"></a><span id="l37.702" class="difflineminus">-    if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty())</span>
<a href="#l37.703"></a><span id="l37.703" class="difflineminus">-    {</span>
<a href="#l37.704"></a><span id="l37.704" class="difflineminus">-        newCard-&gt;SetPrimaryEmail(tempString);</span>
<a href="#l37.705"></a><span id="l37.705" class="difflineminus">-    }</span>
<a href="#l37.706"></a><span id="l37.706" class="difflineminus">-</span>
<a href="#l37.707"></a><span id="l37.707" class="difflineminus">-    err = GetStringColumn(cardRow, m_2ndEmailColumnToken, tempString);</span>
<a href="#l37.708"></a><span id="l37.708" class="difflineminus">-    if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty())</span>
<a href="#l37.709"></a><span id="l37.709" class="difflineminus">-    {</span>
<a href="#l37.710"></a><span id="l37.710" class="difflineminus">-        newCard-&gt;SetSecondEmail(tempString);</span>
<a href="#l37.711"></a><span id="l37.711" class="difflineminus">-    }</span>
<a href="#l37.712"></a><span id="l37.712" class="difflineminus">-</span>
<a href="#l37.713"></a><span id="l37.713" class="difflineminus">-    PRUint32 format = nsIAbPreferMailFormat::unknown;</span>
<a href="#l37.714"></a><span id="l37.714" class="difflineminus">-    err = GetIntColumn(cardRow, m_MailFormatColumnToken, &amp;format, 0);</span>
<a href="#l37.715"></a><span id="l37.715" class="difflineminus">-    if (NS_SUCCEEDED(err))</span>
<a href="#l37.716"></a><span id="l37.716" class="difflineminus">-        newCard-&gt;SetPreferMailFormat(format);</span>
<a href="#l37.717"></a><span id="l37.717" class="difflineminus">-</span>
<a href="#l37.718"></a><span id="l37.718" class="difflineminus">-    PRUint32 popularityIndex = 0;</span>
<a href="#l37.719"></a><span id="l37.719" class="difflineminus">-    err = GetIntColumn(cardRow, m_PopularityIndexColumnToken, &amp;popularityIndex, 0);</span>
<a href="#l37.720"></a><span id="l37.720" class="difflineminus">-    if (NS_SUCCEEDED(err))</span>
<a href="#l37.721"></a><span id="l37.721" class="difflineminus">-        newCard-&gt;SetPopularityIndex(popularityIndex);</span>
<a href="#l37.722"></a><span id="l37.722" class="difflineminus">-</span>
<a href="#l37.723"></a><span id="l37.723" class="difflineminus">-    PRBool allowRemoteContent;</span>
<a href="#l37.724"></a><span id="l37.724" class="difflineminus">-    err = GetBoolColumn(cardRow, m_AllowRemoteContentColumnToken, &amp;allowRemoteContent);</span>
<a href="#l37.725"></a><span id="l37.725" class="difflineminus">-    if (NS_SUCCEEDED(err))</span>
<a href="#l37.726"></a><span id="l37.726" class="difflineminus">-        newCard-&gt;SetAllowRemoteContent(allowRemoteContent);</span>
<a href="#l37.727"></a><span id="l37.727" class="difflineminus">-</span>
<a href="#l37.728"></a><span id="l37.728" class="difflineminus">-    err = GetStringColumn(cardRow, m_WorkPhoneColumnToken, tempString);</span>
<a href="#l37.729"></a><span id="l37.729" class="difflineminus">-    if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty())</span>
<a href="#l37.730"></a><span id="l37.730" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l37.731"></a><span id="l37.731" class="difflineplus">+  if (!newCard || !cardRow || !m_mdbEnv)</span>
<a href="#l37.732"></a><span id="l37.732" class="difflineplus">+    return NS_ERROR_NULL_POINTER;</span>
<a href="#l37.733"></a><span id="l37.733" class="difflineplus">+</span>
<a href="#l37.734"></a><span id="l37.734" class="difflineplus">+  nsCOMPtr&lt;nsIMdbRowCellCursor&gt; cursor;</span>
<a href="#l37.735"></a><span id="l37.735" class="difflineplus">+  nsCOMPtr&lt;nsIMdbCell&gt; cell;</span>
<a href="#l37.736"></a><span id="l37.736" class="difflineplus">+</span>
<a href="#l37.737"></a><span id="l37.737" class="difflineplus">+  rv = cardRow-&gt;GetRowCellCursor(m_mdbEnv, -1, getter_AddRefs(cursor));</span>
<a href="#l37.738"></a><span id="l37.738" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l37.739"></a><span id="l37.739" class="difflineplus">+</span>
<a href="#l37.740"></a><span id="l37.740" class="difflineplus">+  mdb_column columnNumber;</span>
<a href="#l37.741"></a><span id="l37.741" class="difflineplus">+  char columnName[100];</span>
<a href="#l37.742"></a><span id="l37.742" class="difflineplus">+  struct mdbYarn colYarn = {columnName, 0, sizeof(columnName), 0, 0, nsnull};</span>
<a href="#l37.743"></a><span id="l37.743" class="difflineplus">+  struct mdbYarn cellYarn;</span>
<a href="#l37.744"></a><span id="l37.744" class="difflineplus">+</span>
<a href="#l37.745"></a><span id="l37.745" class="difflineplus">+  do</span>
<a href="#l37.746"></a><span id="l37.746" class="difflineplus">+  {</span>
<a href="#l37.747"></a><span id="l37.747" class="difflineplus">+    rv = cursor-&gt;NextCell(m_mdbEnv, getter_AddRefs(cell), &amp;columnNumber, nsnull);</span>
<a href="#l37.748"></a><span id="l37.748" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l37.749"></a><span id="l37.749" class="difflineplus">+</span>
<a href="#l37.750"></a><span id="l37.750" class="difflineplus">+    if (!cell)</span>
<a href="#l37.751"></a><span id="l37.751" class="difflineplus">+      break;</span>
<a href="#l37.752"></a><span id="l37.752" class="difflineplus">+</span>
<a href="#l37.753"></a><span id="l37.753" class="difflineplus">+    // Get the value of the cell</span>
<a href="#l37.754"></a><span id="l37.754" class="difflineplus">+    cell-&gt;AliasYarn(m_mdbEnv, &amp;cellYarn);</span>
<a href="#l37.755"></a><span id="l37.755" class="difflineplus">+    NS_ConvertUTF8toUTF16 value(static_cast&lt;const char*&gt;(cellYarn.mYarn_Buf),</span>
<a href="#l37.756"></a><span id="l37.756" class="difflineplus">+        cellYarn.mYarn_Fill);</span>
<a href="#l37.757"></a><span id="l37.757" class="difflineplus">+</span>
<a href="#l37.758"></a><span id="l37.758" class="difflineplus">+    if (!value.IsEmpty())</span>
<a href="#l37.759"></a><span id="l37.759">     {</span>
<a href="#l37.760"></a><span id="l37.760" class="difflineminus">-        newCard-&gt;SetWorkPhone(tempString);</span>
<a href="#l37.761"></a><span id="l37.761" class="difflineminus">-    }</span>
<a href="#l37.762"></a><span id="l37.762" class="difflineminus">-</span>
<a href="#l37.763"></a><span id="l37.763" class="difflineminus">-    err = GetStringColumn(cardRow, m_HomePhoneColumnToken, tempString);</span>
<a href="#l37.764"></a><span id="l37.764" class="difflineminus">-    if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty())</span>
<a href="#l37.765"></a><span id="l37.765" class="difflineminus">-    {</span>
<a href="#l37.766"></a><span id="l37.766" class="difflineminus">-        newCard-&gt;SetHomePhone(tempString);</span>
<a href="#l37.767"></a><span id="l37.767" class="difflineminus">-    }</span>
<a href="#l37.768"></a><span id="l37.768" class="difflineminus">-</span>
<a href="#l37.769"></a><span id="l37.769" class="difflineminus">-    err = GetStringColumn(cardRow, m_FaxColumnToken, tempString);</span>
<a href="#l37.770"></a><span id="l37.770" class="difflineminus">-    if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty())</span>
<a href="#l37.771"></a><span id="l37.771" class="difflineminus">-    {</span>
<a href="#l37.772"></a><span id="l37.772" class="difflineminus">-        newCard-&gt;SetFaxNumber(tempString);</span>
<a href="#l37.773"></a><span id="l37.773" class="difflineminus">-    }</span>
<a href="#l37.774"></a><span id="l37.774" class="difflineminus">-</span>
<a href="#l37.775"></a><span id="l37.775" class="difflineminus">-    err = GetStringColumn(cardRow, m_PagerColumnToken, tempString);</span>
<a href="#l37.776"></a><span id="l37.776" class="difflineminus">-    if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty())</span>
<a href="#l37.777"></a><span id="l37.777" class="difflineminus">-    {</span>
<a href="#l37.778"></a><span id="l37.778" class="difflineminus">-        newCard-&gt;SetPagerNumber(tempString);</span>
<a href="#l37.779"></a><span id="l37.779" class="difflineminus">-    }</span>
<a href="#l37.780"></a><span id="l37.780" class="difflineminus">-</span>
<a href="#l37.781"></a><span id="l37.781" class="difflineminus">-    err = GetStringColumn(cardRow, m_CellularColumnToken, tempString);</span>
<a href="#l37.782"></a><span id="l37.782" class="difflineminus">-    if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty())</span>
<a href="#l37.783"></a><span id="l37.783" class="difflineminus">-    {</span>
<a href="#l37.784"></a><span id="l37.784" class="difflineminus">-        newCard-&gt;SetCellularNumber(tempString);</span>
<a href="#l37.785"></a><span id="l37.785" class="difflineminus">-    }</span>
<a href="#l37.786"></a><span id="l37.786" class="difflineminus">-</span>
<a href="#l37.787"></a><span id="l37.787" class="difflineminus">-    err = GetStringColumn(cardRow, m_WorkPhoneTypeColumnToken, tempString);</span>
<a href="#l37.788"></a><span id="l37.788" class="difflineminus">-    if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty())</span>
<a href="#l37.789"></a><span id="l37.789" class="difflineminus">-        newCard-&gt;SetWorkPhoneType(tempString);</span>
<a href="#l37.790"></a><span id="l37.790" class="difflineminus">-</span>
<a href="#l37.791"></a><span id="l37.791" class="difflineminus">-    err = GetStringColumn(cardRow, m_HomePhoneTypeColumnToken, tempString);</span>
<a href="#l37.792"></a><span id="l37.792" class="difflineminus">-    if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty())</span>
<a href="#l37.793"></a><span id="l37.793" class="difflineminus">-        newCard-&gt;SetHomePhoneType(tempString);</span>
<a href="#l37.794"></a><span id="l37.794" class="difflineminus">-</span>
<a href="#l37.795"></a><span id="l37.795" class="difflineminus">-    err = GetStringColumn(cardRow, m_FaxTypeColumnToken, tempString);</span>
<a href="#l37.796"></a><span id="l37.796" class="difflineminus">-    if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty())</span>
<a href="#l37.797"></a><span id="l37.797" class="difflineminus">-        newCard-&gt;SetFaxNumberType(tempString);</span>
<a href="#l37.798"></a><span id="l37.798" class="difflineminus">-</span>
<a href="#l37.799"></a><span id="l37.799" class="difflineminus">-    err = GetStringColumn(cardRow, m_PagerTypeColumnToken, tempString);</span>
<a href="#l37.800"></a><span id="l37.800" class="difflineminus">-    if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty())</span>
<a href="#l37.801"></a><span id="l37.801" class="difflineminus">-        newCard-&gt;SetPagerNumberType(tempString);</span>
<a href="#l37.802"></a><span id="l37.802" class="difflineminus">-</span>
<a href="#l37.803"></a><span id="l37.803" class="difflineminus">-    err = GetStringColumn(cardRow, m_CellularTypeColumnToken, tempString);</span>
<a href="#l37.804"></a><span id="l37.804" class="difflineminus">-    if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty())</span>
<a href="#l37.805"></a><span id="l37.805" class="difflineminus">-        newCard-&gt;SetCellularNumberType(tempString);</span>
<a href="#l37.806"></a><span id="l37.806" class="difflineminus">-</span>
<a href="#l37.807"></a><span id="l37.807" class="difflineminus">-    err = GetStringColumn(cardRow, m_HomeAddressColumnToken, tempString);</span>
<a href="#l37.808"></a><span id="l37.808" class="difflineminus">-    if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty())</span>
<a href="#l37.809"></a><span id="l37.809" class="difflineminus">-    {</span>
<a href="#l37.810"></a><span id="l37.810" class="difflineminus">-        newCard-&gt;SetHomeAddress(tempString);</span>
<a href="#l37.811"></a><span id="l37.811" class="difflineminus">-    }</span>
<a href="#l37.812"></a><span id="l37.812" class="difflineminus">-</span>
<a href="#l37.813"></a><span id="l37.813" class="difflineminus">-    err = GetStringColumn(cardRow, m_HomeAddress2ColumnToken, tempString);</span>
<a href="#l37.814"></a><span id="l37.814" class="difflineminus">-    if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty())</span>
<a href="#l37.815"></a><span id="l37.815" class="difflineminus">-    {</span>
<a href="#l37.816"></a><span id="l37.816" class="difflineminus">-        newCard-&gt;SetHomeAddress2(tempString);</span>
<a href="#l37.817"></a><span id="l37.817" class="difflineminus">-    }</span>
<a href="#l37.818"></a><span id="l37.818" class="difflineminus">-</span>
<a href="#l37.819"></a><span id="l37.819" class="difflineminus">-    err = GetStringColumn(cardRow, m_HomeCityColumnToken, tempString);</span>
<a href="#l37.820"></a><span id="l37.820" class="difflineminus">-    if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty())</span>
<a href="#l37.821"></a><span id="l37.821" class="difflineminus">-    {</span>
<a href="#l37.822"></a><span id="l37.822" class="difflineminus">-        newCard-&gt;SetHomeCity(tempString);</span>
<a href="#l37.823"></a><span id="l37.823" class="difflineminus">-    }</span>
<a href="#l37.824"></a><span id="l37.824" class="difflineminus">-</span>
<a href="#l37.825"></a><span id="l37.825" class="difflineminus">-    err = GetStringColumn(cardRow, m_HomeStateColumnToken, tempString);</span>
<a href="#l37.826"></a><span id="l37.826" class="difflineminus">-    if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty())</span>
<a href="#l37.827"></a><span id="l37.827" class="difflineminus">-    {</span>
<a href="#l37.828"></a><span id="l37.828" class="difflineminus">-        newCard-&gt;SetHomeState(tempString);</span>
<a href="#l37.829"></a><span id="l37.829" class="difflineminus">-    }</span>
<a href="#l37.830"></a><span id="l37.830" class="difflineminus">-</span>
<a href="#l37.831"></a><span id="l37.831" class="difflineminus">-    err = GetStringColumn(cardRow, m_HomeZipCodeColumnToken, tempString);</span>
<a href="#l37.832"></a><span id="l37.832" class="difflineminus">-    if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty())</span>
<a href="#l37.833"></a><span id="l37.833" class="difflineminus">-    {</span>
<a href="#l37.834"></a><span id="l37.834" class="difflineminus">-        newCard-&gt;SetHomeZipCode(tempString);</span>
<a href="#l37.835"></a><span id="l37.835" class="difflineminus">-    }</span>
<a href="#l37.836"></a><span id="l37.836" class="difflineminus">-</span>
<a href="#l37.837"></a><span id="l37.837" class="difflineminus">-    err = GetStringColumn(cardRow, m_HomeCountryColumnToken, tempString);</span>
<a href="#l37.838"></a><span id="l37.838" class="difflineminus">-    if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty())</span>
<a href="#l37.839"></a><span id="l37.839" class="difflineminus">-    {</span>
<a href="#l37.840"></a><span id="l37.840" class="difflineminus">-        newCard-&gt;SetHomeCountry(tempString);</span>
<a href="#l37.841"></a><span id="l37.841" class="difflineplus">+      // Get the column of the cell</span>
<a href="#l37.842"></a><span id="l37.842" class="difflineplus">+      // Mork makes this so hard...</span>
<a href="#l37.843"></a><span id="l37.843" class="difflineplus">+      rv = m_mdbStore-&gt;TokenToString(m_mdbEnv, columnNumber, &amp;colYarn);</span>
<a href="#l37.844"></a><span id="l37.844" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l37.845"></a><span id="l37.845" class="difflineplus">+</span>
<a href="#l37.846"></a><span id="l37.846" class="difflineplus">+      char *name = PL_strndup(static_cast&lt;char *&gt;(colYarn.mYarn_Buf),</span>
<a href="#l37.847"></a><span id="l37.847" class="difflineplus">+          colYarn.mYarn_Fill);</span>
<a href="#l37.848"></a><span id="l37.848" class="difflineplus">+      newCard-&gt;SetPropertyAsAString(name, value);</span>
<a href="#l37.849"></a><span id="l37.849" class="difflineplus">+      PL_strfree(name);</span>
<a href="#l37.850"></a><span id="l37.850">     }</span>
<a href="#l37.851"></a><span id="l37.851" class="difflineminus">-</span>
<a href="#l37.852"></a><span id="l37.852" class="difflineminus">-    err = GetStringColumn(cardRow, m_WorkAddressColumnToken, tempString);</span>
<a href="#l37.853"></a><span id="l37.853" class="difflineminus">-    if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty())</span>
<a href="#l37.854"></a><span id="l37.854" class="difflineminus">-    {</span>
<a href="#l37.855"></a><span id="l37.855" class="difflineminus">-        newCard-&gt;SetWorkAddress(tempString);</span>
<a href="#l37.856"></a><span id="l37.856" class="difflineminus">-    }</span>
<a href="#l37.857"></a><span id="l37.857" class="difflineminus">-</span>
<a href="#l37.858"></a><span id="l37.858" class="difflineminus">-    err = GetStringColumn(cardRow, m_WorkAddress2ColumnToken, tempString);</span>
<a href="#l37.859"></a><span id="l37.859" class="difflineminus">-    if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty())</span>
<a href="#l37.860"></a><span id="l37.860" class="difflineminus">-    {</span>
<a href="#l37.861"></a><span id="l37.861" class="difflineminus">-        newCard-&gt;SetWorkAddress2(tempString);</span>
<a href="#l37.862"></a><span id="l37.862" class="difflineminus">-    }</span>
<a href="#l37.863"></a><span id="l37.863" class="difflineminus">-</span>
<a href="#l37.864"></a><span id="l37.864" class="difflineminus">-    err = GetStringColumn(cardRow, m_WorkCityColumnToken, tempString);</span>
<a href="#l37.865"></a><span id="l37.865" class="difflineminus">-    if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty())</span>
<a href="#l37.866"></a><span id="l37.866" class="difflineminus">-    {</span>
<a href="#l37.867"></a><span id="l37.867" class="difflineminus">-        newCard-&gt;SetWorkCity(tempString);</span>
<a href="#l37.868"></a><span id="l37.868" class="difflineminus">-    }</span>
<a href="#l37.869"></a><span id="l37.869" class="difflineminus">-</span>
<a href="#l37.870"></a><span id="l37.870" class="difflineminus">-    err = GetStringColumn(cardRow, m_WorkStateColumnToken, tempString);</span>
<a href="#l37.871"></a><span id="l37.871" class="difflineminus">-    if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty())</span>
<a href="#l37.872"></a><span id="l37.872" class="difflineminus">-    {</span>
<a href="#l37.873"></a><span id="l37.873" class="difflineminus">-        newCard-&gt;SetWorkState(tempString);</span>
<a href="#l37.874"></a><span id="l37.874" class="difflineminus">-    }</span>
<a href="#l37.875"></a><span id="l37.875" class="difflineminus">-</span>
<a href="#l37.876"></a><span id="l37.876" class="difflineminus">-    err = GetStringColumn(cardRow, m_WorkZipCodeColumnToken, tempString);</span>
<a href="#l37.877"></a><span id="l37.877" class="difflineminus">-    if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty())</span>
<a href="#l37.878"></a><span id="l37.878" class="difflineminus">-    {</span>
<a href="#l37.879"></a><span id="l37.879" class="difflineminus">-        newCard-&gt;SetWorkZipCode(tempString);</span>
<a href="#l37.880"></a><span id="l37.880" class="difflineminus">-    }</span>
<a href="#l37.881"></a><span id="l37.881" class="difflineminus">-</span>
<a href="#l37.882"></a><span id="l37.882" class="difflineminus">-    err = GetStringColumn(cardRow, m_WorkCountryColumnToken, tempString);</span>
<a href="#l37.883"></a><span id="l37.883" class="difflineminus">-    if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty())</span>
<a href="#l37.884"></a><span id="l37.884" class="difflineminus">-    {</span>
<a href="#l37.885"></a><span id="l37.885" class="difflineminus">-        newCard-&gt;SetWorkCountry(tempString);</span>
<a href="#l37.886"></a><span id="l37.886" class="difflineminus">-    }</span>
<a href="#l37.887"></a><span id="l37.887" class="difflineminus">-</span>
<a href="#l37.888"></a><span id="l37.888" class="difflineminus">-    err = GetStringColumn(cardRow, m_JobTitleColumnToken, tempString);</span>
<a href="#l37.889"></a><span id="l37.889" class="difflineminus">-    if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty())</span>
<a href="#l37.890"></a><span id="l37.890" class="difflineminus">-    {</span>
<a href="#l37.891"></a><span id="l37.891" class="difflineminus">-        newCard-&gt;SetJobTitle(tempString);</span>
<a href="#l37.892"></a><span id="l37.892" class="difflineminus">-    }</span>
<a href="#l37.893"></a><span id="l37.893" class="difflineminus">-</span>
<a href="#l37.894"></a><span id="l37.894" class="difflineminus">-    err = GetStringColumn(cardRow, m_DepartmentColumnToken, tempString);</span>
<a href="#l37.895"></a><span id="l37.895" class="difflineminus">-    if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty())</span>
<a href="#l37.896"></a><span id="l37.896" class="difflineminus">-    {</span>
<a href="#l37.897"></a><span id="l37.897" class="difflineminus">-        newCard-&gt;SetDepartment(tempString);</span>
<a href="#l37.898"></a><span id="l37.898" class="difflineminus">-    }</span>
<a href="#l37.899"></a><span id="l37.899" class="difflineminus">-</span>
<a href="#l37.900"></a><span id="l37.900" class="difflineminus">-    err = GetStringColumn(cardRow, m_CompanyColumnToken, tempString);</span>
<a href="#l37.901"></a><span id="l37.901" class="difflineminus">-    if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty())</span>
<a href="#l37.902"></a><span id="l37.902" class="difflineminus">-    {</span>
<a href="#l37.903"></a><span id="l37.903" class="difflineminus">-        newCard-&gt;SetCompany(tempString);</span>
<a href="#l37.904"></a><span id="l37.904" class="difflineminus">-    }</span>
<a href="#l37.905"></a><span id="l37.905" class="difflineminus">-</span>
<a href="#l37.906"></a><span id="l37.906" class="difflineminus">-    // AimScreenName</span>
<a href="#l37.907"></a><span id="l37.907" class="difflineminus">-    err = GetStringColumn(cardRow, m_AimScreenNameColumnToken, tempString);</span>
<a href="#l37.908"></a><span id="l37.908" class="difflineminus">-    if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty())</span>
<a href="#l37.909"></a><span id="l37.909" class="difflineminus">-        newCard-&gt;SetAimScreenName(tempString);</span>
<a href="#l37.910"></a><span id="l37.910" class="difflineminus">-</span>
<a href="#l37.911"></a><span id="l37.911" class="difflineminus">-    err = GetStringColumn(cardRow, m_AnniversaryYearColumnToken, tempString);</span>
<a href="#l37.912"></a><span id="l37.912" class="difflineminus">-    if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty())</span>
<a href="#l37.913"></a><span id="l37.913" class="difflineminus">-        newCard-&gt;SetAnniversaryYear(tempString);</span>
<a href="#l37.914"></a><span id="l37.914" class="difflineminus">-</span>
<a href="#l37.915"></a><span id="l37.915" class="difflineminus">-    err = GetStringColumn(cardRow, m_AnniversaryMonthColumnToken, tempString);</span>
<a href="#l37.916"></a><span id="l37.916" class="difflineminus">-    if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty())</span>
<a href="#l37.917"></a><span id="l37.917" class="difflineminus">-        newCard-&gt;SetAnniversaryMonth(tempString);</span>
<a href="#l37.918"></a><span id="l37.918" class="difflineminus">-</span>
<a href="#l37.919"></a><span id="l37.919" class="difflineminus">-    err = GetStringColumn(cardRow, m_AnniversaryDayColumnToken, tempString);</span>
<a href="#l37.920"></a><span id="l37.920" class="difflineminus">-    if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty())</span>
<a href="#l37.921"></a><span id="l37.921" class="difflineminus">-        newCard-&gt;SetAnniversaryDay(tempString);</span>
<a href="#l37.922"></a><span id="l37.922" class="difflineminus">-</span>
<a href="#l37.923"></a><span id="l37.923" class="difflineminus">-    err = GetStringColumn(cardRow, m_SpouseNameColumnToken, tempString);</span>
<a href="#l37.924"></a><span id="l37.924" class="difflineminus">-    if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty())</span>
<a href="#l37.925"></a><span id="l37.925" class="difflineminus">-        newCard-&gt;SetSpouseName(tempString);</span>
<a href="#l37.926"></a><span id="l37.926" class="difflineminus">-</span>
<a href="#l37.927"></a><span id="l37.927" class="difflineminus">-    err = GetStringColumn(cardRow, m_FamilyNameColumnToken, tempString);</span>
<a href="#l37.928"></a><span id="l37.928" class="difflineminus">-    if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty())</span>
<a href="#l37.929"></a><span id="l37.929" class="difflineminus">-        newCard-&gt;SetFamilyName(tempString);</span>
<a href="#l37.930"></a><span id="l37.930" class="difflineminus">-</span>
<a href="#l37.931"></a><span id="l37.931" class="difflineminus">-    err = GetStringColumn(cardRow, m_DefaultAddressColumnToken, tempString);</span>
<a href="#l37.932"></a><span id="l37.932" class="difflineminus">-    if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty())</span>
<a href="#l37.933"></a><span id="l37.933" class="difflineminus">-        newCard-&gt;SetDefaultAddress(tempString);</span>
<a href="#l37.934"></a><span id="l37.934" class="difflineminus">-</span>
<a href="#l37.935"></a><span id="l37.935" class="difflineminus">-    err = GetStringColumn(cardRow, m_CategoryColumnToken, tempString);</span>
<a href="#l37.936"></a><span id="l37.936" class="difflineminus">-    if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty())</span>
<a href="#l37.937"></a><span id="l37.937" class="difflineminus">-        newCard-&gt;SetCategory(tempString);</span>
<a href="#l37.938"></a><span id="l37.938" class="difflineminus">-</span>
<a href="#l37.939"></a><span id="l37.939" class="difflineminus">-    err = GetStringColumn(cardRow, m_WebPage1ColumnToken, tempString);</span>
<a href="#l37.940"></a><span id="l37.940" class="difflineminus">-    if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty())</span>
<a href="#l37.941"></a><span id="l37.941" class="difflineminus">-    {</span>
<a href="#l37.942"></a><span id="l37.942" class="difflineminus">-        newCard-&gt;SetWebPage1(tempString);</span>
<a href="#l37.943"></a><span id="l37.943" class="difflineminus">-    }</span>
<a href="#l37.944"></a><span id="l37.944" class="difflineminus">-</span>
<a href="#l37.945"></a><span id="l37.945" class="difflineminus">-    err = GetStringColumn(cardRow, m_WebPage2ColumnToken, tempString);</span>
<a href="#l37.946"></a><span id="l37.946" class="difflineminus">-    if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty())</span>
<a href="#l37.947"></a><span id="l37.947" class="difflineminus">-    {</span>
<a href="#l37.948"></a><span id="l37.948" class="difflineminus">-        newCard-&gt;SetWebPage2(tempString);</span>
<a href="#l37.949"></a><span id="l37.949" class="difflineminus">-    }</span>
<a href="#l37.950"></a><span id="l37.950" class="difflineminus">-</span>
<a href="#l37.951"></a><span id="l37.951" class="difflineminus">-    err = GetStringColumn(cardRow, m_BirthYearColumnToken, tempString);</span>
<a href="#l37.952"></a><span id="l37.952" class="difflineminus">-    if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty())</span>
<a href="#l37.953"></a><span id="l37.953" class="difflineminus">-    {</span>
<a href="#l37.954"></a><span id="l37.954" class="difflineminus">-        newCard-&gt;SetBirthYear(tempString);</span>
<a href="#l37.955"></a><span id="l37.955" class="difflineminus">-    }</span>
<a href="#l37.956"></a><span id="l37.956" class="difflineminus">-</span>
<a href="#l37.957"></a><span id="l37.957" class="difflineminus">-    err = GetStringColumn(cardRow, m_BirthMonthColumnToken, tempString);</span>
<a href="#l37.958"></a><span id="l37.958" class="difflineminus">-    if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty())</span>
<a href="#l37.959"></a><span id="l37.959" class="difflineminus">-    {</span>
<a href="#l37.960"></a><span id="l37.960" class="difflineminus">-        newCard-&gt;SetBirthMonth(tempString);</span>
<a href="#l37.961"></a><span id="l37.961" class="difflineminus">-    }</span>
<a href="#l37.962"></a><span id="l37.962" class="difflineminus">-</span>
<a href="#l37.963"></a><span id="l37.963" class="difflineminus">-    err = GetStringColumn(cardRow, m_BirthDayColumnToken, tempString);</span>
<a href="#l37.964"></a><span id="l37.964" class="difflineminus">-    if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty())</span>
<a href="#l37.965"></a><span id="l37.965" class="difflineminus">-    {</span>
<a href="#l37.966"></a><span id="l37.966" class="difflineminus">-        newCard-&gt;SetBirthDay(tempString);</span>
<a href="#l37.967"></a><span id="l37.967" class="difflineminus">-    }</span>
<a href="#l37.968"></a><span id="l37.968" class="difflineminus">-</span>
<a href="#l37.969"></a><span id="l37.969" class="difflineminus">-    err = GetStringColumn(cardRow, m_Custom1ColumnToken, tempString);</span>
<a href="#l37.970"></a><span id="l37.970" class="difflineminus">-    if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty())</span>
<a href="#l37.971"></a><span id="l37.971" class="difflineminus">-    {</span>
<a href="#l37.972"></a><span id="l37.972" class="difflineminus">-        newCard-&gt;SetCustom1(tempString);</span>
<a href="#l37.973"></a><span id="l37.973" class="difflineminus">-    }</span>
<a href="#l37.974"></a><span id="l37.974" class="difflineminus">-</span>
<a href="#l37.975"></a><span id="l37.975" class="difflineminus">-    err = GetStringColumn(cardRow, m_Custom2ColumnToken, tempString);</span>
<a href="#l37.976"></a><span id="l37.976" class="difflineminus">-    if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty())</span>
<a href="#l37.977"></a><span id="l37.977" class="difflineminus">-    {</span>
<a href="#l37.978"></a><span id="l37.978" class="difflineminus">-        newCard-&gt;SetCustom2(tempString);</span>
<a href="#l37.979"></a><span id="l37.979" class="difflineminus">-    }</span>
<a href="#l37.980"></a><span id="l37.980" class="difflineminus">-</span>
<a href="#l37.981"></a><span id="l37.981" class="difflineminus">-    err = GetStringColumn(cardRow, m_Custom3ColumnToken, tempString);</span>
<a href="#l37.982"></a><span id="l37.982" class="difflineminus">-    if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty())</span>
<a href="#l37.983"></a><span id="l37.983" class="difflineminus">-    {</span>
<a href="#l37.984"></a><span id="l37.984" class="difflineminus">-        newCard-&gt;SetCustom3(tempString);</span>
<a href="#l37.985"></a><span id="l37.985" class="difflineminus">-    }</span>
<a href="#l37.986"></a><span id="l37.986" class="difflineminus">-</span>
<a href="#l37.987"></a><span id="l37.987" class="difflineminus">-    err = GetStringColumn(cardRow, m_Custom4ColumnToken, tempString);</span>
<a href="#l37.988"></a><span id="l37.988" class="difflineminus">-    if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty())</span>
<a href="#l37.989"></a><span id="l37.989" class="difflineminus">-    {</span>
<a href="#l37.990"></a><span id="l37.990" class="difflineminus">-        newCard-&gt;SetCustom4(tempString);</span>
<a href="#l37.991"></a><span id="l37.991" class="difflineminus">-    }</span>
<a href="#l37.992"></a><span id="l37.992" class="difflineminus">-</span>
<a href="#l37.993"></a><span id="l37.993" class="difflineminus">-    err = GetStringColumn(cardRow, m_NotesColumnToken, tempString);</span>
<a href="#l37.994"></a><span id="l37.994" class="difflineminus">-    if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty())</span>
<a href="#l37.995"></a><span id="l37.995" class="difflineminus">-    {</span>
<a href="#l37.996"></a><span id="l37.996" class="difflineminus">-        newCard-&gt;SetNotes(tempString);</span>
<a href="#l37.997"></a><span id="l37.997" class="difflineminus">-    }</span>
<a href="#l37.998"></a><span id="l37.998" class="difflineminus">-    PRUint32 lastModDate = 0;</span>
<a href="#l37.999"></a><span id="l37.999" class="difflineminus">-    err = GetIntColumn(cardRow, m_LastModDateColumnToken, &amp;lastModDate, 0);</span>
<a href="#l37.1000"></a><span id="l37.1000" class="difflineminus">-    if (NS_SUCCEEDED(err))</span>
<a href="#l37.1001"></a><span id="l37.1001" class="difflineminus">-      newCard-&gt;SetLastModifiedDate(lastModDate);</span>
<a href="#l37.1002"></a><span id="l37.1002" class="difflineminus">-</span>
<a href="#l37.1003"></a><span id="l37.1003" class="difflineminus">-    PRUint32 key = 0;</span>
<a href="#l37.1004"></a><span id="l37.1004" class="difflineminus">-    err = GetIntColumn(cardRow, m_RecordKeyColumnToken, &amp;key, 0);</span>
<a href="#l37.1005"></a><span id="l37.1005" class="difflineminus">-    if (NS_SUCCEEDED(err))</span>
<a href="#l37.1006"></a><span id="l37.1006" class="difflineminus">-    {</span>
<a href="#l37.1007"></a><span id="l37.1007" class="difflineminus">-        nsCOMPtr&lt;nsIAbMDBCard&gt; dbnewCard(do_QueryInterface(newCard, &amp;err));</span>
<a href="#l37.1008"></a><span id="l37.1008" class="difflineminus">-        if (NS_SUCCEEDED(err) &amp;&amp; dbnewCard)</span>
<a href="#l37.1009"></a><span id="l37.1009" class="difflineminus">-            dbnewCard-&gt;SetKey(key);</span>
<a href="#l37.1010"></a><span id="l37.1010" class="difflineminus">-    }</span>
<a href="#l37.1011"></a><span id="l37.1011" class="difflineminus">-</span>
<a href="#l37.1012"></a><span id="l37.1012" class="difflineminus">-    return err;</span>
<a href="#l37.1013"></a><span id="l37.1013" class="difflineplus">+  } while (true);</span>
<a href="#l37.1014"></a><span id="l37.1014" class="difflineplus">+ </span>
<a href="#l37.1015"></a><span id="l37.1015" class="difflineplus">+  PRUint32 key = 0;</span>
<a href="#l37.1016"></a><span id="l37.1016" class="difflineplus">+  rv = GetIntColumn(cardRow, m_RecordKeyColumnToken, &amp;key, 0);</span>
<a href="#l37.1017"></a><span id="l37.1017" class="difflineplus">+  if (NS_SUCCEEDED(rv))</span>
<a href="#l37.1018"></a><span id="l37.1018" class="difflineplus">+    newCard-&gt;SetPropertyAsUint32(kRecordKeyColumn, key);</span>
<a href="#l37.1019"></a><span id="l37.1019" class="difflineplus">+</span>
<a href="#l37.1020"></a><span id="l37.1020" class="difflineplus">+  return NS_OK;</span>
<a href="#l37.1021"></a><span id="l37.1021"> }</span>
<a href="#l37.1022"></a><span id="l37.1022"> </span>
<a href="#l37.1023"></a><span id="l37.1023"> nsresult nsAddrDatabase::GetListCardFromDB(nsIAbCard *listCard, nsIMdbRow* listRow)</span>
<a href="#l37.1024"></a><span id="l37.1024"> {</span>
<a href="#l37.1025"></a><span id="l37.1025">     nsresult    err = NS_OK;</span>
<a href="#l37.1026"></a><span id="l37.1026">     if (!listCard || !listRow)</span>
<a href="#l37.1027"></a><span id="l37.1027">         return NS_ERROR_NULL_POINTER;</span>
<a href="#l37.1028"></a><span id="l37.1028"> </span>
<a href="#l37.1029"></a><span id="l37.1029" class="difflineat">@@ -2870,31 +2447,27 @@ nsresult nsAddrDatabase::GetListCardFrom</span>
<a href="#l37.1030"></a><span id="l37.1030">     if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty())</span>
<a href="#l37.1031"></a><span id="l37.1031">     {</span>
<a href="#l37.1032"></a><span id="l37.1032">         listCard-&gt;SetDisplayName(tempString);</span>
<a href="#l37.1033"></a><span id="l37.1033">         listCard-&gt;SetLastName(tempString);</span>
<a href="#l37.1034"></a><span id="l37.1034">     }</span>
<a href="#l37.1035"></a><span id="l37.1035">     err = GetStringColumn(listRow, m_ListNickNameColumnToken, tempString);</span>
<a href="#l37.1036"></a><span id="l37.1036">     if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty())</span>
<a href="#l37.1037"></a><span id="l37.1037">     {</span>
<a href="#l37.1038"></a><span id="l37.1038" class="difflineminus">-        listCard-&gt;SetNickName(tempString);</span>
<a href="#l37.1039"></a><span id="l37.1039" class="difflineplus">+        listCard-&gt;SetPropertyAsAString(kNicknameProperty, tempString);</span>
<a href="#l37.1040"></a><span id="l37.1040">     }</span>
<a href="#l37.1041"></a><span id="l37.1041">     err = GetStringColumn(listRow, m_ListDescriptionColumnToken, tempString);</span>
<a href="#l37.1042"></a><span id="l37.1042">     if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty())</span>
<a href="#l37.1043"></a><span id="l37.1043">     {</span>
<a href="#l37.1044"></a><span id="l37.1044" class="difflineminus">-        listCard-&gt;SetNotes(tempString);</span>
<a href="#l37.1045"></a><span id="l37.1045" class="difflineplus">+        listCard-&gt;SetPropertyAsAString(kNotesProperty, tempString);</span>
<a href="#l37.1046"></a><span id="l37.1046">     }</span>
<a href="#l37.1047"></a><span id="l37.1047">     PRUint32 key = 0;</span>
<a href="#l37.1048"></a><span id="l37.1048">     err = GetIntColumn(listRow, m_RecordKeyColumnToken, &amp;key, 0);</span>
<a href="#l37.1049"></a><span id="l37.1049">     if (NS_SUCCEEDED(err))</span>
<a href="#l37.1050"></a><span id="l37.1050" class="difflineminus">-    {</span>
<a href="#l37.1051"></a><span id="l37.1051" class="difflineminus">-        nsCOMPtr&lt;nsIAbMDBCard&gt; dblistCard(do_QueryInterface(listCard, &amp;err));</span>
<a href="#l37.1052"></a><span id="l37.1052" class="difflineminus">-        if (NS_SUCCEEDED(err) &amp;&amp; dblistCard)</span>
<a href="#l37.1053"></a><span id="l37.1053" class="difflineminus">-            dblistCard-&gt;SetKey(key);</span>
<a href="#l37.1054"></a><span id="l37.1054" class="difflineminus">-    }</span>
<a href="#l37.1055"></a><span id="l37.1055" class="difflineplus">+      listCard-&gt;SetPropertyAsUint32(kRecordKeyColumn, key);</span>
<a href="#l37.1056"></a><span id="l37.1056">     return err;</span>
<a href="#l37.1057"></a><span id="l37.1057"> }</span>
<a href="#l37.1058"></a><span id="l37.1058"> </span>
<a href="#l37.1059"></a><span id="l37.1059"> nsresult nsAddrDatabase::GetListFromDB(nsIAbDirectory *newList, nsIMdbRow* listRow)</span>
<a href="#l37.1060"></a><span id="l37.1060"> {</span>
<a href="#l37.1061"></a><span id="l37.1061">   nsresult    err = NS_OK;</span>
<a href="#l37.1062"></a><span id="l37.1062">   if (!newList || !listRow || !m_mdbStore || !m_mdbEnv)</span>
<a href="#l37.1063"></a><span id="l37.1063">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l37.1064"></a><span id="l37.1064" class="difflineat">@@ -3268,28 +2841,18 @@ nsresult nsAddrDatabase::CreateCardFromD</span>
<a href="#l37.1065"></a><span id="l37.1065">         rowID = outOid.mOid_Id;</span>
<a href="#l37.1066"></a><span id="l37.1066"> </span>
<a href="#l37.1067"></a><span id="l37.1067">     if(NS_SUCCEEDED(rv))</span>
<a href="#l37.1068"></a><span id="l37.1068">     {</span>
<a href="#l37.1069"></a><span id="l37.1069">         nsCOMPtr&lt;nsIAbCard&gt; personCard;</span>
<a href="#l37.1070"></a><span id="l37.1070">         personCard = do_CreateInstance(NS_ABMDBCARD_CONTRACTID, &amp;rv);</span>
<a href="#l37.1071"></a><span id="l37.1071">         NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l37.1072"></a><span id="l37.1072"> </span>
<a href="#l37.1073"></a><span id="l37.1073" class="difflineminus">-        nsCOMPtr&lt;nsIAbMDBCard&gt; dbpersonCard (do_QueryInterface(personCard, &amp;rv));</span>
<a href="#l37.1074"></a><span id="l37.1074" class="difflineminus">-</span>
<a href="#l37.1075"></a><span id="l37.1075" class="difflineminus">-        if (NS_SUCCEEDED(rv) &amp;&amp; dbpersonCard)</span>
<a href="#l37.1076"></a><span id="l37.1076" class="difflineminus">-        {</span>
<a href="#l37.1077"></a><span id="l37.1077" class="difflineminus">-            InitCardFromRow(personCard, cardRow);</span>
<a href="#l37.1078"></a><span id="l37.1078" class="difflineminus">-            mdbOid tableOid;</span>
<a href="#l37.1079"></a><span id="l37.1079" class="difflineminus">-            m_mdbDeletedCardsTable-&gt;GetOid(m_mdbEnv, &amp;tableOid);</span>
<a href="#l37.1080"></a><span id="l37.1080" class="difflineminus">-</span>
<a href="#l37.1081"></a><span id="l37.1081" class="difflineminus">-            dbpersonCard-&gt;SetDbTableID(tableOid.mOid_Id);</span>
<a href="#l37.1082"></a><span id="l37.1082" class="difflineminus">-            dbpersonCard-&gt;SetDbRowID(rowID);</span>
<a href="#l37.1083"></a><span id="l37.1083" class="difflineminus">-            dbpersonCard-&gt;SetAbDatabase(this);</span>
<a href="#l37.1084"></a><span id="l37.1084" class="difflineminus">-        }</span>
<a href="#l37.1085"></a><span id="l37.1085" class="difflineplus">+        InitCardFromRow(personCard, cardRow);</span>
<a href="#l37.1086"></a><span id="l37.1086" class="difflineplus">+        personCard-&gt;SetPropertyAsUint32(kRowIDProperty, rowID);</span>
<a href="#l37.1087"></a><span id="l37.1087"> </span>
<a href="#l37.1088"></a><span id="l37.1088">         NS_IF_ADDREF(*result = personCard);</span>
<a href="#l37.1089"></a><span id="l37.1089">     }</span>
<a href="#l37.1090"></a><span id="l37.1090"> </span>
<a href="#l37.1091"></a><span id="l37.1091">     return rv;</span>
<a href="#l37.1092"></a><span id="l37.1092"> }</span>
<a href="#l37.1093"></a><span id="l37.1093"> </span>
<a href="#l37.1094"></a><span id="l37.1094"> nsresult nsAddrDatabase::CreateCard(nsIMdbRow* cardRow, mdb_id listRowID, nsIAbCard **result)</span>
<a href="#l37.1095"></a><span id="l37.1095" class="difflineat">@@ -3306,28 +2869,18 @@ nsresult nsAddrDatabase::CreateCard(nsIM</span>
<a href="#l37.1096"></a><span id="l37.1096">         rowID = outOid.mOid_Id;</span>
<a href="#l37.1097"></a><span id="l37.1097"> </span>
<a href="#l37.1098"></a><span id="l37.1098">     if(NS_SUCCEEDED(rv))</span>
<a href="#l37.1099"></a><span id="l37.1099">     {</span>
<a href="#l37.1100"></a><span id="l37.1100">         nsCOMPtr&lt;nsIAbCard&gt; personCard;</span>
<a href="#l37.1101"></a><span id="l37.1101">       personCard = do_CreateInstance(NS_ABMDBCARD_CONTRACTID, &amp;rv);</span>
<a href="#l37.1102"></a><span id="l37.1102">       NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l37.1103"></a><span id="l37.1103"> </span>
<a href="#l37.1104"></a><span id="l37.1104" class="difflineminus">-        nsCOMPtr&lt;nsIAbMDBCard&gt; dbpersonCard (do_QueryInterface(personCard, &amp;rv));</span>
<a href="#l37.1105"></a><span id="l37.1105" class="difflineminus">-</span>
<a href="#l37.1106"></a><span id="l37.1106" class="difflineminus">-        if (NS_SUCCEEDED(rv) &amp;&amp; dbpersonCard)</span>
<a href="#l37.1107"></a><span id="l37.1107" class="difflineminus">-        {</span>
<a href="#l37.1108"></a><span id="l37.1108" class="difflineminus">-            InitCardFromRow(personCard, cardRow);</span>
<a href="#l37.1109"></a><span id="l37.1109" class="difflineminus">-            mdbOid tableOid;</span>
<a href="#l37.1110"></a><span id="l37.1110" class="difflineminus">-            m_mdbPabTable-&gt;GetOid(m_mdbEnv, &amp;tableOid);</span>
<a href="#l37.1111"></a><span id="l37.1111" class="difflineminus">-</span>
<a href="#l37.1112"></a><span id="l37.1112" class="difflineminus">-            dbpersonCard-&gt;SetDbTableID(tableOid.mOid_Id);</span>
<a href="#l37.1113"></a><span id="l37.1113" class="difflineminus">-            dbpersonCard-&gt;SetDbRowID(rowID);</span>
<a href="#l37.1114"></a><span id="l37.1114" class="difflineminus">-            dbpersonCard-&gt;SetAbDatabase(this);</span>
<a href="#l37.1115"></a><span id="l37.1115" class="difflineminus">-        }</span>
<a href="#l37.1116"></a><span id="l37.1116" class="difflineplus">+        InitCardFromRow(personCard, cardRow);</span>
<a href="#l37.1117"></a><span id="l37.1117" class="difflineplus">+        personCard-&gt;SetPropertyAsUint32(kRowIDProperty, rowID);</span>
<a href="#l37.1118"></a><span id="l37.1118"> </span>
<a href="#l37.1119"></a><span id="l37.1119">         NS_IF_ADDREF(*result = personCard);</span>
<a href="#l37.1120"></a><span id="l37.1120">     }</span>
<a href="#l37.1121"></a><span id="l37.1121"> </span>
<a href="#l37.1122"></a><span id="l37.1122">     return rv;</span>
<a href="#l37.1123"></a><span id="l37.1123"> }</span>
<a href="#l37.1124"></a><span id="l37.1124"> </span>
<a href="#l37.1125"></a><span id="l37.1125"> nsresult nsAddrDatabase::CreateABCard(nsIMdbRow* cardRow, mdb_id listRowID, nsIAbCard **result)</span>
<a href="#l37.1126"></a><span id="l37.1126" class="difflineat">@@ -3361,26 +2914,18 @@ nsresult nsAddrDatabase::CreateABListCar</span>
<a href="#l37.1127"></a><span id="l37.1127">     if(NS_SUCCEEDED(rv) &amp;&amp; dbm_dbDirectory)</span>
<a href="#l37.1128"></a><span id="l37.1128">     {</span>
<a href="#l37.1129"></a><span id="l37.1129">     personCard = do_CreateInstance(NS_ABMDBCARD_CONTRACTID, &amp;rv);</span>
<a href="#l37.1130"></a><span id="l37.1130">         NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l37.1131"></a><span id="l37.1131"> </span>
<a href="#l37.1132"></a><span id="l37.1132">         if (personCard)</span>
<a href="#l37.1133"></a><span id="l37.1133">         {</span>
<a href="#l37.1134"></a><span id="l37.1134">             GetListCardFromDB(personCard, listRow);</span>
<a href="#l37.1135"></a><span id="l37.1135" class="difflineminus">-            mdbOid tableOid;</span>
<a href="#l37.1136"></a><span id="l37.1136" class="difflineminus">-            m_mdbPabTable-&gt;GetOid(m_mdbEnv, &amp;tableOid);</span>
<a href="#l37.1137"></a><span id="l37.1137" class="difflineminus">-</span>
<a href="#l37.1138"></a><span id="l37.1138" class="difflineminus">-            nsCOMPtr&lt;nsIAbMDBCard&gt; dbpersonCard(do_QueryInterface(personCard, &amp;rv));</span>
<a href="#l37.1139"></a><span id="l37.1139" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; dbpersonCard)</span>
<a href="#l37.1140"></a><span id="l37.1140" class="difflineminus">-      {</span>
<a href="#l37.1141"></a><span id="l37.1141" class="difflineminus">-              dbpersonCard-&gt;SetDbTableID(tableOid.mOid_Id);</span>
<a href="#l37.1142"></a><span id="l37.1142" class="difflineminus">-              dbpersonCard-&gt;SetDbRowID(rowID);</span>
<a href="#l37.1143"></a><span id="l37.1143" class="difflineminus">-              dbpersonCard-&gt;SetAbDatabase(this);</span>
<a href="#l37.1144"></a><span id="l37.1144" class="difflineminus">-      }</span>
<a href="#l37.1145"></a><span id="l37.1145" class="difflineplus">+</span>
<a href="#l37.1146"></a><span id="l37.1146" class="difflineplus">+            personCard-&gt;SetPropertyAsUint32(kRowIDProperty, rowID);</span>
<a href="#l37.1147"></a><span id="l37.1147">             personCard-&gt;SetIsMailList(PR_TRUE);</span>
<a href="#l37.1148"></a><span id="l37.1148">             personCard-&gt;SetMailListURI(listURI);</span>
<a href="#l37.1149"></a><span id="l37.1149">         }</span>
<a href="#l37.1150"></a><span id="l37.1150"> </span>
<a href="#l37.1151"></a><span id="l37.1151">         NS_IF_ADDREF(*result = personCard);</span>
<a href="#l37.1152"></a><span id="l37.1152">     }</span>
<a href="#l37.1153"></a><span id="l37.1153">     if (listURI)</span>
<a href="#l37.1154"></a><span id="l37.1154">         PR_smprintf_free(listURI);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l38.1"></a><span id="l38.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_basic_nsIAbCard.js</span>
<a href="#l38.2"></a><span id="l38.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_basic_nsIAbCard.js</span>
<a href="#l38.3"></a><span id="l38.3" class="difflineat">@@ -12,28 +12,39 @@ const kEmailValue = &quot;testEmail\u00D2@inv</span>
<a href="#l38.4"></a><span id="l38.4"> const kEmailReducedValue = &quot;testEmail\u00D2&quot;;</span>
<a href="#l38.5"></a><span id="l38.5"> </span>
<a href="#l38.6"></a><span id="l38.6"> function run_test() {</span>
<a href="#l38.7"></a><span id="l38.7">   // Create a new card</span>
<a href="#l38.8"></a><span id="l38.8">   var card = Components.classes[&quot;@mozilla.org/addressbook/cardproperty;1&quot;]</span>
<a href="#l38.9"></a><span id="l38.9">                          .createInstance(Components.interfaces.nsIAbCard);</span>
<a href="#l38.10"></a><span id="l38.10"> </span>
<a href="#l38.11"></a><span id="l38.11">   // Test - Set First, Last and Display Names and Email Address</span>
<a href="#l38.12"></a><span id="l38.12" class="difflineminus">-  // via setCardValue, and check correctly saved via their</span>
<a href="#l38.13"></a><span id="l38.13" class="difflineplus">+  // via setProperty, and check correctly saved via their</span>
<a href="#l38.14"></a><span id="l38.14">   // attributes. We're using firstName to check UTF-8 values.</span>
<a href="#l38.15"></a><span id="l38.15" class="difflineminus">-  card.setCardValue(&quot;FirstName&quot;, kFNValue);</span>
<a href="#l38.16"></a><span id="l38.16" class="difflineminus">-  card.setCardValue(&quot;LastName&quot;, kLNValue);</span>
<a href="#l38.17"></a><span id="l38.17" class="difflineminus">-  card.setCardValue(&quot;DisplayName&quot;, kDNValue);</span>
<a href="#l38.18"></a><span id="l38.18" class="difflineminus">-  card.setCardValue(&quot;PrimaryEmail&quot;, kEmailValue);</span>
<a href="#l38.19"></a><span id="l38.19" class="difflineplus">+  card.setProperty(&quot;FirstName&quot;, kFNValue);</span>
<a href="#l38.20"></a><span id="l38.20" class="difflineplus">+  card.setProperty(&quot;LastName&quot;, kLNValue);</span>
<a href="#l38.21"></a><span id="l38.21" class="difflineplus">+  card.setProperty(&quot;DisplayName&quot;, kDNValue);</span>
<a href="#l38.22"></a><span id="l38.22" class="difflineplus">+  card.setProperty(&quot;PrimaryEmail&quot;, kEmailValue);</span>
<a href="#l38.23"></a><span id="l38.23"> </span>
<a href="#l38.24"></a><span id="l38.24">   do_check_eq(card.firstName, kFNValue);</span>
<a href="#l38.25"></a><span id="l38.25">   do_check_eq(card.lastName, kLNValue);</span>
<a href="#l38.26"></a><span id="l38.26">   do_check_eq(card.displayName, kDNValue);</span>
<a href="#l38.27"></a><span id="l38.27">   do_check_eq(card.primaryEmail, kEmailValue);</span>
<a href="#l38.28"></a><span id="l38.28"> </span>
<a href="#l38.29"></a><span id="l38.29" class="difflineplus">+  // Repeat in the opposite order.</span>
<a href="#l38.30"></a><span id="l38.30" class="difflineplus">+  card.firstName = kFNValue;</span>
<a href="#l38.31"></a><span id="l38.31" class="difflineplus">+  card.lastName = kLNValue;</span>
<a href="#l38.32"></a><span id="l38.32" class="difflineplus">+  card.displayName = kDNValue;</span>
<a href="#l38.33"></a><span id="l38.33" class="difflineplus">+  card.primaryEmail = kEmailValue;</span>
<a href="#l38.34"></a><span id="l38.34" class="difflineplus">+</span>
<a href="#l38.35"></a><span id="l38.35" class="difflineplus">+  do_check_eq(card.getProperty(&quot;FirstName&quot;, &quot;BAD&quot;), kFNValue);</span>
<a href="#l38.36"></a><span id="l38.36" class="difflineplus">+  do_check_eq(card.getProperty(&quot;LastName&quot;, &quot;BAD&quot;), kLNValue);</span>
<a href="#l38.37"></a><span id="l38.37" class="difflineplus">+  do_check_eq(card.getProperty(&quot;DisplayName&quot;, &quot;BAD&quot;), kDNValue);</span>
<a href="#l38.38"></a><span id="l38.38" class="difflineplus">+  do_check_eq(card.getProperty(&quot;PrimaryEmail&quot;, &quot;BAD&quot;), kEmailValue);</span>
<a href="#l38.39"></a><span id="l38.39" class="difflineplus">+</span>
<a href="#l38.40"></a><span id="l38.40">   // Test - generateName. Note: if the addressBook.properties</span>
<a href="#l38.41"></a><span id="l38.41">   // value changes, this will affect these tests.</span>
<a href="#l38.42"></a><span id="l38.42"> </span>
<a href="#l38.43"></a><span id="l38.43">   do_check_eq(card.generateName(0), kDNValue);</span>
<a href="#l38.44"></a><span id="l38.44">   do_check_eq(card.generateName(1), kLNValue + &quot;, &quot; + kFNValue);</span>
<a href="#l38.45"></a><span id="l38.45">   do_check_eq(card.generateName(2), kFNValue + &quot; &quot; + kLNValue);</span>
<a href="#l38.46"></a><span id="l38.46"> </span>
<a href="#l38.47"></a><span id="l38.47">   // Test - generateName, with missing items.</span>
<a href="#l38.48"></a><span id="l38.48" class="difflineat">@@ -56,34 +67,34 @@ function run_test() {</span>
<a href="#l38.49"></a><span id="l38.49"> </span>
<a href="#l38.50"></a><span id="l38.50">   card.primaryEmail = &quot;&quot;;</span>
<a href="#l38.51"></a><span id="l38.51">   do_check_eq(card.generateName(1), &quot;&quot;);</span>
<a href="#l38.52"></a><span id="l38.52">   do_check_eq(card.generateName(2), &quot;&quot;);</span>
<a href="#l38.53"></a><span id="l38.53"> </span>
<a href="#l38.54"></a><span id="l38.54">   // Test - generateNameWithBundle, most of this will have</span>
<a href="#l38.55"></a><span id="l38.55">   // been tested above.</span>
<a href="#l38.56"></a><span id="l38.56"> </span>
<a href="#l38.57"></a><span id="l38.57" class="difflineminus">-  card.setCardValue(&quot;FirstName&quot;, kFNValue);</span>
<a href="#l38.58"></a><span id="l38.58" class="difflineminus">-  card.setCardValue(&quot;LastName&quot;, kLNValue);</span>
<a href="#l38.59"></a><span id="l38.59" class="difflineplus">+  card.firstName = kFNValue;</span>
<a href="#l38.60"></a><span id="l38.60" class="difflineplus">+  card.lastName = kLNValue;</span>
<a href="#l38.61"></a><span id="l38.61"> </span>
<a href="#l38.62"></a><span id="l38.62">   var sbs = Components.classes[&quot;@mozilla.org/intl/stringbundle;1&quot;]</span>
<a href="#l38.63"></a><span id="l38.63">                       .getService(Components.interfaces.nsIStringBundleService);</span>
<a href="#l38.64"></a><span id="l38.64"> </span>
<a href="#l38.65"></a><span id="l38.65">   var bundle = sbs.createBundle(&quot;chrome://messenger/locale/addressbook/addressBook.properties&quot;);</span>
<a href="#l38.66"></a><span id="l38.66"> </span>
<a href="#l38.67"></a><span id="l38.67">   do_check_eq(card.generateName(1, bundle), kLNValue + &quot;, &quot; + kFNValue);</span>
<a href="#l38.68"></a><span id="l38.68"> </span>
<a href="#l38.69"></a><span id="l38.69">   // Test - generatePhoneticName</span>
<a href="#l38.70"></a><span id="l38.70"> </span>
<a href="#l38.71"></a><span id="l38.71" class="difflineminus">-  card.phoneticFirstName = kFNValue;</span>
<a href="#l38.72"></a><span id="l38.72" class="difflineminus">-  card.phoneticLastName = kLNValue;</span>
<a href="#l38.73"></a><span id="l38.73" class="difflineplus">+  card.setProperty(&quot;PhoneticFirstName&quot;, kFNValue);</span>
<a href="#l38.74"></a><span id="l38.74" class="difflineplus">+  card.setProperty(&quot;PhoneticLastName&quot;, kLNValue);</span>
<a href="#l38.75"></a><span id="l38.75">   do_check_eq(card.generatePhoneticName(false), kFNValue + kLNValue);</span>
<a href="#l38.76"></a><span id="l38.76">   do_check_eq(card.generatePhoneticName(true), kLNValue + kFNValue);</span>
<a href="#l38.77"></a><span id="l38.77"> </span>
<a href="#l38.78"></a><span id="l38.78" class="difflineminus">-  card.phoneticLastName = &quot;&quot;;</span>
<a href="#l38.79"></a><span id="l38.79" class="difflineplus">+  card.setProperty(&quot;PhoneticLastName&quot;, &quot;&quot;);</span>
<a href="#l38.80"></a><span id="l38.80">   do_check_eq(card.generatePhoneticName(false), kFNValue);</span>
<a href="#l38.81"></a><span id="l38.81">   do_check_eq(card.generatePhoneticName(true), kFNValue);</span>
<a href="#l38.82"></a><span id="l38.82"> </span>
<a href="#l38.83"></a><span id="l38.83" class="difflineminus">-  card.phoneticFirstName = &quot;&quot;;</span>
<a href="#l38.84"></a><span id="l38.84" class="difflineminus">-  card.phoneticLastName = kLNValue;</span>
<a href="#l38.85"></a><span id="l38.85" class="difflineplus">+  card.setProperty(&quot;PhoneticFirstName&quot;, &quot;&quot;);</span>
<a href="#l38.86"></a><span id="l38.86" class="difflineplus">+  card.setProperty(&quot;PhoneticLastName&quot;, kLNValue);</span>
<a href="#l38.87"></a><span id="l38.87">   do_check_eq(card.generatePhoneticName(false), kLNValue);</span>
<a href="#l38.88"></a><span id="l38.88">   do_check_eq(card.generatePhoneticName(true), kLNValue);</span>
<a href="#l38.89"></a><span id="l38.89"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l39.1"></a><span id="l39.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_collection.js</span>
<a href="#l39.2"></a><span id="l39.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_collection.js</span>
<a href="#l39.3"></a><span id="l39.3" class="difflineat">@@ -222,29 +222,29 @@ var collectChecker = {</span>
<a href="#l39.4"></a><span id="l39.4"> </span>
<a href="#l39.5"></a><span id="l39.5">   checkCardResult : function (aDetails, overrideMailFormat) {</span>
<a href="#l39.6"></a><span id="l39.6">     try {</span>
<a href="#l39.7"></a><span id="l39.7">       var card = this.AB.cardForEmailAddress(aDetails.primaryEmail);</span>
<a href="#l39.8"></a><span id="l39.8"> </span>
<a href="#l39.9"></a><span id="l39.9">       do_check_true(card != null);</span>
<a href="#l39.10"></a><span id="l39.10"> </span>
<a href="#l39.11"></a><span id="l39.11">       if (&quot;secondEmail&quot; in aDetails)</span>
<a href="#l39.12"></a><span id="l39.12" class="difflineminus">-        do_check_eq(card.secondEmail, aDetails.secondEmail);</span>
<a href="#l39.13"></a><span id="l39.13" class="difflineplus">+        do_check_eq(card.getProperty(&quot;SecondEmail&quot;, &quot;BAD&quot;), aDetails.secondEmail);</span>
<a href="#l39.14"></a><span id="l39.14"> </span>
<a href="#l39.15"></a><span id="l39.15">       if (overrideMailFormat)</span>
<a href="#l39.16"></a><span id="l39.16" class="difflineminus">-        do_check_eq(card.preferMailFormat, nsIAbPMF.unknown);</span>
<a href="#l39.17"></a><span id="l39.17" class="difflineplus">+        do_check_eq(card.getProperty(&quot;PreferMailFormat&quot;, &quot;BAD&quot;), nsIAbPMF.unknown);</span>
<a href="#l39.18"></a><span id="l39.18">       else if (&quot;mailFormatOut&quot; in aDetails)</span>
<a href="#l39.19"></a><span id="l39.19" class="difflineminus">-        do_check_eq(card.preferMailFormat, aDetails.mailFormatOut);</span>
<a href="#l39.20"></a><span id="l39.20" class="difflineplus">+        do_check_eq(card.getProperty(&quot;PreferMailFormat&quot;, &quot;BAD&quot;), aDetails.mailFormatOut);</span>
<a href="#l39.21"></a><span id="l39.21">       else</span>
<a href="#l39.22"></a><span id="l39.22" class="difflineminus">-        do_check_eq(card.preferMailFormat, aDetails.mailFormat);</span>
<a href="#l39.23"></a><span id="l39.23" class="difflineplus">+        do_check_eq(card.getProperty(&quot;PreferMailFormat&quot;, &quot;BAD&quot;), aDetails.mailFormat);</span>
<a href="#l39.24"></a><span id="l39.24"> </span>
<a href="#l39.25"></a><span id="l39.25">       do_check_eq(card.displayName, aDetails.displayName);</span>
<a href="#l39.26"></a><span id="l39.26">       do_check_eq(card.firstName, aDetails.firstName);</span>
<a href="#l39.27"></a><span id="l39.27">       do_check_eq(card.lastName, aDetails.lastName);</span>
<a href="#l39.28"></a><span id="l39.28" class="difflineminus">-      do_check_eq(card.aimScreenName, aDetails.screenName);</span>
<a href="#l39.29"></a><span id="l39.29" class="difflineplus">+      do_check_eq(card.getProperty(&quot;_AimScreenName&quot;, &quot;&quot;), aDetails.screenName);</span>
<a href="#l39.30"></a><span id="l39.30">     }</span>
<a href="#l39.31"></a><span id="l39.31">     catch (e) {</span>
<a href="#l39.32"></a><span id="l39.32">       throw &quot;FAILED in checkCardResult emailHeader: &quot; + aDetails.emailHeader + &quot; : &quot; + e;</span>
<a href="#l39.33"></a><span id="l39.33">     }</span>
<a href="#l39.34"></a><span id="l39.34">   }</span>
<a href="#l39.35"></a><span id="l39.35"> };</span>
<a href="#l39.36"></a><span id="l39.36"> </span>
<a href="#l39.37"></a><span id="l39.37"> function run_test()</span>
<a href="#l39.38"></a><span id="l39.38" class="difflineat">@@ -327,16 +327,16 @@ function run_test()</span>
<a href="#l39.39"></a><span id="l39.39">   // Test - Try and modify various emails and formats.</span>
<a href="#l39.40"></a><span id="l39.40"> </span>
<a href="#l39.41"></a><span id="l39.41">   // Add a basic card with just primary and second email to allow testing</span>
<a href="#l39.42"></a><span id="l39.42">   // of the case where we don't modify when second email is matching.</span>
<a href="#l39.43"></a><span id="l39.43">   card = Components.classes[&quot;@mozilla.org/addressbook/cardproperty;1&quot;]</span>
<a href="#l39.44"></a><span id="l39.44">                    .createInstance(Components.interfaces.nsIAbCard);</span>
<a href="#l39.45"></a><span id="l39.45"> </span>
<a href="#l39.46"></a><span id="l39.46">   card.primaryEmail = &quot;userprim\u00D0@invalid.com&quot;;</span>
<a href="#l39.47"></a><span id="l39.47" class="difflineminus">-  card.secondEmail = &quot;usersec\u00D0@invalid.com&quot;;</span>
<a href="#l39.48"></a><span id="l39.48" class="difflineplus">+  card.setProperty(&quot;SecondEmail&quot;, &quot;usersec\u00D0@invalid.com&quot;);</span>
<a href="#l39.49"></a><span id="l39.49"> </span>
<a href="#l39.50"></a><span id="l39.50">   CAB.addCard(card);</span>
<a href="#l39.51"></a><span id="l39.51"> </span>
<a href="#l39.52"></a><span id="l39.52">   collectChecker.part = 0;</span>
<a href="#l39.53"></a><span id="l39.53"> </span>
<a href="#l39.54"></a><span id="l39.54">   modifyEmailChecks.forEach(collectChecker.checkAddress, collectChecker);</span>
<a href="#l39.55"></a><span id="l39.55"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l40.1"></a><span id="l40.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch1.js</span>
<a href="#l40.2"></a><span id="l40.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch1.js</span>
<a href="#l40.3"></a><span id="l40.3" class="difflineat">@@ -244,26 +244,26 @@ function run_test() {</span>
<a href="#l40.4"></a><span id="l40.4">     var card = childCards.getNext().QueryInterface(Ci.nsIAbCard);</span>
<a href="#l40.5"></a><span id="l40.5"> </span>
<a href="#l40.6"></a><span id="l40.6">     if (card.isMailList)</span>
<a href="#l40.7"></a><span id="l40.7">       continue;</span>
<a href="#l40.8"></a><span id="l40.8"> </span>
<a href="#l40.9"></a><span id="l40.9">     switch (card.displayName) {</span>
<a href="#l40.10"></a><span id="l40.10">     case &quot;dis&quot;:</span>
<a href="#l40.11"></a><span id="l40.11">     case &quot;disp&quot;:</span>
<a href="#l40.12"></a><span id="l40.12" class="difflineminus">-      card.popularityIndex = &quot;4&quot;;</span>
<a href="#l40.13"></a><span id="l40.13" class="difflineplus">+      card.setProperty(&quot;PopularityIndex&quot;, 4);</span>
<a href="#l40.14"></a><span id="l40.14">       break;</span>
<a href="#l40.15"></a><span id="l40.15">     case &quot;displ&quot;:</span>
<a href="#l40.16"></a><span id="l40.16" class="difflineminus">-      card.popularityIndex = &quot;5&quot;;</span>
<a href="#l40.17"></a><span id="l40.17" class="difflineplus">+      card.setProperty(&quot;PopularityIndex&quot;, 5);</span>
<a href="#l40.18"></a><span id="l40.18">       break;</span>
<a href="#l40.19"></a><span id="l40.19">     case &quot;d&quot;:</span>
<a href="#l40.20"></a><span id="l40.20" class="difflineminus">-      card.popularityIndex = &quot;1&quot;;</span>
<a href="#l40.21"></a><span id="l40.21" class="difflineplus">+      card.setProperty(&quot;PopularityIndex&quot;, 1);</span>
<a href="#l40.22"></a><span id="l40.22">       break;</span>
<a href="#l40.23"></a><span id="l40.23">     case &quot;di&quot;:</span>
<a href="#l40.24"></a><span id="l40.24" class="difflineminus">-      card.popularityIndex = &quot;20&quot;;</span>
<a href="#l40.25"></a><span id="l40.25" class="difflineplus">+      card.setProperty(&quot;PopularityIndex&quot;, 20);</span>
<a href="#l40.26"></a><span id="l40.26">       break;</span>
<a href="#l40.27"></a><span id="l40.27">     default:</span>
<a href="#l40.28"></a><span id="l40.28">       break;</span>
<a href="#l40.29"></a><span id="l40.29">     }</span>
<a href="#l40.30"></a><span id="l40.30"> </span>
<a href="#l40.31"></a><span id="l40.31">     pab.modifyCard(card);</span>
<a href="#l40.32"></a><span id="l40.32">   }</span>
<a href="#l40.33"></a><span id="l40.33"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l41.1"></a><span id="l41.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch2.js</span>
<a href="#l41.2"></a><span id="l41.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch2.js</span>
<a href="#l41.3"></a><span id="l41.3" class="difflineat">@@ -14,17 +14,17 @@ do_import_script(&quot;../mailnews/addrbook/s</span>
<a href="#l41.4"></a><span id="l41.4"> function createCard(chars, popularity) {</span>
<a href="#l41.5"></a><span id="l41.5">   var card = Components.classes[&quot;@mozilla.org/addressbook/cardproperty;1&quot;]</span>
<a href="#l41.6"></a><span id="l41.6">                        .createInstance(Components.interfaces.nsIAbCard);</span>
<a href="#l41.7"></a><span id="l41.7"> </span>
<a href="#l41.8"></a><span id="l41.8">   card.firstName = &quot;firstName&quot;.slice(0, chars);</span>
<a href="#l41.9"></a><span id="l41.9">   card.lastName = &quot;lastName&quot;.slice(0, chars);</span>
<a href="#l41.10"></a><span id="l41.10">   card.displayName = &quot;displayName&quot;.slice(0, chars);</span>
<a href="#l41.11"></a><span id="l41.11">   card.primaryEmail = &quot;email&quot;.slice(0, chars) + &quot;@invalid.com&quot;;</span>
<a href="#l41.12"></a><span id="l41.12" class="difflineminus">-  card.nickName = &quot;nickName&quot;.slice(0, chars);</span>
<a href="#l41.13"></a><span id="l41.13" class="difflineplus">+  card.setProperty(&quot;NickName&quot;, &quot;nickName&quot;.slice(0, chars));</span>
<a href="#l41.14"></a><span id="l41.14"> </span>
<a href="#l41.15"></a><span id="l41.15">   return card;</span>
<a href="#l41.16"></a><span id="l41.16"> }</span>
<a href="#l41.17"></a><span id="l41.17"> </span>
<a href="#l41.18"></a><span id="l41.18"> const lastSearchCards = [ createCard(1, 0), createCard(2, 0), createCard(3, 0) ];</span>
<a href="#l41.19"></a><span id="l41.19"> </span>
<a href="#l41.20"></a><span id="l41.20"> const results = [ { email: &quot;d &lt;e@invalid.com&gt;&quot;, dirName: kPABData.dirName },</span>
<a href="#l41.21"></a><span id="l41.21">                   { email: &quot;di &lt;em@invalid.com&gt;&quot;, dirName: kPABData.dirName },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l42.1"></a><span id="l42.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch3.js</span>
<a href="#l42.2"></a><span id="l42.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch3.js</span>
<a href="#l42.3"></a><span id="l42.3" class="difflineat">@@ -53,17 +53,17 @@ function run_test()</span>
<a href="#l42.4"></a><span id="l42.4">   var ab = abManager.getDirectory(kPABData.URI);</span>
<a href="#l42.5"></a><span id="l42.5"> </span>
<a href="#l42.6"></a><span id="l42.6">   function createAndAddCard(element) {</span>
<a href="#l42.7"></a><span id="l42.7">     var card = Cc[&quot;@mozilla.org/addressbook/cardproperty;1&quot;]</span>
<a href="#l42.8"></a><span id="l42.8">                  .createInstance(Ci.nsIAbCard);</span>
<a href="#l42.9"></a><span id="l42.9"> </span>
<a href="#l42.10"></a><span id="l42.10">     card.primaryEmail = element.email;</span>
<a href="#l42.11"></a><span id="l42.11">     card.displayName = element.displayName;</span>
<a href="#l42.12"></a><span id="l42.12" class="difflineminus">-    card.popularityIndex = element.popularityIndex;</span>
<a href="#l42.13"></a><span id="l42.13" class="difflineplus">+    card.setProperty(&quot;PopularityIndex&quot;, element.popularityIndex);</span>
<a href="#l42.14"></a><span id="l42.14">     card.firstName = element.firstName;</span>
<a href="#l42.15"></a><span id="l42.15"> </span>
<a href="#l42.16"></a><span id="l42.16">     ab.addCard(card);</span>
<a href="#l42.17"></a><span id="l42.17">   }</span>
<a href="#l42.18"></a><span id="l42.18"> </span>
<a href="#l42.19"></a><span id="l42.19">   cards.forEach(createAndAddCard);</span>
<a href="#l42.20"></a><span id="l42.20"> </span>
<a href="#l42.21"></a><span id="l42.21">   // Test - duplicate elements</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l43.1"></a><span id="l43.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_nsIAbCard.js</span>
<a href="#l43.2"></a><span id="l43.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_nsIAbCard.js</span>
<a href="#l43.3"></a><span id="l43.3" class="difflineat">@@ -33,23 +33,25 @@ function run_test() {</span>
<a href="#l43.4"></a><span id="l43.4">     // We want the one with the right email...</span>
<a href="#l43.5"></a><span id="l43.5">     if (tempCard instanceof Components.interfaces.nsIAbCard &amp;&amp;</span>
<a href="#l43.6"></a><span id="l43.6">         tempCard.primaryEmail == &quot;PrimaryEmail1@test.invalid&quot;)</span>
<a href="#l43.7"></a><span id="l43.7">       fullCard = tempCard;</span>
<a href="#l43.8"></a><span id="l43.8">   }</span>
<a href="#l43.9"></a><span id="l43.9"> </span>
<a href="#l43.10"></a><span id="l43.10">   do_check_true(fullCard != null);</span>
<a href="#l43.11"></a><span id="l43.11"> </span>
<a href="#l43.12"></a><span id="l43.12" class="difflineminus">-  // Test - convertToEscapedVCard.</span>
<a href="#l43.13"></a><span id="l43.13" class="difflineplus">+  // Test - VCard.</span>
<a href="#l43.14"></a><span id="l43.14"> </span>
<a href="#l43.15"></a><span id="l43.15" class="difflineminus">-  do_check_eq(fullCard.convertToEscapedVCard(),</span>
<a href="#l43.16"></a><span id="l43.16" class="difflineplus">+  do_check_eq(fullCard.translateTo(&quot;vcard&quot;),</span>
<a href="#l43.17"></a><span id="l43.17">               &quot;begin%3Avcard%0D%0Afn%3ADisplayName1%0D%0An%3ALastName1%3BFirstName1%0D%0Aorg%3AOrganization1%3BDepartment1%0D%0Aadr%3AWorkAddress21%3B%3BWorkAddress1%3BWorkCity1%3BWorkState1%3BWorkZipCode1%3BWorkCountry1%0D%0Aemail%3Binternet%3APrimaryEmail1%40test.invalid%0D%0Atitle%3AJobTitle1%0D%0Atel%3Bwork%3AWorkPhone1%0D%0Atel%3Bfax%3AFaxNumber1%0D%0Atel%3Bpager%3APagerNumber1%0D%0Atel%3Bhome%3AHomePhone1%0D%0Atel%3Bcell%3ACellularNumber1%0D%0Anote%3ANotes1%0D%0Aurl%3Ahttp%3A//WebPage21%0D%0Aversion%3A2.1%0D%0Aend%3Avcard%0D%0A%0D%0A&quot;);</span>
<a href="#l43.18"></a><span id="l43.18"> </span>
<a href="#l43.19"></a><span id="l43.19" class="difflineminus">-  // Test - convertToXMLPrintData()</span>
<a href="#l43.20"></a><span id="l43.20" class="difflineplus">+  // Test - XML</span>
<a href="#l43.21"></a><span id="l43.21"> </span>
<a href="#l43.22"></a><span id="l43.22" class="difflineminus">-  do_check_eq(fullCard.convertToXMLPrintData(), &quot;&lt;GeneratedName&gt;\nDisplayName1&lt;/GeneratedName&gt;\n&lt;table&gt;&lt;tr&gt;&lt;td&gt;&lt;section&gt;&lt;labelrow&gt;&lt;label&gt;Display Name: &lt;/label&gt;&lt;DisplayName&gt;DisplayName1&lt;/DisplayName&gt;&lt;/labelrow&gt;&lt;labelrow&gt;&lt;label&gt;Nickname: &lt;/label&gt;&lt;NickName&gt;NickName1&lt;/NickName&gt;&lt;/labelrow&gt;&lt;PrimaryEmail&gt;PrimaryEmail1@test.invalid&lt;/PrimaryEmail&gt;&lt;SecondEmail&gt;SecondEmail1@test.invalid&lt;/SecondEmail&gt;&lt;labelrow&gt;&lt;label&gt;Screen Name: &lt;/label&gt;&lt;_AimScreenName&gt;ScreenName1&lt;/_AimScreenName&gt;&lt;/labelrow&gt;&lt;/section&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;section&gt;&lt;sectiontitle&gt;Phone&lt;/sectiontitle&gt;&lt;labelrow&gt;&lt;label&gt;Work: &lt;/label&gt;&lt;WorkPhone&gt;WorkPhone1&lt;/WorkPhone&gt;&lt;/labelrow&gt;&lt;labelrow&gt;&lt;label&gt;Home: &lt;/label&gt;&lt;HomePhone&gt;HomePhone1&lt;/HomePhone&gt;&lt;/labelrow&gt;&lt;labelrow&gt;&lt;label&gt;Fax: &lt;/label&gt;&lt;FaxNumber&gt;FaxNumber1&lt;/FaxNumber&gt;&lt;/labelrow&gt;&lt;labelrow&gt;&lt;label&gt;Pager: &lt;/label&gt;&lt;PagerNumber&gt;PagerNumber1&lt;/PagerNumber&gt;&lt;/labelrow&gt;&lt;labelrow&gt;&lt;label&gt;Mobile: &lt;/label&gt;&lt;CellularNumber&gt;CellularNumber1&lt;/CellularNumber&gt;&lt;/labelrow&gt;&lt;/section&gt;&lt;section&gt;&lt;sectiontitle&gt;Other&lt;/sectiontitle&gt;&lt;labelrow&gt;&lt;label&gt;Custom 1: &lt;/label&gt;&lt;Custom1&gt;Custom11&lt;/Custom1&gt;&lt;/labelrow&gt;&lt;labelrow&gt;&lt;label&gt;Custom 2: &lt;/label&gt;&lt;Custom2&gt;Custom21&lt;/Custom2&gt;&lt;/labelrow&gt;&lt;labelrow&gt;&lt;label&gt;Custom 3: &lt;/label&gt;&lt;Custom3&gt;Custom31&lt;/Custom3&gt;&lt;/labelrow&gt;&lt;labelrow&gt;&lt;label&gt;Custom 4: &lt;/label&gt;&lt;Custom4&gt;Custom41&lt;/Custom4&gt;&lt;/labelrow&gt;&lt;Notes&gt;Notes1&lt;/Notes&gt;&lt;/section&gt;&lt;/td&gt;&lt;td&gt;&lt;section&gt;&lt;sectiontitle&gt;Home&lt;/sectiontitle&gt;&lt;HomeAddress&gt;HomeAddress11&lt;/HomeAddress&gt;&lt;HomeAddress2&gt;HomeAddress21&lt;/HomeAddress2&gt;&lt;HomeCity&gt;HomeCity1&lt;/HomeCity&gt;, &lt;HomeState&gt;HomeState1&lt;/HomeState&gt; &lt;HomeZipCode&gt;HomeZipCode1&lt;/HomeZipCode&gt;&lt;HomeCountry&gt;HomeCountry1&lt;/HomeCountry&gt;&lt;WebPage2&gt;http://WebPage11&lt;/WebPage2&gt;&lt;/section&gt;&lt;section&gt;&lt;sectiontitle&gt;Work&lt;/sectiontitle&gt;&lt;JobTitle&gt;JobTitle1&lt;/JobTitle&gt;&lt;Department&gt;Department1&lt;/Department&gt;&lt;Company&gt;Organization1&lt;/Company&gt;&lt;WorkAddress&gt;WorkAddress1&lt;/WorkAddress&gt;&lt;WorkAddress2&gt;WorkAddress21&lt;/WorkAddress2&gt;&lt;WorkCity&gt;WorkCity1&lt;/WorkCity&gt;, &lt;WorkState&gt;WorkState1&lt;/WorkState&gt; &lt;WorkZipCode&gt;WorkZipCode1&lt;/WorkZipCode&gt;&lt;WorkCountry&gt;WorkCountry1&lt;/WorkCountry&gt;&lt;WebPage1&gt;http://WebPage21&lt;/WebPage1&gt;&lt;/section&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&quot;);</span>
<a href="#l43.23"></a><span id="l43.23" class="difflineplus">+  do_check_eq(fullCard.translateTo(&quot;xml&quot;),</span>
<a href="#l43.24"></a><span id="l43.24" class="difflineplus">+              &quot;&lt;GeneratedName&gt;\nDisplayName1&lt;/GeneratedName&gt;\n&lt;table&gt;&lt;tr&gt;&lt;td&gt;&lt;section&gt;&lt;labelrow&gt;&lt;label&gt;Display Name: &lt;/label&gt;&lt;DisplayName&gt;DisplayName1&lt;/DisplayName&gt;&lt;/labelrow&gt;&lt;labelrow&gt;&lt;label&gt;Nickname: &lt;/label&gt;&lt;NickName&gt;NickName1&lt;/NickName&gt;&lt;/labelrow&gt;&lt;PrimaryEmail&gt;PrimaryEmail1@test.invalid&lt;/PrimaryEmail&gt;&lt;SecondEmail&gt;SecondEmail1@test.invalid&lt;/SecondEmail&gt;&lt;labelrow&gt;&lt;label&gt;Screen Name: &lt;/label&gt;&lt;_AimScreenName&gt;ScreenName1&lt;/_AimScreenName&gt;&lt;/labelrow&gt;&lt;/section&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;section&gt;&lt;sectiontitle&gt;Phone&lt;/sectiontitle&gt;&lt;labelrow&gt;&lt;label&gt;Work: &lt;/label&gt;&lt;WorkPhone&gt;WorkPhone1&lt;/WorkPhone&gt;&lt;/labelrow&gt;&lt;labelrow&gt;&lt;label&gt;Home: &lt;/label&gt;&lt;HomePhone&gt;HomePhone1&lt;/HomePhone&gt;&lt;/labelrow&gt;&lt;labelrow&gt;&lt;label&gt;Fax: &lt;/label&gt;&lt;FaxNumber&gt;FaxNumber1&lt;/FaxNumber&gt;&lt;/labelrow&gt;&lt;labelrow&gt;&lt;label&gt;Pager: &lt;/label&gt;&lt;PagerNumber&gt;PagerNumber1&lt;/PagerNumber&gt;&lt;/labelrow&gt;&lt;labelrow&gt;&lt;label&gt;Mobile: &lt;/label&gt;&lt;CellularNumber&gt;CellularNumber1&lt;/CellularNumber&gt;&lt;/labelrow&gt;&lt;/section&gt;&lt;section&gt;&lt;sectiontitle&gt;Other&lt;/sectiontitle&gt;&lt;labelrow&gt;&lt;label&gt;Custom 1: &lt;/label&gt;&lt;Custom1&gt;Custom11&lt;/Custom1&gt;&lt;/labelrow&gt;&lt;labelrow&gt;&lt;label&gt;Custom 2: &lt;/label&gt;&lt;Custom2&gt;Custom21&lt;/Custom2&gt;&lt;/labelrow&gt;&lt;labelrow&gt;&lt;label&gt;Custom 3: &lt;/label&gt;&lt;Custom3&gt;Custom31&lt;/Custom3&gt;&lt;/labelrow&gt;&lt;labelrow&gt;&lt;label&gt;Custom 4: &lt;/label&gt;&lt;Custom4&gt;Custom41&lt;/Custom4&gt;&lt;/labelrow&gt;&lt;Notes&gt;Notes1&lt;/Notes&gt;&lt;/section&gt;&lt;/td&gt;&lt;td&gt;&lt;section&gt;&lt;sectiontitle&gt;Home&lt;/sectiontitle&gt;&lt;HomeAddress&gt;HomeAddress11&lt;/HomeAddress&gt;&lt;HomeAddress2&gt;HomeAddress21&lt;/HomeAddress2&gt;&lt;HomeCity&gt;HomeCity1&lt;/HomeCity&gt;, &lt;HomeState&gt;HomeState1&lt;/HomeState&gt; &lt;HomeZipCode&gt;HomeZipCode1&lt;/HomeZipCode&gt;&lt;HomeCountry&gt;HomeCountry1&lt;/HomeCountry&gt;&lt;WebPage2&gt;http://WebPage11&lt;/WebPage2&gt;&lt;/section&gt;&lt;section&gt;&lt;sectiontitle&gt;Work&lt;/sectiontitle&gt;&lt;JobTitle&gt;JobTitle1&lt;/JobTitle&gt;&lt;Department&gt;Department1&lt;/Department&gt;&lt;Company&gt;Organization1&lt;/Company&gt;&lt;WorkAddress&gt;WorkAddress1&lt;/WorkAddress&gt;&lt;WorkAddress2&gt;WorkAddress21&lt;/WorkAddress2&gt;&lt;WorkCity&gt;WorkCity1&lt;/WorkCity&gt;, &lt;WorkState&gt;WorkState1&lt;/WorkState&gt; &lt;WorkZipCode&gt;WorkZipCode1&lt;/WorkZipCode&gt;&lt;WorkCountry&gt;WorkCountry1&lt;/WorkCountry&gt;&lt;WebPage1&gt;http://WebPage21&lt;/WebPage1&gt;&lt;/section&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&quot;);</span>
<a href="#l43.25"></a><span id="l43.25"> </span>
<a href="#l43.26"></a><span id="l43.26" class="difflineminus">-  // Test - convertToBase64EncodedXML()</span>
<a href="#l43.27"></a><span id="l43.27" class="difflineplus">+  // Test - base 64</span>
<a href="#l43.28"></a><span id="l43.28"> </span>
<a href="#l43.29"></a><span id="l43.29">   // btoa is only available for xpcom components or via window.btoa, so we</span>
<a href="#l43.30"></a><span id="l43.30">   // can't use it here.</span>
<a href="#l43.31"></a><span id="l43.31" class="difflineminus">-  do_check_eq(fullCard.convertToBase64EncodedXML(), &quot;PD94bWwgdmVyc2lvbj0iMS4wIj8+Cjw/eG1sLXN0eWxlc2hlZXQgdHlwZT0idGV4dC9jc3MiIGhyZWY9ImNocm9tZTovL21lc3Nlbmdlci9jb250ZW50L2FkZHJlc3Nib29rL3ByaW50LmNzcyI/Pgo8ZGlyZWN0b3J5Pgo8dGl0bGUgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwiPkFkZHJlc3MgQm9vazwvdGl0bGU+CjxHZW5lcmF0ZWROYW1lPgpEaXNwbGF5TmFtZTE8L0dlbmVyYXRlZE5hbWU+Cjx0YWJsZT48dHI+PHRkPjxzZWN0aW9uPjxsYWJlbHJvdz48bGFiZWw+RGlzcGxheSBOYW1lOiA8L2xhYmVsPjxEaXNwbGF5TmFtZT5EaXNwbGF5TmFtZTE8L0Rpc3BsYXlOYW1lPjwvbGFiZWxyb3c+PGxhYmVscm93PjxsYWJlbD5OaWNrbmFtZTogPC9sYWJlbD48Tmlja05hbWU+Tmlja05hbWUxPC9OaWNrTmFtZT48L2xhYmVscm93PjxQcmltYXJ5RW1haWw+UHJpbWFyeUVtYWlsMUB0ZXN0LmludmFsaWQ8L1ByaW1hcnlFbWFpbD48U2Vjb25kRW1haWw+U2Vjb25kRW1haWwxQHRlc3QuaW52YWxpZDwvU2Vjb25kRW1haWw+PGxhYmVscm93PjxsYWJlbD5TY3JlZW4gTmFtZTogPC9sYWJlbD48X0FpbVNjcmVlbk5hbWU+U2NyZWVuTmFtZTE8L19BaW1TY3JlZW5OYW1lPjwvbGFiZWxyb3c+PC9zZWN0aW9uPjwvdGQ+PC90cj48dHI+PHRkPjxzZWN0aW9uPjxzZWN0aW9udGl0bGU+UGhvbmU8L3NlY3Rpb250aXRsZT48bGFiZWxyb3c+PGxhYmVsPldvcms6IDwvbGFiZWw+PFdvcmtQaG9uZT5Xb3JrUGhvbmUxPC9Xb3JrUGhvbmU+PC9sYWJlbHJvdz48bGFiZWxyb3c+PGxhYmVsPkhvbWU6IDwvbGFiZWw+PEhvbWVQaG9uZT5Ib21lUGhvbmUxPC9Ib21lUGhvbmU+PC9sYWJlbHJvdz48bGFiZWxyb3c+PGxhYmVsPkZheDogPC9sYWJlbD48RmF4TnVtYmVyPkZheE51bWJlcjE8L0ZheE51bWJlcj48L2xhYmVscm93PjxsYWJlbHJvdz48bGFiZWw+UGFnZXI6IDwvbGFiZWw+PFBhZ2VyTnVtYmVyPlBhZ2VyTnVtYmVyMTwvUGFnZXJOdW1iZXI+PC9sYWJlbHJvdz48bGFiZWxyb3c+PGxhYmVsPk1vYmlsZTogPC9sYWJlbD48Q2VsbHVsYXJOdW1iZXI+Q2VsbHVsYXJOdW1iZXIxPC9DZWxsdWxhck51bWJlcj48L2xhYmVscm93Pjwvc2VjdGlvbj48c2VjdGlvbj48c2VjdGlvbnRpdGxlPk90aGVyPC9zZWN0aW9udGl0bGU+PGxhYmVscm93PjxsYWJlbD5DdXN0b20gMTogPC9sYWJlbD48Q3VzdG9tMT5DdXN0b20xMTwvQ3VzdG9tMT48L2xhYmVscm93PjxsYWJlbHJvdz48bGFiZWw+Q3VzdG9tIDI6IDwvbGFiZWw+PEN1c3RvbTI+Q3VzdG9tMjE8L0N1c3RvbTI+PC9sYWJlbHJvdz48bGFiZWxyb3c+PGxhYmVsPkN1c3RvbSAzOiA8L2xhYmVsPjxDdXN0b20zPkN1c3RvbTMxPC9DdXN0b20zPjwvbGFiZWxyb3c+PGxhYmVscm93PjxsYWJlbD5DdXN0b20gNDogPC9sYWJlbD48Q3VzdG9tND5DdXN0b200MTwvQ3VzdG9tND48L2xhYmVscm93PjxOb3Rlcz5Ob3RlczE8L05vdGVzPjwvc2VjdGlvbj48L3RkPjx0ZD48c2VjdGlvbj48c2VjdGlvbnRpdGxlPkhvbWU8L3NlY3Rpb250aXRsZT48SG9tZUFkZHJlc3M+SG9tZUFkZHJlc3MxMTwvSG9tZUFkZHJlc3M+PEhvbWVBZGRyZXNzMj5Ib21lQWRkcmVzczIxPC9Ib21lQWRkcmVzczI+PEhvbWVDaXR5PkhvbWVDaXR5MTwvSG9tZUNpdHk+LCA8SG9tZVN0YXRlPkhvbWVTdGF0ZTE8L0hvbWVTdGF0ZT4gPEhvbWVaaXBDb2RlPkhvbWVaaXBDb2RlMTwvSG9tZVppcENvZGU+PEhvbWVDb3VudHJ5PkhvbWVDb3VudHJ5MTwvSG9tZUNvdW50cnk+PFdlYlBhZ2UyPmh0dHA6Ly9XZWJQYWdlMTE8L1dlYlBhZ2UyPjwvc2VjdGlvbj48c2VjdGlvbj48c2VjdGlvbnRpdGxlPldvcms8L3NlY3Rpb250aXRsZT48Sm9iVGl0bGU+Sm9iVGl0bGUxPC9Kb2JUaXRsZT48RGVwYXJ0bWVudD5EZXBhcnRtZW50MTwvRGVwYXJ0bWVudD48Q29tcGFueT5Pcmdhbml6YXRpb24xPC9Db21wYW55PjxXb3JrQWRkcmVzcz5Xb3JrQWRkcmVzczE8L1dvcmtBZGRyZXNzPjxXb3JrQWRkcmVzczI+V29ya0FkZHJlc3MyMTwvV29ya0FkZHJlc3MyPjxXb3JrQ2l0eT5Xb3JrQ2l0eTE8L1dvcmtDaXR5PiwgPFdvcmtTdGF0ZT5Xb3JrU3RhdGUxPC9Xb3JrU3RhdGU+IDxXb3JrWmlwQ29kZT5Xb3JrWmlwQ29kZTE8L1dvcmtaaXBDb2RlPjxXb3JrQ291bnRyeT5Xb3JrQ291bnRyeTE8L1dvcmtDb3VudHJ5PjxXZWJQYWdlMT5odHRwOi8vV2ViUGFnZTIxPC9XZWJQYWdlMT48L3NlY3Rpb24+PC90ZD48L3RyPjwvdGFibGU+PC9kaXJlY3Rvcnk+Cg==&quot;);</span>
<a href="#l43.32"></a><span id="l43.32" class="difflineplus">+  do_check_eq(fullCard.translateTo(&quot;base64&quot;),</span>
<a href="#l43.33"></a><span id="l43.33" class="difflineplus">+              &quot;PD94bWwgdmVyc2lvbj0iMS4wIj8+Cjw/eG1sLXN0eWxlc2hlZXQgdHlwZT0idGV4dC9jc3MiIGhyZWY9ImNocm9tZTovL21lc3Nlbmdlci9jb250ZW50L2FkZHJlc3Nib29rL3ByaW50LmNzcyI/Pgo8ZGlyZWN0b3J5Pgo8dGl0bGUgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwiPkFkZHJlc3MgQm9vazwvdGl0bGU+CjxHZW5lcmF0ZWROYW1lPgpEaXNwbGF5TmFtZTE8L0dlbmVyYXRlZE5hbWU+Cjx0YWJsZT48dHI+PHRkPjxzZWN0aW9uPjxsYWJlbHJvdz48bGFiZWw+RGlzcGxheSBOYW1lOiA8L2xhYmVsPjxEaXNwbGF5TmFtZT5EaXNwbGF5TmFtZTE8L0Rpc3BsYXlOYW1lPjwvbGFiZWxyb3c+PGxhYmVscm93PjxsYWJlbD5OaWNrbmFtZTogPC9sYWJlbD48Tmlja05hbWU+Tmlja05hbWUxPC9OaWNrTmFtZT48L2xhYmVscm93PjxQcmltYXJ5RW1haWw+UHJpbWFyeUVtYWlsMUB0ZXN0LmludmFsaWQ8L1ByaW1hcnlFbWFpbD48U2Vjb25kRW1haWw+U2Vjb25kRW1haWwxQHRlc3QuaW52YWxpZDwvU2Vjb25kRW1haWw+PGxhYmVscm93PjxsYWJlbD5TY3JlZW4gTmFtZTogPC9sYWJlbD48X0FpbVNjcmVlbk5hbWU+U2NyZWVuTmFtZTE8L19BaW1TY3JlZW5OYW1lPjwvbGFiZWxyb3c+PC9zZWN0aW9uPjwvdGQ+PC90cj48dHI+PHRkPjxzZWN0aW9uPjxzZWN0aW9udGl0bGU+UGhvbmU8L3NlY3Rpb250aXRsZT48bGFiZWxyb3c+PGxhYmVsPldvcms6IDwvbGFiZWw+PFdvcmtQaG9uZT5Xb3JrUGhvbmUxPC9Xb3JrUGhvbmU+PC9sYWJlbHJvdz48bGFiZWxyb3c+PGxhYmVsPkhvbWU6IDwvbGFiZWw+PEhvbWVQaG9uZT5Ib21lUGhvbmUxPC9Ib21lUGhvbmU+PC9sYWJlbHJvdz48bGFiZWxyb3c+PGxhYmVsPkZheDogPC9sYWJlbD48RmF4TnVtYmVyPkZheE51bWJlcjE8L0ZheE51bWJlcj48L2xhYmVscm93PjxsYWJlbHJvdz48bGFiZWw+UGFnZXI6IDwvbGFiZWw+PFBhZ2VyTnVtYmVyPlBhZ2VyTnVtYmVyMTwvUGFnZXJOdW1iZXI+PC9sYWJlbHJvdz48bGFiZWxyb3c+PGxhYmVsPk1vYmlsZTogPC9sYWJlbD48Q2VsbHVsYXJOdW1iZXI+Q2VsbHVsYXJOdW1iZXIxPC9DZWxsdWxhck51bWJlcj48L2xhYmVscm93Pjwvc2VjdGlvbj48c2VjdGlvbj48c2VjdGlvbnRpdGxlPk90aGVyPC9zZWN0aW9udGl0bGU+PGxhYmVscm93PjxsYWJlbD5DdXN0b20gMTogPC9sYWJlbD48Q3VzdG9tMT5DdXN0b20xMTwvQ3VzdG9tMT48L2xhYmVscm93PjxsYWJlbHJvdz48bGFiZWw+Q3VzdG9tIDI6IDwvbGFiZWw+PEN1c3RvbTI+Q3VzdG9tMjE8L0N1c3RvbTI+PC9sYWJlbHJvdz48bGFiZWxyb3c+PGxhYmVsPkN1c3RvbSAzOiA8L2xhYmVsPjxDdXN0b20zPkN1c3RvbTMxPC9DdXN0b20zPjwvbGFiZWxyb3c+PGxhYmVscm93PjxsYWJlbD5DdXN0b20gNDogPC9sYWJlbD48Q3VzdG9tND5DdXN0b200MTwvQ3VzdG9tND48L2xhYmVscm93PjxOb3Rlcz5Ob3RlczE8L05vdGVzPjwvc2VjdGlvbj48L3RkPjx0ZD48c2VjdGlvbj48c2VjdGlvbnRpdGxlPkhvbWU8L3NlY3Rpb250aXRsZT48SG9tZUFkZHJlc3M+SG9tZUFkZHJlc3MxMTwvSG9tZUFkZHJlc3M+PEhvbWVBZGRyZXNzMj5Ib21lQWRkcmVzczIxPC9Ib21lQWRkcmVzczI+PEhvbWVDaXR5PkhvbWVDaXR5MTwvSG9tZUNpdHk+LCA8SG9tZVN0YXRlPkhvbWVTdGF0ZTE8L0hvbWVTdGF0ZT4gPEhvbWVaaXBDb2RlPkhvbWVaaXBDb2RlMTwvSG9tZVppcENvZGU+PEhvbWVDb3VudHJ5PkhvbWVDb3VudHJ5MTwvSG9tZUNvdW50cnk+PFdlYlBhZ2UyPmh0dHA6Ly9XZWJQYWdlMTE8L1dlYlBhZ2UyPjwvc2VjdGlvbj48c2VjdGlvbj48c2VjdGlvbnRpdGxlPldvcms8L3NlY3Rpb250aXRsZT48Sm9iVGl0bGU+Sm9iVGl0bGUxPC9Kb2JUaXRsZT48RGVwYXJ0bWVudD5EZXBhcnRtZW50MTwvRGVwYXJ0bWVudD48Q29tcGFueT5Pcmdhbml6YXRpb24xPC9Db21wYW55PjxXb3JrQWRkcmVzcz5Xb3JrQWRkcmVzczE8L1dvcmtBZGRyZXNzPjxXb3JrQWRkcmVzczI+V29ya0FkZHJlc3MyMTwvV29ya0FkZHJlc3MyPjxXb3JrQ2l0eT5Xb3JrQ2l0eTE8L1dvcmtDaXR5PiwgPFdvcmtTdGF0ZT5Xb3JrU3RhdGUxPC9Xb3JrU3RhdGU+IDxXb3JrWmlwQ29kZT5Xb3JrWmlwQ29kZTE8L1dvcmtaaXBDb2RlPjxXb3JrQ291bnRyeT5Xb3JrQ291bnRyeTE8L1dvcmtDb3VudHJ5PjxXZWJQYWdlMT5odHRwOi8vV2ViUGFnZTIxPC9XZWJQYWdlMT48L3NlY3Rpb24+PC90ZD48L3RyPjwvdGFibGU+PC9kaXJlY3Rvcnk+Cg==&quot;);</span>
<a href="#l43.34"></a><span id="l43.34"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l44.1"></a><span id="l44.1" class="difflineminus">--- a/mailnews/base/resources/content/mailWindowOverlay.js</span>
<a href="#l44.2"></a><span id="l44.2" class="difflineplus">+++ b/mailnews/base/resources/content/mailWindowOverlay.js</span>
<a href="#l44.3"></a><span id="l44.3" class="difflineat">@@ -2310,17 +2310,17 @@ function allowRemoteContentForSender()</span>
<a href="#l44.4"></a><span id="l44.4">     if (addrbook instanceof Components.interfaces.nsIAbMDBDirectory)</span>
<a href="#l44.5"></a><span id="l44.5">       cardForEmailAddress = addrbook.cardForEmailAddress(authorEmailAddress);</span>
<a href="#l44.6"></a><span id="l44.6">   }</span>
<a href="#l44.7"></a><span id="l44.7"> </span>
<a href="#l44.8"></a><span id="l44.8">   var allowRemoteContent = false;</span>
<a href="#l44.9"></a><span id="l44.9">   if (cardForEmailAddress &amp;&amp; addrbook instanceof Components.interfaces.nsIAbDirectory)</span>
<a href="#l44.10"></a><span id="l44.10">   {</span>
<a href="#l44.11"></a><span id="l44.11">     // set the property for remote content</span>
<a href="#l44.12"></a><span id="l44.12" class="difflineminus">-    cardForEmailAddress.allowRemoteContent = true;</span>
<a href="#l44.13"></a><span id="l44.13" class="difflineplus">+    cardForEmailAddress.setProperty(&quot;AllowRemoteContent&quot;, true);</span>
<a href="#l44.14"></a><span id="l44.14">     addrbook.modifyCard(cardForEmailAddress);</span>
<a href="#l44.15"></a><span id="l44.15">     allowRemoteContent = true;</span>
<a href="#l44.16"></a><span id="l44.16">   }</span>
<a href="#l44.17"></a><span id="l44.17">   else</span>
<a href="#l44.18"></a><span id="l44.18">   {</span>
<a href="#l44.19"></a><span id="l44.19">     var args = {primaryEmail:authorEmailAddress, displayName:names.value[0],</span>
<a href="#l44.20"></a><span id="l44.20">                 allowRemoteContent:true};</span>
<a href="#l44.21"></a><span id="l44.21">     // create a new card and set the property</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l45.1"></a><span id="l45.1" class="difflineminus">--- a/mailnews/base/resources/content/msgHdrViewOverlay.js</span>
<a href="#l45.2"></a><span id="l45.2" class="difflineplus">+++ b/mailnews/base/resources/content/msgHdrViewOverlay.js</span>
<a href="#l45.3"></a><span id="l45.3" class="difflineat">@@ -980,17 +980,17 @@ function setFromBuddyIcon(email)</span>
<a href="#l45.4"></a><span id="l45.4">      // better to cache this?</span>
<a href="#l45.5"></a><span id="l45.5">      var myScreenName = pref.getCharPref(&quot;aim.session.screenname&quot;);</span>
<a href="#l45.6"></a><span id="l45.6"> </span>
<a href="#l45.7"></a><span id="l45.7">      if (!abAddressCollector)</span>
<a href="#l45.8"></a><span id="l45.8">        abAddressCollector = Components.classes[abAddressCollectorContractID].getService(Components.interfaces.nsIAbAddressCollecter);</span>
<a href="#l45.9"></a><span id="l45.9"> </span>
<a href="#l45.10"></a><span id="l45.10">      var card = abAddressCollector.getCardFromAttribute(&quot;PrimaryEmail&quot;, email);</span>
<a href="#l45.11"></a><span id="l45.11"> </span>
<a href="#l45.12"></a><span id="l45.12" class="difflineminus">-     if (myScreenName &amp;&amp; card &amp;&amp; card.aimScreenName) {</span>
<a href="#l45.13"></a><span id="l45.13" class="difflineplus">+     if (myScreenName &amp;&amp; card &amp;&amp; card.setProperty(&quot;_AimScreenName&quot;)) {</span>
<a href="#l45.14"></a><span id="l45.14">        if (!gIOService) {</span>
<a href="#l45.15"></a><span id="l45.15">          // lazily create these globals</span>
<a href="#l45.16"></a><span id="l45.16">          gIOService = Components.classes[&quot;@mozilla.org/network/io-service;1&quot;].getService(Components.interfaces.nsIIOService);</span>
<a href="#l45.17"></a><span id="l45.17">          gFileHandler = gIOService.getProtocolHandler(&quot;file&quot;).QueryInterface(Components.interfaces.nsIFileProtocolHandler);</span>
<a href="#l45.18"></a><span id="l45.18">          </span>
<a href="#l45.19"></a><span id="l45.19">          var dirService = Components.classes[&quot;@mozilla.org/file/directory_service;1&quot;]</span>
<a href="#l45.20"></a><span id="l45.20">              .getService(Components.interfaces.nsIProperties);</span>
<a href="#l45.21"></a><span id="l45.21">          var profileDir = dirService.get(&quot;ProfD&quot;, Components.interfaces.nsIFile);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l46.1"></a><span id="l46.1" class="difflineminus">--- a/mailnews/base/src/nsMsgContentPolicy.cpp</span>
<a href="#l46.2"></a><span id="l46.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgContentPolicy.cpp</span>
<a href="#l46.3"></a><span id="l46.3" class="difflineat">@@ -43,17 +43,16 @@</span>
<a href="#l46.4"></a><span id="l46.4"> #include &quot;nsIPrefBranch2.h&quot;</span>
<a href="#l46.5"></a><span id="l46.5"> #include &quot;nsIURI.h&quot;</span>
<a href="#l46.6"></a><span id="l46.6"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l46.7"></a><span id="l46.7"> #include &quot;nsIRDFService.h&quot;</span>
<a href="#l46.8"></a><span id="l46.8"> #include &quot;nsIRDFResource.h&quot;</span>
<a href="#l46.9"></a><span id="l46.9"> #include &quot;nsIMsgHeaderParser.h&quot;</span>
<a href="#l46.10"></a><span id="l46.10"> #include &quot;nsIAbDirectory.h&quot;</span>
<a href="#l46.11"></a><span id="l46.11"> #include &quot;nsIAbMDBDirectory.h&quot;</span>
<a href="#l46.12"></a><span id="l46.12" class="difflineminus">-#include &quot;nsIAbMDBCard.h&quot;</span>
<a href="#l46.13"></a><span id="l46.13"> #include &quot;nsIAbCard.h&quot;</span>
<a href="#l46.14"></a><span id="l46.14"> #include &quot;nsIMsgMailNewsUrl.h&quot;</span>
<a href="#l46.15"></a><span id="l46.15"> #include &quot;nsIMsgWindow.h&quot;</span>
<a href="#l46.16"></a><span id="l46.16"> #include &quot;nsIMimeMiscStatus.h&quot;</span>
<a href="#l46.17"></a><span id="l46.17"> #include &quot;nsIMsgMessageService.h&quot;</span>
<a href="#l46.18"></a><span id="l46.18"> #include &quot;nsIMsgIncomingServer.h&quot;</span>
<a href="#l46.19"></a><span id="l46.19"> #include &quot;nsIRssIncomingServer.h&quot;</span>
<a href="#l46.20"></a><span id="l46.20"> #include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l46.21"></a><span id="l46.21" class="difflineat">@@ -185,17 +184,17 @@ nsresult nsMsgContentPolicy::AllowRemote</span>
<a href="#l46.22"></a><span id="l46.22">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l46.23"></a><span id="l46.23">     mdbDirectory = do_QueryInterface(supports);</span>
<a href="#l46.24"></a><span id="l46.24">     if (mdbDirectory)</span>
<a href="#l46.25"></a><span id="l46.25">       mdbDirectory-&gt;CardForEmailAddress(emailAddress, getter_AddRefs(cardForAddress));</span>
<a href="#l46.26"></a><span id="l46.26">   }</span>
<a href="#l46.27"></a><span id="l46.27">   </span>
<a href="#l46.28"></a><span id="l46.28">   // if we found a card from the sender, </span>
<a href="#l46.29"></a><span id="l46.29">   if (cardForAddress)</span>
<a href="#l46.30"></a><span id="l46.30" class="difflineminus">-    cardForAddress-&gt;GetAllowRemoteContent(aAllowForSender);</span>
<a href="#l46.31"></a><span id="l46.31" class="difflineplus">+    cardForAddress-&gt;GetPropertyAsBool(kAllowRemoteContentProperty, aAllowForSender);</span>
<a href="#l46.32"></a><span id="l46.32"> </span>
<a href="#l46.33"></a><span id="l46.33">   return NS_OK;</span>
<a href="#l46.34"></a><span id="l46.34"> }</span>
<a href="#l46.35"></a><span id="l46.35"> </span>
<a href="#l46.36"></a><span id="l46.36"> /**</span>
<a href="#l46.37"></a><span id="l46.37">  * Extract the host name from aContentLocation, and look it up in our list</span>
<a href="#l46.38"></a><span id="l46.38">  * of trusted domains.</span>
<a href="#l46.39"></a><span id="l46.39">  */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l47.1"></a><span id="l47.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgCompose.cpp</span>
<a href="#l47.2"></a><span id="l47.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgCompose.cpp</span>
<a href="#l47.3"></a><span id="l47.3" class="difflineat">@@ -4565,17 +4565,17 @@ nsMsgCompose::CheckAndPopulateRecipients</span>
<a href="#l47.4"></a><span id="l47.4">                     if (NS_FAILED(rv))</span>
<a href="#l47.5"></a><span id="l47.5">                       return rv;</span>
<a href="#l47.6"></a><span id="l47.6"> </span>
<a href="#l47.7"></a><span id="l47.7">                     rv = existingCard-&gt;GetDisplayName(pDisplayName);</span>
<a href="#l47.8"></a><span id="l47.8">                     if (NS_FAILED(rv))</span>
<a href="#l47.9"></a><span id="l47.9">                       return rv;</span>
<a href="#l47.10"></a><span id="l47.10"> </span>
<a href="#l47.11"></a><span id="l47.11">                     if (bIsMailList)</span>
<a href="#l47.12"></a><span id="l47.12" class="difflineminus">-                      rv = existingCard-&gt;GetNotes(newRecipient.mEmail);</span>
<a href="#l47.13"></a><span id="l47.13" class="difflineplus">+                      rv = existingCard-&gt;GetPropertyAsAString(kNotesProperty, newRecipient.mEmail);</span>
<a href="#l47.14"></a><span id="l47.14">                     else</span>
<a href="#l47.15"></a><span id="l47.15">                       rv = existingCard-&gt;GetPrimaryEmail(newRecipient.mEmail);</span>
<a href="#l47.16"></a><span id="l47.16"> </span>
<a href="#l47.17"></a><span id="l47.17">                     if (NS_FAILED(rv))</span>
<a href="#l47.18"></a><span id="l47.18">                       return rv;</span>
<a href="#l47.19"></a><span id="l47.19"> </span>
<a href="#l47.20"></a><span id="l47.20">                     if (parser)</span>
<a href="#l47.21"></a><span id="l47.21">                       parser-&gt;MakeFullAddress(pDisplayName, newRecipient.mEmail,</span>
<a href="#l47.22"></a><span id="l47.22" class="difflineat">@@ -4605,17 +4605,18 @@ nsMsgCompose::CheckAndPopulateRecipients</span>
<a href="#l47.23"></a><span id="l47.23">                     // recipient</span>
<a href="#l47.24"></a><span id="l47.24">                     if (bIsMailList)</span>
<a href="#l47.25"></a><span id="l47.25">                     {</span>
<a href="#l47.26"></a><span id="l47.26">                       stillNeedToSearch = PR_TRUE;</span>
<a href="#l47.27"></a><span id="l47.27">                     }</span>
<a href="#l47.28"></a><span id="l47.28">                     else</span>
<a href="#l47.29"></a><span id="l47.29">                     {</span>
<a href="#l47.30"></a><span id="l47.30">                       newRecipient.mPreferFormat = nsIAbPreferMailFormat::unknown;</span>
<a href="#l47.31"></a><span id="l47.31" class="difflineminus">-                      rv = existingCard-&gt;GetPreferMailFormat(&amp;newRecipient.mPreferFormat);</span>
<a href="#l47.32"></a><span id="l47.32" class="difflineplus">+                      rv = existingCard-&gt;GetPropertyAsUint32(</span>
<a href="#l47.33"></a><span id="l47.33" class="difflineplus">+                          kPreferMailFormatProperty, &amp;newRecipient.mPreferFormat);</span>
<a href="#l47.34"></a><span id="l47.34">                       if (NS_SUCCEEDED(rv))</span>
<a href="#l47.35"></a><span id="l47.35">                         newRecipient.mProcessed = PR_TRUE;</span>
<a href="#l47.36"></a><span id="l47.36">                     }</span>
<a href="#l47.37"></a><span id="l47.37">                     rv = recipientsList[i].InsertElementAt(j + 1, newRecipient) ? NS_OK : NS_ERROR_FAILURE;</span>
<a href="#l47.38"></a><span id="l47.38">                     if (NS_FAILED(rv))</span>
<a href="#l47.39"></a><span id="l47.39">                       return rv;</span>
<a href="#l47.40"></a><span id="l47.40">                   }</span>
<a href="#l47.41"></a><span id="l47.41">                   recipientsList[i].RemoveElementAt(j);</span>
<a href="#l47.42"></a><span id="l47.42" class="difflineat">@@ -4633,32 +4634,35 @@ nsMsgCompose::CheckAndPopulateRecipients</span>
<a href="#l47.43"></a><span id="l47.43">             {</span>
<a href="#l47.44"></a><span id="l47.44">               stillNeedToSearch = PR_TRUE;</span>
<a href="#l47.45"></a><span id="l47.45">               continue;</span>
<a href="#l47.46"></a><span id="l47.46">             }</span>
<a href="#l47.47"></a><span id="l47.47"> </span>
<a href="#l47.48"></a><span id="l47.48">             // Then if we have a card for this email address</span>
<a href="#l47.49"></a><span id="l47.49">             // Please DO NOT change the 4th param of GetCardFromAttribute() call to</span>
<a href="#l47.50"></a><span id="l47.50">             // PR_TRUE (ie, case insensitive) without reading bugs #128535 and #121478.</span>
<a href="#l47.51"></a><span id="l47.51" class="difflineminus">-            rv = abDataBase-&gt;GetCardFromAttribute(abDirectory, kPriEmailColumn,</span>
<a href="#l47.52"></a><span id="l47.52" class="difflineplus">+            rv = abDataBase-&gt;GetCardFromAttribute(abDirectory, kPriEmailProperty,</span>
<a href="#l47.53"></a><span id="l47.53">                                                   NS_ConvertUTF16toUTF8(recipient.mEmail),</span>
<a href="#l47.54"></a><span id="l47.54">                                                   PR_FALSE /* case insensitive */,</span>
<a href="#l47.55"></a><span id="l47.55">                                                   getter_AddRefs(existingCard));</span>
<a href="#l47.56"></a><span id="l47.56">             if (NS_SUCCEEDED(rv) &amp;&amp; existingCard)</span>
<a href="#l47.57"></a><span id="l47.57">             {</span>
<a href="#l47.58"></a><span id="l47.58">               recipient.mPreferFormat = nsIAbPreferMailFormat::unknown;</span>
<a href="#l47.59"></a><span id="l47.59" class="difflineminus">-              rv = existingCard-&gt;GetPreferMailFormat(&amp;recipient.mPreferFormat);</span>
<a href="#l47.60"></a><span id="l47.60" class="difflineplus">+              rv = existingCard-&gt;GetPropertyAsUint32(kPreferMailFormatProperty,</span>
<a href="#l47.61"></a><span id="l47.61" class="difflineplus">+                                                     &amp;recipient.mPreferFormat);</span>
<a href="#l47.62"></a><span id="l47.62">               if (NS_SUCCEEDED(rv))</span>
<a href="#l47.63"></a><span id="l47.63">                 recipient.mProcessed = PR_TRUE;</span>
<a href="#l47.64"></a><span id="l47.64"> </span>
<a href="#l47.65"></a><span id="l47.65">               // bump the popularity index for this card since we are about to send e-mail to it</span>
<a href="#l47.66"></a><span id="l47.66">               PRUint32 popularityIndex = 0;</span>
<a href="#l47.67"></a><span id="l47.67" class="difflineminus">-              if (NS_SUCCEEDED(existingCard-&gt;GetPopularityIndex(&amp;popularityIndex)))</span>
<a href="#l47.68"></a><span id="l47.68" class="difflineplus">+              if (NS_SUCCEEDED(existingCard-&gt;GetPropertyAsUint32(</span>
<a href="#l47.69"></a><span id="l47.69" class="difflineplus">+                      kPopularityIndexProperty, &amp;popularityIndex)))</span>
<a href="#l47.70"></a><span id="l47.70">               {</span>
<a href="#l47.71"></a><span id="l47.71" class="difflineminus">-                existingCard-&gt;SetPopularityIndex(++popularityIndex);</span>
<a href="#l47.72"></a><span id="l47.72" class="difflineplus">+                existingCard-&gt;SetPropertyAsUint32(kPopularityIndexProperty,</span>
<a href="#l47.73"></a><span id="l47.73" class="difflineplus">+                                                  ++popularityIndex);</span>
<a href="#l47.74"></a><span id="l47.74">                 // Since we are not notifying anyway, send null</span>
<a href="#l47.75"></a><span id="l47.75">                 abDataBase-&gt;EditCard(existingCard, PR_FALSE, nsnull);</span>
<a href="#l47.76"></a><span id="l47.76"> </span>
<a href="#l47.77"></a><span id="l47.77">                 // commit the database changes if we updated the popularity</span>
<a href="#l47.78"></a><span id="l47.78">                 // count.</span>
<a href="#l47.79"></a><span id="l47.79">                 abDataBase-&gt;Close(PR_TRUE);</span>
<a href="#l47.80"></a><span id="l47.80">               }</span>
<a href="#l47.81"></a><span id="l47.81">             }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l48.1"></a><span id="l48.1" class="difflineminus">--- a/mailnews/extensions/palmsync/src/nsAbIPCCard.cpp</span>
<a href="#l48.2"></a><span id="l48.2" class="difflineplus">+++ b/mailnews/extensions/palmsync/src/nsAbIPCCard.cpp</span>
<a href="#l48.3"></a><span id="l48.3" class="difflineat">@@ -35,31 +35,31 @@</span>
<a href="#l48.4"></a><span id="l48.4">  *</span>
<a href="#l48.5"></a><span id="l48.5">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l48.6"></a><span id="l48.6"> </span>
<a href="#l48.7"></a><span id="l48.7"> #include &lt;windows.h&gt;</span>
<a href="#l48.8"></a><span id="l48.8"> #include &lt;tchar.h&gt;</span>
<a href="#l48.9"></a><span id="l48.9"> </span>
<a href="#l48.10"></a><span id="l48.10"> #include &quot;nsAbIPCCard.h&quot;</span>
<a href="#l48.11"></a><span id="l48.11"> #include &quot;nsUnicharUtils.h&quot;</span>
<a href="#l48.12"></a><span id="l48.12" class="difflineminus">-#include &quot;nsIAbMDBCard.h&quot;</span>
<a href="#l48.13"></a><span id="l48.13" class="difflineplus">+#include &quot;nsIAddrDatabase.h&quot;</span>
<a href="#l48.14"></a><span id="l48.14"> #include &quot;prdtoa.h&quot;</span>
<a href="#l48.15"></a><span id="l48.15"> #include &quot;PalmSyncImp.h&quot;</span>
<a href="#l48.16"></a><span id="l48.16"> </span>
<a href="#l48.17"></a><span id="l48.17"> extern PRLogModuleInfo *PALMSYNC;</span>
<a href="#l48.18"></a><span id="l48.18"> </span>
<a href="#l48.19"></a><span id="l48.19"> #define CONVERT_ASSIGNTO_UNICODE(d, s, convertCRLF)  d.Truncate();\</span>
<a href="#l48.20"></a><span id="l48.20">                                         if((char*) s) d.AppendASCII((char*)s);\</span>
<a href="#l48.21"></a><span id="l48.21">                                         if (convertCRLF) \</span>
<a href="#l48.22"></a><span id="l48.22">                                           d.ReplaceSubstring(NS_LITERAL_STRING(&quot;\x0D\x0A&quot;).get(),NS_LITERAL_STRING(&quot; &quot;).get());</span>
<a href="#l48.23"></a><span id="l48.23"> </span>
<a href="#l48.24"></a><span id="l48.24"> #define CONVERT_CRLF_TO_SPACE(d, s) d.Assign(s); \</span>
<a href="#l48.25"></a><span id="l48.25">                                     d.ReplaceSubstring(NS_LITERAL_STRING(&quot;\x0D\x0A&quot;).get(),NS_LITERAL_STRING(&quot; &quot;).get());</span>
<a href="#l48.26"></a><span id="l48.26"> </span>
<a href="#l48.27"></a><span id="l48.27" class="difflineminus">-NS_IMPL_ISUPPORTS_INHERITED1(nsAbIPCCard, nsAbCardProperty, nsIAbMDBCard)</span>
<a href="#l48.28"></a><span id="l48.28" class="difflineplus">+NS_IMPL_ISUPPORTS_INHERITED0(nsAbIPCCard, nsAbCardProperty)</span>
<a href="#l48.29"></a><span id="l48.29"> </span>
<a href="#l48.30"></a><span id="l48.30"> nsAbIPCCard::nsAbIPCCard()</span>
<a href="#l48.31"></a><span id="l48.31"> {</span>
<a href="#l48.32"></a><span id="l48.32">     mRecordId = 0;</span>
<a href="#l48.33"></a><span id="l48.33">     mCategoryId = -1;</span>
<a href="#l48.34"></a><span id="l48.34">     mStatus = -1;</span>
<a href="#l48.35"></a><span id="l48.35">     PR_LOG(PALMSYNC, PR_LOG_DEBUG, (&quot;nsAbIPCCard::nsAbIPCCard \n&quot;));</span>
<a href="#l48.36"></a><span id="l48.36"> }</span>
<a href="#l48.37"></a><span id="l48.37" class="difflineat">@@ -81,44 +81,39 @@ nsAbIPCCard::nsAbIPCCard(nsABCOMCardStru</span>
<a href="#l48.38"></a><span id="l48.38">     else</span>
<a href="#l48.39"></a><span id="l48.39">         ConvertToUnicodeAndCopy(card);</span>
<a href="#l48.40"></a><span id="l48.40"> }</span>
<a href="#l48.41"></a><span id="l48.41"> </span>
<a href="#l48.42"></a><span id="l48.42"> NS_IMETHODIMP nsAbIPCCard::Copy(nsIAbCard *srcCard)</span>
<a href="#l48.43"></a><span id="l48.43"> {</span>
<a href="#l48.44"></a><span id="l48.44">     NS_ENSURE_ARG_POINTER(srcCard);</span>
<a href="#l48.45"></a><span id="l48.45"> </span>
<a href="#l48.46"></a><span id="l48.46" class="difflineminus">-    nsresult rv;</span>
<a href="#l48.47"></a><span id="l48.47" class="difflineminus">-    nsCOMPtr&lt;nsIAbMDBCard&gt; dbCard;</span>
<a href="#l48.48"></a><span id="l48.48" class="difflineminus">-    dbCard = do_QueryInterface(srcCard, &amp;rv);</span>
<a href="#l48.49"></a><span id="l48.49" class="difflineminus">-    if(NS_SUCCEEDED(rv) &amp;&amp; dbCard) {</span>
<a href="#l48.50"></a><span id="l48.50" class="difflineminus">-        nsString palmIDStr;</span>
<a href="#l48.51"></a><span id="l48.51" class="difflineminus">-        nsresult rv = dbCard-&gt;GetStringAttribute(CARD_ATTRIB_PALMID, getter_Copies(palmIDStr));</span>
<a href="#l48.52"></a><span id="l48.52" class="difflineminus">-        if(NS_SUCCEEDED(rv) &amp;&amp; !palmIDStr.IsEmpty()) {</span>
<a href="#l48.53"></a><span id="l48.53" class="difflineminus">-            PRFloat64 f = PR_strtod(NS_LossyConvertUTF16toASCII(palmIDStr).get(), nsnull);</span>
<a href="#l48.54"></a><span id="l48.54" class="difflineminus">-            PRInt64 l;</span>
<a href="#l48.55"></a><span id="l48.55" class="difflineminus">-            LL_D2L(l, f);</span>
<a href="#l48.56"></a><span id="l48.56" class="difflineminus">-            LL_L2UI(mRecordId, l);</span>
<a href="#l48.57"></a><span id="l48.57" class="difflineminus">-        }</span>
<a href="#l48.58"></a><span id="l48.58" class="difflineminus">-        else</span>
<a href="#l48.59"></a><span id="l48.59" class="difflineminus">-            mRecordId = 0;</span>
<a href="#l48.60"></a><span id="l48.60" class="difflineminus">-        // set tableID, RowID and Key for the card</span>
<a href="#l48.61"></a><span id="l48.61" class="difflineminus">-        PRUint32 tableID=0;</span>
<a href="#l48.62"></a><span id="l48.62" class="difflineminus">-        dbCard-&gt;GetDbTableID(&amp;tableID);</span>
<a href="#l48.63"></a><span id="l48.63" class="difflineminus">-        SetDbTableID(tableID);</span>
<a href="#l48.64"></a><span id="l48.64" class="difflineminus">-        PRUint32 rowID=0;</span>
<a href="#l48.65"></a><span id="l48.65" class="difflineminus">-        dbCard-&gt;GetDbRowID(&amp;rowID);</span>
<a href="#l48.66"></a><span id="l48.66" class="difflineminus">-        SetDbRowID(rowID);</span>
<a href="#l48.67"></a><span id="l48.67" class="difflineminus">-        PRUint32 key;</span>
<a href="#l48.68"></a><span id="l48.68" class="difflineminus">-        dbCard-&gt;GetKey(&amp;key);</span>
<a href="#l48.69"></a><span id="l48.69" class="difflineminus">-        SetKey(key);</span>
<a href="#l48.70"></a><span id="l48.70" class="difflineminus">-    }</span>
<a href="#l48.71"></a><span id="l48.71" class="difflineminus">-    PRUint32 lastModifiedDate = 0;</span>
<a href="#l48.72"></a><span id="l48.72" class="difflineminus">-    srcCard-&gt;GetLastModifiedDate(&amp;lastModifiedDate);</span>
<a href="#l48.73"></a><span id="l48.73" class="difflineminus">-    mStatus = (lastModifiedDate) ? ATTR_MODIFIED : ATTR_NEW;</span>
<a href="#l48.74"></a><span id="l48.74" class="difflineplus">+    nsString palmIDStr;</span>
<a href="#l48.75"></a><span id="l48.75" class="difflineplus">+    nsresult rv = srcCard-&gt;GetPropertyAsAString(CARD_ATTRIB_PALMID, palmIDStr);</span>
<a href="#l48.76"></a><span id="l48.76" class="difflineplus">+   if (NS_SUCCEEDED(rv) &amp;&amp; !palmIDStr.IsEmpty()) {</span>
<a href="#l48.77"></a><span id="l48.77" class="difflineplus">+     PRFloat64 f = PR_strtod(NS_LossyConvertUTF16toASCII(palmIDStr).get(), nsnull);</span>
<a href="#l48.78"></a><span id="l48.78" class="difflineplus">+     PRInt64 l;</span>
<a href="#l48.79"></a><span id="l48.79" class="difflineplus">+     LL_D2L(l, f);</span>
<a href="#l48.80"></a><span id="l48.80" class="difflineplus">+     LL_L2UI(mRecordId, l);</span>
<a href="#l48.81"></a><span id="l48.81" class="difflineplus">+   }</span>
<a href="#l48.82"></a><span id="l48.82" class="difflineplus">+   else</span>
<a href="#l48.83"></a><span id="l48.83" class="difflineplus">+     mRecordId = 0;</span>
<a href="#l48.84"></a><span id="l48.84" class="difflineplus">+</span>
<a href="#l48.85"></a><span id="l48.85" class="difflineplus">+   PRUint32 rowID = 0;</span>
<a href="#l48.86"></a><span id="l48.86" class="difflineplus">+   srcCard-&gt;GetPropertyAsUint32(&quot;DbRowID&quot;, &amp;rowID);</span>
<a href="#l48.87"></a><span id="l48.87" class="difflineplus">+   SetPropertyAsUint32(&quot;DbRowID&quot;, rowID);</span>
<a href="#l48.88"></a><span id="l48.88" class="difflineplus">+</span>
<a href="#l48.89"></a><span id="l48.89" class="difflineplus">+   PRUint32 key = 0;</span>
<a href="#l48.90"></a><span id="l48.90" class="difflineplus">+   srcCard-&gt;GetPropertyAsUint32(&quot;RecordKey&quot;, &amp;key);</span>
<a href="#l48.91"></a><span id="l48.91" class="difflineplus">+   SetPropertyAsUint32(&quot;RecordKey&quot;, key);</span>
<a href="#l48.92"></a><span id="l48.92" class="difflineplus">+</span>
<a href="#l48.93"></a><span id="l48.93" class="difflineplus">+   PRUint32 lastModifiedDate = 0;</span>
<a href="#l48.94"></a><span id="l48.94" class="difflineplus">+   srcCard-&gt;GetPropertyAsUint32(kLastModifiedDateProperty, &amp;lastModifiedDate);</span>
<a href="#l48.95"></a><span id="l48.95" class="difflineplus">+   mStatus = (lastModifiedDate) ? ATTR_MODIFIED : ATTR_NEW;</span>
<a href="#l48.96"></a><span id="l48.96" class="difflineplus">+</span>
<a href="#l48.97"></a><span id="l48.97"> </span>
<a href="#l48.98"></a><span id="l48.98">     rv = nsAbCardProperty::Copy(srcCard);</span>
<a href="#l48.99"></a><span id="l48.99">     // do we need to join the work and home addresses?</span>
<a href="#l48.100"></a><span id="l48.100">     // or split them?</span>
<a href="#l48.101"></a><span id="l48.101"> </span>
<a href="#l48.102"></a><span id="l48.102">     return rv;</span>
<a href="#l48.103"></a><span id="l48.103"> }</span>
<a href="#l48.104"></a><span id="l48.104"> </span>
<a href="#l48.105"></a><span id="l48.105" class="difflineat">@@ -141,107 +136,107 @@ nsresult nsAbIPCCard::Copy(nsABCOMCardSt</span>
<a href="#l48.106"></a><span id="l48.106"> </span>
<a href="#l48.107"></a><span id="l48.107">     CONVERT_CRLF_TO_SPACE(str, srcCard-&gt;lastName);</span>
<a href="#l48.108"></a><span id="l48.108">     SetLastName(str);</span>
<a href="#l48.109"></a><span id="l48.109"> </span>
<a href="#l48.110"></a><span id="l48.110">     CONVERT_CRLF_TO_SPACE(str, srcCard-&gt;displayName);</span>
<a href="#l48.111"></a><span id="l48.111">     SetDisplayName(str);</span>
<a href="#l48.112"></a><span id="l48.112"> </span>
<a href="#l48.113"></a><span id="l48.113">     CONVERT_CRLF_TO_SPACE(str, srcCard-&gt;nickName);</span>
<a href="#l48.114"></a><span id="l48.114" class="difflineminus">-    SetNickName(str);</span>
<a href="#l48.115"></a><span id="l48.115" class="difflineplus">+    SetPropertyAsAString(kNicknameProperty, str);</span>
<a href="#l48.116"></a><span id="l48.116"> </span>
<a href="#l48.117"></a><span id="l48.117">     CONVERT_CRLF_TO_SPACE(str, srcCard-&gt;primaryEmail);</span>
<a href="#l48.118"></a><span id="l48.118">     SetPrimaryEmail(str);</span>
<a href="#l48.119"></a><span id="l48.119"> </span>
<a href="#l48.120"></a><span id="l48.120">     CONVERT_CRLF_TO_SPACE(str, srcCard-&gt;secondEmail);</span>
<a href="#l48.121"></a><span id="l48.121" class="difflineminus">-    SetSecondEmail(str);</span>
<a href="#l48.122"></a><span id="l48.122" class="difflineplus">+    SetPropertyAsAString(k2ndEmailProperty, str);</span>
<a href="#l48.123"></a><span id="l48.123"> </span>
<a href="#l48.124"></a><span id="l48.124" class="difflineminus">-    SetPreferMailFormat(srcCard-&gt;preferMailFormat);</span>
<a href="#l48.125"></a><span id="l48.125" class="difflineplus">+    SetPropertyAsUint32(kPreferMailFormatProperty, srcCard-&gt;preferMailFormat);</span>
<a href="#l48.126"></a><span id="l48.126"> </span>
<a href="#l48.127"></a><span id="l48.127">     CONVERT_CRLF_TO_SPACE(str, srcCard-&gt;workPhone);</span>
<a href="#l48.128"></a><span id="l48.128" class="difflineminus">-    SetWorkPhone(str);</span>
<a href="#l48.129"></a><span id="l48.129" class="difflineplus">+    SetPropertyAsAString(kWorkPhoneProperty, str);</span>
<a href="#l48.130"></a><span id="l48.130"> </span>
<a href="#l48.131"></a><span id="l48.131">     CONVERT_CRLF_TO_SPACE(str, srcCard-&gt;homePhone);</span>
<a href="#l48.132"></a><span id="l48.132" class="difflineminus">-    SetHomePhone(str);</span>
<a href="#l48.133"></a><span id="l48.133" class="difflineplus">+    SetPropertyAsAString(kHomePhoneProperty, str);</span>
<a href="#l48.134"></a><span id="l48.134"> </span>
<a href="#l48.135"></a><span id="l48.135">     CONVERT_CRLF_TO_SPACE(str, srcCard-&gt;faxNumber);</span>
<a href="#l48.136"></a><span id="l48.136" class="difflineminus">-    SetFaxNumber(str);</span>
<a href="#l48.137"></a><span id="l48.137" class="difflineplus">+    SetPropertyAsAString(kFaxProperty, str);</span>
<a href="#l48.138"></a><span id="l48.138"> </span>
<a href="#l48.139"></a><span id="l48.139">     CONVERT_CRLF_TO_SPACE(str, srcCard-&gt;pagerNumber);</span>
<a href="#l48.140"></a><span id="l48.140" class="difflineminus">-    SetPagerNumber(str);</span>
<a href="#l48.141"></a><span id="l48.141" class="difflineplus">+    SetPropertyAsAString(kPagerProperty, str);</span>
<a href="#l48.142"></a><span id="l48.142"> </span>
<a href="#l48.143"></a><span id="l48.143">     CONVERT_CRLF_TO_SPACE(str, srcCard-&gt;cellularNumber);</span>
<a href="#l48.144"></a><span id="l48.144" class="difflineminus">-    SetCellularNumber(str);</span>
<a href="#l48.145"></a><span id="l48.145" class="difflineplus">+    SetPropertyAsAString(kCellularProperty, str);</span>
<a href="#l48.146"></a><span id="l48.146"> </span>
<a href="#l48.147"></a><span id="l48.147">     // See if home address contains multiple lines.</span>
<a href="#l48.148"></a><span id="l48.148">     SplitHomeAndWorkAddresses(srcCard, PR_TRUE);</span>
<a href="#l48.149"></a><span id="l48.149"> </span>
<a href="#l48.150"></a><span id="l48.150">     CONVERT_CRLF_TO_SPACE(str, srcCard-&gt;homeCity);</span>
<a href="#l48.151"></a><span id="l48.151" class="difflineminus">-    SetHomeCity(str);</span>
<a href="#l48.152"></a><span id="l48.152" class="difflineplus">+    SetPropertyAsAString(kHomeCityProperty, str);</span>
<a href="#l48.153"></a><span id="l48.153"> </span>
<a href="#l48.154"></a><span id="l48.154">     CONVERT_CRLF_TO_SPACE(str, srcCard-&gt;homeState);</span>
<a href="#l48.155"></a><span id="l48.155" class="difflineminus">-    SetHomeState(str);</span>
<a href="#l48.156"></a><span id="l48.156" class="difflineplus">+    SetPropertyAsAString(kHomeStateProperty, str);</span>
<a href="#l48.157"></a><span id="l48.157"> </span>
<a href="#l48.158"></a><span id="l48.158">     CONVERT_CRLF_TO_SPACE(str, srcCard-&gt;homeZipCode);</span>
<a href="#l48.159"></a><span id="l48.159" class="difflineminus">-    SetHomeZipCode(str);</span>
<a href="#l48.160"></a><span id="l48.160" class="difflineplus">+    SetPropertyAsAString(kHomeZipCodeProperty, str);</span>
<a href="#l48.161"></a><span id="l48.161"> </span>
<a href="#l48.162"></a><span id="l48.162">     CONVERT_CRLF_TO_SPACE(str, srcCard-&gt;homeCountry);</span>
<a href="#l48.163"></a><span id="l48.163" class="difflineminus">-    SetHomeCountry(str);</span>
<a href="#l48.164"></a><span id="l48.164" class="difflineplus">+    SetPropertyAsAString(kHomeCountryProperty, str);</span>
<a href="#l48.165"></a><span id="l48.165"> </span>
<a href="#l48.166"></a><span id="l48.166">     CONVERT_CRLF_TO_SPACE(str, srcCard-&gt;workCity);</span>
<a href="#l48.167"></a><span id="l48.167" class="difflineminus">-    SetWorkCity(str);</span>
<a href="#l48.168"></a><span id="l48.168" class="difflineplus">+    SetPropertyAsAString(kWorkCityProperty, str);</span>
<a href="#l48.169"></a><span id="l48.169"> </span>
<a href="#l48.170"></a><span id="l48.170">     CONVERT_CRLF_TO_SPACE(str, srcCard-&gt;workState);</span>
<a href="#l48.171"></a><span id="l48.171" class="difflineminus">-    SetWorkState(str);</span>
<a href="#l48.172"></a><span id="l48.172" class="difflineplus">+    SetPropertyAsAString(kWorkStateProperty, str);</span>
<a href="#l48.173"></a><span id="l48.173"> </span>
<a href="#l48.174"></a><span id="l48.174">     CONVERT_CRLF_TO_SPACE(str, srcCard-&gt;workZipCode);</span>
<a href="#l48.175"></a><span id="l48.175" class="difflineminus">-    SetWorkZipCode(str);</span>
<a href="#l48.176"></a><span id="l48.176" class="difflineplus">+    SetPropertyAsAString(kWorkZipCodeProperty, str);</span>
<a href="#l48.177"></a><span id="l48.177"> </span>
<a href="#l48.178"></a><span id="l48.178">     CONVERT_CRLF_TO_SPACE(str, srcCard-&gt;workCountry);</span>
<a href="#l48.179"></a><span id="l48.179" class="difflineminus">-    SetWorkCountry(str);</span>
<a href="#l48.180"></a><span id="l48.180" class="difflineplus">+    SetPropertyAsAString(kWorkCountryProperty, str);</span>
<a href="#l48.181"></a><span id="l48.181"> </span>
<a href="#l48.182"></a><span id="l48.182">     CONVERT_CRLF_TO_SPACE(str, srcCard-&gt;jobTitle);</span>
<a href="#l48.183"></a><span id="l48.183" class="difflineminus">-    SetJobTitle(str);</span>
<a href="#l48.184"></a><span id="l48.184" class="difflineplus">+    SetPropertyAsAString(kJobTitleProperty, str);</span>
<a href="#l48.185"></a><span id="l48.185"> </span>
<a href="#l48.186"></a><span id="l48.186">     CONVERT_CRLF_TO_SPACE(str, srcCard-&gt;department);</span>
<a href="#l48.187"></a><span id="l48.187" class="difflineminus">-    SetDepartment(str);</span>
<a href="#l48.188"></a><span id="l48.188" class="difflineplus">+    SetPropertyAsAString(kDepartmentProperty, str);</span>
<a href="#l48.189"></a><span id="l48.189"> </span>
<a href="#l48.190"></a><span id="l48.190">     CONVERT_CRLF_TO_SPACE(str, srcCard-&gt;company);</span>
<a href="#l48.191"></a><span id="l48.191" class="difflineminus">-    SetCompany(str);</span>
<a href="#l48.192"></a><span id="l48.192" class="difflineplus">+    SetPropertyAsAString(kCompanyProperty, str);</span>
<a href="#l48.193"></a><span id="l48.193"> </span>
<a href="#l48.194"></a><span id="l48.194">     CONVERT_CRLF_TO_SPACE(str, srcCard-&gt;webPage1);</span>
<a href="#l48.195"></a><span id="l48.195" class="difflineminus">-    SetWebPage1(str);</span>
<a href="#l48.196"></a><span id="l48.196" class="difflineplus">+    SetPropertyAsAString(kWorkWebPageProperty, str);</span>
<a href="#l48.197"></a><span id="l48.197"> </span>
<a href="#l48.198"></a><span id="l48.198">     CONVERT_CRLF_TO_SPACE(str, srcCard-&gt;webPage2);</span>
<a href="#l48.199"></a><span id="l48.199" class="difflineminus">-    SetWebPage2(str);</span>
<a href="#l48.200"></a><span id="l48.200" class="difflineplus">+    SetPropertyAsAString(kHomeWebPageProperty, str);</span>
<a href="#l48.201"></a><span id="l48.201"> </span>
<a href="#l48.202"></a><span id="l48.202">     CONVERT_CRLF_TO_SPACE(str, srcCard-&gt;birthYear);</span>
<a href="#l48.203"></a><span id="l48.203" class="difflineminus">-    SetBirthYear(str);</span>
<a href="#l48.204"></a><span id="l48.204" class="difflineplus">+    SetPropertyAsAString(kBirthYearProperty, str);</span>
<a href="#l48.205"></a><span id="l48.205"> </span>
<a href="#l48.206"></a><span id="l48.206">     CONVERT_CRLF_TO_SPACE(str, srcCard-&gt;birthMonth);</span>
<a href="#l48.207"></a><span id="l48.207" class="difflineminus">-    SetBirthMonth(str);</span>
<a href="#l48.208"></a><span id="l48.208" class="difflineplus">+    SetPropertyAsAString(kBirthMonthProperty, str);</span>
<a href="#l48.209"></a><span id="l48.209"> </span>
<a href="#l48.210"></a><span id="l48.210">     CONVERT_CRLF_TO_SPACE(str, srcCard-&gt;birthDay);</span>
<a href="#l48.211"></a><span id="l48.211" class="difflineminus">-    SetBirthDay(str);</span>
<a href="#l48.212"></a><span id="l48.212" class="difflineplus">+    SetPropertyAsAString(kBirthDayProperty, str);</span>
<a href="#l48.213"></a><span id="l48.213"> </span>
<a href="#l48.214"></a><span id="l48.214">     CONVERT_CRLF_TO_SPACE(str, srcCard-&gt;custom1);</span>
<a href="#l48.215"></a><span id="l48.215" class="difflineminus">-    SetCustom1(str);</span>
<a href="#l48.216"></a><span id="l48.216" class="difflineplus">+    SetPropertyAsAString(kCustom1Property, str);</span>
<a href="#l48.217"></a><span id="l48.217"> </span>
<a href="#l48.218"></a><span id="l48.218">     CONVERT_CRLF_TO_SPACE(str, srcCard-&gt;custom2);</span>
<a href="#l48.219"></a><span id="l48.219" class="difflineminus">-    SetCustom2(str);</span>
<a href="#l48.220"></a><span id="l48.220" class="difflineplus">+    SetPropertyAsAString(kCustom2Property, str);</span>
<a href="#l48.221"></a><span id="l48.221"> </span>
<a href="#l48.222"></a><span id="l48.222">     CONVERT_CRLF_TO_SPACE(str, srcCard-&gt;custom3);</span>
<a href="#l48.223"></a><span id="l48.223" class="difflineminus">-    SetCustom3(str);</span>
<a href="#l48.224"></a><span id="l48.224" class="difflineplus">+    SetPropertyAsAString(kCustom3Property, str);</span>
<a href="#l48.225"></a><span id="l48.225"> </span>
<a href="#l48.226"></a><span id="l48.226">     CONVERT_CRLF_TO_SPACE(str, srcCard-&gt;custom4);</span>
<a href="#l48.227"></a><span id="l48.227" class="difflineminus">-    SetCustom4(str);</span>
<a href="#l48.228"></a><span id="l48.228" class="difflineplus">+    SetPropertyAsAString(kCustom4Property, str);</span>
<a href="#l48.229"></a><span id="l48.229"> </span>
<a href="#l48.230"></a><span id="l48.230">     str.Assign(srcCard-&gt;notes);</span>
<a href="#l48.231"></a><span id="l48.231" class="difflineminus">-    SetNotes(str);</span>
<a href="#l48.232"></a><span id="l48.232" class="difflineminus">-    SetLastModifiedDate(srcCard-&gt;lastModifiedDate);</span>
<a href="#l48.233"></a><span id="l48.233" class="difflineplus">+    SetPropertyAsAString(kNotesProperty, str);</span>
<a href="#l48.234"></a><span id="l48.234" class="difflineplus">+    SetPropertyAsUint32(kLastModifiedDateProperty, srcCard-&gt;lastModifiedDate);</span>
<a href="#l48.235"></a><span id="l48.235">     SetIsMailList(srcCard-&gt;isMailList);</span>
<a href="#l48.236"></a><span id="l48.236">     SetMailListURI(srcCard-&gt;mailListURI);</span>
<a href="#l48.237"></a><span id="l48.237"> </span>
<a href="#l48.238"></a><span id="l48.238">     return NS_OK;</span>
<a href="#l48.239"></a><span id="l48.239"> }</span>
<a href="#l48.240"></a><span id="l48.240"> </span>
<a href="#l48.241"></a><span id="l48.241"> nsresult nsAbIPCCard::ConvertToUnicodeAndCopy(nsABCOMCardStruct * srcCard)</span>
<a href="#l48.242"></a><span id="l48.242"> {</span>
<a href="#l48.243"></a><span id="l48.243" class="difflineat">@@ -261,108 +256,108 @@ nsresult nsAbIPCCard::ConvertToUnicodeAn</span>
<a href="#l48.244"></a><span id="l48.244"> </span>
<a href="#l48.245"></a><span id="l48.245">     CONVERT_ASSIGNTO_UNICODE(str, srcCard-&gt;lastName, PR_TRUE);</span>
<a href="#l48.246"></a><span id="l48.246">     SetLastName(str);</span>
<a href="#l48.247"></a><span id="l48.247"> </span>
<a href="#l48.248"></a><span id="l48.248">     CONVERT_ASSIGNTO_UNICODE(str, srcCard-&gt;displayName, PR_TRUE);</span>
<a href="#l48.249"></a><span id="l48.249">     SetDisplayName(str);</span>
<a href="#l48.250"></a><span id="l48.250"> </span>
<a href="#l48.251"></a><span id="l48.251">     CONVERT_ASSIGNTO_UNICODE(str, srcCard-&gt;nickName, PR_TRUE);</span>
<a href="#l48.252"></a><span id="l48.252" class="difflineminus">-    SetNickName(str);</span>
<a href="#l48.253"></a><span id="l48.253" class="difflineplus">+    SetPropertyAsAString(kNicknameProperty, str);</span>
<a href="#l48.254"></a><span id="l48.254"> </span>
<a href="#l48.255"></a><span id="l48.255">     CONVERT_ASSIGNTO_UNICODE(str, srcCard-&gt;primaryEmail, PR_TRUE);</span>
<a href="#l48.256"></a><span id="l48.256">     SetPrimaryEmail(str);</span>
<a href="#l48.257"></a><span id="l48.257"> </span>
<a href="#l48.258"></a><span id="l48.258">     CONVERT_ASSIGNTO_UNICODE(str, srcCard-&gt;secondEmail, PR_TRUE);</span>
<a href="#l48.259"></a><span id="l48.259" class="difflineminus">-    SetSecondEmail(str);</span>
<a href="#l48.260"></a><span id="l48.260" class="difflineplus">+    SetPropertyAsAString(k2ndEmailProperty, str);</span>
<a href="#l48.261"></a><span id="l48.261"> </span>
<a href="#l48.262"></a><span id="l48.262" class="difflineminus">-    SetPreferMailFormat(srcCard-&gt;preferMailFormat);</span>
<a href="#l48.263"></a><span id="l48.263" class="difflineplus">+    SetPropertyAsUint32(kPreferMailFormatProperty, srcCard-&gt;preferMailFormat);</span>
<a href="#l48.264"></a><span id="l48.264"> </span>
<a href="#l48.265"></a><span id="l48.265">     CONVERT_ASSIGNTO_UNICODE(str, srcCard-&gt;workPhone, PR_TRUE);</span>
<a href="#l48.266"></a><span id="l48.266" class="difflineminus">-    SetWorkPhone(str);</span>
<a href="#l48.267"></a><span id="l48.267" class="difflineplus">+    SetPropertyAsAString(kWorkPhoneProperty, str);</span>
<a href="#l48.268"></a><span id="l48.268"> </span>
<a href="#l48.269"></a><span id="l48.269">     CONVERT_ASSIGNTO_UNICODE(str, srcCard-&gt;homePhone, PR_TRUE);</span>
<a href="#l48.270"></a><span id="l48.270" class="difflineminus">-    SetHomePhone(str);</span>
<a href="#l48.271"></a><span id="l48.271" class="difflineplus">+    SetPropertyAsAString(kHomePhoneProperty, str);</span>
<a href="#l48.272"></a><span id="l48.272"> </span>
<a href="#l48.273"></a><span id="l48.273">     CONVERT_ASSIGNTO_UNICODE(str, srcCard-&gt;faxNumber, PR_TRUE);</span>
<a href="#l48.274"></a><span id="l48.274" class="difflineminus">-    SetFaxNumber(str);</span>
<a href="#l48.275"></a><span id="l48.275" class="difflineplus">+    SetPropertyAsAString(kFaxProperty, str);</span>
<a href="#l48.276"></a><span id="l48.276"> </span>
<a href="#l48.277"></a><span id="l48.277">     CONVERT_ASSIGNTO_UNICODE(str, srcCard-&gt;pagerNumber, PR_TRUE);</span>
<a href="#l48.278"></a><span id="l48.278" class="difflineminus">-    SetPagerNumber(str);</span>
<a href="#l48.279"></a><span id="l48.279" class="difflineplus">+    SetPropertyAsAString(kPagerProperty, str);</span>
<a href="#l48.280"></a><span id="l48.280"> </span>
<a href="#l48.281"></a><span id="l48.281">     CONVERT_ASSIGNTO_UNICODE(str, srcCard-&gt;cellularNumber, PR_TRUE);</span>
<a href="#l48.282"></a><span id="l48.282" class="difflineminus">-    SetCellularNumber(str);</span>
<a href="#l48.283"></a><span id="l48.283" class="difflineplus">+    SetPropertyAsAString(kCellularProperty, str);</span>
<a href="#l48.284"></a><span id="l48.284"> </span>
<a href="#l48.285"></a><span id="l48.285">     // See if home address contains multiple lines.</span>
<a href="#l48.286"></a><span id="l48.286">     SplitHomeAndWorkAddresses(srcCard, PR_FALSE);</span>
<a href="#l48.287"></a><span id="l48.287"> </span>
<a href="#l48.288"></a><span id="l48.288">     CONVERT_ASSIGNTO_UNICODE(str, srcCard-&gt;homeCity, PR_TRUE);</span>
<a href="#l48.289"></a><span id="l48.289" class="difflineminus">-    SetHomeCity(str);</span>
<a href="#l48.290"></a><span id="l48.290" class="difflineplus">+    SetPropertyAsAString(kHomeCityProperty, str);</span>
<a href="#l48.291"></a><span id="l48.291"> </span>
<a href="#l48.292"></a><span id="l48.292">     CONVERT_ASSIGNTO_UNICODE(str, srcCard-&gt;homeState, PR_TRUE);</span>
<a href="#l48.293"></a><span id="l48.293" class="difflineminus">-    SetHomeState(str);</span>
<a href="#l48.294"></a><span id="l48.294" class="difflineplus">+    SetPropertyAsAString(kHomeStateProperty, str);</span>
<a href="#l48.295"></a><span id="l48.295"> </span>
<a href="#l48.296"></a><span id="l48.296">     CONVERT_ASSIGNTO_UNICODE(str, srcCard-&gt;homeZipCode, PR_TRUE);</span>
<a href="#l48.297"></a><span id="l48.297" class="difflineminus">-    SetHomeZipCode(str);</span>
<a href="#l48.298"></a><span id="l48.298" class="difflineplus">+    SetPropertyAsAString(kHomeZipCodeProperty, str);</span>
<a href="#l48.299"></a><span id="l48.299"> </span>
<a href="#l48.300"></a><span id="l48.300">     CONVERT_ASSIGNTO_UNICODE(str, srcCard-&gt;homeCountry, PR_TRUE);</span>
<a href="#l48.301"></a><span id="l48.301" class="difflineminus">-    SetHomeCountry(str);</span>
<a href="#l48.302"></a><span id="l48.302" class="difflineplus">+    SetPropertyAsAString(kHomeCountryProperty, str);</span>
<a href="#l48.303"></a><span id="l48.303"> </span>
<a href="#l48.304"></a><span id="l48.304">     CONVERT_ASSIGNTO_UNICODE(str, srcCard-&gt;workCity, PR_TRUE);</span>
<a href="#l48.305"></a><span id="l48.305" class="difflineminus">-    SetWorkCity(str);</span>
<a href="#l48.306"></a><span id="l48.306" class="difflineplus">+    SetPropertyAsAString(kWorkCityProperty, str);</span>
<a href="#l48.307"></a><span id="l48.307"> </span>
<a href="#l48.308"></a><span id="l48.308">     CONVERT_ASSIGNTO_UNICODE(str, srcCard-&gt;workState, PR_TRUE);</span>
<a href="#l48.309"></a><span id="l48.309" class="difflineminus">-    SetWorkState(str);</span>
<a href="#l48.310"></a><span id="l48.310" class="difflineplus">+    SetPropertyAsAString(kWorkStateProperty, str);</span>
<a href="#l48.311"></a><span id="l48.311"> </span>
<a href="#l48.312"></a><span id="l48.312">     CONVERT_ASSIGNTO_UNICODE(str, srcCard-&gt;workZipCode, PR_TRUE);</span>
<a href="#l48.313"></a><span id="l48.313" class="difflineminus">-    SetWorkZipCode(str);</span>
<a href="#l48.314"></a><span id="l48.314" class="difflineplus">+    SetPropertyAsAString(kWorkZipCodeProperty, str);</span>
<a href="#l48.315"></a><span id="l48.315"> </span>
<a href="#l48.316"></a><span id="l48.316">     CONVERT_ASSIGNTO_UNICODE(str, srcCard-&gt;workCountry, PR_TRUE);</span>
<a href="#l48.317"></a><span id="l48.317" class="difflineminus">-    SetWorkCountry(str);</span>
<a href="#l48.318"></a><span id="l48.318" class="difflineplus">+    SetPropertyAsAString(kWorkCountryProperty, str);</span>
<a href="#l48.319"></a><span id="l48.319"> </span>
<a href="#l48.320"></a><span id="l48.320">     CONVERT_ASSIGNTO_UNICODE(str, srcCard-&gt;jobTitle, PR_TRUE);</span>
<a href="#l48.321"></a><span id="l48.321" class="difflineminus">-    SetJobTitle(str);</span>
<a href="#l48.322"></a><span id="l48.322" class="difflineplus">+    SetPropertyAsAString(kJobTitleProperty, str);</span>
<a href="#l48.323"></a><span id="l48.323"> </span>
<a href="#l48.324"></a><span id="l48.324">     CONVERT_ASSIGNTO_UNICODE(str, srcCard-&gt;department, PR_TRUE);</span>
<a href="#l48.325"></a><span id="l48.325" class="difflineminus">-    SetDepartment(str);</span>
<a href="#l48.326"></a><span id="l48.326" class="difflineplus">+    SetPropertyAsAString(kDepartmentProperty, str);</span>
<a href="#l48.327"></a><span id="l48.327"> </span>
<a href="#l48.328"></a><span id="l48.328">     CONVERT_ASSIGNTO_UNICODE(str, srcCard-&gt;company, PR_TRUE);</span>
<a href="#l48.329"></a><span id="l48.329" class="difflineminus">-    SetCompany(str);</span>
<a href="#l48.330"></a><span id="l48.330" class="difflineplus">+    SetPropertyAsAString(kCompanyProperty, str);</span>
<a href="#l48.331"></a><span id="l48.331"> </span>
<a href="#l48.332"></a><span id="l48.332">     CONVERT_ASSIGNTO_UNICODE(str, srcCard-&gt;webPage1, PR_TRUE);</span>
<a href="#l48.333"></a><span id="l48.333" class="difflineminus">-    SetWebPage1(str);</span>
<a href="#l48.334"></a><span id="l48.334" class="difflineplus">+    SetPropertyAsAString(kWorkWebPageProperty, str);</span>
<a href="#l48.335"></a><span id="l48.335"> </span>
<a href="#l48.336"></a><span id="l48.336">     CONVERT_ASSIGNTO_UNICODE(str, srcCard-&gt;webPage2, PR_TRUE);</span>
<a href="#l48.337"></a><span id="l48.337" class="difflineminus">-    SetWebPage2(str);</span>
<a href="#l48.338"></a><span id="l48.338" class="difflineplus">+    SetPropertyAsAString(kHomeWebPageProperty, str);</span>
<a href="#l48.339"></a><span id="l48.339"> </span>
<a href="#l48.340"></a><span id="l48.340">     CONVERT_ASSIGNTO_UNICODE(str, srcCard-&gt;birthYear, PR_TRUE);</span>
<a href="#l48.341"></a><span id="l48.341" class="difflineminus">-    SetBirthYear(str);</span>
<a href="#l48.342"></a><span id="l48.342" class="difflineplus">+    SetPropertyAsAString(kBirthYearProperty, str);</span>
<a href="#l48.343"></a><span id="l48.343"> </span>
<a href="#l48.344"></a><span id="l48.344">     CONVERT_ASSIGNTO_UNICODE(str, srcCard-&gt;birthMonth, PR_TRUE);</span>
<a href="#l48.345"></a><span id="l48.345" class="difflineminus">-    SetBirthMonth(str);</span>
<a href="#l48.346"></a><span id="l48.346" class="difflineplus">+    SetPropertyAsAString(kBirthMonthProperty, str);</span>
<a href="#l48.347"></a><span id="l48.347"> </span>
<a href="#l48.348"></a><span id="l48.348">     CONVERT_ASSIGNTO_UNICODE(str, srcCard-&gt;birthDay, PR_TRUE);</span>
<a href="#l48.349"></a><span id="l48.349" class="difflineminus">-    SetBirthDay(str);</span>
<a href="#l48.350"></a><span id="l48.350" class="difflineplus">+    SetPropertyAsAString(kBirthDayProperty, str);</span>
<a href="#l48.351"></a><span id="l48.351"> </span>
<a href="#l48.352"></a><span id="l48.352">     CONVERT_ASSIGNTO_UNICODE(str, srcCard-&gt;custom1, PR_TRUE);</span>
<a href="#l48.353"></a><span id="l48.353" class="difflineminus">-    SetCustom1(str);</span>
<a href="#l48.354"></a><span id="l48.354" class="difflineplus">+    SetPropertyAsAString(kCustom1Property, str);</span>
<a href="#l48.355"></a><span id="l48.355"> </span>
<a href="#l48.356"></a><span id="l48.356">     CONVERT_ASSIGNTO_UNICODE(str, srcCard-&gt;custom2, PR_TRUE);</span>
<a href="#l48.357"></a><span id="l48.357" class="difflineminus">-    SetCustom2(str);</span>
<a href="#l48.358"></a><span id="l48.358" class="difflineplus">+    SetPropertyAsAString(kCustom2Property, str);</span>
<a href="#l48.359"></a><span id="l48.359"> </span>
<a href="#l48.360"></a><span id="l48.360">     CONVERT_ASSIGNTO_UNICODE(str, srcCard-&gt;custom3, PR_TRUE);</span>
<a href="#l48.361"></a><span id="l48.361" class="difflineminus">-    SetCustom3(str);</span>
<a href="#l48.362"></a><span id="l48.362" class="difflineplus">+    SetPropertyAsAString(kCustom3Property, str);</span>
<a href="#l48.363"></a><span id="l48.363"> </span>
<a href="#l48.364"></a><span id="l48.364">     CONVERT_ASSIGNTO_UNICODE(str, srcCard-&gt;custom4, PR_TRUE);</span>
<a href="#l48.365"></a><span id="l48.365" class="difflineminus">-    SetCustom4(str);</span>
<a href="#l48.366"></a><span id="l48.366" class="difflineplus">+    SetPropertyAsAString(kCustom4Property, str);</span>
<a href="#l48.367"></a><span id="l48.367"> </span>
<a href="#l48.368"></a><span id="l48.368">     CONVERT_ASSIGNTO_UNICODE(str, srcCard-&gt;notes, PR_FALSE);</span>
<a href="#l48.369"></a><span id="l48.369" class="difflineminus">-    SetNotes(str);</span>
<a href="#l48.370"></a><span id="l48.370" class="difflineplus">+    SetPropertyAsAString(kNotesProperty, str);</span>
<a href="#l48.371"></a><span id="l48.371"> </span>
<a href="#l48.372"></a><span id="l48.372" class="difflineminus">-    SetLastModifiedDate(srcCard-&gt;lastModifiedDate);</span>
<a href="#l48.373"></a><span id="l48.373" class="difflineplus">+    SetPropertyAsUint32(kLastModifiedDateProperty, srcCard-&gt;lastModifiedDate);</span>
<a href="#l48.374"></a><span id="l48.374">     SetIsMailList(srcCard-&gt;isMailList);</span>
<a href="#l48.375"></a><span id="l48.375">     SetMailListURI(srcCard-&gt;mailListURI);</span>
<a href="#l48.376"></a><span id="l48.376"> </span>
<a href="#l48.377"></a><span id="l48.377">     return NS_OK;</span>
<a href="#l48.378"></a><span id="l48.378"> }</span>
<a href="#l48.379"></a><span id="l48.379"> </span>
<a href="#l48.380"></a><span id="l48.380"> void nsAbIPCCard::SplitAddresses(PRBool isUnicode, LPTSTR homeAddress, LPTSTR workAddress)</span>
<a href="#l48.381"></a><span id="l48.381"> {</span>
<a href="#l48.382"></a><span id="l48.382" class="difflineat">@@ -381,33 +376,33 @@ void nsAbIPCCard::SplitAddresses(PRBool </span>
<a href="#l48.383"></a><span id="l48.383">   }</span>
<a href="#l48.384"></a><span id="l48.384">   nsAutoString addr1, addr2;</span>
<a href="#l48.385"></a><span id="l48.385">   if ((idx = homeAddressStr.Find( &quot;\x0D\x0A&quot;)) != kNotFound)</span>
<a href="#l48.386"></a><span id="l48.386">   {</span>
<a href="#l48.387"></a><span id="l48.387">     homeAddressStr.Left(addr1, idx);</span>
<a href="#l48.388"></a><span id="l48.388">     homeAddressStr.Right( addr2, homeAddressStr.Length() - idx - 2);  // need to minus string lenght of CRLF.</span>
<a href="#l48.389"></a><span id="l48.389">     addr2.ReplaceSubstring(NS_LITERAL_STRING(&quot;\x0D\x0A&quot;).get(),NS_LITERAL_STRING(&quot;, &quot;).get());</span>
<a href="#l48.390"></a><span id="l48.390"> </span>
<a href="#l48.391"></a><span id="l48.391" class="difflineminus">-    SetHomeAddress(addr1);</span>
<a href="#l48.392"></a><span id="l48.392" class="difflineminus">-    SetHomeAddress2(addr2);</span>
<a href="#l48.393"></a><span id="l48.393" class="difflineplus">+    SetPropertyAsAString(kHomeAddressProperty, addr1);</span>
<a href="#l48.394"></a><span id="l48.394" class="difflineplus">+    SetPropertyAsAString(kHomeAddress2Property, addr2);</span>
<a href="#l48.395"></a><span id="l48.395">   }</span>
<a href="#l48.396"></a><span id="l48.396">   else</span>
<a href="#l48.397"></a><span id="l48.397" class="difflineminus">-    SetHomeAddress(homeAddressStr);</span>
<a href="#l48.398"></a><span id="l48.398" class="difflineplus">+    SetPropertyAsAString(kHomeAddressProperty, homeAddressStr);</span>
<a href="#l48.399"></a><span id="l48.399"> </span>
<a href="#l48.400"></a><span id="l48.400">   if ((idx = workAddressStr.Find( &quot;\x0D\x0A&quot;)) != kNotFound)</span>
<a href="#l48.401"></a><span id="l48.401">   {</span>
<a href="#l48.402"></a><span id="l48.402">     workAddressStr.Left(addr1, idx);</span>
<a href="#l48.403"></a><span id="l48.403">     workAddressStr.Right( addr2, workAddressStr.Length() - idx - 2);  // need to minus string lenght of CRLF.</span>
<a href="#l48.404"></a><span id="l48.404">     addr2.ReplaceSubstring(NS_LITERAL_STRING(&quot;\x0D\x0A&quot;).get(),NS_LITERAL_STRING(&quot;, &quot;).get());</span>
<a href="#l48.405"></a><span id="l48.405"> </span>
<a href="#l48.406"></a><span id="l48.406" class="difflineminus">-    SetWorkAddress(addr1);</span>
<a href="#l48.407"></a><span id="l48.407" class="difflineminus">-    SetWorkAddress2(addr2);</span>
<a href="#l48.408"></a><span id="l48.408" class="difflineplus">+    SetPropertyAsAString(kWorkAddressProperty, addr1);</span>
<a href="#l48.409"></a><span id="l48.409" class="difflineplus">+    SetPropertyAsAString(kWorkAddress2Property, addr2);</span>
<a href="#l48.410"></a><span id="l48.410">   }</span>
<a href="#l48.411"></a><span id="l48.411">   else</span>
<a href="#l48.412"></a><span id="l48.412" class="difflineminus">-    SetWorkAddress(workAddressStr);</span>
<a href="#l48.413"></a><span id="l48.413" class="difflineplus">+    SetPropertyAsAString(kWorkAddressProperty, workAddressStr);</span>
<a href="#l48.414"></a><span id="l48.414"> }</span>
<a href="#l48.415"></a><span id="l48.415"> </span>
<a href="#l48.416"></a><span id="l48.416"> void nsAbIPCCard::SplitHomeAndWorkAddresses(nsABCOMCardStruct * card, PRBool isUnicode)</span>
<a href="#l48.417"></a><span id="l48.417"> {</span>
<a href="#l48.418"></a><span id="l48.418">   // If the address contains more than one line then split it into two </span>
<a href="#l48.419"></a><span id="l48.419">   // (since moz only allows two address lines) and make sure all CRLFs</span>
<a href="#l48.420"></a><span id="l48.420">   // are converted to spaces in the 2nd address line. Lines are ended</span>
<a href="#l48.421"></a><span id="l48.421">   // with CRLF (done by moz conduit). So card-&gt;homeAddress2 </span>
<a href="#l48.422"></a><span id="l48.422" class="difflineat">@@ -425,141 +420,141 @@ PRBool nsAbIPCCard::EqualsAfterUnicodeCo</span>
<a href="#l48.423"></a><span id="l48.423">     nsAbIPCCard card1(card, PR_FALSE);</span>
<a href="#l48.424"></a><span id="l48.424">     card1.SplitAddresses(PR_FALSE, card-&gt;homeAddress, card-&gt;workAddress);</span>
<a href="#l48.425"></a><span id="l48.425">     nsABCOMCardStruct * newCard = new nsABCOMCardStruct;</span>
<a href="#l48.426"></a><span id="l48.426">     // get the unicode nsABCOMCardStruct and compare</span>
<a href="#l48.427"></a><span id="l48.427">     card1.GetABCOMCardStruct(PR_TRUE, newCard);</span>
<a href="#l48.428"></a><span id="l48.428">     // want to split newCard home and work address</span>
<a href="#l48.429"></a><span id="l48.429"> </span>
<a href="#l48.430"></a><span id="l48.430">     // I think this leaks...need to free up the original values</span>
<a href="#l48.431"></a><span id="l48.431" class="difflineminus">-    card1.CopyValue(PR_TRUE, m_HomeAddress, &amp;newCard-&gt;homeAddress);</span>
<a href="#l48.432"></a><span id="l48.432" class="difflineminus">-    card1.CopyValue(PR_TRUE, m_HomeAddress2, &amp;newCard-&gt;homeAddress2);</span>
<a href="#l48.433"></a><span id="l48.433" class="difflineminus">-    card1.CopyValue(PR_TRUE, m_WorkAddress, &amp;newCard-&gt;workAddress);</span>
<a href="#l48.434"></a><span id="l48.434" class="difflineminus">-    card1.CopyValue(PR_TRUE, m_WorkAddress2, &amp;newCard-&gt;workAddress2);</span>
<a href="#l48.435"></a><span id="l48.435" class="difflineplus">+    card1.CopyValue(PR_TRUE, kHomeAddressProperty, &amp;newCard-&gt;homeAddress);</span>
<a href="#l48.436"></a><span id="l48.436" class="difflineplus">+    card1.CopyValue(PR_TRUE, kHomeAddress2Property, &amp;newCard-&gt;homeAddress2);</span>
<a href="#l48.437"></a><span id="l48.437" class="difflineplus">+    card1.CopyValue(PR_TRUE, kWorkAddressProperty, &amp;newCard-&gt;workAddress);</span>
<a href="#l48.438"></a><span id="l48.438" class="difflineplus">+    card1.CopyValue(PR_TRUE, kWorkAddress2Property, &amp;newCard-&gt;workAddress2);</span>
<a href="#l48.439"></a><span id="l48.439">   </span>
<a href="#l48.440"></a><span id="l48.440">     PRBool ret = Equals(newCard, differingAttrs);</span>
<a href="#l48.441"></a><span id="l48.441">     delete newCard;</span>
<a href="#l48.442"></a><span id="l48.442">     return ret;</span>
<a href="#l48.443"></a><span id="l48.443"> }</span>
<a href="#l48.444"></a><span id="l48.444"> </span>
<a href="#l48.445"></a><span id="l48.445"> </span>
<a href="#l48.446"></a><span id="l48.446"> PRBool nsAbIPCCard::Equals(nsABCOMCardStruct * card, nsStringArray &amp; differingAttrs)</span>
<a href="#l48.447"></a><span id="l48.447"> {</span>
<a href="#l48.448"></a><span id="l48.448">     if(!card)</span>
<a href="#l48.449"></a><span id="l48.449">         return PR_FALSE;</span>
<a href="#l48.450"></a><span id="l48.450"> </span>
<a href="#l48.451"></a><span id="l48.451">     differingAttrs.Clear();</span>
<a href="#l48.452"></a><span id="l48.452"> </span>
<a href="#l48.453"></a><span id="l48.453">     if(card-&gt;firstName)</span>
<a href="#l48.454"></a><span id="l48.454" class="difflineminus">-        if (Compare(nsDependentString(card-&gt;firstName), m_FirstName, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.455"></a><span id="l48.455" class="difflineminus">-            differingAttrs.AppendString(NS_LITERAL_STRING(kFirstNameColumn));</span>
<a href="#l48.456"></a><span id="l48.456" class="difflineplus">+        if (CompareValue(PR_TRUE, card-&gt;firstName, kFirstNameProperty))</span>
<a href="#l48.457"></a><span id="l48.457" class="difflineplus">+            differingAttrs.AppendString(NS_LITERAL_STRING(kFirstNameProperty));</span>
<a href="#l48.458"></a><span id="l48.458">     if(card-&gt;lastName)</span>
<a href="#l48.459"></a><span id="l48.459" class="difflineminus">-        if (Compare(nsDependentString(card-&gt;lastName), m_LastName, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.460"></a><span id="l48.460" class="difflineminus">-            differingAttrs.AppendString(NS_LITERAL_STRING(kLastNameColumn));</span>
<a href="#l48.461"></a><span id="l48.461" class="difflineplus">+        if (CompareValue(PR_TRUE, card-&gt;lastName, kLastNameProperty))</span>
<a href="#l48.462"></a><span id="l48.462" class="difflineplus">+            differingAttrs.AppendString(NS_LITERAL_STRING(kLastNameProperty));</span>
<a href="#l48.463"></a><span id="l48.463">     if(card-&gt;displayName)</span>
<a href="#l48.464"></a><span id="l48.464" class="difflineminus">-        if (Compare(nsDependentString(card-&gt;displayName), m_DisplayName, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.465"></a><span id="l48.465" class="difflineminus">-            differingAttrs.AppendString(NS_LITERAL_STRING(kDisplayNameColumn));</span>
<a href="#l48.466"></a><span id="l48.466" class="difflineplus">+        if (CompareValue(PR_TRUE, card-&gt;displayName, kDisplayNameProperty))</span>
<a href="#l48.467"></a><span id="l48.467" class="difflineplus">+            differingAttrs.AppendString(NS_LITERAL_STRING(kDisplayNameProperty));</span>
<a href="#l48.468"></a><span id="l48.468">     if(card-&gt;nickName)</span>
<a href="#l48.469"></a><span id="l48.469" class="difflineminus">-        if (Compare(nsDependentString(card-&gt;nickName), m_NickName, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.470"></a><span id="l48.470" class="difflineminus">-            differingAttrs.AppendString(NS_LITERAL_STRING(kNicknameColumn));</span>
<a href="#l48.471"></a><span id="l48.471" class="difflineplus">+        if (CompareValue(PR_TRUE, card-&gt;nickName, kNicknameProperty))</span>
<a href="#l48.472"></a><span id="l48.472" class="difflineplus">+            differingAttrs.AppendString(NS_LITERAL_STRING(kNicknameProperty));</span>
<a href="#l48.473"></a><span id="l48.473">     if(card-&gt;primaryEmail)</span>
<a href="#l48.474"></a><span id="l48.474" class="difflineminus">-        if (Compare(nsDependentString(card-&gt;primaryEmail), m_PrimaryEmail, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.475"></a><span id="l48.475" class="difflineminus">-            differingAttrs.AppendString(NS_LITERAL_STRING(kPriEmailColumn));</span>
<a href="#l48.476"></a><span id="l48.476" class="difflineplus">+        if (CompareValue(PR_TRUE, card-&gt;primaryEmail, kPriEmailProperty))</span>
<a href="#l48.477"></a><span id="l48.477" class="difflineplus">+            differingAttrs.AppendString(NS_LITERAL_STRING(kPriEmailProperty));</span>
<a href="#l48.478"></a><span id="l48.478">     if(card-&gt;secondEmail)</span>
<a href="#l48.479"></a><span id="l48.479" class="difflineminus">-        if (Compare(nsDependentString(card-&gt;secondEmail), m_SecondEmail, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.480"></a><span id="l48.480" class="difflineminus">-            differingAttrs.AppendString(NS_LITERAL_STRING(k2ndEmailColumn));</span>
<a href="#l48.481"></a><span id="l48.481" class="difflineplus">+        if (CompareValue(PR_TRUE, card-&gt;secondEmail, k2ndEmailProperty))</span>
<a href="#l48.482"></a><span id="l48.482" class="difflineplus">+            differingAttrs.AppendString(NS_LITERAL_STRING(k2ndEmailProperty));</span>
<a href="#l48.483"></a><span id="l48.483">     if(card-&gt;workPhone)</span>
<a href="#l48.484"></a><span id="l48.484" class="difflineminus">-        if (Compare(nsDependentString(card-&gt;workPhone), m_WorkPhone, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.485"></a><span id="l48.485" class="difflineminus">-            differingAttrs.AppendString(NS_LITERAL_STRING(kWorkPhoneColumn));</span>
<a href="#l48.486"></a><span id="l48.486" class="difflineplus">+        if (CompareValue(PR_TRUE, card-&gt;workPhone, kWorkPhoneProperty))</span>
<a href="#l48.487"></a><span id="l48.487" class="difflineplus">+            differingAttrs.AppendString(NS_LITERAL_STRING(kWorkPhoneProperty));</span>
<a href="#l48.488"></a><span id="l48.488">     if(card-&gt;homePhone)</span>
<a href="#l48.489"></a><span id="l48.489" class="difflineminus">-        if (Compare(nsDependentString(card-&gt;homePhone), m_HomePhone, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.490"></a><span id="l48.490" class="difflineminus">-            differingAttrs.AppendString(NS_LITERAL_STRING(kHomePhoneColumn));</span>
<a href="#l48.491"></a><span id="l48.491" class="difflineplus">+        if (CompareValue(PR_TRUE, card-&gt;homePhone, kHomePhoneProperty))</span>
<a href="#l48.492"></a><span id="l48.492" class="difflineplus">+            differingAttrs.AppendString(NS_LITERAL_STRING(kHomePhoneProperty));</span>
<a href="#l48.493"></a><span id="l48.493">     if(card-&gt;faxNumber)</span>
<a href="#l48.494"></a><span id="l48.494" class="difflineminus">-        if (Compare(nsDependentString(card-&gt;faxNumber), m_FaxNumber, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.495"></a><span id="l48.495" class="difflineminus">-            differingAttrs.AppendString(NS_LITERAL_STRING(kFaxColumn));</span>
<a href="#l48.496"></a><span id="l48.496" class="difflineplus">+        if (CompareValue(PR_TRUE, card-&gt;faxNumber, kFaxProperty))</span>
<a href="#l48.497"></a><span id="l48.497" class="difflineplus">+            differingAttrs.AppendString(NS_LITERAL_STRING(kFaxProperty));</span>
<a href="#l48.498"></a><span id="l48.498">     if(card-&gt;pagerNumber)</span>
<a href="#l48.499"></a><span id="l48.499" class="difflineminus">-        if (Compare(nsDependentString(card-&gt;pagerNumber), m_PagerNumber, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.500"></a><span id="l48.500" class="difflineminus">-            differingAttrs.AppendString(NS_LITERAL_STRING(kPagerColumn));</span>
<a href="#l48.501"></a><span id="l48.501" class="difflineplus">+        if (CompareValue(PR_TRUE, card-&gt;pagerNumber, kPagerProperty))</span>
<a href="#l48.502"></a><span id="l48.502" class="difflineplus">+            differingAttrs.AppendString(NS_LITERAL_STRING(kPagerProperty));</span>
<a href="#l48.503"></a><span id="l48.503">     if(card-&gt;cellularNumber)</span>
<a href="#l48.504"></a><span id="l48.504" class="difflineminus">-        if (Compare(nsDependentString(card-&gt;cellularNumber), m_CellularNumber, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.505"></a><span id="l48.505" class="difflineminus">-            differingAttrs.AppendString(NS_LITERAL_STRING(kCellularColumn));</span>
<a href="#l48.506"></a><span id="l48.506" class="difflineplus">+        if (CompareValue(PR_TRUE, card-&gt;cellularNumber, kCellularProperty))</span>
<a href="#l48.507"></a><span id="l48.507" class="difflineplus">+            differingAttrs.AppendString(NS_LITERAL_STRING(kCellularProperty));</span>
<a href="#l48.508"></a><span id="l48.508">     // card  has home and work addresses joined, but &quot;this&quot; has them split</span>
<a href="#l48.509"></a><span id="l48.509">     if(card-&gt;homeAddress)</span>
<a href="#l48.510"></a><span id="l48.510" class="difflineminus">-        if (Compare(nsDependentString(card-&gt;homeAddress), m_HomeAddress, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.511"></a><span id="l48.511" class="difflineminus">-            differingAttrs.AppendString(NS_LITERAL_STRING(kHomeAddressColumn));</span>
<a href="#l48.512"></a><span id="l48.512" class="difflineplus">+        if (CompareValue(PR_TRUE, card-&gt;homeAddress, kHomeAddressProperty))</span>
<a href="#l48.513"></a><span id="l48.513" class="difflineplus">+            differingAttrs.AppendString(NS_LITERAL_STRING(kHomeAddressProperty));</span>
<a href="#l48.514"></a><span id="l48.514">     if(card-&gt;homeAddress2)</span>
<a href="#l48.515"></a><span id="l48.515" class="difflineminus">-        if (Compare(nsDependentString(card-&gt;homeAddress2), m_HomeAddress2, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.516"></a><span id="l48.516" class="difflineminus">-            differingAttrs.AppendString(NS_LITERAL_STRING(kHomeAddress2Column));</span>
<a href="#l48.517"></a><span id="l48.517" class="difflineplus">+        if (CompareValue(PR_TRUE, card-&gt;homeAddress2, kHomeAddress2Property))</span>
<a href="#l48.518"></a><span id="l48.518" class="difflineplus">+            differingAttrs.AppendString(NS_LITERAL_STRING(kHomeAddress2Property));</span>
<a href="#l48.519"></a><span id="l48.519">     if(card-&gt;homeCity)</span>
<a href="#l48.520"></a><span id="l48.520" class="difflineminus">-        if (Compare(nsDependentString(card-&gt;homeCity), m_HomeCity, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.521"></a><span id="l48.521" class="difflineminus">-            differingAttrs.AppendString(NS_LITERAL_STRING(kHomeCityColumn));</span>
<a href="#l48.522"></a><span id="l48.522" class="difflineplus">+        if (CompareValue(PR_TRUE, card-&gt;homeCity, kHomeCityProperty))</span>
<a href="#l48.523"></a><span id="l48.523" class="difflineplus">+            differingAttrs.AppendString(NS_LITERAL_STRING(kHomeCityProperty));</span>
<a href="#l48.524"></a><span id="l48.524">     if(card-&gt;homeState)</span>
<a href="#l48.525"></a><span id="l48.525" class="difflineminus">-        if (Compare(nsDependentString(card-&gt;homeState), m_HomeState, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.526"></a><span id="l48.526" class="difflineminus">-            differingAttrs.AppendString(NS_LITERAL_STRING(kHomeStateColumn));</span>
<a href="#l48.527"></a><span id="l48.527" class="difflineplus">+        if (CompareValue(PR_TRUE, card-&gt;homeState, kHomeStateProperty))</span>
<a href="#l48.528"></a><span id="l48.528" class="difflineplus">+            differingAttrs.AppendString(NS_LITERAL_STRING(kHomeStateProperty));</span>
<a href="#l48.529"></a><span id="l48.529">     if(card-&gt;homeZipCode)</span>
<a href="#l48.530"></a><span id="l48.530" class="difflineminus">-        if (Compare(nsDependentString(card-&gt;homeZipCode), m_HomeZipCode, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.531"></a><span id="l48.531" class="difflineminus">-            differingAttrs.AppendString(NS_LITERAL_STRING(kHomeZipCodeColumn));</span>
<a href="#l48.532"></a><span id="l48.532" class="difflineplus">+        if (CompareValue(PR_TRUE, card-&gt;homeZipCode, kHomeZipCodeProperty))</span>
<a href="#l48.533"></a><span id="l48.533" class="difflineplus">+            differingAttrs.AppendString(NS_LITERAL_STRING(kHomeZipCodeProperty));</span>
<a href="#l48.534"></a><span id="l48.534">     if(card-&gt;homeCountry)</span>
<a href="#l48.535"></a><span id="l48.535" class="difflineminus">-        if (Compare(nsDependentString(card-&gt;homeCountry), m_HomeCountry, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.536"></a><span id="l48.536" class="difflineminus">-            differingAttrs.AppendString(NS_LITERAL_STRING(kHomeCountryColumn));</span>
<a href="#l48.537"></a><span id="l48.537" class="difflineminus">-    // card-&gt;workAddress is Joined, m_workAddress and m_workAddress2 are split</span>
<a href="#l48.538"></a><span id="l48.538" class="difflineplus">+        if (CompareValue(PR_TRUE, card-&gt;homeCountry, kHomeCountryProperty))</span>
<a href="#l48.539"></a><span id="l48.539" class="difflineplus">+            differingAttrs.AppendString(NS_LITERAL_STRING(kHomeCountryProperty));</span>
<a href="#l48.540"></a><span id="l48.540" class="difflineplus">+    // card-&gt;workAddress is Joined, WorkAddress and WorkAddress2 are split</span>
<a href="#l48.541"></a><span id="l48.541">     if(card-&gt;workAddress)</span>
<a href="#l48.542"></a><span id="l48.542" class="difflineminus">-        if (Compare(nsDependentString(card-&gt;workAddress), m_WorkAddress, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.543"></a><span id="l48.543" class="difflineminus">-            differingAttrs.AppendString(NS_LITERAL_STRING(kWorkAddressColumn));</span>
<a href="#l48.544"></a><span id="l48.544" class="difflineplus">+        if (CompareValue(PR_TRUE, card-&gt;workAddress, kWorkAddressProperty))</span>
<a href="#l48.545"></a><span id="l48.545" class="difflineplus">+            differingAttrs.AppendString(NS_LITERAL_STRING(kWorkAddressProperty));</span>
<a href="#l48.546"></a><span id="l48.546">     if(card-&gt;workAddress2)</span>
<a href="#l48.547"></a><span id="l48.547" class="difflineminus">-        if (Compare(nsDependentString(card-&gt;workAddress2), m_WorkAddress2, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.548"></a><span id="l48.548" class="difflineminus">-            differingAttrs.AppendString(NS_LITERAL_STRING(kWorkAddress2Column));</span>
<a href="#l48.549"></a><span id="l48.549" class="difflineplus">+        if (CompareValue(PR_TRUE, card-&gt;workAddress2, kWorkAddress2Property))</span>
<a href="#l48.550"></a><span id="l48.550" class="difflineplus">+            differingAttrs.AppendString(NS_LITERAL_STRING(kWorkAddress2Property));</span>
<a href="#l48.551"></a><span id="l48.551">     if(card-&gt;workCity)</span>
<a href="#l48.552"></a><span id="l48.552" class="difflineminus">-        if (Compare(nsDependentString(card-&gt;workCity), m_WorkCity, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.553"></a><span id="l48.553" class="difflineminus">-            differingAttrs.AppendString(NS_LITERAL_STRING(kWorkCityColumn));</span>
<a href="#l48.554"></a><span id="l48.554" class="difflineplus">+        if (CompareValue(PR_TRUE, card-&gt;workCity, kWorkCityProperty))</span>
<a href="#l48.555"></a><span id="l48.555" class="difflineplus">+            differingAttrs.AppendString(NS_LITERAL_STRING(kWorkCityProperty));</span>
<a href="#l48.556"></a><span id="l48.556">     if(card-&gt;workState)</span>
<a href="#l48.557"></a><span id="l48.557" class="difflineminus">-        if (Compare(nsDependentString(card-&gt;workState), m_WorkState, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.558"></a><span id="l48.558" class="difflineminus">-            differingAttrs.AppendString(NS_LITERAL_STRING(kWorkStateColumn));</span>
<a href="#l48.559"></a><span id="l48.559" class="difflineplus">+        if (CompareValue(PR_TRUE, card-&gt;workState, kWorkStateProperty))</span>
<a href="#l48.560"></a><span id="l48.560" class="difflineplus">+            differingAttrs.AppendString(NS_LITERAL_STRING(kWorkStateProperty));</span>
<a href="#l48.561"></a><span id="l48.561">     if(card-&gt;workZipCode)</span>
<a href="#l48.562"></a><span id="l48.562" class="difflineminus">-        if (Compare(nsDependentString(card-&gt;workZipCode), m_WorkZipCode, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.563"></a><span id="l48.563" class="difflineminus">-            differingAttrs.AppendString(NS_LITERAL_STRING(kWorkZipCodeColumn));</span>
<a href="#l48.564"></a><span id="l48.564" class="difflineplus">+        if (CompareValue(PR_TRUE, card-&gt;workZipCode, kWorkZipCodeProperty))</span>
<a href="#l48.565"></a><span id="l48.565" class="difflineplus">+            differingAttrs.AppendString(NS_LITERAL_STRING(kWorkZipCodeProperty));</span>
<a href="#l48.566"></a><span id="l48.566">     if(card-&gt;workCountry)</span>
<a href="#l48.567"></a><span id="l48.567" class="difflineminus">-        if (Compare(nsDependentString(card-&gt;workCountry), m_WorkCountry, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.568"></a><span id="l48.568" class="difflineminus">-            differingAttrs.AppendString(NS_LITERAL_STRING(kWorkCountryColumn));</span>
<a href="#l48.569"></a><span id="l48.569" class="difflineplus">+        if (CompareValue(PR_TRUE, card-&gt;workCountry, kWorkCountryProperty))</span>
<a href="#l48.570"></a><span id="l48.570" class="difflineplus">+            differingAttrs.AppendString(NS_LITERAL_STRING(kWorkCountryProperty));</span>
<a href="#l48.571"></a><span id="l48.571">     if(card-&gt;jobTitle)</span>
<a href="#l48.572"></a><span id="l48.572" class="difflineminus">-        if (Compare(nsDependentString(card-&gt;jobTitle), m_JobTitle, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.573"></a><span id="l48.573" class="difflineminus">-            differingAttrs.AppendString(NS_LITERAL_STRING(kJobTitleColumn));</span>
<a href="#l48.574"></a><span id="l48.574" class="difflineplus">+        if (CompareValue(PR_TRUE, card-&gt;jobTitle, kJobTitleProperty))</span>
<a href="#l48.575"></a><span id="l48.575" class="difflineplus">+            differingAttrs.AppendString(NS_LITERAL_STRING(kJobTitleProperty));</span>
<a href="#l48.576"></a><span id="l48.576">     if(card-&gt;department)</span>
<a href="#l48.577"></a><span id="l48.577" class="difflineminus">-        if (Compare(nsDependentString(card-&gt;department), m_Department, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.578"></a><span id="l48.578" class="difflineminus">-            differingAttrs.AppendString(NS_LITERAL_STRING(kDepartmentColumn));</span>
<a href="#l48.579"></a><span id="l48.579" class="difflineplus">+        if (CompareValue(PR_TRUE, card-&gt;department, kDepartmentProperty))</span>
<a href="#l48.580"></a><span id="l48.580" class="difflineplus">+            differingAttrs.AppendString(NS_LITERAL_STRING(kDepartmentProperty));</span>
<a href="#l48.581"></a><span id="l48.581">     if(card-&gt;company)</span>
<a href="#l48.582"></a><span id="l48.582" class="difflineminus">-        if (Compare(nsDependentString(card-&gt;company), m_Company, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.583"></a><span id="l48.583" class="difflineminus">-            differingAttrs.AppendString(NS_LITERAL_STRING(kCompanyColumn));</span>
<a href="#l48.584"></a><span id="l48.584" class="difflineplus">+        if (CompareValue(PR_TRUE, card-&gt;company, kCompanyProperty))</span>
<a href="#l48.585"></a><span id="l48.585" class="difflineplus">+            differingAttrs.AppendString(NS_LITERAL_STRING(kCompanyProperty));</span>
<a href="#l48.586"></a><span id="l48.586">     if(card-&gt;webPage1)</span>
<a href="#l48.587"></a><span id="l48.587" class="difflineminus">-        if (Compare(nsDependentString(card-&gt;webPage1), m_WebPage1, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.588"></a><span id="l48.588" class="difflineminus">-            differingAttrs.AppendString(NS_LITERAL_STRING(kWebPage1Column));</span>
<a href="#l48.589"></a><span id="l48.589" class="difflineplus">+        if (CompareValue(PR_TRUE, card-&gt;webPage1, kWorkWebPageProperty))</span>
<a href="#l48.590"></a><span id="l48.590" class="difflineplus">+            differingAttrs.AppendString(NS_LITERAL_STRING(kWorkWebPageProperty));</span>
<a href="#l48.591"></a><span id="l48.591">     if(card-&gt;webPage2)</span>
<a href="#l48.592"></a><span id="l48.592" class="difflineminus">-        if (Compare(nsDependentString(card-&gt;webPage2), m_WebPage2, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.593"></a><span id="l48.593" class="difflineminus">-            differingAttrs.AppendString(NS_LITERAL_STRING(kWebPage2Column));</span>
<a href="#l48.594"></a><span id="l48.594" class="difflineplus">+        if (CompareValue(PR_TRUE, card-&gt;webPage2, kWorkWebPageProperty))</span>
<a href="#l48.595"></a><span id="l48.595" class="difflineplus">+            differingAttrs.AppendString(NS_LITERAL_STRING(kHomeWebPageProperty));</span>
<a href="#l48.596"></a><span id="l48.596">     if(card-&gt;birthYear)</span>
<a href="#l48.597"></a><span id="l48.597" class="difflineminus">-        if (Compare(nsDependentString(card-&gt;birthYear), m_BirthYear, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.598"></a><span id="l48.598" class="difflineminus">-            differingAttrs.AppendString(NS_LITERAL_STRING(kBirthYearColumn));</span>
<a href="#l48.599"></a><span id="l48.599" class="difflineplus">+        if (CompareValue(PR_TRUE, card-&gt;birthYear, kBirthYearProperty))</span>
<a href="#l48.600"></a><span id="l48.600" class="difflineplus">+            differingAttrs.AppendString(NS_LITERAL_STRING(kBirthYearProperty));</span>
<a href="#l48.601"></a><span id="l48.601">     if(card-&gt;birthMonth)</span>
<a href="#l48.602"></a><span id="l48.602" class="difflineminus">-        if (Compare(nsDependentString(card-&gt;birthMonth), m_BirthMonth, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.603"></a><span id="l48.603" class="difflineminus">-            differingAttrs.AppendString(NS_LITERAL_STRING(kBirthMonthColumn));</span>
<a href="#l48.604"></a><span id="l48.604" class="difflineplus">+        if (CompareValue(PR_TRUE, card-&gt;birthMonth, kBirthMonthProperty))</span>
<a href="#l48.605"></a><span id="l48.605" class="difflineplus">+            differingAttrs.AppendString(NS_LITERAL_STRING(kBirthMonthProperty));</span>
<a href="#l48.606"></a><span id="l48.606">     if(card-&gt;birthDay)</span>
<a href="#l48.607"></a><span id="l48.607" class="difflineminus">-        if (Compare(nsDependentString(card-&gt;birthDay), m_BirthDay, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.608"></a><span id="l48.608" class="difflineminus">-            differingAttrs.AppendString(NS_LITERAL_STRING(kBirthDayColumn));</span>
<a href="#l48.609"></a><span id="l48.609" class="difflineplus">+        if (CompareValue(PR_TRUE, card-&gt;birthDay, kBirthDayProperty))</span>
<a href="#l48.610"></a><span id="l48.610" class="difflineplus">+            differingAttrs.AppendString(NS_LITERAL_STRING(kBirthDayProperty));</span>
<a href="#l48.611"></a><span id="l48.611">     if(card-&gt;custom1)</span>
<a href="#l48.612"></a><span id="l48.612" class="difflineminus">-        if (Compare(nsDependentString(card-&gt;custom1), m_Custom1, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.613"></a><span id="l48.613" class="difflineminus">-            differingAttrs.AppendString(NS_LITERAL_STRING(kCustom1Column));</span>
<a href="#l48.614"></a><span id="l48.614" class="difflineplus">+        if (CompareValue(PR_TRUE, card-&gt;custom1, kCustom1Property))</span>
<a href="#l48.615"></a><span id="l48.615" class="difflineplus">+            differingAttrs.AppendString(NS_LITERAL_STRING(kCustom1Property));</span>
<a href="#l48.616"></a><span id="l48.616">     if(card-&gt;custom2)</span>
<a href="#l48.617"></a><span id="l48.617" class="difflineminus">-        if (Compare(nsDependentString(card-&gt;custom2), m_Custom2, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.618"></a><span id="l48.618" class="difflineminus">-            differingAttrs.AppendString(NS_LITERAL_STRING(kCustom2Column));</span>
<a href="#l48.619"></a><span id="l48.619" class="difflineplus">+        if (CompareValue(PR_TRUE, card-&gt;custom2, kCustom2Property))</span>
<a href="#l48.620"></a><span id="l48.620" class="difflineplus">+            differingAttrs.AppendString(NS_LITERAL_STRING(kCustom2Property));</span>
<a href="#l48.621"></a><span id="l48.621">     if(card-&gt;custom3)</span>
<a href="#l48.622"></a><span id="l48.622" class="difflineminus">-        if (Compare(nsDependentString(card-&gt;custom3), m_Custom3, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.623"></a><span id="l48.623" class="difflineminus">-            differingAttrs.AppendString(NS_LITERAL_STRING(kCustom3Column));</span>
<a href="#l48.624"></a><span id="l48.624" class="difflineplus">+        if (CompareValue(PR_TRUE, card-&gt;custom3, kCustom3Property))</span>
<a href="#l48.625"></a><span id="l48.625" class="difflineplus">+            differingAttrs.AppendString(NS_LITERAL_STRING(kCustom3Property));</span>
<a href="#l48.626"></a><span id="l48.626">     if(card-&gt;custom4)</span>
<a href="#l48.627"></a><span id="l48.627" class="difflineminus">-        if (Compare(nsDependentString(card-&gt;custom4), m_Custom4, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.628"></a><span id="l48.628" class="difflineminus">-            differingAttrs.AppendString(NS_LITERAL_STRING(kCustom4Column));</span>
<a href="#l48.629"></a><span id="l48.629" class="difflineplus">+        if (CompareValue(PR_TRUE, card-&gt;custom4, kCustom4Property))</span>
<a href="#l48.630"></a><span id="l48.630" class="difflineplus">+            differingAttrs.AppendString(NS_LITERAL_STRING(kCustom4Property));</span>
<a href="#l48.631"></a><span id="l48.631">     if (card-&gt;isMailList != m_IsMailList)</span>
<a href="#l48.632"></a><span id="l48.632">         differingAttrs.AppendString(NS_LITERAL_STRING(kMailListName));</span>
<a href="#l48.633"></a><span id="l48.633">     if(card-&gt;mailListURI) {</span>
<a href="#l48.634"></a><span id="l48.634">         nsCAutoString str(card-&gt;mailListURI);</span>
<a href="#l48.635"></a><span id="l48.635">         if (str.Equals(m_MailListURI, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l48.636"></a><span id="l48.636">             differingAttrs.AppendString(NS_LITERAL_STRING(kMailListDescription));</span>
<a href="#l48.637"></a><span id="l48.637">     }</span>
<a href="#l48.638"></a><span id="l48.638"> </span>
<a href="#l48.639"></a><span id="l48.639" class="difflineat">@@ -571,250 +566,286 @@ NS_IMETHODIMP nsAbIPCCard::Equals(nsIAbC</span>
<a href="#l48.640"></a><span id="l48.640"> {</span>
<a href="#l48.641"></a><span id="l48.641">     NS_ENSURE_ARG_POINTER(card);</span>
<a href="#l48.642"></a><span id="l48.642">     NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l48.643"></a><span id="l48.643"> </span>
<a href="#l48.644"></a><span id="l48.644">     nsString str;</span>
<a href="#l48.645"></a><span id="l48.645">     *_retval = PR_FALSE;</span>
<a href="#l48.646"></a><span id="l48.646"> </span>
<a href="#l48.647"></a><span id="l48.647">     card-&gt;GetFirstName(str);</span>
<a href="#l48.648"></a><span id="l48.648" class="difflineminus">-    if (Compare(str, m_FirstName, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.649"></a><span id="l48.649" class="difflineplus">+    if (Compare(str, kFirstNameProperty))</span>
<a href="#l48.650"></a><span id="l48.650">         return NS_OK;</span>
<a href="#l48.651"></a><span id="l48.651"> </span>
<a href="#l48.652"></a><span id="l48.652">     card-&gt;GetLastName(str);</span>
<a href="#l48.653"></a><span id="l48.653" class="difflineminus">-    if (Compare(str, m_LastName, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.654"></a><span id="l48.654" class="difflineplus">+    if (Compare(str, kLastNameProperty))</span>
<a href="#l48.655"></a><span id="l48.655">         return NS_OK;</span>
<a href="#l48.656"></a><span id="l48.656"> </span>
<a href="#l48.657"></a><span id="l48.657">     card-&gt;GetDisplayName(str);</span>
<a href="#l48.658"></a><span id="l48.658" class="difflineminus">-    if (Compare(str, m_DisplayName, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.659"></a><span id="l48.659" class="difflineplus">+    if (Compare(str, kDisplayNameProperty))</span>
<a href="#l48.660"></a><span id="l48.660">         return NS_OK;</span>
<a href="#l48.661"></a><span id="l48.661"> </span>
<a href="#l48.662"></a><span id="l48.662" class="difflineminus">-    card-&gt;GetNickName(str);</span>
<a href="#l48.663"></a><span id="l48.663" class="difflineminus">-    if (Compare(str, m_NickName, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.664"></a><span id="l48.664" class="difflineplus">+    if (NS_FAILED(card-&gt;GetPropertyAsAString(kNicknameProperty, str)))</span>
<a href="#l48.665"></a><span id="l48.665" class="difflineplus">+      str.Truncate();</span>
<a href="#l48.666"></a><span id="l48.666" class="difflineplus">+    if (Compare(str, kNicknameProperty))</span>
<a href="#l48.667"></a><span id="l48.667">         return NS_OK;</span>
<a href="#l48.668"></a><span id="l48.668"> </span>
<a href="#l48.669"></a><span id="l48.669">     card-&gt;GetPrimaryEmail(str);</span>
<a href="#l48.670"></a><span id="l48.670" class="difflineminus">-    if (Compare(str, m_PrimaryEmail, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.671"></a><span id="l48.671" class="difflineplus">+    if (Compare(str, kPriEmailProperty))</span>
<a href="#l48.672"></a><span id="l48.672">         return NS_OK;</span>
<a href="#l48.673"></a><span id="l48.673"> </span>
<a href="#l48.674"></a><span id="l48.674" class="difflineminus">-    card-&gt;GetSecondEmail(str);</span>
<a href="#l48.675"></a><span id="l48.675" class="difflineminus">-    if (Compare(str, m_SecondEmail, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.676"></a><span id="l48.676" class="difflineplus">+    if (NS_FAILED(card-&gt;GetPropertyAsAString(k2ndEmailProperty, str)))</span>
<a href="#l48.677"></a><span id="l48.677" class="difflineplus">+      str.Truncate();</span>
<a href="#l48.678"></a><span id="l48.678" class="difflineplus">+    if (Compare(str, k2ndEmailProperty))</span>
<a href="#l48.679"></a><span id="l48.679">         return NS_OK;</span>
<a href="#l48.680"></a><span id="l48.680"> </span>
<a href="#l48.681"></a><span id="l48.681" class="difflineminus">-    card-&gt;GetWorkPhone(str);</span>
<a href="#l48.682"></a><span id="l48.682" class="difflineminus">-    if (Compare(str, m_WorkPhone, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.683"></a><span id="l48.683" class="difflineplus">+    if (NS_FAILED(card-&gt;GetPropertyAsAString(kWorkPhoneProperty, str)))</span>
<a href="#l48.684"></a><span id="l48.684" class="difflineplus">+      str.Truncate();</span>
<a href="#l48.685"></a><span id="l48.685" class="difflineplus">+    if (Compare(str, kWorkPhoneProperty))</span>
<a href="#l48.686"></a><span id="l48.686">         return NS_OK;</span>
<a href="#l48.687"></a><span id="l48.687"> </span>
<a href="#l48.688"></a><span id="l48.688" class="difflineminus">-    card-&gt;GetHomePhone(str);</span>
<a href="#l48.689"></a><span id="l48.689" class="difflineminus">-    if (Compare(str, m_HomePhone, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.690"></a><span id="l48.690" class="difflineplus">+    if (NS_FAILED(card-&gt;GetPropertyAsAString(kHomePhoneProperty, str)))</span>
<a href="#l48.691"></a><span id="l48.691" class="difflineplus">+      str.Truncate();</span>
<a href="#l48.692"></a><span id="l48.692" class="difflineplus">+    if (Compare(str, kHomePhoneProperty))</span>
<a href="#l48.693"></a><span id="l48.693">         return NS_OK;</span>
<a href="#l48.694"></a><span id="l48.694"> </span>
<a href="#l48.695"></a><span id="l48.695" class="difflineminus">-    card-&gt;GetFaxNumber(str);</span>
<a href="#l48.696"></a><span id="l48.696" class="difflineminus">-    if (Compare(str, m_FaxNumber, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.697"></a><span id="l48.697" class="difflineplus">+    if (NS_FAILED(card-&gt;GetPropertyAsAString(kFaxProperty, str)))</span>
<a href="#l48.698"></a><span id="l48.698" class="difflineplus">+      str.Truncate();</span>
<a href="#l48.699"></a><span id="l48.699" class="difflineplus">+    if (Compare(str, kFaxProperty))</span>
<a href="#l48.700"></a><span id="l48.700">         return NS_OK;</span>
<a href="#l48.701"></a><span id="l48.701"> </span>
<a href="#l48.702"></a><span id="l48.702" class="difflineminus">-    card-&gt;GetPagerNumber(str);</span>
<a href="#l48.703"></a><span id="l48.703" class="difflineminus">-    if (Compare(str, m_PagerNumber, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.704"></a><span id="l48.704" class="difflineplus">+    if (NS_FAILED(card-&gt;GetPropertyAsAString(kPagerProperty, str)))</span>
<a href="#l48.705"></a><span id="l48.705" class="difflineplus">+      str.Truncate();</span>
<a href="#l48.706"></a><span id="l48.706" class="difflineplus">+    if (Compare(str, kPagerProperty))</span>
<a href="#l48.707"></a><span id="l48.707">         return NS_OK;</span>
<a href="#l48.708"></a><span id="l48.708"> </span>
<a href="#l48.709"></a><span id="l48.709" class="difflineminus">-    card-&gt;GetCellularNumber(str);</span>
<a href="#l48.710"></a><span id="l48.710" class="difflineminus">-    if (Compare(str, m_CellularNumber, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.711"></a><span id="l48.711" class="difflineplus">+    if (NS_FAILED(card-&gt;GetPropertyAsAString(kCellularProperty, str)))</span>
<a href="#l48.712"></a><span id="l48.712" class="difflineplus">+      str.Truncate();</span>
<a href="#l48.713"></a><span id="l48.713" class="difflineplus">+    if (Compare(str, kCellularProperty))</span>
<a href="#l48.714"></a><span id="l48.714">         return NS_OK;</span>
<a href="#l48.715"></a><span id="l48.715"> </span>
<a href="#l48.716"></a><span id="l48.716" class="difflineminus">-    card-&gt;GetHomeAddress(str);</span>
<a href="#l48.717"></a><span id="l48.717" class="difflineminus">-    if (Compare(str, m_HomeAddress, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.718"></a><span id="l48.718" class="difflineplus">+    if (NS_FAILED(card-&gt;GetPropertyAsAString(kHomeAddressProperty, str)))</span>
<a href="#l48.719"></a><span id="l48.719" class="difflineplus">+      str.Truncate();</span>
<a href="#l48.720"></a><span id="l48.720" class="difflineplus">+    if (Compare(str, kHomeAddressProperty))</span>
<a href="#l48.721"></a><span id="l48.721">         return NS_OK;</span>
<a href="#l48.722"></a><span id="l48.722"> </span>
<a href="#l48.723"></a><span id="l48.723" class="difflineminus">-    card-&gt;GetHomeAddress2(str);</span>
<a href="#l48.724"></a><span id="l48.724" class="difflineminus">-    if (Compare(str, m_HomeAddress2, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.725"></a><span id="l48.725" class="difflineplus">+    if (NS_FAILED(card-&gt;GetPropertyAsAString(kHomeAddress2Property, str)))</span>
<a href="#l48.726"></a><span id="l48.726" class="difflineplus">+      str.Truncate();</span>
<a href="#l48.727"></a><span id="l48.727" class="difflineplus">+    if (Compare(str, kHomeAddress2Property))</span>
<a href="#l48.728"></a><span id="l48.728">         return NS_OK;</span>
<a href="#l48.729"></a><span id="l48.729"> </span>
<a href="#l48.730"></a><span id="l48.730" class="difflineminus">-    card-&gt;GetHomeCity(str);</span>
<a href="#l48.731"></a><span id="l48.731" class="difflineminus">-    if (Compare(str, m_HomeCity, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.732"></a><span id="l48.732" class="difflineplus">+    if (NS_FAILED(card-&gt;GetPropertyAsAString(kHomeCityProperty, str)))</span>
<a href="#l48.733"></a><span id="l48.733" class="difflineplus">+      str.Truncate();</span>
<a href="#l48.734"></a><span id="l48.734" class="difflineplus">+    if (Compare(str, kHomeCityProperty))</span>
<a href="#l48.735"></a><span id="l48.735">         return NS_OK;</span>
<a href="#l48.736"></a><span id="l48.736"> </span>
<a href="#l48.737"></a><span id="l48.737" class="difflineminus">-    card-&gt;GetHomeState(str);</span>
<a href="#l48.738"></a><span id="l48.738" class="difflineminus">-    if (Compare(str, m_HomeState, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.739"></a><span id="l48.739" class="difflineplus">+    if (NS_FAILED(card-&gt;GetPropertyAsAString(kHomeStateProperty, str)))</span>
<a href="#l48.740"></a><span id="l48.740" class="difflineplus">+      str.Truncate();</span>
<a href="#l48.741"></a><span id="l48.741" class="difflineplus">+    if (Compare(str, kHomeStateProperty))</span>
<a href="#l48.742"></a><span id="l48.742">         return NS_OK;</span>
<a href="#l48.743"></a><span id="l48.743"> </span>
<a href="#l48.744"></a><span id="l48.744" class="difflineminus">-    card-&gt;GetHomeZipCode(str);</span>
<a href="#l48.745"></a><span id="l48.745" class="difflineminus">-    if (Compare(str, m_HomeZipCode, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.746"></a><span id="l48.746" class="difflineplus">+    if (NS_FAILED(card-&gt;GetPropertyAsAString(kHomeZipCodeProperty, str)))</span>
<a href="#l48.747"></a><span id="l48.747" class="difflineplus">+      str.Truncate();</span>
<a href="#l48.748"></a><span id="l48.748" class="difflineplus">+    if (Compare(str, kHomeZipCodeProperty))</span>
<a href="#l48.749"></a><span id="l48.749">         return NS_OK;</span>
<a href="#l48.750"></a><span id="l48.750"> </span>
<a href="#l48.751"></a><span id="l48.751" class="difflineminus">-    card-&gt;GetHomeCountry(str);</span>
<a href="#l48.752"></a><span id="l48.752" class="difflineminus">-    if (Compare(str, m_HomeCountry, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.753"></a><span id="l48.753" class="difflineplus">+    if (NS_FAILED(card-&gt;GetPropertyAsAString(kHomeCountryProperty, str)))</span>
<a href="#l48.754"></a><span id="l48.754" class="difflineplus">+      str.Truncate();</span>
<a href="#l48.755"></a><span id="l48.755" class="difflineplus">+    if (Compare(str, kHomeCountryProperty))</span>
<a href="#l48.756"></a><span id="l48.756">         return NS_OK;</span>
<a href="#l48.757"></a><span id="l48.757"> </span>
<a href="#l48.758"></a><span id="l48.758">     // both card and this have their addresses split, which is correct</span>
<a href="#l48.759"></a><span id="l48.759" class="difflineminus">-    card-&gt;GetWorkAddress(str);</span>
<a href="#l48.760"></a><span id="l48.760" class="difflineminus">-    if (Compare(str, m_WorkAddress, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.761"></a><span id="l48.761" class="difflineplus">+    if (NS_FAILED(card-&gt;GetPropertyAsAString(kWorkAddressProperty, str)))</span>
<a href="#l48.762"></a><span id="l48.762" class="difflineplus">+      str.Truncate();</span>
<a href="#l48.763"></a><span id="l48.763" class="difflineplus">+    if (Compare(str, kWorkAddressProperty))</span>
<a href="#l48.764"></a><span id="l48.764">         return NS_OK;</span>
<a href="#l48.765"></a><span id="l48.765"> </span>
<a href="#l48.766"></a><span id="l48.766" class="difflineminus">-    card-&gt;GetWorkAddress2(str);</span>
<a href="#l48.767"></a><span id="l48.767" class="difflineminus">-    if (Compare(str, m_WorkAddress2, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.768"></a><span id="l48.768" class="difflineplus">+    if (NS_FAILED(card-&gt;GetPropertyAsAString(kWorkAddress2Property, str)))</span>
<a href="#l48.769"></a><span id="l48.769" class="difflineplus">+      str.Truncate();</span>
<a href="#l48.770"></a><span id="l48.770" class="difflineplus">+    if (Compare(str, kWorkAddress2Property))</span>
<a href="#l48.771"></a><span id="l48.771">         return NS_OK;</span>
<a href="#l48.772"></a><span id="l48.772"> </span>
<a href="#l48.773"></a><span id="l48.773" class="difflineminus">-    card-&gt;GetWorkCity(str);</span>
<a href="#l48.774"></a><span id="l48.774" class="difflineminus">-    if (Compare(str, m_WorkCity, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.775"></a><span id="l48.775" class="difflineplus">+    if (NS_FAILED(card-&gt;GetPropertyAsAString(kWorkCityProperty, str)))</span>
<a href="#l48.776"></a><span id="l48.776" class="difflineplus">+      str.Truncate();</span>
<a href="#l48.777"></a><span id="l48.777" class="difflineplus">+    if (Compare(str, kWorkCityProperty))</span>
<a href="#l48.778"></a><span id="l48.778">         return NS_OK;</span>
<a href="#l48.779"></a><span id="l48.779"> </span>
<a href="#l48.780"></a><span id="l48.780" class="difflineminus">-    card-&gt;GetWorkState(str);</span>
<a href="#l48.781"></a><span id="l48.781" class="difflineminus">-    if (Compare(str, m_WorkState, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.782"></a><span id="l48.782" class="difflineplus">+    if (NS_FAILED(card-&gt;GetPropertyAsAString(kWorkStateProperty, str)))</span>
<a href="#l48.783"></a><span id="l48.783" class="difflineplus">+      str.Truncate();</span>
<a href="#l48.784"></a><span id="l48.784" class="difflineplus">+    if (Compare(str, kWorkStateProperty))</span>
<a href="#l48.785"></a><span id="l48.785">         return NS_OK;</span>
<a href="#l48.786"></a><span id="l48.786"> </span>
<a href="#l48.787"></a><span id="l48.787" class="difflineminus">-    card-&gt;GetWorkZipCode(str);</span>
<a href="#l48.788"></a><span id="l48.788" class="difflineminus">-    if (Compare(str, m_WorkZipCode, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.789"></a><span id="l48.789" class="difflineplus">+    if (NS_FAILED(card-&gt;GetPropertyAsAString(kWorkZipCodeProperty, str)))</span>
<a href="#l48.790"></a><span id="l48.790" class="difflineplus">+      str.Truncate();</span>
<a href="#l48.791"></a><span id="l48.791" class="difflineplus">+    if (Compare(str, kWorkZipCodeProperty))</span>
<a href="#l48.792"></a><span id="l48.792">         return NS_OK;</span>
<a href="#l48.793"></a><span id="l48.793"> </span>
<a href="#l48.794"></a><span id="l48.794" class="difflineminus">-    card-&gt;GetWorkCountry(str);</span>
<a href="#l48.795"></a><span id="l48.795" class="difflineminus">-    if (Compare(str, m_WorkCountry, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.796"></a><span id="l48.796" class="difflineplus">+    if (NS_FAILED(card-&gt;GetPropertyAsAString(kWorkCountryProperty, str)))</span>
<a href="#l48.797"></a><span id="l48.797" class="difflineplus">+      str.Truncate();</span>
<a href="#l48.798"></a><span id="l48.798" class="difflineplus">+    if (Compare(str, kWorkCountryProperty))</span>
<a href="#l48.799"></a><span id="l48.799">         return NS_OK;</span>
<a href="#l48.800"></a><span id="l48.800"> </span>
<a href="#l48.801"></a><span id="l48.801" class="difflineminus">-    card-&gt;GetJobTitle(str);</span>
<a href="#l48.802"></a><span id="l48.802" class="difflineminus">-    if (Compare(str, m_JobTitle, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.803"></a><span id="l48.803" class="difflineplus">+    if (NS_FAILED(card-&gt;GetPropertyAsAString(kJobTitleProperty, str)))</span>
<a href="#l48.804"></a><span id="l48.804" class="difflineplus">+      str.Truncate();</span>
<a href="#l48.805"></a><span id="l48.805" class="difflineplus">+    if (Compare(str, kJobTitleProperty))</span>
<a href="#l48.806"></a><span id="l48.806">         return NS_OK;</span>
<a href="#l48.807"></a><span id="l48.807"> </span>
<a href="#l48.808"></a><span id="l48.808" class="difflineminus">-    card-&gt;GetDepartment(str);</span>
<a href="#l48.809"></a><span id="l48.809" class="difflineminus">-    if (Compare(str, m_Department, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.810"></a><span id="l48.810" class="difflineplus">+    if (NS_FAILED(card-&gt;GetPropertyAsAString(kDepartmentProperty, str)))</span>
<a href="#l48.811"></a><span id="l48.811" class="difflineplus">+      str.Truncate();</span>
<a href="#l48.812"></a><span id="l48.812" class="difflineplus">+    if (Compare(str, kDepartmentProperty))</span>
<a href="#l48.813"></a><span id="l48.813">         return NS_OK;</span>
<a href="#l48.814"></a><span id="l48.814"> </span>
<a href="#l48.815"></a><span id="l48.815" class="difflineminus">-    card-&gt;GetCompany(str);</span>
<a href="#l48.816"></a><span id="l48.816" class="difflineminus">-    if (Compare(str, m_Company, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.817"></a><span id="l48.817" class="difflineplus">+    if (NS_FAILED(card-&gt;GetPropertyAsAString(kCompanyProperty, str)))</span>
<a href="#l48.818"></a><span id="l48.818" class="difflineplus">+      str.Truncate();</span>
<a href="#l48.819"></a><span id="l48.819" class="difflineplus">+    if (Compare(str, kCompanyProperty))</span>
<a href="#l48.820"></a><span id="l48.820">         return NS_OK;</span>
<a href="#l48.821"></a><span id="l48.821"> </span>
<a href="#l48.822"></a><span id="l48.822" class="difflineminus">-    card-&gt;GetWebPage1(str);</span>
<a href="#l48.823"></a><span id="l48.823" class="difflineminus">-    if (Compare(str, m_WebPage1, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.824"></a><span id="l48.824" class="difflineplus">+    if (NS_FAILED(card-&gt;GetPropertyAsAString(kWorkWebPageProperty, str)))</span>
<a href="#l48.825"></a><span id="l48.825" class="difflineplus">+      str.Truncate();</span>
<a href="#l48.826"></a><span id="l48.826" class="difflineplus">+    if (Compare(str, kWorkWebPageProperty))</span>
<a href="#l48.827"></a><span id="l48.827">         return NS_OK;</span>
<a href="#l48.828"></a><span id="l48.828"> </span>
<a href="#l48.829"></a><span id="l48.829" class="difflineminus">-    card-&gt;GetWebPage2(str);</span>
<a href="#l48.830"></a><span id="l48.830" class="difflineminus">-    if (Compare(str, m_WebPage2, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.831"></a><span id="l48.831" class="difflineplus">+    if (NS_FAILED(card-&gt;GetPropertyAsAString(kHomeWebPageProperty, str)))</span>
<a href="#l48.832"></a><span id="l48.832" class="difflineplus">+      str.Truncate();</span>
<a href="#l48.833"></a><span id="l48.833" class="difflineplus">+    if (Compare(str, kHomeWebPageProperty))</span>
<a href="#l48.834"></a><span id="l48.834">         return NS_OK;</span>
<a href="#l48.835"></a><span id="l48.835"> </span>
<a href="#l48.836"></a><span id="l48.836" class="difflineminus">-    card-&gt;GetBirthYear(str);</span>
<a href="#l48.837"></a><span id="l48.837" class="difflineminus">-    if (Compare(str, m_BirthYear, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.838"></a><span id="l48.838" class="difflineplus">+    if (NS_FAILED(card-&gt;GetPropertyAsAString(kBirthYearProperty, str)))</span>
<a href="#l48.839"></a><span id="l48.839" class="difflineplus">+      str.Truncate();</span>
<a href="#l48.840"></a><span id="l48.840" class="difflineplus">+    if (Compare(str, kBirthYearProperty))</span>
<a href="#l48.841"></a><span id="l48.841">         return NS_OK;</span>
<a href="#l48.842"></a><span id="l48.842"> </span>
<a href="#l48.843"></a><span id="l48.843" class="difflineminus">-    card-&gt;GetBirthMonth(str);</span>
<a href="#l48.844"></a><span id="l48.844" class="difflineminus">-    if (Compare(str, m_BirthMonth, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.845"></a><span id="l48.845" class="difflineplus">+    if (NS_FAILED(card-&gt;GetPropertyAsAString(kBirthMonthProperty, str)))</span>
<a href="#l48.846"></a><span id="l48.846" class="difflineplus">+      str.Truncate();</span>
<a href="#l48.847"></a><span id="l48.847" class="difflineplus">+    if (Compare(str, kBirthMonthProperty))</span>
<a href="#l48.848"></a><span id="l48.848">         return NS_OK;</span>
<a href="#l48.849"></a><span id="l48.849"> </span>
<a href="#l48.850"></a><span id="l48.850" class="difflineminus">-    card-&gt;GetBirthDay(str);</span>
<a href="#l48.851"></a><span id="l48.851" class="difflineminus">-    if (Compare(str, m_BirthDay, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.852"></a><span id="l48.852" class="difflineplus">+    if (NS_FAILED(card-&gt;GetPropertyAsAString(kBirthDayProperty, str)))</span>
<a href="#l48.853"></a><span id="l48.853" class="difflineplus">+      str.Truncate();</span>
<a href="#l48.854"></a><span id="l48.854" class="difflineplus">+    if (Compare(str, kBirthDayProperty))</span>
<a href="#l48.855"></a><span id="l48.855">         return NS_OK;</span>
<a href="#l48.856"></a><span id="l48.856"> </span>
<a href="#l48.857"></a><span id="l48.857" class="difflineminus">-    card-&gt;GetCustom1(str);</span>
<a href="#l48.858"></a><span id="l48.858" class="difflineminus">-    if (Compare(str, m_Custom1, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.859"></a><span id="l48.859" class="difflineplus">+    if (NS_FAILED(card-&gt;GetPropertyAsAString(kCustom1Property, str)))</span>
<a href="#l48.860"></a><span id="l48.860" class="difflineplus">+      str.Truncate();</span>
<a href="#l48.861"></a><span id="l48.861" class="difflineplus">+    if (Compare(str, kCustom1Property))</span>
<a href="#l48.862"></a><span id="l48.862">         return NS_OK;</span>
<a href="#l48.863"></a><span id="l48.863"> </span>
<a href="#l48.864"></a><span id="l48.864" class="difflineminus">-    card-&gt;GetCustom2(str);</span>
<a href="#l48.865"></a><span id="l48.865" class="difflineminus">-    if (Compare(str, m_Custom2, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.866"></a><span id="l48.866" class="difflineplus">+    if (NS_FAILED(card-&gt;GetPropertyAsAString(kCustom2Property, str)))</span>
<a href="#l48.867"></a><span id="l48.867" class="difflineplus">+      str.Truncate();</span>
<a href="#l48.868"></a><span id="l48.868" class="difflineplus">+    if (Compare(str, kCustom2Property))</span>
<a href="#l48.869"></a><span id="l48.869">         return NS_OK;</span>
<a href="#l48.870"></a><span id="l48.870"> </span>
<a href="#l48.871"></a><span id="l48.871" class="difflineminus">-    card-&gt;GetCustom3(str);</span>
<a href="#l48.872"></a><span id="l48.872" class="difflineminus">-    if (Compare(str, m_Custom3, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.873"></a><span id="l48.873" class="difflineplus">+    if (NS_FAILED(card-&gt;GetPropertyAsAString(kCustom3Property, str)))</span>
<a href="#l48.874"></a><span id="l48.874" class="difflineplus">+      str.Truncate();</span>
<a href="#l48.875"></a><span id="l48.875" class="difflineplus">+    if (Compare(str, kCustom3Property))</span>
<a href="#l48.876"></a><span id="l48.876">         return NS_OK;</span>
<a href="#l48.877"></a><span id="l48.877"> </span>
<a href="#l48.878"></a><span id="l48.878" class="difflineminus">-    card-&gt;GetCustom4(str);</span>
<a href="#l48.879"></a><span id="l48.879" class="difflineminus">-    if (Compare(str, m_Custom4, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.880"></a><span id="l48.880" class="difflineplus">+    if (NS_FAILED(card-&gt;GetPropertyAsAString(kCustom4Property, str)))</span>
<a href="#l48.881"></a><span id="l48.881" class="difflineplus">+      str.Truncate();</span>
<a href="#l48.882"></a><span id="l48.882" class="difflineplus">+    if (Compare(str, kCustom4Property))</span>
<a href="#l48.883"></a><span id="l48.883">         return NS_OK;</span>
<a href="#l48.884"></a><span id="l48.884"> </span>
<a href="#l48.885"></a><span id="l48.885">     PRBool isMailList=PR_FALSE;</span>
<a href="#l48.886"></a><span id="l48.886">     card-&gt;GetIsMailList(&amp;isMailList);</span>
<a href="#l48.887"></a><span id="l48.887">     if (isMailList != m_IsMailList)</span>
<a href="#l48.888"></a><span id="l48.888">         return NS_OK;</span>
<a href="#l48.889"></a><span id="l48.889"> </span>
<a href="#l48.890"></a><span id="l48.890">     nsCString str2;</span>
<a href="#l48.891"></a><span id="l48.891">     card-&gt;GetMailListURI(getter_Copies(str2));</span>
<a href="#l48.892"></a><span id="l48.892">     if (m_MailListURI.Equals(str2, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l48.893"></a><span id="l48.893">         return NS_OK;</span>
<a href="#l48.894"></a><span id="l48.894"> </span>
<a href="#l48.895"></a><span id="l48.895">     *_retval = PR_TRUE;</span>
<a href="#l48.896"></a><span id="l48.896">     return NS_OK;</span>
<a href="#l48.897"></a><span id="l48.897"> }</span>
<a href="#l48.898"></a><span id="l48.898"> </span>
<a href="#l48.899"></a><span id="l48.899" class="difflineminus">-PRBool nsAbIPCCard::CompareValue(PRBool isUnicode, LPTSTR cardValue, nsString &amp; attribValue)</span>
<a href="#l48.900"></a><span id="l48.900" class="difflineplus">+PRBool nsAbIPCCard::CompareValue(PRBool isUnicode, LPTSTR cardValue, const char *attribute)</span>
<a href="#l48.901"></a><span id="l48.901"> {</span>
<a href="#l48.902"></a><span id="l48.902">     if(cardValue) {</span>
<a href="#l48.903"></a><span id="l48.903">         if(isUnicode) {</span>
<a href="#l48.904"></a><span id="l48.904" class="difflineminus">-            if (Compare(nsDependentString(cardValue), attribValue, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.905"></a><span id="l48.905" class="difflineplus">+            if (Compare(nsDependentString(cardValue), attribute))</span>
<a href="#l48.906"></a><span id="l48.906">                 return PR_FALSE;</span>
<a href="#l48.907"></a><span id="l48.907">         }</span>
<a href="#l48.908"></a><span id="l48.908">         else {</span>
<a href="#l48.909"></a><span id="l48.909">             nsAutoString str;</span>
<a href="#l48.910"></a><span id="l48.910">             CONVERT_ASSIGNTO_UNICODE(str, cardValue, PR_TRUE);</span>
<a href="#l48.911"></a><span id="l48.911" class="difflineminus">-            if (Compare(str, attribValue, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.912"></a><span id="l48.912" class="difflineplus">+            if (Compare(str, attribute))</span>
<a href="#l48.913"></a><span id="l48.913">                 return PR_FALSE;</span>
<a href="#l48.914"></a><span id="l48.914">         }</span>
<a href="#l48.915"></a><span id="l48.915">     }</span>
<a href="#l48.916"></a><span id="l48.916"> </span>
<a href="#l48.917"></a><span id="l48.917">     return PR_TRUE;</span>
<a href="#l48.918"></a><span id="l48.918"> }</span>
<a href="#l48.919"></a><span id="l48.919"> </span>
<a href="#l48.920"></a><span id="l48.920" class="difflineplus">+PRBool nsAbIPCCard::Compare(nsString &amp;cardValue, const char *attribute)</span>
<a href="#l48.921"></a><span id="l48.921" class="difflineplus">+{</span>
<a href="#l48.922"></a><span id="l48.922" class="difflineplus">+  nsAutoString attribValue;</span>
<a href="#l48.923"></a><span id="l48.923" class="difflineplus">+  GetPropertyAsAString(attribute, attribValue);</span>
<a href="#l48.924"></a><span id="l48.924" class="difflineplus">+  return ::Compare(cardValue, attribValue, nsCaseInsensitiveStringComparator());</span>
<a href="#l48.925"></a><span id="l48.925" class="difflineplus">+}</span>
<a href="#l48.926"></a><span id="l48.926"> PRBool nsAbIPCCard::Same(nsABCOMCardStruct * card, PRBool isUnicode)</span>
<a href="#l48.927"></a><span id="l48.927"> {</span>
<a href="#l48.928"></a><span id="l48.928">     if(!card)</span>
<a href="#l48.929"></a><span id="l48.929">         return PR_FALSE;</span>
<a href="#l48.930"></a><span id="l48.930"> </span>
<a href="#l48.931"></a><span id="l48.931">     if(mRecordId &amp;&amp; card-&gt;dwRecordId) </span>
<a href="#l48.932"></a><span id="l48.932">         return (mRecordId == card-&gt;dwRecordId);</span>
<a href="#l48.933"></a><span id="l48.933"> </span>
<a href="#l48.934"></a><span id="l48.934" class="difflineminus">-    if(CompareValue(isUnicode, card-&gt;firstName, m_FirstName))</span>
<a href="#l48.935"></a><span id="l48.935" class="difflineminus">-        if(CompareValue(isUnicode, card-&gt;lastName, m_LastName))</span>
<a href="#l48.936"></a><span id="l48.936" class="difflineminus">-            if(CompareValue(isUnicode, card-&gt;displayName, m_DisplayName))</span>
<a href="#l48.937"></a><span id="l48.937" class="difflineminus">-                if(CompareValue(isUnicode, card-&gt;nickName, m_NickName))</span>
<a href="#l48.938"></a><span id="l48.938" class="difflineplus">+    if(CompareValue(isUnicode, card-&gt;firstName, kFirstNameProperty))</span>
<a href="#l48.939"></a><span id="l48.939" class="difflineplus">+        if(CompareValue(isUnicode, card-&gt;lastName, kLastNameProperty))</span>
<a href="#l48.940"></a><span id="l48.940" class="difflineplus">+            if(CompareValue(isUnicode, card-&gt;displayName, kDisplayNameProperty))</span>
<a href="#l48.941"></a><span id="l48.941" class="difflineplus">+                if(CompareValue(isUnicode, card-&gt;nickName, kNicknameProperty))</span>
<a href="#l48.942"></a><span id="l48.942">                     return PR_TRUE;</span>
<a href="#l48.943"></a><span id="l48.943"> </span>
<a href="#l48.944"></a><span id="l48.944">     return PR_FALSE;</span>
<a href="#l48.945"></a><span id="l48.945"> }</span>
<a href="#l48.946"></a><span id="l48.946"> </span>
<a href="#l48.947"></a><span id="l48.947"> </span>
<a href="#l48.948"></a><span id="l48.948"> PRBool nsAbIPCCard::Same(nsIAbCard *card)</span>
<a href="#l48.949"></a><span id="l48.949"> {</span>
<a href="#l48.950"></a><span id="l48.950">     if(!card)</span>
<a href="#l48.951"></a><span id="l48.951">         return PR_FALSE;</span>
<a href="#l48.952"></a><span id="l48.952"> </span>
<a href="#l48.953"></a><span id="l48.953">     nsresult rv;</span>
<a href="#l48.954"></a><span id="l48.954" class="difflineminus">-    nsCOMPtr&lt;nsIAbMDBCard&gt; dbCard;</span>
<a href="#l48.955"></a><span id="l48.955" class="difflineminus">-    dbCard = do_QueryInterface(card, &amp;rv);</span>
<a href="#l48.956"></a><span id="l48.956" class="difflineminus">-    if(NS_SUCCEEDED(rv)) {</span>
<a href="#l48.957"></a><span id="l48.957" class="difflineminus">-        // first check the palmID for the cards if they exist</span>
<a href="#l48.958"></a><span id="l48.958" class="difflineminus">-        nsString palmIDStr;</span>
<a href="#l48.959"></a><span id="l48.959" class="difflineminus">-        rv = dbCard-&gt;GetStringAttribute(CARD_ATTRIB_PALMID, getter_Copies(palmIDStr));</span>
<a href="#l48.960"></a><span id="l48.960" class="difflineminus">-        if(NS_SUCCEEDED(rv) &amp;&amp; palmIDStr.get()) {</span>
<a href="#l48.961"></a><span id="l48.961" class="difflineminus">-            PRInt32 palmID=0;</span>
<a href="#l48.962"></a><span id="l48.962" class="difflineminus">-            PRFloat64 f = PR_strtod(NS_LossyConvertUTF16toASCII(palmIDStr).get(), nsnull);</span>
<a href="#l48.963"></a><span id="l48.963" class="difflineminus">-            PRInt64 l;</span>
<a href="#l48.964"></a><span id="l48.964" class="difflineminus">-            LL_D2L(l, f);</span>
<a href="#l48.965"></a><span id="l48.965" class="difflineminus">-            LL_L2UI(palmID, l);</span>
<a href="#l48.966"></a><span id="l48.966" class="difflineminus">-            if(palmID &amp;&amp; mRecordId)</span>
<a href="#l48.967"></a><span id="l48.967" class="difflineminus">-                return mRecordId == palmID;</span>
<a href="#l48.968"></a><span id="l48.968" class="difflineminus">-        }</span>
<a href="#l48.969"></a><span id="l48.969" class="difflineplus">+    // first check the palmID for the cards if they exist</span>
<a href="#l48.970"></a><span id="l48.970" class="difflineplus">+    nsString palmIDStr;</span>
<a href="#l48.971"></a><span id="l48.971" class="difflineplus">+    rv = card-&gt;GetPropertyAsAString(CARD_ATTRIB_PALMID, palmIDStr);</span>
<a href="#l48.972"></a><span id="l48.972" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; palmIDStr.get()) {</span>
<a href="#l48.973"></a><span id="l48.973" class="difflineplus">+      PRInt32 palmID=0;</span>
<a href="#l48.974"></a><span id="l48.974" class="difflineplus">+      PRFloat64 f = PR_strtod(NS_LossyConvertUTF16toASCII(palmIDStr).get(), nsnull);</span>
<a href="#l48.975"></a><span id="l48.975" class="difflineplus">+      PRInt64 l;</span>
<a href="#l48.976"></a><span id="l48.976" class="difflineplus">+      LL_D2L(l, f);</span>
<a href="#l48.977"></a><span id="l48.977" class="difflineplus">+      LL_L2UI(palmID, l);</span>
<a href="#l48.978"></a><span id="l48.978" class="difflineplus">+      if (palmID &amp;&amp; mRecordId)</span>
<a href="#l48.979"></a><span id="l48.979" class="difflineplus">+        return mRecordId == palmID;</span>
<a href="#l48.980"></a><span id="l48.980">     }</span>
<a href="#l48.981"></a><span id="l48.981"> </span>
<a href="#l48.982"></a><span id="l48.982">     nsString str;</span>
<a href="#l48.983"></a><span id="l48.983">     card-&gt;GetFirstName(str);</span>
<a href="#l48.984"></a><span id="l48.984" class="difflineminus">-    if (Compare(str, m_FirstName, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.985"></a><span id="l48.985" class="difflineplus">+    if (Compare(str, kFirstNameProperty))</span>
<a href="#l48.986"></a><span id="l48.986">         return PR_FALSE;</span>
<a href="#l48.987"></a><span id="l48.987">     card-&gt;GetLastName(str);</span>
<a href="#l48.988"></a><span id="l48.988" class="difflineminus">-    if (Compare(str, m_LastName, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.989"></a><span id="l48.989" class="difflineplus">+    if (Compare(str, kLastNameProperty))</span>
<a href="#l48.990"></a><span id="l48.990">         return PR_FALSE;</span>
<a href="#l48.991"></a><span id="l48.991">     card-&gt;GetDisplayName(str);</span>
<a href="#l48.992"></a><span id="l48.992" class="difflineminus">-    if (Compare(str, m_DisplayName, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.993"></a><span id="l48.993" class="difflineplus">+    if (Compare(str, kDisplayNameProperty))</span>
<a href="#l48.994"></a><span id="l48.994">         return PR_FALSE;</span>
<a href="#l48.995"></a><span id="l48.995" class="difflineminus">-    card-&gt;GetNickName(str);</span>
<a href="#l48.996"></a><span id="l48.996" class="difflineminus">-    if (Compare(str, m_NickName, nsCaseInsensitiveStringComparator()))</span>
<a href="#l48.997"></a><span id="l48.997" class="difflineplus">+    if (NS_FAILED(card-&gt;GetPropertyAsAString(kNicknameProperty, str)))</span>
<a href="#l48.998"></a><span id="l48.998" class="difflineplus">+      str.Truncate();</span>
<a href="#l48.999"></a><span id="l48.999" class="difflineplus">+    if (Compare(str, kNicknameProperty))</span>
<a href="#l48.1000"></a><span id="l48.1000">         return PR_FALSE;</span>
<a href="#l48.1001"></a><span id="l48.1001"> </span>
<a href="#l48.1002"></a><span id="l48.1002">     return PR_TRUE;</span>
<a href="#l48.1003"></a><span id="l48.1003"> }</span>
<a href="#l48.1004"></a><span id="l48.1004"> </span>
<a href="#l48.1005"></a><span id="l48.1005"> </span>
<a href="#l48.1006"></a><span id="l48.1006" class="difflineminus">-void nsAbIPCCard::CopyValue(PRBool isUnicode, nsString &amp; attribValue, LPTSTR * result)</span>
<a href="#l48.1007"></a><span id="l48.1007" class="difflineplus">+void nsAbIPCCard::CopyValue(PRBool isUnicode, const char *attribute, LPTSTR * result)</span>
<a href="#l48.1008"></a><span id="l48.1008"> {</span>
<a href="#l48.1009"></a><span id="l48.1009">     *result = NULL;</span>
<a href="#l48.1010"></a><span id="l48.1010" class="difflineplus">+    nsAutoString attribValue;</span>
<a href="#l48.1011"></a><span id="l48.1011" class="difflineplus">+    GetPropertyAsAString(attribute, attribValue);</span>
<a href="#l48.1012"></a><span id="l48.1012">     if(attribValue.Length() &amp;&amp; attribValue.get()) {</span>
<a href="#l48.1013"></a><span id="l48.1013">         PRInt32 length;</span>
<a href="#l48.1014"></a><span id="l48.1014">         if(isUnicode) {                                 </span>
<a href="#l48.1015"></a><span id="l48.1015">             length = attribValue.Length()+1;</span>
<a href="#l48.1016"></a><span id="l48.1016">             PRUnichar * Str = (PRUnichar *) CoTaskMemAlloc(sizeof(PRUnichar) * length);</span>
<a href="#l48.1017"></a><span id="l48.1017">             wcsncpy(Str, attribValue.get(), length-1);</span>
<a href="#l48.1018"></a><span id="l48.1018">             Str[length-1] = '\0';</span>
<a href="#l48.1019"></a><span id="l48.1019">             *result = Str;</span>
<a href="#l48.1020"></a><span id="l48.1020" class="difflineat">@@ -842,58 +873,63 @@ nsresult nsAbIPCCard::GetABCOMCardStruct</span>
<a href="#l48.1021"></a><span id="l48.1021">     // receive a different return code even if nsSynchronizeAB() return S_OK.</span>
<a href="#l48.1022"></a><span id="l48.1022">     memset(card, 0, sizeof(nsABCOMCardStruct));</span>
<a href="#l48.1023"></a><span id="l48.1023">     card-&gt;dwRecordId = mRecordId;</span>
<a href="#l48.1024"></a><span id="l48.1024">     card-&gt;dwCategoryId = mCategoryId;</span>
<a href="#l48.1025"></a><span id="l48.1025">     card-&gt;dwStatus = mStatus;</span>
<a href="#l48.1026"></a><span id="l48.1026">     card-&gt;addressToUse = CPalmSyncImp::nsUseABHomeAddressForPalmAddress(); // 0 == home, 1 == work</span>
<a href="#l48.1027"></a><span id="l48.1027">     PR_LOG(PALMSYNC, PR_LOG_DEBUG, (&quot;nsAbIPCCard::GetABCOMCardStruct using %d\n&quot;, card-&gt;addressToUse));</span>
<a href="#l48.1028"></a><span id="l48.1028"> </span>
<a href="#l48.1029"></a><span id="l48.1029" class="difflineminus">-    CopyValue(isUnicode, m_FirstName, &amp;card-&gt;firstName);</span>
<a href="#l48.1030"></a><span id="l48.1030" class="difflineminus">-    CopyValue(isUnicode, m_LastName, &amp;card-&gt;lastName);</span>
<a href="#l48.1031"></a><span id="l48.1031" class="difflineminus">-    CopyValue(isUnicode, m_DisplayName, &amp;card-&gt;displayName);</span>
<a href="#l48.1032"></a><span id="l48.1032" class="difflineminus">-    CopyValue(isUnicode, m_NickName, &amp;card-&gt;nickName);</span>
<a href="#l48.1033"></a><span id="l48.1033" class="difflineminus">-    CopyValue(isUnicode, m_PrimaryEmail, &amp;card-&gt;primaryEmail);</span>
<a href="#l48.1034"></a><span id="l48.1034" class="difflineminus">-    CopyValue(isUnicode, m_SecondEmail, &amp;card-&gt;secondEmail);</span>
<a href="#l48.1035"></a><span id="l48.1035" class="difflineminus">-    CopyValue(isUnicode, m_WorkPhone, &amp;card-&gt;workPhone);</span>
<a href="#l48.1036"></a><span id="l48.1036" class="difflineminus">-    CopyValue(isUnicode, m_HomePhone, &amp;card-&gt;homePhone);</span>
<a href="#l48.1037"></a><span id="l48.1037" class="difflineminus">-    CopyValue(isUnicode, m_FaxNumber, &amp;card-&gt;faxNumber);</span>
<a href="#l48.1038"></a><span id="l48.1038" class="difflineminus">-    CopyValue(isUnicode, m_PagerNumber, &amp;card-&gt;pagerNumber);</span>
<a href="#l48.1039"></a><span id="l48.1039" class="difflineminus">-    CopyValue(isUnicode, m_CellularNumber, &amp;card-&gt;cellularNumber);</span>
<a href="#l48.1040"></a><span id="l48.1040" class="difflineplus">+    CopyValue(isUnicode, kFirstNameProperty, &amp;card-&gt;firstName);</span>
<a href="#l48.1041"></a><span id="l48.1041" class="difflineplus">+    CopyValue(isUnicode, kLastNameProperty, &amp;card-&gt;lastName);</span>
<a href="#l48.1042"></a><span id="l48.1042" class="difflineplus">+    CopyValue(isUnicode, kDisplayNameProperty, &amp;card-&gt;displayName);</span>
<a href="#l48.1043"></a><span id="l48.1043" class="difflineplus">+    CopyValue(isUnicode, kNicknameProperty, &amp;card-&gt;nickName);</span>
<a href="#l48.1044"></a><span id="l48.1044" class="difflineplus">+    CopyValue(isUnicode, kPriEmailProperty, &amp;card-&gt;primaryEmail);</span>
<a href="#l48.1045"></a><span id="l48.1045" class="difflineplus">+    CopyValue(isUnicode, k2ndEmailProperty, &amp;card-&gt;secondEmail);</span>
<a href="#l48.1046"></a><span id="l48.1046" class="difflineplus">+    CopyValue(isUnicode, kWorkPhoneProperty, &amp;card-&gt;workPhone);</span>
<a href="#l48.1047"></a><span id="l48.1047" class="difflineplus">+    CopyValue(isUnicode, kHomePhoneProperty, &amp;card-&gt;homePhone);</span>
<a href="#l48.1048"></a><span id="l48.1048" class="difflineplus">+    CopyValue(isUnicode, kFaxProperty, &amp;card-&gt;faxNumber);</span>
<a href="#l48.1049"></a><span id="l48.1049" class="difflineplus">+    CopyValue(isUnicode, kPagerProperty, &amp;card-&gt;pagerNumber);</span>
<a href="#l48.1050"></a><span id="l48.1050" class="difflineplus">+    CopyValue(isUnicode, kCellularProperty, &amp;card-&gt;cellularNumber);</span>
<a href="#l48.1051"></a><span id="l48.1051">     // See if home address contains multiple lines.</span>
<a href="#l48.1052"></a><span id="l48.1052">     JoinHomeAndWorkAddresses(isUnicode, card);</span>
<a href="#l48.1053"></a><span id="l48.1053" class="difflineminus">-    CopyValue(isUnicode, m_HomeCity, &amp;card-&gt;homeCity);</span>
<a href="#l48.1054"></a><span id="l48.1054" class="difflineminus">-    CopyValue(isUnicode, m_HomeState, &amp;card-&gt;homeState);</span>
<a href="#l48.1055"></a><span id="l48.1055" class="difflineminus">-    CopyValue(isUnicode, m_HomeZipCode, &amp;card-&gt;homeZipCode);</span>
<a href="#l48.1056"></a><span id="l48.1056" class="difflineminus">-    CopyValue(isUnicode, m_HomeCountry, &amp;card-&gt;homeCountry);</span>
<a href="#l48.1057"></a><span id="l48.1057" class="difflineminus">-    CopyValue(isUnicode, m_WorkCity, &amp;card-&gt;workCity);</span>
<a href="#l48.1058"></a><span id="l48.1058" class="difflineminus">-    CopyValue(isUnicode, m_WorkState, &amp;card-&gt;workState);</span>
<a href="#l48.1059"></a><span id="l48.1059" class="difflineminus">-    CopyValue(isUnicode, m_WorkZipCode, &amp;card-&gt;workZipCode);</span>
<a href="#l48.1060"></a><span id="l48.1060" class="difflineminus">-    CopyValue(isUnicode, m_WorkCountry, &amp;card-&gt;workCountry);</span>
<a href="#l48.1061"></a><span id="l48.1061" class="difflineminus">-    CopyValue(isUnicode, m_JobTitle, &amp;card-&gt;jobTitle);</span>
<a href="#l48.1062"></a><span id="l48.1062" class="difflineminus">-    CopyValue(isUnicode, m_Department, &amp;card-&gt;department);</span>
<a href="#l48.1063"></a><span id="l48.1063" class="difflineminus">-    CopyValue(isUnicode, m_Company, &amp;card-&gt;company);</span>
<a href="#l48.1064"></a><span id="l48.1064" class="difflineminus">-    CopyValue(isUnicode, m_WebPage1, &amp;card-&gt;webPage1);</span>
<a href="#l48.1065"></a><span id="l48.1065" class="difflineminus">-    CopyValue(isUnicode, m_WebPage2, &amp;card-&gt;webPage2);</span>
<a href="#l48.1066"></a><span id="l48.1066" class="difflineminus">-    CopyValue(isUnicode, m_BirthYear, &amp;card-&gt;birthYear);</span>
<a href="#l48.1067"></a><span id="l48.1067" class="difflineminus">-    CopyValue(isUnicode, m_BirthMonth, &amp;card-&gt;birthMonth);</span>
<a href="#l48.1068"></a><span id="l48.1068" class="difflineminus">-    CopyValue(isUnicode, m_BirthDay, &amp;card-&gt;birthDay);</span>
<a href="#l48.1069"></a><span id="l48.1069" class="difflineminus">-    CopyValue(isUnicode, m_Custom1, &amp;card-&gt;custom1);</span>
<a href="#l48.1070"></a><span id="l48.1070" class="difflineminus">-    CopyValue(isUnicode, m_Custom2, &amp;card-&gt;custom2);</span>
<a href="#l48.1071"></a><span id="l48.1071" class="difflineminus">-    CopyValue(isUnicode, m_Custom3, &amp;card-&gt;custom3);</span>
<a href="#l48.1072"></a><span id="l48.1072" class="difflineminus">-    CopyValue(isUnicode, m_Custom4, &amp;card-&gt;custom4);</span>
<a href="#l48.1073"></a><span id="l48.1073" class="difflineminus">-    CopyValue(isUnicode, m_Note, &amp;card-&gt;notes);</span>
<a href="#l48.1074"></a><span id="l48.1074" class="difflineplus">+    CopyValue(isUnicode, kHomeCityProperty, &amp;card-&gt;homeCity);</span>
<a href="#l48.1075"></a><span id="l48.1075" class="difflineplus">+    CopyValue(isUnicode, kHomeStateProperty, &amp;card-&gt;homeState);</span>
<a href="#l48.1076"></a><span id="l48.1076" class="difflineplus">+    CopyValue(isUnicode, kHomeZipCodeProperty, &amp;card-&gt;homeZipCode);</span>
<a href="#l48.1077"></a><span id="l48.1077" class="difflineplus">+    CopyValue(isUnicode, kHomeCountryProperty, &amp;card-&gt;homeCountry);</span>
<a href="#l48.1078"></a><span id="l48.1078" class="difflineplus">+    CopyValue(isUnicode, kWorkCityProperty, &amp;card-&gt;workCity);</span>
<a href="#l48.1079"></a><span id="l48.1079" class="difflineplus">+    CopyValue(isUnicode, kWorkStateProperty, &amp;card-&gt;workState);</span>
<a href="#l48.1080"></a><span id="l48.1080" class="difflineplus">+    CopyValue(isUnicode, kWorkZipCodeProperty, &amp;card-&gt;workZipCode);</span>
<a href="#l48.1081"></a><span id="l48.1081" class="difflineplus">+    CopyValue(isUnicode, kWorkCountryProperty, &amp;card-&gt;workCountry);</span>
<a href="#l48.1082"></a><span id="l48.1082" class="difflineplus">+    CopyValue(isUnicode, kJobTitleProperty, &amp;card-&gt;jobTitle);</span>
<a href="#l48.1083"></a><span id="l48.1083" class="difflineplus">+    CopyValue(isUnicode, kDepartmentProperty, &amp;card-&gt;department);</span>
<a href="#l48.1084"></a><span id="l48.1084" class="difflineplus">+    CopyValue(isUnicode, kCompanyProperty, &amp;card-&gt;company);</span>
<a href="#l48.1085"></a><span id="l48.1085" class="difflineplus">+    CopyValue(isUnicode, kWorkWebPageProperty, &amp;card-&gt;webPage1);</span>
<a href="#l48.1086"></a><span id="l48.1086" class="difflineplus">+    CopyValue(isUnicode, kHomeWebPageProperty, &amp;card-&gt;webPage2);</span>
<a href="#l48.1087"></a><span id="l48.1087" class="difflineplus">+    CopyValue(isUnicode, kBirthYearProperty, &amp;card-&gt;birthYear);</span>
<a href="#l48.1088"></a><span id="l48.1088" class="difflineplus">+    CopyValue(isUnicode, kBirthMonthProperty, &amp;card-&gt;birthMonth);</span>
<a href="#l48.1089"></a><span id="l48.1089" class="difflineplus">+    CopyValue(isUnicode, kBirthDayProperty, &amp;card-&gt;birthDay);</span>
<a href="#l48.1090"></a><span id="l48.1090" class="difflineplus">+    CopyValue(isUnicode, kCustom1Property, &amp;card-&gt;custom1);</span>
<a href="#l48.1091"></a><span id="l48.1091" class="difflineplus">+    CopyValue(isUnicode, kCustom2Property, &amp;card-&gt;custom2);</span>
<a href="#l48.1092"></a><span id="l48.1092" class="difflineplus">+    CopyValue(isUnicode, kCustom3Property, &amp;card-&gt;custom3);</span>
<a href="#l48.1093"></a><span id="l48.1093" class="difflineplus">+    CopyValue(isUnicode, kCustom4Property, &amp;card-&gt;custom4);</span>
<a href="#l48.1094"></a><span id="l48.1094" class="difflineplus">+    CopyValue(isUnicode, kNotesProperty, &amp;card-&gt;notes);</span>
<a href="#l48.1095"></a><span id="l48.1095"> </span>
<a href="#l48.1096"></a><span id="l48.1096" class="difflineminus">-    card-&gt;lastModifiedDate = m_LastModDate;</span>
<a href="#l48.1097"></a><span id="l48.1097" class="difflineminus">-    card-&gt;preferMailFormat = m_PreferMailFormat;</span>
<a href="#l48.1098"></a><span id="l48.1098" class="difflineplus">+    GetPropertyAsUint32(kLastModifiedDateProperty,</span>
<a href="#l48.1099"></a><span id="l48.1099" class="difflineplus">+                        (PRUint32*)&amp;card-&gt;lastModifiedDate);</span>
<a href="#l48.1100"></a><span id="l48.1100" class="difflineplus">+    GetPropertyAsUint32(kPreferMailFormatProperty,</span>
<a href="#l48.1101"></a><span id="l48.1101" class="difflineplus">+                        (PRUint32*)&amp;card-&gt;preferMailFormat);</span>
<a href="#l48.1102"></a><span id="l48.1102">     card-&gt;addressToUse = CPalmSyncImp::nsUseABHomeAddressForPalmAddress(); // 0 == home, 1 == work</span>
<a href="#l48.1103"></a><span id="l48.1103" class="difflineplus">+    nsAutoString homePhone, workPhone;</span>
<a href="#l48.1104"></a><span id="l48.1104" class="difflineplus">+    GetPropertyAsAString(kHomePhoneProperty, homePhone);</span>
<a href="#l48.1105"></a><span id="l48.1105" class="difflineplus">+    GetPropertyAsAString(kWorkPhoneProperty, workPhone);</span>
<a href="#l48.1106"></a><span id="l48.1106">     if (CPalmSyncImp::nsPreferABHomePhoneForPalmPhone())</span>
<a href="#l48.1107"></a><span id="l48.1107" class="difflineminus">-      card-&gt;preferredPhoneNum = (m_HomePhone.IsEmpty()) ? (m_WorkPhone.IsEmpty() ? 4 : 1) : 2;</span>
<a href="#l48.1108"></a><span id="l48.1108" class="difflineplus">+      card-&gt;preferredPhoneNum = (homePhone.IsEmpty()) ? (workPhone.IsEmpty() ? 4 : 1) : 2;</span>
<a href="#l48.1109"></a><span id="l48.1109">     else</span>
<a href="#l48.1110"></a><span id="l48.1110" class="difflineminus">-      card-&gt;preferredPhoneNum = (m_WorkPhone.IsEmpty()) ? 2 : (m_WorkPhone.IsEmpty() ? 4 : 1);</span>
<a href="#l48.1111"></a><span id="l48.1111" class="difflineplus">+      card-&gt;preferredPhoneNum = (workPhone.IsEmpty()) ? 2 : (workPhone.IsEmpty() ? 4 : 1);</span>
<a href="#l48.1112"></a><span id="l48.1112">     card-&gt;isMailList = m_IsMailList;</span>
<a href="#l48.1113"></a><span id="l48.1113">     // Can't use ToNewCString() call here becasue MSCOM will complaint about</span>
<a href="#l48.1114"></a><span id="l48.1114">     // memory deallocation (ie, NdrPointerFree()) use CoTaskMemAlloc() instead.</span>
<a href="#l48.1115"></a><span id="l48.1115">     if (m_MailListURI.IsEmpty())</span>
<a href="#l48.1116"></a><span id="l48.1116">       card-&gt;mailListURI = NULL;</span>
<a href="#l48.1117"></a><span id="l48.1117">     else</span>
<a href="#l48.1118"></a><span id="l48.1118">     {</span>
<a href="#l48.1119"></a><span id="l48.1119">       PRInt32 length = m_MailListURI.Length()+1;</span>
<a href="#l48.1120"></a><span id="l48.1120" class="difflineat">@@ -966,13 +1002,21 @@ void nsAbIPCCard::JoinAddress(PRBool isU</span>
<a href="#l48.1121"></a><span id="l48.1121">       strncpy(str, cStr.get(), strLength-1);</span>
<a href="#l48.1122"></a><span id="l48.1122">       str[strLength-1] = '\0';</span>
<a href="#l48.1123"></a><span id="l48.1123">     }</span>
<a href="#l48.1124"></a><span id="l48.1124">     *ptrAddress = (LPTSTR) str;</span>
<a href="#l48.1125"></a><span id="l48.1125">   } </span>
<a href="#l48.1126"></a><span id="l48.1126"> }</span>
<a href="#l48.1127"></a><span id="l48.1127"> void nsAbIPCCard::JoinHomeAndWorkAddresses(PRBool isUnicode, nsABCOMCardStruct * card)</span>
<a href="#l48.1128"></a><span id="l48.1128"> {</span>
<a href="#l48.1129"></a><span id="l48.1129" class="difflineminus">-  JoinAddress(isUnicode, &amp;card-&gt;homeAddress, m_HomeAddress, m_HomeAddress2);</span>
<a href="#l48.1130"></a><span id="l48.1130" class="difflineminus">-  JoinAddress(isUnicode, &amp;card-&gt;workAddress, m_WorkAddress, m_WorkAddress2);</span>
<a href="#l48.1131"></a><span id="l48.1131" class="difflineplus">+  nsAutoString address, address2;</span>
<a href="#l48.1132"></a><span id="l48.1132" class="difflineplus">+  GetPropertyAsAString(kHomeAddressProperty, address);</span>
<a href="#l48.1133"></a><span id="l48.1133" class="difflineplus">+  GetPropertyAsAString(kHomeAddress2Property, address2);</span>
<a href="#l48.1134"></a><span id="l48.1134" class="difflineplus">+  JoinAddress(isUnicode, &amp;card-&gt;homeAddress, address, address2);</span>
<a href="#l48.1135"></a><span id="l48.1135" class="difflineplus">+</span>
<a href="#l48.1136"></a><span id="l48.1136" class="difflineplus">+  address.Truncate();</span>
<a href="#l48.1137"></a><span id="l48.1137" class="difflineplus">+  address2.Truncate();</span>
<a href="#l48.1138"></a><span id="l48.1138" class="difflineplus">+  GetPropertyAsAString(kWorkAddressProperty, address);</span>
<a href="#l48.1139"></a><span id="l48.1139" class="difflineplus">+  GetPropertyAsAString(kWorkAddress2Property, address2);</span>
<a href="#l48.1140"></a><span id="l48.1140" class="difflineplus">+  JoinAddress(isUnicode, &amp;card-&gt;workAddress, address, address2);</span>
<a href="#l48.1141"></a><span id="l48.1141"> }</span>
<a href="#l48.1142"></a><span id="l48.1142"> </span>
<a href="#l48.1143"></a><span id="l48.1143"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l49.1"></a><span id="l49.1" class="difflineminus">--- a/mailnews/extensions/palmsync/src/nsAbIPCCard.h</span>
<a href="#l49.2"></a><span id="l49.2" class="difflineplus">+++ b/mailnews/extensions/palmsync/src/nsAbIPCCard.h</span>
<a href="#l49.3"></a><span id="l49.3" class="difflineat">@@ -34,32 +34,31 @@</span>
<a href="#l49.4"></a><span id="l49.4">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l49.5"></a><span id="l49.5">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l49.6"></a><span id="l49.6">  *</span>
<a href="#l49.7"></a><span id="l49.7">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l49.8"></a><span id="l49.8"> </span>
<a href="#l49.9"></a><span id="l49.9"> #ifndef nsAbIPCCard_h__</span>
<a href="#l49.10"></a><span id="l49.10"> #define nsAbIPCCard_h__</span>
<a href="#l49.11"></a><span id="l49.11"> </span>
<a href="#l49.12"></a><span id="l49.12" class="difflineminus">-#include &quot;nsAbMDBCard.h&quot;</span>
<a href="#l49.13"></a><span id="l49.13" class="difflineminus">-#include &quot;nsIAbMDBCard.h&quot;</span>
<a href="#l49.14"></a><span id="l49.14" class="difflineplus">+#include &quot;nsAbCardProperty.h&quot;</span>
<a href="#l49.15"></a><span id="l49.15"> #include &quot;nsISupportsArray.h&quot;</span>
<a href="#l49.16"></a><span id="l49.16"> #include &quot;nsVoidArray.h&quot;</span>
<a href="#l49.17"></a><span id="l49.17"> #include &quot;IPalmSync.h&quot;</span>
<a href="#l49.18"></a><span id="l49.18"> </span>
<a href="#l49.19"></a><span id="l49.19"> // these are states of Palm record</span>
<a href="#l49.20"></a><span id="l49.20"> // as defined in the Palm CDK</span>
<a href="#l49.21"></a><span id="l49.21"> #define ATTR_DELETED        0x0001</span>
<a href="#l49.22"></a><span id="l49.22"> #define ATTR_ARCHIVED       0x0002</span>
<a href="#l49.23"></a><span id="l49.23"> #define ATTR_MODIFIED       0x0004</span>
<a href="#l49.24"></a><span id="l49.24"> #define ATTR_NEW            0x0008</span>
<a href="#l49.25"></a><span id="l49.25"> #define ATTR_NONE           0x0020</span>
<a href="#l49.26"></a><span id="l49.26"> #define ATTR_NO_REC         0x0040</span>
<a href="#l49.27"></a><span id="l49.27"> </span>
<a href="#l49.28"></a><span id="l49.28" class="difflineminus">-class nsAbIPCCard : public nsAbMDBCard</span>
<a href="#l49.29"></a><span id="l49.29" class="difflineplus">+class nsAbIPCCard : public nsAbCardProperty</span>
<a href="#l49.30"></a><span id="l49.30"> {</span>
<a href="#l49.31"></a><span id="l49.31"> public:</span>
<a href="#l49.32"></a><span id="l49.32">     NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l49.33"></a><span id="l49.33">     </span>
<a href="#l49.34"></a><span id="l49.34">     // this checks for all card data fields</span>
<a href="#l49.35"></a><span id="l49.35">     NS_IMETHOD Equals(nsIAbCard *card, PRBool *_retval);</span>
<a href="#l49.36"></a><span id="l49.36">     PRBool Equals(nsABCOMCardStruct * card, nsStringArray &amp; differingAttrs);</span>
<a href="#l49.37"></a><span id="l49.37">     PRBool EqualsAfterUnicodeConversion(nsABCOMCardStruct * card, nsStringArray &amp; differingAttrs);</span>
<a href="#l49.38"></a><span id="l49.38" class="difflineat">@@ -88,17 +87,18 @@ public:</span>
<a href="#l49.39"></a><span id="l49.39">     void SetCategoryId(PRUint32 catID) { mCategoryId = catID; }</span>
<a href="#l49.40"></a><span id="l49.40">     PRUint32 GetCategoryId() { return mCategoryId; }</span>
<a href="#l49.41"></a><span id="l49.41"> </span>
<a href="#l49.42"></a><span id="l49.42"> private:</span>
<a href="#l49.43"></a><span id="l49.43">     PRUint32 mRecordId;</span>
<a href="#l49.44"></a><span id="l49.44">     PRUint32 mCategoryId;</span>
<a href="#l49.45"></a><span id="l49.45">     PRUint32 mStatus;</span>
<a href="#l49.46"></a><span id="l49.46"> </span>
<a href="#l49.47"></a><span id="l49.47" class="difflineminus">-    void CopyValue(PRBool isUnicode, nsString &amp; attribValue, LPTSTR * result);</span>
<a href="#l49.48"></a><span id="l49.48" class="difflineminus">-    PRBool CompareValue(PRBool isUnicode, LPTSTR cardValue, nsString &amp; attribValue);</span>
<a href="#l49.49"></a><span id="l49.49" class="difflineplus">+    void CopyValue(PRBool isUnicode, const char *attribute, LPTSTR * result);</span>
<a href="#l49.50"></a><span id="l49.50" class="difflineplus">+    PRBool CompareValue(PRBool isUnicode, LPTSTR cardValue, const char *attribute);</span>
<a href="#l49.51"></a><span id="l49.51" class="difflineplus">+    PRBool Compare(nsString &amp;cardValue, const char *attribute);</span>
<a href="#l49.52"></a><span id="l49.52">     void SplitHomeAndWorkAddresses(nsABCOMCardStruct * card, PRBool isUnicode);</span>
<a href="#l49.53"></a><span id="l49.53">     void SplitAddresses(PRBool isUnicode, LPTSTR homeAddress, LPTSTR workAddress);</span>
<a href="#l49.54"></a><span id="l49.54">     void JoinHomeAndWorkAddresses(PRBool isUnicode, nsABCOMCardStruct * card);</span>
<a href="#l49.55"></a><span id="l49.55">     void JoinAddress(PRBool isUnicode, LPTSTR *ptrAddress, nsString &amp;address1, nsString &amp;address2);</span>
<a href="#l49.56"></a><span id="l49.56"> };</span>
<a href="#l49.57"></a><span id="l49.57"> </span>
<a href="#l49.58"></a><span id="l49.58"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l50.1"></a><span id="l50.1" class="difflineminus">--- a/mailnews/extensions/palmsync/src/nsAbPalmSync.cpp</span>
<a href="#l50.2"></a><span id="l50.2" class="difflineplus">+++ b/mailnews/extensions/palmsync/src/nsAbPalmSync.cpp</span>
<a href="#l50.3"></a><span id="l50.3" class="difflineat">@@ -39,17 +39,16 @@</span>
<a href="#l50.4"></a><span id="l50.4"> </span>
<a href="#l50.5"></a><span id="l50.5"> #include &quot;nsRDFResource.h&quot;</span>
<a href="#l50.6"></a><span id="l50.6"> #include &quot;nsAbPalmSync.h&quot;</span>
<a href="#l50.7"></a><span id="l50.7"> #include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l50.8"></a><span id="l50.8"> #include &quot;nsMsgI18N.h&quot;</span>
<a href="#l50.9"></a><span id="l50.9"> #include &quot;nsIRDFService.h&quot;</span>
<a href="#l50.10"></a><span id="l50.10"> #include &quot;nsRDFCID.h&quot;</span>
<a href="#l50.11"></a><span id="l50.11"> #include &quot;nsUnicharUtils.h&quot;</span>
<a href="#l50.12"></a><span id="l50.12" class="difflineminus">-#include &quot;nsIAbMDBCard.h&quot;</span>
<a href="#l50.13"></a><span id="l50.13"> #include &quot;nsIAbManager.h&quot;</span>
<a href="#l50.14"></a><span id="l50.14"> #include &quot;nsAbCardProperty.h&quot;</span>
<a href="#l50.15"></a><span id="l50.15"> #include &quot;prdtoa.h&quot;</span>
<a href="#l50.16"></a><span id="l50.16"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l50.17"></a><span id="l50.17"> #include &quot;nsIArray.h&quot;</span>
<a href="#l50.18"></a><span id="l50.18"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l50.19"></a><span id="l50.19"> </span>
<a href="#l50.20"></a><span id="l50.20"> #define  PREVIOUS_EXTENSION &quot;.prev&quot;</span>
<a href="#l50.21"></a><span id="l50.21" class="difflineat">@@ -150,26 +149,25 @@ nsAbPalmHotSync::~nsAbPalmHotSync()</span>
<a href="#l50.22"></a><span id="l50.22">     // clear the nsVoidArray, don't free the stored pointers since they are freed by calling app (Conduit)</span>
<a href="#l50.23"></a><span id="l50.23">     mPalmRecords.Clear();</span>
<a href="#l50.24"></a><span id="l50.24"> </span>
<a href="#l50.25"></a><span id="l50.25">     if(mDBOpen &amp;&amp; mABDB)</span>
<a href="#l50.26"></a><span id="l50.26">         mABDB-&gt;Close(PR_FALSE);</span>
<a href="#l50.27"></a><span id="l50.27"> }</span>
<a href="#l50.28"></a><span id="l50.28"> </span>
<a href="#l50.29"></a><span id="l50.29"> // this is a utility function</span>
<a href="#l50.30"></a><span id="l50.30" class="difflineminus">-void nsAbPalmHotSync::ConvertAssignPalmIDAttrib(PRUint32 id, nsIAbMDBCard * card)  </span>
<a href="#l50.31"></a><span id="l50.31" class="difflineplus">+void nsAbPalmHotSync::ConvertAssignPalmIDAttrib(PRUint32 id, nsIAbCard * card)  </span>
<a href="#l50.32"></a><span id="l50.32"> { </span>
<a href="#l50.33"></a><span id="l50.33">     PRInt64 l;</span>
<a href="#l50.34"></a><span id="l50.34">     LL_UI2L(l, id);</span>
<a href="#l50.35"></a><span id="l50.35">     PRFloat64 f;</span>
<a href="#l50.36"></a><span id="l50.36">     LL_L2F(f, l);</span>
<a href="#l50.37"></a><span id="l50.37">     char buf[128];</span>
<a href="#l50.38"></a><span id="l50.38">     PR_cnvtf(buf, 128, 0, f);</span>
<a href="#l50.39"></a><span id="l50.39" class="difflineminus">-    card-&gt;SetAbDatabase(mABDB);</span>
<a href="#l50.40"></a><span id="l50.40" class="difflineminus">-    card-&gt;SetStringAttribute(CARD_ATTRIB_PALMID,NS_ConvertASCIItoUTF16(buf).get());</span>
<a href="#l50.41"></a><span id="l50.41" class="difflineplus">+    mABDB-&gt;SetCardValue(card, CARD_ATTRIB_PALMID, NS_ConvertASCIItoUTF16(buf).get(), PR_TRUE);</span>
<a href="#l50.42"></a><span id="l50.42"> }</span>
<a href="#l50.43"></a><span id="l50.43"> </span>
<a href="#l50.44"></a><span id="l50.44"> nsresult nsAbPalmHotSync::GetABInterface()</span>
<a href="#l50.45"></a><span id="l50.45"> {</span>
<a href="#l50.46"></a><span id="l50.46">   // Use GetChildNodes() call here.</span>
<a href="#l50.47"></a><span id="l50.47">   nsresult rv;</span>
<a href="#l50.48"></a><span id="l50.48">   nsCOMPtr&lt;nsIAbManager&gt; abManager(do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv));</span>
<a href="#l50.49"></a><span id="l50.49">   if (NS_FAILED(rv))</span>
<a href="#l50.50"></a><span id="l50.50" class="difflineat">@@ -524,17 +522,17 @@ nsresult nsAbPalmHotSync::LoadDeletedCar</span>
<a href="#l50.51"></a><span id="l50.51">             continue;</span>
<a href="#l50.52"></a><span id="l50.52">         </span>
<a href="#l50.53"></a><span id="l50.53">         PRBool isMailingList=PR_FALSE;</span>
<a href="#l50.54"></a><span id="l50.54">         rv = card-&gt;GetIsMailList(&amp;isMailingList);</span>
<a href="#l50.55"></a><span id="l50.55">         if (NS_FAILED(rv) || isMailingList)</span>
<a href="#l50.56"></a><span id="l50.56">             continue;</span>
<a href="#l50.57"></a><span id="l50.57"> </span>
<a href="#l50.58"></a><span id="l50.58">         PRUint32 lastModifiedDate = 0;</span>
<a href="#l50.59"></a><span id="l50.59" class="difflineminus">-        rv = card-&gt;GetLastModifiedDate(&amp;lastModifiedDate);</span>
<a href="#l50.60"></a><span id="l50.60" class="difflineplus">+        rv = card-&gt;GetPropertyAsUint32(kLastModifiedDateProperty, &amp;lastModifiedDate);</span>
<a href="#l50.61"></a><span id="l50.61">         if (NS_FAILED(rv) || !lastModifiedDate)</span>
<a href="#l50.62"></a><span id="l50.62">             continue;</span>
<a href="#l50.63"></a><span id="l50.63"> </span>
<a href="#l50.64"></a><span id="l50.64">         if(lastModifiedDate &gt; mPalmSyncTimeStamp)</span>
<a href="#l50.65"></a><span id="l50.65">         {</span>
<a href="#l50.66"></a><span id="l50.66">             nsAbIPCCard  ipcCard(card);</span>
<a href="#l50.67"></a><span id="l50.67">             // check in the list of Palm records</span>
<a href="#l50.68"></a><span id="l50.68">             for(PRInt32 i=mPalmRecords.Count()-1; i &gt;=0;  i--) </span>
<a href="#l50.69"></a><span id="l50.69" class="difflineat">@@ -580,17 +578,17 @@ nsresult nsAbPalmHotSync::LoadNewModifie</span>
<a href="#l50.70"></a><span id="l50.70">             continue;</span>
<a href="#l50.71"></a><span id="l50.71"> </span>
<a href="#l50.72"></a><span id="l50.72">         PRBool isMailingList=PR_FALSE;</span>
<a href="#l50.73"></a><span id="l50.73">         rv = card-&gt;GetIsMailList(&amp;isMailingList);</span>
<a href="#l50.74"></a><span id="l50.74">         if (NS_FAILED(rv) || isMailingList) // if mailing list go to cards</span>
<a href="#l50.75"></a><span id="l50.75">             continue;</span>
<a href="#l50.76"></a><span id="l50.76"> </span>
<a href="#l50.77"></a><span id="l50.77">         PRUint32 lastModifiedDate = 0;</span>
<a href="#l50.78"></a><span id="l50.78" class="difflineminus">-        rv = card-&gt;GetLastModifiedDate(&amp;lastModifiedDate);</span>
<a href="#l50.79"></a><span id="l50.79" class="difflineplus">+        rv = card-&gt;GetPropertyAsUint32(kLastModifiedDateProperty, &amp;lastModifiedDate);</span>
<a href="#l50.80"></a><span id="l50.80">         if (NS_FAILED(rv))</span>
<a href="#l50.81"></a><span id="l50.81">             continue;</span>
<a href="#l50.82"></a><span id="l50.82"> </span>
<a href="#l50.83"></a><span id="l50.83">         if(lastModifiedDate &gt; mPalmSyncTimeStamp  // take care of modified</span>
<a href="#l50.84"></a><span id="l50.84">             || !lastModifiedDate || !mPalmSyncTimeStamp) </span>
<a href="#l50.85"></a><span id="l50.85">         {  // take care of new or never before sync</span>
<a href="#l50.86"></a><span id="l50.86">             </span>
<a href="#l50.87"></a><span id="l50.87">             //create nsAbIPCCard and assign its status based on lastModifiedDate</span>
<a href="#l50.88"></a><span id="l50.88" class="difflineat">@@ -820,19 +818,18 @@ nsresult nsAbPalmHotSync::UpdateMozABWit</span>
<a href="#l50.89"></a><span id="l50.89">         {</span>
<a href="#l50.90"></a><span id="l50.90">           rv = mABDB-&gt;GetCardFromAttribute(nsnull, CARD_ATTRIB_DISPLAY,</span>
<a href="#l50.91"></a><span id="l50.91"> 					   nsDependentCString((const char *) palmRec-&gt;displayName),</span>
<a href="#l50.92"></a><span id="l50.92"> 					   PR_FALSE, getter_AddRefs(existingCard));</span>
<a href="#l50.93"></a><span id="l50.93">           // if card with this display name exists, just continue; But, we should make sure</span>
<a href="#l50.94"></a><span id="l50.94">           // it's associated with the palm card going forward, so set the palmid.</span>
<a href="#l50.95"></a><span id="l50.95">           if (NS_SUCCEEDED(rv) &amp;&amp; existingCard)</span>
<a href="#l50.96"></a><span id="l50.96">           {</span>
<a href="#l50.97"></a><span id="l50.97" class="difflineminus">-            nsCOMPtr&lt;nsIAbMDBCard&gt; dbCard = do_QueryInterface(existingCard);</span>
<a href="#l50.98"></a><span id="l50.98" class="difflineminus">-</span>
<a href="#l50.99"></a><span id="l50.99" class="difflineminus">-            dbCard-&gt;SetStringAttribute(CARD_ATTRIB_PALMID, NS_ConvertASCIItoUTF16(recordIDBuf).get());</span>
<a href="#l50.100"></a><span id="l50.100" class="difflineplus">+            existingCard-&gt;SetPropertyAsAUTF8String(CARD_ATTRIB_PALMID,</span>
<a href="#l50.101"></a><span id="l50.101" class="difflineplus">+                nsDependentCString(recordIDBuf));</span>
<a href="#l50.102"></a><span id="l50.102">             continue;</span>
<a href="#l50.103"></a><span id="l50.103">           }</span>
<a href="#l50.104"></a><span id="l50.104"> </span>
<a href="#l50.105"></a><span id="l50.105">         }</span>
<a href="#l50.106"></a><span id="l50.106">         if(NS_SUCCEEDED(rv) &amp;&amp; existingCard) </span>
<a href="#l50.107"></a><span id="l50.107">         {</span>
<a href="#l50.108"></a><span id="l50.108">             // Archived is the same as deleted in palm.</span>
<a href="#l50.109"></a><span id="l50.109">             if(palmRec-&gt;dwStatus &amp; ATTR_DELETED || palmRec-&gt;dwStatus &amp; ATTR_ARCHIVED) </span>
<a href="#l50.110"></a><span id="l50.110" class="difflineat">@@ -852,47 +849,40 @@ nsresult nsAbPalmHotSync::UpdateMozABWit</span>
<a href="#l50.111"></a><span id="l50.111">                 {</span>
<a href="#l50.112"></a><span id="l50.112">                     existingCard-&gt;Copy(&amp;ipcCard);</span>
<a href="#l50.113"></a><span id="l50.113">                     rv = mABDB-&gt;EditCard(existingCard, PR_FALSE, nsnull);</span>
<a href="#l50.114"></a><span id="l50.114">                     continue;</span>
<a href="#l50.115"></a><span id="l50.115">                 }</span>
<a href="#l50.116"></a><span id="l50.116">             }</span>
<a href="#l50.117"></a><span id="l50.117">         }</span>
<a href="#l50.118"></a><span id="l50.118"> </span>
<a href="#l50.119"></a><span id="l50.119" class="difflineminus">-        nsCOMPtr&lt;nsIAbMDBCard&gt; dbCard;</span>
<a href="#l50.120"></a><span id="l50.120" class="difflineminus">-        dbCard = do_CreateInstance(NS_ABMDBCARD_CONTRACTID, &amp;rv);</span>
<a href="#l50.121"></a><span id="l50.121" class="difflineplus">+        nsCOMPtr&lt;nsIAbCard&gt; newCard;</span>
<a href="#l50.122"></a><span id="l50.122" class="difflineplus">+        newCard = do_CreateInstance(NS_ABMDBCARD_CONTRACTID, &amp;rv);</span>
<a href="#l50.123"></a><span id="l50.123">         if(NS_FAILED(rv))</span>
<a href="#l50.124"></a><span id="l50.124">             continue;</span>
<a href="#l50.125"></a><span id="l50.125"> </span>
<a href="#l50.126"></a><span id="l50.126" class="difflineminus">-        nsCOMPtr&lt;nsIAbCard&gt; newCard;</span>
<a href="#l50.127"></a><span id="l50.127" class="difflineminus">-        newCard = do_QueryInterface(dbCard, &amp;rv);</span>
<a href="#l50.128"></a><span id="l50.128" class="difflineminus">-        if(NS_FAILED(rv)) </span>
<a href="#l50.129"></a><span id="l50.129" class="difflineminus">-            continue;</span>
<a href="#l50.130"></a><span id="l50.130" class="difflineminus">-</span>
<a href="#l50.131"></a><span id="l50.131">         rv = newCard-&gt;Copy(&amp;ipcCard);</span>
<a href="#l50.132"></a><span id="l50.132">         if(NS_FAILED(rv)) </span>
<a href="#l50.133"></a><span id="l50.133">             continue;</span>
<a href="#l50.134"></a><span id="l50.134"> </span>
<a href="#l50.135"></a><span id="l50.135">         // if the card does not exist</span>
<a href="#l50.136"></a><span id="l50.136">         if((ipcCard.GetStatus() == ATTR_NEW)</span>
<a href="#l50.137"></a><span id="l50.137">             ||(ipcCard.GetStatus() == ATTR_MODIFIED)</span>
<a href="#l50.138"></a><span id="l50.138">             || (ipcCard.GetStatus() == ATTR_NONE)) </span>
<a href="#l50.139"></a><span id="l50.139">         {</span>
<a href="#l50.140"></a><span id="l50.140">             PRUint32 modTimeInSec;</span>
<a href="#l50.141"></a><span id="l50.141">             PRTime2Seconds(PR_Now(), &amp;modTimeInSec);</span>
<a href="#l50.142"></a><span id="l50.142" class="difflineminus">-            ipcCard.SetLastModifiedDate(modTimeInSec);</span>
<a href="#l50.143"></a><span id="l50.143" class="difflineplus">+            ipcCard.SetPropertyAsUint32(kLastModifiedDateProperty, modTimeInSec);</span>
<a href="#l50.144"></a><span id="l50.144">             rv = mABDB-&gt;CreateNewCardAndAddToDB(newCard, PR_FALSE, nsnull);</span>
<a href="#l50.145"></a><span id="l50.145">             if(NS_SUCCEEDED(rv)) </span>
<a href="#l50.146"></a><span id="l50.146">             {</span>
<a href="#l50.147"></a><span id="l50.147">                 // now set the attribute for the PalmRecID in the card in the DB</span>
<a href="#l50.148"></a><span id="l50.148" class="difflineminus">-                dbCard-&gt;SetAbDatabase(mABDB);</span>
<a href="#l50.149"></a><span id="l50.149" class="difflineminus">-                dbCard-&gt;SetStringAttribute(CARD_ATTRIB_PALMID, NS_ConvertASCIItoUTF16(recordIDBuf).get());</span>
<a href="#l50.150"></a><span id="l50.150" class="difflineminus">-                newCard = do_QueryInterface(dbCard, &amp;rv);</span>
<a href="#l50.151"></a><span id="l50.151" class="difflineminus">-                if(NS_SUCCEEDED(rv))</span>
<a href="#l50.152"></a><span id="l50.152" class="difflineminus">-                    rv = mABDB-&gt;EditCard(newCard, PR_FALSE, nsnull);</span>
<a href="#l50.153"></a><span id="l50.153" class="difflineplus">+                newCard-&gt;SetPropertyAsAUTF8String(CARD_ATTRIB_PALMID,</span>
<a href="#l50.154"></a><span id="l50.154" class="difflineplus">+                    nsDependentCString(recordIDBuf));</span>
<a href="#l50.155"></a><span id="l50.155" class="difflineplus">+                rv = mABDB-&gt;EditCard(newCard, PR_FALSE, nsnull);</span>
<a href="#l50.156"></a><span id="l50.156">             }</span>
<a href="#l50.157"></a><span id="l50.157">         }</span>
<a href="#l50.158"></a><span id="l50.158">     }</span>
<a href="#l50.159"></a><span id="l50.159"> </span>
<a href="#l50.160"></a><span id="l50.160">     return rv;</span>
<a href="#l50.161"></a><span id="l50.161"> }</span>
<a href="#l50.162"></a><span id="l50.162"> </span>
<a href="#l50.163"></a><span id="l50.163"> </span>
<a href="#l50.164"></a><span id="l50.164" class="difflineat">@@ -902,25 +892,22 @@ nsresult nsAbPalmHotSync::Done(PRBool aS</span>
<a href="#l50.165"></a><span id="l50.165">         return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l50.166"></a><span id="l50.166"> </span>
<a href="#l50.167"></a><span id="l50.167">     nsresult rv=NS_ERROR_UNEXPECTED;</span>
<a href="#l50.168"></a><span id="l50.168"> </span>
<a href="#l50.169"></a><span id="l50.169">     if(aPalmRecIDListCount == mNewCardCount) </span>
<a href="#l50.170"></a><span id="l50.170">     {</span>
<a href="#l50.171"></a><span id="l50.171">         for(PRUint32 i=0; i&lt;aPalmRecIDListCount; i++) </span>
<a href="#l50.172"></a><span id="l50.172">         {</span>
<a href="#l50.173"></a><span id="l50.173" class="difflineminus">-            nsCOMPtr&lt;nsIAbMDBCard&gt; dbCard;</span>
<a href="#l50.174"></a><span id="l50.174" class="difflineminus">-            rv = mNewCardsArray-&gt;QueryElementAt(i, NS_GET_IID(nsIAbMDBCard), getter_AddRefs(dbCard));</span>
<a href="#l50.175"></a><span id="l50.175" class="difflineminus">-            if(NS_SUCCEEDED(rv) &amp;&amp; dbCard) </span>
<a href="#l50.176"></a><span id="l50.176" class="difflineplus">+            nsCOMPtr&lt;nsIAbCard&gt; newCard;</span>
<a href="#l50.177"></a><span id="l50.177" class="difflineplus">+            rv = mNewCardsArray-&gt;QueryElementAt(i, NS_GET_IID(nsIAbCard), getter_AddRefs(newCard));</span>
<a href="#l50.178"></a><span id="l50.178" class="difflineplus">+            if (NS_SUCCEEDED(rv) &amp;&amp; newCard) </span>
<a href="#l50.179"></a><span id="l50.179">             {</span>
<a href="#l50.180"></a><span id="l50.180" class="difflineminus">-                ConvertAssignPalmIDAttrib(aPalmRecordIDList[i], dbCard);</span>
<a href="#l50.181"></a><span id="l50.181" class="difflineminus">-                nsCOMPtr&lt;nsIAbCard&gt; newCard;</span>
<a href="#l50.182"></a><span id="l50.182" class="difflineminus">-                newCard = do_QueryInterface(dbCard, &amp;rv);</span>
<a href="#l50.183"></a><span id="l50.183" class="difflineminus">-                if(NS_SUCCEEDED(rv))</span>
<a href="#l50.184"></a><span id="l50.184" class="difflineminus">-                    mABDB-&gt;EditCard(newCard, PR_FALSE, nsnull);</span>
<a href="#l50.185"></a><span id="l50.185" class="difflineplus">+                ConvertAssignPalmIDAttrib(aPalmRecordIDList[i], newCard);</span>
<a href="#l50.186"></a><span id="l50.186" class="difflineplus">+                mABDB-&gt;EditCard(newCard, PR_FALSE, nsnull);</span>
<a href="#l50.187"></a><span id="l50.187">             }</span>
<a href="#l50.188"></a><span id="l50.188">         }</span>
<a href="#l50.189"></a><span id="l50.189">     }</span>
<a href="#l50.190"></a><span id="l50.190"> </span>
<a href="#l50.191"></a><span id="l50.191">     if(mABDB &amp;&amp; mDBOpen) </span>
<a href="#l50.192"></a><span id="l50.192">     {</span>
<a href="#l50.193"></a><span id="l50.193">         if(aSuccess) </span>
<a href="#l50.194"></a><span id="l50.194">         {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l51.1"></a><span id="l51.1" class="difflineminus">--- a/mailnews/extensions/palmsync/src/nsAbPalmSync.h</span>
<a href="#l51.2"></a><span id="l51.2" class="difflineplus">+++ b/mailnews/extensions/palmsync/src/nsAbPalmSync.h</span>
<a href="#l51.3"></a><span id="l51.3" class="difflineat">@@ -135,17 +135,17 @@ protected:</span>
<a href="#l51.4"></a><span id="l51.4"> </span>
<a href="#l51.5"></a><span id="l51.5">     // Checks with the corresponding Palm record for any discrepencies</span>
<a href="#l51.6"></a><span id="l51.6">     // if any modification needed, this will return the modified card</span>
<a href="#l51.7"></a><span id="l51.7">     // returns whether card exists (in which case it can be discarded)</span>
<a href="#l51.8"></a><span id="l51.8">     PRBool CardExistsInPalmList(nsAbIPCCard  * aIPCCard);</span>
<a href="#l51.9"></a><span id="l51.9"> </span>
<a href="#l51.10"></a><span id="l51.10">     // utility function</span>
<a href="#l51.11"></a><span id="l51.11">     nsresult AddToListForPalm(nsAbIPCCard &amp; ipcCard);</span>
<a href="#l51.12"></a><span id="l51.12" class="difflineminus">-    void ConvertAssignPalmIDAttrib(PRUint32 id, nsIAbMDBCard * card);</span>
<a href="#l51.13"></a><span id="l51.13" class="difflineplus">+    void ConvertAssignPalmIDAttrib(PRUint32 id, nsIAbCard * card);</span>
<a href="#l51.14"></a><span id="l51.14">     nsresult GetABInterface();</span>
<a href="#l51.15"></a><span id="l51.15">     nsresult UpdateABInfo(PRUint32 modTime, PRInt32 categoryId);</span>
<a href="#l51.16"></a><span id="l51.16">     nsresult ModifyAB(const char * ABUrl, const nsString &amp;aAbName,</span>
<a href="#l51.17"></a><span id="l51.17">                       const PRUint32 aModTime, const PRInt32 aCategoryId);</span>
<a href="#l51.18"></a><span id="l51.18">     nsresult NewAB(const nsString&amp; aAbName);</span>
<a href="#l51.19"></a><span id="l51.19"> </span>
<a href="#l51.20"></a><span id="l51.20"> };</span>
<a href="#l51.21"></a><span id="l51.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l52.1"></a><span id="l52.1" class="difflineminus">--- a/mailnews/import/src/nsImportFieldMap.cpp</span>
<a href="#l52.2"></a><span id="l52.2" class="difflineplus">+++ b/mailnews/import/src/nsImportFieldMap.cpp</span>
<a href="#l52.3"></a><span id="l52.3" class="difflineat">@@ -418,121 +418,123 @@ NS_IMETHODIMP nsImportFieldMap::GetField</span>
<a href="#l52.4"></a><span id="l52.4">     break;</span>
<a href="#l52.5"></a><span id="l52.5">   case 1:</span>
<a href="#l52.6"></a><span id="l52.6">     rv = card-&gt;GetLastName(value);</span>
<a href="#l52.7"></a><span id="l52.7">     break;</span>
<a href="#l52.8"></a><span id="l52.8">   case 2:</span>
<a href="#l52.9"></a><span id="l52.9">     rv = card-&gt;GetDisplayName(value);</span>
<a href="#l52.10"></a><span id="l52.10">     break;</span>
<a href="#l52.11"></a><span id="l52.11">   case 3:</span>
<a href="#l52.12"></a><span id="l52.12" class="difflineminus">-    rv = card-&gt;GetNickName(value);</span>
<a href="#l52.13"></a><span id="l52.13" class="difflineplus">+    rv = card-&gt;GetPropertyAsAString(kNicknameProperty, value);</span>
<a href="#l52.14"></a><span id="l52.14">     break;</span>
<a href="#l52.15"></a><span id="l52.15">   case 4:</span>
<a href="#l52.16"></a><span id="l52.16">     rv = card-&gt;GetPrimaryEmail(value);</span>
<a href="#l52.17"></a><span id="l52.17">     break;</span>
<a href="#l52.18"></a><span id="l52.18">   case 5:</span>
<a href="#l52.19"></a><span id="l52.19" class="difflineminus">-    rv = card-&gt;GetSecondEmail(value);</span>
<a href="#l52.20"></a><span id="l52.20" class="difflineplus">+    rv = card-&gt;GetPropertyAsAString(k2ndEmailProperty, value);</span>
<a href="#l52.21"></a><span id="l52.21">     break;</span>
<a href="#l52.22"></a><span id="l52.22">   case 6:</span>
<a href="#l52.23"></a><span id="l52.23" class="difflineminus">-    rv = card-&gt;GetWorkPhone(value);</span>
<a href="#l52.24"></a><span id="l52.24" class="difflineplus">+    rv = card-&gt;GetPropertyAsAString(kWorkPhoneProperty, value);</span>
<a href="#l52.25"></a><span id="l52.25">     break;</span>
<a href="#l52.26"></a><span id="l52.26">   case 7:</span>
<a href="#l52.27"></a><span id="l52.27" class="difflineminus">-    rv = card-&gt;GetHomePhone(value);</span>
<a href="#l52.28"></a><span id="l52.28" class="difflineplus">+    rv = card-&gt;GetPropertyAsAString(kHomePhoneProperty, value);</span>
<a href="#l52.29"></a><span id="l52.29">     break;</span>
<a href="#l52.30"></a><span id="l52.30">   case 8:</span>
<a href="#l52.31"></a><span id="l52.31" class="difflineminus">-    rv = card-&gt;GetFaxNumber(value);</span>
<a href="#l52.32"></a><span id="l52.32" class="difflineplus">+    rv = card-&gt;GetPropertyAsAString(kFaxProperty, value);</span>
<a href="#l52.33"></a><span id="l52.33">     break;</span>
<a href="#l52.34"></a><span id="l52.34">   case 9:</span>
<a href="#l52.35"></a><span id="l52.35" class="difflineminus">-    rv = card-&gt;GetPagerNumber(value);</span>
<a href="#l52.36"></a><span id="l52.36" class="difflineplus">+    rv = card-&gt;GetPropertyAsAString(kPagerProperty, value);</span>
<a href="#l52.37"></a><span id="l52.37">     break;</span>
<a href="#l52.38"></a><span id="l52.38">   case 10:</span>
<a href="#l52.39"></a><span id="l52.39" class="difflineminus">-    rv = card-&gt;GetCellularNumber(value);</span>
<a href="#l52.40"></a><span id="l52.40" class="difflineplus">+    rv = card-&gt;GetPropertyAsAString(kCellularProperty, value);</span>
<a href="#l52.41"></a><span id="l52.41">     break;</span>
<a href="#l52.42"></a><span id="l52.42">   case 11:</span>
<a href="#l52.43"></a><span id="l52.43" class="difflineminus">-    rv = card-&gt;GetHomeAddress(value);</span>
<a href="#l52.44"></a><span id="l52.44" class="difflineplus">+    rv = card-&gt;GetPropertyAsAString(kHomeAddressProperty, value);</span>
<a href="#l52.45"></a><span id="l52.45">     break;</span>
<a href="#l52.46"></a><span id="l52.46">   case 12:</span>
<a href="#l52.47"></a><span id="l52.47" class="difflineminus">-    rv = card-&gt;GetHomeAddress2(value);</span>
<a href="#l52.48"></a><span id="l52.48" class="difflineplus">+    rv = card-&gt;GetPropertyAsAString(kHomeAddress2Property, value);</span>
<a href="#l52.49"></a><span id="l52.49">     break;</span>
<a href="#l52.50"></a><span id="l52.50">   case 13:</span>
<a href="#l52.51"></a><span id="l52.51" class="difflineminus">-    rv = card-&gt;GetHomeCity(value);</span>
<a href="#l52.52"></a><span id="l52.52" class="difflineplus">+    rv = card-&gt;GetPropertyAsAString(kHomeCityProperty, value);</span>
<a href="#l52.53"></a><span id="l52.53">     break;</span>
<a href="#l52.54"></a><span id="l52.54">   case 14:</span>
<a href="#l52.55"></a><span id="l52.55" class="difflineminus">-    rv = card-&gt;GetHomeState(value);</span>
<a href="#l52.56"></a><span id="l52.56" class="difflineplus">+    rv = card-&gt;GetPropertyAsAString(kHomeStateProperty, value);</span>
<a href="#l52.57"></a><span id="l52.57">     break;</span>
<a href="#l52.58"></a><span id="l52.58">   case 15:</span>
<a href="#l52.59"></a><span id="l52.59" class="difflineminus">-    rv = card-&gt;GetHomeZipCode(value);</span>
<a href="#l52.60"></a><span id="l52.60" class="difflineplus">+    rv = card-&gt;GetPropertyAsAString(kHomeZipCodeProperty, value);</span>
<a href="#l52.61"></a><span id="l52.61">     break;</span>
<a href="#l52.62"></a><span id="l52.62">   case 16:</span>
<a href="#l52.63"></a><span id="l52.63" class="difflineminus">-    rv = card-&gt;GetHomeCountry(value);</span>
<a href="#l52.64"></a><span id="l52.64" class="difflineplus">+    rv = card-&gt;GetPropertyAsAString(kHomeCountryProperty, value);</span>
<a href="#l52.65"></a><span id="l52.65">     break;</span>
<a href="#l52.66"></a><span id="l52.66">   case 17:</span>
<a href="#l52.67"></a><span id="l52.67" class="difflineminus">-    rv = card-&gt;GetWorkAddress(value);</span>
<a href="#l52.68"></a><span id="l52.68" class="difflineplus">+    rv = card-&gt;GetPropertyAsAString(kWorkAddressProperty, value);</span>
<a href="#l52.69"></a><span id="l52.69">     break;</span>
<a href="#l52.70"></a><span id="l52.70">   case 18:</span>
<a href="#l52.71"></a><span id="l52.71" class="difflineminus">-    rv = card-&gt;GetWorkAddress2(value);</span>
<a href="#l52.72"></a><span id="l52.72" class="difflineplus">+    rv = card-&gt;GetPropertyAsAString(kWorkAddress2Property, value);</span>
<a href="#l52.73"></a><span id="l52.73">     break;</span>
<a href="#l52.74"></a><span id="l52.74">   case 19:</span>
<a href="#l52.75"></a><span id="l52.75" class="difflineminus">-    rv = card-&gt;GetWorkCity(value);</span>
<a href="#l52.76"></a><span id="l52.76" class="difflineplus">+    rv = card-&gt;GetPropertyAsAString(kWorkCityProperty, value);</span>
<a href="#l52.77"></a><span id="l52.77">     break;</span>
<a href="#l52.78"></a><span id="l52.78">   case 20:</span>
<a href="#l52.79"></a><span id="l52.79" class="difflineminus">-    rv = card-&gt;GetWorkState(value);</span>
<a href="#l52.80"></a><span id="l52.80" class="difflineplus">+    rv = card-&gt;GetPropertyAsAString(kWorkStateProperty, value);</span>
<a href="#l52.81"></a><span id="l52.81">     break;</span>
<a href="#l52.82"></a><span id="l52.82">   case 21:</span>
<a href="#l52.83"></a><span id="l52.83" class="difflineminus">-    rv = card-&gt;GetWorkZipCode(value);</span>
<a href="#l52.84"></a><span id="l52.84" class="difflineplus">+    rv = card-&gt;GetPropertyAsAString(kWorkZipCodeProperty, value);</span>
<a href="#l52.85"></a><span id="l52.85">     break;</span>
<a href="#l52.86"></a><span id="l52.86">   case 22:</span>
<a href="#l52.87"></a><span id="l52.87" class="difflineminus">-    rv = card-&gt;GetWorkCountry(value);</span>
<a href="#l52.88"></a><span id="l52.88" class="difflineplus">+    rv = card-&gt;GetPropertyAsAString(kWorkCountryProperty, value);</span>
<a href="#l52.89"></a><span id="l52.89">     break;</span>
<a href="#l52.90"></a><span id="l52.90">   case 23:</span>
<a href="#l52.91"></a><span id="l52.91" class="difflineminus">-    rv = card-&gt;GetJobTitle(value);</span>
<a href="#l52.92"></a><span id="l52.92" class="difflineplus">+    rv = card-&gt;GetPropertyAsAString(kJobTitleProperty, value);</span>
<a href="#l52.93"></a><span id="l52.93">     break;</span>
<a href="#l52.94"></a><span id="l52.94">   case 24:</span>
<a href="#l52.95"></a><span id="l52.95" class="difflineminus">-    rv = card-&gt;GetDepartment(value);</span>
<a href="#l52.96"></a><span id="l52.96" class="difflineplus">+    rv = card-&gt;GetPropertyAsAString(kDepartmentProperty, value);</span>
<a href="#l52.97"></a><span id="l52.97">     break;</span>
<a href="#l52.98"></a><span id="l52.98">   case 25:</span>
<a href="#l52.99"></a><span id="l52.99" class="difflineminus">-    rv = card-&gt;GetCompany(value);</span>
<a href="#l52.100"></a><span id="l52.100" class="difflineplus">+    rv = card-&gt;GetPropertyAsAString(kCompanyProperty, value);</span>
<a href="#l52.101"></a><span id="l52.101">     break;</span>
<a href="#l52.102"></a><span id="l52.102">   case 26:</span>
<a href="#l52.103"></a><span id="l52.103" class="difflineminus">-    rv = card-&gt;GetWebPage1(value);</span>
<a href="#l52.104"></a><span id="l52.104" class="difflineplus">+    rv = card-&gt;GetPropertyAsAString(kWorkWebPageProperty, value);</span>
<a href="#l52.105"></a><span id="l52.105">     break;</span>
<a href="#l52.106"></a><span id="l52.106">   case 27:</span>
<a href="#l52.107"></a><span id="l52.107" class="difflineminus">-    rv = card-&gt;GetWebPage2(value);</span>
<a href="#l52.108"></a><span id="l52.108" class="difflineplus">+    rv = card-&gt;GetPropertyAsAString(kHomeWebPageProperty, value);</span>
<a href="#l52.109"></a><span id="l52.109">     break;</span>
<a href="#l52.110"></a><span id="l52.110">   case 28:</span>
<a href="#l52.111"></a><span id="l52.111" class="difflineminus">-    rv = card-&gt;GetBirthYear(value);</span>
<a href="#l52.112"></a><span id="l52.112" class="difflineplus">+    rv = card-&gt;GetPropertyAsAString(kBirthYearProperty, value);</span>
<a href="#l52.113"></a><span id="l52.113">     break;</span>
<a href="#l52.114"></a><span id="l52.114">   case 29:</span>
<a href="#l52.115"></a><span id="l52.115" class="difflineminus">-    rv = card-&gt;GetBirthMonth(value);</span>
<a href="#l52.116"></a><span id="l52.116" class="difflineplus">+    rv = card-&gt;GetPropertyAsAString(kBirthMonthProperty, value);</span>
<a href="#l52.117"></a><span id="l52.117">     break;</span>
<a href="#l52.118"></a><span id="l52.118">   case 30:</span>
<a href="#l52.119"></a><span id="l52.119" class="difflineminus">-    rv = card-&gt;GetBirthDay(value);</span>
<a href="#l52.120"></a><span id="l52.120" class="difflineplus">+    rv = card-&gt;GetPropertyAsAString(kBirthDayProperty, value);</span>
<a href="#l52.121"></a><span id="l52.121">     break;</span>
<a href="#l52.122"></a><span id="l52.122">   case 31:</span>
<a href="#l52.123"></a><span id="l52.123" class="difflineminus">-    rv = card-&gt;GetCustom1(value);</span>
<a href="#l52.124"></a><span id="l52.124" class="difflineplus">+    rv = card-&gt;GetPropertyAsAString(kCustom1Property, value);</span>
<a href="#l52.125"></a><span id="l52.125">     break;</span>
<a href="#l52.126"></a><span id="l52.126">   case 32:</span>
<a href="#l52.127"></a><span id="l52.127" class="difflineminus">-    rv = card-&gt;GetCustom2(value);</span>
<a href="#l52.128"></a><span id="l52.128" class="difflineplus">+    rv = card-&gt;GetPropertyAsAString(kCustom2Property, value);</span>
<a href="#l52.129"></a><span id="l52.129">     break;</span>
<a href="#l52.130"></a><span id="l52.130">   case 33:</span>
<a href="#l52.131"></a><span id="l52.131" class="difflineminus">-    rv = card-&gt;GetCustom3(value);</span>
<a href="#l52.132"></a><span id="l52.132" class="difflineplus">+    rv = card-&gt;GetPropertyAsAString(kCustom3Property, value);</span>
<a href="#l52.133"></a><span id="l52.133">     break;</span>
<a href="#l52.134"></a><span id="l52.134">   case 34:</span>
<a href="#l52.135"></a><span id="l52.135" class="difflineminus">-    rv = card-&gt;GetCustom4(value);</span>
<a href="#l52.136"></a><span id="l52.136" class="difflineplus">+    rv = card-&gt;GetPropertyAsAString(kCustom4Property, value);</span>
<a href="#l52.137"></a><span id="l52.137">     break;</span>
<a href="#l52.138"></a><span id="l52.138">   case 35:</span>
<a href="#l52.139"></a><span id="l52.139" class="difflineminus">-    rv = card-&gt;GetNotes(value);</span>
<a href="#l52.140"></a><span id="l52.140" class="difflineplus">+    rv = card-&gt;GetPropertyAsAString(kNotesProperty, value);</span>
<a href="#l52.141"></a><span id="l52.141">     break;</span>
<a href="#l52.142"></a><span id="l52.142">   default:</span>
<a href="#l52.143"></a><span id="l52.143">     /* Get the field description, and add it as an anonymous attr? */</span>
<a href="#l52.144"></a><span id="l52.144">     /* OR WHAT???? */</span>
<a href="#l52.145"></a><span id="l52.145">     {</span>
<a href="#l52.146"></a><span id="l52.146">       rv = NS_ERROR_FAILURE;</span>
<a href="#l52.147"></a><span id="l52.147">     }</span>
<a href="#l52.148"></a><span id="l52.148">   }</span>
<a href="#l52.149"></a><span id="l52.149" class="difflineplus">+  if (rv == NS_ERROR_NOT_AVAILABLE)</span>
<a href="#l52.150"></a><span id="l52.150" class="difflineplus">+    value = EmptyString();</span>
<a href="#l52.151"></a><span id="l52.151"> </span>
<a href="#l52.152"></a><span id="l52.152">   *_retval = ToNewUnicode(value);</span>
<a href="#l52.153"></a><span id="l52.153"> </span>
<a href="#l52.154"></a><span id="l52.154">   return rv;</span>
<a href="#l52.155"></a><span id="l52.155"> }</span>
<a href="#l52.156"></a><span id="l52.156"> </span>
<a href="#l52.157"></a><span id="l52.157"> NS_IMETHODIMP nsImportFieldMap::GetFieldValueByDescription(nsIAbCard *card, const PRUnichar *fieldDesc, PRUnichar **_retval)</span>
<a href="#l52.158"></a><span id="l52.158"> {</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

