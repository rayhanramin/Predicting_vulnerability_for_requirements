<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 20685:270d1fada781a7e1614e0317adb9576726b88f2e</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 270d1fada781a7e1614e0317adb9576726b88f2e" />
<meta property="og:url" content="/comm-central/rev/270d1fada781a7e1614e0317adb9576726b88f2e" />
<meta property="og:description" content="Bug 1316909 - Replace 0's with nullptr to work with nsCOMPtr again. r=aleth" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 270d1fada781a7e1614e0317adb9576726b88f2e 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/270d1fada781a7e1614e0317adb9576726b88f2e">shortlog</a> |
<a href="/comm-central/log/270d1fada781a7e1614e0317adb9576726b88f2e">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/270d1fada781a7e1614e0317adb9576726b88f2e">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/270d1fada781a7e1614e0317adb9576726b88f2e">files</a> |
changeset |
<a href="/comm-central/raw-rev/270d1fada781a7e1614e0317adb9576726b88f2e">raw</a>  | <a href="/comm-central/archive/270d1fada781a7e1614e0317adb9576726b88f2e.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1316909">Bug 1316909</a> - Replace 0's with nullptr to work with nsCOMPtr again. r=aleth
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#82;&#105;&#99;&#104;&#97;&#114;&#100;&#32;&#77;&#97;&#114;&#116;&#105;&#32;&#60;&#114;&#105;&#99;&#104;&#97;&#114;&#100;&#46;&#109;&#97;&#114;&#116;&#105;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 11 Nov 2016 19:12:07 +0100</td></tr>

<tr>
 <td>changeset 20685</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/270d1fada781a7e1614e0317adb9576726b88f2e">270d1fada781a7e1614e0317adb9576726b88f2e</a></td>
</tr>



<tr>
<td>parent 20684</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/6bbafc1273eed73e3ef6192416d7eaf343a2ebb6">6bbafc1273eed73e3ef6192416d7eaf343a2ebb6</a>
</td>
</tr>

<tr>
<td>child 20686</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/3bbc1b01ea13a5b280e635d0c3109e35bbc7aa46">3bbc1b01ea13a5b280e635d0c3109e35bbc7aa46</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=270d1fada781a7e1614e0317adb9576726b88f2e">12516</a></td></tr>
<tr><td>push user</td><td>richard.marti@gmail.com</td></tr>
<tr><td>push date</td><td class="date age">Fri, 11 Nov 2016 18:12:29 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@270d1fada781 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=270d1fada781a7e1614e0317adb9576726b88f2e">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=270d1fada781a7e1614e0317adb9576726b88f2e&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=270d1fada781a7e1614e0317adb9576726b88f2e&newProject=comm-central&newRevision=270d1fada781a7e1614e0317adb9576726b88f2e&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=270d1fada781a7e1614e0317adb9576726b88f2e&newProject=comm-central&newRevision=270d1fada781a7e1614e0317adb9576726b88f2e&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=270d1fada781a7e1614e0317adb9576726b88f2e&newProject=comm-central&newRevision=270d1fada781a7e1614e0317adb9576726b88f2e&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28aleth%29&revcount=50">aleth</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1316909">1316909</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1316909">Bug 1316909</a> - Replace 0's with nullptr to work with nsCOMPtr again. r=aleth</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/270d1fada781a7e1614e0317adb9576726b88f2e/ldap/xpcom/src/nsLDAPConnection.cpp">ldap/xpcom/src/nsLDAPConnection.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/270d1fada781a7e1614e0317adb9576726b88f2e/ldap/xpcom/src/nsLDAPConnection.cpp">file</a> |
<a href="/comm-central/annotate/270d1fada781a7e1614e0317adb9576726b88f2e/ldap/xpcom/src/nsLDAPConnection.cpp">annotate</a> |
<a href="/comm-central/diff/270d1fada781a7e1614e0317adb9576726b88f2e/ldap/xpcom/src/nsLDAPConnection.cpp">diff</a> |
<a href="/comm-central/comparison/270d1fada781a7e1614e0317adb9576726b88f2e/ldap/xpcom/src/nsLDAPConnection.cpp">comparison</a> |
<a href="/comm-central/log/270d1fada781a7e1614e0317adb9576726b88f2e/ldap/xpcom/src/nsLDAPConnection.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/270d1fada781a7e1614e0317adb9576726b88f2e/ldap/xpcom/src/nsLDAPService.cpp">ldap/xpcom/src/nsLDAPService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/270d1fada781a7e1614e0317adb9576726b88f2e/ldap/xpcom/src/nsLDAPService.cpp">file</a> |
<a href="/comm-central/annotate/270d1fada781a7e1614e0317adb9576726b88f2e/ldap/xpcom/src/nsLDAPService.cpp">annotate</a> |
<a href="/comm-central/diff/270d1fada781a7e1614e0317adb9576726b88f2e/ldap/xpcom/src/nsLDAPService.cpp">diff</a> |
<a href="/comm-central/comparison/270d1fada781a7e1614e0317adb9576726b88f2e/ldap/xpcom/src/nsLDAPService.cpp">comparison</a> |
<a href="/comm-central/log/270d1fada781a7e1614e0317adb9576726b88f2e/ldap/xpcom/src/nsLDAPService.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/270d1fada781a7e1614e0317adb9576726b88f2e/ldap/xpcom/src/nsLDAPSyncQuery.cpp">ldap/xpcom/src/nsLDAPSyncQuery.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/270d1fada781a7e1614e0317adb9576726b88f2e/ldap/xpcom/src/nsLDAPSyncQuery.cpp">file</a> |
<a href="/comm-central/annotate/270d1fada781a7e1614e0317adb9576726b88f2e/ldap/xpcom/src/nsLDAPSyncQuery.cpp">annotate</a> |
<a href="/comm-central/diff/270d1fada781a7e1614e0317adb9576726b88f2e/ldap/xpcom/src/nsLDAPSyncQuery.cpp">diff</a> |
<a href="/comm-central/comparison/270d1fada781a7e1614e0317adb9576726b88f2e/ldap/xpcom/src/nsLDAPSyncQuery.cpp">comparison</a> |
<a href="/comm-central/log/270d1fada781a7e1614e0317adb9576726b88f2e/ldap/xpcom/src/nsLDAPSyncQuery.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/270d1fada781a7e1614e0317adb9576726b88f2e/mailnews/addrbook/src/nsAbLDAPListenerBase.cpp">mailnews/addrbook/src/nsAbLDAPListenerBase.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/270d1fada781a7e1614e0317adb9576726b88f2e/mailnews/addrbook/src/nsAbLDAPListenerBase.cpp">file</a> |
<a href="/comm-central/annotate/270d1fada781a7e1614e0317adb9576726b88f2e/mailnews/addrbook/src/nsAbLDAPListenerBase.cpp">annotate</a> |
<a href="/comm-central/diff/270d1fada781a7e1614e0317adb9576726b88f2e/mailnews/addrbook/src/nsAbLDAPListenerBase.cpp">diff</a> |
<a href="/comm-central/comparison/270d1fada781a7e1614e0317adb9576726b88f2e/mailnews/addrbook/src/nsAbLDAPListenerBase.cpp">comparison</a> |
<a href="/comm-central/log/270d1fada781a7e1614e0317adb9576726b88f2e/mailnews/addrbook/src/nsAbLDAPListenerBase.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/270d1fada781a7e1614e0317adb9576726b88f2e/mailnews/base/util/nsMsgIncomingServer.cpp">mailnews/base/util/nsMsgIncomingServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/270d1fada781a7e1614e0317adb9576726b88f2e/mailnews/base/util/nsMsgIncomingServer.cpp">file</a> |
<a href="/comm-central/annotate/270d1fada781a7e1614e0317adb9576726b88f2e/mailnews/base/util/nsMsgIncomingServer.cpp">annotate</a> |
<a href="/comm-central/diff/270d1fada781a7e1614e0317adb9576726b88f2e/mailnews/base/util/nsMsgIncomingServer.cpp">diff</a> |
<a href="/comm-central/comparison/270d1fada781a7e1614e0317adb9576726b88f2e/mailnews/base/util/nsMsgIncomingServer.cpp">comparison</a> |
<a href="/comm-central/log/270d1fada781a7e1614e0317adb9576726b88f2e/mailnews/base/util/nsMsgIncomingServer.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/270d1fada781a7e1614e0317adb9576726b88f2e/mailnews/base/util/nsMsgProtocol.cpp">mailnews/base/util/nsMsgProtocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/270d1fada781a7e1614e0317adb9576726b88f2e/mailnews/base/util/nsMsgProtocol.cpp">file</a> |
<a href="/comm-central/annotate/270d1fada781a7e1614e0317adb9576726b88f2e/mailnews/base/util/nsMsgProtocol.cpp">annotate</a> |
<a href="/comm-central/diff/270d1fada781a7e1614e0317adb9576726b88f2e/mailnews/base/util/nsMsgProtocol.cpp">diff</a> |
<a href="/comm-central/comparison/270d1fada781a7e1614e0317adb9576726b88f2e/mailnews/base/util/nsMsgProtocol.cpp">comparison</a> |
<a href="/comm-central/log/270d1fada781a7e1614e0317adb9576726b88f2e/mailnews/base/util/nsMsgProtocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/270d1fada781a7e1614e0317adb9576726b88f2e/mailnews/compose/src/nsMsgSend.cpp">mailnews/compose/src/nsMsgSend.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/270d1fada781a7e1614e0317adb9576726b88f2e/mailnews/compose/src/nsMsgSend.cpp">file</a> |
<a href="/comm-central/annotate/270d1fada781a7e1614e0317adb9576726b88f2e/mailnews/compose/src/nsMsgSend.cpp">annotate</a> |
<a href="/comm-central/diff/270d1fada781a7e1614e0317adb9576726b88f2e/mailnews/compose/src/nsMsgSend.cpp">diff</a> |
<a href="/comm-central/comparison/270d1fada781a7e1614e0317adb9576726b88f2e/mailnews/compose/src/nsMsgSend.cpp">comparison</a> |
<a href="/comm-central/log/270d1fada781a7e1614e0317adb9576726b88f2e/mailnews/compose/src/nsMsgSend.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/270d1fada781a7e1614e0317adb9576726b88f2e/mailnews/extensions/smime/src/nsMsgComposeSecure.cpp">mailnews/extensions/smime/src/nsMsgComposeSecure.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/270d1fada781a7e1614e0317adb9576726b88f2e/mailnews/extensions/smime/src/nsMsgComposeSecure.cpp">file</a> |
<a href="/comm-central/annotate/270d1fada781a7e1614e0317adb9576726b88f2e/mailnews/extensions/smime/src/nsMsgComposeSecure.cpp">annotate</a> |
<a href="/comm-central/diff/270d1fada781a7e1614e0317adb9576726b88f2e/mailnews/extensions/smime/src/nsMsgComposeSecure.cpp">diff</a> |
<a href="/comm-central/comparison/270d1fada781a7e1614e0317adb9576726b88f2e/mailnews/extensions/smime/src/nsMsgComposeSecure.cpp">comparison</a> |
<a href="/comm-central/log/270d1fada781a7e1614e0317adb9576726b88f2e/mailnews/extensions/smime/src/nsMsgComposeSecure.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/270d1fada781a7e1614e0317adb9576726b88f2e/mailnews/local/src/nsMailboxProtocol.cpp">mailnews/local/src/nsMailboxProtocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/270d1fada781a7e1614e0317adb9576726b88f2e/mailnews/local/src/nsMailboxProtocol.cpp">file</a> |
<a href="/comm-central/annotate/270d1fada781a7e1614e0317adb9576726b88f2e/mailnews/local/src/nsMailboxProtocol.cpp">annotate</a> |
<a href="/comm-central/diff/270d1fada781a7e1614e0317adb9576726b88f2e/mailnews/local/src/nsMailboxProtocol.cpp">diff</a> |
<a href="/comm-central/comparison/270d1fada781a7e1614e0317adb9576726b88f2e/mailnews/local/src/nsMailboxProtocol.cpp">comparison</a> |
<a href="/comm-central/log/270d1fada781a7e1614e0317adb9576726b88f2e/mailnews/local/src/nsMailboxProtocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/270d1fada781a7e1614e0317adb9576726b88f2e/mailnews/local/src/nsPop3Sink.cpp">mailnews/local/src/nsPop3Sink.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/270d1fada781a7e1614e0317adb9576726b88f2e/mailnews/local/src/nsPop3Sink.cpp">file</a> |
<a href="/comm-central/annotate/270d1fada781a7e1614e0317adb9576726b88f2e/mailnews/local/src/nsPop3Sink.cpp">annotate</a> |
<a href="/comm-central/diff/270d1fada781a7e1614e0317adb9576726b88f2e/mailnews/local/src/nsPop3Sink.cpp">diff</a> |
<a href="/comm-central/comparison/270d1fada781a7e1614e0317adb9576726b88f2e/mailnews/local/src/nsPop3Sink.cpp">comparison</a> |
<a href="/comm-central/log/270d1fada781a7e1614e0317adb9576726b88f2e/mailnews/local/src/nsPop3Sink.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/270d1fada781a7e1614e0317adb9576726b88f2e/mailnews/mime/src/mimecms.cpp">mailnews/mime/src/mimecms.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/270d1fada781a7e1614e0317adb9576726b88f2e/mailnews/mime/src/mimecms.cpp">file</a> |
<a href="/comm-central/annotate/270d1fada781a7e1614e0317adb9576726b88f2e/mailnews/mime/src/mimecms.cpp">annotate</a> |
<a href="/comm-central/diff/270d1fada781a7e1614e0317adb9576726b88f2e/mailnews/mime/src/mimecms.cpp">diff</a> |
<a href="/comm-central/comparison/270d1fada781a7e1614e0317adb9576726b88f2e/mailnews/mime/src/mimecms.cpp">comparison</a> |
<a href="/comm-central/log/270d1fada781a7e1614e0317adb9576726b88f2e/mailnews/mime/src/mimecms.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/270d1fada781a7e1614e0317adb9576726b88f2e/mailnews/mime/src/mimemcms.cpp">mailnews/mime/src/mimemcms.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/270d1fada781a7e1614e0317adb9576726b88f2e/mailnews/mime/src/mimemcms.cpp">file</a> |
<a href="/comm-central/annotate/270d1fada781a7e1614e0317adb9576726b88f2e/mailnews/mime/src/mimemcms.cpp">annotate</a> |
<a href="/comm-central/diff/270d1fada781a7e1614e0317adb9576726b88f2e/mailnews/mime/src/mimemcms.cpp">diff</a> |
<a href="/comm-central/comparison/270d1fada781a7e1614e0317adb9576726b88f2e/mailnews/mime/src/mimemcms.cpp">comparison</a> |
<a href="/comm-central/log/270d1fada781a7e1614e0317adb9576726b88f2e/mailnews/mime/src/mimemcms.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/270d1fada781a7e1614e0317adb9576726b88f2e/mailnews/mime/src/mimemoz2.cpp">mailnews/mime/src/mimemoz2.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/270d1fada781a7e1614e0317adb9576726b88f2e/mailnews/mime/src/mimemoz2.cpp">file</a> |
<a href="/comm-central/annotate/270d1fada781a7e1614e0317adb9576726b88f2e/mailnews/mime/src/mimemoz2.cpp">annotate</a> |
<a href="/comm-central/diff/270d1fada781a7e1614e0317adb9576726b88f2e/mailnews/mime/src/mimemoz2.cpp">diff</a> |
<a href="/comm-central/comparison/270d1fada781a7e1614e0317adb9576726b88f2e/mailnews/mime/src/mimemoz2.cpp">comparison</a> |
<a href="/comm-central/log/270d1fada781a7e1614e0317adb9576726b88f2e/mailnews/mime/src/mimemoz2.cpp">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/ldap/xpcom/src/nsLDAPConnection.cpp</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/ldap/xpcom/src/nsLDAPConnection.cpp</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -31,22 +31,22 @@</span>
<a href="#l1.4"></a><span id="l1.4"> </span>
<a href="#l1.5"></a><span id="l1.5"> using namespace mozilla;</span>
<a href="#l1.6"></a><span id="l1.6"> </span>
<a href="#l1.7"></a><span id="l1.7"> const char kDNSServiceContractId[] = &quot;@mozilla.org/network/dns-service;1&quot;;</span>
<a href="#l1.8"></a><span id="l1.8"> </span>
<a href="#l1.9"></a><span id="l1.9"> // constructor</span>
<a href="#l1.10"></a><span id="l1.10"> //</span>
<a href="#l1.11"></a><span id="l1.11"> nsLDAPConnection::nsLDAPConnection()</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-    : mConnectionHandle(0),</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+    : mConnectionHandle(nullptr),</span>
<a href="#l1.14"></a><span id="l1.14">       mPendingOperationsMutex(&quot;nsLDAPConnection.mPendingOperationsMutex&quot;),</span>
<a href="#l1.15"></a><span id="l1.15">       mPendingOperations(10),</span>
<a href="#l1.16"></a><span id="l1.16">       mSSL(false),</span>
<a href="#l1.17"></a><span id="l1.17">       mVersion(nsILDAPConnection::VERSION3),</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineminus">-      mDNSRequest(0)</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+      mDNSRequest(nullptr)</span>
<a href="#l1.20"></a><span id="l1.20"> {</span>
<a href="#l1.21"></a><span id="l1.21"> }</span>
<a href="#l1.22"></a><span id="l1.22"> </span>
<a href="#l1.23"></a><span id="l1.23"> // destructor</span>
<a href="#l1.24"></a><span id="l1.24"> //</span>
<a href="#l1.25"></a><span id="l1.25"> nsLDAPConnection::~nsLDAPConnection()</span>
<a href="#l1.26"></a><span id="l1.26"> {</span>
<a href="#l1.27"></a><span id="l1.27">   nsCOMPtr&lt;nsIObserverService&gt; obsServ =</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineat">@@ -200,19 +200,19 @@ nsLDAPConnection::Close()</span>
<a href="#l1.29"></a><span id="l1.29">   NS_ASSERTION(!mThread || NS_SUCCEEDED(mThread-&gt;Shutdown()),</span>
<a href="#l1.30"></a><span id="l1.30">                &quot;Failed to shutdown thread cleanly&quot;);</span>
<a href="#l1.31"></a><span id="l1.31"> </span>
<a href="#l1.32"></a><span id="l1.32">   // Cancel the DNS lookup if needed, and also drop the reference to the</span>
<a href="#l1.33"></a><span id="l1.33">   // Init listener (if still there).</span>
<a href="#l1.34"></a><span id="l1.34">   //</span>
<a href="#l1.35"></a><span id="l1.35">   if (mDNSRequest) {</span>
<a href="#l1.36"></a><span id="l1.36">       mDNSRequest-&gt;Cancel(NS_ERROR_ABORT);</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineminus">-      mDNSRequest = 0;</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineplus">+      mDNSRequest = nullptr;</span>
<a href="#l1.39"></a><span id="l1.39">   }</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineminus">-  mInitListener = 0;</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineplus">+  mInitListener = nullptr;</span>
<a href="#l1.42"></a><span id="l1.42"> </span>
<a href="#l1.43"></a><span id="l1.43"> }</span>
<a href="#l1.44"></a><span id="l1.44"> </span>
<a href="#l1.45"></a><span id="l1.45"> NS_IMETHODIMP</span>
<a href="#l1.46"></a><span id="l1.46"> nsLDAPConnection::Observe(nsISupports *aSubject, const char *aTopic,</span>
<a href="#l1.47"></a><span id="l1.47">                           const char16_t *aData)</span>
<a href="#l1.48"></a><span id="l1.48"> {</span>
<a href="#l1.49"></a><span id="l1.49">   if (!strcmp(aTopic, &quot;profile-change-net-teardown&quot;)) {</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineat">@@ -584,23 +584,23 @@ nsLDAPConnection::OnLookupComplete(nsICa</span>
<a href="#l1.51"></a><span id="l1.51">                 }</span>
<a href="#l1.52"></a><span id="l1.52">             }</span>
<a href="#l1.53"></a><span id="l1.53">         }</span>
<a href="#l1.54"></a><span id="l1.54">     }</span>
<a href="#l1.55"></a><span id="l1.55"> </span>
<a href="#l1.56"></a><span id="l1.56">     // Drop the DNS request object, we no longer need it, and set the flag</span>
<a href="#l1.57"></a><span id="l1.57">     // indicating that DNS has finished.</span>
<a href="#l1.58"></a><span id="l1.58">     //</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineminus">-    mDNSRequest = 0;</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineplus">+    mDNSRequest = nullptr;</span>
<a href="#l1.61"></a><span id="l1.61">     mDNSHost.Truncate();</span>
<a href="#l1.62"></a><span id="l1.62"> </span>
<a href="#l1.63"></a><span id="l1.63">     // Call the listener, and then we can release our reference to it.</span>
<a href="#l1.64"></a><span id="l1.64">     //</span>
<a href="#l1.65"></a><span id="l1.65">     mInitListener-&gt;OnLDAPInit(this, rv);</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineminus">-    mInitListener = 0;</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineplus">+    mInitListener = nullptr;</span>
<a href="#l1.68"></a><span id="l1.68"> </span>
<a href="#l1.69"></a><span id="l1.69">     return rv;</span>
<a href="#l1.70"></a><span id="l1.70"> }</span>
<a href="#l1.71"></a><span id="l1.71"> </span>
<a href="#l1.72"></a><span id="l1.72"> nsLDAPConnectionRunnable::nsLDAPConnectionRunnable(int32_t aOperationID,</span>
<a href="#l1.73"></a><span id="l1.73">                                                    nsILDAPOperation *aOperation,</span>
<a href="#l1.74"></a><span id="l1.74">                                                    nsLDAPConnection *aConnection)</span>
<a href="#l1.75"></a><span id="l1.75">   : mOperationID(aOperationID),  mConnection(aConnection)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/ldap/xpcom/src/nsLDAPService.cpp</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/ldap/xpcom/src/nsLDAPService.cpp</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -1,10 +1,10 @@</span>
<a href="#l2.4"></a><span id="l2.4"> /* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-</span>
<a href="#l2.5"></a><span id="l2.5" class="difflineminus">- * </span>
<a href="#l2.6"></a><span id="l2.6" class="difflineplus">+ *</span>
<a href="#l2.7"></a><span id="l2.7">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l2.8"></a><span id="l2.8">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l2.9"></a><span id="l2.9">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l2.10"></a><span id="l2.10"> </span>
<a href="#l2.11"></a><span id="l2.11"> #include &quot;nsLDAPInternal.h&quot;</span>
<a href="#l2.12"></a><span id="l2.12"> #include &quot;nsLDAPService.h&quot;</span>
<a href="#l2.13"></a><span id="l2.13"> #include &quot;nsLDAPConnection.h&quot;</span>
<a href="#l2.14"></a><span id="l2.14"> #include &quot;nsLDAPOperation.h&quot;</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineat">@@ -162,17 +162,17 @@ bool nsLDAPServiceEntry::DeleteEntry()</span>
<a href="#l2.16"></a><span id="l2.16">     mDelete = true;</span>
<a href="#l2.17"></a><span id="l2.17"> </span>
<a href="#l2.18"></a><span id="l2.18">     return true;</span>
<a href="#l2.19"></a><span id="l2.19"> }</span>
<a href="#l2.20"></a><span id="l2.20"> // This is the end of the nsLDAPServiceEntry class</span>
<a href="#l2.21"></a><span id="l2.21"> </span>
<a href="#l2.22"></a><span id="l2.22"> </span>
<a href="#l2.23"></a><span id="l2.23"> // Here begins the implementation for nsLDAPService</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineminus">-// </span>
<a href="#l2.25"></a><span id="l2.25" class="difflineplus">+//</span>
<a href="#l2.26"></a><span id="l2.26"> NS_IMPL_ISUPPORTS(nsLDAPService,</span>
<a href="#l2.27"></a><span id="l2.27">                               nsILDAPService,</span>
<a href="#l2.28"></a><span id="l2.28">                               nsILDAPMessageListener)</span>
<a href="#l2.29"></a><span id="l2.29"> </span>
<a href="#l2.30"></a><span id="l2.30"> </span>
<a href="#l2.31"></a><span id="l2.31"> // constructor</span>
<a href="#l2.32"></a><span id="l2.32"> //</span>
<a href="#l2.33"></a><span id="l2.33"> nsLDAPService::nsLDAPService()</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineat">@@ -194,17 +194,17 @@ nsresult nsLDAPService::Init()</span>
<a href="#l2.35"></a><span id="l2.35"> }</span>
<a href="#l2.36"></a><span id="l2.36"> </span>
<a href="#l2.37"></a><span id="l2.37"> // void addServer (in nsILDAPServer aServer);</span>
<a href="#l2.38"></a><span id="l2.38"> NS_IMETHODIMP nsLDAPService::AddServer(nsILDAPServer *aServer)</span>
<a href="#l2.39"></a><span id="l2.39"> {</span>
<a href="#l2.40"></a><span id="l2.40">     nsLDAPServiceEntry *entry;</span>
<a href="#l2.41"></a><span id="l2.41">     nsString key;</span>
<a href="#l2.42"></a><span id="l2.42">     nsresult rv;</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineminus">-    </span>
<a href="#l2.44"></a><span id="l2.44" class="difflineplus">+</span>
<a href="#l2.45"></a><span id="l2.45">     if (!aServer) {</span>
<a href="#l2.46"></a><span id="l2.46">         NS_ERROR(&quot;nsLDAPService::AddServer: null pointer &quot;);</span>
<a href="#l2.47"></a><span id="l2.47">         return NS_ERROR_NULL_POINTER;</span>
<a href="#l2.48"></a><span id="l2.48">     }</span>
<a href="#l2.49"></a><span id="l2.49"> </span>
<a href="#l2.50"></a><span id="l2.50">     // Set up the hash key for the server entry</span>
<a href="#l2.51"></a><span id="l2.51">     //</span>
<a href="#l2.52"></a><span id="l2.52">     rv = aServer-&gt;GetKey(getter_Copies(key));</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineat">@@ -255,17 +255,17 @@ NS_IMETHODIMP nsLDAPService::AddServer(n</span>
<a href="#l2.54"></a><span id="l2.54">     return NS_OK;</span>
<a href="#l2.55"></a><span id="l2.55"> }</span>
<a href="#l2.56"></a><span id="l2.56"> </span>
<a href="#l2.57"></a><span id="l2.57"> // void deleteServer (in wstring aKey);</span>
<a href="#l2.58"></a><span id="l2.58"> NS_IMETHODIMP nsLDAPService::DeleteServer(const char16_t *aKey)</span>
<a href="#l2.59"></a><span id="l2.59"> {</span>
<a href="#l2.60"></a><span id="l2.60">     nsLDAPServiceEntry *entry;</span>
<a href="#l2.61"></a><span id="l2.61">     MutexAutoLock lock(mLock);</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineminus">-        </span>
<a href="#l2.63"></a><span id="l2.63" class="difflineplus">+</span>
<a href="#l2.64"></a><span id="l2.64">     // We should probably rename the key for this entry now that it's</span>
<a href="#l2.65"></a><span id="l2.65">     // &quot;deleted&quot;, so that we can add in a new one with the same ID.</span>
<a href="#l2.66"></a><span id="l2.66">     // This is bug #77669.</span>
<a href="#l2.67"></a><span id="l2.67">     //</span>
<a href="#l2.68"></a><span id="l2.68">     mServers.Get(nsDependentString(aKey), &amp;entry);</span>
<a href="#l2.69"></a><span id="l2.69">     if (entry) {</span>
<a href="#l2.70"></a><span id="l2.70">         if (entry-&gt;GetLeases() &gt; 0) {</span>
<a href="#l2.71"></a><span id="l2.71">             return NS_ERROR_FAILURE;</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineat">@@ -349,17 +349,17 @@ NS_IMETHODIMP nsLDAPService::RequestConn</span>
<a href="#l2.73"></a><span id="l2.73"> </span>
<a href="#l2.74"></a><span id="l2.74">     }</span>
<a href="#l2.75"></a><span id="l2.75"> </span>
<a href="#l2.76"></a><span id="l2.76">     // We got a new connection, now push the listeners on our stack,</span>
<a href="#l2.77"></a><span id="l2.77">     // until we get the LDAP message back.</span>
<a href="#l2.78"></a><span id="l2.78">     //</span>
<a href="#l2.79"></a><span id="l2.79">     {</span>
<a href="#l2.80"></a><span id="l2.80">         MutexAutoLock lock(mLock);</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineminus">-            </span>
<a href="#l2.82"></a><span id="l2.82" class="difflineplus">+</span>
<a href="#l2.83"></a><span id="l2.83">         if (!mServers.Get(nsDependentString(aKey), &amp;entry) ||</span>
<a href="#l2.84"></a><span id="l2.84">             !entry-&gt;PushListener(static_cast&lt;nsILDAPMessageListener *&gt;</span>
<a href="#l2.85"></a><span id="l2.85">                                             (aListener))) {</span>
<a href="#l2.86"></a><span id="l2.86">             return NS_ERROR_FAILURE;</span>
<a href="#l2.87"></a><span id="l2.87">         }</span>
<a href="#l2.88"></a><span id="l2.88">     }</span>
<a href="#l2.89"></a><span id="l2.89"> </span>
<a href="#l2.90"></a><span id="l2.90">     return NS_OK;</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineat">@@ -421,17 +421,17 @@ NS_IMETHODIMP nsLDAPService::ReconnectCo</span>
<a href="#l2.92"></a><span id="l2.92"> </span>
<a href="#l2.93"></a><span id="l2.93">     if (!aListener) {</span>
<a href="#l2.94"></a><span id="l2.94">         NS_ERROR(&quot;nsLDAPService::ReconnectConnection: null pointer &quot;);</span>
<a href="#l2.95"></a><span id="l2.95">         return NS_ERROR_NULL_POINTER;</span>
<a href="#l2.96"></a><span id="l2.96">     }</span>
<a href="#l2.97"></a><span id="l2.97"> </span>
<a href="#l2.98"></a><span id="l2.98">     {</span>
<a href="#l2.99"></a><span id="l2.99">         MutexAutoLock lock(mLock);</span>
<a href="#l2.100"></a><span id="l2.100" class="difflineminus">-        </span>
<a href="#l2.101"></a><span id="l2.101" class="difflineplus">+</span>
<a href="#l2.102"></a><span id="l2.102">         if (!mServers.Get(nsDependentString(aKey), &amp;entry)) {</span>
<a href="#l2.103"></a><span id="l2.103">             return NS_ERROR_FAILURE;</span>
<a href="#l2.104"></a><span id="l2.104">         }</span>
<a href="#l2.105"></a><span id="l2.105">         entry-&gt;SetTimestamp();</span>
<a href="#l2.106"></a><span id="l2.106"> </span>
<a href="#l2.107"></a><span id="l2.107">         if (entry-&gt;IsRebinding()) {</span>
<a href="#l2.108"></a><span id="l2.108">             if (!entry-&gt;PushListener(aListener)) {</span>
<a href="#l2.109"></a><span id="l2.109">                 return NS_ERROR_FAILURE;</span>
<a href="#l2.110"></a><span id="l2.110" class="difflineat">@@ -455,17 +455,17 @@ NS_IMETHODIMP nsLDAPService::ReconnectCo</span>
<a href="#l2.111"></a><span id="l2.111"> </span>
<a href="#l2.112"></a><span id="l2.112">     rv = EstablishConnection(entry, aListener);</span>
<a href="#l2.113"></a><span id="l2.113">     if (NS_FAILED(rv)) {</span>
<a href="#l2.114"></a><span id="l2.114">         return rv;</span>
<a href="#l2.115"></a><span id="l2.115">     }</span>
<a href="#l2.116"></a><span id="l2.116"> </span>
<a href="#l2.117"></a><span id="l2.117">     {</span>
<a href="#l2.118"></a><span id="l2.118">         MutexAutoLock lock(mLock);</span>
<a href="#l2.119"></a><span id="l2.119" class="difflineminus">-        </span>
<a href="#l2.120"></a><span id="l2.120" class="difflineplus">+</span>
<a href="#l2.121"></a><span id="l2.121">         if (!entry-&gt;PushListener(static_cast&lt;nsILDAPMessageListener *&gt;</span>
<a href="#l2.122"></a><span id="l2.122">                                             (aListener))) {</span>
<a href="#l2.123"></a><span id="l2.123">             entry-&gt;SetRebinding(false);</span>
<a href="#l2.124"></a><span id="l2.124">             return NS_ERROR_FAILURE;</span>
<a href="#l2.125"></a><span id="l2.125">         }</span>
<a href="#l2.126"></a><span id="l2.126">     }</span>
<a href="#l2.127"></a><span id="l2.127"> </span>
<a href="#l2.128"></a><span id="l2.128">     return NS_OK;</span>
<a href="#l2.129"></a><span id="l2.129" class="difflineat">@@ -473,17 +473,17 @@ NS_IMETHODIMP nsLDAPService::ReconnectCo</span>
<a href="#l2.130"></a><span id="l2.130"> </span>
<a href="#l2.131"></a><span id="l2.131"> /**</span>
<a href="#l2.132"></a><span id="l2.132">  * Messages received are passed back via this function.</span>
<a href="#l2.133"></a><span id="l2.133">  *</span>
<a href="#l2.134"></a><span id="l2.134">  * @arg aMessage  The message that was returned, 0 if none was.</span>
<a href="#l2.135"></a><span id="l2.135">  *</span>
<a href="#l2.136"></a><span id="l2.136">  * void OnLDAPMessage (in nsILDAPMessage aMessage)</span>
<a href="#l2.137"></a><span id="l2.137">  */</span>
<a href="#l2.138"></a><span id="l2.138" class="difflineminus">-NS_IMETHODIMP </span>
<a href="#l2.139"></a><span id="l2.139" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l2.140"></a><span id="l2.140"> nsLDAPService::OnLDAPMessage(nsILDAPMessage *aMessage)</span>
<a href="#l2.141"></a><span id="l2.141"> {</span>
<a href="#l2.142"></a><span id="l2.142">     nsCOMPtr&lt;nsILDAPOperation&gt; operation;</span>
<a href="#l2.143"></a><span id="l2.143">     nsCOMPtr&lt;nsILDAPConnection&gt; connection;</span>
<a href="#l2.144"></a><span id="l2.144">     int32_t messageType;</span>
<a href="#l2.145"></a><span id="l2.145"> </span>
<a href="#l2.146"></a><span id="l2.146">     // XXXleif: NULL messages are supposedly allowed, but the semantics</span>
<a href="#l2.147"></a><span id="l2.147">     // are not definted (yet?). This is something to look out for...</span>
<a href="#l2.148"></a><span id="l2.148" class="difflineat">@@ -552,17 +552,17 @@ nsLDAPService::OnLDAPMessage(nsILDAPMess</span>
<a href="#l2.149"></a><span id="l2.149">         break;</span>
<a href="#l2.150"></a><span id="l2.150"> </span>
<a href="#l2.151"></a><span id="l2.151">     default:</span>
<a href="#l2.152"></a><span id="l2.152">         NS_WARNING(&quot;nsLDAPService::OnLDAPMessage(): unexpected LDAP message &quot;</span>
<a href="#l2.153"></a><span id="l2.153">                    &quot;received&quot;);</span>
<a href="#l2.154"></a><span id="l2.154"> </span>
<a href="#l2.155"></a><span id="l2.155">         // get the console service so we can log a message</span>
<a href="#l2.156"></a><span id="l2.156">         //</span>
<a href="#l2.157"></a><span id="l2.157" class="difflineminus">-        nsCOMPtr&lt;nsIConsoleService&gt; consoleSvc = </span>
<a href="#l2.158"></a><span id="l2.158" class="difflineplus">+        nsCOMPtr&lt;nsIConsoleService&gt; consoleSvc =</span>
<a href="#l2.159"></a><span id="l2.159">             do_GetService(&quot;@mozilla.org/consoleservice;1&quot;, &amp;rv);</span>
<a href="#l2.160"></a><span id="l2.160">         if (NS_FAILED(rv)) {</span>
<a href="#l2.161"></a><span id="l2.161">             NS_ERROR(&quot;nsLDAPChannel::OnLDAPMessage() couldn't get console &quot;</span>
<a href="#l2.162"></a><span id="l2.162">                      &quot;service&quot;);</span>
<a href="#l2.163"></a><span id="l2.163">             break;</span>
<a href="#l2.164"></a><span id="l2.164">         }</span>
<a href="#l2.165"></a><span id="l2.165"> </span>
<a href="#l2.166"></a><span id="l2.166">         // log the message</span>
<a href="#l2.167"></a><span id="l2.167" class="difflineat">@@ -663,17 +663,17 @@ nsLDAPService::EstablishConnection(nsLDA</span>
<a href="#l2.168"></a><span id="l2.168"> </span>
<a href="#l2.169"></a><span id="l2.169">         conn2 = aEntry-&gt;GetConnection();</span>
<a href="#l2.170"></a><span id="l2.170">         message = aEntry-&gt;GetMessage();</span>
<a href="#l2.171"></a><span id="l2.171">     }</span>
<a href="#l2.172"></a><span id="l2.172"> </span>
<a href="#l2.173"></a><span id="l2.173">     if (conn2) {</span>
<a href="#l2.174"></a><span id="l2.174">         // Drop the new connection, we can't use it.</span>
<a href="#l2.175"></a><span id="l2.175">         //</span>
<a href="#l2.176"></a><span id="l2.176" class="difflineminus">-        conn = 0;</span>
<a href="#l2.177"></a><span id="l2.177" class="difflineplus">+        conn = nullptr;</span>
<a href="#l2.178"></a><span id="l2.178">         if (message) {</span>
<a href="#l2.179"></a><span id="l2.179">             aListener-&gt;OnLDAPMessage(message);</span>
<a href="#l2.180"></a><span id="l2.180">             return NS_OK;</span>
<a href="#l2.181"></a><span id="l2.181">         }</span>
<a href="#l2.182"></a><span id="l2.182"> </span>
<a href="#l2.183"></a><span id="l2.183">         {</span>
<a href="#l2.184"></a><span id="l2.184">             MutexAutoLock lock(mLock);</span>
<a href="#l2.185"></a><span id="l2.185"> </span>
<a href="#l2.186"></a><span id="l2.186" class="difflineat">@@ -704,53 +704,53 @@ nsLDAPService::EstablishConnection(nsLDA</span>
<a href="#l2.187"></a><span id="l2.187">         return NS_ERROR_FAILURE;</span>
<a href="#l2.188"></a><span id="l2.188">     }</span>
<a href="#l2.189"></a><span id="l2.189"> </span>
<a href="#l2.190"></a><span id="l2.190">     rv = operation-&gt;Init(conn, this, nullptr);</span>
<a href="#l2.191"></a><span id="l2.191">     if (NS_FAILED(rv)) {</span>
<a href="#l2.192"></a><span id="l2.192">         return NS_ERROR_UNEXPECTED; // this should never happen</span>
<a href="#l2.193"></a><span id="l2.193">     }</span>
<a href="#l2.194"></a><span id="l2.194"> </span>
<a href="#l2.195"></a><span id="l2.195" class="difflineminus">-    // Start a bind operation </span>
<a href="#l2.196"></a><span id="l2.196" class="difflineplus">+    // Start a bind operation</span>
<a href="#l2.197"></a><span id="l2.197">     //</span>
<a href="#l2.198"></a><span id="l2.198">     // Here we need to support the password, see bug #75990</span>
<a href="#l2.199"></a><span id="l2.199" class="difflineminus">-    // </span>
<a href="#l2.200"></a><span id="l2.200" class="difflineplus">+    //</span>
<a href="#l2.201"></a><span id="l2.201">     rv = operation-&gt;SimpleBind(password);</span>
<a href="#l2.202"></a><span id="l2.202">     if (NS_FAILED(rv)) {</span>
<a href="#l2.203"></a><span id="l2.203">         // Only pass along errors we are aware of</span>
<a href="#l2.204"></a><span id="l2.204">         if ((rv == NS_ERROR_LDAP_ENCODING_ERROR) ||</span>
<a href="#l2.205"></a><span id="l2.205">             (rv == NS_ERROR_FAILURE) ||</span>
<a href="#l2.206"></a><span id="l2.206">             (rv == NS_ERROR_OUT_OF_MEMORY))</span>
<a href="#l2.207"></a><span id="l2.207">             return rv;</span>
<a href="#l2.208"></a><span id="l2.208">         else</span>
<a href="#l2.209"></a><span id="l2.209">             return NS_ERROR_UNEXPECTED;</span>
<a href="#l2.210"></a><span id="l2.210">     }</span>
<a href="#l2.211"></a><span id="l2.211"> </span>
<a href="#l2.212"></a><span id="l2.212">     return NS_OK;</span>
<a href="#l2.213"></a><span id="l2.213"> }</span>
<a href="#l2.214"></a><span id="l2.214"> </span>
<a href="#l2.215"></a><span id="l2.215"> /* AString createFilter (in unsigned long aMaxSize, in AString aPattern, in AString aPrefix, in AString aSuffix, in AString aAttr, in AString aValue); */</span>
<a href="#l2.216"></a><span id="l2.216" class="difflineminus">-NS_IMETHODIMP nsLDAPService::CreateFilter(uint32_t aMaxSize, </span>
<a href="#l2.217"></a><span id="l2.217" class="difflineplus">+NS_IMETHODIMP nsLDAPService::CreateFilter(uint32_t aMaxSize,</span>
<a href="#l2.218"></a><span id="l2.218">                                           const nsACString &amp; aPattern,</span>
<a href="#l2.219"></a><span id="l2.219">                                           const nsACString &amp; aPrefix,</span>
<a href="#l2.220"></a><span id="l2.220">                                           const nsACString &amp; aSuffix,</span>
<a href="#l2.221"></a><span id="l2.221">                                           const nsACString &amp; aAttr,</span>
<a href="#l2.222"></a><span id="l2.222">                                           const nsACString &amp; aValue,</span>
<a href="#l2.223"></a><span id="l2.223">                                           nsACString &amp; _retval)</span>
<a href="#l2.224"></a><span id="l2.224"> {</span>
<a href="#l2.225"></a><span id="l2.225">     if (!aMaxSize) {</span>
<a href="#l2.226"></a><span id="l2.226">         return NS_ERROR_INVALID_ARG;</span>
<a href="#l2.227"></a><span id="l2.227">     }</span>
<a href="#l2.228"></a><span id="l2.228"> </span>
<a href="#l2.229"></a><span id="l2.229">     // figure out how big of an array we're going to need for the tokens,</span>
<a href="#l2.230"></a><span id="l2.230">     // including a trailing NULL, and allocate space for it.</span>
<a href="#l2.231"></a><span id="l2.231">     //</span>
<a href="#l2.232"></a><span id="l2.232">     const char *iter = aValue.BeginReading();</span>
<a href="#l2.233"></a><span id="l2.233">     const char *iterEnd = aValue.EndReading();</span>
<a href="#l2.234"></a><span id="l2.234" class="difflineminus">-    uint32_t numTokens = CountTokens(iter, iterEnd); </span>
<a href="#l2.235"></a><span id="l2.235" class="difflineplus">+    uint32_t numTokens = CountTokens(iter, iterEnd);</span>
<a href="#l2.236"></a><span id="l2.236">     char **valueWords;</span>
<a href="#l2.237"></a><span id="l2.237">     valueWords = static_cast&lt;char **&gt;(moz_xmalloc((numTokens + 1) *</span>
<a href="#l2.238"></a><span id="l2.238">                                                 sizeof(char *)));</span>
<a href="#l2.239"></a><span id="l2.239">     if (!valueWords) {</span>
<a href="#l2.240"></a><span id="l2.240">         return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l2.241"></a><span id="l2.241">     }</span>
<a href="#l2.242"></a><span id="l2.242"> </span>
<a href="#l2.243"></a><span id="l2.243">     // build the array of values</span>
<a href="#l2.244"></a><span id="l2.244" class="difflineat">@@ -761,43 +761,43 @@ NS_IMETHODIMP nsLDAPService::CreateFilte</span>
<a href="#l2.245"></a><span id="l2.245">         if ( !valueWords[curToken] ) {</span>
<a href="#l2.246"></a><span id="l2.246">             NS_FREE_XPCOM_ALLOCATED_POINTER_ARRAY(curToken, valueWords);</span>
<a href="#l2.247"></a><span id="l2.247">             return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l2.248"></a><span id="l2.248">         }</span>
<a href="#l2.249"></a><span id="l2.249">         curToken++;</span>
<a href="#l2.250"></a><span id="l2.250">     }</span>
<a href="#l2.251"></a><span id="l2.251">     valueWords[numTokens] = 0;  // end of array signal to LDAP C SDK</span>
<a href="#l2.252"></a><span id="l2.252"> </span>
<a href="#l2.253"></a><span id="l2.253" class="difflineminus">-    // make buffer to be used for construction </span>
<a href="#l2.254"></a><span id="l2.254" class="difflineplus">+    // make buffer to be used for construction</span>
<a href="#l2.255"></a><span id="l2.255">     //</span>
<a href="#l2.256"></a><span id="l2.256">     char *buffer = static_cast&lt;char *&gt;(moz_xmalloc(aMaxSize * sizeof(char)));</span>
<a href="#l2.257"></a><span id="l2.257">     if (!buffer) {</span>
<a href="#l2.258"></a><span id="l2.258">         NS_FREE_XPCOM_ALLOCATED_POINTER_ARRAY(numTokens, valueWords);</span>
<a href="#l2.259"></a><span id="l2.259">         return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l2.260"></a><span id="l2.260">     }</span>
<a href="#l2.261"></a><span id="l2.261"> </span>
<a href="#l2.262"></a><span id="l2.262">     // create the filter itself</span>
<a href="#l2.263"></a><span id="l2.263">     //</span>
<a href="#l2.264"></a><span id="l2.264">     nsresult rv;</span>
<a href="#l2.265"></a><span id="l2.265" class="difflineminus">-    int result = ldap_create_filter(buffer, aMaxSize, </span>
<a href="#l2.266"></a><span id="l2.266" class="difflineplus">+    int result = ldap_create_filter(buffer, aMaxSize,</span>
<a href="#l2.267"></a><span id="l2.267">                    const_cast&lt;char *&gt;(PromiseFlatCString(aPattern).get()),</span>
<a href="#l2.268"></a><span id="l2.268">                    const_cast&lt;char *&gt;(PromiseFlatCString(aPrefix).get()),</span>
<a href="#l2.269"></a><span id="l2.269">                    const_cast&lt;char *&gt;(PromiseFlatCString(aSuffix).get()),</span>
<a href="#l2.270"></a><span id="l2.270">                    const_cast&lt;char *&gt;(PromiseFlatCString(aAttr).get()),</span>
<a href="#l2.271"></a><span id="l2.271">                    const_cast&lt;char *&gt;(PromiseFlatCString(aValue).get()),</span>
<a href="#l2.272"></a><span id="l2.272">                    valueWords);</span>
<a href="#l2.273"></a><span id="l2.273">     switch (result) {</span>
<a href="#l2.274"></a><span id="l2.274">     case LDAP_SUCCESS:</span>
<a href="#l2.275"></a><span id="l2.275">         rv = NS_OK;</span>
<a href="#l2.276"></a><span id="l2.276">         break;</span>
<a href="#l2.277"></a><span id="l2.277"> </span>
<a href="#l2.278"></a><span id="l2.278">     case LDAP_SIZELIMIT_EXCEEDED:</span>
<a href="#l2.279"></a><span id="l2.279" class="difflineminus">-        MOZ_LOG(gLDAPLogModule, mozilla::LogLevel::Debug, </span>
<a href="#l2.280"></a><span id="l2.280" class="difflineplus">+        MOZ_LOG(gLDAPLogModule, mozilla::LogLevel::Debug,</span>
<a href="#l2.281"></a><span id="l2.281">                    (&quot;nsLDAPService::CreateFilter(): &quot;</span>
<a href="#l2.282"></a><span id="l2.282" class="difflineminus">-                    &quot;filter longer than max size of %d generated&quot;, </span>
<a href="#l2.283"></a><span id="l2.283" class="difflineplus">+                    &quot;filter longer than max size of %d generated&quot;,</span>
<a href="#l2.284"></a><span id="l2.284">                     aMaxSize));</span>
<a href="#l2.285"></a><span id="l2.285">         rv = NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l2.286"></a><span id="l2.286">         break;</span>
<a href="#l2.287"></a><span id="l2.287"> </span>
<a href="#l2.288"></a><span id="l2.288">     case LDAP_PARAM_ERROR:</span>
<a href="#l2.289"></a><span id="l2.289">         rv = NS_ERROR_INVALID_ARG;</span>
<a href="#l2.290"></a><span id="l2.290">         break;</span>
<a href="#l2.291"></a><span id="l2.291"> </span>
<a href="#l2.292"></a><span id="l2.292" class="difflineat">@@ -863,17 +863,17 @@ NS_IMETHODIMP nsLDAPService::ParseDn(con</span>
<a href="#l2.293"></a><span id="l2.293">     for (char **component = rdnComponents; *component; ++component)</span>
<a href="#l2.294"></a><span id="l2.294">         ++rdnCount;</span>
<a href="#l2.295"></a><span id="l2.295">     if (rdnCount &lt; 1) {</span>
<a href="#l2.296"></a><span id="l2.296">         NS_ERROR(&quot;nsLDAPService::ParseDn: RDN has too few components&quot;);</span>
<a href="#l2.297"></a><span id="l2.297">         ldap_value_free(dnComponents);</span>
<a href="#l2.298"></a><span id="l2.298">         ldap_value_free(rdnComponents);</span>
<a href="#l2.299"></a><span id="l2.299">         return NS_ERROR_UNEXPECTED;</span>
<a href="#l2.300"></a><span id="l2.300">     }</span>
<a href="#l2.301"></a><span id="l2.301" class="difflineminus">-  </span>
<a href="#l2.302"></a><span id="l2.302" class="difflineplus">+</span>
<a href="#l2.303"></a><span id="l2.303">     // get the RDN attribute names</span>
<a href="#l2.304"></a><span id="l2.304">     char **attrNameArray = static_cast&lt;char **&gt;(</span>
<a href="#l2.305"></a><span id="l2.305">         moz_xmalloc(rdnCount * sizeof(char *)));</span>
<a href="#l2.306"></a><span id="l2.306">     if (!attrNameArray) {</span>
<a href="#l2.307"></a><span id="l2.307">         NS_ERROR(&quot;nsLDAPService::ParseDn: out of memory &quot;);</span>
<a href="#l2.308"></a><span id="l2.308">         ldap_value_free(dnComponents);</span>
<a href="#l2.309"></a><span id="l2.309">         ldap_value_free(rdnComponents);</span>
<a href="#l2.310"></a><span id="l2.310">         return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l2.311"></a><span id="l2.311" class="difflineat">@@ -920,17 +920,17 @@ uint32_t</span>
<a href="#l2.312"></a><span id="l2.312"> nsLDAPService::CountTokens(const char *aIter,</span>
<a href="#l2.313"></a><span id="l2.313">                            const char *aIterEnd)</span>
<a href="#l2.314"></a><span id="l2.314"> {</span>
<a href="#l2.315"></a><span id="l2.315">     uint32_t count(0);</span>
<a href="#l2.316"></a><span id="l2.316"> </span>
<a href="#l2.317"></a><span id="l2.317">     // keep iterating through the string until we hit the end</span>
<a href="#l2.318"></a><span id="l2.318">     //</span>
<a href="#l2.319"></a><span id="l2.319">     while (aIter != aIterEnd) {</span>
<a href="#l2.320"></a><span id="l2.320" class="difflineminus">-    </span>
<a href="#l2.321"></a><span id="l2.321" class="difflineplus">+</span>
<a href="#l2.322"></a><span id="l2.322">         // move past any leading spaces</span>
<a href="#l2.323"></a><span id="l2.323">         //</span>
<a href="#l2.324"></a><span id="l2.324">         while (aIter != aIterEnd &amp;&amp;</span>
<a href="#l2.325"></a><span id="l2.325">                ldap_utf8isspace(const_cast&lt;char *&gt;(aIter))){</span>
<a href="#l2.326"></a><span id="l2.326">             ++aIter;</span>
<a href="#l2.327"></a><span id="l2.327">         }</span>
<a href="#l2.328"></a><span id="l2.328"> </span>
<a href="#l2.329"></a><span id="l2.329">         // move past all chars in this token</span>
<a href="#l2.330"></a><span id="l2.330" class="difflineat">@@ -940,17 +940,17 @@ nsLDAPService::CountTokens(const char *a</span>
<a href="#l2.331"></a><span id="l2.331">             if (ldap_utf8isspace(const_cast&lt;char *&gt;(aIter))) {</span>
<a href="#l2.332"></a><span id="l2.332">                 ++count;    // token finished; increment the count</span>
<a href="#l2.333"></a><span id="l2.333">                 ++aIter;    // move past the space</span>
<a href="#l2.334"></a><span id="l2.334">                 break;</span>
<a href="#l2.335"></a><span id="l2.335">             }</span>
<a href="#l2.336"></a><span id="l2.336"> </span>
<a href="#l2.337"></a><span id="l2.337">             ++aIter; // move to next char</span>
<a href="#l2.338"></a><span id="l2.338"> </span>
<a href="#l2.339"></a><span id="l2.339" class="difflineminus">-            // if we've hit the end of this token and the end of this </span>
<a href="#l2.340"></a><span id="l2.340" class="difflineplus">+            // if we've hit the end of this token and the end of this</span>
<a href="#l2.341"></a><span id="l2.341">             // iterator simultaneous, be sure to bump the count, since we're</span>
<a href="#l2.342"></a><span id="l2.342">             // never gonna hit the IsAsciiSpace where it's normally done.</span>
<a href="#l2.343"></a><span id="l2.343">             //</span>
<a href="#l2.344"></a><span id="l2.344">             if (aIter == aIterEnd) {</span>
<a href="#l2.345"></a><span id="l2.345">                 ++count;</span>
<a href="#l2.346"></a><span id="l2.346">             }</span>
<a href="#l2.347"></a><span id="l2.347"> </span>
<a href="#l2.348"></a><span id="l2.348">         }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/ldap/xpcom/src/nsLDAPSyncQuery.cpp</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/ldap/xpcom/src/nsLDAPSyncQuery.cpp</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -27,19 +27,19 @@ nsLDAPSyncQuery::nsLDAPSyncQuery() :</span>
<a href="#l3.4"></a><span id="l3.4"> // Destructor</span>
<a href="#l3.5"></a><span id="l3.5"> //</span>
<a href="#l3.6"></a><span id="l3.6"> nsLDAPSyncQuery::~nsLDAPSyncQuery()</span>
<a href="#l3.7"></a><span id="l3.7"> {</span>
<a href="#l3.8"></a><span id="l3.8"> }</span>
<a href="#l3.9"></a><span id="l3.9"> </span>
<a href="#l3.10"></a><span id="l3.10"> </span>
<a href="#l3.11"></a><span id="l3.11"> // Messages received are passed back via this function.</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-// void OnLDAPMessage (in nsILDAPMessage aMessage) </span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+// void OnLDAPMessage (in nsILDAPMessage aMessage)</span>
<a href="#l3.14"></a><span id="l3.14"> //</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">-NS_IMETHODIMP </span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l3.17"></a><span id="l3.17"> nsLDAPSyncQuery::OnLDAPMessage(nsILDAPMessage *aMessage)</span>
<a href="#l3.18"></a><span id="l3.18"> {</span>
<a href="#l3.19"></a><span id="l3.19">     int32_t messageType;</span>
<a href="#l3.20"></a><span id="l3.20"> </span>
<a href="#l3.21"></a><span id="l3.21">     // just in case.</span>
<a href="#l3.22"></a><span id="l3.22">     //</span>
<a href="#l3.23"></a><span id="l3.23">     if (!aMessage) {</span>
<a href="#l3.24"></a><span id="l3.24">         return NS_OK;</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineat">@@ -59,29 +59,29 @@ nsLDAPSyncQuery::OnLDAPMessage(nsILDAPMe</span>
<a href="#l3.26"></a><span id="l3.26"> </span>
<a href="#l3.27"></a><span id="l3.27">     case nsILDAPMessage::RES_BIND:</span>
<a href="#l3.28"></a><span id="l3.28"> </span>
<a href="#l3.29"></a><span id="l3.29">         // a bind has completed</span>
<a href="#l3.30"></a><span id="l3.30">         //</span>
<a href="#l3.31"></a><span id="l3.31">         return OnLDAPBind(aMessage);</span>
<a href="#l3.32"></a><span id="l3.32"> </span>
<a href="#l3.33"></a><span id="l3.33">     case nsILDAPMessage::RES_SEARCH_ENTRY:</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineminus">-        </span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+</span>
<a href="#l3.36"></a><span id="l3.36">         // a search entry has been returned</span>
<a href="#l3.37"></a><span id="l3.37">         //</span>
<a href="#l3.38"></a><span id="l3.38">         return OnLDAPSearchEntry(aMessage);</span>
<a href="#l3.39"></a><span id="l3.39"> </span>
<a href="#l3.40"></a><span id="l3.40">     case nsILDAPMessage::RES_SEARCH_RESULT:</span>
<a href="#l3.41"></a><span id="l3.41"> </span>
<a href="#l3.42"></a><span id="l3.42">         // the search is finished; we're all done</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineminus">-        //  </span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+        //</span>
<a href="#l3.45"></a><span id="l3.45">         return OnLDAPSearchResult(aMessage);</span>
<a href="#l3.46"></a><span id="l3.46"> </span>
<a href="#l3.47"></a><span id="l3.47">     default:</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineminus">-        </span>
<a href="#l3.49"></a><span id="l3.49" class="difflineplus">+</span>
<a href="#l3.50"></a><span id="l3.50">         // Given the LDAP operations nsLDAPSyncQuery uses, we should</span>
<a href="#l3.51"></a><span id="l3.51">         // never get here.  If we do get here in a release build, it's</span>
<a href="#l3.52"></a><span id="l3.52">         // probably a bug, but maybe it's the LDAP server doing something</span>
<a href="#l3.53"></a><span id="l3.53">         // weird.  Might as well try and continue anyway.  The session should</span>
<a href="#l3.54"></a><span id="l3.54">         // eventually get reaped by the timeout code, if necessary.</span>
<a href="#l3.55"></a><span id="l3.55">         //</span>
<a href="#l3.56"></a><span id="l3.56">         NS_ERROR(&quot;nsLDAPSyncQuery::OnLDAPMessage(): unexpected &quot;</span>
<a href="#l3.57"></a><span id="l3.57">                  &quot;LDAP message received&quot;);</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineat">@@ -91,56 +91,56 @@ nsLDAPSyncQuery::OnLDAPMessage(nsILDAPMe</span>
<a href="#l3.59"></a><span id="l3.59"> </span>
<a href="#l3.60"></a><span id="l3.60"> // void onLDAPInit (in nsresult aStatus);</span>
<a href="#l3.61"></a><span id="l3.61"> //</span>
<a href="#l3.62"></a><span id="l3.62"> NS_IMETHODIMP</span>
<a href="#l3.63"></a><span id="l3.63"> nsLDAPSyncQuery::OnLDAPInit(nsILDAPConnection *aConn, nsresult aStatus)</span>
<a href="#l3.64"></a><span id="l3.64"> {</span>
<a href="#l3.65"></a><span id="l3.65">     nsresult rv;        // temp for xpcom return values</span>
<a href="#l3.66"></a><span id="l3.66">     // create and initialize an LDAP operation (to be used for the bind)</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineminus">-    //  </span>
<a href="#l3.68"></a><span id="l3.68" class="difflineminus">-    mOperation = do_CreateInstance(&quot;@mozilla.org/network/ldap-operation;1&quot;, </span>
<a href="#l3.69"></a><span id="l3.69" class="difflineplus">+    //</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineplus">+    mOperation = do_CreateInstance(&quot;@mozilla.org/network/ldap-operation;1&quot;,</span>
<a href="#l3.71"></a><span id="l3.71">                                    &amp;rv);</span>
<a href="#l3.72"></a><span id="l3.72">     if (NS_FAILED(rv)) {</span>
<a href="#l3.73"></a><span id="l3.73">         FinishLDAPQuery();</span>
<a href="#l3.74"></a><span id="l3.74">         return NS_ERROR_FAILURE;</span>
<a href="#l3.75"></a><span id="l3.75">     }</span>
<a href="#l3.76"></a><span id="l3.76"> </span>
<a href="#l3.77"></a><span id="l3.77">     // our OnLDAPMessage accepts all result callbacks</span>
<a href="#l3.78"></a><span id="l3.78">     //</span>
<a href="#l3.79"></a><span id="l3.79">     rv = mOperation-&gt;Init(mConnection, this, nullptr);</span>
<a href="#l3.80"></a><span id="l3.80">     if (NS_FAILED(rv)) {</span>
<a href="#l3.81"></a><span id="l3.81">         FinishLDAPQuery();</span>
<a href="#l3.82"></a><span id="l3.82">         return NS_ERROR_UNEXPECTED; // this should never happen</span>
<a href="#l3.83"></a><span id="l3.83">     }</span>
<a href="#l3.84"></a><span id="l3.84"> </span>
<a href="#l3.85"></a><span id="l3.85" class="difflineminus">-    // kick off a bind operation </span>
<a href="#l3.86"></a><span id="l3.86" class="difflineminus">-    // </span>
<a href="#l3.87"></a><span id="l3.87" class="difflineminus">-    rv = mOperation-&gt;SimpleBind(EmptyCString()); </span>
<a href="#l3.88"></a><span id="l3.88" class="difflineplus">+    // kick off a bind operation</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineplus">+    //</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineplus">+    rv = mOperation-&gt;SimpleBind(EmptyCString());</span>
<a href="#l3.91"></a><span id="l3.91">     if (NS_FAILED(rv)) {</span>
<a href="#l3.92"></a><span id="l3.92">         FinishLDAPQuery();</span>
<a href="#l3.93"></a><span id="l3.93">         return NS_ERROR_FAILURE;</span>
<a href="#l3.94"></a><span id="l3.94">     }</span>
<a href="#l3.95"></a><span id="l3.95" class="difflineminus">-    </span>
<a href="#l3.96"></a><span id="l3.96" class="difflineplus">+</span>
<a href="#l3.97"></a><span id="l3.97">     return NS_OK;</span>
<a href="#l3.98"></a><span id="l3.98"> }</span>
<a href="#l3.99"></a><span id="l3.99"> </span>
<a href="#l3.100"></a><span id="l3.100"> nsresult</span>
<a href="#l3.101"></a><span id="l3.101"> nsLDAPSyncQuery::OnLDAPBind(nsILDAPMessage *aMessage)</span>
<a href="#l3.102"></a><span id="l3.102"> {</span>
<a href="#l3.103"></a><span id="l3.103"> </span>
<a href="#l3.104"></a><span id="l3.104">     int32_t errCode;</span>
<a href="#l3.105"></a><span id="l3.105"> </span>
<a href="#l3.106"></a><span id="l3.106" class="difflineminus">-    mOperation = 0;  // done with bind op; make nsCOMPtr release it</span>
<a href="#l3.107"></a><span id="l3.107" class="difflineplus">+    mOperation = nullptr;  // done with bind op; make nsCOMPtr release it</span>
<a href="#l3.108"></a><span id="l3.108"> </span>
<a href="#l3.109"></a><span id="l3.109">     // get the status of the bind</span>
<a href="#l3.110"></a><span id="l3.110">     //</span>
<a href="#l3.111"></a><span id="l3.111">     nsresult rv = aMessage-&gt;GetErrorCode(&amp;errCode);</span>
<a href="#l3.112"></a><span id="l3.112">     if (NS_FAILED(rv)) {</span>
<a href="#l3.113"></a><span id="l3.113" class="difflineminus">-        </span>
<a href="#l3.114"></a><span id="l3.114" class="difflineplus">+</span>
<a href="#l3.115"></a><span id="l3.115">         NS_ERROR(&quot;nsLDAPSyncQuery::OnLDAPBind(): couldn't get &quot;</span>
<a href="#l3.116"></a><span id="l3.116">                  &quot;error code from aMessage&quot;);</span>
<a href="#l3.117"></a><span id="l3.117">         FinishLDAPQuery();</span>
<a href="#l3.118"></a><span id="l3.118">         return NS_ERROR_FAILURE;</span>
<a href="#l3.119"></a><span id="l3.119">     }</span>
<a href="#l3.120"></a><span id="l3.120"> </span>
<a href="#l3.121"></a><span id="l3.121"> </span>
<a href="#l3.122"></a><span id="l3.122">     // check to be sure the bind succeeded</span>
<a href="#l3.123"></a><span id="l3.123" class="difflineat">@@ -202,28 +202,28 @@ nsLDAPSyncQuery::OnLDAPSearchEntry(nsILD</span>
<a href="#l3.124"></a><span id="l3.124"> }</span>
<a href="#l3.125"></a><span id="l3.125"> </span>
<a href="#l3.126"></a><span id="l3.126"> </span>
<a href="#l3.127"></a><span id="l3.127"> nsresult</span>
<a href="#l3.128"></a><span id="l3.128"> nsLDAPSyncQuery::OnLDAPSearchResult(nsILDAPMessage *aMessage)</span>
<a href="#l3.129"></a><span id="l3.129"> {</span>
<a href="#l3.130"></a><span id="l3.130">     // We are done with the LDAP search.</span>
<a href="#l3.131"></a><span id="l3.131">     // Release the control variable for the eventloop and other members</span>
<a href="#l3.132"></a><span id="l3.132" class="difflineminus">-    // </span>
<a href="#l3.133"></a><span id="l3.133" class="difflineplus">+    //</span>
<a href="#l3.134"></a><span id="l3.134">     FinishLDAPQuery();</span>
<a href="#l3.135"></a><span id="l3.135">     return NS_OK;</span>
<a href="#l3.136"></a><span id="l3.136"> }</span>
<a href="#l3.137"></a><span id="l3.137"> </span>
<a href="#l3.138"></a><span id="l3.138"> nsresult</span>
<a href="#l3.139"></a><span id="l3.139"> nsLDAPSyncQuery::StartLDAPSearch()</span>
<a href="#l3.140"></a><span id="l3.140"> {</span>
<a href="#l3.141"></a><span id="l3.141">     nsresult rv;</span>
<a href="#l3.142"></a><span id="l3.142">     // create and initialize an LDAP operation (to be used for the search</span>
<a href="#l3.143"></a><span id="l3.143" class="difflineminus">-    //  </span>
<a href="#l3.144"></a><span id="l3.144" class="difflineminus">-    mOperation = </span>
<a href="#l3.145"></a><span id="l3.145" class="difflineplus">+    //</span>
<a href="#l3.146"></a><span id="l3.146" class="difflineplus">+    mOperation =</span>
<a href="#l3.147"></a><span id="l3.147">         do_CreateInstance(&quot;@mozilla.org/network/ldap-operation;1&quot;, &amp;rv);</span>
<a href="#l3.148"></a><span id="l3.148"> </span>
<a href="#l3.149"></a><span id="l3.149">     if (NS_FAILED(rv)) {</span>
<a href="#l3.150"></a><span id="l3.150">         NS_ERROR(&quot;nsLDAPSyncQuery::StartLDAPSearch(): couldn't &quot;</span>
<a href="#l3.151"></a><span id="l3.151">                  &quot;create @mozilla.org/network/ldap-operation;1&quot;);</span>
<a href="#l3.152"></a><span id="l3.152">         FinishLDAPQuery();</span>
<a href="#l3.153"></a><span id="l3.153">         return NS_ERROR_FAILURE;</span>
<a href="#l3.154"></a><span id="l3.154">     }</span>
<a href="#l3.155"></a><span id="l3.155" class="difflineat">@@ -233,17 +233,17 @@ nsLDAPSyncQuery::StartLDAPSearch()</span>
<a href="#l3.156"></a><span id="l3.156">     rv = mOperation-&gt;Init(mConnection, this, nullptr);</span>
<a href="#l3.157"></a><span id="l3.157">     if (NS_FAILED(rv)) {</span>
<a href="#l3.158"></a><span id="l3.158">         NS_ERROR(&quot;nsLDAPSyncQuery::StartLDAPSearch(): couldn't &quot;</span>
<a href="#l3.159"></a><span id="l3.159">                  &quot;initialize LDAP operation&quot;);</span>
<a href="#l3.160"></a><span id="l3.160">         FinishLDAPQuery();</span>
<a href="#l3.161"></a><span id="l3.161">         return NS_ERROR_UNEXPECTED;</span>
<a href="#l3.162"></a><span id="l3.162">     }</span>
<a href="#l3.163"></a><span id="l3.163"> </span>
<a href="#l3.164"></a><span id="l3.164" class="difflineminus">-    // get the search filter associated with the directory server url; </span>
<a href="#l3.165"></a><span id="l3.165" class="difflineplus">+    // get the search filter associated with the directory server url;</span>
<a href="#l3.166"></a><span id="l3.166">     //</span>
<a href="#l3.167"></a><span id="l3.167">     nsAutoCString urlFilter;</span>
<a href="#l3.168"></a><span id="l3.168">     rv = mServerURL-&gt;GetFilter(urlFilter);</span>
<a href="#l3.169"></a><span id="l3.169">     if (NS_FAILED(rv)) {</span>
<a href="#l3.170"></a><span id="l3.170">         FinishLDAPQuery();</span>
<a href="#l3.171"></a><span id="l3.171">         return NS_ERROR_UNEXPECTED;</span>
<a href="#l3.172"></a><span id="l3.172">     }</span>
<a href="#l3.173"></a><span id="l3.173"> </span>
<a href="#l3.174"></a><span id="l3.174" class="difflineat">@@ -278,17 +278,17 @@ nsLDAPSyncQuery::StartLDAPSearch()</span>
<a href="#l3.175"></a><span id="l3.175">     if (NS_FAILED(rv)) {</span>
<a href="#l3.176"></a><span id="l3.176">         FinishLDAPQuery();</span>
<a href="#l3.177"></a><span id="l3.177">         return NS_ERROR_FAILURE;</span>
<a href="#l3.178"></a><span id="l3.178">     }</span>
<a href="#l3.179"></a><span id="l3.179"> </span>
<a href="#l3.180"></a><span id="l3.180">     return NS_OK;</span>
<a href="#l3.181"></a><span id="l3.181"> }</span>
<a href="#l3.182"></a><span id="l3.182"> </span>
<a href="#l3.183"></a><span id="l3.183" class="difflineminus">-// void initConnection (); </span>
<a href="#l3.184"></a><span id="l3.184" class="difflineplus">+// void initConnection ();</span>
<a href="#l3.185"></a><span id="l3.185"> //</span>
<a href="#l3.186"></a><span id="l3.186"> nsresult nsLDAPSyncQuery::InitConnection()</span>
<a href="#l3.187"></a><span id="l3.187"> {</span>
<a href="#l3.188"></a><span id="l3.188">     // Because mConnection-&gt;Init proxies back to the main thread, this</span>
<a href="#l3.189"></a><span id="l3.189">     // better be the main thread.</span>
<a href="#l3.190"></a><span id="l3.190">     NS_ENSURE_TRUE(NS_IsMainThread(), NS_ERROR_FAILURE);</span>
<a href="#l3.191"></a><span id="l3.191">     nsresult rv;        // temp for xpcom return values</span>
<a href="#l3.192"></a><span id="l3.192">     // create an LDAP connection</span>
<a href="#l3.193"></a><span id="l3.193" class="difflineat">@@ -318,62 +318,62 @@ nsresult nsLDAPSyncQuery::InitConnection</span>
<a href="#l3.194"></a><span id="l3.194">     }</span>
<a href="#l3.195"></a><span id="l3.195"> </span>
<a href="#l3.196"></a><span id="l3.196">     return NS_OK;</span>
<a href="#l3.197"></a><span id="l3.197"> }</span>
<a href="#l3.198"></a><span id="l3.198"> </span>
<a href="#l3.199"></a><span id="l3.199"> void</span>
<a href="#l3.200"></a><span id="l3.200"> nsLDAPSyncQuery::FinishLDAPQuery()</span>
<a href="#l3.201"></a><span id="l3.201"> {</span>
<a href="#l3.202"></a><span id="l3.202" class="difflineminus">-    // We are done with the LDAP operation. </span>
<a href="#l3.203"></a><span id="l3.203" class="difflineplus">+    // We are done with the LDAP operation.</span>
<a href="#l3.204"></a><span id="l3.204">     // Release the Control variable for the eventloop</span>
<a href="#l3.205"></a><span id="l3.205">     //</span>
<a href="#l3.206"></a><span id="l3.206">     mFinished = true;</span>
<a href="#l3.207"></a><span id="l3.207" class="difflineminus">-    </span>
<a href="#l3.208"></a><span id="l3.208" class="difflineplus">+</span>
<a href="#l3.209"></a><span id="l3.209">     // Release member variables</span>
<a href="#l3.210"></a><span id="l3.210">     //</span>
<a href="#l3.211"></a><span id="l3.211" class="difflineminus">-    mConnection = 0;</span>
<a href="#l3.212"></a><span id="l3.212" class="difflineminus">-    mOperation = 0;</span>
<a href="#l3.213"></a><span id="l3.213" class="difflineminus">-    mServerURL = 0;</span>
<a href="#l3.214"></a><span id="l3.214" class="difflineminus">- </span>
<a href="#l3.215"></a><span id="l3.215" class="difflineplus">+    mConnection = nullptr;</span>
<a href="#l3.216"></a><span id="l3.216" class="difflineplus">+    mOperation = nullptr;</span>
<a href="#l3.217"></a><span id="l3.217" class="difflineplus">+    mServerURL = nullptr;</span>
<a href="#l3.218"></a><span id="l3.218" class="difflineplus">+</span>
<a href="#l3.219"></a><span id="l3.219"> }</span>
<a href="#l3.220"></a><span id="l3.220"> </span>
<a href="#l3.221"></a><span id="l3.221"> /* wstring getQueryResults (in nsILDAPURL aServerURL, in unsigned long aVersion); */</span>
<a href="#l3.222"></a><span id="l3.222"> NS_IMETHODIMP nsLDAPSyncQuery::GetQueryResults(nsILDAPURL *aServerURL,</span>
<a href="#l3.223"></a><span id="l3.223">                                                uint32_t aProtocolVersion,</span>
<a href="#l3.224"></a><span id="l3.224">                                                char16_t **_retval)</span>
<a href="#l3.225"></a><span id="l3.225"> {</span>
<a href="#l3.226"></a><span id="l3.226">     nsresult rv;</span>
<a href="#l3.227"></a><span id="l3.227" class="difflineminus">-    </span>
<a href="#l3.228"></a><span id="l3.228" class="difflineplus">+</span>
<a href="#l3.229"></a><span id="l3.229">     if (!aServerURL) {</span>
<a href="#l3.230"></a><span id="l3.230">         NS_ERROR(&quot;nsLDAPSyncQuery::GetQueryResults() called without LDAP URL&quot;);</span>
<a href="#l3.231"></a><span id="l3.231">         return NS_ERROR_FAILURE;</span>
<a href="#l3.232"></a><span id="l3.232">     }</span>
<a href="#l3.233"></a><span id="l3.233">     mServerURL = aServerURL;</span>
<a href="#l3.234"></a><span id="l3.234">     mProtocolVersion = aProtocolVersion;</span>
<a href="#l3.235"></a><span id="l3.235"> </span>
<a href="#l3.236"></a><span id="l3.236">     nsCOMPtr&lt;nsIThread&gt; currentThread = do_GetCurrentThread();</span>
<a href="#l3.237"></a><span id="l3.237"> </span>
<a href="#l3.238"></a><span id="l3.238" class="difflineminus">-    // Start an LDAP query. </span>
<a href="#l3.239"></a><span id="l3.239" class="difflineminus">-    // InitConnection will bind to the ldap server and post a OnLDAPMessage </span>
<a href="#l3.240"></a><span id="l3.240" class="difflineminus">-    // event. This event will trigger a search and the whole operation will </span>
<a href="#l3.241"></a><span id="l3.241" class="difflineplus">+    // Start an LDAP query.</span>
<a href="#l3.242"></a><span id="l3.242" class="difflineplus">+    // InitConnection will bind to the ldap server and post a OnLDAPMessage</span>
<a href="#l3.243"></a><span id="l3.243" class="difflineplus">+    // event. This event will trigger a search and the whole operation will</span>
<a href="#l3.244"></a><span id="l3.244">     // be carried out by chain of events</span>
<a href="#l3.245"></a><span id="l3.245">     //</span>
<a href="#l3.246"></a><span id="l3.246">     rv = InitConnection();</span>
<a href="#l3.247"></a><span id="l3.247">     if (NS_FAILED(rv))</span>
<a href="#l3.248"></a><span id="l3.248">         return rv;</span>
<a href="#l3.249"></a><span id="l3.249" class="difflineminus">-    </span>
<a href="#l3.250"></a><span id="l3.250" class="difflineminus">-    // We want this LDAP query to be synchronous while the XPCOM LDAP is </span>
<a href="#l3.251"></a><span id="l3.251" class="difflineminus">-    // async in nature. So this eventQueue handling will wait for the </span>
<a href="#l3.252"></a><span id="l3.252" class="difflineminus">-    // LDAP operation to be finished. </span>
<a href="#l3.253"></a><span id="l3.253" class="difflineminus">-    // mFinished controls the state of the LDAP opertion. </span>
<a href="#l3.254"></a><span id="l3.254" class="difflineplus">+</span>
<a href="#l3.255"></a><span id="l3.255" class="difflineplus">+    // We want this LDAP query to be synchronous while the XPCOM LDAP is</span>
<a href="#l3.256"></a><span id="l3.256" class="difflineplus">+    // async in nature. So this eventQueue handling will wait for the</span>
<a href="#l3.257"></a><span id="l3.257" class="difflineplus">+    // LDAP operation to be finished.</span>
<a href="#l3.258"></a><span id="l3.258" class="difflineplus">+    // mFinished controls the state of the LDAP opertion.</span>
<a href="#l3.259"></a><span id="l3.259">     // It will be released in any case (success/failure)</span>
<a href="#l3.260"></a><span id="l3.260" class="difflineminus">-    </span>
<a href="#l3.261"></a><span id="l3.261" class="difflineminus">-    </span>
<a href="#l3.262"></a><span id="l3.262" class="difflineminus">-    // Run the event loop, </span>
<a href="#l3.263"></a><span id="l3.263" class="difflineplus">+</span>
<a href="#l3.264"></a><span id="l3.264" class="difflineplus">+</span>
<a href="#l3.265"></a><span id="l3.265" class="difflineplus">+    // Run the event loop,</span>
<a href="#l3.266"></a><span id="l3.266">     // mFinished is a control variable</span>
<a href="#l3.267"></a><span id="l3.267">     //</span>
<a href="#l3.268"></a><span id="l3.268">     while (!mFinished)</span>
<a href="#l3.269"></a><span id="l3.269">         NS_ENSURE_STATE(NS_ProcessNextEvent(currentThread));</span>
<a href="#l3.270"></a><span id="l3.270"> </span>
<a href="#l3.271"></a><span id="l3.271">     // Return results</span>
<a href="#l3.272"></a><span id="l3.272">     //</span>
<a href="#l3.273"></a><span id="l3.273">     if (!mResults.IsEmpty()) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPListenerBase.cpp</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPListenerBase.cpp</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -69,17 +69,17 @@ NS_IMETHODIMP nsAbLDAPListenerBase::OnLD</span>
<a href="#l4.4"></a><span id="l4.4">   }</span>
<a href="#l4.5"></a><span id="l4.5"> </span>
<a href="#l4.6"></a><span id="l4.6">   // If mLogin is set, we're expected to use it to get a password.</span>
<a href="#l4.7"></a><span id="l4.7">   //</span>
<a href="#l4.8"></a><span id="l4.8">   if (!mLogin.IsEmpty() &amp;&amp; !mSaslMechanism.EqualsLiteral(&quot;GSSAPI&quot;))</span>
<a href="#l4.9"></a><span id="l4.9">   {</span>
<a href="#l4.10"></a><span id="l4.10">     // get the string bundle service</span>
<a href="#l4.11"></a><span id="l4.11">     //</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-    nsCOMPtr&lt;nsIStringBundleService&gt; stringBundleSvc = </span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+    nsCOMPtr&lt;nsIStringBundleService&gt; stringBundleSvc =</span>
<a href="#l4.14"></a><span id="l4.14">       mozilla::services::GetStringBundleService();</span>
<a href="#l4.15"></a><span id="l4.15">     if (!stringBundleSvc)</span>
<a href="#l4.16"></a><span id="l4.16">     {</span>
<a href="#l4.17"></a><span id="l4.17">       NS_ERROR(&quot;nsAbLDAPListenerBase::OnLDAPInit():&quot;</span>
<a href="#l4.18"></a><span id="l4.18">                &quot; error getting string bundle service&quot;);</span>
<a href="#l4.19"></a><span id="l4.19">       InitFailed();</span>
<a href="#l4.20"></a><span id="l4.20">       return NS_ERROR_UNEXPECTED;</span>
<a href="#l4.21"></a><span id="l4.21">     }</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineat">@@ -118,17 +118,17 @@ NS_IMETHODIMP nsAbLDAPListenerBase::OnLD</span>
<a href="#l4.23"></a><span id="l4.23">     if (NS_FAILED(rv))</span>
<a href="#l4.24"></a><span id="l4.24">     {</span>
<a href="#l4.25"></a><span id="l4.25">       NS_ERROR(&quot;nsAbLDAPListenerBase::OnLDAPInit(): error getting ascii host&quot;</span>
<a href="#l4.26"></a><span id="l4.26">                &quot;name from directory url&quot;);</span>
<a href="#l4.27"></a><span id="l4.27">       InitFailed();</span>
<a href="#l4.28"></a><span id="l4.28">       return rv;</span>
<a href="#l4.29"></a><span id="l4.29">     }</span>
<a href="#l4.30"></a><span id="l4.30"> </span>
<a href="#l4.31"></a><span id="l4.31" class="difflineminus">-    // hostTemp is only necessary to work around a code-generation </span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+    // hostTemp is only necessary to work around a code-generation</span>
<a href="#l4.33"></a><span id="l4.33">     // bug in egcs 1.1.2 (the version of gcc that comes with Red Hat 6.2),</span>
<a href="#l4.34"></a><span id="l4.34">     // which is the default compiler for Mozilla on linux at the moment.</span>
<a href="#l4.35"></a><span id="l4.35">     //</span>
<a href="#l4.36"></a><span id="l4.36">     NS_ConvertASCIItoUTF16 hostTemp(host);</span>
<a href="#l4.37"></a><span id="l4.37">     const char16_t *hostArray[1] = { hostTemp.get() };</span>
<a href="#l4.38"></a><span id="l4.38"> </span>
<a href="#l4.39"></a><span id="l4.39">     // format the hostname into the authprompt text string</span>
<a href="#l4.40"></a><span id="l4.40">     //</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineat">@@ -169,17 +169,17 @@ NS_IMETHODIMP nsAbLDAPListenerBase::OnLD</span>
<a href="#l4.42"></a><span id="l4.42">       NS_ERROR(&quot;nsAbLDAPListenerBase::OnLDAPInit():&quot;</span>
<a href="#l4.43"></a><span id="l4.43">                &quot; error getting most recent window&quot;);</span>
<a href="#l4.44"></a><span id="l4.44">       InitFailed();</span>
<a href="#l4.45"></a><span id="l4.45">       return rv;</span>
<a href="#l4.46"></a><span id="l4.46">     }</span>
<a href="#l4.47"></a><span id="l4.47"> </span>
<a href="#l4.48"></a><span id="l4.48">     // get the window watcher service, so we can get an auth prompter</span>
<a href="#l4.49"></a><span id="l4.49">     //</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineminus">-    nsCOMPtr&lt;nsIWindowWatcher&gt; windowWatcherSvc = </span>
<a href="#l4.51"></a><span id="l4.51" class="difflineplus">+    nsCOMPtr&lt;nsIWindowWatcher&gt; windowWatcherSvc =</span>
<a href="#l4.52"></a><span id="l4.52">       do_GetService(NS_WINDOWWATCHER_CONTRACTID, &amp;rv);</span>
<a href="#l4.53"></a><span id="l4.53">     if (NS_FAILED(rv))</span>
<a href="#l4.54"></a><span id="l4.54">     {</span>
<a href="#l4.55"></a><span id="l4.55">       NS_ERROR(&quot;nsAbLDAPListenerBase::OnLDAPInit():&quot;</span>
<a href="#l4.56"></a><span id="l4.56">                &quot; couldn't get window watcher service.&quot;);</span>
<a href="#l4.57"></a><span id="l4.57">       InitFailed();</span>
<a href="#l4.58"></a><span id="l4.58">       return rv;</span>
<a href="#l4.59"></a><span id="l4.59">     }</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineat">@@ -194,17 +194,17 @@ NS_IMETHODIMP nsAbLDAPListenerBase::OnLD</span>
<a href="#l4.61"></a><span id="l4.61">       NS_ERROR(&quot;nsAbLDAPMessageBase::OnLDAPInit():&quot;</span>
<a href="#l4.62"></a><span id="l4.62">                &quot; error getting auth prompter&quot;);</span>
<a href="#l4.63"></a><span id="l4.63">       InitFailed();</span>
<a href="#l4.64"></a><span id="l4.64">       return rv;</span>
<a href="#l4.65"></a><span id="l4.65">     }</span>
<a href="#l4.66"></a><span id="l4.66"> </span>
<a href="#l4.67"></a><span id="l4.67">     // get authentication password, prompting the user if necessary</span>
<a href="#l4.68"></a><span id="l4.68">     //</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineminus">-    // we're going to use the URL spec of the server as the &quot;realm&quot; for </span>
<a href="#l4.70"></a><span id="l4.70" class="difflineplus">+    // we're going to use the URL spec of the server as the &quot;realm&quot; for</span>
<a href="#l4.71"></a><span id="l4.71">     // wallet to remember the password by / for.</span>
<a href="#l4.72"></a><span id="l4.72"> </span>
<a href="#l4.73"></a><span id="l4.73">     // Get the specification</span>
<a href="#l4.74"></a><span id="l4.74">     nsCString spec;</span>
<a href="#l4.75"></a><span id="l4.75">     rv = mDirectoryUrl-&gt;GetSpec(spec);</span>
<a href="#l4.76"></a><span id="l4.76">     if (NS_FAILED(rv))</span>
<a href="#l4.77"></a><span id="l4.77">     {</span>
<a href="#l4.78"></a><span id="l4.78">       NS_ERROR(&quot;nsAbLDAPMessageBase::OnLDAPInit():&quot;</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineat">@@ -264,28 +264,28 @@ NS_IMETHODIMP nsAbLDAPListenerBase::OnLD</span>
<a href="#l4.80"></a><span id="l4.80">       do_CreateInstance(NS_AUTH_MODULE_CONTRACTID_PREFIX &quot;sasl-gssapi&quot;, &amp;rv);</span>
<a href="#l4.81"></a><span id="l4.81">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.82"></a><span id="l4.82"> </span>
<a href="#l4.83"></a><span id="l4.83">     rv = mOperation-&gt;SaslBind(service, mSaslMechanism, authModule);</span>
<a href="#l4.84"></a><span id="l4.84">     if (NS_FAILED(rv))</span>
<a href="#l4.85"></a><span id="l4.85">     {</span>
<a href="#l4.86"></a><span id="l4.86">       NS_ERROR(&quot;nsAbLDAPMessageBase::OnLDAPInit(): &quot;</span>
<a href="#l4.87"></a><span id="l4.87">                &quot;failed to perform GSSAPI bind&quot;);</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineminus">-      mOperation = 0; // Break Listener -&gt; Operation -&gt; Listener ref cycle</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineplus">+      mOperation = nullptr; // Break Listener -&gt; Operation -&gt; Listener ref cycle</span>
<a href="#l4.90"></a><span id="l4.90">       InitFailed();</span>
<a href="#l4.91"></a><span id="l4.91">     }</span>
<a href="#l4.92"></a><span id="l4.92">     return rv;</span>
<a href="#l4.93"></a><span id="l4.93">   }</span>
<a href="#l4.94"></a><span id="l4.94"> </span>
<a href="#l4.95"></a><span id="l4.95">   // Bind</span>
<a href="#l4.96"></a><span id="l4.96">   rv = mOperation-&gt;SimpleBind(NS_ConvertUTF16toUTF8(passwd));</span>
<a href="#l4.97"></a><span id="l4.97">   if (NS_FAILED(rv))</span>
<a href="#l4.98"></a><span id="l4.98">   {</span>
<a href="#l4.99"></a><span id="l4.99">     NS_ERROR(&quot;nsAbLDAPMessageBase::OnLDAPInit(): failed to perform bind operation&quot;);</span>
<a href="#l4.100"></a><span id="l4.100" class="difflineminus">-    mOperation = 0; // Break Listener-&gt;Operation-&gt;Listener reference cycle</span>
<a href="#l4.101"></a><span id="l4.101" class="difflineplus">+    mOperation = nullptr; // Break Listener-&gt;Operation-&gt;Listener reference cycle</span>
<a href="#l4.102"></a><span id="l4.102">     InitFailed();</span>
<a href="#l4.103"></a><span id="l4.103">   }</span>
<a href="#l4.104"></a><span id="l4.104">   return rv;</span>
<a href="#l4.105"></a><span id="l4.105"> }</span>
<a href="#l4.106"></a><span id="l4.106"> </span>
<a href="#l4.107"></a><span id="l4.107"> nsresult nsAbLDAPListenerBase::OnLDAPMessageBind(nsILDAPMessage *aMessage)</span>
<a href="#l4.108"></a><span id="l4.108"> {</span>
<a href="#l4.109"></a><span id="l4.109">   if (mBound)</span>
<a href="#l4.110"></a><span id="l4.110" class="difflineat">@@ -337,17 +337,17 @@ nsresult nsAbLDAPListenerBase::OnLDAPMes</span>
<a href="#l4.111"></a><span id="l4.111">         {</span>
<a href="#l4.112"></a><span id="l4.112">           NS_FREE_XPCOM_ISUPPORTS_POINTER_ARRAY(count, logins);</span>
<a href="#l4.113"></a><span id="l4.113">           return rv;</span>
<a href="#l4.114"></a><span id="l4.114">         }</span>
<a href="#l4.115"></a><span id="l4.115">       }</span>
<a href="#l4.116"></a><span id="l4.116">       NS_FREE_XPCOM_ISUPPORTS_POINTER_ARRAY(count, logins);</span>
<a href="#l4.117"></a><span id="l4.117"> </span>
<a href="#l4.118"></a><span id="l4.118">       // XXX We should probably pop up an error dialog telling</span>
<a href="#l4.119"></a><span id="l4.119" class="difflineminus">-      // the user that the login failed here, rather than just bringing </span>
<a href="#l4.120"></a><span id="l4.120" class="difflineplus">+      // the user that the login failed here, rather than just bringing</span>
<a href="#l4.121"></a><span id="l4.121">       // up the password dialog again, which is what calling OnLDAPInit()</span>
<a href="#l4.122"></a><span id="l4.122">       // does.</span>
<a href="#l4.123"></a><span id="l4.123">       return OnLDAPInit(nullptr, NS_OK);</span>
<a href="#l4.124"></a><span id="l4.124">     }</span>
<a href="#l4.125"></a><span id="l4.125"> </span>
<a href="#l4.126"></a><span id="l4.126">     // Don't know how to handle this, so use the message error code in</span>
<a href="#l4.127"></a><span id="l4.127">     // the failure return value so we hopefully get it back to the UI.</span>
<a href="#l4.128"></a><span id="l4.128">     return NS_ERROR_GENERATE_FAILURE(NS_ERROR_MODULE_LDAP, errCode);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/base/util/nsMsgIncomingServer.cpp</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgIncomingServer.cpp</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -48,25 +48,25 @@</span>
<a href="#l5.4"></a><span id="l5.4"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l5.5"></a><span id="l5.5"> #include &quot;nsIMsgFilter.h&quot;</span>
<a href="#l5.6"></a><span id="l5.6"> #include &quot;nsIArray.h&quot;</span>
<a href="#l5.7"></a><span id="l5.7"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l5.8"></a><span id="l5.8"> </span>
<a href="#l5.9"></a><span id="l5.9"> #define PORT_NOT_SET -1</span>
<a href="#l5.10"></a><span id="l5.10"> </span>
<a href="#l5.11"></a><span id="l5.11"> nsMsgIncomingServer::nsMsgIncomingServer():</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-    m_rootFolder(0),</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+    m_rootFolder(nullptr),</span>
<a href="#l5.14"></a><span id="l5.14">     m_downloadedHdrs(50),</span>
<a href="#l5.15"></a><span id="l5.15">     m_numMsgsDownloaded(0),</span>
<a href="#l5.16"></a><span id="l5.16">     m_biffState(nsIMsgFolder::nsMsgBiffState_Unknown),</span>
<a href="#l5.17"></a><span id="l5.17">     m_serverBusy(false),</span>
<a href="#l5.18"></a><span id="l5.18">     m_canHaveFilters(true),</span>
<a href="#l5.19"></a><span id="l5.19">     m_displayStartupPage(true),</span>
<a href="#l5.20"></a><span id="l5.20">     mPerformingBiff(false)</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineminus">-{ </span>
<a href="#l5.22"></a><span id="l5.22" class="difflineplus">+{</span>
<a href="#l5.23"></a><span id="l5.23"> }</span>
<a href="#l5.24"></a><span id="l5.24"> </span>
<a href="#l5.25"></a><span id="l5.25"> nsMsgIncomingServer::~nsMsgIncomingServer()</span>
<a href="#l5.26"></a><span id="l5.26"> {</span>
<a href="#l5.27"></a><span id="l5.27"> }</span>
<a href="#l5.28"></a><span id="l5.28"> </span>
<a href="#l5.29"></a><span id="l5.29"> NS_IMPL_ISUPPORTS(nsMsgIncomingServer, nsIMsgIncomingServer,</span>
<a href="#l5.30"></a><span id="l5.30">   nsISupportsWeakReference)</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineat">@@ -909,17 +909,17 @@ nsMsgIncomingServer::GetLocalPath(nsIFil</span>
<a href="#l5.32"></a><span id="l5.32">   rv = localPath-&gt;Create(nsIFile::DIRECTORY_TYPE, 0755);</span>
<a href="#l5.33"></a><span id="l5.33">   if (rv == NS_ERROR_FILE_ALREADY_EXISTS)</span>
<a href="#l5.34"></a><span id="l5.34">     rv = NS_OK;</span>
<a href="#l5.35"></a><span id="l5.35">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.36"></a><span id="l5.36"> </span>
<a href="#l5.37"></a><span id="l5.37">   nsCString hostname;</span>
<a href="#l5.38"></a><span id="l5.38">   rv = GetHostName(hostname);</span>
<a href="#l5.39"></a><span id="l5.39">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineminus">-  </span>
<a href="#l5.41"></a><span id="l5.41" class="difflineplus">+</span>
<a href="#l5.42"></a><span id="l5.42">   // set the leaf name to &quot;dummy&quot;, and then call MakeUnique with a suggested leaf name</span>
<a href="#l5.43"></a><span id="l5.43">   rv = localPath-&gt;AppendNative(hostname);</span>
<a href="#l5.44"></a><span id="l5.44">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.45"></a><span id="l5.45">   rv = localPath-&gt;CreateUnique(nsIFile::DIRECTORY_TYPE, 0755);</span>
<a href="#l5.46"></a><span id="l5.46">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.47"></a><span id="l5.47"> </span>
<a href="#l5.48"></a><span id="l5.48">   rv = SetLocalPath(localPath);</span>
<a href="#l5.49"></a><span id="l5.49">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineat">@@ -1305,17 +1305,17 @@ nsMsgIncomingServer::GetHostName(nsACStr</span>
<a href="#l5.51"></a><span id="l5.51"> </span>
<a href="#l5.52"></a><span id="l5.52"> NS_IMETHODIMP</span>
<a href="#l5.53"></a><span id="l5.53"> nsMsgIncomingServer::GetRealHostName(nsACString&amp; aResult)</span>
<a href="#l5.54"></a><span id="l5.54"> {</span>
<a href="#l5.55"></a><span id="l5.55">   // If 'realhostname' is set (was changed) then use it, otherwise use 'hostname'</span>
<a href="#l5.56"></a><span id="l5.56">   nsresult rv;</span>
<a href="#l5.57"></a><span id="l5.57">   rv = GetCharValue(&quot;realhostname&quot;, aResult);</span>
<a href="#l5.58"></a><span id="l5.58">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineminus">-  </span>
<a href="#l5.60"></a><span id="l5.60" class="difflineplus">+</span>
<a href="#l5.61"></a><span id="l5.61">   if (aResult.IsEmpty())</span>
<a href="#l5.62"></a><span id="l5.62">     return GetHostName(aResult);</span>
<a href="#l5.63"></a><span id="l5.63"> </span>
<a href="#l5.64"></a><span id="l5.64">   if (MsgCountChar(aResult, ':') == 1)</span>
<a href="#l5.65"></a><span id="l5.65">   {</span>
<a href="#l5.66"></a><span id="l5.66">     SetRealHostName(aResult);</span>
<a href="#l5.67"></a><span id="l5.67">     rv = GetCharValue(&quot;realhostname&quot;, aResult);</span>
<a href="#l5.68"></a><span id="l5.68">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/base/util/nsMsgProtocol.cpp</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgProtocol.cpp</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -250,20 +250,20 @@ nsresult nsMsgProtocol::CloseSocket()</span>
<a href="#l6.4"></a><span id="l6.4">     if (strans) {</span>
<a href="#l6.5"></a><span id="l6.5">       strans-&gt;SetEventSink(nullptr, nullptr); // break cyclic reference!</span>
<a href="#l6.6"></a><span id="l6.6">     }</span>
<a href="#l6.7"></a><span id="l6.7">   }</span>
<a href="#l6.8"></a><span id="l6.8">   // we need to call Cancel so that we remove the socket transport from the mActiveTransportList.  see bug #30648</span>
<a href="#l6.9"></a><span id="l6.9">   if (m_request) {</span>
<a href="#l6.10"></a><span id="l6.10">     rv = m_request-&gt;Cancel(NS_BINDING_ABORTED);</span>
<a href="#l6.11"></a><span id="l6.11">   }</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-  m_request = 0;</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+  m_request = nullptr;</span>
<a href="#l6.14"></a><span id="l6.14">   if (m_transport) {</span>
<a href="#l6.15"></a><span id="l6.15">     m_transport-&gt;Close(NS_BINDING_ABORTED);</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineminus">-    m_transport = 0;</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+    m_transport = nullptr;</span>
<a href="#l6.18"></a><span id="l6.18">   }</span>
<a href="#l6.19"></a><span id="l6.19"> </span>
<a href="#l6.20"></a><span id="l6.20">   return rv;</span>
<a href="#l6.21"></a><span id="l6.21"> }</span>
<a href="#l6.22"></a><span id="l6.22"> </span>
<a href="#l6.23"></a><span id="l6.23"> /*</span>
<a href="#l6.24"></a><span id="l6.24"> * Writes the data contained in dataBuffer into the current output stream. It also informs</span>
<a href="#l6.25"></a><span id="l6.25"> * the transport layer that this data is now available for transmission.</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineat">@@ -387,18 +387,18 @@ NS_IMETHODIMP nsMsgProtocol::OnStopReque</span>
<a href="#l6.27"></a><span id="l6.27">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.28"></a><span id="l6.28"> </span>
<a href="#l6.29"></a><span id="l6.29">         rv = mailSession-&gt;AlertUser(errorMsg, msgUrl);</span>
<a href="#l6.30"></a><span id="l6.30">       }</span>
<a href="#l6.31"></a><span id="l6.31">     } // if we got an error code</span>
<a href="#l6.32"></a><span id="l6.32">   } // if we have a mailnews url.</span>
<a href="#l6.33"></a><span id="l6.33"> </span>
<a href="#l6.34"></a><span id="l6.34">   // Drop notification callbacks to prevent cycles.</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineminus">-  mCallbacks = 0;</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineminus">-  mProgressEventSink = 0;</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineplus">+  mCallbacks = nullptr;</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineplus">+  mProgressEventSink = nullptr;</span>
<a href="#l6.39"></a><span id="l6.39">   // Call CloseSocket(), in case we got here because the server dropped the</span>
<a href="#l6.40"></a><span id="l6.40">   // connection while reading, and we never get a chance to get back into</span>
<a href="#l6.41"></a><span id="l6.41">   // the protocol state machine via OnDataAvailable.</span>
<a href="#l6.42"></a><span id="l6.42">   if (m_socketIsOpen)</span>
<a href="#l6.43"></a><span id="l6.43">     CloseSocket();</span>
<a href="#l6.44"></a><span id="l6.44"> </span>
<a href="#l6.45"></a><span id="l6.45">   return rv;</span>
<a href="#l6.46"></a><span id="l6.46"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgSend.cpp</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgSend.cpp</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -937,17 +937,17 @@ nsMsgComposeAndSend::GatherMimeAttachmen</span>
<a href="#l7.4"></a><span id="l7.4">   status = toppart-&gt;Write();</span>
<a href="#l7.5"></a><span id="l7.5">   if (NS_FAILED(status))</span>
<a href="#l7.6"></a><span id="l7.6">     goto FAIL;</span>
<a href="#l7.7"></a><span id="l7.7"> </span>
<a href="#l7.8"></a><span id="l7.8">   /* Close down encryption stream */</span>
<a href="#l7.9"></a><span id="l7.9">   if (m_crypto_closure)</span>
<a href="#l7.10"></a><span id="l7.10">   {</span>
<a href="#l7.11"></a><span id="l7.11">     status = m_crypto_closure-&gt;FinishCryptoEncapsulation(false, mSendReport);</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-    m_crypto_closure = 0;</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+    m_crypto_closure = nullptr;</span>
<a href="#l7.14"></a><span id="l7.14">     if (NS_FAILED(status)) goto FAIL;</span>
<a href="#l7.15"></a><span id="l7.15">   }</span>
<a href="#l7.16"></a><span id="l7.16"> </span>
<a href="#l7.17"></a><span id="l7.17">   if (mOutputFile)</span>
<a href="#l7.18"></a><span id="l7.18">   {</span>
<a href="#l7.19"></a><span id="l7.19">     if (NS_FAILED(mOutputFile-&gt;Flush()))</span>
<a href="#l7.20"></a><span id="l7.20">     {</span>
<a href="#l7.21"></a><span id="l7.21">       status = NS_MSG_ERROR_WRITING_FILE;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/extensions/smime/src/nsMsgComposeSecure.cpp</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/extensions/smime/src/nsMsgComposeSecure.cpp</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -681,17 +681,17 @@ nsresult nsMsgComposeSecure::MimeFinishM</span>
<a href="#l8.4"></a><span id="l8.4">   NS_ConvertUTF16toUTF8 sig_content_desc_utf8(mime_smime_sig_content_desc);</span>
<a href="#l8.5"></a><span id="l8.5"> </span>
<a href="#l8.6"></a><span id="l8.6">   /* Compute the hash...</span>
<a href="#l8.7"></a><span id="l8.7">    */</span>
<a href="#l8.8"></a><span id="l8.8"> </span>
<a href="#l8.9"></a><span id="l8.9">   nsAutoCString hashString;</span>
<a href="#l8.10"></a><span id="l8.10">   mDataHash-&gt;Finish(false, hashString);</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-  mDataHash = 0;</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+  mDataHash = nullptr;</span>
<a href="#l8.14"></a><span id="l8.14"> </span>
<a href="#l8.15"></a><span id="l8.15">   status = PR_GetError();</span>
<a href="#l8.16"></a><span id="l8.16">   if (status &lt; 0) goto FAIL;</span>
<a href="#l8.17"></a><span id="l8.17"> </span>
<a href="#l8.18"></a><span id="l8.18">   /* Write out the headers for the signature.</span>
<a href="#l8.19"></a><span id="l8.19">    */</span>
<a href="#l8.20"></a><span id="l8.20">   uint32_t L;</span>
<a href="#l8.21"></a><span id="l8.21">   header =</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineat">@@ -833,24 +833,24 @@ nsresult nsMsgComposeSecure::MimeFinishE</span>
<a href="#l8.23"></a><span id="l8.23">   }</span>
<a href="#l8.24"></a><span id="l8.24"> </span>
<a href="#l8.25"></a><span id="l8.25">   rv = mEncryptionContext-&gt;Finish();</span>
<a href="#l8.26"></a><span id="l8.26">   if (NS_FAILED(rv)) {</span>
<a href="#l8.27"></a><span id="l8.27">     SetError(sendReport, u&quot;ErrorEncryptMail&quot;);</span>
<a href="#l8.28"></a><span id="l8.28">     goto FAIL;</span>
<a href="#l8.29"></a><span id="l8.29">   }</span>
<a href="#l8.30"></a><span id="l8.30"> </span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-  mEncryptionContext = 0;</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+  mEncryptionContext = nullptr;</span>
<a href="#l8.33"></a><span id="l8.33"> </span>
<a href="#l8.34"></a><span id="l8.34">   PR_ASSERT(mEncryptionCinfo);</span>
<a href="#l8.35"></a><span id="l8.35">   if (!mEncryptionCinfo) {</span>
<a href="#l8.36"></a><span id="l8.36">     rv = NS_ERROR_FAILURE;</span>
<a href="#l8.37"></a><span id="l8.37">   }</span>
<a href="#l8.38"></a><span id="l8.38">   if (mEncryptionCinfo) {</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineminus">-    mEncryptionCinfo = 0;</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineplus">+    mEncryptionCinfo = nullptr;</span>
<a href="#l8.41"></a><span id="l8.41">   }</span>
<a href="#l8.42"></a><span id="l8.42"> </span>
<a href="#l8.43"></a><span id="l8.43">   // Shut down the base64 encoder.</span>
<a href="#l8.44"></a><span id="l8.44">   mCryptoEncoder-&gt;Flush();</span>
<a href="#l8.45"></a><span id="l8.45">   mCryptoEncoder = nullptr;</span>
<a href="#l8.46"></a><span id="l8.46"> </span>
<a href="#l8.47"></a><span id="l8.47">   uint32_t n;</span>
<a href="#l8.48"></a><span id="l8.48">   rv = mStream-&gt;Write(CRLF, 2, &amp;n);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/local/src/nsMailboxProtocol.cpp</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/local/src/nsMailboxProtocol.cpp</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -54,17 +54,17 @@ nsMailboxProtocol::nsMailboxProtocol(nsI</span>
<a href="#l9.4"></a><span id="l9.4"> </span>
<a href="#l9.5"></a><span id="l9.5">   // initialize the pr log if it hasn't been initialiezed already</span>
<a href="#l9.6"></a><span id="l9.6">   if (!MAILBOX)</span>
<a href="#l9.7"></a><span id="l9.7">     MAILBOX = PR_NewLogModule(&quot;MAILBOX&quot;);</span>
<a href="#l9.8"></a><span id="l9.8"> }</span>
<a href="#l9.9"></a><span id="l9.9"> </span>
<a href="#l9.10"></a><span id="l9.10"> nsMailboxProtocol::~nsMailboxProtocol()</span>
<a href="#l9.11"></a><span id="l9.11"> {</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-  // free our local state </span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+  // free our local state</span>
<a href="#l9.14"></a><span id="l9.14">   delete m_lineStreamBuffer;</span>
<a href="#l9.15"></a><span id="l9.15"> }</span>
<a href="#l9.16"></a><span id="l9.16"> </span>
<a href="#l9.17"></a><span id="l9.17"> nsresult nsMailboxProtocol::OpenMultipleMsgTransport(uint64_t offset, int32_t size)</span>
<a href="#l9.18"></a><span id="l9.18"> {</span>
<a href="#l9.19"></a><span id="l9.19">   nsresult rv;</span>
<a href="#l9.20"></a><span id="l9.20"> </span>
<a href="#l9.21"></a><span id="l9.21">   nsCOMPtr&lt;nsIStreamTransportService&gt; serv =</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineat">@@ -84,17 +84,17 @@ nsresult nsMailboxProtocol::Initialize(n</span>
<a href="#l9.23"></a><span id="l9.23">   NS_PRECONDITION(aURL, &quot;invalid URL passed into MAILBOX Protocol&quot;);</span>
<a href="#l9.24"></a><span id="l9.24">   nsresult rv = NS_OK;</span>
<a href="#l9.25"></a><span id="l9.25">   if (aURL)</span>
<a href="#l9.26"></a><span id="l9.26">   {</span>
<a href="#l9.27"></a><span id="l9.27">     rv = aURL-&gt;QueryInterface(NS_GET_IID(nsIMailboxUrl), (void **) getter_AddRefs(m_runningUrl));</span>
<a href="#l9.28"></a><span id="l9.28">     if (NS_SUCCEEDED(rv) &amp;&amp; m_runningUrl)</span>
<a href="#l9.29"></a><span id="l9.29">     {</span>
<a href="#l9.30"></a><span id="l9.30">       nsCOMPtr &lt;nsIMsgWindow&gt; window;</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineminus">-      rv = m_runningUrl-&gt;GetMailboxAction(&amp;m_mailboxAction); </span>
<a href="#l9.32"></a><span id="l9.32" class="difflineplus">+      rv = m_runningUrl-&gt;GetMailboxAction(&amp;m_mailboxAction);</span>
<a href="#l9.33"></a><span id="l9.33">       // clear stopped flag on msg window, because we care.</span>
<a href="#l9.34"></a><span id="l9.34">       nsCOMPtr &lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(m_runningUrl);</span>
<a href="#l9.35"></a><span id="l9.35">       if (mailnewsUrl)</span>
<a href="#l9.36"></a><span id="l9.36">       {</span>
<a href="#l9.37"></a><span id="l9.37">         mailnewsUrl-&gt;GetMsgWindow(getter_AddRefs(window));</span>
<a href="#l9.38"></a><span id="l9.38">         if (window)</span>
<a href="#l9.39"></a><span id="l9.39">           window-&gt;SetStopped(false);</span>
<a href="#l9.40"></a><span id="l9.40">       }</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineat">@@ -170,30 +170,30 @@ nsresult nsMailboxProtocol::Initialize(n</span>
<a href="#l9.42"></a><span id="l9.42">           }</span>
<a href="#l9.43"></a><span id="l9.43">           if (!folder) // must be a .eml file</span>
<a href="#l9.44"></a><span id="l9.44">             rv = OpenFileSocket(aURL, 0, aMsgSize);</span>
<a href="#l9.45"></a><span id="l9.45">         }</span>
<a href="#l9.46"></a><span id="l9.46">         NS_ASSERTION(NS_SUCCEEDED(rv), &quot;oops....i messed something up&quot;);</span>
<a href="#l9.47"></a><span id="l9.47">       }</span>
<a href="#l9.48"></a><span id="l9.48">     }</span>
<a href="#l9.49"></a><span id="l9.49">   }</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineminus">-  </span>
<a href="#l9.51"></a><span id="l9.51" class="difflineplus">+</span>
<a href="#l9.52"></a><span id="l9.52">   m_lineStreamBuffer = new nsMsgLineStreamBuffer(OUTPUT_BUFFER_SIZE, true);</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineminus">-  </span>
<a href="#l9.54"></a><span id="l9.54" class="difflineplus">+</span>
<a href="#l9.55"></a><span id="l9.55">   m_nextState = MAILBOX_READ_FOLDER;</span>
<a href="#l9.56"></a><span id="l9.56">   m_initialState = MAILBOX_READ_FOLDER;</span>
<a href="#l9.57"></a><span id="l9.57">   mCurrentProgress = 0;</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineminus">-  </span>
<a href="#l9.59"></a><span id="l9.59" class="difflineplus">+</span>
<a href="#l9.60"></a><span id="l9.60">   // do we really need both?</span>
<a href="#l9.61"></a><span id="l9.61">   m_tempMessageFile = m_tempMsgFile;</span>
<a href="#l9.62"></a><span id="l9.62">   return rv;</span>
<a href="#l9.63"></a><span id="l9.63"> }</span>
<a href="#l9.64"></a><span id="l9.64"> </span>
<a href="#l9.65"></a><span id="l9.65"> /////////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineminus">-// we suppport the nsIStreamListener interface </span>
<a href="#l9.67"></a><span id="l9.67" class="difflineplus">+// we suppport the nsIStreamListener interface</span>
<a href="#l9.68"></a><span id="l9.68"> ////////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l9.69"></a><span id="l9.69"> </span>
<a href="#l9.70"></a><span id="l9.70"> NS_IMETHODIMP nsMailboxProtocol::OnStartRequest(nsIRequest *request, nsISupports *ctxt)</span>
<a href="#l9.71"></a><span id="l9.71"> {</span>
<a href="#l9.72"></a><span id="l9.72">   // extract the appropriate event sinks from the url and initialize them in our protocol data</span>
<a href="#l9.73"></a><span id="l9.73">   // the URL should be queried for a nsINewsURL. If it doesn't support a news URL interface then</span>
<a href="#l9.74"></a><span id="l9.74">   // we have an error.</span>
<a href="#l9.75"></a><span id="l9.75">   if (m_nextState == MAILBOX_READ_FOLDER &amp;&amp; m_mailboxParser)</span>
<a href="#l9.76"></a><span id="l9.76" class="difflineat">@@ -211,42 +211,42 @@ bool nsMailboxProtocol::RunningMultipleM</span>
<a href="#l9.77"></a><span id="l9.77">     uint32_t numMoveCopyMsgs;</span>
<a href="#l9.78"></a><span id="l9.78">     nsresult rv = m_runningUrl-&gt;GetNumMoveCopyMsgs(&amp;numMoveCopyMsgs);</span>
<a href="#l9.79"></a><span id="l9.79">     if (NS_SUCCEEDED(rv) &amp;&amp; numMoveCopyMsgs &gt; 1)</span>
<a href="#l9.80"></a><span id="l9.80">       return true;</span>
<a href="#l9.81"></a><span id="l9.81">   }</span>
<a href="#l9.82"></a><span id="l9.82">   return false;</span>
<a href="#l9.83"></a><span id="l9.83"> }</span>
<a href="#l9.84"></a><span id="l9.84"> </span>
<a href="#l9.85"></a><span id="l9.85" class="difflineminus">-// stop binding is a &quot;notification&quot; informing us that the stream associated with aURL is going away. </span>
<a href="#l9.86"></a><span id="l9.86" class="difflineplus">+// stop binding is a &quot;notification&quot; informing us that the stream associated with aURL is going away.</span>
<a href="#l9.87"></a><span id="l9.87"> NS_IMETHODIMP nsMailboxProtocol::OnStopRequest(nsIRequest *request, nsISupports *ctxt, nsresult aStatus)</span>
<a href="#l9.88"></a><span id="l9.88"> {</span>
<a href="#l9.89"></a><span id="l9.89">   nsresult rv;</span>
<a href="#l9.90"></a><span id="l9.90">   if (m_nextState == MAILBOX_READ_FOLDER &amp;&amp; m_mailboxParser)</span>
<a href="#l9.91"></a><span id="l9.91">   {</span>
<a href="#l9.92"></a><span id="l9.92">     // we need to inform our mailbox parser that there is no more incoming data...</span>
<a href="#l9.93"></a><span id="l9.93">     m_mailboxParser-&gt;OnStopRequest(request, ctxt, aStatus);</span>
<a href="#l9.94"></a><span id="l9.94">   }</span>
<a href="#l9.95"></a><span id="l9.95" class="difflineminus">-  else if (m_nextState == MAILBOX_READ_MESSAGE) </span>
<a href="#l9.96"></a><span id="l9.96" class="difflineplus">+  else if (m_nextState == MAILBOX_READ_MESSAGE)</span>
<a href="#l9.97"></a><span id="l9.97">   {</span>
<a href="#l9.98"></a><span id="l9.98">     DoneReadingMessage();</span>
<a href="#l9.99"></a><span id="l9.99">   }</span>
<a href="#l9.100"></a><span id="l9.100">   // I'm not getting cancel status - maybe the load group still has the status.</span>
<a href="#l9.101"></a><span id="l9.101">   bool stopped = false;</span>
<a href="#l9.102"></a><span id="l9.102">   if (m_runningUrl)</span>
<a href="#l9.103"></a><span id="l9.103">   {</span>
<a href="#l9.104"></a><span id="l9.104">     nsCOMPtr &lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(m_runningUrl);</span>
<a href="#l9.105"></a><span id="l9.105">     if (mailnewsUrl)</span>
<a href="#l9.106"></a><span id="l9.106">     {</span>
<a href="#l9.107"></a><span id="l9.107">       nsCOMPtr &lt;nsIMsgWindow&gt; window;</span>
<a href="#l9.108"></a><span id="l9.108">       mailnewsUrl-&gt;GetMsgWindow(getter_AddRefs(window));</span>
<a href="#l9.109"></a><span id="l9.109">       if (window)</span>
<a href="#l9.110"></a><span id="l9.110">         window-&gt;GetStopped(&amp;stopped);</span>
<a href="#l9.111"></a><span id="l9.111">     }</span>
<a href="#l9.112"></a><span id="l9.112" class="difflineminus">-    </span>
<a href="#l9.113"></a><span id="l9.113" class="difflineplus">+</span>
<a href="#l9.114"></a><span id="l9.114">     if (!stopped &amp;&amp; NS_SUCCEEDED(aStatus) &amp;&amp; (m_mailboxAction == nsIMailboxUrl::ActionCopyMessage || m_mailboxAction == nsIMailboxUrl::ActionMoveMessage))</span>
<a href="#l9.115"></a><span id="l9.115">     {</span>
<a href="#l9.116"></a><span id="l9.116">       uint32_t numMoveCopyMsgs;</span>
<a href="#l9.117"></a><span id="l9.117">       uint32_t curMoveCopyMsgIndex;</span>
<a href="#l9.118"></a><span id="l9.118">       rv = m_runningUrl-&gt;GetNumMoveCopyMsgs(&amp;numMoveCopyMsgs);</span>
<a href="#l9.119"></a><span id="l9.119">       if (NS_SUCCEEDED(rv) &amp;&amp; numMoveCopyMsgs &gt; 0)</span>
<a href="#l9.120"></a><span id="l9.120">       {</span>
<a href="#l9.121"></a><span id="l9.121">         m_runningUrl-&gt;GetCurMoveCopyMsgIndex(&amp;curMoveCopyMsgIndex);</span>
<a href="#l9.122"></a><span id="l9.122" class="difflineat">@@ -286,19 +286,19 @@ NS_IMETHODIMP nsMailboxProtocol::OnStopR</span>
<a href="#l9.123"></a><span id="l9.123">                 // now we have to seek to the right position in the file and</span>
<a href="#l9.124"></a><span id="l9.124">                 // basically re-initialize the transport with the correct message size.</span>
<a href="#l9.125"></a><span id="l9.125">                 // then, we have to make sure the url keeps running somehow.</span>
<a href="#l9.126"></a><span id="l9.126">                 nsCOMPtr&lt;nsISupports&gt; urlSupports = do_QueryInterface(m_runningUrl);</span>
<a href="#l9.127"></a><span id="l9.127">                 //</span>
<a href="#l9.128"></a><span id="l9.128">                 // put us in a state where we are always notified of incoming data</span>
<a href="#l9.129"></a><span id="l9.129">                 //</span>
<a href="#l9.130"></a><span id="l9.130"> </span>
<a href="#l9.131"></a><span id="l9.131" class="difflineminus">-                m_transport = 0; // open new stream transport</span>
<a href="#l9.132"></a><span id="l9.132" class="difflineminus">-                m_inputStream = 0;</span>
<a href="#l9.133"></a><span id="l9.133" class="difflineminus">-                m_outputStream = 0;</span>
<a href="#l9.134"></a><span id="l9.134" class="difflineplus">+                m_transport = nullptr; // open new stream transport</span>
<a href="#l9.135"></a><span id="l9.135" class="difflineplus">+                m_inputStream = nullptr;</span>
<a href="#l9.136"></a><span id="l9.136" class="difflineplus">+                m_outputStream = nullptr;</span>
<a href="#l9.137"></a><span id="l9.137"> </span>
<a href="#l9.138"></a><span id="l9.138">                 if (m_multipleMsgMoveCopyStream)</span>
<a href="#l9.139"></a><span id="l9.139">                 {</span>
<a href="#l9.140"></a><span id="l9.140">                   rv = OpenMultipleMsgTransport(msgOffset, msgSize);</span>
<a href="#l9.141"></a><span id="l9.141">                 }</span>
<a href="#l9.142"></a><span id="l9.142">                 else</span>
<a href="#l9.143"></a><span id="l9.143">                 {</span>
<a href="#l9.144"></a><span id="l9.144">                   nsCOMPtr&lt;nsIInputStream&gt; stream;</span>
<a href="#l9.145"></a><span id="l9.145" class="difflineat">@@ -350,66 +350,66 @@ NS_IMETHODIMP nsMailboxProtocol::OnStopR</span>
<a href="#l9.146"></a><span id="l9.146">           }</span>
<a href="#l9.147"></a><span id="l9.147">         }</span>
<a href="#l9.148"></a><span id="l9.148">         else</span>
<a href="#l9.149"></a><span id="l9.149">         {</span>
<a href="#l9.150"></a><span id="l9.150">         }</span>
<a href="#l9.151"></a><span id="l9.151">       }</span>
<a href="#l9.152"></a><span id="l9.152">     }</span>
<a href="#l9.153"></a><span id="l9.153">   }</span>
<a href="#l9.154"></a><span id="l9.154" class="difflineminus">-  // and we want to mark ourselves for deletion or some how inform our protocol manager that we are </span>
<a href="#l9.155"></a><span id="l9.155" class="difflineplus">+  // and we want to mark ourselves for deletion or some how inform our protocol manager that we are</span>
<a href="#l9.156"></a><span id="l9.156">   // available for another url if there is one.</span>
<a href="#l9.157"></a><span id="l9.157" class="difflineminus">-  </span>
<a href="#l9.158"></a><span id="l9.158" class="difflineplus">+</span>
<a href="#l9.159"></a><span id="l9.159">   // mscott --&gt; maybe we should set our state to done because we don't run multiple urls in a mailbox</span>
<a href="#l9.160"></a><span id="l9.160">   // protocol connection....</span>
<a href="#l9.161"></a><span id="l9.161">   m_nextState = MAILBOX_DONE;</span>
<a href="#l9.162"></a><span id="l9.162" class="difflineminus">-  </span>
<a href="#l9.163"></a><span id="l9.163" class="difflineplus">+</span>
<a href="#l9.164"></a><span id="l9.164">   // the following is for smoke test purposes. QA is looking at this &quot;Mailbox Done&quot; string which</span>
<a href="#l9.165"></a><span id="l9.165">   // is printed out to the console and determining if the mail app loaded up correctly...obviously</span>
<a href="#l9.166"></a><span id="l9.166">   // this solution is not very good so we should look at something better, but don't remove this</span>
<a href="#l9.167"></a><span id="l9.167">   // line before talking to me (mscott) and mailnews QA....</span>
<a href="#l9.168"></a><span id="l9.168" class="difflineminus">-  </span>
<a href="#l9.169"></a><span id="l9.169" class="difflineplus">+</span>
<a href="#l9.170"></a><span id="l9.170">   MOZ_LOG(MAILBOX, mozilla::LogLevel::Info, (&quot;Mailbox Done\n&quot;));</span>
<a href="#l9.171"></a><span id="l9.171" class="difflineminus">-  </span>
<a href="#l9.172"></a><span id="l9.172" class="difflineplus">+</span>
<a href="#l9.173"></a><span id="l9.173">   // when on stop binding is called, we as the protocol are done...let's close down the connection</span>
<a href="#l9.174"></a><span id="l9.174">   // releasing all of our interfaces. It's important to remember that this on stop binding call</span>
<a href="#l9.175"></a><span id="l9.175">   // is coming from netlib so they are never going to ping us again with on data available. This means</span>
<a href="#l9.176"></a><span id="l9.176">   // we'll never be going through the Process loop...</span>
<a href="#l9.177"></a><span id="l9.177" class="difflineminus">-  </span>
<a href="#l9.178"></a><span id="l9.178" class="difflineplus">+</span>
<a href="#l9.179"></a><span id="l9.179">   if (m_multipleMsgMoveCopyStream)</span>
<a href="#l9.180"></a><span id="l9.180">   {</span>
<a href="#l9.181"></a><span id="l9.181">     m_multipleMsgMoveCopyStream-&gt;Close();</span>
<a href="#l9.182"></a><span id="l9.182">     m_multipleMsgMoveCopyStream = nullptr;</span>
<a href="#l9.183"></a><span id="l9.183">   }</span>
<a href="#l9.184"></a><span id="l9.184">   nsMsgProtocol::OnStopRequest(request, ctxt, aStatus);</span>
<a href="#l9.185"></a><span id="l9.185" class="difflineminus">-  return CloseSocket(); </span>
<a href="#l9.186"></a><span id="l9.186" class="difflineplus">+  return CloseSocket();</span>
<a href="#l9.187"></a><span id="l9.187"> }</span>
<a href="#l9.188"></a><span id="l9.188"> </span>
<a href="#l9.189"></a><span id="l9.189"> /////////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l9.190"></a><span id="l9.190"> // End of nsIStreamListenerSupport</span>
<a href="#l9.191"></a><span id="l9.191"> //////////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l9.192"></a><span id="l9.192"> </span>
<a href="#l9.193"></a><span id="l9.193"> nsresult nsMailboxProtocol::DoneReadingMessage()</span>
<a href="#l9.194"></a><span id="l9.194"> {</span>
<a href="#l9.195"></a><span id="l9.195">   nsresult rv = NS_OK;</span>
<a href="#l9.196"></a><span id="l9.196">   // and close the article file if it was open....</span>
<a href="#l9.197"></a><span id="l9.197" class="difflineminus">-  </span>
<a href="#l9.198"></a><span id="l9.198" class="difflineplus">+</span>
<a href="#l9.199"></a><span id="l9.199">   if (m_mailboxAction == nsIMailboxUrl::ActionSaveMessageToDisk &amp;&amp; m_msgFileOutputStream)</span>
<a href="#l9.200"></a><span id="l9.200">     rv = m_msgFileOutputStream-&gt;Close();</span>
<a href="#l9.201"></a><span id="l9.201" class="difflineminus">-  </span>
<a href="#l9.202"></a><span id="l9.202" class="difflineplus">+</span>
<a href="#l9.203"></a><span id="l9.203">   return rv;</span>
<a href="#l9.204"></a><span id="l9.204"> }</span>
<a href="#l9.205"></a><span id="l9.205"> </span>
<a href="#l9.206"></a><span id="l9.206"> nsresult nsMailboxProtocol::SetupMessageExtraction()</span>
<a href="#l9.207"></a><span id="l9.207"> {</span>
<a href="#l9.208"></a><span id="l9.208" class="difflineminus">-  // Determine the number of bytes we are going to need to read out of the </span>
<a href="#l9.209"></a><span id="l9.209" class="difflineplus">+  // Determine the number of bytes we are going to need to read out of the</span>
<a href="#l9.210"></a><span id="l9.210">   // mailbox url....</span>
<a href="#l9.211"></a><span id="l9.211">   nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l9.212"></a><span id="l9.212">   nsresult rv = NS_OK;</span>
<a href="#l9.213"></a><span id="l9.213" class="difflineminus">-  </span>
<a href="#l9.214"></a><span id="l9.214" class="difflineplus">+</span>
<a href="#l9.215"></a><span id="l9.215">   NS_ASSERTION(m_runningUrl, &quot;Not running a url&quot;);</span>
<a href="#l9.216"></a><span id="l9.216">   if (m_runningUrl)</span>
<a href="#l9.217"></a><span id="l9.217">   {</span>
<a href="#l9.218"></a><span id="l9.218">     uint32_t messageSize = 0;</span>
<a href="#l9.219"></a><span id="l9.219">     m_runningUrl-&gt;GetMessageSize(&amp;messageSize);</span>
<a href="#l9.220"></a><span id="l9.220">     if (!messageSize)</span>
<a href="#l9.221"></a><span id="l9.221">     {</span>
<a href="#l9.222"></a><span id="l9.222">       nsCOMPtr&lt;nsIMsgMessageUrl&gt; msgUrl = do_QueryInterface(m_runningUrl, &amp;rv);</span>
<a href="#l9.223"></a><span id="l9.223" class="difflineat">@@ -434,25 +434,25 @@ nsresult nsMailboxProtocol::SetupMessage</span>
<a href="#l9.224"></a><span id="l9.224"> </span>
<a href="#l9.225"></a><span id="l9.225"> nsresult nsMailboxProtocol::LoadUrl(nsIURI * aURL, nsISupports * aConsumer)</span>
<a href="#l9.226"></a><span id="l9.226"> {</span>
<a href="#l9.227"></a><span id="l9.227">   nsresult rv = NS_OK;</span>
<a href="#l9.228"></a><span id="l9.228">   // if we were already initialized with a consumer, use it...</span>
<a href="#l9.229"></a><span id="l9.229">   nsCOMPtr&lt;nsIStreamListener&gt; consumer = do_QueryInterface(aConsumer);</span>
<a href="#l9.230"></a><span id="l9.230">   if (consumer)</span>
<a href="#l9.231"></a><span id="l9.231">     m_channelListener = consumer;</span>
<a href="#l9.232"></a><span id="l9.232" class="difflineminus">-  </span>
<a href="#l9.233"></a><span id="l9.233" class="difflineplus">+</span>
<a href="#l9.234"></a><span id="l9.234">   if (aURL)</span>
<a href="#l9.235"></a><span id="l9.235">   {</span>
<a href="#l9.236"></a><span id="l9.236">     m_runningUrl = do_QueryInterface(aURL);</span>
<a href="#l9.237"></a><span id="l9.237">     if (m_runningUrl)</span>
<a href="#l9.238"></a><span id="l9.238">     {</span>
<a href="#l9.239"></a><span id="l9.239">       // find out from the url what action we are supposed to perform...</span>
<a href="#l9.240"></a><span id="l9.240">       rv = m_runningUrl-&gt;GetMailboxAction(&amp;m_mailboxAction);</span>
<a href="#l9.241"></a><span id="l9.241" class="difflineminus">-      </span>
<a href="#l9.242"></a><span id="l9.242" class="difflineplus">+</span>
<a href="#l9.243"></a><span id="l9.243">       bool convertData = false;</span>
<a href="#l9.244"></a><span id="l9.244"> </span>
<a href="#l9.245"></a><span id="l9.245">       // need to check if we're fetching an rfc822 part in order to</span>
<a href="#l9.246"></a><span id="l9.246">       // quote a message.</span>
<a href="#l9.247"></a><span id="l9.247">       if (m_mailboxAction == nsIMailboxUrl::ActionFetchMessage)</span>
<a href="#l9.248"></a><span id="l9.248">       {</span>
<a href="#l9.249"></a><span id="l9.249">         nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgUrl = do_QueryInterface(m_runningUrl, &amp;rv);</span>
<a href="#l9.250"></a><span id="l9.250">         NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l9.251"></a><span id="l9.251" class="difflineat">@@ -481,17 +481,17 @@ nsresult nsMailboxProtocol::LoadUrl(nsIU</span>
<a href="#l9.252"></a><span id="l9.252">           nsCOMPtr &lt;nsIStreamListener&gt; conversionListener;</span>
<a href="#l9.253"></a><span id="l9.253">           nsCOMPtr&lt;nsIChannel&gt; channel;</span>
<a href="#l9.254"></a><span id="l9.254">           QueryInterface(NS_GET_IID(nsIChannel), getter_AddRefs(channel));</span>
<a href="#l9.255"></a><span id="l9.255"> </span>
<a href="#l9.256"></a><span id="l9.256">           rv = streamConverter-&gt;AsyncConvertData(&quot;message/rfc822&quot;,</span>
<a href="#l9.257"></a><span id="l9.257">                                                  &quot;*/*&quot;,</span>
<a href="#l9.258"></a><span id="l9.258">                                                  consumer, channel, getter_AddRefs(m_channelListener));</span>
<a href="#l9.259"></a><span id="l9.259">       }</span>
<a href="#l9.260"></a><span id="l9.260" class="difflineminus">-      </span>
<a href="#l9.261"></a><span id="l9.261" class="difflineplus">+</span>
<a href="#l9.262"></a><span id="l9.262">       if (NS_SUCCEEDED(rv))</span>
<a href="#l9.263"></a><span id="l9.263">       {</span>
<a href="#l9.264"></a><span id="l9.264">         switch (m_mailboxAction)</span>
<a href="#l9.265"></a><span id="l9.265">         {</span>
<a href="#l9.266"></a><span id="l9.266">         case nsIMailboxUrl::ActionParseMailbox:</span>
<a href="#l9.267"></a><span id="l9.267">           // extract the mailbox parser..</span>
<a href="#l9.268"></a><span id="l9.268">           rv = m_runningUrl-&gt;GetMailboxParser(getter_AddRefs(m_mailboxParser));</span>
<a href="#l9.269"></a><span id="l9.269">           m_nextState = MAILBOX_READ_FOLDER;</span>
<a href="#l9.270"></a><span id="l9.270" class="difflineat">@@ -528,77 +528,77 @@ nsresult nsMailboxProtocol::LoadUrl(nsIU</span>
<a href="#l9.271"></a><span id="l9.271">           break;</span>
<a href="#l9.272"></a><span id="l9.272">         case nsIMailboxUrl::ActionFetchPart:</span>
<a href="#l9.273"></a><span id="l9.273">             m_nextState = MAILBOX_READ_MESSAGE;</span>
<a href="#l9.274"></a><span id="l9.274">             break;</span>
<a href="#l9.275"></a><span id="l9.275">         default:</span>
<a href="#l9.276"></a><span id="l9.276">           break;</span>
<a href="#l9.277"></a><span id="l9.277">         }</span>
<a href="#l9.278"></a><span id="l9.278">       }</span>
<a href="#l9.279"></a><span id="l9.279" class="difflineminus">-      </span>
<a href="#l9.280"></a><span id="l9.280" class="difflineplus">+</span>
<a href="#l9.281"></a><span id="l9.281">       rv = nsMsgProtocol::LoadUrl(aURL, m_channelListener);</span>
<a href="#l9.282"></a><span id="l9.282" class="difflineminus">-      </span>
<a href="#l9.283"></a><span id="l9.283" class="difflineplus">+</span>
<a href="#l9.284"></a><span id="l9.284">     } // if we received an MAILBOX url...</span>
<a href="#l9.285"></a><span id="l9.285">   } // if we received a url!</span>
<a href="#l9.286"></a><span id="l9.286" class="difflineminus">-  </span>
<a href="#l9.287"></a><span id="l9.287" class="difflineplus">+</span>
<a href="#l9.288"></a><span id="l9.288">   return rv;</span>
<a href="#l9.289"></a><span id="l9.289"> }</span>
<a href="#l9.290"></a><span id="l9.290"> </span>
<a href="#l9.291"></a><span id="l9.291"> int32_t nsMailboxProtocol::ReadFolderResponse(nsIInputStream * inputStream, uint64_t sourceOffset, uint32_t length)</span>
<a href="#l9.292"></a><span id="l9.292"> {</span>
<a href="#l9.293"></a><span id="l9.293">   // okay we are doing a folder read in 8K chunks of a mail folder....</span>
<a href="#l9.294"></a><span id="l9.294">   // this is almost too easy....we can just forward the data in this stream on to our</span>
<a href="#l9.295"></a><span id="l9.295">   // folder parser object!!!</span>
<a href="#l9.296"></a><span id="l9.296" class="difflineminus">-  </span>
<a href="#l9.297"></a><span id="l9.297" class="difflineplus">+</span>
<a href="#l9.298"></a><span id="l9.298">   nsresult rv = NS_OK;</span>
<a href="#l9.299"></a><span id="l9.299">   mCurrentProgress += length;</span>
<a href="#l9.300"></a><span id="l9.300" class="difflineminus">-  </span>
<a href="#l9.301"></a><span id="l9.301" class="difflineplus">+</span>
<a href="#l9.302"></a><span id="l9.302">   if (m_mailboxParser)</span>
<a href="#l9.303"></a><span id="l9.303">   {</span>
<a href="#l9.304"></a><span id="l9.304">     nsCOMPtr &lt;nsIURI&gt; url = do_QueryInterface(m_runningUrl);</span>
<a href="#l9.305"></a><span id="l9.305">     rv = m_mailboxParser-&gt;OnDataAvailable(nullptr, url, inputStream, sourceOffset, length); // let the parser deal with it...</span>
<a href="#l9.306"></a><span id="l9.306">   }</span>
<a href="#l9.307"></a><span id="l9.307">   if (NS_FAILED(rv))</span>
<a href="#l9.308"></a><span id="l9.308">   {</span>
<a href="#l9.309"></a><span id="l9.309">     m_nextState = MAILBOX_ERROR_DONE; // drop out of the loop....</span>
<a href="#l9.310"></a><span id="l9.310">     return -1;</span>
<a href="#l9.311"></a><span id="l9.311">   }</span>
<a href="#l9.312"></a><span id="l9.312" class="difflineminus">-  </span>
<a href="#l9.313"></a><span id="l9.313" class="difflineplus">+</span>
<a href="#l9.314"></a><span id="l9.314">   // now wait for the next 8K chunk to come in.....</span>
<a href="#l9.315"></a><span id="l9.315">   SetFlag(MAILBOX_PAUSE_FOR_READ);</span>
<a href="#l9.316"></a><span id="l9.316" class="difflineminus">-  </span>
<a href="#l9.317"></a><span id="l9.317" class="difflineplus">+</span>
<a href="#l9.318"></a><span id="l9.318">   // leave our state alone so when the next chunk of the mailbox comes in we jump to this state</span>
<a href="#l9.319"></a><span id="l9.319">   // and repeat....how does this process end? Well when the file is done being read in, core net lib</span>
<a href="#l9.320"></a><span id="l9.320">   // will issue an ::OnStopRequest to us...we'll use that as our sign to drop out of this state and to</span>
<a href="#l9.321"></a><span id="l9.321">   // close the protocol instance...</span>
<a href="#l9.322"></a><span id="l9.322" class="difflineminus">-  </span>
<a href="#l9.323"></a><span id="l9.323" class="difflineminus">-  return 0; </span>
<a href="#l9.324"></a><span id="l9.324" class="difflineplus">+</span>
<a href="#l9.325"></a><span id="l9.325" class="difflineplus">+  return 0;</span>
<a href="#l9.326"></a><span id="l9.326"> }</span>
<a href="#l9.327"></a><span id="l9.327"> </span>
<a href="#l9.328"></a><span id="l9.328"> int32_t nsMailboxProtocol::ReadMessageResponse(nsIInputStream * inputStream, uint64_t sourceOffset, uint32_t length)</span>
<a href="#l9.329"></a><span id="l9.329"> {</span>
<a href="#l9.330"></a><span id="l9.330">   char *line = nullptr;</span>
<a href="#l9.331"></a><span id="l9.331">   uint32_t status = 0;</span>
<a href="#l9.332"></a><span id="l9.332">   nsresult rv = NS_OK;</span>
<a href="#l9.333"></a><span id="l9.333">   mCurrentProgress += length;</span>
<a href="#l9.334"></a><span id="l9.334" class="difflineminus">-  </span>
<a href="#l9.335"></a><span id="l9.335" class="difflineplus">+</span>
<a href="#l9.336"></a><span id="l9.336">   // if we are doing a move or a copy, forward the data onto the copy handler...</span>
<a href="#l9.337"></a><span id="l9.337">   // if we want to display the message then parse the incoming data...</span>
<a href="#l9.338"></a><span id="l9.338" class="difflineminus">-  </span>
<a href="#l9.339"></a><span id="l9.339" class="difflineplus">+</span>
<a href="#l9.340"></a><span id="l9.340">   if (m_channelListener)</span>
<a href="#l9.341"></a><span id="l9.341">   {</span>
<a href="#l9.342"></a><span id="l9.342">     // just forward the data we read in to the listener...</span>
<a href="#l9.343"></a><span id="l9.343">     rv = m_channelListener-&gt;OnDataAvailable(this, m_channelContext, inputStream, sourceOffset, length);</span>
<a href="#l9.344"></a><span id="l9.344">   }</span>
<a href="#l9.345"></a><span id="l9.345">   else</span>
<a href="#l9.346"></a><span id="l9.346">   {</span>
<a href="#l9.347"></a><span id="l9.347">     bool pauseForMoreData = false;</span>
<a href="#l9.348"></a><span id="l9.348">     bool canonicalLineEnding = false;</span>
<a href="#l9.349"></a><span id="l9.349">     nsCOMPtr&lt;nsIMsgMessageUrl&gt; msgurl = do_QueryInterface(m_runningUrl);</span>
<a href="#l9.350"></a><span id="l9.350" class="difflineminus">-    </span>
<a href="#l9.351"></a><span id="l9.351" class="difflineplus">+</span>
<a href="#l9.352"></a><span id="l9.352">     if (msgurl)</span>
<a href="#l9.353"></a><span id="l9.353">       msgurl-&gt;GetCanonicalLineEnding(&amp;canonicalLineEnding);</span>
<a href="#l9.354"></a><span id="l9.354"> </span>
<a href="#l9.355"></a><span id="l9.355">     while ((line = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, status, pauseForMoreData)) &amp;&amp;</span>
<a href="#l9.356"></a><span id="l9.356">            !pauseForMoreData)</span>
<a href="#l9.357"></a><span id="l9.357">     {</span>
<a href="#l9.358"></a><span id="l9.358">       /* When we're sending this line to a converter (ie,</span>
<a href="#l9.359"></a><span id="l9.359">       it's a message/rfc822) use the local line termination</span>
<a href="#l9.360"></a><span id="l9.360" class="difflineat">@@ -628,49 +628,49 @@ int32_t nsMailboxProtocol::ReadMessageRe</span>
<a href="#l9.361"></a><span id="l9.361">           break;</span>
<a href="#l9.362"></a><span id="l9.362">       }</span>
<a href="#l9.363"></a><span id="l9.363">       else</span>
<a href="#l9.364"></a><span id="l9.364">         SetFlag(MAILBOX_MSG_PARSE_FIRST_LINE);</span>
<a href="#l9.365"></a><span id="l9.365">       PR_Free(line);</span>
<a href="#l9.366"></a><span id="l9.366">     }</span>
<a href="#l9.367"></a><span id="l9.367">     PR_Free(line);</span>
<a href="#l9.368"></a><span id="l9.368">   }</span>
<a href="#l9.369"></a><span id="l9.369" class="difflineminus">-  </span>
<a href="#l9.370"></a><span id="l9.370" class="difflineplus">+</span>
<a href="#l9.371"></a><span id="l9.371">   SetFlag(MAILBOX_PAUSE_FOR_READ); // wait for more data to become available...</span>
<a href="#l9.372"></a><span id="l9.372">   if (mProgressEventSink &amp;&amp; m_runningUrl)</span>
<a href="#l9.373"></a><span id="l9.373">   {</span>
<a href="#l9.374"></a><span id="l9.374">     int64_t maxProgress;</span>
<a href="#l9.375"></a><span id="l9.375">     nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl(do_QueryInterface(m_runningUrl));</span>
<a href="#l9.376"></a><span id="l9.376">     mailnewsUrl-&gt;GetMaxProgress(&amp;maxProgress);</span>
<a href="#l9.377"></a><span id="l9.377">     mProgressEventSink-&gt;OnProgress(this, m_channelContext,</span>
<a href="#l9.378"></a><span id="l9.378">                                    mCurrentProgress,</span>
<a href="#l9.379"></a><span id="l9.379">                                    maxProgress);</span>
<a href="#l9.380"></a><span id="l9.380">   }</span>
<a href="#l9.381"></a><span id="l9.381" class="difflineminus">-  </span>
<a href="#l9.382"></a><span id="l9.382" class="difflineplus">+</span>
<a href="#l9.383"></a><span id="l9.383">   if (NS_FAILED(rv)) return -1;</span>
<a href="#l9.384"></a><span id="l9.384" class="difflineminus">-  </span>
<a href="#l9.385"></a><span id="l9.385" class="difflineplus">+</span>
<a href="#l9.386"></a><span id="l9.386">   return 0;</span>
<a href="#l9.387"></a><span id="l9.387"> }</span>
<a href="#l9.388"></a><span id="l9.388"> </span>
<a href="#l9.389"></a><span id="l9.389"> </span>
<a href="#l9.390"></a><span id="l9.390"> /*</span>
<a href="#l9.391"></a><span id="l9.391">  * returns negative if the transfer is finished or error'd out</span>
<a href="#l9.392"></a><span id="l9.392">  *</span>
<a href="#l9.393"></a><span id="l9.393">  * returns zero or more if the transfer needs to be continued.</span>
<a href="#l9.394"></a><span id="l9.394">  */</span>
<a href="#l9.395"></a><span id="l9.395"> nsresult nsMailboxProtocol::ProcessProtocolState(nsIURI * url, nsIInputStream * inputStream, uint64_t offset, uint32_t length)</span>
<a href="#l9.396"></a><span id="l9.396"> {</span>
<a href="#l9.397"></a><span id="l9.397">   nsresult rv = NS_OK;</span>
<a href="#l9.398"></a><span id="l9.398">   int32_t status = 0;</span>
<a href="#l9.399"></a><span id="l9.399">   ClearFlag(MAILBOX_PAUSE_FOR_READ); /* already paused; reset */</span>
<a href="#l9.400"></a><span id="l9.400" class="difflineminus">-  </span>
<a href="#l9.401"></a><span id="l9.401" class="difflineplus">+</span>
<a href="#l9.402"></a><span id="l9.402">   while(!TestFlag(MAILBOX_PAUSE_FOR_READ))</span>
<a href="#l9.403"></a><span id="l9.403">   {</span>
<a href="#l9.404"></a><span id="l9.404" class="difflineminus">-    </span>
<a href="#l9.405"></a><span id="l9.405" class="difflineminus">-    switch(m_nextState) </span>
<a href="#l9.406"></a><span id="l9.406" class="difflineplus">+</span>
<a href="#l9.407"></a><span id="l9.407" class="difflineplus">+    switch(m_nextState)</span>
<a href="#l9.408"></a><span id="l9.408">     {</span>
<a href="#l9.409"></a><span id="l9.409">     case MAILBOX_READ_MESSAGE:</span>
<a href="#l9.410"></a><span id="l9.410">       if (inputStream == nullptr)</span>
<a href="#l9.411"></a><span id="l9.411">         SetFlag(MAILBOX_PAUSE_FOR_READ);</span>
<a href="#l9.412"></a><span id="l9.412">       else</span>
<a href="#l9.413"></a><span id="l9.413">         status = ReadMessageResponse(inputStream, offset, length);</span>
<a href="#l9.414"></a><span id="l9.414">       break;</span>
<a href="#l9.415"></a><span id="l9.415">     case MAILBOX_READ_FOLDER:</span>
<a href="#l9.416"></a><span id="l9.416" class="difflineat">@@ -683,43 +683,43 @@ nsresult nsMailboxProtocol::ProcessProto</span>
<a href="#l9.417"></a><span id="l9.417">     case MAILBOX_ERROR_DONE:</span>
<a href="#l9.418"></a><span id="l9.418">       {</span>
<a href="#l9.419"></a><span id="l9.419">         nsCOMPtr &lt;nsIMsgMailNewsUrl&gt; anotherUrl = do_QueryInterface(m_runningUrl);</span>
<a href="#l9.420"></a><span id="l9.420">         rv = m_nextState == MAILBOX_DONE ? NS_OK : NS_ERROR_FAILURE;</span>
<a href="#l9.421"></a><span id="l9.421">         anotherUrl-&gt;SetUrlState(false, rv);</span>
<a href="#l9.422"></a><span id="l9.422">         m_nextState = MAILBOX_FREE;</span>
<a href="#l9.423"></a><span id="l9.423">       }</span>
<a href="#l9.424"></a><span id="l9.424">       break;</span>
<a href="#l9.425"></a><span id="l9.425" class="difflineminus">-      </span>
<a href="#l9.426"></a><span id="l9.426" class="difflineplus">+</span>
<a href="#l9.427"></a><span id="l9.427">     case MAILBOX_FREE:</span>
<a href="#l9.428"></a><span id="l9.428">       // MAILBOX is a one time use connection so kill it if we get here...</span>
<a href="#l9.429"></a><span id="l9.429" class="difflineminus">-      CloseSocket(); </span>
<a href="#l9.430"></a><span id="l9.430" class="difflineplus">+      CloseSocket();</span>
<a href="#l9.431"></a><span id="l9.431">       return rv; /* final end */</span>
<a href="#l9.432"></a><span id="l9.432" class="difflineminus">-      </span>
<a href="#l9.433"></a><span id="l9.433" class="difflineplus">+</span>
<a href="#l9.434"></a><span id="l9.434">     default: /* should never happen !!! */</span>
<a href="#l9.435"></a><span id="l9.435">       m_nextState = MAILBOX_ERROR_DONE;</span>
<a href="#l9.436"></a><span id="l9.436">       break;</span>
<a href="#l9.437"></a><span id="l9.437">     }</span>
<a href="#l9.438"></a><span id="l9.438" class="difflineminus">-    </span>
<a href="#l9.439"></a><span id="l9.439" class="difflineminus">-    /* check for errors during load and call error </span>
<a href="#l9.440"></a><span id="l9.440" class="difflineplus">+</span>
<a href="#l9.441"></a><span id="l9.441" class="difflineplus">+    /* check for errors during load and call error</span>
<a href="#l9.442"></a><span id="l9.442">     * state if found</span>
<a href="#l9.443"></a><span id="l9.443">     */</span>
<a href="#l9.444"></a><span id="l9.444">     if(status &lt; 0 &amp;&amp; m_nextState != MAILBOX_FREE)</span>
<a href="#l9.445"></a><span id="l9.445">     {</span>
<a href="#l9.446"></a><span id="l9.446">       m_nextState = MAILBOX_ERROR_DONE;</span>
<a href="#l9.447"></a><span id="l9.447">       /* don't exit! loop around again and do the free case */</span>
<a href="#l9.448"></a><span id="l9.448">       ClearFlag(MAILBOX_PAUSE_FOR_READ);</span>
<a href="#l9.449"></a><span id="l9.449">     }</span>
<a href="#l9.450"></a><span id="l9.450">   } /* while(!MAILBOX_PAUSE_FOR_READ) */</span>
<a href="#l9.451"></a><span id="l9.451" class="difflineminus">-  </span>
<a href="#l9.452"></a><span id="l9.452" class="difflineplus">+</span>
<a href="#l9.453"></a><span id="l9.453">   return rv;</span>
<a href="#l9.454"></a><span id="l9.454"> }</span>
<a href="#l9.455"></a><span id="l9.455"> </span>
<a href="#l9.456"></a><span id="l9.456"> nsresult nsMailboxProtocol::CloseSocket()</span>
<a href="#l9.457"></a><span id="l9.457"> {</span>
<a href="#l9.458"></a><span id="l9.458">   // how do you force a release when closing the connection??</span>
<a href="#l9.459"></a><span id="l9.459" class="difflineminus">-  nsMsgProtocol::CloseSocket(); </span>
<a href="#l9.460"></a><span id="l9.460" class="difflineplus">+  nsMsgProtocol::CloseSocket();</span>
<a href="#l9.461"></a><span id="l9.461">   m_runningUrl = nullptr;</span>
<a href="#l9.462"></a><span id="l9.462">   m_mailboxParser = nullptr;</span>
<a href="#l9.463"></a><span id="l9.463">   return NS_OK;</span>
<a href="#l9.464"></a><span id="l9.464"> }</span>
<a href="#l9.465"></a><span id="l9.465"> </span>
<a href="#l9.466"></a><span id="l9.466"> // vim: ts=2 sw=2</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/local/src/nsPop3Sink.cpp</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/local/src/nsPop3Sink.cpp</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -272,17 +272,17 @@ nsPop3Sink::EndMailDelivery(nsIPop3Proto</span>
<a href="#l10.4"></a><span id="l10.4">     if (m_outFileStream)</span>
<a href="#l10.5"></a><span id="l10.5">       m_outFileStream-&gt;Flush();  // try this.</span>
<a href="#l10.6"></a><span id="l10.6">     m_newMailParser-&gt;OnStopRequest(nullptr, nullptr, NS_OK);</span>
<a href="#l10.7"></a><span id="l10.7">     m_newMailParser-&gt;EndMsgDownload();</span>
<a href="#l10.8"></a><span id="l10.8">   }</span>
<a href="#l10.9"></a><span id="l10.9">   if (m_outFileStream)</span>
<a href="#l10.10"></a><span id="l10.10">   {</span>
<a href="#l10.11"></a><span id="l10.11">     m_outFileStream-&gt;Close();</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-    m_outFileStream = 0;</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+    m_outFileStream = nullptr;</span>
<a href="#l10.14"></a><span id="l10.14">   }</span>
<a href="#l10.15"></a><span id="l10.15"> </span>
<a href="#l10.16"></a><span id="l10.16">   if (m_downloadingToTempFile)</span>
<a href="#l10.17"></a><span id="l10.17">     m_tmpDownloadFile-&gt;Remove(false);</span>
<a href="#l10.18"></a><span id="l10.18"> </span>
<a href="#l10.19"></a><span id="l10.19">   // tell the parser to mark the db valid *after* closing the mailbox.</span>
<a href="#l10.20"></a><span id="l10.20">   if (m_newMailParser)</span>
<a href="#l10.21"></a><span id="l10.21">     m_newMailParser-&gt;UpdateDBFolderInfo();</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineat">@@ -400,17 +400,17 @@ nsPop3Sink::AbortMailDelivery(nsIPop3Pro</span>
<a href="#l10.23"></a><span id="l10.23"> {</span>
<a href="#l10.24"></a><span id="l10.24">   CheckPartialMessages(protocol);</span>
<a href="#l10.25"></a><span id="l10.25"> </span>
<a href="#l10.26"></a><span id="l10.26">   // ### PS TODO - discard any new message?</span>
<a href="#l10.27"></a><span id="l10.27"> </span>
<a href="#l10.28"></a><span id="l10.28">   if (m_outFileStream)</span>
<a href="#l10.29"></a><span id="l10.29">   {</span>
<a href="#l10.30"></a><span id="l10.30">     m_outFileStream-&gt;Close();</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineminus">-    m_outFileStream = 0;</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineplus">+    m_outFileStream = nullptr;</span>
<a href="#l10.33"></a><span id="l10.33">   }</span>
<a href="#l10.34"></a><span id="l10.34"> </span>
<a href="#l10.35"></a><span id="l10.35">   if (m_downloadingToTempFile &amp;&amp; m_tmpDownloadFile)</span>
<a href="#l10.36"></a><span id="l10.36">     m_tmpDownloadFile-&gt;Remove(false);</span>
<a href="#l10.37"></a><span id="l10.37"> </span>
<a href="#l10.38"></a><span id="l10.38">   /* tell the parser to mark the db valid *after* closing the mailbox.</span>
<a href="#l10.39"></a><span id="l10.39">   we have truncated the inbox, so berkeley mailbox and msf file are in sync*/</span>
<a href="#l10.40"></a><span id="l10.40">   if (m_newMailParser)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/mime/src/mimecms.cpp</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/mime/src/mimecms.cpp</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -68,30 +68,30 @@ typedef struct MimeCMSdata</span>
<a href="#l11.4"></a><span id="l11.4">   bool ci_is_encrypted;</span>
<a href="#l11.5"></a><span id="l11.5">   char *sender_addr;</span>
<a href="#l11.6"></a><span id="l11.6">   bool decoding_failed;</span>
<a href="#l11.7"></a><span id="l11.7">   uint32_t decoded_bytes;</span>
<a href="#l11.8"></a><span id="l11.8">   MimeObject *self;</span>
<a href="#l11.9"></a><span id="l11.9">   bool parent_is_encrypted_p;</span>
<a href="#l11.10"></a><span id="l11.10">   bool parent_holds_stamp_p;</span>
<a href="#l11.11"></a><span id="l11.11">   nsCOMPtr&lt;nsIMsgSMIMEHeaderSink&gt; smimeHeaderSink;</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-  </span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+</span>
<a href="#l11.14"></a><span id="l11.14">   MimeCMSdata()</span>
<a href="#l11.15"></a><span id="l11.15">   :output_fn(nullptr),</span>
<a href="#l11.16"></a><span id="l11.16">   output_closure(nullptr),</span>
<a href="#l11.17"></a><span id="l11.17">   ci_is_encrypted(false),</span>
<a href="#l11.18"></a><span id="l11.18">   sender_addr(nullptr),</span>
<a href="#l11.19"></a><span id="l11.19">   decoding_failed(false),</span>
<a href="#l11.20"></a><span id="l11.20">   decoded_bytes(0),</span>
<a href="#l11.21"></a><span id="l11.21">   self(nullptr),</span>
<a href="#l11.22"></a><span id="l11.22">   parent_is_encrypted_p(false),</span>
<a href="#l11.23"></a><span id="l11.23">   parent_holds_stamp_p(false)</span>
<a href="#l11.24"></a><span id="l11.24">   {</span>
<a href="#l11.25"></a><span id="l11.25">   }</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineminus">-  </span>
<a href="#l11.27"></a><span id="l11.27" class="difflineplus">+</span>
<a href="#l11.28"></a><span id="l11.28">   ~MimeCMSdata()</span>
<a href="#l11.29"></a><span id="l11.29">   {</span>
<a href="#l11.30"></a><span id="l11.30">     if(sender_addr)</span>
<a href="#l11.31"></a><span id="l11.31">       PR_Free(sender_addr);</span>
<a href="#l11.32"></a><span id="l11.32"> </span>
<a href="#l11.33"></a><span id="l11.33">     // Do an orderly release of nsICMSDecoder and nsICMSMessage //</span>
<a href="#l11.34"></a><span id="l11.34">     if (decoder_context)</span>
<a href="#l11.35"></a><span id="l11.35">     {</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineat">@@ -135,17 +135,17 @@ bool MimeEncryptedCMS_encrypted_p (MimeO</span>
<a href="#l11.37"></a><span id="l11.37">     if (!data || !data-&gt;content_info) return false;</span>
<a href="#l11.38"></a><span id="l11.38">                 data-&gt;content_info-&gt;ContentIsEncrypted(&amp;encrypted);</span>
<a href="#l11.39"></a><span id="l11.39">           return encrypted;</span>
<a href="#l11.40"></a><span id="l11.40">   }</span>
<a href="#l11.41"></a><span id="l11.41">   return false;</span>
<a href="#l11.42"></a><span id="l11.42"> }</span>
<a href="#l11.43"></a><span id="l11.43"> </span>
<a href="#l11.44"></a><span id="l11.44"> </span>
<a href="#l11.45"></a><span id="l11.45" class="difflineminus">-bool MimeCMSHeadersAndCertsMatch(nsICMSMessage *content_info, </span>
<a href="#l11.46"></a><span id="l11.46" class="difflineplus">+bool MimeCMSHeadersAndCertsMatch(nsICMSMessage *content_info,</span>
<a href="#l11.47"></a><span id="l11.47">                                    nsIX509Cert *signerCert,</span>
<a href="#l11.48"></a><span id="l11.48">                                    const char *from_addr,</span>
<a href="#l11.49"></a><span id="l11.49">                                    const char *from_name,</span>
<a href="#l11.50"></a><span id="l11.50">                                    const char *sender_addr,</span>
<a href="#l11.51"></a><span id="l11.51">                                    const char *sender_name,</span>
<a href="#l11.52"></a><span id="l11.52">                                    bool *signing_cert_without_email_address)</span>
<a href="#l11.53"></a><span id="l11.53"> {</span>
<a href="#l11.54"></a><span id="l11.54">   nsCString cert_addr;</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineat">@@ -213,17 +213,17 @@ public:</span>
<a href="#l11.56"></a><span id="l11.56">   NS_DECL_NSISMIMEVERIFICATIONLISTENER</span>
<a href="#l11.57"></a><span id="l11.57"> </span>
<a href="#l11.58"></a><span id="l11.58">   nsSMimeVerificationListener(const char *aFromAddr, const char *aFromName,</span>
<a href="#l11.59"></a><span id="l11.59">                               const char *aSenderAddr, const char *aSenderName,</span>
<a href="#l11.60"></a><span id="l11.60">                               nsIMsgSMIMEHeaderSink *aHeaderSink, int32_t aMimeNestingLevel);</span>
<a href="#l11.61"></a><span id="l11.61"> </span>
<a href="#l11.62"></a><span id="l11.62"> protected:</span>
<a href="#l11.63"></a><span id="l11.63">   virtual ~nsSMimeVerificationListener() {}</span>
<a href="#l11.64"></a><span id="l11.64" class="difflineminus">-  </span>
<a href="#l11.65"></a><span id="l11.65" class="difflineplus">+</span>
<a href="#l11.66"></a><span id="l11.66">   /**</span>
<a href="#l11.67"></a><span id="l11.67">    * It is safe to declare this implementation as thread safe,</span>
<a href="#l11.68"></a><span id="l11.68">    * despite not using a lock to protect the members.</span>
<a href="#l11.69"></a><span id="l11.69">    * Because of the way the object will be used, we don't expect a race.</span>
<a href="#l11.70"></a><span id="l11.70">    * After construction, the object is passed to another thread,</span>
<a href="#l11.71"></a><span id="l11.71">    * but will no longer be accessed on the original thread.</span>
<a href="#l11.72"></a><span id="l11.72">    * The other thread is unable to access/modify self's data members.</span>
<a href="#l11.73"></a><span id="l11.73">    * When the other thread is finished, it will call into the &quot;Notify&quot;</span>
<a href="#l11.74"></a><span id="l11.74" class="difflineat">@@ -295,27 +295,27 @@ nsSMimeVerificationListener::nsSMimeVeri</span>
<a href="#l11.75"></a><span id="l11.75">   mSenderName = aSenderName;</span>
<a href="#l11.76"></a><span id="l11.76"> }</span>
<a href="#l11.77"></a><span id="l11.77"> </span>
<a href="#l11.78"></a><span id="l11.78"> NS_IMETHODIMP nsSMimeVerificationListener::Notify(nsICMSMessage2 *aVerifiedMessage,</span>
<a href="#l11.79"></a><span id="l11.79">                                                   nsresult aVerificationResultCode)</span>
<a href="#l11.80"></a><span id="l11.80"> {</span>
<a href="#l11.81"></a><span id="l11.81">   // Only continue if we have a valid pointer to the UI</span>
<a href="#l11.82"></a><span id="l11.82">   NS_ENSURE_FALSE(mSinkIsNull, NS_OK);</span>
<a href="#l11.83"></a><span id="l11.83" class="difflineminus">-  </span>
<a href="#l11.84"></a><span id="l11.84" class="difflineplus">+</span>
<a href="#l11.85"></a><span id="l11.85">   NS_ENSURE_TRUE(aVerifiedMessage, NS_ERROR_FAILURE);</span>
<a href="#l11.86"></a><span id="l11.86" class="difflineminus">-  </span>
<a href="#l11.87"></a><span id="l11.87" class="difflineplus">+</span>
<a href="#l11.88"></a><span id="l11.88">   nsCOMPtr&lt;nsICMSMessage&gt; msg = do_QueryInterface(aVerifiedMessage);</span>
<a href="#l11.89"></a><span id="l11.89">   NS_ENSURE_TRUE(msg, NS_ERROR_FAILURE);</span>
<a href="#l11.90"></a><span id="l11.90" class="difflineminus">-  </span>
<a href="#l11.91"></a><span id="l11.91" class="difflineplus">+</span>
<a href="#l11.92"></a><span id="l11.92">   nsCOMPtr&lt;nsIX509Cert&gt; signerCert;</span>
<a href="#l11.93"></a><span id="l11.93">   msg-&gt;GetSignerCert(getter_AddRefs(signerCert));</span>
<a href="#l11.94"></a><span id="l11.94" class="difflineminus">-  </span>
<a href="#l11.95"></a><span id="l11.95" class="difflineplus">+</span>
<a href="#l11.96"></a><span id="l11.96">   int32_t signature_status = nsICMSMessageErrors::GENERAL_ERROR;</span>
<a href="#l11.97"></a><span id="l11.97" class="difflineminus">-  </span>
<a href="#l11.98"></a><span id="l11.98" class="difflineplus">+</span>
<a href="#l11.99"></a><span id="l11.99">   if (NS_FAILED(aVerificationResultCode))</span>
<a href="#l11.100"></a><span id="l11.100">   {</span>
<a href="#l11.101"></a><span id="l11.101">     if (NS_ERROR_MODULE_SECURITY == NS_ERROR_GET_MODULE(aVerificationResultCode))</span>
<a href="#l11.102"></a><span id="l11.102">       signature_status = NS_ERROR_GET_CODE(aVerificationResultCode);</span>
<a href="#l11.103"></a><span id="l11.103">     else if (NS_ERROR_NOT_IMPLEMENTED == aVerificationResultCode)</span>
<a href="#l11.104"></a><span id="l11.104">       signature_status = nsICMSMessageErrors::VERIFY_ERROR_PROCESSING;</span>
<a href="#l11.105"></a><span id="l11.105">   }</span>
<a href="#l11.106"></a><span id="l11.106">   else</span>
<a href="#l11.107"></a><span id="l11.107" class="difflineat">@@ -328,17 +328,17 @@ NS_IMETHODIMP nsSMimeVerificationListene</span>
<a href="#l11.108"></a><span id="l11.108">                                                 &amp;signing_cert_without_email_address);</span>
<a href="#l11.109"></a><span id="l11.109">     if (!good_p)</span>
<a href="#l11.110"></a><span id="l11.110">     {</span>
<a href="#l11.111"></a><span id="l11.111">       if (signing_cert_without_email_address)</span>
<a href="#l11.112"></a><span id="l11.112">         signature_status = nsICMSMessageErrors::VERIFY_CERT_WITHOUT_ADDRESS;</span>
<a href="#l11.113"></a><span id="l11.113">       else</span>
<a href="#l11.114"></a><span id="l11.114">         signature_status = nsICMSMessageErrors::VERIFY_HEADER_MISMATCH;</span>
<a href="#l11.115"></a><span id="l11.115">     }</span>
<a href="#l11.116"></a><span id="l11.116" class="difflineminus">-    else </span>
<a href="#l11.117"></a><span id="l11.117" class="difflineplus">+    else</span>
<a href="#l11.118"></a><span id="l11.118">       signature_status = nsICMSMessageErrors::SUCCESS;</span>
<a href="#l11.119"></a><span id="l11.119">   }</span>
<a href="#l11.120"></a><span id="l11.120"> </span>
<a href="#l11.121"></a><span id="l11.121">   ProxySignedStatus(mHeaderSink, mMimeNestingLevel, signature_status, signerCert);</span>
<a href="#l11.122"></a><span id="l11.122"> </span>
<a href="#l11.123"></a><span id="l11.123">   return NS_OK;</span>
<a href="#l11.124"></a><span id="l11.124"> }</span>
<a href="#l11.125"></a><span id="l11.125"> </span>
<a href="#l11.126"></a><span id="l11.126" class="difflineat">@@ -406,17 +406,17 @@ int MIMEGetRelativeCryptoNestLevel(MimeO</span>
<a href="#l11.127"></a><span id="l11.127">   if (!CryptoObjectIsChildOfTopShownObject) {</span>
<a href="#l11.128"></a><span id="l11.128">     return -1;</span>
<a href="#l11.129"></a><span id="l11.129">   }</span>
<a href="#l11.130"></a><span id="l11.130"> </span>
<a href="#l11.131"></a><span id="l11.131">   return aCryptoPartNestLevel - aTopMessageNestLevel;</span>
<a href="#l11.132"></a><span id="l11.132"> }</span>
<a href="#l11.133"></a><span id="l11.133"> </span>
<a href="#l11.134"></a><span id="l11.134"> static void *MimeCMS_init(MimeObject *obj,</span>
<a href="#l11.135"></a><span id="l11.135" class="difflineminus">-                          int (*output_fn) (const char *buf, int32_t buf_size, void *output_closure), </span>
<a href="#l11.136"></a><span id="l11.136" class="difflineplus">+                          int (*output_fn) (const char *buf, int32_t buf_size, void *output_closure),</span>
<a href="#l11.137"></a><span id="l11.137">                           void *output_closure)</span>
<a href="#l11.138"></a><span id="l11.138"> {</span>
<a href="#l11.139"></a><span id="l11.139">   MimeCMSdata *data;</span>
<a href="#l11.140"></a><span id="l11.140">   nsresult rv;</span>
<a href="#l11.141"></a><span id="l11.141"> </span>
<a href="#l11.142"></a><span id="l11.142">   if (!(obj &amp;&amp; obj-&gt;options &amp;&amp; output_fn)) return 0;</span>
<a href="#l11.143"></a><span id="l11.143"> </span>
<a href="#l11.144"></a><span id="l11.144">   data = new MimeCMSdata;</span>
<a href="#l11.145"></a><span id="l11.145" class="difflineat">@@ -567,23 +567,23 @@ void MimeCMSRequestAsyncSignatureVerific</span>
<a href="#l11.146"></a><span id="l11.146">                                               const char *aFromAddr, const char *aFromName,</span>
<a href="#l11.147"></a><span id="l11.147">                                               const char *aSenderAddr, const char *aSenderName,</span>
<a href="#l11.148"></a><span id="l11.148">                                               nsIMsgSMIMEHeaderSink *aHeaderSink, int32_t aMimeNestingLevel,</span>
<a href="#l11.149"></a><span id="l11.149">                                               unsigned char* item_data, uint32_t item_len)</span>
<a href="#l11.150"></a><span id="l11.150"> {</span>
<a href="#l11.151"></a><span id="l11.151">   nsCOMPtr&lt;nsICMSMessage2&gt; msg2 = do_QueryInterface(aCMSMsg);</span>
<a href="#l11.152"></a><span id="l11.152">   if (!msg2)</span>
<a href="#l11.153"></a><span id="l11.153">     return;</span>
<a href="#l11.154"></a><span id="l11.154" class="difflineminus">-  </span>
<a href="#l11.155"></a><span id="l11.155" class="difflineminus">-  RefPtr&lt;nsSMimeVerificationListener&gt; listener = </span>
<a href="#l11.156"></a><span id="l11.156" class="difflineplus">+</span>
<a href="#l11.157"></a><span id="l11.157" class="difflineplus">+  RefPtr&lt;nsSMimeVerificationListener&gt; listener =</span>
<a href="#l11.158"></a><span id="l11.158">     new nsSMimeVerificationListener(aFromAddr, aFromName, aSenderAddr, aSenderName,</span>
<a href="#l11.159"></a><span id="l11.159">                                     aHeaderSink, aMimeNestingLevel);</span>
<a href="#l11.160"></a><span id="l11.160">   if (!listener)</span>
<a href="#l11.161"></a><span id="l11.161">     return;</span>
<a href="#l11.162"></a><span id="l11.162" class="difflineminus">-  </span>
<a href="#l11.163"></a><span id="l11.163" class="difflineplus">+</span>
<a href="#l11.164"></a><span id="l11.164">   if (item_data)</span>
<a href="#l11.165"></a><span id="l11.165">     msg2-&gt;AsyncVerifyDetachedSignature(listener, item_data, item_len);</span>
<a href="#l11.166"></a><span id="l11.166">   else</span>
<a href="#l11.167"></a><span id="l11.167">     msg2-&gt;AsyncVerifySignature(listener);</span>
<a href="#l11.168"></a><span id="l11.168"> }</span>
<a href="#l11.169"></a><span id="l11.169"> </span>
<a href="#l11.170"></a><span id="l11.170"> static int</span>
<a href="#l11.171"></a><span id="l11.171"> MimeCMS_eof (void *crypto_closure, bool abort_p)</span>
<a href="#l11.172"></a><span id="l11.172" class="difflineat">@@ -606,17 +606,17 @@ MimeCMS_eof (void *crypto_closure, bool </span>
<a href="#l11.173"></a><span id="l11.173">    blurb about whether the signature validation was cool.</span>
<a href="#l11.174"></a><span id="l11.174">    */</span>
<a href="#l11.175"></a><span id="l11.175"> </span>
<a href="#l11.176"></a><span id="l11.176">   PR_SetError(0, 0);</span>
<a href="#l11.177"></a><span id="l11.177">   rv = data-&gt;decoder_context-&gt;Finish(getter_AddRefs(data-&gt;content_info));</span>
<a href="#l11.178"></a><span id="l11.178">   if (NS_FAILED(rv))</span>
<a href="#l11.179"></a><span id="l11.179">     status = nsICMSMessageErrors::GENERAL_ERROR;</span>
<a href="#l11.180"></a><span id="l11.180"> </span>
<a href="#l11.181"></a><span id="l11.181" class="difflineminus">-  data-&gt;decoder_context = 0;</span>
<a href="#l11.182"></a><span id="l11.182" class="difflineplus">+  data-&gt;decoder_context = nullptr;</span>
<a href="#l11.183"></a><span id="l11.183"> </span>
<a href="#l11.184"></a><span id="l11.184">   nsCOMPtr&lt;nsIX509Cert&gt; certOfInterest;</span>
<a href="#l11.185"></a><span id="l11.185"> </span>
<a href="#l11.186"></a><span id="l11.186">   if (!data-&gt;smimeHeaderSink)</span>
<a href="#l11.187"></a><span id="l11.187">     return 0;</span>
<a href="#l11.188"></a><span id="l11.188"> </span>
<a href="#l11.189"></a><span id="l11.189">   if (aRelativeNestLevel &lt; 0)</span>
<a href="#l11.190"></a><span id="l11.190">     return 0;</span>
<a href="#l11.191"></a><span id="l11.191" class="difflineat">@@ -670,24 +670,24 @@ MimeCMS_eof (void *crypto_closure, bool </span>
<a href="#l11.192"></a><span id="l11.192">         return 0;</span>
<a href="#l11.193"></a><span id="l11.193">       }</span>
<a href="#l11.194"></a><span id="l11.194"> </span>
<a href="#l11.195"></a><span id="l11.195">       nsCString from_addr;</span>
<a href="#l11.196"></a><span id="l11.196">       nsCString from_name;</span>
<a href="#l11.197"></a><span id="l11.197">       nsCString sender_addr;</span>
<a href="#l11.198"></a><span id="l11.198">       nsCString sender_name;</span>
<a href="#l11.199"></a><span id="l11.199"> </span>
<a href="#l11.200"></a><span id="l11.200" class="difflineminus">-      MimeCMSGetFromSender(data-&gt;self, </span>
<a href="#l11.201"></a><span id="l11.201" class="difflineplus">+      MimeCMSGetFromSender(data-&gt;self,</span>
<a href="#l11.202"></a><span id="l11.202">                            from_addr, from_name,</span>
<a href="#l11.203"></a><span id="l11.203">                            sender_addr, sender_name);</span>
<a href="#l11.204"></a><span id="l11.204"> </span>
<a href="#l11.205"></a><span id="l11.205" class="difflineminus">-      MimeCMSRequestAsyncSignatureVerification(data-&gt;content_info, </span>
<a href="#l11.206"></a><span id="l11.206" class="difflineplus">+      MimeCMSRequestAsyncSignatureVerification(data-&gt;content_info,</span>
<a href="#l11.207"></a><span id="l11.207">                                                from_addr.get(), from_name.get(),</span>
<a href="#l11.208"></a><span id="l11.208">                                                sender_addr.get(), sender_name.get(),</span>
<a href="#l11.209"></a><span id="l11.209" class="difflineminus">-                                               data-&gt;smimeHeaderSink, aRelativeNestLevel, </span>
<a href="#l11.210"></a><span id="l11.210" class="difflineplus">+                                               data-&gt;smimeHeaderSink, aRelativeNestLevel,</span>
<a href="#l11.211"></a><span id="l11.211">                                                nullptr, 0);</span>
<a href="#l11.212"></a><span id="l11.212">     }</span>
<a href="#l11.213"></a><span id="l11.213">   }</span>
<a href="#l11.214"></a><span id="l11.214"> </span>
<a href="#l11.215"></a><span id="l11.215">   if (data-&gt;ci_is_encrypted)</span>
<a href="#l11.216"></a><span id="l11.216">   {</span>
<a href="#l11.217"></a><span id="l11.217">     data-&gt;smimeHeaderSink-&gt;EncryptionStatus(</span>
<a href="#l11.218"></a><span id="l11.218">       aRelativeNestLevel,</span>
<a href="#l11.219"></a><span id="l11.219" class="difflineat">@@ -699,17 +699,17 @@ MimeCMS_eof (void *crypto_closure, bool </span>
<a href="#l11.220"></a><span id="l11.220">   return 0;</span>
<a href="#l11.221"></a><span id="l11.221"> }</span>
<a href="#l11.222"></a><span id="l11.222"> </span>
<a href="#l11.223"></a><span id="l11.223"> static void</span>
<a href="#l11.224"></a><span id="l11.224"> MimeCMS_free (void *crypto_closure)</span>
<a href="#l11.225"></a><span id="l11.225"> {</span>
<a href="#l11.226"></a><span id="l11.226">   MimeCMSdata *data = (MimeCMSdata *) crypto_closure;</span>
<a href="#l11.227"></a><span id="l11.227">   if (!data) return;</span>
<a href="#l11.228"></a><span id="l11.228" class="difflineminus">-  </span>
<a href="#l11.229"></a><span id="l11.229" class="difflineplus">+</span>
<a href="#l11.230"></a><span id="l11.230">   delete data;</span>
<a href="#l11.231"></a><span id="l11.231"> }</span>
<a href="#l11.232"></a><span id="l11.232"> </span>
<a href="#l11.233"></a><span id="l11.233"> static char *</span>
<a href="#l11.234"></a><span id="l11.234"> MimeCMS_generate (void *crypto_closure)</span>
<a href="#l11.235"></a><span id="l11.235"> {</span>
<a href="#l11.236"></a><span id="l11.236">   return nullptr;</span>
<a href="#l11.237"></a><span id="l11.237"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/mime/src/mimemcms.cpp</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/mime/src/mimemcms.cpp</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -296,17 +296,17 @@ MimeMultCMS_data_eof (void *crypto_closu</span>
<a href="#l12.4"></a><span id="l12.4"> </span>
<a href="#l12.5"></a><span id="l12.5">   data-&gt;item_len  = hashString.Length();</span>
<a href="#l12.6"></a><span id="l12.6">   data-&gt;item_data = new unsigned char[data-&gt;item_len];</span>
<a href="#l12.7"></a><span id="l12.7">   if (!data-&gt;item_data) return MIME_OUT_OF_MEMORY;</span>
<a href="#l12.8"></a><span id="l12.8"> </span>
<a href="#l12.9"></a><span id="l12.9">   memcpy(data-&gt;item_data, hashString.get(), data-&gt;item_len);</span>
<a href="#l12.10"></a><span id="l12.10"> </span>
<a href="#l12.11"></a><span id="l12.11">   // Release our reference to nsICryptoHash //</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-  data-&gt;data_hash_context = 0;</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+  data-&gt;data_hash_context = nullptr;</span>
<a href="#l12.14"></a><span id="l12.14"> </span>
<a href="#l12.15"></a><span id="l12.15">   /* At this point, data-&gt;item.data contains a digest for the first part.</span>
<a href="#l12.16"></a><span id="l12.16">    When we process the signature, the security library will compare this</span>
<a href="#l12.17"></a><span id="l12.17">    digest to what's in the signature object. */</span>
<a href="#l12.18"></a><span id="l12.18"> </span>
<a href="#l12.19"></a><span id="l12.19">   return 0;</span>
<a href="#l12.20"></a><span id="l12.20"> }</span>
<a href="#l12.21"></a><span id="l12.21"> </span>
<a href="#l12.22"></a><span id="l12.22" class="difflineat">@@ -378,17 +378,17 @@ MimeMultCMS_sig_eof (void *crypto_closur</span>
<a href="#l12.23"></a><span id="l12.23">    We save away the value returned and will use it later to emit a</span>
<a href="#l12.24"></a><span id="l12.24">    blurb about whether the signature validation was cool.</span>
<a href="#l12.25"></a><span id="l12.25">    */</span>
<a href="#l12.26"></a><span id="l12.26"> </span>
<a href="#l12.27"></a><span id="l12.27">   if (data-&gt;sig_decoder_context) {</span>
<a href="#l12.28"></a><span id="l12.28">     data-&gt;sig_decoder_context-&gt;Finish(getter_AddRefs(data-&gt;content_info));</span>
<a href="#l12.29"></a><span id="l12.29"> </span>
<a href="#l12.30"></a><span id="l12.30">     // Release our reference to nsICMSDecoder //</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineminus">-    data-&gt;sig_decoder_context = 0;</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineplus">+    data-&gt;sig_decoder_context = nullptr;</span>
<a href="#l12.33"></a><span id="l12.33">   }</span>
<a href="#l12.34"></a><span id="l12.34"> </span>
<a href="#l12.35"></a><span id="l12.35">   return 0;</span>
<a href="#l12.36"></a><span id="l12.36"> }</span>
<a href="#l12.37"></a><span id="l12.37"> </span>
<a href="#l12.38"></a><span id="l12.38"> static void</span>
<a href="#l12.39"></a><span id="l12.39"> MimeMultCMS_free (void *crypto_closure)</span>
<a href="#l12.40"></a><span id="l12.40"> {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/mime/src/mimemoz2.cpp</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/mime/src/mimemoz2.cpp</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -491,17 +491,17 @@ GenerateAttachmentData(MimeObject *objec</span>
<a href="#l13.4"></a><span id="l13.4"> </span>
<a href="#l13.5"></a><span id="l13.5"> nsresult</span>
<a href="#l13.6"></a><span id="l13.6"> BuildAttachmentList(MimeObject *anObject, nsMsgAttachmentData *aAttachData, const char *aMessageURL)</span>
<a href="#l13.7"></a><span id="l13.7"> {</span>
<a href="#l13.8"></a><span id="l13.8">   nsresult              rv;</span>
<a href="#l13.9"></a><span id="l13.9">   int32_t               i;</span>
<a href="#l13.10"></a><span id="l13.10">   MimeContainer         *cobj = (MimeContainer *) anObject;</span>
<a href="#l13.11"></a><span id="l13.11">   bool                  found_output = false;</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-  </span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+</span>
<a href="#l13.14"></a><span id="l13.14">   if ( (!anObject) || (!cobj-&gt;children) || (!cobj-&gt;nchildren) ||</span>
<a href="#l13.15"></a><span id="l13.15">        (mime_typep(anObject, (MimeObjectClass *)&amp;mimeExternalBodyClass)))</span>
<a href="#l13.16"></a><span id="l13.16">     return NS_OK;</span>
<a href="#l13.17"></a><span id="l13.17"> </span>
<a href="#l13.18"></a><span id="l13.18">   for (i = 0; i &lt; cobj-&gt;nchildren ; i++)</span>
<a href="#l13.19"></a><span id="l13.19">   {</span>
<a href="#l13.20"></a><span id="l13.20">     MimeObject    *child = cobj-&gt;children[i];</span>
<a href="#l13.21"></a><span id="l13.21">     char          *ct = child-&gt;content_type;</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineat">@@ -1525,17 +1525,17 @@ mime_bridge_create_display_stream(</span>
<a href="#l13.23"></a><span id="l13.23">     delete msd;</span>
<a href="#l13.24"></a><span id="l13.24">     return nullptr;</span>
<a href="#l13.25"></a><span id="l13.25">   }</span>
<a href="#l13.26"></a><span id="l13.26"> </span>
<a href="#l13.27"></a><span id="l13.27">   // Need the text converter...</span>
<a href="#l13.28"></a><span id="l13.28">   rv = CallCreateInstance(MOZ_TXTTOHTMLCONV_CONTRACTID, &amp;(msd-&gt;options-&gt;conv));</span>
<a href="#l13.29"></a><span id="l13.29">   if (NS_FAILED(rv))</span>
<a href="#l13.30"></a><span id="l13.30">   {</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineminus">-    msd-&gt;options-&gt;m_prefBranch = 0;</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineplus">+    msd-&gt;options-&gt;m_prefBranch = nullptr;</span>
<a href="#l13.33"></a><span id="l13.33">     delete msd;</span>
<a href="#l13.34"></a><span id="l13.34">     return nullptr;</span>
<a href="#l13.35"></a><span id="l13.35">   }</span>
<a href="#l13.36"></a><span id="l13.36"> </span>
<a href="#l13.37"></a><span id="l13.37">   //</span>
<a href="#l13.38"></a><span id="l13.38">   // Set the defaults, based on the context, and the output-type.</span>
<a href="#l13.39"></a><span id="l13.39">   //</span>
<a href="#l13.40"></a><span id="l13.40">   MIME_HeaderType = MimeHeadersAll;</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineat">@@ -1775,17 +1775,17 @@ mimeEmitterAddAllHeaders(MimeDisplayOpti</span>
<a href="#l13.42"></a><span id="l13.42"> </span>
<a href="#l13.43"></a><span id="l13.43">   mime_stream_data  *msd = GetMSD(opt);</span>
<a href="#l13.44"></a><span id="l13.44">   if (!msd)</span>
<a href="#l13.45"></a><span id="l13.45">     return NS_ERROR_FAILURE;</span>
<a href="#l13.46"></a><span id="l13.46"> </span>
<a href="#l13.47"></a><span id="l13.47">   if (msd-&gt;output_emitter)</span>
<a href="#l13.48"></a><span id="l13.48">   {</span>
<a href="#l13.49"></a><span id="l13.49">     nsIMimeEmitter *emitter = (nsIMimeEmitter *)msd-&gt;output_emitter;</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineminus">-    return emitter-&gt;AddAllHeaders(Substring(allheaders, </span>
<a href="#l13.51"></a><span id="l13.51" class="difflineplus">+    return emitter-&gt;AddAllHeaders(Substring(allheaders,</span>
<a href="#l13.52"></a><span id="l13.52">                                             allheaders + allheadersize));</span>
<a href="#l13.53"></a><span id="l13.53">   }</span>
<a href="#l13.54"></a><span id="l13.54"> </span>
<a href="#l13.55"></a><span id="l13.55">   return NS_ERROR_FAILURE;</span>
<a href="#l13.56"></a><span id="l13.56"> }</span>
<a href="#l13.57"></a><span id="l13.57"> </span>
<a href="#l13.58"></a><span id="l13.58"> extern &quot;C&quot; nsresult</span>
<a href="#l13.59"></a><span id="l13.59"> mimeEmitterStartAttachment(MimeDisplayOptions *opt, const char *name, const char *contentType, const char *url,</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

