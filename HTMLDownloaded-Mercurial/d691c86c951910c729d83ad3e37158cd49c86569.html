<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 28368:d691c86c951910c729d83ad3e37158cd49c86569</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ d691c86c951910c729d83ad3e37158cd49c86569" />
<meta property="og:url" content="/comm-central/rev/d691c86c951910c729d83ad3e37158cd49c86569" />
<meta property="og:description" content="Bug 507601 - Port |Bug 414038 - Replace rdf-driven folder pane with a js-driven/non-rdf treeview| to SeaMonkey - Move functions to folderPane.js gFolderTreeController. r=frg" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / d691c86c951910c729d83ad3e37158cd49c86569 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/d691c86c951910c729d83ad3e37158cd49c86569">shortlog</a> |
<a href="/comm-central/log/d691c86c951910c729d83ad3e37158cd49c86569">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/d691c86c951910c729d83ad3e37158cd49c86569">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/d691c86c951910c729d83ad3e37158cd49c86569">files</a> |
changeset |
<a href="/comm-central/raw-rev/d691c86c951910c729d83ad3e37158cd49c86569">raw</a>  | <a href="/comm-central/archive/d691c86c951910c729d83ad3e37158cd49c86569.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=507601">Bug 507601</a> - Port |<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=414038">Bug 414038</a> - Replace rdf-driven folder pane with a js-driven/non-rdf treeview| to SeaMonkey - Move functions to folderPane.js gFolderTreeController. r=frg
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#73;&#97;&#110;&#32;&#78;&#101;&#97;&#108;&#32;&#60;&#105;&#97;&#110;&#110;&#95;&#99;&#118;&#115;&#64;&#98;&#108;&#117;&#101;&#121;&#111;&#110;&#100;&#101;&#114;&#46;&#99;&#111;&#46;&#117;&#107;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 12 Dec 2019 19:49:40 +0100</td></tr>

<tr>
 <td>changeset 28368</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/d691c86c951910c729d83ad3e37158cd49c86569">d691c86c951910c729d83ad3e37158cd49c86569</a></td>
</tr>



<tr>
<td>parent 28367</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/8157030f14a55019fa7bbeb4e0bd9f9228c73f2d">8157030f14a55019fa7bbeb4e0bd9f9228c73f2d</a>
</td>
</tr>

<tr>
<td>child 28369</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/8876b708ba297b57ad0fb7f88f3c50b0c3b558ee">8876b708ba297b57ad0fb7f88f3c50b0c3b558ee</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=d691c86c951910c729d83ad3e37158cd49c86569">16801</a></td></tr>
<tr><td>push user</td><td>frgrahl@gmx.net</td></tr>
<tr><td>push date</td><td class="date age">Thu, 12 Dec 2019 18:51:32 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@bf911482c679 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=bf911482c6797b0b499817bb195dad8f43a39b3b">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=bf911482c6797b0b499817bb195dad8f43a39b3b&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=bf911482c6797b0b499817bb195dad8f43a39b3b&newProject=comm-central&newRevision=d691c86c951910c729d83ad3e37158cd49c86569&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=bf911482c6797b0b499817bb195dad8f43a39b3b&newProject=comm-central&newRevision=d691c86c951910c729d83ad3e37158cd49c86569&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=bf911482c6797b0b499817bb195dad8f43a39b3b&newProject=comm-central&newRevision=d691c86c951910c729d83ad3e37158cd49c86569&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28frg%29&revcount=50">frg</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=507601">507601</a>, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=414038">414038</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=507601">Bug 507601</a> - Port |<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=414038">Bug 414038</a> - Replace rdf-driven folder pane with a js-driven/non-rdf treeview| to SeaMonkey - Move functions to folderPane.js gFolderTreeController. r=frg</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d691c86c951910c729d83ad3e37158cd49c86569/suite/mailnews/content/folderPane.js">suite/mailnews/content/folderPane.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d691c86c951910c729d83ad3e37158cd49c86569/suite/mailnews/content/folderPane.js">file</a> |
<a href="/comm-central/annotate/d691c86c951910c729d83ad3e37158cd49c86569/suite/mailnews/content/folderPane.js">annotate</a> |
<a href="/comm-central/diff/d691c86c951910c729d83ad3e37158cd49c86569/suite/mailnews/content/folderPane.js">diff</a> |
<a href="/comm-central/comparison/d691c86c951910c729d83ad3e37158cd49c86569/suite/mailnews/content/folderPane.js">comparison</a> |
<a href="/comm-central/log/d691c86c951910c729d83ad3e37158cd49c86569/suite/mailnews/content/folderPane.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d691c86c951910c729d83ad3e37158cd49c86569/suite/mailnews/content/mail3PaneWindowCommands.js">suite/mailnews/content/mail3PaneWindowCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d691c86c951910c729d83ad3e37158cd49c86569/suite/mailnews/content/mail3PaneWindowCommands.js">file</a> |
<a href="/comm-central/annotate/d691c86c951910c729d83ad3e37158cd49c86569/suite/mailnews/content/mail3PaneWindowCommands.js">annotate</a> |
<a href="/comm-central/diff/d691c86c951910c729d83ad3e37158cd49c86569/suite/mailnews/content/mail3PaneWindowCommands.js">diff</a> |
<a href="/comm-central/comparison/d691c86c951910c729d83ad3e37158cd49c86569/suite/mailnews/content/mail3PaneWindowCommands.js">comparison</a> |
<a href="/comm-central/log/d691c86c951910c729d83ad3e37158cd49c86569/suite/mailnews/content/mail3PaneWindowCommands.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d691c86c951910c729d83ad3e37158cd49c86569/suite/mailnews/content/mailCommands.js">suite/mailnews/content/mailCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d691c86c951910c729d83ad3e37158cd49c86569/suite/mailnews/content/mailCommands.js">file</a> |
<a href="/comm-central/annotate/d691c86c951910c729d83ad3e37158cd49c86569/suite/mailnews/content/mailCommands.js">annotate</a> |
<a href="/comm-central/diff/d691c86c951910c729d83ad3e37158cd49c86569/suite/mailnews/content/mailCommands.js">diff</a> |
<a href="/comm-central/comparison/d691c86c951910c729d83ad3e37158cd49c86569/suite/mailnews/content/mailCommands.js">comparison</a> |
<a href="/comm-central/log/d691c86c951910c729d83ad3e37158cd49c86569/suite/mailnews/content/mailCommands.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d691c86c951910c729d83ad3e37158cd49c86569/suite/mailnews/content/mailWindowOverlay.js">suite/mailnews/content/mailWindowOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d691c86c951910c729d83ad3e37158cd49c86569/suite/mailnews/content/mailWindowOverlay.js">file</a> |
<a href="/comm-central/annotate/d691c86c951910c729d83ad3e37158cd49c86569/suite/mailnews/content/mailWindowOverlay.js">annotate</a> |
<a href="/comm-central/diff/d691c86c951910c729d83ad3e37158cd49c86569/suite/mailnews/content/mailWindowOverlay.js">diff</a> |
<a href="/comm-central/comparison/d691c86c951910c729d83ad3e37158cd49c86569/suite/mailnews/content/mailWindowOverlay.js">comparison</a> |
<a href="/comm-central/log/d691c86c951910c729d83ad3e37158cd49c86569/suite/mailnews/content/mailWindowOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d691c86c951910c729d83ad3e37158cd49c86569/suite/mailnews/content/mailWindowOverlay.xul">suite/mailnews/content/mailWindowOverlay.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d691c86c951910c729d83ad3e37158cd49c86569/suite/mailnews/content/mailWindowOverlay.xul">file</a> |
<a href="/comm-central/annotate/d691c86c951910c729d83ad3e37158cd49c86569/suite/mailnews/content/mailWindowOverlay.xul">annotate</a> |
<a href="/comm-central/diff/d691c86c951910c729d83ad3e37158cd49c86569/suite/mailnews/content/mailWindowOverlay.xul">diff</a> |
<a href="/comm-central/comparison/d691c86c951910c729d83ad3e37158cd49c86569/suite/mailnews/content/mailWindowOverlay.xul">comparison</a> |
<a href="/comm-central/log/d691c86c951910c729d83ad3e37158cd49c86569/suite/mailnews/content/mailWindowOverlay.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d691c86c951910c729d83ad3e37158cd49c86569/suite/mailnews/content/messageWindow.js">suite/mailnews/content/messageWindow.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d691c86c951910c729d83ad3e37158cd49c86569/suite/mailnews/content/messageWindow.js">file</a> |
<a href="/comm-central/annotate/d691c86c951910c729d83ad3e37158cd49c86569/suite/mailnews/content/messageWindow.js">annotate</a> |
<a href="/comm-central/diff/d691c86c951910c729d83ad3e37158cd49c86569/suite/mailnews/content/messageWindow.js">diff</a> |
<a href="/comm-central/comparison/d691c86c951910c729d83ad3e37158cd49c86569/suite/mailnews/content/messageWindow.js">comparison</a> |
<a href="/comm-central/log/d691c86c951910c729d83ad3e37158cd49c86569/suite/mailnews/content/messageWindow.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d691c86c951910c729d83ad3e37158cd49c86569/suite/mailnews/content/messenger.xul">suite/mailnews/content/messenger.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d691c86c951910c729d83ad3e37158cd49c86569/suite/mailnews/content/messenger.xul">file</a> |
<a href="/comm-central/annotate/d691c86c951910c729d83ad3e37158cd49c86569/suite/mailnews/content/messenger.xul">annotate</a> |
<a href="/comm-central/diff/d691c86c951910c729d83ad3e37158cd49c86569/suite/mailnews/content/messenger.xul">diff</a> |
<a href="/comm-central/comparison/d691c86c951910c729d83ad3e37158cd49c86569/suite/mailnews/content/messenger.xul">comparison</a> |
<a href="/comm-central/log/d691c86c951910c729d83ad3e37158cd49c86569/suite/mailnews/content/messenger.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d691c86c951910c729d83ad3e37158cd49c86569/suite/mailnews/content/msgViewPickerOverlay.js">suite/mailnews/content/msgViewPickerOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d691c86c951910c729d83ad3e37158cd49c86569/suite/mailnews/content/msgViewPickerOverlay.js">file</a> |
<a href="/comm-central/annotate/d691c86c951910c729d83ad3e37158cd49c86569/suite/mailnews/content/msgViewPickerOverlay.js">annotate</a> |
<a href="/comm-central/diff/d691c86c951910c729d83ad3e37158cd49c86569/suite/mailnews/content/msgViewPickerOverlay.js">diff</a> |
<a href="/comm-central/comparison/d691c86c951910c729d83ad3e37158cd49c86569/suite/mailnews/content/msgViewPickerOverlay.js">comparison</a> |
<a href="/comm-central/log/d691c86c951910c729d83ad3e37158cd49c86569/suite/mailnews/content/msgViewPickerOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d691c86c951910c729d83ad3e37158cd49c86569/suite/mailnews/content/widgetglue.js">suite/mailnews/content/widgetglue.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d691c86c951910c729d83ad3e37158cd49c86569/suite/mailnews/content/widgetglue.js">file</a> |
<a href="/comm-central/annotate/d691c86c951910c729d83ad3e37158cd49c86569/suite/mailnews/content/widgetglue.js">annotate</a> |
<a href="/comm-central/diff/d691c86c951910c729d83ad3e37158cd49c86569/suite/mailnews/content/widgetglue.js">diff</a> |
<a href="/comm-central/comparison/d691c86c951910c729d83ad3e37158cd49c86569/suite/mailnews/content/widgetglue.js">comparison</a> |
<a href="/comm-central/log/d691c86c951910c729d83ad3e37158cd49c86569/suite/mailnews/content/widgetglue.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d691c86c951910c729d83ad3e37158cd49c86569/suite/mailnews/jar.mn">suite/mailnews/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d691c86c951910c729d83ad3e37158cd49c86569/suite/mailnews/jar.mn">file</a> |
<a href="/comm-central/annotate/d691c86c951910c729d83ad3e37158cd49c86569/suite/mailnews/jar.mn">annotate</a> |
<a href="/comm-central/diff/d691c86c951910c729d83ad3e37158cd49c86569/suite/mailnews/jar.mn">diff</a> |
<a href="/comm-central/comparison/d691c86c951910c729d83ad3e37158cd49c86569/suite/mailnews/jar.mn">comparison</a> |
<a href="/comm-central/log/d691c86c951910c729d83ad3e37158cd49c86569/suite/mailnews/jar.mn">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1">new file mode 100644</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineminus">--- /dev/null</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineplus">+++ b/suite/mailnews/content/folderPane.js</span>
<a href="#l1.4"></a><span id="l1.4" class="difflineat">@@ -0,0 +1,356 @@</span>
<a href="#l1.5"></a><span id="l1.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l1.6"></a><span id="l1.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l1.7"></a><span id="l1.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l1.8"></a><span id="l1.8" class="difflineplus">+</span>
<a href="#l1.9"></a><span id="l1.9" class="difflineplus">+var { folderUtils } =</span>
<a href="#l1.10"></a><span id="l1.10" class="difflineplus">+  ChromeUtils.import(&quot;resource:///modules/folderUtils.jsm&quot;);</span>
<a href="#l1.11"></a><span id="l1.11" class="difflineplus">+var { iteratorUtils } =</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+  ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+var { Services } =</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+  ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+// Implements a tree of folders. It shows icons depending on folder type</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+// and other fancy styling.</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+// This is used in the main folder pane, but also some dialogs that need</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+// to show a nice list of folders.</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+/**</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineplus">+ * This handles the invocation of most commands dealing with folders, based off</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineplus">+ * of the current selection, or a passed in folder.</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineplus">+ */</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineplus">+var gFolderTreeController = {</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineplus">+  /**</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineplus">+   * Opens the dialog to create a new sub-folder, and creates it if the user</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineplus">+   * accepts</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineplus">+   *</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineplus">+   * @param aParent (optional)  the parent for the new subfolder</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+   */</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+  newFolder(aParent) {</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+    var preselectedFolder = aParent || GetFirstSelectedMsgFolder();</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+    var dualUseFolders = true;</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineplus">+    var server = null;</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineplus">+    var folder = null;</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineplus">+</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineplus">+    if (preselectedFolder) {</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineplus">+      try {</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+        server = preselectedFolder.server;</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineplus">+        if (server) {</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineplus">+         folder = getDestinationFolder(preselectedFolder, server);</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineplus">+</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineplus">+          var imapServer = server.QueryInterface(Ci.nsIImapIncomingServer);</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineplus">+          if (imapServer)</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineplus">+            dualUseFolders = imapServer.dualUseFolders;</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineplus">+        }</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineplus">+      } catch (e) {</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineplus">+        dump (&quot;Exception: dualUseFolders = true\n&quot;);</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineplus">+      }</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineplus">+    }</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineplus">+</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineplus">+    //xxx useless param</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineplus">+    function newFolderCallback(aName, aFolder) {</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineplus">+      if (aName)</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineplus">+        folder.createSubfolder(aName, msgWindow);</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineplus">+    }</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineplus">+</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineplus">+    window.openDialog(&quot;chrome://messenger/content/newFolderDialog.xul&quot;,</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineplus">+                      &quot;&quot;,</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineplus">+                      &quot;chrome,modal,centerscreen&quot;,</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineplus">+                      {folder: folder,</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineplus">+                       dualUseFolders: dualUseFolders,</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineplus">+                       okCallback: newFolderCallback});</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineplus">+  },</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineplus">+</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineplus">+  /**</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineplus">+   * Opens the dialog to edit the properties for a folder</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineplus">+   *</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineplus">+   * @param aTabID  (optional) the tab to show in the dialog</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineplus">+   * @param aFolder (optional) the folder to edit, if not the selected one</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineplus">+   */</span>
<a href="#l1.73"></a><span id="l1.73" class="difflineplus">+  editFolder(aTabID, aFolder) {</span>
<a href="#l1.74"></a><span id="l1.74" class="difflineplus">+    let folder = aFolder || GetSelectedMsgFolders()[0];</span>
<a href="#l1.75"></a><span id="l1.75" class="difflineplus">+</span>
<a href="#l1.76"></a><span id="l1.76" class="difflineplus">+    // If a server is selected, view settings for that account.</span>
<a href="#l1.77"></a><span id="l1.77" class="difflineplus">+    if (folder.isServer) {</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineplus">+      MsgAccountManager(null, folder.server);</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineplus">+      return;</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineplus">+    }</span>
<a href="#l1.81"></a><span id="l1.81" class="difflineplus">+</span>
<a href="#l1.82"></a><span id="l1.82" class="difflineplus">+    if (folder.flags &amp; Ci.nsMsgFolderFlags.Virtual) {</span>
<a href="#l1.83"></a><span id="l1.83" class="difflineplus">+      // virtual folders get their own property dialog that contains all of the</span>
<a href="#l1.84"></a><span id="l1.84" class="difflineplus">+      // search information related to the virtual folder.</span>
<a href="#l1.85"></a><span id="l1.85" class="difflineplus">+      this.editVirtualFolder(folder);</span>
<a href="#l1.86"></a><span id="l1.86" class="difflineplus">+      return;</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineplus">+    }</span>
<a href="#l1.88"></a><span id="l1.88" class="difflineplus">+</span>
<a href="#l1.89"></a><span id="l1.89" class="difflineplus">+    let title = gMessengerBundle.getString(&quot;folderProperties&quot;);</span>
<a href="#l1.90"></a><span id="l1.90" class="difflineplus">+</span>
<a href="#l1.91"></a><span id="l1.91" class="difflineplus">+    function editFolderCallback(aNewName, aOldName, aUri) {</span>
<a href="#l1.92"></a><span id="l1.92" class="difflineplus">+      if (aNewName != aOldName)</span>
<a href="#l1.93"></a><span id="l1.93" class="difflineplus">+        folder.rename(aNewName, msgWindow);</span>
<a href="#l1.94"></a><span id="l1.94" class="difflineplus">+    }</span>
<a href="#l1.95"></a><span id="l1.95" class="difflineplus">+</span>
<a href="#l1.96"></a><span id="l1.96" class="difflineplus">+    function rebuildSummary(msgFolder) {</span>
<a href="#l1.97"></a><span id="l1.97" class="difflineplus">+      if (msgFolder.locked) {</span>
<a href="#l1.98"></a><span id="l1.98" class="difflineplus">+        msgFolder.throwAlertMsg(&quot;operationFailedFolderBusy&quot;, msgWindow);</span>
<a href="#l1.99"></a><span id="l1.99" class="difflineplus">+        return;</span>
<a href="#l1.100"></a><span id="l1.100" class="difflineplus">+      }</span>
<a href="#l1.101"></a><span id="l1.101" class="difflineplus">+      let msgDB = msgFolder.msgDatabase;</span>
<a href="#l1.102"></a><span id="l1.102" class="difflineplus">+      msgDB.summaryValid = false;</span>
<a href="#l1.103"></a><span id="l1.103" class="difflineplus">+      try {</span>
<a href="#l1.104"></a><span id="l1.104" class="difflineplus">+        msgFolder.closeAndBackupFolderDB(&quot;&quot;);</span>
<a href="#l1.105"></a><span id="l1.105" class="difflineplus">+      }</span>
<a href="#l1.106"></a><span id="l1.106" class="difflineplus">+      catch(e) {</span>
<a href="#l1.107"></a><span id="l1.107" class="difflineplus">+        // In a failure, proceed anyway since we're dealing with problems</span>
<a href="#l1.108"></a><span id="l1.108" class="difflineplus">+        msgFolder.ForceDBClosed();</span>
<a href="#l1.109"></a><span id="l1.109" class="difflineplus">+      }</span>
<a href="#l1.110"></a><span id="l1.110" class="difflineplus">+      // these two lines will cause the thread pane to get reloaded</span>
<a href="#l1.111"></a><span id="l1.111" class="difflineplus">+      // when the download/reparse is finished. Only do this</span>
<a href="#l1.112"></a><span id="l1.112" class="difflineplus">+      // if the selected folder is loaded (i.e., not thru the</span>
<a href="#l1.113"></a><span id="l1.113" class="difflineplus">+      // context menu on a non-loaded folder).</span>
<a href="#l1.114"></a><span id="l1.114" class="difflineplus">+      if (msgFolder == GetLoadedMsgFolder()) {</span>
<a href="#l1.115"></a><span id="l1.115" class="difflineplus">+        gRerootOnFolderLoad = true;</span>
<a href="#l1.116"></a><span id="l1.116" class="difflineplus">+        gCurrentFolderToReroot = msgFolder.URI;</span>
<a href="#l1.117"></a><span id="l1.117" class="difflineplus">+      }</span>
<a href="#l1.118"></a><span id="l1.118" class="difflineplus">+      msgFolder.updateFolder(msgWindow);</span>
<a href="#l1.119"></a><span id="l1.119" class="difflineplus">+    }</span>
<a href="#l1.120"></a><span id="l1.120" class="difflineplus">+</span>
<a href="#l1.121"></a><span id="l1.121" class="difflineplus">+    window.openDialog(&quot;chrome://messenger/content/folderProps.xul&quot;,</span>
<a href="#l1.122"></a><span id="l1.122" class="difflineplus">+                      &quot;&quot;, &quot;chrome,modal,centerscreen&quot;,</span>
<a href="#l1.123"></a><span id="l1.123" class="difflineplus">+                      {folder: folder, serverType: folder.server.type,</span>
<a href="#l1.124"></a><span id="l1.124" class="difflineplus">+                       msgWindow: msgWindow, title: title,</span>
<a href="#l1.125"></a><span id="l1.125" class="difflineplus">+                       okCallback: editFolderCallback, tabID: aTabID,</span>
<a href="#l1.126"></a><span id="l1.126" class="difflineplus">+                       name: folder.prettyName,</span>
<a href="#l1.127"></a><span id="l1.127" class="difflineplus">+                       rebuildSummaryCallback: rebuildSummary});</span>
<a href="#l1.128"></a><span id="l1.128" class="difflineplus">+  },</span>
<a href="#l1.129"></a><span id="l1.129" class="difflineplus">+</span>
<a href="#l1.130"></a><span id="l1.130" class="difflineplus">+ /**</span>
<a href="#l1.131"></a><span id="l1.131" class="difflineplus">+   * Opens the dialog to rename a particular folder, and does the renaming if</span>
<a href="#l1.132"></a><span id="l1.132" class="difflineplus">+   * the user clicks OK in that dialog</span>
<a href="#l1.133"></a><span id="l1.133" class="difflineplus">+   *</span>
<a href="#l1.134"></a><span id="l1.134" class="difflineplus">+   * @param aFolder (optional)  the folder to rename, if different than the</span>
<a href="#l1.135"></a><span id="l1.135" class="difflineplus">+   *                            currently selected one</span>
<a href="#l1.136"></a><span id="l1.136" class="difflineplus">+   */</span>
<a href="#l1.137"></a><span id="l1.137" class="difflineplus">+  renameFolder(aFolder) {</span>
<a href="#l1.138"></a><span id="l1.138" class="difflineplus">+    let folder = aFolder || GetSelectedMsgFolders()[0];</span>
<a href="#l1.139"></a><span id="l1.139" class="difflineplus">+</span>
<a href="#l1.140"></a><span id="l1.140" class="difflineplus">+    function renameCallback(aName, aUri) {</span>
<a href="#l1.141"></a><span id="l1.141" class="difflineplus">+      let folderTree = GetFolderTree();</span>
<a href="#l1.142"></a><span id="l1.142" class="difflineplus">+      if (gDBView)</span>
<a href="#l1.143"></a><span id="l1.143" class="difflineplus">+        gCurrentlyDisplayedMessage = gDBView.currentlyDisplayedMessage;</span>
<a href="#l1.144"></a><span id="l1.144" class="difflineplus">+</span>
<a href="#l1.145"></a><span id="l1.145" class="difflineplus">+      ClearThreadPane();</span>
<a href="#l1.146"></a><span id="l1.146" class="difflineplus">+      ClearMessagePane();</span>
<a href="#l1.147"></a><span id="l1.147" class="difflineplus">+      folderTree.view.selection.clearSelection();</span>
<a href="#l1.148"></a><span id="l1.148" class="difflineplus">+</span>
<a href="#l1.149"></a><span id="l1.149" class="difflineplus">+      try {</span>
<a href="#l1.150"></a><span id="l1.150" class="difflineplus">+        folder.rename(aName, msgWindow);</span>
<a href="#l1.151"></a><span id="l1.151" class="difflineplus">+      }</span>
<a href="#l1.152"></a><span id="l1.152" class="difflineplus">+      catch(e) {</span>
<a href="#l1.153"></a><span id="l1.153" class="difflineplus">+        SelectFolder(folder.URI);  //restore selection</span>
<a href="#l1.154"></a><span id="l1.154" class="difflineplus">+        throw(e); // so that the dialog does not automatically close</span>
<a href="#l1.155"></a><span id="l1.155" class="difflineplus">+        dump (&quot;Exception : RenameFolder \n&quot;);</span>
<a href="#l1.156"></a><span id="l1.156" class="difflineplus">+      }</span>
<a href="#l1.157"></a><span id="l1.157" class="difflineplus">+    }</span>
<a href="#l1.158"></a><span id="l1.158" class="difflineplus">+</span>
<a href="#l1.159"></a><span id="l1.159" class="difflineplus">+    window.openDialog(&quot;chrome://messenger/content/renameFolderDialog.xul&quot;,</span>
<a href="#l1.160"></a><span id="l1.160" class="difflineplus">+                      &quot;&quot;, &quot;chrome,modal,centerscreen&quot;,</span>
<a href="#l1.161"></a><span id="l1.161" class="difflineplus">+                      {preselectedURI: folder.URI,</span>
<a href="#l1.162"></a><span id="l1.162" class="difflineplus">+                       okCallback: renameCallback, name: folder.prettyName});</span>
<a href="#l1.163"></a><span id="l1.163" class="difflineplus">+  },</span>
<a href="#l1.164"></a><span id="l1.164" class="difflineplus">+</span>
<a href="#l1.165"></a><span id="l1.165" class="difflineplus">+  /**</span>
<a href="#l1.166"></a><span id="l1.166" class="difflineplus">+   * Deletes a folder from its parent. Also handles unsubscribe from newsgroups</span>
<a href="#l1.167"></a><span id="l1.167" class="difflineplus">+   * if the selected folder/s happen to be nntp.</span>
<a href="#l1.168"></a><span id="l1.168" class="difflineplus">+   *</span>
<a href="#l1.169"></a><span id="l1.169" class="difflineplus">+   * @param aFolder (optional) the folder to delete, if not the selected one</span>
<a href="#l1.170"></a><span id="l1.170" class="difflineplus">+   */</span>
<a href="#l1.171"></a><span id="l1.171" class="difflineplus">+  deleteFolder(aFolder) {</span>
<a href="#l1.172"></a><span id="l1.172" class="difflineplus">+    let folders = aFolder ? [aFolder] : GetSelectedMsgFolders();</span>
<a href="#l1.173"></a><span id="l1.173" class="difflineplus">+    const NS_MSG_ERROR_COPY_FOLDER_ABORTED = 0x8055001a;</span>
<a href="#l1.174"></a><span id="l1.174" class="difflineplus">+    let prompt = Services.prompt;</span>
<a href="#l1.175"></a><span id="l1.175" class="difflineplus">+    for (let folder of folders) {</span>
<a href="#l1.176"></a><span id="l1.176" class="difflineplus">+      let specialFolder = getSpecialFolderString(folder);</span>
<a href="#l1.177"></a><span id="l1.177" class="difflineplus">+      if (specialFolder == &quot;Inbox&quot; || specialFolder == &quot;Trash&quot;)</span>
<a href="#l1.178"></a><span id="l1.178" class="difflineplus">+        continue;</span>
<a href="#l1.179"></a><span id="l1.179" class="difflineplus">+</span>
<a href="#l1.180"></a><span id="l1.180" class="difflineplus">+      if (folder.flags &amp; Ci.nsMsgFolderFlags.Virtual) {</span>
<a href="#l1.181"></a><span id="l1.181" class="difflineplus">+        let confirmation = gMessengerBundle.getString(&quot;confirmSavedSearchDeleteMessage&quot;);</span>
<a href="#l1.182"></a><span id="l1.182" class="difflineplus">+        let title = gMessengerBundle.getString(&quot;confirmSavedSearchDeleteTitle&quot;);</span>
<a href="#l1.183"></a><span id="l1.183" class="difflineplus">+        let buttonTitle = gMessengerBundle.getString(&quot;confirmSavedSearchDeleteButton&quot;);</span>
<a href="#l1.184"></a><span id="l1.184" class="difflineplus">+        let buttonFlags = prompt.BUTTON_TITLE_IS_STRING * prompt.BUTTON_POS_0 +</span>
<a href="#l1.185"></a><span id="l1.185" class="difflineplus">+                          prompt.BUTTON_TITLE_CANCEL * prompt.BUTTON_POS_1;</span>
<a href="#l1.186"></a><span id="l1.186" class="difflineplus">+        if (prompt.confirmEx(window, title, confirmation, buttonFlags, buttonTitle,</span>
<a href="#l1.187"></a><span id="l1.187" class="difflineplus">+                             &quot;&quot;, &quot;&quot;, &quot;&quot;, {}) != 0) /* the yes button is in position 0 */</span>
<a href="#l1.188"></a><span id="l1.188" class="difflineplus">+          continue;</span>
<a href="#l1.189"></a><span id="l1.189" class="difflineplus">+        if (gCurrentVirtualFolderUri == folder.URI)</span>
<a href="#l1.190"></a><span id="l1.190" class="difflineplus">+          gCurrentVirtualFolderUri = null;</span>
<a href="#l1.191"></a><span id="l1.191" class="difflineplus">+        let array = Cc[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l1.192"></a><span id="l1.192" class="difflineplus">+                      .createInstance(Ci.nsIMutableArray);</span>
<a href="#l1.193"></a><span id="l1.193" class="difflineplus">+        array.appendElement(folder);</span>
<a href="#l1.194"></a><span id="l1.194" class="difflineplus">+        folder.parent.deleteSubFolders(array, msgWindow);</span>
<a href="#l1.195"></a><span id="l1.195" class="difflineplus">+        continue;</span>
<a href="#l1.196"></a><span id="l1.196" class="difflineplus">+      }</span>
<a href="#l1.197"></a><span id="l1.197" class="difflineplus">+</span>
<a href="#l1.198"></a><span id="l1.198" class="difflineplus">+      if (isNewsURI(folder.URI)) {</span>
<a href="#l1.199"></a><span id="l1.199" class="difflineplus">+        let unsubscribe = ConfirmUnsubscribe(folder);</span>
<a href="#l1.200"></a><span id="l1.200" class="difflineplus">+        if (unsubscribe)</span>
<a href="#l1.201"></a><span id="l1.201" class="difflineplus">+          UnSubscribe(folder);</span>
<a href="#l1.202"></a><span id="l1.202" class="difflineplus">+      }</span>
<a href="#l1.203"></a><span id="l1.203" class="difflineplus">+      else if (specialFolder == &quot;Junk&quot; ?</span>
<a href="#l1.204"></a><span id="l1.204" class="difflineplus">+               CanRenameDeleteJunkMail(folder.URI) : folder.deletable) {</span>
<a href="#l1.205"></a><span id="l1.205" class="difflineplus">+        // We can delete this folder.</span>
<a href="#l1.206"></a><span id="l1.206" class="difflineplus">+        let array = Cc[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l1.207"></a><span id="l1.207" class="difflineplus">+                      .createInstance(Ci.nsIMutableArray);</span>
<a href="#l1.208"></a><span id="l1.208" class="difflineplus">+        array.appendElement(folder);</span>
<a href="#l1.209"></a><span id="l1.209" class="difflineplus">+        try {</span>
<a href="#l1.210"></a><span id="l1.210" class="difflineplus">+          folder.parent.deleteSubFolders(array, msgWindow);</span>
<a href="#l1.211"></a><span id="l1.211" class="difflineplus">+        }</span>
<a href="#l1.212"></a><span id="l1.212" class="difflineplus">+        // Ignore known errors from canceled warning dialogs.</span>
<a href="#l1.213"></a><span id="l1.213" class="difflineplus">+        catch (ex if (ex.result == NS_MSG_ERROR_COPY_FOLDER_ABORTED)) {}</span>
<a href="#l1.214"></a><span id="l1.214" class="difflineplus">+      }</span>
<a href="#l1.215"></a><span id="l1.215" class="difflineplus">+    }</span>
<a href="#l1.216"></a><span id="l1.216" class="difflineplus">+  },</span>
<a href="#l1.217"></a><span id="l1.217" class="difflineplus">+</span>
<a href="#l1.218"></a><span id="l1.218" class="difflineplus">+  /**</span>
<a href="#l1.219"></a><span id="l1.219" class="difflineplus">+   * Prompts the user to confirm and empties the trash for the selected folder</span>
<a href="#l1.220"></a><span id="l1.220" class="difflineplus">+   *</span>
<a href="#l1.221"></a><span id="l1.221" class="difflineplus">+   * @param aFolder (optional)  the trash folder to empty</span>
<a href="#l1.222"></a><span id="l1.222" class="difflineplus">+   * @note Calling this function on a non-trash folder will result in strange</span>
<a href="#l1.223"></a><span id="l1.223" class="difflineplus">+   *       behavior!</span>
<a href="#l1.224"></a><span id="l1.224" class="difflineplus">+   */</span>
<a href="#l1.225"></a><span id="l1.225" class="difflineplus">+  emptyTrash(aFolder) {</span>
<a href="#l1.226"></a><span id="l1.226" class="difflineplus">+    let folder = aFolder || GetSelectedMsgFolders()[0];</span>
<a href="#l1.227"></a><span id="l1.227" class="difflineplus">+    if (this._checkConfirmationPrompt(&quot;emptyTrash&quot;))</span>
<a href="#l1.228"></a><span id="l1.228" class="difflineplus">+      folder.emptyTrash(msgWindow, null);</span>
<a href="#l1.229"></a><span id="l1.229" class="difflineplus">+  },</span>
<a href="#l1.230"></a><span id="l1.230" class="difflineplus">+</span>
<a href="#l1.231"></a><span id="l1.231" class="difflineplus">+  /**</span>
<a href="#l1.232"></a><span id="l1.232" class="difflineplus">+   * Deletes everything (folders and messages) in this folder</span>
<a href="#l1.233"></a><span id="l1.233" class="difflineplus">+   *</span>
<a href="#l1.234"></a><span id="l1.234" class="difflineplus">+   * @param aFolder (optional)  the folder to empty</span>
<a href="#l1.235"></a><span id="l1.235" class="difflineplus">+   */</span>
<a href="#l1.236"></a><span id="l1.236" class="difflineplus">+  emptyJunk(aFolder) {</span>
<a href="#l1.237"></a><span id="l1.237" class="difflineplus">+    let folder = aFolder || GetSelectedMsgFolders()[0];</span>
<a href="#l1.238"></a><span id="l1.238" class="difflineplus">+</span>
<a href="#l1.239"></a><span id="l1.239" class="difflineplus">+    if (!this._checkConfirmationPrompt(&quot;emptyJunk&quot;))</span>
<a href="#l1.240"></a><span id="l1.240" class="difflineplus">+      return;</span>
<a href="#l1.241"></a><span id="l1.241" class="difflineplus">+</span>
<a href="#l1.242"></a><span id="l1.242" class="difflineplus">+    // Delete any sub-folders this folder might have.</span>
<a href="#l1.243"></a><span id="l1.243" class="difflineplus">+    let iter = folder.subFolders;</span>
<a href="#l1.244"></a><span id="l1.244" class="difflineplus">+    while (iter.hasMoreElements())</span>
<a href="#l1.245"></a><span id="l1.245" class="difflineplus">+      folder.propagateDelete(iter.getNext(), true, msgWindow);</span>
<a href="#l1.246"></a><span id="l1.246" class="difflineplus">+</span>
<a href="#l1.247"></a><span id="l1.247" class="difflineplus">+    let children = Cc[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l1.248"></a><span id="l1.248" class="difflineplus">+                     .createInstance(Ci.nsIMutableArray);</span>
<a href="#l1.249"></a><span id="l1.249" class="difflineplus">+</span>
<a href="#l1.250"></a><span id="l1.250" class="difflineplus">+    // Now delete the messages.</span>
<a href="#l1.251"></a><span id="l1.251" class="difflineplus">+    iter = folder.messages;</span>
<a href="#l1.252"></a><span id="l1.252" class="difflineplus">+    while (iter.hasMoreElements()) {</span>
<a href="#l1.253"></a><span id="l1.253" class="difflineplus">+      children.appendElement(iter.getNext());</span>
<a href="#l1.254"></a><span id="l1.254" class="difflineplus">+    }</span>
<a href="#l1.255"></a><span id="l1.255" class="difflineplus">+    folder.deleteMessages(children, msgWindow, true, false, null, false);</span>
<a href="#l1.256"></a><span id="l1.256" class="difflineplus">+    children.clear();</span>
<a href="#l1.257"></a><span id="l1.257" class="difflineplus">+  },</span>
<a href="#l1.258"></a><span id="l1.258" class="difflineplus">+</span>
<a href="#l1.259"></a><span id="l1.259" class="difflineplus">+  /**</span>
<a href="#l1.260"></a><span id="l1.260" class="difflineplus">+   * Compacts either a particular folder, or all folders</span>
<a href="#l1.261"></a><span id="l1.261" class="difflineplus">+   *</span>
<a href="#l1.262"></a><span id="l1.262" class="difflineplus">+   * @param aCompactAll - whether we should compact all folders</span>
<a href="#l1.263"></a><span id="l1.263" class="difflineplus">+   * @param aFolder (optional) the folder to compact, if different than the</span>
<a href="#l1.264"></a><span id="l1.264" class="difflineplus">+   *                           currently selected one</span>
<a href="#l1.265"></a><span id="l1.265" class="difflineplus">+   */</span>
<a href="#l1.266"></a><span id="l1.266" class="difflineplus">+  compactFolder(aCompactAll, aFolder) {</span>
<a href="#l1.267"></a><span id="l1.267" class="difflineplus">+    let folder = aFolder || GetSelectedMsgFolders()[0];</span>
<a href="#l1.268"></a><span id="l1.268" class="difflineplus">+    let isImapFolder = folder.server.type == &quot;imap&quot;;</span>
<a href="#l1.269"></a><span id="l1.269" class="difflineplus">+    if (!isImapFolder) {</span>
<a href="#l1.270"></a><span id="l1.270" class="difflineplus">+      if (folder.expungedBytes &gt; 0) {</span>
<a href="#l1.271"></a><span id="l1.271" class="difflineplus">+        if (gDBView) {</span>
<a href="#l1.272"></a><span id="l1.272" class="difflineplus">+          gCurrentlyDisplayedMessage = gDBView.currentlyDisplayedMessage;</span>
<a href="#l1.273"></a><span id="l1.273" class="difflineplus">+          if (gDBView.msgFolder == folder || aCompactAll) {</span>
<a href="#l1.274"></a><span id="l1.274" class="difflineplus">+            ClearThreadPaneSelection();</span>
<a href="#l1.275"></a><span id="l1.275" class="difflineplus">+            ClearThreadPane();</span>
<a href="#l1.276"></a><span id="l1.276" class="difflineplus">+            ClearMessagePane();</span>
<a href="#l1.277"></a><span id="l1.277" class="difflineplus">+          }</span>
<a href="#l1.278"></a><span id="l1.278" class="difflineplus">+        }</span>
<a href="#l1.279"></a><span id="l1.279" class="difflineplus">+      }</span>
<a href="#l1.280"></a><span id="l1.280" class="difflineplus">+      else {</span>
<a href="#l1.281"></a><span id="l1.281" class="difflineplus">+        if (!aCompactAll) // you have one local folder with no room to compact</span>
<a href="#l1.282"></a><span id="l1.282" class="difflineplus">+          return;</span>
<a href="#l1.283"></a><span id="l1.283" class="difflineplus">+      }</span>
<a href="#l1.284"></a><span id="l1.284" class="difflineplus">+    }</span>
<a href="#l1.285"></a><span id="l1.285" class="difflineplus">+    if (aCompactAll)</span>
<a href="#l1.286"></a><span id="l1.286" class="difflineplus">+      folder.compactAll(null, msgWindow, isImapFolder || folder.server.type == &quot;nntp&quot;);</span>
<a href="#l1.287"></a><span id="l1.287" class="difflineplus">+    else</span>
<a href="#l1.288"></a><span id="l1.288" class="difflineplus">+      folder.compact(null, msgWindow);</span>
<a href="#l1.289"></a><span id="l1.289" class="difflineplus">+  },</span>
<a href="#l1.290"></a><span id="l1.290" class="difflineplus">+</span>
<a href="#l1.291"></a><span id="l1.291" class="difflineplus">+  /**</span>
<a href="#l1.292"></a><span id="l1.292" class="difflineplus">+   * Opens the dialog to create a new virtual folder</span>
<a href="#l1.293"></a><span id="l1.293" class="difflineplus">+   *</span>
<a href="#l1.294"></a><span id="l1.294" class="difflineplus">+   * @param aName - the default name for the new folder</span>
<a href="#l1.295"></a><span id="l1.295" class="difflineplus">+   * @param aSearchTerms - the search terms associated with the folder</span>
<a href="#l1.296"></a><span id="l1.296" class="difflineplus">+   * @param aParent - the folder to run the search terms on</span>
<a href="#l1.297"></a><span id="l1.297" class="difflineplus">+   */</span>
<a href="#l1.298"></a><span id="l1.298" class="difflineplus">+  newVirtualFolder(aName, aSearchTerms, aParent) {</span>
<a href="#l1.299"></a><span id="l1.299" class="difflineplus">+    let folder = aParent || GetSelectedMsgFolders()[0];</span>
<a href="#l1.300"></a><span id="l1.300" class="difflineplus">+    let name = folder.prettyName;</span>
<a href="#l1.301"></a><span id="l1.301" class="difflineplus">+    if (aName)</span>
<a href="#l1.302"></a><span id="l1.302" class="difflineplus">+      name += &quot;-&quot; + aName;</span>
<a href="#l1.303"></a><span id="l1.303" class="difflineplus">+</span>
<a href="#l1.304"></a><span id="l1.304" class="difflineplus">+    window.openDialog(&quot;chrome://messenger/content/virtualFolderProperties.xul&quot;,</span>
<a href="#l1.305"></a><span id="l1.305" class="difflineplus">+                      &quot;&quot;, &quot;chrome,modal,centerscreen&quot;,</span>
<a href="#l1.306"></a><span id="l1.306" class="difflineplus">+                      {folder: folder, searchTerms: aSearchTems,</span>
<a href="#l1.307"></a><span id="l1.307" class="difflineplus">+                       newFolderName: name});</span>
<a href="#l1.308"></a><span id="l1.308" class="difflineplus">+  },</span>
<a href="#l1.309"></a><span id="l1.309" class="difflineplus">+</span>
<a href="#l1.310"></a><span id="l1.310" class="difflineplus">+  /**</span>
<a href="#l1.311"></a><span id="l1.311" class="difflineplus">+   * Opens the dialog to edit the properties for a virtual folder</span>
<a href="#l1.312"></a><span id="l1.312" class="difflineplus">+   *</span>
<a href="#l1.313"></a><span id="l1.313" class="difflineplus">+   * @param aFolder (optional) the folder to edit, if not the selected one</span>
<a href="#l1.314"></a><span id="l1.314" class="difflineplus">+   */</span>
<a href="#l1.315"></a><span id="l1.315" class="difflineplus">+  editVirtualFolder(aFolder) {</span>
<a href="#l1.316"></a><span id="l1.316" class="difflineplus">+    let folder = aFolder || GetSelectedMsgFolders()[0];</span>
<a href="#l1.317"></a><span id="l1.317" class="difflineplus">+</span>
<a href="#l1.318"></a><span id="l1.318" class="difflineplus">+    function editVirtualCallback(aURI) {</span>
<a href="#l1.319"></a><span id="l1.319" class="difflineplus">+      // we need to reload the folder if it is the currently loaded folder...</span>
<a href="#l1.320"></a><span id="l1.320" class="difflineplus">+      if (gMsgFolderSelected &amp;&amp; aURI == gMsgFolderSelected.URI) {</span>
<a href="#l1.321"></a><span id="l1.321" class="difflineplus">+        // force the folder pane to reload the virtual folder</span>
<a href="#l1.322"></a><span id="l1.322" class="difflineplus">+        gMsgFolderSelected = null;</span>
<a href="#l1.323"></a><span id="l1.323" class="difflineplus">+        FolderPaneSelectionChange();</span>
<a href="#l1.324"></a><span id="l1.324" class="difflineplus">+      }</span>
<a href="#l1.325"></a><span id="l1.325" class="difflineplus">+    }</span>
<a href="#l1.326"></a><span id="l1.326" class="difflineplus">+    window.openDialog(&quot;chrome://messenger/content/virtualFolderProperties.xul&quot;,</span>
<a href="#l1.327"></a><span id="l1.327" class="difflineplus">+                      &quot;&quot;, &quot;chrome,modal,centerscreen&quot;,</span>
<a href="#l1.328"></a><span id="l1.328" class="difflineplus">+                      {folder: folder, editExistingFolder: true,</span>
<a href="#l1.329"></a><span id="l1.329" class="difflineplus">+                       onOKCallback: editVirtualCallback,</span>
<a href="#l1.330"></a><span id="l1.330" class="difflineplus">+                       msgWindow:msgWindow});</span>
<a href="#l1.331"></a><span id="l1.331" class="difflineplus">+  },</span>
<a href="#l1.332"></a><span id="l1.332" class="difflineplus">+</span>
<a href="#l1.333"></a><span id="l1.333" class="difflineplus">+  /**</span>
<a href="#l1.334"></a><span id="l1.334" class="difflineplus">+   * Prompts for confirmation, if the user hasn't already chosen the &quot;don't ask</span>
<a href="#l1.335"></a><span id="l1.335" class="difflineplus">+   * again&quot; option.</span>
<a href="#l1.336"></a><span id="l1.336" class="difflineplus">+   *</span>
<a href="#l1.337"></a><span id="l1.337" class="difflineplus">+   * @param aCommand - the command to prompt for</span>
<a href="#l1.338"></a><span id="l1.338" class="difflineplus">+   */</span>
<a href="#l1.339"></a><span id="l1.339" class="difflineplus">+  _checkConfirmationPrompt(aCommand) {</span>
<a href="#l1.340"></a><span id="l1.340" class="difflineplus">+    const kDontAskAgainPref = &quot;mailnews.&quot; + aCommand + &quot;.dontAskAgain&quot;;</span>
<a href="#l1.341"></a><span id="l1.341" class="difflineplus">+    // default to ask user if the pref is not set</span>
<a href="#l1.342"></a><span id="l1.342" class="difflineplus">+    if (!Services.prefs.getBoolPref(kDontAskAgainPref, false)) {</span>
<a href="#l1.343"></a><span id="l1.343" class="difflineplus">+      let checkbox = {value: false};</span>
<a href="#l1.344"></a><span id="l1.344" class="difflineplus">+      let choice = Services.prompt.confirmEx(</span>
<a href="#l1.345"></a><span id="l1.345" class="difflineplus">+                     window,</span>
<a href="#l1.346"></a><span id="l1.346" class="difflineplus">+                     gMessengerBundle.getString(aCommand + &quot;Title&quot;),</span>
<a href="#l1.347"></a><span id="l1.347" class="difflineplus">+                     gMessengerBundle.getString(aCommand + &quot;Message&quot;),</span>
<a href="#l1.348"></a><span id="l1.348" class="difflineplus">+                     Services.prompt.STD_YES_NO_BUTTONS,</span>
<a href="#l1.349"></a><span id="l1.349" class="difflineplus">+                     null, null, null,</span>
<a href="#l1.350"></a><span id="l1.350" class="difflineplus">+                     gMessengerBundle.getString(aCommand + &quot;DontAsk&quot;),</span>
<a href="#l1.351"></a><span id="l1.351" class="difflineplus">+                     checkbox);</span>
<a href="#l1.352"></a><span id="l1.352" class="difflineplus">+      if (checkbox.value)</span>
<a href="#l1.353"></a><span id="l1.353" class="difflineplus">+        Services.prefs.setBoolPref(kDontAskAgainPref, true);</span>
<a href="#l1.354"></a><span id="l1.354" class="difflineplus">+</span>
<a href="#l1.355"></a><span id="l1.355" class="difflineplus">+      if (choice != 0)</span>
<a href="#l1.356"></a><span id="l1.356" class="difflineplus">+        return false;</span>
<a href="#l1.357"></a><span id="l1.357" class="difflineplus">+    }</span>
<a href="#l1.358"></a><span id="l1.358" class="difflineplus">+    return true;</span>
<a href="#l1.359"></a><span id="l1.359" class="difflineplus">+  },</span>
<a href="#l1.360"></a><span id="l1.360" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/suite/mailnews/content/mail3PaneWindowCommands.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/suite/mailnews/content/mail3PaneWindowCommands.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -85,17 +85,17 @@ var FolderPaneController =</span>
<a href="#l2.4"></a><span id="l2.4">     if (!this.isCommandEnabled(command)) return;</span>
<a href="#l2.5"></a><span id="l2.5"> </span>
<a href="#l2.6"></a><span id="l2.6">     switch ( command )</span>
<a href="#l2.7"></a><span id="l2.7">     {</span>
<a href="#l2.8"></a><span id="l2.8">       case &quot;cmd_delete&quot;:</span>
<a href="#l2.9"></a><span id="l2.9">       case &quot;cmd_shiftDelete&quot;:</span>
<a href="#l2.10"></a><span id="l2.10">       case &quot;button_delete&quot;:</span>
<a href="#l2.11"></a><span id="l2.11">       case &quot;button_shiftDelete&quot;:</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-        MsgDeleteFolder();</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+        gFolderTreeController.deleteFolder();</span>
<a href="#l2.14"></a><span id="l2.14">         break;</span>
<a href="#l2.15"></a><span id="l2.15">     }</span>
<a href="#l2.16"></a><span id="l2.16">   },</span>
<a href="#l2.17"></a><span id="l2.17"> </span>
<a href="#l2.18"></a><span id="l2.18">   onEvent: function(event)</span>
<a href="#l2.19"></a><span id="l2.19">   {</span>
<a href="#l2.20"></a><span id="l2.20">   }</span>
<a href="#l2.21"></a><span id="l2.21"> };</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineat">@@ -583,17 +583,17 @@ var DefaultController =</span>
<a href="#l2.23"></a><span id="l2.23">         break;</span>
<a href="#l2.24"></a><span id="l2.24">       case &quot;cmd_expandAllThreads&quot;:</span>
<a href="#l2.25"></a><span id="l2.25">                 gDBView.doCommand(nsMsgViewCommandType.expandAll);</span>
<a href="#l2.26"></a><span id="l2.26">         break;</span>
<a href="#l2.27"></a><span id="l2.27">       case &quot;cmd_collapseAllThreads&quot;:</span>
<a href="#l2.28"></a><span id="l2.28">                 gDBView.doCommand(nsMsgViewCommandType.collapseAll);</span>
<a href="#l2.29"></a><span id="l2.29">         break;</span>
<a href="#l2.30"></a><span id="l2.30">       case &quot;cmd_renameFolder&quot;:</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-        MsgRenameFolder();</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+        gFolderTreeController.renameFolder();</span>
<a href="#l2.33"></a><span id="l2.33">         return;</span>
<a href="#l2.34"></a><span id="l2.34">       case &quot;cmd_sendUnsentMsgs&quot;:</span>
<a href="#l2.35"></a><span id="l2.35">         MsgSendUnsentMsgs();</span>
<a href="#l2.36"></a><span id="l2.36">         return;</span>
<a href="#l2.37"></a><span id="l2.37">       case &quot;cmd_subscribe&quot;:</span>
<a href="#l2.38"></a><span id="l2.38">         MsgSubscribe();</span>
<a href="#l2.39"></a><span id="l2.39">         return;</span>
<a href="#l2.40"></a><span id="l2.40">       case &quot;cmd_openMessage&quot;:</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineat">@@ -613,32 +613,32 @@ var DefaultController =</span>
<a href="#l2.42"></a><span id="l2.42">         return;</span>
<a href="#l2.43"></a><span id="l2.43">       case &quot;cmd_saveAsTemplate&quot;:</span>
<a href="#l2.44"></a><span id="l2.44">         MsgSaveAsTemplate();</span>
<a href="#l2.45"></a><span id="l2.45">         return;</span>
<a href="#l2.46"></a><span id="l2.46">       case &quot;cmd_viewPageSource&quot;:</span>
<a href="#l2.47"></a><span id="l2.47">         MsgViewPageSource();</span>
<a href="#l2.48"></a><span id="l2.48">         return;</span>
<a href="#l2.49"></a><span id="l2.49">       case &quot;cmd_setFolderCharset&quot;:</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineminus">-        MsgFolderProperties();</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineplus">+        gFolderTreeController.editFolder();</span>
<a href="#l2.52"></a><span id="l2.52">         return;</span>
<a href="#l2.53"></a><span id="l2.53">       case &quot;cmd_reload&quot;:</span>
<a href="#l2.54"></a><span id="l2.54">         ReloadMessage();</span>
<a href="#l2.55"></a><span id="l2.55">         return;</span>
<a href="#l2.56"></a><span id="l2.56">       case &quot;cmd_find&quot;:</span>
<a href="#l2.57"></a><span id="l2.57">         MsgFind();</span>
<a href="#l2.58"></a><span id="l2.58">         return;</span>
<a href="#l2.59"></a><span id="l2.59">       case &quot;cmd_findNext&quot;:</span>
<a href="#l2.60"></a><span id="l2.60">         MsgFindAgain(false);</span>
<a href="#l2.61"></a><span id="l2.61">         return;</span>
<a href="#l2.62"></a><span id="l2.62">       case &quot;cmd_findPrev&quot;:</span>
<a href="#l2.63"></a><span id="l2.63">         MsgFindAgain(true);</span>
<a href="#l2.64"></a><span id="l2.64">         return;</span>
<a href="#l2.65"></a><span id="l2.65">       case &quot;cmd_properties&quot;:</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineminus">-        MsgFolderProperties();</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineplus">+        gFolderTreeController.editFolder();</span>
<a href="#l2.68"></a><span id="l2.68">         return;</span>
<a href="#l2.69"></a><span id="l2.69">       case &quot;button_search&quot;:</span>
<a href="#l2.70"></a><span id="l2.70">       case &quot;cmd_search&quot;:</span>
<a href="#l2.71"></a><span id="l2.71">         MsgSearchMessages();</span>
<a href="#l2.72"></a><span id="l2.72">         return;</span>
<a href="#l2.73"></a><span id="l2.73">       case &quot;button_mark&quot;:</span>
<a href="#l2.74"></a><span id="l2.74">       case &quot;cmd_markAsRead&quot;:</span>
<a href="#l2.75"></a><span id="l2.75">         MsgMarkMsgAsRead(null);</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineat">@@ -687,20 +687,20 @@ var DefaultController =</span>
<a href="#l2.77"></a><span id="l2.77">         return;</span>
<a href="#l2.78"></a><span id="l2.78">       case &quot;cmd_runJunkControls&quot;:</span>
<a href="#l2.79"></a><span id="l2.79">         filterFolderForJunk();</span>
<a href="#l2.80"></a><span id="l2.80">         return;</span>
<a href="#l2.81"></a><span id="l2.81">       case &quot;cmd_deleteJunk&quot;:</span>
<a href="#l2.82"></a><span id="l2.82">         deleteJunkInFolder();</span>
<a href="#l2.83"></a><span id="l2.83">         return;</span>
<a href="#l2.84"></a><span id="l2.84">       case &quot;cmd_emptyTrash&quot;:</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineminus">-        MsgEmptyTrash();</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineplus">+        gFolderTreeController.emptyTrash();</span>
<a href="#l2.87"></a><span id="l2.87">         return;</span>
<a href="#l2.88"></a><span id="l2.88">       case &quot;cmd_compactFolder&quot;:</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineminus">-        MsgCompactFolder(true);</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineplus">+        gFolderTreeController.compactFolder(true);</span>
<a href="#l2.91"></a><span id="l2.91">         return;</span>
<a href="#l2.92"></a><span id="l2.92">       case &quot;cmd_downloadFlagged&quot;:</span>
<a href="#l2.93"></a><span id="l2.93">         MsgDownloadFlagged();</span>
<a href="#l2.94"></a><span id="l2.94">         break;</span>
<a href="#l2.95"></a><span id="l2.95">       case &quot;cmd_downloadSelected&quot;:</span>
<a href="#l2.96"></a><span id="l2.96">         MsgDownloadSelected();</span>
<a href="#l2.97"></a><span id="l2.97">         break;</span>
<a href="#l2.98"></a><span id="l2.98">       case &quot;cmd_synchronizeOffline&quot;:</span>
<a href="#l2.99"></a><span id="l2.99" class="difflineat">@@ -901,76 +901,16 @@ function IsFolderSelected()</span>
<a href="#l2.100"></a><span id="l2.100">   return folders.length == 1 &amp;&amp; !folders[0].isServer;</span>
<a href="#l2.101"></a><span id="l2.101"> }</span>
<a href="#l2.102"></a><span id="l2.102"> </span>
<a href="#l2.103"></a><span id="l2.103"> function IsMessageDisplayedInMessagePane()</span>
<a href="#l2.104"></a><span id="l2.104"> {</span>
<a href="#l2.105"></a><span id="l2.105">   return (!IsMessagePaneCollapsed() &amp;&amp; (GetNumSelectedMessages() &gt; 0));</span>
<a href="#l2.106"></a><span id="l2.106"> }</span>
<a href="#l2.107"></a><span id="l2.107"> </span>
<a href="#l2.108"></a><span id="l2.108" class="difflineminus">-function MsgDeleteFolder()</span>
<a href="#l2.109"></a><span id="l2.109" class="difflineminus">-{</span>
<a href="#l2.110"></a><span id="l2.110" class="difflineminus">-  const NS_MSG_ERROR_COPY_FOLDER_ABORTED = 0x8055001a;</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineminus">-  var folderTree = GetFolderTree();</span>
<a href="#l2.112"></a><span id="l2.112" class="difflineminus">-  var selectedFolders = GetSelectedMsgFolders();</span>
<a href="#l2.113"></a><span id="l2.113" class="difflineminus">-  var prompt = Services.prompt;</span>
<a href="#l2.114"></a><span id="l2.114" class="difflineminus">-  for (var i = 0; i &lt; selectedFolders.length; i++)</span>
<a href="#l2.115"></a><span id="l2.115" class="difflineminus">-  {</span>
<a href="#l2.116"></a><span id="l2.116" class="difflineminus">-    var selectedFolder = selectedFolders[i];</span>
<a href="#l2.117"></a><span id="l2.117" class="difflineminus">-    let specialFolder = getSpecialFolderString(selectedFolder);</span>
<a href="#l2.118"></a><span id="l2.118" class="difflineminus">-    if (specialFolder != &quot;Inbox&quot; &amp;&amp; specialFolder != &quot;Trash&quot;)</span>
<a href="#l2.119"></a><span id="l2.119" class="difflineminus">-    {</span>
<a href="#l2.120"></a><span id="l2.120" class="difflineminus">-      var folder = selectedFolder.QueryInterface(Ci.nsIMsgFolder);</span>
<a href="#l2.121"></a><span id="l2.121" class="difflineminus">-      if (folder.flags &amp; Ci.nsMsgFolderFlags.Virtual)</span>
<a href="#l2.122"></a><span id="l2.122" class="difflineminus">-      {</span>
<a href="#l2.123"></a><span id="l2.123" class="difflineminus">-        var confirmation = gMessengerBundle.getString(&quot;confirmSavedSearchDeleteMessage&quot;);</span>
<a href="#l2.124"></a><span id="l2.124" class="difflineminus">-        var title = gMessengerBundle.getString(&quot;confirmSavedSearchDeleteTitle&quot;);</span>
<a href="#l2.125"></a><span id="l2.125" class="difflineminus">-        var buttonTitle = gMessengerBundle.getString(&quot;confirmSavedSearchDeleteButton&quot;);</span>
<a href="#l2.126"></a><span id="l2.126" class="difflineminus">-        var buttonFlags = prompt.BUTTON_TITLE_IS_STRING * prompt.BUTTON_POS_0 +</span>
<a href="#l2.127"></a><span id="l2.127" class="difflineminus">-                          prompt.BUTTON_TITLE_CANCEL * prompt.BUTTON_POS_1;</span>
<a href="#l2.128"></a><span id="l2.128" class="difflineminus">-        if (prompt.confirmEx(window, title, confirmation, buttonFlags, buttonTitle,</span>
<a href="#l2.129"></a><span id="l2.129" class="difflineminus">-                             &quot;&quot;, &quot;&quot;, &quot;&quot;, {}) != 0) /* the yes button is in position 0 */</span>
<a href="#l2.130"></a><span id="l2.130" class="difflineminus">-          continue;</span>
<a href="#l2.131"></a><span id="l2.131" class="difflineminus">-        if (gCurrentVirtualFolderUri == selectedFolder.URI)</span>
<a href="#l2.132"></a><span id="l2.132" class="difflineminus">-          gCurrentVirtualFolderUri = null;</span>
<a href="#l2.133"></a><span id="l2.133" class="difflineminus">-        var array = Cc[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l2.134"></a><span id="l2.134" class="difflineminus">-                      .createInstance(Ci.nsIMutableArray);</span>
<a href="#l2.135"></a><span id="l2.135" class="difflineminus">-        array.appendElement(folder);</span>
<a href="#l2.136"></a><span id="l2.136" class="difflineminus">-        folder.parent.deleteSubFolders(array, msgWindow);</span>
<a href="#l2.137"></a><span id="l2.137" class="difflineminus">-        continue;</span>
<a href="#l2.138"></a><span id="l2.138" class="difflineminus">-      }</span>
<a href="#l2.139"></a><span id="l2.139" class="difflineminus">-</span>
<a href="#l2.140"></a><span id="l2.140" class="difflineminus">-      if (isNewsURI(selectedFolder.URI))</span>
<a href="#l2.141"></a><span id="l2.141" class="difflineminus">-      {</span>
<a href="#l2.142"></a><span id="l2.142" class="difflineminus">-        var unsubscribe = ConfirmUnsubscribe(selectedFolder);</span>
<a href="#l2.143"></a><span id="l2.143" class="difflineminus">-        if (unsubscribe)</span>
<a href="#l2.144"></a><span id="l2.144" class="difflineminus">-          UnSubscribe(selectedFolder);</span>
<a href="#l2.145"></a><span id="l2.145" class="difflineminus">-      }</span>
<a href="#l2.146"></a><span id="l2.146" class="difflineminus">-      else if (specialFolder == &quot;Junk&quot; ?</span>
<a href="#l2.147"></a><span id="l2.147" class="difflineminus">-             CanRenameDeleteJunkMail(folder.URI) : folder.deletable)</span>
<a href="#l2.148"></a><span id="l2.148" class="difflineminus">-      {</span>
<a href="#l2.149"></a><span id="l2.149" class="difflineminus">-        // We can delete this folder.</span>
<a href="#l2.150"></a><span id="l2.150" class="difflineminus">-        var array = Cc[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l2.151"></a><span id="l2.151" class="difflineminus">-                      .createInstance(Ci.nsIMutableArray);</span>
<a href="#l2.152"></a><span id="l2.152" class="difflineminus">-        array.appendElement(selectedFolder);</span>
<a href="#l2.153"></a><span id="l2.153" class="difflineminus">-        try</span>
<a href="#l2.154"></a><span id="l2.154" class="difflineminus">-        {</span>
<a href="#l2.155"></a><span id="l2.155" class="difflineminus">-          selectedFolder.parent.deleteSubFolders(array, msgWindow);</span>
<a href="#l2.156"></a><span id="l2.156" class="difflineminus">-        }</span>
<a href="#l2.157"></a><span id="l2.157" class="difflineminus">-        // Ignore known errors from canceled warning dialogs.</span>
<a href="#l2.158"></a><span id="l2.158" class="difflineminus">-        catch (ex) {</span>
<a href="#l2.159"></a><span id="l2.159" class="difflineminus">-          if (ex.result != NS_MSG_ERROR_COPY_FOLDER_ABORTED) {</span>
<a href="#l2.160"></a><span id="l2.160" class="difflineminus">-            throw ex;</span>
<a href="#l2.161"></a><span id="l2.161" class="difflineminus">-          }</span>
<a href="#l2.162"></a><span id="l2.162" class="difflineminus">-        }</span>
<a href="#l2.163"></a><span id="l2.163" class="difflineminus">-      }</span>
<a href="#l2.164"></a><span id="l2.164" class="difflineminus">-    }</span>
<a href="#l2.165"></a><span id="l2.165" class="difflineminus">-  }</span>
<a href="#l2.166"></a><span id="l2.166" class="difflineminus">-}</span>
<a href="#l2.167"></a><span id="l2.167" class="difflineminus">-</span>
<a href="#l2.168"></a><span id="l2.168"> function SetFocusThreadPaneIfNotOnMessagePane()</span>
<a href="#l2.169"></a><span id="l2.169"> {</span>
<a href="#l2.170"></a><span id="l2.170">   var focusedElement = gFolderDisplay.focusedPane;</span>
<a href="#l2.171"></a><span id="l2.171"> </span>
<a href="#l2.172"></a><span id="l2.172">   if((focusedElement != GetThreadTree()) &amp;&amp;</span>
<a href="#l2.173"></a><span id="l2.173">      (focusedElement != GetMessagePane()))</span>
<a href="#l2.174"></a><span id="l2.174">      SetFocusThreadPane();</span>
<a href="#l2.175"></a><span id="l2.175"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/suite/mailnews/content/mailCommands.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/suite/mailnews/content/mailCommands.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -258,24 +258,16 @@ function NewMessageToSelectedAddresses(t</span>
<a href="#l3.4"></a><span id="l3.4">       }</span>
<a href="#l3.5"></a><span id="l3.5">       composeFields.to = addressList.join(&quot;,&quot;);</span>
<a href="#l3.6"></a><span id="l3.6">       params.composeFields = composeFields;</span>
<a href="#l3.7"></a><span id="l3.7">       msgComposeService.OpenComposeWindowWithParams(null, params);</span>
<a href="#l3.8"></a><span id="l3.8">     }</span>
<a href="#l3.9"></a><span id="l3.9">   }</span>
<a href="#l3.10"></a><span id="l3.10"> }</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-function NewFolder(name, folder)</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-{</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-  if (!folder || !name)</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">-    return;</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineminus">-</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineminus">-  folder.createSubfolder(name, msgWindow);</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineminus">-}</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineminus">-</span>
<a href="#l3.20"></a><span id="l3.20"> function UnSubscribe(folder)</span>
<a href="#l3.21"></a><span id="l3.21"> {</span>
<a href="#l3.22"></a><span id="l3.22">   // Unsubscribe the current folder from the newsserver, this assumes any confirmation has already</span>
<a href="#l3.23"></a><span id="l3.23">   // been made by the user  SPL</span>
<a href="#l3.24"></a><span id="l3.24"> </span>
<a href="#l3.25"></a><span id="l3.25">   var server = folder.server;</span>
<a href="#l3.26"></a><span id="l3.26">   var subscribableServer = server.QueryInterface(Ci.nsISubscribableServer);</span>
<a href="#l3.27"></a><span id="l3.27">   subscribableServer.unsubscribe(folder.name);</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineat">@@ -447,65 +439,8 @@ function ViewPageSource(messages)</span>
<a href="#l3.29"></a><span id="l3.29">         return false;</span>
<a href="#l3.30"></a><span id="l3.30">     }</span>
<a href="#l3.31"></a><span id="l3.31"> }</span>
<a href="#l3.32"></a><span id="l3.32"> </span>
<a href="#l3.33"></a><span id="l3.33"> function doHelpButton()</span>
<a href="#l3.34"></a><span id="l3.34"> {</span>
<a href="#l3.35"></a><span id="l3.35">     openHelp(&quot;mail-offline-items&quot;);</span>
<a href="#l3.36"></a><span id="l3.36"> }</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineminus">-</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineminus">-function confirmToProceed(commandName)</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineminus">-{</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineminus">-  const kDontAskAgainPref = &quot;mailnews.&quot;+commandName+&quot;.dontAskAgain&quot;;</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineminus">-  // default to ask user if the pref is not set</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineminus">-  var dontAskAgain = false;</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineminus">-  try {</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineminus">-    dontAskAgain = Services.prefs.getBoolPref(kDontAskAgainPref);</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineminus">-  } catch (ex) {}</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineminus">-</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineminus">-  if (!dontAskAgain)</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineminus">-  {</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineminus">-    var checkbox = {value:false};</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineminus">-    var choice = Services.prompt.confirmEx(</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineminus">-                   window,</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineminus">-                   gMessengerBundle.getString(commandName+&quot;Title&quot;),</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineminus">-                   gMessengerBundle.getString(commandName+&quot;Message&quot;),</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineminus">-                   Services.prompt.STD_YES_NO_BUTTONS,</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineminus">-                   null, null, null,</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineminus">-                   gMessengerBundle.getString(commandName+&quot;DontAsk&quot;),</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineminus">-                   checkbox);</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineminus">-    try {</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineminus">-      if (checkbox.value)</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineminus">-        Services.prefs.setBoolPref(kDontAskAgainPref, true);</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineminus">-    } catch (ex) {}</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineminus">-</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineminus">-    if (choice != 0)</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineminus">-      return false;</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineminus">-  }</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineminus">-  return true;</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineminus">-}</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineminus">-</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineminus">-function deleteAllInFolder(commandName)</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineminus">-{</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineminus">-  var folder = GetMsgFolderFromUri(GetSelectedFolderURI(), true);</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineminus">-  if (!folder)</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineminus">-    return;</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineminus">-</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineminus">-  if (!confirmToProceed(commandName))</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineminus">-    return;</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineminus">-</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineminus">-  // Delete sub-folders.</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineminus">-  var iter = folder.subFolders;</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineminus">-  while (iter.hasMoreElements())</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineminus">-    folder.propagateDelete(iter.getNext(), true, msgWindow);</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineminus">-</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineminus">-  var children = Cc[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineminus">-                  .createInstance(Ci.nsIMutableArray);</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineminus">-</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineminus">-  // Delete messages.</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineminus">-  iter = folder.messages;</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineminus">-  while (iter.hasMoreElements()) {</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineminus">-    children.appendElement(iter.getNext());</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineminus">-  }</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineminus">-  folder.deleteMessages(children, msgWindow, true, false, null, false);</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineminus">-  children.clear();</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/suite/mailnews/content/mailWindowOverlay.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/suite/mailnews/content/mailWindowOverlay.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -1434,48 +1434,16 @@ function MsgCreateFilter()</span>
<a href="#l4.4"></a><span id="l4.4">   }</span>
<a href="#l4.5"></a><span id="l4.5">   if (!folder)</span>
<a href="#l4.6"></a><span id="l4.6">     folder = GetFirstSelectedMsgFolder();</span>
<a href="#l4.7"></a><span id="l4.7"> </span>
<a href="#l4.8"></a><span id="l4.8">     if (emailAddress)</span>
<a href="#l4.9"></a><span id="l4.9">      top.MsgFilters(emailAddress, folder);</span>
<a href="#l4.10"></a><span id="l4.10"> }</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-function MsgNewFolder(callBackFunctionName)</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-{</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-    var preselectedFolder = GetFirstSelectedMsgFolder();</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineminus">-    var dualUseFolders = true;</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineminus">-    var server = null;</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineminus">-    var destinationFolder = null;</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineminus">-</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineminus">-    if (preselectedFolder)</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineminus">-    {</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineminus">-        try {</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineminus">-            server = preselectedFolder.server;</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineminus">-            if (server)</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineminus">-            {</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineminus">-                destinationFolder = getDestinationFolder(preselectedFolder, server);</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineminus">-</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineminus">-                var imapServer =</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineminus">-                    server.QueryInterface(Ci.nsIImapIncomingServer);</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineminus">-                if (imapServer)</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineminus">-                    dualUseFolders = imapServer.dualUseFolders;</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineminus">-            }</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineminus">-        } catch (e) {</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineminus">-            dump (&quot;Exception: dualUseFolders = true\n&quot;);</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineminus">-        }</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineminus">-    }</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineminus">-    window.openDialog(&quot;chrome://messenger/content/newFolderDialog.xul&quot;,</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineminus">-                      &quot;&quot;,</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineminus">-                      &quot;chrome,modal,centerscreen&quot;,</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineminus">-                      {folder: destinationFolder,</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineminus">-                       dualUseFolders: dualUseFolders,</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineminus">-                       okCallback:callBackFunctionName});</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineminus">-}</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineminus">-</span>
<a href="#l4.44"></a><span id="l4.44"> function getDestinationFolder(preselectedFolder, server)</span>
<a href="#l4.45"></a><span id="l4.45"> {</span>
<a href="#l4.46"></a><span id="l4.46">     var destinationFolder = null;</span>
<a href="#l4.47"></a><span id="l4.47"> </span>
<a href="#l4.48"></a><span id="l4.48">     var isCreateSubfolders = preselectedFolder.canCreateSubfolders;</span>
<a href="#l4.49"></a><span id="l4.49">     if (!isCreateSubfolders)</span>
<a href="#l4.50"></a><span id="l4.50">     {</span>
<a href="#l4.51"></a><span id="l4.51">         destinationFolder = server.rootMsgFolder;</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineat">@@ -1570,22 +1538,22 @@ function MsgOpenFromFile()</span>
<a href="#l4.53"></a><span id="l4.53"> }</span>
<a href="#l4.54"></a><span id="l4.54"> </span>
<a href="#l4.55"></a><span id="l4.55"> function MsgOpenNewWindowForFolder(uri, key)</span>
<a href="#l4.56"></a><span id="l4.56"> {</span>
<a href="#l4.57"></a><span id="l4.57">   var uriToOpen = uri;</span>
<a href="#l4.58"></a><span id="l4.58">   var keyToSelect = key;</span>
<a href="#l4.59"></a><span id="l4.59"> </span>
<a href="#l4.60"></a><span id="l4.60">   if (!uriToOpen)</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineminus">-    // use GetSelectedFolderURI() to find out which message to open instead of</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineminus">-    // GetLoadedMsgFolder().URI.</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineminus">-    // This is required because on a right-click, the currentIndex value will be</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineminus">-    // different from the actual row that is highlighted.  GetSelectedFolderURI()</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineminus">-    // will return the message that is highlighted.</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineminus">-    uriToOpen = GetSelectedFolderURI();</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineplus">+    // Use GetSelectedMsgFolders() to find out which message to open instead of</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineplus">+    // GetLoadedMsgFolder().URI. This is required because on a right-click, the</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineplus">+    // currentIndex value will be different from the actual row that is</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineplus">+    // highlighted. GetSelectedMsgFolders() will return the message that is</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineplus">+    // highlighted.</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineplus">+    uriToOpen = GetSelectedMsgFolders()[0].URI;</span>
<a href="#l4.73"></a><span id="l4.73"> </span>
<a href="#l4.74"></a><span id="l4.74">   if (uriToOpen) {</span>
<a href="#l4.75"></a><span id="l4.75">    // get the messenger window open service and ask it to open a new window for us</span>
<a href="#l4.76"></a><span id="l4.76">    var mailWindowService = Cc[&quot;@mozilla.org/messenger/windowservice;1&quot;].getService(Ci.nsIMessengerWindowService);</span>
<a href="#l4.77"></a><span id="l4.77">    if (mailWindowService)</span>
<a href="#l4.78"></a><span id="l4.78">      mailWindowService.openMessengerWindowWithUri(&quot;mail:3pane&quot;, uriToOpen, keyToSelect);</span>
<a href="#l4.79"></a><span id="l4.79">   }</span>
<a href="#l4.80"></a><span id="l4.80"> }</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineat">@@ -1699,23 +1667,23 @@ function MsgOpenSearch(aSearchStr, aEven</span>
<a href="#l4.82"></a><span id="l4.82"> }</span>
<a href="#l4.83"></a><span id="l4.83"> </span>
<a href="#l4.84"></a><span id="l4.84"> function MsgOpenNewWindowForMessage(messageUri, folderUri)</span>
<a href="#l4.85"></a><span id="l4.85"> {</span>
<a href="#l4.86"></a><span id="l4.86">   if (!messageUri)</span>
<a href="#l4.87"></a><span id="l4.87">     messageUri = gFolderDisplay.selectedMessageUri;</span>
<a href="#l4.88"></a><span id="l4.88"> </span>
<a href="#l4.89"></a><span id="l4.89">     if (!folderUri)</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineminus">-        // use GetSelectedFolderURI() to find out which message to open</span>
<a href="#l4.91"></a><span id="l4.91" class="difflineplus">+        // Use GetSelectedMsgFolders() to find out which message to open</span>
<a href="#l4.92"></a><span id="l4.92">         // instead of gDBView.getURIForViewIndex(currentIndex).  This is</span>
<a href="#l4.93"></a><span id="l4.93">         // required because on a right-click, the currentIndex value will be</span>
<a href="#l4.94"></a><span id="l4.94">         // different from the actual row that is highlighted.</span>
<a href="#l4.95"></a><span id="l4.95" class="difflineminus">-        // GetSelectedFolderURI() will return the message that is</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineplus">+        // GetSelectedMsgFolders() will return the message that is</span>
<a href="#l4.97"></a><span id="l4.97">         // highlighted.</span>
<a href="#l4.98"></a><span id="l4.98" class="difflineminus">-        folderUri = GetSelectedFolderURI();</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineplus">+        folderUri = GetSelectedMsgFolders()[0].URI;</span>
<a href="#l4.100"></a><span id="l4.100"> </span>
<a href="#l4.101"></a><span id="l4.101">     // be sure to pass in the current view....</span>
<a href="#l4.102"></a><span id="l4.102">     if (messageUri &amp;&amp; folderUri) {</span>
<a href="#l4.103"></a><span id="l4.103">         window.openDialog( &quot;chrome://messenger/content/messageWindow.xul&quot;, &quot;_blank&quot;, &quot;all,chrome,dialog=no,status,toolbar&quot;, messageUri, folderUri, gDBView );</span>
<a href="#l4.104"></a><span id="l4.104">     }</span>
<a href="#l4.105"></a><span id="l4.105"> }</span>
<a href="#l4.106"></a><span id="l4.106"> </span>
<a href="#l4.107"></a><span id="l4.107"> function CloseMailWindow()</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineat">@@ -1749,20 +1717,20 @@ function MsgMarkReadByDate()</span>
<a href="#l4.109"></a><span id="l4.109"> {</span>
<a href="#l4.110"></a><span id="l4.110">     window.openDialog( &quot;chrome://messenger/content/markByDate.xul&quot;,&quot;&quot;,</span>
<a href="#l4.111"></a><span id="l4.111">                        &quot;chrome,modal,titlebar,centerscreen&quot;,</span>
<a href="#l4.112"></a><span id="l4.112">                        GetLoadedMsgFolder() );</span>
<a href="#l4.113"></a><span id="l4.113"> }</span>
<a href="#l4.114"></a><span id="l4.114"> </span>
<a href="#l4.115"></a><span id="l4.115"> function MsgMarkAllRead()</span>
<a href="#l4.116"></a><span id="l4.116"> {</span>
<a href="#l4.117"></a><span id="l4.117" class="difflineminus">-    var folder = GetMsgFolderFromUri(GetSelectedFolderURI(), true);</span>
<a href="#l4.118"></a><span id="l4.118" class="difflineminus">-</span>
<a href="#l4.119"></a><span id="l4.119" class="difflineminus">-    if(folder)</span>
<a href="#l4.120"></a><span id="l4.120" class="difflineminus">-        folder.markAllMessagesRead(msgWindow);</span>
<a href="#l4.121"></a><span id="l4.121" class="difflineplus">+  var folder = GetSelectedMsgFolders()[0];</span>
<a href="#l4.122"></a><span id="l4.122" class="difflineplus">+</span>
<a href="#l4.123"></a><span id="l4.123" class="difflineplus">+  if (folder)</span>
<a href="#l4.124"></a><span id="l4.124" class="difflineplus">+    folder.markAllMessagesRead(msgWindow);</span>
<a href="#l4.125"></a><span id="l4.125"> }</span>
<a href="#l4.126"></a><span id="l4.126"> </span>
<a href="#l4.127"></a><span id="l4.127"> function MsgDownloadFlagged()</span>
<a href="#l4.128"></a><span id="l4.128"> {</span>
<a href="#l4.129"></a><span id="l4.129">   gDBView.doCommand(nsMsgViewCommandType.downloadFlaggedForOffline);</span>
<a href="#l4.130"></a><span id="l4.130"> }</span>
<a href="#l4.131"></a><span id="l4.131"> </span>
<a href="#l4.132"></a><span id="l4.132"> function MsgDownloadSelected()</span>
<a href="#l4.133"></a><span id="l4.133" class="difflineat">@@ -2098,18 +2066,22 @@ function IsGetNextNMessagesEnabled()</span>
<a href="#l4.134"></a><span id="l4.134">     }</span>
<a href="#l4.135"></a><span id="l4.135"> </span>
<a href="#l4.136"></a><span id="l4.136">     menuItem.setAttribute(&quot;hidden&quot;,&quot;true&quot;);</span>
<a href="#l4.137"></a><span id="l4.137">     return false;</span>
<a href="#l4.138"></a><span id="l4.138"> }</span>
<a href="#l4.139"></a><span id="l4.139"> </span>
<a href="#l4.140"></a><span id="l4.140"> function IsCompactFolderEnabled()</span>
<a href="#l4.141"></a><span id="l4.141"> {</span>
<a href="#l4.142"></a><span id="l4.142" class="difflineminus">-  var server = GetServer(GetSelectedFolderURI());</span>
<a href="#l4.143"></a><span id="l4.143" class="difflineplus">+  let folder = GetSelectedMsgFolders()[0];</span>
<a href="#l4.144"></a><span id="l4.144" class="difflineplus">+  if (!folder)</span>
<a href="#l4.145"></a><span id="l4.145" class="difflineplus">+    return false;</span>
<a href="#l4.146"></a><span id="l4.146" class="difflineplus">+  let server = folder.server;</span>
<a href="#l4.147"></a><span id="l4.147">   return (server &amp;&amp;</span>
<a href="#l4.148"></a><span id="l4.148" class="difflineplus">+      (server.type != 'nntp') &amp;&amp; // compact news folder is not supported</span>
<a href="#l4.149"></a><span id="l4.149">       ((server.type != 'imap') || server.canCompactFoldersOnServer) &amp;&amp;</span>
<a href="#l4.150"></a><span id="l4.150">       isCommandEnabled(&quot;cmd_compactFolder&quot;));   // checks e.g. if IMAP is offline</span>
<a href="#l4.151"></a><span id="l4.151"> }</span>
<a href="#l4.152"></a><span id="l4.152"> </span>
<a href="#l4.153"></a><span id="l4.153"> function SetUpToolbarButtons(uri)</span>
<a href="#l4.154"></a><span id="l4.154"> {</span>
<a href="#l4.155"></a><span id="l4.155">   let deleteButton = document.getElementById(&quot;button-delete&quot;);</span>
<a href="#l4.156"></a><span id="l4.156">   let replyAllButton = document.getElementById(&quot;button-replyall&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/suite/mailnews/content/mailWindowOverlay.xul</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/suite/mailnews/content/mailWindowOverlay.xul</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -425,61 +425,61 @@</span>
<a href="#l5.4"></a><span id="l5.4">         accesskey=&quot;&amp;folderContextUnsubscribe.accesskey;&quot;</span>
<a href="#l5.5"></a><span id="l5.5">         oncommand=&quot;MsgUnsubscribe();&quot;/&gt;</span>
<a href="#l5.6"></a><span id="l5.6"> </span>
<a href="#l5.7"></a><span id="l5.7">     &lt;menuseparator id=&quot;folderPaneContext-sep1&quot;/&gt;</span>
<a href="#l5.8"></a><span id="l5.8"> </span>
<a href="#l5.9"></a><span id="l5.9">     &lt;menuitem id=&quot;folderPaneContext-new&quot;</span>
<a href="#l5.10"></a><span id="l5.10">         label=&quot;&amp;folderContextNew.label;&quot;</span>
<a href="#l5.11"></a><span id="l5.11">         accesskey=&quot;&amp;folderContextNew.accesskey;&quot;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-        oncommand=&quot;MsgNewFolder(NewFolder);&quot;/&gt;</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+        oncommand=&quot;gFolderTreeController.newFolder();&quot;/&gt;</span>
<a href="#l5.14"></a><span id="l5.14">     &lt;menuitem id=&quot;folderPaneContext-remove&quot;</span>
<a href="#l5.15"></a><span id="l5.15">               label=&quot;&amp;folderContextRemove.label;&quot;</span>
<a href="#l5.16"></a><span id="l5.16">               accesskey=&quot;&amp;folderContextRemove.accesskey;&quot;</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineminus">-              oncommand=&quot;MsgDeleteFolder();&quot;/&gt;</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+              oncommand=&quot;gFolderTreeController.deleteFolder();&quot;/&gt;</span>
<a href="#l5.19"></a><span id="l5.19">     &lt;menuitem id=&quot;folderPaneContext-rename&quot;</span>
<a href="#l5.20"></a><span id="l5.20">         label=&quot;&amp;folderContextRename.label;&quot;</span>
<a href="#l5.21"></a><span id="l5.21">         accesskey=&quot;&amp;folderContextRename.accesskey;&quot;</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineminus">-        oncommand=&quot;MsgRenameFolder();&quot;/&gt;</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineplus">+        oncommand=&quot;gFolderTreeController.renameFolder();&quot;/&gt;</span>
<a href="#l5.24"></a><span id="l5.24"> </span>
<a href="#l5.25"></a><span id="l5.25">     &lt;menuitem id=&quot;folderPaneContext-compact&quot;</span>
<a href="#l5.26"></a><span id="l5.26">         label=&quot;&amp;folderContextCompact.label;&quot;</span>
<a href="#l5.27"></a><span id="l5.27">         accesskey=&quot;&amp;folderContextCompact.accesskey;&quot;</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineminus">-        oncommand=&quot;MsgCompactFolder(false);&quot;/&gt;</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineplus">+        oncommand=&quot;gFolderTreeController.compactFolder(false);&quot;/&gt;</span>
<a href="#l5.30"></a><span id="l5.30">     &lt;menuitem id=&quot;folderPaneContext-markMailFolderAllRead&quot;</span>
<a href="#l5.31"></a><span id="l5.31">               label=&quot;&amp;folderContextMarkMailFolderRead.label;&quot;</span>
<a href="#l5.32"></a><span id="l5.32">               accesskey=&quot;&amp;folderContextMarkMailFolderRead.accesskey;&quot;</span>
<a href="#l5.33"></a><span id="l5.33">               oncommand=&quot;MsgMarkAllRead();&quot;/&gt;</span>
<a href="#l5.34"></a><span id="l5.34">     &lt;menuitem id=&quot;folderPaneContext-markNewsgroupAllRead&quot;</span>
<a href="#l5.35"></a><span id="l5.35">               label=&quot;&amp;folderContextMarkNewsgroupRead.label;&quot;</span>
<a href="#l5.36"></a><span id="l5.36">               accesskey=&quot;&amp;folderContextMarkNewsgroupRead.accesskey;&quot;</span>
<a href="#l5.37"></a><span id="l5.37">               oncommand=&quot;MsgMarkAllRead();&quot;/&gt;</span>
<a href="#l5.38"></a><span id="l5.38">     &lt;menuitem id=&quot;folderPaneContext-emptyTrash&quot;</span>
<a href="#l5.39"></a><span id="l5.39">         label=&quot;&amp;folderContextEmptyTrash.label;&quot;</span>
<a href="#l5.40"></a><span id="l5.40">         accesskey=&quot;&amp;folderContextEmptyTrash.accesskey;&quot;</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineminus">-        oncommand=&quot;MsgEmptyTrash();&quot;/&gt;</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineplus">+        oncommand=&quot;gFolderTreeController.emptyTrash();&quot;/&gt;</span>
<a href="#l5.43"></a><span id="l5.43">     &lt;menuitem id=&quot;folderPaneContext-emptyJunk&quot;</span>
<a href="#l5.44"></a><span id="l5.44">         label=&quot;&amp;folderContextEmptyJunk.label;&quot;</span>
<a href="#l5.45"></a><span id="l5.45">         accesskey=&quot;&amp;folderContextEmptyJunk.accesskey;&quot;</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineminus">-        oncommand=&quot;deleteAllInFolder('emptyJunk');&quot;/&gt;</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineplus">+        oncommand=&quot;gFolderTreeController.emptyJunk();&quot;/&gt;</span>
<a href="#l5.48"></a><span id="l5.48">     &lt;menuitem id=&quot;folderPaneContext-sendUnsentMessages&quot;</span>
<a href="#l5.49"></a><span id="l5.49">         label=&quot;&amp;folderContextSendUnsentMessages.label;&quot;</span>
<a href="#l5.50"></a><span id="l5.50">         accesskey=&quot;&amp;folderContextSendUnsentMessages.accesskey;&quot;</span>
<a href="#l5.51"></a><span id="l5.51">         oncommand=&quot;goDoCommand('cmd_sendUnsentMsgs')&quot;/&gt;</span>
<a href="#l5.52"></a><span id="l5.52"> </span>
<a href="#l5.53"></a><span id="l5.53">     &lt;menuseparator id=&quot;folderPaneContext-sep-edit&quot;/&gt;</span>
<a href="#l5.54"></a><span id="l5.54"> </span>
<a href="#l5.55"></a><span id="l5.55">     &lt;menuitem id=&quot;folderPaneContext-properties&quot;</span>
<a href="#l5.56"></a><span id="l5.56">         label=&quot;&amp;folderContextProperties.label;&quot;</span>
<a href="#l5.57"></a><span id="l5.57">         accesskey=&quot;&amp;folderContextProperties.accesskey;&quot;</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineminus">-        oncommand=&quot;MsgFolderProperties();&quot;/&gt;</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineplus">+        oncommand=&quot;gFolderTreeController.editFolder();&quot;/&gt;</span>
<a href="#l5.60"></a><span id="l5.60">     &lt;menuitem id=&quot;folderPaneContext-settings&quot;</span>
<a href="#l5.61"></a><span id="l5.61">               label=&quot;&amp;folderContextSettings.label;&quot;</span>
<a href="#l5.62"></a><span id="l5.62">               accesskey=&quot;&amp;folderContextSettings.accesskey;&quot;</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineminus">-              oncommand=&quot;MsgFolderProperties();&quot;/&gt;</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineplus">+              oncommand=&quot;gFolderTreeController.editFolder();&quot;/&gt;</span>
<a href="#l5.65"></a><span id="l5.65">   &lt;/menupopup&gt;</span>
<a href="#l5.66"></a><span id="l5.66"> </span>
<a href="#l5.67"></a><span id="l5.67">   &lt;menupopup id=&quot;mailContext&quot;</span>
<a href="#l5.68"></a><span id="l5.68">          onpopupshowing=&quot;return event.target != this ||</span>
<a href="#l5.69"></a><span id="l5.69">                                 FillMailContextMenu(this, event);&quot;</span>
<a href="#l5.70"></a><span id="l5.70">          onpopuphiding=&quot;if (event.target == this) MailContextOnPopupHiding(this);&quot;&gt;</span>
<a href="#l5.71"></a><span id="l5.71">     &lt;menuitem id=&quot;context-openlinkintab&quot;</span>
<a href="#l5.72"></a><span id="l5.72">               label=&quot;&amp;openLinkCmdInTab.label;&quot;</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineat">@@ -911,19 +911,19 @@</span>
<a href="#l5.74"></a><span id="l5.74">           &lt;menuitem id=&quot;newNewMsgCmd&quot;</span>
<a href="#l5.75"></a><span id="l5.75">                     label=&quot;&amp;newNewMsgCmd.label;&quot;</span>
<a href="#l5.76"></a><span id="l5.76">                     accesskey=&quot;&amp;newNewMsgCmd.accesskey;&quot;</span>
<a href="#l5.77"></a><span id="l5.77">                     key=&quot;key_newMessage&quot;</span>
<a href="#l5.78"></a><span id="l5.78">                     oncommand=&quot;MsgNewMessage(null);&quot;/&gt;</span>
<a href="#l5.79"></a><span id="l5.79">           &lt;menuitem id=&quot;menu_newFolder&quot;</span>
<a href="#l5.80"></a><span id="l5.80">                     label=&quot;&amp;newFolderCmd.label;&quot;</span>
<a href="#l5.81"></a><span id="l5.81">                     accesskey=&quot;&amp;newFolderCmd.accesskey;&quot;</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineminus">-                    oncommand=&quot;MsgNewFolder(NewFolder);&quot;/&gt;</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineplus">+                    oncommand=&quot;gFolderTreeController.newFolder();&quot;/&gt;</span>
<a href="#l5.84"></a><span id="l5.84">           &lt;menuitem id=&quot;menu_newVirtualFolder&quot; label=&quot;&amp;newVirtualFolderCmd.label;&quot;</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineminus">-                    oncommand=&quot;MsgVirtualFolderProperties(false);&quot;</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineplus">+                    oncommand=&quot;gFolderTreeController.newVirtualFolder();&quot;</span>
<a href="#l5.87"></a><span id="l5.87">                     accesskey=&quot;&amp;newVirtualFolderCmd.accesskey;&quot;/&gt;</span>
<a href="#l5.88"></a><span id="l5.88">           &lt;menuitem id=&quot;newAccountMenuItem&quot;</span>
<a href="#l5.89"></a><span id="l5.89">                     label=&quot;&amp;newAccountCmd.label;&quot;</span>
<a href="#l5.90"></a><span id="l5.90">                     accesskey=&quot;&amp;newAccountCmd.accesskey;&quot;</span>
<a href="#l5.91"></a><span id="l5.91">                     oncommand=&quot;MsgAccountWizard();&quot;/&gt;</span>
<a href="#l5.92"></a><span id="l5.92">           &lt;menuseparator id=&quot;newPopupMenuSeparator&quot;/&gt;</span>
<a href="#l5.93"></a><span id="l5.93">           &lt;menuitem id=&quot;menu_newCard&quot;/&gt;</span>
<a href="#l5.94"></a><span id="l5.94">           &lt;menuitem id=&quot;menu_newTab&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/suite/mailnews/content/messageWindow.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/suite/mailnews/content/messageWindow.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -433,21 +433,16 @@ function GetSelectedIndices(dbView)</span>
<a href="#l6.4"></a><span id="l6.4">   }</span>
<a href="#l6.5"></a><span id="l6.5"> }</span>
<a href="#l6.6"></a><span id="l6.6"> </span>
<a href="#l6.7"></a><span id="l6.7"> function GetLoadedMsgFolder()</span>
<a href="#l6.8"></a><span id="l6.8"> {</span>
<a href="#l6.9"></a><span id="l6.9">   return gCurrentFolderUri ? GetMsgFolderFromUri(gCurrentFolderUri) : null;</span>
<a href="#l6.10"></a><span id="l6.10"> }</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-function GetSelectedFolderURI()</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-{</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-  return gCurrentFolderUri;</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineminus">-}</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineminus">-</span>
<a href="#l6.17"></a><span id="l6.17"> function GetLoadedMessage()</span>
<a href="#l6.18"></a><span id="l6.18"> {</span>
<a href="#l6.19"></a><span id="l6.19">   return gCurrentMessageUri;</span>
<a href="#l6.20"></a><span id="l6.20"> }</span>
<a href="#l6.21"></a><span id="l6.21"> </span>
<a href="#l6.22"></a><span id="l6.22"> //Clear everything related to the current message. called after load start page.</span>
<a href="#l6.23"></a><span id="l6.23"> function ClearMessageSelection()</span>
<a href="#l6.24"></a><span id="l6.24"> {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/suite/mailnews/content/messenger.xul</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/suite/mailnews/content/messenger.xul</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -45,16 +45,17 @@</span>
<a href="#l7.4"></a><span id="l7.4"> &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://messenger/content/commandglue.js&quot;/&gt;</span>
<a href="#l7.5"></a><span id="l7.5"> &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://messenger/content/msgViewNavigation.js&quot;/&gt;</span>
<a href="#l7.6"></a><span id="l7.6"> &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://messenger/content/mailWindow.js&quot;/&gt;</span>
<a href="#l7.7"></a><span id="l7.7"> &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://messenger/content/msgMail3PaneWindow.js&quot;/&gt;</span>
<a href="#l7.8"></a><span id="l7.8"> &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://messenger/content/mail3PaneWindowCommands.js&quot;/&gt;</span>
<a href="#l7.9"></a><span id="l7.9"> &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://messenger/content/mailContextMenus.js&quot;/&gt;</span>
<a href="#l7.10"></a><span id="l7.10"> &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://messenger/content/messengerdnd.js&quot;/&gt;</span>
<a href="#l7.11"></a><span id="l7.11"> &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://messenger/content/accountUtils.js&quot;/&gt;</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+&lt;script type=&quot;application/javascript&quot; src=&quot;chrome://messenger/content/folderPane.js&quot;/&gt;</span>
<a href="#l7.13"></a><span id="l7.13"> &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://messenger/content/phishingDetector.js&quot;/&gt;</span>
<a href="#l7.14"></a><span id="l7.14"> &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://communicator/content/contentAreaClick.js&quot;/&gt;</span>
<a href="#l7.15"></a><span id="l7.15"> &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://global/content/nsDragAndDrop.js&quot;/&gt;</span>
<a href="#l7.16"></a><span id="l7.16"> &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://messenger/content/searchBar.js&quot;/&gt;</span>
<a href="#l7.17"></a><span id="l7.17"> &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://messenger/content/tabmail.js&quot;/&gt;</span>
<a href="#l7.18"></a><span id="l7.18"> </span>
<a href="#l7.19"></a><span id="l7.19"> &lt;commandset id=&quot;mailCommands&quot;&gt;</span>
<a href="#l7.20"></a><span id="l7.20">   &lt;commandset id=&quot;mailFileMenuItems&quot;/&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/suite/mailnews/content/msgViewPickerOverlay.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/suite/mailnews/content/msgViewPickerOverlay.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -34,22 +34,18 @@ function ViewChange(aValue, aLabel)</span>
<a href="#l8.4"></a><span id="l8.4">   if (aValue == kViewItemCustomize || aValue == kViewItemVirtual)</span>
<a href="#l8.5"></a><span id="l8.5">   {</span>
<a href="#l8.6"></a><span id="l8.6">     // restore to the previous view value, in case they cancel</span>
<a href="#l8.7"></a><span id="l8.7">     UpdateViewPicker(gCurrentViewValue, gCurrentViewLabel);</span>
<a href="#l8.8"></a><span id="l8.8">     if (aValue == kViewItemCustomize)</span>
<a href="#l8.9"></a><span id="l8.9">       LaunchCustomizeDialog();</span>
<a href="#l8.10"></a><span id="l8.10">     else</span>
<a href="#l8.11"></a><span id="l8.11">     {</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-      // Thunderbird uses the folder pane for this.</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-      if (&quot;gFolderTreeController&quot; in window)</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineminus">-        gFolderTreeController.newVirtualFolder(gCurrentViewLabel,</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineminus">-                                               gSaveDefaultSVTerms);</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineminus">-      else</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineminus">-        openNewVirtualFolderDialogWithArgs(gCurrentViewLabel, gSaveDefaultSVTerms);</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+      gFolderTreeController.newVirtualFolder(gCurrentViewLabel,</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+                                             gSaveDefaultSVTerms);</span>
<a href="#l8.20"></a><span id="l8.20">     }</span>
<a href="#l8.21"></a><span id="l8.21">     return;</span>
<a href="#l8.22"></a><span id="l8.22">   }</span>
<a href="#l8.23"></a><span id="l8.23"> </span>
<a href="#l8.24"></a><span id="l8.24">   // persist the view</span>
<a href="#l8.25"></a><span id="l8.25">   gCurrentViewValue = aValue;</span>
<a href="#l8.26"></a><span id="l8.26">   gCurrentViewLabel = aLabel;</span>
<a href="#l8.27"></a><span id="l8.27">   SetMailViewForFolder(GetFirstSelectedMsgFolder(), gCurrentViewValue)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/suite/mailnews/content/widgetglue.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/suite/mailnews/content/widgetglue.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -7,217 +7,18 @@</span>
<a href="#l9.4"></a><span id="l9.4">  * widget-specific wrapper glue. There should be one function for every</span>
<a href="#l9.5"></a><span id="l9.5">  * widget/menu item, which gets some context (like the current selection)</span>
<a href="#l9.6"></a><span id="l9.6">  * and then calls a function/command in commandglue</span>
<a href="#l9.7"></a><span id="l9.7">  */</span>
<a href="#l9.8"></a><span id="l9.8"> </span>
<a href="#l9.9"></a><span id="l9.9"> //The eventual goal is for this file to go away and its contents to be brought into</span>
<a href="#l9.10"></a><span id="l9.10"> //mailWindowOverlay.js.  This is currently being done.</span>
<a href="#l9.11"></a><span id="l9.11"> </span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-var {MailUtils} = ChromeUtils.import(&quot;resource:///modules/MailUtils.js&quot;);</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineminus">-//NOTE: gMessengerBundle must be defined and set or this Overlay won't work</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineminus">-</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineminus">-function GetSelectedFolderURI()</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineminus">-{</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineminus">-  let folders = GetSelectedMsgFolders();</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineminus">-  return folders.length == 1 ? folders[0].URI : null;</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineminus">-}</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineminus">-</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineminus">-function MsgRenameFolder()</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineminus">-{</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineminus">-  let folder = GetSelectedMsgFolders()[0];</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineminus">-  let dialog = window.openDialog(</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineminus">-               &quot;chrome://messenger/content/renameFolderDialog.xul&quot;,</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineminus">-               &quot;&quot;,</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineminus">-               &quot;chrome,modal,centerscreen&quot;,</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineminus">-               {preselectedURI: folder.URI,</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineminus">-                okCallback: RenameFolder, name: folder.prettyName});</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineminus">-}</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineminus">-</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineminus">-function RenameFolder(name,uri)</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineminus">-{</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineminus">-  var folderTree = GetFolderTree();</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineminus">-  if (folderTree)</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineminus">-  {</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineminus">-    if (uri &amp;&amp; (uri != &quot;&quot;) &amp;&amp; name &amp;&amp; (name != &quot;&quot;))</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineminus">-    {</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineminus">-      var selectedFolder = GetMsgFolderFromUri(uri);</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineminus">-      if (gDBView)</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineminus">-        gCurrentlyDisplayedMessage = gDBView.currentlyDisplayedMessage;</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineminus">-</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineminus">-      ClearThreadPane();</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineminus">-      ClearMessagePane();</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineminus">-      folderTree.view.selection.clearSelection();</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineminus">-</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineminus">-      try</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineminus">-      {</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineminus">-        selectedFolder.rename(name, msgWindow);</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineminus">-      }</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineminus">-      catch(e)</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineminus">-      {</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineminus">-        SelectFolder(selectedFolder.URI);  //restore selection</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineminus">-        throw(e); // so that the dialog does not automatically close</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineminus">-        dump (&quot;Exception : RenameFolder \n&quot;);</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineminus">-      }</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineminus">-    }</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineminus">-    else</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineminus">-    {</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineminus">-      dump(&quot;no name or nothing selected\n&quot;);</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineminus">-    }</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineminus">-  }</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineminus">-  else</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineminus">-  {</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineminus">-    dump(&quot;no folder tree\n&quot;);</span>
<a href="#l9.67"></a><span id="l9.67" class="difflineminus">-  }</span>
<a href="#l9.68"></a><span id="l9.68" class="difflineminus">-}</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineminus">-</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineminus">-function MsgEmptyTrash()</span>
<a href="#l9.71"></a><span id="l9.71" class="difflineminus">-{</span>
<a href="#l9.72"></a><span id="l9.72" class="difflineminus">-  let folders = GetSelectedMsgFolders();</span>
<a href="#l9.73"></a><span id="l9.73" class="difflineminus">-  if (folders.length != 1 || !confirmToProceed(&quot;emptyTrash&quot;))</span>
<a href="#l9.74"></a><span id="l9.74" class="difflineminus">-    return;</span>
<a href="#l9.75"></a><span id="l9.75" class="difflineminus">-</span>
<a href="#l9.76"></a><span id="l9.76" class="difflineminus">-  folders[0].emptyTrash(msgWindow, null);</span>
<a href="#l9.77"></a><span id="l9.77" class="difflineminus">-}</span>
<a href="#l9.78"></a><span id="l9.78" class="difflineminus">-</span>
<a href="#l9.79"></a><span id="l9.79" class="difflineminus">-function MsgCompactFolder(aCompactAccount)</span>
<a href="#l9.80"></a><span id="l9.80" class="difflineminus">-{</span>
<a href="#l9.81"></a><span id="l9.81" class="difflineminus">-  // Get the selected folders.</span>
<a href="#l9.82"></a><span id="l9.82" class="difflineminus">-  var selectedFolders = GetSelectedMsgFolders();</span>
<a href="#l9.83"></a><span id="l9.83" class="difflineminus">-  if (selectedFolders.length == 1)</span>
<a href="#l9.84"></a><span id="l9.84" class="difflineminus">-  {</span>
<a href="#l9.85"></a><span id="l9.85" class="difflineminus">-    var selectedFolder = selectedFolders[0];</span>
<a href="#l9.86"></a><span id="l9.86" class="difflineminus">-    var isImapFolder = selectedFolder.server.type == &quot;imap&quot;;</span>
<a href="#l9.87"></a><span id="l9.87" class="difflineminus">-    if (!isImapFolder)</span>
<a href="#l9.88"></a><span id="l9.88" class="difflineminus">-    {</span>
<a href="#l9.89"></a><span id="l9.89" class="difflineminus">-      if (selectedFolder.expungedBytes &gt; 0)</span>
<a href="#l9.90"></a><span id="l9.90" class="difflineminus">-      {</span>
<a href="#l9.91"></a><span id="l9.91" class="difflineminus">-        if (gDBView)</span>
<a href="#l9.92"></a><span id="l9.92" class="difflineminus">-        {</span>
<a href="#l9.93"></a><span id="l9.93" class="difflineminus">-          gCurrentlyDisplayedMessage = gDBView.currentlyDisplayedMessage;</span>
<a href="#l9.94"></a><span id="l9.94" class="difflineminus">-          if (gDBView.msgFolder == selectedFolder || aCompactAccount)</span>
<a href="#l9.95"></a><span id="l9.95" class="difflineminus">-          {</span>
<a href="#l9.96"></a><span id="l9.96" class="difflineminus">-            ClearThreadPaneSelection();</span>
<a href="#l9.97"></a><span id="l9.97" class="difflineminus">-            ClearThreadPane();</span>
<a href="#l9.98"></a><span id="l9.98" class="difflineminus">-            ClearMessagePane();</span>
<a href="#l9.99"></a><span id="l9.99" class="difflineminus">-          }</span>
<a href="#l9.100"></a><span id="l9.100" class="difflineminus">-        }</span>
<a href="#l9.101"></a><span id="l9.101" class="difflineminus">-      }</span>
<a href="#l9.102"></a><span id="l9.102" class="difflineminus">-      else</span>
<a href="#l9.103"></a><span id="l9.103" class="difflineminus">-      {</span>
<a href="#l9.104"></a><span id="l9.104" class="difflineminus">-        if (!aCompactAccount) // you have one local folder with no room to compact</span>
<a href="#l9.105"></a><span id="l9.105" class="difflineminus">-          return;</span>
<a href="#l9.106"></a><span id="l9.106" class="difflineminus">-      }</span>
<a href="#l9.107"></a><span id="l9.107" class="difflineminus">-    }</span>
<a href="#l9.108"></a><span id="l9.108" class="difflineminus">-    if (aCompactAccount)</span>
<a href="#l9.109"></a><span id="l9.109" class="difflineminus">-      selectedFolder.compactAll(null, msgWindow, isImapFolder || selectedFolder.server.type == &quot;nntp&quot;);</span>
<a href="#l9.110"></a><span id="l9.110" class="difflineminus">-    else</span>
<a href="#l9.111"></a><span id="l9.111" class="difflineminus">-      selectedFolder.compact(null, msgWindow);</span>
<a href="#l9.112"></a><span id="l9.112" class="difflineminus">-  }</span>
<a href="#l9.113"></a><span id="l9.113" class="difflineminus">-}</span>
<a href="#l9.114"></a><span id="l9.114" class="difflineminus">-</span>
<a href="#l9.115"></a><span id="l9.115" class="difflineminus">-function openNewVirtualFolderDialogWithArgs(defaultViewName, aSearchTerms)</span>
<a href="#l9.116"></a><span id="l9.116" class="difflineminus">-{</span>
<a href="#l9.117"></a><span id="l9.117" class="difflineminus">-  var folder = GetFirstSelectedMsgFolder();</span>
<a href="#l9.118"></a><span id="l9.118" class="difflineminus">-  let name = folder.prettyName + &quot;-&quot; + defaultViewName;</span>
<a href="#l9.119"></a><span id="l9.119" class="difflineminus">-</span>
<a href="#l9.120"></a><span id="l9.120" class="difflineminus">-  var dialog = window.openDialog(&quot;chrome://messenger/content/virtualFolderProperties.xul&quot;, &quot;&quot;,</span>
<a href="#l9.121"></a><span id="l9.121" class="difflineminus">-                                 &quot;chrome,modal,centerscreen&quot;,</span>
<a href="#l9.122"></a><span id="l9.122" class="difflineminus">-                                 {folder:folder,</span>
<a href="#l9.123"></a><span id="l9.123" class="difflineminus">-                                  searchTerms:aSearchTerms,</span>
<a href="#l9.124"></a><span id="l9.124" class="difflineminus">-                                  newFolderName:name});</span>
<a href="#l9.125"></a><span id="l9.125" class="difflineminus">-}</span>
<a href="#l9.126"></a><span id="l9.126" class="difflineminus">-</span>
<a href="#l9.127"></a><span id="l9.127" class="difflineminus">-function MsgVirtualFolderProperties(aEditExistingVFolder)</span>
<a href="#l9.128"></a><span id="l9.128" class="difflineminus">-{</span>
<a href="#l9.129"></a><span id="l9.129" class="difflineminus">-  var preselectedFolder = GetFirstSelectedMsgFolder();</span>
<a href="#l9.130"></a><span id="l9.130" class="difflineminus">-</span>
<a href="#l9.131"></a><span id="l9.131" class="difflineminus">-  var dialog = window.openDialog(&quot;chrome://messenger/content/virtualFolderProperties.xul&quot;, &quot;&quot;,</span>
<a href="#l9.132"></a><span id="l9.132" class="difflineminus">-                                 &quot;chrome,modal,centerscreen&quot;,</span>
<a href="#l9.133"></a><span id="l9.133" class="difflineminus">-                                 {folder:preselectedFolder,</span>
<a href="#l9.134"></a><span id="l9.134" class="difflineminus">-                                  editExistingFolder: aEditExistingVFolder,</span>
<a href="#l9.135"></a><span id="l9.135" class="difflineminus">-                                  onOKCallback:onEditVirtualFolderPropertiesCallback,</span>
<a href="#l9.136"></a><span id="l9.136" class="difflineminus">-                                  msgWindow:msgWindow});</span>
<a href="#l9.137"></a><span id="l9.137" class="difflineminus">-}</span>
<a href="#l9.138"></a><span id="l9.138" class="difflineminus">-</span>
<a href="#l9.139"></a><span id="l9.139" class="difflineminus">-function onEditVirtualFolderPropertiesCallback(aVirtualFolderURI)</span>
<a href="#l9.140"></a><span id="l9.140" class="difflineminus">-{</span>
<a href="#l9.141"></a><span id="l9.141" class="difflineminus">-  // we need to reload the folder if it is the currently loaded folder...</span>
<a href="#l9.142"></a><span id="l9.142" class="difflineminus">-  if (gMsgFolderSelected &amp;&amp; aVirtualFolderURI == gMsgFolderSelected.URI)</span>
<a href="#l9.143"></a><span id="l9.143" class="difflineminus">-  {</span>
<a href="#l9.144"></a><span id="l9.144" class="difflineminus">-    gMsgFolderSelected = null; // force the folder pane to reload the virtual folder</span>
<a href="#l9.145"></a><span id="l9.145" class="difflineminus">-    FolderPaneSelectionChange();</span>
<a href="#l9.146"></a><span id="l9.146" class="difflineminus">-  }</span>
<a href="#l9.147"></a><span id="l9.147" class="difflineminus">-}</span>
<a href="#l9.148"></a><span id="l9.148" class="difflineminus">-</span>
<a href="#l9.149"></a><span id="l9.149" class="difflineminus">-</span>
<a href="#l9.150"></a><span id="l9.150" class="difflineminus">-function MsgFolderProperties()</span>
<a href="#l9.151"></a><span id="l9.151" class="difflineminus">-{</span>
<a href="#l9.152"></a><span id="l9.152" class="difflineminus">-  let msgFolder = GetMsgFolderFromUri(GetSelectedFolderURI(), true);</span>
<a href="#l9.153"></a><span id="l9.153" class="difflineminus">-</span>
<a href="#l9.154"></a><span id="l9.154" class="difflineminus">-  // if a server is selected, view settings for that account</span>
<a href="#l9.155"></a><span id="l9.155" class="difflineminus">-  if (msgFolder.isServer) {</span>
<a href="#l9.156"></a><span id="l9.156" class="difflineminus">-    MsgAccountManager(null, msgFolder.server);</span>
<a href="#l9.157"></a><span id="l9.157" class="difflineminus">-    return;</span>
<a href="#l9.158"></a><span id="l9.158" class="difflineminus">-  }</span>
<a href="#l9.159"></a><span id="l9.159" class="difflineminus">-</span>
<a href="#l9.160"></a><span id="l9.160" class="difflineminus">-  if (msgFolder.flags &amp; Ci.nsMsgFolderFlags.Virtual)</span>
<a href="#l9.161"></a><span id="l9.161" class="difflineminus">-  {</span>
<a href="#l9.162"></a><span id="l9.162" class="difflineminus">-    // virtual folders get their own property dialog that contains all of the</span>
<a href="#l9.163"></a><span id="l9.163" class="difflineminus">-    // search information related to the virtual folder.</span>
<a href="#l9.164"></a><span id="l9.164" class="difflineminus">-    MsgVirtualFolderProperties(true);</span>
<a href="#l9.165"></a><span id="l9.165" class="difflineminus">-    return;</span>
<a href="#l9.166"></a><span id="l9.166" class="difflineminus">-  }</span>
<a href="#l9.167"></a><span id="l9.167" class="difflineminus">-</span>
<a href="#l9.168"></a><span id="l9.168" class="difflineminus">-  var windowTitle = gMessengerBundle.getString(&quot;folderProperties&quot;);</span>
<a href="#l9.169"></a><span id="l9.169" class="difflineminus">-  var dialog = window.openDialog(</span>
<a href="#l9.170"></a><span id="l9.170" class="difflineminus">-              &quot;chrome://messenger/content/folderProps.xul&quot;,</span>
<a href="#l9.171"></a><span id="l9.171" class="difflineminus">-              &quot;&quot;,</span>
<a href="#l9.172"></a><span id="l9.172" class="difflineminus">-              &quot;chrome,modal,centerscreen&quot;,</span>
<a href="#l9.173"></a><span id="l9.173" class="difflineminus">-              {folder: msgFolder, serverType: msgFolder.server.type,</span>
<a href="#l9.174"></a><span id="l9.174" class="difflineminus">-               msgWindow: msgWindow, title: windowTitle,</span>
<a href="#l9.175"></a><span id="l9.175" class="difflineminus">-               okCallback: FolderProperties, tabID: &quot;&quot;, tabIndex: 0,</span>
<a href="#l9.176"></a><span id="l9.176" class="difflineminus">-               name: msgFolder.prettyName,</span>
<a href="#l9.177"></a><span id="l9.177" class="difflineminus">-               rebuildSummaryCallback: RebuildSummaryFile});</span>
<a href="#l9.178"></a><span id="l9.178" class="difflineminus">-}</span>
<a href="#l9.179"></a><span id="l9.179" class="difflineminus">-</span>
<a href="#l9.180"></a><span id="l9.180" class="difflineminus">-function RebuildSummaryFile(msgFolder)</span>
<a href="#l9.181"></a><span id="l9.181" class="difflineminus">-{</span>
<a href="#l9.182"></a><span id="l9.182" class="difflineminus">-  if (msgFolder.locked)</span>
<a href="#l9.183"></a><span id="l9.183" class="difflineminus">-  {</span>
<a href="#l9.184"></a><span id="l9.184" class="difflineminus">-    msgFolder.throwAlertMsg(&quot;operationFailedFolderBusy&quot;, msgWindow);</span>
<a href="#l9.185"></a><span id="l9.185" class="difflineminus">-    return;</span>
<a href="#l9.186"></a><span id="l9.186" class="difflineminus">-  }</span>
<a href="#l9.187"></a><span id="l9.187" class="difflineminus">-  var msgDB = msgFolder.msgDatabase;</span>
<a href="#l9.188"></a><span id="l9.188" class="difflineminus">-  msgDB.summaryValid = false;</span>
<a href="#l9.189"></a><span id="l9.189" class="difflineminus">-  try {</span>
<a href="#l9.190"></a><span id="l9.190" class="difflineminus">-    msgFolder.closeAndBackupFolderDB(&quot;&quot;);</span>
<a href="#l9.191"></a><span id="l9.191" class="difflineminus">-  }</span>
<a href="#l9.192"></a><span id="l9.192" class="difflineminus">-  catch(e) {</span>
<a href="#l9.193"></a><span id="l9.193" class="difflineminus">-    // In a failure, proceed anyway since we're dealing with problems</span>
<a href="#l9.194"></a><span id="l9.194" class="difflineminus">-    msgFolder.ForceDBClosed();</span>
<a href="#l9.195"></a><span id="l9.195" class="difflineminus">-  }</span>
<a href="#l9.196"></a><span id="l9.196" class="difflineminus">-  // these two lines will cause the thread pane to get reloaded</span>
<a href="#l9.197"></a><span id="l9.197" class="difflineminus">-  // when the download/reparse is finished. Only do this</span>
<a href="#l9.198"></a><span id="l9.198" class="difflineminus">-  // if the selected folder is loaded (i.e., not thru the</span>
<a href="#l9.199"></a><span id="l9.199" class="difflineminus">-  // context menu on a non-loaded folder).</span>
<a href="#l9.200"></a><span id="l9.200" class="difflineminus">-  if (msgFolder == GetLoadedMsgFolder())</span>
<a href="#l9.201"></a><span id="l9.201" class="difflineminus">-  {</span>
<a href="#l9.202"></a><span id="l9.202" class="difflineminus">-    gRerootOnFolderLoad = true;</span>
<a href="#l9.203"></a><span id="l9.203" class="difflineminus">-    gCurrentFolderToReroot = msgFolder.URI;</span>
<a href="#l9.204"></a><span id="l9.204" class="difflineminus">-  }</span>
<a href="#l9.205"></a><span id="l9.205" class="difflineminus">-  msgFolder.updateFolder(msgWindow);</span>
<a href="#l9.206"></a><span id="l9.206" class="difflineminus">-}</span>
<a href="#l9.207"></a><span id="l9.207" class="difflineminus">-</span>
<a href="#l9.208"></a><span id="l9.208" class="difflineminus">-function FolderProperties(name, oldName, uri)</span>
<a href="#l9.209"></a><span id="l9.209" class="difflineminus">-{</span>
<a href="#l9.210"></a><span id="l9.210" class="difflineminus">-  if (name != oldName)</span>
<a href="#l9.211"></a><span id="l9.211" class="difflineminus">-    RenameFolder(name, uri);</span>
<a href="#l9.212"></a><span id="l9.212" class="difflineminus">-}</span>
<a href="#l9.213"></a><span id="l9.213" class="difflineplus">+var { MailUtils } =</span>
<a href="#l9.214"></a><span id="l9.214" class="difflineplus">+  ChromeUtils.import(&quot;resource:///modules/MailUtils.js&quot;);</span>
<a href="#l9.215"></a><span id="l9.215"> </span>
<a href="#l9.216"></a><span id="l9.216"> // Given a URI we would like to return corresponding message folder here.</span>
<a href="#l9.217"></a><span id="l9.217"> // An additonal input param which specifies whether or not to check folder</span>
<a href="#l9.218"></a><span id="l9.218"> // attributes (like if there exists a parent or is it a server) is also passed</span>
<a href="#l9.219"></a><span id="l9.219"> // to this routine. Qualifying against those checks would return an existing</span>
<a href="#l9.220"></a><span id="l9.220"> // folder. Callers who don't want to check those attributes will specify the</span>
<a href="#l9.221"></a><span id="l9.221"> // same and then this routine will simply return a msgfolder. This scenario</span>
<a href="#l9.222"></a><span id="l9.222"> // applies to a new imap account creation where special folders are created</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/suite/mailnews/jar.mn</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/suite/mailnews/jar.mn</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -16,18 +16,19 @@ messenger.jar:</span>
<a href="#l10.4"></a><span id="l10.4"> % overlay chrome://communicator/content/pref/pref-scripts.xul                  chrome://messenger/content/mailPrefsOverlay.xul</span>
<a href="#l10.5"></a><span id="l10.5"> % overlay chrome://communicator/content/pref/pref-cookies.xul                  chrome://messenger/content/mailPrefsOverlay.xul</span>
<a href="#l10.6"></a><span id="l10.6"> % overlay chrome://editor/content/editorTasksOverlay.xul                       chrome://messenger/content/mailTasksOverlay.xul</span>
<a href="#l10.7"></a><span id="l10.7"> % overlay chrome://messenger/content/addressbook/abSelectAddressesDialog.xul   chrome://messenger/content/mailOverlay.xul</span>
<a href="#l10.8"></a><span id="l10.8"> % overlay chrome://editor/content/composerOverlay.xul                          chrome://messenger/content/mailEditorOverlay.xul</span>
<a href="#l10.9"></a><span id="l10.9">     content/messenger/browserRequest.js                                        (content/browserRequest.js)</span>
<a href="#l10.10"></a><span id="l10.10">     content/messenger/browserRequest.xul                                       (content/browserRequest.xul)</span>
<a href="#l10.11"></a><span id="l10.11">     content/messenger/commandglue.js                                           (content/commandglue.js)</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+    content/messenger/folderDisplay.js                                         (content/folderDisplay.js)</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+    content/messenger/folderPane.js                                            (content/folderPane.js)</span>
<a href="#l10.14"></a><span id="l10.14">     content/messenger/folderPane.xul                                           (content/folderPane.xul)</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineminus">-    content/messenger/folderDisplay.js                                         (content/folderDisplay.js)</span>
<a href="#l10.16"></a><span id="l10.16">     content/messenger/mail-offline.js                                          (content/mail-offline.js)</span>
<a href="#l10.17"></a><span id="l10.17">     content/messenger/mail3PaneWindowCommands.js                               (content/mail3PaneWindowCommands.js)</span>
<a href="#l10.18"></a><span id="l10.18">     content/messenger/mailCommands.js                                          (content/mailCommands.js)</span>
<a href="#l10.19"></a><span id="l10.19">     content/messenger/mailContextMenus.js                                      (content/mailContextMenus.js)</span>
<a href="#l10.20"></a><span id="l10.20">     content/messenger/mailEditorOverlay.xul                                    (content/mailEditorOverlay.xul)</span>
<a href="#l10.21"></a><span id="l10.21">     content/messenger/mailKeysOverlay.xul                                      (content/mailKeysOverlay.xul)</span>
<a href="#l10.22"></a><span id="l10.22">     content/messenger/mailOverlay.js                                           (content/mailOverlay.js)</span>
<a href="#l10.23"></a><span id="l10.23">     content/messenger/mailOverlay.xul                                          (content/mailOverlay.xul)</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

