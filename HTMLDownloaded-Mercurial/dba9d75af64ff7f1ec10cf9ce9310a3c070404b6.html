<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 9424:dba9d75af64ff7f1ec10cf9ce9310a3c070404b6</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ dba9d75af64ff7f1ec10cf9ce9310a3c070404b6" />
<meta property="og:url" content="/comm-central/rev/dba9d75af64ff7f1ec10cf9ce9310a3c070404b6" />
<meta property="og:description" content="Bug 227633. (Av1c) Replace 0x0A by nsCRT::LF, 0x0D by nsCRT::CR, 9 by '\t', and 32 by ' ', in mailnews/. r=(dwitte, mbanner) rs=dmose." />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / dba9d75af64ff7f1ec10cf9ce9310a3c070404b6 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/dba9d75af64ff7f1ec10cf9ce9310a3c070404b6">shortlog</a> |
<a href="/comm-central/log/dba9d75af64ff7f1ec10cf9ce9310a3c070404b6">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/dba9d75af64ff7f1ec10cf9ce9310a3c070404b6">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/dba9d75af64ff7f1ec10cf9ce9310a3c070404b6">files</a> |
changeset |
<a href="/comm-central/raw-rev/dba9d75af64ff7f1ec10cf9ce9310a3c070404b6">raw</a>  | <a href="/comm-central/archive/dba9d75af64ff7f1ec10cf9ce9310a3c070404b6.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=227633">Bug 227633</a>. (Av1c) Replace 0x0A by nsCRT::LF, 0x0D by nsCRT::CR, 9 by '\t', and 32 by ' ', in mailnews/. r=(dwitte, mbanner) rs=dmose.
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#83;&#101;&#114;&#103;&#101;&#32;&#71;&#97;&#117;&#116;&#104;&#101;&#114;&#105;&#101;&#32;&#60;&#115;&#103;&#97;&#117;&#116;&#104;&#101;&#114;&#105;&#101;&#46;&#98;&#122;&#64;&#102;&#114;&#101;&#101;&#46;&#102;&#114;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 20 Feb 2012 23:21:15 +0100</td></tr>

<tr>
 <td>changeset 9424</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/dba9d75af64ff7f1ec10cf9ce9310a3c070404b6">dba9d75af64ff7f1ec10cf9ce9310a3c070404b6</a></td>
</tr>



<tr>
<td>parent 9423</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/77c812a9a8200fddc29442693674d61bbf5a495a">77c812a9a8200fddc29442693674d61bbf5a495a</a>
</td>
</tr>

<tr>
<td>child 9425</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/5df553de0a84a09324b7ef748a9f24e36fe1b25e">5df553de0a84a09324b7ef748a9f24e36fe1b25e</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=dba9d75af64ff7f1ec10cf9ce9310a3c070404b6">7216</a></td></tr>
<tr><td>push user</td><td>sgautherie.bz@free.fr</td></tr>
<tr><td>push date</td><td class="date age">Mon, 20 Feb 2012 22:22:53 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@dba9d75af64f [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=dba9d75af64ff7f1ec10cf9ce9310a3c070404b6">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=dba9d75af64ff7f1ec10cf9ce9310a3c070404b6&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=dba9d75af64ff7f1ec10cf9ce9310a3c070404b6&newProject=comm-central&newRevision=dba9d75af64ff7f1ec10cf9ce9310a3c070404b6&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=dba9d75af64ff7f1ec10cf9ce9310a3c070404b6&newProject=comm-central&newRevision=dba9d75af64ff7f1ec10cf9ce9310a3c070404b6&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=dba9d75af64ff7f1ec10cf9ce9310a3c070404b6&newProject=comm-central&newRevision=dba9d75af64ff7f1ec10cf9ce9310a3c070404b6&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28dmose%29&revcount=50">dmose</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=227633">227633</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=227633">Bug 227633</a>. (Av1c) Replace 0x0A by nsCRT::LF, 0x0D by nsCRT::CR, 9 by '\t', and 32 by ' ', in mailnews/. r=(dwitte, mbanner) rs=dmose.

Included logic rewrites are:
*nsMsgCompose.cpp: merges 2 |*wPtr = ...|.
*nsEudoraCompose::FindNextEndLine(): moves 2 |(count &lt; len)| to front.
*nsEudoraMailbox::ExamineAttachment(): moves 1 |(cnt &lt; len)| to front.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dba9d75af64ff7f1ec10cf9ce9310a3c070404b6/mailnews/addrbook/src/nsAbLDIFService.cpp">mailnews/addrbook/src/nsAbLDIFService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dba9d75af64ff7f1ec10cf9ce9310a3c070404b6/mailnews/addrbook/src/nsAbLDIFService.cpp">file</a> |
<a href="/comm-central/annotate/dba9d75af64ff7f1ec10cf9ce9310a3c070404b6/mailnews/addrbook/src/nsAbLDIFService.cpp">annotate</a> |
<a href="/comm-central/diff/dba9d75af64ff7f1ec10cf9ce9310a3c070404b6/mailnews/addrbook/src/nsAbLDIFService.cpp">diff</a> |
<a href="/comm-central/comparison/dba9d75af64ff7f1ec10cf9ce9310a3c070404b6/mailnews/addrbook/src/nsAbLDIFService.cpp">comparison</a> |
<a href="/comm-central/log/dba9d75af64ff7f1ec10cf9ce9310a3c070404b6/mailnews/addrbook/src/nsAbLDIFService.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/dba9d75af64ff7f1ec10cf9ce9310a3c070404b6/mailnews/compose/src/nsMsgCompose.cpp">mailnews/compose/src/nsMsgCompose.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dba9d75af64ff7f1ec10cf9ce9310a3c070404b6/mailnews/compose/src/nsMsgCompose.cpp">file</a> |
<a href="/comm-central/annotate/dba9d75af64ff7f1ec10cf9ce9310a3c070404b6/mailnews/compose/src/nsMsgCompose.cpp">annotate</a> |
<a href="/comm-central/diff/dba9d75af64ff7f1ec10cf9ce9310a3c070404b6/mailnews/compose/src/nsMsgCompose.cpp">diff</a> |
<a href="/comm-central/comparison/dba9d75af64ff7f1ec10cf9ce9310a3c070404b6/mailnews/compose/src/nsMsgCompose.cpp">comparison</a> |
<a href="/comm-central/log/dba9d75af64ff7f1ec10cf9ce9310a3c070404b6/mailnews/compose/src/nsMsgCompose.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dba9d75af64ff7f1ec10cf9ce9310a3c070404b6/mailnews/import/eudora/src/nsEudoraCompose.cpp">mailnews/import/eudora/src/nsEudoraCompose.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dba9d75af64ff7f1ec10cf9ce9310a3c070404b6/mailnews/import/eudora/src/nsEudoraCompose.cpp">file</a> |
<a href="/comm-central/annotate/dba9d75af64ff7f1ec10cf9ce9310a3c070404b6/mailnews/import/eudora/src/nsEudoraCompose.cpp">annotate</a> |
<a href="/comm-central/diff/dba9d75af64ff7f1ec10cf9ce9310a3c070404b6/mailnews/import/eudora/src/nsEudoraCompose.cpp">diff</a> |
<a href="/comm-central/comparison/dba9d75af64ff7f1ec10cf9ce9310a3c070404b6/mailnews/import/eudora/src/nsEudoraCompose.cpp">comparison</a> |
<a href="/comm-central/log/dba9d75af64ff7f1ec10cf9ce9310a3c070404b6/mailnews/import/eudora/src/nsEudoraCompose.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/dba9d75af64ff7f1ec10cf9ce9310a3c070404b6/mailnews/import/eudora/src/nsEudoraMailbox.cpp">mailnews/import/eudora/src/nsEudoraMailbox.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dba9d75af64ff7f1ec10cf9ce9310a3c070404b6/mailnews/import/eudora/src/nsEudoraMailbox.cpp">file</a> |
<a href="/comm-central/annotate/dba9d75af64ff7f1ec10cf9ce9310a3c070404b6/mailnews/import/eudora/src/nsEudoraMailbox.cpp">annotate</a> |
<a href="/comm-central/diff/dba9d75af64ff7f1ec10cf9ce9310a3c070404b6/mailnews/import/eudora/src/nsEudoraMailbox.cpp">diff</a> |
<a href="/comm-central/comparison/dba9d75af64ff7f1ec10cf9ce9310a3c070404b6/mailnews/import/eudora/src/nsEudoraMailbox.cpp">comparison</a> |
<a href="/comm-central/log/dba9d75af64ff7f1ec10cf9ce9310a3c070404b6/mailnews/import/eudora/src/nsEudoraMailbox.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dba9d75af64ff7f1ec10cf9ce9310a3c070404b6/mailnews/import/eudora/src/nsEudoraWin32.cpp">mailnews/import/eudora/src/nsEudoraWin32.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dba9d75af64ff7f1ec10cf9ce9310a3c070404b6/mailnews/import/eudora/src/nsEudoraWin32.cpp">file</a> |
<a href="/comm-central/annotate/dba9d75af64ff7f1ec10cf9ce9310a3c070404b6/mailnews/import/eudora/src/nsEudoraWin32.cpp">annotate</a> |
<a href="/comm-central/diff/dba9d75af64ff7f1ec10cf9ce9310a3c070404b6/mailnews/import/eudora/src/nsEudoraWin32.cpp">diff</a> |
<a href="/comm-central/comparison/dba9d75af64ff7f1ec10cf9ce9310a3c070404b6/mailnews/import/eudora/src/nsEudoraWin32.cpp">comparison</a> |
<a href="/comm-central/log/dba9d75af64ff7f1ec10cf9ce9310a3c070404b6/mailnews/import/eudora/src/nsEudoraWin32.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/dba9d75af64ff7f1ec10cf9ce9310a3c070404b6/mailnews/import/oexpress/nsOEMailbox.cpp">mailnews/import/oexpress/nsOEMailbox.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dba9d75af64ff7f1ec10cf9ce9310a3c070404b6/mailnews/import/oexpress/nsOEMailbox.cpp">file</a> |
<a href="/comm-central/annotate/dba9d75af64ff7f1ec10cf9ce9310a3c070404b6/mailnews/import/oexpress/nsOEMailbox.cpp">annotate</a> |
<a href="/comm-central/diff/dba9d75af64ff7f1ec10cf9ce9310a3c070404b6/mailnews/import/oexpress/nsOEMailbox.cpp">diff</a> |
<a href="/comm-central/comparison/dba9d75af64ff7f1ec10cf9ce9310a3c070404b6/mailnews/import/oexpress/nsOEMailbox.cpp">comparison</a> |
<a href="/comm-central/log/dba9d75af64ff7f1ec10cf9ce9310a3c070404b6/mailnews/import/oexpress/nsOEMailbox.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dba9d75af64ff7f1ec10cf9ce9310a3c070404b6/mailnews/import/outlook/src/MapiMessage.cpp">mailnews/import/outlook/src/MapiMessage.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dba9d75af64ff7f1ec10cf9ce9310a3c070404b6/mailnews/import/outlook/src/MapiMessage.cpp">file</a> |
<a href="/comm-central/annotate/dba9d75af64ff7f1ec10cf9ce9310a3c070404b6/mailnews/import/outlook/src/MapiMessage.cpp">annotate</a> |
<a href="/comm-central/diff/dba9d75af64ff7f1ec10cf9ce9310a3c070404b6/mailnews/import/outlook/src/MapiMessage.cpp">diff</a> |
<a href="/comm-central/comparison/dba9d75af64ff7f1ec10cf9ce9310a3c070404b6/mailnews/import/outlook/src/MapiMessage.cpp">comparison</a> |
<a href="/comm-central/log/dba9d75af64ff7f1ec10cf9ce9310a3c070404b6/mailnews/import/outlook/src/MapiMessage.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/dba9d75af64ff7f1ec10cf9ce9310a3c070404b6/mailnews/import/outlook/src/nsOutlookCompose.cpp">mailnews/import/outlook/src/nsOutlookCompose.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dba9d75af64ff7f1ec10cf9ce9310a3c070404b6/mailnews/import/outlook/src/nsOutlookCompose.cpp">file</a> |
<a href="/comm-central/annotate/dba9d75af64ff7f1ec10cf9ce9310a3c070404b6/mailnews/import/outlook/src/nsOutlookCompose.cpp">annotate</a> |
<a href="/comm-central/diff/dba9d75af64ff7f1ec10cf9ce9310a3c070404b6/mailnews/import/outlook/src/nsOutlookCompose.cpp">diff</a> |
<a href="/comm-central/comparison/dba9d75af64ff7f1ec10cf9ce9310a3c070404b6/mailnews/import/outlook/src/nsOutlookCompose.cpp">comparison</a> |
<a href="/comm-central/log/dba9d75af64ff7f1ec10cf9ce9310a3c070404b6/mailnews/import/outlook/src/nsOutlookCompose.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dba9d75af64ff7f1ec10cf9ce9310a3c070404b6/mailnews/import/src/ImportCharSet.h">mailnews/import/src/ImportCharSet.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dba9d75af64ff7f1ec10cf9ce9310a3c070404b6/mailnews/import/src/ImportCharSet.h">file</a> |
<a href="/comm-central/annotate/dba9d75af64ff7f1ec10cf9ce9310a3c070404b6/mailnews/import/src/ImportCharSet.h">annotate</a> |
<a href="/comm-central/diff/dba9d75af64ff7f1ec10cf9ce9310a3c070404b6/mailnews/import/src/ImportCharSet.h">diff</a> |
<a href="/comm-central/comparison/dba9d75af64ff7f1ec10cf9ce9310a3c070404b6/mailnews/import/src/ImportCharSet.h">comparison</a> |
<a href="/comm-central/log/dba9d75af64ff7f1ec10cf9ce9310a3c070404b6/mailnews/import/src/ImportCharSet.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/dba9d75af64ff7f1ec10cf9ce9310a3c070404b6/mailnews/import/text/src/nsTextAddress.cpp">mailnews/import/text/src/nsTextAddress.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dba9d75af64ff7f1ec10cf9ce9310a3c070404b6/mailnews/import/text/src/nsTextAddress.cpp">file</a> |
<a href="/comm-central/annotate/dba9d75af64ff7f1ec10cf9ce9310a3c070404b6/mailnews/import/text/src/nsTextAddress.cpp">annotate</a> |
<a href="/comm-central/diff/dba9d75af64ff7f1ec10cf9ce9310a3c070404b6/mailnews/import/text/src/nsTextAddress.cpp">diff</a> |
<a href="/comm-central/comparison/dba9d75af64ff7f1ec10cf9ce9310a3c070404b6/mailnews/import/text/src/nsTextAddress.cpp">comparison</a> |
<a href="/comm-central/log/dba9d75af64ff7f1ec10cf9ce9310a3c070404b6/mailnews/import/text/src/nsTextAddress.cpp">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDIFService.cpp</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDIFService.cpp</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -832,17 +832,17 @@ NS_IMETHODIMP nsAbLDIFService::IsLDIFFil</span>
<a href="#l1.4"></a><span id="l1.4">       pChar = line.get();</span>
<a href="#l1.5"></a><span id="l1.5">       lineLen = line.Length();</span>
<a href="#l1.6"></a><span id="l1.6">       if (!lineLen &amp;&amp; gotLDIF)</span>
<a href="#l1.7"></a><span id="l1.7">       {</span>
<a href="#l1.8"></a><span id="l1.8">         recCount++;</span>
<a href="#l1.9"></a><span id="l1.9">         gotLDIF = false;</span>
<a href="#l1.10"></a><span id="l1.10">       }</span>
<a href="#l1.11"></a><span id="l1.11">                    </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-      if (lineLen &amp;&amp; (*pChar != ' ') &amp;&amp; (*pChar != 9))</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+      if (lineLen &amp;&amp; (*pChar != ' ') &amp;&amp; (*pChar != '\t'))</span>
<a href="#l1.14"></a><span id="l1.14">       {</span>
<a href="#l1.15"></a><span id="l1.15">         fLen = 0;</span>
<a href="#l1.16"></a><span id="l1.16"> </span>
<a href="#l1.17"></a><span id="l1.17">         while (lineLen &amp;&amp; (fLen &lt; (kMaxLDIFLen - 1)) &amp;&amp; (*pChar != ':'))</span>
<a href="#l1.18"></a><span id="l1.18">         {</span>
<a href="#l1.19"></a><span id="l1.19">           field[fLen] = *pChar;</span>
<a href="#l1.20"></a><span id="l1.20">           pChar++;</span>
<a href="#l1.21"></a><span id="l1.21">           fLen++;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgCompose.cpp</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgCompose.cpp</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -147,24 +147,21 @@ static void TranslateLineEnding(nsString</span>
<a href="#l2.4"></a><span id="l2.4">   PRUnichar* sPtr;   //Start data pointer</span>
<a href="#l2.5"></a><span id="l2.5">   PRUnichar* ePtr;   //End data pointer</span>
<a href="#l2.6"></a><span id="l2.6"> </span>
<a href="#l2.7"></a><span id="l2.7">   rPtr = wPtr = sPtr = data.BeginWriting();</span>
<a href="#l2.8"></a><span id="l2.8">   ePtr = rPtr + data.Length();</span>
<a href="#l2.9"></a><span id="l2.9"> </span>
<a href="#l2.10"></a><span id="l2.10">   while (rPtr &lt; ePtr)</span>
<a href="#l2.11"></a><span id="l2.11">   {</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-    if (*rPtr == 0x0D)</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-      if (rPtr + 1 &lt; ePtr &amp;&amp; *(rPtr + 1) == 0x0A)</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-      {</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineminus">-        *wPtr = 0x0A;</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+    if (*rPtr == nsCRT::CR) {</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+      *wPtr = nsCRT::LF;</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+      if (rPtr + 1 &lt; ePtr &amp;&amp; *(rPtr + 1) == nsCRT::LF)</span>
<a href="#l2.19"></a><span id="l2.19">         rPtr ++;</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineminus">-      }</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineminus">-      else</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineminus">-        *wPtr = 0x0A;</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineplus">+    }</span>
<a href="#l2.24"></a><span id="l2.24">     else</span>
<a href="#l2.25"></a><span id="l2.25">       *wPtr = *rPtr;</span>
<a href="#l2.26"></a><span id="l2.26"> </span>
<a href="#l2.27"></a><span id="l2.27">     rPtr ++;</span>
<a href="#l2.28"></a><span id="l2.28">     wPtr ++;</span>
<a href="#l2.29"></a><span id="l2.29">   }</span>
<a href="#l2.30"></a><span id="l2.30"> </span>
<a href="#l2.31"></a><span id="l2.31">   data.SetLength(wPtr - sPtr);</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineat">@@ -5119,17 +5116,17 @@ nsresult nsMsgCompose::TagConvertible(ns</span>
<a href="#l2.33"></a><span id="l2.33">           *_retval = nsIMsgCompConvertible::Altering;</span>
<a href="#l2.34"></a><span id="l2.34">         }</span>
<a href="#l2.35"></a><span id="l2.35">         else if (NS_SUCCEEDED(domElement-&gt;HasAttribute(NS_LITERAL_STRING(&quot;bgcolor&quot;), &amp;hasAttribute)) &amp;&amp;</span>
<a href="#l2.36"></a><span id="l2.36">                  hasAttribute &amp;&amp;</span>
<a href="#l2.37"></a><span id="l2.37">                  NS_SUCCEEDED(domElement-&gt;GetAttribute(NS_LITERAL_STRING(&quot;bgcolor&quot;), color)) &amp;&amp;</span>
<a href="#l2.38"></a><span id="l2.38">                  !color.LowerCaseEqualsLiteral(&quot;#ffffff&quot;)) {</span>
<a href="#l2.39"></a><span id="l2.39">           *_retval = nsIMsgCompConvertible::Altering;</span>
<a href="#l2.40"></a><span id="l2.40">         }</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineminus">-		else if (NS_SUCCEEDED(domElement-&gt;HasAttribute(NS_LITERAL_STRING(&quot;dir&quot;), &amp;hasAttribute))</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineplus">+        else if (NS_SUCCEEDED(domElement-&gt;HasAttribute(NS_LITERAL_STRING(&quot;dir&quot;), &amp;hasAttribute))</span>
<a href="#l2.43"></a><span id="l2.43">             &amp;&amp; hasAttribute)  // dir=rtl attributes should not downconvert</span>
<a href="#l2.44"></a><span id="l2.44">           *_retval = nsIMsgCompConvertible::No;</span>
<a href="#l2.45"></a><span id="l2.45"> </span>
<a href="#l2.46"></a><span id="l2.46">         //ignore special color setting for link, vlink and alink at this point.</span>
<a href="#l2.47"></a><span id="l2.47">       }</span>
<a href="#l2.48"></a><span id="l2.48"> </span>
<a href="#l2.49"></a><span id="l2.49">     }</span>
<a href="#l2.50"></a><span id="l2.50">     else if (element.LowerCaseEqualsLiteral(&quot;blockquote&quot;))</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/import/eudora/src/nsEudoraCompose.cpp</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/import/eudora/src/nsEudoraCompose.cpp</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -303,17 +303,17 @@ void nsEudoraCompose::GetNthHeader( cons</span>
<a href="#l3.4"></a><span id="l3.4">     }</span>
<a href="#l3.5"></a><span id="l3.5">     header.Append( pStart, len);</span>
<a href="#l3.6"></a><span id="l3.6">     header.Trim( kWhitespace);</span>
<a href="#l3.7"></a><span id="l3.7">     start++;</span>
<a href="#l3.8"></a><span id="l3.8">     pChar++;</span>
<a href="#l3.9"></a><span id="l3.9">   }</span>
<a href="#l3.10"></a><span id="l3.10">   else {</span>
<a href="#l3.11"></a><span id="l3.11">     while (start &lt; dataLen) {</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-      if ((*pChar != ' ') &amp;&amp; (*pChar != 9)) {</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+      if ((*pChar != ' ') &amp;&amp; (*pChar != '\t')) {</span>
<a href="#l3.14"></a><span id="l3.14">         if (n == index) {</span>
<a href="#l3.15"></a><span id="l3.15">           pStart = pChar;</span>
<a href="#l3.16"></a><span id="l3.16">           len = 0;</span>
<a href="#l3.17"></a><span id="l3.17">           while ((start &lt; dataLen) &amp;&amp; (*pChar != ':')) {</span>
<a href="#l3.18"></a><span id="l3.18">             start++;</span>
<a href="#l3.19"></a><span id="l3.19">             len++;</span>
<a href="#l3.20"></a><span id="l3.20">             pChar++;</span>
<a href="#l3.21"></a><span id="l3.21">           }</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineat">@@ -322,50 +322,60 @@ void nsEudoraCompose::GetNthHeader( cons</span>
<a href="#l3.23"></a><span id="l3.23">           start++;</span>
<a href="#l3.24"></a><span id="l3.24">           pChar++;</span>
<a href="#l3.25"></a><span id="l3.25">           break;</span>
<a href="#l3.26"></a><span id="l3.26">         }</span>
<a href="#l3.27"></a><span id="l3.27">         else</span>
<a href="#l3.28"></a><span id="l3.28">           index++;</span>
<a href="#l3.29"></a><span id="l3.29">       }</span>
<a href="#l3.30"></a><span id="l3.30"> </span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-      while ((start &lt; dataLen) &amp;&amp; (*pChar != 0x0D) &amp;&amp; (*pChar != 0x0A)) {</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+      // Skip to next end of line.</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+      while ((start &lt; dataLen) &amp;&amp;</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+             (*pChar != nsCRT::CR) &amp;&amp; (*pChar != nsCRT::LF)) {</span>
<a href="#l3.35"></a><span id="l3.35">         start++;</span>
<a href="#l3.36"></a><span id="l3.36">         pChar++;</span>
<a href="#l3.37"></a><span id="l3.37">       }</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineminus">-      while ((start &lt; dataLen) &amp;&amp; ((*pChar == 0x0D) || (*pChar == 0x0A))) {</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+      // Skip over end of line(s).</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+      while ((start &lt; dataLen) &amp;&amp;</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+             ((*pChar == nsCRT::CR) || (*pChar == nsCRT::LF))) {</span>
<a href="#l3.42"></a><span id="l3.42">         start++;</span>
<a href="#l3.43"></a><span id="l3.43">         pChar++;</span>
<a href="#l3.44"></a><span id="l3.44">       }</span>
<a href="#l3.45"></a><span id="l3.45">     }</span>
<a href="#l3.46"></a><span id="l3.46">   }</span>
<a href="#l3.47"></a><span id="l3.47"> </span>
<a href="#l3.48"></a><span id="l3.48">   if (start &gt;= dataLen)</span>
<a href="#l3.49"></a><span id="l3.49">     return;</span>
<a href="#l3.50"></a><span id="l3.50"> </span>
<a href="#l3.51"></a><span id="l3.51">   PRInt32 lineEnd;</span>
<a href="#l3.52"></a><span id="l3.52">   PRInt32 end = start;</span>
<a href="#l3.53"></a><span id="l3.53">   while (end &lt; dataLen) {</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineminus">-    while ((end &lt; dataLen) &amp;&amp; (*pChar != 0x0D) &amp;&amp; (*pChar != 0x0A)) {</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineplus">+    // Skip to next end of line.</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineplus">+    while ((end &lt; dataLen) &amp;&amp; (*pChar != nsCRT::CR) &amp;&amp; (*pChar != nsCRT::LF)) {</span>
<a href="#l3.57"></a><span id="l3.57">       end++;</span>
<a href="#l3.58"></a><span id="l3.58">       pChar++;</span>
<a href="#l3.59"></a><span id="l3.59">     }</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineplus">+</span>
<a href="#l3.61"></a><span id="l3.61">     if (end &gt; start) {</span>
<a href="#l3.62"></a><span id="l3.62">       val.Append( pData + start, end - start);</span>
<a href="#l3.63"></a><span id="l3.63">     }</span>
<a href="#l3.64"></a><span id="l3.64"> </span>
<a href="#l3.65"></a><span id="l3.65">     lineEnd = end;</span>
<a href="#l3.66"></a><span id="l3.66">     pStart = pChar;</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineminus">-    while ((end &lt; dataLen) &amp;&amp; ((*pChar == 0x0D) || (*pChar == 0x0A))) {</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineplus">+</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineplus">+    // Skip over end of line(s).</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineplus">+    while ((end &lt; dataLen) &amp;&amp;</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineplus">+           ((*pChar == nsCRT::CR) || (*pChar == nsCRT::LF))) {</span>
<a href="#l3.72"></a><span id="l3.72">       end++;</span>
<a href="#l3.73"></a><span id="l3.73">       pChar++;</span>
<a href="#l3.74"></a><span id="l3.74">     }</span>
<a href="#l3.75"></a><span id="l3.75"> </span>
<a href="#l3.76"></a><span id="l3.76">     start = end;</span>
<a href="#l3.77"></a><span id="l3.77"> </span>
<a href="#l3.78"></a><span id="l3.78" class="difflineplus">+    // Skip over space(s) and tab(s).</span>
<a href="#l3.79"></a><span id="l3.79">     while ((end &lt; dataLen) &amp;&amp; ((*pChar == ' ') || (*pChar == '\t'))) {</span>
<a href="#l3.80"></a><span id="l3.80">       end++;</span>
<a href="#l3.81"></a><span id="l3.81">       pChar++;</span>
<a href="#l3.82"></a><span id="l3.82">     }</span>
<a href="#l3.83"></a><span id="l3.83"> </span>
<a href="#l3.84"></a><span id="l3.84">     if (start == end)</span>
<a href="#l3.85"></a><span id="l3.85">       break;</span>
<a href="#l3.86"></a><span id="l3.86"> </span>
<a href="#l3.87"></a><span id="l3.87" class="difflineat">@@ -391,24 +401,29 @@ void nsEudoraCompose::GetHeaderValue( co</span>
<a href="#l3.88"></a><span id="l3.88">   PRInt32  start = 0;</span>
<a href="#l3.89"></a><span id="l3.89">   PRInt32 len = strlen( pHeader);</span>
<a href="#l3.90"></a><span id="l3.90">   const char *pChar = pData;</span>
<a href="#l3.91"></a><span id="l3.91">   if (!PL_strncasecmp( pHeader, pData, len)) {</span>
<a href="#l3.92"></a><span id="l3.92">     start = len;</span>
<a href="#l3.93"></a><span id="l3.93">   }</span>
<a href="#l3.94"></a><span id="l3.94">   else {</span>
<a href="#l3.95"></a><span id="l3.95">     while (start &lt; dataLen) {</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineminus">-      while ((start &lt; dataLen) &amp;&amp; (*pChar != 0x0D) &amp;&amp; (*pChar != 0x0A)) {</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineplus">+      // Skip to next end of line.</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineplus">+      while ((start &lt; dataLen) &amp;&amp;</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineplus">+             (*pChar != nsCRT::CR) &amp;&amp; (*pChar != nsCRT::LF)) {</span>
<a href="#l3.100"></a><span id="l3.100">         start++;</span>
<a href="#l3.101"></a><span id="l3.101">         pChar++;</span>
<a href="#l3.102"></a><span id="l3.102">       }</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineminus">-      while ((start &lt; dataLen) &amp;&amp; ((*pChar == 0x0D) || (*pChar == 0x0A))) {</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineplus">+      // Skip over end of line(s).</span>
<a href="#l3.105"></a><span id="l3.105" class="difflineplus">+      while ((start &lt; dataLen) &amp;&amp;</span>
<a href="#l3.106"></a><span id="l3.106" class="difflineplus">+             ((*pChar == nsCRT::CR) || (*pChar == nsCRT::LF))) {</span>
<a href="#l3.107"></a><span id="l3.107">         start++;</span>
<a href="#l3.108"></a><span id="l3.108">         pChar++;</span>
<a href="#l3.109"></a><span id="l3.109">       }</span>
<a href="#l3.110"></a><span id="l3.110" class="difflineplus">+</span>
<a href="#l3.111"></a><span id="l3.111">       if ((start &lt; dataLen) &amp;&amp; !PL_strncasecmp( pChar, pHeader, len))</span>
<a href="#l3.112"></a><span id="l3.112">         break;</span>
<a href="#l3.113"></a><span id="l3.113">     }</span>
<a href="#l3.114"></a><span id="l3.114">     if (start &lt; dataLen)</span>
<a href="#l3.115"></a><span id="l3.115">       start += len;</span>
<a href="#l3.116"></a><span id="l3.116">   }</span>
<a href="#l3.117"></a><span id="l3.117"> </span>
<a href="#l3.118"></a><span id="l3.118">   if (start &gt;= dataLen)</span>
<a href="#l3.119"></a><span id="l3.119" class="difflineat">@@ -416,33 +431,39 @@ void nsEudoraCompose::GetHeaderValue( co</span>
<a href="#l3.120"></a><span id="l3.120"> </span>
<a href="#l3.121"></a><span id="l3.121">   PRInt32 end = start;</span>
<a href="#l3.122"></a><span id="l3.122">   PRInt32 lineEnd;</span>
<a href="#l3.123"></a><span id="l3.123">   const char * pStart;</span>
<a href="#l3.124"></a><span id="l3.124"> </span>
<a href="#l3.125"></a><span id="l3.125">   pChar = pData + start;</span>
<a href="#l3.126"></a><span id="l3.126"> </span>
<a href="#l3.127"></a><span id="l3.127">   while (end &lt; dataLen) {</span>
<a href="#l3.128"></a><span id="l3.128" class="difflineminus">-    while ((end &lt; dataLen) &amp;&amp; (*pChar != 0x0D) &amp;&amp; (*pChar != 0x0A)) {</span>
<a href="#l3.129"></a><span id="l3.129" class="difflineplus">+    // Skip to next end of line.</span>
<a href="#l3.130"></a><span id="l3.130" class="difflineplus">+    while ((end &lt; dataLen) &amp;&amp; (*pChar != nsCRT::CR) &amp;&amp; (*pChar != nsCRT::LF)) {</span>
<a href="#l3.131"></a><span id="l3.131">       end++;</span>
<a href="#l3.132"></a><span id="l3.132">       pChar++;</span>
<a href="#l3.133"></a><span id="l3.133">     }</span>
<a href="#l3.134"></a><span id="l3.134" class="difflineplus">+</span>
<a href="#l3.135"></a><span id="l3.135">     if (end &gt; start) {</span>
<a href="#l3.136"></a><span id="l3.136">       val.Append( pData + start, end - start);</span>
<a href="#l3.137"></a><span id="l3.137">     }</span>
<a href="#l3.138"></a><span id="l3.138"> </span>
<a href="#l3.139"></a><span id="l3.139">     lineEnd = end;</span>
<a href="#l3.140"></a><span id="l3.140">     pStart = pChar;</span>
<a href="#l3.141"></a><span id="l3.141" class="difflineminus">-    while ((end &lt; dataLen) &amp;&amp; ((*pChar == 0x0D) || (*pChar == 0x0A))) {</span>
<a href="#l3.142"></a><span id="l3.142" class="difflineplus">+</span>
<a href="#l3.143"></a><span id="l3.143" class="difflineplus">+    // Skip over the end of line(s).</span>
<a href="#l3.144"></a><span id="l3.144" class="difflineplus">+    while ((end &lt; dataLen) &amp;&amp;</span>
<a href="#l3.145"></a><span id="l3.145" class="difflineplus">+           ((*pChar == nsCRT::CR) || (*pChar == nsCRT::LF))) {</span>
<a href="#l3.146"></a><span id="l3.146">       end++;</span>
<a href="#l3.147"></a><span id="l3.147">       pChar++;</span>
<a href="#l3.148"></a><span id="l3.148">     }</span>
<a href="#l3.149"></a><span id="l3.149"> </span>
<a href="#l3.150"></a><span id="l3.150">     start = end;</span>
<a href="#l3.151"></a><span id="l3.151"> </span>
<a href="#l3.152"></a><span id="l3.152" class="difflineplus">+    // Skip over space(s) and tab(s).</span>
<a href="#l3.153"></a><span id="l3.153">     while ((end &lt; dataLen) &amp;&amp; ((*pChar == ' ') || (*pChar == '\t'))) {</span>
<a href="#l3.154"></a><span id="l3.154">       end++;</span>
<a href="#l3.155"></a><span id="l3.155">       pChar++;</span>
<a href="#l3.156"></a><span id="l3.156">     }</span>
<a href="#l3.157"></a><span id="l3.157"> </span>
<a href="#l3.158"></a><span id="l3.158">     if (start == end)</span>
<a href="#l3.159"></a><span id="l3.159">       break;</span>
<a href="#l3.160"></a><span id="l3.160"> </span>
<a href="#l3.161"></a><span id="l3.161" class="difflineat">@@ -722,31 +743,31 @@ nsresult nsEudoraCompose::SendTheMessage</span>
<a href="#l3.162"></a><span id="l3.162"> </span>
<a href="#l3.163"></a><span id="l3.163"> bool SimpleBufferTonyRCopiedOnce::SpecialMemCpy( PRInt32 offset, const char *pData, PRInt32 len, PRInt32 *pWritten)</span>
<a href="#l3.164"></a><span id="l3.164"> {</span>
<a href="#l3.165"></a><span id="l3.165">   // Arg!!!!!  Mozilla can't handle plain CRs in any mail messages.  Particularly a</span>
<a href="#l3.166"></a><span id="l3.166">   // problem with Eudora since it doesn't give a rats a**</span>
<a href="#l3.167"></a><span id="l3.167">   *pWritten = len;</span>
<a href="#l3.168"></a><span id="l3.168">   PRInt32  sz = offset + len;</span>
<a href="#l3.169"></a><span id="l3.169">   if (offset) {</span>
<a href="#l3.170"></a><span id="l3.170" class="difflineminus">-    if ((m_pBuffer[offset - 1] == 0x0D) &amp;&amp; (*pData != 0x0A)) {</span>
<a href="#l3.171"></a><span id="l3.171" class="difflineplus">+    if ((m_pBuffer[offset - 1] == nsCRT::CR) &amp;&amp; (*pData != nsCRT::LF)) {</span>
<a href="#l3.172"></a><span id="l3.172">       sz++;</span>
<a href="#l3.173"></a><span id="l3.173">       if (!Grow( sz)) return( false);</span>
<a href="#l3.174"></a><span id="l3.174" class="difflineminus">-      m_pBuffer[offset] = 0x0A;</span>
<a href="#l3.175"></a><span id="l3.175" class="difflineplus">+      m_pBuffer[offset] = nsCRT::LF;</span>
<a href="#l3.176"></a><span id="l3.176">       offset++;</span>
<a href="#l3.177"></a><span id="l3.177">       (*pWritten)++;</span>
<a href="#l3.178"></a><span id="l3.178">     }</span>
<a href="#l3.179"></a><span id="l3.179">   }</span>
<a href="#l3.180"></a><span id="l3.180">   while (len &gt; 0) {</span>
<a href="#l3.181"></a><span id="l3.181" class="difflineminus">-    if ((*pData == 0x0D) &amp;&amp; (*(pData + 1) != 0x0A)) {</span>
<a href="#l3.182"></a><span id="l3.182" class="difflineplus">+    if ((*pData == nsCRT::CR) &amp;&amp; (*(pData + 1) != nsCRT::LF)) {</span>
<a href="#l3.183"></a><span id="l3.183">       sz++;</span>
<a href="#l3.184"></a><span id="l3.184">       if (!Grow( sz)) return( false);</span>
<a href="#l3.185"></a><span id="l3.185" class="difflineminus">-      m_pBuffer[offset] = 0x0D;</span>
<a href="#l3.186"></a><span id="l3.186" class="difflineplus">+      m_pBuffer[offset] = nsCRT::CR;</span>
<a href="#l3.187"></a><span id="l3.187">       offset++;</span>
<a href="#l3.188"></a><span id="l3.188" class="difflineminus">-      m_pBuffer[offset] = 0x0A;</span>
<a href="#l3.189"></a><span id="l3.189" class="difflineplus">+      m_pBuffer[offset] = nsCRT::LF;</span>
<a href="#l3.190"></a><span id="l3.190">       (*pWritten)++;</span>
<a href="#l3.191"></a><span id="l3.191">     }</span>
<a href="#l3.192"></a><span id="l3.192">     else {</span>
<a href="#l3.193"></a><span id="l3.193">       m_pBuffer[offset] = *pData;</span>
<a href="#l3.194"></a><span id="l3.194">     }</span>
<a href="#l3.195"></a><span id="l3.195">     offset++;</span>
<a href="#l3.196"></a><span id="l3.196">     pData++;</span>
<a href="#l3.197"></a><span id="l3.197">     len--;</span>
<a href="#l3.198"></a><span id="l3.198" class="difflineat">@@ -808,47 +829,54 @@ nsresult nsEudoraCompose::ReadHeaders( R</span>
<a href="#l3.199"></a><span id="l3.199">   return( NS_OK);</span>
<a href="#l3.200"></a><span id="l3.200"> }</span>
<a href="#l3.201"></a><span id="l3.201"> </span>
<a href="#l3.202"></a><span id="l3.202"> PRInt32 nsEudoraCompose::FindNextEndLine( SimpleBufferTonyRCopiedOnce&amp; data)</span>
<a href="#l3.203"></a><span id="l3.203"> {</span>
<a href="#l3.204"></a><span id="l3.204">   PRInt32 len = data.m_bytesInBuf - data.m_writeOffset;</span>
<a href="#l3.205"></a><span id="l3.205">   if (!len)</span>
<a href="#l3.206"></a><span id="l3.206">     return( -1);</span>
<a href="#l3.207"></a><span id="l3.207" class="difflineminus">-  PRInt32  count = 0;</span>
<a href="#l3.208"></a><span id="l3.208" class="difflineplus">+</span>
<a href="#l3.209"></a><span id="l3.209" class="difflineplus">+  PRInt32 count = 0;</span>
<a href="#l3.210"></a><span id="l3.210">   const char *pData = data.m_pBuffer + data.m_writeOffset;</span>
<a href="#l3.211"></a><span id="l3.211" class="difflineminus">-  while (((*pData == 0x0D) || (*pData == 0x0A)) &amp;&amp; (count &lt; len)) {</span>
<a href="#l3.212"></a><span id="l3.212" class="difflineplus">+  // Skip over end of line(s).</span>
<a href="#l3.213"></a><span id="l3.213" class="difflineplus">+  while ((count &lt; len) &amp;&amp; ((*pData == nsCRT::CR) || (*pData == nsCRT::LF))) {</span>
<a href="#l3.214"></a><span id="l3.214">     pData++;</span>
<a href="#l3.215"></a><span id="l3.215">     count++;</span>
<a href="#l3.216"></a><span id="l3.216">   }</span>
<a href="#l3.217"></a><span id="l3.217" class="difflineminus">-  while ((*pData != 0x0D) &amp;&amp; (*pData != 0x0A) &amp;&amp; (count &lt; len)) {</span>
<a href="#l3.218"></a><span id="l3.218" class="difflineplus">+  // Skip to next end of line.</span>
<a href="#l3.219"></a><span id="l3.219" class="difflineplus">+  while ((count &lt; len) &amp;&amp; (*pData != nsCRT::CR) &amp;&amp; (*pData != nsCRT::LF)) {</span>
<a href="#l3.220"></a><span id="l3.220">     pData++;</span>
<a href="#l3.221"></a><span id="l3.221">     count++;</span>
<a href="#l3.222"></a><span id="l3.222">   }</span>
<a href="#l3.223"></a><span id="l3.223" class="difflineminus">-</span>
<a href="#l3.224"></a><span id="l3.224">   if (count &lt; len)</span>
<a href="#l3.225"></a><span id="l3.225">     return( count);</span>
<a href="#l3.226"></a><span id="l3.226"> </span>
<a href="#l3.227"></a><span id="l3.227">   return( -1);</span>
<a href="#l3.228"></a><span id="l3.228"> }</span>
<a href="#l3.229"></a><span id="l3.229"> </span>
<a href="#l3.230"></a><span id="l3.230"> PRInt32 nsEudoraCompose::IsEndHeaders( SimpleBufferTonyRCopiedOnce&amp; data)</span>
<a href="#l3.231"></a><span id="l3.231"> {</span>
<a href="#l3.232"></a><span id="l3.232">   PRInt32 len = data.m_bytesInBuf - data.m_writeOffset;</span>
<a href="#l3.233"></a><span id="l3.233">   if (len &lt; 2)</span>
<a href="#l3.234"></a><span id="l3.234">     return( -1);</span>
<a href="#l3.235"></a><span id="l3.235" class="difflineplus">+</span>
<a href="#l3.236"></a><span id="l3.236">   const char *pChar = data.m_pBuffer + data.m_writeOffset;</span>
<a href="#l3.237"></a><span id="l3.237" class="difflineminus">-  if ((*pChar == 0x0D) &amp;&amp; (*(pChar + 1) == 0x0D))</span>
<a href="#l3.238"></a><span id="l3.238" class="difflineplus">+  // Double nsCRT::CR.</span>
<a href="#l3.239"></a><span id="l3.239" class="difflineplus">+  if ((*pChar == nsCRT::CR) &amp;&amp; (*(pChar + 1) == nsCRT::CR))</span>
<a href="#l3.240"></a><span id="l3.240">     return( 2);</span>
<a href="#l3.241"></a><span id="l3.241"> </span>
<a href="#l3.242"></a><span id="l3.242">   if (len &lt; 4)</span>
<a href="#l3.243"></a><span id="l3.243">     return( -1);</span>
<a href="#l3.244"></a><span id="l3.244" class="difflineminus">-  if ((*pChar == 0x0D) &amp;&amp; (*(pChar + 1) == 0x0A) &amp;&amp;</span>
<a href="#l3.245"></a><span id="l3.245" class="difflineminus">-    (*(pChar + 2) == 0x0D) &amp;&amp; (*(pChar + 3) == 0x0A))</span>
<a href="#l3.246"></a><span id="l3.246" class="difflineplus">+</span>
<a href="#l3.247"></a><span id="l3.247" class="difflineplus">+  // Double (nsCRT::CR + nsCRT::LF).</span>
<a href="#l3.248"></a><span id="l3.248" class="difflineplus">+  if ((*pChar == nsCRT::CR) &amp;&amp; (*(pChar + 1) == nsCRT::LF) &amp;&amp;</span>
<a href="#l3.249"></a><span id="l3.249" class="difflineplus">+      (*(pChar + 2) == nsCRT::CR) &amp;&amp; (*(pChar + 3) == nsCRT::LF))</span>
<a href="#l3.250"></a><span id="l3.250">     return( 4);</span>
<a href="#l3.251"></a><span id="l3.251" class="difflineplus">+</span>
<a href="#l3.252"></a><span id="l3.252">   return( -1);</span>
<a href="#l3.253"></a><span id="l3.253"> }</span>
<a href="#l3.254"></a><span id="l3.254"> </span>
<a href="#l3.255"></a><span id="l3.255"> </span>
<a href="#l3.256"></a><span id="l3.256"> nsresult nsEudoraCompose::CopyComposedMessage( nsCString&amp; fromLine, nsIFile *pSrc, nsIOutputStream *pDst, SimpleBufferTonyRCopiedOnce&amp; copy)</span>
<a href="#l3.257"></a><span id="l3.257"> {</span>
<a href="#l3.258"></a><span id="l3.258">   copy.m_bytesInBuf = 0;</span>
<a href="#l3.259"></a><span id="l3.259">   copy.m_writeOffset = 0;</span>
<a href="#l3.260"></a><span id="l3.260" class="difflineat">@@ -905,17 +933,17 @@ nsresult nsEudoraCompose::CopyComposedMe</span>
<a href="#l3.261"></a><span id="l3.261">         copy.m_writeOffset = copy.m_bytesInBuf;</span>
<a href="#l3.262"></a><span id="l3.262">       else</span>
<a href="#l3.263"></a><span id="l3.263">         IMPORT_LOG0( &quot;*** Error writing to destination mailbox\n&quot;);</span>
<a href="#l3.264"></a><span id="l3.264">     }</span>
<a href="#l3.265"></a><span id="l3.265">   }</span>
<a href="#l3.266"></a><span id="l3.266"> </span>
<a href="#l3.267"></a><span id="l3.267">   state.pInputStream-&gt;Close();</span>
<a href="#l3.268"></a><span id="l3.268"> </span>
<a href="#l3.269"></a><span id="l3.269" class="difflineminus">-  if ((lastChar != 0x0A) &amp;&amp; NS_SUCCEEDED( rv)) {</span>
<a href="#l3.270"></a><span id="l3.270" class="difflineplus">+  if ((lastChar != nsCRT::LF) &amp;&amp; NS_SUCCEEDED(rv)) {</span>
<a href="#l3.271"></a><span id="l3.271">     rv = pDst-&gt;Write( &quot;\x0D\x0A&quot;, 2, &amp;written);</span>
<a href="#l3.272"></a><span id="l3.272">     if (written != 2)</span>
<a href="#l3.273"></a><span id="l3.273">       rv = NS_ERROR_FAILURE;</span>
<a href="#l3.274"></a><span id="l3.274">   }</span>
<a href="#l3.275"></a><span id="l3.275"> </span>
<a href="#l3.276"></a><span id="l3.276">   return( rv);</span>
<a href="#l3.277"></a><span id="l3.277"> }</span>
<a href="#l3.278"></a><span id="l3.278"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/import/eudora/src/nsEudoraMailbox.cpp</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/import/eudora/src/nsEudoraMailbox.cpp</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -105,17 +105,16 @@ static const char *eudoraMonths[12] = {</span>
<a href="#l4.4"></a><span id="l4.4">   &quot;Jul&quot;,</span>
<a href="#l4.5"></a><span id="l4.5">   &quot;Aug&quot;,</span>
<a href="#l4.6"></a><span id="l4.6">   &quot;Sep&quot;,</span>
<a href="#l4.7"></a><span id="l4.7">   &quot;Oct&quot;,</span>
<a href="#l4.8"></a><span id="l4.8">   &quot;Nov&quot;,</span>
<a href="#l4.9"></a><span id="l4.9">   &quot;Dec&quot;</span>
<a href="#l4.10"></a><span id="l4.10"> };</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-</span>
<a href="#l4.13"></a><span id="l4.13"> PRUint16 EudoraTOCEntry::GetMozillaStatusFlags()</span>
<a href="#l4.14"></a><span id="l4.14"> {</span>
<a href="#l4.15"></a><span id="l4.15">   // Return the mozilla equivalent of flags that Eudora supports.</span>
<a href="#l4.16"></a><span id="l4.16">   PRUint16  flags = 0;</span>
<a href="#l4.17"></a><span id="l4.17"> </span>
<a href="#l4.18"></a><span id="l4.18"> #ifndef XP_MACOSX</span>
<a href="#l4.19"></a><span id="l4.19">   switch (m_State)</span>
<a href="#l4.20"></a><span id="l4.20">   {</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineat">@@ -166,17 +165,16 @@ PRUint16 EudoraTOCEntry::GetMozillaStatu</span>
<a href="#l4.22"></a><span id="l4.22">   // Translate priority into format used in mozilla status flags</span>
<a href="#l4.23"></a><span id="l4.23">   // (which is reversed for some reason)</span>
<a href="#l4.24"></a><span id="l4.24">   flags |= (7-m_Priority) &lt;&lt; 13;</span>
<a href="#l4.25"></a><span id="l4.25"> #endif</span>
<a href="#l4.26"></a><span id="l4.26"> </span>
<a href="#l4.27"></a><span id="l4.27">   return flags;</span>
<a href="#l4.28"></a><span id="l4.28"> }</span>
<a href="#l4.29"></a><span id="l4.29"> </span>
<a href="#l4.30"></a><span id="l4.30" class="difflineminus">-</span>
<a href="#l4.31"></a><span id="l4.31"> PRUint32 EudoraTOCEntry::GetMozillaStatus2Flags()</span>
<a href="#l4.32"></a><span id="l4.32"> {</span>
<a href="#l4.33"></a><span id="l4.33"> #ifdef XP_MACOSX</span>
<a href="#l4.34"></a><span id="l4.34">   return 0;</span>
<a href="#l4.35"></a><span id="l4.35"> #else</span>
<a href="#l4.36"></a><span id="l4.36"> </span>
<a href="#l4.37"></a><span id="l4.37">   // Return the mozilla equivalent of flags that Eudora supports.</span>
<a href="#l4.38"></a><span id="l4.38">   PRUint32  flags = 0;</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineat">@@ -186,17 +184,16 @@ PRUint32 EudoraTOCEntry::GetMozillaStatu</span>
<a href="#l4.40"></a><span id="l4.40"> </span>
<a href="#l4.41"></a><span id="l4.41">   if (m_Flags &amp; MSF_READ_RECEIPT)</span>
<a href="#l4.42"></a><span id="l4.42">     flags |= nsMsgMessageFlags::MDNReportNeeded;</span>
<a href="#l4.43"></a><span id="l4.43"> </span>
<a href="#l4.44"></a><span id="l4.44">   return flags;</span>
<a href="#l4.45"></a><span id="l4.45"> #endif</span>
<a href="#l4.46"></a><span id="l4.46"> }</span>
<a href="#l4.47"></a><span id="l4.47"> </span>
<a href="#l4.48"></a><span id="l4.48" class="difflineminus">-</span>
<a href="#l4.49"></a><span id="l4.49"> nsEudoraMailbox::nsEudoraMailbox()</span>
<a href="#l4.50"></a><span id="l4.50"> : m_fromLen(0)</span>
<a href="#l4.51"></a><span id="l4.51"> {</span>
<a href="#l4.52"></a><span id="l4.52"> }</span>
<a href="#l4.53"></a><span id="l4.53"> </span>
<a href="#l4.54"></a><span id="l4.54"> nsEudoraMailbox::~nsEudoraMailbox()</span>
<a href="#l4.55"></a><span id="l4.55"> {</span>
<a href="#l4.56"></a><span id="l4.56">   EmptyAttachments();</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineat">@@ -226,17 +223,16 @@ nsresult nsEudoraMailbox::DeleteFile( ns</span>
<a href="#l4.58"></a><span id="l4.58"> #ifndef DONT_DELETE_EUDORA_TEMP_FILES</span>
<a href="#l4.59"></a><span id="l4.59">         rv = pFile-&gt;Remove(false);</span>
<a href="#l4.60"></a><span id="l4.60"> #endif</span>
<a href="#l4.61"></a><span id="l4.61">     }</span>
<a href="#l4.62"></a><span id="l4.62">   }</span>
<a href="#l4.63"></a><span id="l4.63">   return( rv);</span>
<a href="#l4.64"></a><span id="l4.64"> }</span>
<a href="#l4.65"></a><span id="l4.65"> </span>
<a href="#l4.66"></a><span id="l4.66" class="difflineminus">-</span>
<a href="#l4.67"></a><span id="l4.67"> #define kComposeErrorStr  &quot;X-Eudora-Compose-Error: *****&quot; &quot;\x0D\x0A&quot;</span>
<a href="#l4.68"></a><span id="l4.68"> #define kHTMLTag &quot;&lt;html&gt;&quot;</span>
<a href="#l4.69"></a><span id="l4.69"> </span>
<a href="#l4.70"></a><span id="l4.70"> nsresult nsEudoraMailbox::ImportMailbox( PRUint32 *pBytes, bool *pAbort, const PRUnichar *pName, nsIFile *pSrc, nsIFile *pDst, PRInt32 *pMsgCount)</span>
<a href="#l4.71"></a><span id="l4.71"> {</span>
<a href="#l4.72"></a><span id="l4.72">   nsCOMPtr&lt;nsIFile&gt;   tocFile;</span>
<a href="#l4.73"></a><span id="l4.73">         nsCOMPtr &lt;nsIInputStream&gt; srcInputStream;</span>
<a href="#l4.74"></a><span id="l4.74">         nsCOMPtr &lt;nsIInputStream&gt; tocInputStream;</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineat">@@ -346,17 +342,16 @@ nsresult nsEudoraMailbox::ImportMailbox(</span>
<a href="#l4.76"></a><span id="l4.76"> #ifdef XP_MACOSX</span>
<a href="#l4.77"></a><span id="l4.77"> #define kMsgHeaderSize    220</span>
<a href="#l4.78"></a><span id="l4.78"> #define  kMsgFirstOffset    278</span>
<a href="#l4.79"></a><span id="l4.79"> #else</span>
<a href="#l4.80"></a><span id="l4.80"> #define  kMsgHeaderSize    218</span>
<a href="#l4.81"></a><span id="l4.81"> #define kMsgFirstOffset    104</span>
<a href="#l4.82"></a><span id="l4.82"> #endif</span>
<a href="#l4.83"></a><span id="l4.83"> </span>
<a href="#l4.84"></a><span id="l4.84" class="difflineminus">-</span>
<a href="#l4.85"></a><span id="l4.85"> nsresult nsEudoraMailbox::ImportMailboxUsingTOC(</span>
<a href="#l4.86"></a><span id="l4.86">   PRUint32 *pBytes,</span>
<a href="#l4.87"></a><span id="l4.87">   bool *pAbort,</span>
<a href="#l4.88"></a><span id="l4.88">   nsIInputStream *pInputStream,</span>
<a href="#l4.89"></a><span id="l4.89">   nsIFile *tocFile,</span>
<a href="#l4.90"></a><span id="l4.90">   nsIOutputStream *pDst,</span>
<a href="#l4.91"></a><span id="l4.91">   PRInt32 *pMsgCount)</span>
<a href="#l4.92"></a><span id="l4.92"> {</span>
<a href="#l4.93"></a><span id="l4.93" class="difflineat">@@ -527,17 +522,16 @@ nsresult nsEudoraMailbox::ReadTOCEntry(n</span>
<a href="#l4.94"></a><span id="l4.94">   tocEntry.m_ucJunkScore = cJunkInfo;</span>
<a href="#l4.95"></a><span id="l4.95"> </span>
<a href="#l4.96"></a><span id="l4.96">   READ_TOC_FIELD(ulJunkPluginID);</span>
<a href="#l4.97"></a><span id="l4.97"> #endif</span>
<a href="#l4.98"></a><span id="l4.98"> </span>
<a href="#l4.99"></a><span id="l4.99">   return NS_OK;</span>
<a href="#l4.100"></a><span id="l4.100"> }</span>
<a href="#l4.101"></a><span id="l4.101"> </span>
<a href="#l4.102"></a><span id="l4.102" class="difflineminus">-</span>
<a href="#l4.103"></a><span id="l4.103"> nsresult nsEudoraMailbox::ImportMessage(</span>
<a href="#l4.104"></a><span id="l4.104">   SimpleBufferTonyRCopiedOnce &amp;headers,</span>
<a href="#l4.105"></a><span id="l4.105">   SimpleBufferTonyRCopiedOnce &amp;body,</span>
<a href="#l4.106"></a><span id="l4.106">   nsCString&amp; defaultDate,</span>
<a href="#l4.107"></a><span id="l4.107">   nsCAutoString&amp; bodyType,</span>
<a href="#l4.108"></a><span id="l4.108">   nsIOutputStream *pDst,</span>
<a href="#l4.109"></a><span id="l4.109">   PRInt32  *pMsgCount)</span>
<a href="#l4.110"></a><span id="l4.110"> {</span>
<a href="#l4.111"></a><span id="l4.111" class="difflineat">@@ -597,19 +591,16 @@ nsresult nsEudoraMailbox::ImportMessage(</span>
<a href="#l4.112"></a><span id="l4.112">     if (NS_FAILED( rv)) {</span>
<a href="#l4.113"></a><span id="l4.113">       IMPORT_LOG0( &quot;*** Error writing to destination mailbox\n&quot;);</span>
<a href="#l4.114"></a><span id="l4.114">     }</span>
<a href="#l4.115"></a><span id="l4.115">   }</span>
<a href="#l4.116"></a><span id="l4.116"> </span>
<a href="#l4.117"></a><span id="l4.117">   return rv;</span>
<a href="#l4.118"></a><span id="l4.118"> }</span>
<a href="#l4.119"></a><span id="l4.119"> </span>
<a href="#l4.120"></a><span id="l4.120" class="difflineminus">-</span>
<a href="#l4.121"></a><span id="l4.121" class="difflineminus">-</span>
<a href="#l4.122"></a><span id="l4.122" class="difflineminus">-</span>
<a href="#l4.123"></a><span id="l4.123"> nsresult nsEudoraMailbox::ReadNextMessage( ReadFileState *pState, SimpleBufferTonyRCopiedOnce&amp; copy,</span>
<a href="#l4.124"></a><span id="l4.124">                                           SimpleBufferTonyRCopiedOnce&amp; header, SimpleBufferTonyRCopiedOnce&amp; body,</span>
<a href="#l4.125"></a><span id="l4.125">                                           nsCString&amp; defaultDate, nsCString&amp; bodyType, EudoraTOCEntry *pTocEntry)</span>
<a href="#l4.126"></a><span id="l4.126"> {</span>
<a href="#l4.127"></a><span id="l4.127">   header.m_writeOffset = 0;</span>
<a href="#l4.128"></a><span id="l4.128">   body.m_writeOffset = 0;</span>
<a href="#l4.129"></a><span id="l4.129"> </span>
<a href="#l4.130"></a><span id="l4.130">   nsresult    rv;</span>
<a href="#l4.131"></a><span id="l4.131" class="difflineat">@@ -718,17 +709,16 @@ nsresult nsEudoraMailbox::ReadNextMessag</span>
<a href="#l4.132"></a><span id="l4.132">     header.Write( keywordHdr.get(), keywordHdr.Length() );</span>
<a href="#l4.133"></a><span id="l4.133">   }</span>
<a href="#l4.134"></a><span id="l4.134"> </span>
<a href="#l4.135"></a><span id="l4.135">   if (!header.Write( &amp;endBuffer, 1)) {</span>
<a href="#l4.136"></a><span id="l4.136">     IMPORT_LOG0( &quot;*** Error writing header trailing null\n&quot;);</span>
<a href="#l4.137"></a><span id="l4.137">     return( NS_ERROR_FAILURE);</span>
<a href="#l4.138"></a><span id="l4.138">   }</span>
<a href="#l4.139"></a><span id="l4.139"> </span>
<a href="#l4.140"></a><span id="l4.140" class="difflineminus">-</span>
<a href="#l4.141"></a><span id="l4.141">   copy.m_writeOffset += endLen;</span>
<a href="#l4.142"></a><span id="l4.142">   if (NS_FAILED( rv = FillMailBuffer( pState, copy))) {</span>
<a href="#l4.143"></a><span id="l4.143">     IMPORT_LOG0( &quot;*** Error reading beginning of message body\n&quot;);</span>
<a href="#l4.144"></a><span id="l4.144">     return( rv);</span>
<a href="#l4.145"></a><span id="l4.145">   }</span>
<a href="#l4.146"></a><span id="l4.146"> </span>
<a href="#l4.147"></a><span id="l4.147">   EmptyAttachments();</span>
<a href="#l4.148"></a><span id="l4.148"> </span>
<a href="#l4.149"></a><span id="l4.149" class="difflineat">@@ -771,17 +761,16 @@ nsresult nsEudoraMailbox::ReadNextMessag</span>
<a href="#l4.150"></a><span id="l4.150">     // attachment is actually missing.</span>
<a href="#l4.151"></a><span id="l4.151">     rv = ExamineAttachment( copy);</span>
<a href="#l4.152"></a><span id="l4.152">     if (NS_FAILED( rv)) {</span>
<a href="#l4.153"></a><span id="l4.153">       IMPORT_LOG0( &quot;*** Error examining attachment line\n&quot;);</span>
<a href="#l4.154"></a><span id="l4.154">       return( rv);</span>
<a href="#l4.155"></a><span id="l4.155">     }</span>
<a href="#l4.156"></a><span id="l4.156">     }</span>
<a href="#l4.157"></a><span id="l4.157"> </span>
<a href="#l4.158"></a><span id="l4.158" class="difflineminus">-</span>
<a href="#l4.159"></a><span id="l4.159">     while (((lineLen = FindStartLine( copy)) == -1) &amp;&amp; copy.m_bytesInBuf) {</span>
<a href="#l4.160"></a><span id="l4.160">       copy.m_writeOffset = copy.m_bytesInBuf;</span>
<a href="#l4.161"></a><span id="l4.161">       if (!body.Write( copy.m_pBuffer, copy.m_writeOffset)) {</span>
<a href="#l4.162"></a><span id="l4.162">         IMPORT_LOG0( &quot;*** Error writing to message body\n&quot;);</span>
<a href="#l4.163"></a><span id="l4.163">         return( NS_ERROR_FAILURE);</span>
<a href="#l4.164"></a><span id="l4.164">       }</span>
<a href="#l4.165"></a><span id="l4.165">       if (NS_FAILED( rv = FillMailBuffer( pState, copy))) {</span>
<a href="#l4.166"></a><span id="l4.166">         IMPORT_LOG0( &quot;*** Error reading message body\n&quot;);</span>
<a href="#l4.167"></a><span id="l4.167" class="difflineat">@@ -820,87 +809,89 @@ nsresult nsEudoraMailbox::ReadNextMessag</span>
<a href="#l4.168"></a><span id="l4.168">   if (NS_FAILED( rv = FillMailBuffer( pState, copy))) {</span>
<a href="#l4.169"></a><span id="l4.169">     IMPORT_LOG0( &quot;*** Error filling mail buffer for next read message\n&quot;);</span>
<a href="#l4.170"></a><span id="l4.170">     return( rv);</span>
<a href="#l4.171"></a><span id="l4.171">   }</span>
<a href="#l4.172"></a><span id="l4.172"> </span>
<a href="#l4.173"></a><span id="l4.173">   return( NS_OK);</span>
<a href="#l4.174"></a><span id="l4.174"> }</span>
<a href="#l4.175"></a><span id="l4.175"> </span>
<a href="#l4.176"></a><span id="l4.176" class="difflineminus">-</span>
<a href="#l4.177"></a><span id="l4.177" class="difflineminus">-</span>
<a href="#l4.178"></a><span id="l4.178"> PRInt32  nsEudoraMailbox::FindStartLine( SimpleBufferTonyRCopiedOnce&amp; data)</span>
<a href="#l4.179"></a><span id="l4.179"> {</span>
<a href="#l4.180"></a><span id="l4.180">   PRInt32 len = data.m_bytesInBuf - data.m_writeOffset;</span>
<a href="#l4.181"></a><span id="l4.181">   if (!len)</span>
<a href="#l4.182"></a><span id="l4.182">     return( -1);</span>
<a href="#l4.183"></a><span id="l4.183" class="difflineminus">-  PRInt32  count = 0;</span>
<a href="#l4.184"></a><span id="l4.184" class="difflineplus">+</span>
<a href="#l4.185"></a><span id="l4.185" class="difflineplus">+  PRInt32 count = 0;</span>
<a href="#l4.186"></a><span id="l4.186">   const char *pData = data.m_pBuffer + data.m_writeOffset;</span>
<a href="#l4.187"></a><span id="l4.187" class="difflineminus">-  while ((count &lt; len) &amp;&amp; (*pData != 0x0D) &amp;&amp; (*pData != 0x0A)) {</span>
<a href="#l4.188"></a><span id="l4.188" class="difflineplus">+  // Skip to next end of line.</span>
<a href="#l4.189"></a><span id="l4.189" class="difflineplus">+  while ((count &lt; len) &amp;&amp; (*pData != nsCRT::CR) &amp;&amp; (*pData != nsCRT::LF)) {</span>
<a href="#l4.190"></a><span id="l4.190">     pData++;</span>
<a href="#l4.191"></a><span id="l4.191">     count++;</span>
<a href="#l4.192"></a><span id="l4.192">   }</span>
<a href="#l4.193"></a><span id="l4.193">   if (count == len)</span>
<a href="#l4.194"></a><span id="l4.194">     return( -1);</span>
<a href="#l4.195"></a><span id="l4.195"> </span>
<a href="#l4.196"></a><span id="l4.196" class="difflineminus">-  while ((count &lt; len) &amp;&amp; ((*pData == 0x0D) || (*pData == 0x0A))) {</span>
<a href="#l4.197"></a><span id="l4.197" class="difflineplus">+  // Skip over end of line(s).</span>
<a href="#l4.198"></a><span id="l4.198" class="difflineplus">+  while ((count &lt; len) &amp;&amp; ((*pData == nsCRT::CR) || (*pData == nsCRT::LF))) {</span>
<a href="#l4.199"></a><span id="l4.199">     pData++;</span>
<a href="#l4.200"></a><span id="l4.200">     count++;</span>
<a href="#l4.201"></a><span id="l4.201">   }</span>
<a href="#l4.202"></a><span id="l4.202" class="difflineminus">-</span>
<a href="#l4.203"></a><span id="l4.203">   if (count &lt; len)</span>
<a href="#l4.204"></a><span id="l4.204">     return( count);</span>
<a href="#l4.205"></a><span id="l4.205"> </span>
<a href="#l4.206"></a><span id="l4.206">   return( -1);</span>
<a href="#l4.207"></a><span id="l4.207"> }</span>
<a href="#l4.208"></a><span id="l4.208"> </span>
<a href="#l4.209"></a><span id="l4.209"> PRInt32 nsEudoraMailbox::FindNextEndLine( SimpleBufferTonyRCopiedOnce&amp; data)</span>
<a href="#l4.210"></a><span id="l4.210"> {</span>
<a href="#l4.211"></a><span id="l4.211">   PRInt32 len = data.m_bytesInBuf - data.m_writeOffset;</span>
<a href="#l4.212"></a><span id="l4.212">   if (!len)</span>
<a href="#l4.213"></a><span id="l4.213">     return( -1);</span>
<a href="#l4.214"></a><span id="l4.214" class="difflineminus">-  PRInt32  count = 0;</span>
<a href="#l4.215"></a><span id="l4.215" class="difflineplus">+</span>
<a href="#l4.216"></a><span id="l4.216" class="difflineplus">+  PRInt32 count = 0;</span>
<a href="#l4.217"></a><span id="l4.217">   const char *pData = data.m_pBuffer + data.m_writeOffset;</span>
<a href="#l4.218"></a><span id="l4.218" class="difflineminus">-  while ((count &lt; len) &amp;&amp; ((*pData == 0x0D) || (*pData == 0x0A))) {</span>
<a href="#l4.219"></a><span id="l4.219" class="difflineplus">+  // Skip over end of line(s).</span>
<a href="#l4.220"></a><span id="l4.220" class="difflineplus">+  while ((count &lt; len) &amp;&amp; ((*pData == nsCRT::CR) || (*pData == nsCRT::LF))) {</span>
<a href="#l4.221"></a><span id="l4.221">     pData++;</span>
<a href="#l4.222"></a><span id="l4.222">     count++;</span>
<a href="#l4.223"></a><span id="l4.223">   }</span>
<a href="#l4.224"></a><span id="l4.224" class="difflineminus">-  while ((count &lt; len) &amp;&amp; (*pData != 0x0D) &amp;&amp; (*pData != 0x0A)) {</span>
<a href="#l4.225"></a><span id="l4.225" class="difflineplus">+  // Skip to next end of line.</span>
<a href="#l4.226"></a><span id="l4.226" class="difflineplus">+  while ((count &lt; len) &amp;&amp; (*pData != nsCRT::CR) &amp;&amp; (*pData != nsCRT::LF)) {</span>
<a href="#l4.227"></a><span id="l4.227">     pData++;</span>
<a href="#l4.228"></a><span id="l4.228">     count++;</span>
<a href="#l4.229"></a><span id="l4.229">   }</span>
<a href="#l4.230"></a><span id="l4.230" class="difflineminus">-</span>
<a href="#l4.231"></a><span id="l4.231">   if (count &lt; len)</span>
<a href="#l4.232"></a><span id="l4.232">     return( count);</span>
<a href="#l4.233"></a><span id="l4.233"> </span>
<a href="#l4.234"></a><span id="l4.234">   return( -1);</span>
<a href="#l4.235"></a><span id="l4.235"> }</span>
<a href="#l4.236"></a><span id="l4.236"> </span>
<a href="#l4.237"></a><span id="l4.237" class="difflineminus">-</span>
<a href="#l4.238"></a><span id="l4.238"> PRInt32 nsEudoraMailbox::IsEndHeaders( SimpleBufferTonyRCopiedOnce&amp; data)</span>
<a href="#l4.239"></a><span id="l4.239"> {</span>
<a href="#l4.240"></a><span id="l4.240">   PRInt32 len = data.m_bytesInBuf - data.m_writeOffset;</span>
<a href="#l4.241"></a><span id="l4.241">   if (len &lt; 2)</span>
<a href="#l4.242"></a><span id="l4.242">     return( -1);</span>
<a href="#l4.243"></a><span id="l4.243" class="difflineplus">+</span>
<a href="#l4.244"></a><span id="l4.244">   const char *pChar = data.m_pBuffer + data.m_writeOffset;</span>
<a href="#l4.245"></a><span id="l4.245" class="difflineminus">-  if ((*pChar == 0x0D) &amp;&amp; (*(pChar + 1) == 0x0D))</span>
<a href="#l4.246"></a><span id="l4.246" class="difflineplus">+  // Double nsCRT::CR.</span>
<a href="#l4.247"></a><span id="l4.247" class="difflineplus">+  if ((*pChar == nsCRT::CR) &amp;&amp; (*(pChar + 1) == nsCRT::CR))</span>
<a href="#l4.248"></a><span id="l4.248">     return( 2);</span>
<a href="#l4.249"></a><span id="l4.249"> </span>
<a href="#l4.250"></a><span id="l4.250">   if (len &lt; 4)</span>
<a href="#l4.251"></a><span id="l4.251">     return( -1);</span>
<a href="#l4.252"></a><span id="l4.252" class="difflineminus">-  if ((*pChar == 0x0D) &amp;&amp; (*(pChar + 1) == 0x0A) &amp;&amp;</span>
<a href="#l4.253"></a><span id="l4.253" class="difflineminus">-    (*(pChar + 2) == 0x0D) &amp;&amp; (*(pChar + 3) == 0x0A))</span>
<a href="#l4.254"></a><span id="l4.254" class="difflineplus">+</span>
<a href="#l4.255"></a><span id="l4.255" class="difflineplus">+  // Double (nsCRT::CR + nsCRT::LF).</span>
<a href="#l4.256"></a><span id="l4.256" class="difflineplus">+  if ((*pChar == nsCRT::CR) &amp;&amp; (*(pChar + 1) == nsCRT::LF) &amp;&amp;</span>
<a href="#l4.257"></a><span id="l4.257" class="difflineplus">+      (*(pChar + 2) == nsCRT::CR) &amp;&amp; (*(pChar + 3) == nsCRT::LF))</span>
<a href="#l4.258"></a><span id="l4.258">     return( 4);</span>
<a href="#l4.259"></a><span id="l4.259"> </span>
<a href="#l4.260"></a><span id="l4.260">   return( -1);</span>
<a href="#l4.261"></a><span id="l4.261"> }</span>
<a href="#l4.262"></a><span id="l4.262"> </span>
<a href="#l4.263"></a><span id="l4.263" class="difflineminus">-</span>
<a href="#l4.264"></a><span id="l4.264" class="difflineminus">-</span>
<a href="#l4.265"></a><span id="l4.265" class="difflineminus">-</span>
<a href="#l4.266"></a><span id="l4.266"> static const char *eudoraTag[] = {</span>
<a href="#l4.267"></a><span id="l4.267">   &quot;&lt;x-html&gt;&quot;,</span>
<a href="#l4.268"></a><span id="l4.268">   &quot;&lt;/x-html&gt;&quot;,</span>
<a href="#l4.269"></a><span id="l4.269">   &quot;&lt;x-rich&gt;&quot;,</span>
<a href="#l4.270"></a><span id="l4.270">   &quot;&lt;/x-rich&gt;&quot;,</span>
<a href="#l4.271"></a><span id="l4.271">   &quot;&lt;x-flowed&gt;&quot;,</span>
<a href="#l4.272"></a><span id="l4.272">   &quot;&lt;/x-flowed&gt;&quot;</span>
<a href="#l4.273"></a><span id="l4.273"> };</span>
<a href="#l4.274"></a><span id="l4.274" class="difflineat">@@ -910,27 +901,25 @@ static PRInt32 eudoraTagLen[] = {</span>
<a href="#l4.275"></a><span id="l4.275">   9,</span>
<a href="#l4.276"></a><span id="l4.276">   8,</span>
<a href="#l4.277"></a><span id="l4.277">   9,</span>
<a href="#l4.278"></a><span id="l4.278">   10,</span>
<a href="#l4.279"></a><span id="l4.279">   11,</span>
<a href="#l4.280"></a><span id="l4.280">   0</span>
<a href="#l4.281"></a><span id="l4.281"> };</span>
<a href="#l4.282"></a><span id="l4.282"> </span>
<a href="#l4.283"></a><span id="l4.283" class="difflineminus">-</span>
<a href="#l4.284"></a><span id="l4.284"> static const char *TagContentType[] = {</span>
<a href="#l4.285"></a><span id="l4.285">   &quot;text/html&quot;,</span>
<a href="#l4.286"></a><span id="l4.286">   &quot;text/html&quot;,</span>
<a href="#l4.287"></a><span id="l4.287">   &quot;text/enriched&quot;,</span>
<a href="#l4.288"></a><span id="l4.288">   &quot;text/enriched&quot;,</span>
<a href="#l4.289"></a><span id="l4.289">   &quot;text/plain&quot;,</span>
<a href="#l4.290"></a><span id="l4.290">   &quot;text/plain&quot;,</span>
<a href="#l4.291"></a><span id="l4.291"> };</span>
<a href="#l4.292"></a><span id="l4.292"> </span>
<a href="#l4.293"></a><span id="l4.293" class="difflineminus">-</span>
<a href="#l4.294"></a><span id="l4.294">   // Determine if this line contains an eudora special tag</span>
<a href="#l4.295"></a><span id="l4.295"> bool    nsEudoraMailbox::IsEudoraTag( const char *pChar, PRInt32 maxLen, bool &amp;insideEudoraTags, nsCString &amp;bodyType, PRInt32 &amp;tagLength)</span>
<a href="#l4.296"></a><span id="l4.296"> {</span>
<a href="#l4.297"></a><span id="l4.297">   PRInt32  idx = 0;</span>
<a href="#l4.298"></a><span id="l4.298">   while ((tagLength = eudoraTagLen[idx]) != 0) {</span>
<a href="#l4.299"></a><span id="l4.299">     if (maxLen &gt;= tagLength &amp;&amp; !strncmp( eudoraTag[idx], pChar, tagLength)) {</span>
<a href="#l4.300"></a><span id="l4.300">       insideEudoraTags = (pChar[1] != '/');</span>
<a href="#l4.301"></a><span id="l4.301">       bodyType = TagContentType[idx];</span>
<a href="#l4.302"></a><span id="l4.302" class="difflineat">@@ -967,21 +956,21 @@ PRInt32  nsEudoraMailbox::IsEudoraFromSe</span>
<a href="#l4.303"></a><span id="l4.303">     len++;</span>
<a href="#l4.304"></a><span id="l4.304">   }</span>
<a href="#l4.305"></a><span id="l4.305">   if (len == maxLen)</span>
<a href="#l4.306"></a><span id="l4.306">     return( -1);</span>
<a href="#l4.307"></a><span id="l4.307"> </span>
<a href="#l4.308"></a><span id="l4.308">   // Determine the length of the line</span>
<a href="#l4.309"></a><span id="l4.309">   PRInt32      lineLen = len;</span>
<a href="#l4.310"></a><span id="l4.310">   const char *  pTok = pChar;</span>
<a href="#l4.311"></a><span id="l4.311" class="difflineminus">-  while ((lineLen &lt; maxLen) &amp;&amp; (*pTok != 0x0D) &amp;&amp; (*pTok != 0x0A)) {</span>
<a href="#l4.312"></a><span id="l4.312" class="difflineplus">+  // Skip to next end of line.</span>
<a href="#l4.313"></a><span id="l4.313" class="difflineplus">+  while ((lineLen &lt; maxLen) &amp;&amp; (*pTok != nsCRT::CR) &amp;&amp; (*pTok != nsCRT::LF)) {</span>
<a href="#l4.314"></a><span id="l4.314">     lineLen++;</span>
<a href="#l4.315"></a><span id="l4.315">     pTok++;</span>
<a href="#l4.316"></a><span id="l4.316">   }</span>
<a href="#l4.317"></a><span id="l4.317" class="difflineminus">-</span>
<a href="#l4.318"></a><span id="l4.318">   if (len &gt;= lineLen)</span>
<a href="#l4.319"></a><span id="l4.319">     return( -1);</span>
<a href="#l4.320"></a><span id="l4.320"> </span>
<a href="#l4.321"></a><span id="l4.321">   // Eudora allows the return address to be double quoted or not at all..</span>
<a href="#l4.322"></a><span id="l4.322">   // I'll allow single or double quote, but other than that, just skip</span>
<a href="#l4.323"></a><span id="l4.323">   // the return address until you hit a space char (I allow tab as well)</span>
<a href="#l4.324"></a><span id="l4.324">   char  quote = *pChar;</span>
<a href="#l4.325"></a><span id="l4.325">   if ((quote == '&quot;') || (quote == '\'')) {</span>
<a href="#l4.326"></a><span id="l4.326" class="difflineat">@@ -1126,38 +1115,41 @@ PRInt32  nsEudoraMailbox::IsEudoraFromSe</span>
<a href="#l4.327"></a><span id="l4.327">     // isn't blank!</span>
<a href="#l4.328"></a><span id="l4.328">     while (len &lt; lineLen) {</span>
<a href="#l4.329"></a><span id="l4.329">       len++;</span>
<a href="#l4.330"></a><span id="l4.330">       pChar++;</span>
<a href="#l4.331"></a><span id="l4.331">     }</span>
<a href="#l4.332"></a><span id="l4.332">     if (len == maxLen)</span>
<a href="#l4.333"></a><span id="l4.333">       return( -1);</span>
<a href="#l4.334"></a><span id="l4.334"> </span>
<a href="#l4.335"></a><span id="l4.335" class="difflineminus">-    if (*pChar == 0x0D) {</span>
<a href="#l4.336"></a><span id="l4.336" class="difflineplus">+    if (*pChar == nsCRT::CR) {</span>
<a href="#l4.337"></a><span id="l4.337">       len++;</span>
<a href="#l4.338"></a><span id="l4.338">       pChar++;</span>
<a href="#l4.339"></a><span id="l4.339" class="difflineminus">-      if (*pChar == 0x0A) {</span>
<a href="#l4.340"></a><span id="l4.340" class="difflineplus">+      if (*pChar == nsCRT::LF) {</span>
<a href="#l4.341"></a><span id="l4.341">         len++;</span>
<a href="#l4.342"></a><span id="l4.342">         pChar++;</span>
<a href="#l4.343"></a><span id="l4.343">       }</span>
<a href="#l4.344"></a><span id="l4.344">     }</span>
<a href="#l4.345"></a><span id="l4.345" class="difflineminus">-    else if (*pChar == 0x0A) {</span>
<a href="#l4.346"></a><span id="l4.346" class="difflineplus">+    else if (*pChar == nsCRT::LF) {</span>
<a href="#l4.347"></a><span id="l4.347">       len++;</span>
<a href="#l4.348"></a><span id="l4.348">       pChar++;</span>
<a href="#l4.349"></a><span id="l4.349">     }</span>
<a href="#l4.350"></a><span id="l4.350">     else</span>
<a href="#l4.351"></a><span id="l4.351">       return( -1);</span>
<a href="#l4.352"></a><span id="l4.352" class="difflineplus">+</span>
<a href="#l4.353"></a><span id="l4.353">     if (len &gt;= maxLen)</span>
<a href="#l4.354"></a><span id="l4.354">       return( -1);</span>
<a href="#l4.355"></a><span id="l4.355"> </span>
<a href="#l4.356"></a><span id="l4.356">     while (len &lt; maxLen) {</span>
<a href="#l4.357"></a><span id="l4.357" class="difflineminus">-      if ((*pChar == 0x0D) || (*pChar == 0x0A))</span>
<a href="#l4.358"></a><span id="l4.358" class="difflineplus">+      if ((*pChar == nsCRT::CR) || (*pChar == nsCRT::LF))</span>
<a href="#l4.359"></a><span id="l4.359">         return( -1);</span>
<a href="#l4.360"></a><span id="l4.360" class="difflineplus">+</span>
<a href="#l4.361"></a><span id="l4.361">       if ((*pChar != ' ') &amp;&amp; (*pChar != '\t'))</span>
<a href="#l4.362"></a><span id="l4.362">         break;</span>
<a href="#l4.363"></a><span id="l4.363" class="difflineplus">+</span>
<a href="#l4.364"></a><span id="l4.364">       pChar++;</span>
<a href="#l4.365"></a><span id="l4.365">       len++;</span>
<a href="#l4.366"></a><span id="l4.366">     }</span>
<a href="#l4.367"></a><span id="l4.367"> </span>
<a href="#l4.368"></a><span id="l4.368">     // Whew!, the next line isn't blank.</span>
<a href="#l4.369"></a><span id="l4.369">     // Generate the default date header in case the date header is missing when we</span>
<a href="#l4.370"></a><span id="l4.370">     // write out headers later. The header looks like &quot;Date: Tue, 5 Feb 2002 23:05:04&quot;</span>
<a href="#l4.371"></a><span id="l4.371">     char date_header_str[DATE_STR_LEN];</span>
<a href="#l4.372"></a><span id="l4.372" class="difflineat">@@ -1179,17 +1171,16 @@ PRInt32 nsEudoraMailbox::AsciiToLong( co</span>
<a href="#l4.373"></a><span id="l4.373">     num *= 10;</span>
<a href="#l4.374"></a><span id="l4.374">     num += (*pChar - '0');</span>
<a href="#l4.375"></a><span id="l4.375">     len--;</span>
<a href="#l4.376"></a><span id="l4.376">     pChar++;</span>
<a href="#l4.377"></a><span id="l4.377">   }</span>
<a href="#l4.378"></a><span id="l4.378">   return( num);</span>
<a href="#l4.379"></a><span id="l4.379"> }</span>
<a href="#l4.380"></a><span id="l4.380"> </span>
<a href="#l4.381"></a><span id="l4.381" class="difflineminus">-</span>
<a href="#l4.382"></a><span id="l4.382"> int nsEudoraMailbox::IsWeekDayStr( const char *pStr)</span>
<a href="#l4.383"></a><span id="l4.383"> {</span>
<a href="#l4.384"></a><span id="l4.384">   for (int i = 0; i &lt; 7; i++) {</span>
<a href="#l4.385"></a><span id="l4.385">     if (!PL_strncasecmp( pStr, eudoraWeekDays[i], 3))</span>
<a href="#l4.386"></a><span id="l4.386">       return( i + 1);</span>
<a href="#l4.387"></a><span id="l4.387">   }</span>
<a href="#l4.388"></a><span id="l4.388">   return( 0);</span>
<a href="#l4.389"></a><span id="l4.389"> }</span>
<a href="#l4.390"></a><span id="l4.390" class="difflineat">@@ -1276,17 +1267,19 @@ nsresult nsEudoraMailbox::ExamineAttachm</span>
<a href="#l4.391"></a><span id="l4.391">           while ((*pData != quote) &amp;&amp; (cnt &lt; len)) {</span>
<a href="#l4.392"></a><span id="l4.392">             cnt++;</span>
<a href="#l4.393"></a><span id="l4.393">             pData++;</span>
<a href="#l4.394"></a><span id="l4.394">             nameLen++;</span>
<a href="#l4.395"></a><span id="l4.395">           }</span>
<a href="#l4.396"></a><span id="l4.396">         }</span>
<a href="#l4.397"></a><span id="l4.397">         else {</span>
<a href="#l4.398"></a><span id="l4.398">           pStart = pData;</span>
<a href="#l4.399"></a><span id="l4.399" class="difflineminus">-          while ((*pData != 0x0D) &amp;&amp; (*pData != 0x0A) &amp;&amp; (cnt &lt; len)) {</span>
<a href="#l4.400"></a><span id="l4.400" class="difflineplus">+          // Skip to next end of line.</span>
<a href="#l4.401"></a><span id="l4.401" class="difflineplus">+          while ((cnt &lt; len) &amp;&amp;</span>
<a href="#l4.402"></a><span id="l4.402" class="difflineplus">+                 (*pData != nsCRT::CR) &amp;&amp; (*pData != nsCRT::LF)) {</span>
<a href="#l4.403"></a><span id="l4.403">             pData++;</span>
<a href="#l4.404"></a><span id="l4.404">             cnt++;</span>
<a href="#l4.405"></a><span id="l4.405">             nameLen++;</span>
<a href="#l4.406"></a><span id="l4.406">           }</span>
<a href="#l4.407"></a><span id="l4.407">         }</span>
<a href="#l4.408"></a><span id="l4.408">         nsCString  fileName;</span>
<a href="#l4.409"></a><span id="l4.409">         fileName.Append( pStart, nameLen);</span>
<a href="#l4.410"></a><span id="l4.410">         fileName.Trim( kWhitespace);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/import/eudora/src/nsEudoraWin32.cpp</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/import/eudora/src/nsEudoraWin32.cpp</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -398,27 +398,30 @@ nsresult nsEudoraWin32::ScanDescmap( nsI</span>
<a href="#l5.4"></a><span id="l5.4">     type.Truncate();</span>
<a href="#l5.5"></a><span id="l5.5">     if (fieldLen)</span>
<a href="#l5.6"></a><span id="l5.6">       type.Append( pStart, fieldLen);</span>
<a href="#l5.7"></a><span id="l5.7">     type.Trim( kWhitespace);</span>
<a href="#l5.8"></a><span id="l5.8">     pos++;</span>
<a href="#l5.9"></a><span id="l5.9">     pData++;</span>
<a href="#l5.10"></a><span id="l5.10">     pStart = pData;</span>
<a href="#l5.11"></a><span id="l5.11">     fieldLen = 0;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-    while ((pos &lt; len) &amp;&amp; (*pData != 0x0D) &amp;&amp; (*pData != 0x0A) &amp;&amp; (*pData != ','))</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+    // Skip to next end of line, or ',' separator.</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+    while ((pos &lt; len) &amp;&amp;</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+           (*pData != nsCRT::CR) &amp;&amp; (*pData != nsCRT::LF) &amp;&amp; (*pData != ','))</span>
<a href="#l5.16"></a><span id="l5.16">     {</span>
<a href="#l5.17"></a><span id="l5.17">       pos++;</span>
<a href="#l5.18"></a><span id="l5.18">       pData++;</span>
<a href="#l5.19"></a><span id="l5.19">       fieldLen++;</span>
<a href="#l5.20"></a><span id="l5.20">     }</span>
<a href="#l5.21"></a><span id="l5.21">     flag.Truncate();</span>
<a href="#l5.22"></a><span id="l5.22">     if (fieldLen)</span>
<a href="#l5.23"></a><span id="l5.23">       flag.Append( pStart, fieldLen);</span>
<a href="#l5.24"></a><span id="l5.24">     flag.Trim( kWhitespace);</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineminus">-    while ((pos &lt; len) &amp;&amp; ((*pData == 0x0D) || (*pData == 0x0A)))</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineplus">+    // Skip over end of line(s).</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineplus">+    while ((pos &lt; len) &amp;&amp; ((*pData == nsCRT::CR) || (*pData == nsCRT::LF)))</span>
<a href="#l5.28"></a><span id="l5.28">     {</span>
<a href="#l5.29"></a><span id="l5.29">       pos++;</span>
<a href="#l5.30"></a><span id="l5.30">       pData++;</span>
<a href="#l5.31"></a><span id="l5.31">     }</span>
<a href="#l5.32"></a><span id="l5.32"> </span>
<a href="#l5.33"></a><span id="l5.33">     IMPORT_LOG2( &quot;name: %s, fName: %s\n&quot;, name.get(), fName.get());</span>
<a href="#l5.34"></a><span id="l5.34"> </span>
<a href="#l5.35"></a><span id="l5.35">     if (!fName.IsEmpty() &amp;&amp; !name.IsEmpty() &amp;&amp; (type.Length() == 1))</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineat">@@ -1276,62 +1279,79 @@ void nsEudoraWin32::GetMimeTypeFromExten</span>
<a href="#l5.37"></a><span id="l5.37">       pChar++;</span>
<a href="#l5.38"></a><span id="l5.38">     pStart = pChar;</span>
<a href="#l5.39"></a><span id="l5.39">     len = 0;</span>
<a href="#l5.40"></a><span id="l5.40">     while (*pChar &amp;&amp; (*pChar != ','))</span>
<a href="#l5.41"></a><span id="l5.41">     {</span>
<a href="#l5.42"></a><span id="l5.42">       pChar++;</span>
<a href="#l5.43"></a><span id="l5.43">       len++;</span>
<a href="#l5.44"></a><span id="l5.44">     }</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineminus">-    if (!*pChar) return;</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineplus">+    if (!*pChar)</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineplus">+      return;</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineplus">+</span>
<a href="#l5.49"></a><span id="l5.49">     tStr.Truncate();</span>
<a href="#l5.50"></a><span id="l5.50">     tStr.Append( pStart, len);</span>
<a href="#l5.51"></a><span id="l5.51">     tStr.Trim( kWhitespace);</span>
<a href="#l5.52"></a><span id="l5.52">     if (!PL_strcasecmp( tStr.get(), pExt))</span>
<a href="#l5.53"></a><span id="l5.53">     {</span>
<a href="#l5.54"></a><span id="l5.54">       // skip the mac creator and type</span>
<a href="#l5.55"></a><span id="l5.55">       pChar++;</span>
<a href="#l5.56"></a><span id="l5.56">       while (*pChar &amp;&amp; (*pChar != ','))</span>
<a href="#l5.57"></a><span id="l5.57">         pChar++;</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineminus">-      if (!*pChar) return;</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineplus">+      if (!*pChar)</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineplus">+        return;</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineplus">+</span>
<a href="#l5.62"></a><span id="l5.62">       pChar++;</span>
<a href="#l5.63"></a><span id="l5.63">       while (*pChar &amp;&amp; (*pChar != ','))</span>
<a href="#l5.64"></a><span id="l5.64">         pChar++;</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineminus">-      if (!*pChar) return;</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineplus">+      if (!*pChar)</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineplus">+        return;</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineplus">+</span>
<a href="#l5.69"></a><span id="l5.69">       pChar++;</span>
<a href="#l5.70"></a><span id="l5.70">       // Get the first mime type</span>
<a href="#l5.71"></a><span id="l5.71">       len = 0;</span>
<a href="#l5.72"></a><span id="l5.72">       pStart = pChar;</span>
<a href="#l5.73"></a><span id="l5.73">       while (*pChar &amp;&amp; (*pChar != ','))</span>
<a href="#l5.74"></a><span id="l5.74">       {</span>
<a href="#l5.75"></a><span id="l5.75">         pChar++;</span>
<a href="#l5.76"></a><span id="l5.76">         len++;</span>
<a href="#l5.77"></a><span id="l5.77">       }</span>
<a href="#l5.78"></a><span id="l5.78" class="difflineminus">-      if (!*pChar) return;</span>
<a href="#l5.79"></a><span id="l5.79" class="difflineplus">+      if (!*pChar)</span>
<a href="#l5.80"></a><span id="l5.80" class="difflineplus">+        return;</span>
<a href="#l5.81"></a><span id="l5.81" class="difflineplus">+</span>
<a href="#l5.82"></a><span id="l5.82">       pChar++;</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineminus">-      if (!len) continue;</span>
<a href="#l5.84"></a><span id="l5.84" class="difflineplus">+      if (!len)</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineplus">+        continue;</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineplus">+</span>
<a href="#l5.87"></a><span id="l5.87">       tStr.Truncate();</span>
<a href="#l5.88"></a><span id="l5.88">       tStr.Append( pStart, len);</span>
<a href="#l5.89"></a><span id="l5.89">       tStr.Trim( kWhitespace);</span>
<a href="#l5.90"></a><span id="l5.90" class="difflineminus">-      if (tStr.IsEmpty()) continue;</span>
<a href="#l5.91"></a><span id="l5.91" class="difflineplus">+      if (tStr.IsEmpty())</span>
<a href="#l5.92"></a><span id="l5.92" class="difflineplus">+        continue;</span>
<a href="#l5.93"></a><span id="l5.93" class="difflineplus">+</span>
<a href="#l5.94"></a><span id="l5.94">       mimeType.Truncate();</span>
<a href="#l5.95"></a><span id="l5.95">       mimeType.Append( tStr.get());</span>
<a href="#l5.96"></a><span id="l5.96">       mimeType.Append( &quot;/&quot;);</span>
<a href="#l5.97"></a><span id="l5.97">       pStart = pChar;</span>
<a href="#l5.98"></a><span id="l5.98">       len = 0;</span>
<a href="#l5.99"></a><span id="l5.99" class="difflineminus">-      while (*pChar &amp;&amp; (*pChar != 0x0D) &amp;&amp; (*pChar != 0x0A))</span>
<a href="#l5.100"></a><span id="l5.100" class="difflineplus">+      // Skip to next end of line.</span>
<a href="#l5.101"></a><span id="l5.101" class="difflineplus">+      while (*pChar &amp;&amp; (*pChar != nsCRT::CR) &amp;&amp; (*pChar != nsCRT::LF))</span>
<a href="#l5.102"></a><span id="l5.102">       {</span>
<a href="#l5.103"></a><span id="l5.103">         pChar++;</span>
<a href="#l5.104"></a><span id="l5.104">         len++;</span>
<a href="#l5.105"></a><span id="l5.105">       }</span>
<a href="#l5.106"></a><span id="l5.106" class="difflineminus">-      if (!len) continue;</span>
<a href="#l5.107"></a><span id="l5.107" class="difflineplus">+      if (!len)</span>
<a href="#l5.108"></a><span id="l5.108" class="difflineplus">+        continue;</span>
<a href="#l5.109"></a><span id="l5.109" class="difflineplus">+</span>
<a href="#l5.110"></a><span id="l5.110">       tStr.Truncate();</span>
<a href="#l5.111"></a><span id="l5.111">       tStr.Append( pStart, len);</span>
<a href="#l5.112"></a><span id="l5.112">       tStr.Trim( kWhitespace);</span>
<a href="#l5.113"></a><span id="l5.113" class="difflineminus">-      if (tStr.IsEmpty()) continue;</span>
<a href="#l5.114"></a><span id="l5.114" class="difflineplus">+      if (tStr.IsEmpty())</span>
<a href="#l5.115"></a><span id="l5.115" class="difflineplus">+        continue;</span>
<a href="#l5.116"></a><span id="l5.116" class="difflineplus">+</span>
<a href="#l5.117"></a><span id="l5.117">       mimeType.Append( tStr.get());</span>
<a href="#l5.118"></a><span id="l5.118"> </span>
<a href="#l5.119"></a><span id="l5.119">       IMPORT_LOG1( &quot;Found Mime Type: %s\n&quot;, mimeType.get());</span>
<a href="#l5.120"></a><span id="l5.120"> </span>
<a href="#l5.121"></a><span id="l5.121">       return;</span>
<a href="#l5.122"></a><span id="l5.122">     }</span>
<a href="#l5.123"></a><span id="l5.123">   }</span>
<a href="#l5.124"></a><span id="l5.124"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/import/oexpress/nsOEMailbox.cpp</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/import/oexpress/nsOEMailbox.cpp</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -390,17 +390,17 @@ bool CMbxScanner::CopyMbxFileBytes(PRUin</span>
<a href="#l6.4"></a><span id="l6.4"> </span>
<a href="#l6.5"></a><span id="l6.5">     inIdx = 0;</span>
<a href="#l6.6"></a><span id="l6.6">     // Handle the beginning line, don't duplicate an existing From separator</span>
<a href="#l6.7"></a><span id="l6.7">     if (first) {</span>
<a href="#l6.8"></a><span id="l6.8">       // check the first buffer to see if it already starts with a From line</span>
<a href="#l6.9"></a><span id="l6.9">       // If it does, throw it away and use our own</span>
<a href="#l6.10"></a><span id="l6.10">       if (IsFromLineKey( m_pInBuffer, cnt)) {</span>
<a href="#l6.11"></a><span id="l6.11">         // skip past the first line</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-        while ((inIdx &lt; cnt) &amp;&amp; (m_pInBuffer[inIdx] != 0x0D))</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+        while ((inIdx &lt; cnt) &amp;&amp; (m_pInBuffer[inIdx] != nsCRT::CR))</span>
<a href="#l6.14"></a><span id="l6.14">           inIdx++;</span>
<a href="#l6.15"></a><span id="l6.15">         while ((inIdx &lt; cnt) &amp;&amp; (IS_ANY_SPACE( m_pInBuffer[inIdx])))</span>
<a href="#l6.16"></a><span id="l6.16">           inIdx++;</span>
<a href="#l6.17"></a><span id="l6.17">         if (inIdx &gt;= cnt) {</span>
<a href="#l6.18"></a><span id="l6.18">           // This should not occurr - it means the message starts</span>
<a href="#l6.19"></a><span id="l6.19">           // with a From separator line that is longer than our</span>
<a href="#l6.20"></a><span id="l6.20">           // file buffer!  In this bizarre case, just skip this message</span>
<a href="#l6.21"></a><span id="l6.21">           // since it is probably bogus anyway.</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineat">@@ -433,68 +433,71 @@ bool CMbxScanner::CopyMbxFileBytes(PRUin</span>
<a href="#l6.23"></a><span id="l6.23">     // Handle generic data, escape any lines that begin with &quot;From &quot;</span>
<a href="#l6.24"></a><span id="l6.24">     pIn = m_pInBuffer + inIdx;</span>
<a href="#l6.25"></a><span id="l6.25">     numBytes -= cnt;</span>
<a href="#l6.26"></a><span id="l6.26">     m_didBytes += cnt;</span>
<a href="#l6.27"></a><span id="l6.27">     pStart = pIn;</span>
<a href="#l6.28"></a><span id="l6.28">     cnt -= inIdx;</span>
<a href="#l6.29"></a><span id="l6.29">     inIdx = 0;</span>
<a href="#l6.30"></a><span id="l6.30">     while (cnt) {</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-      if (*pIn == 0x0D) {</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+      if (*pIn == nsCRT::CR) {</span>
<a href="#l6.33"></a><span id="l6.33">         // need more in buffer?</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineminus">-        if ((cnt &lt; 7) &amp;&amp; numBytes) {</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+        if ((cnt &lt; 7) &amp;&amp; numBytes)</span>
<a href="#l6.36"></a><span id="l6.36">           break;</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineminus">-        }</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineminus">-        else if (cnt &gt; 6) {</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineminus">-          if ((pIn[1] == 0x0A) &amp;&amp; (IsFromLineKey( pIn + 2, cnt))) {</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineplus">+</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineplus">+        if (cnt &gt; 6) {</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineplus">+          if ((pIn[1] == nsCRT::LF) &amp;&amp; IsFromLineKey(pIn + 2, cnt)) {</span>
<a href="#l6.43"></a><span id="l6.43">             inIdx += 2;</span>
<a href="#l6.44"></a><span id="l6.44">             // Match, escape it</span>
<a href="#l6.45"></a><span id="l6.45">             rv = m_dstFileOutputStream-&gt;Write( (const char *)pStart, (PRInt32)inIdx, &amp;cntRead);</span>
<a href="#l6.46"></a><span id="l6.46">             if (NS_SUCCEEDED( rv) &amp;&amp; (cntRead == (PRInt32)inIdx))</span>
<a href="#l6.47"></a><span id="l6.47">               rv = m_dstFileOutputStream-&gt;Write( &quot;&gt;&quot;, 1, &amp;cntRead);</span>
<a href="#l6.48"></a><span id="l6.48">             if (NS_FAILED( rv) || (cntRead != 1)) {</span>
<a href="#l6.49"></a><span id="l6.49">               ReportWriteError( m_dstFile);</span>
<a href="#l6.50"></a><span id="l6.50">               return( false);</span>
<a href="#l6.51"></a><span id="l6.51">             }</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineplus">+</span>
<a href="#l6.53"></a><span id="l6.53">             cnt -= 2;</span>
<a href="#l6.54"></a><span id="l6.54">             pIn += 2;</span>
<a href="#l6.55"></a><span id="l6.55">             inIdx = 0;</span>
<a href="#l6.56"></a><span id="l6.56">             pStart = pIn;</span>
<a href="#l6.57"></a><span id="l6.57">             continue;</span>
<a href="#l6.58"></a><span id="l6.58">           }</span>
<a href="#l6.59"></a><span id="l6.59">         }</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineminus">-      } // == 0x0D</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineplus">+      } // == nsCRT::CR</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineplus">+</span>
<a href="#l6.63"></a><span id="l6.63">       cnt--;</span>
<a href="#l6.64"></a><span id="l6.64">       inIdx++;</span>
<a href="#l6.65"></a><span id="l6.65">       pIn++;</span>
<a href="#l6.66"></a><span id="l6.66">     }</span>
<a href="#l6.67"></a><span id="l6.67">     rv = m_dstFileOutputStream-&gt;Write( (const char *)pStart, (PRInt32)inIdx, &amp;cntRead);</span>
<a href="#l6.68"></a><span id="l6.68">     if (NS_FAILED( rv) || (cntRead != (PRInt32)inIdx)) {</span>
<a href="#l6.69"></a><span id="l6.69">       ReportWriteError( m_dstFile);</span>
<a href="#l6.70"></a><span id="l6.70">       return( false);</span>
<a href="#l6.71"></a><span id="l6.71">     }</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineplus">+</span>
<a href="#l6.73"></a><span id="l6.73">     if (cnt) {</span>
<a href="#l6.74"></a><span id="l6.74">       inIdx = cnt;</span>
<a href="#l6.75"></a><span id="l6.75">       memcpy( m_pInBuffer, pIn, cnt);</span>
<a href="#l6.76"></a><span id="l6.76">     }</span>
<a href="#l6.77"></a><span id="l6.77">     else</span>
<a href="#l6.78"></a><span id="l6.78">       inIdx = 0;</span>
<a href="#l6.79"></a><span id="l6.79">   }</span>
<a href="#l6.80"></a><span id="l6.80"> </span>
<a href="#l6.81"></a><span id="l6.81">   // I used to check for an eol before writing one but</span>
<a href="#l6.82"></a><span id="l6.82">   // it turns out that adding a proper EOL before the next</span>
<a href="#l6.83"></a><span id="l6.83">   // separator never really hurts so better to be safe</span>
<a href="#l6.84"></a><span id="l6.84">   // and always do it.</span>
<a href="#l6.85"></a><span id="l6.85" class="difflineminus">-  //  if ((last[0] != 0x0D) || (last[1] != 0x0A)) {</span>
<a href="#l6.86"></a><span id="l6.86" class="difflineplus">+  //  if ((last[0] != nsCRT::CR) || (last[1] != nsCRT::LF)) {</span>
<a href="#l6.87"></a><span id="l6.87">   rv = m_dstFileOutputStream-&gt;Write( &quot;\x0D\x0A&quot;, 2, &amp;cntRead);</span>
<a href="#l6.88"></a><span id="l6.88">   if (NS_FAILED( rv) || (cntRead != 2)) {</span>
<a href="#l6.89"></a><span id="l6.89">     ReportWriteError( m_dstFile);</span>
<a href="#l6.90"></a><span id="l6.90">     return( false);</span>
<a href="#l6.91"></a><span id="l6.91">   }</span>
<a href="#l6.92"></a><span id="l6.92" class="difflineminus">-  //  }</span>
<a href="#l6.93"></a><span id="l6.93" class="difflineplus">+  //  } // != nsCRT::CR || != nsCRT::LF</span>
<a href="#l6.94"></a><span id="l6.94"> </span>
<a href="#l6.95"></a><span id="l6.95">   return( true);</span>
<a href="#l6.96"></a><span id="l6.96"> }</span>
<a href="#l6.97"></a><span id="l6.97"> </span>
<a href="#l6.98"></a><span id="l6.98"> </span>
<a href="#l6.99"></a><span id="l6.99"> CIndexScanner::CIndexScanner( nsString&amp; name, nsIFile * idxFile, nsIFile * mbxFile, nsIFile * dstFile)</span>
<a href="#l6.100"></a><span id="l6.100"> : CMbxScanner( name, mbxFile, dstFile)</span>
<a href="#l6.101"></a><span id="l6.101"> {</span>
<a href="#l6.102"></a><span id="l6.102" class="difflineat">@@ -662,9 +665,8 @@ bool CIndexScanner::DoWork( bool *pAbort</span>
<a href="#l6.103"></a><span id="l6.103"> }</span>
<a href="#l6.104"></a><span id="l6.104"> </span>
<a href="#l6.105"></a><span id="l6.105"> </span>
<a href="#l6.106"></a><span id="l6.106"> void CIndexScanner::CleanUp( void)</span>
<a href="#l6.107"></a><span id="l6.107"> {</span>
<a href="#l6.108"></a><span id="l6.108">   CMbxScanner::CleanUp();</span>
<a href="#l6.109"></a><span id="l6.109">   m_idxFileInputStream-&gt;Close();</span>
<a href="#l6.110"></a><span id="l6.110"> }</span>
<a href="#l6.111"></a><span id="l6.111" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/import/outlook/src/MapiMessage.cpp</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/import/outlook/src/MapiMessage.cpp</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -482,17 +482,17 @@ const char* CpToCharset(unsigned int cp)</span>
<a href="#l7.4"></a><span id="l7.4">       {10008, &quot;x-mac-chinesesimp&quot;}, // MAC Simplified Chinese (GB 2312); Chinese Simplified (Mac)</span>
<a href="#l7.5"></a><span id="l7.5">       {10010, &quot;x-mac-romanian&quot;}, // Romanian (Mac)</span>
<a href="#l7.6"></a><span id="l7.6">       {10017, &quot;x-mac-ukrainian&quot;}, // Ukrainian (Mac)</span>
<a href="#l7.7"></a><span id="l7.7">       {10021, &quot;x-mac-thai&quot;}, // Thai (Mac)</span>
<a href="#l7.8"></a><span id="l7.8">       {10029, &quot;x-mac-ce&quot;}, // MAC Latin 2; Central European (Mac)</span>
<a href="#l7.9"></a><span id="l7.9">       {10079, &quot;x-mac-icelandic&quot;}, // Icelandic (Mac)</span>
<a href="#l7.10"></a><span id="l7.10">       {10081, &quot;x-mac-turkish&quot;}, // Turkish (Mac)</span>
<a href="#l7.11"></a><span id="l7.11">       {10082, &quot;x-mac-croatian&quot;}, // Croatian (Mac)</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-      // Unicode UTF-32, little endian byte order; available only to managed applications </span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+      // Unicode UTF-32, little endian byte order; available only to managed applications</span>
<a href="#l7.14"></a><span id="l7.14">       // impossible in 8-bit mail</span>
<a href="#l7.15"></a><span id="l7.15">       {12000, &quot;utf-32&quot;},</span>
<a href="#l7.16"></a><span id="l7.16">        // Unicode UTF-32, big endian byte order; available only to managed applications</span>
<a href="#l7.17"></a><span id="l7.17">        // impossible in 8-bit mail</span>
<a href="#l7.18"></a><span id="l7.18">       {12001, &quot;utf-32BE&quot;},</span>
<a href="#l7.19"></a><span id="l7.19">       {20000, &quot;x-Chinese_CNS&quot;}, // CNS Taiwan; Chinese Traditional (CNS)</span>
<a href="#l7.20"></a><span id="l7.20">       {20001, &quot;x-cp20001&quot;}, // TCA Taiwan</span>
<a href="#l7.21"></a><span id="l7.21">       {20002, &quot;x_Chinese-Eten&quot;}, // Eten Taiwan; Chinese Traditional (Eten)</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineat">@@ -624,17 +624,17 @@ bool CMapiMessage::CheckBodyInCharsetRan</span>
<a href="#l7.23"></a><span id="l7.23">   const wchar_t *currentSrcPtr = txt;</span>
<a href="#l7.24"></a><span id="l7.24">   int srcLength;</span>
<a href="#l7.25"></a><span id="l7.25">   int dstLength;</span>
<a href="#l7.26"></a><span id="l7.26">   char localbuf[512];</span>
<a href="#l7.27"></a><span id="l7.27">   int consumedLen = 0;</span>
<a href="#l7.28"></a><span id="l7.28"> </span>
<a href="#l7.29"></a><span id="l7.29">   // convert</span>
<a href="#l7.30"></a><span id="l7.30">   while (consumedLen &lt; txtLen) {</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">-    srcLength = txtLen - consumedLen;  </span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+    srcLength = txtLen - consumedLen;</span>
<a href="#l7.33"></a><span id="l7.33">     dstLength = sizeof(localbuf)/sizeof(localbuf[0]);</span>
<a href="#l7.34"></a><span id="l7.34">     rv = encoder-&gt;Convert(currentSrcPtr, &amp;srcLength, localbuf, &amp;dstLength);</span>
<a href="#l7.35"></a><span id="l7.35">     if (rv == NS_ERROR_UENC_NOMAPPING)</span>
<a href="#l7.36"></a><span id="l7.36">       return false;</span>
<a href="#l7.37"></a><span id="l7.37">     if (NS_FAILED(rv) || dstLength == 0)</span>
<a href="#l7.38"></a><span id="l7.38">       break;</span>
<a href="#l7.39"></a><span id="l7.39"> </span>
<a href="#l7.40"></a><span id="l7.40">     currentSrcPtr += srcLength;</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineat">@@ -1251,18 +1251,19 @@ char* dup(const char* begin, const char*</span>
<a href="#l7.42"></a><span id="l7.42">     return 0;</span>
<a href="#l7.43"></a><span id="l7.43">   char* str = new char[end-begin+1];</span>
<a href="#l7.44"></a><span id="l7.44">   memcpy(str, begin, (end-begin)*sizeof(begin[0]));</span>
<a href="#l7.45"></a><span id="l7.45">   str[end - begin] = 0;</span>
<a href="#l7.46"></a><span id="l7.46">   return str;</span>
<a href="#l7.47"></a><span id="l7.47"> }</span>
<a href="#l7.48"></a><span id="l7.48"> </span>
<a href="#l7.49"></a><span id="l7.49"> // See RFC822</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineminus">-inline bool IsPrintableASCII(char c) { return (c &gt; 32) &amp;&amp; (c &lt; 127); }</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineminus">-inline bool IsWSP(char c) { return (c == 32) || (c == 9); }</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineplus">+// 9 = '\t', 32 = ' '.</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineplus">+inline bool IsPrintableASCII(char c) { return (c &gt; ' ') &amp;&amp; (c &lt; 127); }</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineplus">+inline bool IsWSP(char c) { return (c == ' ') || (c == '\t'); }</span>
<a href="#l7.55"></a><span id="l7.55"> </span>
<a href="#l7.56"></a><span id="l7.56"> CMapiMessageHeaders::CHeaderField::CHeaderField(const char* begin, int len)</span>
<a href="#l7.57"></a><span id="l7.57">   : m_fname(0), m_fbody(0), m_fbody_utf8(false)</span>
<a href="#l7.58"></a><span id="l7.58"> {</span>
<a href="#l7.59"></a><span id="l7.59">   const char *end = begin+len, *fname_end = begin;</span>
<a href="#l7.60"></a><span id="l7.60">   while ((fname_end &lt; end) &amp;&amp; IsPrintableASCII(*fname_end) &amp;&amp; (*fname_end != ':'))</span>
<a href="#l7.61"></a><span id="l7.61">     ++fname_end;</span>
<a href="#l7.62"></a><span id="l7.62">   if ((fname_end == end) || (*fname_end != ':'))</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineat">@@ -1293,20 +1294,21 @@ void CMapiMessageHeaders::CHeaderField::</span>
<a href="#l7.64"></a><span id="l7.64"> }</span>
<a href="#l7.65"></a><span id="l7.65"> </span>
<a href="#l7.66"></a><span id="l7.66"> void CMapiMessageHeaders::CHeaderField::GetUnfoldedString(nsString&amp; dest,</span>
<a href="#l7.67"></a><span id="l7.67">                                           const char* fallbackCharset) const</span>
<a href="#l7.68"></a><span id="l7.68"> {</span>
<a href="#l7.69"></a><span id="l7.69">   dest.Truncate();</span>
<a href="#l7.70"></a><span id="l7.70">   if (!m_fbody)</span>
<a href="#l7.71"></a><span id="l7.71">     return;</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineplus">+</span>
<a href="#l7.73"></a><span id="l7.73">   nsCString unfolded;</span>
<a href="#l7.74"></a><span id="l7.74">   const char* pos = m_fbody;</span>
<a href="#l7.75"></a><span id="l7.75">   while (*pos) {</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineminus">-    if ((*pos == '\x0D') &amp;&amp; (*(pos+1) == '\x0A') &amp;&amp; IsWSP(*(pos+2)))</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineplus">+    if ((*pos == nsCRT::CR) &amp;&amp; (*(pos+1) == nsCRT::LF) &amp;&amp; IsWSP(*(pos+2)))</span>
<a href="#l7.78"></a><span id="l7.78">       pos += 2; // Skip CRLF if it is followed by SPACE or TAB</span>
<a href="#l7.79"></a><span id="l7.79">     else</span>
<a href="#l7.80"></a><span id="l7.80">       unfolded.Append(*(pos++));</span>
<a href="#l7.81"></a><span id="l7.81">   }</span>
<a href="#l7.82"></a><span id="l7.82">   if (m_fbody_utf8)</span>
<a href="#l7.83"></a><span id="l7.83">     CopyUTF8toUTF16(unfolded, dest);</span>
<a href="#l7.84"></a><span id="l7.84">   else</span>
<a href="#l7.85"></a><span id="l7.85">     nsMsgI18NConvertToUnicode(fallbackCharset, unfolded, dest);</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineat">@@ -1344,19 +1346,20 @@ void CMapiMessageHeaders::ClearHeaderFie</span>
<a href="#l7.87"></a><span id="l7.87"> </span>
<a href="#l7.88"></a><span id="l7.88"> void CMapiMessageHeaders::Assign(const char* headers)</span>
<a href="#l7.89"></a><span id="l7.89"> {</span>
<a href="#l7.90"></a><span id="l7.90">   for (int i=0; i&lt;hdrMax; i++)</span>
<a href="#l7.91"></a><span id="l7.91">     m_SpecialHeaders[i] = 0;</span>
<a href="#l7.92"></a><span id="l7.92">   ClearHeaderFields();</span>
<a href="#l7.93"></a><span id="l7.93">   if (!headers)</span>
<a href="#l7.94"></a><span id="l7.94">     return;</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineplus">+</span>
<a href="#l7.96"></a><span id="l7.96">   const char *start=headers, *end=headers;</span>
<a href="#l7.97"></a><span id="l7.97">   while (*end) {</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineminus">-    if ((*end == '\x0D') &amp;&amp; (*(end+1) == '\x0A')) { // CRLF</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineplus">+    if ((*end == nsCRT::CR) &amp;&amp; (*(end+1) == nsCRT::LF)) {</span>
<a href="#l7.100"></a><span id="l7.100">       if (!IsWSP(*(end+2))) { // Not SPACE nor TAB (avoid FSP) -&gt; next header or EOF</span>
<a href="#l7.101"></a><span id="l7.101">         Add(new CHeaderField(start, end-start));</span>
<a href="#l7.102"></a><span id="l7.102">         start = ++end + 1;</span>
<a href="#l7.103"></a><span id="l7.103">       }</span>
<a href="#l7.104"></a><span id="l7.104">     }</span>
<a href="#l7.105"></a><span id="l7.105">     ++end;</span>
<a href="#l7.106"></a><span id="l7.106">   }</span>
<a href="#l7.107"></a><span id="l7.107"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/import/outlook/src/nsOutlookCompose.cpp</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/import/outlook/src/nsOutlookCompose.cpp</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -474,17 +474,17 @@ nsresult nsOutlookCompose::CopyComposedM</span>
<a href="#l8.4"></a><span id="l8.4">   // Here I revert the changes that were made when the multipart/related message</span>
<a href="#l8.5"></a><span id="l8.5">   // was composed in nsMsgSend::ProcessMultipartRelated() - the Content-Ids of</span>
<a href="#l8.6"></a><span id="l8.6">   // attachments were replaced with new ones.</span>
<a href="#l8.7"></a><span id="l8.7">   nsCString line;</span>
<a href="#l8.8"></a><span id="l8.8">   while (NS_SUCCEEDED(f.ToString(line, MSG_LINEBREAK))) {</span>
<a href="#l8.9"></a><span id="l8.9">     EscapeFromSpaceLine(pDst, const_cast&lt;char*&gt;(line.get()), line.get()+line.Length());</span>
<a href="#l8.10"></a><span id="l8.10">   }</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-  if (f.LastChar() != 0x0A) {</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+  if (f.LastChar() != nsCRT::LF) {</span>
<a href="#l8.14"></a><span id="l8.14">     rv = pDst-&gt;Write( MSG_LINEBREAK, 2, &amp;written);</span>
<a href="#l8.15"></a><span id="l8.15">     if (written != 2)</span>
<a href="#l8.16"></a><span id="l8.16">       rv = NS_ERROR_FAILURE;</span>
<a href="#l8.17"></a><span id="l8.17">   }</span>
<a href="#l8.18"></a><span id="l8.18"> </span>
<a href="#l8.19"></a><span id="l8.19">   return rv;</span>
<a href="#l8.20"></a><span id="l8.20"> }</span>
<a href="#l8.21"></a><span id="l8.21"> </span>
<a href="#l8.22"></a><span id="l8.22" class="difflineat">@@ -712,31 +712,29 @@ nsresult CCompositionFile::EnsureHasData</span>
<a href="#l8.23"></a><span id="l8.23">     return( NS_ERROR_FAILURE);</span>
<a href="#l8.24"></a><span id="l8.24">   m_fifoBufferWrittenPos = m_fifoBuffer+bytesRead;</span>
<a href="#l8.25"></a><span id="l8.25">   m_fifoBufferReadPos = m_fifoBuffer;</span>
<a href="#l8.26"></a><span id="l8.26">   m_fileReadPos += bytesRead;</span>
<a href="#l8.27"></a><span id="l8.27"> </span>
<a href="#l8.28"></a><span id="l8.28">   return NS_OK;</span>
<a href="#l8.29"></a><span id="l8.29"> }</span>
<a href="#l8.30"></a><span id="l8.30"> </span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-const char CR = '\x0D', LF = '\x0A';</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineminus">-</span>
<a href="#l8.33"></a><span id="l8.33"> class CTermGuard {</span>
<a href="#l8.34"></a><span id="l8.34"> public:</span>
<a href="#l8.35"></a><span id="l8.35">   CTermGuard(const char* term, int termSize)</span>
<a href="#l8.36"></a><span id="l8.36">     : m_term(term),</span>
<a href="#l8.37"></a><span id="l8.37">     m_termSize(term ? ((termSize!=-1) ? termSize : strlen(term)) : 0),</span>
<a href="#l8.38"></a><span id="l8.38">     m_matchPos(0)</span>
<a href="#l8.39"></a><span id="l8.39">   {}</span>
<a href="#l8.40"></a><span id="l8.40"> </span>
<a href="#l8.41"></a><span id="l8.41">    // if the guard triggered</span>
<a href="#l8.42"></a><span id="l8.42">   inline bool IsTriggered() const {</span>
<a href="#l8.43"></a><span id="l8.43">     return m_termSize &amp;&amp; (m_matchPos == m_termSize); }</span>
<a href="#l8.44"></a><span id="l8.44">   // indicates if the guard has something to check</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineminus">-  inline bool IsChecking() const { return m_termSize; } </span>
<a href="#l8.46"></a><span id="l8.46" class="difflineplus">+  inline bool IsChecking() const { return m_termSize; }</span>
<a href="#l8.47"></a><span id="l8.47"> </span>
<a href="#l8.48"></a><span id="l8.48">   bool Check(char c) // returns true only if the whole sequence passed</span>
<a href="#l8.49"></a><span id="l8.49">   {</span>
<a href="#l8.50"></a><span id="l8.50">     if (!m_termSize) // no guard</span>
<a href="#l8.51"></a><span id="l8.51">       return false;</span>
<a href="#l8.52"></a><span id="l8.52">     if (m_matchPos &gt;= m_termSize) // check past success!</span>
<a href="#l8.53"></a><span id="l8.53">       m_matchPos = 0;</span>
<a href="#l8.54"></a><span id="l8.54">     if (m_term[m_matchPos] != c) // Reset sequence</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineat">@@ -755,58 +753,59 @@ private:</span>
<a href="#l8.56"></a><span id="l8.56"> </span>
<a href="#l8.57"></a><span id="l8.57"> template &lt;class _OutFn&gt;</span>
<a href="#l8.58"></a><span id="l8.58"> nsresult CCompositionFile::ToDest(_OutFn dest, const char* term, int termSize)</span>
<a href="#l8.59"></a><span id="l8.59"> {</span>
<a href="#l8.60"></a><span id="l8.60">   CTermGuard guard(term, termSize);</span>
<a href="#l8.61"></a><span id="l8.61"> </span>
<a href="#l8.62"></a><span id="l8.62"> #ifdef MOZILLA_INTERNAL_API</span>
<a href="#l8.63"></a><span id="l8.63">   // We already know the required string size, so reduce future reallocations</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineminus">-  if (!guard.IsChecking() &amp;&amp; !m_convertCRs) </span>
<a href="#l8.65"></a><span id="l8.65" class="difflineplus">+  if (!guard.IsChecking() &amp;&amp; !m_convertCRs)</span>
<a href="#l8.66"></a><span id="l8.66">     dest.SetCapacity(m_fileSize - m_fileReadPos);</span>
<a href="#l8.67"></a><span id="l8.67"> #endif</span>
<a href="#l8.68"></a><span id="l8.68"> </span>
<a href="#l8.69"></a><span id="l8.69">   bool wasCR = false;</span>
<a href="#l8.70"></a><span id="l8.70">   char c = 0;</span>
<a href="#l8.71"></a><span id="l8.71">   nsresult rv;</span>
<a href="#l8.72"></a><span id="l8.72">   while (NS_SUCCEEDED(rv = EnsureHasDataInBuffer())) {</span>
<a href="#l8.73"></a><span id="l8.73">     if (!guard.IsChecking() &amp;&amp; !m_convertCRs) { // Use efficient algorithm</span>
<a href="#l8.74"></a><span id="l8.74">       dest.Append(m_fifoBufferReadPos, m_fifoBufferWrittenPos-m_fifoBufferReadPos);</span>
<a href="#l8.75"></a><span id="l8.75">     }</span>
<a href="#l8.76"></a><span id="l8.76">     else { // Check character by character to convert CRs and find terminating sequence</span>
<a href="#l8.77"></a><span id="l8.77">       while (m_fifoBufferReadPos &lt; m_fifoBufferWrittenPos) {</span>
<a href="#l8.78"></a><span id="l8.78">         c = *m_fifoBufferReadPos;</span>
<a href="#l8.79"></a><span id="l8.79">         if (m_convertCRs &amp;&amp; wasCR) {</span>
<a href="#l8.80"></a><span id="l8.80">           wasCR = false;</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineminus">-          if (c != LF) {</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineminus">-            dest.Append(&amp;LF, 1);</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineminus">-            if (guard.Check(LF)) {</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineminus">-              c = LF; // save last char</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineplus">+          if (c != nsCRT::LF) {</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineplus">+            const char kTmpLF = nsCRT::LF;</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineplus">+            dest.Append(&amp;kTmpLF, 1);</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineplus">+            if (guard.Check(nsCRT::LF)) {</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineplus">+              c = nsCRT::LF; // save last char</span>
<a href="#l8.90"></a><span id="l8.90">               break;</span>
<a href="#l8.91"></a><span id="l8.91">             }</span>
<a href="#l8.92"></a><span id="l8.92">           }</span>
<a href="#l8.93"></a><span id="l8.93">         }</span>
<a href="#l8.94"></a><span id="l8.94">         dest.Append(&amp;c, 1);</span>
<a href="#l8.95"></a><span id="l8.95">         m_fifoBufferReadPos++;</span>
<a href="#l8.96"></a><span id="l8.96"> </span>
<a href="#l8.97"></a><span id="l8.97">         if (guard.Check(c))</span>
<a href="#l8.98"></a><span id="l8.98">           break;</span>
<a href="#l8.99"></a><span id="l8.99"> </span>
<a href="#l8.100"></a><span id="l8.100" class="difflineminus">-        if (m_convertCRs &amp;&amp; (c == CR))</span>
<a href="#l8.101"></a><span id="l8.101" class="difflineplus">+        if (m_convertCRs &amp;&amp; (c == nsCRT::CR))</span>
<a href="#l8.102"></a><span id="l8.102">           wasCR = true;</span>
<a href="#l8.103"></a><span id="l8.103">       }</span>
<a href="#l8.104"></a><span id="l8.104">       if (guard.IsTriggered())</span>
<a href="#l8.105"></a><span id="l8.105">         break;</span>
<a href="#l8.106"></a><span id="l8.106">     }</span>
<a href="#l8.107"></a><span id="l8.107">   }</span>
<a href="#l8.108"></a><span id="l8.108"> </span>
<a href="#l8.109"></a><span id="l8.109">   // check for trailing CR (only if caller didn't specify the terminating sequence that ends with CR -</span>
<a href="#l8.110"></a><span id="l8.110">   // in this case he knows what he does!)</span>
<a href="#l8.111"></a><span id="l8.111" class="difflineminus">-  if (m_convertCRs &amp;&amp; !guard.IsTriggered() &amp;&amp; (c == CR)) {</span>
<a href="#l8.112"></a><span id="l8.112" class="difflineminus">-    c = LF;</span>
<a href="#l8.113"></a><span id="l8.113" class="difflineplus">+  if (m_convertCRs &amp;&amp; !guard.IsTriggered() &amp;&amp; (c == nsCRT::CR)) {</span>
<a href="#l8.114"></a><span id="l8.114" class="difflineplus">+    c = nsCRT::LF;</span>
<a href="#l8.115"></a><span id="l8.115">     dest.Append(&amp;c, 1);</span>
<a href="#l8.116"></a><span id="l8.116">   }</span>
<a href="#l8.117"></a><span id="l8.117"> </span>
<a href="#l8.118"></a><span id="l8.118">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.119"></a><span id="l8.119"> </span>
<a href="#l8.120"></a><span id="l8.120">   m_lastChar = c;</span>
<a href="#l8.121"></a><span id="l8.121">   return NS_OK;</span>
<a href="#l8.122"></a><span id="l8.122"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/import/src/ImportCharSet.h</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/import/src/ImportCharSet.h</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -38,17 +38,17 @@</span>
<a href="#l9.4"></a><span id="l9.4"> #ifndef ImportCharSet_h___</span>
<a href="#l9.5"></a><span id="l9.5"> #define ImportCharSet_h___</span>
<a href="#l9.6"></a><span id="l9.6"> </span>
<a href="#l9.7"></a><span id="l9.7"> #include &quot;nscore.h&quot;</span>
<a href="#l9.8"></a><span id="l9.8"> </span>
<a href="#l9.9"></a><span id="l9.9"> </span>
<a href="#l9.10"></a><span id="l9.10"> // Some useful ASCII values</span>
<a href="#l9.11"></a><span id="l9.11"> //  'A' = 65, 0x41</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-//   'Z' = 90, 0x5a</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+//  'Z' = 90, 0x5a</span>
<a href="#l9.14"></a><span id="l9.14"> //  '_' = 95, 0x5f</span>
<a href="#l9.15"></a><span id="l9.15"> //  'a' = 97, 0x61</span>
<a href="#l9.16"></a><span id="l9.16"> //  'z' = 122, 0x7a</span>
<a href="#l9.17"></a><span id="l9.17"> //  '0' = 48, 0x30</span>
<a href="#l9.18"></a><span id="l9.18"> //  '1' = 49, 0x31</span>
<a href="#l9.19"></a><span id="l9.19"> //  '9' = 57, 0x39</span>
<a href="#l9.20"></a><span id="l9.20"> //  ' ' = 32, 0x20</span>
<a href="#l9.21"></a><span id="l9.21"> //   whitespace, 10, 13, 32, 9 (linefeed, cr, space, tab) - 0x0a, 0x0d, 0x20, 0x09</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/import/text/src/nsTextAddress.cpp</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/import/text/src/nsTextAddress.cpp</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -232,19 +232,19 @@ nsresult nsTextAddress::ReadRecordNumber</span>
<a href="#l10.4"></a><span id="l10.4">   }</span>
<a href="#l10.5"></a><span id="l10.5"> </span>
<a href="#l10.6"></a><span id="l10.6">   return NS_ERROR_FAILURE;</span>
<a href="#l10.7"></a><span id="l10.7"> }</span>
<a href="#l10.8"></a><span id="l10.8"> </span>
<a href="#l10.9"></a><span id="l10.9"> PRInt32 nsTextAddress::CountFields( const char *pLine, PRInt32 maxLen, char delim)</span>
<a href="#l10.10"></a><span id="l10.10"> {</span>
<a href="#l10.11"></a><span id="l10.11">     const char *pChar = pLine;</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-    PRInt32        len = 0;</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-    PRInt32        count = 0;</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineminus">-    char        tab = 9;</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+    PRInt32 len = 0;</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+    PRInt32 count = 0;</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineplus">+    char tab = '\t';</span>
<a href="#l10.18"></a><span id="l10.18"> </span>
<a href="#l10.19"></a><span id="l10.19">     if (delim == tab)</span>
<a href="#l10.20"></a><span id="l10.20">         tab = 0;</span>
<a href="#l10.21"></a><span id="l10.21"> </span>
<a href="#l10.22"></a><span id="l10.22">     while (len &lt; maxLen) {</span>
<a href="#l10.23"></a><span id="l10.23">         while (((*pChar == ' ') || (*pChar == tab)) &amp;&amp; (len &lt; maxLen)) {</span>
<a href="#l10.24"></a><span id="l10.24">             pChar++;</span>
<a href="#l10.25"></a><span id="l10.25">             len++;</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineat">@@ -277,18 +277,18 @@ PRInt32 nsTextAddress::CountFields( cons</span>
<a href="#l10.27"></a><span id="l10.27"> </span>
<a href="#l10.28"></a><span id="l10.28">     return( count);</span>
<a href="#l10.29"></a><span id="l10.29"> }</span>
<a href="#l10.30"></a><span id="l10.30"> </span>
<a href="#l10.31"></a><span id="l10.31"> bool nsTextAddress::GetField( const char *pLine, PRInt32 maxLen, PRInt32 index, nsCString&amp; field, char delim)</span>
<a href="#l10.32"></a><span id="l10.32"> {</span>
<a href="#l10.33"></a><span id="l10.33">     bool result = false;</span>
<a href="#l10.34"></a><span id="l10.34">     const char *pChar = pLine;</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineminus">-    PRInt32        len = 0;</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineminus">-    char        tab = 9;</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineplus">+    PRInt32 len = 0;</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineplus">+    char tab = '\t';</span>
<a href="#l10.39"></a><span id="l10.39"> </span>
<a href="#l10.40"></a><span id="l10.40">     field.Truncate();</span>
<a href="#l10.41"></a><span id="l10.41"> </span>
<a href="#l10.42"></a><span id="l10.42">     if (delim == tab)</span>
<a href="#l10.43"></a><span id="l10.43">         tab = 0;</span>
<a href="#l10.44"></a><span id="l10.44"> </span>
<a href="#l10.45"></a><span id="l10.45">     while (index &amp;&amp; (len &lt; maxLen)) {</span>
<a href="#l10.46"></a><span id="l10.46">         while (((*pChar == ' ') || (*pChar == tab)) &amp;&amp; (len &lt; maxLen)) {</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineat">@@ -432,17 +432,17 @@ nsresult nsTextAddress::DetermineDelim(n</span>
<a href="#l10.48"></a><span id="l10.48">     lineCount++;</span>
<a href="#l10.49"></a><span id="l10.49">   }</span>
<a href="#l10.50"></a><span id="l10.50"> </span>
<a href="#l10.51"></a><span id="l10.51">   rv = inputStream-&gt;Close();</span>
<a href="#l10.52"></a><span id="l10.52"> </span>
<a href="#l10.53"></a><span id="l10.53">   delete [] pLine;</span>
<a href="#l10.54"></a><span id="l10.54"> </span>
<a href="#l10.55"></a><span id="l10.55">   if (tabLines &gt; commaLines)</span>
<a href="#l10.56"></a><span id="l10.56" class="difflineminus">-    m_delim = 9;</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineplus">+    m_delim = '\t';</span>
<a href="#l10.58"></a><span id="l10.58">   else</span>
<a href="#l10.59"></a><span id="l10.59">     m_delim = ',';</span>
<a href="#l10.60"></a><span id="l10.60"> </span>
<a href="#l10.61"></a><span id="l10.61">   return rv;</span>
<a href="#l10.62"></a><span id="l10.62"> }</span>
<a href="#l10.63"></a><span id="l10.63"> </span>
<a href="#l10.64"></a><span id="l10.64"> /*</span>
<a href="#l10.65"></a><span id="l10.65">     This is where the real work happens!</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

