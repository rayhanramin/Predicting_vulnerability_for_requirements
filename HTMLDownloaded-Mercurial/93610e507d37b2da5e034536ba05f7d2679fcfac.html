<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 29877:93610e507d37b2da5e034536ba05f7d2679fcfac</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 93610e507d37b2da5e034536ba05f7d2679fcfac" />
<meta property="og:url" content="/comm-central/rev/93610e507d37b2da5e034536ba05f7d2679fcfac" />
<meta property="og:description" content="Bug 1612239 - Remove nsIArray use in nsIMsgFolder markMessagesRead, markMessagesFlagged, setLabelForMessages, setJunkScoreForMessages. r=mkmelin" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 93610e507d37b2da5e034536ba05f7d2679fcfac 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/93610e507d37b2da5e034536ba05f7d2679fcfac">shortlog</a> |
<a href="/comm-central/log/93610e507d37b2da5e034536ba05f7d2679fcfac">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/93610e507d37b2da5e034536ba05f7d2679fcfac">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/93610e507d37b2da5e034536ba05f7d2679fcfac">files</a> |
changeset |
<a href="/comm-central/raw-rev/93610e507d37b2da5e034536ba05f7d2679fcfac">raw</a>  | <a href="/comm-central/archive/93610e507d37b2da5e034536ba05f7d2679fcfac.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1612239">Bug 1612239</a> - Remove nsIArray use in nsIMsgFolder markMessagesRead, markMessagesFlagged, setLabelForMessages, setJunkScoreForMessages. r=mkmelin
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#66;&#101;&#110;&#32;&#67;&#97;&#109;&#112;&#98;&#101;&#108;&#108;&#32;&#60;&#98;&#101;&#110;&#99;&#64;&#116;&#104;&#117;&#110;&#100;&#101;&#114;&#98;&#105;&#114;&#100;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 05 Jun 2020 23:47:16 +1200</td></tr>

<tr>
 <td>changeset 29877</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/93610e507d37b2da5e034536ba05f7d2679fcfac">93610e507d37b2da5e034536ba05f7d2679fcfac</a></td>
</tr>



<tr>
<td>parent 29876</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/8a91a2d9db06032490bfa76dab4272540dea1881">8a91a2d9db06032490bfa76dab4272540dea1881</a>
</td>
</tr>

<tr>
<td>child 29878</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/d667aaed4e097422d2f37b1c6805b27f4639cb40">d667aaed4e097422d2f37b1c6805b27f4639cb40</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=93610e507d37b2da5e034536ba05f7d2679fcfac">17576</a></td></tr>
<tr><td>push user</td><td>geoff@darktrojan.net</td></tr>
<tr><td>push date</td><td class="date age">Wed, 17 Jun 2020 00:38:52 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@d667aaed4e09 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=d667aaed4e097422d2f37b1c6805b27f4639cb40">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=d667aaed4e097422d2f37b1c6805b27f4639cb40&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=d667aaed4e097422d2f37b1c6805b27f4639cb40&newProject=comm-central&newRevision=8a91a2d9db06032490bfa76dab4272540dea1881&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=d667aaed4e097422d2f37b1c6805b27f4639cb40&newProject=comm-central&newRevision=8a91a2d9db06032490bfa76dab4272540dea1881&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=d667aaed4e097422d2f37b1c6805b27f4639cb40&newProject=comm-central&newRevision=8a91a2d9db06032490bfa76dab4272540dea1881&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mkmelin%29&revcount=50">mkmelin</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1612239">1612239</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1612239">Bug 1612239</a> - Remove nsIArray use in nsIMsgFolder markMessagesRead, markMessagesFlagged, setLabelForMessages, setJunkScoreForMessages. r=mkmelin</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/93610e507d37b2da5e034536ba05f7d2679fcfac/mail/base/content/mailWindowOverlay.js">mail/base/content/mailWindowOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/93610e507d37b2da5e034536ba05f7d2679fcfac/mail/base/content/mailWindowOverlay.js">file</a> |
<a href="/comm-central/annotate/93610e507d37b2da5e034536ba05f7d2679fcfac/mail/base/content/mailWindowOverlay.js">annotate</a> |
<a href="/comm-central/diff/93610e507d37b2da5e034536ba05f7d2679fcfac/mail/base/content/mailWindowOverlay.js">diff</a> |
<a href="/comm-central/comparison/93610e507d37b2da5e034536ba05f7d2679fcfac/mail/base/content/mailWindowOverlay.js">comparison</a> |
<a href="/comm-central/log/93610e507d37b2da5e034536ba05f7d2679fcfac/mail/base/content/mailWindowOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/93610e507d37b2da5e034536ba05f7d2679fcfac/mail/components/extensions/parent/ext-messages.js">mail/components/extensions/parent/ext-messages.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/93610e507d37b2da5e034536ba05f7d2679fcfac/mail/components/extensions/parent/ext-messages.js">file</a> |
<a href="/comm-central/annotate/93610e507d37b2da5e034536ba05f7d2679fcfac/mail/components/extensions/parent/ext-messages.js">annotate</a> |
<a href="/comm-central/diff/93610e507d37b2da5e034536ba05f7d2679fcfac/mail/components/extensions/parent/ext-messages.js">diff</a> |
<a href="/comm-central/comparison/93610e507d37b2da5e034536ba05f7d2679fcfac/mail/components/extensions/parent/ext-messages.js">comparison</a> |
<a href="/comm-central/log/93610e507d37b2da5e034536ba05f7d2679fcfac/mail/components/extensions/parent/ext-messages.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/93610e507d37b2da5e034536ba05f7d2679fcfac/mail/extensions/openpgp/content/modules/stdlib/msgHdrUtils.jsm">mail/extensions/openpgp/content/modules/stdlib/msgHdrUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/93610e507d37b2da5e034536ba05f7d2679fcfac/mail/extensions/openpgp/content/modules/stdlib/msgHdrUtils.jsm">file</a> |
<a href="/comm-central/annotate/93610e507d37b2da5e034536ba05f7d2679fcfac/mail/extensions/openpgp/content/modules/stdlib/msgHdrUtils.jsm">annotate</a> |
<a href="/comm-central/diff/93610e507d37b2da5e034536ba05f7d2679fcfac/mail/extensions/openpgp/content/modules/stdlib/msgHdrUtils.jsm">diff</a> |
<a href="/comm-central/comparison/93610e507d37b2da5e034536ba05f7d2679fcfac/mail/extensions/openpgp/content/modules/stdlib/msgHdrUtils.jsm">comparison</a> |
<a href="/comm-central/log/93610e507d37b2da5e034536ba05f7d2679fcfac/mail/extensions/openpgp/content/modules/stdlib/msgHdrUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/base/content/junkCommands.js">mailnews/base/content/junkCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/base/content/junkCommands.js">file</a> |
<a href="/comm-central/annotate/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/base/content/junkCommands.js">annotate</a> |
<a href="/comm-central/diff/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/base/content/junkCommands.js">diff</a> |
<a href="/comm-central/comparison/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/base/content/junkCommands.js">comparison</a> |
<a href="/comm-central/log/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/base/content/junkCommands.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/base/public/nsIMsgFolder.idl">mailnews/base/public/nsIMsgFolder.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/base/public/nsIMsgFolder.idl">file</a> |
<a href="/comm-central/annotate/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/base/public/nsIMsgFolder.idl">annotate</a> |
<a href="/comm-central/diff/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/base/public/nsIMsgFolder.idl">diff</a> |
<a href="/comm-central/comparison/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/base/public/nsIMsgFolder.idl">comparison</a> |
<a href="/comm-central/log/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/base/public/nsIMsgFolder.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/base/search/src/nsMsgFilterService.cpp">mailnews/base/search/src/nsMsgFilterService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/base/search/src/nsMsgFilterService.cpp">file</a> |
<a href="/comm-central/annotate/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/base/search/src/nsMsgFilterService.cpp">annotate</a> |
<a href="/comm-central/diff/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/base/search/src/nsMsgFilterService.cpp">diff</a> |
<a href="/comm-central/comparison/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/base/search/src/nsMsgFilterService.cpp">comparison</a> |
<a href="/comm-central/log/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/base/search/src/nsMsgFilterService.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/base/src/nsMsgDBView.cpp">mailnews/base/src/nsMsgDBView.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/base/src/nsMsgDBView.cpp">file</a> |
<a href="/comm-central/annotate/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/base/src/nsMsgDBView.cpp">annotate</a> |
<a href="/comm-central/diff/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/base/src/nsMsgDBView.cpp">diff</a> |
<a href="/comm-central/comparison/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/base/src/nsMsgDBView.cpp">comparison</a> |
<a href="/comm-central/log/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/base/src/nsMsgDBView.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/base/test/unit/test_bug428427.js">mailnews/base/test/unit/test_bug428427.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/base/test/unit/test_bug428427.js">file</a> |
<a href="/comm-central/annotate/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/base/test/unit/test_bug428427.js">annotate</a> |
<a href="/comm-central/diff/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/base/test/unit/test_bug428427.js">diff</a> |
<a href="/comm-central/comparison/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/base/test/unit/test_bug428427.js">comparison</a> |
<a href="/comm-central/log/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/base/test/unit/test_bug428427.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/base/util/nsMsgDBFolder.cpp">mailnews/base/util/nsMsgDBFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/base/util/nsMsgDBFolder.cpp">file</a> |
<a href="/comm-central/annotate/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/base/util/nsMsgDBFolder.cpp">annotate</a> |
<a href="/comm-central/diff/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/base/util/nsMsgDBFolder.cpp">diff</a> |
<a href="/comm-central/comparison/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/base/util/nsMsgDBFolder.cpp">comparison</a> |
<a href="/comm-central/log/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/base/util/nsMsgDBFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/base/util/nsMsgReadStateTxn.cpp">mailnews/base/util/nsMsgReadStateTxn.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/base/util/nsMsgReadStateTxn.cpp">file</a> |
<a href="/comm-central/annotate/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/base/util/nsMsgReadStateTxn.cpp">annotate</a> |
<a href="/comm-central/diff/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/base/util/nsMsgReadStateTxn.cpp">diff</a> |
<a href="/comm-central/comparison/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/base/util/nsMsgReadStateTxn.cpp">comparison</a> |
<a href="/comm-central/log/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/base/util/nsMsgReadStateTxn.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/imap/src/nsImapMailFolder.cpp">mailnews/imap/src/nsImapMailFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/imap/src/nsImapMailFolder.cpp">file</a> |
<a href="/comm-central/annotate/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/imap/src/nsImapMailFolder.cpp">annotate</a> |
<a href="/comm-central/diff/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/imap/src/nsImapMailFolder.cpp">diff</a> |
<a href="/comm-central/comparison/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/imap/src/nsImapMailFolder.cpp">comparison</a> |
<a href="/comm-central/log/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/imap/src/nsImapMailFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/imap/src/nsImapMailFolder.h">mailnews/imap/src/nsImapMailFolder.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/imap/src/nsImapMailFolder.h">file</a> |
<a href="/comm-central/annotate/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/imap/src/nsImapMailFolder.h">annotate</a> |
<a href="/comm-central/diff/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/imap/src/nsImapMailFolder.h">diff</a> |
<a href="/comm-central/comparison/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/imap/src/nsImapMailFolder.h">comparison</a> |
<a href="/comm-central/log/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/imap/src/nsImapMailFolder.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/imap/test/unit/test_offlinePlayback.js">mailnews/imap/test/unit/test_offlinePlayback.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/imap/test/unit/test_offlinePlayback.js">file</a> |
<a href="/comm-central/annotate/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/imap/test/unit/test_offlinePlayback.js">annotate</a> |
<a href="/comm-central/diff/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/imap/test/unit/test_offlinePlayback.js">diff</a> |
<a href="/comm-central/comparison/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/imap/test/unit/test_offlinePlayback.js">comparison</a> |
<a href="/comm-central/log/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/imap/test/unit/test_offlinePlayback.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/local/src/nsLocalMailFolder.cpp">mailnews/local/src/nsLocalMailFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/local/src/nsLocalMailFolder.cpp">file</a> |
<a href="/comm-central/annotate/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/local/src/nsLocalMailFolder.cpp">annotate</a> |
<a href="/comm-central/diff/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/local/src/nsLocalMailFolder.cpp">diff</a> |
<a href="/comm-central/comparison/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/local/src/nsLocalMailFolder.cpp">comparison</a> |
<a href="/comm-central/log/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/local/src/nsLocalMailFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/local/src/nsLocalMailFolder.h">mailnews/local/src/nsLocalMailFolder.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/local/src/nsLocalMailFolder.h">file</a> |
<a href="/comm-central/annotate/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/local/src/nsLocalMailFolder.h">annotate</a> |
<a href="/comm-central/diff/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/local/src/nsLocalMailFolder.h">diff</a> |
<a href="/comm-central/comparison/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/local/src/nsLocalMailFolder.h">comparison</a> |
<a href="/comm-central/log/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/local/src/nsLocalMailFolder.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/local/src/nsParseMailbox.cpp">mailnews/local/src/nsParseMailbox.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/local/src/nsParseMailbox.cpp">file</a> |
<a href="/comm-central/annotate/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/local/src/nsParseMailbox.cpp">annotate</a> |
<a href="/comm-central/diff/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/local/src/nsParseMailbox.cpp">diff</a> |
<a href="/comm-central/comparison/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/local/src/nsParseMailbox.cpp">comparison</a> |
<a href="/comm-central/log/93610e507d37b2da5e034536ba05f7d2679fcfac/mailnews/local/src/nsParseMailbox.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/93610e507d37b2da5e034536ba05f7d2679fcfac/suite/mailnews/content/mailWindowOverlay.js">suite/mailnews/content/mailWindowOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/93610e507d37b2da5e034536ba05f7d2679fcfac/suite/mailnews/content/mailWindowOverlay.js">file</a> |
<a href="/comm-central/annotate/93610e507d37b2da5e034536ba05f7d2679fcfac/suite/mailnews/content/mailWindowOverlay.js">annotate</a> |
<a href="/comm-central/diff/93610e507d37b2da5e034536ba05f7d2679fcfac/suite/mailnews/content/mailWindowOverlay.js">diff</a> |
<a href="/comm-central/comparison/93610e507d37b2da5e034536ba05f7d2679fcfac/suite/mailnews/content/mailWindowOverlay.js">comparison</a> |
<a href="/comm-central/log/93610e507d37b2da5e034536ba05f7d2679fcfac/suite/mailnews/content/mailWindowOverlay.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/base/content/mailWindowOverlay.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/base/content/mailWindowOverlay.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -3539,19 +3539,17 @@ function setMsgHdrPropertyAndReload(aPro</span>
<a href="#l1.4"></a><span id="l1.4"> }</span>
<a href="#l1.5"></a><span id="l1.5"> </span>
<a href="#l1.6"></a><span id="l1.6"> /**</span>
<a href="#l1.7"></a><span id="l1.7">  * Mark a specified message as read.</span>
<a href="#l1.8"></a><span id="l1.8">  * @param msgHdr header (nsIMsgDBHdr) of the message to mark as read</span>
<a href="#l1.9"></a><span id="l1.9">  */</span>
<a href="#l1.10"></a><span id="l1.10"> function MarkMessageAsRead(msgHdr) {</span>
<a href="#l1.11"></a><span id="l1.11">   ClearPendingReadTimer();</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-  var headers = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-  headers.appendElement(msgHdr);</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-  msgHdr.folder.markMessagesRead(headers, true);</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+  msgHdr.folder.markMessagesRead([msgHdr], true);</span>
<a href="#l1.16"></a><span id="l1.16"> }</span>
<a href="#l1.17"></a><span id="l1.17"> </span>
<a href="#l1.18"></a><span id="l1.18"> function ClearPendingReadTimer() {</span>
<a href="#l1.19"></a><span id="l1.19">   if (gMarkViewedMessageAsReadTimer) {</span>
<a href="#l1.20"></a><span id="l1.20">     clearTimeout(gMarkViewedMessageAsReadTimer);</span>
<a href="#l1.21"></a><span id="l1.21">     gMarkViewedMessageAsReadTimer = null;</span>
<a href="#l1.22"></a><span id="l1.22">   }</span>
<a href="#l1.23"></a><span id="l1.23"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/components/extensions/parent/ext-messages.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/components/extensions/parent/ext-messages.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -337,20 +337,22 @@ this.messages = class extends ExtensionA</span>
<a href="#l2.4"></a><span id="l2.4">             context.extension</span>
<a href="#l2.5"></a><span id="l2.5">           );</span>
<a href="#l2.6"></a><span id="l2.6">         },</span>
<a href="#l2.7"></a><span id="l2.7">         async update(messageId, newProperties) {</span>
<a href="#l2.8"></a><span id="l2.8">           let msgHdr = messageTracker.getMessage(messageId);</span>
<a href="#l2.9"></a><span id="l2.9">           if (!msgHdr) {</span>
<a href="#l2.10"></a><span id="l2.10">             return;</span>
<a href="#l2.11"></a><span id="l2.11">           }</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-          const msgs = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+          // Stopgap for nsIArray removal (Bug 1612239).</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+          const msgsArray = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(</span>
<a href="#l2.15"></a><span id="l2.15">             Ci.nsIMutableArray</span>
<a href="#l2.16"></a><span id="l2.16">           );</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineminus">-          msgs.appendElement(msgHdr);</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+          msgsArray.appendElement(msgHdr);</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+          let msgs = [msgHdr];</span>
<a href="#l2.20"></a><span id="l2.20"> </span>
<a href="#l2.21"></a><span id="l2.21">           if (newProperties.read !== null) {</span>
<a href="#l2.22"></a><span id="l2.22">             msgHdr.folder.markMessagesRead(msgs, newProperties.read);</span>
<a href="#l2.23"></a><span id="l2.23">           }</span>
<a href="#l2.24"></a><span id="l2.24">           if (newProperties.flagged !== null) {</span>
<a href="#l2.25"></a><span id="l2.25">             msgHdr.folder.markMessagesFlagged(msgs, newProperties.flagged);</span>
<a href="#l2.26"></a><span id="l2.26">           }</span>
<a href="#l2.27"></a><span id="l2.27">           if (newProperties.junk !== null) {</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineat">@@ -360,20 +362,20 @@ this.messages = class extends ExtensionA</span>
<a href="#l2.29"></a><span id="l2.29">             msgHdr.folder.setJunkScoreForMessages(msgs, score);</span>
<a href="#l2.30"></a><span id="l2.30">           }</span>
<a href="#l2.31"></a><span id="l2.31">           if (Array.isArray(newProperties.tags)) {</span>
<a href="#l2.32"></a><span id="l2.32">             let currentTags = msgHdr.getStringProperty(&quot;keywords&quot;).split(&quot; &quot;);</span>
<a href="#l2.33"></a><span id="l2.33"> </span>
<a href="#l2.34"></a><span id="l2.34">             for (let { key: tagKey } of MailServices.tags.getAllTags()) {</span>
<a href="#l2.35"></a><span id="l2.35">               if (newProperties.tags.includes(tagKey)) {</span>
<a href="#l2.36"></a><span id="l2.36">                 if (!currentTags.includes(tagKey)) {</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineminus">-                  msgHdr.folder.addKeywordsToMessages(msgs, tagKey);</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+                  msgHdr.folder.addKeywordsToMessages(msgsArray, tagKey);</span>
<a href="#l2.39"></a><span id="l2.39">                 }</span>
<a href="#l2.40"></a><span id="l2.40">               } else if (currentTags.includes(tagKey)) {</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineminus">-                msgHdr.folder.removeKeywordsFromMessages(msgs, tagKey);</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineplus">+                msgHdr.folder.removeKeywordsFromMessages(msgsArray, tagKey);</span>
<a href="#l2.43"></a><span id="l2.43">               }</span>
<a href="#l2.44"></a><span id="l2.44">             }</span>
<a href="#l2.45"></a><span id="l2.45">           }</span>
<a href="#l2.46"></a><span id="l2.46">         },</span>
<a href="#l2.47"></a><span id="l2.47">         async move(messageIds, destination) {</span>
<a href="#l2.48"></a><span id="l2.48">           return moveOrCopyMessages(messageIds, destination, true);</span>
<a href="#l2.49"></a><span id="l2.49">         },</span>
<a href="#l2.50"></a><span id="l2.50">         async copy(messageIds, destination) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/stdlib/msgHdrUtils.jsm</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/stdlib/msgHdrUtils.jsm</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -249,20 +249,20 @@ function msgHdrsMarkAsRead(msgHdrs, read</span>
<a href="#l3.4"></a><span id="l3.4">   let pending = {};</span>
<a href="#l3.5"></a><span id="l3.5">   for (let msgHdr of msgHdrs) {</span>
<a href="#l3.6"></a><span id="l3.6">     if (msgHdr.isRead == read) {</span>
<a href="#l3.7"></a><span id="l3.7">       continue;</span>
<a href="#l3.8"></a><span id="l3.8">     }</span>
<a href="#l3.9"></a><span id="l3.9">     if (!pending[msgHdr.folder.URI]) {</span>
<a href="#l3.10"></a><span id="l3.10">       pending[msgHdr.folder.URI] = {</span>
<a href="#l3.11"></a><span id="l3.11">         folder: msgHdr.folder,</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-        msgs: Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray),</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+        msgs: [],</span>
<a href="#l3.14"></a><span id="l3.14">       };</span>
<a href="#l3.15"></a><span id="l3.15">     }</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineminus">-    pending[msgHdr.folder.URI].msgs.appendElement(msgHdr);</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+    pending[msgHdr.folder.URI].msgs.push(msgHdr);</span>
<a href="#l3.18"></a><span id="l3.18">   }</span>
<a href="#l3.19"></a><span id="l3.19">   for (let [{ folder, msgs }] of entries(pending)) {</span>
<a href="#l3.20"></a><span id="l3.20">     folder.markMessagesRead(msgs, read);</span>
<a href="#l3.21"></a><span id="l3.21">     folder.msgDatabase = null; /* don't leak */</span>
<a href="#l3.22"></a><span id="l3.22">   }</span>
<a href="#l3.23"></a><span id="l3.23"> }</span>
<a href="#l3.24"></a><span id="l3.24"> </span>
<a href="#l3.25"></a><span id="l3.25"> /**</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/base/content/junkCommands.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/base/content/junkCommands.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -17,17 +17,17 @@</span>
<a href="#l4.4"></a><span id="l4.4">  *</span>
<a href="#l4.5"></a><span id="l4.5">  *   messenger</span>
<a href="#l4.6"></a><span id="l4.6">  *   gDBView</span>
<a href="#l4.7"></a><span id="l4.7">  *   MsgJunkMailInfo(aCheckFirstUse)</span>
<a href="#l4.8"></a><span id="l4.8">  *   msgWindow</span>
<a href="#l4.9"></a><span id="l4.9">  */</span>
<a href="#l4.10"></a><span id="l4.10"> </span>
<a href="#l4.11"></a><span id="l4.11"> /* globals ClearMessagePane, gDBView, gFolderDisplay, MarkSelectedMessagesRead, messenger,</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-   MsgJunkMailInfo, msgWindow, nsMsgViewIndex_None */</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+   MsgJunkMailInfo, msgWindow, nsMsgViewIndex_None, fixIterator */</span>
<a href="#l4.14"></a><span id="l4.14"> </span>
<a href="#l4.15"></a><span id="l4.15"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l4.16"></a><span id="l4.16"> var { MailServices } = ChromeUtils.import(</span>
<a href="#l4.17"></a><span id="l4.17">   &quot;resource:///modules/MailServices.jsm&quot;</span>
<a href="#l4.18"></a><span id="l4.18"> );</span>
<a href="#l4.19"></a><span id="l4.19"> var { MailUtils } = ChromeUtils.import(&quot;resource:///modules/MailUtils.jsm&quot;);</span>
<a href="#l4.20"></a><span id="l4.20"> </span>
<a href="#l4.21"></a><span id="l4.21"> /*</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineat">@@ -110,17 +110,20 @@ function performActionsOnJunkMsgs(aFolde</span>
<a href="#l4.23"></a><span id="l4.23">       }</span>
<a href="#l4.24"></a><span id="l4.24">       aFolder.storeCustomKeywords(null, &quot;NonJunk&quot;, &quot;Junk&quot;, goodMsgKeys);</span>
<a href="#l4.25"></a><span id="l4.25">     }</span>
<a href="#l4.26"></a><span id="l4.26">   }</span>
<a href="#l4.27"></a><span id="l4.27"> </span>
<a href="#l4.28"></a><span id="l4.28">   if (aJunkMsgHdrs.length) {</span>
<a href="#l4.29"></a><span id="l4.29">     var actionParams = determineActionsForJunkMsgs(aFolder);</span>
<a href="#l4.30"></a><span id="l4.30">     if (actionParams.markRead) {</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineminus">-      aFolder.markMessagesRead(aJunkMsgHdrs, true);</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+      aFolder.markMessagesRead(</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+        [...fixIterator(aJunkMsgHdrs, Ci.nsIMsgDBHdr)],</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+        true</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+      );</span>
<a href="#l4.36"></a><span id="l4.36">     }</span>
<a href="#l4.37"></a><span id="l4.37"> </span>
<a href="#l4.38"></a><span id="l4.38">     if (actionParams.junkTargetFolder) {</span>
<a href="#l4.39"></a><span id="l4.39">       MailServices.copy.CopyMessages(</span>
<a href="#l4.40"></a><span id="l4.40">         aFolder,</span>
<a href="#l4.41"></a><span id="l4.41">         aJunkMsgHdrs,</span>
<a href="#l4.42"></a><span id="l4.42">         actionParams.junkTargetFolder,</span>
<a href="#l4.43"></a><span id="l4.43">         true /* isMove */,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/base/public/nsIMsgFolder.idl</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/base/public/nsIMsgFolder.idl</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -521,21 +521,21 @@ interface nsIMsgFolder : nsISupports {</span>
<a href="#l5.4"></a><span id="l5.4">   ACString generateMessageURI(in nsMsgKey msgKey);</span>
<a href="#l5.5"></a><span id="l5.5"> </span>
<a href="#l5.6"></a><span id="l5.6">   const nsMsgDispositionState nsMsgDispositionState_None = -1;</span>
<a href="#l5.7"></a><span id="l5.7">   const nsMsgDispositionState nsMsgDispositionState_Replied = 0;</span>
<a href="#l5.8"></a><span id="l5.8">   const nsMsgDispositionState nsMsgDispositionState_Forwarded = 1;</span>
<a href="#l5.9"></a><span id="l5.9">   void addMessageDispositionState(in nsIMsgDBHdr aMessage,</span>
<a href="#l5.10"></a><span id="l5.10">                                   in nsMsgDispositionState aDispositionFlag);</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-  void markMessagesRead(in nsIArray messages, in boolean markRead);</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+  void markMessagesRead(in Array&lt;nsIMsgDBHdr&gt; messages, in boolean markRead);</span>
<a href="#l5.14"></a><span id="l5.14">   void markAllMessagesRead(in nsIMsgWindow aMsgWindow);</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineminus">-  void markMessagesFlagged(in nsIArray messages, in boolean markFlagged);</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+  void markMessagesFlagged(in Array&lt;nsIMsgDBHdr&gt; messages, in boolean markFlagged);</span>
<a href="#l5.17"></a><span id="l5.17">   void markThreadRead(in nsIMsgThread thread);</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineminus">-  void setLabelForMessages(in nsIArray messages, in nsMsgLabelValue label);</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+  void setLabelForMessages(in Array&lt;nsIMsgDBHdr&gt; messages, in nsMsgLabelValue label);</span>
<a href="#l5.20"></a><span id="l5.20">   /**</span>
<a href="#l5.21"></a><span id="l5.21">    * Gets the message database for the folder.</span>
<a href="#l5.22"></a><span id="l5.22">    *</span>
<a href="#l5.23"></a><span id="l5.23">    * Note that if the database is out of date, the implementation MAY choose to</span>
<a href="#l5.24"></a><span id="l5.24">    * throw an error. For a handle to the database which MAY NOT throw an error,</span>
<a href="#l5.25"></a><span id="l5.25">    * one can use getDBFolderInfoAndDB.</span>
<a href="#l5.26"></a><span id="l5.26">    *</span>
<a href="#l5.27"></a><span id="l5.27">    * The attribute can also be set to another database or to null to force the</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineat">@@ -731,17 +731,17 @@ interface nsIMsgFolder : nsISupports {</span>
<a href="#l5.29"></a><span id="l5.29"> </span>
<a href="#l5.30"></a><span id="l5.30">   // Gets all descendants, not just first level children.</span>
<a href="#l5.31"></a><span id="l5.31">   readonly attribute Array&lt;nsIMsgFolder&gt; descendants;</span>
<a href="#l5.32"></a><span id="l5.32">   void Shutdown(in boolean shutdownChildren);</span>
<a href="#l5.33"></a><span id="l5.33"> </span>
<a href="#l5.34"></a><span id="l5.34">   void copyDataToOutputStreamForAppend(in nsIInputStream aIStream,</span>
<a href="#l5.35"></a><span id="l5.35">                      in long aLength, in nsIOutputStream outputStream);</span>
<a href="#l5.36"></a><span id="l5.36">   void copyDataDone();</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineminus">-  void setJunkScoreForMessages(in nsIArray aMessages, in ACString aJunkScore);</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineplus">+  void setJunkScoreForMessages(in Array&lt;nsIMsgDBHdr&gt; aMessages, in ACString aJunkScore);</span>
<a href="#l5.39"></a><span id="l5.39">   void applyRetentionSettings();</span>
<a href="#l5.40"></a><span id="l5.40"> </span>
<a href="#l5.41"></a><span id="l5.41">   /**</span>
<a href="#l5.42"></a><span id="l5.42">    * Get the beginning of the message bodies for the passed in keys and store</span>
<a href="#l5.43"></a><span id="l5.43">    * them in the msg hdr property &quot;preview&quot;. This is intended for</span>
<a href="#l5.44"></a><span id="l5.44">    * new mail alerts, title tips on folders with new messages, and perhaps</span>
<a href="#l5.45"></a><span id="l5.45">    * titletips/message preview in the thread pane.</span>
<a href="#l5.46"></a><span id="l5.46">    *</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgFilterService.cpp</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgFilterService.cpp</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -690,25 +690,25 @@ nsresult nsMsgFilterAfterTheFact::ApplyF</span>
<a href="#l6.4"></a><span id="l6.4">       if (actionType == nsMsgFilterAction::MoveToFolder ||</span>
<a href="#l6.5"></a><span id="l6.5">           actionType == nsMsgFilterAction::CopyToFolder) {</span>
<a href="#l6.6"></a><span id="l6.6">         rv = filterAction-&gt;GetTargetFolderUri(actionTargetFolderUri);</span>
<a href="#l6.7"></a><span id="l6.7">         CONTINUE_IF_FAILURE(rv, &quot;GetTargetFolderUri failed&quot;);</span>
<a href="#l6.8"></a><span id="l6.8">         CONTINUE_IF_FALSE(!actionTargetFolderUri.IsEmpty(),</span>
<a href="#l6.9"></a><span id="l6.9">                           &quot;actionTargetFolderUri is empty&quot;);</span>
<a href="#l6.10"></a><span id="l6.10">       }</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+      // Stopgap during nsIArray removal (Bug 1612239).</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+      // Need to shadow m_searchHitHdrs until all the receiving functions</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+      // have been updated.</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+      nsTArray&lt;RefPtr&lt;nsIMsgDBHdr&gt;&gt; hitHdrs;</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+      MsgHdrsToTArray(m_searchHitHdrs, hitHdrs);</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+</span>
<a href="#l6.18"></a><span id="l6.18">       if (loggingEnabled) {</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineminus">-        for (uint32_t msgIndex = 0; msgIndex &lt; m_searchHits.Length();</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineminus">-             msgIndex++) {</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineminus">-          nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr =</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineminus">-              do_QueryElementAt(m_searchHitHdrs, msgIndex);</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineminus">-          if (msgHdr)</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineminus">-            (void)m_curFilter-&gt;LogRuleHit(filterAction, msgHdr);</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineminus">-          else</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineminus">-            NS_WARNING(&quot;could not QI element to nsIMsgDBHdr&quot;);</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineplus">+        for (auto msgHdr : hitHdrs) {</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineplus">+          (void)m_curFilter-&gt;LogRuleHit(filterAction, msgHdr);</span>
<a href="#l6.29"></a><span id="l6.29">         }</span>
<a href="#l6.30"></a><span id="l6.30">       }</span>
<a href="#l6.31"></a><span id="l6.31"> </span>
<a href="#l6.32"></a><span id="l6.32">       // all actions that pass &quot;this&quot; as a listener in order to chain filter</span>
<a href="#l6.33"></a><span id="l6.33">       // execution when the action is finished need to return before reaching</span>
<a href="#l6.34"></a><span id="l6.34">       // the bottom of this routine, because we run the next filter at the end</span>
<a href="#l6.35"></a><span id="l6.35">       // of this routine.</span>
<a href="#l6.36"></a><span id="l6.36">       switch (actionType) {</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineat">@@ -791,35 +791,30 @@ nsresult nsMsgFilterAfterTheFact::ApplyF</span>
<a href="#l6.38"></a><span id="l6.38">           MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug,</span>
<a href="#l6.39"></a><span id="l6.39">                   (&quot;(Post) Action execution continues async&quot;));</span>
<a href="#l6.40"></a><span id="l6.40">           return NS_OK;  // OnStopCopy callback to continue;</span>
<a href="#l6.41"></a><span id="l6.41">         } break;</span>
<a href="#l6.42"></a><span id="l6.42">         case nsMsgFilterAction::MarkRead:</span>
<a href="#l6.43"></a><span id="l6.43">           // crud, no listener support here - we'll probably just need to go on</span>
<a href="#l6.44"></a><span id="l6.44">           // and apply the next filter, and, in the imap case, rely on multiple</span>
<a href="#l6.45"></a><span id="l6.45">           // connection and url queueing to stay out of trouble</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineminus">-          rv = curFolder-&gt;MarkMessagesRead(m_searchHitHdrs, true);</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineplus">+          rv = curFolder-&gt;MarkMessagesRead(hitHdrs, true);</span>
<a href="#l6.48"></a><span id="l6.48">           BREAK_ACTION_IF_FAILURE(rv, &quot;Setting message flags failed&quot;);</span>
<a href="#l6.49"></a><span id="l6.49">           break;</span>
<a href="#l6.50"></a><span id="l6.50">         case nsMsgFilterAction::MarkUnread:</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineminus">-          rv = curFolder-&gt;MarkMessagesRead(m_searchHitHdrs, false);</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineplus">+          rv = curFolder-&gt;MarkMessagesRead(hitHdrs, false);</span>
<a href="#l6.53"></a><span id="l6.53">           BREAK_ACTION_IF_FAILURE(rv, &quot;Setting message flags failed&quot;);</span>
<a href="#l6.54"></a><span id="l6.54">           break;</span>
<a href="#l6.55"></a><span id="l6.55">         case nsMsgFilterAction::MarkFlagged:</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineminus">-          rv = curFolder-&gt;MarkMessagesFlagged(m_searchHitHdrs, true);</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineplus">+          rv = curFolder-&gt;MarkMessagesFlagged(hitHdrs, true);</span>
<a href="#l6.58"></a><span id="l6.58">           BREAK_ACTION_IF_FAILURE(rv, &quot;Setting message flags failed&quot;);</span>
<a href="#l6.59"></a><span id="l6.59">           break;</span>
<a href="#l6.60"></a><span id="l6.60">         case nsMsgFilterAction::KillThread:</span>
<a href="#l6.61"></a><span id="l6.61">         case nsMsgFilterAction::WatchThread: {</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineminus">-          for (uint32_t msgIndex = 0; msgIndex &lt; m_searchHits.Length();</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineminus">-               msgIndex++) {</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineminus">-            nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr =</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineminus">-                do_QueryElementAt(m_searchHitHdrs, msgIndex);</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineminus">-            BREAK_ACTION_IF_FALSE(msgHdr, &quot;Could not get msg header&quot;);</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineminus">-</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineplus">+          for (auto msgHdr : hitHdrs) {</span>
<a href="#l6.69"></a><span id="l6.69">             nsCOMPtr&lt;nsIMsgThread&gt; msgThread;</span>
<a href="#l6.70"></a><span id="l6.70">             nsMsgKey threadKey;</span>
<a href="#l6.71"></a><span id="l6.71">             m_curFolderDB-&gt;GetThreadContainingMsgHdr(msgHdr,</span>
<a href="#l6.72"></a><span id="l6.72">                                                      getter_AddRefs(msgThread));</span>
<a href="#l6.73"></a><span id="l6.73">             BREAK_ACTION_IF_FALSE(msgThread, &quot;Could not find msg thread&quot;);</span>
<a href="#l6.74"></a><span id="l6.74">             msgThread-&gt;GetThreadKey(&amp;threadKey);</span>
<a href="#l6.75"></a><span id="l6.75">             if (actionType == nsMsgFilterAction::KillThread) {</span>
<a href="#l6.76"></a><span id="l6.76">               rv = m_curFolderDB-&gt;MarkThreadIgnored(msgThread, threadKey, true,</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineat">@@ -828,102 +823,81 @@ nsresult nsMsgFilterAfterTheFact::ApplyF</span>
<a href="#l6.78"></a><span id="l6.78">             } else {</span>
<a href="#l6.79"></a><span id="l6.79">               rv = m_curFolderDB-&gt;MarkThreadWatched(msgThread, threadKey, true,</span>
<a href="#l6.80"></a><span id="l6.80">                                                     nullptr);</span>
<a href="#l6.81"></a><span id="l6.81">               BREAK_ACTION_IF_FAILURE(rv, &quot;Setting message flags failed&quot;);</span>
<a href="#l6.82"></a><span id="l6.82">             }</span>
<a href="#l6.83"></a><span id="l6.83">           }</span>
<a href="#l6.84"></a><span id="l6.84">         } break;</span>
<a href="#l6.85"></a><span id="l6.85">         case nsMsgFilterAction::KillSubthread: {</span>
<a href="#l6.86"></a><span id="l6.86" class="difflineminus">-          for (uint32_t msgIndex = 0; msgIndex &lt; m_searchHits.Length();</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineminus">-               msgIndex++) {</span>
<a href="#l6.88"></a><span id="l6.88" class="difflineminus">-            nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr =</span>
<a href="#l6.89"></a><span id="l6.89" class="difflineminus">-                do_QueryElementAt(m_searchHitHdrs, msgIndex, &amp;rv);</span>
<a href="#l6.90"></a><span id="l6.90" class="difflineminus">-            BREAK_ACTION_IF_FAILURE(rv, &quot;Could not get msg header&quot;);</span>
<a href="#l6.91"></a><span id="l6.91" class="difflineminus">-            BREAK_ACTION_IF_FALSE(msgHdr, &quot;Could not get msg header&quot;);</span>
<a href="#l6.92"></a><span id="l6.92" class="difflineplus">+          for (auto msgHdr : hitHdrs) {</span>
<a href="#l6.93"></a><span id="l6.93">             rv = m_curFolderDB-&gt;MarkHeaderKilled(msgHdr, true, nullptr);</span>
<a href="#l6.94"></a><span id="l6.94">             BREAK_ACTION_IF_FAILURE(rv, &quot;Setting message flags failed&quot;);</span>
<a href="#l6.95"></a><span id="l6.95">           }</span>
<a href="#l6.96"></a><span id="l6.96">         } break;</span>
<a href="#l6.97"></a><span id="l6.97">         case nsMsgFilterAction::ChangePriority: {</span>
<a href="#l6.98"></a><span id="l6.98">           nsMsgPriorityValue filterPriority;</span>
<a href="#l6.99"></a><span id="l6.99">           filterAction-&gt;GetPriority(&amp;filterPriority);</span>
<a href="#l6.100"></a><span id="l6.100" class="difflineminus">-          for (uint32_t msgIndex = 0; msgIndex &lt; m_searchHits.Length();</span>
<a href="#l6.101"></a><span id="l6.101" class="difflineminus">-               msgIndex++) {</span>
<a href="#l6.102"></a><span id="l6.102" class="difflineminus">-            nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr =</span>
<a href="#l6.103"></a><span id="l6.103" class="difflineminus">-                do_QueryElementAt(m_searchHitHdrs, msgIndex, &amp;rv);</span>
<a href="#l6.104"></a><span id="l6.104" class="difflineminus">-            BREAK_ACTION_IF_FAILURE(rv, &quot;Could not get msg header&quot;);</span>
<a href="#l6.105"></a><span id="l6.105" class="difflineminus">-            BREAK_ACTION_IF_FALSE(msgHdr, &quot;Could not get msg header&quot;);</span>
<a href="#l6.106"></a><span id="l6.106" class="difflineplus">+          for (auto msgHdr : hitHdrs) {</span>
<a href="#l6.107"></a><span id="l6.107">             rv = msgHdr-&gt;SetPriority(filterPriority);</span>
<a href="#l6.108"></a><span id="l6.108">             BREAK_ACTION_IF_FAILURE(rv, &quot;Setting message flags failed&quot;);</span>
<a href="#l6.109"></a><span id="l6.109">           }</span>
<a href="#l6.110"></a><span id="l6.110">         } break;</span>
<a href="#l6.111"></a><span id="l6.111">         case nsMsgFilterAction::Label: {</span>
<a href="#l6.112"></a><span id="l6.112">           nsMsgLabelValue filterLabel;</span>
<a href="#l6.113"></a><span id="l6.113">           filterAction-&gt;GetLabel(&amp;filterLabel);</span>
<a href="#l6.114"></a><span id="l6.114" class="difflineminus">-          rv = curFolder-&gt;SetLabelForMessages(m_searchHitHdrs, filterLabel);</span>
<a href="#l6.115"></a><span id="l6.115" class="difflineplus">+          rv = curFolder-&gt;SetLabelForMessages(hitHdrs, filterLabel);</span>
<a href="#l6.116"></a><span id="l6.116">           BREAK_ACTION_IF_FAILURE(rv, &quot;Setting message flags failed&quot;);</span>
<a href="#l6.117"></a><span id="l6.117">         } break;</span>
<a href="#l6.118"></a><span id="l6.118">         case nsMsgFilterAction::AddTag: {</span>
<a href="#l6.119"></a><span id="l6.119">           nsCString keyword;</span>
<a href="#l6.120"></a><span id="l6.120">           filterAction-&gt;GetStrValue(keyword);</span>
<a href="#l6.121"></a><span id="l6.121">           rv = curFolder-&gt;AddKeywordsToMessages(m_searchHitHdrs, keyword);</span>
<a href="#l6.122"></a><span id="l6.122">           BREAK_ACTION_IF_FAILURE(rv, &quot;Setting message flags failed&quot;);</span>
<a href="#l6.123"></a><span id="l6.123">         } break;</span>
<a href="#l6.124"></a><span id="l6.124">         case nsMsgFilterAction::JunkScore: {</span>
<a href="#l6.125"></a><span id="l6.125">           nsAutoCString junkScoreStr;</span>
<a href="#l6.126"></a><span id="l6.126">           int32_t junkScore;</span>
<a href="#l6.127"></a><span id="l6.127">           filterAction-&gt;GetJunkScore(&amp;junkScore);</span>
<a href="#l6.128"></a><span id="l6.128">           junkScoreStr.AppendInt(junkScore);</span>
<a href="#l6.129"></a><span id="l6.129" class="difflineminus">-          rv =</span>
<a href="#l6.130"></a><span id="l6.130" class="difflineminus">-              curFolder-&gt;SetJunkScoreForMessages(m_searchHitHdrs, junkScoreStr);</span>
<a href="#l6.131"></a><span id="l6.131" class="difflineplus">+          rv = curFolder-&gt;SetJunkScoreForMessages(hitHdrs, junkScoreStr);</span>
<a href="#l6.132"></a><span id="l6.132">           BREAK_ACTION_IF_FAILURE(rv, &quot;Setting message flags failed&quot;);</span>
<a href="#l6.133"></a><span id="l6.133">         } break;</span>
<a href="#l6.134"></a><span id="l6.134">         case nsMsgFilterAction::Forward: {</span>
<a href="#l6.135"></a><span id="l6.135">           nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l6.136"></a><span id="l6.136">           rv = curFolder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l6.137"></a><span id="l6.137">           BREAK_ACTION_IF_FAILURE(rv, &quot;Could not get server&quot;);</span>
<a href="#l6.138"></a><span id="l6.138">           nsCString forwardTo;</span>
<a href="#l6.139"></a><span id="l6.139">           filterAction-&gt;GetStrValue(forwardTo);</span>
<a href="#l6.140"></a><span id="l6.140">           BREAK_ACTION_IF_FALSE(!forwardTo.IsEmpty(), &quot;blank forwardTo URI&quot;);</span>
<a href="#l6.141"></a><span id="l6.141">           nsCOMPtr&lt;nsIMsgComposeService&gt; compService =</span>
<a href="#l6.142"></a><span id="l6.142">               do_GetService(NS_MSGCOMPOSESERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l6.143"></a><span id="l6.143">           BREAK_ACTION_IF_FAILURE(rv, &quot;Could not get compose service&quot;);</span>
<a href="#l6.144"></a><span id="l6.144"> </span>
<a href="#l6.145"></a><span id="l6.145" class="difflineminus">-          for (uint32_t msgIndex = 0; msgIndex &lt; m_searchHits.Length();</span>
<a href="#l6.146"></a><span id="l6.146" class="difflineminus">-               msgIndex++) {</span>
<a href="#l6.147"></a><span id="l6.147" class="difflineminus">-            nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr(</span>
<a href="#l6.148"></a><span id="l6.148" class="difflineminus">-                do_QueryElementAt(m_searchHitHdrs, msgIndex));</span>
<a href="#l6.149"></a><span id="l6.149" class="difflineminus">-            if (msgHdr)</span>
<a href="#l6.150"></a><span id="l6.150" class="difflineminus">-              rv = compService-&gt;ForwardMessage(</span>
<a href="#l6.151"></a><span id="l6.151" class="difflineminus">-                  NS_ConvertASCIItoUTF16(forwardTo), msgHdr, m_msgWindow,</span>
<a href="#l6.152"></a><span id="l6.152" class="difflineminus">-                  server, nsIMsgComposeService::kForwardAsDefault);</span>
<a href="#l6.153"></a><span id="l6.153" class="difflineplus">+          for (auto msgHdr : hitHdrs) {</span>
<a href="#l6.154"></a><span id="l6.154" class="difflineplus">+            rv = compService-&gt;ForwardMessage(</span>
<a href="#l6.155"></a><span id="l6.155" class="difflineplus">+                NS_ConvertASCIItoUTF16(forwardTo), msgHdr, m_msgWindow, server,</span>
<a href="#l6.156"></a><span id="l6.156" class="difflineplus">+                nsIMsgComposeService::kForwardAsDefault);</span>
<a href="#l6.157"></a><span id="l6.157">             BREAK_ACTION_IF_FAILURE(rv, &quot;Forward action failed&quot;);</span>
<a href="#l6.158"></a><span id="l6.158" class="difflineminus">-            BREAK_ACTION_IF_FALSE(msgHdr, &quot;Forward action failed&quot;);</span>
<a href="#l6.159"></a><span id="l6.159">           }</span>
<a href="#l6.160"></a><span id="l6.160">         } break;</span>
<a href="#l6.161"></a><span id="l6.161">         case nsMsgFilterAction::Reply: {</span>
<a href="#l6.162"></a><span id="l6.162">           nsCString replyTemplateUri;</span>
<a href="#l6.163"></a><span id="l6.163">           filterAction-&gt;GetStrValue(replyTemplateUri);</span>
<a href="#l6.164"></a><span id="l6.164">           BREAK_ACTION_IF_FALSE(!replyTemplateUri.IsEmpty(),</span>
<a href="#l6.165"></a><span id="l6.165">                                 &quot;Empty reply template URI&quot;);</span>
<a href="#l6.166"></a><span id="l6.166"> </span>
<a href="#l6.167"></a><span id="l6.167">           nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l6.168"></a><span id="l6.168">           rv = curFolder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l6.169"></a><span id="l6.169">           BREAK_ACTION_IF_FAILURE(rv, &quot;Could not get server&quot;);</span>
<a href="#l6.170"></a><span id="l6.170"> </span>
<a href="#l6.171"></a><span id="l6.171">           nsCOMPtr&lt;nsIMsgComposeService&gt; compService =</span>
<a href="#l6.172"></a><span id="l6.172">               do_GetService(NS_MSGCOMPOSESERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l6.173"></a><span id="l6.173">           BREAK_ACTION_IF_FAILURE(rv, &quot;Could not get compose service&quot;);</span>
<a href="#l6.174"></a><span id="l6.174" class="difflineminus">-          for (uint32_t msgIndex = 0; msgIndex &lt; m_searchHits.Length();</span>
<a href="#l6.175"></a><span id="l6.175" class="difflineminus">-               msgIndex++) {</span>
<a href="#l6.176"></a><span id="l6.176" class="difflineminus">-            nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr =</span>
<a href="#l6.177"></a><span id="l6.177" class="difflineminus">-                do_QueryElementAt(m_searchHitHdrs, msgIndex, &amp;rv);</span>
<a href="#l6.178"></a><span id="l6.178" class="difflineminus">-            BREAK_ACTION_IF_FAILURE(rv, &quot;Could not get msgHdr&quot;);</span>
<a href="#l6.179"></a><span id="l6.179" class="difflineminus">-            BREAK_ACTION_IF_FALSE(msgHdr, &quot;Could not get msgHdr&quot;);</span>
<a href="#l6.180"></a><span id="l6.180" class="difflineplus">+          for (auto msgHdr : hitHdrs) {</span>
<a href="#l6.181"></a><span id="l6.181">             rv = compService-&gt;ReplyWithTemplate(msgHdr, replyTemplateUri.get(),</span>
<a href="#l6.182"></a><span id="l6.182">                                                 m_msgWindow, server);</span>
<a href="#l6.183"></a><span id="l6.183">             if (NS_FAILED(rv)) {</span>
<a href="#l6.184"></a><span id="l6.184">               if (rv == NS_ERROR_ABORT) {</span>
<a href="#l6.185"></a><span id="l6.185">                 (void)m_curFilter-&gt;LogRuleHitFail(</span>
<a href="#l6.186"></a><span id="l6.186">                     filterAction, msgHdr, rv,</span>
<a href="#l6.187"></a><span id="l6.187">                     NS_LITERAL_CSTRING(&quot;filterFailureSendingReplyAborted&quot;));</span>
<a href="#l6.188"></a><span id="l6.188">               } else {</span>
<a href="#l6.189"></a><span id="l6.189" class="difflineat">@@ -937,32 +911,25 @@ nsresult nsMsgFilterAfterTheFact::ApplyF</span>
<a href="#l6.190"></a><span id="l6.190">         } break;</span>
<a href="#l6.191"></a><span id="l6.191">         case nsMsgFilterAction::DeleteFromPop3Server: {</span>
<a href="#l6.192"></a><span id="l6.192">           nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localFolder =</span>
<a href="#l6.193"></a><span id="l6.193">               do_QueryInterface(curFolder, &amp;rv);</span>
<a href="#l6.194"></a><span id="l6.194">           BREAK_ACTION_IF_FAILURE(rv, &quot;Current folder not a local folder&quot;);</span>
<a href="#l6.195"></a><span id="l6.195">           BREAK_ACTION_IF_FALSE(localFolder,</span>
<a href="#l6.196"></a><span id="l6.196">                                 &quot;Current folder not a local folder&quot;);</span>
<a href="#l6.197"></a><span id="l6.197">           // This action ignores the deleteMailLeftOnServer preference</span>
<a href="#l6.198"></a><span id="l6.198" class="difflineminus">-          {</span>
<a href="#l6.199"></a><span id="l6.199" class="difflineminus">-            nsTArray&lt;RefPtr&lt;nsIMsgDBHdr&gt;&gt; hdrs;</span>
<a href="#l6.200"></a><span id="l6.200" class="difflineminus">-            MsgHdrsToTArray(m_searchHitHdrs, hdrs);</span>
<a href="#l6.201"></a><span id="l6.201" class="difflineminus">-            rv = localFolder-&gt;MarkMsgsOnPop3Server(hdrs, POP3_FORCE_DEL);</span>
<a href="#l6.202"></a><span id="l6.202" class="difflineminus">-            BREAK_ACTION_IF_FAILURE(rv, &quot;MarkMsgsOnPop3Server failed&quot;);</span>
<a href="#l6.203"></a><span id="l6.203" class="difflineminus">-          }</span>
<a href="#l6.204"></a><span id="l6.204" class="difflineplus">+          rv = localFolder-&gt;MarkMsgsOnPop3Server(hitHdrs, POP3_FORCE_DEL);</span>
<a href="#l6.205"></a><span id="l6.205" class="difflineplus">+          BREAK_ACTION_IF_FAILURE(rv, &quot;MarkMsgsOnPop3Server failed&quot;);</span>
<a href="#l6.206"></a><span id="l6.206"> </span>
<a href="#l6.207"></a><span id="l6.207">           nsCOMPtr&lt;nsIMutableArray&gt; partialMsgs;</span>
<a href="#l6.208"></a><span id="l6.208">           // Delete the partial headers. They're useless now</span>
<a href="#l6.209"></a><span id="l6.209">           //   that the server copy is being deleted.</span>
<a href="#l6.210"></a><span id="l6.210">           for (uint32_t msgIndex = 0; msgIndex &lt; m_searchHits.Length();</span>
<a href="#l6.211"></a><span id="l6.211">                msgIndex++) {</span>
<a href="#l6.212"></a><span id="l6.212" class="difflineminus">-            nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr =</span>
<a href="#l6.213"></a><span id="l6.213" class="difflineminus">-                do_QueryElementAt(m_searchHitHdrs, msgIndex, &amp;rv);</span>
<a href="#l6.214"></a><span id="l6.214" class="difflineminus">-            BREAK_ACTION_IF_FAILURE(rv, &quot;Could not get msgHdr&quot;);</span>
<a href="#l6.215"></a><span id="l6.215" class="difflineminus">-            BREAK_ACTION_IF_FALSE(msgHdr, &quot;Could not get msgHdr&quot;);</span>
<a href="#l6.216"></a><span id="l6.216" class="difflineplus">+            nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr(hitHdrs[msgIndex]);</span>
<a href="#l6.217"></a><span id="l6.217">             uint32_t flags;</span>
<a href="#l6.218"></a><span id="l6.218">             msgHdr-&gt;GetFlags(&amp;flags);</span>
<a href="#l6.219"></a><span id="l6.219">             if (flags &amp; nsMsgMessageFlags::Partial) {</span>
<a href="#l6.220"></a><span id="l6.220">               if (!partialMsgs) {</span>
<a href="#l6.221"></a><span id="l6.221">                 partialMsgs = do_CreateInstance(NS_ARRAY_CONTRACTID);</span>
<a href="#l6.222"></a><span id="l6.222">                 BREAK_ACTION_IF_FALSE(partialMsgs,</span>
<a href="#l6.223"></a><span id="l6.223">                                       &quot;Could not create partialMsgs array&quot;);</span>
<a href="#l6.224"></a><span id="l6.224">               }</span>
<a href="#l6.225"></a><span id="l6.225" class="difflineat">@@ -981,22 +948,17 @@ nsresult nsMsgFilterAfterTheFact::ApplyF</span>
<a href="#l6.226"></a><span id="l6.226">         case nsMsgFilterAction::FetchBodyFromPop3Server: {</span>
<a href="#l6.227"></a><span id="l6.227">           nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localFolder =</span>
<a href="#l6.228"></a><span id="l6.228">               do_QueryInterface(curFolder, &amp;rv);</span>
<a href="#l6.229"></a><span id="l6.229">           BREAK_ACTION_IF_FAILURE(rv, &quot;current folder not local&quot;);</span>
<a href="#l6.230"></a><span id="l6.230">           BREAK_ACTION_IF_FALSE(localFolder, &quot;current folder not local&quot;);</span>
<a href="#l6.231"></a><span id="l6.231">           nsCOMPtr&lt;nsIMutableArray&gt; messages(</span>
<a href="#l6.232"></a><span id="l6.232">               do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l6.233"></a><span id="l6.233">           BREAK_ACTION_IF_FAILURE(rv, &quot;Could not create messages array&quot;);</span>
<a href="#l6.234"></a><span id="l6.234" class="difflineminus">-          for (uint32_t msgIndex = 0; msgIndex &lt; m_searchHits.Length();</span>
<a href="#l6.235"></a><span id="l6.235" class="difflineminus">-               msgIndex++) {</span>
<a href="#l6.236"></a><span id="l6.236" class="difflineminus">-            nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr =</span>
<a href="#l6.237"></a><span id="l6.237" class="difflineminus">-                do_QueryElementAt(m_searchHitHdrs, msgIndex, &amp;rv);</span>
<a href="#l6.238"></a><span id="l6.238" class="difflineminus">-            BREAK_ACTION_IF_FAILURE(rv, &quot;Could not get msgHdr&quot;);</span>
<a href="#l6.239"></a><span id="l6.239" class="difflineminus">-            BREAK_ACTION_IF_FALSE(msgHdr, &quot;Could not get msgHdr&quot;);</span>
<a href="#l6.240"></a><span id="l6.240" class="difflineplus">+          for (auto msgHdr : hitHdrs) {</span>
<a href="#l6.241"></a><span id="l6.241">             uint32_t flags = 0;</span>
<a href="#l6.242"></a><span id="l6.242">             msgHdr-&gt;GetFlags(&amp;flags);</span>
<a href="#l6.243"></a><span id="l6.243">             if (flags &amp; nsMsgMessageFlags::Partial)</span>
<a href="#l6.244"></a><span id="l6.244">               messages-&gt;AppendElement(msgHdr);</span>
<a href="#l6.245"></a><span id="l6.245">           }</span>
<a href="#l6.246"></a><span id="l6.246">           uint32_t msgsToFetch;</span>
<a href="#l6.247"></a><span id="l6.247">           messages-&gt;GetLength(&amp;msgsToFetch);</span>
<a href="#l6.248"></a><span id="l6.248">           if (msgsToFetch &gt; 0) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/base/src/nsMsgDBView.cpp</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgDBView.cpp</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -2858,28 +2858,31 @@ nsresult nsMsgDBView::ApplyCommandToIndi</span>
<a href="#l7.4"></a><span id="l7.4">   // for mark thread read.</span>
<a href="#l7.5"></a><span id="l7.5">   if (command == nsMsgViewCommandType::markThreadRead) {</span>
<a href="#l7.6"></a><span id="l7.6">     for (int32_t index = 0; index &lt; numIndices; index++)</span>
<a href="#l7.7"></a><span id="l7.7">       SetThreadOfMsgReadByIndex(indices[index], imapUids, true);</span>
<a href="#l7.8"></a><span id="l7.8">   } else {</span>
<a href="#l7.9"></a><span id="l7.9">     // Turn the selection into an array of msg hdrs. This may include messages</span>
<a href="#l7.10"></a><span id="l7.10">     // in collapsed threads</span>
<a href="#l7.11"></a><span id="l7.11">     uint32_t length;</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-    nsCOMPtr&lt;nsIMutableArray&gt; messages(</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+    nsCOMPtr&lt;nsIMutableArray&gt; messageArray(</span>
<a href="#l7.14"></a><span id="l7.14">         do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l7.15"></a><span id="l7.15">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineminus">-    rv = GetHeadersFromSelection(indices, numIndices, messages);</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+    rv = GetHeadersFromSelection(indices, numIndices, messageArray);</span>
<a href="#l7.18"></a><span id="l7.18">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineminus">-    messages-&gt;GetLength(&amp;length);</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+    messageArray-&gt;GetLength(&amp;length);</span>
<a href="#l7.21"></a><span id="l7.21"> </span>
<a href="#l7.22"></a><span id="l7.22">     if (thisIsImapFolder) imapUids.SetLength(length);</span>
<a href="#l7.23"></a><span id="l7.23"> </span>
<a href="#l7.24"></a><span id="l7.24" class="difflineplus">+    nsTArray&lt;RefPtr&lt;nsIMsgDBHdr&gt;&gt; messages(length);</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineplus">+    MsgHdrsToTArray(messageArray, messages);</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineplus">+</span>
<a href="#l7.27"></a><span id="l7.27">     for (uint32_t i = 0; i &lt; length; i++) {</span>
<a href="#l7.28"></a><span id="l7.28">       nsMsgKey msgKey;</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineminus">-      nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr = do_QueryElementAt(messages, i);</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineplus">+      nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr(messages[i]);</span>
<a href="#l7.31"></a><span id="l7.31">       msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l7.32"></a><span id="l7.32">       if (thisIsImapFolder) imapUids[i] = msgKey;</span>
<a href="#l7.33"></a><span id="l7.33"> </span>
<a href="#l7.34"></a><span id="l7.34">       switch (command) {</span>
<a href="#l7.35"></a><span id="l7.35">         case nsMsgViewCommandType::junk:</span>
<a href="#l7.36"></a><span id="l7.36">           mNumMessagesRemainingInBatch++;</span>
<a href="#l7.37"></a><span id="l7.37">           mJunkHdrs-&gt;AppendElement(msgHdr);</span>
<a href="#l7.38"></a><span id="l7.38">           rv = SetMsgHdrJunkStatus(junkPlugin.get(), msgHdr,</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineat">@@ -2902,21 +2905,20 @@ nsresult nsMsgDBView::ApplyCommandToIndi</span>
<a href="#l7.40"></a><span id="l7.40">         default:</span>
<a href="#l7.41"></a><span id="l7.41">           NS_ERROR(&quot;unhandled command&quot;);</span>
<a href="#l7.42"></a><span id="l7.42">           break;</span>
<a href="#l7.43"></a><span id="l7.43">       }</span>
<a href="#l7.44"></a><span id="l7.44">     }</span>
<a href="#l7.45"></a><span id="l7.45"> </span>
<a href="#l7.46"></a><span id="l7.46">     switch (command) {</span>
<a href="#l7.47"></a><span id="l7.47">       case nsMsgViewCommandType::toggleMessageRead: {</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineminus">-        nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr = do_QueryElementAt(messages, 0);</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineminus">-        if (!msgHdr) break;</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineplus">+        if (messages.IsEmpty()) break;</span>
<a href="#l7.51"></a><span id="l7.51"> </span>
<a href="#l7.52"></a><span id="l7.52">         uint32_t msgFlags;</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineminus">-        msgHdr-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineplus">+        messages[0]-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l7.55"></a><span id="l7.55">         folder-&gt;MarkMessagesRead(messages,</span>
<a href="#l7.56"></a><span id="l7.56">                                  !(msgFlags &amp; nsMsgMessageFlags::Read));</span>
<a href="#l7.57"></a><span id="l7.57">         break;</span>
<a href="#l7.58"></a><span id="l7.58">       }</span>
<a href="#l7.59"></a><span id="l7.59">       case nsMsgViewCommandType::markMessagesRead:</span>
<a href="#l7.60"></a><span id="l7.60">       case nsMsgViewCommandType::markMessagesUnread:</span>
<a href="#l7.61"></a><span id="l7.61">         folder-&gt;MarkMessagesRead(</span>
<a href="#l7.62"></a><span id="l7.62">             messages, command == nsMsgViewCommandType::markMessagesRead);</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineat">@@ -2933,17 +2935,17 @@ nsresult nsMsgDBView::ApplyCommandToIndi</span>
<a href="#l7.64"></a><span id="l7.64">     // Provide junk-related batch notifications.</span>
<a href="#l7.65"></a><span id="l7.65">     if (command == nsMsgViewCommandType::junk ||</span>
<a href="#l7.66"></a><span id="l7.66">         command == nsMsgViewCommandType::unjunk) {</span>
<a href="#l7.67"></a><span id="l7.67">       nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(</span>
<a href="#l7.68"></a><span id="l7.68">           do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l7.69"></a><span id="l7.69"> </span>
<a href="#l7.70"></a><span id="l7.70">       if (notifier)</span>
<a href="#l7.71"></a><span id="l7.71">         notifier-&gt;NotifyItemEvent(</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineminus">-            messages, NS_LITERAL_CSTRING(&quot;JunkStatusChanged&quot;), nullptr,</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineplus">+            messageArray, NS_LITERAL_CSTRING(&quot;JunkStatusChanged&quot;), nullptr,</span>
<a href="#l7.74"></a><span id="l7.74">             (command == nsMsgViewCommandType::junk)</span>
<a href="#l7.75"></a><span id="l7.75">                 ? NS_LITERAL_CSTRING(&quot;junk&quot;)</span>
<a href="#l7.76"></a><span id="l7.76">                 : NS_LITERAL_CSTRING(&quot;notjunk&quot;));</span>
<a href="#l7.77"></a><span id="l7.77">     }</span>
<a href="#l7.78"></a><span id="l7.78">   }</span>
<a href="#l7.79"></a><span id="l7.79"> </span>
<a href="#l7.80"></a><span id="l7.80">   folder-&gt;EnableNotifications(nsIMsgFolder::allMessageCountNotifications, true);</span>
<a href="#l7.81"></a><span id="l7.81"> </span>
<a href="#l7.82"></a><span id="l7.82" class="difflineat">@@ -3381,17 +3383,19 @@ nsresult nsMsgDBView::PerformActionsOnJu</span>
<a href="#l7.83"></a><span id="l7.83">     //    automatic classification by the bayesian filter (see code for local</span>
<a href="#l7.84"></a><span id="l7.84">     //    mail folders and for imap mail folders). The server-specific</span>
<a href="#l7.85"></a><span id="l7.85">     //    markAsReadOnSpam pref only applies to the latter, the former is</span>
<a href="#l7.86"></a><span id="l7.86">     //    controlled by &quot;mailnews.ui.junk.manualMarkAsJunkMarksRead&quot;.</span>
<a href="#l7.87"></a><span id="l7.87">     // 2. Even though move/delete on manual mark may be</span>
<a href="#l7.88"></a><span id="l7.88">     //    turned off, we might still need to mark as read.</span>
<a href="#l7.89"></a><span id="l7.89"> </span>
<a href="#l7.90"></a><span id="l7.90">     NoteStartChange(nsMsgViewNotificationCode::none, 0, 0);</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineminus">-    rv = srcFolder-&gt;MarkMessagesRead(mJunkHdrs, msgsAreJunk);</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineplus">+    nsTArray&lt;RefPtr&lt;nsIMsgDBHdr&gt;&gt; tmpHdrs;</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineplus">+    MsgHdrsToTArray(mJunkHdrs, tmpHdrs);</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineplus">+    rv = srcFolder-&gt;MarkMessagesRead(tmpHdrs, msgsAreJunk);</span>
<a href="#l7.95"></a><span id="l7.95">     NoteEndChange(nsMsgViewNotificationCode::none, 0, 0);</span>
<a href="#l7.96"></a><span id="l7.96">     NS_ASSERTION(NS_SUCCEEDED(rv),</span>
<a href="#l7.97"></a><span id="l7.97">                  &quot;marking marked-as-junk messages as read failed&quot;);</span>
<a href="#l7.98"></a><span id="l7.98">   }</span>
<a href="#l7.99"></a><span id="l7.99"> </span>
<a href="#l7.100"></a><span id="l7.100">   if (moveMessages) {</span>
<a href="#l7.101"></a><span id="l7.101">     // Check if one of the messages to be junked is actually selected.</span>
<a href="#l7.102"></a><span id="l7.102">     // If more than one message being junked, one must be selected.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/base/test/unit/test_bug428427.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_bug428427.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -85,30 +85,20 @@ function setupVirtualFolder() {</span>
<a href="#l8.4"></a><span id="l8.4">     Ci.nsIMutableArray</span>
<a href="#l8.5"></a><span id="l8.5">   );</span>
<a href="#l8.6"></a><span id="l8.6">   for (var i = 0; i &lt;= 3; i++) {</span>
<a href="#l8.7"></a><span id="l8.7">     messages0to3.appendElement(hdrs[i]);</span>
<a href="#l8.8"></a><span id="l8.8">   }</span>
<a href="#l8.9"></a><span id="l8.9">   localAccountUtils.inboxFolder.addKeywordsToMessages(messages0to3, tag1);</span>
<a href="#l8.10"></a><span id="l8.10"> </span>
<a href="#l8.11"></a><span id="l8.11">   // set 3 messages unread, 2 messages read</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-  var messages0to2 = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-    Ci.nsIMutableArray</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineminus">-  );</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineminus">-  for (i = 0; i &lt;= 2; i++) {</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineminus">-    messages0to2.appendElement(hdrs[i]);</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineminus">-  }</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+  let messages0to2 = [hdrs[0], hdrs[1], hdrs[2]];</span>
<a href="#l8.19"></a><span id="l8.19">   localAccountUtils.inboxFolder.markMessagesRead(messages0to2, false);</span>
<a href="#l8.20"></a><span id="l8.20"> </span>
<a href="#l8.21"></a><span id="l8.21" class="difflineminus">-  var messages3to4 = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineminus">-    Ci.nsIMutableArray</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineminus">-  );</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineminus">-  for (i = 3; i &lt;= 4; i++) {</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineminus">-    messages3to4.appendElement(hdrs[i]);</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineminus">-  }</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineplus">+  let messages3to4 = [hdrs[3], hdrs[4]];</span>
<a href="#l8.28"></a><span id="l8.28">   localAccountUtils.inboxFolder.markMessagesRead(messages3to4, true);</span>
<a href="#l8.29"></a><span id="l8.29"> </span>
<a href="#l8.30"></a><span id="l8.30">   // search will look for tag tag1 in the inbox folder</span>
<a href="#l8.31"></a><span id="l8.31">   var searchTerm = makeSearchTerm(</span>
<a href="#l8.32"></a><span id="l8.32">     localAccountUtils.inboxFolder,</span>
<a href="#l8.33"></a><span id="l8.33">     tag1,</span>
<a href="#l8.34"></a><span id="l8.34">     Ci.nsMsgSearchAttrib.Keywords,</span>
<a href="#l8.35"></a><span id="l8.35">     Ci.nsMsgSearchOp.Contains</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineat">@@ -172,19 +162,17 @@ function testVirtualFolder() {</span>
<a href="#l8.37"></a><span id="l8.37"> </span>
<a href="#l8.38"></a><span id="l8.38">   // total messages matching search</span>
<a href="#l8.39"></a><span id="l8.39">   Assert.equal(4, virtualFolder.getTotalMessages(false));</span>
<a href="#l8.40"></a><span id="l8.40"> </span>
<a href="#l8.41"></a><span id="l8.41">   // total unread messages in search</span>
<a href="#l8.42"></a><span id="l8.42">   Assert.equal(3, virtualFolder.getNumUnread(false));</span>
<a href="#l8.43"></a><span id="l8.43"> </span>
<a href="#l8.44"></a><span id="l8.44">   // change unread of one item in search to decrease count</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineminus">-  var message0 = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineminus">-  message0.appendElement(hdrs[0]);</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineminus">-  localAccountUtils.inboxFolder.markMessagesRead(message0, true);</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineplus">+  localAccountUtils.inboxFolder.markMessagesRead([hdrs[0]], true);</span>
<a href="#l8.49"></a><span id="l8.49">   virtualFolder.updateSummaryTotals(true);</span>
<a href="#l8.50"></a><span id="l8.50"> </span>
<a href="#l8.51"></a><span id="l8.51">   Assert.equal(2, virtualFolder.getNumUnread(false));</span>
<a href="#l8.52"></a><span id="l8.52"> </span>
<a href="#l8.53"></a><span id="l8.53">   // failures fixed in this bug</span>
<a href="#l8.54"></a><span id="l8.54"> </span>
<a href="#l8.55"></a><span id="l8.55">   // remove tag from one item to decrease count</span>
<a href="#l8.56"></a><span id="l8.56">   var message1 = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/base/util/nsMsgDBFolder.cpp</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgDBFolder.cpp</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -4280,90 +4280,65 @@ NS_IMETHODIMP nsMsgDBFolder::GetSummaryF</span>
<a href="#l9.4"></a><span id="l9.4">   rv = newSummaryLocation-&gt;SetLeafName(fileName);</span>
<a href="#l9.5"></a><span id="l9.5">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.6"></a><span id="l9.6"> </span>
<a href="#l9.7"></a><span id="l9.7">   newSummaryLocation.forget(aSummaryFile);</span>
<a href="#l9.8"></a><span id="l9.8">   return NS_OK;</span>
<a href="#l9.9"></a><span id="l9.9"> }</span>
<a href="#l9.10"></a><span id="l9.10"> </span>
<a href="#l9.11"></a><span id="l9.11"> NS_IMETHODIMP</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-nsMsgDBFolder::MarkMessagesRead(nsIArray *messages, bool markRead) {</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-  uint32_t count;</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineminus">-  nsresult rv;</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineminus">-</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineminus">-  rv = messages-&gt;GetLength(&amp;count);</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineminus">-</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineminus">-  for (uint32_t i = 0; i &lt; count; i++) {</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineminus">-    nsCOMPtr&lt;nsIMsgDBHdr&gt; message = do_QueryElementAt(messages, i, &amp;rv);</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineminus">-    if (message) rv = message-&gt;MarkRead(markRead);</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineplus">+nsMsgDBFolder::MarkMessagesRead(const nsTArray&lt;RefPtr&lt;nsIMsgDBHdr&gt;&gt; &amp;messages,</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineplus">+                                bool markRead) {</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineplus">+  for (auto message : messages) {</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineplus">+    nsresult rv = message-&gt;MarkRead(markRead);</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.28"></a><span id="l9.28">   }</span>
<a href="#l9.29"></a><span id="l9.29">   return NS_OK;</span>
<a href="#l9.30"></a><span id="l9.30"> }</span>
<a href="#l9.31"></a><span id="l9.31"> </span>
<a href="#l9.32"></a><span id="l9.32"> NS_IMETHODIMP</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineminus">-nsMsgDBFolder::MarkMessagesFlagged(nsIArray *messages, bool markFlagged) {</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineminus">-  uint32_t count;</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineminus">-  nsresult rv;</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineminus">-</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineminus">-  rv = messages-&gt;GetLength(&amp;count);</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineminus">-</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineminus">-  for (uint32_t i = 0; i &lt; count; i++) {</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineminus">-    nsCOMPtr&lt;nsIMsgDBHdr&gt; message = do_QueryElementAt(messages, i, &amp;rv);</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineminus">-    if (message) rv = message-&gt;MarkFlagged(markFlagged);</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineplus">+nsMsgDBFolder::MarkMessagesFlagged(</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineplus">+    const nsTArray&lt;RefPtr&lt;nsIMsgDBHdr&gt;&gt; &amp;messages, bool markFlagged) {</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineplus">+  for (auto message : messages) {</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineplus">+    nsresult rv = message-&gt;MarkFlagged(markFlagged);</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.49"></a><span id="l9.49">   }</span>
<a href="#l9.50"></a><span id="l9.50">   return NS_OK;</span>
<a href="#l9.51"></a><span id="l9.51"> }</span>
<a href="#l9.52"></a><span id="l9.52"> </span>
<a href="#l9.53"></a><span id="l9.53"> NS_IMETHODIMP</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineminus">-nsMsgDBFolder::SetLabelForMessages(nsIArray *aMessages,</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineminus">-                                   nsMsgLabelValue aLabel) {</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineminus">-  NS_ENSURE_ARG(aMessages);</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineplus">+nsMsgDBFolder::SetLabelForMessages(</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineplus">+    const nsTArray&lt;RefPtr&lt;nsIMsgDBHdr&gt;&gt; &amp;aMessages, nsMsgLabelValue aLabel) {</span>
<a href="#l9.59"></a><span id="l9.59">   GetDatabase();</span>
<a href="#l9.60"></a><span id="l9.60">   if (mDatabase) {</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineminus">-    uint32_t count;</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineminus">-    nsresult rv = aMessages-&gt;GetLength(&amp;count);</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineminus">-    for (uint32_t i = 0; i &lt; count; i++) {</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineplus">+    for (auto message : aMessages) {</span>
<a href="#l9.66"></a><span id="l9.66">       nsMsgKey msgKey;</span>
<a href="#l9.67"></a><span id="l9.67" class="difflineminus">-      nsCOMPtr&lt;nsIMsgDBHdr&gt; message = do_QueryElementAt(aMessages, i, &amp;rv);</span>
<a href="#l9.68"></a><span id="l9.68" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.69"></a><span id="l9.69">       (void)message-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineminus">-      rv = mDatabase-&gt;SetLabel(msgKey, aLabel);</span>
<a href="#l9.71"></a><span id="l9.71" class="difflineplus">+      nsresult rv = mDatabase-&gt;SetLabel(msgKey, aLabel);</span>
<a href="#l9.72"></a><span id="l9.72">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.73"></a><span id="l9.73">     }</span>
<a href="#l9.74"></a><span id="l9.74">   }</span>
<a href="#l9.75"></a><span id="l9.75">   return NS_OK;</span>
<a href="#l9.76"></a><span id="l9.76"> }</span>
<a href="#l9.77"></a><span id="l9.77"> </span>
<a href="#l9.78"></a><span id="l9.78"> NS_IMETHODIMP</span>
<a href="#l9.79"></a><span id="l9.79" class="difflineminus">-nsMsgDBFolder::SetJunkScoreForMessages(nsIArray *aMessages,</span>
<a href="#l9.80"></a><span id="l9.80" class="difflineminus">-                                       const nsACString &amp;junkScore) {</span>
<a href="#l9.81"></a><span id="l9.81" class="difflineminus">-  NS_ENSURE_ARG(aMessages);</span>
<a href="#l9.82"></a><span id="l9.82" class="difflineminus">-  nsresult rv = NS_OK;</span>
<a href="#l9.83"></a><span id="l9.83" class="difflineplus">+nsMsgDBFolder::SetJunkScoreForMessages(</span>
<a href="#l9.84"></a><span id="l9.84" class="difflineplus">+    const nsTArray&lt;RefPtr&lt;nsIMsgDBHdr&gt;&gt; &amp;aMessages,</span>
<a href="#l9.85"></a><span id="l9.85" class="difflineplus">+    const nsACString &amp;junkScore) {</span>
<a href="#l9.86"></a><span id="l9.86">   GetDatabase();</span>
<a href="#l9.87"></a><span id="l9.87">   if (mDatabase) {</span>
<a href="#l9.88"></a><span id="l9.88" class="difflineminus">-    uint32_t count;</span>
<a href="#l9.89"></a><span id="l9.89" class="difflineminus">-    nsresult rv = aMessages-&gt;GetLength(&amp;count);</span>
<a href="#l9.90"></a><span id="l9.90" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.91"></a><span id="l9.91" class="difflineminus">-</span>
<a href="#l9.92"></a><span id="l9.92" class="difflineminus">-    for (uint32_t i = 0; i &lt; count; i++) {</span>
<a href="#l9.93"></a><span id="l9.93" class="difflineplus">+    for (auto message : aMessages) {</span>
<a href="#l9.94"></a><span id="l9.94">       nsMsgKey msgKey;</span>
<a href="#l9.95"></a><span id="l9.95" class="difflineminus">-      nsCOMPtr&lt;nsIMsgDBHdr&gt; message = do_QueryElementAt(aMessages, i, &amp;rv);</span>
<a href="#l9.96"></a><span id="l9.96" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.97"></a><span id="l9.97">       (void)message-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l9.98"></a><span id="l9.98">       mDatabase-&gt;SetStringProperty(msgKey, &quot;junkscore&quot;,</span>
<a href="#l9.99"></a><span id="l9.99">                                    nsCString(junkScore).get());</span>
<a href="#l9.100"></a><span id="l9.100">       mDatabase-&gt;SetStringProperty(msgKey, &quot;junkscoreorigin&quot;, &quot;filter&quot;);</span>
<a href="#l9.101"></a><span id="l9.101">     }</span>
<a href="#l9.102"></a><span id="l9.102">   }</span>
<a href="#l9.103"></a><span id="l9.103" class="difflineminus">-  return rv;</span>
<a href="#l9.104"></a><span id="l9.104" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.105"></a><span id="l9.105"> }</span>
<a href="#l9.106"></a><span id="l9.106"> </span>
<a href="#l9.107"></a><span id="l9.107"> NS_IMETHODIMP</span>
<a href="#l9.108"></a><span id="l9.108"> nsMsgDBFolder::ApplyRetentionSettings() { return ApplyRetentionSettings(true); }</span>
<a href="#l9.109"></a><span id="l9.109"> </span>
<a href="#l9.110"></a><span id="l9.110"> nsresult nsMsgDBFolder::ApplyRetentionSettings(bool deleteViaFolder) {</span>
<a href="#l9.111"></a><span id="l9.111">   if (mFlags &amp; nsMsgFolderFlags::Virtual)  // ignore virtual folders.</span>
<a href="#l9.112"></a><span id="l9.112">     return NS_OK;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/base/util/nsMsgReadStateTxn.cpp</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgReadStateTxn.cpp</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -26,25 +26,19 @@ nsresult nsMsgReadStateTxn::Init(nsIMsgF</span>
<a href="#l10.4"></a><span id="l10.4"> NS_IMETHODIMP</span>
<a href="#l10.5"></a><span id="l10.5"> nsMsgReadStateTxn::UndoTransaction() { return MarkMessages(false); }</span>
<a href="#l10.6"></a><span id="l10.6"> </span>
<a href="#l10.7"></a><span id="l10.7"> NS_IMETHODIMP</span>
<a href="#l10.8"></a><span id="l10.8"> nsMsgReadStateTxn::RedoTransaction() { return MarkMessages(true); }</span>
<a href="#l10.9"></a><span id="l10.9"> </span>
<a href="#l10.10"></a><span id="l10.10"> NS_IMETHODIMP</span>
<a href="#l10.11"></a><span id="l10.11"> nsMsgReadStateTxn::MarkMessages(bool aAsRead) {</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-  nsresult rv;</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; messageArray =</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineminus">-      do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineminus">-</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineminus">-  uint32_t length = mMarkedMessages.Length();</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineminus">-  for (uint32_t i = 0; i &lt; length; i++) {</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineplus">+  nsTArray&lt;RefPtr&lt;nsIMsgDBHdr&gt;&gt; messages(mMarkedMessages.Length());</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineplus">+  for (auto msgKey : mMarkedMessages) {</span>
<a href="#l10.21"></a><span id="l10.21">     nsCOMPtr&lt;nsIMsgDBHdr&gt; curMsgHdr;</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineminus">-    rv = mParentFolder-&gt;GetMessageHeader(mMarkedMessages[i],</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineminus">-                                         getter_AddRefs(curMsgHdr));</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineplus">+    nsresult rv =</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineplus">+        mParentFolder-&gt;GetMessageHeader(msgKey, getter_AddRefs(curMsgHdr));</span>
<a href="#l10.26"></a><span id="l10.26">     if (NS_SUCCEEDED(rv) &amp;&amp; curMsgHdr) {</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineminus">-      messageArray-&gt;AppendElement(curMsgHdr);</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineplus">+      messages.AppendElement(curMsgHdr);</span>
<a href="#l10.29"></a><span id="l10.29">     }</span>
<a href="#l10.30"></a><span id="l10.30">   }</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineminus">-</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineminus">-  return mParentFolder-&gt;MarkMessagesRead(messageArray, aAsRead);</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineplus">+  return mParentFolder-&gt;MarkMessagesRead(messages, aAsRead);</span>
<a href="#l10.34"></a><span id="l10.34"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -1694,42 +1694,41 @@ nsImapMailFolder::AddMessageDispositionS</span>
<a href="#l11.4"></a><span id="l11.4">       StoreImapFlags(kImapMsgAnsweredFlag, true, {msgKey}, nullptr);</span>
<a href="#l11.5"></a><span id="l11.5">     else if (aDispositionFlag == nsIMsgFolder::nsMsgDispositionState_Forwarded)</span>
<a href="#l11.6"></a><span id="l11.6">       StoreImapFlags(kImapMsgForwardedFlag, true, {msgKey}, nullptr);</span>
<a href="#l11.7"></a><span id="l11.7">   }</span>
<a href="#l11.8"></a><span id="l11.8">   return NS_OK;</span>
<a href="#l11.9"></a><span id="l11.9"> }</span>
<a href="#l11.10"></a><span id="l11.10"> </span>
<a href="#l11.11"></a><span id="l11.11"> NS_IMETHODIMP</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-nsImapMailFolder::MarkMessagesRead(nsIArray *messages, bool markRead) {</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+nsImapMailFolder::MarkMessagesRead(</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+    const nsTArray&lt;RefPtr&lt;nsIMsgDBHdr&gt;&gt; &amp;messages, bool markRead) {</span>
<a href="#l11.15"></a><span id="l11.15">   // tell the folder to do it, which will mark them read in the db.</span>
<a href="#l11.16"></a><span id="l11.16">   nsresult rv = nsMsgDBFolder::MarkMessagesRead(messages, markRead);</span>
<a href="#l11.17"></a><span id="l11.17">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l11.18"></a><span id="l11.18">     nsAutoCString messageIds;</span>
<a href="#l11.19"></a><span id="l11.19">     nsTArray&lt;nsMsgKey&gt; keysToMarkRead;</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineminus">-    rv = BuildIdsAndKeyArray(messages, messageIds, keysToMarkRead);</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineplus">+    rv = BuildIdsAndKeyArray2(messages, messageIds, keysToMarkRead);</span>
<a href="#l11.22"></a><span id="l11.22">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.23"></a><span id="l11.23"> </span>
<a href="#l11.24"></a><span id="l11.24">     StoreImapFlags(kImapMsgSeenFlag, markRead, keysToMarkRead, nullptr);</span>
<a href="#l11.25"></a><span id="l11.25">     rv = GetDatabase();</span>
<a href="#l11.26"></a><span id="l11.26">     if (NS_SUCCEEDED(rv)) mDatabase-&gt;Commit(nsMsgDBCommitType::kLargeCommit);</span>
<a href="#l11.27"></a><span id="l11.27">   }</span>
<a href="#l11.28"></a><span id="l11.28">   return rv;</span>
<a href="#l11.29"></a><span id="l11.29"> }</span>
<a href="#l11.30"></a><span id="l11.30"> </span>
<a href="#l11.31"></a><span id="l11.31"> NS_IMETHODIMP</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineminus">-nsImapMailFolder::SetLabelForMessages(nsIArray *aMessages,</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineminus">-                                      nsMsgLabelValue aLabel) {</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineminus">-  NS_ENSURE_ARG(aMessages);</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineminus">-</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineplus">+nsImapMailFolder::SetLabelForMessages(</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineplus">+    const nsTArray&lt;RefPtr&lt;nsIMsgDBHdr&gt;&gt; &amp;aMessages, nsMsgLabelValue aLabel) {</span>
<a href="#l11.38"></a><span id="l11.38">   nsresult rv = nsMsgDBFolder::SetLabelForMessages(aMessages, aLabel);</span>
<a href="#l11.39"></a><span id="l11.39">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l11.40"></a><span id="l11.40">     nsAutoCString messageIds;</span>
<a href="#l11.41"></a><span id="l11.41">     nsTArray&lt;nsMsgKey&gt; keysToLabel;</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineminus">-    nsresult rv = BuildIdsAndKeyArray(aMessages, messageIds, keysToLabel);</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineplus">+    nsresult rv = BuildIdsAndKeyArray2(aMessages, messageIds, keysToLabel);</span>
<a href="#l11.44"></a><span id="l11.44">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.45"></a><span id="l11.45">     StoreImapFlags((aLabel &lt;&lt; 9), true, keysToLabel, nullptr);</span>
<a href="#l11.46"></a><span id="l11.46">     rv = GetDatabase();</span>
<a href="#l11.47"></a><span id="l11.47">     if (NS_SUCCEEDED(rv)) mDatabase-&gt;Commit(nsMsgDBCommitType::kLargeCommit);</span>
<a href="#l11.48"></a><span id="l11.48">   }</span>
<a href="#l11.49"></a><span id="l11.49">   return rv;</span>
<a href="#l11.50"></a><span id="l11.50"> }</span>
<a href="#l11.51"></a><span id="l11.51"> </span>
<a href="#l11.52"></a><span id="l11.52" class="difflineat">@@ -1821,24 +1820,25 @@ NS_IMETHODIMP nsImapMailFolder::WriteToF</span>
<a href="#l11.53"></a><span id="l11.53">     element-&gt;SetInt32Property(&quot;lastSyncTimeInSec&quot;,</span>
<a href="#l11.54"></a><span id="l11.54">                               (int32_t)(lastSyncTime / PR_USEC_PER_SEC));</span>
<a href="#l11.55"></a><span id="l11.55">   }</span>
<a href="#l11.56"></a><span id="l11.56"> </span>
<a href="#l11.57"></a><span id="l11.57">   return rv;</span>
<a href="#l11.58"></a><span id="l11.58"> }</span>
<a href="#l11.59"></a><span id="l11.59"> </span>
<a href="#l11.60"></a><span id="l11.60"> NS_IMETHODIMP</span>
<a href="#l11.61"></a><span id="l11.61" class="difflineminus">-nsImapMailFolder::MarkMessagesFlagged(nsIArray *messages, bool markFlagged) {</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineplus">+nsImapMailFolder::MarkMessagesFlagged(</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineplus">+    const nsTArray&lt;RefPtr&lt;nsIMsgDBHdr&gt;&gt; &amp;messages, bool markFlagged) {</span>
<a href="#l11.64"></a><span id="l11.64">   nsresult rv;</span>
<a href="#l11.65"></a><span id="l11.65">   // tell the folder to do it, which will mark them read in the db.</span>
<a href="#l11.66"></a><span id="l11.66">   rv = nsMsgDBFolder::MarkMessagesFlagged(messages, markFlagged);</span>
<a href="#l11.67"></a><span id="l11.67">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l11.68"></a><span id="l11.68">     nsAutoCString messageIds;</span>
<a href="#l11.69"></a><span id="l11.69">     nsTArray&lt;nsMsgKey&gt; keysToMarkFlagged;</span>
<a href="#l11.70"></a><span id="l11.70" class="difflineminus">-    rv = BuildIdsAndKeyArray(messages, messageIds, keysToMarkFlagged);</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineplus">+    rv = BuildIdsAndKeyArray2(messages, messageIds, keysToMarkFlagged);</span>
<a href="#l11.72"></a><span id="l11.72">     if (NS_FAILED(rv)) return rv;</span>
<a href="#l11.73"></a><span id="l11.73">     rv = StoreImapFlags(kImapMsgFlaggedFlag, markFlagged, keysToMarkFlagged,</span>
<a href="#l11.74"></a><span id="l11.74">                         nullptr);</span>
<a href="#l11.75"></a><span id="l11.75">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.76"></a><span id="l11.76">     rv = GetDatabase();</span>
<a href="#l11.77"></a><span id="l11.77">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.78"></a><span id="l11.78">     mDatabase-&gt;Commit(nsMsgDBCommitType::kLargeCommit);</span>
<a href="#l11.79"></a><span id="l11.79">   }</span>
<a href="#l11.80"></a><span id="l11.80" class="difflineat">@@ -1933,16 +1933,32 @@ nsImapMailFolder::GetDBFolderInfoAndDB(n</span>
<a href="#l11.81"></a><span id="l11.81">     nsMsgKey key;</span>
<a href="#l11.82"></a><span id="l11.82">     nsCOMPtr&lt;nsIMsgDBHdr&gt; msgDBHdr = do_QueryElementAt(messages, i, &amp;rv);</span>
<a href="#l11.83"></a><span id="l11.83">     if (msgDBHdr) rv = msgDBHdr-&gt;GetMessageKey(&amp;key);</span>
<a href="#l11.84"></a><span id="l11.84">     if (NS_SUCCEEDED(rv)) keyArray.AppendElement(key);</span>
<a href="#l11.85"></a><span id="l11.85">   }</span>
<a href="#l11.86"></a><span id="l11.86">   return AllocateUidStringFromKeys(keyArray, msgIds);</span>
<a href="#l11.87"></a><span id="l11.87"> }</span>
<a href="#l11.88"></a><span id="l11.88"> </span>
<a href="#l11.89"></a><span id="l11.89" class="difflineplus">+// Stopgap during nsIArray removal. To be renamed to BuildIdsAndKeyArray().</span>
<a href="#l11.90"></a><span id="l11.90" class="difflineplus">+// (see Bug 1612239)</span>
<a href="#l11.91"></a><span id="l11.91" class="difflineplus">+/* static */ nsresult nsImapMailFolder::BuildIdsAndKeyArray2(</span>
<a href="#l11.92"></a><span id="l11.92" class="difflineplus">+    const nsTArray&lt;RefPtr&lt;nsIMsgDBHdr&gt;&gt; &amp;messages, nsCString &amp;msgIds,</span>
<a href="#l11.93"></a><span id="l11.93" class="difflineplus">+    nsTArray&lt;nsMsgKey&gt; &amp;keyArray) {</span>
<a href="#l11.94"></a><span id="l11.94" class="difflineplus">+  keyArray.Clear();</span>
<a href="#l11.95"></a><span id="l11.95" class="difflineplus">+  keyArray.SetCapacity(messages.Length());</span>
<a href="#l11.96"></a><span id="l11.96" class="difflineplus">+  // build up message keys.</span>
<a href="#l11.97"></a><span id="l11.97" class="difflineplus">+  for (auto msgDBHdr : messages) {</span>
<a href="#l11.98"></a><span id="l11.98" class="difflineplus">+    nsMsgKey key;</span>
<a href="#l11.99"></a><span id="l11.99" class="difflineplus">+    nsresult rv = msgDBHdr-&gt;GetMessageKey(&amp;key);</span>
<a href="#l11.100"></a><span id="l11.100" class="difflineplus">+    if (NS_SUCCEEDED(rv)) keyArray.AppendElement(key);</span>
<a href="#l11.101"></a><span id="l11.101" class="difflineplus">+  }</span>
<a href="#l11.102"></a><span id="l11.102" class="difflineplus">+  return AllocateUidStringFromKeys(keyArray, msgIds);</span>
<a href="#l11.103"></a><span id="l11.103" class="difflineplus">+}</span>
<a href="#l11.104"></a><span id="l11.104" class="difflineplus">+</span>
<a href="#l11.105"></a><span id="l11.105"> /* static */ nsresult nsImapMailFolder::AllocateUidStringFromKeys(</span>
<a href="#l11.106"></a><span id="l11.106">     const nsTArray&lt;nsMsgKey&gt; &amp;keys, nsCString &amp;msgIds) {</span>
<a href="#l11.107"></a><span id="l11.107">   if (keys.IsEmpty()) return NS_ERROR_INVALID_ARG;</span>
<a href="#l11.108"></a><span id="l11.108">   nsresult rv = NS_OK;</span>
<a href="#l11.109"></a><span id="l11.109">   uint32_t startSequence;</span>
<a href="#l11.110"></a><span id="l11.110">   startSequence = keys[0];</span>
<a href="#l11.111"></a><span id="l11.111">   uint32_t curSequenceEnd = startSequence;</span>
<a href="#l11.112"></a><span id="l11.112">   uint32_t total = keys.Length();</span>
<a href="#l11.113"></a><span id="l11.113" class="difflineat">@@ -8386,25 +8402,24 @@ nsresult nsImapMailFolder::PlaybackCoale</span>
<a href="#l11.114"></a><span id="l11.114">                           *nonJunkKeysToClassify, nullptr);</span>
<a href="#l11.115"></a><span id="l11.115">     nonJunkKeysToClassify-&gt;Clear();</span>
<a href="#l11.116"></a><span id="l11.116">     return m_moveCoalescer-&gt;PlaybackMoves(ShowPreviewText());</span>
<a href="#l11.117"></a><span id="l11.117">   }</span>
<a href="#l11.118"></a><span id="l11.118">   return NS_OK;  // must not be any coalesced operations</span>
<a href="#l11.119"></a><span id="l11.119"> }</span>
<a href="#l11.120"></a><span id="l11.120"> </span>
<a href="#l11.121"></a><span id="l11.121"> NS_IMETHODIMP</span>
<a href="#l11.122"></a><span id="l11.122" class="difflineminus">-nsImapMailFolder::SetJunkScoreForMessages(nsIArray *aMessages,</span>
<a href="#l11.123"></a><span id="l11.123" class="difflineminus">-                                          const nsACString &amp;aJunkScore) {</span>
<a href="#l11.124"></a><span id="l11.124" class="difflineminus">-  NS_ENSURE_ARG(aMessages);</span>
<a href="#l11.125"></a><span id="l11.125" class="difflineminus">-</span>
<a href="#l11.126"></a><span id="l11.126" class="difflineplus">+nsImapMailFolder::SetJunkScoreForMessages(</span>
<a href="#l11.127"></a><span id="l11.127" class="difflineplus">+    const nsTArray&lt;RefPtr&lt;nsIMsgDBHdr&gt;&gt; &amp;aMessages,</span>
<a href="#l11.128"></a><span id="l11.128" class="difflineplus">+    const nsACString &amp;aJunkScore) {</span>
<a href="#l11.129"></a><span id="l11.129">   nsresult rv = nsMsgDBFolder::SetJunkScoreForMessages(aMessages, aJunkScore);</span>
<a href="#l11.130"></a><span id="l11.130">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l11.131"></a><span id="l11.131">     nsAutoCString messageIds;</span>
<a href="#l11.132"></a><span id="l11.132">     nsTArray&lt;nsMsgKey&gt; keys;</span>
<a href="#l11.133"></a><span id="l11.133" class="difflineminus">-    nsresult rv = BuildIdsAndKeyArray(aMessages, messageIds, keys);</span>
<a href="#l11.134"></a><span id="l11.134" class="difflineplus">+    nsresult rv = BuildIdsAndKeyArray2(aMessages, messageIds, keys);</span>
<a href="#l11.135"></a><span id="l11.135">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.136"></a><span id="l11.136">     StoreCustomKeywords(</span>
<a href="#l11.137"></a><span id="l11.137">         nullptr,</span>
<a href="#l11.138"></a><span id="l11.138">         aJunkScore.EqualsLiteral(&quot;0&quot;) ? NS_LITERAL_CSTRING(&quot;NonJunk&quot;)</span>
<a href="#l11.139"></a><span id="l11.139">                                       : NS_LITERAL_CSTRING(&quot;Junk&quot;),</span>
<a href="#l11.140"></a><span id="l11.140">         aJunkScore.EqualsLiteral(&quot;0&quot;) ? NS_LITERAL_CSTRING(&quot;Junk&quot;)</span>
<a href="#l11.141"></a><span id="l11.141">                                       : NS_LITERAL_CSTRING(&quot;NonJunk&quot;),</span>
<a href="#l11.142"></a><span id="l11.142">         keys, nullptr);</span>
<a href="#l11.143"></a><span id="l11.143" class="difflineat">@@ -8450,22 +8465,17 @@ nsImapMailFolder::OnMessageClassified(co</span>
<a href="#l11.144"></a><span id="l11.144">       if (aClassification == nsIJunkMailPlugin::JUNK) {</span>
<a href="#l11.145"></a><span id="l11.145">         nsCOMPtr&lt;nsISpamSettings&gt; spamSettings;</span>
<a href="#l11.146"></a><span id="l11.146">         rv = server-&gt;GetSpamSettings(getter_AddRefs(spamSettings));</span>
<a href="#l11.147"></a><span id="l11.147">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.148"></a><span id="l11.148"> </span>
<a href="#l11.149"></a><span id="l11.149">         bool markAsReadOnSpam;</span>
<a href="#l11.150"></a><span id="l11.150">         (void)spamSettings-&gt;GetMarkAsReadOnSpam(&amp;markAsReadOnSpam);</span>
<a href="#l11.151"></a><span id="l11.151">         if (markAsReadOnSpam) {</span>
<a href="#l11.152"></a><span id="l11.152" class="difflineminus">-          if (!m_junkMessagesToMarkAsRead) {</span>
<a href="#l11.153"></a><span id="l11.153" class="difflineminus">-            m_junkMessagesToMarkAsRead =</span>
<a href="#l11.154"></a><span id="l11.154" class="difflineminus">-                do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l11.155"></a><span id="l11.155" class="difflineminus">-            NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.156"></a><span id="l11.156" class="difflineminus">-          }</span>
<a href="#l11.157"></a><span id="l11.157" class="difflineminus">-          m_junkMessagesToMarkAsRead-&gt;AppendElement(msgHdr);</span>
<a href="#l11.158"></a><span id="l11.158" class="difflineplus">+          m_junkMessagesToMarkAsRead.AppendElement(msgHdr);</span>
<a href="#l11.159"></a><span id="l11.159">         }</span>
<a href="#l11.160"></a><span id="l11.160"> </span>
<a href="#l11.161"></a><span id="l11.161">         bool willMoveMessage = false;</span>
<a href="#l11.162"></a><span id="l11.162"> </span>
<a href="#l11.163"></a><span id="l11.163">         // don't do the move when we are opening up</span>
<a href="#l11.164"></a><span id="l11.164">         // the junk mail folder or the trash folder</span>
<a href="#l11.165"></a><span id="l11.165">         // or when manually classifying messages in those folders</span>
<a href="#l11.166"></a><span id="l11.166">         if (!(mFlags &amp; nsMsgFolderFlags::Junk ||</span>
<a href="#l11.167"></a><span id="l11.167" class="difflineat">@@ -8509,24 +8519,20 @@ nsImapMailFolder::OnMessageClassified(co</span>
<a href="#l11.168"></a><span id="l11.168">   }</span>
<a href="#l11.169"></a><span id="l11.169"> </span>
<a href="#l11.170"></a><span id="l11.170">   else  // end of batch</span>
<a href="#l11.171"></a><span id="l11.171">   {</span>
<a href="#l11.172"></a><span id="l11.172">     // Parent will apply post bayes filters.</span>
<a href="#l11.173"></a><span id="l11.173">     nsMsgDBFolder::OnMessageClassified(nullptr, nsIJunkMailPlugin::UNCLASSIFIED,</span>
<a href="#l11.174"></a><span id="l11.174">                                        0);</span>
<a href="#l11.175"></a><span id="l11.175"> </span>
<a href="#l11.176"></a><span id="l11.176" class="difflineminus">-    if (m_junkMessagesToMarkAsRead) {</span>
<a href="#l11.177"></a><span id="l11.177" class="difflineminus">-      uint32_t count;</span>
<a href="#l11.178"></a><span id="l11.178" class="difflineminus">-      m_junkMessagesToMarkAsRead-&gt;GetLength(&amp;count);</span>
<a href="#l11.179"></a><span id="l11.179" class="difflineminus">-      if (count &gt; 0) {</span>
<a href="#l11.180"></a><span id="l11.180" class="difflineminus">-        rv = MarkMessagesRead(m_junkMessagesToMarkAsRead, true);</span>
<a href="#l11.181"></a><span id="l11.181" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.182"></a><span id="l11.182" class="difflineminus">-        m_junkMessagesToMarkAsRead-&gt;Clear();</span>
<a href="#l11.183"></a><span id="l11.183" class="difflineminus">-      }</span>
<a href="#l11.184"></a><span id="l11.184" class="difflineplus">+    if (!m_junkMessagesToMarkAsRead.IsEmpty()) {</span>
<a href="#l11.185"></a><span id="l11.185" class="difflineplus">+      rv = MarkMessagesRead(m_junkMessagesToMarkAsRead, true);</span>
<a href="#l11.186"></a><span id="l11.186" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.187"></a><span id="l11.187" class="difflineplus">+      m_junkMessagesToMarkAsRead.Clear();</span>
<a href="#l11.188"></a><span id="l11.188">     }</span>
<a href="#l11.189"></a><span id="l11.189">     if (!mSpamKeysToMove.IsEmpty()) {</span>
<a href="#l11.190"></a><span id="l11.190">       GetMoveCoalescer();</span>
<a href="#l11.191"></a><span id="l11.191">       for (uint32_t keyIndex = 0; keyIndex &lt; mSpamKeysToMove.Length();</span>
<a href="#l11.192"></a><span id="l11.192">            keyIndex++) {</span>
<a href="#l11.193"></a><span id="l11.193">         // If an upstream filter moved this message, don't move it here.</span>
<a href="#l11.194"></a><span id="l11.194">         nsMsgKey msgKey = mSpamKeysToMove.ElementAt(keyIndex);</span>
<a href="#l11.195"></a><span id="l11.195">         nsMsgProcessingFlagType processingFlags;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/imap/src/nsImapMailFolder.h</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapMailFolder.h</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -264,24 +264,27 @@ class nsImapMailFolder : public nsMsgDBF</span>
<a href="#l12.4"></a><span id="l12.4"> </span>
<a href="#l12.5"></a><span id="l12.5">   NS_IMETHOD GetCanCreateSubfolders(bool *aResult) override;</span>
<a href="#l12.6"></a><span id="l12.6">   NS_IMETHOD GetCanSubscribe(bool *aResult) override;</span>
<a href="#l12.7"></a><span id="l12.7"> </span>
<a href="#l12.8"></a><span id="l12.8">   NS_IMETHOD ApplyRetentionSettings() override;</span>
<a href="#l12.9"></a><span id="l12.9"> </span>
<a href="#l12.10"></a><span id="l12.10">   NS_IMETHOD AddMessageDispositionState(</span>
<a href="#l12.11"></a><span id="l12.11">       nsIMsgDBHdr *aMessage, nsMsgDispositionState aDispositionFlag) override;</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-  NS_IMETHOD MarkMessagesRead(nsIArray *messages, bool markRead) override;</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+  NS_IMETHOD MarkMessagesRead(const nsTArray&lt;RefPtr&lt;nsIMsgDBHdr&gt;&gt; &amp;messages,</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+                              bool markRead) override;</span>
<a href="#l12.15"></a><span id="l12.15">   NS_IMETHOD MarkAllMessagesRead(nsIMsgWindow *aMsgWindow) override;</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineminus">-  NS_IMETHOD MarkMessagesFlagged(nsIArray *messages, bool markFlagged) override;</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineplus">+  NS_IMETHOD MarkMessagesFlagged(const nsTArray&lt;RefPtr&lt;nsIMsgDBHdr&gt;&gt; &amp;messages,</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineplus">+                                 bool markFlagged) override;</span>
<a href="#l12.19"></a><span id="l12.19">   NS_IMETHOD MarkThreadRead(nsIMsgThread *thread) override;</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineminus">-  NS_IMETHOD SetLabelForMessages(nsIArray *aMessages,</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineplus">+  NS_IMETHOD SetLabelForMessages(const nsTArray&lt;RefPtr&lt;nsIMsgDBHdr&gt;&gt; &amp;aMessages,</span>
<a href="#l12.22"></a><span id="l12.22">                                  nsMsgLabelValue aLabel) override;</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineminus">-  NS_IMETHOD SetJunkScoreForMessages(nsIArray *aMessages,</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineminus">-                                     const nsACString &amp;aJunkScore) override;</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineplus">+  NS_IMETHOD SetJunkScoreForMessages(</span>
<a href="#l12.26"></a><span id="l12.26" class="difflineplus">+      const nsTArray&lt;RefPtr&lt;nsIMsgDBHdr&gt;&gt; &amp;aMessages,</span>
<a href="#l12.27"></a><span id="l12.27" class="difflineplus">+      const nsACString &amp;aJunkScore) override;</span>
<a href="#l12.28"></a><span id="l12.28">   NS_IMETHOD DeleteSubFolders(nsIArray *folders,</span>
<a href="#l12.29"></a><span id="l12.29">                               nsIMsgWindow *msgWindow) override;</span>
<a href="#l12.30"></a><span id="l12.30">   NS_IMETHOD ReadFromFolderCacheElem(</span>
<a href="#l12.31"></a><span id="l12.31">       nsIMsgFolderCacheElement *element) override;</span>
<a href="#l12.32"></a><span id="l12.32">   NS_IMETHOD WriteToFolderCacheElem(nsIMsgFolderCacheElement *element) override;</span>
<a href="#l12.33"></a><span id="l12.33"> </span>
<a href="#l12.34"></a><span id="l12.34">   NS_IMETHOD GetDBFolderInfoAndDB(nsIDBFolderInfo **folderInfo,</span>
<a href="#l12.35"></a><span id="l12.35">                                   nsIMsgDatabase **db) override;</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineat">@@ -374,16 +377,21 @@ class nsImapMailFolder : public nsMsgDBF</span>
<a href="#l12.37"></a><span id="l12.37"> </span>
<a href="#l12.38"></a><span id="l12.38">   // send notification to copy service listener.</span>
<a href="#l12.39"></a><span id="l12.39">   nsresult OnCopyCompleted(nsISupports *srcSupport, nsresult exitCode);</span>
<a href="#l12.40"></a><span id="l12.40"> </span>
<a href="#l12.41"></a><span id="l12.41">   static nsresult AllocateUidStringFromKeys(const nsTArray&lt;nsMsgKey&gt; &amp;keys,</span>
<a href="#l12.42"></a><span id="l12.42">                                             nsCString &amp;msgIds);</span>
<a href="#l12.43"></a><span id="l12.43">   static nsresult BuildIdsAndKeyArray(nsIArray *messages, nsCString &amp;msgIds,</span>
<a href="#l12.44"></a><span id="l12.44">                                       nsTArray&lt;nsMsgKey&gt; &amp;keyArray);</span>
<a href="#l12.45"></a><span id="l12.45" class="difflineplus">+  // Stopgap during nsIArray removal. To be renamed to BuildIdsAndKeyArray().</span>
<a href="#l12.46"></a><span id="l12.46" class="difflineplus">+  // (see Bug 1612239)</span>
<a href="#l12.47"></a><span id="l12.47" class="difflineplus">+  static nsresult BuildIdsAndKeyArray2(</span>
<a href="#l12.48"></a><span id="l12.48" class="difflineplus">+      const nsTArray&lt;RefPtr&lt;nsIMsgDBHdr&gt;&gt; &amp;messages, nsCString &amp;msgIds,</span>
<a href="#l12.49"></a><span id="l12.49" class="difflineplus">+      nsTArray&lt;nsMsgKey&gt; &amp;keyArray);</span>
<a href="#l12.50"></a><span id="l12.50"> </span>
<a href="#l12.51"></a><span id="l12.51">   // these might end up as an nsIImapMailFolder attribute.</span>
<a href="#l12.52"></a><span id="l12.52">   nsresult SetSupportedUserFlags(uint32_t userFlags);</span>
<a href="#l12.53"></a><span id="l12.53">   nsresult GetSupportedUserFlags(uint32_t *userFlags);</span>
<a href="#l12.54"></a><span id="l12.54"> </span>
<a href="#l12.55"></a><span id="l12.55">   // Find the start of a range of msgKeys that can hold srcCount headers.</span>
<a href="#l12.56"></a><span id="l12.56">   nsresult FindOpenRange(nsMsgKey &amp;fakeBase, uint32_t srcCount);</span>
<a href="#l12.57"></a><span id="l12.57"> </span>
<a href="#l12.58"></a><span id="l12.58" class="difflineat">@@ -504,17 +512,17 @@ class nsImapMailFolder : public nsMsgDBF</span>
<a href="#l12.59"></a><span id="l12.59">   nsCOMPtr&lt;nsIMsgParseMailMsgState&gt; m_msgParser;</span>
<a href="#l12.60"></a><span id="l12.60">   nsCOMPtr&lt;nsIMsgFilterList&gt; m_filterList;</span>
<a href="#l12.61"></a><span id="l12.61">   nsCOMPtr&lt;nsIMsgFilterPlugin&gt; m_filterPlugin;  // XXX should be a list</span>
<a href="#l12.62"></a><span id="l12.62">   // used with filter plugins to know when we've finished classifying and can</span>
<a href="#l12.63"></a><span id="l12.63">   // playback moves</span>
<a href="#l12.64"></a><span id="l12.64">   bool m_msgMovedByFilter;</span>
<a href="#l12.65"></a><span id="l12.65">   RefPtr&lt;nsImapMoveCoalescer&gt;</span>
<a href="#l12.66"></a><span id="l12.66">       m_moveCoalescer;  // strictly owned by the nsImapMailFolder</span>
<a href="#l12.67"></a><span id="l12.67" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; m_junkMessagesToMarkAsRead;</span>
<a href="#l12.68"></a><span id="l12.68" class="difflineplus">+  nsTArray&lt;RefPtr&lt;nsIMsgDBHdr&gt;&gt; m_junkMessagesToMarkAsRead;</span>
<a href="#l12.69"></a><span id="l12.69">   /// list of keys to be moved to the junk folder</span>
<a href="#l12.70"></a><span id="l12.70">   nsTArray&lt;nsMsgKey&gt; mSpamKeysToMove;</span>
<a href="#l12.71"></a><span id="l12.71">   /// the junk destination folder</span>
<a href="#l12.72"></a><span id="l12.72">   nsCOMPtr&lt;nsIMsgFolder&gt; mSpamFolder;</span>
<a href="#l12.73"></a><span id="l12.73">   nsMsgKey m_curMsgUid;</span>
<a href="#l12.74"></a><span id="l12.74">   uint32_t m_uidValidity;</span>
<a href="#l12.75"></a><span id="l12.75"> </span>
<a href="#l12.76"></a><span id="l12.76">   // These three vars are used to store counts from STATUS or SELECT command</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_offlinePlayback.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_offlinePlayback.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -55,18 +55,18 @@ var tests = [</span>
<a href="#l13.4"></a><span id="l13.4">     let headers1 = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(</span>
<a href="#l13.5"></a><span id="l13.5">       Ci.nsIMutableArray</span>
<a href="#l13.6"></a><span id="l13.6">     );</span>
<a href="#l13.7"></a><span id="l13.7">     let headers2 = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(</span>
<a href="#l13.8"></a><span id="l13.8">       Ci.nsIMutableArray</span>
<a href="#l13.9"></a><span id="l13.9">     );</span>
<a href="#l13.10"></a><span id="l13.10">     headers1.appendElement(msgHdr1);</span>
<a href="#l13.11"></a><span id="l13.11">     headers2.appendElement(msgHdr2);</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-    msgHdr1.folder.markMessagesFlagged(headers1, true);</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-    msgHdr2.folder.markMessagesFlagged(headers2, true);</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+    msgHdr1.folder.markMessagesFlagged([msgHdr1], true);</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+    msgHdr2.folder.markMessagesFlagged([msgHdr2], true);</span>
<a href="#l13.16"></a><span id="l13.16">     let promiseCopyListener1 = new PromiseTestUtils.PromiseCopyListener();</span>
<a href="#l13.17"></a><span id="l13.17">     MailServices.copy.CopyMessages(</span>
<a href="#l13.18"></a><span id="l13.18">       IMAPPump.inbox,</span>
<a href="#l13.19"></a><span id="l13.19">       headers1,</span>
<a href="#l13.20"></a><span id="l13.20">       gSecondFolder,</span>
<a href="#l13.21"></a><span id="l13.21">       true,</span>
<a href="#l13.22"></a><span id="l13.22">       promiseCopyListener1,</span>
<a href="#l13.23"></a><span id="l13.23">       null,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/local/src/nsLocalMailFolder.cpp</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/local/src/nsLocalMailFolder.cpp</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -1083,46 +1083,35 @@ nsMsgLocalMailFolder::AddMessageDisposit</span>
<a href="#l14.4"></a><span id="l14.4"> </span>
<a href="#l14.5"></a><span id="l14.5">   nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l14.6"></a><span id="l14.6">   rv = GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l14.7"></a><span id="l14.7">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.8"></a><span id="l14.8">   return msgStore-&gt;ChangeFlags({aMessage}, msgFlag, true);</span>
<a href="#l14.9"></a><span id="l14.9"> }</span>
<a href="#l14.10"></a><span id="l14.10"> </span>
<a href="#l14.11"></a><span id="l14.11"> NS_IMETHODIMP</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-nsMsgLocalMailFolder::MarkMessagesRead(nsIArray *aMessages, bool aMarkRead) {</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+nsMsgLocalMailFolder::MarkMessagesRead(</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+    const nsTArray&lt;RefPtr&lt;nsIMsgDBHdr&gt;&gt; &amp;aMessages, bool aMarkRead) {</span>
<a href="#l14.15"></a><span id="l14.15">   nsresult rv = nsMsgDBFolder::MarkMessagesRead(aMessages, aMarkRead);</span>
<a href="#l14.16"></a><span id="l14.16">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineminus">-</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineminus">-  // Stopgap. Build a parallel array of message headers while we complete</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineminus">-  // removal of nsIArray usage (Bug 1583030).</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineminus">-  nsTArray&lt;RefPtr&lt;nsIMsgDBHdr&gt;&gt; msgHeaders;</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineminus">-  MsgHdrsToTArray(aMessages, msgHeaders);</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineminus">-</span>
<a href="#l14.23"></a><span id="l14.23">   nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l14.24"></a><span id="l14.24">   rv = GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l14.25"></a><span id="l14.25">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineminus">-  return msgStore-&gt;ChangeFlags(msgHeaders, nsMsgMessageFlags::Read, aMarkRead);</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineplus">+  return msgStore-&gt;ChangeFlags(aMessages, nsMsgMessageFlags::Read, aMarkRead);</span>
<a href="#l14.28"></a><span id="l14.28"> }</span>
<a href="#l14.29"></a><span id="l14.29"> </span>
<a href="#l14.30"></a><span id="l14.30"> NS_IMETHODIMP</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineminus">-nsMsgLocalMailFolder::MarkMessagesFlagged(nsIArray *aMessages,</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineminus">-                                          bool aMarkFlagged) {</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineplus">+nsMsgLocalMailFolder::MarkMessagesFlagged(</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineplus">+    const nsTArray&lt;RefPtr&lt;nsIMsgDBHdr&gt;&gt; &amp;aMessages, bool aMarkFlagged) {</span>
<a href="#l14.35"></a><span id="l14.35">   nsresult rv = nsMsgDBFolder::MarkMessagesFlagged(aMessages, aMarkFlagged);</span>
<a href="#l14.36"></a><span id="l14.36">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.37"></a><span id="l14.37">   nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l14.38"></a><span id="l14.38">   rv = GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l14.39"></a><span id="l14.39">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineminus">-</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineminus">-  // Stopgap. Build a parallel array of message headers while we complete</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineminus">-  // removal of nsIArray usage (Bug 1583030).</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineminus">-  nsTArray&lt;RefPtr&lt;nsIMsgDBHdr&gt;&gt; msgHeaders;</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineminus">-  MsgHdrsToTArray(aMessages, msgHeaders);</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineminus">-</span>
<a href="#l14.46"></a><span id="l14.46" class="difflineminus">-  return msgStore-&gt;ChangeFlags(msgHeaders, nsMsgMessageFlags::Marked,</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineplus">+  return msgStore-&gt;ChangeFlags(aMessages, nsMsgMessageFlags::Marked,</span>
<a href="#l14.48"></a><span id="l14.48">                                aMarkFlagged);</span>
<a href="#l14.49"></a><span id="l14.49"> }</span>
<a href="#l14.50"></a><span id="l14.50"> </span>
<a href="#l14.51"></a><span id="l14.51"> NS_IMETHODIMP</span>
<a href="#l14.52"></a><span id="l14.52"> nsMsgLocalMailFolder::MarkAllMessagesRead(nsIMsgWindow *aMsgWindow) {</span>
<a href="#l14.53"></a><span id="l14.53">   nsresult rv = GetDatabase();</span>
<a href="#l14.54"></a><span id="l14.54">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.55"></a><span id="l14.55"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/local/src/nsLocalMailFolder.h</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/local/src/nsLocalMailFolder.h</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -159,18 +159,19 @@ class nsMsgLocalMailFolder : public nsMs</span>
<a href="#l15.4"></a><span id="l15.4">   NS_IMETHOD CopyFileMessage(nsIFile *aFile, nsIMsgDBHdr *msgToReplace,</span>
<a href="#l15.5"></a><span id="l15.5">                              bool isDraftOrTemplate, uint32_t newMsgFlags,</span>
<a href="#l15.6"></a><span id="l15.6">                              const nsACString &amp;aNewMsgKeywords,</span>
<a href="#l15.7"></a><span id="l15.7">                              nsIMsgWindow *msgWindow,</span>
<a href="#l15.8"></a><span id="l15.8">                              nsIMsgCopyServiceListener *listener) override;</span>
<a href="#l15.9"></a><span id="l15.9"> </span>
<a href="#l15.10"></a><span id="l15.10">   NS_IMETHOD AddMessageDispositionState(</span>
<a href="#l15.11"></a><span id="l15.11">       nsIMsgDBHdr *aMessage, nsMsgDispositionState aDispositionFlag) override;</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-  NS_IMETHOD MarkMessagesRead(nsIArray *aMessages, bool aMarkRead) override;</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineminus">-  NS_IMETHOD MarkMessagesFlagged(nsIArray *aMessages,</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineplus">+  NS_IMETHOD MarkMessagesRead(const nsTArray&lt;RefPtr&lt;nsIMsgDBHdr&gt;&gt; &amp;aMessages,</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineplus">+                              bool aMarkRead) override;</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineplus">+  NS_IMETHOD MarkMessagesFlagged(const nsTArray&lt;RefPtr&lt;nsIMsgDBHdr&gt;&gt; &amp;aMessages,</span>
<a href="#l15.17"></a><span id="l15.17">                                  bool aMarkFlagged) override;</span>
<a href="#l15.18"></a><span id="l15.18">   NS_IMETHOD MarkAllMessagesRead(nsIMsgWindow *aMsgWindow) override;</span>
<a href="#l15.19"></a><span id="l15.19">   NS_IMETHOD MarkThreadRead(nsIMsgThread *thread) override;</span>
<a href="#l15.20"></a><span id="l15.20">   NS_IMETHOD GetNewMessages(nsIMsgWindow *aWindow,</span>
<a href="#l15.21"></a><span id="l15.21">                             nsIUrlListener *aListener) override;</span>
<a href="#l15.22"></a><span id="l15.22">   NS_IMETHOD NotifyCompactCompleted() override;</span>
<a href="#l15.23"></a><span id="l15.23">   NS_IMETHOD Shutdown(bool shutdownChildren) override;</span>
<a href="#l15.24"></a><span id="l15.24"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/local/src/nsParseMailbox.cpp</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/local/src/nsParseMailbox.cpp</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -2021,21 +2021,17 @@ NS_IMETHODIMP nsParseNewMailState::Apply</span>
<a href="#l16.4"></a><span id="l16.4">           break;</span>
<a href="#l16.5"></a><span id="l16.5">         case nsMsgFilterAction::KillSubthread:</span>
<a href="#l16.6"></a><span id="l16.6">           rv = msgHdr-&gt;OrFlags(nsMsgMessageFlags::Ignored, &amp;newFlags);</span>
<a href="#l16.7"></a><span id="l16.7">           break;</span>
<a href="#l16.8"></a><span id="l16.8">         case nsMsgFilterAction::WatchThread:</span>
<a href="#l16.9"></a><span id="l16.9">           rv = msgHdr-&gt;OrFlags(nsMsgMessageFlags::Watched, &amp;newFlags);</span>
<a href="#l16.10"></a><span id="l16.10">           break;</span>
<a href="#l16.11"></a><span id="l16.11">         case nsMsgFilterAction::MarkFlagged: {</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-          nsCOMPtr&lt;nsIMutableArray&gt; messageArray(</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineminus">-              do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineminus">-          if (NS_FAILED(rv) || !messageArray) break;</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineminus">-          messageArray-&gt;AppendElement(msgHdr);</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineminus">-          rv = m_downloadFolder-&gt;MarkMessagesFlagged(messageArray, true);</span>
<a href="#l16.17"></a><span id="l16.17" class="difflineplus">+          rv = m_downloadFolder-&gt;MarkMessagesFlagged({&amp;*msgHdr}, true);</span>
<a href="#l16.18"></a><span id="l16.18">         } break;</span>
<a href="#l16.19"></a><span id="l16.19">         case nsMsgFilterAction::ChangePriority: {</span>
<a href="#l16.20"></a><span id="l16.20">           nsMsgPriorityValue filterPriority;</span>
<a href="#l16.21"></a><span id="l16.21">           filterAction-&gt;GetPriority(&amp;filterPriority);</span>
<a href="#l16.22"></a><span id="l16.22">           rv = msgHdr-&gt;SetPriority(filterPriority);</span>
<a href="#l16.23"></a><span id="l16.23">         } break;</span>
<a href="#l16.24"></a><span id="l16.24">         case nsMsgFilterAction::AddTag: {</span>
<a href="#l16.25"></a><span id="l16.25">           nsCString keyword;</span>
<a href="#l16.26"></a><span id="l16.26" class="difflineat">@@ -2259,35 +2255,29 @@ nsresult nsParseNewMailState::ApplyForwa</span>
<a href="#l16.27"></a><span id="l16.27">     }</span>
<a href="#l16.28"></a><span id="l16.28">   }</span>
<a href="#l16.29"></a><span id="l16.29">   m_replyTemplateUri.Clear();</span>
<a href="#l16.30"></a><span id="l16.30">   m_msgToForwardOrReply = nullptr;</span>
<a href="#l16.31"></a><span id="l16.31">   return rv;</span>
<a href="#l16.32"></a><span id="l16.32"> }</span>
<a href="#l16.33"></a><span id="l16.33"> </span>
<a href="#l16.34"></a><span id="l16.34"> void nsParseNewMailState::MarkFilteredMessageRead(nsIMsgDBHdr *msgHdr) {</span>
<a href="#l16.35"></a><span id="l16.35" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; messageArray(</span>
<a href="#l16.36"></a><span id="l16.36" class="difflineminus">-      do_CreateInstance(NS_ARRAY_CONTRACTID));</span>
<a href="#l16.37"></a><span id="l16.37" class="difflineminus">-  messageArray-&gt;AppendElement(msgHdr);</span>
<a href="#l16.38"></a><span id="l16.38" class="difflineminus">-  m_downloadFolder-&gt;MarkMessagesRead(messageArray, true);</span>
<a href="#l16.39"></a><span id="l16.39" class="difflineplus">+  m_downloadFolder-&gt;MarkMessagesRead({msgHdr}, true);</span>
<a href="#l16.40"></a><span id="l16.40"> }</span>
<a href="#l16.41"></a><span id="l16.41"> </span>
<a href="#l16.42"></a><span id="l16.42"> void nsParseNewMailState::MarkFilteredMessageUnread(nsIMsgDBHdr *msgHdr) {</span>
<a href="#l16.43"></a><span id="l16.43">   uint32_t newFlags;</span>
<a href="#l16.44"></a><span id="l16.44">   if (m_mailDB) {</span>
<a href="#l16.45"></a><span id="l16.45">     nsMsgKey msgKey;</span>
<a href="#l16.46"></a><span id="l16.46">     msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l16.47"></a><span id="l16.47">     m_mailDB-&gt;AddToNewList(msgKey);</span>
<a href="#l16.48"></a><span id="l16.48">   } else {</span>
<a href="#l16.49"></a><span id="l16.49">     msgHdr-&gt;OrFlags(nsMsgMessageFlags::New, &amp;newFlags);</span>
<a href="#l16.50"></a><span id="l16.50">   }</span>
<a href="#l16.51"></a><span id="l16.51" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; messageArray(</span>
<a href="#l16.52"></a><span id="l16.52" class="difflineminus">-      do_CreateInstance(NS_ARRAY_CONTRACTID));</span>
<a href="#l16.53"></a><span id="l16.53" class="difflineminus">-  messageArray-&gt;AppendElement(msgHdr);</span>
<a href="#l16.54"></a><span id="l16.54" class="difflineminus">-  m_downloadFolder-&gt;MarkMessagesRead(messageArray, false);</span>
<a href="#l16.55"></a><span id="l16.55" class="difflineplus">+  m_downloadFolder-&gt;MarkMessagesRead({msgHdr}, false);</span>
<a href="#l16.56"></a><span id="l16.56"> }</span>
<a href="#l16.57"></a><span id="l16.57"> </span>
<a href="#l16.58"></a><span id="l16.58"> nsresult nsParseNewMailState::EndMsgDownload() {</span>
<a href="#l16.59"></a><span id="l16.59">   if (m_moveCoalescer) m_moveCoalescer-&gt;PlaybackMoves();</span>
<a href="#l16.60"></a><span id="l16.60"> </span>
<a href="#l16.61"></a><span id="l16.61">   // need to do this for all folders that had messages filtered into them</span>
<a href="#l16.62"></a><span id="l16.62">   uint32_t serverCount = m_filterTargetFolders.Count();</span>
<a href="#l16.63"></a><span id="l16.63">   nsresult rv;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/suite/mailnews/content/mailWindowOverlay.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/suite/mailnews/content/mailWindowOverlay.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -2743,20 +2743,17 @@ function checkMsgHdrPropertyIsNot(aPrope</span>
<a href="#l17.4"></a><span id="l17.4"> </span>
<a href="#l17.5"></a><span id="l17.5"> /**</span>
<a href="#l17.6"></a><span id="l17.6">  * Mark a specified message as read.</span>
<a href="#l17.7"></a><span id="l17.7">  * @param msgHdr header (nsIMsgDBHdr) of the message to mark as read</span>
<a href="#l17.8"></a><span id="l17.8">  */</span>
<a href="#l17.9"></a><span id="l17.9"> function MarkMessageAsRead(msgHdr)</span>
<a href="#l17.10"></a><span id="l17.10"> {</span>
<a href="#l17.11"></a><span id="l17.11">   ClearPendingReadTimer();</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-  var headers = Cc[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineminus">-                  .createInstance(Ci.nsIMutableArray);</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineminus">-  headers.appendElement(msgHdr);</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineminus">-  msgHdr.folder.markMessagesRead(headers, true);</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineplus">+  msgHdr.folder.markMessagesRead([msgHdr], true);</span>
<a href="#l17.17"></a><span id="l17.17"> }</span>
<a href="#l17.18"></a><span id="l17.18"> </span>
<a href="#l17.19"></a><span id="l17.19"> function ClearPendingReadTimer()</span>
<a href="#l17.20"></a><span id="l17.20"> {</span>
<a href="#l17.21"></a><span id="l17.21">   if (gMarkViewedMessageAsReadTimer)</span>
<a href="#l17.22"></a><span id="l17.22">   {</span>
<a href="#l17.23"></a><span id="l17.23">     clearTimeout(gMarkViewedMessageAsReadTimer);</span>
<a href="#l17.24"></a><span id="l17.24">     gMarkViewedMessageAsReadTimer = null;</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:31Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

