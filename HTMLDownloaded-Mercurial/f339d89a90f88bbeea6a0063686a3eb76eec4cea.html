<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 11937:f339d89a90f88bbeea6a0063686a3eb76eec4cea</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ f339d89a90f88bbeea6a0063686a3eb76eec4cea" />
<meta property="og:url" content="/comm-central/rev/f339d89a90f88bbeea6a0063686a3eb76eec4cea" />
<meta property="og:description" content="Fix bug 788004 - No email send after invitation creation if offline cache is enabled (regression). r=philipp" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / f339d89a90f88bbeea6a0063686a3eb76eec4cea 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/f339d89a90f88bbeea6a0063686a3eb76eec4cea">shortlog</a> |
<a href="/comm-central/log/f339d89a90f88bbeea6a0063686a3eb76eec4cea">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/f339d89a90f88bbeea6a0063686a3eb76eec4cea">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/f339d89a90f88bbeea6a0063686a3eb76eec4cea">files</a> |
changeset |
<a href="/comm-central/raw-rev/f339d89a90f88bbeea6a0063686a3eb76eec4cea">raw</a>  | <a href="/comm-central/archive/f339d89a90f88bbeea6a0063686a3eb76eec4cea.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
Fix <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=788004">bug 788004</a> - No email send after invitation creation if offline cache is enabled (regression). r=philipp
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#77;&#111;&#104;&#105;&#116;&#32;&#75;&#97;&#110;&#119;&#97;&#108;&#32;&#91;&#58;&#114;&#101;&#100;&#68;&#114;&#97;&#103;&#111;&#110;&#93;&#32;&#60;&#109;&#111;&#104;&#105;&#116;&#46;&#107;&#97;&#110;&#119;&#97;&#108;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 11 Feb 2013 10:50:00 +0100</td></tr>

<tr>
 <td>changeset 11937</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/f339d89a90f88bbeea6a0063686a3eb76eec4cea">f339d89a90f88bbeea6a0063686a3eb76eec4cea</a></td>
</tr>



<tr>
<td>parent 11936</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/0a6e923be4e9ef0a8ca1e5c32cfcf2a9cfbe40dd">0a6e923be4e9ef0a8ca1e5c32cfcf2a9cfbe40dd</a>
</td>
</tr>

<tr>
<td>child 11938</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/9054982058688c6d104d563ffa86b807765c4dba">9054982058688c6d104d563ffa86b807765c4dba</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=f339d89a90f88bbeea6a0063686a3eb76eec4cea">8886</a></td></tr>
<tr><td>push user</td><td>mozilla@kewis.ch</td></tr>
<tr><td>push date</td><td class="date age">Mon, 11 Feb 2013 10:06:43 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@905498205868 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=9054982058688c6d104d563ffa86b807765c4dba">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=9054982058688c6d104d563ffa86b807765c4dba&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=9054982058688c6d104d563ffa86b807765c4dba&newProject=comm-central&newRevision=f339d89a90f88bbeea6a0063686a3eb76eec4cea&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=9054982058688c6d104d563ffa86b807765c4dba&newProject=comm-central&newRevision=f339d89a90f88bbeea6a0063686a3eb76eec4cea&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=9054982058688c6d104d563ffa86b807765c4dba&newProject=comm-central&newRevision=f339d89a90f88bbeea6a0063686a3eb76eec4cea&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28philipp%29&revcount=50">philipp</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=788004">788004</a></td></tr>




</table></div>

<div class="page_body description">Fix <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=788004">bug 788004</a> - No email send after invitation creation if offline cache is enabled (regression). r=philipp</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/content/agenda-listbox.js">calendar/base/content/agenda-listbox.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/content/agenda-listbox.js">file</a> |
<a href="/comm-central/annotate/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/content/agenda-listbox.js">annotate</a> |
<a href="/comm-central/diff/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/content/agenda-listbox.js">diff</a> |
<a href="/comm-central/comparison/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/content/agenda-listbox.js">comparison</a> |
<a href="/comm-central/log/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/content/agenda-listbox.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/content/calendar-base-view.xml">calendar/base/content/calendar-base-view.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/content/calendar-base-view.xml">file</a> |
<a href="/comm-central/annotate/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/content/calendar-base-view.xml">annotate</a> |
<a href="/comm-central/diff/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/content/calendar-base-view.xml">diff</a> |
<a href="/comm-central/comparison/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/content/calendar-base-view.xml">comparison</a> |
<a href="/comm-central/log/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/content/calendar-base-view.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/content/calendar-item-editing.js">calendar/base/content/calendar-item-editing.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/content/calendar-item-editing.js">file</a> |
<a href="/comm-central/annotate/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/content/calendar-item-editing.js">annotate</a> |
<a href="/comm-central/diff/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/content/calendar-item-editing.js">diff</a> |
<a href="/comm-central/comparison/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/content/calendar-item-editing.js">comparison</a> |
<a href="/comm-central/log/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/content/calendar-item-editing.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/content/dialogs/calendar-dialog-utils.js">calendar/base/content/dialogs/calendar-dialog-utils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/content/dialogs/calendar-dialog-utils.js">file</a> |
<a href="/comm-central/annotate/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/content/dialogs/calendar-dialog-utils.js">annotate</a> |
<a href="/comm-central/diff/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/content/dialogs/calendar-dialog-utils.js">diff</a> |
<a href="/comm-central/comparison/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/content/dialogs/calendar-dialog-utils.js">comparison</a> |
<a href="/comm-central/log/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/content/dialogs/calendar-dialog-utils.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/content/dialogs/calendar-event-dialog-attendees.js">calendar/base/content/dialogs/calendar-event-dialog-attendees.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/content/dialogs/calendar-event-dialog-attendees.js">file</a> |
<a href="/comm-central/annotate/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/content/dialogs/calendar-event-dialog-attendees.js">annotate</a> |
<a href="/comm-central/diff/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/content/dialogs/calendar-event-dialog-attendees.js">diff</a> |
<a href="/comm-central/comparison/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/content/dialogs/calendar-event-dialog-attendees.js">comparison</a> |
<a href="/comm-central/log/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/content/dialogs/calendar-event-dialog-attendees.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/content/dialogs/calendar-event-dialog-attendees.xml">calendar/base/content/dialogs/calendar-event-dialog-attendees.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/content/dialogs/calendar-event-dialog-attendees.xml">file</a> |
<a href="/comm-central/annotate/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/content/dialogs/calendar-event-dialog-attendees.xml">annotate</a> |
<a href="/comm-central/diff/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/content/dialogs/calendar-event-dialog-attendees.xml">diff</a> |
<a href="/comm-central/comparison/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/content/dialogs/calendar-event-dialog-attendees.xml">comparison</a> |
<a href="/comm-central/log/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/content/dialogs/calendar-event-dialog-attendees.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/content/dialogs/calendar-event-dialog-recurrence.js">calendar/base/content/dialogs/calendar-event-dialog-recurrence.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/content/dialogs/calendar-event-dialog-recurrence.js">file</a> |
<a href="/comm-central/annotate/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/content/dialogs/calendar-event-dialog-recurrence.js">annotate</a> |
<a href="/comm-central/diff/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/content/dialogs/calendar-event-dialog-recurrence.js">diff</a> |
<a href="/comm-central/comparison/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/content/dialogs/calendar-event-dialog-recurrence.js">comparison</a> |
<a href="/comm-central/log/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/content/dialogs/calendar-event-dialog-recurrence.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/content/dialogs/calendar-event-dialog.js">calendar/base/content/dialogs/calendar-event-dialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/content/dialogs/calendar-event-dialog.js">file</a> |
<a href="/comm-central/annotate/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/content/dialogs/calendar-event-dialog.js">annotate</a> |
<a href="/comm-central/diff/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/content/dialogs/calendar-event-dialog.js">diff</a> |
<a href="/comm-central/comparison/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/content/dialogs/calendar-event-dialog.js">comparison</a> |
<a href="/comm-central/log/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/content/dialogs/calendar-event-dialog.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/content/dialogs/calendar-invitations-list.xml">calendar/base/content/dialogs/calendar-invitations-list.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/content/dialogs/calendar-invitations-list.xml">file</a> |
<a href="/comm-central/annotate/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/content/dialogs/calendar-invitations-list.xml">annotate</a> |
<a href="/comm-central/diff/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/content/dialogs/calendar-invitations-list.xml">diff</a> |
<a href="/comm-central/comparison/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/content/dialogs/calendar-invitations-list.xml">comparison</a> |
<a href="/comm-central/log/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/content/dialogs/calendar-invitations-list.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/content/dialogs/calendar-summary-dialog.js">calendar/base/content/dialogs/calendar-summary-dialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/content/dialogs/calendar-summary-dialog.js">file</a> |
<a href="/comm-central/annotate/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/content/dialogs/calendar-summary-dialog.js">annotate</a> |
<a href="/comm-central/diff/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/content/dialogs/calendar-summary-dialog.js">diff</a> |
<a href="/comm-central/comparison/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/content/dialogs/calendar-summary-dialog.js">comparison</a> |
<a href="/comm-central/log/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/content/dialogs/calendar-summary-dialog.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/modules/calItipUtils.jsm">calendar/base/modules/calItipUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/modules/calItipUtils.jsm">file</a> |
<a href="/comm-central/annotate/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/modules/calItipUtils.jsm">annotate</a> |
<a href="/comm-central/diff/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/modules/calItipUtils.jsm">diff</a> |
<a href="/comm-central/comparison/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/modules/calItipUtils.jsm">comparison</a> |
<a href="/comm-central/log/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/modules/calItipUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/modules/calRecurrenceUtils.jsm">calendar/base/modules/calRecurrenceUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/modules/calRecurrenceUtils.jsm">file</a> |
<a href="/comm-central/annotate/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/modules/calRecurrenceUtils.jsm">annotate</a> |
<a href="/comm-central/diff/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/modules/calRecurrenceUtils.jsm">diff</a> |
<a href="/comm-central/comparison/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/modules/calRecurrenceUtils.jsm">comparison</a> |
<a href="/comm-central/log/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/modules/calRecurrenceUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/modules/calUtils.jsm">calendar/base/modules/calUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/modules/calUtils.jsm">file</a> |
<a href="/comm-central/annotate/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/modules/calUtils.jsm">annotate</a> |
<a href="/comm-central/diff/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/modules/calUtils.jsm">diff</a> |
<a href="/comm-central/comparison/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/modules/calUtils.jsm">comparison</a> |
<a href="/comm-central/log/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/modules/calUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/src/calCachedCalendar.js">calendar/base/src/calCachedCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/src/calCachedCalendar.js">file</a> |
<a href="/comm-central/annotate/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/src/calCachedCalendar.js">annotate</a> |
<a href="/comm-central/diff/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/src/calCachedCalendar.js">diff</a> |
<a href="/comm-central/comparison/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/src/calCachedCalendar.js">comparison</a> |
<a href="/comm-central/log/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/src/calCachedCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/src/calCalendarManager.js">calendar/base/src/calCalendarManager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/src/calCalendarManager.js">file</a> |
<a href="/comm-central/annotate/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/src/calCalendarManager.js">annotate</a> |
<a href="/comm-central/diff/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/src/calCalendarManager.js">diff</a> |
<a href="/comm-central/comparison/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/src/calCalendarManager.js">comparison</a> |
<a href="/comm-central/log/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/src/calCalendarManager.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/src/calRecurrenceInfo.js">calendar/base/src/calRecurrenceInfo.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/src/calRecurrenceInfo.js">file</a> |
<a href="/comm-central/annotate/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/src/calRecurrenceInfo.js">annotate</a> |
<a href="/comm-central/diff/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/src/calRecurrenceInfo.js">diff</a> |
<a href="/comm-central/comparison/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/src/calRecurrenceInfo.js">comparison</a> |
<a href="/comm-central/log/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/src/calRecurrenceInfo.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/src/calUtils.js">calendar/base/src/calUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/src/calUtils.js">file</a> |
<a href="/comm-central/annotate/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/src/calUtils.js">annotate</a> |
<a href="/comm-central/diff/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/src/calUtils.js">diff</a> |
<a href="/comm-central/comparison/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/src/calUtils.js">comparison</a> |
<a href="/comm-central/log/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/base/src/calUtils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/providers/composite/calCompositeCalendar.js">calendar/providers/composite/calCompositeCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/providers/composite/calCompositeCalendar.js">file</a> |
<a href="/comm-central/annotate/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/providers/composite/calCompositeCalendar.js">annotate</a> |
<a href="/comm-central/diff/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/providers/composite/calCompositeCalendar.js">diff</a> |
<a href="/comm-central/comparison/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/providers/composite/calCompositeCalendar.js">comparison</a> |
<a href="/comm-central/log/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/providers/composite/calCompositeCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/providers/gdata/components/calGoogleUtils.js">calendar/providers/gdata/components/calGoogleUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/providers/gdata/components/calGoogleUtils.js">file</a> |
<a href="/comm-central/annotate/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/providers/gdata/components/calGoogleUtils.js">annotate</a> |
<a href="/comm-central/diff/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/providers/gdata/components/calGoogleUtils.js">diff</a> |
<a href="/comm-central/comparison/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/providers/gdata/components/calGoogleUtils.js">comparison</a> |
<a href="/comm-central/log/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/providers/gdata/components/calGoogleUtils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/providers/ics/calICSCalendar.js">calendar/providers/ics/calICSCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/providers/ics/calICSCalendar.js">file</a> |
<a href="/comm-central/annotate/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/providers/ics/calICSCalendar.js">annotate</a> |
<a href="/comm-central/diff/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/providers/ics/calICSCalendar.js">diff</a> |
<a href="/comm-central/comparison/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/providers/ics/calICSCalendar.js">comparison</a> |
<a href="/comm-central/log/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/providers/ics/calICSCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/providers/storage/calStorageCalendar.js">calendar/providers/storage/calStorageCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/providers/storage/calStorageCalendar.js">file</a> |
<a href="/comm-central/annotate/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/providers/storage/calStorageCalendar.js">annotate</a> |
<a href="/comm-central/diff/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/providers/storage/calStorageCalendar.js">diff</a> |
<a href="/comm-central/comparison/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/providers/storage/calStorageCalendar.js">comparison</a> |
<a href="/comm-central/log/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/providers/storage/calStorageCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/providers/wcap/calWcapCalendarItems.js">calendar/providers/wcap/calWcapCalendarItems.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/providers/wcap/calWcapCalendarItems.js">file</a> |
<a href="/comm-central/annotate/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/providers/wcap/calWcapCalendarItems.js">annotate</a> |
<a href="/comm-central/diff/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/providers/wcap/calWcapCalendarItems.js">diff</a> |
<a href="/comm-central/comparison/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/providers/wcap/calWcapCalendarItems.js">comparison</a> |
<a href="/comm-central/log/f339d89a90f88bbeea6a0063686a3eb76eec4cea/calendar/providers/wcap/calWcapCalendarItems.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/calendar/base/content/agenda-listbox.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/calendar/base/content/agenda-listbox.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -597,17 +597,18 @@ function setupContextMenu(popup) {</span>
<a href="#l1.4"></a><span id="l1.4">  * @param aEnd          (optional) The end date for the item query.</span>
<a href="#l1.5"></a><span id="l1.5">  * @param aCalendar     (optional) If specified, the single calendar from</span>
<a href="#l1.6"></a><span id="l1.6">  *                                   which the refresh will occur.</span>
<a href="#l1.7"></a><span id="l1.7">  */</span>
<a href="#l1.8"></a><span id="l1.8"> agendaListbox.refreshCalendarQuery =</span>
<a href="#l1.9"></a><span id="l1.9"> function refreshCalendarQuery(aStart, aEnd, aCalendar) {</span>
<a href="#l1.10"></a><span id="l1.10">     let pendingRefresh = this.pendingRefresh;</span>
<a href="#l1.11"></a><span id="l1.11">     if (pendingRefresh) {</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-        if (calInstanceOf(pendingRefresh, Components.interfaces.calIOperation)) {</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+        pendingRefresh = cal.wrapInstance(pendingRefresh, Components.interfaces.calIOperation);</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+        if (pendingRefresh) {</span>
<a href="#l1.15"></a><span id="l1.15">             this.pendingRefresh = null;</span>
<a href="#l1.16"></a><span id="l1.16">             pendingRefresh.cancel(null);</span>
<a href="#l1.17"></a><span id="l1.17">         } else {</span>
<a href="#l1.18"></a><span id="l1.18">             return;</span>
<a href="#l1.19"></a><span id="l1.19">         }</span>
<a href="#l1.20"></a><span id="l1.20">     }</span>
<a href="#l1.21"></a><span id="l1.21">     if (!(aStart || aEnd || aCalendar)) {</span>
<a href="#l1.22"></a><span id="l1.22">         this.removeListItems();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/calendar/base/content/calendar-base-view.xml</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/calendar/base/content/calendar-base-view.xml</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -409,17 +409,18 @@</span>
<a href="#l2.4"></a><span id="l2.4">             return getDateFormatter().formatInterval(this.rangeStartDate, this.rangeEndDate);</span>
<a href="#l2.5"></a><span id="l2.5">         ]]&gt;&lt;/body&gt;</span>
<a href="#l2.6"></a><span id="l2.6">       &lt;/method&gt;</span>
<a href="#l2.7"></a><span id="l2.7"> </span>
<a href="#l2.8"></a><span id="l2.8">       &lt;method name=&quot;popRefreshQueue&quot;&gt;</span>
<a href="#l2.9"></a><span id="l2.9">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l2.10"></a><span id="l2.10">           let pendingRefresh = this.mRefreshPending;</span>
<a href="#l2.11"></a><span id="l2.11">           if (pendingRefresh) {</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-              if (calInstanceOf(pendingRefresh, Components.interfaces.calIOperation)) {</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+              pendingRefresh = cal.wrapInstance(pendingRefresh, Components.interfaces.calIOperation);</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+              if (pendingRefresh) {</span>
<a href="#l2.15"></a><span id="l2.15">                   this.mRefreshPending = null;</span>
<a href="#l2.16"></a><span id="l2.16">                   pendingRefresh.cancel(null);</span>
<a href="#l2.17"></a><span id="l2.17">               } else {</span>
<a href="#l2.18"></a><span id="l2.18">                   if(this.mRefreshQueue.length &gt; 0) {</span>
<a href="#l2.19"></a><span id="l2.19">                       this.relayout();</span>
<a href="#l2.20"></a><span id="l2.20">                   }</span>
<a href="#l2.21"></a><span id="l2.21">                   return;</span>
<a href="#l2.22"></a><span id="l2.22">               }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/calendar/base/content/calendar-item-editing.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/calendar/base/content/calendar-item-editing.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -311,17 +311,18 @@ function openEventDialog(calendarItem, c</span>
<a href="#l3.4"></a><span id="l3.4"> </span>
<a href="#l3.5"></a><span id="l3.5">     // the dialog will reset this to auto when it is done loading.</span>
<a href="#l3.6"></a><span id="l3.6">     window.setCursor(&quot;wait&quot;);</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8">     // ask the provide if this item is an invitation. if this is the case</span>
<a href="#l3.9"></a><span id="l3.9">     // we'll open the summary dialog since the user is not allowed to change</span>
<a href="#l3.10"></a><span id="l3.10">     // the details of the item.</span>
<a href="#l3.11"></a><span id="l3.11">     var isInvitation = false;</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-    if (calInstanceOf(calendar, Components.interfaces.calISchedulingSupport)) {</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+    calendar = cal.wrapInstance(calendar, Components.interfaces.calISchedulingSupport);</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+    if (calendar) {</span>
<a href="#l3.15"></a><span id="l3.15">         isInvitation = calendar.isInvitation(calendarItem);</span>
<a href="#l3.16"></a><span id="l3.16">     }</span>
<a href="#l3.17"></a><span id="l3.17">     // open the dialog modeless</span>
<a href="#l3.18"></a><span id="l3.18">     let url;</span>
<a href="#l3.19"></a><span id="l3.19">     if (isCalendarWritable(calendar)</span>
<a href="#l3.20"></a><span id="l3.20">         &amp;&amp; (mode == &quot;new&quot;</span>
<a href="#l3.21"></a><span id="l3.21">             || (mode == &quot;modify&quot; &amp;&amp; !isInvitation &amp;&amp; userCanModifyItem((calendarItem))))) {</span>
<a href="#l3.22"></a><span id="l3.22">         url = &quot;chrome://calendar/content/calendar-event-dialog.xul&quot;;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-dialog-utils.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-dialog-utils.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -441,18 +441,19 @@ function updateLink() {</span>
<a href="#l4.4"></a><span id="l4.4">         } catch (e) {</span>
<a href="#l4.5"></a><span id="l4.5">             // No protocol handler for the given protocol, or invalid uri</span>
<a href="#l4.6"></a><span id="l4.6">             hideOrShow(false);</span>
<a href="#l4.7"></a><span id="l4.7">             return;</span>
<a href="#l4.8"></a><span id="l4.8">         }</span>
<a href="#l4.9"></a><span id="l4.9"> </span>
<a href="#l4.10"></a><span id="l4.10">         // Only show if its either an internal protcol handler, or its external</span>
<a href="#l4.11"></a><span id="l4.11">         // and there is an external app for the scheme</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-        hideOrShow(!calInstanceOf(handler, Components.interfaces.nsIExternalProtocolHandler) ||</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-                   handler.externalAppExistsForScheme(uri.scheme));</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+        let handlerWrappedInstance = cal.wrapInstance(handler, Components.interfaces.nsIExternalProtocolHandler);</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+        hideOrShow(!handlerWrappedInstance ||</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+                   handlerWrappedInstance.externalAppExistsForScheme(uri.scheme));</span>
<a href="#l4.17"></a><span id="l4.17"> </span>
<a href="#l4.18"></a><span id="l4.18">         setTimeout(function() {</span>
<a href="#l4.19"></a><span id="l4.19">           // HACK the url-link doesn't crop when setting the value in onLoad</span>
<a href="#l4.20"></a><span id="l4.20">           setElementValue(&quot;url-link&quot;, itemUrlString);</span>
<a href="#l4.21"></a><span id="l4.21">           setElementValue(&quot;url-link&quot;, itemUrlString, &quot;href&quot;);</span>
<a href="#l4.22"></a><span id="l4.22">         }, 0);</span>
<a href="#l4.23"></a><span id="l4.23">     }</span>
<a href="#l4.24"></a><span id="l4.24"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-event-dialog-attendees.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-event-dialog-attendees.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -611,17 +611,18 @@ function onChangeCalendar(calendar) {</span>
<a href="#l5.4"></a><span id="l5.4">     // set 'mIsReadOnly' if the calendar is read-only</span>
<a href="#l5.5"></a><span id="l5.5">     if (calendar &amp;&amp; calendar.readOnly) {</span>
<a href="#l5.6"></a><span id="l5.6">         gIsReadOnly = true;</span>
<a href="#l5.7"></a><span id="l5.7">     }</span>
<a href="#l5.8"></a><span id="l5.8"> </span>
<a href="#l5.9"></a><span id="l5.9">     // assume we're the organizer [in case that the calendar</span>
<a href="#l5.10"></a><span id="l5.10">     // does not support the concept of identities].</span>
<a href="#l5.11"></a><span id="l5.11">     gIsInvitation = false;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-    if (calInstanceOf(args.item.calendar, Components.interfaces.calISchedulingSupport)) {</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+    args.item.calendar = cal.wrapInstance(args.item.calendar, Components.interfaces.calISchedulingSupport);</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+    if (args.item.calendar) {</span>
<a href="#l5.15"></a><span id="l5.15">         gIsInvitation = args.item.calendar.isInvitation(args.item);</span>
<a href="#l5.16"></a><span id="l5.16">     }</span>
<a href="#l5.17"></a><span id="l5.17"> </span>
<a href="#l5.18"></a><span id="l5.18">     if (gIsReadOnly || gIsInvitation) {</span>
<a href="#l5.19"></a><span id="l5.19">         document.getElementById(&quot;next-slot&quot;)</span>
<a href="#l5.20"></a><span id="l5.20">             .setAttribute('disabled', 'true');</span>
<a href="#l5.21"></a><span id="l5.21">         document.getElementById(&quot;previous-slot&quot;)</span>
<a href="#l5.22"></a><span id="l5.22">             .setAttribute('disabled', 'true');</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-event-dialog-attendees.xml</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-event-dialog-attendees.xml</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -139,19 +139,18 @@</span>
<a href="#l6.4"></a><span id="l6.4"> </span>
<a href="#l6.5"></a><span id="l6.5">           this.mIsReadOnly = calendar.readOnly;</span>
<a href="#l6.6"></a><span id="l6.6"> </span>
<a href="#l6.7"></a><span id="l6.7">           // assume we're the organizer [in case that the calendar</span>
<a href="#l6.8"></a><span id="l6.8">           // does not support the concept of identities].</span>
<a href="#l6.9"></a><span id="l6.9">           var organizerID = ((organizer &amp;&amp; organizer.id)</span>
<a href="#l6.10"></a><span id="l6.10">                              ? organizer.id</span>
<a href="#l6.11"></a><span id="l6.11">                              : calendar.getProperty(&quot;organizerId&quot;));</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-          this.mIsInvitation = (calInstanceOf(calendar, Components.interfaces.calISchedulingSupport) &amp;&amp;</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-                                calendar.isInvitation(args.item));</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+          calendar = cal.wrapInstance(calendar, Components.interfaces.calISchedulingSupport);</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+          this.mIsInvitation = (calendar &amp;&amp; calendar.isInvitation(args.item));</span>
<a href="#l6.17"></a><span id="l6.17"> </span>
<a href="#l6.18"></a><span id="l6.18">           var listbox =</span>
<a href="#l6.19"></a><span id="l6.19">               document.getAnonymousElementByAttribute(</span>
<a href="#l6.20"></a><span id="l6.20">                   this, &quot;anonid&quot;, &quot;listbox&quot;);</span>
<a href="#l6.21"></a><span id="l6.21">           var template =</span>
<a href="#l6.22"></a><span id="l6.22">               document.getAnonymousElementByAttribute(</span>
<a href="#l6.23"></a><span id="l6.23">                   this, &quot;anonid&quot;, &quot;item&quot;);</span>
<a href="#l6.24"></a><span id="l6.24">           template.focus();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-event-dialog-recurrence.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-event-dialog-recurrence.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -40,19 +40,17 @@ function onLoad() {</span>
<a href="#l7.4"></a><span id="l7.4">         // Split out rules and exceptions</span>
<a href="#l7.5"></a><span id="l7.5">         try {</span>
<a href="#l7.6"></a><span id="l7.6">             var rrules = splitRecurrenceRules(recinfo);</span>
<a href="#l7.7"></a><span id="l7.7">             var rules = rrules[0];</span>
<a href="#l7.8"></a><span id="l7.8">             var exceptions = rrules[1];</span>
<a href="#l7.9"></a><span id="l7.9">             // Deal with the rules</span>
<a href="#l7.10"></a><span id="l7.10">             if (rules.length &gt; 0) {</span>
<a href="#l7.11"></a><span id="l7.11">                 // We only handle 1 rule currently</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-                if (calInstanceOf(rules[0], Components.interfaces.calIRecurrenceRule)) {</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-                    rule = rules[0];</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineminus">-                }</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+                rule = calWrapInstance(rules[0], Components.interfaces.calIRecurrenceRule);</span>
<a href="#l7.16"></a><span id="l7.16">             }</span>
<a href="#l7.17"></a><span id="l7.17">         } catch (ex) {</span>
<a href="#l7.18"></a><span id="l7.18">             Components.utils.reportError(ex);</span>
<a href="#l7.19"></a><span id="l7.19">         }</span>
<a href="#l7.20"></a><span id="l7.20">     }</span>
<a href="#l7.21"></a><span id="l7.21">     if (!rule) {</span>
<a href="#l7.22"></a><span id="l7.22">         rule = createRecurrenceRule();</span>
<a href="#l7.23"></a><span id="l7.23">         rule.type = 'DAILY';</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-event-dialog.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-event-dialog.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -755,18 +755,18 @@ function loadRepeat(item) {</span>
<a href="#l8.4"></a><span id="l8.4">         for each (var r in ritems) {</span>
<a href="#l8.5"></a><span id="l8.5">             if (r.isNegative) {</span>
<a href="#l8.6"></a><span id="l8.6">                 exceptions.push(r);</span>
<a href="#l8.7"></a><span id="l8.7">             } else {</span>
<a href="#l8.8"></a><span id="l8.8">                 rules.push(r);</span>
<a href="#l8.9"></a><span id="l8.9">             }</span>
<a href="#l8.10"></a><span id="l8.10">         }</span>
<a href="#l8.11"></a><span id="l8.11">         if (rules.length == 1) {</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-            var rule = rules[0];</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-            if (calInstanceOf(rule, Components.interfaces.calIRecurrenceRule)) {</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+            let rule = cal.wrapInstance(rules[0], Components.interfaces.calIRecurrenceRule);</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+            if (rule) {</span>
<a href="#l8.16"></a><span id="l8.16">                 switch (rule.type) {</span>
<a href="#l8.17"></a><span id="l8.17">                     case 'DAILY':</span>
<a href="#l8.18"></a><span id="l8.18">                         if (!checkRecurrenceRule(rule, ['BYSECOND',</span>
<a href="#l8.19"></a><span id="l8.19">                                                         'BYMINUTE',</span>
<a href="#l8.20"></a><span id="l8.20">                                                         'BYHOUR',</span>
<a href="#l8.21"></a><span id="l8.21">                                                         'BYMONTHDAY',</span>
<a href="#l8.22"></a><span id="l8.22">                                                         'BYYEARDAY',</span>
<a href="#l8.23"></a><span id="l8.23">                                                         'BYWEEKNO',</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-invitations-list.xml</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-invitations-list.xml</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -196,18 +196,19 @@</span>
<a href="#l9.4"></a><span id="l9.4">           return (att ? att.participationStatus : null);</span>
<a href="#l9.5"></a><span id="l9.5">         ]]&gt;&lt;/body&gt;</span>
<a href="#l9.6"></a><span id="l9.6">       &lt;/method&gt;</span>
<a href="#l9.7"></a><span id="l9.7"> </span>
<a href="#l9.8"></a><span id="l9.8">       &lt;method name=&quot;setCalendarItemParticipationStatus&quot;&gt;</span>
<a href="#l9.9"></a><span id="l9.9">         &lt;parameter name=&quot;aItem&quot;/&gt;</span>
<a href="#l9.10"></a><span id="l9.10">         &lt;parameter name=&quot;aStatus&quot;/&gt;</span>
<a href="#l9.11"></a><span id="l9.11">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-          if (calInstanceOf(aItem.calendar, Components.interfaces.calISchedulingSupport)) {</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-              var att = aItem.calendar.getInvitedAttendee(aItem);</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+          let wrappedCalendar = cal.wrapInstance(aItem.calendar, Components.interfaces.calISchedulingSupport);</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+          if (wrappedCalendar) {</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+              var att = wrappedCalendar.getInvitedAttendee(aItem);</span>
<a href="#l9.17"></a><span id="l9.17">               if (att) {</span>
<a href="#l9.18"></a><span id="l9.18">                   var att_ = att.clone();</span>
<a href="#l9.19"></a><span id="l9.19">                   att_.participationStatus = aStatus;</span>
<a href="#l9.20"></a><span id="l9.20"> </span>
<a href="#l9.21"></a><span id="l9.21">                   // Update attendee</span>
<a href="#l9.22"></a><span id="l9.22">                   aItem.removeAttendee(att);</span>
<a href="#l9.23"></a><span id="l9.23">                   aItem.addAttendee(att_);</span>
<a href="#l9.24"></a><span id="l9.24">                   return true;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-summary-dialog.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-summary-dialog.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -48,20 +48,20 @@ function onLoad() {</span>
<a href="#l10.4"></a><span id="l10.4">     if (cal.isEvent(item)) {</span>
<a href="#l10.5"></a><span id="l10.5">         setDialogId(document.documentElement, &quot;calendar-event-summary-dialog&quot;);</span>
<a href="#l10.6"></a><span id="l10.6">     } else if (cal.isToDo(item)) {</span>
<a href="#l10.7"></a><span id="l10.7">         setDialogId(document.documentElement, &quot;calendar-task-summary-dialog&quot;);</span>
<a href="#l10.8"></a><span id="l10.8">     }</span>
<a href="#l10.9"></a><span id="l10.9"> </span>
<a href="#l10.10"></a><span id="l10.10">     window.readOnly = !(isCalendarWritable(calendar)</span>
<a href="#l10.11"></a><span id="l10.11">                         &amp;&amp; (userCanModifyItem(item)</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-                            || (calInstanceOf(item.calendar, Components.interfaces.calISchedulingSupport)</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+                            || (cal.wrapInstance(item.calendar, Components.interfaces.calISchedulingSupport))</span>
<a href="#l10.14"></a><span id="l10.14">                                 &amp;&amp; item.calendar.isInvitation(item)</span>
<a href="#l10.15"></a><span id="l10.15">                                 &amp;&amp; userCanRespondToInvitation(item))));</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineminus">-    if (!window.readOnly &amp;&amp; calInstanceOf(calendar, Components.interfaces.calISchedulingSupport)) {</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineplus">+    if (!window.readOnly &amp;&amp; cal.wrapInstance(calendar, Components.interfaces.calISchedulingSupport)) {</span>
<a href="#l10.18"></a><span id="l10.18">         var attendee = calendar.getInvitedAttendee(item);</span>
<a href="#l10.19"></a><span id="l10.19">         if (attendee) {</span>
<a href="#l10.20"></a><span id="l10.20">             // if this is an unresponded invitation, preset our default alarm values:</span>
<a href="#l10.21"></a><span id="l10.21">             if (!item.getAlarms({}).length &amp;&amp;</span>
<a href="#l10.22"></a><span id="l10.22">                 (attendee.participationStatus == &quot;NEEDS-ACTION&quot;)) {</span>
<a href="#l10.23"></a><span id="l10.23">                 cal.alarms.setDefaultValues(item);</span>
<a href="#l10.24"></a><span id="l10.24">             }</span>
<a href="#l10.25"></a><span id="l10.25"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/calendar/base/modules/calItipUtils.jsm</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/calendar/base/modules/calItipUtils.jsm</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -15,18 +15,18 @@ EXPORTED_SYMBOLS = [&quot;cal&quot;]; // even thou</span>
<a href="#l11.4"></a><span id="l11.4"> cal.itip = {</span>
<a href="#l11.5"></a><span id="l11.5">     /**</span>
<a href="#l11.6"></a><span id="l11.6">      * Gets the sequence/revision number, either of the passed item or</span>
<a href="#l11.7"></a><span id="l11.7">      * the last received one of an attendee; see</span>
<a href="#l11.8"></a><span id="l11.8">      * &lt;http://tools.ietf.org/html/draft-desruisseaux-caldav-sched-04#section-7.1&gt;.</span>
<a href="#l11.9"></a><span id="l11.9">      */</span>
<a href="#l11.10"></a><span id="l11.10">      getSequence: function cal_itip_getSequence(item) {</span>
<a href="#l11.11"></a><span id="l11.11">         let seq = null;</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-        if (cal.calInstanceOf(item, Components.interfaces.calIAttendee)) {</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+        item = cal.wrapInstance(item, Components.interfaces.calIAttendee);</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+        if (item) {</span>
<a href="#l11.16"></a><span id="l11.16">             seq = item.getProperty(&quot;RECEIVED-SEQUENCE&quot;);</span>
<a href="#l11.17"></a><span id="l11.17">         } else if (item) {</span>
<a href="#l11.18"></a><span id="l11.18">             // Unless the below is standardized, we store the last original</span>
<a href="#l11.19"></a><span id="l11.19">             // REQUEST/PUBLISH SEQUENCE in X-MOZ-RECEIVED-SEQUENCE to test against it</span>
<a href="#l11.20"></a><span id="l11.20">             // when updates come in:</span>
<a href="#l11.21"></a><span id="l11.21">             seq = item.getProperty(&quot;X-MOZ-RECEIVED-SEQUENCE&quot;);</span>
<a href="#l11.22"></a><span id="l11.22">             if (seq === null) {</span>
<a href="#l11.23"></a><span id="l11.23">                 seq = item.getProperty(&quot;SEQUENCE&quot;);</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineat">@@ -50,17 +50,18 @@ cal.itip = {</span>
<a href="#l11.25"></a><span id="l11.25">     /**</span>
<a href="#l11.26"></a><span id="l11.26">      * Gets the stamp date-time, either of the passed item or</span>
<a href="#l11.27"></a><span id="l11.27">      * the last received one of an attendee; see</span>
<a href="#l11.28"></a><span id="l11.28">      * &lt;http://tools.ietf.org/html/draft-desruisseaux-caldav-sched-04#section-7.2&gt;.</span>
<a href="#l11.29"></a><span id="l11.29">      */</span>
<a href="#l11.30"></a><span id="l11.30">     getStamp: function cal_itip_getStamp(item) {</span>
<a href="#l11.31"></a><span id="l11.31">         let dtstamp = null;</span>
<a href="#l11.32"></a><span id="l11.32"> </span>
<a href="#l11.33"></a><span id="l11.33" class="difflineminus">-        if (cal.calInstanceOf(item, Components.interfaces.calIAttendee)) {</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineplus">+        item = cal.wrapInstance(item, Components.interfaces.calIAttendee);</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineplus">+        if (item) {</span>
<a href="#l11.36"></a><span id="l11.36">             let st = item.getProperty(&quot;RECEIVED-DTSTAMP&quot;);</span>
<a href="#l11.37"></a><span id="l11.37">             if (st) {</span>
<a href="#l11.38"></a><span id="l11.38">                 dtstamp = cal.createDateTime(st);</span>
<a href="#l11.39"></a><span id="l11.39">             }</span>
<a href="#l11.40"></a><span id="l11.40">         } else if (item) {</span>
<a href="#l11.41"></a><span id="l11.41">             // Unless the below is standardized, we store the last original</span>
<a href="#l11.42"></a><span id="l11.42">             // REQUEST/PUBLISH DTSTAMP in X-MOZ-RECEIVED-DTSTAMP to test against it</span>
<a href="#l11.43"></a><span id="l11.43">             // when updates come in:</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineat">@@ -528,21 +529,21 @@ cal.itip = {</span>
<a href="#l11.45"></a><span id="l11.45">             }</span>
<a href="#l11.46"></a><span id="l11.46"> </span>
<a href="#l11.47"></a><span id="l11.47">             if (aOriginalItem.recurrenceInfo &amp;&amp; aItem.recurrenceInfo) {</span>
<a href="#l11.48"></a><span id="l11.48">                 // check whether the two differ only in EXDATEs</span>
<a href="#l11.49"></a><span id="l11.49">                 let clonedItem = aItem.clone();</span>
<a href="#l11.50"></a><span id="l11.50">                 let exdates = [];</span>
<a href="#l11.51"></a><span id="l11.51">                 for each (let ritem in clonedItem.recurrenceInfo.getRecurrenceItems({})) {</span>
<a href="#l11.52"></a><span id="l11.52">                     if (ritem.isNegative &amp;&amp;</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineminus">-                        cal.calInstanceOf(ritem, Components.interfaces.calIRecurrenceDate) &amp;&amp;</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineplus">+                        cal.wrapInstance(ritem, Components.interfaces.calIRecurrenceDate) &amp;&amp;</span>
<a href="#l11.55"></a><span id="l11.55">                         !aOriginalItem.recurrenceInfo.getRecurrenceItems({}).some(</span>
<a href="#l11.56"></a><span id="l11.56">                             function(r) {</span>
<a href="#l11.57"></a><span id="l11.57">                                 return (r.isNegative &amp;&amp;</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineminus">-                                        cal.calInstanceOf(r, Components.interfaces.calIRecurrenceDate) &amp;&amp;</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineplus">+                                        cal.wrapInstance(r, Components.interfaces.calIRecurrenceDate) &amp;&amp;</span>
<a href="#l11.60"></a><span id="l11.60">                                         r.date.compare(ritem.date) == 0);</span>
<a href="#l11.61"></a><span id="l11.61">                             })) {</span>
<a href="#l11.62"></a><span id="l11.62">                         exdates.push(ritem);</span>
<a href="#l11.63"></a><span id="l11.63">                     }</span>
<a href="#l11.64"></a><span id="l11.64">                 }</span>
<a href="#l11.65"></a><span id="l11.65">                 if (exdates.length &gt; 0) {</span>
<a href="#l11.66"></a><span id="l11.66">                     // check whether really only EXDATEs have been added:</span>
<a href="#l11.67"></a><span id="l11.67">                     let recInfo = clonedItem.recurrenceInfo;</span>
<a href="#l11.68"></a><span id="l11.68" class="difflineat">@@ -741,22 +742,22 @@ cal.itip = {</span>
<a href="#l11.69"></a><span id="l11.69"> </span>
<a href="#l11.70"></a><span id="l11.70"> /** local to this module file</span>
<a href="#l11.71"></a><span id="l11.71">  * Sets the received info either on the passed attendee or item object.</span>
<a href="#l11.72"></a><span id="l11.72">  *</span>
<a href="#l11.73"></a><span id="l11.73">  * @param item either  calIAttendee or calIItemBase</span>
<a href="#l11.74"></a><span id="l11.74">  * @param itipItemItem received iTIP item</span>
<a href="#l11.75"></a><span id="l11.75">  */</span>
<a href="#l11.76"></a><span id="l11.76"> function setReceivedInfo(item, itipItemItem) {</span>
<a href="#l11.77"></a><span id="l11.77" class="difflineminus">-    item.setProperty(cal.calInstanceOf(item, Components.interfaces.calIAttendee) ? &quot;RECEIVED-SEQUENCE&quot;</span>
<a href="#l11.78"></a><span id="l11.78" class="difflineplus">+    item.setProperty(cal.wrapInstance(item, Components.interfaces.calIAttendee) ? &quot;RECEIVED-SEQUENCE&quot;</span>
<a href="#l11.79"></a><span id="l11.79">                                                                                  : &quot;X-MOZ-RECEIVED-SEQUENCE&quot;,</span>
<a href="#l11.80"></a><span id="l11.80">                      String(cal.itip.getSequence(itipItemItem)));</span>
<a href="#l11.81"></a><span id="l11.81">     let dtstamp = cal.itip.getStamp(itipItemItem);</span>
<a href="#l11.82"></a><span id="l11.82">     if (dtstamp) {</span>
<a href="#l11.83"></a><span id="l11.83" class="difflineminus">-        item.setProperty(cal.calInstanceOf(item, Components.interfaces.calIAttendee) ? &quot;RECEIVED-DTSTAMP&quot;</span>
<a href="#l11.84"></a><span id="l11.84" class="difflineplus">+        item.setProperty(cal.wrapInstance(item, Components.interfaces.calIAttendee) ? &quot;RECEIVED-DTSTAMP&quot;</span>
<a href="#l11.85"></a><span id="l11.85">                                                                                      : &quot;X-MOZ-RECEIVED-DTSTAMP&quot;,</span>
<a href="#l11.86"></a><span id="l11.86">                          dtstamp.getInTimezone(cal.UTC()).icalString);</span>
<a href="#l11.87"></a><span id="l11.87">     }</span>
<a href="#l11.88"></a><span id="l11.88"> }</span>
<a href="#l11.89"></a><span id="l11.89"> </span>
<a href="#l11.90"></a><span id="l11.90"> /**</span>
<a href="#l11.91"></a><span id="l11.91">  * Strips user specific data, e.g. categories and alarm settings and returns the stripped item.</span>
<a href="#l11.92"></a><span id="l11.92">  */</span>
<a href="#l11.93"></a><span id="l11.93" class="difflineat">@@ -879,31 +880,19 @@ function createOrganizer(aCalendar) {</span>
<a href="#l11.94"></a><span id="l11.94">  * @param aMethod iTIP method</span>
<a href="#l11.95"></a><span id="l11.95">  * @param aRecipientsList an array of calIAttendee objects the message should be sent to</span>
<a href="#l11.96"></a><span id="l11.96">  * @param autoResponse an inout object whether the transport should ask before sending</span>
<a href="#l11.97"></a><span id="l11.97">  */</span>
<a href="#l11.98"></a><span id="l11.98"> function sendMessage(aItem, aMethod, aRecipientsList, autoResponse) {</span>
<a href="#l11.99"></a><span id="l11.99">     if (aRecipientsList.length == 0) {</span>
<a href="#l11.100"></a><span id="l11.100">         return;</span>
<a href="#l11.101"></a><span id="l11.101">     }</span>
<a href="#l11.102"></a><span id="l11.102" class="difflineminus">-    if (cal.calInstanceOf(aItem.calendar, Components.interfaces.calISchedulingSupport)) {</span>
<a href="#l11.103"></a><span id="l11.103" class="difflineminus">-        // HACK: Usage of QueryInterface kind of hackish, need to remove all</span>
<a href="#l11.104"></a><span id="l11.104" class="difflineminus">-        // calls of calInstanceOf since casting happens per-compartment.</span>
<a href="#l11.105"></a><span id="l11.105" class="difflineminus">-        //</span>
<a href="#l11.106"></a><span id="l11.106" class="difflineminus">-        // Works:</span>
<a href="#l11.107"></a><span id="l11.107" class="difflineminus">-        //   let foo = aItem.calendar;</span>
<a href="#l11.108"></a><span id="l11.108" class="difflineminus">-        //   (foo instanceof Ci.calISchedulingSupport);</span>
<a href="#l11.109"></a><span id="l11.109" class="difflineminus">-        //   cal.calInstanceOf(aItem.calendar, Ci.calISchedulingSupport) &amp;&amp; aItem.calendar.canNotify();</span>
<a href="#l11.110"></a><span id="l11.110" class="difflineminus">-        // Fails:</span>
<a href="#l11.111"></a><span id="l11.111" class="difflineminus">-        //   let foo = aItem.calendar;</span>
<a href="#l11.112"></a><span id="l11.112" class="difflineminus">-        //   cal.calInstanceOf(aItem.calendar, Ci.calISchedulingSupport) &amp;&amp; aItem.calendar.canNotify();</span>
<a href="#l11.113"></a><span id="l11.113" class="difflineminus">-        if (aItem.calendar.QueryInterface(Components.interfaces.calISchedulingSupport)</span>
<a href="#l11.114"></a><span id="l11.114" class="difflineminus">-                          .canNotify(aMethod, aItem)) {</span>
<a href="#l11.115"></a><span id="l11.115" class="difflineminus">-            return; //provider will handle that</span>
<a href="#l11.116"></a><span id="l11.116" class="difflineminus">-        }</span>
<a href="#l11.117"></a><span id="l11.117" class="difflineplus">+    aItem.calendar = cal.wrapInstance(aItem.calendar, Components.interfaces.calISchedulingSupport);</span>
<a href="#l11.118"></a><span id="l11.118" class="difflineplus">+    if (aItem.calendar &amp;&amp; aItem.calendar.canNotify(aMethod, aItem)) {</span>
<a href="#l11.119"></a><span id="l11.119" class="difflineplus">+          return; // provider will handle that</span>
<a href="#l11.120"></a><span id="l11.120">     }</span>
<a href="#l11.121"></a><span id="l11.121"> </span>
<a href="#l11.122"></a><span id="l11.122">     let aTransport = aItem.calendar.getProperty(&quot;itip.transport&quot;);</span>
<a href="#l11.123"></a><span id="l11.123">     if (!aTransport) { // can only send if there's a transport for the calendar</span>
<a href="#l11.124"></a><span id="l11.124">         return;</span>
<a href="#l11.125"></a><span id="l11.125">     }</span>
<a href="#l11.126"></a><span id="l11.126">     aTransport = aTransport.QueryInterface(Components.interfaces.calIItipTransport);</span>
<a href="#l11.127"></a><span id="l11.127"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/calendar/base/modules/calRecurrenceUtils.jsm</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/calendar/base/modules/calRecurrenceUtils.jsm</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -20,19 +20,19 @@ function recurrenceRule2String(recurrenc</span>
<a href="#l12.4"></a><span id="l12.4">     function getRString(name, args) cal.calGetString(&quot;calendar-event-dialog&quot;, name, args);</span>
<a href="#l12.5"></a><span id="l12.5"> </span>
<a href="#l12.6"></a><span id="l12.6">     // Retrieve a valid recurrence rule from the currently</span>
<a href="#l12.7"></a><span id="l12.7">     // set recurrence info. Bail out if there's more</span>
<a href="#l12.8"></a><span id="l12.8">     // than a single rule or something other than a rule.</span>
<a href="#l12.9"></a><span id="l12.9">     recurrenceInfo = recurrenceInfo.clone();</span>
<a href="#l12.10"></a><span id="l12.10">     let rrules = splitRecurrenceRules(recurrenceInfo);</span>
<a href="#l12.11"></a><span id="l12.11">     if (rrules[0].length == 1) {</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-        let rule = rrules[0][0];</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+        let rule = cal.wrapInstance(rrules[0][0], Components.interfaces.calIRecurrenceRule);</span>
<a href="#l12.14"></a><span id="l12.14">         // currently we don't allow for any BYxxx-rules.</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineminus">-        if (cal.calInstanceOf(rule, Components.interfaces.calIRecurrenceRule) &amp;&amp;</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineplus">+        if ((rule) &amp;&amp;</span>
<a href="#l12.17"></a><span id="l12.17">             !checkRecurrenceRule(rule, ['BYSECOND',</span>
<a href="#l12.18"></a><span id="l12.18">                                         'BYMINUTE',</span>
<a href="#l12.19"></a><span id="l12.19">                                         //'BYDAY',</span>
<a href="#l12.20"></a><span id="l12.20">                                         'BYHOUR',</span>
<a href="#l12.21"></a><span id="l12.21">                                         //'BYMONTHDAY',</span>
<a href="#l12.22"></a><span id="l12.22">                                         'BYYEARDAY',</span>
<a href="#l12.23"></a><span id="l12.23">                                         'BYWEEKNO',</span>
<a href="#l12.24"></a><span id="l12.24">                                         //'BYMONTH',</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/calendar/base/modules/calUtils.jsm</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/calendar/base/modules/calUtils.jsm</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -165,31 +165,31 @@ let cal = {</span>
<a href="#l13.4"></a><span id="l13.4">         return serializer.serializeToString();</span>
<a href="#l13.5"></a><span id="l13.5">     },</span>
<a href="#l13.6"></a><span id="l13.6"> </span>
<a href="#l13.7"></a><span id="l13.7">     /**</span>
<a href="#l13.8"></a><span id="l13.8">      * Shortcut function to check whether an item is an invitation copy.</span>
<a href="#l13.9"></a><span id="l13.9">      */</span>
<a href="#l13.10"></a><span id="l13.10">     isInvitation: function cal_isInvitation(aItem) {</span>
<a href="#l13.11"></a><span id="l13.11">         let isInvitation = false;</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-        let calendar = aItem.calendar;</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-        if (cal.calInstanceOf(calendar, Components.interfaces.calISchedulingSupport)) {</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+        let calendar = cal.wrapInstance(aItem.calendar, Components.interfaces.calISchedulingSupport);</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+        if (calendar) {</span>
<a href="#l13.16"></a><span id="l13.16">             isInvitation = calendar.isInvitation(aItem);</span>
<a href="#l13.17"></a><span id="l13.17">         }</span>
<a href="#l13.18"></a><span id="l13.18">         return isInvitation;</span>
<a href="#l13.19"></a><span id="l13.19">     },</span>
<a href="#l13.20"></a><span id="l13.20"> </span>
<a href="#l13.21"></a><span id="l13.21">     /**</span>
<a href="#l13.22"></a><span id="l13.22">      * Shortcut function to check whether an item is an invitation copy and</span>
<a href="#l13.23"></a><span id="l13.23">      * has a participation status of either NEEDS-ACTION or TENTATIVE.</span>
<a href="#l13.24"></a><span id="l13.24">      *</span>
<a href="#l13.25"></a><span id="l13.25">      * @param aItem either calIAttendee or calIItemBase </span>
<a href="#l13.26"></a><span id="l13.26">      */</span>
<a href="#l13.27"></a><span id="l13.27">     isOpenInvitation: function cal_isOpenInvitation(aItem) {</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineminus">-        if (!cal.calInstanceOf(aItem, Components.interfaces.calIAttendee)) {</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineplus">+        if (!cal.wrapInstance(aItem, Components.interfaces.calIAttendee)) {</span>
<a href="#l13.30"></a><span id="l13.30">             aItem = cal.getInvitedAttendee(aItem);</span>
<a href="#l13.31"></a><span id="l13.31">         }</span>
<a href="#l13.32"></a><span id="l13.32">         if (aItem) {</span>
<a href="#l13.33"></a><span id="l13.33">             switch (aItem.participationStatus) {</span>
<a href="#l13.34"></a><span id="l13.34">                 case &quot;NEEDS-ACTION&quot;:</span>
<a href="#l13.35"></a><span id="l13.35">                 case &quot;TENTATIVE&quot;:</span>
<a href="#l13.36"></a><span id="l13.36">                     return true;</span>
<a href="#l13.37"></a><span id="l13.37">             }</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineat">@@ -197,20 +197,20 @@ let cal = {</span>
<a href="#l13.39"></a><span id="l13.39">         return false;</span>
<a href="#l13.40"></a><span id="l13.40">     },</span>
<a href="#l13.41"></a><span id="l13.41"> </span>
<a href="#l13.42"></a><span id="l13.42">     /**</span>
<a href="#l13.43"></a><span id="l13.43">      * Shortcut function to get the invited attendee of an item.</span>
<a href="#l13.44"></a><span id="l13.44">      */</span>
<a href="#l13.45"></a><span id="l13.45">     getInvitedAttendee: function cal_getInvitedAttendee(aItem, aCalendar) {</span>
<a href="#l13.46"></a><span id="l13.46">         if (!aCalendar) {</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineminus">-            aCalendar = aItem.calendar;</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineplus">+            aCalendar = cal.wrapInstance(aItem.calendar, Components.interfaces.calISchedulingSupport);</span>
<a href="#l13.49"></a><span id="l13.49">         }</span>
<a href="#l13.50"></a><span id="l13.50">         let invitedAttendee = null;</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineminus">-        if (cal.calInstanceOf(aCalendar, Components.interfaces.calISchedulingSupport)) {</span>
<a href="#l13.52"></a><span id="l13.52" class="difflineplus">+        if (aCalendar) {</span>
<a href="#l13.53"></a><span id="l13.53">             invitedAttendee = aCalendar.getInvitedAttendee(aItem);</span>
<a href="#l13.54"></a><span id="l13.54">         }</span>
<a href="#l13.55"></a><span id="l13.55">         return invitedAttendee;</span>
<a href="#l13.56"></a><span id="l13.56">     },</span>
<a href="#l13.57"></a><span id="l13.57"> </span>
<a href="#l13.58"></a><span id="l13.58">     // The below functions will move to some different place once the</span>
<a href="#l13.59"></a><span id="l13.59">     // unifinder tress are consolidated.</span>
<a href="#l13.60"></a><span id="l13.60"> </span>
<a href="#l13.61"></a><span id="l13.61" class="difflineat">@@ -599,16 +599,30 @@ let cal = {</span>
<a href="#l13.62"></a><span id="l13.62">                     func(subject, topic, data);</span>
<a href="#l13.63"></a><span id="l13.63">                 }</span>
<a href="#l13.64"></a><span id="l13.64">             }</span>
<a href="#l13.65"></a><span id="l13.65">         };</span>
<a href="#l13.66"></a><span id="l13.66">         Services.obs.addObserver(observer, topic, false /* don't hold weakly */);</span>
<a href="#l13.67"></a><span id="l13.67">     },</span>
<a href="#l13.68"></a><span id="l13.68"> </span>
<a href="#l13.69"></a><span id="l13.69">     /**</span>
<a href="#l13.70"></a><span id="l13.70" class="difflineplus">+     * Wraps an instance. Replaces calInstanceOf from calUtils.js</span>
<a href="#l13.71"></a><span id="l13.71" class="difflineplus">+     *</span>
<a href="#l13.72"></a><span id="l13.72" class="difflineplus">+     * @param aObj the object under consideration</span>
<a href="#l13.73"></a><span id="l13.73" class="difflineplus">+     * @param aInterface the interface to be wrapped</span>
<a href="#l13.74"></a><span id="l13.74" class="difflineplus">+     */</span>
<a href="#l13.75"></a><span id="l13.75" class="difflineplus">+    wrapInstance: function wrapInstance(aObj, aInterface) {</span>
<a href="#l13.76"></a><span id="l13.76" class="difflineplus">+        try {</span>
<a href="#l13.77"></a><span id="l13.77" class="difflineplus">+            return aObj.QueryInterface(aInterface);</span>
<a href="#l13.78"></a><span id="l13.78" class="difflineplus">+        } catch (e) {</span>
<a href="#l13.79"></a><span id="l13.79" class="difflineplus">+            return null;</span>
<a href="#l13.80"></a><span id="l13.80" class="difflineplus">+        }</span>
<a href="#l13.81"></a><span id="l13.81" class="difflineplus">+    },</span>
<a href="#l13.82"></a><span id="l13.82" class="difflineplus">+</span>
<a href="#l13.83"></a><span id="l13.83" class="difflineplus">+    /**</span>
<a href="#l13.84"></a><span id="l13.84">      * Adds an xpcom shutdown observer.</span>
<a href="#l13.85"></a><span id="l13.85">      *</span>
<a href="#l13.86"></a><span id="l13.86">      * @param func function to execute</span>
<a href="#l13.87"></a><span id="l13.87">      */</span>
<a href="#l13.88"></a><span id="l13.88">     addShutdownObserver: function cal_addShutdownObserver(func) {</span>
<a href="#l13.89"></a><span id="l13.89">         cal.addObserver(func, &quot;xpcom-shutdown&quot;, true /* one time */);</span>
<a href="#l13.90"></a><span id="l13.90">     },</span>
<a href="#l13.91"></a><span id="l13.91"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/calendar/base/src/calCachedCalendar.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/calendar/base/src/calCachedCalendar.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -665,17 +665,17 @@ calCachedCalendar.prototype = {</span>
<a href="#l14.4"></a><span id="l14.4">     set superCalendar(val) {</span>
<a href="#l14.5"></a><span id="l14.5">         return (this.mSuperCalendar = val);</span>
<a href="#l14.6"></a><span id="l14.6">     },</span>
<a href="#l14.7"></a><span id="l14.7"> </span>
<a href="#l14.8"></a><span id="l14.8">     get offline() {</span>
<a href="#l14.9"></a><span id="l14.9">         return Services.io.offline;</span>
<a href="#l14.10"></a><span id="l14.10">     },</span>
<a href="#l14.11"></a><span id="l14.11">     get supportsChangeLog() {</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-        return calInstanceOf(this.mUncachedCalendar, Components.interfaces.calIChangeLog);</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+        return (cal.wrapInstance(this.mUncachedCalendar, Components.interfaces.calIChangeLog) != null);</span>
<a href="#l14.14"></a><span id="l14.14">     },</span>
<a href="#l14.15"></a><span id="l14.15"> </span>
<a href="#l14.16"></a><span id="l14.16">     get canRefresh() { // enable triggering sync using the reload button</span>
<a href="#l14.17"></a><span id="l14.17">         return true;</span>
<a href="#l14.18"></a><span id="l14.18">     },</span>
<a href="#l14.19"></a><span id="l14.19"> </span>
<a href="#l14.20"></a><span id="l14.20">     getProperty: function(aName) {</span>
<a href="#l14.21"></a><span id="l14.21">         switch (aName) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/calendar/base/src/calCalendarManager.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/calendar/base/src/calCalendarManager.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -643,17 +643,18 @@ calCalendarManager.prototype = {</span>
<a href="#l15.4"></a><span id="l15.4"> </span>
<a href="#l15.5"></a><span id="l15.5">         // XXX This is a workaround for bug 351499. We should remove it once</span>
<a href="#l15.6"></a><span id="l15.6">         // we sort out the whole &quot;delete&quot; vs. &quot;unsubscribe&quot; UI thing.</span>
<a href="#l15.7"></a><span id="l15.7">         //</span>
<a href="#l15.8"></a><span id="l15.8">         // We only want to delete the contents of calendars from local</span>
<a href="#l15.9"></a><span id="l15.9">         // providers (storage and memory). Otherwise we may nuke someone's</span>
<a href="#l15.10"></a><span id="l15.10">         // calendar stored on a server when all they really wanted to do was</span>
<a href="#l15.11"></a><span id="l15.11">         // unsubscribe.</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-        if (cal.calInstanceOf(calendar, Components.interfaces.calICalendarProvider) &amp;&amp;</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+        calendar = cal.wrapInstance(calendar, Components.interfaces.calICalendarProvider);</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineplus">+        if (calendar &amp;&amp;</span>
<a href="#l15.15"></a><span id="l15.15">             (calendar.type == &quot;storage&quot; || calendar.type == &quot;memory&quot;)) {</span>
<a href="#l15.16"></a><span id="l15.16">             try {</span>
<a href="#l15.17"></a><span id="l15.17">                 calendar.deleteCalendar(calendar, null);</span>
<a href="#l15.18"></a><span id="l15.18">             } catch (e) {</span>
<a href="#l15.19"></a><span id="l15.19">                 Components.utils.reportError(&quot;error purging calendar: &quot; + e);</span>
<a href="#l15.20"></a><span id="l15.20">             }</span>
<a href="#l15.21"></a><span id="l15.21">         }</span>
<a href="#l15.22"></a><span id="l15.22">     },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/calendar/base/src/calRecurrenceInfo.js</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/calendar/base/src/calRecurrenceInfo.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -310,46 +310,48 @@ calRecurrenceInfo.prototype = {</span>
<a href="#l16.4"></a><span id="l16.4">             // Go through all positive rules and get the next recurrence id</span>
<a href="#l16.5"></a><span id="l16.5">             // according to that rule. If for all rules the rid is &quot;invalid&quot;,</span>
<a href="#l16.6"></a><span id="l16.6">             // (i.e an EXDATE removed it, or an exception moved it somewhere</span>
<a href="#l16.7"></a><span id="l16.7">             // else), then get the respective next rid.</span>
<a href="#l16.8"></a><span id="l16.8">             //</span>
<a href="#l16.9"></a><span id="l16.9">             // If in a loop at least one rid is valid (i.e not an exception, not</span>
<a href="#l16.10"></a><span id="l16.10">             // an exdate, is after aTime), then remember the lowest one.</span>
<a href="#l16.11"></a><span id="l16.11">             for (var i = 0; i &lt; this.mPositiveRules.length; i++) {</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-                if (calInstanceOf(this.mPositiveRules[i], Components.interfaces.calIRecurrenceDate)) {</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+                let rDateInstance = cal.wrapInstance(this.mPositiveRules[i], Components.interfaces.calIRecurrenceDate);</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineplus">+                let rRuleInstance = cal.wrapInstance(this.mPositiveRules[i], Components.interfaces.calIRecurrenceRule);</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineplus">+                if (rDateInstance) {</span>
<a href="#l16.16"></a><span id="l16.16">                     // RDATEs are special. there is only one date in this rule,</span>
<a href="#l16.17"></a><span id="l16.17">                     // so no need to search anything.</span>
<a href="#l16.18"></a><span id="l16.18" class="difflineminus">-                    var rdate = this.mPositiveRules[i].date;</span>
<a href="#l16.19"></a><span id="l16.19" class="difflineplus">+                    var rdate = rDateInstance.date;</span>
<a href="#l16.20"></a><span id="l16.20">                     if (!nextOccurrences[i] &amp;&amp; rdate.compare(aTime) &gt; 0) {</span>
<a href="#l16.21"></a><span id="l16.21">                         // The RDATE falls into range, save it.</span>
<a href="#l16.22"></a><span id="l16.22">                         nextOccurrences[i] = rdate;</span>
<a href="#l16.23"></a><span id="l16.23">                     } else {</span>
<a href="#l16.24"></a><span id="l16.24">                         // The RDATE doesn't fall into range. This rule will</span>
<a href="#l16.25"></a><span id="l16.25">                         // always be invalid, since it can't give out a date.</span>
<a href="#l16.26"></a><span id="l16.26">                         nextOccurrences[i] = null;</span>
<a href="#l16.27"></a><span id="l16.27">                         invalidOccurrences++;</span>
<a href="#l16.28"></a><span id="l16.28">                     }</span>
<a href="#l16.29"></a><span id="l16.29" class="difflineminus">-                } else if (calInstanceOf(this.mPositiveRules[i], Components.interfaces.calIRecurrenceRule)) {</span>
<a href="#l16.30"></a><span id="l16.30" class="difflineplus">+                } else if (rRuleInstance) {</span>
<a href="#l16.31"></a><span id="l16.31">                     // RRULEs must not start searching before |startDate|, since</span>
<a href="#l16.32"></a><span id="l16.32">                     // the pattern is only valid afterwards. If an occurrence</span>
<a href="#l16.33"></a><span id="l16.33">                     // was found in a previous round, we can go ahead and start</span>
<a href="#l16.34"></a><span id="l16.34">                     // searching from that occurrence.</span>
<a href="#l16.35"></a><span id="l16.35">                     var searchStart = nextOccurrences[i] || startDate;</span>
<a href="#l16.36"></a><span id="l16.36"> </span>
<a href="#l16.37"></a><span id="l16.37">                     // Search for the next occurrence after aTime. If the last</span>
<a href="#l16.38"></a><span id="l16.38">                     // round was invalid, then in this round we need to search</span>
<a href="#l16.39"></a><span id="l16.39">                     // after nextOccurrences[i] to make sure getNextOccurrence()</span>
<a href="#l16.40"></a><span id="l16.40">                     // doesn't find the same occurrence again.</span>
<a href="#l16.41"></a><span id="l16.41">                     var searchDate =</span>
<a href="#l16.42"></a><span id="l16.42">                         (nextOccurrences[i] &amp;&amp; nextOccurrences[i].compare(aTime) &gt; 0 ?</span>
<a href="#l16.43"></a><span id="l16.43">                             nextOccurrences[i] :</span>
<a href="#l16.44"></a><span id="l16.44">                             aTime);</span>
<a href="#l16.45"></a><span id="l16.45"> </span>
<a href="#l16.46"></a><span id="l16.46" class="difflineminus">-                    nextOccurrences[i] = this.mPositiveRules[i]</span>
<a href="#l16.47"></a><span id="l16.47" class="difflineplus">+                    nextOccurrences[i] = rRuleInstance</span>
<a href="#l16.48"></a><span id="l16.48">                                              .getNextOccurrence(searchStart, searchDate);</span>
<a href="#l16.49"></a><span id="l16.49">                 }</span>
<a href="#l16.50"></a><span id="l16.50"> </span>
<a href="#l16.51"></a><span id="l16.51">                 // As decided in bug 734245, an EXDATE of type DATE shall also match a DTSTART of type DATE-TIME</span>
<a href="#l16.52"></a><span id="l16.52">                 let nextKey = getRidKey(nextOccurrences[i]);</span>
<a href="#l16.53"></a><span id="l16.53">                 let isInExceptionMap = nextKey &amp;&amp; (this.mExceptionMap[nextKey.substring(0,8)] ||</span>
<a href="#l16.54"></a><span id="l16.54">                                                    this.mExceptionMap[nextKey]);</span>
<a href="#l16.55"></a><span id="l16.55">                 let isInNegMap = nextKey &amp;&amp; (negMap[nextKey.substring(0,8)] ||</span>
<a href="#l16.56"></a><span id="l16.56" class="difflineat">@@ -639,17 +641,17 @@ calRecurrenceInfo.prototype = {</span>
<a href="#l16.57"></a><span id="l16.57">     },</span>
<a href="#l16.58"></a><span id="l16.58"> </span>
<a href="#l16.59"></a><span id="l16.59">     restoreOccurrenceAt: function cRI_restoreOccurrenceAt(aRecurrenceId) {</span>
<a href="#l16.60"></a><span id="l16.60">         this.ensureBaseItem();</span>
<a href="#l16.61"></a><span id="l16.61">         this.ensureMutable();</span>
<a href="#l16.62"></a><span id="l16.62">         this.ensureSortedRecurrenceRules();</span>
<a href="#l16.63"></a><span id="l16.63"> </span>
<a href="#l16.64"></a><span id="l16.64">         for (var i = 0; i &lt; this.mRecurrenceItems.length; i++) {</span>
<a href="#l16.65"></a><span id="l16.65" class="difflineminus">-            if (calInstanceOf(this.mRecurrenceItems[i], Components.interfaces.calIRecurrenceDate)) {</span>
<a href="#l16.66"></a><span id="l16.66" class="difflineplus">+            if (cal.wrapInstance(this.mRecurrenceItems[i], Components.interfaces.calIRecurrenceDate)) {</span>
<a href="#l16.67"></a><span id="l16.67">                 var rd = this.mRecurrenceItems[i].QueryInterface(Components.interfaces.calIRecurrenceDate);</span>
<a href="#l16.68"></a><span id="l16.68">                 if (rd.isNegative &amp;&amp; rd.date.compare(aRecurrenceId) == 0) {</span>
<a href="#l16.69"></a><span id="l16.69">                     return this.deleteRecurrenceItemAt(i);</span>
<a href="#l16.70"></a><span id="l16.70">                 }</span>
<a href="#l16.71"></a><span id="l16.71">             }</span>
<a href="#l16.72"></a><span id="l16.72">         }</span>
<a href="#l16.73"></a><span id="l16.73"> </span>
<a href="#l16.74"></a><span id="l16.74">         throw Components.results.NS_ERROR_INVALID_ARG;</span>
<a href="#l16.75"></a><span id="l16.75" class="difflineat">@@ -762,25 +764,27 @@ calRecurrenceInfo.prototype = {</span>
<a href="#l16.76"></a><span id="l16.76">         let timeDiff = aNewStartTime.getInTimezone(UTC()).subtractDate(aOldStartTime.getInTimezone(UTC()));</span>
<a href="#l16.77"></a><span id="l16.77"> </span>
<a href="#l16.78"></a><span id="l16.78">         let rdates = {};</span>
<a href="#l16.79"></a><span id="l16.79"> </span>
<a href="#l16.80"></a><span id="l16.80">         // take RDATE's and EXDATE's into account.</span>
<a href="#l16.81"></a><span id="l16.81">         const kCalIRecurrenceDate = Components.interfaces.calIRecurrenceDate;</span>
<a href="#l16.82"></a><span id="l16.82">         let ritems = this.getRecurrenceItems({});</span>
<a href="#l16.83"></a><span id="l16.83">         for each (let ritem in ritems) {</span>
<a href="#l16.84"></a><span id="l16.84" class="difflineminus">-            if (cal.calInstanceOf(ritem, kCalIRecurrenceDate)) {</span>
<a href="#l16.85"></a><span id="l16.85" class="difflineplus">+            if (cal.wrapInstance(ritem, kCalIRecurrenceDate)) {</span>
<a href="#l16.86"></a><span id="l16.86" class="difflineplus">+                // Possible performance issue with QueryInterface</span>
<a href="#l16.87"></a><span id="l16.87" class="difflineplus">+                // as cal.wrapInstance already tries to do one</span>
<a href="#l16.88"></a><span id="l16.88">                 ritem = ritem.QueryInterface(kCalIRecurrenceDate);</span>
<a href="#l16.89"></a><span id="l16.89">                 let date = ritem.date;</span>
<a href="#l16.90"></a><span id="l16.90">                 date.addDuration(timeDiff);</span>
<a href="#l16.91"></a><span id="l16.91">                 if (!ritem.isNegative) {</span>
<a href="#l16.92"></a><span id="l16.92">                     rdates[getRidKey(date)] = date;</span>
<a href="#l16.93"></a><span id="l16.93">                 }</span>
<a href="#l16.94"></a><span id="l16.94">                 ritem.date = date;</span>
<a href="#l16.95"></a><span id="l16.95" class="difflineminus">-            } else if (cal.calInstanceOf(ritem, Components.interfaces.calIRecurrenceRule)) {</span>
<a href="#l16.96"></a><span id="l16.96" class="difflineplus">+            } else if (cal.wrapInstance(ritem, Components.interfaces.calIRecurrenceRule)) {</span>
<a href="#l16.97"></a><span id="l16.97">                 ritem = ritem.QueryInterface(Components.interfaces.calIRecurrenceRule);</span>
<a href="#l16.98"></a><span id="l16.98">                 if (!ritem.isByCount) {</span>
<a href="#l16.99"></a><span id="l16.99">                     let untilDate = ritem.untilDate;</span>
<a href="#l16.100"></a><span id="l16.100">                     if (untilDate) {</span>
<a href="#l16.101"></a><span id="l16.101">                         untilDate.addDuration(timeDiff);</span>
<a href="#l16.102"></a><span id="l16.102">                         ritem.untilDate = untilDate;</span>
<a href="#l16.103"></a><span id="l16.103">                     }</span>
<a href="#l16.104"></a><span id="l16.104">                 }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/calendar/base/src/calUtils.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/calendar/base/src/calUtils.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -411,53 +411,33 @@ function isItemSupported(aItem, aCalenda</span>
<a href="#l17.4"></a><span id="l17.4">         return (aCalendar.getProperty(&quot;capabilities.tasks.supported&quot;) !== false);</span>
<a href="#l17.5"></a><span id="l17.5">     } else if (isEvent(aItem)) {</span>
<a href="#l17.6"></a><span id="l17.6">         return (aCalendar.getProperty(&quot;capabilities.events.supported&quot;) !== false);</span>
<a href="#l17.7"></a><span id="l17.7">     }</span>
<a href="#l17.8"></a><span id="l17.8">     return false;</span>
<a href="#l17.9"></a><span id="l17.9"> }</span>
<a href="#l17.10"></a><span id="l17.10"> </span>
<a href="#l17.11"></a><span id="l17.11"> /**</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">- * (At least on branch 1.8), the js instanceof operator does not work to test</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineminus">- * interfaces on direct implementation objects, i.e. non-wrapped objects.</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineminus">- * This function falla back to using QueryInterface to check whether the interface</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineminus">- * is implemented.</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineminus">- */</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineminus">-function calInstanceOf(aObject, aInterface) {</span>
<a href="#l17.18"></a><span id="l17.18" class="difflineminus">-    // We first try instanceof which is assumed to be faster than querying the object:</span>
<a href="#l17.19"></a><span id="l17.19" class="difflineminus">-    if (!(aObject instanceof aInterface)) {</span>
<a href="#l17.20"></a><span id="l17.20" class="difflineminus">-        // if the passed object in not wrapped (but a plain implementation),</span>
<a href="#l17.21"></a><span id="l17.21" class="difflineminus">-        // instanceof won't check QueryInterface.</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineminus">-        try {</span>
<a href="#l17.23"></a><span id="l17.23" class="difflineminus">-            aObject.QueryInterface(aInterface);</span>
<a href="#l17.24"></a><span id="l17.24" class="difflineminus">-        } catch (exc) {</span>
<a href="#l17.25"></a><span id="l17.25" class="difflineminus">-            return false;</span>
<a href="#l17.26"></a><span id="l17.26" class="difflineminus">-        }</span>
<a href="#l17.27"></a><span id="l17.27" class="difflineminus">-    }</span>
<a href="#l17.28"></a><span id="l17.28" class="difflineminus">-    return true;</span>
<a href="#l17.29"></a><span id="l17.29" class="difflineminus">-}</span>
<a href="#l17.30"></a><span id="l17.30" class="difflineminus">-</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineminus">-/**</span>
<a href="#l17.32"></a><span id="l17.32">  * Determines whether or not the aObject is a calIEvent</span>
<a href="#l17.33"></a><span id="l17.33">  *</span>
<a href="#l17.34"></a><span id="l17.34">  * @param aObject  the object to test</span>
<a href="#l17.35"></a><span id="l17.35">  * @returns        true if the object is a calIEvent, false otherwise</span>
<a href="#l17.36"></a><span id="l17.36">  */</span>
<a href="#l17.37"></a><span id="l17.37"> function isEvent(aObject) {</span>
<a href="#l17.38"></a><span id="l17.38" class="difflineminus">-    return calInstanceOf(aObject, Components.interfaces.calIEvent);</span>
<a href="#l17.39"></a><span id="l17.39" class="difflineplus">+    return (cal.wrapInstance(aObject, Components.interfaces.calIEvent) != null);</span>
<a href="#l17.40"></a><span id="l17.40"> }</span>
<a href="#l17.41"></a><span id="l17.41"> </span>
<a href="#l17.42"></a><span id="l17.42"> /**</span>
<a href="#l17.43"></a><span id="l17.43">  * Determines whether or not the aObject is a calITodo</span>
<a href="#l17.44"></a><span id="l17.44">  *</span>
<a href="#l17.45"></a><span id="l17.45">  * @param aObject  the object to test</span>
<a href="#l17.46"></a><span id="l17.46">  * @returns        true if the object is a calITodo, false otherwise</span>
<a href="#l17.47"></a><span id="l17.47">  */</span>
<a href="#l17.48"></a><span id="l17.48"> function isToDo(aObject) {</span>
<a href="#l17.49"></a><span id="l17.49" class="difflineminus">-    return calInstanceOf(aObject, Components.interfaces.calITodo);</span>
<a href="#l17.50"></a><span id="l17.50" class="difflineplus">+    return (cal.wrapInstance(aObject, Components.interfaces.calITodo) != null);</span>
<a href="#l17.51"></a><span id="l17.51"> }</span>
<a href="#l17.52"></a><span id="l17.52"> </span>
<a href="#l17.53"></a><span id="l17.53"> /**</span>
<a href="#l17.54"></a><span id="l17.54">  * Normal get*Pref calls will throw if the pref is undefined.  This function</span>
<a href="#l17.55"></a><span id="l17.55">  * will get a bool, int, or string pref.  If the pref is undefined, it will</span>
<a href="#l17.56"></a><span id="l17.56">  * return aDefault.</span>
<a href="#l17.57"></a><span id="l17.57">  *</span>
<a href="#l17.58"></a><span id="l17.58">  * @param aPrefName   the (full) name of preference to get</span>
<a href="#l17.59"></a><span id="l17.59" class="difflineat">@@ -1412,17 +1392,18 @@ function calGetProductVersion() {</span>
<a href="#l17.60"></a><span id="l17.60">  * ical component.  This should be used whenever you need to set the prodid</span>
<a href="#l17.61"></a><span id="l17.61">  * and version on a calIcalComponent object.</span>
<a href="#l17.62"></a><span id="l17.62">  *</span>
<a href="#l17.63"></a><span id="l17.63">  * @param</span>
<a href="#l17.64"></a><span id="l17.64">  *      aIcalComponent  The ical component to set the prodid and version on.</span>
<a href="#l17.65"></a><span id="l17.65">  */</span>
<a href="#l17.66"></a><span id="l17.66"> function calSetProdidVersion(aIcalComponent) {</span>
<a href="#l17.67"></a><span id="l17.67">     // Throw for an invalid parameter</span>
<a href="#l17.68"></a><span id="l17.68" class="difflineminus">-    if (!calInstanceOf(aIcalComponent, Components.interfaces.calIIcalComponent)) {</span>
<a href="#l17.69"></a><span id="l17.69" class="difflineplus">+    aIcalComponent = cal.wrapInstance(aIcalComponent, Components.interfaces.calIIcalComponent);</span>
<a href="#l17.70"></a><span id="l17.70" class="difflineplus">+    if (!aIcalComponent) {</span>
<a href="#l17.71"></a><span id="l17.71">         throw Components.results.NS_ERROR_INVALID_ARG;</span>
<a href="#l17.72"></a><span id="l17.72">     }</span>
<a href="#l17.73"></a><span id="l17.73">     // Set the prodid and version</span>
<a href="#l17.74"></a><span id="l17.74">     aIcalComponent.prodid = calGetProductId();</span>
<a href="#l17.75"></a><span id="l17.75">     aIcalComponent.version = calGetProductVersion();</span>
<a href="#l17.76"></a><span id="l17.76"> }</span>
<a href="#l17.77"></a><span id="l17.77"> </span>
<a href="#l17.78"></a><span id="l17.78"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/calendar/providers/composite/calCompositeCalendar.js</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/calendar/providers/composite/calCompositeCalendar.js</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -314,26 +314,28 @@ calCompositeCalendar.prototype = {</span>
<a href="#l18.4"></a><span id="l18.4">     deleteProperty: function(aName) {</span>
<a href="#l18.5"></a><span id="l18.5">         return this.mDefaultCalendar.deleteProperty(aName);</span>
<a href="#l18.6"></a><span id="l18.6">     },</span>
<a href="#l18.7"></a><span id="l18.7"> </span>
<a href="#l18.8"></a><span id="l18.8">     // void addObserver( in calIObserver observer );</span>
<a href="#l18.9"></a><span id="l18.9">     mCompositeObservers: null,</span>
<a href="#l18.10"></a><span id="l18.10">     mObservers: null,</span>
<a href="#l18.11"></a><span id="l18.11">     addObserver: function (aObserver) {</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-        if (cal.calInstanceOf(aObserver, Components.interfaces.calICompositeObserver)) {</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineminus">-            this.mCompositeObservers.add(aObserver);</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineplus">+        let compositeObserver = cal.wrapInstance(aObserver, Components.interfaces.calICompositeObserver);</span>
<a href="#l18.15"></a><span id="l18.15" class="difflineplus">+        if (compositeObserver) {</span>
<a href="#l18.16"></a><span id="l18.16" class="difflineplus">+            this.mCompositeObservers.add(compositeObserver);</span>
<a href="#l18.17"></a><span id="l18.17">         }</span>
<a href="#l18.18"></a><span id="l18.18">         this.mObservers.add(aObserver);</span>
<a href="#l18.19"></a><span id="l18.19">     },</span>
<a href="#l18.20"></a><span id="l18.20"> </span>
<a href="#l18.21"></a><span id="l18.21">     // void removeObserver( in calIObserver observer );</span>
<a href="#l18.22"></a><span id="l18.22">     removeObserver: function (aObserver) {</span>
<a href="#l18.23"></a><span id="l18.23" class="difflineminus">-        if (cal.calInstanceOf(aObserver, Components.interfaces.calICompositeObserver)) {</span>
<a href="#l18.24"></a><span id="l18.24" class="difflineminus">-            this.mCompositeObservers.remove(aObserver);</span>
<a href="#l18.25"></a><span id="l18.25" class="difflineplus">+        let compositeObserver = cal.wrapInstance(aObserver, Components.interfaces.calICompositeObserver);</span>
<a href="#l18.26"></a><span id="l18.26" class="difflineplus">+        if (compositeObserver) {</span>
<a href="#l18.27"></a><span id="l18.27" class="difflineplus">+            this.mCompositeObservers.remove(compositeObserver);</span>
<a href="#l18.28"></a><span id="l18.28">         }</span>
<a href="#l18.29"></a><span id="l18.29">         this.mObservers.remove(aObserver);</span>
<a href="#l18.30"></a><span id="l18.30">     },</span>
<a href="#l18.31"></a><span id="l18.31"> </span>
<a href="#l18.32"></a><span id="l18.32">     refresh: function cCC_refresh() {</span>
<a href="#l18.33"></a><span id="l18.33">         if (this.mStatusObserver) {</span>
<a href="#l18.34"></a><span id="l18.34">             this.mStatusObserver.startMeteors(Components.interfaces.calIStatusObserver.DETERMINED_PROGRESS, this.mCalendars.length);</span>
<a href="#l18.35"></a><span id="l18.35">         }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/calendar/providers/gdata/components/calGoogleUtils.js</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/calendar/providers/gdata/components/calGoogleUtils.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -579,17 +579,18 @@ function ItemToXMLEntry(aItem, aCalendar</span>
<a href="#l19.4"></a><span id="l19.4">             icalString = &quot;DTSTART;TZID=&quot; + startTZID</span>
<a href="#l19.5"></a><span id="l19.5">                          + &quot;:&quot; + aItem.startDate.icalString + kNEWLINE</span>
<a href="#l19.6"></a><span id="l19.6">                          + &quot;DTEND;TZID=&quot; + endTZID</span>
<a href="#l19.7"></a><span id="l19.7">                          + &quot;:&quot;  + aItem.endDate.icalString + kNEWLINE;</span>
<a href="#l19.8"></a><span id="l19.8"> </span>
<a href="#l19.9"></a><span id="l19.9">             // Add all recurrence items to the ical string</span>
<a href="#l19.10"></a><span id="l19.10">             for each (let ritem in recurrenceItems) {</span>
<a href="#l19.11"></a><span id="l19.11">                 let prop = ritem.icalProperty;</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-                if (calInstanceOf(ritem, Components.interfaces.calIRecurrenceDate)) {</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+                ritem = cal.wrapInstance(ritem, Components.interfaces.calIRecurrenceDate);</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineplus">+                if (ritem) {</span>
<a href="#l19.15"></a><span id="l19.15">                     // EXDATES require special casing, since they might contain</span>
<a href="#l19.16"></a><span id="l19.16">                     // a TZID. To avoid the need for conversion of TZID strings,</span>
<a href="#l19.17"></a><span id="l19.17">                     // convert to UTC before serialization.</span>
<a href="#l19.18"></a><span id="l19.18">                     prop.valueAsDatetime = ritem.date.getInTimezone(UTC());</span>
<a href="#l19.19"></a><span id="l19.19">                 }</span>
<a href="#l19.20"></a><span id="l19.20">                 icalString += prop.icalString;</span>
<a href="#l19.21"></a><span id="l19.21">             }</span>
<a href="#l19.22"></a><span id="l19.22"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/calendar/providers/ics/calICSCalendar.js</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/calendar/providers/ics/calICSCalendar.js</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -120,21 +120,21 @@ calICSCalendar.prototype = {</span>
<a href="#l20.4"></a><span id="l20.4"> </span>
<a href="#l20.5"></a><span id="l20.5">     get uri() { return this.mUri },</span>
<a href="#l20.6"></a><span id="l20.6">     set uri(aUri) {</span>
<a href="#l20.7"></a><span id="l20.7">         this.mUri = aUri;</span>
<a href="#l20.8"></a><span id="l20.8">         this.mMemoryCalendar.uri = this.mUri;</span>
<a href="#l20.9"></a><span id="l20.9"> </span>
<a href="#l20.10"></a><span id="l20.10">         // Use the ioservice, to create a channel, which makes finding the</span>
<a href="#l20.11"></a><span id="l20.11">         // right hooks to use easier.</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-        var channel = Services.io.newChannelFromURI(this.mUri);</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineplus">+        let channel = Services.io.newChannelFromURI(this.mUri);</span>
<a href="#l20.14"></a><span id="l20.14"> </span>
<a href="#l20.15"></a><span id="l20.15" class="difflineminus">-        if (calInstanceOf(channel, Components.interfaces.nsIHttpChannel)) {</span>
<a href="#l20.16"></a><span id="l20.16" class="difflineplus">+        if (cal.wrapInstance(channel, Components.interfaces.nsIHttpChannel)) {</span>
<a href="#l20.17"></a><span id="l20.17">             this.mHooks = new httpHooks(this);</span>
<a href="#l20.18"></a><span id="l20.18" class="difflineminus">-        } else if (calInstanceOf(channel, Components.interfaces.nsIFileChannel)) {</span>
<a href="#l20.19"></a><span id="l20.19" class="difflineplus">+        } else if (cal.wrapInstance(channel, Components.interfaces.nsIFileChannel)) {</span>
<a href="#l20.20"></a><span id="l20.20">             this.mHooks = new fileHooks(this);</span>
<a href="#l20.21"></a><span id="l20.21">         } else {</span>
<a href="#l20.22"></a><span id="l20.22">             this.mHooks = new dummyHooks(this);</span>
<a href="#l20.23"></a><span id="l20.23">         }</span>
<a href="#l20.24"></a><span id="l20.24">     },</span>
<a href="#l20.25"></a><span id="l20.25"> </span>
<a href="#l20.26"></a><span id="l20.26">     getProperty: function calICSCalendar_getProperty(aName) {</span>
<a href="#l20.27"></a><span id="l20.27">         switch (aName) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/calendar/providers/storage/calStorageCalendar.js</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/calendar/providers/storage/calStorageCalendar.js</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -2111,18 +2111,19 @@ calStorageCalendar.prototype = {</span>
<a href="#l21.4"></a><span id="l21.4">         return 0;</span>
<a href="#l21.5"></a><span id="l21.5">     },</span>
<a href="#l21.6"></a><span id="l21.6"> </span>
<a href="#l21.7"></a><span id="l21.7">     writeProperty: function cSC_writeProperty(item, propName, propValue) {</span>
<a href="#l21.8"></a><span id="l21.8">         try {</span>
<a href="#l21.9"></a><span id="l21.9">             this.prepareStatement(this.mInsertProperty);</span>
<a href="#l21.10"></a><span id="l21.10">             var pp = this.mInsertProperty.params;</span>
<a href="#l21.11"></a><span id="l21.11">             pp.key = propName;</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-            if (calInstanceOf(propValue, Components.interfaces.calIDateTime)) {</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineminus">-                pp.value = propValue.nativeTime;</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineplus">+            let propDateTimeVal = cal.wrapInstance(propValue, Components.interfaces.calIDateTime);</span>
<a href="#l21.15"></a><span id="l21.15" class="difflineplus">+            if (propDateTimeVal) {</span>
<a href="#l21.16"></a><span id="l21.16" class="difflineplus">+                pp.value = propDateTimeVal.nativeTime;</span>
<a href="#l21.17"></a><span id="l21.17">             } else {</span>
<a href="#l21.18"></a><span id="l21.18">                 try {</span>
<a href="#l21.19"></a><span id="l21.19">                     pp.value = propValue;</span>
<a href="#l21.20"></a><span id="l21.20">                 } catch (e) {</span>
<a href="#l21.21"></a><span id="l21.21">                     // The storage service throws an NS_ERROR_ILLEGAL_VALUE in</span>
<a href="#l21.22"></a><span id="l21.22">                     // case pval is something complex (i.e not a string or</span>
<a href="#l21.23"></a><span id="l21.23">                     // number). Swallow this error, leaving the value empty.</span>
<a href="#l21.24"></a><span id="l21.24">                     if (e.result != Components.results.NS_ERROR_ILLEGAL_VALUE) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/calendar/providers/wcap/calWcapCalendarItems.js</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/calendar/providers/wcap/calWcapCalendarItems.js</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -38,29 +38,31 @@ function calWcapCalendar_getRecurrencePa</span>
<a href="#l22.4"></a><span id="l22.4">     out_rrules.value = [];</span>
<a href="#l22.5"></a><span id="l22.5">     out_rdates.value = [];</span>
<a href="#l22.6"></a><span id="l22.6">     out_exrules.value = [];</span>
<a href="#l22.7"></a><span id="l22.7">     out_exdates.value = [];</span>
<a href="#l22.8"></a><span id="l22.8">     if (item.recurrenceInfo) {</span>
<a href="#l22.9"></a><span id="l22.9">         var rItems = item.recurrenceInfo.getRecurrenceItems({});</span>
<a href="#l22.10"></a><span id="l22.10">         for each (var rItem in rItems) {</span>
<a href="#l22.11"></a><span id="l22.11">             var isNeg = rItem.isNegative;</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-            if (calInstanceOf(rItem, Components.interfaces.calIRecurrenceRule)) {</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineminus">-                var rule = (&quot;\&quot;&quot; + encodeURIComponent(rItem.icalProperty.valueAsIcalString) + &quot;\&quot;&quot;);</span>
<a href="#l22.14"></a><span id="l22.14" class="difflineplus">+            let rRule = cal.wrapInstance(rItem, Components.interfaces.calIRecurrenceRule);</span>
<a href="#l22.15"></a><span id="l22.15" class="difflineplus">+            let rDate = cal.wrapInstance(rItem, Components.interfaces.calIRecurrenceDate);</span>
<a href="#l22.16"></a><span id="l22.16" class="difflineplus">+            if (rRule) {</span>
<a href="#l22.17"></a><span id="l22.17" class="difflineplus">+                let rule = (&quot;\&quot;&quot; + encodeURIComponent(rRule.icalProperty.valueAsIcalString) + &quot;\&quot;&quot;);</span>
<a href="#l22.18"></a><span id="l22.18">                 if (isNeg) {</span>
<a href="#l22.19"></a><span id="l22.19">                     out_exrules.value.push(rule);</span>
<a href="#l22.20"></a><span id="l22.20">                 } else {</span>
<a href="#l22.21"></a><span id="l22.21">                     out_rrules.value.push(rule);</span>
<a href="#l22.22"></a><span id="l22.22">                 }</span>
<a href="#l22.23"></a><span id="l22.23" class="difflineminus">-            } else if (calInstanceOf(rItem, Components.interfaces.calIRecurrenceDate)) {</span>
<a href="#l22.24"></a><span id="l22.24" class="difflineplus">+            } else if (rDate) {</span>
<a href="#l22.25"></a><span id="l22.25">                 // cs does not accept DATEs here:</span>
<a href="#l22.26"></a><span id="l22.26">                 if (isNeg) {</span>
<a href="#l22.27"></a><span id="l22.27" class="difflineminus">-                    out_exdates.value.push(getIcalUTC(ensureDateTime(rItem.date)));</span>
<a href="#l22.28"></a><span id="l22.28" class="difflineplus">+                    out_exdates.value.push(getIcalUTC(ensureDateTime(rDate.date)));</span>
<a href="#l22.29"></a><span id="l22.29">                 } else {</span>
<a href="#l22.30"></a><span id="l22.30" class="difflineminus">-                    out_rdates.value.push(getIcalUTC(ensureDateTime(rItem.date)));</span>
<a href="#l22.31"></a><span id="l22.31" class="difflineplus">+                    out_rdates.value.push(getIcalUTC(ensureDateTime(rDate.date)));</span>
<a href="#l22.32"></a><span id="l22.32">                 }</span>
<a href="#l22.33"></a><span id="l22.33">             } else {</span>
<a href="#l22.34"></a><span id="l22.34">                 this.notifyError(NS_ERROR_UNEXPECTED,</span>
<a href="#l22.35"></a><span id="l22.35">                                  &quot;don\'t know how to handle this recurrence item: &quot; + rItem.valueAsIcalString);</span>
<a href="#l22.36"></a><span id="l22.36">             }</span>
<a href="#l22.37"></a><span id="l22.37">         }</span>
<a href="#l22.38"></a><span id="l22.38">     }</span>
<a href="#l22.39"></a><span id="l22.39"> };</span>
<a href="#l22.40"></a><span id="l22.40" class="difflineat">@@ -495,20 +497,21 @@ function calWcapCalendar_storeItem(bAddI</span>
<a href="#l22.41"></a><span id="l22.41"> </span>
<a href="#l22.42"></a><span id="l22.42">         // attachment urls:</span>
<a href="#l22.43"></a><span id="l22.43">         function getAttachments(item) {</span>
<a href="#l22.44"></a><span id="l22.44">             var ret = &quot;&quot;;</span>
<a href="#l22.45"></a><span id="l22.45">             var attachments = item.attachments;</span>
<a href="#l22.46"></a><span id="l22.46">             if (attachments) {</span>
<a href="#l22.47"></a><span id="l22.47">                 var strings = [];</span>
<a href="#l22.48"></a><span id="l22.48">                 for each (var att in attachements) {</span>
<a href="#l22.49"></a><span id="l22.49" class="difflineplus">+                    let wrappedAttachment = cal.wrapInstance(att, Components.interfaces.calIAttachment);</span>
<a href="#l22.50"></a><span id="l22.50">                     if (typeof(att) == &quot;string&quot;) {</span>
<a href="#l22.51"></a><span id="l22.51">                         strings.push(encodeURIComponent(att));</span>
<a href="#l22.52"></a><span id="l22.52" class="difflineminus">-                    } else if (calInstanceOf(att, Components.interfaces.calIAttachment) &amp;&amp; att.uri) {</span>
<a href="#l22.53"></a><span id="l22.53" class="difflineminus">-                        strings.push(encodeURIComponent(att.uri.spec));</span>
<a href="#l22.54"></a><span id="l22.54" class="difflineplus">+                    } else if (wrappedAttachment &amp;&amp; wrappedAttachment.uri) {</span>
<a href="#l22.55"></a><span id="l22.55" class="difflineplus">+                        strings.push(encodeURIComponent(wrappedAttachment.uri.spec));</span>
<a href="#l22.56"></a><span id="l22.56">                     } else { // xxx todo</span>
<a href="#l22.57"></a><span id="l22.57">                         logError(&quot;only URLs supported as attachment, not: &quot; + att, this_);</span>
<a href="#l22.58"></a><span id="l22.58">                     }</span>
<a href="#l22.59"></a><span id="l22.59">                 }</span>
<a href="#l22.60"></a><span id="l22.60">                 strings.sort();</span>
<a href="#l22.61"></a><span id="l22.61">                 ret += strings.join(&quot;;&quot;);</span>
<a href="#l22.62"></a><span id="l22.62">             }</span>
<a href="#l22.63"></a><span id="l22.63">             return ret;</span>
<a href="#l22.64"></a><span id="l22.64" class="difflineat">@@ -968,22 +971,25 @@ calWcapCalendar.prototype.parseItems = f</span>
<a href="#l22.65"></a><span id="l22.65"> </span>
<a href="#l22.66"></a><span id="l22.66">             let recStartDate = item.recurrenceStartDate;</span>
<a href="#l22.67"></a><span id="l22.67">             if (recStartDate &amp;&amp; !recStartDate.isDate) {</span>
<a href="#l22.68"></a><span id="l22.68">                 recStartDate = null;</span>
<a href="#l22.69"></a><span id="l22.69">             }</span>
<a href="#l22.70"></a><span id="l22.70">             let recItems = item.recurrenceInfo.getRecurrenceItems({});</span>
<a href="#l22.71"></a><span id="l22.71">             for each (let recItem in recItems) {</span>
<a href="#l22.72"></a><span id="l22.72">                 // cs bug: workaround missing COUNT</span>
<a href="#l22.73"></a><span id="l22.73" class="difflineminus">-                if (calInstanceOf(recItem, Components.interfaces.calIRecurrenceRule)) {</span>
<a href="#l22.74"></a><span id="l22.74" class="difflineplus">+                if (cal.wrapInstance(recItem, Components.interfaces.calIRecurrenceRule)) {</span>
<a href="#l22.75"></a><span id="l22.75" class="difflineplus">+                    // Possible performance issue double QueryInterface calls</span>
<a href="#l22.76"></a><span id="l22.76" class="difflineplus">+                    recItem = recItem.QueryInterface(Components.interfaces.calIRecurrenceRule);</span>
<a href="#l22.77"></a><span id="l22.77">                     if (!recItem.isFinite &amp;&amp; !recItem.isNegative) {</span>
<a href="#l22.78"></a><span id="l22.78">                         recItem.count = recurrenceBound;</span>
<a href="#l22.79"></a><span id="l22.79">                     }</span>
<a href="#l22.80"></a><span id="l22.80">                 } else if (recStartDate &amp;&amp;</span>
<a href="#l22.81"></a><span id="l22.81" class="difflineminus">-                           calInstanceOf(recItem, Components.interfaces.calIRecurrenceDate)) {</span>
<a href="#l22.82"></a><span id="l22.82" class="difflineplus">+                           cal.wrapInstance(recItem, Components.interfaces.calIRecurrenceDate)) {</span>
<a href="#l22.83"></a><span id="l22.83" class="difflineplus">+                    recItem = recItem.QueryInterface(Components.interfaces.calIRecurrenceDate);</span>
<a href="#l22.84"></a><span id="l22.84">                     // cs bug: always uses DATE-TIME even though the master item is all-day DATE:</span>
<a href="#l22.85"></a><span id="l22.85">                     //         get into startDate's timezone before cutting:</span>
<a href="#l22.86"></a><span id="l22.86">                     let date = recItem.date.getInTimezone(recStartDate.timezone);</span>
<a href="#l22.87"></a><span id="l22.87">                     date.isDate = true;</span>
<a href="#l22.88"></a><span id="l22.88">                     recItem.date = date;</span>
<a href="#l22.89"></a><span id="l22.89">                 }</span>
<a href="#l22.90"></a><span id="l22.90">             }</span>
<a href="#l22.91"></a><span id="l22.91"> </span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

