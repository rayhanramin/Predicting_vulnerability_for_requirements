<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 29590:1dd226bb8d772fafbfad436e8b7258a15b7632d0</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 1dd226bb8d772fafbfad436e8b7258a15b7632d0" />
<meta property="og:url" content="/comm-central/rev/1dd226bb8d772fafbfad436e8b7258a15b7632d0" />
<meta property="og:description" content="Bug 1606610 - Warn the user when autodiscovery redirects from plain HTTP to HTTPS. Show the new target domain, and ask for confirmation. r=aleca,mkmelin" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 1dd226bb8d772fafbfad436e8b7258a15b7632d0 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/1dd226bb8d772fafbfad436e8b7258a15b7632d0">shortlog</a> |
<a href="/comm-central/log/1dd226bb8d772fafbfad436e8b7258a15b7632d0">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/1dd226bb8d772fafbfad436e8b7258a15b7632d0">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/1dd226bb8d772fafbfad436e8b7258a15b7632d0">files</a> |
changeset |
<a href="/comm-central/raw-rev/1dd226bb8d772fafbfad436e8b7258a15b7632d0">raw</a>  | <a href="/comm-central/archive/1dd226bb8d772fafbfad436e8b7258a15b7632d0.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1606610">Bug 1606610</a> - Warn the user when autodiscovery redirects from plain HTTP to HTTPS. Show the new target domain, and ask for confirmation. r=aleca,mkmelin
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#66;&#101;&#110;&#32;&#66;&#117;&#99;&#107;&#115;&#99;&#104;&#32;&#60;&#98;&#101;&#110;&#46;&#98;&#117;&#99;&#107;&#115;&#99;&#104;&#64;&#98;&#101;&#111;&#110;&#101;&#120;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Sat, 16 May 2020 22:54:23 +0300</td></tr>

<tr>
 <td>changeset 29590</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/1dd226bb8d772fafbfad436e8b7258a15b7632d0">1dd226bb8d772fafbfad436e8b7258a15b7632d0</a></td>
</tr>



<tr>
<td>parent 29589</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/94c8faf148df4c428cb3d25fb37fe9d24d63b9dc">94c8faf148df4c428cb3d25fb37fe9d24d63b9dc</a>
</td>
</tr>

<tr>
<td>child 29591</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/b0aeb62aae1d2e1e82163866add7d05a95583d31">b0aeb62aae1d2e1e82163866add7d05a95583d31</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=1dd226bb8d772fafbfad436e8b7258a15b7632d0">17446</a></td></tr>
<tr><td>push user</td><td>mkmelin@iki.fi</td></tr>
<tr><td>push date</td><td class="date age">Sat, 16 May 2020 19:55:57 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@1dd226bb8d77 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=1dd226bb8d772fafbfad436e8b7258a15b7632d0">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=1dd226bb8d772fafbfad436e8b7258a15b7632d0&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=1dd226bb8d772fafbfad436e8b7258a15b7632d0&newProject=comm-central&newRevision=94c8faf148df4c428cb3d25fb37fe9d24d63b9dc&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=1dd226bb8d772fafbfad436e8b7258a15b7632d0&newProject=comm-central&newRevision=94c8faf148df4c428cb3d25fb37fe9d24d63b9dc&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=1dd226bb8d772fafbfad436e8b7258a15b7632d0&newProject=comm-central&newRevision=94c8faf148df4c428cb3d25fb37fe9d24d63b9dc&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28aleca%29&revcount=50">aleca</a>, <a href="/comm-central/log?rev=reviewer%28mkmelin%29&revcount=50">mkmelin</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1606610">1606610</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1606610">Bug 1606610</a> - Warn the user when autodiscovery redirects from plain HTTP to HTTPS. Show the new target domain, and ask for confirmation. r=aleca,mkmelin</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1dd226bb8d772fafbfad436e8b7258a15b7632d0/mail/components/accountcreation/content/emailWizard.js">mail/components/accountcreation/content/emailWizard.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1dd226bb8d772fafbfad436e8b7258a15b7632d0/mail/components/accountcreation/content/emailWizard.js">file</a> |
<a href="/comm-central/annotate/1dd226bb8d772fafbfad436e8b7258a15b7632d0/mail/components/accountcreation/content/emailWizard.js">annotate</a> |
<a href="/comm-central/diff/1dd226bb8d772fafbfad436e8b7258a15b7632d0/mail/components/accountcreation/content/emailWizard.js">diff</a> |
<a href="/comm-central/comparison/1dd226bb8d772fafbfad436e8b7258a15b7632d0/mail/components/accountcreation/content/emailWizard.js">comparison</a> |
<a href="/comm-central/log/1dd226bb8d772fafbfad436e8b7258a15b7632d0/mail/components/accountcreation/content/emailWizard.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1dd226bb8d772fafbfad436e8b7258a15b7632d0/mail/components/accountcreation/content/emailWizard.xhtml">mail/components/accountcreation/content/emailWizard.xhtml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1dd226bb8d772fafbfad436e8b7258a15b7632d0/mail/components/accountcreation/content/emailWizard.xhtml">file</a> |
<a href="/comm-central/annotate/1dd226bb8d772fafbfad436e8b7258a15b7632d0/mail/components/accountcreation/content/emailWizard.xhtml">annotate</a> |
<a href="/comm-central/diff/1dd226bb8d772fafbfad436e8b7258a15b7632d0/mail/components/accountcreation/content/emailWizard.xhtml">diff</a> |
<a href="/comm-central/comparison/1dd226bb8d772fafbfad436e8b7258a15b7632d0/mail/components/accountcreation/content/emailWizard.xhtml">comparison</a> |
<a href="/comm-central/log/1dd226bb8d772fafbfad436e8b7258a15b7632d0/mail/components/accountcreation/content/emailWizard.xhtml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1dd226bb8d772fafbfad436e8b7258a15b7632d0/mail/components/accountcreation/content/exchangeAutoDiscover.js">mail/components/accountcreation/content/exchangeAutoDiscover.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1dd226bb8d772fafbfad436e8b7258a15b7632d0/mail/components/accountcreation/content/exchangeAutoDiscover.js">file</a> |
<a href="/comm-central/annotate/1dd226bb8d772fafbfad436e8b7258a15b7632d0/mail/components/accountcreation/content/exchangeAutoDiscover.js">annotate</a> |
<a href="/comm-central/diff/1dd226bb8d772fafbfad436e8b7258a15b7632d0/mail/components/accountcreation/content/exchangeAutoDiscover.js">diff</a> |
<a href="/comm-central/comparison/1dd226bb8d772fafbfad436e8b7258a15b7632d0/mail/components/accountcreation/content/exchangeAutoDiscover.js">comparison</a> |
<a href="/comm-central/log/1dd226bb8d772fafbfad436e8b7258a15b7632d0/mail/components/accountcreation/content/exchangeAutoDiscover.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1dd226bb8d772fafbfad436e8b7258a15b7632d0/mail/components/accountcreation/content/util.js">mail/components/accountcreation/content/util.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1dd226bb8d772fafbfad436e8b7258a15b7632d0/mail/components/accountcreation/content/util.js">file</a> |
<a href="/comm-central/annotate/1dd226bb8d772fafbfad436e8b7258a15b7632d0/mail/components/accountcreation/content/util.js">annotate</a> |
<a href="/comm-central/diff/1dd226bb8d772fafbfad436e8b7258a15b7632d0/mail/components/accountcreation/content/util.js">diff</a> |
<a href="/comm-central/comparison/1dd226bb8d772fafbfad436e8b7258a15b7632d0/mail/components/accountcreation/content/util.js">comparison</a> |
<a href="/comm-central/log/1dd226bb8d772fafbfad436e8b7258a15b7632d0/mail/components/accountcreation/content/util.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1dd226bb8d772fafbfad436e8b7258a15b7632d0/mail/locales/en-US/chrome/messenger/accountCreation.properties">mail/locales/en-US/chrome/messenger/accountCreation.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1dd226bb8d772fafbfad436e8b7258a15b7632d0/mail/locales/en-US/chrome/messenger/accountCreation.properties">file</a> |
<a href="/comm-central/annotate/1dd226bb8d772fafbfad436e8b7258a15b7632d0/mail/locales/en-US/chrome/messenger/accountCreation.properties">annotate</a> |
<a href="/comm-central/diff/1dd226bb8d772fafbfad436e8b7258a15b7632d0/mail/locales/en-US/chrome/messenger/accountCreation.properties">diff</a> |
<a href="/comm-central/comparison/1dd226bb8d772fafbfad436e8b7258a15b7632d0/mail/locales/en-US/chrome/messenger/accountCreation.properties">comparison</a> |
<a href="/comm-central/log/1dd226bb8d772fafbfad436e8b7258a15b7632d0/mail/locales/en-US/chrome/messenger/accountCreation.properties">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1dd226bb8d772fafbfad436e8b7258a15b7632d0/mail/themes/shared/mail/accountCreation.css">mail/themes/shared/mail/accountCreation.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1dd226bb8d772fafbfad436e8b7258a15b7632d0/mail/themes/shared/mail/accountCreation.css">file</a> |
<a href="/comm-central/annotate/1dd226bb8d772fafbfad436e8b7258a15b7632d0/mail/themes/shared/mail/accountCreation.css">annotate</a> |
<a href="/comm-central/diff/1dd226bb8d772fafbfad436e8b7258a15b7632d0/mail/themes/shared/mail/accountCreation.css">diff</a> |
<a href="/comm-central/comparison/1dd226bb8d772fafbfad436e8b7258a15b7632d0/mail/themes/shared/mail/accountCreation.css">comparison</a> |
<a href="/comm-central/log/1dd226bb8d772fafbfad436e8b7258a15b7632d0/mail/themes/shared/mail/accountCreation.css">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/components/accountcreation/content/emailWizard.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/components/accountcreation/content/emailWizard.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -168,16 +168,97 @@ function resizeDialog() {</span>
<a href="#l1.4"></a><span id="l1.4">     window.innerHeight = box.clientHeight;</span>
<a href="#l1.5"></a><span id="l1.5">   }</span>
<a href="#l1.6"></a><span id="l1.6"> </span>
<a href="#l1.7"></a><span id="l1.7">   if (box.clientWidth &gt; window.innerWidth) {</span>
<a href="#l1.8"></a><span id="l1.8">     window.innerWidth = box.clientWidth;</span>
<a href="#l1.9"></a><span id="l1.9">   }</span>
<a href="#l1.10"></a><span id="l1.10"> }</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+/**</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+ * Inline confirmation dialog</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+ * Shows, below status area:</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+ *</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+ * Your question here</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+ *  [ Cancel ] [ OK ]</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+ *</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+ * @param {string} questionLabel - Text with the question.</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+ * @param {string} okLabel - Text for OK/Yes button.</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+ * @param {string} cancelLabel - Text for Cancel/No button.</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineplus">+ * @param {function} okCallback - Called when the user clicks OK.</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineplus">+ * @param {function(ex)} cancelCallback - Called when the user clicks Cancel</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineplus">+ *   or if you call `Abortable.cancel()`.</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineplus">+ * @returns {Abortable} - If `Abortable.cancel()` is called,</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineplus">+ *   the dialog is closed and the `cancelCallback()` is called.</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineplus">+ */</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineplus">+function confirmDialog(</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineplus">+  questionLabel,</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineplus">+  okLabel,</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+  cancelLabel,</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+  okCallback,</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+  cancelCallback</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+) {</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineplus">+  e(&quot;confirmationQuestion&quot;).textContent = questionLabel;</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineplus">+  let okButton = e(&quot;confirmationOKButton&quot;);</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineplus">+  let cancelButton = e(&quot;confirmationCancelButton&quot;);</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineplus">+  okButton.label = okLabel;</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineplus">+  cancelButton.label = cancelLabel;</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineplus">+  // Disable UI we don't want in this state.</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineplus">+  let statusAreaWasHidden = e(&quot;status-area&quot;).hidden;</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineplus">+  let statusLineWasHidden = e(&quot;status-lines&quot;).hidden;</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineplus">+  let cancelWasDisabled = e(&quot;cancel_button&quot;).disabled;</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineplus">+  let stopWasDisabled = e(&quot;stop_button&quot;).disabled;</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineplus">+  let manualConfigWasDisabled = e(&quot;manual-edit_button&quot;).disabled;</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineplus">+  let nextWasDisabled = e(&quot;next_button&quot;).disabled;</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineplus">+</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineplus">+  _hide(&quot;status-area&quot;);</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineplus">+  _hide(&quot;status-lines&quot;);</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineplus">+  _disable(&quot;cancel_button&quot;);</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineplus">+  _disable(&quot;stop_button&quot;);</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineplus">+  _disable(&quot;manual-edit_button&quot;);</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineplus">+  _disable(&quot;next_button&quot;);</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineplus">+</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineplus">+  _show(&quot;confirmationDialog&quot;);</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineplus">+  resizeDialog();</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineplus">+</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineplus">+  function close() {</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineplus">+    _hide(&quot;confirmationDialog&quot;);</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineplus">+    e(&quot;status-area&quot;).hidden = statusAreaWasHidden;</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineplus">+    e(&quot;status-lines&quot;).hidden = statusLineWasHidden;</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineplus">+    e(&quot;cancel_button&quot;).disabled = cancelWasDisabled;</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineplus">+    e(&quot;stop_button&quot;).disabled = stopWasDisabled;</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineplus">+    e(&quot;manual-edit_button&quot;).disabled = manualConfigWasDisabled;</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineplus">+    e(&quot;next_button&quot;).disabled = nextWasDisabled;</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineplus">+    resizeDialog();</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineplus">+  }</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineplus">+  okButton.addEventListener(</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineplus">+    &quot;command&quot;,</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineplus">+    event =&gt; {</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineplus">+      close();</span>
<a href="#l1.73"></a><span id="l1.73" class="difflineplus">+      okCallback();</span>
<a href="#l1.74"></a><span id="l1.74" class="difflineplus">+    },</span>
<a href="#l1.75"></a><span id="l1.75" class="difflineplus">+    { once: true }</span>
<a href="#l1.76"></a><span id="l1.76" class="difflineplus">+  );</span>
<a href="#l1.77"></a><span id="l1.77" class="difflineplus">+  cancelButton.addEventListener(</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineplus">+    &quot;command&quot;,</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineplus">+    event =&gt; {</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineplus">+      close();</span>
<a href="#l1.81"></a><span id="l1.81" class="difflineplus">+      cancelCallback(new UserCancelledException());</span>
<a href="#l1.82"></a><span id="l1.82" class="difflineplus">+    },</span>
<a href="#l1.83"></a><span id="l1.83" class="difflineplus">+    { once: true }</span>
<a href="#l1.84"></a><span id="l1.84" class="difflineplus">+  );</span>
<a href="#l1.85"></a><span id="l1.85" class="difflineplus">+  let abortable = new Abortable();</span>
<a href="#l1.86"></a><span id="l1.86" class="difflineplus">+  abortable.cancel = ex =&gt; {</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineplus">+    close();</span>
<a href="#l1.88"></a><span id="l1.88" class="difflineplus">+    cancelCallback(ex);</span>
<a href="#l1.89"></a><span id="l1.89" class="difflineplus">+  };</span>
<a href="#l1.90"></a><span id="l1.90" class="difflineplus">+  return abortable;</span>
<a href="#l1.91"></a><span id="l1.91" class="difflineplus">+}</span>
<a href="#l1.92"></a><span id="l1.92" class="difflineplus">+</span>
<a href="#l1.93"></a><span id="l1.93"> function EmailConfigWizard() {</span>
<a href="#l1.94"></a><span id="l1.94">   this._init();</span>
<a href="#l1.95"></a><span id="l1.95"> }</span>
<a href="#l1.96"></a><span id="l1.96"> </span>
<a href="#l1.97"></a><span id="l1.97"> EmailConfigWizard.prototype = {</span>
<a href="#l1.98"></a><span id="l1.98">   _init() {</span>
<a href="#l1.99"></a><span id="l1.99">     gEmailWizardLogger.info(&quot;Initializing setup wizard&quot;);</span>
<a href="#l1.100"></a><span id="l1.100">     this._abortable = null;</span>
<a href="#l1.101"></a><span id="l1.101" class="difflineat">@@ -626,17 +707,18 @@ EmailConfigWizard.prototype = {</span>
<a href="#l1.102"></a><span id="l1.102">         self.removeStatusLines();</span>
<a href="#l1.103"></a><span id="l1.103">         self.stopSpinner(call.foundMsg);</span>
<a href="#l1.104"></a><span id="l1.104">         self.foundConfig(config);</span>
<a href="#l1.105"></a><span id="l1.105">       },</span>
<a href="#l1.106"></a><span id="l1.106">       function(e, allErrors) {</span>
<a href="#l1.107"></a><span id="l1.107">         // all failed</span>
<a href="#l1.108"></a><span id="l1.108">         self._abortable = null;</span>
<a href="#l1.109"></a><span id="l1.109">         self.removeStatusLines();</span>
<a href="#l1.110"></a><span id="l1.110" class="difflineminus">-        if (allErrors.some(e =&gt; e instanceof CancelledException)) {</span>
<a href="#l1.111"></a><span id="l1.111" class="difflineplus">+        if (e instanceof CancelledException) {</span>
<a href="#l1.112"></a><span id="l1.112" class="difflineplus">+          self.onStartOver();</span>
<a href="#l1.113"></a><span id="l1.113">           return;</span>
<a href="#l1.114"></a><span id="l1.114">         }</span>
<a href="#l1.115"></a><span id="l1.115"> </span>
<a href="#l1.116"></a><span id="l1.116">         // guess config</span>
<a href="#l1.117"></a><span id="l1.117">         let initialConfig = new AccountConfig();</span>
<a href="#l1.118"></a><span id="l1.118">         self._prefillConfig(initialConfig);</span>
<a href="#l1.119"></a><span id="l1.119">         self._guessConfig(domain, initialConfig);</span>
<a href="#l1.120"></a><span id="l1.120">       }</span>
<a href="#l1.121"></a><span id="l1.121" class="difflineat">@@ -693,17 +775,19 @@ EmailConfigWizard.prototype = {</span>
<a href="#l1.122"></a><span id="l1.122">         domain,</span>
<a href="#l1.123"></a><span id="l1.123">         emailAddress,</span>
<a href="#l1.124"></a><span id="l1.124">         this._exchangeUsername,</span>
<a href="#l1.125"></a><span id="l1.125">         this._password,</span>
<a href="#l1.126"></a><span id="l1.126">         call.successCallback(),</span>
<a href="#l1.127"></a><span id="l1.127">         (e, allErrors) =&gt; {</span>
<a href="#l1.128"></a><span id="l1.128">           // Must call error callback in any case to stop the discover mode.</span>
<a href="#l1.129"></a><span id="l1.129">           let errorCallback = call.errorCallback();</span>
<a href="#l1.130"></a><span id="l1.130" class="difflineminus">-          if (allErrors &amp;&amp; allErrors.some(e =&gt; e.code == 401)) {</span>
<a href="#l1.131"></a><span id="l1.131" class="difflineplus">+          if (e instanceof CancelledException) {</span>
<a href="#l1.132"></a><span id="l1.132" class="difflineplus">+            errorCallback(e);</span>
<a href="#l1.133"></a><span id="l1.133" class="difflineplus">+          } else if (allErrors &amp;&amp; allErrors.some(e =&gt; e.code == 401)) {</span>
<a href="#l1.134"></a><span id="l1.134">             // Auth failed.</span>
<a href="#l1.135"></a><span id="l1.135">             // Ask user for username.</span>
<a href="#l1.136"></a><span id="l1.136">             this.onStartOver();</span>
<a href="#l1.137"></a><span id="l1.137">             this.stopSpinner(); // clears status message</span>
<a href="#l1.138"></a><span id="l1.138">             _show(&quot;usernameRow&quot;);</span>
<a href="#l1.139"></a><span id="l1.139">             _show(&quot;status-area&quot;);</span>
<a href="#l1.140"></a><span id="l1.140">             if (!this._exchangeUsername) {</span>
<a href="#l1.141"></a><span id="l1.141">               this.showErrorStatus(&quot;credentials_incomplete&quot;);</span>
<a href="#l1.142"></a><span id="l1.142" class="difflineat">@@ -1004,16 +1088,17 @@ EmailConfigWizard.prototype = {</span>
<a href="#l1.143"></a><span id="l1.143">               alt =&gt; alt.type == &quot;imap&quot; || alt.type == &quot;pop3&quot;</span>
<a href="#l1.144"></a><span id="l1.144">             )</span>
<a href="#l1.145"></a><span id="l1.145">           ) {</span>
<a href="#l1.146"></a><span id="l1.146">             msg = gStringsBundle.getString(&quot;no-open-protocols&quot;) + &quot; &quot; + msg;</span>
<a href="#l1.147"></a><span id="l1.147">           }</span>
<a href="#l1.148"></a><span id="l1.148">           setText(&quot;result_addon_intro&quot;, msg);</span>
<a href="#l1.149"></a><span id="l1.149"> </span>
<a href="#l1.150"></a><span id="l1.150">           let containerE = e(&quot;result_addon_install_rows&quot;);</span>
<a href="#l1.151"></a><span id="l1.151" class="difflineplus">+          removeChildNodes(containerE);</span>
<a href="#l1.152"></a><span id="l1.152">           for (let addon of config.addons) {</span>
<a href="#l1.153"></a><span id="l1.153">             // Creates</span>
<a href="#l1.154"></a><span id="l1.154">             // &lt;hbox flex=&quot;1&quot;&gt;</span>
<a href="#l1.155"></a><span id="l1.155">             //   &lt;image src=&quot;https://live.thunderbird.net/owl32.png&quot; /&gt;</span>
<a href="#l1.156"></a><span id="l1.156">             //   &lt;label is=&quot;text-link&quot; href=&quot;https://live.thunderbird.net/owl&quot;&gt;</span>
<a href="#l1.157"></a><span id="l1.157">             //     A third party addon that ...</span>
<a href="#l1.158"></a><span id="l1.158">             //   &lt;/label&gt;</span>
<a href="#l1.159"></a><span id="l1.159">             //   &lt;button class=&quot;larger-button&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/components/accountcreation/content/emailWizard.xhtml</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/components/accountcreation/content/emailWizard.xhtml</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -234,16 +234,25 @@</span>
<a href="#l2.4"></a><span id="l2.4">                 &lt;!-- Include 160 = nbsp, to make the element occupy the</span>
<a href="#l2.5"></a><span id="l2.5">                     full height, for at least one line. With a normal space,</span>
<a href="#l2.6"></a><span id="l2.6">                     it does not have sufficient height. --&gt;</span>
<a href="#l2.7"></a><span id="l2.7">               &lt;image id=&quot;statusImgAfter&quot;/&gt;</span>
<a href="#l2.8"></a><span id="l2.8">             &lt;/hbox&gt;</span>
<a href="#l2.9"></a><span id="l2.9">           &lt;/vbox&gt;</span>
<a href="#l2.10"></a><span id="l2.10"> </span>
<a href="#l2.11"></a><span id="l2.11">           &lt;vbox id=&quot;status-lines&quot; flex=&quot;1&quot; align=&quot;center&quot;/&gt;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+          &lt;vbox id=&quot;confirmationDialog&quot; hidden=&quot;true&quot;&gt;</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+            &lt;description id=&quot;confirmationQuestion&quot; class=&quot;autoconfigLabel&quot;/&gt;</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+            &lt;hbox id=&quot;confirmationButtons&quot; pack=&quot;end&quot;&gt;</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+              &lt;button id=&quot;confirmationCancelButton&quot;/&gt;</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+              &lt;button id=&quot;confirmationOKButton&quot;/&gt;</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+            &lt;/hbox&gt;</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+          &lt;/vbox&gt;</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+</span>
<a href="#l2.21"></a><span id="l2.21">         &lt;/form&gt;</span>
<a href="#l2.22"></a><span id="l2.22">       &lt;/vbox&gt;&lt;!-- .hub-wrapper --&gt;</span>
<a href="#l2.23"></a><span id="l2.23"> </span>
<a href="#l2.24"></a><span id="l2.24">       &lt;html:fieldset id=&quot;result_area&quot; class=&quot;hub-wrapper config-area&quot;</span>
<a href="#l2.25"></a><span id="l2.25">                      hidden=&quot;hidden&quot;</span>
<a href="#l2.26"></a><span id="l2.26">                      pack=&quot;center&quot;&gt;</span>
<a href="#l2.27"></a><span id="l2.27">         &lt;hbox flex=&quot;1&quot;&gt;</span>
<a href="#l2.28"></a><span id="l2.28">           &lt;label class=&quot;label-result&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/components/accountcreation/content/exchangeAutoDiscover.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/components/accountcreation/content/exchangeAutoDiscover.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -82,18 +82,16 @@ function fetchConfigFromExchange(</span>
<a href="#l3.4"></a><span id="l3.4">     post: true,</span>
<a href="#l3.5"></a><span id="l3.5">     headers: {</span>
<a href="#l3.6"></a><span id="l3.6">       // outlook.com needs this exact string, with space and lower case &quot;utf&quot;.</span>
<a href="#l3.7"></a><span id="l3.7">       // Compare bug 1454325 comment 15.</span>
<a href="#l3.8"></a><span id="l3.8">       &quot;Content-Type&quot;: &quot;text/xml; charset=utf-8&quot;,</span>
<a href="#l3.9"></a><span id="l3.9">     },</span>
<a href="#l3.10"></a><span id="l3.10">     username: username || emailAddress,</span>
<a href="#l3.11"></a><span id="l3.11">     password,</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-    // url3 is HTTP (not HTTPS), so suppress password. Even MS spec demands so.</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-    requireSecureAuth: true,</span>
<a href="#l3.14"></a><span id="l3.14">     allowAuthPrompt: false,</span>
<a href="#l3.15"></a><span id="l3.15">   };</span>
<a href="#l3.16"></a><span id="l3.16">   let call;</span>
<a href="#l3.17"></a><span id="l3.17">   let fetch;</span>
<a href="#l3.18"></a><span id="l3.18">   let fetch3;</span>
<a href="#l3.19"></a><span id="l3.19"> </span>
<a href="#l3.20"></a><span id="l3.20">   let successive = new SuccessiveAbortable();</span>
<a href="#l3.21"></a><span id="l3.21">   let priority = new PriorityOrderAbortable(function(xml, call) {</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineat">@@ -124,32 +122,105 @@ function fetchConfigFromExchange(</span>
<a href="#l3.23"></a><span id="l3.23">     callArgs,</span>
<a href="#l3.24"></a><span id="l3.24">     call.successCallback(),</span>
<a href="#l3.25"></a><span id="l3.25">     call.errorCallback()</span>
<a href="#l3.26"></a><span id="l3.26">   );</span>
<a href="#l3.27"></a><span id="l3.27">   fetch.start();</span>
<a href="#l3.28"></a><span id="l3.28">   call.setAbortable(fetch);</span>
<a href="#l3.29"></a><span id="l3.29"> </span>
<a href="#l3.30"></a><span id="l3.30">   call = priority.addCall();</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-  fetch3 = new FetchHTTP(</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineminus">-    url3,</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineminus">-    callArgs,</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineminus">-    call.successCallback(),</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineminus">-    call.errorCallback()</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineminus">-  );</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+  let call3ErrorCallback = call.errorCallback();</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+  // url3 is HTTP (not HTTPS), so suppress password. Even MS spec demands so.</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+  let call3Args = deepCopy(callArgs);</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+  delete call3Args.username;</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+  delete call3Args.password;</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineplus">+  fetch3 = new FetchHTTP(url3, call3Args, call.successCallback(), ex =&gt; {</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+    // url3 is an HTTP URL that will redirect to the real one, usually a</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+    // HTTPS URL of the hoster. XMLHttpRequest unfortunately loses the call</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineplus">+    // parameters, drops the auth, drops the body, and turns POST into GET,</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineplus">+    // which cause the call to fail. For AutoDiscover mechanism to work,</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineplus">+    // we need to repeat the call with the correct parameters again.</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineplus">+    let redirectURL = fetch3._request.responseURL;</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineplus">+    if (!redirectURL.startsWith(&quot;https:&quot;)) {</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineplus">+      call3ErrorCallback(ex);</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+      return;</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineplus">+    }</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineplus">+    let redirectURI = Services.io.newURI(redirectURL);</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineplus">+    let redirectDomain = Services.eTLD.getBaseDomain(redirectURI);</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineplus">+    let originalDomain = Services.eTLD.getBaseDomainFromHost(domain);</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineplus">+</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineplus">+    function fetchRedirect() {</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineplus">+      let fetchCall = priority.addCall();</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineplus">+      let fetch = new FetchHTTP(</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineplus">+        redirectURL,</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineplus">+        callArgs, // now with auth</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineplus">+        fetchCall.successCallback(),</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineplus">+        fetchCall.errorCallback()</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineplus">+      );</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineplus">+      fetchCall.setAbortable(fetch);</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineplus">+      fetch.start();</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineplus">+    }</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineplus">+</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineplus">+    const kSafeDomains = [&quot;office365.com&quot;, &quot;outlook.com&quot;];</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineplus">+    if (</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineplus">+      redirectDomain != originalDomain &amp;&amp;</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineplus">+      !kSafeDomains.includes(redirectDomain)</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineplus">+    ) {</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineplus">+      // Given that we received the redirect URL from an insecure HTTP call,</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineplus">+      // we ask the user whether he trusts the redirect domain.</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineplus">+      gEmailWizardLogger.info(&quot;AutoDiscover HTTP redirected to other domain&quot;);</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineplus">+      let dialogSuccessive = new SuccessiveAbortable();</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineplus">+      // Because the dialog implements Abortable, the dialog will cancel and</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineplus">+      // close automatically, if a slow higher priority call returns late.</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineplus">+      let dialogCall = priority.addCall();</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineplus">+      dialogCall.setAbortable(dialogSuccessive);</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineplus">+      call3ErrorCallback(new Exception(&quot;Redirected&quot;));</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineplus">+      dialogSuccessive.current = new TimeoutAbortable(</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineplus">+        setTimeout(() =&gt; {</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineplus">+          let questionLabel = gStringsBundle.getFormattedString(</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineplus">+            &quot;otherDomain.label&quot;,</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineplus">+            [</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineplus">+              document</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineplus">+                .getElementById(&quot;bundle_brand&quot;)</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineplus">+                .getString(&quot;brandShortName&quot;),</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineplus">+              redirectDomain,</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineplus">+            ]</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineplus">+          );</span>
<a href="#l3.94"></a><span id="l3.94" class="difflineplus">+          let okLabel = gStringsBundle.getString(&quot;otherDomain_ok.label&quot;);</span>
<a href="#l3.95"></a><span id="l3.95" class="difflineplus">+          let cancelLabel = gStringsBundle.getString(</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineplus">+            &quot;otherDomain_cancel.label&quot;</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineplus">+          );</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineplus">+          dialogSuccessive.current = confirmDialog(</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineplus">+            questionLabel,</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineplus">+            okLabel,</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineplus">+            cancelLabel,</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineplus">+            () =&gt; {</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineplus">+              // User agreed.</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineplus">+              fetchRedirect();</span>
<a href="#l3.105"></a><span id="l3.105" class="difflineplus">+              // Remove the dialog from the call stack.</span>
<a href="#l3.106"></a><span id="l3.106" class="difflineplus">+              dialogCall.errorCallback()(new Exception(&quot;Proceed to fetch&quot;));</span>
<a href="#l3.107"></a><span id="l3.107" class="difflineplus">+            },</span>
<a href="#l3.108"></a><span id="l3.108" class="difflineplus">+            ex =&gt; {</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineplus">+              // User rejected, or action cancelled otherwise.</span>
<a href="#l3.110"></a><span id="l3.110" class="difflineplus">+              dialogCall.errorCallback()(ex);</span>
<a href="#l3.111"></a><span id="l3.111" class="difflineplus">+            }</span>
<a href="#l3.112"></a><span id="l3.112" class="difflineplus">+          );</span>
<a href="#l3.113"></a><span id="l3.113" class="difflineplus">+          // Account for a slow server response.</span>
<a href="#l3.114"></a><span id="l3.114" class="difflineplus">+          // This will prevent showing the warning message when not necessary.</span>
<a href="#l3.115"></a><span id="l3.115" class="difflineplus">+          // The timeout is just for optics. The Abortable ensures that it works.</span>
<a href="#l3.116"></a><span id="l3.116" class="difflineplus">+        }, 2000)</span>
<a href="#l3.117"></a><span id="l3.117" class="difflineplus">+      );</span>
<a href="#l3.118"></a><span id="l3.118" class="difflineplus">+    } else {</span>
<a href="#l3.119"></a><span id="l3.119" class="difflineplus">+      fetchRedirect();</span>
<a href="#l3.120"></a><span id="l3.120" class="difflineplus">+      call3ErrorCallback(new Exception(&quot;Redirected&quot;));</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineplus">+    }</span>
<a href="#l3.122"></a><span id="l3.122" class="difflineplus">+  });</span>
<a href="#l3.123"></a><span id="l3.123">   fetch3.start();</span>
<a href="#l3.124"></a><span id="l3.124">   call.setAbortable(fetch3);</span>
<a href="#l3.125"></a><span id="l3.125"> </span>
<a href="#l3.126"></a><span id="l3.126" class="difflineminus">-  // url3 is an HTTP URL that will redirect to the real one, usually a HTTPS</span>
<a href="#l3.127"></a><span id="l3.127" class="difflineminus">-  // URL of the hoster. XMLHttpRequest unfortunately loses the call</span>
<a href="#l3.128"></a><span id="l3.128" class="difflineminus">-  // parameters, drops the auth, drops the body, and turns POST into GET,</span>
<a href="#l3.129"></a><span id="l3.129" class="difflineminus">-  // which cause the call to fail, but FetchHTTP fixes this and automatically</span>
<a href="#l3.130"></a><span id="l3.130" class="difflineminus">-  // repeats the call. We need that, otherwise the whole AutoDiscover</span>
<a href="#l3.131"></a><span id="l3.131" class="difflineminus">-  // mechanism doesn't work.</span>
<a href="#l3.132"></a><span id="l3.132" class="difflineminus">-</span>
<a href="#l3.133"></a><span id="l3.133">   successive.current = priority;</span>
<a href="#l3.134"></a><span id="l3.134">   return successive;</span>
<a href="#l3.135"></a><span id="l3.135"> }</span>
<a href="#l3.136"></a><span id="l3.136"> </span>
<a href="#l3.137"></a><span id="l3.137"> var gLoopCounter = 0;</span>
<a href="#l3.138"></a><span id="l3.138"> </span>
<a href="#l3.139"></a><span id="l3.139"> /**</span>
<a href="#l3.140"></a><span id="l3.140">  * @param {JXON} xml - The Exchange server AutoDiscover response</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/components/accountcreation/content/util.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/components/accountcreation/content/util.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -436,17 +436,18 @@ ParallelCall.prototype = {</span>
<a href="#l4.4"></a><span id="l4.4">  * It aborts the forth (because the third succeeded), and it waits for the second to return.</span>
<a href="#l4.5"></a><span id="l4.5">  * If the second succeeds, it is the result, otherwise the third is the result.</span>
<a href="#l4.6"></a><span id="l4.6">  *</span>
<a href="#l4.7"></a><span id="l4.7">  * @param {Function(</span>
<a href="#l4.8"></a><span id="l4.8">  *     {Object} result - Result of winner call</span>
<a href="#l4.9"></a><span id="l4.9">  *     {ParallelCall} call - Winner call info</span>
<a href="#l4.10"></a><span id="l4.10">  *   )} successCallback -  A call returned successfully</span>
<a href="#l4.11"></a><span id="l4.11">  * @param {Function(e, allErrors)} errorCallback - All calls failed.</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">- *     {Exception} e - The exception returned by the first call.</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+ *     {Exception} e - The first CancelledException, and otherwise</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+ *       the exception returned by the first call.</span>
<a href="#l4.15"></a><span id="l4.15">  *     This is just to adhere to the standard API of errorCallback(e).</span>
<a href="#l4.16"></a><span id="l4.16">  *     {Array of Exception} allErrors - The exceptions from all calls.</span>
<a href="#l4.17"></a><span id="l4.17">  */</span>
<a href="#l4.18"></a><span id="l4.18"> function PriorityOrderAbortable(successCallback, errorCallback) {</span>
<a href="#l4.19"></a><span id="l4.19">   assert(typeof successCallback == &quot;function&quot;);</span>
<a href="#l4.20"></a><span id="l4.20">   assert(typeof errorCallback == &quot;function&quot;);</span>
<a href="#l4.21"></a><span id="l4.21">   ParallelAbortable.call(this); // call super constructor</span>
<a href="#l4.22"></a><span id="l4.22">   this._successfulCall = null;</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineat">@@ -482,20 +483,20 @@ function PriorityOrderAbortable(successC</span>
<a href="#l4.24"></a><span id="l4.24">         console.error(e);</span>
<a href="#l4.25"></a><span id="l4.25">         // If the handler failed with this data, treat this call as failed.</span>
<a href="#l4.26"></a><span id="l4.26">         call.e = e;</span>
<a href="#l4.27"></a><span id="l4.27">         call.succeeded = false;</span>
<a href="#l4.28"></a><span id="l4.28">       }</span>
<a href="#l4.29"></a><span id="l4.29">     }</span>
<a href="#l4.30"></a><span id="l4.30">     if (!this._successfulCall) {</span>
<a href="#l4.31"></a><span id="l4.31">       // all failed</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineminus">-      errorCallback(</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineminus">-        this._calls[0].e,</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineminus">-        this._calls.map(call =&gt; call.e)</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineminus">-      ); // see docs above</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+      let allErrors = this._calls.map(call =&gt; call.e);</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+      let e =</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+        allErrors.find(e =&gt; e instanceof CancelledException) || allErrors[0];</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+      errorCallback(e, allErrors); // see docs above</span>
<a href="#l4.40"></a><span id="l4.40">     }</span>
<a href="#l4.41"></a><span id="l4.41">   });</span>
<a href="#l4.42"></a><span id="l4.42"> }</span>
<a href="#l4.43"></a><span id="l4.43"> PriorityOrderAbortable.prototype = Object.create(ParallelAbortable.prototype);</span>
<a href="#l4.44"></a><span id="l4.44"> PriorityOrderAbortable.prototype.constructor = PriorityOrderAbortable;</span>
<a href="#l4.45"></a><span id="l4.45"> </span>
<a href="#l4.46"></a><span id="l4.46"> function NoLongerNeededException(msg) {</span>
<a href="#l4.47"></a><span id="l4.47">   CancelledException.call(this, msg);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/accountCreation.properties</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/accountCreation.properties</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -102,8 +102,12 @@ resultUsernameBoth=%1$S</span>
<a href="#l5.4"></a><span id="l5.4"> resultUsernameDifferent=Incoming: %1$S, Outgoing: %2$S</span>
<a href="#l5.5"></a><span id="l5.5"> </span>
<a href="#l5.6"></a><span id="l5.6"> confirmAdvancedConfigTitle=Confirm Advanced Configuration</span>
<a href="#l5.7"></a><span id="l5.7"> confirmAdvancedConfigText=This dialog will be closed and an account with the current settings will be created, even if the configuration is incorrect. Do you want to proceed?</span>
<a href="#l5.8"></a><span id="l5.8"> </span>
<a href="#l5.9"></a><span id="l5.9"> # LOCALIZATION NOTE(credentials_incomplete): The reference to &quot;janedoe&quot; (Jane Doe) is the name of an example person. You will want to translate it to whatever example persons would be named in your language. In the example, AD is the name of the Windows domain, and this should usually not be translated.</span>
<a href="#l5.10"></a><span id="l5.10"> credentials_incomplete=Authentication failed. Either the entered credentials are incorrect or a separate username is required for logging in. This username is usually your Windows domain login with or without the domain (for example, janedoe or AD\\janedoe).</span>
<a href="#l5.11"></a><span id="l5.11"> credentials_wrong=Authentication failed. Please check the username and password.</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+# LOCALIZATION NOTE(otherDomain.label): %1$S will be the brandShortName. %2$S refers to the domain name, e.g. rackspace.com</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+otherDomain.label=%1$S found your account setup information on %2$S. Do you want to proceed and submit your credentials?</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+otherDomain_ok.label=Login</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+otherDomain_cancel.label=Cancel</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/themes/shared/mail/accountCreation.css</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/themes/shared/mail/accountCreation.css</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -66,16 +66,41 @@</span>
<a href="#l6.4"></a><span id="l6.4"> </span>
<a href="#l6.5"></a><span id="l6.5"> .warning_settings {</span>
<a href="#l6.6"></a><span id="l6.6">   color: yellow;</span>
<a href="#l6.7"></a><span id="l6.7">   font-weight: bold;</span>
<a href="#l6.8"></a><span id="l6.8">   margin: 0;</span>
<a href="#l6.9"></a><span id="l6.9">   margin-right: 2px;</span>
<a href="#l6.10"></a><span id="l6.10"> }</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+#confirmationDialog {</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+  margin-block: 10px;</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+  padding: 10px;</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+  background-color: #FFE900;</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+  color: #333333;</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+  border: 1px solid #F3CE00;</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+  border-radius: 2px;</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineplus">+}</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineplus">+#confirmationButtons {</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+  margin-top: 6px;</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineplus">+}</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineplus">+</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineplus">+#confirmationDialog button {</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineplus">+  background-color: -moz-Dialog;</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineplus">+  border: 1px solid ThreeDShadow;</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineplus">+  margin-inline: 5px;</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineplus">+  margin-bottom: 0;</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineplus">+}</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineplus">+</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+#confirmationDialog button:hover,</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+#confirmationDialog button:focus {</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+  background-color: #FFFFFF;</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+}</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineplus">+</span>
<a href="#l6.37"></a><span id="l6.37"> checkbox.acknowledge_checkbox {</span>
<a href="#l6.38"></a><span id="l6.38">   padding-top: .5em;</span>
<a href="#l6.39"></a><span id="l6.39"> }</span>
<a href="#l6.40"></a><span id="l6.40"> </span>
<a href="#l6.41"></a><span id="l6.41"> .title {</span>
<a href="#l6.42"></a><span id="l6.42">   font-weight: bold;</span>
<a href="#l6.43"></a><span id="l6.43">   padding: 0 3px;</span>
<a href="#l6.44"></a><span id="l6.44"> }</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:31Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

