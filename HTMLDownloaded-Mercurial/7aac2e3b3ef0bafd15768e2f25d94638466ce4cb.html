<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 10769:7aac2e3b3ef0bafd15768e2f25d94638466ce4cb</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 7aac2e3b3ef0bafd15768e2f25d94638466ce4cb" />
<meta property="og:url" content="/comm-central/rev/7aac2e3b3ef0bafd15768e2f25d94638466ce4cb" />
<meta property="og:description" content="Fix bug 756052 - Adapt offline interfaces to avoid extra methods for providers - reduce needed methods. r=redDragon" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 7aac2e3b3ef0bafd15768e2f25d94638466ce4cb 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/7aac2e3b3ef0bafd15768e2f25d94638466ce4cb">shortlog</a> |
<a href="/comm-central/log/7aac2e3b3ef0bafd15768e2f25d94638466ce4cb">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/7aac2e3b3ef0bafd15768e2f25d94638466ce4cb">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/7aac2e3b3ef0bafd15768e2f25d94638466ce4cb">files</a> |
changeset |
<a href="/comm-central/raw-rev/7aac2e3b3ef0bafd15768e2f25d94638466ce4cb">raw</a>  | <a href="/comm-central/archive/7aac2e3b3ef0bafd15768e2f25d94638466ce4cb.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
Fix <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=756052">bug 756052</a> - Adapt offline interfaces to avoid extra methods for providers - reduce needed methods. r=redDragon
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#80;&#104;&#105;&#108;&#105;&#112;&#112;&#32;&#75;&#101;&#119;&#105;&#115;&#99;&#104;&#32;&#60;&#109;&#111;&#122;&#105;&#108;&#108;&#97;&#64;&#107;&#101;&#119;&#105;&#115;&#46;&#99;&#104;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 30 Jul 2012 14:07:24 +0200</td></tr>

<tr>
 <td>changeset 10769</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/7aac2e3b3ef0bafd15768e2f25d94638466ce4cb">7aac2e3b3ef0bafd15768e2f25d94638466ce4cb</a></td>
</tr>



<tr>
<td>parent 10768</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/1d9804d82741e50193c1ce7dce539692c154c2d9">1d9804d82741e50193c1ce7dce539692c154c2d9</a>
</td>
</tr>

<tr>
<td>child 10770</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/ccab1c205bb0e6c48108418389c15870bff5f9ba">ccab1c205bb0e6c48108418389c15870bff5f9ba</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=7aac2e3b3ef0bafd15768e2f25d94638466ce4cb">8094</a></td></tr>
<tr><td>push user</td><td>mozilla@kewis.ch</td></tr>
<tr><td>push date</td><td class="date age">Mon, 30 Jul 2012 12:09:29 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@ccab1c205bb0 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=ccab1c205bb0e6c48108418389c15870bff5f9ba">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=ccab1c205bb0e6c48108418389c15870bff5f9ba&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=ccab1c205bb0e6c48108418389c15870bff5f9ba&newProject=comm-central&newRevision=7aac2e3b3ef0bafd15768e2f25d94638466ce4cb&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=ccab1c205bb0e6c48108418389c15870bff5f9ba&newProject=comm-central&newRevision=7aac2e3b3ef0bafd15768e2f25d94638466ce4cb&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=ccab1c205bb0e6c48108418389c15870bff5f9ba&newProject=comm-central&newRevision=7aac2e3b3ef0bafd15768e2f25d94638466ce4cb&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28redDragon%29&revcount=50">redDragon</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=756052">756052</a></td></tr>




</table></div>

<div class="page_body description">Fix <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=756052">bug 756052</a> - Adapt offline interfaces to avoid extra methods for providers - reduce needed methods. r=redDragon</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7aac2e3b3ef0bafd15768e2f25d94638466ce4cb/calendar/base/public/calIChangeLog.idl">calendar/base/public/calIChangeLog.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7aac2e3b3ef0bafd15768e2f25d94638466ce4cb/calendar/base/public/calIChangeLog.idl">file</a> |
<a href="/comm-central/annotate/7aac2e3b3ef0bafd15768e2f25d94638466ce4cb/calendar/base/public/calIChangeLog.idl">annotate</a> |
<a href="/comm-central/diff/7aac2e3b3ef0bafd15768e2f25d94638466ce4cb/calendar/base/public/calIChangeLog.idl">diff</a> |
<a href="/comm-central/comparison/7aac2e3b3ef0bafd15768e2f25d94638466ce4cb/calendar/base/public/calIChangeLog.idl">comparison</a> |
<a href="/comm-central/log/7aac2e3b3ef0bafd15768e2f25d94638466ce4cb/calendar/base/public/calIChangeLog.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7aac2e3b3ef0bafd15768e2f25d94638466ce4cb/calendar/base/src/calCachedCalendar.js">calendar/base/src/calCachedCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7aac2e3b3ef0bafd15768e2f25d94638466ce4cb/calendar/base/src/calCachedCalendar.js">file</a> |
<a href="/comm-central/annotate/7aac2e3b3ef0bafd15768e2f25d94638466ce4cb/calendar/base/src/calCachedCalendar.js">annotate</a> |
<a href="/comm-central/diff/7aac2e3b3ef0bafd15768e2f25d94638466ce4cb/calendar/base/src/calCachedCalendar.js">diff</a> |
<a href="/comm-central/comparison/7aac2e3b3ef0bafd15768e2f25d94638466ce4cb/calendar/base/src/calCachedCalendar.js">comparison</a> |
<a href="/comm-central/log/7aac2e3b3ef0bafd15768e2f25d94638466ce4cb/calendar/base/src/calCachedCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7aac2e3b3ef0bafd15768e2f25d94638466ce4cb/calendar/providers/caldav/calDavCalendar.js">calendar/providers/caldav/calDavCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7aac2e3b3ef0bafd15768e2f25d94638466ce4cb/calendar/providers/caldav/calDavCalendar.js">file</a> |
<a href="/comm-central/annotate/7aac2e3b3ef0bafd15768e2f25d94638466ce4cb/calendar/providers/caldav/calDavCalendar.js">annotate</a> |
<a href="/comm-central/diff/7aac2e3b3ef0bafd15768e2f25d94638466ce4cb/calendar/providers/caldav/calDavCalendar.js">diff</a> |
<a href="/comm-central/comparison/7aac2e3b3ef0bafd15768e2f25d94638466ce4cb/calendar/providers/caldav/calDavCalendar.js">comparison</a> |
<a href="/comm-central/log/7aac2e3b3ef0bafd15768e2f25d94638466ce4cb/calendar/providers/caldav/calDavCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7aac2e3b3ef0bafd15768e2f25d94638466ce4cb/calendar/providers/gdata/components/calGoogleCalendar.js">calendar/providers/gdata/components/calGoogleCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7aac2e3b3ef0bafd15768e2f25d94638466ce4cb/calendar/providers/gdata/components/calGoogleCalendar.js">file</a> |
<a href="/comm-central/annotate/7aac2e3b3ef0bafd15768e2f25d94638466ce4cb/calendar/providers/gdata/components/calGoogleCalendar.js">annotate</a> |
<a href="/comm-central/diff/7aac2e3b3ef0bafd15768e2f25d94638466ce4cb/calendar/providers/gdata/components/calGoogleCalendar.js">diff</a> |
<a href="/comm-central/comparison/7aac2e3b3ef0bafd15768e2f25d94638466ce4cb/calendar/providers/gdata/components/calGoogleCalendar.js">comparison</a> |
<a href="/comm-central/log/7aac2e3b3ef0bafd15768e2f25d94638466ce4cb/calendar/providers/gdata/components/calGoogleCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7aac2e3b3ef0bafd15768e2f25d94638466ce4cb/calendar/providers/wcap/calWcapCalendar.js">calendar/providers/wcap/calWcapCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7aac2e3b3ef0bafd15768e2f25d94638466ce4cb/calendar/providers/wcap/calWcapCalendar.js">file</a> |
<a href="/comm-central/annotate/7aac2e3b3ef0bafd15768e2f25d94638466ce4cb/calendar/providers/wcap/calWcapCalendar.js">annotate</a> |
<a href="/comm-central/diff/7aac2e3b3ef0bafd15768e2f25d94638466ce4cb/calendar/providers/wcap/calWcapCalendar.js">diff</a> |
<a href="/comm-central/comparison/7aac2e3b3ef0bafd15768e2f25d94638466ce4cb/calendar/providers/wcap/calWcapCalendar.js">comparison</a> |
<a href="/comm-central/log/7aac2e3b3ef0bafd15768e2f25d94638466ce4cb/calendar/providers/wcap/calWcapCalendar.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/calendar/base/public/calIChangeLog.idl</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/calendar/base/public/calIChangeLog.idl</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -127,61 +127,21 @@ interface calIChangeLog : nsISupports {</span>
<a href="#l1.4"></a><span id="l1.4">     attribute calISyncWriteCalendar offlineStorage;</span>
<a href="#l1.5"></a><span id="l1.5"> </span>
<a href="#l1.6"></a><span id="l1.6">     /**</span>
<a href="#l1.7"></a><span id="l1.7">      * Resets the changelog. This is used if the cache should be refreshed.</span>
<a href="#l1.8"></a><span id="l1.8">      */</span>
<a href="#l1.9"></a><span id="l1.9">     void resetLog();</span>
<a href="#l1.10"></a><span id="l1.10"> </span>
<a href="#l1.11"></a><span id="l1.11">     /**</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-     * Instructs the calendar to replay remote changes into the given</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+     * Instructs the calendar to replay remote changes into the above offlineStorage</span>
<a href="#l1.14"></a><span id="l1.14">      * calendar. The calendar itself is responsible for storing anything needed</span>
<a href="#l1.15"></a><span id="l1.15">      * to keep track of what items need updating.</span>
<a href="#l1.16"></a><span id="l1.16">      *</span>
<a href="#l1.17"></a><span id="l1.17">      * TODO: We might reconsider to replay on calICalendar,</span>
<a href="#l1.18"></a><span id="l1.18">      *       but this complicates implementing this interface</span>
<a href="#l1.19"></a><span id="l1.19">      *       enormously for providers.</span>
<a href="#l1.20"></a><span id="l1.20">      *</span>
<a href="#l1.21"></a><span id="l1.21">      * @param aDestination      The calendar to sync changes into</span>
<a href="#l1.22"></a><span id="l1.22">      * @param aListener         The listener to notify when the operation completes.</span>
<a href="#l1.23"></a><span id="l1.23">      */</span>
<a href="#l1.24"></a><span id="l1.24">     calIOperation replayChangesOn(in calIGenericOperationListener aListener);</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineminus">-</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineminus">-    /**</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineminus">-     * addItemOrUseCache: same as calICalendar::addItem</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineminus">-     *</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineminus">-     * @param useCache          use the cache for handling availability errors</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineminus">-     *</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-     * When 'useCache' is set, failure to perform the operation will result in</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineminus">-     * a write in the cache with the corresponding offline operation, when the</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineminus">-     * backend supports it. In that case, the listener will thus always</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineminus">-     * receive a success code. When unset, the behaviour is similar to the</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineminus">-     * corresponding addItem() invocation.</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineminus">-     */</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineminus">-    calIOperation addItemOrUseCache(in calIItemBase aItem,</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineminus">-                                    in boolean useCache,</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineminus">-                                    in calIOperationListener aListener);</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineminus">-    /**</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineminus">-     * adoptItemOrUseCache: same as calICalendar::adoptItem</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineminus">-     *</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineminus">-     * @param useCache          use the cache for handling availability errors</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineminus">-     */</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineminus">-    calIOperation adoptItemOrUseCache(in calIItemBase aItem,</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineminus">-                                      in boolean useCache,</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineminus">-                                      in calIOperationListener aListener);</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineminus">-    /**</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineminus">-     * modifyItemOrUseCache: same as calICalendar::modifyItem</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineminus">-     *</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineminus">-     * @param useCache          use the cache for handling availability errors</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineminus">-     */</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineminus">-    calIOperation modifyItemOrUseCache(in calIItemBase aNewItem,</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineminus">-                                       in calIItemBase aOldItem,</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineminus">-                                       in boolean useCache,</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineminus">-                                       in calIOperationListener aListener);</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineminus">-    /**</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineminus">-     * deleteItemOrUseCache: same as calICalendar::deleteItem</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineminus">-     *</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineminus">-     * @param useCache          use the cache for handling availability errors</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineminus">-     */</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineminus">-    calIOperation deleteItemOrUseCache(in calIItemBase aItem,</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineminus">-                                       in boolean useCache,</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineminus">-                                       in calIOperationListener aListener);</span>
<a href="#l1.65"></a><span id="l1.65"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/calendar/base/src/calCachedCalendar.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/calendar/base/src/calCachedCalendar.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -10,16 +10,47 @@ const cICL = Components.interfaces.calIC</span>
<a href="#l2.4"></a><span id="l2.4"> let gNoOpListener = {</span>
<a href="#l2.5"></a><span id="l2.5">     onGetResult: function(calendar, status, itemType, detail, count, items) {</span>
<a href="#l2.6"></a><span id="l2.6">     },</span>
<a href="#l2.7"></a><span id="l2.7"> </span>
<a href="#l2.8"></a><span id="l2.8">     onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l2.9"></a><span id="l2.9">     }</span>
<a href="#l2.10"></a><span id="l2.10"> };</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+/**</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+ * Returns true if the exception passed is one that should cause the cache</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+ * layer to retry the operation. This is usually a network error or other</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+ * temporary error.</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+ *</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+ * @param result     The result code to check.</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+ * @return           True, if the result code means server unavailability.</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+ */</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+function isUnavailableCode(result) {</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineplus">+    // Stolen from nserror.h</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineplus">+    const NS_ERROR_MODULE_NETWORK = 6;</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineplus">+    function NS_ERROR_GET_MODULE(code) {</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineplus">+        return (((code &gt;&gt; 16) - 0x45) &amp; 0x1fff);</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineplus">+    }</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineplus">+</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineplus">+    if (NS_ERROR_GET_MODULE(result) == NS_ERROR_MODULE_NETWORK &amp;&amp;</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineplus">+        !Components.isSuccessCode(result)) {</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineplus">+        // This is a network error, which most likely means we should</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineplus">+        // retry it some time.</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+        return true;</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+    }</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+    // Other potential errors we want to retry with</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+    switch (result) {</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+        case Components.results.NS_ERROR_NOT_AVAILABLE:</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+            return true;</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+        default:</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+            return false;</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+    }</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+}</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineplus">+</span>
<a href="#l2.43"></a><span id="l2.43"> function calCachedCalendarObserverHelper(home, isCachedObserver) {</span>
<a href="#l2.44"></a><span id="l2.44">     this.home = home;</span>
<a href="#l2.45"></a><span id="l2.45">     this.isCachedObserver = isCachedObserver;</span>
<a href="#l2.46"></a><span id="l2.46"> }</span>
<a href="#l2.47"></a><span id="l2.47"> calCachedCalendarObserverHelper.prototype = {</span>
<a href="#l2.48"></a><span id="l2.48">     isCachedObserver: false,</span>
<a href="#l2.49"></a><span id="l2.49"> </span>
<a href="#l2.50"></a><span id="l2.50">     onStartBatch: function() {</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineat">@@ -154,17 +185,17 @@ calCachedCalendar.prototype = {</span>
<a href="#l2.52"></a><span id="l2.52">                         if (this.supportsChangeLog) {</span>
<a href="#l2.53"></a><span id="l2.53">                             // start with full sync:</span>
<a href="#l2.54"></a><span id="l2.54">                             this.mUncachedCalendar.resetLog();</span>
<a href="#l2.55"></a><span id="l2.55">                         }</span>
<a href="#l2.56"></a><span id="l2.56">                         break;</span>
<a href="#l2.57"></a><span id="l2.57">                     case &quot;storage&quot;:</span>
<a href="#l2.58"></a><span id="l2.58">                         let file = getCalendarDirectory();</span>
<a href="#l2.59"></a><span id="l2.59">                         file.append(&quot;cache.sqlite&quot;);</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineminus">-                        cachedCalendar.uri = getIOService().newFileURI(file);</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineplus">+                        cachedCalendar.uri = Services.io.newFileURI(file);</span>
<a href="#l2.62"></a><span id="l2.62">                         cachedCalendar.id = this.id;</span>
<a href="#l2.63"></a><span id="l2.63">                         break;</span>
<a href="#l2.64"></a><span id="l2.64">                     default:</span>
<a href="#l2.65"></a><span id="l2.65">                         throw new Error(&quot;unsupported cache calendar type: &quot; + calType);</span>
<a href="#l2.66"></a><span id="l2.66">                 }</span>
<a href="#l2.67"></a><span id="l2.67">                 cachedCalendar.transientProperties = true;</span>
<a href="#l2.68"></a><span id="l2.68">                 cachedCalendar.setProperty(&quot;relaxedMode&quot;, true);</span>
<a href="#l2.69"></a><span id="l2.69">                 cachedCalendar.superCalendar = this;</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineat">@@ -269,24 +300,23 @@ calCachedCalendar.prototype = {</span>
<a href="#l2.71"></a><span id="l2.71"> </span>
<a href="#l2.72"></a><span id="l2.72">         if (this.offline) {</span>
<a href="#l2.73"></a><span id="l2.73">             return emptyQueue(Components.results.NS_OK);</span>
<a href="#l2.74"></a><span id="l2.74">         }</span>
<a href="#l2.75"></a><span id="l2.75"> </span>
<a href="#l2.76"></a><span id="l2.76">         if (this.supportsChangeLog) {</span>
<a href="#l2.77"></a><span id="l2.77">             cal.LOG(&quot;[calCachedCalendar] Doing changelog based sync for calendar &quot; + this.uri.spec);</span>
<a href="#l2.78"></a><span id="l2.78">             var opListener = {</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineminus">-                thisCalendar : this,</span>
<a href="#l2.80"></a><span id="l2.80">                 onResult: function(op, result) {</span>
<a href="#l2.81"></a><span id="l2.81">                     if (!op || !op.isPending) {</span>
<a href="#l2.82"></a><span id="l2.82">                         var status = (op ? op.status : Components.results.NS_OK);</span>
<a href="#l2.83"></a><span id="l2.83">                         if (!Components.isSuccessCode(status)) {</span>
<a href="#l2.84"></a><span id="l2.84">                             cal.ERROR(&quot;[calCachedCalendar] replay action failed: &quot; +</span>
<a href="#l2.85"></a><span id="l2.85">                                       (op ? op.id : &quot;&lt;unknown&gt;&quot;)+&quot;, uri=&quot; +</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineminus">-                                      this.thisCalendar.uri.spec + &quot;, result=&quot; +</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineplus">+                                      this_.uri.spec + &quot;, result=&quot; +</span>
<a href="#l2.88"></a><span id="l2.88">                                       result + &quot;, op=&quot; + op);</span>
<a href="#l2.89"></a><span id="l2.89">                         }</span>
<a href="#l2.90"></a><span id="l2.90">                         cal.LOG(&quot;[calCachedCalendar] replayChangesOn finished.&quot;);</span>
<a href="#l2.91"></a><span id="l2.91">                         emptyQueue(status);</span>
<a href="#l2.92"></a><span id="l2.92">                     }</span>
<a href="#l2.93"></a><span id="l2.93">                 }</span>
<a href="#l2.94"></a><span id="l2.94">             };</span>
<a href="#l2.95"></a><span id="l2.95">             this.mPendingSync = this.mUncachedCalendar.replayChangesOn(opListener);</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineat">@@ -439,18 +469,21 @@ calCachedCalendar.prototype = {</span>
<a href="#l2.97"></a><span id="l2.97">             itemCount: 0,</span>
<a href="#l2.98"></a><span id="l2.98"> </span>
<a href="#l2.99"></a><span id="l2.99">             onGetResult: function(calendar, status, itemType, detail, count, items) {</span>
<a href="#l2.100"></a><span id="l2.100">             },</span>
<a href="#l2.101"></a><span id="l2.101">             onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l2.102"></a><span id="l2.102">                 if (Components.isSuccessCode(status)) {</span>
<a href="#l2.103"></a><span id="l2.103">                     storage.resetItemOfflineFlag(detail, resetListener);</span>
<a href="#l2.104"></a><span id="l2.104">                 } else {</span>
<a href="#l2.105"></a><span id="l2.105" class="difflineminus">-                    cal.LOG(&quot;[calCachedCalendar.js] Unable to playback the items to the server. Will try again later. Aborting\n&quot;);</span>
<a href="#l2.106"></a><span id="l2.106" class="difflineminus">-                    // TODO does something need to be called back?</span>
<a href="#l2.107"></a><span id="l2.107" class="difflineplus">+                    // If the item could not be added to the server, then there</span>
<a href="#l2.108"></a><span id="l2.108" class="difflineplus">+                    // is no need for further action. The item still has the</span>
<a href="#l2.109"></a><span id="l2.109" class="difflineplus">+                    // offline flag, so it will be taken care of next time.</span>
<a href="#l2.110"></a><span id="l2.110" class="difflineplus">+                    cal.WARN(&quot;[calCachedCalendar] Unable to playback an item addition to &quot; +</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineplus">+                             &quot;the server, will try again next time (&quot; + id + &quot;,&quot; + detail + &quot;)&quot;);</span>
<a href="#l2.112"></a><span id="l2.112">                 }</span>
<a href="#l2.113"></a><span id="l2.113"> </span>
<a href="#l2.114"></a><span id="l2.114">                 this.itemCount--;</span>
<a href="#l2.115"></a><span id="l2.115">                 if (this.itemCount == 0) {</span>
<a href="#l2.116"></a><span id="l2.116">                     this_.playbackModifiedItems(callbackFunc);</span>
<a href="#l2.117"></a><span id="l2.117">                 }</span>
<a href="#l2.118"></a><span id="l2.118">             }</span>
<a href="#l2.119"></a><span id="l2.119">         };</span>
<a href="#l2.120"></a><span id="l2.120" class="difflineat">@@ -466,25 +499,20 @@ calCachedCalendar.prototype = {</span>
<a href="#l2.121"></a><span id="l2.121">                     cal.LOG(&quot;[calCachedCalendar] back to offline mode, reconciliation aborted&quot;);</span>
<a href="#l2.122"></a><span id="l2.122">                     callbackFunc();</span>
<a href="#l2.123"></a><span id="l2.123">                 } else {</span>
<a href="#l2.124"></a><span id="l2.124">                     cal.LOG(&quot;[calCachedCalendar] Adding &quot;  + this.items.length + &quot; items to &quot; + this_.name);</span>
<a href="#l2.125"></a><span id="l2.125">                     if (this.items.length &gt; 0) {</span>
<a href="#l2.126"></a><span id="l2.126">                         addListener.itemCount = this.items.length;</span>
<a href="#l2.127"></a><span id="l2.127">                         for each (let item in this.items) {</span>
<a href="#l2.128"></a><span id="l2.128">                             try {</span>
<a href="#l2.129"></a><span id="l2.129" class="difflineminus">-                                if (this_.supportsChangeLog) {</span>
<a href="#l2.130"></a><span id="l2.130" class="difflineminus">-                                    this_.mUncachedCalendar.addItemOrUseCache(item, false, addListener);</span>
<a href="#l2.131"></a><span id="l2.131" class="difflineminus">-                                } else {</span>
<a href="#l2.132"></a><span id="l2.132" class="difflineminus">-                                    // default mechanism for providers not implementing calIChangeLog</span>
<a href="#l2.133"></a><span id="l2.133" class="difflineminus">-                                    this_.mUncachedCalendar.adoptItem(item.clone(), addListener);</span>
<a href="#l2.134"></a><span id="l2.134" class="difflineminus">-                                }</span>
<a href="#l2.135"></a><span id="l2.135" class="difflineplus">+                                this_.mUncachedCalendar.addItem(item, addListener);</span>
<a href="#l2.136"></a><span id="l2.136">                             } catch (e) {</span>
<a href="#l2.137"></a><span id="l2.137">                                 cal.ERROR(&quot;[calCachedCalendar] Could not playback added item &quot; + item.title + &quot;: &quot; + e);</span>
<a href="#l2.138"></a><span id="l2.138" class="difflineminus">-                                addListener.onOperationComplete(thisCalendar,</span>
<a href="#l2.139"></a><span id="l2.139" class="difflineplus">+                                addListener.onOperationComplete(this_,</span>
<a href="#l2.140"></a><span id="l2.140">                                                                 e.result,</span>
<a href="#l2.141"></a><span id="l2.141">                                                                 Components.interfaces.calIOperationListener.ADD,</span>
<a href="#l2.142"></a><span id="l2.142">                                                                 item.id,</span>
<a href="#l2.143"></a><span id="l2.143">                                                                 e.message);</span>
<a href="#l2.144"></a><span id="l2.144">                             }</span>
<a href="#l2.145"></a><span id="l2.145">                         }</span>
<a href="#l2.146"></a><span id="l2.146">                     } else {</span>
<a href="#l2.147"></a><span id="l2.147">                         this_.playbackModifiedItems(callbackFunc);</span>
<a href="#l2.148"></a><span id="l2.148" class="difflineat">@@ -505,17 +533,21 @@ calCachedCalendar.prototype = {</span>
<a href="#l2.149"></a><span id="l2.149"> </span>
<a href="#l2.150"></a><span id="l2.150">         let modifyListener = {</span>
<a href="#l2.151"></a><span id="l2.151">             itemCount: 0,</span>
<a href="#l2.152"></a><span id="l2.152">             onGetResult: function(calendar, status, itemType, detail, count, items) {},</span>
<a href="#l2.153"></a><span id="l2.153">             onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l2.154"></a><span id="l2.154">                 if (Components.isSuccessCode(status)) {</span>
<a href="#l2.155"></a><span id="l2.155">                     storage.resetItemOfflineFlag(detail, resetListener);</span>
<a href="#l2.156"></a><span id="l2.156">                 } else {</span>
<a href="#l2.157"></a><span id="l2.157" class="difflineminus">-                    cal.ERROR(&quot;[calCachedCalendar] Could not modify item &quot; + id + &quot; - &quot; + detail);</span>
<a href="#l2.158"></a><span id="l2.158" class="difflineplus">+                    // If the item could not be modified on the server, then there</span>
<a href="#l2.159"></a><span id="l2.159" class="difflineplus">+                    // is no need for further action. The item still has the</span>
<a href="#l2.160"></a><span id="l2.160" class="difflineplus">+                    // offline flag, so it will be taken care of next time.</span>
<a href="#l2.161"></a><span id="l2.161" class="difflineplus">+                    cal.WARN(&quot;[calCachedCalendar] Unable to playback an item modification to &quot; +</span>
<a href="#l2.162"></a><span id="l2.162" class="difflineplus">+                             &quot;the server, will try again next time (&quot; + id + &quot;,&quot; + detail + &quot;)&quot;);</span>
<a href="#l2.163"></a><span id="l2.163">                 }</span>
<a href="#l2.164"></a><span id="l2.164"> </span>
<a href="#l2.165"></a><span id="l2.165">                 this.itemCount--;</span>
<a href="#l2.166"></a><span id="l2.166">                 if (this.itemCount == 0) {</span>
<a href="#l2.167"></a><span id="l2.167">                     // All items have been pushed in and this is the last.</span>
<a href="#l2.168"></a><span id="l2.168">                     // Continue with deleted items.</span>
<a href="#l2.169"></a><span id="l2.169">                     this_.playbackDeletedItems(callbackFunc);</span>
<a href="#l2.170"></a><span id="l2.170">                 }</span>
<a href="#l2.171"></a><span id="l2.171" class="difflineat">@@ -533,27 +565,22 @@ calCachedCalendar.prototype = {</span>
<a href="#l2.172"></a><span id="l2.172">                     cal.LOG(&quot;[calCachedCalendar] Returning to offline mode, reconciliation aborted&quot;);</span>
<a href="#l2.173"></a><span id="l2.173">                     callbackFunc();</span>
<a href="#l2.174"></a><span id="l2.174">                 } else {</span>
<a href="#l2.175"></a><span id="l2.175">                     cal.LOG(&quot;[calCachedCalendar] Modifying &quot; + this.items.length + &quot; items in &quot; + this_.name);</span>
<a href="#l2.176"></a><span id="l2.176">                     if (this.items.length &gt; 0) {</span>
<a href="#l2.177"></a><span id="l2.177">                         modifyListener.itemCount = this.items.length;</span>
<a href="#l2.178"></a><span id="l2.178">                         for each (let item in this.items) {</span>
<a href="#l2.179"></a><span id="l2.179">                             try {</span>
<a href="#l2.180"></a><span id="l2.180" class="difflineminus">-                                if (this_.supportsChangeLog) {</span>
<a href="#l2.181"></a><span id="l2.181" class="difflineminus">-                                    // The calendar supports the changelog functions, let it modify the item</span>
<a href="#l2.182"></a><span id="l2.182" class="difflineminus">-                                    // TODO is it ok to not have the old item here? Pass null or the new item?</span>
<a href="#l2.183"></a><span id="l2.183" class="difflineminus">-                                    this_.mUncachedCalendar.modifyItemOrUseCache(item, item, false, modifyListener);</span>
<a href="#l2.184"></a><span id="l2.184" class="difflineminus">-                                } else {</span>
<a href="#l2.185"></a><span id="l2.185" class="difflineminus">-                                    // Default strategy for providers not implementing calIChangeLog</span>
<a href="#l2.186"></a><span id="l2.186" class="difflineminus">-                                    this_.mUncachedCalendar.modifyItem(item, null, modifyListener);</span>
<a href="#l2.187"></a><span id="l2.187" class="difflineminus">-                                }</span>
<a href="#l2.188"></a><span id="l2.188" class="difflineplus">+                                // The calendar supports the changelog functions, let it modify the item</span>
<a href="#l2.189"></a><span id="l2.189" class="difflineplus">+                                // TODO is it ok to not have the old item here? Pass null or the new item?</span>
<a href="#l2.190"></a><span id="l2.190" class="difflineplus">+                                this_.mUncachedCalendar.modifyItem(item, item, modifyListener);</span>
<a href="#l2.191"></a><span id="l2.191">                             } catch (e) {</span>
<a href="#l2.192"></a><span id="l2.192">                                 cal.ERROR(&quot;[calCachedCalendar] Could not playback modified item &quot; + item.title + &quot;: &quot; + e);</span>
<a href="#l2.193"></a><span id="l2.193" class="difflineminus">-                                modifyListener.onOperationComplete(thisCalendar,</span>
<a href="#l2.194"></a><span id="l2.194" class="difflineplus">+                                modifyListener.onOperationComplete(this_,</span>
<a href="#l2.195"></a><span id="l2.195">                                                                    e.result,</span>
<a href="#l2.196"></a><span id="l2.196">                                                                    Components.interfaces.calIOperationListener.MODIFY,</span>
<a href="#l2.197"></a><span id="l2.197">                                                                    item.id,</span>
<a href="#l2.198"></a><span id="l2.198">                                                                    e.message);</span>
<a href="#l2.199"></a><span id="l2.199">                             }</span>
<a href="#l2.200"></a><span id="l2.200">                         }</span>
<a href="#l2.201"></a><span id="l2.201">                     } else {</span>
<a href="#l2.202"></a><span id="l2.202">                         this_.playbackDeletedItems(callbackFunc);</span>
<a href="#l2.203"></a><span id="l2.203" class="difflineat">@@ -579,18 +606,21 @@ calCachedCalendar.prototype = {</span>
<a href="#l2.204"></a><span id="l2.204">             onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l2.205"></a><span id="l2.205">                 if (Components.isSuccessCode(status)) {</span>
<a href="#l2.206"></a><span id="l2.206">                     this_.mCachedCalendar.deleteItem(detail, resetListener);</span>
<a href="#l2.207"></a><span id="l2.207">                     this.itemCount--;</span>
<a href="#l2.208"></a><span id="l2.208">                     if (this.itemCount == 0 &amp;&amp; callbackFunc) {</span>
<a href="#l2.209"></a><span id="l2.209">                         callbackFunc();</span>
<a href="#l2.210"></a><span id="l2.210">                     }</span>
<a href="#l2.211"></a><span id="l2.211">                 } else {</span>
<a href="#l2.212"></a><span id="l2.212" class="difflineminus">-                    // TODO do something on error</span>
<a href="#l2.213"></a><span id="l2.213" class="difflineminus">-                    cal.WARN(&quot;[calCachedCalendar] failed to playback deleted item &quot; + id + &quot; - &quot; + detail);</span>
<a href="#l2.214"></a><span id="l2.214" class="difflineplus">+                    // If the item could not be deleted on the server, then there</span>
<a href="#l2.215"></a><span id="l2.215" class="difflineplus">+                    // is no need for further action. The item still has the</span>
<a href="#l2.216"></a><span id="l2.216" class="difflineplus">+                    // offline flag, so it will be taken care of next time.</span>
<a href="#l2.217"></a><span id="l2.217" class="difflineplus">+                    cal.WARN(&quot;[calCachedCalendar] Unable to playback an item deletion to &quot; +</span>
<a href="#l2.218"></a><span id="l2.218" class="difflineplus">+                             &quot;the server, will try again next time (&quot; + id + &quot;,&quot; + detail + &quot;)&quot;);</span>
<a href="#l2.219"></a><span id="l2.219">                 }</span>
<a href="#l2.220"></a><span id="l2.220">             }</span>
<a href="#l2.221"></a><span id="l2.221">         };</span>
<a href="#l2.222"></a><span id="l2.222"> </span>
<a href="#l2.223"></a><span id="l2.223">         let getListener = {</span>
<a href="#l2.224"></a><span id="l2.224">             items: [],</span>
<a href="#l2.225"></a><span id="l2.225"> </span>
<a href="#l2.226"></a><span id="l2.226">             onGetResult: function(calendar, status, itemType, detail, count, items) {</span>
<a href="#l2.227"></a><span id="l2.227" class="difflineat">@@ -601,25 +631,20 @@ calCachedCalendar.prototype = {</span>
<a href="#l2.228"></a><span id="l2.228">                     cal.LOG(&quot;[calCachedCalendar] Returning to offline mode, reconciliation aborted&quot;);</span>
<a href="#l2.229"></a><span id="l2.229">                     callbackFunc();</span>
<a href="#l2.230"></a><span id="l2.230">                 } else {</span>
<a href="#l2.231"></a><span id="l2.231">                     cal.LOG(&quot;[calCachedCalendar] Deleting &quot;  + this.items.length + &quot; items from &quot; + this_.name);</span>
<a href="#l2.232"></a><span id="l2.232">                     if (this.items.length &gt; 0) {</span>
<a href="#l2.233"></a><span id="l2.233">                         deleteListener.itemCount = this.items.length;</span>
<a href="#l2.234"></a><span id="l2.234">                         for each (let item in this.items) {</span>
<a href="#l2.235"></a><span id="l2.235">                             try {</span>
<a href="#l2.236"></a><span id="l2.236" class="difflineminus">-                                if (this_.supportsChangeLog) {</span>
<a href="#l2.237"></a><span id="l2.237" class="difflineminus">-                                    this_.mUncachedCalendar.deleteItemOrUseCache(item, false, deleteListener);</span>
<a href="#l2.238"></a><span id="l2.238" class="difflineminus">-                                } else {</span>
<a href="#l2.239"></a><span id="l2.239" class="difflineminus">-                                    // Default strategy for providers not implementing calIChangeLog</span>
<a href="#l2.240"></a><span id="l2.240" class="difflineminus">-                                    this_.mUncachedCalendar.deleteItem(item, deleteListener);</span>
<a href="#l2.241"></a><span id="l2.241" class="difflineminus">-                                }</span>
<a href="#l2.242"></a><span id="l2.242" class="difflineplus">+                                this_.mUncachedCalendar.deleteItem(item, deleteListener);</span>
<a href="#l2.243"></a><span id="l2.243">                             } catch (e) {</span>
<a href="#l2.244"></a><span id="l2.244">                                 cal.ERROR(&quot;[calCachedCalendar] Could not playback deleted item &quot; + item.title + &quot;: &quot; + e);</span>
<a href="#l2.245"></a><span id="l2.245" class="difflineminus">-                                deleteListener.onOperationComplete(thisCalendar,</span>
<a href="#l2.246"></a><span id="l2.246" class="difflineplus">+                                deleteListener.onOperationComplete(this_,</span>
<a href="#l2.247"></a><span id="l2.247">                                                                    e.result,</span>
<a href="#l2.248"></a><span id="l2.248">                                                                    Components.interfaces.calIOperationListener.MODIFY,</span>
<a href="#l2.249"></a><span id="l2.249">                                                                    item.id,</span>
<a href="#l2.250"></a><span id="l2.250">                                                                    e.message);</span>
<a href="#l2.251"></a><span id="l2.251">                             }</span>
<a href="#l2.252"></a><span id="l2.252">                         }</span>
<a href="#l2.253"></a><span id="l2.253">                     } else if (callbackFunc) {</span>
<a href="#l2.254"></a><span id="l2.254">                         callbackFunc();</span>
<a href="#l2.255"></a><span id="l2.255" class="difflineat">@@ -680,47 +705,55 @@ calCachedCalendar.prototype = {</span>
<a href="#l2.256"></a><span id="l2.256">     removeObserver: function(aObserver) {</span>
<a href="#l2.257"></a><span id="l2.257">         this.mObservers.remove(aObserver);</span>
<a href="#l2.258"></a><span id="l2.258">     },</span>
<a href="#l2.259"></a><span id="l2.259"> </span>
<a href="#l2.260"></a><span id="l2.260">     addItem: function(item, listener) {</span>
<a href="#l2.261"></a><span id="l2.261">         return this.adoptItem(item.clone(), listener);</span>
<a href="#l2.262"></a><span id="l2.262">     },</span>
<a href="#l2.263"></a><span id="l2.263">     adoptItem: function(item, listener) {</span>
<a href="#l2.264"></a><span id="l2.264" class="difflineminus">-        if (this.offline) {</span>
<a href="#l2.265"></a><span id="l2.265" class="difflineminus">-            this.adoptOfflineItem(item, listener);</span>
<a href="#l2.266"></a><span id="l2.266" class="difflineminus">-            return;</span>
<a href="#l2.267"></a><span id="l2.267" class="difflineminus">-        }</span>
<a href="#l2.268"></a><span id="l2.268">         // Forwarding add/modify/delete to the cached calendar using the calIObserver</span>
<a href="#l2.269"></a><span id="l2.269">         // callbacks would be advantageous, because the uncached provider could implement</span>
<a href="#l2.270"></a><span id="l2.270">         // a true push mechanism firing without being triggered from within the program.</span>
<a href="#l2.271"></a><span id="l2.271">         // But this would mean the uncached provider fires on the passed</span>
<a href="#l2.272"></a><span id="l2.272">         // calIOperationListener, e.g. *before* it fires on calIObservers</span>
<a href="#l2.273"></a><span id="l2.273">         // (because that order is undefined). Firing onOperationComplete before onAddItem et al</span>
<a href="#l2.274"></a><span id="l2.274">         // would result in this facade firing onOperationComplete even though the modification</span>
<a href="#l2.275"></a><span id="l2.275">         // hasn't yet been performed on the cached calendar (which happens in onAddItem et al).</span>
<a href="#l2.276"></a><span id="l2.276">         // Result is that we currently stick to firing onOperationComplete if the cached calendar</span>
<a href="#l2.277"></a><span id="l2.277">         // has performed the modification, see below:</span>
<a href="#l2.278"></a><span id="l2.278" class="difflineminus">-        var this_ = this;</span>
<a href="#l2.279"></a><span id="l2.279" class="difflineminus">-        var opListener = {</span>
<a href="#l2.280"></a><span id="l2.280" class="difflineplus">+        let self = this;</span>
<a href="#l2.281"></a><span id="l2.281" class="difflineplus">+        let cacheListener = {</span>
<a href="#l2.282"></a><span id="l2.282">             onGetResult: function(calendar, status, itemType, detail, count, items) {</span>
<a href="#l2.283"></a><span id="l2.283">                 cal.ASSERT(false, &quot;unexpected!&quot;);</span>
<a href="#l2.284"></a><span id="l2.284">             },</span>
<a href="#l2.285"></a><span id="l2.285">             onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l2.286"></a><span id="l2.286" class="difflineminus">-                if (Components.isSuccessCode(status) &amp;&amp; !this_.supportsChangeLog) {</span>
<a href="#l2.287"></a><span id="l2.287" class="difflineminus">-                    this_.mCachedCalendar.addItem(detail, listener);</span>
<a href="#l2.288"></a><span id="l2.288" class="difflineplus">+                if (isUnavailableCode(status)) {</span>
<a href="#l2.289"></a><span id="l2.289" class="difflineplus">+                    // The item couldn't be added to the (remote) location,</span>
<a href="#l2.290"></a><span id="l2.290" class="difflineplus">+                    // this is like being offline. Add the item to the cached</span>
<a href="#l2.291"></a><span id="l2.291" class="difflineplus">+                    // calendar instead.</span>
<a href="#l2.292"></a><span id="l2.292" class="difflineplus">+                    self.adoptOfflineItem(item, listener);</span>
<a href="#l2.293"></a><span id="l2.293" class="difflineplus">+                } else if (Components.isSuccessCode(status)) {</span>
<a href="#l2.294"></a><span id="l2.294" class="difflineplus">+                    // On success, add the item to the cache.</span>
<a href="#l2.295"></a><span id="l2.295" class="difflineplus">+                    self.mCachedCalendar.addItem(detail, listener);</span>
<a href="#l2.296"></a><span id="l2.296">                 } else if (listener) {</span>
<a href="#l2.297"></a><span id="l2.297" class="difflineminus">-                    listener.onOperationComplete(this_, status, opType, id, detail);</span>
<a href="#l2.298"></a><span id="l2.298" class="difflineplus">+                    // Either an error occurred or this is a successful add</span>
<a href="#l2.299"></a><span id="l2.299" class="difflineplus">+                    // to a cached calendar. Forward the call to the listener</span>
<a href="#l2.300"></a><span id="l2.300" class="difflineplus">+                    listener.onOperationComplete(self, status, opType, id, detail);</span>
<a href="#l2.301"></a><span id="l2.301">                 }</span>
<a href="#l2.302"></a><span id="l2.302">             }</span>
<a href="#l2.303"></a><span id="l2.303">         }</span>
<a href="#l2.304"></a><span id="l2.304" class="difflineminus">-        if (this.supportsChangeLog) {</span>
<a href="#l2.305"></a><span id="l2.305" class="difflineminus">-            return this.mUncachedCalendar.addItemOrUseCache(item, true, opListener);</span>
<a href="#l2.306"></a><span id="l2.306" class="difflineplus">+</span>
<a href="#l2.307"></a><span id="l2.307" class="difflineplus">+        if (this.offline) {</span>
<a href="#l2.308"></a><span id="l2.308" class="difflineplus">+            // If we are offline, don't even try to add the item</span>
<a href="#l2.309"></a><span id="l2.309" class="difflineplus">+            this.adoptOfflineItem(item, listener);</span>
<a href="#l2.310"></a><span id="l2.310" class="difflineplus">+        } else {</span>
<a href="#l2.311"></a><span id="l2.311" class="difflineplus">+            // Otherwise ask the provider to add the item now.</span>
<a href="#l2.312"></a><span id="l2.312" class="difflineplus">+            this.mUncachedCalendar.adoptItem(item, cacheListener);</span>
<a href="#l2.313"></a><span id="l2.313">         }</span>
<a href="#l2.314"></a><span id="l2.314" class="difflineminus">-        return this.mUncachedCalendar.adoptItem(item, opListener);</span>
<a href="#l2.315"></a><span id="l2.315">     },</span>
<a href="#l2.316"></a><span id="l2.316">     adoptOfflineItem: function(item, listener) {</span>
<a href="#l2.317"></a><span id="l2.317">         var this_ = this;</span>
<a href="#l2.318"></a><span id="l2.318">         var opListener = {</span>
<a href="#l2.319"></a><span id="l2.319">             onGetResult: function(calendar, status, itemType, detail, count, items) {</span>
<a href="#l2.320"></a><span id="l2.320">                 cal.ASSERT(false, &quot;unexpected!&quot;);</span>
<a href="#l2.321"></a><span id="l2.321">             },</span>
<a href="#l2.322"></a><span id="l2.322">             onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l2.323"></a><span id="l2.323" class="difflineat">@@ -731,101 +764,158 @@ calCachedCalendar.prototype = {</span>
<a href="#l2.324"></a><span id="l2.324">                     listener.onOperationComplete(this_, status, opType, id, detail);</span>
<a href="#l2.325"></a><span id="l2.325">                 }</span>
<a href="#l2.326"></a><span id="l2.326">             }</span>
<a href="#l2.327"></a><span id="l2.327">         };</span>
<a href="#l2.328"></a><span id="l2.328">         this.mCachedCalendar.adoptItem(item, opListener);</span>
<a href="#l2.329"></a><span id="l2.329">     },</span>
<a href="#l2.330"></a><span id="l2.330"> </span>
<a href="#l2.331"></a><span id="l2.331">     modifyItem: function(newItem, oldItem, listener) {</span>
<a href="#l2.332"></a><span id="l2.332" class="difflineplus">+        let self = this;</span>
<a href="#l2.333"></a><span id="l2.333" class="difflineplus">+</span>
<a href="#l2.334"></a><span id="l2.334" class="difflineplus">+        // First of all, we should find out if the item to modify is</span>
<a href="#l2.335"></a><span id="l2.335" class="difflineplus">+        // already an offline item or not.</span>
<a href="#l2.336"></a><span id="l2.336" class="difflineplus">+        let flagListener = {</span>
<a href="#l2.337"></a><span id="l2.337" class="difflineplus">+            onGetResult: function() {},</span>
<a href="#l2.338"></a><span id="l2.338" class="difflineplus">+            onOperationComplete: function(c, s, o, i, offline_flag) {</span>
<a href="#l2.339"></a><span id="l2.339" class="difflineplus">+                if (offline_flag == cICL.OFFLINE_FLAG_CREATED_RECORD ||</span>
<a href="#l2.340"></a><span id="l2.340" class="difflineplus">+                    offline_flag == cICL.OFFLINE_FLAG_MODIFIED_RECORD) {</span>
<a href="#l2.341"></a><span id="l2.341" class="difflineplus">+                    // The item is already offline, just modify it in the cache</span>
<a href="#l2.342"></a><span id="l2.342" class="difflineplus">+                    self.modifyOfflineItem(newItem, oldItem, listener);</span>
<a href="#l2.343"></a><span id="l2.343" class="difflineplus">+                } else {</span>
<a href="#l2.344"></a><span id="l2.344" class="difflineplus">+                    // Not an offline item, attempt to modify using provider</span>
<a href="#l2.345"></a><span id="l2.345" class="difflineplus">+                    self.mUncachedCalendar.modifyItem(newItem, oldItem, cacheListener);</span>
<a href="#l2.346"></a><span id="l2.346" class="difflineplus">+                }</span>
<a href="#l2.347"></a><span id="l2.347" class="difflineplus">+            }</span>
<a href="#l2.348"></a><span id="l2.348" class="difflineplus">+        };</span>
<a href="#l2.349"></a><span id="l2.349" class="difflineplus">+</span>
<a href="#l2.350"></a><span id="l2.350" class="difflineplus">+        /* Forwarding add/modify/delete to the cached calendar using the calIObserver</span>
<a href="#l2.351"></a><span id="l2.351" class="difflineplus">+         * callbacks would be advantageous, because the uncached provider could implement</span>
<a href="#l2.352"></a><span id="l2.352" class="difflineplus">+         * a true push mechanism firing without being triggered from within the program.</span>
<a href="#l2.353"></a><span id="l2.353" class="difflineplus">+         * But this would mean the uncached provider fires on the passed</span>
<a href="#l2.354"></a><span id="l2.354" class="difflineplus">+         * calIOperationListener, e.g. *before* it fires on calIObservers</span>
<a href="#l2.355"></a><span id="l2.355" class="difflineplus">+         * (because that order is undefined). Firing onOperationComplete before onAddItem et al</span>
<a href="#l2.356"></a><span id="l2.356" class="difflineplus">+         * would result in this facade firing onOperationComplete even though the modification</span>
<a href="#l2.357"></a><span id="l2.357" class="difflineplus">+         * hasn't yet been performed on the cached calendar (which happens in onAddItem et al).</span>
<a href="#l2.358"></a><span id="l2.358" class="difflineplus">+         * Result is that we currently stick to firing onOperationComplete if the cached calendar</span>
<a href="#l2.359"></a><span id="l2.359" class="difflineplus">+         * has performed the modification, see below: */</span>
<a href="#l2.360"></a><span id="l2.360" class="difflineplus">+        let cacheListener = {</span>
<a href="#l2.361"></a><span id="l2.361" class="difflineplus">+            onGetResult: function() {},</span>
<a href="#l2.362"></a><span id="l2.362" class="difflineplus">+            onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l2.363"></a><span id="l2.363" class="difflineplus">+                if (isUnavailableCode(status)) {</span>
<a href="#l2.364"></a><span id="l2.364" class="difflineplus">+                    // The item couldn't be modified at the (remote) location,</span>
<a href="#l2.365"></a><span id="l2.365" class="difflineplus">+                    // this is like being offline. Add the item to the cache</span>
<a href="#l2.366"></a><span id="l2.366" class="difflineplus">+                    // instead.</span>
<a href="#l2.367"></a><span id="l2.367" class="difflineplus">+                    self.modifyOfflineItem(newItem, oldItem, listener);</span>
<a href="#l2.368"></a><span id="l2.368" class="difflineplus">+                } else if (Components.isSuccessCode(status)) {</span>
<a href="#l2.369"></a><span id="l2.369" class="difflineplus">+                    // On success, modify the item in the cache</span>
<a href="#l2.370"></a><span id="l2.370" class="difflineplus">+                    self.mCachedCalendar.modifyItem(detail, oldItem, listener);</span>
<a href="#l2.371"></a><span id="l2.371" class="difflineplus">+                } else if (listener) {</span>
<a href="#l2.372"></a><span id="l2.372" class="difflineplus">+                    // This happens on error, forward the error through the listener</span>
<a href="#l2.373"></a><span id="l2.373" class="difflineplus">+                    listener.onOperationComplete(self, status, opType, id, detail);</span>
<a href="#l2.374"></a><span id="l2.374" class="difflineplus">+                }</span>
<a href="#l2.375"></a><span id="l2.375" class="difflineplus">+            }</span>
<a href="#l2.376"></a><span id="l2.376" class="difflineplus">+        };</span>
<a href="#l2.377"></a><span id="l2.377" class="difflineplus">+</span>
<a href="#l2.378"></a><span id="l2.378">         if (this.offline) {</span>
<a href="#l2.379"></a><span id="l2.379" class="difflineplus">+            // If we are offline, don't even try to modify the item</span>
<a href="#l2.380"></a><span id="l2.380">             this.modifyOfflineItem(newItem, oldItem, listener);</span>
<a href="#l2.381"></a><span id="l2.381" class="difflineminus">-            return;</span>
<a href="#l2.382"></a><span id="l2.382" class="difflineplus">+        } else {</span>
<a href="#l2.383"></a><span id="l2.383" class="difflineplus">+            // Otherwise, get the item flags, the listener will further</span>
<a href="#l2.384"></a><span id="l2.384" class="difflineplus">+            // process the item.</span>
<a href="#l2.385"></a><span id="l2.385" class="difflineplus">+            this.mCachedCalendar.getItemOfflineFlag(oldItem, flagListener);</span>
<a href="#l2.386"></a><span id="l2.386">         }</span>
<a href="#l2.387"></a><span id="l2.387" class="difflineplus">+    },</span>
<a href="#l2.388"></a><span id="l2.388"> </span>
<a href="#l2.389"></a><span id="l2.389" class="difflineplus">+    modifyOfflineItem: function(newItem, oldItem, listener) {</span>
<a href="#l2.390"></a><span id="l2.390" class="difflineplus">+        var this_ = this;</span>
<a href="#l2.391"></a><span id="l2.391" class="difflineplus">+        var opListener = {</span>
<a href="#l2.392"></a><span id="l2.392" class="difflineplus">+            onGetResult: function(calendar, status, itemType, detail, count, items) {</span>
<a href="#l2.393"></a><span id="l2.393" class="difflineplus">+                cal.ASSERT(false, &quot;unexpected!&quot;);</span>
<a href="#l2.394"></a><span id="l2.394" class="difflineplus">+            },</span>
<a href="#l2.395"></a><span id="l2.395" class="difflineplus">+            onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l2.396"></a><span id="l2.396" class="difflineplus">+                if (Components.isSuccessCode(status)) {</span>
<a href="#l2.397"></a><span id="l2.397" class="difflineplus">+                    // Modify the offline item in the storage, passing the</span>
<a href="#l2.398"></a><span id="l2.398" class="difflineplus">+                    // listener will make sure its notified</span>
<a href="#l2.399"></a><span id="l2.399" class="difflineplus">+                    var storage = this_.mCachedCalendar.QueryInterface(Components.interfaces.calIOfflineStorage);</span>
<a href="#l2.400"></a><span id="l2.400" class="difflineplus">+                    storage.modifyOfflineItem(detail, listener);</span>
<a href="#l2.401"></a><span id="l2.401" class="difflineplus">+                } else if (listener) {</span>
<a href="#l2.402"></a><span id="l2.402" class="difflineplus">+                    // If there was not a success, then we need to notify the</span>
<a href="#l2.403"></a><span id="l2.403" class="difflineplus">+                    // listener ourselves</span>
<a href="#l2.404"></a><span id="l2.404" class="difflineplus">+                    listener.onOperationComplete(this_, status, opType, id, detail);</span>
<a href="#l2.405"></a><span id="l2.405" class="difflineplus">+                }</span>
<a href="#l2.406"></a><span id="l2.406" class="difflineplus">+            }</span>
<a href="#l2.407"></a><span id="l2.407" class="difflineplus">+        };</span>
<a href="#l2.408"></a><span id="l2.408" class="difflineplus">+</span>
<a href="#l2.409"></a><span id="l2.409" class="difflineplus">+        this.mCachedCalendar.modifyItem(newItem, oldItem, opListener);</span>
<a href="#l2.410"></a><span id="l2.410" class="difflineplus">+    },</span>
<a href="#l2.411"></a><span id="l2.411" class="difflineplus">+</span>
<a href="#l2.412"></a><span id="l2.412" class="difflineplus">+    deleteItem: function(item, listener) {</span>
<a href="#l2.413"></a><span id="l2.413" class="difflineplus">+        let self = this;</span>
<a href="#l2.414"></a><span id="l2.414" class="difflineplus">+</span>
<a href="#l2.415"></a><span id="l2.415" class="difflineplus">+        // First of all, we should find out if the item to delete is</span>
<a href="#l2.416"></a><span id="l2.416" class="difflineplus">+        // already an offline item or not.</span>
<a href="#l2.417"></a><span id="l2.417" class="difflineplus">+        let flagListener = {</span>
<a href="#l2.418"></a><span id="l2.418" class="difflineplus">+            onGetResult: function() {},</span>
<a href="#l2.419"></a><span id="l2.419" class="difflineplus">+            onOperationComplete: function(c, s, o, i, offline_flag) {</span>
<a href="#l2.420"></a><span id="l2.420" class="difflineplus">+                if (offline_flag == cICL.OFFLINE_FLAG_CREATED_RECORD ||</span>
<a href="#l2.421"></a><span id="l2.421" class="difflineplus">+                    offline_flag == cICL.OFFLINE_FLAG_MODIFIED_RECORD) {</span>
<a href="#l2.422"></a><span id="l2.422" class="difflineplus">+                    // The item is already offline, just mark it deleted it in</span>
<a href="#l2.423"></a><span id="l2.423" class="difflineplus">+                    // the cache</span>
<a href="#l2.424"></a><span id="l2.424" class="difflineplus">+                    self.deleteOfflineItem(item, listener);</span>
<a href="#l2.425"></a><span id="l2.425" class="difflineplus">+                } else {</span>
<a href="#l2.426"></a><span id="l2.426" class="difflineplus">+                    // Not an offline item, attempt to delete using provider</span>
<a href="#l2.427"></a><span id="l2.427" class="difflineplus">+                    self.mUncachedCalendar.deleteItem(item, cacheListener);</span>
<a href="#l2.428"></a><span id="l2.428" class="difflineplus">+                }</span>
<a href="#l2.429"></a><span id="l2.429" class="difflineplus">+            }</span>
<a href="#l2.430"></a><span id="l2.430" class="difflineplus">+        };</span>
<a href="#l2.431"></a><span id="l2.431">         // Forwarding add/modify/delete to the cached calendar using the calIObserver</span>
<a href="#l2.432"></a><span id="l2.432">         // callbacks would be advantageous, because the uncached provider could implement</span>
<a href="#l2.433"></a><span id="l2.433">         // a true push mechanism firing without being triggered from within the program.</span>
<a href="#l2.434"></a><span id="l2.434">         // But this would mean the uncached provider fires on the passed</span>
<a href="#l2.435"></a><span id="l2.435">         // calIOperationListener, e.g. *before* it fires on calIObservers</span>
<a href="#l2.436"></a><span id="l2.436">         // (because that order is undefined). Firing onOperationComplete before onAddItem et al</span>
<a href="#l2.437"></a><span id="l2.437">         // would result in this facade firing onOperationComplete even though the modification</span>
<a href="#l2.438"></a><span id="l2.438">         // hasn't yet been performed on the cached calendar (which happens in onAddItem et al).</span>
<a href="#l2.439"></a><span id="l2.439">         // Result is that we currently stick to firing onOperationComplete if the cached calendar</span>
<a href="#l2.440"></a><span id="l2.440">         // has performed the modification, see below:</span>
<a href="#l2.441"></a><span id="l2.441" class="difflineminus">-        var this_ = this;</span>
<a href="#l2.442"></a><span id="l2.442" class="difflineminus">-        var opListener = {</span>
<a href="#l2.443"></a><span id="l2.443" class="difflineminus">-            onGetResult: function(calendar, status, itemType, detail, count, items) {</span>
<a href="#l2.444"></a><span id="l2.444" class="difflineminus">-                cal.ASSERT(false, &quot;unexpected!&quot;);</span>
<a href="#l2.445"></a><span id="l2.445" class="difflineminus">-            },</span>
<a href="#l2.446"></a><span id="l2.446" class="difflineplus">+        var cacheListener = {</span>
<a href="#l2.447"></a><span id="l2.447" class="difflineplus">+            onGetResult: function() {},</span>
<a href="#l2.448"></a><span id="l2.448">             onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l2.449"></a><span id="l2.449" class="difflineminus">-                if (Components.isSuccessCode(status)) {</span>
<a href="#l2.450"></a><span id="l2.450" class="difflineminus">-                    this_.mCachedCalendar.modifyItem(detail, oldItem, listener);</span>
<a href="#l2.451"></a><span id="l2.451" class="difflineplus">+                if (isUnavailableCode(status)) {</span>
<a href="#l2.452"></a><span id="l2.452" class="difflineplus">+                    // The item couldn't be deleted at the (remote) location,</span>
<a href="#l2.453"></a><span id="l2.453" class="difflineplus">+                    // this is like being offline. Mark the item deleted in the</span>
<a href="#l2.454"></a><span id="l2.454" class="difflineplus">+                    // cache instead.</span>
<a href="#l2.455"></a><span id="l2.455" class="difflineplus">+                    self.deleteOfflineItem(item, listener);</span>
<a href="#l2.456"></a><span id="l2.456" class="difflineplus">+                } else if (Components.isSuccessCode(status)) {</span>
<a href="#l2.457"></a><span id="l2.457" class="difflineplus">+                    // On success, delete the item from the cache</span>
<a href="#l2.458"></a><span id="l2.458" class="difflineplus">+                    self.mCachedCalendar.deleteItem(item, listener);</span>
<a href="#l2.459"></a><span id="l2.459" class="difflineplus">+</span>
<a href="#l2.460"></a><span id="l2.460" class="difflineplus">+                    // Also, remove any meta data associated with the item</span>
<a href="#l2.461"></a><span id="l2.461" class="difflineplus">+                    try {</span>
<a href="#l2.462"></a><span id="l2.462" class="difflineplus">+                        let storage = self.mCachedCalendar.QueryInterface(Components.interfaces.calISyncWriteCalendar);</span>
<a href="#l2.463"></a><span id="l2.463" class="difflineplus">+                        storage.deleteMetaData(item.id);</span>
<a href="#l2.464"></a><span id="l2.464" class="difflineplus">+                    } catch (e) {</span>
<a href="#l2.465"></a><span id="l2.465" class="difflineplus">+                        cal.LOG(&quot;[calCachedCalendar] Offline storage doesn't support metadata&quot;);</span>
<a href="#l2.466"></a><span id="l2.466" class="difflineplus">+                    }</span>
<a href="#l2.467"></a><span id="l2.467">                 } else if (listener) {</span>
<a href="#l2.468"></a><span id="l2.468" class="difflineminus">-                    listener.onOperationComplete(this_, status, opType, id, detail);</span>
<a href="#l2.469"></a><span id="l2.469" class="difflineminus">-                }</span>
<a href="#l2.470"></a><span id="l2.470" class="difflineminus">-            }</span>
<a href="#l2.471"></a><span id="l2.471" class="difflineminus">-        }</span>
<a href="#l2.472"></a><span id="l2.472" class="difflineminus">-        if (this.supportsChangeLog) {</span>
<a href="#l2.473"></a><span id="l2.473" class="difflineminus">-            return this.mUncachedCalendar.modifyItemOrUseCache(newItem, oldItem, true, opListener);</span>
<a href="#l2.474"></a><span id="l2.474" class="difflineminus">-        } else {</span>
<a href="#l2.475"></a><span id="l2.475" class="difflineminus">-            return this.mUncachedCalendar.modifyItem(newItem, oldItem, opListener);</span>
<a href="#l2.476"></a><span id="l2.476" class="difflineminus">-        }</span>
<a href="#l2.477"></a><span id="l2.477" class="difflineminus">-    },</span>
<a href="#l2.478"></a><span id="l2.478" class="difflineminus">-    modifyOfflineItem: function(newItem, oldItem, listener) {</span>
<a href="#l2.479"></a><span id="l2.479" class="difflineminus">-        var this_ = this;</span>
<a href="#l2.480"></a><span id="l2.480" class="difflineminus">-        var opListener = {</span>
<a href="#l2.481"></a><span id="l2.481" class="difflineminus">-            onGetResult: function(calendar, status, itemType, detail, count, items) {</span>
<a href="#l2.482"></a><span id="l2.482" class="difflineminus">-                cal.ASSERT(false, &quot;unexpected!&quot;);</span>
<a href="#l2.483"></a><span id="l2.483" class="difflineminus">-            },</span>
<a href="#l2.484"></a><span id="l2.484" class="difflineminus">-            onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l2.485"></a><span id="l2.485" class="difflineminus">-                if (Components.isSuccessCode(status)) {</span>
<a href="#l2.486"></a><span id="l2.486" class="difflineminus">-                    var storage = this_.mCachedCalendar.QueryInterface(Components.interfaces.calIOfflineStorage);</span>
<a href="#l2.487"></a><span id="l2.487" class="difflineminus">-                    storage.modifyOfflineItem(detail, listener);</span>
<a href="#l2.488"></a><span id="l2.488" class="difflineminus">-                } else if (listener) {</span>
<a href="#l2.489"></a><span id="l2.489" class="difflineminus">-                    listener.onOperationComplete(this_, status, opType, id, detail);</span>
<a href="#l2.490"></a><span id="l2.490" class="difflineplus">+                    // This happens on error, forward the error through the listener</span>
<a href="#l2.491"></a><span id="l2.491" class="difflineplus">+                    listener.onOperationComplete(self, status, opType, id, detail);</span>
<a href="#l2.492"></a><span id="l2.492">                 }</span>
<a href="#l2.493"></a><span id="l2.493">             }</span>
<a href="#l2.494"></a><span id="l2.494">         };</span>
<a href="#l2.495"></a><span id="l2.495"> </span>
<a href="#l2.496"></a><span id="l2.496" class="difflineminus">-        this.mCachedCalendar.modifyItem(newItem, oldItem, opListener);</span>
<a href="#l2.497"></a><span id="l2.497" class="difflineminus">-    },</span>
<a href="#l2.498"></a><span id="l2.498" class="difflineminus">-</span>
<a href="#l2.499"></a><span id="l2.499" class="difflineminus">-    deleteItem: function(item, listener) {</span>
<a href="#l2.500"></a><span id="l2.500">         if (this.offline) {</span>
<a href="#l2.501"></a><span id="l2.501" class="difflineplus">+            // If we are offline, don't even try to delete the item</span>
<a href="#l2.502"></a><span id="l2.502">             this.deleteOfflineItem(item, listener);</span>
<a href="#l2.503"></a><span id="l2.503" class="difflineminus">-            return;</span>
<a href="#l2.504"></a><span id="l2.504" class="difflineplus">+        } else {</span>
<a href="#l2.505"></a><span id="l2.505" class="difflineplus">+            // Otherwise, get the item flags, the listener will further</span>
<a href="#l2.506"></a><span id="l2.506" class="difflineplus">+            // process the item.</span>
<a href="#l2.507"></a><span id="l2.507" class="difflineplus">+            this.mCachedCalendar.getItemOfflineFlag(item, flagListener);</span>
<a href="#l2.508"></a><span id="l2.508">         }</span>
<a href="#l2.509"></a><span id="l2.509" class="difflineminus">-        // Forwarding add/modify/delete to the cached calendar using the calIObserver</span>
<a href="#l2.510"></a><span id="l2.510" class="difflineminus">-        // callbacks would be advantageous, because the uncached provider could implement</span>
<a href="#l2.511"></a><span id="l2.511" class="difflineminus">-        // a true push mechanism firing without being triggered from within the program.</span>
<a href="#l2.512"></a><span id="l2.512" class="difflineminus">-        // But this would mean the uncached provider fires on the passed</span>
<a href="#l2.513"></a><span id="l2.513" class="difflineminus">-        // calIOperationListener, e.g. *before* it fires on calIObservers</span>
<a href="#l2.514"></a><span id="l2.514" class="difflineminus">-        // (because that order is undefined). Firing onOperationComplete before onAddItem et al</span>
<a href="#l2.515"></a><span id="l2.515" class="difflineminus">-        // would result in this facade firing onOperationComplete even though the modification</span>
<a href="#l2.516"></a><span id="l2.516" class="difflineminus">-        // hasn't yet been performed on the cached calendar (which happens in onAddItem et al).</span>
<a href="#l2.517"></a><span id="l2.517" class="difflineminus">-        // Result is that we currently stick to firing onOperationComplete if the cached calendar</span>
<a href="#l2.518"></a><span id="l2.518" class="difflineminus">-        // has performed the modification, see below:</span>
<a href="#l2.519"></a><span id="l2.519" class="difflineminus">-        var this_ = this;</span>
<a href="#l2.520"></a><span id="l2.520" class="difflineminus">-        var opListener = {</span>
<a href="#l2.521"></a><span id="l2.521" class="difflineminus">-            onGetResult: function(calendar, status, itemType, detail, count, items) {</span>
<a href="#l2.522"></a><span id="l2.522" class="difflineminus">-                cal.ASSERT(false, &quot;unexpected!&quot;);</span>
<a href="#l2.523"></a><span id="l2.523" class="difflineminus">-            },</span>
<a href="#l2.524"></a><span id="l2.524" class="difflineminus">-            onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l2.525"></a><span id="l2.525" class="difflineminus">-                if (Components.isSuccessCode(status)) {</span>
<a href="#l2.526"></a><span id="l2.526" class="difflineminus">-                    this_.mCachedCalendar.deleteItem(item, listener);</span>
<a href="#l2.527"></a><span id="l2.527" class="difflineminus">-                } else if (listener) {</span>
<a href="#l2.528"></a><span id="l2.528" class="difflineminus">-                    listener.onOperationComplete(this_, status, opType, id, detail);</span>
<a href="#l2.529"></a><span id="l2.529" class="difflineminus">-                }</span>
<a href="#l2.530"></a><span id="l2.530" class="difflineminus">-            }</span>
<a href="#l2.531"></a><span id="l2.531" class="difflineminus">-        }</span>
<a href="#l2.532"></a><span id="l2.532" class="difflineminus">-        if (this.supportsChangeLog) {</span>
<a href="#l2.533"></a><span id="l2.533" class="difflineminus">-            return this.mUncachedCalendar.deleteItemOrUseCache(item, true, opListener);</span>
<a href="#l2.534"></a><span id="l2.534" class="difflineminus">-        }</span>
<a href="#l2.535"></a><span id="l2.535" class="difflineminus">-        return this.mUncachedCalendar.deleteItem(item, opListener);</span>
<a href="#l2.536"></a><span id="l2.536">     },</span>
<a href="#l2.537"></a><span id="l2.537">     deleteOfflineItem: function(item, listener) {</span>
<a href="#l2.538"></a><span id="l2.538">         /* We do not delete the item from the cache, as we will need it when reconciling the cache content and the server content. */</span>
<a href="#l2.539"></a><span id="l2.539">         var storage = this.mCachedCalendar.QueryInterface(Components.interfaces.calIOfflineStorage);</span>
<a href="#l2.540"></a><span id="l2.540">         storage.deleteOfflineItem(item, listener);</span>
<a href="#l2.541"></a><span id="l2.541">     }</span>
<a href="#l2.542"></a><span id="l2.542"> };</span>
<a href="#l2.543"></a><span id="l2.543"> (function() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/calendar/providers/caldav/calDavCalendar.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/calendar/providers/caldav/calDavCalendar.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -461,68 +461,59 @@ calDavCalendar.prototype = {</span>
<a href="#l3.4"></a><span id="l3.4">         }</span>
<a href="#l3.5"></a><span id="l3.5">         return this.__proto__.__proto__.getProperty.apply(this, arguments);</span>
<a href="#l3.6"></a><span id="l3.6">     },</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8">     promptOverwrite: function caldav_promptOverwrite(aMethod, aItem, aListener, aOldItem) {</span>
<a href="#l3.9"></a><span id="l3.9">         let overwrite = cal.promptOverwrite(aMethod, aItem, aListener, aOldItem);</span>
<a href="#l3.10"></a><span id="l3.10">         if (overwrite) {</span>
<a href="#l3.11"></a><span id="l3.11">             if (aMethod == CALDAV_MODIFY_ITEM) {</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-                this.doModifyItemOrUseCache(aItem, aOldItem, true, aListener, true);</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+                this.doModifyItem(aItem, aOldItem, aListener, true);</span>
<a href="#l3.14"></a><span id="l3.14">             } else {</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">-                this.doDeleteItemOrUseCache(aItem, true, aListener, true, false, null);</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+                this.doDeleteItem(aItem, aListener, true, false, null);</span>
<a href="#l3.17"></a><span id="l3.17">             }</span>
<a href="#l3.18"></a><span id="l3.18">         } else {</span>
<a href="#l3.19"></a><span id="l3.19">             this.getUpdatedItem(aItem, aListener);</span>
<a href="#l3.20"></a><span id="l3.20">         }</span>
<a href="#l3.21"></a><span id="l3.21">     },</span>
<a href="#l3.22"></a><span id="l3.22"> </span>
<a href="#l3.23"></a><span id="l3.23">     mItemInfoCache: null,</span>
<a href="#l3.24"></a><span id="l3.24"> </span>
<a href="#l3.25"></a><span id="l3.25">     mHrefIndex: null,</span>
<a href="#l3.26"></a><span id="l3.26"> </span>
<a href="#l3.27"></a><span id="l3.27">     /**</span>
<a href="#l3.28"></a><span id="l3.28">      * addItem()</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineminus">-     * we actually use doAdoptItemOrUseCache()</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineplus">+     * we actually use doAdoptItem()</span>
<a href="#l3.31"></a><span id="l3.31">      *</span>
<a href="#l3.32"></a><span id="l3.32">      * @param aItem       item to add</span>
<a href="#l3.33"></a><span id="l3.33">      * @param aListener   listener for method completion</span>
<a href="#l3.34"></a><span id="l3.34">      */</span>
<a href="#l3.35"></a><span id="l3.35">     addItem: function caldav_addItem(aItem, aListener) {</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineminus">-        return this.addItemOrUseCache(aItem, true, aListener);</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+        return this.doAdoptItem(aItem.clone(), aListener);</span>
<a href="#l3.38"></a><span id="l3.38">     },</span>
<a href="#l3.39"></a><span id="l3.39"> </span>
<a href="#l3.40"></a><span id="l3.40" class="difflineminus">-    addItemOrUseCache: function caldav_addItemOrUseCache(aItem, useCache, aListener){</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineminus">-        let newItem = aItem.clone();</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineminus">-        this.adoptItemOrUseCache(newItem, useCache, aListener);</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineminus">-    },</span>
<a href="#l3.44"></a><span id="l3.44">     /**</span>
<a href="#l3.45"></a><span id="l3.45">      * adoptItem()</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineminus">-     * we actually use doAdoptItemOrUseCache()</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineplus">+     * we actually use doAdoptItem()</span>
<a href="#l3.48"></a><span id="l3.48">      *</span>
<a href="#l3.49"></a><span id="l3.49">      * @param aItem       item to check</span>
<a href="#l3.50"></a><span id="l3.50">      * @param aListener   listener for method completion</span>
<a href="#l3.51"></a><span id="l3.51">      */</span>
<a href="#l3.52"></a><span id="l3.52">     adoptItem: function caldav_adoptItem(aItem, aListener) {</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineminus">-        return this.adoptItemOrUseCache(aItem, true, aListener);</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineminus">-    },</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineminus">-</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineminus">-    adoptItemOrUseCache: function caldav_adoptItemOrUseCache(aItem, useCache, aListener){</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineminus">-        return this.doAdoptItemOrUseCache(aItem, useCache, aListener, false);</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineplus">+        return this.doAdoptItem(aItem, aListener);</span>
<a href="#l3.59"></a><span id="l3.59">     },</span>
<a href="#l3.60"></a><span id="l3.60"> </span>
<a href="#l3.61"></a><span id="l3.61">     /**</span>
<a href="#l3.62"></a><span id="l3.62">      * Performs the actual addition of the item to CalDAV store</span>
<a href="#l3.63"></a><span id="l3.63">      *</span>
<a href="#l3.64"></a><span id="l3.64">      * @param aItem       item to add</span>
<a href="#l3.65"></a><span id="l3.65">      * @param aListener   listener for method completion</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineminus">-     * @param useCache    flag to use the cache when a server failure occurs</span>
<a href="#l3.67"></a><span id="l3.67">      * @param aIgnoreEtag flag to indicate ignoring of Etag</span>
<a href="#l3.68"></a><span id="l3.68">      */</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineminus">-    doAdoptItemOrUseCache: function caldav_doAdoptItemOrUseCache(aItem, useCache, aListener, aIgnoreEtag){</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineplus">+    doAdoptItem: function caldav_doAdoptItem(aItem, aListener, aIgnoreEtag) {</span>
<a href="#l3.71"></a><span id="l3.71">         if (aItem.id == null &amp;&amp; aItem.isMutable) {</span>
<a href="#l3.72"></a><span id="l3.72">             aItem.id = cal.getUUID();</span>
<a href="#l3.73"></a><span id="l3.73">         }</span>
<a href="#l3.74"></a><span id="l3.74"> </span>
<a href="#l3.75"></a><span id="l3.75">         if (aItem.id == null) {</span>
<a href="#l3.76"></a><span id="l3.76">             this.notifyOperationComplete(aListener,</span>
<a href="#l3.77"></a><span id="l3.77">                                          Components.results.NS_ERROR_FAILURE,</span>
<a href="#l3.78"></a><span id="l3.78">                                          Components.interfaces.calIOperationListener.ADD,</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineat">@@ -559,43 +550,46 @@ calDavCalendar.prototype = {</span>
<a href="#l3.80"></a><span id="l3.80">                 status = Components.interfaces.calIErrors.DAV_PUT_ERROR;</span>
<a href="#l3.81"></a><span id="l3.81">             }</span>
<a href="#l3.82"></a><span id="l3.82">             if (thisCalendar.verboseLogging()) {</span>
<a href="#l3.83"></a><span id="l3.83">                 let str = cal.convertByteArray(aResult, aResultLength);</span>
<a href="#l3.84"></a><span id="l3.84">                 cal.LOG(&quot;CalDAV: recv: &quot; + (str || &quot;&quot;));</span>
<a href="#l3.85"></a><span id="l3.85">             }</span>
<a href="#l3.86"></a><span id="l3.86">             // 201 = HTTP &quot;Created&quot;</span>
<a href="#l3.87"></a><span id="l3.87">             // 204 = HTTP &quot;No Content&quot;</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineminus">-            //</span>
<a href="#l3.89"></a><span id="l3.89">             if (status == 201 || status == 204) {</span>
<a href="#l3.90"></a><span id="l3.90">                 cal.LOG(&quot;CalDAV: Item added to &quot; + thisCalendar.name + &quot; successfully&quot;);</span>
<a href="#l3.91"></a><span id="l3.91"> </span>
<a href="#l3.92"></a><span id="l3.92">                 // Some CalDAV servers will modify items on PUT (add X-props,</span>
<a href="#l3.93"></a><span id="l3.93">                 // for instance) so we'd best re-fetch in order to know</span>
<a href="#l3.94"></a><span id="l3.94">                 // the current state of the item</span>
<a href="#l3.95"></a><span id="l3.95">                 // Observers will be notified in getUpdatedItem()</span>
<a href="#l3.96"></a><span id="l3.96">                 thisCalendar.getUpdatedItem(parentItem, aListener);</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineminus">-            } else if (status &gt;= 500 &amp;&amp; status &lt;= 510 &amp;&amp;</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineminus">-                       useCache &amp;&amp; thisCalendar.mOfflineStorage) {</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineplus">+            } else if (status &gt;= 500 &amp;&amp; status &lt;= 510) {</span>
<a href="#l3.100"></a><span id="l3.100">                 cal.LOG(&quot;[calDavCalendar] Server unavailability code received. Items are being put into cache for a later try&quot;);</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineminus">-                thisCalendar.adoptOfflineItem(aItem, aListener);</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineplus">+                aListener.onOperationComplete(thisCalendar.superCalendar,</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineplus">+                                              Components.results.NS_ERROR_NOT_AVAILABLE,</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineplus">+                                              Components.interfaces.calIOperationListener.ADD,</span>
<a href="#l3.105"></a><span id="l3.105" class="difflineplus">+                                              parentItem.id,</span>
<a href="#l3.106"></a><span id="l3.106" class="difflineplus">+                                              parentItem);</span>
<a href="#l3.107"></a><span id="l3.107">             } else {</span>
<a href="#l3.108"></a><span id="l3.108">                 if (status &gt; 999) {</span>
<a href="#l3.109"></a><span id="l3.109">                     status = &quot;0x&quot; + status.toString(16);</span>
<a href="#l3.110"></a><span id="l3.110">                 }</span>
<a href="#l3.111"></a><span id="l3.111">                 let responseBody=&quot;&quot;;</span>
<a href="#l3.112"></a><span id="l3.112">                 try {</span>
<a href="#l3.113"></a><span id="l3.113">                     responseBody = cal.convertByteArray(aResult, aResultLength);</span>
<a href="#l3.114"></a><span id="l3.114">                 } catch (e) {}</span>
<a href="#l3.115"></a><span id="l3.115"> </span>
<a href="#l3.116"></a><span id="l3.116">                 cal.ERROR(&quot;CalDAV: Unexpected status adding item to &quot; +</span>
<a href="#l3.117"></a><span id="l3.117">                           thisCalendar.name + &quot;: &quot; + status + &quot;\n&quot; +</span>
<a href="#l3.118"></a><span id="l3.118">                           responseBody + &quot;\n&quot; +</span>
<a href="#l3.119"></a><span id="l3.119">                           serializedItem);</span>
<a href="#l3.120"></a><span id="l3.120"> </span>
<a href="#l3.121"></a><span id="l3.121" class="difflineplus">+                // TODO why is no listener called here?</span>
<a href="#l3.122"></a><span id="l3.122">                 thisCalendar.reportDavError(Components.interfaces.calIErrors.DAV_PUT_ERROR,</span>
<a href="#l3.123"></a><span id="l3.123">                                             status,</span>
<a href="#l3.124"></a><span id="l3.124">                                             responseBody);</span>
<a href="#l3.125"></a><span id="l3.125">             }</span>
<a href="#l3.126"></a><span id="l3.126">         };</span>
<a href="#l3.127"></a><span id="l3.127"> </span>
<a href="#l3.128"></a><span id="l3.128">         parentItem.calendar = this.superCalendar;</span>
<a href="#l3.129"></a><span id="l3.129"> </span>
<a href="#l3.130"></a><span id="l3.130" class="difflineat">@@ -606,74 +600,36 @@ calDavCalendar.prototype = {</span>
<a href="#l3.131"></a><span id="l3.131"> </span>
<a href="#l3.132"></a><span id="l3.132">         if (!aIgnoreEtag) {</span>
<a href="#l3.133"></a><span id="l3.133">             httpchannel.setRequestHeader(&quot;If-None-Match&quot;, &quot;*&quot;, false);</span>
<a href="#l3.134"></a><span id="l3.134">         }</span>
<a href="#l3.135"></a><span id="l3.135"> </span>
<a href="#l3.136"></a><span id="l3.136">         cal.sendHttpRequest(cal.createStreamLoader(), httpchannel, addListener);</span>
<a href="#l3.137"></a><span id="l3.137">     },</span>
<a href="#l3.138"></a><span id="l3.138"> </span>
<a href="#l3.139"></a><span id="l3.139" class="difflineminus">-    adoptOfflineItem: function(item, listener) {</span>
<a href="#l3.140"></a><span id="l3.140" class="difflineminus">-        let thisCalendar = this;</span>
<a href="#l3.141"></a><span id="l3.141" class="difflineminus">-        let opListener = {</span>
<a href="#l3.142"></a><span id="l3.142" class="difflineminus">-            onGetResult: function(calendar, status, itemType, detail, count, items) {</span>
<a href="#l3.143"></a><span id="l3.143" class="difflineminus">-                cal.ASSERT(false, &quot;unexpected!&quot;);</span>
<a href="#l3.144"></a><span id="l3.144" class="difflineminus">-            },</span>
<a href="#l3.145"></a><span id="l3.145" class="difflineminus">-            onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l3.146"></a><span id="l3.146" class="difflineminus">-                if (Components.isSuccessCode(status)) {</span>
<a href="#l3.147"></a><span id="l3.147" class="difflineminus">-                    let storage = thisCalendar.mOfflineStorage.QueryInterface(Components.interfaces.calIOfflineStorage);</span>
<a href="#l3.148"></a><span id="l3.148" class="difflineminus">-                    storage.addOfflineItem(detail, listener);</span>
<a href="#l3.149"></a><span id="l3.149" class="difflineminus">-                } else if (listener) {</span>
<a href="#l3.150"></a><span id="l3.150" class="difflineminus">-                    listener.onOperationComplete(thisCalendar, status, opType, id, detail);</span>
<a href="#l3.151"></a><span id="l3.151" class="difflineminus">-                }</span>
<a href="#l3.152"></a><span id="l3.152" class="difflineminus">-            }</span>
<a href="#l3.153"></a><span id="l3.153" class="difflineminus">-        };</span>
<a href="#l3.154"></a><span id="l3.154" class="difflineminus">-        thisCalendar.mOfflineStorage.adoptItem(item, opListener);</span>
<a href="#l3.155"></a><span id="l3.155" class="difflineminus">-    },</span>
<a href="#l3.156"></a><span id="l3.156" class="difflineminus">-</span>
<a href="#l3.157"></a><span id="l3.157">     /**</span>
<a href="#l3.158"></a><span id="l3.158">      * modifyItem(); required by calICalendar.idl</span>
<a href="#l3.159"></a><span id="l3.159" class="difflineminus">-     * we actually use modifyItemOrUseCache()</span>
<a href="#l3.160"></a><span id="l3.160" class="difflineplus">+     * we actually use doModifyItem()</span>
<a href="#l3.161"></a><span id="l3.161">      *</span>
<a href="#l3.162"></a><span id="l3.162">      * @param aItem       item to check</span>
<a href="#l3.163"></a><span id="l3.163">      * @param aListener   listener for method completion</span>
<a href="#l3.164"></a><span id="l3.164">     */</span>
<a href="#l3.165"></a><span id="l3.165">     modifyItem: function caldav_modifyItem(aNewItem, aOldItem, aListener) {</span>
<a href="#l3.166"></a><span id="l3.166" class="difflineminus">-        return this.modifyItemOrUseCache(aNewItem, aOldItem, true, aListener);</span>
<a href="#l3.167"></a><span id="l3.167" class="difflineminus">-    },</span>
<a href="#l3.168"></a><span id="l3.168" class="difflineminus">-</span>
<a href="#l3.169"></a><span id="l3.169" class="difflineminus">-    modifyItemOrUseCache: function caldav_modifyItemOrUseCache(aNewItem, aOldItem, useCache, aListener){</span>
<a href="#l3.170"></a><span id="l3.170" class="difflineminus">-        let thisCalendar = this;</span>
<a href="#l3.171"></a><span id="l3.171" class="difflineminus">-        let opListener = {</span>
<a href="#l3.172"></a><span id="l3.172" class="difflineminus">-            onGetResult: function(calendar, status, itemType, detail, count, items) {</span>
<a href="#l3.173"></a><span id="l3.173" class="difflineminus">-            },</span>
<a href="#l3.174"></a><span id="l3.174" class="difflineminus">-            onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l3.175"></a><span id="l3.175" class="difflineminus">-                let offline_flag = detail;</span>
<a href="#l3.176"></a><span id="l3.176" class="difflineminus">-                if ((offline_flag == cICL.OFFLINE_FLAG_CREATED_RECORD ||</span>
<a href="#l3.177"></a><span id="l3.177" class="difflineminus">-                     offline_flag == cICL.OFFLINE_FLAG_MODIFIED_RECORD) &amp;&amp; useCache) {</span>
<a href="#l3.178"></a><span id="l3.178" class="difflineminus">-                    thisCalendar.modifyOfflineItem(aNewItem, aOldItem, aListener);</span>
<a href="#l3.179"></a><span id="l3.179" class="difflineminus">-                } else {</span>
<a href="#l3.180"></a><span id="l3.180" class="difflineminus">-                    thisCalendar.doModifyItemOrUseCache(aNewItem, aOldItem, useCache, aListener, false);</span>
<a href="#l3.181"></a><span id="l3.181" class="difflineminus">-                }</span>
<a href="#l3.182"></a><span id="l3.182" class="difflineminus">-            }</span>
<a href="#l3.183"></a><span id="l3.183" class="difflineminus">-        };</span>
<a href="#l3.184"></a><span id="l3.184" class="difflineminus">-        let storage = thisCalendar.mOfflineStorage.QueryInterface(Components.interfaces.calIOfflineStorage);</span>
<a href="#l3.185"></a><span id="l3.185" class="difflineminus">-        storage.getItemOfflineFlag(aOldItem, opListener);</span>
<a href="#l3.186"></a><span id="l3.186" class="difflineplus">+        return this.doModifyItem(aNewItem, aOldItem, aListener, false);</span>
<a href="#l3.187"></a><span id="l3.187">     },</span>
<a href="#l3.188"></a><span id="l3.188"> </span>
<a href="#l3.189"></a><span id="l3.189">     /**</span>
<a href="#l3.190"></a><span id="l3.190">      * Modifies existing item in CalDAV store.</span>
<a href="#l3.191"></a><span id="l3.191">      *</span>
<a href="#l3.192"></a><span id="l3.192">      * @param aItem       item to check</span>
<a href="#l3.193"></a><span id="l3.193">      * @param aOldItem    previous version of item to be modified</span>
<a href="#l3.194"></a><span id="l3.194" class="difflineminus">-     * @param useCache    Flag to use the cached entry in case of failure</span>
<a href="#l3.195"></a><span id="l3.195">      * @param aListener   listener from original request</span>
<a href="#l3.196"></a><span id="l3.196">      * @param aIgnoreEtag ignore item etag</span>
<a href="#l3.197"></a><span id="l3.197">      */</span>
<a href="#l3.198"></a><span id="l3.198" class="difflineminus">-    doModifyItemOrUseCache: function caldav_doModifyItemOrUseCache(aNewItem, aOldItem, useCache, aListener, aIgnoreEtag){</span>
<a href="#l3.199"></a><span id="l3.199" class="difflineplus">+    doModifyItem: function caldav_doModifyItem(aNewItem, aOldItem, aListener, aIgnoreEtag){</span>
<a href="#l3.200"></a><span id="l3.200">         if (aNewItem.id == null) {</span>
<a href="#l3.201"></a><span id="l3.201">             this.notifyOperationComplete(aListener,</span>
<a href="#l3.202"></a><span id="l3.202">                                          Components.results.NS_ERROR_FAILURE,</span>
<a href="#l3.203"></a><span id="l3.203">                                          Components.interfaces.calIOperationListener.MODIFY,</span>
<a href="#l3.204"></a><span id="l3.204">                                          aItem.id,</span>
<a href="#l3.205"></a><span id="l3.205">                                          &quot;ID for modifyItem doesn't exist or is null&quot;);</span>
<a href="#l3.206"></a><span id="l3.206">             return;</span>
<a href="#l3.207"></a><span id="l3.207">         }</span>
<a href="#l3.208"></a><span id="l3.208" class="difflineat">@@ -716,39 +672,44 @@ calDavCalendar.prototype = {</span>
<a href="#l3.209"></a><span id="l3.209">                 // Some CalDAV servers will modify items on PUT (add X-props,</span>
<a href="#l3.210"></a><span id="l3.210">                 // for instance) so we'd best re-fetch in order to know</span>
<a href="#l3.211"></a><span id="l3.211">                 // the current state of the item</span>
<a href="#l3.212"></a><span id="l3.212">                 // Observers will be notified in getUpdatedItem()</span>
<a href="#l3.213"></a><span id="l3.213">                 thisCalendar.getUpdatedItem(aNewItem, aListener);</span>
<a href="#l3.214"></a><span id="l3.214">                 // SOGo has calendarUri == inboxUri so we need to be careful</span>
<a href="#l3.215"></a><span id="l3.215">                 // about deletions</span>
<a href="#l3.216"></a><span id="l3.216">                 if (wasInboxItem &amp;&amp; thisCalendar.mShouldPollInbox) {</span>
<a href="#l3.217"></a><span id="l3.217" class="difflineminus">-                    thisCalendar.doDeleteItemOrUseCache(aNewItem, true, null, true, true, null);</span>
<a href="#l3.218"></a><span id="l3.218" class="difflineplus">+                    thisCalendar.doDeleteItem(aNewItem, null, true, true, null);</span>
<a href="#l3.219"></a><span id="l3.219">                 }</span>
<a href="#l3.220"></a><span id="l3.220">             } else if (status == 412 || status == 409) {</span>
<a href="#l3.221"></a><span id="l3.221">                 thisCalendar.promptOverwrite(CALDAV_MODIFY_ITEM, aNewItem,</span>
<a href="#l3.222"></a><span id="l3.222">                                              aListener, aOldItem);</span>
<a href="#l3.223"></a><span id="l3.223" class="difflineminus">-            } else if ((status &gt;= 500 &amp;&amp; status &lt;= 510) &amp;&amp; (useCache &amp;&amp; thisCalendar.mOfflineStorage)) {</span>
<a href="#l3.224"></a><span id="l3.224" class="difflineminus">-                cal.LOG(&quot;[calDavCalendar] doModifyItemOrUseCache received status code of server unavailibity. Putting entry in cache for later try.&quot;);</span>
<a href="#l3.225"></a><span id="l3.225" class="difflineminus">-                thisCalendar.modifyOfflineItem(aNewItem, aOldItem, aListener);</span>
<a href="#l3.226"></a><span id="l3.226" class="difflineplus">+            } else if (status &gt;= 500 &amp;&amp; status &lt;= 510) {</span>
<a href="#l3.227"></a><span id="l3.227" class="difflineplus">+                cal.LOG(&quot;[calDavCalendar] doModifyItem received status code of server unavailibity. Putting entry in cache for later try.&quot;);</span>
<a href="#l3.228"></a><span id="l3.228" class="difflineplus">+                aListener.onOperationComplete(thisCalendar.superCalendar,</span>
<a href="#l3.229"></a><span id="l3.229" class="difflineplus">+                                              Components.results.NS_ERROR_NOT_AVAILABLE,</span>
<a href="#l3.230"></a><span id="l3.230" class="difflineplus">+                                              Components.interfaces.calIOperationListener.MODIFY,</span>
<a href="#l3.231"></a><span id="l3.231" class="difflineplus">+                                              aNewItem.id,</span>
<a href="#l3.232"></a><span id="l3.232" class="difflineplus">+                                              aNewItem);</span>
<a href="#l3.233"></a><span id="l3.233">             } else {</span>
<a href="#l3.234"></a><span id="l3.234">                 if (status &gt; 999) {</span>
<a href="#l3.235"></a><span id="l3.235">                     status = &quot;0x &quot; + status.toString(16);</span>
<a href="#l3.236"></a><span id="l3.236">                 }</span>
<a href="#l3.237"></a><span id="l3.237"> </span>
<a href="#l3.238"></a><span id="l3.238">                 let responseBody=&quot;&quot;;</span>
<a href="#l3.239"></a><span id="l3.239">                 try {</span>
<a href="#l3.240"></a><span id="l3.240">                     responseBody = cal.convertByteArray(aResult, aResultLength);</span>
<a href="#l3.241"></a><span id="l3.241">                 } catch (e) {}</span>
<a href="#l3.242"></a><span id="l3.242"> </span>
<a href="#l3.243"></a><span id="l3.243">                 cal.ERROR(&quot;CalDAV: Unexpected status modifying item to &quot; +</span>
<a href="#l3.244"></a><span id="l3.244">                         thisCalendar.name + &quot;: &quot; + status + &quot;\n&quot; +</span>
<a href="#l3.245"></a><span id="l3.245">                         responseBody + &quot;\n&quot; +</span>
<a href="#l3.246"></a><span id="l3.246">                         modifiedItemICS);</span>
<a href="#l3.247"></a><span id="l3.247"> </span>
<a href="#l3.248"></a><span id="l3.248" class="difflineplus">+                // TODO why is the listener not notified?</span>
<a href="#l3.249"></a><span id="l3.249">                 thisCalendar.reportDavError(Components.interfaces.calIErrors.DAV_PUT_ERROR,</span>
<a href="#l3.250"></a><span id="l3.250">                                             status,</span>
<a href="#l3.251"></a><span id="l3.251">                                             responseBody);</span>
<a href="#l3.252"></a><span id="l3.252">             }</span>
<a href="#l3.253"></a><span id="l3.253">         };</span>
<a href="#l3.254"></a><span id="l3.254"> </span>
<a href="#l3.255"></a><span id="l3.255">         let httpchannel = cal.prepHttpChannel(eventUri,</span>
<a href="#l3.256"></a><span id="l3.256">                                               modifiedItemICS,</span>
<a href="#l3.257"></a><span id="l3.257" class="difflineat">@@ -759,91 +720,37 @@ calDavCalendar.prototype = {</span>
<a href="#l3.258"></a><span id="l3.258">             httpchannel.setRequestHeader(&quot;If-Match&quot;,</span>
<a href="#l3.259"></a><span id="l3.259">                                          this.mItemInfoCache[aNewItem.id].etag,</span>
<a href="#l3.260"></a><span id="l3.260">                                          false);</span>
<a href="#l3.261"></a><span id="l3.261">         }</span>
<a href="#l3.262"></a><span id="l3.262"> </span>
<a href="#l3.263"></a><span id="l3.263">         cal.sendHttpRequest(cal.createStreamLoader(), httpchannel, modListener);</span>
<a href="#l3.264"></a><span id="l3.264">     },</span>
<a href="#l3.265"></a><span id="l3.265"> </span>
<a href="#l3.266"></a><span id="l3.266" class="difflineminus">-    modifyOfflineItem: function(aNewItem, aOldItem, aListener) {</span>
<a href="#l3.267"></a><span id="l3.267" class="difflineminus">-        let thisCalendar = this;</span>
<a href="#l3.268"></a><span id="l3.268" class="difflineminus">-        let opListener = {</span>
<a href="#l3.269"></a><span id="l3.269" class="difflineminus">-            onGetResult: function(calendar, status, itemType, detail, count, items) {</span>
<a href="#l3.270"></a><span id="l3.270" class="difflineminus">-                cal.ASSERT(false, &quot;unexpected!&quot;);</span>
<a href="#l3.271"></a><span id="l3.271" class="difflineminus">-            },</span>
<a href="#l3.272"></a><span id="l3.272" class="difflineminus">-            onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l3.273"></a><span id="l3.273" class="difflineminus">-                if (Components.isSuccessCode(status)) {</span>
<a href="#l3.274"></a><span id="l3.274" class="difflineminus">-                    // Modify the offline item in the storage, passing the</span>
<a href="#l3.275"></a><span id="l3.275" class="difflineminus">-                    // listener will make sure its notified</span>
<a href="#l3.276"></a><span id="l3.276" class="difflineminus">-                    let storage = thisCalendar.mOfflineStorage.QueryInterface(Components.interfaces.calIOfflineStorage);</span>
<a href="#l3.277"></a><span id="l3.277" class="difflineminus">-                    storage.modifyOfflineItem(detail, aListener);</span>
<a href="#l3.278"></a><span id="l3.278" class="difflineminus">-                } else if (aListener) {</span>
<a href="#l3.279"></a><span id="l3.279" class="difflineminus">-                    // If there was not a success, then we need to notify the</span>
<a href="#l3.280"></a><span id="l3.280" class="difflineminus">-                    // listener ourselves</span>
<a href="#l3.281"></a><span id="l3.281" class="difflineminus">-                    aListener.onOperationComplete(thisCalendar.superCalendar, status, opType, id, detail);</span>
<a href="#l3.282"></a><span id="l3.282" class="difflineminus">-                }</span>
<a href="#l3.283"></a><span id="l3.283" class="difflineminus">-            }</span>
<a href="#l3.284"></a><span id="l3.284" class="difflineminus">-        };</span>
<a href="#l3.285"></a><span id="l3.285" class="difflineminus">-        thisCalendar.mOfflineStorage.modifyItem(aNewItem, aOldItem, opListener);</span>
<a href="#l3.286"></a><span id="l3.286" class="difflineminus">-    },</span>
<a href="#l3.287"></a><span id="l3.287" class="difflineminus">-</span>
<a href="#l3.288"></a><span id="l3.288">     /**</span>
<a href="#l3.289"></a><span id="l3.289">      * deleteItem(); required by calICalendar.idl</span>
<a href="#l3.290"></a><span id="l3.290" class="difflineminus">-     * the actual deletion is done in deleteItemOrUseCache()</span>
<a href="#l3.291"></a><span id="l3.291" class="difflineplus">+     * the actual deletion is done in doDeleteItem()</span>
<a href="#l3.292"></a><span id="l3.292">      *</span>
<a href="#l3.293"></a><span id="l3.293">      * @param aItem       item to delete</span>
<a href="#l3.294"></a><span id="l3.294">      * @param aListener   listener for method completion</span>
<a href="#l3.295"></a><span id="l3.295">      */</span>
<a href="#l3.296"></a><span id="l3.296">     deleteItem: function caldav_deleteItem(aItem, aListener) {</span>
<a href="#l3.297"></a><span id="l3.297" class="difflineminus">-        return this.deleteItemOrUseCache(aItem, true, aListener);</span>
<a href="#l3.298"></a><span id="l3.298" class="difflineplus">+        return this.doDeleteItem(aItem, aListener, false, null, null);</span>
<a href="#l3.299"></a><span id="l3.299">     },</span>
<a href="#l3.300"></a><span id="l3.300"> </span>
<a href="#l3.301"></a><span id="l3.301" class="difflineminus">-    deleteItemOrUseCache: function caldav_deleteItemOrUseCache(aItem, useCache, aListener){</span>
<a href="#l3.302"></a><span id="l3.302" class="difflineminus">-        let thisCalendar = this;</span>
<a href="#l3.303"></a><span id="l3.303" class="difflineminus">-</span>
<a href="#l3.304"></a><span id="l3.304" class="difflineminus">-        let deleteListener = { //We need a listener because the original doDeleteItemOrUseCache would return null upon successful item deletion</span>
<a href="#l3.305"></a><span id="l3.305" class="difflineminus">-            onGetResult: function(calendar, status, itemType, detail, count, items) {</span>
<a href="#l3.306"></a><span id="l3.306" class="difflineminus">-                cal.ASSERT(false, &quot;unexpected!&quot;);</span>
<a href="#l3.307"></a><span id="l3.307" class="difflineminus">-            },</span>
<a href="#l3.308"></a><span id="l3.308" class="difflineminus">-            onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l3.309"></a><span id="l3.309" class="difflineminus">-                aListener.onOperationComplete(calendar, status, opType, aItem.id, aItem);</span>
<a href="#l3.310"></a><span id="l3.310" class="difflineminus">-            }</span>
<a href="#l3.311"></a><span id="l3.311" class="difflineminus">-        };</span>
<a href="#l3.312"></a><span id="l3.312" class="difflineminus">-</span>
<a href="#l3.313"></a><span id="l3.313" class="difflineminus">-        // If the item has an offline_flag associated with itself then it is better to</span>
<a href="#l3.314"></a><span id="l3.314" class="difflineminus">-        // do offline deletion since the items will not be present in the</span>
<a href="#l3.315"></a><span id="l3.315" class="difflineminus">-        // mItemInfoCache. The items will be reconciled whenever the server becomes available</span>
<a href="#l3.316"></a><span id="l3.316" class="difflineminus">-        let opListener = {</span>
<a href="#l3.317"></a><span id="l3.317" class="difflineminus">-            onGetResult: function(calendar, status, itemType, detail, count, items) {</span>
<a href="#l3.318"></a><span id="l3.318" class="difflineminus">-            },</span>
<a href="#l3.319"></a><span id="l3.319" class="difflineminus">-            onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l3.320"></a><span id="l3.320" class="difflineminus">-                let offline_flag = detail;</span>
<a href="#l3.321"></a><span id="l3.321" class="difflineminus">-                if ((offline_flag == cICL.OFFLINE_FLAG_CREATED_RECORD ||</span>
<a href="#l3.322"></a><span id="l3.322" class="difflineminus">-                     offline_flag == cICL.OFFLINE_FLAG_MODIFIED_RECORD) &amp;&amp; useCache) {</span>
<a href="#l3.323"></a><span id="l3.323" class="difflineminus">-                    thisCalendar.deleteOfflineItem(aItem, deleteListener);</span>
<a href="#l3.324"></a><span id="l3.324" class="difflineminus">-                } else {</span>
<a href="#l3.325"></a><span id="l3.325" class="difflineminus">-                    thisCalendar.doDeleteItemOrUseCache(aItem, useCache, deleteListener, false);</span>
<a href="#l3.326"></a><span id="l3.326" class="difflineminus">-                }</span>
<a href="#l3.327"></a><span id="l3.327" class="difflineminus">-            }</span>
<a href="#l3.328"></a><span id="l3.328" class="difflineminus">-        };</span>
<a href="#l3.329"></a><span id="l3.329" class="difflineminus">-        let storage = thisCalendar.mOfflineStorage.QueryInterface(Components.interfaces.calIOfflineStorage);</span>
<a href="#l3.330"></a><span id="l3.330" class="difflineminus">-        storage.getItemOfflineFlag(aItem, opListener);</span>
<a href="#l3.331"></a><span id="l3.331" class="difflineminus">-    },</span>
<a href="#l3.332"></a><span id="l3.332">     /**</span>
<a href="#l3.333"></a><span id="l3.333">      * Deletes item from CalDAV store.</span>
<a href="#l3.334"></a><span id="l3.334">      *</span>
<a href="#l3.335"></a><span id="l3.335">      * @param aItem       item to delete</span>
<a href="#l3.336"></a><span id="l3.336">      * @param aListener   listener for method completion</span>
<a href="#l3.337"></a><span id="l3.337" class="difflineminus">-     * @param useCache    flag to use the cache in case of failure</span>
<a href="#l3.338"></a><span id="l3.338">      * @param aIgnoreEtag ignore item etag</span>
<a href="#l3.339"></a><span id="l3.339">      * @param aFromInbox  delete from inbox rather than calendar</span>
<a href="#l3.340"></a><span id="l3.340">      * @param aUri        uri of item to delete</span>
<a href="#l3.341"></a><span id="l3.341">      * */</span>
<a href="#l3.342"></a><span id="l3.342" class="difflineminus">-    doDeleteItemOrUseCache: function caldav_doDeleteItemOrUseCache(aItem, useCache, aListener, aIgnoreEtag, aFromInbox, aUri){</span>
<a href="#l3.343"></a><span id="l3.343" class="difflineplus">+    doDeleteItem: function caldav_doDeleteItem(aItem, aListener, aIgnoreEtag, aFromInbox, aUri){</span>
<a href="#l3.344"></a><span id="l3.344">         if (aItem.id == null) {</span>
<a href="#l3.345"></a><span id="l3.345">             this.notifyOperationComplete(aListener,</span>
<a href="#l3.346"></a><span id="l3.346">                                          Components.results.NS_ERROR_FAILURE,</span>
<a href="#l3.347"></a><span id="l3.347">                                          Components.interfaces.calIOperationListener.DELETE,</span>
<a href="#l3.348"></a><span id="l3.348">                                          aItem.id,</span>
<a href="#l3.349"></a><span id="l3.349">                                          &quot;ID doesn't exist for deleteItem&quot;);</span>
<a href="#l3.350"></a><span id="l3.350">             return;</span>
<a href="#l3.351"></a><span id="l3.351">         }</span>
<a href="#l3.352"></a><span id="l3.352" class="difflineat">@@ -854,74 +761,67 @@ calDavCalendar.prototype = {</span>
<a href="#l3.353"></a><span id="l3.353">         } else if (aFromInbox || this.mItemInfoCache[aItem.id].isInboxItem) {</span>
<a href="#l3.354"></a><span id="l3.354">             eventUri = this.makeUri(this.mItemInfoCache[aItem.id].locationPath, this.mInboxUrl);</span>
<a href="#l3.355"></a><span id="l3.355">         } else {</span>
<a href="#l3.356"></a><span id="l3.356">             eventUri = this.makeUri(this.mItemInfoCache[aItem.id].locationPath);</span>
<a href="#l3.357"></a><span id="l3.357">         }</span>
<a href="#l3.358"></a><span id="l3.358"> </span>
<a href="#l3.359"></a><span id="l3.359">         var delListener = {};</span>
<a href="#l3.360"></a><span id="l3.360">         var thisCalendar = this;</span>
<a href="#l3.361"></a><span id="l3.361" class="difflineminus">-        var realListener = aListener; // need to access from callback</span>
<a href="#l3.362"></a><span id="l3.362"> </span>
<a href="#l3.363"></a><span id="l3.363">         delListener.onStreamComplete =</span>
<a href="#l3.364"></a><span id="l3.364">         function caldav_dDI_del_onStreamComplete(aLoader, aContext, aStatus, aResultLength, aResult) {</span>
<a href="#l3.365"></a><span id="l3.365">             let request = aLoader.request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l3.366"></a><span id="l3.366">             let status;</span>
<a href="#l3.367"></a><span id="l3.367">             try {</span>
<a href="#l3.368"></a><span id="l3.368">                 status = request.responseStatus;</span>
<a href="#l3.369"></a><span id="l3.369">             } catch (ex) {</span>
<a href="#l3.370"></a><span id="l3.370">                 status = Components.interfaces.calIErrors.DAV_REMOVE_ERROR;</span>
<a href="#l3.371"></a><span id="l3.371">             }</span>
<a href="#l3.372"></a><span id="l3.372"> </span>
<a href="#l3.373"></a><span id="l3.373">             // 204 = HTTP &quot;No content&quot;</span>
<a href="#l3.374"></a><span id="l3.374" class="difflineplus">+            // 404 = Not Found - This is kind of a success, since the item is already deleted.</span>
<a href="#l3.375"></a><span id="l3.375">             //</span>
<a href="#l3.376"></a><span id="l3.376" class="difflineminus">-            if (status == 204 || status == 200) {</span>
<a href="#l3.377"></a><span id="l3.377" class="difflineplus">+            if (status == 204 || status == 200 || status == 404) {</span>
<a href="#l3.378"></a><span id="l3.378">                 if (!aFromInbox) {</span>
<a href="#l3.379"></a><span id="l3.379">                     if (thisCalendar.isCached) {</span>
<a href="#l3.380"></a><span id="l3.380">                         // the item is deleted in the storage calendar from calCachedCalendar</span>
<a href="#l3.381"></a><span id="l3.381" class="difflineminus">-                        realListener.onOperationComplete(thisCalendar, status,</span>
<a href="#l3.382"></a><span id="l3.382" class="difflineplus">+                        aListener.onOperationComplete(thisCalendar, status,</span>
<a href="#l3.383"></a><span id="l3.383">                                                          Components.interfaces.calIOperationListener.DELETE,</span>
<a href="#l3.384"></a><span id="l3.384" class="difflineminus">-                                                         null, null);</span>
<a href="#l3.385"></a><span id="l3.385" class="difflineminus">-                        thisCalendar.mOfflineStorage.deleteMetaData(aItem.id);</span>
<a href="#l3.386"></a><span id="l3.386" class="difflineplus">+                                                         aItem.id, aItem);</span>
<a href="#l3.387"></a><span id="l3.387">                     } else {</span>
<a href="#l3.388"></a><span id="l3.388">                         thisCalendar.mOfflineStorage.deleteItem(aItem, aListener);</span>
<a href="#l3.389"></a><span id="l3.389">                     }</span>
<a href="#l3.390"></a><span id="l3.390">                     let decodedPath = thisCalendar.ensureDecodedPath(eventUri.path);</span>
<a href="#l3.391"></a><span id="l3.391">                     delete thisCalendar.mHrefIndex[decodedPath];</span>
<a href="#l3.392"></a><span id="l3.392">                     delete thisCalendar.mItemInfoCache[aItem.id];</span>
<a href="#l3.393"></a><span id="l3.393" class="difflineminus">-                    cal.LOG(&quot;CalDAV: Item deleted successfully from calendar&quot; +</span>
<a href="#l3.394"></a><span id="l3.394" class="difflineminus">-                            thisCalendar.name);</span>
<a href="#l3.395"></a><span id="l3.395" class="difflineplus">+                    cal.LOG(&quot;CalDAV: Item deleted successfully from calendar&quot; + thisCalendar.name);</span>
<a href="#l3.396"></a><span id="l3.396">                 }</span>
<a href="#l3.397"></a><span id="l3.397">             } else if (status == 412 || status == 409) {</span>
<a href="#l3.398"></a><span id="l3.398" class="difflineminus">-                // item has either been modified or deleted by someone else</span>
<a href="#l3.399"></a><span id="l3.399" class="difflineminus">-                // check to see which</span>
<a href="#l3.400"></a><span id="l3.400" class="difflineminus">-</span>
<a href="#l3.401"></a><span id="l3.401" class="difflineplus">+                // item has either been modified or deleted by someone else check to see which</span>
<a href="#l3.402"></a><span id="l3.402">                 let httpchannel2 = cal.prepHttpChannel(eventUri,</span>
<a href="#l3.403"></a><span id="l3.403">                                                        null,</span>
<a href="#l3.404"></a><span id="l3.404">                                                        null,</span>
<a href="#l3.405"></a><span id="l3.405">                                                        thisCalendar);</span>
<a href="#l3.406"></a><span id="l3.406">                 httpchannel2.requestMethod = &quot;HEAD&quot;;</span>
<a href="#l3.407"></a><span id="l3.407">                 cal.sendHttpRequest(cal.createStreamLoader(), httpchannel2, delListener2);</span>
<a href="#l3.408"></a><span id="l3.408" class="difflineminus">-            } else if ((status &gt;= 500 &amp;&amp; status &lt;= 510) &amp;&amp; (useCache &amp;&amp; thisCalendar.mOfflineStorage)) {</span>
<a href="#l3.409"></a><span id="l3.409" class="difflineplus">+            } else if (status &gt;= 500 &amp;&amp; status &lt;= 510) {</span>
<a href="#l3.410"></a><span id="l3.410">                 cal.LOG(&quot;[calDavCalendar] Remote Calendar &quot; + thisCalendar.name + &quot; is currently unavailabile. Putting entry in cache for a later try.&quot;);</span>
<a href="#l3.411"></a><span id="l3.411" class="difflineminus">-                let opListener = {</span>
<a href="#l3.412"></a><span id="l3.412" class="difflineminus">-                    // We should not return a success code since the listeners can delete the physical item in case of success</span>
<a href="#l3.413"></a><span id="l3.413" class="difflineminus">-                    onGetResult: function(calendar, status, itemType, detail, count, items) {},</span>
<a href="#l3.414"></a><span id="l3.414" class="difflineminus">-                    onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l3.415"></a><span id="l3.415" class="difflineminus">-                         aListener.onOperationComplete(calendar, Components.results.NS_ERROR_CONNECTION_REFUSED,</span>
<a href="#l3.416"></a><span id="l3.416" class="difflineminus">-                                          Components.interfaces.calIOperationListener.GET, aItem.id, aItem);</span>
<a href="#l3.417"></a><span id="l3.417" class="difflineminus">-                    }</span>
<a href="#l3.418"></a><span id="l3.418" class="difflineminus">-                };</span>
<a href="#l3.419"></a><span id="l3.419" class="difflineminus">-                thisCalendar.deleteOfflineItem(aItem, opListener);</span>
<a href="#l3.420"></a><span id="l3.420" class="difflineplus">+                aListener.onOperationComplete(thisCalendar.superCalendar,</span>
<a href="#l3.421"></a><span id="l3.421" class="difflineplus">+                                              Components.results.NS_ERROR_NOT_AVAILABLE,</span>
<a href="#l3.422"></a><span id="l3.422" class="difflineplus">+                                              Components.interfaces.calIOperationListener.DELETE,</span>
<a href="#l3.423"></a><span id="l3.423" class="difflineplus">+                                              aItem.id,</span>
<a href="#l3.424"></a><span id="l3.424" class="difflineplus">+                                              aItem);</span>
<a href="#l3.425"></a><span id="l3.425">             } else {</span>
<a href="#l3.426"></a><span id="l3.426">                 let responseBody=&quot;&quot;;</span>
<a href="#l3.427"></a><span id="l3.427">                 try {</span>
<a href="#l3.428"></a><span id="l3.428">                     responseBody = cal.convertByteArray(aResult, aResultLength);</span>
<a href="#l3.429"></a><span id="l3.429">                 } catch (e) {}</span>
<a href="#l3.430"></a><span id="l3.430"> </span>
<a href="#l3.431"></a><span id="l3.431" class="difflineplus">+                // TODO why are listeners not notified?</span>
<a href="#l3.432"></a><span id="l3.432">                 cal.ERROR(&quot;CalDAV: Unexpected status deleting item from &quot; +</span>
<a href="#l3.433"></a><span id="l3.433">                           thisCalendar.name + &quot;: &quot; + status + &quot;\n&quot; +</span>
<a href="#l3.434"></a><span id="l3.434">                           responseBody + &quot;\n&quot; +</span>
<a href="#l3.435"></a><span id="l3.435">                           &quot;uri: &quot; + eventUri.spec);</span>
<a href="#l3.436"></a><span id="l3.436"> </span>
<a href="#l3.437"></a><span id="l3.437">                 thisCalendar.reportDavError(Components.interfaces.calIErrors.DAV_REMOVE_ERROR,</span>
<a href="#l3.438"></a><span id="l3.438">                                             status,</span>
<a href="#l3.439"></a><span id="l3.439">                                             responseBody);</span>
<a href="#l3.440"></a><span id="l3.440" class="difflineat">@@ -929,32 +829,27 @@ calDavCalendar.prototype = {</span>
<a href="#l3.441"></a><span id="l3.441">         };</span>
<a href="#l3.442"></a><span id="l3.442">         var delListener2 = {};</span>
<a href="#l3.443"></a><span id="l3.443">         delListener2.onStreamComplete =</span>
<a href="#l3.444"></a><span id="l3.444">             function caldav_dDI_del2_onStreamComplete(aLoader, aContext, aStatus, aResultLength, aResult) {</span>
<a href="#l3.445"></a><span id="l3.445">                 let request = aLoader.request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l3.446"></a><span id="l3.446">                 let status = request.responseStatus;</span>
<a href="#l3.447"></a><span id="l3.447">                 if (status == 404) {</span>
<a href="#l3.448"></a><span id="l3.448">                     // someone else already deleted it</span>
<a href="#l3.449"></a><span id="l3.449" class="difflineplus">+                    // TODO don't we have to notify observers?</span>
<a href="#l3.450"></a><span id="l3.450">                     return;</span>
<a href="#l3.451"></a><span id="l3.451" class="difflineminus">-                } else if ((status &gt;= 500 &amp;&amp; status &lt;= 510) &amp;&amp; (useCache &amp;&amp; thisCalendar.mOfflineStorage)) {</span>
<a href="#l3.452"></a><span id="l3.452" class="difflineminus">-                    cal.LOG(&quot;[calDavCalendar] doDeleteItemOrUseCache recd status response of remote calendar unavailability. Putting entry in cache for a later try.&quot;);</span>
<a href="#l3.453"></a><span id="l3.453" class="difflineminus">-                    let opListener = {</span>
<a href="#l3.454"></a><span id="l3.454" class="difflineminus">-                         //We should not return a success code since the listeners can delete the physical item in case of success</span>
<a href="#l3.455"></a><span id="l3.455" class="difflineminus">-                         onGetResult: function(calendar, status, itemType, detail, count, items) {</span>
<a href="#l3.456"></a><span id="l3.456" class="difflineminus">-                        },</span>
<a href="#l3.457"></a><span id="l3.457" class="difflineminus">-                         onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l3.458"></a><span id="l3.458" class="difflineminus">-                              aListener.onOperationComplete(calendar, Components.results.NS_ERROR_CONNECTION_REFUSED,</span>
<a href="#l3.459"></a><span id="l3.459" class="difflineminus">-                                               Components.interfaces.calIOperationListener.GET, aItem.id, aItem);</span>
<a href="#l3.460"></a><span id="l3.460" class="difflineminus">-                        }</span>
<a href="#l3.461"></a><span id="l3.461" class="difflineminus">-                    };</span>
<a href="#l3.462"></a><span id="l3.462" class="difflineminus">-                    thisCalendar.deleteOfflineItem(aItem, opListener);</span>
<a href="#l3.463"></a><span id="l3.463" class="difflineplus">+                } else if (status &gt;= 500 &amp;&amp; status &lt;= 510) {</span>
<a href="#l3.464"></a><span id="l3.464" class="difflineplus">+                    cal.LOG(&quot;[calDavCalendar] doDeleteItem recd status response of remote calendar unavailability. Putting entry in cache for a later try.&quot;);</span>
<a href="#l3.465"></a><span id="l3.465" class="difflineplus">+                    aListener.onOperationComplete(thisCalendar.superCalendar,</span>
<a href="#l3.466"></a><span id="l3.466" class="difflineplus">+                                                  Components.results.NS_ERROR_NOT_AVAILABLE,</span>
<a href="#l3.467"></a><span id="l3.467" class="difflineplus">+                                                  Components.interfaces.calIOperationListener.DELETE,</span>
<a href="#l3.468"></a><span id="l3.468" class="difflineplus">+                                                  aItem.id,</span>
<a href="#l3.469"></a><span id="l3.469" class="difflineplus">+                                                  aItem);</span>
<a href="#l3.470"></a><span id="l3.470">                 } else {</span>
<a href="#l3.471"></a><span id="l3.471" class="difflineminus">-                    thisCalendar.promptOverwrite(CALDAV_DELETE_ITEM, aItem,</span>
<a href="#l3.472"></a><span id="l3.472" class="difflineminus">-                                                 realListener, null);</span>
<a href="#l3.473"></a><span id="l3.473" class="difflineplus">+                    thisCalendar.promptOverwrite(CALDAV_DELETE_ITEM, aItem, aListener, null);</span>
<a href="#l3.474"></a><span id="l3.474">                 }</span>
<a href="#l3.475"></a><span id="l3.475">             };</span>
<a href="#l3.476"></a><span id="l3.476"> </span>
<a href="#l3.477"></a><span id="l3.477">         if (this.verboseLogging()) {</span>
<a href="#l3.478"></a><span id="l3.478">             cal.LOG(&quot;CalDAV: Deleting &quot; + eventUri.spec);</span>
<a href="#l3.479"></a><span id="l3.479">         }</span>
<a href="#l3.480"></a><span id="l3.480"> </span>
<a href="#l3.481"></a><span id="l3.481">         let httpchannel = cal.prepHttpChannel(eventUri, null, null, this);</span>
<a href="#l3.482"></a><span id="l3.482" class="difflineat">@@ -963,22 +858,16 @@ calDavCalendar.prototype = {</span>
<a href="#l3.483"></a><span id="l3.483">                                          this.mItemInfoCache[aItem.id].etag,</span>
<a href="#l3.484"></a><span id="l3.484">                                          false);</span>
<a href="#l3.485"></a><span id="l3.485">         }</span>
<a href="#l3.486"></a><span id="l3.486">         httpchannel.requestMethod = &quot;DELETE&quot;;</span>
<a href="#l3.487"></a><span id="l3.487"> </span>
<a href="#l3.488"></a><span id="l3.488">         cal.sendHttpRequest(cal.createStreamLoader(), httpchannel, delListener);</span>
<a href="#l3.489"></a><span id="l3.489">     },</span>
<a href="#l3.490"></a><span id="l3.490"> </span>
<a href="#l3.491"></a><span id="l3.491" class="difflineminus">-    deleteOfflineItem: function(item, listener) {</span>
<a href="#l3.492"></a><span id="l3.492" class="difflineminus">-        /* We do not delete the item from the cache, as we will need it when reconciling the cache content and the server content. */</span>
<a href="#l3.493"></a><span id="l3.493" class="difflineminus">-        let storage = this.mOfflineStorage.QueryInterface(Components.interfaces.calIOfflineStorage);</span>
<a href="#l3.494"></a><span id="l3.494" class="difflineminus">-        storage.deleteOfflineItem(item, listener);</span>
<a href="#l3.495"></a><span id="l3.495" class="difflineminus">-    },</span>
<a href="#l3.496"></a><span id="l3.496" class="difflineminus">-</span>
<a href="#l3.497"></a><span id="l3.497">     /**</span>
<a href="#l3.498"></a><span id="l3.498">      * Add an item to the target calendar</span>
<a href="#l3.499"></a><span id="l3.499">      *</span>
<a href="#l3.500"></a><span id="l3.500">      * @param path      Item path MUST NOT BE ENCODED</span>
<a href="#l3.501"></a><span id="l3.501">      * @param calData   iCalendar string representation of the item</span>
<a href="#l3.502"></a><span id="l3.502">      * @param aUri      Base URI of the request</span>
<a href="#l3.503"></a><span id="l3.503">      * @param aListener Listener</span>
<a href="#l3.504"></a><span id="l3.504">      */</span>
<a href="#l3.505"></a><span id="l3.505" class="difflineat">@@ -1044,24 +933,41 @@ calDavCalendar.prototype = {</span>
<a href="#l3.506"></a><span id="l3.506">         } else {</span>
<a href="#l3.507"></a><span id="l3.507">             this.mItemInfoCache[item.id] = { isNew: true };</span>
<a href="#l3.508"></a><span id="l3.508">         }</span>
<a href="#l3.509"></a><span id="l3.509">         this.mItemInfoCache[item.id].locationPath = locationPath;</span>
<a href="#l3.510"></a><span id="l3.510">         this.mItemInfoCache[item.id].isInboxItem = isInboxItem;</span>
<a href="#l3.511"></a><span id="l3.511"> </span>
<a href="#l3.512"></a><span id="l3.512">         this.mHrefIndex[path] = item.id;</span>
<a href="#l3.513"></a><span id="l3.513">         this.mItemInfoCache[item.id].etag = etag;</span>
<a href="#l3.514"></a><span id="l3.514" class="difflineminus">-        if (this.mItemInfoCache[item.id].isNew) {</span>
<a href="#l3.515"></a><span id="l3.515" class="difflineminus">-            this.mOfflineStorage.adoptItem(item, aListener);</span>
<a href="#l3.516"></a><span id="l3.516" class="difflineminus">-        } else {</span>
<a href="#l3.517"></a><span id="l3.517" class="difflineminus">-            this.mOfflineStorage.modifyItem(item, null, aListener);</span>
<a href="#l3.518"></a><span id="l3.518" class="difflineminus">-        }</span>
<a href="#l3.519"></a><span id="l3.519"> </span>
<a href="#l3.520"></a><span id="l3.520">         if (this.isCached) {</span>
<a href="#l3.521"></a><span id="l3.521">             this.setMetaData(item.id, path, etag, isInboxItem);</span>
<a href="#l3.522"></a><span id="l3.522" class="difflineplus">+</span>
<a href="#l3.523"></a><span id="l3.523" class="difflineplus">+            // In the cached case, notifying operation complete will add the item to the cache</span>
<a href="#l3.524"></a><span id="l3.524" class="difflineplus">+            if (this.mItemInfoCache[item.id].isNew) {</span>
<a href="#l3.525"></a><span id="l3.525" class="difflineplus">+                this.notifyOperationComplete(aListener,</span>
<a href="#l3.526"></a><span id="l3.526" class="difflineplus">+                                             Components.results.NS_OK,</span>
<a href="#l3.527"></a><span id="l3.527" class="difflineplus">+                                             Components.interfaces.calIOperationListener.ADD,</span>
<a href="#l3.528"></a><span id="l3.528" class="difflineplus">+                                             item.id,</span>
<a href="#l3.529"></a><span id="l3.529" class="difflineplus">+                                             item);</span>
<a href="#l3.530"></a><span id="l3.530" class="difflineplus">+            } else {</span>
<a href="#l3.531"></a><span id="l3.531" class="difflineplus">+                this.notifyOperationComplete(aListener,</span>
<a href="#l3.532"></a><span id="l3.532" class="difflineplus">+                                             Components.results.NS_OK,</span>
<a href="#l3.533"></a><span id="l3.533" class="difflineplus">+                                             Components.interfaces.calIOperationListener.MODIFY,</span>
<a href="#l3.534"></a><span id="l3.534" class="difflineplus">+                                             item.id,</span>
<a href="#l3.535"></a><span id="l3.535" class="difflineplus">+                                             item);</span>
<a href="#l3.536"></a><span id="l3.536" class="difflineplus">+            }</span>
<a href="#l3.537"></a><span id="l3.537" class="difflineplus">+        } else {</span>
<a href="#l3.538"></a><span id="l3.538" class="difflineplus">+            // In the uncached case, we need to do so ourselves</span>
<a href="#l3.539"></a><span id="l3.539" class="difflineplus">+            if (this.mItemInfoCache[item.id].isNew) {</span>
<a href="#l3.540"></a><span id="l3.540" class="difflineplus">+                this.mOfflineStorage.adoptItem(item, aListener);</span>
<a href="#l3.541"></a><span id="l3.541" class="difflineplus">+            } else {</span>
<a href="#l3.542"></a><span id="l3.542" class="difflineplus">+                this.mOfflineStorage.modifyItem(item, null, aListener);</span>
<a href="#l3.543"></a><span id="l3.543" class="difflineplus">+            }</span>
<a href="#l3.544"></a><span id="l3.544">         }</span>
<a href="#l3.545"></a><span id="l3.545">     },</span>
<a href="#l3.546"></a><span id="l3.546"> </span>
<a href="#l3.547"></a><span id="l3.547">     /**</span>
<a href="#l3.548"></a><span id="l3.548">      * Deletes an item from the target calendar</span>
<a href="#l3.549"></a><span id="l3.549">      *</span>
<a href="#l3.550"></a><span id="l3.550">      * @param path Path of the item to delete, must not be encoded</span>
<a href="#l3.551"></a><span id="l3.551">      */</span>
<a href="#l3.552"></a><span id="l3.552" class="difflineat">@@ -2432,34 +2338,34 @@ calDavCalendar.prototype = {</span>
<a href="#l3.553"></a><span id="l3.553">                 var att = newItem.getAttendeeById(attendee.id);</span>
<a href="#l3.554"></a><span id="l3.554">                 if (att) {</span>
<a href="#l3.555"></a><span id="l3.555">                     newItem.removeAttendee(att);</span>
<a href="#l3.556"></a><span id="l3.556">                     att = att.clone();</span>
<a href="#l3.557"></a><span id="l3.557">                     att.participationStatus = attendee.participationStatus;</span>
<a href="#l3.558"></a><span id="l3.558">                     newItem.addAttendee(att);</span>
<a href="#l3.559"></a><span id="l3.559">                 }</span>
<a href="#l3.560"></a><span id="l3.560">             }</span>
<a href="#l3.561"></a><span id="l3.561" class="difflineminus">-            thisCalendar.doModifyItemOrUseCache(newItem, itemToUpdate.parentItem /* related to bug 396182 */,</span>
<a href="#l3.562"></a><span id="l3.562" class="difflineminus">-                                      true, modListener, true);</span>
<a href="#l3.563"></a><span id="l3.563" class="difflineplus">+            thisCalendar.doModifyItem(newItem, itemToUpdate.parentItem /* related to bug 396182 */,</span>
<a href="#l3.564"></a><span id="l3.564" class="difflineplus">+                                      modListener, true);</span>
<a href="#l3.565"></a><span id="l3.565">         };</span>
<a href="#l3.566"></a><span id="l3.566"> </span>
<a href="#l3.567"></a><span id="l3.567">         var modListener = {};</span>
<a href="#l3.568"></a><span id="l3.568">         modListener.onOperationComplete = function caldav_pIR_moOC(aCalendar,</span>
<a href="#l3.569"></a><span id="l3.569">                                                                    aStatus,</span>
<a href="#l3.570"></a><span id="l3.570">                                                                    aOperationType,</span>
<a href="#l3.571"></a><span id="l3.571">                                                                    aItemId,</span>
<a href="#l3.572"></a><span id="l3.572">                                                                    aDetail) {</span>
<a href="#l3.573"></a><span id="l3.573">             cal.LOG(&quot;CalDAV: status &quot; + aStatus + &quot; while processing iTIP REPLY &quot; +</span>
<a href="#l3.574"></a><span id="l3.574">                     &quot; for &quot; + thisCalendar.name);</span>
<a href="#l3.575"></a><span id="l3.575">             // don't delete the REPLY item from inbox unless modifying the master</span>
<a href="#l3.576"></a><span id="l3.576">             // item was successful</span>
<a href="#l3.577"></a><span id="l3.577">             if (aStatus == 0) { // aStatus undocumented; 0 seems to indicate no error</span>
<a href="#l3.578"></a><span id="l3.578">                 var delUri = thisCalendar.calendarUri.clone();</span>
<a href="#l3.579"></a><span id="l3.579">                 delUri.path = thisCalendar.ensureEncodedPath(aPath);</span>
<a href="#l3.580"></a><span id="l3.580" class="difflineminus">-                thisCalendar.doDeleteItemOrUseCache(aItem, true, null, true, true, delUri);</span>
<a href="#l3.581"></a><span id="l3.581" class="difflineplus">+                thisCalendar.doDeleteItem(aItem, null, true, true, delUri);</span>
<a href="#l3.582"></a><span id="l3.582">             }</span>
<a href="#l3.583"></a><span id="l3.583">         };</span>
<a href="#l3.584"></a><span id="l3.584"> </span>
<a href="#l3.585"></a><span id="l3.585">         this.mOfflineStorage.getItem(aItem.id, getItemListener);</span>
<a href="#l3.586"></a><span id="l3.586">     },</span>
<a href="#l3.587"></a><span id="l3.587"> </span>
<a href="#l3.588"></a><span id="l3.588">     canNotify: function caldav_canNotify(aMethod, aItem) {</span>
<a href="#l3.589"></a><span id="l3.589">         if (this.hasAutoScheduling) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/calendar/providers/gdata/components/calGoogleCalendar.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/calendar/providers/gdata/components/calGoogleCalendar.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -288,20 +288,16 @@ calGoogleCalendar.prototype = {</span>
<a href="#l4.4"></a><span id="l4.4">         return this.__proto__.__proto__.getProperty.apply(this, arguments);</span>
<a href="#l4.5"></a><span id="l4.5">     },</span>
<a href="#l4.6"></a><span id="l4.6"> </span>
<a href="#l4.7"></a><span id="l4.7">     get canRefresh() {</span>
<a href="#l4.8"></a><span id="l4.8">         return true;</span>
<a href="#l4.9"></a><span id="l4.9">     },</span>
<a href="#l4.10"></a><span id="l4.10"> </span>
<a href="#l4.11"></a><span id="l4.11">     adoptItem: function cGC_adoptItem(aItem, aListener) {</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-        return this.adoptItemOrUseCache(aItem, !!this.mOfflineStorage, aListener);</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-    },</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineminus">-    adoptItemOrUseCache: function adoptItemOrUseCache(aItem, useCache, aListener) {</span>
<a href="#l4.16"></a><span id="l4.16">         cal.LOG(&quot;[calGoogleCalendar] Adding item &quot; + aItem.title);</span>
<a href="#l4.17"></a><span id="l4.17"> </span>
<a href="#l4.18"></a><span id="l4.18">         try {</span>
<a href="#l4.19"></a><span id="l4.19">             // Check if calendar is readonly</span>
<a href="#l4.20"></a><span id="l4.20">             if (this.readOnly) {</span>
<a href="#l4.21"></a><span id="l4.21">                 throw new Components.Exception(&quot;&quot;,</span>
<a href="#l4.22"></a><span id="l4.22">                                                Components.interfaces.calIErrors.CAL_IS_READONLY);</span>
<a href="#l4.23"></a><span id="l4.23">             }</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineat">@@ -322,17 +318,16 @@ calGoogleCalendar.prototype = {</span>
<a href="#l4.25"></a><span id="l4.25">                                           this.session.fullName);</span>
<a href="#l4.26"></a><span id="l4.26"> </span>
<a href="#l4.27"></a><span id="l4.27">             request.type = request.ADD;</span>
<a href="#l4.28"></a><span id="l4.28">             request.uri = this.fullUri.spec;</span>
<a href="#l4.29"></a><span id="l4.29">             request.setUploadData(&quot;application/atom+xml; charset=UTF-8&quot;, cal.xml.serializeDOM(xmlEntry));</span>
<a href="#l4.30"></a><span id="l4.30">             request.operationListener = aListener;</span>
<a href="#l4.31"></a><span id="l4.31">             request.calendar = this;</span>
<a href="#l4.32"></a><span id="l4.32">             request.newItem = aItem;</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineminus">-            request.useCache = useCache;</span>
<a href="#l4.34"></a><span id="l4.34">             request.responseListener = { onResult: this.addItem_response.bind(this) };</span>
<a href="#l4.35"></a><span id="l4.35">             request.addQueryParameter(&quot;ctz&quot;, calendarDefaultTimezone().tzid);</span>
<a href="#l4.36"></a><span id="l4.36"> </span>
<a href="#l4.37"></a><span id="l4.37">             this.session.asyncItemRequest(request);</span>
<a href="#l4.38"></a><span id="l4.38">             return request;</span>
<a href="#l4.39"></a><span id="l4.39">         } catch (e) {</span>
<a href="#l4.40"></a><span id="l4.40">             cal.LOG(&quot;[calGoogleCalendar] adoptItem failed before request &quot; + aItem.title + &quot;\n:&quot; + e);</span>
<a href="#l4.41"></a><span id="l4.41">             if (e.result == Components.interfaces.calIErrors.CAL_IS_READONLY) {</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineat">@@ -349,57 +344,20 @@ calGoogleCalendar.prototype = {</span>
<a href="#l4.43"></a><span id="l4.43">                                          e.message);</span>
<a href="#l4.44"></a><span id="l4.44">         }</span>
<a href="#l4.45"></a><span id="l4.45">         return null;</span>
<a href="#l4.46"></a><span id="l4.46">     },</span>
<a href="#l4.47"></a><span id="l4.47"> </span>
<a href="#l4.48"></a><span id="l4.48">     addItem: function cGC_addItem(aItem, aListener) {</span>
<a href="#l4.49"></a><span id="l4.49">         // Google assigns an ID to every event added. Any id set here or in</span>
<a href="#l4.50"></a><span id="l4.50">         // adoptItem will be overridden.</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineminus">-        return this.addItemOrUseCache(aItem, !!this.mOfflineStorage, aListener);</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineminus">-    },</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineminus">-</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineminus">-    addItemOrUseCache: function addItemOrUseCache(aItem, useCache, aListener) {</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineminus">-        return this.adoptItemOrUseCache(aItem.clone(), useCache, aListener);</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineplus">+        return this.adoptItem(aItem.clone(), aListener);</span>
<a href="#l4.57"></a><span id="l4.57">     },</span>
<a href="#l4.58"></a><span id="l4.58"> </span>
<a href="#l4.59"></a><span id="l4.59">     modifyItem: function cGC_modifyItem(aNewItem, aOldItem, aListener) {</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineminus">-        if (this.mOfflineStorage) {</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineminus">-            return this.modifyItemOrUseCache(aNewItem, aOldItem, true, aListener);</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineminus">-        } else {</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineminus">-            return this.doModifyItem(aNewItem, aOldItem, false, aListener);</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineminus">-        }</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineminus">-    },</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineminus">-</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineminus">-    modifyItemOrUseCache: function modifyItemOrUseCache(aNewItem, aOldItem, useCache, aListener) {</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineminus">-        let thisCalendar = this;</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineminus">-        let storage = this.mOfflineStorage.QueryInterface(Components.interfaces.calIOfflineStorage);</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineminus">-        let modifyOfflineListener = {</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineminus">-            onGetResult: function(calendar, status, itemType, detail, count, items) {},</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineminus">-            onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineminus">-                storage.modifyOfflineItem(detail, aListener);</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineminus">-            }</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineminus">-        };</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineminus">-</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineminus">-        let offlineFlagListener = {</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineminus">-            onGetResult: function(calendar, status, itemType, detail, count, items) {},</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineminus">-            onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineminus">-                let offline_flag = detail;</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineminus">-                if ((offline_flag == cICL.OFFLINE_FLAG_CREATED_RECORD ||</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineminus">-                     offline_flag == cICL.OFFLINE_FLAG_MODIFIED_RECORD) &amp;&amp; useCache) {</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineminus">-                    storage.modifyItem(aNewItem, aOldItem, modifyOfflineListener);</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineminus">-                } else {</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineminus">-                    thisCalendar.doModifyItem(aNewItem, aOldItem, useCache, aListener, false);</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineminus">-                }</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineminus">-            }</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineminus">-        };</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineminus">-        storage.getItemOfflineFlag(aOldItem, offlineFlagListener);</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineminus">-    },</span>
<a href="#l4.91"></a><span id="l4.91" class="difflineminus">-</span>
<a href="#l4.92"></a><span id="l4.92" class="difflineminus">-    doModifyItem: function doModifyItem(aNewItem, aOldItem, useCache, aListener) {</span>
<a href="#l4.93"></a><span id="l4.93">         cal.LOG(&quot;[calGoogleCalendar] Modifying item &quot; + aOldItem.title);</span>
<a href="#l4.94"></a><span id="l4.94"> </span>
<a href="#l4.95"></a><span id="l4.95">         try {</span>
<a href="#l4.96"></a><span id="l4.96">             if (this.readOnly) {</span>
<a href="#l4.97"></a><span id="l4.97">                 throw new Components.Exception(&quot;&quot;,</span>
<a href="#l4.98"></a><span id="l4.98">                                                Components.interfaces.calIErrors.CAL_IS_READONLY);</span>
<a href="#l4.99"></a><span id="l4.99">             }</span>
<a href="#l4.100"></a><span id="l4.100"> </span>
<a href="#l4.101"></a><span id="l4.101" class="difflineat">@@ -449,17 +407,16 @@ calGoogleCalendar.prototype = {</span>
<a href="#l4.102"></a><span id="l4.102">             }</span>
<a href="#l4.103"></a><span id="l4.103"> </span>
<a href="#l4.104"></a><span id="l4.104">             request.setUploadData(&quot;application/atom+xml; charset=UTF-8&quot;, cal.xml.serializeDOM(xmlEntry));</span>
<a href="#l4.105"></a><span id="l4.105">             request.responseListener = { onResult: this.modifyItem_response.bind(this) };</span>
<a href="#l4.106"></a><span id="l4.106">             request.operationListener = aListener;</span>
<a href="#l4.107"></a><span id="l4.107">             request.newItem = newItem;</span>
<a href="#l4.108"></a><span id="l4.108">             request.oldItem = aOldItem;</span>
<a href="#l4.109"></a><span id="l4.109">             request.calendar = this;</span>
<a href="#l4.110"></a><span id="l4.110" class="difflineminus">-            request.useCache = useCache;</span>
<a href="#l4.111"></a><span id="l4.111">             request.addQueryParameter(&quot;ctz&quot;, calendarDefaultTimezone().tzid);</span>
<a href="#l4.112"></a><span id="l4.112"> </span>
<a href="#l4.113"></a><span id="l4.113">             this.session.asyncItemRequest(request);</span>
<a href="#l4.114"></a><span id="l4.114">             return request;</span>
<a href="#l4.115"></a><span id="l4.115">         } catch (e) {</span>
<a href="#l4.116"></a><span id="l4.116">             cal.LOG(&quot;[calGoogleCalendar] modifyItem failed before request &quot; +</span>
<a href="#l4.117"></a><span id="l4.117">                     aNewItem.title + &quot;(&quot; + aNewItem.id + &quot;):\n&quot; + e);</span>
<a href="#l4.118"></a><span id="l4.118"> </span>
<a href="#l4.119"></a><span id="l4.119" class="difflineat">@@ -475,52 +432,16 @@ calGoogleCalendar.prototype = {</span>
<a href="#l4.120"></a><span id="l4.120">                                          Components.interfaces.calIOperationListener.MODIFY,</span>
<a href="#l4.121"></a><span id="l4.121">                                          null,</span>
<a href="#l4.122"></a><span id="l4.122">                                          e.message);</span>
<a href="#l4.123"></a><span id="l4.123">         }</span>
<a href="#l4.124"></a><span id="l4.124">         return null;</span>
<a href="#l4.125"></a><span id="l4.125">     },</span>
<a href="#l4.126"></a><span id="l4.126"> </span>
<a href="#l4.127"></a><span id="l4.127">     deleteItem: function cGC_deleteItem(aItem, aListener) {</span>
<a href="#l4.128"></a><span id="l4.128" class="difflineminus">-        if (this.mOfflineStorage) {</span>
<a href="#l4.129"></a><span id="l4.129" class="difflineminus">-            return this.deleteItemOrUseCache(aItem, true, aListener);</span>
<a href="#l4.130"></a><span id="l4.130" class="difflineminus">-        } else {</span>
<a href="#l4.131"></a><span id="l4.131" class="difflineminus">-            return this.doDeleteItem(aItem, false, aListener);</span>
<a href="#l4.132"></a><span id="l4.132" class="difflineminus">-        }</span>
<a href="#l4.133"></a><span id="l4.133" class="difflineminus">-    },</span>
<a href="#l4.134"></a><span id="l4.134" class="difflineminus">-</span>
<a href="#l4.135"></a><span id="l4.135" class="difflineminus">-    deleteItemOrUseCache: function deleteItemOrUseCache(aItem, useCache, aListener) {</span>
<a href="#l4.136"></a><span id="l4.136" class="difflineminus">-        let thisCalendar = this;</span>
<a href="#l4.137"></a><span id="l4.137" class="difflineminus">-        let storage = this.mOfflineStorage.QueryInterface(Components.interfaces.calIOfflineStorage);</span>
<a href="#l4.138"></a><span id="l4.138" class="difflineminus">-        let deleteOfflineListener = {</span>
<a href="#l4.139"></a><span id="l4.139" class="difflineminus">-            onGetResult: function(calendar, status, itemType, detail, count, items) {},</span>
<a href="#l4.140"></a><span id="l4.140" class="difflineminus">-            onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l4.141"></a><span id="l4.141" class="difflineminus">-                if (aListener) {</span>
<a href="#l4.142"></a><span id="l4.142" class="difflineminus">-                    aListener.onOperationComplete(calendar, status, opType, aItem.id, aItem);</span>
<a href="#l4.143"></a><span id="l4.143" class="difflineminus">-                }</span>
<a href="#l4.144"></a><span id="l4.144" class="difflineminus">-            }</span>
<a href="#l4.145"></a><span id="l4.145" class="difflineminus">-        };</span>
<a href="#l4.146"></a><span id="l4.146" class="difflineminus">-</span>
<a href="#l4.147"></a><span id="l4.147" class="difflineminus">-        let offlineFlagListener = {</span>
<a href="#l4.148"></a><span id="l4.148" class="difflineminus">-            onGetResult: function(calendar, status, itemType, detail, count, items) {},</span>
<a href="#l4.149"></a><span id="l4.149" class="difflineminus">-            onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l4.150"></a><span id="l4.150" class="difflineminus">-                let offline_flag = detail;</span>
<a href="#l4.151"></a><span id="l4.151" class="difflineminus">-                if ((offline_flag == cICL.OFFLINE_FLAG_CREATED_RECORD ||</span>
<a href="#l4.152"></a><span id="l4.152" class="difflineminus">-                     offline_flag == cICL.OFFLINE_FLAG_MODIFIED_RECORD) &amp;&amp; useCache) {</span>
<a href="#l4.153"></a><span id="l4.153" class="difflineminus">-                    /* We do not delete the item from the cache, but mark it deleted */</span>
<a href="#l4.154"></a><span id="l4.154" class="difflineminus">-                    storage.deleteOfflineItem(aItem, aListener);</span>
<a href="#l4.155"></a><span id="l4.155" class="difflineminus">-                } else {</span>
<a href="#l4.156"></a><span id="l4.156" class="difflineminus">-                    thisCalendar.doDeleteItem(aItem, useCache, aListener);</span>
<a href="#l4.157"></a><span id="l4.157" class="difflineminus">-                }</span>
<a href="#l4.158"></a><span id="l4.158" class="difflineminus">-            }</span>
<a href="#l4.159"></a><span id="l4.159" class="difflineminus">-        };</span>
<a href="#l4.160"></a><span id="l4.160" class="difflineminus">-        storage.getItemOfflineFlag(aItem, offlineFlagListener);</span>
<a href="#l4.161"></a><span id="l4.161" class="difflineminus">-    },</span>
<a href="#l4.162"></a><span id="l4.162" class="difflineminus">-</span>
<a href="#l4.163"></a><span id="l4.163" class="difflineminus">-    doDeleteItem: function doDeleteItem(aItem, useCache, aListener) {</span>
<a href="#l4.164"></a><span id="l4.164">         cal.LOG(&quot;[calGoogleCalendar] Deleting item &quot; + aItem.title + &quot;(&quot; + aItem.id + &quot;)&quot;);</span>
<a href="#l4.165"></a><span id="l4.165"> </span>
<a href="#l4.166"></a><span id="l4.166">         try {</span>
<a href="#l4.167"></a><span id="l4.167">             if (this.readOnly) {</span>
<a href="#l4.168"></a><span id="l4.168">                 throw new Components.Exception(&quot;&quot;,</span>
<a href="#l4.169"></a><span id="l4.169">                                                Components.interfaces.calIErrors.CAL_IS_READONLY);</span>
<a href="#l4.170"></a><span id="l4.170">             }</span>
<a href="#l4.171"></a><span id="l4.171"> </span>
<a href="#l4.172"></a><span id="l4.172" class="difflineat">@@ -532,17 +453,16 @@ calGoogleCalendar.prototype = {</span>
<a href="#l4.173"></a><span id="l4.173">             // item XML data on delete, and we need to call the observers.</span>
<a href="#l4.174"></a><span id="l4.174">             let request = new calGoogleRequest(this);</span>
<a href="#l4.175"></a><span id="l4.175"> </span>
<a href="#l4.176"></a><span id="l4.176">             request.type = request.DELETE;</span>
<a href="#l4.177"></a><span id="l4.177">             request.uri = getItemEditURI(aItem);</span>
<a href="#l4.178"></a><span id="l4.178">             request.operationListener = aListener;</span>
<a href="#l4.179"></a><span id="l4.179">             request.oldItem = aItem;</span>
<a href="#l4.180"></a><span id="l4.180">             request.calendar = this;</span>
<a href="#l4.181"></a><span id="l4.181" class="difflineminus">-            request.useCache = useCache;</span>
<a href="#l4.182"></a><span id="l4.182">             request.responseListener = { onResult: this.deleteItem_response.bind(this) };</span>
<a href="#l4.183"></a><span id="l4.183"> </span>
<a href="#l4.184"></a><span id="l4.184">             this.session.asyncItemRequest(request);</span>
<a href="#l4.185"></a><span id="l4.185">             return request;</span>
<a href="#l4.186"></a><span id="l4.186">         } catch (e) {</span>
<a href="#l4.187"></a><span id="l4.187">             cal.LOG(&quot;[calGoogleCalendar] deleteItem failed before request for &quot; +</span>
<a href="#l4.188"></a><span id="l4.188">                     aItem.title + &quot;(&quot; + aItem.id + &quot;):\n&quot; + e);</span>
<a href="#l4.189"></a><span id="l4.189"> </span>
<a href="#l4.190"></a><span id="l4.190" class="difflineat">@@ -697,72 +617,31 @@ calGoogleCalendar.prototype = {</span>
<a href="#l4.191"></a><span id="l4.191">                 // called again</span>
<a href="#l4.192"></a><span id="l4.192">                 return;</span>
<a href="#l4.193"></a><span id="l4.193">             }</span>
<a href="#l4.194"></a><span id="l4.194">         } catch (exp) {</span>
<a href="#l4.195"></a><span id="l4.195">             item = null;</span>
<a href="#l4.196"></a><span id="l4.196">             e = exp;</span>
<a href="#l4.197"></a><span id="l4.197">         }</span>
<a href="#l4.198"></a><span id="l4.198"> </span>
<a href="#l4.199"></a><span id="l4.199" class="difflineminus">-        // Now we can do some processing on it. If the cache is used, then we</span>
<a href="#l4.200"></a><span id="l4.200" class="difflineminus">-        // ultimately need to add the item to the cache, either as offline item</span>
<a href="#l4.201"></a><span id="l4.201" class="difflineminus">-        // or normal item. We will also have to notify the listener and the</span>
<a href="#l4.202"></a><span id="l4.202" class="difflineminus">-        // observers sooner or later.</span>
<a href="#l4.203"></a><span id="l4.203" class="difflineminus">-        if (aOperation.useCache &amp;&amp; this.mOfflineStorage &amp;&amp; (!e || isCacheException(e))) {</span>
<a href="#l4.204"></a><span id="l4.204" class="difflineminus">-            let listener;</span>
<a href="#l4.205"></a><span id="l4.205" class="difflineminus">-            if (item) {</span>
<a href="#l4.206"></a><span id="l4.206" class="difflineminus">-                // If we have an item, then we can directly notify the target</span>
<a href="#l4.207"></a><span id="l4.207" class="difflineminus">-                // listener</span>
<a href="#l4.208"></a><span id="l4.208" class="difflineminus">-                listener = aOperation.operationListener;</span>
<a href="#l4.209"></a><span id="l4.209" class="difflineminus">-                cal.LOG(&quot;[calGoogleCalendar] Adding item &quot; + aOperation.newItem.title + &quot; successful&quot;);</span>
<a href="#l4.210"></a><span id="l4.210" class="difflineminus">-            } else {</span>
<a href="#l4.211"></a><span id="l4.211" class="difflineminus">-                // Otherwise we create an intermediate listener that also sets</span>
<a href="#l4.212"></a><span id="l4.212" class="difflineminus">-                // the offline flag</span>
<a href="#l4.213"></a><span id="l4.213" class="difflineminus">-                let storage = this.mOfflineStorage.QueryInterface(Components.interfaces.calIOfflineStorage);</span>
<a href="#l4.214"></a><span id="l4.214" class="difflineminus">-                let self = this;</span>
<a href="#l4.215"></a><span id="l4.215" class="difflineminus">-                item = aOperation.newItem;</span>
<a href="#l4.216"></a><span id="l4.216" class="difflineminus">-                listener = {</span>
<a href="#l4.217"></a><span id="l4.217" class="difflineminus">-                    onGetResult: function(calendar, status, itemType, detail, count, items) {},</span>
<a href="#l4.218"></a><span id="l4.218" class="difflineminus">-                    onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l4.219"></a><span id="l4.219" class="difflineminus">-                        if (Components.isSuccessCode(status)) {</span>
<a href="#l4.220"></a><span id="l4.220" class="difflineminus">-                            // On success, the addOfflineItem call will notify the listener</span>
<a href="#l4.221"></a><span id="l4.221" class="difflineminus">-                            cal.LOG(&quot;[calGoogleCalendar] Adding item &quot; + aOperation.newItem.title + &quot; failed, but the operation will be retried (status: &quot; + status + &quot;, exception: &quot; + e + &quot;)&quot;);</span>
<a href="#l4.222"></a><span id="l4.222" class="difflineminus">-                            storage.addOfflineItem(detail, aOperation.operationListener);</span>
<a href="#l4.223"></a><span id="l4.223" class="difflineminus">-                            self.mObservers.notify(&quot;onAddItem&quot;, [aOperation.newItem]);</span>
<a href="#l4.224"></a><span id="l4.224" class="difflineminus">-                        } else if (aOperation.operationListener) {</span>
<a href="#l4.225"></a><span id="l4.225" class="difflineminus">-                            cal.ERROR(&quot;[calGoogleCalendar] Could not add item &quot; + aOperation.newItem.title + &quot; to the offline cache:&quot; +</span>
<a href="#l4.226"></a><span id="l4.226" class="difflineminus">-                                      new Components.Exception(detail, status));</span>
<a href="#l4.227"></a><span id="l4.227" class="difflineminus">-                            // Otherwise we have to do it ourselves.</span>
<a href="#l4.228"></a><span id="l4.228" class="difflineminus">-                            self.notifyOperationComplete(aOperation.operationListener,</span>
<a href="#l4.229"></a><span id="l4.229" class="difflineminus">-                                                         status,</span>
<a href="#l4.230"></a><span id="l4.230" class="difflineminus">-                                                         Components.interfaces.calIOperationListener.ADD,</span>
<a href="#l4.231"></a><span id="l4.231" class="difflineminus">-                                                         null,</span>
<a href="#l4.232"></a><span id="l4.232" class="difflineminus">-                                                         null);</span>
<a href="#l4.233"></a><span id="l4.233" class="difflineminus">-                        }</span>
<a href="#l4.234"></a><span id="l4.234" class="difflineminus">-                    }</span>
<a href="#l4.235"></a><span id="l4.235" class="difflineminus">-                };</span>
<a href="#l4.236"></a><span id="l4.236" class="difflineminus">-            }</span>
<a href="#l4.237"></a><span id="l4.237" class="difflineplus">+        let resultCode;</span>
<a href="#l4.238"></a><span id="l4.238" class="difflineplus">+        if (item) {</span>
<a href="#l4.239"></a><span id="l4.239" class="difflineplus">+            cal.LOG(&quot;[calGoogleCalendar] Adding item &quot; + item.title + &quot; successful&quot;);</span>
<a href="#l4.240"></a><span id="l4.240" class="difflineplus">+            this.mObservers.notify(&quot;onAddItem&quot;, [item]);</span>
<a href="#l4.241"></a><span id="l4.241" class="difflineplus">+            resultCode = Components.results.NS_OK;</span>
<a href="#l4.242"></a><span id="l4.242" class="difflineplus">+        } else {</span>
<a href="#l4.243"></a><span id="l4.243" class="difflineplus">+            cal.LOG(&quot;[calGoogleCalendar] Adding item &quot; + aOperation.newItem.id + &quot; failed, status &quot; + aOperation.status + &quot;, Exception: &quot; + e);</span>
<a href="#l4.244"></a><span id="l4.244" class="difflineplus">+            resultCode = isCacheException(e) ? Components.results.NS_ERROR_NOT_AVAILABLE : e.result || Components.results.NS_ERROR_FAILURE;</span>
<a href="#l4.245"></a><span id="l4.245" class="difflineplus">+        }</span>
<a href="#l4.246"></a><span id="l4.246"> </span>
<a href="#l4.247"></a><span id="l4.247" class="difflineminus">-            // Now send the item to the offline storage</span>
<a href="#l4.248"></a><span id="l4.248" class="difflineminus">-            this.mOfflineStorage.adoptItem(item, listener);</span>
<a href="#l4.249"></a><span id="l4.249" class="difflineminus">-        } else {</span>
<a href="#l4.250"></a><span id="l4.250" class="difflineminus">-            // When not using the cache, we merely have to notify onAddItem and</span>
<a href="#l4.251"></a><span id="l4.251" class="difflineminus">-            // tell the operation listener we are done (error or not)</span>
<a href="#l4.252"></a><span id="l4.252" class="difflineminus">-            if (item) {</span>
<a href="#l4.253"></a><span id="l4.253" class="difflineminus">-                cal.LOG(&quot;[calGoogleCalendar] Adding item &quot; + item.title + &quot; successful&quot;);</span>
<a href="#l4.254"></a><span id="l4.254" class="difflineminus">-                this.mObservers.notify(&quot;onAddItem&quot;, [item]);</span>
<a href="#l4.255"></a><span id="l4.255" class="difflineminus">-            } else {</span>
<a href="#l4.256"></a><span id="l4.256" class="difflineminus">-                cal.LOG(&quot;[calGoogleCalendar] Adding item &quot; + aOperation.newItem.id + &quot; failed, status &quot; + aOperation.status + &quot;, Exception: &quot; + e);</span>
<a href="#l4.257"></a><span id="l4.257" class="difflineminus">-            }</span>
<a href="#l4.258"></a><span id="l4.258" class="difflineminus">-            this.notifyOperationComplete(aOperation.operationListener,</span>
<a href="#l4.259"></a><span id="l4.259" class="difflineminus">-                                         (item ? Components.results.NS_OK : e.result),</span>
<a href="#l4.260"></a><span id="l4.260" class="difflineminus">-                                         Components.interfaces.calIOperationListener.ADD,</span>
<a href="#l4.261"></a><span id="l4.261" class="difflineminus">-                                         (item ? item.id : null),</span>
<a href="#l4.262"></a><span id="l4.262" class="difflineminus">-                                         (item ? item : e.message));</span>
<a href="#l4.263"></a><span id="l4.263" class="difflineminus">-        }</span>
<a href="#l4.264"></a><span id="l4.264" class="difflineplus">+        this.notifyOperationComplete(aOperation.operationListener,</span>
<a href="#l4.265"></a><span id="l4.265" class="difflineplus">+                                     resultCode,</span>
<a href="#l4.266"></a><span id="l4.266" class="difflineplus">+                                     Components.interfaces.calIOperationListener.ADD,</span>
<a href="#l4.267"></a><span id="l4.267" class="difflineplus">+                                     (item ? item.id : null),</span>
<a href="#l4.268"></a><span id="l4.268" class="difflineplus">+                                     (item ? item : e.message));</span>
<a href="#l4.269"></a><span id="l4.269">     },</span>
<a href="#l4.270"></a><span id="l4.270"> </span>
<a href="#l4.271"></a><span id="l4.271">     /**</span>
<a href="#l4.272"></a><span id="l4.272">      * modifyItem_response</span>
<a href="#l4.273"></a><span id="l4.273">      * Response function, called by the session object when an item was modified</span>
<a href="#l4.274"></a><span id="l4.274">      *</span>
<a href="#l4.275"></a><span id="l4.275">      * @param aOperation The calIGoogleRequest processing the request</span>
<a href="#l4.276"></a><span id="l4.276">      * @param aData      In case of an error, this is the error string, otherwise</span>
<a href="#l4.277"></a><span id="l4.277" class="difflineat">@@ -793,69 +672,30 @@ calGoogleCalendar.prototype = {</span>
<a href="#l4.278"></a><span id="l4.278">                 // called again</span>
<a href="#l4.279"></a><span id="l4.279">                 return;</span>
<a href="#l4.280"></a><span id="l4.280">             }</span>
<a href="#l4.281"></a><span id="l4.281">         } catch (exp) {</span>
<a href="#l4.282"></a><span id="l4.282">             newItem = null;</span>
<a href="#l4.283"></a><span id="l4.283">             e = exp;</span>
<a href="#l4.284"></a><span id="l4.284">         }</span>
<a href="#l4.285"></a><span id="l4.285"> </span>
<a href="#l4.286"></a><span id="l4.286" class="difflineminus">-        // Now we can do some processing on it. If the cache is used, then we</span>
<a href="#l4.287"></a><span id="l4.287" class="difflineminus">-        // ultimately need to modify the item in the cache, either as offline item</span>
<a href="#l4.288"></a><span id="l4.288" class="difflineminus">-        // or normal item. We will also have to notify the listener and the</span>
<a href="#l4.289"></a><span id="l4.289" class="difflineminus">-        // observers sooner or later.</span>
<a href="#l4.290"></a><span id="l4.290" class="difflineminus">-        if (aOperation.useCache &amp;&amp; this.mOfflineStorage &amp;&amp; (!e || isCacheException(e))) {</span>
<a href="#l4.291"></a><span id="l4.291" class="difflineminus">-            let listener;</span>
<a href="#l4.292"></a><span id="l4.292" class="difflineminus">-            if (newItem) {</span>
<a href="#l4.293"></a><span id="l4.293" class="difflineminus">-                // If we have an item, then we can directly notify the target</span>
<a href="#l4.294"></a><span id="l4.294" class="difflineminus">-                // listener</span>
<a href="#l4.295"></a><span id="l4.295" class="difflineminus">-                listener = aOperation.operationListener;</span>
<a href="#l4.296"></a><span id="l4.296" class="difflineminus">-                cal.LOG(&quot;[calGoogleCalendar] Modifying item &quot; + aOperation.oldItem.id + &quot; successful&quot;);</span>
<a href="#l4.297"></a><span id="l4.297" class="difflineminus">-            } else {</span>
<a href="#l4.298"></a><span id="l4.298" class="difflineminus">-                let storage = this.mOfflineStorage.QueryInterface(Components.interfaces.calIOfflineStorage);</span>
<a href="#l4.299"></a><span id="l4.299" class="difflineminus">-                newItem = aOperation.newItem;</span>
<a href="#l4.300"></a><span id="l4.300" class="difflineminus">-                listener = {</span>
<a href="#l4.301"></a><span id="l4.301" class="difflineminus">-                    onGetResult: function(calendar, status, itemType, detail, count, items) {},</span>
<a href="#l4.302"></a><span id="l4.302" class="difflineminus">-                    onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l4.303"></a><span id="l4.303" class="difflineminus">-                        if (Components.isSuccessCode(status)) {</span>
<a href="#l4.304"></a><span id="l4.304" class="difflineminus">-                            cal.LOG(&quot;[calGoogleCalendar] Modifying item &quot; + aOperation.oldItem.id + &quot; failed, but the operation will be retried (status: &quot; + status + &quot;, exception: &quot; + e + &quot;)&quot;);</span>
<a href="#l4.305"></a><span id="l4.305" class="difflineminus">-                            // On success, the modifyOfflineItem call will notify the listener</span>
<a href="#l4.306"></a><span id="l4.306" class="difflineminus">-                            storage.modifyOfflineItem(detail, aOperation.operationListener);</span>
<a href="#l4.307"></a><span id="l4.307" class="difflineminus">-                            notifyObserver(newItem, aOperation.oldItem);</span>
<a href="#l4.308"></a><span id="l4.308" class="difflineminus">-                        } else if (aOperation.operationListener) {</span>
<a href="#l4.309"></a><span id="l4.309" class="difflineminus">-                            cal.ERROR(&quot;[calGoogleCalendar] Could not modify item &quot; + aOperation.newItem.id + &quot; in the offline cache:&quot; +</span>
<a href="#l4.310"></a><span id="l4.310" class="difflineminus">-                                      new Components.Exception(detail, status));</span>
<a href="#l4.311"></a><span id="l4.311" class="difflineminus">-                            // Otherwise we have to do it ourselves.</span>
<a href="#l4.312"></a><span id="l4.312" class="difflineminus">-                            self.notifyOperationComplete(aOperation.operationListener,</span>
<a href="#l4.313"></a><span id="l4.313" class="difflineminus">-                                                         status,</span>
<a href="#l4.314"></a><span id="l4.314" class="difflineminus">-                                                         Components.interfaces.calIOperationListener.MODIFY,</span>
<a href="#l4.315"></a><span id="l4.315" class="difflineminus">-                                                         null,</span>
<a href="#l4.316"></a><span id="l4.316" class="difflineminus">-                                                         null);</span>
<a href="#l4.317"></a><span id="l4.317" class="difflineminus">-                        }</span>
<a href="#l4.318"></a><span id="l4.318" class="difflineminus">-                    }</span>
<a href="#l4.319"></a><span id="l4.319" class="difflineminus">-                };</span>
<a href="#l4.320"></a><span id="l4.320" class="difflineminus">-            }</span>
<a href="#l4.321"></a><span id="l4.321" class="difflineminus">-</span>
<a href="#l4.322"></a><span id="l4.322" class="difflineminus">-            // Now send the item to the offline storage</span>
<a href="#l4.323"></a><span id="l4.323" class="difflineminus">-            this.mOfflineStorage.modifyItem(newItem, aOperation.oldItem, listener);</span>
<a href="#l4.324"></a><span id="l4.324" class="difflineplus">+        let resultCode;</span>
<a href="#l4.325"></a><span id="l4.325" class="difflineplus">+        if (newItem) {</span>
<a href="#l4.326"></a><span id="l4.326" class="difflineplus">+            cal.LOG(&quot;[calGoogleCalendar] Modifying item &quot; + newItem.id + &quot; successful&quot;);</span>
<a href="#l4.327"></a><span id="l4.327" class="difflineplus">+            notifyObserver(newItem, aOperation.oldItem);</span>
<a href="#l4.328"></a><span id="l4.328" class="difflineplus">+            resultCode = Components.results.NS_OK;</span>
<a href="#l4.329"></a><span id="l4.329">         } else {</span>
<a href="#l4.330"></a><span id="l4.330" class="difflineminus">-            // When not using the cache, we merely have to notify onModifyItem and</span>
<a href="#l4.331"></a><span id="l4.331" class="difflineminus">-            // tell the operation listener we are done (error or not)</span>
<a href="#l4.332"></a><span id="l4.332" class="difflineminus">-            notifyObserver(newItem, aOperation.oldItem);</span>
<a href="#l4.333"></a><span id="l4.333" class="difflineminus">-            if (newItem) {</span>
<a href="#l4.334"></a><span id="l4.334" class="difflineminus">-                cal.LOG(&quot;[calGoogleCalendar] Modifying item &quot; + newItem.id + &quot; successful&quot;);</span>
<a href="#l4.335"></a><span id="l4.335" class="difflineminus">-            } else {</span>
<a href="#l4.336"></a><span id="l4.336" class="difflineminus">-                cal.LOG(&quot;[calGoogleCalendar] Modifying item &quot; + aOperation.oldItem.id + &quot; failed, status &quot; + aOperation.status + &quot;, Exception: &quot; + e);</span>
<a href="#l4.337"></a><span id="l4.337" class="difflineminus">-            }</span>
<a href="#l4.338"></a><span id="l4.338" class="difflineminus">-            this.notifyOperationComplete(aOperation.operationListener,</span>
<a href="#l4.339"></a><span id="l4.339" class="difflineminus">-                                         (newItem ? Components.results.NS_OK : e.result || Components.results.NS_ERROR_FAILURE),</span>
<a href="#l4.340"></a><span id="l4.340" class="difflineminus">-                                         Components.interfaces.calIOperationListener.MODIFY,</span>
<a href="#l4.341"></a><span id="l4.341" class="difflineminus">-                                         (newItem ? newItem.id : null),</span>
<a href="#l4.342"></a><span id="l4.342" class="difflineminus">-                                         (newItem ? newItem : e.message));</span>
<a href="#l4.343"></a><span id="l4.343" class="difflineplus">+            cal.LOG(&quot;[calGoogleCalendar] Modifying item &quot; + aOperation.oldItem.id + &quot; failed, status &quot; + aOperation.status + &quot;, Exception: &quot; + e);</span>
<a href="#l4.344"></a><span id="l4.344" class="difflineplus">+            resultCode = isCacheException(e) ? Components.results.NS_ERROR_NOT_AVAILABLE : e.result || Components.results.NS_ERROR_FAILURE;</span>
<a href="#l4.345"></a><span id="l4.345">         }</span>
<a href="#l4.346"></a><span id="l4.346" class="difflineplus">+        this.notifyOperationComplete(aOperation.operationListener,</span>
<a href="#l4.347"></a><span id="l4.347" class="difflineplus">+                                     resultCode,</span>
<a href="#l4.348"></a><span id="l4.348" class="difflineplus">+                                     Components.interfaces.calIOperationListener.MODIFY,</span>
<a href="#l4.349"></a><span id="l4.349" class="difflineplus">+                                     (newItem ? newItem.id : null),</span>
<a href="#l4.350"></a><span id="l4.350" class="difflineplus">+                                     (newItem ? newItem : e.message));</span>
<a href="#l4.351"></a><span id="l4.351">     },</span>
<a href="#l4.352"></a><span id="l4.352"> </span>
<a href="#l4.353"></a><span id="l4.353">     /**</span>
<a href="#l4.354"></a><span id="l4.354">      * deleteItem_response</span>
<a href="#l4.355"></a><span id="l4.355">      * Response function, called by the session object when an Item was deleted</span>
<a href="#l4.356"></a><span id="l4.356">      *</span>
<a href="#l4.357"></a><span id="l4.357">      * @param aOperation The calIGoogleRequest processing the request</span>
<a href="#l4.358"></a><span id="l4.358">      * @param aData      In case of an error, this is the error string, otherwise</span>
<a href="#l4.359"></a><span id="l4.359" class="difflineat">@@ -872,57 +712,30 @@ calGoogleCalendar.prototype = {</span>
<a href="#l4.360"></a><span id="l4.360">                 // called again</span>
<a href="#l4.361"></a><span id="l4.361">                 return;</span>
<a href="#l4.362"></a><span id="l4.362">             }</span>
<a href="#l4.363"></a><span id="l4.363">         } catch (exp) {</span>
<a href="#l4.364"></a><span id="l4.364">             item = null;</span>
<a href="#l4.365"></a><span id="l4.365">             e = exp;</span>
<a href="#l4.366"></a><span id="l4.366">         }</span>
<a href="#l4.367"></a><span id="l4.367"> </span>
<a href="#l4.368"></a><span id="l4.368" class="difflineminus">-        if (aOperation.useCache &amp;&amp; this.mOfflineStorage &amp;&amp; (!e || isCacheException(e))) {</span>
<a href="#l4.369"></a><span id="l4.369" class="difflineminus">-            if (item) {</span>
<a href="#l4.370"></a><span id="l4.370" class="difflineminus">-                // If we have an item, then we can directly notify the target</span>
<a href="#l4.371"></a><span id="l4.371" class="difflineminus">-                // listener using the offline storage</span>
<a href="#l4.372"></a><span id="l4.372" class="difflineminus">-                cal.LOG(&quot;[calGoogleCalendar] Deleting item &quot; + aOperation.oldItem.id + &quot; successful&quot;);</span>
<a href="#l4.373"></a><span id="l4.373" class="difflineminus">-                this.mOfflineStorage.deleteItem(item, aOperation.operationListener);</span>
<a href="#l4.374"></a><span id="l4.374" class="difflineminus">-            } else {</span>
<a href="#l4.375"></a><span id="l4.375" class="difflineminus">-                // Otherwise we shouldn't remove it from the cache, but set the</span>
<a href="#l4.376"></a><span id="l4.376" class="difflineminus">-                // offline flag to mark it deleted</span>
<a href="#l4.377"></a><span id="l4.377" class="difflineminus">-                let self = this;</span>
<a href="#l4.378"></a><span id="l4.378" class="difflineminus">-                let offlineListener = {</span>
<a href="#l4.379"></a><span id="l4.379" class="difflineminus">-                    // We should not return a success code since the listeners can delete the physical item in case of success</span>
<a href="#l4.380"></a><span id="l4.380" class="difflineminus">-                    onGetResult: function(calendar, status, itemType, detail, count, items) {},</span>
<a href="#l4.381"></a><span id="l4.381" class="difflineminus">-                    onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l4.382"></a><span id="l4.382" class="difflineminus">-                        self.mObservers.notify(&quot;onDeleteItem&quot;, [aOperation.oldItem]);</span>
<a href="#l4.383"></a><span id="l4.383" class="difflineminus">-                        cal.LOG(&quot;[calGoogleCalendar] Deleting item &quot; + aOperation.oldItem.id + &quot; failed, but the operation will be retried&quot;);</span>
<a href="#l4.384"></a><span id="l4.384" class="difflineminus">-                        self.notifyOperationComplete(aOperation.operationListener,</span>
<a href="#l4.385"></a><span id="l4.385" class="difflineminus">-                                                     Components.results.NS_ERROR_NOT_AVAILABLE,</span>
<a href="#l4.386"></a><span id="l4.386" class="difflineminus">-                                                     Components.interfaces.calIOperationListener.GET,</span>
<a href="#l4.387"></a><span id="l4.387" class="difflineminus">-                                                     aOperation.oldItem.id,</span>
<a href="#l4.388"></a><span id="l4.388" class="difflineminus">-                                                     aOperation.oldItem);</span>
<a href="#l4.389"></a><span id="l4.389" class="difflineminus">-                    }</span>
<a href="#l4.390"></a><span id="l4.390" class="difflineminus">-                };</span>
<a href="#l4.391"></a><span id="l4.391" class="difflineminus">-                let storage = this.mOfflineStorage.QueryInterface(Components.interfaces.calIOfflineStorage);</span>
<a href="#l4.392"></a><span id="l4.392" class="difflineminus">-                storage.deleteOfflineItem(aOperation.oldItem, offlineListener);</span>
<a href="#l4.393"></a><span id="l4.393" class="difflineminus">-            }</span>
<a href="#l4.394"></a><span id="l4.394" class="difflineplus">+        let resultCode;</span>
<a href="#l4.395"></a><span id="l4.395" class="difflineplus">+        if (item) {</span>
<a href="#l4.396"></a><span id="l4.396" class="difflineplus">+            cal.LOG(&quot;[calGoogleCalendar] Deleting item &quot; + aOperation.oldItem.id + &quot; successful&quot;);</span>
<a href="#l4.397"></a><span id="l4.397" class="difflineplus">+            this.mObservers.notify(&quot;onDeleteItem&quot;, [item]);</span>
<a href="#l4.398"></a><span id="l4.398" class="difflineplus">+            resultCode = Components.results.NS_OK;</span>
<a href="#l4.399"></a><span id="l4.399">         } else {</span>
<a href="#l4.400"></a><span id="l4.400" class="difflineminus">-            // When not using the cache, we merely have to notify onDeleteItem and</span>
<a href="#l4.401"></a><span id="l4.401" class="difflineminus">-            // tell the operation listener we are done (error or not)</span>
<a href="#l4.402"></a><span id="l4.402" class="difflineminus">-            if (item) {</span>
<a href="#l4.403"></a><span id="l4.403" class="difflineminus">-                cal.LOG(&quot;[calGoogleCalendar] Deleting item &quot; + aOperation.oldItem.id + &quot; successful&quot;);</span>
<a href="#l4.404"></a><span id="l4.404" class="difflineminus">-                this.mObservers.notify(&quot;onDeleteItem&quot;, [item]);</span>
<a href="#l4.405"></a><span id="l4.405" class="difflineminus">-            } else {</span>
<a href="#l4.406"></a><span id="l4.406" class="difflineminus">-                cal.LOG(&quot;[calGoogleCalendar] Deleting item &quot; + aOperation.oldItem.id + &quot; failed, status &quot; + aOperation.status + &quot;, Exception: &quot; + e);</span>
<a href="#l4.407"></a><span id="l4.407" class="difflineminus">-            }</span>
<a href="#l4.408"></a><span id="l4.408" class="difflineminus">-            this.notifyOperationComplete(aOperation.operationListener,</span>
<a href="#l4.409"></a><span id="l4.409" class="difflineminus">-                                         (item ? Components.results.NS_OK : e.result || Components.results.NS_ERROR_FAILURE),</span>
<a href="#l4.410"></a><span id="l4.410" class="difflineminus">-                                         Components.interfaces.calIOperationListener.ADD,</span>
<a href="#l4.411"></a><span id="l4.411" class="difflineminus">-                                         (item ? item.id : null),</span>
<a href="#l4.412"></a><span id="l4.412" class="difflineminus">-                                         (item ? item : e.message));</span>
<a href="#l4.413"></a><span id="l4.413" class="difflineplus">+            cal.LOG(&quot;[calGoogleCalendar] Deleting item &quot; + aOperation.oldItem.id + &quot; failed, status &quot; + aOperation.status + &quot;, Exception: &quot; + e);</span>
<a href="#l4.414"></a><span id="l4.414" class="difflineplus">+            resultCode = isCacheException(e) ? Components.results.NS_ERROR_NOT_AVAILABLE : e.result || Components.results.NS_ERROR_FAILURE;</span>
<a href="#l4.415"></a><span id="l4.415">         }</span>
<a href="#l4.416"></a><span id="l4.416" class="difflineplus">+        this.notifyOperationComplete(aOperation.operationListener,</span>
<a href="#l4.417"></a><span id="l4.417" class="difflineplus">+                                     resultCode,</span>
<a href="#l4.418"></a><span id="l4.418" class="difflineplus">+                                     Components.interfaces.calIOperationListener.DELETE,</span>
<a href="#l4.419"></a><span id="l4.419" class="difflineplus">+                                     (item ? item.id : null),</span>
<a href="#l4.420"></a><span id="l4.420" class="difflineplus">+                                     (item ? item : e.message));</span>
<a href="#l4.421"></a><span id="l4.421">     },</span>
<a href="#l4.422"></a><span id="l4.422"> </span>
<a href="#l4.423"></a><span id="l4.423">     /**</span>
<a href="#l4.424"></a><span id="l4.424">      * getItem_response</span>
<a href="#l4.425"></a><span id="l4.425">      * Response function, called by the session object when a single Item was</span>
<a href="#l4.426"></a><span id="l4.426">      * downloaded.</span>
<a href="#l4.427"></a><span id="l4.427">      *</span>
<a href="#l4.428"></a><span id="l4.428">      * @param aOperation The calIGoogleRequest processing the request</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/calendar/providers/wcap/calWcapCalendar.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/calendar/providers/wcap/calWcapCalendar.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -117,18 +117,17 @@ calWcapCalendar.prototype = {</span>
<a href="#l5.4"></a><span id="l5.4">             }</span>
<a href="#l5.5"></a><span id="l5.5">         }</span>
<a href="#l5.6"></a><span id="l5.6">         return this.uri;</span>
<a href="#l5.7"></a><span id="l5.7">     },</span>
<a href="#l5.8"></a><span id="l5.8"> </span>
<a href="#l5.9"></a><span id="l5.9">     getProperty: function calWcapCalendar_getProperty(aName) {</span>
<a href="#l5.10"></a><span id="l5.10">         switch (aName) {</span>
<a href="#l5.11"></a><span id="l5.11">             case &quot;cache.supported&quot;:</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-                return false; // TODO Sorry, but until we implement the new</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-                              // calIChangeLog interfaces, we must disable the cache for wcap.</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+                return true;</span>
<a href="#l5.15"></a><span id="l5.15">             case &quot;timezones.provider&quot;:</span>
<a href="#l5.16"></a><span id="l5.16">                 return ((this.m_session &amp;&amp; this.session.isLoggedIn) ? this.session : null);</span>
<a href="#l5.17"></a><span id="l5.17">             case &quot;organizerId&quot;:</span>
<a href="#l5.18"></a><span id="l5.18">                 return this.ownerId;</span>
<a href="#l5.19"></a><span id="l5.19">             case &quot;organizerCN&quot;:</span>
<a href="#l5.20"></a><span id="l5.20">                 return this.getCalendarProperties(&quot;X-S1CS-CALPROPS-COMMON-NAME&quot;);</span>
<a href="#l5.21"></a><span id="l5.21">             case &quot;itip.disableRevisionChecks&quot;:</span>
<a href="#l5.22"></a><span id="l5.22">                 return true;</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

