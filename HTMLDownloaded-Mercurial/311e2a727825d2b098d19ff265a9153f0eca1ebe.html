<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 20094:311e2a727825d2b098d19ff265a9153f0eca1ebe</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 311e2a727825d2b098d19ff265a9153f0eca1ebe" />
<meta property="og:url" content="/comm-central/rev/311e2a727825d2b098d19ff265a9153f0eca1ebe" />
<meta property="og:description" content="Bug 1280898 - Set up eslint for calendar files - enable id-length rule. r=MakeMyDay" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 311e2a727825d2b098d19ff265a9153f0eca1ebe 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/311e2a727825d2b098d19ff265a9153f0eca1ebe">shortlog</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/311e2a727825d2b098d19ff265a9153f0eca1ebe">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe">files</a> |
changeset |
<a href="/comm-central/raw-rev/311e2a727825d2b098d19ff265a9153f0eca1ebe">raw</a>  | <a href="/comm-central/archive/311e2a727825d2b098d19ff265a9153f0eca1ebe.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1280898">Bug 1280898</a> - Set up eslint for calendar files - enable id-length rule. r=MakeMyDay
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#101;&#115;&#108;&#105;&#110;&#116;&#32;&#60;&#101;&#115;&#108;&#105;&#110;&#116;&#64;&#98;&#117;&#103;&#122;&#105;&#108;&#108;&#97;&#46;&#107;&#101;&#119;&#105;&#115;&#46;&#99;&#104;&#62;</td></tr>
<tr><td></td><td class="date age">Sat, 16 Jul 2016 02:20:06 +0200</td></tr>

<tr>
 <td>changeset 20094</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/311e2a727825d2b098d19ff265a9153f0eca1ebe">311e2a727825d2b098d19ff265a9153f0eca1ebe</a></td>
</tr>



<tr>
<td>parent 20093</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/0f9a99fba7f36da451ca1ccdf13dc9bb66880e80">0f9a99fba7f36da451ca1ccdf13dc9bb66880e80</a>
</td>
</tr>

<tr>
<td>child 20095</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/880d5e4d567c33a4424cae66ac72fc523a663efd">880d5e4d567c33a4424cae66ac72fc523a663efd</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=311e2a727825d2b098d19ff265a9153f0eca1ebe">12312</a></td></tr>
<tr><td>push user</td><td>mozilla@kewis.ch</td></tr>
<tr><td>push date</td><td class="date age">Sat, 17 Sep 2016 23:42:54 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@2d001923cb98 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=2d001923cb988f8f6a7108093f5388e9b627bc01">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=2d001923cb988f8f6a7108093f5388e9b627bc01&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=2d001923cb988f8f6a7108093f5388e9b627bc01&newProject=comm-central&newRevision=311e2a727825d2b098d19ff265a9153f0eca1ebe&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=2d001923cb988f8f6a7108093f5388e9b627bc01&newProject=comm-central&newRevision=311e2a727825d2b098d19ff265a9153f0eca1ebe&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=2d001923cb988f8f6a7108093f5388e9b627bc01&newProject=comm-central&newRevision=311e2a727825d2b098d19ff265a9153f0eca1ebe&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28MakeMyDay%29&revcount=50">MakeMyDay</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1280898">1280898</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1280898">Bug 1280898</a> - Set up eslint for calendar files - enable id-length rule. r=MakeMyDay

MozReview-Commit-ID: 1eaufSiw4BF</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/.eslintrc">calendar/.eslintrc</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/.eslintrc">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/.eslintrc">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/.eslintrc">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/.eslintrc">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/.eslintrc">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/backend/icaljs/calDateTime.js">calendar/base/backend/icaljs/calDateTime.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/backend/icaljs/calDateTime.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/backend/icaljs/calDateTime.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/backend/icaljs/calDateTime.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/backend/icaljs/calDateTime.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/backend/icaljs/calDateTime.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/backend/icaljs/calICSService.js">calendar/base/backend/icaljs/calICSService.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/backend/icaljs/calICSService.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/backend/icaljs/calICSService.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/backend/icaljs/calICSService.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/backend/icaljs/calICSService.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/backend/icaljs/calICSService.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/agenda-listbox.js">calendar/base/content/agenda-listbox.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/agenda-listbox.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/agenda-listbox.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/agenda-listbox.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/agenda-listbox.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/agenda-listbox.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/calendar-base-view.xml">calendar/base/content/calendar-base-view.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/calendar-base-view.xml">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/calendar-base-view.xml">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/calendar-base-view.xml">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/calendar-base-view.xml">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/calendar-base-view.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/calendar-invitations-manager.js">calendar/base/content/calendar-invitations-manager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/calendar-invitations-manager.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/calendar-invitations-manager.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/calendar-invitations-manager.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/calendar-invitations-manager.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/calendar-invitations-manager.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/calendar-month-view.xml">calendar/base/content/calendar-month-view.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/calendar-month-view.xml">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/calendar-month-view.xml">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/calendar-month-view.xml">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/calendar-month-view.xml">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/calendar-month-view.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/calendar-multiday-view.xml">calendar/base/content/calendar-multiday-view.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/calendar-multiday-view.xml">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/calendar-multiday-view.xml">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/calendar-multiday-view.xml">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/calendar-multiday-view.xml">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/calendar-multiday-view.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/calendar-task-editing.js">calendar/base/content/calendar-task-editing.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/calendar-task-editing.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/calendar-task-editing.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/calendar-task-editing.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/calendar-task-editing.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/calendar-task-editing.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/calendar-task-tree.js">calendar/base/content/calendar-task-tree.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/calendar-task-tree.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/calendar-task-tree.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/calendar-task-tree.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/calendar-task-tree.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/calendar-task-tree.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/calendar-task-tree.xml">calendar/base/content/calendar-task-tree.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/calendar-task-tree.xml">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/calendar-task-tree.xml">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/calendar-task-tree.xml">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/calendar-task-tree.xml">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/calendar-task-tree.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/calendar-ui-utils.js">calendar/base/content/calendar-ui-utils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/calendar-ui-utils.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/calendar-ui-utils.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/calendar-ui-utils.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/calendar-ui-utils.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/calendar-ui-utils.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/calendar-unifinder.js">calendar/base/content/calendar-unifinder.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/calendar-unifinder.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/calendar-unifinder.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/calendar-unifinder.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/calendar-unifinder.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/calendar-unifinder.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/calendar-views.xml">calendar/base/content/calendar-views.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/calendar-views.xml">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/calendar-views.xml">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/calendar-views.xml">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/calendar-views.xml">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/calendar-views.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/dialogs/calendar-creation.js">calendar/base/content/dialogs/calendar-creation.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/dialogs/calendar-creation.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/dialogs/calendar-creation.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/dialogs/calendar-creation.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/dialogs/calendar-creation.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/dialogs/calendar-creation.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/dialogs/calendar-dialog-utils.js">calendar/base/content/dialogs/calendar-dialog-utils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/dialogs/calendar-dialog-utils.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/dialogs/calendar-dialog-utils.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/dialogs/calendar-dialog-utils.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/dialogs/calendar-dialog-utils.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/dialogs/calendar-dialog-utils.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/dialogs/calendar-event-dialog-attendees.xml">calendar/base/content/dialogs/calendar-event-dialog-attendees.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/dialogs/calendar-event-dialog-attendees.xml">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/dialogs/calendar-event-dialog-attendees.xml">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/dialogs/calendar-event-dialog-attendees.xml">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/dialogs/calendar-event-dialog-attendees.xml">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/dialogs/calendar-event-dialog-attendees.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/dialogs/calendar-event-dialog-recurrence-preview.xml">calendar/base/content/dialogs/calendar-event-dialog-recurrence-preview.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/dialogs/calendar-event-dialog-recurrence-preview.xml">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/dialogs/calendar-event-dialog-recurrence-preview.xml">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/dialogs/calendar-event-dialog-recurrence-preview.xml">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/dialogs/calendar-event-dialog-recurrence-preview.xml">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/dialogs/calendar-event-dialog-recurrence-preview.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/dialogs/calendar-event-dialog-recurrence.js">calendar/base/content/dialogs/calendar-event-dialog-recurrence.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/dialogs/calendar-event-dialog-recurrence.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/dialogs/calendar-event-dialog-recurrence.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/dialogs/calendar-event-dialog-recurrence.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/dialogs/calendar-event-dialog-recurrence.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/dialogs/calendar-event-dialog-recurrence.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/dialogs/calendar-event-dialog-timezone.js">calendar/base/content/dialogs/calendar-event-dialog-timezone.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/dialogs/calendar-event-dialog-timezone.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/dialogs/calendar-event-dialog-timezone.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/dialogs/calendar-event-dialog-timezone.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/dialogs/calendar-event-dialog-timezone.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/dialogs/calendar-event-dialog-timezone.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/dialogs/calendar-subscriptions-dialog.js">calendar/base/content/dialogs/calendar-subscriptions-dialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/dialogs/calendar-subscriptions-dialog.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/dialogs/calendar-subscriptions-dialog.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/dialogs/calendar-subscriptions-dialog.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/dialogs/calendar-subscriptions-dialog.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/dialogs/calendar-subscriptions-dialog.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/dialogs/calendar-summary-dialog.js">calendar/base/content/dialogs/calendar-summary-dialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/dialogs/calendar-summary-dialog.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/dialogs/calendar-summary-dialog.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/dialogs/calendar-summary-dialog.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/dialogs/calendar-summary-dialog.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/dialogs/calendar-summary-dialog.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/import-export.js">calendar/base/content/import-export.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/import-export.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/import-export.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/import-export.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/import-export.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/import-export.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/preferences/alarms.js">calendar/base/content/preferences/alarms.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/preferences/alarms.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/preferences/alarms.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/preferences/alarms.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/preferences/alarms.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/preferences/alarms.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/preferences/general.js">calendar/base/content/preferences/general.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/preferences/general.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/preferences/general.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/preferences/general.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/preferences/general.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/preferences/general.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/widgets/calendar-alarm-widget.xml">calendar/base/content/widgets/calendar-alarm-widget.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/widgets/calendar-alarm-widget.xml">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/widgets/calendar-alarm-widget.xml">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/widgets/calendar-alarm-widget.xml">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/widgets/calendar-alarm-widget.xml">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/widgets/calendar-alarm-widget.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/widgets/calendar-list-tree.xml">calendar/base/content/widgets/calendar-list-tree.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/widgets/calendar-list-tree.xml">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/widgets/calendar-list-tree.xml">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/widgets/calendar-list-tree.xml">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/widgets/calendar-list-tree.xml">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/widgets/calendar-list-tree.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/widgets/minimonth.xml">calendar/base/content/widgets/minimonth.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/widgets/minimonth.xml">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/widgets/minimonth.xml">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/widgets/minimonth.xml">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/widgets/minimonth.xml">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/content/widgets/minimonth.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/modules/calAlarmUtils.jsm">calendar/base/modules/calAlarmUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/modules/calAlarmUtils.jsm">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/modules/calAlarmUtils.jsm">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/modules/calAlarmUtils.jsm">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/modules/calAlarmUtils.jsm">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/modules/calAlarmUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/modules/calAuthUtils.jsm">calendar/base/modules/calAuthUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/modules/calAuthUtils.jsm">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/modules/calAuthUtils.jsm">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/modules/calAuthUtils.jsm">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/modules/calAuthUtils.jsm">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/modules/calAuthUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/modules/calExtract.jsm">calendar/base/modules/calExtract.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/modules/calExtract.jsm">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/modules/calExtract.jsm">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/modules/calExtract.jsm">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/modules/calExtract.jsm">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/modules/calExtract.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/modules/calItipUtils.jsm">calendar/base/modules/calItipUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/modules/calItipUtils.jsm">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/modules/calItipUtils.jsm">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/modules/calItipUtils.jsm">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/modules/calItipUtils.jsm">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/modules/calItipUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/modules/calPrintUtils.jsm">calendar/base/modules/calPrintUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/modules/calPrintUtils.jsm">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/modules/calPrintUtils.jsm">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/modules/calPrintUtils.jsm">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/modules/calPrintUtils.jsm">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/modules/calPrintUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/modules/calRecurrenceUtils.jsm">calendar/base/modules/calRecurrenceUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/modules/calRecurrenceUtils.jsm">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/modules/calRecurrenceUtils.jsm">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/modules/calRecurrenceUtils.jsm">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/modules/calRecurrenceUtils.jsm">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/modules/calRecurrenceUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/modules/calUtils.jsm">calendar/base/modules/calUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/modules/calUtils.jsm">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/modules/calUtils.jsm">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/modules/calUtils.jsm">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/modules/calUtils.jsm">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/modules/calUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calAlarm.js">calendar/base/src/calAlarm.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calAlarm.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calAlarm.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calAlarm.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calAlarm.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calAlarm.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calAttachment.js">calendar/base/src/calAttachment.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calAttachment.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calAttachment.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calAttachment.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calAttachment.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calAttachment.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calCachedCalendar.js">calendar/base/src/calCachedCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calCachedCalendar.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calCachedCalendar.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calCachedCalendar.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calCachedCalendar.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calCachedCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calCalendarManager.js">calendar/base/src/calCalendarManager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calCalendarManager.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calCalendarManager.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calCalendarManager.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calCalendarManager.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calCalendarManager.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calDeletedItems.js">calendar/base/src/calDeletedItems.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calDeletedItems.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calDeletedItems.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calDeletedItems.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calDeletedItems.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calDeletedItems.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calEvent.js">calendar/base/src/calEvent.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calEvent.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calEvent.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calEvent.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calEvent.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calEvent.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calFilter.js">calendar/base/src/calFilter.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calFilter.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calFilter.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calFilter.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calFilter.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calFilter.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calIcsParser.js">calendar/base/src/calIcsParser.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calIcsParser.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calIcsParser.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calIcsParser.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calIcsParser.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calIcsParser.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calItemBase.js">calendar/base/src/calItemBase.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calItemBase.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calItemBase.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calItemBase.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calItemBase.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calItemBase.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calRecurrenceInfo.js">calendar/base/src/calRecurrenceInfo.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calRecurrenceInfo.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calRecurrenceInfo.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calRecurrenceInfo.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calRecurrenceInfo.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calRecurrenceInfo.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calTimezoneService.js">calendar/base/src/calTimezoneService.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calTimezoneService.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calTimezoneService.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calTimezoneService.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calTimezoneService.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calTimezoneService.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calTodo.js">calendar/base/src/calTodo.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calTodo.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calTodo.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calTodo.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calTodo.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calTodo.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calUtils.js">calendar/base/src/calUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calUtils.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calUtils.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calUtils.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calUtils.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/base/src/calUtils.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/import-export/calOutlookCSVImportExport.js">calendar/import-export/calOutlookCSVImportExport.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/import-export/calOutlookCSVImportExport.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/import-export/calOutlookCSVImportExport.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/import-export/calOutlookCSVImportExport.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/import-export/calOutlookCSVImportExport.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/import-export/calOutlookCSVImportExport.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/itip/calItipEmailTransport.js">calendar/itip/calItipEmailTransport.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/itip/calItipEmailTransport.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/itip/calItipEmailTransport.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/itip/calItipEmailTransport.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/itip/calItipEmailTransport.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/itip/calItipEmailTransport.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/lightning/components/calItipProtocolHandler.js">calendar/lightning/components/calItipProtocolHandler.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/lightning/components/calItipProtocolHandler.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/lightning/components/calItipProtocolHandler.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/lightning/components/calItipProtocolHandler.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/lightning/components/calItipProtocolHandler.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/lightning/components/calItipProtocolHandler.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/lightning/content/html-item-editing/react-code.js">calendar/lightning/content/html-item-editing/react-code.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/lightning/content/html-item-editing/react-code.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/lightning/content/html-item-editing/react-code.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/lightning/content/html-item-editing/react-code.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/lightning/content/html-item-editing/react-code.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/lightning/content/html-item-editing/react-code.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/lightning/content/imip-bar.js">calendar/lightning/content/imip-bar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/lightning/content/imip-bar.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/lightning/content/imip-bar.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/lightning/content/imip-bar.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/lightning/content/imip-bar.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/lightning/content/imip-bar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/lightning/content/lightning-item-iframe.js">calendar/lightning/content/lightning-item-iframe.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/lightning/content/lightning-item-iframe.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/lightning/content/lightning-item-iframe.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/lightning/content/lightning-item-iframe.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/lightning/content/lightning-item-iframe.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/lightning/content/lightning-item-iframe.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/lightning/modules/ltnInvitationUtils.jsm">calendar/lightning/modules/ltnInvitationUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/lightning/modules/ltnInvitationUtils.jsm">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/lightning/modules/ltnInvitationUtils.jsm">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/lightning/modules/ltnInvitationUtils.jsm">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/lightning/modules/ltnInvitationUtils.jsm">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/lightning/modules/ltnInvitationUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/providers/caldav/calDavCalendar.js">calendar/providers/caldav/calDavCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/providers/caldav/calDavCalendar.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/providers/caldav/calDavCalendar.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/providers/caldav/calDavCalendar.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/providers/caldav/calDavCalendar.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/providers/caldav/calDavCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/providers/caldav/calDavRequestHandlers.js">calendar/providers/caldav/calDavRequestHandlers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/providers/caldav/calDavRequestHandlers.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/providers/caldav/calDavRequestHandlers.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/providers/caldav/calDavRequestHandlers.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/providers/caldav/calDavRequestHandlers.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/providers/caldav/calDavRequestHandlers.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/providers/composite/calCompositeCalendar.js">calendar/providers/composite/calCompositeCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/providers/composite/calCompositeCalendar.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/providers/composite/calCompositeCalendar.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/providers/composite/calCompositeCalendar.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/providers/composite/calCompositeCalendar.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/providers/composite/calCompositeCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/providers/ics/calICSCalendar.js">calendar/providers/ics/calICSCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/providers/ics/calICSCalendar.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/providers/ics/calICSCalendar.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/providers/ics/calICSCalendar.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/providers/ics/calICSCalendar.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/providers/ics/calICSCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/providers/storage/calStorageCalendar.js">calendar/providers/storage/calStorageCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/providers/storage/calStorageCalendar.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/providers/storage/calStorageCalendar.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/providers/storage/calStorageCalendar.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/providers/storage/calStorageCalendar.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/providers/storage/calStorageCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/providers/storage/calStorageHelpers.jsm">calendar/providers/storage/calStorageHelpers.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/providers/storage/calStorageHelpers.jsm">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/providers/storage/calStorageHelpers.jsm">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/providers/storage/calStorageHelpers.jsm">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/providers/storage/calStorageHelpers.jsm">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/providers/storage/calStorageHelpers.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/providers/storage/calStorageUpgrade.jsm">calendar/providers/storage/calStorageUpgrade.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/providers/storage/calStorageUpgrade.jsm">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/providers/storage/calStorageUpgrade.jsm">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/providers/storage/calStorageUpgrade.jsm">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/providers/storage/calStorageUpgrade.jsm">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/providers/storage/calStorageUpgrade.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/providers/wcap/calWcapCalendar.js">calendar/providers/wcap/calWcapCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/providers/wcap/calWcapCalendar.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/providers/wcap/calWcapCalendar.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/providers/wcap/calWcapCalendar.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/providers/wcap/calWcapCalendar.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/providers/wcap/calWcapCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/providers/wcap/calWcapCalendarItems.js">calendar/providers/wcap/calWcapCalendarItems.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/providers/wcap/calWcapCalendarItems.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/providers/wcap/calWcapCalendarItems.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/providers/wcap/calWcapCalendarItems.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/providers/wcap/calWcapCalendarItems.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/providers/wcap/calWcapCalendarItems.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/providers/wcap/calWcapSession.js">calendar/providers/wcap/calWcapSession.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/providers/wcap/calWcapSession.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/providers/wcap/calWcapSession.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/providers/wcap/calWcapSession.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/providers/wcap/calWcapSession.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/providers/wcap/calWcapSession.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/providers/wcap/calWcapUtils.js">calendar/providers/wcap/calWcapUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/providers/wcap/calWcapUtils.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/providers/wcap/calWcapUtils.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/providers/wcap/calWcapUtils.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/providers/wcap/calWcapUtils.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/providers/wcap/calWcapUtils.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/resources/content/calendarCreation.js">calendar/resources/content/calendarCreation.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/resources/content/calendarCreation.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/resources/content/calendarCreation.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/resources/content/calendarCreation.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/resources/content/calendarCreation.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/resources/content/calendarCreation.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/resources/content/datetimepickers/datetimepickers.xml">calendar/resources/content/datetimepickers/datetimepickers.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/resources/content/datetimepickers/datetimepickers.xml">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/resources/content/datetimepickers/datetimepickers.xml">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/resources/content/datetimepickers/datetimepickers.xml">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/resources/content/datetimepickers/datetimepickers.xml">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/resources/content/datetimepickers/datetimepickers.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/mozmill/eventDialog/testEventDialog.js">calendar/test/mozmill/eventDialog/testEventDialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/mozmill/eventDialog/testEventDialog.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/mozmill/eventDialog/testEventDialog.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/mozmill/eventDialog/testEventDialog.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/mozmill/eventDialog/testEventDialog.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/mozmill/eventDialog/testEventDialog.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/mozmill/eventDialog/testEventDialogModificationPrompt.js">calendar/test/mozmill/eventDialog/testEventDialogModificationPrompt.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/mozmill/eventDialog/testEventDialogModificationPrompt.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/mozmill/eventDialog/testEventDialogModificationPrompt.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/mozmill/eventDialog/testEventDialogModificationPrompt.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/mozmill/eventDialog/testEventDialogModificationPrompt.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/mozmill/eventDialog/testEventDialogModificationPrompt.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/mozmill/recurrence/testLastDayOfMonthRecurrence.js">calendar/test/mozmill/recurrence/testLastDayOfMonthRecurrence.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/mozmill/recurrence/testLastDayOfMonthRecurrence.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/mozmill/recurrence/testLastDayOfMonthRecurrence.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/mozmill/recurrence/testLastDayOfMonthRecurrence.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/mozmill/recurrence/testLastDayOfMonthRecurrence.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/mozmill/recurrence/testLastDayOfMonthRecurrence.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/mozmill/recurrence/testWeeklyNRecurrence.js">calendar/test/mozmill/recurrence/testWeeklyNRecurrence.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/mozmill/recurrence/testWeeklyNRecurrence.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/mozmill/recurrence/testWeeklyNRecurrence.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/mozmill/recurrence/testWeeklyNRecurrence.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/mozmill/recurrence/testWeeklyNRecurrence.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/mozmill/recurrence/testWeeklyNRecurrence.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/mozmill/recurrence/testWeeklyUntilRecurrence.js">calendar/test/mozmill/recurrence/testWeeklyUntilRecurrence.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/mozmill/recurrence/testWeeklyUntilRecurrence.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/mozmill/recurrence/testWeeklyUntilRecurrence.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/mozmill/recurrence/testWeeklyUntilRecurrence.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/mozmill/recurrence/testWeeklyUntilRecurrence.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/mozmill/recurrence/testWeeklyUntilRecurrence.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/mozmill/recurrence/testWeeklyWithExceptionRecurrence.js">calendar/test/mozmill/recurrence/testWeeklyWithExceptionRecurrence.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/mozmill/recurrence/testWeeklyWithExceptionRecurrence.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/mozmill/recurrence/testWeeklyWithExceptionRecurrence.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/mozmill/recurrence/testWeeklyWithExceptionRecurrence.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/mozmill/recurrence/testWeeklyWithExceptionRecurrence.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/mozmill/recurrence/testWeeklyWithExceptionRecurrence.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/mozmill/recurrenceRotated/testLastDayOfMonthRecurrence.js">calendar/test/mozmill/recurrenceRotated/testLastDayOfMonthRecurrence.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/mozmill/recurrenceRotated/testLastDayOfMonthRecurrence.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/mozmill/recurrenceRotated/testLastDayOfMonthRecurrence.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/mozmill/recurrenceRotated/testLastDayOfMonthRecurrence.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/mozmill/recurrenceRotated/testLastDayOfMonthRecurrence.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/mozmill/recurrenceRotated/testLastDayOfMonthRecurrence.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/mozmill/recurrenceRotated/testWeeklyNRecurrence.js">calendar/test/mozmill/recurrenceRotated/testWeeklyNRecurrence.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/mozmill/recurrenceRotated/testWeeklyNRecurrence.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/mozmill/recurrenceRotated/testWeeklyNRecurrence.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/mozmill/recurrenceRotated/testWeeklyNRecurrence.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/mozmill/recurrenceRotated/testWeeklyNRecurrence.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/mozmill/recurrenceRotated/testWeeklyNRecurrence.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/mozmill/recurrenceRotated/testWeeklyUntilRecurrence.js">calendar/test/mozmill/recurrenceRotated/testWeeklyUntilRecurrence.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/mozmill/recurrenceRotated/testWeeklyUntilRecurrence.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/mozmill/recurrenceRotated/testWeeklyUntilRecurrence.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/mozmill/recurrenceRotated/testWeeklyUntilRecurrence.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/mozmill/recurrenceRotated/testWeeklyUntilRecurrence.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/mozmill/recurrenceRotated/testWeeklyUntilRecurrence.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/mozmill/recurrenceRotated/testWeeklyWithExceptionRecurrence.js">calendar/test/mozmill/recurrenceRotated/testWeeklyWithExceptionRecurrence.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/mozmill/recurrenceRotated/testWeeklyWithExceptionRecurrence.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/mozmill/recurrenceRotated/testWeeklyWithExceptionRecurrence.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/mozmill/recurrenceRotated/testWeeklyWithExceptionRecurrence.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/mozmill/recurrenceRotated/testWeeklyWithExceptionRecurrence.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/mozmill/recurrenceRotated/testWeeklyWithExceptionRecurrence.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/mozmill/shared-modules/calendar-utils.js">calendar/test/mozmill/shared-modules/calendar-utils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/mozmill/shared-modules/calendar-utils.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/mozmill/shared-modules/calendar-utils.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/mozmill/shared-modules/calendar-utils.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/mozmill/shared-modules/calendar-utils.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/mozmill/shared-modules/calendar-utils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/mozmill/shared-modules/timezone-utils.js">calendar/test/mozmill/shared-modules/timezone-utils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/mozmill/shared-modules/timezone-utils.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/mozmill/shared-modules/timezone-utils.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/mozmill/shared-modules/timezone-utils.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/mozmill/shared-modules/timezone-utils.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/mozmill/shared-modules/timezone-utils.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/head_consts.js">calendar/test/unit/head_consts.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/head_consts.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/head_consts.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/head_consts.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/head_consts.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/head_consts.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_alarm.js">calendar/test/unit/test_alarm.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_alarm.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_alarm.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_alarm.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_alarm.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_alarm.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_alarmservice.js">calendar/test/unit/test_alarmservice.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_alarmservice.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_alarmservice.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_alarmservice.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_alarmservice.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_alarmservice.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_attendee.js">calendar/test/unit/test_attendee.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_attendee.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_attendee.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_attendee.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_attendee.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_attendee.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_bug1204255.js">calendar/test/unit/test_bug1204255.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_bug1204255.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_bug1204255.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_bug1204255.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_bug1204255.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_bug1204255.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_bug1209399.js">calendar/test/unit/test_bug1209399.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_bug1209399.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_bug1209399.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_bug1209399.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_bug1209399.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_bug1209399.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_bug759324.js">calendar/test/unit/test_bug759324.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_bug759324.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_bug759324.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_bug759324.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_bug759324.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_bug759324.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_calutils.js">calendar/test/unit/test_calutils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_calutils.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_calutils.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_calutils.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_calutils.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_calutils.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_datetime.js">calendar/test/unit/test_datetime.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_datetime.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_datetime.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_datetime.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_datetime.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_datetime.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_freebusy_service.js">calendar/test/unit/test_freebusy_service.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_freebusy_service.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_freebusy_service.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_freebusy_service.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_freebusy_service.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_freebusy_service.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_gdata_provider.js">calendar/test/unit/test_gdata_provider.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_gdata_provider.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_gdata_provider.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_gdata_provider.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_gdata_provider.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_gdata_provider.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_hashedarray.js">calendar/test/unit/test_hashedarray.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_hashedarray.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_hashedarray.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_hashedarray.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_hashedarray.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_hashedarray.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_ics_service.js">calendar/test/unit/test_ics_service.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_ics_service.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_ics_service.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_ics_service.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_ics_service.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_ics_service.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_items.js">calendar/test/unit/test_items.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_items.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_items.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_items.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_items.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_items.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_ltninvitationutils.js">calendar/test/unit/test_ltninvitationutils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_ltninvitationutils.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_ltninvitationutils.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_ltninvitationutils.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_ltninvitationutils.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_ltninvitationutils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_recur.js">calendar/test/unit/test_recur.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_recur.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_recur.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_recur.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_recur.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_recur.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_relation.js">calendar/test/unit/test_relation.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_relation.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_relation.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_relation.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_relation.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_relation.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_search_service.js">calendar/test/unit/test_search_service.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_search_service.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_search_service.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_search_service.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_search_service.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_search_service.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_storage.js">calendar/test/unit/test_storage.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_storage.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_storage.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_storage.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_storage.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_storage.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_timezone.js">calendar/test/unit/test_timezone.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_timezone.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_timezone.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_timezone.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_timezone.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_timezone.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_timezone_definition.js">calendar/test/unit/test_timezone_definition.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_timezone_definition.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_timezone_definition.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_timezone_definition.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_timezone_definition.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_timezone_definition.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_utils.js">calendar/test/unit/test_utils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_utils.js">file</a> |
<a href="/comm-central/annotate/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_utils.js">annotate</a> |
<a href="/comm-central/diff/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_utils.js">diff</a> |
<a href="/comm-central/comparison/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_utils.js">comparison</a> |
<a href="/comm-central/log/311e2a727825d2b098d19ff265a9153f0eca1ebe/calendar/test/unit/test_utils.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/calendar/.eslintrc</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/calendar/.eslintrc</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -439,13 +439,28 @@</span>
<a href="#l1.4"></a><span id="l1.4">     &quot;max-statements-per-line&quot;: [2, { &quot;max&quot;: 2 }],</span>
<a href="#l1.5"></a><span id="l1.5"> </span>
<a href="#l1.6"></a><span id="l1.6">     // Disallow arrow functions where they could be confused with comparisons</span>
<a href="#l1.7"></a><span id="l1.7">     &quot;no-confusing-arrow&quot;: 2,</span>
<a href="#l1.8"></a><span id="l1.8"> </span>
<a href="#l1.9"></a><span id="l1.9">     // Disallow Unnecessary Nested Blocks</span>
<a href="#l1.10"></a><span id="l1.10">     &quot;no-lone-blocks&quot;: 2,</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+    // Enforce minimum identifier length</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+    &quot;id-length&quot;: [2, {</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+      &quot;min&quot;: 3,</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+      &quot;exceptions&quot;: [</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+        /* sorting */ &quot;a&quot;, &quot;b&quot;,</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+        /* exceptions */ &quot;e&quot;, &quot;ex&quot;,</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+        /* loop indices */ &quot;i&quot;, &quot;j&quot;, &quot;k&quot;, &quot;n&quot;,</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+        /* coordinates */ &quot;x&quot;, &quot;y&quot;,</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+        /* regexes */ &quot;re&quot;,</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+        /* known words */ &quot;rc&quot;, &quot;rv&quot;, &quot;id&quot;, &quot;OS&quot;, &quot;os&quot;, &quot;db&quot;,</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineplus">+        /* mail/calendar words */ &quot;to&quot;, &quot;cc&quot;,</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineplus">+        /* Components */ &quot;Ci&quot;, &quot;Cc&quot;, &quot;Cu&quot;, &quot;Cr&quot;,</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineplus">+      ]</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineplus">+    }],</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineplus">+</span>
<a href="#l1.27"></a><span id="l1.27">     // The following rules will not be enabled currently, but are kept here for</span>
<a href="#l1.28"></a><span id="l1.28">     // easier updates in the future.</span>
<a href="#l1.29"></a><span id="l1.29">     &quot;no-else-return&quot;: 0,</span>
<a href="#l1.30"></a><span id="l1.30">   }</span>
<a href="#l1.31"></a><span id="l1.31"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/calendar/base/backend/icaljs/calDateTime.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/calendar/base/backend/icaljs/calDateTime.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -56,26 +56,26 @@ calDateTime.prototype = {</span>
<a href="#l2.4"></a><span id="l2.4">     get timezone() { return new calICALJSTimezone(this.innerObject.zone); },</span>
<a href="#l2.5"></a><span id="l2.5">     set timezone(rawval) {</span>
<a href="#l2.6"></a><span id="l2.6">         unwrapSetter(ICAL.Timezone, rawval, function(val) {</span>
<a href="#l2.7"></a><span id="l2.7">             this.innerObject.zone = val;</span>
<a href="#l2.8"></a><span id="l2.8">             return val;</span>
<a href="#l2.9"></a><span id="l2.9">         }, this);</span>
<a href="#l2.10"></a><span id="l2.10">     },</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-    resetTo: function(yr, mo, dy, hr, mi, sc, tz) {</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+    resetTo: function(year, month, day, hour, minute, second, timezone) {</span>
<a href="#l2.14"></a><span id="l2.14">         this.innerObject.fromData({</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineminus">-            year: yr,</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineminus">-            month: mo + 1,</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineminus">-            day: dy,</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineminus">-            hour: hr,</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineminus">-            minute: mi,</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineminus">-            second: sc,</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineplus">+            year: year,</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineplus">+            month: month + 1,</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineplus">+            day: day,</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineplus">+            hour: hour,</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineplus">+            minute: minute,</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineplus">+            second: second,</span>
<a href="#l2.27"></a><span id="l2.27">         });</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineminus">-        this.timezone = tz;</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineplus">+        this.timezone = timezone;</span>
<a href="#l2.30"></a><span id="l2.30">     },</span>
<a href="#l2.31"></a><span id="l2.31"> </span>
<a href="#l2.32"></a><span id="l2.32">     reset: function() { this.innerObject.reset(); },</span>
<a href="#l2.33"></a><span id="l2.33"> </span>
<a href="#l2.34"></a><span id="l2.34">     get timezoneOffset() { return this.innerObject.utcOffset(); },</span>
<a href="#l2.35"></a><span id="l2.35">     get isDate() { return this.innerObject.isDate; },</span>
<a href="#l2.36"></a><span id="l2.36">     set isDate(val) { this.innerObject.isDate = val; },</span>
<a href="#l2.37"></a><span id="l2.37"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/calendar/base/backend/icaljs/calICSService.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/calendar/base/backend/icaljs/calICSService.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -44,25 +44,25 @@ calIcalProperty.prototype = {</span>
<a href="#l3.4"></a><span id="l3.4">             return val;</span>
<a href="#l3.5"></a><span id="l3.5">         }</span>
<a href="#l3.6"></a><span id="l3.6">         this.valueAsIcalString = val;</span>
<a href="#l3.7"></a><span id="l3.7">         return val;</span>
<a href="#l3.8"></a><span id="l3.8">     },</span>
<a href="#l3.9"></a><span id="l3.9"> </span>
<a href="#l3.10"></a><span id="l3.10">     get valueAsIcalString() {</span>
<a href="#l3.11"></a><span id="l3.11">         let type = this.innerObject.type;</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-        return this.innerObject.getValues().map(v =&gt; {</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+        return this.innerObject.getValues().map(val =&gt; {</span>
<a href="#l3.14"></a><span id="l3.14">             if (type == &quot;text&quot;) {</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">-                return ICAL.stringify.value(v, type, ICAL.design.icalendar);</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineminus">-            } else if (typeof v == &quot;number&quot; || typeof v == &quot;string&quot;) {</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineminus">-                return v;</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineminus">-            } else if (&quot;toICALString&quot; in v) {</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineminus">-                return v.toICALString();</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+                return ICAL.stringify.value(val, type, ICAL.design.icalendar);</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+            } else if (typeof val == &quot;number&quot; || typeof val == &quot;string&quot;) {</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+                return val;</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+            } else if (&quot;toICALString&quot; in val) {</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+                return val.toICALString();</span>
<a href="#l3.25"></a><span id="l3.25">             } else {</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineminus">-                return v.toString();</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+                return val.toString();</span>
<a href="#l3.28"></a><span id="l3.28">             }</span>
<a href="#l3.29"></a><span id="l3.29">         }).join(&quot;,&quot;);</span>
<a href="#l3.30"></a><span id="l3.30">     },</span>
<a href="#l3.31"></a><span id="l3.31">     set valueAsIcalString(val) {</span>
<a href="#l3.32"></a><span id="l3.32">         let mockLine = this.propertyName + &quot;:&quot; + val;</span>
<a href="#l3.33"></a><span id="l3.33">         let prop = ICAL.Property.fromString(mockLine, ICAL.design.icalendar);</span>
<a href="#l3.34"></a><span id="l3.34"> </span>
<a href="#l3.35"></a><span id="l3.35">         if (this.innerObject.isMultiValue) {</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineat">@@ -107,72 +107,72 @@ calIcalProperty.prototype = {</span>
<a href="#l3.37"></a><span id="l3.37">                 // Default type doesn't match object type, so we have a VALUE</span>
<a href="#l3.38"></a><span id="l3.38">                 // parameter</span>
<a href="#l3.39"></a><span id="l3.39">                 return this.innerObject.type.toUpperCase();</span>
<a href="#l3.40"></a><span id="l3.40">             }</span>
<a href="#l3.41"></a><span id="l3.41">         }</span>
<a href="#l3.42"></a><span id="l3.42"> </span>
<a href="#l3.43"></a><span id="l3.43">         return this.innerObject.getParameter(name.toLowerCase());</span>
<a href="#l3.44"></a><span id="l3.44">     },</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineminus">-    setParameter: function(n, v) {</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineplus">+    setParameter: function(name, value) {</span>
<a href="#l3.47"></a><span id="l3.47">         // Similar problems for setting the value parameter. Lightning code</span>
<a href="#l3.48"></a><span id="l3.48">         // expects setting the value parameter to just change the value type</span>
<a href="#l3.49"></a><span id="l3.49">         // and attempt to use the previous value as the new one. To do this in</span>
<a href="#l3.50"></a><span id="l3.50">         // ICAL.js we need to save the value, reset the type and then try to</span>
<a href="#l3.51"></a><span id="l3.51">         // set the value again.</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineminus">-        if (n == &quot;VALUE&quot;) {</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineplus">+        if (name == &quot;VALUE&quot;) {</span>
<a href="#l3.54"></a><span id="l3.54">             let oldValues;</span>
<a href="#l3.55"></a><span id="l3.55">             let type = this.innerObject.type;</span>
<a href="#l3.56"></a><span id="l3.56">             let designSet = this.innerObject._designSet;</span>
<a href="#l3.57"></a><span id="l3.57"> </span>
<a href="#l3.58"></a><span id="l3.58">             let wasMultiValue = this.innerObject.isMultiValue;</span>
<a href="#l3.59"></a><span id="l3.59">             if (wasMultiValue) {</span>
<a href="#l3.60"></a><span id="l3.60">                 oldValues = this.innerObject.getValues();</span>
<a href="#l3.61"></a><span id="l3.61">             } else {</span>
<a href="#l3.62"></a><span id="l3.62">                 let oldValue = this.innerObject.getFirstValue();</span>
<a href="#l3.63"></a><span id="l3.63">                 oldValues = oldValue ? [oldValue] : [];</span>
<a href="#l3.64"></a><span id="l3.64">             }</span>
<a href="#l3.65"></a><span id="l3.65"> </span>
<a href="#l3.66"></a><span id="l3.66" class="difflineminus">-            this.innerObject.resetType(v.toLowerCase());</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineplus">+            this.innerObject.resetType(value.toLowerCase());</span>
<a href="#l3.68"></a><span id="l3.68">             try {</span>
<a href="#l3.69"></a><span id="l3.69">                 oldValues = oldValues.map(oldValue =&gt; {</span>
<a href="#l3.70"></a><span id="l3.70">                     let strvalue = ICAL.stringify.value(oldValue.toString(), type, designSet);</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineminus">-                    return ICAL.parse._parseValue(strvalue, v, designSet);</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineplus">+                    return ICAL.parse._parseValue(strvalue, value, designSet);</span>
<a href="#l3.73"></a><span id="l3.73">                 });</span>
<a href="#l3.74"></a><span id="l3.74">             } catch (e) {</span>
<a href="#l3.75"></a><span id="l3.75">                 // If there was an error reparsing the value, then just keep it</span>
<a href="#l3.76"></a><span id="l3.76">                 // empty.</span>
<a href="#l3.77"></a><span id="l3.77">                 oldValues = null;</span>
<a href="#l3.78"></a><span id="l3.78">             }</span>
<a href="#l3.79"></a><span id="l3.79"> </span>
<a href="#l3.80"></a><span id="l3.80">             if (oldValues &amp;&amp; oldValues.length) {</span>
<a href="#l3.81"></a><span id="l3.81">                 if (wasMultiValue &amp;&amp; this.innerObject.isMultiValue) {</span>
<a href="#l3.82"></a><span id="l3.82">                     this.innerObject.setValues(oldValues);</span>
<a href="#l3.83"></a><span id="l3.83">                 } else {</span>
<a href="#l3.84"></a><span id="l3.84">                     this.innerObject.setValue(oldValues.join(&quot;,&quot;));</span>
<a href="#l3.85"></a><span id="l3.85">                 }</span>
<a href="#l3.86"></a><span id="l3.86">             }</span>
<a href="#l3.87"></a><span id="l3.87">         } else {</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineminus">-            this.innerObject.setParameter(n.toLowerCase(), v);</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineplus">+            this.innerObject.setParameter(name.toLowerCase(), value);</span>
<a href="#l3.90"></a><span id="l3.90">         }</span>
<a href="#l3.91"></a><span id="l3.91">     },</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineminus">-    removeParameter: function(n) {</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineplus">+    removeParameter: function(name) {</span>
<a href="#l3.94"></a><span id="l3.94">         // Again, VALUE needs special handling. Removing the value parameter is</span>
<a href="#l3.95"></a><span id="l3.95">         // kind of like resetting it to the default type. So find out the</span>
<a href="#l3.96"></a><span id="l3.96">         // default type and then set the value parameter to it.</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineminus">-        if (n == &quot;VALUE&quot;) {</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineplus">+        if (name == &quot;VALUE&quot;) {</span>
<a href="#l3.99"></a><span id="l3.99">             let propname = this.innerObject.name.toLowerCase();</span>
<a href="#l3.100"></a><span id="l3.100">             if (propname in ICAL.design.icalendar.property) {</span>
<a href="#l3.101"></a><span id="l3.101">                 let details = ICAL.design.icalendar.property[propname];</span>
<a href="#l3.102"></a><span id="l3.102">                 if (&quot;defaultType&quot; in details) {</span>
<a href="#l3.103"></a><span id="l3.103">                     this.setParameter(&quot;VALUE&quot;, details.defaultType);</span>
<a href="#l3.104"></a><span id="l3.104">                 }</span>
<a href="#l3.105"></a><span id="l3.105">             }</span>
<a href="#l3.106"></a><span id="l3.106">         } else {</span>
<a href="#l3.107"></a><span id="l3.107" class="difflineminus">-            this.innerObject.removeParameter(n.toLowerCase());</span>
<a href="#l3.108"></a><span id="l3.108" class="difflineplus">+            this.innerObject.removeParameter(name.toLowerCase());</span>
<a href="#l3.109"></a><span id="l3.109">         }</span>
<a href="#l3.110"></a><span id="l3.110">     },</span>
<a href="#l3.111"></a><span id="l3.111"> </span>
<a href="#l3.112"></a><span id="l3.112">     clearXParameters: function() {</span>
<a href="#l3.113"></a><span id="l3.113">         cal.WARN(&quot;calIICSService::clearXParameters is no longer implemented, &quot; +</span>
<a href="#l3.114"></a><span id="l3.114">                  &quot;please use removeParameter&quot;);</span>
<a href="#l3.115"></a><span id="l3.115">     },</span>
<a href="#l3.116"></a><span id="l3.116"> </span>
<a href="#l3.117"></a><span id="l3.117" class="difflineat">@@ -405,45 +405,45 @@ calIcalComponent.prototype = {</span>
<a href="#l3.118"></a><span id="l3.118">         while (vcalendar &amp;&amp; vcalendar.componentType != &quot;VCALENDAR&quot;) {</span>
<a href="#l3.119"></a><span id="l3.119">             vcalendar = vcalendar.parent;</span>
<a href="#l3.120"></a><span id="l3.120">         }</span>
<a href="#l3.121"></a><span id="l3.121">         return vcalendar || this;</span>
<a href="#l3.122"></a><span id="l3.122">     },</span>
<a href="#l3.123"></a><span id="l3.123"> </span>
<a href="#l3.124"></a><span id="l3.124">     addProperty: function(prop) {</span>
<a href="#l3.125"></a><span id="l3.125">         try {</span>
<a href="#l3.126"></a><span id="l3.126" class="difflineminus">-            let dt = prop.valueAsDatetime;</span>
<a href="#l3.127"></a><span id="l3.127" class="difflineminus">-            if (dt &amp;&amp; dt.timezone) {</span>
<a href="#l3.128"></a><span id="l3.128" class="difflineminus">-                this._getNextParentVCalendar().addTimezoneReference(dt.timezone);</span>
<a href="#l3.129"></a><span id="l3.129" class="difflineplus">+            let datetime = prop.valueAsDatetime;</span>
<a href="#l3.130"></a><span id="l3.130" class="difflineplus">+            if (datetime &amp;&amp; datetime.timezone) {</span>
<a href="#l3.131"></a><span id="l3.131" class="difflineplus">+                this._getNextParentVCalendar().addTimezoneReference(datetime.timezone);</span>
<a href="#l3.132"></a><span id="l3.132">             }</span>
<a href="#l3.133"></a><span id="l3.133">         } catch (e) {</span>
<a href="#l3.134"></a><span id="l3.134">             // If there is an issue adding the timezone reference, don't make</span>
<a href="#l3.135"></a><span id="l3.135">             // that break adding the property.</span>
<a href="#l3.136"></a><span id="l3.136">         }</span>
<a href="#l3.137"></a><span id="l3.137"> </span>
<a href="#l3.138"></a><span id="l3.138">         let jsprop = unwrapSingle(ICAL.Property, prop);</span>
<a href="#l3.139"></a><span id="l3.139">         this.innerObject.addProperty(jsprop);</span>
<a href="#l3.140"></a><span id="l3.140">     },</span>
<a href="#l3.141"></a><span id="l3.141"> </span>
<a href="#l3.142"></a><span id="l3.142" class="difflineminus">-    addTimezoneReference: function(tz) {</span>
<a href="#l3.143"></a><span id="l3.143" class="difflineminus">-        if (tz) {</span>
<a href="#l3.144"></a><span id="l3.144" class="difflineminus">-            if (!(tz.tzid in this.mReferencedZones) &amp;&amp;</span>
<a href="#l3.145"></a><span id="l3.145" class="difflineplus">+    addTimezoneReference: function(timezone) {</span>
<a href="#l3.146"></a><span id="l3.146" class="difflineplus">+        if (timezone) {</span>
<a href="#l3.147"></a><span id="l3.147" class="difflineplus">+            if (!(timezone.tzid in this.mReferencedZones) &amp;&amp;</span>
<a href="#l3.148"></a><span id="l3.148">                 this.componentType == &quot;VCALENDAR&quot;) {</span>
<a href="#l3.149"></a><span id="l3.149" class="difflineminus">-                let comp = tz.icalComponent;</span>
<a href="#l3.150"></a><span id="l3.150" class="difflineplus">+                let comp = timezone.icalComponent;</span>
<a href="#l3.151"></a><span id="l3.151">                 if (comp) {</span>
<a href="#l3.152"></a><span id="l3.152">                     this.addSubcomponent(comp);</span>
<a href="#l3.153"></a><span id="l3.153">                 }</span>
<a href="#l3.154"></a><span id="l3.154">             }</span>
<a href="#l3.155"></a><span id="l3.155"> </span>
<a href="#l3.156"></a><span id="l3.156" class="difflineminus">-            this.mReferencedZones[tz.tzid] = tz;</span>
<a href="#l3.157"></a><span id="l3.157" class="difflineplus">+            this.mReferencedZones[timezone.tzid] = timezone;</span>
<a href="#l3.158"></a><span id="l3.158">         }</span>
<a href="#l3.159"></a><span id="l3.159">     },</span>
<a href="#l3.160"></a><span id="l3.160"> </span>
<a href="#l3.161"></a><span id="l3.161">     getReferencedTimezones: function(aCount) {</span>
<a href="#l3.162"></a><span id="l3.162" class="difflineminus">-        let vals = Object.keys(this.mReferencedZones).map(tz =&gt; this.mReferencedZones[tz]);</span>
<a href="#l3.163"></a><span id="l3.163" class="difflineplus">+        let vals = Object.keys(this.mReferencedZones).map(timezone =&gt; this.mReferencedZones[timezone]);</span>
<a href="#l3.164"></a><span id="l3.164">         aCount.value = vals.length;</span>
<a href="#l3.165"></a><span id="l3.165">         return vals;</span>
<a href="#l3.166"></a><span id="l3.166">     },</span>
<a href="#l3.167"></a><span id="l3.167"> </span>
<a href="#l3.168"></a><span id="l3.168">     serializeToICSStream: function() {</span>
<a href="#l3.169"></a><span id="l3.169">         let unicodeConverter = Components.classes[&quot;@mozilla.org/intl/scriptableunicodeconverter&quot;]</span>
<a href="#l3.170"></a><span id="l3.170">                                          .createInstance(Components.interfaces.nsIScriptableUnicodeConverter);</span>
<a href="#l3.171"></a><span id="l3.171">         unicodeConverter.charset = &quot;UTF-8&quot;;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/calendar/base/content/agenda-listbox.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/calendar/base/content/agenda-listbox.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -616,19 +616,19 @@ agendaListbox.refreshCalendarQuery = fun</span>
<a href="#l4.4"></a><span id="l4.4">             }</span>
<a href="#l4.5"></a><span id="l4.5">             for (let item of aItems) {</span>
<a href="#l4.6"></a><span id="l4.6">                 this.agendaListbox.addItem(item);</span>
<a href="#l4.7"></a><span id="l4.7">             }</span>
<a href="#l4.8"></a><span id="l4.8">         },</span>
<a href="#l4.9"></a><span id="l4.9"> </span>
<a href="#l4.10"></a><span id="l4.10">         cancel: function() {</span>
<a href="#l4.11"></a><span id="l4.11">             this.cancelled = true;</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-            let op = cal.wrapInstance(this.operation, Components.interfaces.calIOperation);</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-            if (op &amp;&amp; op.isPending) {</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-                op.cancel();</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+            let operation = cal.wrapInstance(this.operation, Components.interfaces.calIOperation);</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+            if (operation &amp;&amp; operation.isPending) {</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+                operation.cancel();</span>
<a href="#l4.18"></a><span id="l4.18">                 this.operation = null;</span>
<a href="#l4.19"></a><span id="l4.19">             }</span>
<a href="#l4.20"></a><span id="l4.20">         },</span>
<a href="#l4.21"></a><span id="l4.21"> </span>
<a href="#l4.22"></a><span id="l4.22">         execute: function() {</span>
<a href="#l4.23"></a><span id="l4.23">             if (!(aStart || aEnd || aCalendar)) {</span>
<a href="#l4.24"></a><span id="l4.24">                 this.agendaListbox.removeListItems();</span>
<a href="#l4.25"></a><span id="l4.25">             }</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineat">@@ -660,20 +660,20 @@ agendaListbox.refreshCalendarQuery = fun</span>
<a href="#l4.27"></a><span id="l4.27">                     this.agendaListbox.mPendingRefreshJobs.get(this.calId).cancel();</span>
<a href="#l4.28"></a><span id="l4.28">                     this.agendaListbox.mPendingRefreshJobs.delete(this.calId);</span>
<a href="#l4.29"></a><span id="l4.29">                 }</span>
<a href="#l4.30"></a><span id="l4.30">             }</span>
<a href="#l4.31"></a><span id="l4.31">             this.calendar = aCalendar;</span>
<a href="#l4.32"></a><span id="l4.32"> </span>
<a href="#l4.33"></a><span id="l4.33">             let filter = this.calendar.ITEM_FILTER_CLASS_OCCURRENCES |</span>
<a href="#l4.34"></a><span id="l4.34">                          this.calendar.ITEM_FILTER_TYPE_EVENT;</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineminus">-            let op = this.calendar.getItems(filter, 0, aStart, aEnd, this);</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineminus">-            op = cal.wrapInstance(op, Components.interfaces.calIOperation);</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineminus">-            if (op &amp;&amp; op.isPending) {</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineminus">-                this.operation = op;</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+            let operation = this.calendar.getItems(filter, 0, aStart, aEnd, this);</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+            operation = cal.wrapInstance(operation, Components.interfaces.calIOperation);</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+            if (operation &amp;&amp; operation.isPending) {</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+                this.operation = operation;</span>
<a href="#l4.43"></a><span id="l4.43">                 this.agendaListbox.mPendingRefreshJobs.set(this.calId, this);</span>
<a href="#l4.44"></a><span id="l4.44">             }</span>
<a href="#l4.45"></a><span id="l4.45">         }</span>
<a href="#l4.46"></a><span id="l4.46">     };</span>
<a href="#l4.47"></a><span id="l4.47"> </span>
<a href="#l4.48"></a><span id="l4.48">     refreshJob.execute();</span>
<a href="#l4.49"></a><span id="l4.49"> };</span>
<a href="#l4.50"></a><span id="l4.50"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/calendar/base/content/calendar-base-view.xml</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/calendar/base/content/calendar-base-view.xml</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -415,19 +415,19 @@</span>
<a href="#l5.4"></a><span id="l5.4">           for (let i = 0; i &lt; labeldayboxkids.length; i++) {</span>
<a href="#l5.5"></a><span id="l5.5">               labeldayboxkids[i].shortWeekNames = useShortNames;</span>
<a href="#l5.6"></a><span id="l5.6">           }</span>
<a href="#l5.7"></a><span id="l5.7">         ]]&gt;&lt;/body&gt;</span>
<a href="#l5.8"></a><span id="l5.8">       &lt;/method&gt;</span>
<a href="#l5.9"></a><span id="l5.9"> </span>
<a href="#l5.10"></a><span id="l5.10">       &lt;method name=&quot;today&quot;&gt;</span>
<a href="#l5.11"></a><span id="l5.11">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-          let d = cal.jsDateToDateTime(new Date()).getInTimezone(this.mTimezone);</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-          d.isDate = true;</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineminus">-          return d;</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+          let date = cal.jsDateToDateTime(new Date()).getInTimezone(this.mTimezone);</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+          date.isDate = true;</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+          return date;</span>
<a href="#l5.18"></a><span id="l5.18">         ]]&gt;&lt;/body&gt;</span>
<a href="#l5.19"></a><span id="l5.19">       &lt;/method&gt;</span>
<a href="#l5.20"></a><span id="l5.20"> </span>
<a href="#l5.21"></a><span id="l5.21">       &lt;method name=&quot;isVisible&quot;&gt;</span>
<a href="#l5.22"></a><span id="l5.22">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l5.23"></a><span id="l5.23">             return (this.nodeName == currentView().nodeName);</span>
<a href="#l5.24"></a><span id="l5.24">         ]]&gt;&lt;/body&gt;</span>
<a href="#l5.25"></a><span id="l5.25">       &lt;/method&gt;</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineat">@@ -483,19 +483,19 @@</span>
<a href="#l5.27"></a><span id="l5.27">                           this.calView.doAddItem(item);</span>
<a href="#l5.28"></a><span id="l5.28">                       }</span>
<a href="#l5.29"></a><span id="l5.29">                   }</span>
<a href="#l5.30"></a><span id="l5.30">               },</span>
<a href="#l5.31"></a><span id="l5.31"> </span>
<a href="#l5.32"></a><span id="l5.32">               cancel: function() {</span>
<a href="#l5.33"></a><span id="l5.33">                   this.calView.mLog.info(&quot;Refresh cancelled for calendar &quot; + this.calId);</span>
<a href="#l5.34"></a><span id="l5.34">                   this.cancelled = true;</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineminus">-                  let op = cal.wrapInstance(this.operation, Components.interfaces.calIOperation);</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineminus">-                  if (op &amp;&amp; op.isPending) {</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineminus">-                      op.cancel();</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineplus">+                  let operation = cal.wrapInstance(this.operation, Components.interfaces.calIOperation);</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineplus">+                  if (operation &amp;&amp; operation.isPending) {</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineplus">+                      operation.cancel();</span>
<a href="#l5.41"></a><span id="l5.41">                       this.operation = null;</span>
<a href="#l5.42"></a><span id="l5.42">                   }</span>
<a href="#l5.43"></a><span id="l5.43">               },</span>
<a href="#l5.44"></a><span id="l5.44"> </span>
<a href="#l5.45"></a><span id="l5.45">               execute: function() {</span>
<a href="#l5.46"></a><span id="l5.46">                   if (!this.calView.startDate || !this.calView.endDate || !aCalendar) {</span>
<a href="#l5.47"></a><span id="l5.47">                       return;</span>
<a href="#l5.48"></a><span id="l5.48">                   }</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineat">@@ -530,24 +530,24 @@</span>
<a href="#l5.50"></a><span id="l5.50">                   }</span>
<a href="#l5.51"></a><span id="l5.51"> </span>
<a href="#l5.52"></a><span id="l5.52">                   if (this.calView.mTasksInView) {</span>
<a href="#l5.53"></a><span id="l5.53">                       filter |= this.calendar.ITEM_FILTER_TYPE_ALL;</span>
<a href="#l5.54"></a><span id="l5.54">                   } else {</span>
<a href="#l5.55"></a><span id="l5.55">                       filter |= this.calendar.ITEM_FILTER_TYPE_EVENT;</span>
<a href="#l5.56"></a><span id="l5.56">                   }</span>
<a href="#l5.57"></a><span id="l5.57"> </span>
<a href="#l5.58"></a><span id="l5.58" class="difflineminus">-                  let op = this.calendar.getItems(filter,</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineminus">-                                                  0,</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineminus">-                                                  this.calView.startDate,</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineminus">-                                                  this.calView.queryEndDate,</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineminus">-                                                  this);</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineminus">-                  op = cal.wrapInstance(op, Components.interfaces.calIOperation);</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineminus">-                  if (op &amp;&amp; op.isPending) {</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineminus">-                      this.operation = op;</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineplus">+                  let operation = this.calendar.getItems(filter,</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineplus">+                                                         0,</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineplus">+                                                         this.calView.startDate,</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineplus">+                                                         this.calView.queryEndDate,</span>
<a href="#l5.70"></a><span id="l5.70" class="difflineplus">+                                                         this);</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineplus">+                  operation = cal.wrapInstance(operation, Components.interfaces.calIOperation);</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineplus">+                  if (operation &amp;&amp; operation.isPending) {</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineplus">+                      this.operation = operation;</span>
<a href="#l5.74"></a><span id="l5.74">                       this.calView.mPendingRefreshJobs.set(this.calId, this);</span>
<a href="#l5.75"></a><span id="l5.75">                   }</span>
<a href="#l5.76"></a><span id="l5.76">               }</span>
<a href="#l5.77"></a><span id="l5.77">           };</span>
<a href="#l5.78"></a><span id="l5.78"> </span>
<a href="#l5.79"></a><span id="l5.79">           refreshJob.execute();</span>
<a href="#l5.80"></a><span id="l5.80">         ]]&gt;&lt;/body&gt;</span>
<a href="#l5.81"></a><span id="l5.81">       &lt;/method&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/calendar/base/content/calendar-invitations-manager.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/calendar/base/content/calendar-invitations-manager.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -16,19 +16,19 @@ var gInvitationsRequestManager = {</span>
<a href="#l6.4"></a><span id="l6.4">     mRequestStatusList: {},</span>
<a href="#l6.5"></a><span id="l6.5"> </span>
<a href="#l6.6"></a><span id="l6.6">     /**</span>
<a href="#l6.7"></a><span id="l6.7">      * Add a request to the request manager.</span>
<a href="#l6.8"></a><span id="l6.8">      *</span>
<a href="#l6.9"></a><span id="l6.9">      * @param calendar    The calendar to add for.</span>
<a href="#l6.10"></a><span id="l6.10">      * @param op          The operation to add</span>
<a href="#l6.11"></a><span id="l6.11">      */</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-    addRequestStatus: function(calendar, op) {</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-        if (op) {</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-            this.mRequestStatusList[calendar.id] = op;</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+    addRequestStatus: function(calendar, operation) {</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+        if (operation) {</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+            this.mRequestStatusList[calendar.id] = operation;</span>
<a href="#l6.18"></a><span id="l6.18">         }</span>
<a href="#l6.19"></a><span id="l6.19">     },</span>
<a href="#l6.20"></a><span id="l6.20"> </span>
<a href="#l6.21"></a><span id="l6.21">     /**</span>
<a href="#l6.22"></a><span id="l6.22">      * Cancel all pending requests</span>
<a href="#l6.23"></a><span id="l6.23">      */</span>
<a href="#l6.24"></a><span id="l6.24">     cancelPendingRequests: function() {</span>
<a href="#l6.25"></a><span id="l6.25">         for (let id in this.mRequestStatusList) {</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineat">@@ -202,25 +202,25 @@ InvitationsManager.prototype = {</span>
<a href="#l6.27"></a><span id="l6.27">                 opListener.onOperationComplete();</span>
<a href="#l6.28"></a><span id="l6.28">                 continue;</span>
<a href="#l6.29"></a><span id="l6.29">             }</span>
<a href="#l6.30"></a><span id="l6.30"> </span>
<a href="#l6.31"></a><span id="l6.31">             try {</span>
<a href="#l6.32"></a><span id="l6.32">                 calendar = calendar.QueryInterface(Components.interfaces.calICalendar);</span>
<a href="#l6.33"></a><span id="l6.33">                 let endDate = this.mStartDate.clone();</span>
<a href="#l6.34"></a><span id="l6.34">                 endDate.year += 1;</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineminus">-                let op = calendar.getItems(Components.interfaces.calICalendar.ITEM_FILTER_REQUEST_NEEDS_ACTION |</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineminus">-                                           Components.interfaces.calICalendar.ITEM_FILTER_TYPE_ALL |</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineminus">-                                           // we need to retrieve by occurrence to properly filter exceptions,</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineminus">-                                           // should be fixed with bug 416975</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineminus">-                                           Components.interfaces.calICalendar.ITEM_FILTER_CLASS_OCCURRENCES,</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineminus">-                                           0, this.mStartDate,</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineminus">-                                           endDate /* we currently cannot pass null here, because of bug 416975 */,</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineminus">-                                           opListener);</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineminus">-                gInvitationsRequestManager.addRequestStatus(calendar, op);</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineplus">+                let operation = calendar.getItems(Components.interfaces.calICalendar.ITEM_FILTER_REQUEST_NEEDS_ACTION |</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineplus">+                                                  Components.interfaces.calICalendar.ITEM_FILTER_TYPE_ALL |</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineplus">+                                                  // we need to retrieve by occurrence to properly filter exceptions,</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineplus">+                                                  // should be fixed with bug 416975</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineplus">+                                                  Components.interfaces.calICalendar.ITEM_FILTER_CLASS_OCCURRENCES,</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineplus">+                                                  0, this.mStartDate,</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineplus">+                                                  endDate /* we currently cannot pass null here, because of bug 416975 */,</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineplus">+                                                  opListener);</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineplus">+                gInvitationsRequestManager.addRequestStatus(calendar, operation);</span>
<a href="#l6.53"></a><span id="l6.53">             } catch (exc) {</span>
<a href="#l6.54"></a><span id="l6.54">                 opListener.onOperationComplete();</span>
<a href="#l6.55"></a><span id="l6.55">                 ERROR(exc);</span>
<a href="#l6.56"></a><span id="l6.56">             }</span>
<a href="#l6.57"></a><span id="l6.57">         }</span>
<a href="#l6.58"></a><span id="l6.58">     },</span>
<a href="#l6.59"></a><span id="l6.59"> </span>
<a href="#l6.60"></a><span id="l6.60">     /**</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/calendar/base/content/calendar-month-view.xml</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/calendar/base/content/calendar-month-view.xml</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -77,38 +77,38 @@</span>
<a href="#l7.4"></a><span id="l7.4">             return this.mOccurrence;</span>
<a href="#l7.5"></a><span id="l7.5">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l7.6"></a><span id="l7.6">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l7.7"></a><span id="l7.7">           ASSERT(!this.mOccurrence, &quot;Code changes needed to set the occurrence twice&quot;, true);</span>
<a href="#l7.8"></a><span id="l7.8">           this.mOccurrence = val;</span>
<a href="#l7.9"></a><span id="l7.9">           if (cal.isEvent(val)) {</span>
<a href="#l7.10"></a><span id="l7.10">             if (!val.startDate.isDate) {</span>
<a href="#l7.11"></a><span id="l7.11">               let label = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;item-label&quot;);</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-              let df = Components.classes[&quot;@mozilla.org/calendar/datetime-formatter;1&quot;]</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-                                 .getService(Components.interfaces.calIDateTimeFormatter);</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+              let formatter = Components.classes[&quot;@mozilla.org/calendar/datetime-formatter;1&quot;]</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+                                        .getService(Components.interfaces.calIDateTimeFormatter);</span>
<a href="#l7.16"></a><span id="l7.16">               let timezone = this.calendarView ? this.calendarView.mTimezone</span>
<a href="#l7.17"></a><span id="l7.17">                                                : calendarDefaultTimezone();</span>
<a href="#l7.18"></a><span id="l7.18">               let parentDate = ensureDateTime(this.parentBox.date);</span>
<a href="#l7.19"></a><span id="l7.19">               let startTime = val.startDate.getInTimezone(timezone);</span>
<a href="#l7.20"></a><span id="l7.20">               let endTime = val.endDate.getInTimezone(timezone);</span>
<a href="#l7.21"></a><span id="l7.21">               let nextDay = parentDate.clone();</span>
<a href="#l7.22"></a><span id="l7.22">               nextDay.day++;</span>
<a href="#l7.23"></a><span id="l7.23">               let comp = endTime.compare(nextDay);</span>
<a href="#l7.24"></a><span id="l7.24">               if (startTime.compare(parentDate) == -1) {</span>
<a href="#l7.25"></a><span id="l7.25">                 if (comp == 1) {</span>
<a href="#l7.26"></a><span id="l7.26">                   label.value = &quot;↔&quot;;</span>
<a href="#l7.27"></a><span id="l7.27">                 } else if (comp == 0) {</span>
<a href="#l7.28"></a><span id="l7.28">                   label.value = &quot;↤&quot;;</span>
<a href="#l7.29"></a><span id="l7.29">                 } else {</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineminus">-                  label.value = &quot;⇥ &quot; + df.formatTime(endTime);</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineplus">+                  label.value = &quot;⇥ &quot; + formatter.formatTime(endTime);</span>
<a href="#l7.32"></a><span id="l7.32">                 }</span>
<a href="#l7.33"></a><span id="l7.33">               } else if (comp == 1) {</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineminus">-                label.value = &quot;⇤ &quot; + df.formatTime(startTime);</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineplus">+                label.value = &quot;⇤ &quot; + formatter.formatTime(startTime);</span>
<a href="#l7.36"></a><span id="l7.36">               } else {</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineminus">-                label.value = df.formatTime(startTime);</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineplus">+                label.value = formatter.formatTime(startTime);</span>
<a href="#l7.39"></a><span id="l7.39">               }</span>
<a href="#l7.40"></a><span id="l7.40">               label.setAttribute(&quot;time&quot;, &quot;true&quot;);</span>
<a href="#l7.41"></a><span id="l7.41">             }</span>
<a href="#l7.42"></a><span id="l7.42">           }</span>
<a href="#l7.43"></a><span id="l7.43"> </span>
<a href="#l7.44"></a><span id="l7.44">           this.setEditableLabel();</span>
<a href="#l7.45"></a><span id="l7.45">           this.setCSSClasses();</span>
<a href="#l7.46"></a><span id="l7.46">           return val;</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineat">@@ -783,43 +783,43 @@</span>
<a href="#l7.48"></a><span id="l7.48">             if (finished) {</span>
<a href="#l7.49"></a><span id="l7.49">               row.setAttribute(&quot;collapsed&quot;, true);</span>
<a href="#l7.50"></a><span id="l7.50">               continue;</span>
<a href="#l7.51"></a><span id="l7.51">             } else {</span>
<a href="#l7.52"></a><span id="l7.52">               row.removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l7.53"></a><span id="l7.53">             }</span>
<a href="#l7.54"></a><span id="l7.54">             for (let j = 0; j &lt; row.childNodes.length; j++) {</span>
<a href="#l7.55"></a><span id="l7.55">               let daybox = row.childNodes[j];</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineminus">-              let dt = dateList[dateBoxes.length];</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineplus">+              let date = dateList[dateBoxes.length];</span>
<a href="#l7.58"></a><span id="l7.58"> </span>
<a href="#l7.59"></a><span id="l7.59">               // Remove the attribute &quot;relation&quot; for all the column headers.</span>
<a href="#l7.60"></a><span id="l7.60">               // Consider only the first row index otherwise it will be</span>
<a href="#l7.61"></a><span id="l7.61">               // removed again afterwards the correct setting.</span>
<a href="#l7.62"></a><span id="l7.62">               if (i == 0) {</span>
<a href="#l7.63"></a><span id="l7.63">                   this.labeldaybox.childNodes[j].removeAttribute(&quot;relation&quot;);</span>
<a href="#l7.64"></a><span id="l7.64">               }</span>
<a href="#l7.65"></a><span id="l7.65"> </span>
<a href="#l7.66"></a><span id="l7.66">               daybox.setAttribute(&quot;context&quot;, this.getAttribute(&quot;context&quot;));</span>
<a href="#l7.67"></a><span id="l7.67">               daybox.setAttribute(&quot;item-context&quot;, this.getAttribute(&quot;item-context&quot;) || this.getAttribute(&quot;context&quot;));</span>
<a href="#l7.68"></a><span id="l7.68"> </span>
<a href="#l7.69"></a><span id="l7.69">               // Set the box-class depending on if this box displays a day in</span>
<a href="#l7.70"></a><span id="l7.70">               // the month being currently shown or not.</span>
<a href="#l7.71"></a><span id="l7.71">               let boxClass;</span>
<a href="#l7.72"></a><span id="l7.72">               if (this.showFullMonth) {</span>
<a href="#l7.73"></a><span id="l7.73">                   boxClass = &quot;calendar-month-day-box-&quot; +</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineminus">-                             (mainMonth == dt.month ? &quot;current-month&quot; : &quot;other-month&quot;);</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineplus">+                             (mainMonth == date.month ? &quot;current-month&quot; : &quot;other-month&quot;);</span>
<a href="#l7.76"></a><span id="l7.76">               } else {</span>
<a href="#l7.77"></a><span id="l7.77">                   boxClass = &quot;calendar-month-day-box-current-month&quot;;</span>
<a href="#l7.78"></a><span id="l7.78">               }</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineminus">-              if (this.mDaysOffArray.some(dayOffNum =&gt; dayOffNum == dt.weekday)) {</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineplus">+              if (this.mDaysOffArray.some(dayOffNum =&gt; dayOffNum == date.weekday)) {</span>
<a href="#l7.81"></a><span id="l7.81">                 boxClass = &quot;calendar-month-day-box-day-off &quot; + boxClass;</span>
<a href="#l7.82"></a><span id="l7.82">               }</span>
<a href="#l7.83"></a><span id="l7.83"> </span>
<a href="#l7.84"></a><span id="l7.84">               // Set up date relations</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineminus">-              switch (dt.compare(today)) {</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineplus">+              switch (date.compare(today)) {</span>
<a href="#l7.87"></a><span id="l7.87">                   case -1:</span>
<a href="#l7.88"></a><span id="l7.88">                       daybox.setAttribute(&quot;relation&quot;, &quot;past&quot;);</span>
<a href="#l7.89"></a><span id="l7.89">                       break;</span>
<a href="#l7.90"></a><span id="l7.90">                   case 0:</span>
<a href="#l7.91"></a><span id="l7.91">                       daybox.setAttribute(&quot;relation&quot;, &quot;today&quot;);</span>
<a href="#l7.92"></a><span id="l7.92">                       this.labeldaybox.childNodes[j].setAttribute(&quot;relation&quot;, &quot;today&quot;);</span>
<a href="#l7.93"></a><span id="l7.93">                       break;</span>
<a href="#l7.94"></a><span id="l7.94">                   case 1:</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineat">@@ -834,34 +834,34 @@</span>
<a href="#l7.96"></a><span id="l7.96">                   let isDayOff = this.mDaysOffArray.includes((j + this.mWeekStartOffset) % 7);</span>
<a href="#l7.97"></a><span id="l7.97">                   if (this.mDisplayDaysOff || !isDayOff) {</span>
<a href="#l7.98"></a><span id="l7.98">                     weekLabelColumnPos = j;</span>
<a href="#l7.99"></a><span id="l7.99">                   }</span>
<a href="#l7.100"></a><span id="l7.100">                 }</span>
<a href="#l7.101"></a><span id="l7.101">                 // Build and set the label.</span>
<a href="#l7.102"></a><span id="l7.102">                 if (j == weekLabelColumnPos) {</span>
<a href="#l7.103"></a><span id="l7.103">                   weekLabel.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l7.104"></a><span id="l7.104" class="difflineminus">-                  let weekNumber = cal.getWeekInfoService().getWeekTitle(dt);</span>
<a href="#l7.105"></a><span id="l7.105" class="difflineplus">+                  let weekNumber = cal.getWeekInfoService().getWeekTitle(date);</span>
<a href="#l7.106"></a><span id="l7.106">                   let weekString = cal.calGetString(&quot;calendar&quot;, &quot;abbreviationOfWeek&quot;, [weekNumber]);</span>
<a href="#l7.107"></a><span id="l7.107">                   weekLabel.value = weekString;</span>
<a href="#l7.108"></a><span id="l7.108">                 } else {</span>
<a href="#l7.109"></a><span id="l7.109">                   weekLabel.hidden = true;</span>
<a href="#l7.110"></a><span id="l7.110">                 }</span>
<a href="#l7.111"></a><span id="l7.111">               }</span>
<a href="#l7.112"></a><span id="l7.112"> </span>
<a href="#l7.113"></a><span id="l7.113">               daybox.setAttribute(&quot;class&quot;, boxClass);</span>
<a href="#l7.114"></a><span id="l7.114"> </span>
<a href="#l7.115"></a><span id="l7.115" class="difflineminus">-              daybox.setDate(dt);</span>
<a href="#l7.116"></a><span id="l7.116" class="difflineminus">-              if (dt.day == 1 || dt.day == dt.endOfMonth.day) {</span>
<a href="#l7.117"></a><span id="l7.117" class="difflineplus">+              daybox.setDate(date);</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineplus">+              if (date.day == 1 || date.day == date.endOfMonth.day) {</span>
<a href="#l7.119"></a><span id="l7.119">                 daybox.showMonthLabel = true;</span>
<a href="#l7.120"></a><span id="l7.120">               } else {</span>
<a href="#l7.121"></a><span id="l7.121">                 daybox.showMonthLabel = false;</span>
<a href="#l7.122"></a><span id="l7.122">               }</span>
<a href="#l7.123"></a><span id="l7.123">               daybox.calendarView = this;</span>
<a href="#l7.124"></a><span id="l7.124" class="difflineminus">-              daybox.date = dt;</span>
<a href="#l7.125"></a><span id="l7.125" class="difflineplus">+              daybox.date = date;</span>
<a href="#l7.126"></a><span id="l7.126">               dateBoxes.push(daybox);</span>
<a href="#l7.127"></a><span id="l7.127"> </span>
<a href="#l7.128"></a><span id="l7.128">               // If we've now assigned all of our dates, set this to true so we</span>
<a href="#l7.129"></a><span id="l7.129">               // know we can just collapse the rest of the rows.</span>
<a href="#l7.130"></a><span id="l7.130">               if (dateBoxes.length == dateList.length) {</span>
<a href="#l7.131"></a><span id="l7.131">                 finished = true;</span>
<a href="#l7.132"></a><span id="l7.132">               }</span>
<a href="#l7.133"></a><span id="l7.133">             }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/calendar/base/content/calendar-multiday-view.xml</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/calendar/base/content/calendar-multiday-view.xml</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -958,40 +958,40 @@</span>
<a href="#l8.4"></a><span id="l8.4">               //       |______|      |</span>
<a href="#l8.5"></a><span id="l8.5">               //       |      |      |</span>
<a href="#l8.6"></a><span id="l8.6">               //       |OPEN! |      |&lt;--Our item's start time might be here</span>
<a href="#l8.7"></a><span id="l8.7">               //       |      |______|</span>
<a href="#l8.8"></a><span id="l8.8">               //       |      |      |</span>
<a href="#l8.9"></a><span id="l8.9">               //</span>
<a href="#l8.10"></a><span id="l8.10">               // Remember that any time we're starting a new blob, colEndArray</span>
<a href="#l8.11"></a><span id="l8.11">               // will be empty, but that's ok.</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-              for (let ii = 0; ii &lt; colEndArray.length; ++ii) {</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-                  let colEnd = colEndArray[ii].layoutEnd;</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+              for (let j = 0; j &lt; colEndArray.length; ++j) {</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+                  let colEnd = colEndArray[j].layoutEnd;</span>
<a href="#l8.16"></a><span id="l8.16">                   if (colEnd.compare(curItemInfo.layoutStart) != 1) {</span>
<a href="#l8.17"></a><span id="l8.17">                       // Yay, we can jump into this column</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineminus">-                      colEndArray[ii] = curItemInfo;</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+                      colEndArray[j] = curItemInfo;</span>
<a href="#l8.20"></a><span id="l8.20"> </span>
<a href="#l8.21"></a><span id="l8.21">                       // Check and see if there are any adjacent columns we can</span>
<a href="#l8.22"></a><span id="l8.22">                       // jump into as well.</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineminus">-                      let lastCol = Number(ii) + 1;</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+                      let lastCol = Number(j) + 1;</span>
<a href="#l8.25"></a><span id="l8.25">                       while (lastCol &lt; colEndArray.length) {</span>
<a href="#l8.26"></a><span id="l8.26">                           let nextColEnd = colEndArray[lastCol].layoutEnd;</span>
<a href="#l8.27"></a><span id="l8.27">                           // If the next column's item ends after we start, we</span>
<a href="#l8.28"></a><span id="l8.28">                           // can't expand any further</span>
<a href="#l8.29"></a><span id="l8.29">                           if (nextColEnd.compare(curItemInfo.layoutStart) == 1) {</span>
<a href="#l8.30"></a><span id="l8.30">                               break;</span>
<a href="#l8.31"></a><span id="l8.31">                           }</span>
<a href="#l8.32"></a><span id="l8.32">                           colEndArray[lastCol] = curItemInfo;</span>
<a href="#l8.33"></a><span id="l8.33">                           lastCol++;</span>
<a href="#l8.34"></a><span id="l8.34">                       }</span>
<a href="#l8.35"></a><span id="l8.35">                       // Now construct the info we need to push into the blob</span>
<a href="#l8.36"></a><span id="l8.36">                       currentBlob.push({</span>
<a href="#l8.37"></a><span id="l8.37">                           itemInfo: curItemInfo,</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineminus">-                          startCol: ii,</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineminus">-                          colSpan: lastCol - ii</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineplus">+                          startCol: j,</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineplus">+                          colSpan: lastCol - j</span>
<a href="#l8.42"></a><span id="l8.42">                       });</span>
<a href="#l8.43"></a><span id="l8.43"> </span>
<a href="#l8.44"></a><span id="l8.44">                       // Update latestItemEnd</span>
<a href="#l8.45"></a><span id="l8.45">                       if (latestItemEnd &amp;&amp;</span>
<a href="#l8.46"></a><span id="l8.46">                           curItemInfo.layoutEnd.compare(latestItemEnd) == 1) {</span>
<a href="#l8.47"></a><span id="l8.47">                           latestItemEnd = curItemInfo.layoutEnd;</span>
<a href="#l8.48"></a><span id="l8.48">                       }</span>
<a href="#l8.49"></a><span id="l8.49">                       placedItem = true;</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineat">@@ -1015,39 +1015,39 @@</span>
<a href="#l8.51"></a><span id="l8.51">               //       |      |______|      |</span>
<a href="#l8.52"></a><span id="l8.52">               //       |      |      |______|</span>
<a href="#l8.53"></a><span id="l8.53">               //       |      |_____________|</span>
<a href="#l8.54"></a><span id="l8.54">               //       |      |ev2          |</span>
<a href="#l8.55"></a><span id="l8.55">               //       |______|             |&lt;--If our item's start time is</span>
<a href="#l8.56"></a><span id="l8.56">               //       |      |_____________|   here, we can shrink ev2 and jump</span>
<a href="#l8.57"></a><span id="l8.57">               //       |      |      |      |   in column #3</span>
<a href="#l8.58"></a><span id="l8.58">               //</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineminus">-              for (let jj = 1; jj &lt; colEndArray.length; ++jj) {</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineminus">-                  if (colEndArray[jj].event.hashId == colEndArray[jj - 1].event.hashId) {</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineplus">+              for (let j = 1; j &lt; colEndArray.length; ++j) {</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineplus">+                  if (colEndArray[j].event.hashId == colEndArray[j - 1].event.hashId) {</span>
<a href="#l8.63"></a><span id="l8.63">                       // Good we found a item that spanned multiple columns.</span>
<a href="#l8.64"></a><span id="l8.64">                       // Find it in the blob so we can modify its properties</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineminus">-                      for (let kk in currentBlob) {</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineminus">-                          if (currentBlob[kk].itemInfo.event.hashId == colEndArray[jj].event.hashId) {</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineplus">+                      for (let blobKey in currentBlob) {</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineplus">+                          if (currentBlob[blobKey].itemInfo.event.hashId == colEndArray[j].event.hashId) {</span>
<a href="#l8.69"></a><span id="l8.69">                               // Take all but the first spot that the item spanned</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineminus">-                              let spanOfShrunkItem = currentBlob[kk].colSpan;</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineplus">+                              let spanOfShrunkItem = currentBlob[blobKey].colSpan;</span>
<a href="#l8.72"></a><span id="l8.72">                               currentBlob.push({</span>
<a href="#l8.73"></a><span id="l8.73">                                   itemInfo: curItemInfo,</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineminus">-                                  startCol: Number(currentBlob[kk].startCol) + 1,</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineplus">+                                  startCol: Number(currentBlob[blobKey].startCol) + 1,</span>
<a href="#l8.76"></a><span id="l8.76">                                   colSpan: spanOfShrunkItem - 1</span>
<a href="#l8.77"></a><span id="l8.77">                               });</span>
<a href="#l8.78"></a><span id="l8.78"> </span>
<a href="#l8.79"></a><span id="l8.79">                               // Update colEndArray</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineminus">-                              for (let ll = jj; ll &lt; jj + spanOfShrunkItem - 1; ll++) {</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineminus">-                                  colEndArray[ll] = curItemInfo;</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineplus">+                              for (let k = j; k &lt; j + spanOfShrunkItem - 1; k++) {</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineplus">+                                  colEndArray[k] = curItemInfo;</span>
<a href="#l8.84"></a><span id="l8.84">                               }</span>
<a href="#l8.85"></a><span id="l8.85"> </span>
<a href="#l8.86"></a><span id="l8.86">                               // Modify the data on the old item</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineminus">-                              currentBlob[kk] = {</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineminus">-                                  itemInfo: currentBlob[kk].itemInfo,</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineminus">-                                  startCol: currentBlob[kk].startCol,</span>
<a href="#l8.90"></a><span id="l8.90" class="difflineplus">+                              currentBlob[blobKey] = {</span>
<a href="#l8.91"></a><span id="l8.91" class="difflineplus">+                                  itemInfo: currentBlob[blobKey].itemInfo,</span>
<a href="#l8.92"></a><span id="l8.92" class="difflineplus">+                                  startCol: currentBlob[blobKey].startCol,</span>
<a href="#l8.93"></a><span id="l8.93">                                   colSpan: 1</span>
<a href="#l8.94"></a><span id="l8.94">                               };</span>
<a href="#l8.95"></a><span id="l8.95">                               // Update latestItemEnd</span>
<a href="#l8.96"></a><span id="l8.96">                               if (latestItemEnd &amp;&amp;</span>
<a href="#l8.97"></a><span id="l8.97">                                   curItemInfo.layoutEnd.compare(latestItemEnd) == 1) {</span>
<a href="#l8.98"></a><span id="l8.98">                                   latestItemEnd = curItemInfo.layoutEnd;</span>
<a href="#l8.99"></a><span id="l8.99">                               }</span>
<a href="#l8.100"></a><span id="l8.100">                               break; // Stop iterating through currentBlob</span>
<a href="#l8.101"></a><span id="l8.101" class="difflineat">@@ -1070,24 +1070,24 @@</span>
<a href="#l8.102"></a><span id="l8.102">               // All the items in the last column, except for the one* that</span>
<a href="#l8.103"></a><span id="l8.103">               // conflicts with the item we're trying to place, need to have</span>
<a href="#l8.104"></a><span id="l8.104">               // their span extended by 1, since we're adding the new column</span>
<a href="#l8.105"></a><span id="l8.105">               //</span>
<a href="#l8.106"></a><span id="l8.106">               // * Note that there can only be one, because we sorted our</span>
<a href="#l8.107"></a><span id="l8.107">               //   events by start time, so this event must start later than</span>
<a href="#l8.108"></a><span id="l8.108">               //   the start of any possible conflicts.</span>
<a href="#l8.109"></a><span id="l8.109">               let lastColNum = colEndArray.length;</span>
<a href="#l8.110"></a><span id="l8.110" class="difflineminus">-              for (let mm in currentBlob) {</span>
<a href="#l8.111"></a><span id="l8.111" class="difflineminus">-                  let mmEnd = currentBlob[mm].itemInfo.layoutEnd;</span>
<a href="#l8.112"></a><span id="l8.112" class="difflineminus">-                  if (currentBlob[mm].startCol + currentBlob[mm].colSpan == lastColNum &amp;&amp;</span>
<a href="#l8.113"></a><span id="l8.113" class="difflineminus">-                      mmEnd.compare(curItemInfo.layoutStart) != 1) {</span>
<a href="#l8.114"></a><span id="l8.114" class="difflineminus">-                      currentBlob[mm] = {</span>
<a href="#l8.115"></a><span id="l8.115" class="difflineminus">-                          itemInfo: currentBlob[mm].itemInfo,</span>
<a href="#l8.116"></a><span id="l8.116" class="difflineminus">-                          startCol: currentBlob[mm].startCol,</span>
<a href="#l8.117"></a><span id="l8.117" class="difflineminus">-                          colSpan: currentBlob[mm].colSpan + 1</span>
<a href="#l8.118"></a><span id="l8.118" class="difflineplus">+              for (let blobKey in currentBlob) {</span>
<a href="#l8.119"></a><span id="l8.119" class="difflineplus">+                  let blobKeyEnd = currentBlob[blobKey].itemInfo.layoutEnd;</span>
<a href="#l8.120"></a><span id="l8.120" class="difflineplus">+                  if (currentBlob[blobKey].startCol + currentBlob[blobKey].colSpan == lastColNum &amp;&amp;</span>
<a href="#l8.121"></a><span id="l8.121" class="difflineplus">+                      blobKeyEnd.compare(curItemInfo.layoutStart) != 1) {</span>
<a href="#l8.122"></a><span id="l8.122" class="difflineplus">+                      currentBlob[blobKey] = {</span>
<a href="#l8.123"></a><span id="l8.123" class="difflineplus">+                          itemInfo: currentBlob[blobKey].itemInfo,</span>
<a href="#l8.124"></a><span id="l8.124" class="difflineplus">+                          startCol: currentBlob[blobKey].startCol,</span>
<a href="#l8.125"></a><span id="l8.125" class="difflineplus">+                          colSpan: currentBlob[blobKey].colSpan + 1</span>
<a href="#l8.126"></a><span id="l8.126">                       };</span>
<a href="#l8.127"></a><span id="l8.127">                   }</span>
<a href="#l8.128"></a><span id="l8.128">               }</span>
<a href="#l8.129"></a><span id="l8.129">               currentBlob.push({</span>
<a href="#l8.130"></a><span id="l8.130">                   itemInfo: curItemInfo,</span>
<a href="#l8.131"></a><span id="l8.131">                   startCol: colEndArray.length,</span>
<a href="#l8.132"></a><span id="l8.132">                   colSpan: 1</span>
<a href="#l8.133"></a><span id="l8.133">               });</span>
<a href="#l8.134"></a><span id="l8.134" class="difflineat">@@ -2445,20 +2445,20 @@</span>
<a href="#l8.135"></a><span id="l8.135">         }</span>
<a href="#l8.136"></a><span id="l8.136">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l8.137"></a><span id="l8.137"> </span>
<a href="#l8.138"></a><span id="l8.138">       &lt;handler event=&quot;mousemove&quot;&gt;&lt;![CDATA[</span>
<a href="#l8.139"></a><span id="l8.139">         if (!this.mInMouseDown) {</span>
<a href="#l8.140"></a><span id="l8.140">             return;</span>
<a href="#l8.141"></a><span id="l8.141">         }</span>
<a href="#l8.142"></a><span id="l8.142"> </span>
<a href="#l8.143"></a><span id="l8.143" class="difflineminus">-        let dx = Math.abs(event.screenX - this.mMouseX);</span>
<a href="#l8.144"></a><span id="l8.144" class="difflineminus">-        let dy = Math.abs(event.screenY - this.mMouseY);</span>
<a href="#l8.145"></a><span id="l8.145" class="difflineplus">+        let deltaX = Math.abs(event.screenX - this.mMouseX);</span>
<a href="#l8.146"></a><span id="l8.146" class="difflineplus">+        let deltaY = Math.abs(event.screenY - this.mMouseY);</span>
<a href="#l8.147"></a><span id="l8.147">         // more than a 3 pixel move?</span>
<a href="#l8.148"></a><span id="l8.148" class="difflineminus">-        if ((dx * dx + dy * dy) &gt; 9) {</span>
<a href="#l8.149"></a><span id="l8.149" class="difflineplus">+        if ((deltaX * deltaX + deltaY * deltaY) &gt; 9) {</span>
<a href="#l8.150"></a><span id="l8.150">             if (this.parentColumn) {</span>
<a href="#l8.151"></a><span id="l8.151">                 if (this.editingTimer) {</span>
<a href="#l8.152"></a><span id="l8.152">                     clearTimeout(this.editingTimer);</span>
<a href="#l8.153"></a><span id="l8.153">                     this.editingTimer = null;</span>
<a href="#l8.154"></a><span id="l8.154">                 }</span>
<a href="#l8.155"></a><span id="l8.155"> </span>
<a href="#l8.156"></a><span id="l8.156">                 this.calendarView.setSelectedItems(1, [this.mOccurrence]);</span>
<a href="#l8.157"></a><span id="l8.157"> </span>
<a href="#l8.158"></a><span id="l8.158" class="difflineat">@@ -2835,19 +2835,19 @@</span>
<a href="#l8.159"></a><span id="l8.159">           targetDate.isDate = true;</span>
<a href="#l8.160"></a><span id="l8.160"> </span>
<a href="#l8.161"></a><span id="l8.161">           if (this.mStartDate &amp;&amp; this.mEndDate) {</span>
<a href="#l8.162"></a><span id="l8.162">               if (this.mStartDate.compare(targetDate) &lt;= 0 &amp;&amp;</span>
<a href="#l8.163"></a><span id="l8.163">                   this.mEndDate.compare(targetDate) &gt;= 0) {</span>
<a href="#l8.164"></a><span id="l8.164">                   return;</span>
<a href="#l8.165"></a><span id="l8.165">               }</span>
<a href="#l8.166"></a><span id="l8.166">           } else if (this.mDateList) {</span>
<a href="#l8.167"></a><span id="l8.167" class="difflineminus">-              for (let d of this.mDateList) {</span>
<a href="#l8.168"></a><span id="l8.168" class="difflineplus">+              for (let date of this.mDateList) {</span>
<a href="#l8.169"></a><span id="l8.169">                   // if date is already visible, nothing to do</span>
<a href="#l8.170"></a><span id="l8.170" class="difflineminus">-                  if (d.compare(targetDate) == 0) {</span>
<a href="#l8.171"></a><span id="l8.171" class="difflineplus">+                  if (date.compare(targetDate) == 0) {</span>
<a href="#l8.172"></a><span id="l8.172">                       return;</span>
<a href="#l8.173"></a><span id="l8.173">                   }</span>
<a href="#l8.174"></a><span id="l8.174">               }</span>
<a href="#l8.175"></a><span id="l8.175">           }</span>
<a href="#l8.176"></a><span id="l8.176"> </span>
<a href="#l8.177"></a><span id="l8.177">           // if we're only showing one date, then continue</span>
<a href="#l8.178"></a><span id="l8.178">           // to only show one date; otherwise, show the week.</span>
<a href="#l8.179"></a><span id="l8.179">           if (this.numVisibleDates == 1) {</span>
<a href="#l8.180"></a><span id="l8.180" class="difflineat">@@ -2914,24 +2914,24 @@</span>
<a href="#l8.181"></a><span id="l8.181">         ]]&gt;&lt;/body&gt;</span>
<a href="#l8.182"></a><span id="l8.182">       &lt;/method&gt;</span>
<a href="#l8.183"></a><span id="l8.183"> </span>
<a href="#l8.184"></a><span id="l8.184">       &lt;method name=&quot;getDateList&quot;&gt;</span>
<a href="#l8.185"></a><span id="l8.185">         &lt;parameter name=&quot;aCount&quot;/&gt;</span>
<a href="#l8.186"></a><span id="l8.186">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l8.187"></a><span id="l8.187">            let dates = [];</span>
<a href="#l8.188"></a><span id="l8.188">            if (this.mStartDate &amp;&amp; this.mEndDate) {</span>
<a href="#l8.189"></a><span id="l8.189" class="difflineminus">-               let d = this.mStartDate.clone();</span>
<a href="#l8.190"></a><span id="l8.190" class="difflineminus">-               while (d.compare(this.mEndDate) &lt;= 0) {</span>
<a href="#l8.191"></a><span id="l8.191" class="difflineplus">+               let date = this.mStartDate.clone();</span>
<a href="#l8.192"></a><span id="l8.192" class="difflineplus">+               while (date.compare(this.mEndDate) &lt;= 0) {</span>
<a href="#l8.193"></a><span id="l8.193">                    dates.push(d.clone());</span>
<a href="#l8.194"></a><span id="l8.194" class="difflineminus">-                   d.day += 1;</span>
<a href="#l8.195"></a><span id="l8.195" class="difflineplus">+                   date.day += 1;</span>
<a href="#l8.196"></a><span id="l8.196">                }</span>
<a href="#l8.197"></a><span id="l8.197">            } else if (this.mDateList) {</span>
<a href="#l8.198"></a><span id="l8.198" class="difflineminus">-               for (let d of this.mDateList) {</span>
<a href="#l8.199"></a><span id="l8.199" class="difflineminus">-                   dates.push(d.clone());</span>
<a href="#l8.200"></a><span id="l8.200" class="difflineplus">+               for (let date of this.mDateList) {</span>
<a href="#l8.201"></a><span id="l8.201" class="difflineplus">+                   dates.push(date.clone());</span>
<a href="#l8.202"></a><span id="l8.202">                }</span>
<a href="#l8.203"></a><span id="l8.203">            }</span>
<a href="#l8.204"></a><span id="l8.204"> </span>
<a href="#l8.205"></a><span id="l8.205">            aCount.value = dates.length;</span>
<a href="#l8.206"></a><span id="l8.206">            return dates;</span>
<a href="#l8.207"></a><span id="l8.207">         ]]&gt;&lt;/body&gt;</span>
<a href="#l8.208"></a><span id="l8.208">       &lt;/method&gt;</span>
<a href="#l8.209"></a><span id="l8.209"> </span>
<a href="#l8.210"></a><span id="l8.210" class="difflineat">@@ -3165,20 +3165,20 @@</span>
<a href="#l8.211"></a><span id="l8.211"> </span>
<a href="#l8.212"></a><span id="l8.212">           let count = 0;</span>
<a href="#l8.213"></a><span id="l8.213"> </span>
<a href="#l8.214"></a><span id="l8.214">           if (!this.mStartDate || !this.mEndDate) {</span>
<a href="#l8.215"></a><span id="l8.215">             // The view has not been initialized, so there are 0 visible dates.</span>
<a href="#l8.216"></a><span id="l8.216">             return count;</span>
<a href="#l8.217"></a><span id="l8.217">           }</span>
<a href="#l8.218"></a><span id="l8.218"> </span>
<a href="#l8.219"></a><span id="l8.219" class="difflineminus">-          let d = this.mStartDate.clone();</span>
<a href="#l8.220"></a><span id="l8.220" class="difflineminus">-          while (d.compare(this.mEndDate) &lt;= 0) {</span>
<a href="#l8.221"></a><span id="l8.221" class="difflineplus">+          let date = this.mStartDate.clone();</span>
<a href="#l8.222"></a><span id="l8.222" class="difflineplus">+          while (date.compare(this.mEndDate) &lt;= 0) {</span>
<a href="#l8.223"></a><span id="l8.223">             count++;</span>
<a href="#l8.224"></a><span id="l8.224" class="difflineminus">-            d.day += 1;</span>
<a href="#l8.225"></a><span id="l8.225" class="difflineplus">+            date.day += 1;</span>
<a href="#l8.226"></a><span id="l8.226">           }</span>
<a href="#l8.227"></a><span id="l8.227"> </span>
<a href="#l8.228"></a><span id="l8.228">           return count;</span>
<a href="#l8.229"></a><span id="l8.229">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l8.230"></a><span id="l8.230">       &lt;/property&gt;</span>
<a href="#l8.231"></a><span id="l8.231"> </span>
<a href="#l8.232"></a><span id="l8.232">       &lt;property name=&quot;orient&quot;&gt;</span>
<a href="#l8.233"></a><span id="l8.233">         &lt;getter&gt;&lt;![CDATA[return this.getAttribute(&quot;orient&quot;) || &quot;vertical&quot;;]]&gt;&lt;/getter&gt;</span>
<a href="#l8.234"></a><span id="l8.234" class="difflineat">@@ -3335,68 +3335,68 @@</span>
<a href="#l8.235"></a><span id="l8.235">           // get today's date</span>
<a href="#l8.236"></a><span id="l8.236">           let today = this.today();</span>
<a href="#l8.237"></a><span id="l8.237">           let counter = 0;</span>
<a href="#l8.238"></a><span id="l8.238">           let dayboxkids = daybox.childNodes;</span>
<a href="#l8.239"></a><span id="l8.239">           let headerboxkids = headerdaybox.childNodes;</span>
<a href="#l8.240"></a><span id="l8.240">           let labelboxkids = this.labeldaybox.childNodes;</span>
<a href="#l8.241"></a><span id="l8.241">           let updateTimeIndicator = false;</span>
<a href="#l8.242"></a><span id="l8.242"> </span>
<a href="#l8.243"></a><span id="l8.243" class="difflineminus">-          for (let d of computedDateList) {</span>
<a href="#l8.244"></a><span id="l8.244" class="difflineplus">+          for (let date of computedDateList) {</span>
<a href="#l8.245"></a><span id="l8.245">               let dayEventsBox;</span>
<a href="#l8.246"></a><span id="l8.246">               if (counter &lt; dayboxkids.length) {</span>
<a href="#l8.247"></a><span id="l8.247">                   dayEventsBox = dayboxkids[counter];</span>
<a href="#l8.248"></a><span id="l8.248">                   dayEventsBox.removeAttribute(&quot;relation&quot;);</span>
<a href="#l8.249"></a><span id="l8.249">                   dayEventsBox.mEventInfos = [];</span>
<a href="#l8.250"></a><span id="l8.250">               } else {</span>
<a href="#l8.251"></a><span id="l8.251">                   dayEventsBox = createXULElement(&quot;calendar-event-column&quot;);</span>
<a href="#l8.252"></a><span id="l8.252">                   dayEventsBox.setAttribute(&quot;flex&quot;, &quot;1&quot;);</span>
<a href="#l8.253"></a><span id="l8.253">                   daybox.appendChild(dayEventsBox);</span>
<a href="#l8.254"></a><span id="l8.254">               }</span>
<a href="#l8.255"></a><span id="l8.255" class="difflineminus">-              setUpDayEventsBox(dayEventsBox, d);</span>
<a href="#l8.256"></a><span id="l8.256" class="difflineplus">+              setUpDayEventsBox(dayEventsBox, date);</span>
<a href="#l8.257"></a><span id="l8.257"> </span>
<a href="#l8.258"></a><span id="l8.258">               let dayHeaderBox;</span>
<a href="#l8.259"></a><span id="l8.259">               if (counter &lt; headerboxkids.length) {</span>
<a href="#l8.260"></a><span id="l8.260">                   dayHeaderBox = headerboxkids[counter];</span>
<a href="#l8.261"></a><span id="l8.261">                   // Delete backwards to make sure we get them all</span>
<a href="#l8.262"></a><span id="l8.262">                   // and delete until no more elements are left.</span>
<a href="#l8.263"></a><span id="l8.263">                   while (dayHeaderBox.mItemBoxes.length != 0) {</span>
<a href="#l8.264"></a><span id="l8.264">                       let num = dayHeaderBox.mItemBoxes.length;</span>
<a href="#l8.265"></a><span id="l8.265">                       dayHeaderBox.deleteEvent(dayHeaderBox.mItemBoxes[num-1].occurrence);</span>
<a href="#l8.266"></a><span id="l8.266">                   }</span>
<a href="#l8.267"></a><span id="l8.267">               } else {</span>
<a href="#l8.268"></a><span id="l8.268">                   dayHeaderBox = createXULElement(&quot;calendar-header-container&quot;);</span>
<a href="#l8.269"></a><span id="l8.269">                   dayHeaderBox.setAttribute(&quot;flex&quot;, &quot;1&quot;);</span>
<a href="#l8.270"></a><span id="l8.270">                   headerdaybox.appendChild(dayHeaderBox);</span>
<a href="#l8.271"></a><span id="l8.271">               }</span>
<a href="#l8.272"></a><span id="l8.272" class="difflineminus">-              setUpDayHeaderBox(dayHeaderBox, d);</span>
<a href="#l8.273"></a><span id="l8.273" class="difflineminus">-</span>
<a href="#l8.274"></a><span id="l8.274" class="difflineminus">-              if (this.mDaysOffArray.indexOf(d.weekday) &gt;= 0) {</span>
<a href="#l8.275"></a><span id="l8.275" class="difflineplus">+              setUpDayHeaderBox(dayHeaderBox, date);</span>
<a href="#l8.276"></a><span id="l8.276" class="difflineplus">+</span>
<a href="#l8.277"></a><span id="l8.277" class="difflineplus">+              if (this.mDaysOffArray.indexOf(date.weekday) &gt;= 0) {</span>
<a href="#l8.278"></a><span id="l8.278">                   dayEventsBox.dayOff = true;</span>
<a href="#l8.279"></a><span id="l8.279">                   dayHeaderBox.setAttribute(&quot;weekend&quot;, &quot;true&quot;);</span>
<a href="#l8.280"></a><span id="l8.280">               } else {</span>
<a href="#l8.281"></a><span id="l8.281">                   dayEventsBox.dayOff = false;</span>
<a href="#l8.282"></a><span id="l8.282">                   dayHeaderBox.removeAttribute(&quot;weekend&quot;);</span>
<a href="#l8.283"></a><span id="l8.283">               }</span>
<a href="#l8.284"></a><span id="l8.284">               let labelbox;</span>
<a href="#l8.285"></a><span id="l8.285">               if (counter &lt; labelboxkids.length) {</span>
<a href="#l8.286"></a><span id="l8.286">                   labelbox = labelboxkids[counter];</span>
<a href="#l8.287"></a><span id="l8.287" class="difflineminus">-                  labelbox.date = d;</span>
<a href="#l8.288"></a><span id="l8.288" class="difflineplus">+                  labelbox.date = date;</span>
<a href="#l8.289"></a><span id="l8.289">               } else {</span>
<a href="#l8.290"></a><span id="l8.290">                   labelbox = createXULElement(&quot;calendar-day-label&quot;);</span>
<a href="#l8.291"></a><span id="l8.291">                   labelbox.setAttribute(&quot;orient&quot;, otherorient);</span>
<a href="#l8.292"></a><span id="l8.292">                   this.labeldaybox.appendChild(labelbox);</span>
<a href="#l8.293"></a><span id="l8.293" class="difflineminus">-                  labelbox.date = d;</span>
<a href="#l8.294"></a><span id="l8.294" class="difflineplus">+                  labelbox.date = date;</span>
<a href="#l8.295"></a><span id="l8.295">               }</span>
<a href="#l8.296"></a><span id="l8.296">               // Set attributes for date relations and for the time indicator.</span>
<a href="#l8.297"></a><span id="l8.297">               let headerDayBox = document.getAnonymousElementByAttribute(</span>
<a href="#l8.298"></a><span id="l8.298">                                      this, &quot;anonid&quot;, &quot;headerdaybox&quot;);</span>
<a href="#l8.299"></a><span id="l8.299">               headerDayBox.removeAttribute(&quot;todaylastinview&quot;);</span>
<a href="#l8.300"></a><span id="l8.300">               dayEventsBox.timeIndicatorBox.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l8.301"></a><span id="l8.301" class="difflineminus">-              switch (d.compare(today)) {</span>
<a href="#l8.302"></a><span id="l8.302" class="difflineplus">+              switch (date.compare(today)) {</span>
<a href="#l8.303"></a><span id="l8.303">                   case -1:</span>
<a href="#l8.304"></a><span id="l8.304">                       dayHeaderBox.setAttribute(&quot;relation&quot;, &quot;past&quot;);</span>
<a href="#l8.305"></a><span id="l8.305">                       dayEventsBox.setAttribute(&quot;relation&quot;, &quot;past&quot;);</span>
<a href="#l8.306"></a><span id="l8.306">                       labelbox.setAttribute(&quot;relation&quot;, &quot;past&quot;);</span>
<a href="#l8.307"></a><span id="l8.307">                       break;</span>
<a href="#l8.308"></a><span id="l8.308">                   case 0:</span>
<a href="#l8.309"></a><span id="l8.309">                       let relation_ = this.numVisibleDates == 1 ? &quot;today1day&quot; : &quot;today&quot;;</span>
<a href="#l8.310"></a><span id="l8.310">                       dayHeaderBox.setAttribute(&quot;relation&quot;, relation_);</span>
<a href="#l8.311"></a><span id="l8.311" class="difflineat">@@ -3418,20 +3418,20 @@</span>
<a href="#l8.312"></a><span id="l8.312">                   case 1:</span>
<a href="#l8.313"></a><span id="l8.313">                       dayHeaderBox.setAttribute(&quot;relation&quot;, &quot;future&quot;);</span>
<a href="#l8.314"></a><span id="l8.314">                       dayEventsBox.setAttribute(&quot;relation&quot;, &quot;future&quot;);</span>
<a href="#l8.315"></a><span id="l8.315">                       labelbox.setAttribute(&quot;relation&quot;, &quot;future&quot;);</span>
<a href="#l8.316"></a><span id="l8.316">                       break;</span>
<a href="#l8.317"></a><span id="l8.317">               }</span>
<a href="#l8.318"></a><span id="l8.318">               // We don't want to actually mess with our original dates, plus</span>
<a href="#l8.319"></a><span id="l8.319">               // they're likely to be immutable.</span>
<a href="#l8.320"></a><span id="l8.320" class="difflineminus">-              let d2 = d.clone();</span>
<a href="#l8.321"></a><span id="l8.321" class="difflineminus">-              d2.isDate = true;</span>
<a href="#l8.322"></a><span id="l8.322" class="difflineminus">-              d2.makeImmutable();</span>
<a href="#l8.323"></a><span id="l8.323" class="difflineminus">-              this.mDateColumns.push({ date: d2, column: dayEventsBox, header: dayHeaderBox });</span>
<a href="#l8.324"></a><span id="l8.324" class="difflineplus">+              let date2 = date.clone();</span>
<a href="#l8.325"></a><span id="l8.325" class="difflineplus">+              date2.isDate = true;</span>
<a href="#l8.326"></a><span id="l8.326" class="difflineplus">+              date2.makeImmutable();</span>
<a href="#l8.327"></a><span id="l8.327" class="difflineplus">+              this.mDateColumns.push({ date: date2, column: dayEventsBox, header: dayHeaderBox });</span>
<a href="#l8.328"></a><span id="l8.328">               counter++;</span>
<a href="#l8.329"></a><span id="l8.329">           }</span>
<a href="#l8.330"></a><span id="l8.330"> </span>
<a href="#l8.331"></a><span id="l8.331">           // Remove any extra columns that may have been hanging around</span>
<a href="#l8.332"></a><span id="l8.332">           function removeExtraKids(elem) {</span>
<a href="#l8.333"></a><span id="l8.333">               while (counter &lt; elem.childNodes.length) {</span>
<a href="#l8.334"></a><span id="l8.334">                   elem.childNodes[counter].remove();</span>
<a href="#l8.335"></a><span id="l8.335">               }</span>
<a href="#l8.336"></a><span id="l8.336" class="difflineat">@@ -3549,20 +3549,20 @@</span>
<a href="#l8.337"></a><span id="l8.337">             return columns;</span>
<a href="#l8.338"></a><span id="l8.338">           }</span>
<a href="#l8.339"></a><span id="l8.339"> </span>
<a href="#l8.340"></a><span id="l8.340">           // Note that these may be dates or datetimes</span>
<a href="#l8.341"></a><span id="l8.341">           let startDate = aItem.startDate || aItem.entryDate || aItem.dueDate;</span>
<a href="#l8.342"></a><span id="l8.342">           if (!startDate) {</span>
<a href="#l8.343"></a><span id="l8.343">               return columns;</span>
<a href="#l8.344"></a><span id="l8.344">           }</span>
<a href="#l8.345"></a><span id="l8.345" class="difflineminus">-          let tz = this.mDateColumns[0].date.timezone;</span>
<a href="#l8.346"></a><span id="l8.346" class="difflineminus">-          let targetDate = startDate.getInTimezone(tz);</span>
<a href="#l8.347"></a><span id="l8.347" class="difflineplus">+          let timezone = this.mDateColumns[0].date.timezone;</span>
<a href="#l8.348"></a><span id="l8.348" class="difflineplus">+          let targetDate = startDate.getInTimezone(timezone);</span>
<a href="#l8.349"></a><span id="l8.349">           let finishDate = (aItem.endDate || aItem.dueDate || aItem.entryDate || startDate)</span>
<a href="#l8.350"></a><span id="l8.350" class="difflineminus">-                               .getInTimezone(tz);</span>
<a href="#l8.351"></a><span id="l8.351" class="difflineplus">+                               .getInTimezone(timezone);</span>
<a href="#l8.352"></a><span id="l8.352"> </span>
<a href="#l8.353"></a><span id="l8.353">           if (!targetDate.isDate) {</span>
<a href="#l8.354"></a><span id="l8.354">             // Set the time to 00:00 so that we get all the boxes</span>
<a href="#l8.355"></a><span id="l8.355">             targetDate.hour = 0;</span>
<a href="#l8.356"></a><span id="l8.356">             targetDate.minute = 0;</span>
<a href="#l8.357"></a><span id="l8.357">             targetDate.second = 0;</span>
<a href="#l8.358"></a><span id="l8.358">           }</span>
<a href="#l8.359"></a><span id="l8.359"> </span>
<a href="#l8.360"></a><span id="l8.360" class="difflineat">@@ -3596,19 +3596,21 @@</span>
<a href="#l8.361"></a><span id="l8.361">       &lt;method name=&quot;findColumnForClientPoint&quot;&gt;</span>
<a href="#l8.362"></a><span id="l8.362">         &lt;parameter name=&quot;aClientX&quot;/&gt;</span>
<a href="#l8.363"></a><span id="l8.363">         &lt;parameter name=&quot;aClientY&quot;/&gt;</span>
<a href="#l8.364"></a><span id="l8.364">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l8.365"></a><span id="l8.365">           if (!this.mDateColumns) {</span>
<a href="#l8.366"></a><span id="l8.366">               return null;</span>
<a href="#l8.367"></a><span id="l8.367">           }</span>
<a href="#l8.368"></a><span id="l8.368">           for (let col of this.mDateColumns) {</span>
<a href="#l8.369"></a><span id="l8.369" class="difflineminus">-              let bo = document.getAnonymousElementByAttribute(col.column, &quot;anonid&quot;, &quot;boxstack&quot;).boxObject;</span>
<a href="#l8.370"></a><span id="l8.370" class="difflineminus">-              if ((aClientX &gt;= bo.screenX) &amp;&amp; (aClientX &lt;= (bo.screenX + bo.width)) &amp;&amp;</span>
<a href="#l8.371"></a><span id="l8.371" class="difflineminus">-                  (aClientY &gt;= bo.screenY) &amp;&amp; (aClientY &lt;= (bo.screenY + bo.height))) {</span>
<a href="#l8.372"></a><span id="l8.372" class="difflineplus">+              let boxObject = document.getAnonymousElementByAttribute(col.column, &quot;anonid&quot;, &quot;boxstack&quot;).boxObject;</span>
<a href="#l8.373"></a><span id="l8.373" class="difflineplus">+              if (aClientX &gt;= boxObject.screenX &amp;&amp;</span>
<a href="#l8.374"></a><span id="l8.374" class="difflineplus">+                  aClientX &lt;= (boxObject.screenX + boxObject.width) &amp;&amp;</span>
<a href="#l8.375"></a><span id="l8.375" class="difflineplus">+                  aClientY &gt;= boxObject.screenY &amp;&amp;</span>
<a href="#l8.376"></a><span id="l8.376" class="difflineplus">+                  aClientY &lt;= (boxObject.screenY + boxObject.height)) {</span>
<a href="#l8.377"></a><span id="l8.377">                   return col.column;</span>
<a href="#l8.378"></a><span id="l8.378">               }</span>
<a href="#l8.379"></a><span id="l8.379">           }</span>
<a href="#l8.380"></a><span id="l8.380">           return null;</span>
<a href="#l8.381"></a><span id="l8.381">         ]]&gt;&lt;/body&gt;</span>
<a href="#l8.382"></a><span id="l8.382">       &lt;/method&gt;</span>
<a href="#l8.383"></a><span id="l8.383"> </span>
<a href="#l8.384"></a><span id="l8.384">       &lt;method name=&quot;adjustScrollbarSpacersForAlldayEvents&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/calendar/base/content/calendar-task-editing.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/calendar/base/content/calendar-task-editing.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -21,22 +21,22 @@ var taskEdit = {</span>
<a href="#l9.4"></a><span id="l9.4">     get observedCalendar() {</span>
<a href="#l9.5"></a><span id="l9.5">         return this.mObservedCalendar;</span>
<a href="#l9.6"></a><span id="l9.6">     },</span>
<a href="#l9.7"></a><span id="l9.7"> </span>
<a href="#l9.8"></a><span id="l9.8">     /**</span>
<a href="#l9.9"></a><span id="l9.9">      * Set the currently observed calendar, removing listeners to any old</span>
<a href="#l9.10"></a><span id="l9.10">      * calendar set and adding listeners to the new one.</span>
<a href="#l9.11"></a><span id="l9.11">      */</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-    set observedCalendar(v) {</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+    set observedCalendar(aCalendar) {</span>
<a href="#l9.14"></a><span id="l9.14">         if (this.mObservedCalendar) {</span>
<a href="#l9.15"></a><span id="l9.15">             this.mObservedCalendar.removeObserver(this.calendarObserver);</span>
<a href="#l9.16"></a><span id="l9.16">         }</span>
<a href="#l9.17"></a><span id="l9.17"> </span>
<a href="#l9.18"></a><span id="l9.18" class="difflineminus">-        this.mObservedCalendar = v;</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineplus">+        this.mObservedCalendar = aCalendar;</span>
<a href="#l9.20"></a><span id="l9.20"> </span>
<a href="#l9.21"></a><span id="l9.21">         if (this.mObservedCalendar) {</span>
<a href="#l9.22"></a><span id="l9.22">             this.mObservedCalendar.addObserver(this.calendarObserver);</span>
<a href="#l9.23"></a><span id="l9.23">         }</span>
<a href="#l9.24"></a><span id="l9.24">         return this.mObservedCalendar;</span>
<a href="#l9.25"></a><span id="l9.25">     },</span>
<a href="#l9.26"></a><span id="l9.26"> </span>
<a href="#l9.27"></a><span id="l9.27">     /**</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/calendar/base/content/calendar-task-tree.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/calendar/base/content/calendar-task-tree.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -157,19 +157,18 @@ function contextChangeTaskProgress(aEven</span>
<a href="#l10.4"></a><span id="l10.4">  * Handler function to change the calendar of the selected tasks. The targeted</span>
<a href="#l10.5"></a><span id="l10.5">  * menuitem must have &quot;calendar&quot; property that implements calICalendar.</span>
<a href="#l10.6"></a><span id="l10.6">  *</span>
<a href="#l10.7"></a><span id="l10.7">  * @param aEvent      The DOM event that triggered this command.</span>
<a href="#l10.8"></a><span id="l10.8">  */</span>
<a href="#l10.9"></a><span id="l10.9"> function contextChangeTaskCalendar(aEvent) {</span>
<a href="#l10.10"></a><span id="l10.10">    startBatchTransaction();</span>
<a href="#l10.11"></a><span id="l10.11">    let tasks = getSelectedTasks(aEvent);</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-   for (let t = 0; t &lt; tasks.length; t++) {</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-       let task = tasks[t];</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineminus">-       let newTask = task.clone().QueryInterface(Components.interfaces.calITodo);</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+   for (let task of tasks) {</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+       let newTask = task.clone();</span>
<a href="#l10.17"></a><span id="l10.17">        newTask.calendar = aEvent.target.calendar;</span>
<a href="#l10.18"></a><span id="l10.18">        doTransaction(&quot;modify&quot;, newTask, newTask.calendar, task, null);</span>
<a href="#l10.19"></a><span id="l10.19">     }</span>
<a href="#l10.20"></a><span id="l10.20">     endBatchTransaction();</span>
<a href="#l10.21"></a><span id="l10.21"> }</span>
<a href="#l10.22"></a><span id="l10.22"> </span>
<a href="#l10.23"></a><span id="l10.23"> /**</span>
<a href="#l10.24"></a><span id="l10.24">  * Handler function to change the priority of the selected tasks, or of</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineat">@@ -232,18 +231,18 @@ function contextPostponeTask(aEvent, aDu</span>
<a href="#l10.26"></a><span id="l10.26"> /**</span>
<a href="#l10.27"></a><span id="l10.27">  * Modifies the selected tasks with the event dialog</span>
<a href="#l10.28"></a><span id="l10.28">  *</span>
<a href="#l10.29"></a><span id="l10.29">  * @param aEvent        The DOM event that triggered this command.</span>
<a href="#l10.30"></a><span id="l10.30">  * @param initialDate   (optional) The initial date for new task datepickers</span>
<a href="#l10.31"></a><span id="l10.31">  */</span>
<a href="#l10.32"></a><span id="l10.32"> function modifyTaskFromContext(aEvent, initialDate) {</span>
<a href="#l10.33"></a><span id="l10.33">     let tasks = getSelectedTasks(aEvent);</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineminus">-    for (let t = 0; t &lt; tasks.length; t++) {</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineminus">-        modifyEventWithDialog(tasks[t], null, true, initialDate);</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineplus">+    for (let task of tasks) {</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineplus">+        modifyEventWithDialog(task, null, true, initialDate);</span>
<a href="#l10.38"></a><span id="l10.38">     }</span>
<a href="#l10.39"></a><span id="l10.39">  }</span>
<a href="#l10.40"></a><span id="l10.40"> </span>
<a href="#l10.41"></a><span id="l10.41"> /**</span>
<a href="#l10.42"></a><span id="l10.42">  *  Delete the current selected item with focus from the task tree</span>
<a href="#l10.43"></a><span id="l10.43">  *</span>
<a href="#l10.44"></a><span id="l10.44">  * @param aEvent          The DOM event that triggered this command.</span>
<a href="#l10.45"></a><span id="l10.45">  * @param aDoNotConfirm   If true, the user will not be asked to delete.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/calendar/base/content/calendar-task-tree.xml</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/calendar/base/content/calendar-task-tree.xml</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -942,21 +942,21 @@</span>
<a href="#l11.4"></a><span id="l11.4"> </span>
<a href="#l11.5"></a><span id="l11.5">               execute: function() {</span>
<a href="#l11.6"></a><span id="l11.6">                   if (aCalendar.id in this.binding.mPendingRefreshJobs) {</span>
<a href="#l11.7"></a><span id="l11.7">                       this.binding.mPendingRefreshJobs[aCalendar.id].cancel();</span>
<a href="#l11.8"></a><span id="l11.8">                   }</span>
<a href="#l11.9"></a><span id="l11.9">                   this.calendar = aCalendar;</span>
<a href="#l11.10"></a><span id="l11.10">                   this.items = [];</span>
<a href="#l11.11"></a><span id="l11.11"> </span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-                  let op = this.binding.mFilter.getItems(aCalendar,</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-                                                         aCalendar.ITEM_FILTER_TYPE_TODO,</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineminus">-                                                         this);</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineminus">-                  if (op &amp;&amp; op.isPending) {</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineminus">-                      this.operation = op;</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineplus">+                  let operation = this.binding.mFilter.getItems(aCalendar,</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineplus">+                                                                aCalendar.ITEM_FILTER_TYPE_TODO,</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineplus">+                                                                this);</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineplus">+                  if (operation &amp;&amp; operation.isPending) {</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineplus">+                      this.operation = operation;</span>
<a href="#l11.22"></a><span id="l11.22">                       this.binding.mPendingRefreshJobs[aCalendar.id] = this;</span>
<a href="#l11.23"></a><span id="l11.23">                   }</span>
<a href="#l11.24"></a><span id="l11.24">               }</span>
<a href="#l11.25"></a><span id="l11.25">           };</span>
<a href="#l11.26"></a><span id="l11.26"> </span>
<a href="#l11.27"></a><span id="l11.27">           refreshJob.execute();</span>
<a href="#l11.28"></a><span id="l11.28">         ]]&gt;&lt;/body&gt;</span>
<a href="#l11.29"></a><span id="l11.29">       &lt;/method&gt;</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineat">@@ -1136,36 +1136,36 @@</span>
<a href="#l11.31"></a><span id="l11.31"> </span>
<a href="#l11.32"></a><span id="l11.32">         let tree = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;calendar-task-tree&quot;);</span>
<a href="#l11.33"></a><span id="l11.33"> </span>
<a href="#l11.34"></a><span id="l11.34">         // let's build the drag region</span>
<a href="#l11.35"></a><span id="l11.35">         let region = null;</span>
<a href="#l11.36"></a><span id="l11.36">         try {</span>
<a href="#l11.37"></a><span id="l11.37">           region = Components.classes[&quot;@mozilla.org/gfx/region;1&quot;].createInstance(Components.interfaces.nsIScriptableRegion);</span>
<a href="#l11.38"></a><span id="l11.38">           region.init();</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineminus">-          let obo = tree.treeBoxObject;</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineminus">-          let bo = obo.treeBody.boxObject;</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineplus">+          let treeBox = tree.treeBox;</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineplus">+          let bodyBox = treeBox.treeBody.boxObject;</span>
<a href="#l11.43"></a><span id="l11.43">           let sel = tree.view.selection;</span>
<a href="#l11.44"></a><span id="l11.44"> </span>
<a href="#l11.45"></a><span id="l11.45" class="difflineminus">-          let rowX = bo.x;</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineminus">-          let rowY = bo.y;</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineminus">-          let rowHeight = obo.rowHeight;</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineminus">-          let rowWidth = bo.width;</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineplus">+          let rowX = bodyBox.x;</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineplus">+          let rowY = bodyBox.y;</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineplus">+          let rowHeight = treeBox.rowHeight;</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineplus">+          let rowWidth = bodyBox.width;</span>
<a href="#l11.53"></a><span id="l11.53"> </span>
<a href="#l11.54"></a><span id="l11.54">           // add a rectangle for each visible selected row</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineminus">-          for (let i = obo.getFirstVisibleRow(); i &lt;= obo.getLastVisibleRow(); i++) {</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineplus">+          for (let i = treeBox.getFirstVisibleRow(); i &lt;= treeBox.getLastVisibleRow(); i++) {</span>
<a href="#l11.57"></a><span id="l11.57">             if (sel.isSelected(i)) {</span>
<a href="#l11.58"></a><span id="l11.58">               region.unionRect(rowX, rowY, rowWidth, rowHeight);</span>
<a href="#l11.59"></a><span id="l11.59">             }</span>
<a href="#l11.60"></a><span id="l11.60">             rowY = rowY + rowHeight;</span>
<a href="#l11.61"></a><span id="l11.61">           }</span>
<a href="#l11.62"></a><span id="l11.62"> </span>
<a href="#l11.63"></a><span id="l11.63">           // and finally, clip the result to be sure we don't spill over...</span>
<a href="#l11.64"></a><span id="l11.64">           if (!region.isEmpty()) {</span>
<a href="#l11.65"></a><span id="l11.65" class="difflineminus">-            region.intersectRect(bo.x, bo.y, bo.width, bo.height);</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineplus">+            region.intersectRect(bodyBox.x, bodyBox.y, bodyBox.width, bodyBox.height);</span>
<a href="#l11.67"></a><span id="l11.67">           }</span>
<a href="#l11.68"></a><span id="l11.68">         } catch (ex) {</span>
<a href="#l11.69"></a><span id="l11.69">           ASSERT(false, &quot;Error while building selection region: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l11.70"></a><span id="l11.70">           region = null;</span>
<a href="#l11.71"></a><span id="l11.71">         }</span>
<a href="#l11.72"></a><span id="l11.72">         invokeEventDragSession(item, event.target);</span>
<a href="#l11.73"></a><span id="l11.73">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l11.74"></a><span id="l11.74">     &lt;/handlers&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/calendar/base/content/calendar-ui-utils.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/calendar/base/content/calendar-ui-utils.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -243,31 +243,31 @@ function removeChildren(aElement) {</span>
<a href="#l12.4"></a><span id="l12.4"> function sortCalendarArray(calendars) {</span>
<a href="#l12.5"></a><span id="l12.5">     let ret = calendars.concat([]);</span>
<a href="#l12.6"></a><span id="l12.6">     let sortOrder = {};</span>
<a href="#l12.7"></a><span id="l12.7">     let sortOrderPref = Preferences.get(&quot;calendar.list.sortOrder&quot;, &quot;&quot;).split(&quot; &quot;);</span>
<a href="#l12.8"></a><span id="l12.8">     for (let i = 0; i &lt; sortOrderPref.length; ++i) {</span>
<a href="#l12.9"></a><span id="l12.9">         sortOrder[sortOrderPref[i]] = i;</span>
<a href="#l12.10"></a><span id="l12.10">     }</span>
<a href="#l12.11"></a><span id="l12.11">     function sortFunc(cal1, cal2) {</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-        let i1 = sortOrder[cal1.id] || -1;</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineminus">-        let i2 = sortOrder[cal2.id] || -1;</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineminus">-        if (i1 &lt; i2) {</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+        let orderIdx1 = sortOrder[cal1.id] || -1;</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineplus">+        let orderIdx2 = sortOrder[cal2.id] || -1;</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineplus">+        if (orderIdx1 &lt; orderIdx2) {</span>
<a href="#l12.18"></a><span id="l12.18">             return -1;</span>
<a href="#l12.19"></a><span id="l12.19">         }</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineminus">-        if (i1 &gt; i2) {</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineplus">+        if (orderIdx1 &gt; orderIdx2) {</span>
<a href="#l12.22"></a><span id="l12.22">             return 1;</span>
<a href="#l12.23"></a><span id="l12.23">         }</span>
<a href="#l12.24"></a><span id="l12.24">         return 0;</span>
<a href="#l12.25"></a><span id="l12.25">     }</span>
<a href="#l12.26"></a><span id="l12.26">     ret.sort(sortFunc);</span>
<a href="#l12.27"></a><span id="l12.27"> </span>
<a href="#l12.28"></a><span id="l12.28">     // check and repair pref:</span>
<a href="#l12.29"></a><span id="l12.29">     let sortOrderString = Preferences.get(&quot;calendar.list.sortOrder&quot;, &quot;&quot;);</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineminus">-    let wantedOrderString = ret.map(c =&gt; c.id).join(&quot; &quot;);</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineplus">+    let wantedOrderString = ret.map(calendar =&gt; calendar.id).join(&quot; &quot;);</span>
<a href="#l12.32"></a><span id="l12.32">     if (wantedOrderString != sortOrderString) {</span>
<a href="#l12.33"></a><span id="l12.33">         Preferences.set(&quot;calendar.list.sortOrder&quot;, wantedOrderString);</span>
<a href="#l12.34"></a><span id="l12.34">     }</span>
<a href="#l12.35"></a><span id="l12.35"> </span>
<a href="#l12.36"></a><span id="l12.36">     return ret;</span>
<a href="#l12.37"></a><span id="l12.37"> }</span>
<a href="#l12.38"></a><span id="l12.38"> </span>
<a href="#l12.39"></a><span id="l12.39"> /**</span>
<a href="#l12.40"></a><span id="l12.40" class="difflineat">@@ -517,21 +517,21 @@ function menuListIndexOf(menuList, value</span>
<a href="#l12.41"></a><span id="l12.41">         }</span>
<a href="#l12.42"></a><span id="l12.42">     }</span>
<a href="#l12.43"></a><span id="l12.43">     return -1; // not found</span>
<a href="#l12.44"></a><span id="l12.44"> }</span>
<a href="#l12.45"></a><span id="l12.45"> </span>
<a href="#l12.46"></a><span id="l12.46"> /**</span>
<a href="#l12.47"></a><span id="l12.47">  * Creates the given element in the XUL namespace.</span>
<a href="#l12.48"></a><span id="l12.48">  *</span>
<a href="#l12.49"></a><span id="l12.49" class="difflineminus">- * @param el    The local name of the element to create.</span>
<a href="#l12.50"></a><span id="l12.50" class="difflineminus">- * @return      The XUL element requested.</span>
<a href="#l12.51"></a><span id="l12.51" class="difflineplus">+ * @param elem      The local name of the element to create.</span>
<a href="#l12.52"></a><span id="l12.52" class="difflineplus">+ * @return          The XUL element requested.</span>
<a href="#l12.53"></a><span id="l12.53">  */</span>
<a href="#l12.54"></a><span id="l12.54" class="difflineminus">-function createXULElement(el) {</span>
<a href="#l12.55"></a><span id="l12.55" class="difflineminus">-    return document.createElementNS(&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;, el);</span>
<a href="#l12.56"></a><span id="l12.56" class="difflineplus">+function createXULElement(elem) {</span>
<a href="#l12.57"></a><span id="l12.57" class="difflineplus">+    return document.createElementNS(&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;, elem);</span>
<a href="#l12.58"></a><span id="l12.58"> }</span>
<a href="#l12.59"></a><span id="l12.59"> </span>
<a href="#l12.60"></a><span id="l12.60"> /**</span>
<a href="#l12.61"></a><span id="l12.61">  * A helper function to calculate and add up certain css-values of a box.</span>
<a href="#l12.62"></a><span id="l12.62">  * It is required, that all css values can be converted to integers</span>
<a href="#l12.63"></a><span id="l12.63">  * see also</span>
<a href="#l12.64"></a><span id="l12.64">  * http://www.w3.org/TR/DOM-Level-2-Style/css.html#CSS-CSSview-getComputedStyle</span>
<a href="#l12.65"></a><span id="l12.65">  * @param aXULElement   The xul element to be inspected.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/calendar/base/content/calendar-unifinder.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/calendar/base/content/calendar-unifinder.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -331,22 +331,22 @@ function unifinderSelect(event) {</span>
<a href="#l13.4"></a><span id="l13.4">     let selectedItems = [];</span>
<a href="#l13.5"></a><span id="l13.5">     gCalendarEventTreeClicked = true;</span>
<a href="#l13.6"></a><span id="l13.6"> </span>
<a href="#l13.7"></a><span id="l13.7">     // Get the selected events from the tree</span>
<a href="#l13.8"></a><span id="l13.8">     let start = {};</span>
<a href="#l13.9"></a><span id="l13.9">     let end = {};</span>
<a href="#l13.10"></a><span id="l13.10">     let numRanges = tree.view.selection.getRangeCount();</span>
<a href="#l13.11"></a><span id="l13.11"> </span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-    for (let t = 0; t &lt; numRanges; t++) {</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-        tree.view.selection.getRangeAt(t, start, end);</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+    for (let range = 0; range &lt; numRanges; range++) {</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+        tree.view.selection.getRangeAt(range, start, end);</span>
<a href="#l13.16"></a><span id="l13.16"> </span>
<a href="#l13.17"></a><span id="l13.17" class="difflineminus">-        for (let v = start.value; v &lt;= end.value; v++) {</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineplus">+        for (let i = start.value; i &lt;= end.value; i++) {</span>
<a href="#l13.19"></a><span id="l13.19">             try {</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineminus">-                selectedItems.push(unifinderTreeView.getItemAt(v));</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineplus">+                selectedItems.push(unifinderTreeView.getItemAt(i));</span>
<a href="#l13.22"></a><span id="l13.22">             } catch (e) {</span>
<a href="#l13.23"></a><span id="l13.23">                WARN(&quot;Error getting Event from row: &quot; + e + &quot;\n&quot;);</span>
<a href="#l13.24"></a><span id="l13.24">             }</span>
<a href="#l13.25"></a><span id="l13.25">         }</span>
<a href="#l13.26"></a><span id="l13.26">     }</span>
<a href="#l13.27"></a><span id="l13.27"> </span>
<a href="#l13.28"></a><span id="l13.28">     if (selectedItems.length == 1) {</span>
<a href="#l13.29"></a><span id="l13.29">         // Go to the day of the selected item in the current view.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/calendar/base/content/calendar-views.xml</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/calendar/base/content/calendar-views.xml</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -89,30 +89,30 @@</span>
<a href="#l14.4"></a><span id="l14.4">                 &lt;body&gt;&lt;![CDATA[</span>
<a href="#l14.5"></a><span id="l14.5">                     this.displayDaysOff = !this.mWorkdaysOnly;</span>
<a href="#l14.6"></a><span id="l14.6"> </span>
<a href="#l14.7"></a><span id="l14.7">                     if (!aDate) {</span>
<a href="#l14.8"></a><span id="l14.8">                         this.refresh();</span>
<a href="#l14.9"></a><span id="l14.9">                         return;</span>
<a href="#l14.10"></a><span id="l14.10">                     }</span>
<a href="#l14.11"></a><span id="l14.11">                     aDate = aDate.getInTimezone(this.timezone);</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-                    let d1 = getWeekInfoService().getStartOfWeek(aDate);</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineminus">-                    let d2 = d1.clone();</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineminus">-                    d2.day += 6;</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineminus">-                    this.setDateRange(d1, d2);</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineplus">+                    let weekStart = getWeekInfoService().getStartOfWeek(aDate);</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineplus">+                    let weekEnd = weekStart.clone();</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineplus">+                    weekEnd.day += 6;</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineplus">+                    this.setDateRange(weekStart, weekEnd);</span>
<a href="#l14.20"></a><span id="l14.20">                     this.selectedDay = aDate;</span>
<a href="#l14.21"></a><span id="l14.21">                 ]]&gt;&lt;/body&gt;</span>
<a href="#l14.22"></a><span id="l14.22">             &lt;/method&gt;</span>
<a href="#l14.23"></a><span id="l14.23">             &lt;method name=&quot;moveView&quot;&gt;</span>
<a href="#l14.24"></a><span id="l14.24">                 &lt;parameter name=&quot;aNumber&quot;/&gt;</span>
<a href="#l14.25"></a><span id="l14.25">                 &lt;body&gt;&lt;![CDATA[</span>
<a href="#l14.26"></a><span id="l14.26">                     if (aNumber) {</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineminus">-                        let d1 = this.selectedDay.clone();</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineminus">-                        d1.day += 7 * aNumber;</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineminus">-                        this.goToDay(d1);</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineplus">+                        let date = this.selectedDay.clone();</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineplus">+                        date.day += 7 * aNumber;</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineplus">+                        this.goToDay(date);</span>
<a href="#l14.33"></a><span id="l14.33">                     } else {</span>
<a href="#l14.34"></a><span id="l14.34">                         this.goToDay(now());</span>
<a href="#l14.35"></a><span id="l14.35">                     }</span>
<a href="#l14.36"></a><span id="l14.36">                 ]]&gt;&lt;/body&gt;</span>
<a href="#l14.37"></a><span id="l14.37">             &lt;/method&gt;</span>
<a href="#l14.38"></a><span id="l14.38">         &lt;/implementation&gt;</span>
<a href="#l14.39"></a><span id="l14.39">     &lt;/binding&gt;</span>
<a href="#l14.40"></a><span id="l14.40"> </span>
<a href="#l14.41"></a><span id="l14.41" class="difflineat">@@ -180,38 +180,38 @@</span>
<a href="#l14.42"></a><span id="l14.42">                     // If aDate is null it means that only a refresh is needed</span>
<a href="#l14.43"></a><span id="l14.43">                     // without changing the start and end of the view.</span>
<a href="#l14.44"></a><span id="l14.44">                     if (aDate) {</span>
<a href="#l14.45"></a><span id="l14.45">                         aDate = aDate.getInTimezone(this.timezone);</span>
<a href="#l14.46"></a><span id="l14.46">                         // Get the first date that should be shown. This is the</span>
<a href="#l14.47"></a><span id="l14.47">                         // start of the week of the day that we're centering around</span>
<a href="#l14.48"></a><span id="l14.48">                         // adjusted for the day the week starts on and the number</span>
<a href="#l14.49"></a><span id="l14.49">                         // of previous weeks we're supposed to display.</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineminus">-                        let d1 = getWeekInfoService().getStartOfWeek(aDate);</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineminus">-                        d1.day -= (7 * Preferences.get(&quot;calendar.previousweeks.inview&quot;, 0));</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineplus">+                        let dayStart = getWeekInfoService().getStartOfWeek(aDate);</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineplus">+                        dayStart.day -= (7 * Preferences.get(&quot;calendar.previousweeks.inview&quot;, 0));</span>
<a href="#l14.54"></a><span id="l14.54">                         // The last day we're supposed to show</span>
<a href="#l14.55"></a><span id="l14.55" class="difflineminus">-                        let d2 = d1.clone();</span>
<a href="#l14.56"></a><span id="l14.56" class="difflineminus">-                        d2.day += ((7 * this.mWeeksInView) - 1);</span>
<a href="#l14.57"></a><span id="l14.57" class="difflineminus">-                        this.setDateRange(d1, d2);</span>
<a href="#l14.58"></a><span id="l14.58" class="difflineplus">+                        let dayEnd = dayStart.clone();</span>
<a href="#l14.59"></a><span id="l14.59" class="difflineplus">+                        dayEnd.day += ((7 * this.mWeeksInView) - 1);</span>
<a href="#l14.60"></a><span id="l14.60" class="difflineplus">+                        this.setDateRange(dayStart, dayEnd);</span>
<a href="#l14.61"></a><span id="l14.61">                         this.selectedDay = aDate;</span>
<a href="#l14.62"></a><span id="l14.62">                     } else {</span>
<a href="#l14.63"></a><span id="l14.63">                         this.refresh();</span>
<a href="#l14.64"></a><span id="l14.64">                     }</span>
<a href="#l14.65"></a><span id="l14.65">                 ]]&gt;&lt;/body&gt;</span>
<a href="#l14.66"></a><span id="l14.66">             &lt;/method&gt;</span>
<a href="#l14.67"></a><span id="l14.67">             &lt;method name=&quot;moveView&quot;&gt;</span>
<a href="#l14.68"></a><span id="l14.68">                 &lt;parameter name=&quot;aNumber&quot;/&gt;</span>
<a href="#l14.69"></a><span id="l14.69">                 &lt;body&gt;&lt;![CDATA[</span>
<a href="#l14.70"></a><span id="l14.70">                     if (aNumber) {</span>
<a href="#l14.71"></a><span id="l14.71" class="difflineminus">-                        let d1 = this.startDay.clone();</span>
<a href="#l14.72"></a><span id="l14.72" class="difflineplus">+                        let date = this.startDay.clone();</span>
<a href="#l14.73"></a><span id="l14.73">                         let savedSelectedDay = this.selectedDay.clone();</span>
<a href="#l14.74"></a><span id="l14.74">                         // aNumber only corresponds to the number of weeks to move</span>
<a href="#l14.75"></a><span id="l14.75">                         // make sure to compensate for previous weeks in view too</span>
<a href="#l14.76"></a><span id="l14.76" class="difflineminus">-                        d1.day += 7 * (aNumber + Preferences.get(&quot;calendar.previousweeks.inview&quot;, 4));</span>
<a href="#l14.77"></a><span id="l14.77" class="difflineminus">-                        this.goToDay(d1);</span>
<a href="#l14.78"></a><span id="l14.78" class="difflineplus">+                        date.day += 7 * (aNumber + Preferences.get(&quot;calendar.previousweeks.inview&quot;, 4));</span>
<a href="#l14.79"></a><span id="l14.79" class="difflineplus">+                        this.goToDay(date);</span>
<a href="#l14.80"></a><span id="l14.80">                         savedSelectedDay.day += 7 * aNumber;</span>
<a href="#l14.81"></a><span id="l14.81">                         this.selectedDay = savedSelectedDay;</span>
<a href="#l14.82"></a><span id="l14.82">                     } else {</span>
<a href="#l14.83"></a><span id="l14.83">                         let date = now();</span>
<a href="#l14.84"></a><span id="l14.84">                         this.goToDay(date);</span>
<a href="#l14.85"></a><span id="l14.85">                         this.selectedDay = date;</span>
<a href="#l14.86"></a><span id="l14.86">                     }</span>
<a href="#l14.87"></a><span id="l14.87">                 ]]&gt;&lt;/body&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-creation.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-creation.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -5,42 +5,42 @@</span>
<a href="#l15.4"></a><span id="l15.4"> /* exported openLocalCalendar */</span>
<a href="#l15.5"></a><span id="l15.5"> </span>
<a href="#l15.6"></a><span id="l15.6"> /**</span>
<a href="#l15.7"></a><span id="l15.7">  * Shows the filepicker and creates a new calendar with a local file using the ICS</span>
<a href="#l15.8"></a><span id="l15.8">  * provider.</span>
<a href="#l15.9"></a><span id="l15.9">  */</span>
<a href="#l15.10"></a><span id="l15.10"> function openLocalCalendar() {</span>
<a href="#l15.11"></a><span id="l15.11">     const nsIFilePicker = Components.interfaces.nsIFilePicker;</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-    let fp = Components.classes[&quot;@mozilla.org/filepicker;1&quot;].createInstance(nsIFilePicker);</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineminus">-    fp.init(window, calGetString(&quot;calendar&quot;, &quot;Open&quot;), nsIFilePicker.modeOpen);</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineplus">+    let picker = Components.classes[&quot;@mozilla.org/filepicker;1&quot;].createInstance(nsIFilePicker);</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineplus">+    picker.init(window, calGetString(&quot;calendar&quot;, &quot;Open&quot;), nsIFilePicker.modeOpen);</span>
<a href="#l15.16"></a><span id="l15.16">     let wildmat = &quot;*.ics&quot;;</span>
<a href="#l15.17"></a><span id="l15.17">     let description = calGetString(&quot;calendar&quot;, &quot;filterIcs&quot;, [wildmat]);</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineminus">-    fp.appendFilter(description, wildmat);</span>
<a href="#l15.19"></a><span id="l15.19" class="difflineminus">-    fp.appendFilters(nsIFilePicker.filterAll);</span>
<a href="#l15.20"></a><span id="l15.20" class="difflineplus">+    picker.appendFilter(description, wildmat);</span>
<a href="#l15.21"></a><span id="l15.21" class="difflineplus">+    picker.appendFilters(nsIFilePicker.filterAll);</span>
<a href="#l15.22"></a><span id="l15.22"> </span>
<a href="#l15.23"></a><span id="l15.23" class="difflineminus">-    if (fp.show() != nsIFilePicker.returnOK) {</span>
<a href="#l15.24"></a><span id="l15.24" class="difflineplus">+    if (picker.show() != nsIFilePicker.returnOK) {</span>
<a href="#l15.25"></a><span id="l15.25">         return;</span>
<a href="#l15.26"></a><span id="l15.26">     }</span>
<a href="#l15.27"></a><span id="l15.27"> </span>
<a href="#l15.28"></a><span id="l15.28">     let calMgr = getCalendarManager();</span>
<a href="#l15.29"></a><span id="l15.29">     let calendars = calMgr.getCalendars({});</span>
<a href="#l15.30"></a><span id="l15.30" class="difflineminus">-    if (calendars.some(x =&gt; x.uri == fp.fileURL)) {</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineplus">+    if (calendars.some(x =&gt; x.uri == picker.fileURL)) {</span>
<a href="#l15.32"></a><span id="l15.32">         // The calendar already exists, select it and return.</span>
<a href="#l15.33"></a><span id="l15.33">         document.getElementById(&quot;calendar-list-tree-widget&quot;)</span>
<a href="#l15.34"></a><span id="l15.34">                 .tree.view.selection.select(index);</span>
<a href="#l15.35"></a><span id="l15.35">         return;</span>
<a href="#l15.36"></a><span id="l15.36">     }</span>
<a href="#l15.37"></a><span id="l15.37"> </span>
<a href="#l15.38"></a><span id="l15.38" class="difflineminus">-    let openCalendar = calMgr.createCalendar(&quot;ics&quot;, fp.fileURL);</span>
<a href="#l15.39"></a><span id="l15.39" class="difflineplus">+    let openCalendar = calMgr.createCalendar(&quot;ics&quot;, picker.fileURL);</span>
<a href="#l15.40"></a><span id="l15.40"> </span>
<a href="#l15.41"></a><span id="l15.41">     // Strip &quot;.ics&quot; from filename for use as calendar name, taken from</span>
<a href="#l15.42"></a><span id="l15.42">     // calendarCreation.js</span>
<a href="#l15.43"></a><span id="l15.43">     let fullPathRegex = new RegExp(&quot;([^/:]+)[.]ics$&quot;);</span>
<a href="#l15.44"></a><span id="l15.44" class="difflineminus">-    let prettyName = fp.fileURL.spec.match(fullPathRegex);</span>
<a href="#l15.45"></a><span id="l15.45" class="difflineplus">+    let prettyName = picker.fileURL.spec.match(fullPathRegex);</span>
<a href="#l15.46"></a><span id="l15.46">     let name;</span>
<a href="#l15.47"></a><span id="l15.47"> </span>
<a href="#l15.48"></a><span id="l15.48">     if (prettyName &amp;&amp; prettyName.length &gt;= 1) {</span>
<a href="#l15.49"></a><span id="l15.49">         name = decodeURIComponent(prettyName[1]);</span>
<a href="#l15.50"></a><span id="l15.50">     } else {</span>
<a href="#l15.51"></a><span id="l15.51">         name = calGetString(&quot;calendar&quot;, &quot;untitledCalendarName&quot;);</span>
<a href="#l15.52"></a><span id="l15.52">     }</span>
<a href="#l15.53"></a><span id="l15.53">     openCalendar.name = name;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-dialog-utils.js</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-dialog-utils.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -596,34 +596,34 @@ function setupAttendees() {</span>
<a href="#l16.4"></a><span id="l16.4">                 let newCell = clonedCell.cloneNode(true);</span>
<a href="#l16.5"></a><span id="l16.5">                 let cell = row.appendChild(newCell);</span>
<a href="#l16.6"></a><span id="l16.6">                 let icon = cell.getElementsByTagName(&quot;img&quot;)[0];</span>
<a href="#l16.7"></a><span id="l16.7">                 let text = cell.getElementsByTagName(&quot;label&quot;)[0];</span>
<a href="#l16.8"></a><span id="l16.8">                 let attendee = window.attendees[attCount];</span>
<a href="#l16.9"></a><span id="l16.9"> </span>
<a href="#l16.10"></a><span id="l16.10">                 let label = (attendee.commonName &amp;&amp; attendee.commonName.length)</span>
<a href="#l16.11"></a><span id="l16.11">                             ? attendee.commonName : attendee.toString();</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-                let ut = attendee.userType || &quot;INDIVIDUAL&quot;;</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+                let userType = attendee.userType || &quot;INDIVIDUAL&quot;;</span>
<a href="#l16.14"></a><span id="l16.14">                 let role = attendee.role || &quot;REQ-PARTICIPANT&quot;;</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineminus">-                let ps = attendee.participationStatus || &quot;NEEDS-ACTION&quot;;</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineplus">+                let partstat = attendee.participationStatus || &quot;NEEDS-ACTION&quot;;</span>
<a href="#l16.17"></a><span id="l16.17"> </span>
<a href="#l16.18"></a><span id="l16.18" class="difflineminus">-                icon.setAttribute(&quot;partstat&quot;, ps);</span>
<a href="#l16.19"></a><span id="l16.19" class="difflineminus">-                icon.setAttribute(&quot;usertype&quot;, ut);</span>
<a href="#l16.20"></a><span id="l16.20" class="difflineplus">+                icon.setAttribute(&quot;partstat&quot;, partstat);</span>
<a href="#l16.21"></a><span id="l16.21" class="difflineplus">+                icon.setAttribute(&quot;usertype&quot;, userType);</span>
<a href="#l16.22"></a><span id="l16.22">                 icon.setAttribute(&quot;role&quot;, role);</span>
<a href="#l16.23"></a><span id="l16.23">                 cell.setAttribute(&quot;attendeeid&quot;, attendee.id);</span>
<a href="#l16.24"></a><span id="l16.24">                 cell.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l16.25"></a><span id="l16.25"> </span>
<a href="#l16.26"></a><span id="l16.26" class="difflineminus">-                let utString = cal.calGetString(&quot;calendar&quot;, &quot;dialog.tooltip.attendeeUserType2.&quot; + ut,</span>
<a href="#l16.27"></a><span id="l16.27" class="difflineminus">-                                                [attendee.toString()]);</span>
<a href="#l16.28"></a><span id="l16.28" class="difflineplus">+                let userTypeString = cal.calGetString(&quot;calendar&quot;, &quot;dialog.tooltip.attendeeUserType2.&quot; + userType,</span>
<a href="#l16.29"></a><span id="l16.29" class="difflineplus">+                                                      [attendee.toString()]);</span>
<a href="#l16.30"></a><span id="l16.30">                 let roleString = cal.calGetString(&quot;calendar&quot;, &quot;dialog.tooltip.attendeeRole2.&quot; + role,</span>
<a href="#l16.31"></a><span id="l16.31" class="difflineminus">-                                                  [utString]);</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineminus">-                let psString = cal.calGetString(&quot;calendar&quot;, &quot;dialog.tooltip.attendeePartStat2.&quot; + ps,</span>
<a href="#l16.33"></a><span id="l16.33" class="difflineminus">-                                                [label]);</span>
<a href="#l16.34"></a><span id="l16.34" class="difflineplus">+                                                  [userTypeString]);</span>
<a href="#l16.35"></a><span id="l16.35" class="difflineplus">+                let partstatString = cal.calGetString(&quot;calendar&quot;, &quot;dialog.tooltip.attendeePartStat2.&quot; + partstat,</span>
<a href="#l16.36"></a><span id="l16.36" class="difflineplus">+                                                      [label]);</span>
<a href="#l16.37"></a><span id="l16.37">                 let tooltip = cal.calGetString(&quot;calendar&quot;, &quot;dialog.tooltip.attendee.combined&quot;,</span>
<a href="#l16.38"></a><span id="l16.38" class="difflineminus">-                                               [roleString, psString]);</span>
<a href="#l16.39"></a><span id="l16.39" class="difflineplus">+                                               [roleString, partstatString]);</span>
<a href="#l16.40"></a><span id="l16.40"> </span>
<a href="#l16.41"></a><span id="l16.41">                 let del = cal.resolveDelegation(attendee, window.attendees);</span>
<a href="#l16.42"></a><span id="l16.42">                 if (del.delegators != &quot;&quot;) {</span>
<a href="#l16.43"></a><span id="l16.43">                     del.delegators = cal.calGetString(&quot;calendar&quot;,</span>
<a href="#l16.44"></a><span id="l16.44">                                                       &quot;dialog.attendee.append.delegatedFrom&quot;,</span>
<a href="#l16.45"></a><span id="l16.45">                                                       [del.delegators]);</span>
<a href="#l16.46"></a><span id="l16.46">                     label += &quot; &quot; + del.delegators;</span>
<a href="#l16.47"></a><span id="l16.47">                     tooltip += &quot; &quot; + del.delegators;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-event-dialog-attendees.xml</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-event-dialog-attendees.xml</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -226,25 +226,25 @@</span>
<a href="#l17.4"></a><span id="l17.4">               input.setAttribute(&quot;id&quot;, &quot;attendeeCol3#&quot; + rowNumber);</span>
<a href="#l17.5"></a><span id="l17.5">           }</span>
<a href="#l17.6"></a><span id="l17.6"> </span>
<a href="#l17.7"></a><span id="l17.7">           if (!aAttendee) {</span>
<a href="#l17.8"></a><span id="l17.8">               aAttendee = this.createAttendee();</span>
<a href="#l17.9"></a><span id="l17.9">           }</span>
<a href="#l17.10"></a><span id="l17.10"> </span>
<a href="#l17.11"></a><span id="l17.11">           // construct the display string from common name and/or email address.</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-          let cn = aAttendee.commonName || &quot;&quot;;</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+          let commonName = aAttendee.commonName || &quot;&quot;;</span>
<a href="#l17.14"></a><span id="l17.14">           let inputValue = cal.removeMailTo(aAttendee.id || &quot;&quot;);</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineminus">-          if (cn.length) {</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineplus">+          if (commonName.length) {</span>
<a href="#l17.17"></a><span id="l17.17">               // Make the commonName appear in quotes if it contains a</span>
<a href="#l17.18"></a><span id="l17.18">               // character that could confuse the header parser</span>
<a href="#l17.19"></a><span id="l17.19" class="difflineminus">-              if (cn.search(/[,;&lt;&gt;@]/) != -1) {</span>
<a href="#l17.20"></a><span id="l17.20" class="difflineminus">-                  cn = '&quot;' + cn + '&quot;';</span>
<a href="#l17.21"></a><span id="l17.21" class="difflineplus">+              if (commonName.search(/[,;&lt;&gt;@]/) != -1) {</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineplus">+                  commonName = '&quot;' + commonName + '&quot;';</span>
<a href="#l17.23"></a><span id="l17.23">               }</span>
<a href="#l17.24"></a><span id="l17.24" class="difflineminus">-              inputValue = inputValue.length ? cn + &quot; &lt;&quot; + inputValue + &quot;&gt;&quot; : cn;</span>
<a href="#l17.25"></a><span id="l17.25" class="difflineplus">+              inputValue = inputValue.length ? commonName + &quot; &lt;&quot; + inputValue + &quot;&gt;&quot; : commonName;</span>
<a href="#l17.26"></a><span id="l17.26">           }</span>
<a href="#l17.27"></a><span id="l17.27"> </span>
<a href="#l17.28"></a><span id="l17.28">           // trim spaces if any</span>
<a href="#l17.29"></a><span id="l17.29">           inputValue = inputValue.trim();</span>
<a href="#l17.30"></a><span id="l17.30"> </span>
<a href="#l17.31"></a><span id="l17.31">           // don't set value with null, otherwise autocomplete stops working,</span>
<a href="#l17.32"></a><span id="l17.32">           // but make sure attendee and dirty are set</span>
<a href="#l17.33"></a><span id="l17.33">           if (inputValue.length) {</span>
<a href="#l17.34"></a><span id="l17.34" class="difflineat">@@ -488,49 +488,40 @@</span>
<a href="#l17.35"></a><span id="l17.35">         ]]&gt;&lt;/body&gt;</span>
<a href="#l17.36"></a><span id="l17.36">     &lt;/method&gt;</span>
<a href="#l17.37"></a><span id="l17.37"> </span>
<a href="#l17.38"></a><span id="l17.38">     &lt;method name=&quot;_getListEntriesInt&quot;&gt;</span>
<a href="#l17.39"></a><span id="l17.39">         &lt;parameter name=&quot;mailingList&quot;/&gt;</span>
<a href="#l17.40"></a><span id="l17.40">         &lt;parameter name=&quot;attendees&quot;/&gt;</span>
<a href="#l17.41"></a><span id="l17.41">         &lt;parameter name=&quot;allListsUri&quot;/&gt;</span>
<a href="#l17.42"></a><span id="l17.42">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l17.43"></a><span id="l17.43" class="difflineminus">-            function in_list(aList, listid) {</span>
<a href="#l17.44"></a><span id="l17.44" class="difflineminus">-              for (let l = 0; l &lt; aList.length; l++) {</span>
<a href="#l17.45"></a><span id="l17.45" class="difflineminus">-                if (aList[l] === listid) {</span>
<a href="#l17.46"></a><span id="l17.46" class="difflineminus">-                  return true;</span>
<a href="#l17.47"></a><span id="l17.47" class="difflineminus">-                }</span>
<a href="#l17.48"></a><span id="l17.48" class="difflineminus">-              }</span>
<a href="#l17.49"></a><span id="l17.49" class="difflineminus">-              return false;</span>
<a href="#l17.50"></a><span id="l17.50" class="difflineminus">-            }</span>
<a href="#l17.51"></a><span id="l17.51" class="difflineminus">-</span>
<a href="#l17.52"></a><span id="l17.52">             let addressLists = mailingList.addressLists;</span>
<a href="#l17.53"></a><span id="l17.53">             for (let i = 0; i &lt; addressLists.length; i++) {</span>
<a href="#l17.54"></a><span id="l17.54">               let abCard = addressLists.queryElementAt(i, Components.interfaces.nsIAbCard);</span>
<a href="#l17.55"></a><span id="l17.55">               let thisId = abCard.primaryEmail;</span>
<a href="#l17.56"></a><span id="l17.56">               if (abCard.displayName.length &gt; 0) {</span>
<a href="#l17.57"></a><span id="l17.57">                   let rCn = abCard.displayName;</span>
<a href="#l17.58"></a><span id="l17.58">                   if (rCn.includes(&quot;,&quot;)) {</span>
<a href="#l17.59"></a><span id="l17.59">                       rCn = '&quot;' + rCn + '&quot;';</span>
<a href="#l17.60"></a><span id="l17.60">                   }</span>
<a href="#l17.61"></a><span id="l17.61">                   thisId = rCn + &quot; &lt;&quot; + thisId + &quot;&gt;&quot;;</span>
<a href="#l17.62"></a><span id="l17.62">               }</span>
<a href="#l17.63"></a><span id="l17.63" class="difflineminus">-              if (in_list(attendees, thisId)) {</span>
<a href="#l17.64"></a><span id="l17.64" class="difflineplus">+              if (attendees.some(att =&gt; att == thisId)) {</span>
<a href="#l17.65"></a><span id="l17.65">                 continue;</span>
<a href="#l17.66"></a><span id="l17.66">               }</span>
<a href="#l17.67"></a><span id="l17.67"> </span>
<a href="#l17.68"></a><span id="l17.68">               if (abCard.displayName.length &gt; 0) {</span>
<a href="#l17.69"></a><span id="l17.69" class="difflineminus">-                let ml = this._findListInAddrBooks(abCard.displayName);</span>
<a href="#l17.70"></a><span id="l17.70" class="difflineminus">-                if (ml) {</span>
<a href="#l17.71"></a><span id="l17.71" class="difflineminus">-                  if (in_list(allListsUri, ml.URI)) {</span>
<a href="#l17.72"></a><span id="l17.72" class="difflineplus">+                let list = this._findListInAddrBooks(abCard.displayName);</span>
<a href="#l17.73"></a><span id="l17.73" class="difflineplus">+                if (list) {</span>
<a href="#l17.74"></a><span id="l17.74" class="difflineplus">+                  if (allListsUri.some(uri =&gt; uri == list.URI)) {</span>
<a href="#l17.75"></a><span id="l17.75">                     continue;</span>
<a href="#l17.76"></a><span id="l17.76">                   }</span>
<a href="#l17.77"></a><span id="l17.77" class="difflineminus">-                  allListsUri.push(ml.URI);</span>
<a href="#l17.78"></a><span id="l17.78" class="difflineplus">+                  allListsUri.push(list.URI);</span>
<a href="#l17.79"></a><span id="l17.79"> </span>
<a href="#l17.80"></a><span id="l17.80" class="difflineminus">-                  this._getListEntriesInt(ml, attendees, allListsUri);</span>
<a href="#l17.81"></a><span id="l17.81" class="difflineplus">+                  this._getListEntriesInt(list, attendees, allListsUri);</span>
<a href="#l17.82"></a><span id="l17.82"> </span>
<a href="#l17.83"></a><span id="l17.83">                   continue;</span>
<a href="#l17.84"></a><span id="l17.84">                 }</span>
<a href="#l17.85"></a><span id="l17.85">               }</span>
<a href="#l17.86"></a><span id="l17.86"> </span>
<a href="#l17.87"></a><span id="l17.87">               attendees.push(thisId);</span>
<a href="#l17.88"></a><span id="l17.88">             }</span>
<a href="#l17.89"></a><span id="l17.89"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-event-dialog-recurrence-preview.xml</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-event-dialog-recurrence-preview.xml</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -142,25 +142,25 @@</span>
<a href="#l18.4"></a><span id="l18.4"> </span>
<a href="#l18.5"></a><span id="l18.5">           this.updateContent();</span>
<a href="#l18.6"></a><span id="l18.6">           this.updatePreview(this.mRecurrenceInfo);</span>
<a href="#l18.7"></a><span id="l18.7">         ]]&gt;&lt;/body&gt;</span>
<a href="#l18.8"></a><span id="l18.8">       &lt;/method&gt;</span>
<a href="#l18.9"></a><span id="l18.9"> </span>
<a href="#l18.10"></a><span id="l18.10">       &lt;method name=&quot;updateContent&quot;&gt;</span>
<a href="#l18.11"></a><span id="l18.11">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-          let dt = cal.dateTimeToJsDate(this.dateTime);</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+          let date = cal.dateTimeToJsDate(this.dateTime);</span>
<a href="#l18.14"></a><span id="l18.14">           let row = document.getAnonymousElementByAttribute(</span>
<a href="#l18.15"></a><span id="l18.15">                         this, &quot;anonid&quot;, &quot;row&quot;);</span>
<a href="#l18.16"></a><span id="l18.16">           while (row) {</span>
<a href="#l18.17"></a><span id="l18.17">               let numChilds = row.childNodes.length - 1;</span>
<a href="#l18.18"></a><span id="l18.18">               for (let i = 0; i &lt; numChilds; i++) {</span>
<a href="#l18.19"></a><span id="l18.19">                   let minimonth = row.childNodes[i];</span>
<a href="#l18.20"></a><span id="l18.20" class="difflineminus">-                  minimonth.showMonth(dt);</span>
<a href="#l18.21"></a><span id="l18.21" class="difflineminus">-                  dt.setMonth(dt.getMonth() + 1);</span>
<a href="#l18.22"></a><span id="l18.22" class="difflineplus">+                  minimonth.showMonth(date);</span>
<a href="#l18.23"></a><span id="l18.23" class="difflineplus">+                  date.setMonth(date.getMonth() + 1);</span>
<a href="#l18.24"></a><span id="l18.24">               }</span>
<a href="#l18.25"></a><span id="l18.25">               row = row.nextSibling;</span>
<a href="#l18.26"></a><span id="l18.26">           }</span>
<a href="#l18.27"></a><span id="l18.27">         ]]&gt;&lt;/body&gt;</span>
<a href="#l18.28"></a><span id="l18.28">       &lt;/method&gt;</span>
<a href="#l18.29"></a><span id="l18.29"> </span>
<a href="#l18.30"></a><span id="l18.30">       &lt;method name=&quot;updatePreview&quot;&gt;</span>
<a href="#l18.31"></a><span id="l18.31">         &lt;parameter name=&quot;aRecurrenceInfo&quot;/&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-event-dialog-recurrence.js</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-event-dialog-recurrence.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -97,17 +97,17 @@ function initializeControls(rule) {</span>
<a href="#l19.4"></a><span id="l19.4">             }</span>
<a href="#l19.5"></a><span id="l19.5">             document.getElementById(&quot;yearly-group&quot;).selectedIndex = 0;</span>
<a href="#l19.6"></a><span id="l19.6">             setElementValue(&quot;yearly-days&quot;, aByMonthDay);</span>
<a href="#l19.7"></a><span id="l19.7">         }</span>
<a href="#l19.8"></a><span id="l19.8">     }</span>
<a href="#l19.9"></a><span id="l19.9"> </span>
<a href="#l19.10"></a><span id="l19.10">     function everyWeekDay(aByDay) {</span>
<a href="#l19.11"></a><span id="l19.11">         // Checks if aByDay contains only values from 1 to 7 with any order.</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-        let mask = aByDay.reduce((v, c) =&gt; v | (1 &lt;&lt; c), 1);</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+        let mask = aByDay.reduce((value, item) =&gt; value | (1 &lt;&lt; item), 1);</span>
<a href="#l19.14"></a><span id="l19.14">         return aByDay.length == 7 &amp;&amp; mask == Math.pow(2, 8) - 1;</span>
<a href="#l19.15"></a><span id="l19.15">     }</span>
<a href="#l19.16"></a><span id="l19.16"> </span>
<a href="#l19.17"></a><span id="l19.17">     switch (rule.type) {</span>
<a href="#l19.18"></a><span id="l19.18">         case &quot;DAILY&quot;:</span>
<a href="#l19.19"></a><span id="l19.19">             document.getElementById(&quot;period-list&quot;).selectedIndex = 0;</span>
<a href="#l19.20"></a><span id="l19.20">             setElementValue(&quot;daily-days&quot;, rule.interval);</span>
<a href="#l19.21"></a><span id="l19.21">             break;</span>
<a href="#l19.22"></a><span id="l19.22" class="difflineat">@@ -502,24 +502,24 @@ function enableRecurrenceFields(aAttribu</span>
<a href="#l19.23"></a><span id="l19.23">  * XXX This function is duplicate from calendar-dialog-utils.js, which we may</span>
<a href="#l19.24"></a><span id="l19.24">  * want to include in this dialog.</span>
<a href="#l19.25"></a><span id="l19.25">  *</span>
<a href="#l19.26"></a><span id="l19.26">  * @param recurrenceInfo    An item's recurrence info to parse.</span>
<a href="#l19.27"></a><span id="l19.27">  * @return                  An array with two elements: an array of positive</span>
<a href="#l19.28"></a><span id="l19.28">  *                            rules and an array of negative rules.</span>
<a href="#l19.29"></a><span id="l19.29">  */</span>
<a href="#l19.30"></a><span id="l19.30"> function splitRecurrenceRules(recurrenceInfo) {</span>
<a href="#l19.31"></a><span id="l19.31" class="difflineminus">-    let ritems = recurrenceInfo.getRecurrenceItems({});</span>
<a href="#l19.32"></a><span id="l19.32" class="difflineplus">+    let recItems = recurrenceInfo.getRecurrenceItems({});</span>
<a href="#l19.33"></a><span id="l19.33">     let rules = [];</span>
<a href="#l19.34"></a><span id="l19.34">     let exceptions = [];</span>
<a href="#l19.35"></a><span id="l19.35" class="difflineminus">-    for (let r of ritems) {</span>
<a href="#l19.36"></a><span id="l19.36" class="difflineminus">-        if (r.isNegative) {</span>
<a href="#l19.37"></a><span id="l19.37" class="difflineminus">-            exceptions.push(r);</span>
<a href="#l19.38"></a><span id="l19.38" class="difflineplus">+    for (let recItem of recItems) {</span>
<a href="#l19.39"></a><span id="l19.39" class="difflineplus">+        if (recItem.isNegative) {</span>
<a href="#l19.40"></a><span id="l19.40" class="difflineplus">+            exceptions.push(recItem);</span>
<a href="#l19.41"></a><span id="l19.41">         } else {</span>
<a href="#l19.42"></a><span id="l19.42" class="difflineminus">-            rules.push(r);</span>
<a href="#l19.43"></a><span id="l19.43" class="difflineplus">+            rules.push(recItem);</span>
<a href="#l19.44"></a><span id="l19.44">         }</span>
<a href="#l19.45"></a><span id="l19.45">     }</span>
<a href="#l19.46"></a><span id="l19.46">     return [rules, exceptions];</span>
<a href="#l19.47"></a><span id="l19.47"> }</span>
<a href="#l19.48"></a><span id="l19.48"> </span>
<a href="#l19.49"></a><span id="l19.49"> /**</span>
<a href="#l19.50"></a><span id="l19.50">  * Handler function to update the period-deck when an item from the period-list</span>
<a href="#l19.51"></a><span id="l19.51">  * is selected. Also updates the controls on that deck.</span>
<a href="#l19.52"></a><span id="l19.52" class="difflineat">@@ -753,20 +753,20 @@ function changeOrderForElements(aPropKey</span>
<a href="#l19.53"></a><span id="l19.53"> </span>
<a href="#l19.54"></a><span id="l19.54">     try {</span>
<a href="#l19.55"></a><span id="l19.55">         localeOrder = calGetString(&quot;calendar-event-dialog&quot;,</span>
<a href="#l19.56"></a><span id="l19.56">                                    aPropKey,</span>
<a href="#l19.57"></a><span id="l19.57">                                    aPropParams);</span>
<a href="#l19.58"></a><span id="l19.58"> </span>
<a href="#l19.59"></a><span id="l19.59">         localeOrder = localeOrder.split(&quot; &quot;);</span>
<a href="#l19.60"></a><span id="l19.60">     } catch (ex) {</span>
<a href="#l19.61"></a><span id="l19.61" class="difflineminus">-        let s = &quot;The key &quot; + aPropKey + &quot; in calendar-event-dialog.prop&quot; +</span>
<a href="#l19.62"></a><span id="l19.62" class="difflineminus">-                &quot;erties has incorrect number of params. Expected &quot; +</span>
<a href="#l19.63"></a><span id="l19.63" class="difflineminus">-                aPropParams.length + &quot; params.&quot;;</span>
<a href="#l19.64"></a><span id="l19.64" class="difflineminus">-        Components.utils.reportError(s + &quot; &quot; + ex);</span>
<a href="#l19.65"></a><span id="l19.65" class="difflineplus">+        let msg = &quot;The key &quot; + aPropKey + &quot; in calendar-event-dialog.prop&quot; +</span>
<a href="#l19.66"></a><span id="l19.66" class="difflineplus">+                  &quot;erties has incorrect number of params. Expected &quot; +</span>
<a href="#l19.67"></a><span id="l19.67" class="difflineplus">+                  aPropParams.length + &quot; params.&quot;;</span>
<a href="#l19.68"></a><span id="l19.68" class="difflineplus">+        Components.utils.reportError(msg + &quot; &quot; + ex);</span>
<a href="#l19.69"></a><span id="l19.69">         return;</span>
<a href="#l19.70"></a><span id="l19.70">     }</span>
<a href="#l19.71"></a><span id="l19.71"> </span>
<a href="#l19.72"></a><span id="l19.72">     // Add elements in the right order, removing them from their old parent</span>
<a href="#l19.73"></a><span id="l19.73">     for (let i = 0; i &lt; aPropParams.length; i++) {</span>
<a href="#l19.74"></a><span id="l19.74">         let newEl = document.getElementById(localeOrder[i]);</span>
<a href="#l19.75"></a><span id="l19.75">         if (newEl) {</span>
<a href="#l19.76"></a><span id="l19.76">             parents[i].appendChild(newEl.parentNode.removeChild(newEl));</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-event-dialog-timezone.js</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-event-dialog-timezone.js</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -29,21 +29,21 @@ function onLoad() {</span>
<a href="#l20.4"></a><span id="l20.4">     if (args.calendar.getProperty(&quot;capabilities.timezones.UTC.supported&quot;) !== false) {</span>
<a href="#l20.5"></a><span id="l20.5">         addMenuItem(tzMenuPopup, UTC().displayName, UTC().tzid);</span>
<a href="#l20.6"></a><span id="l20.6">     }</span>
<a href="#l20.7"></a><span id="l20.7"> </span>
<a href="#l20.8"></a><span id="l20.8">     let enumerator = tzProvider.timezoneIds;</span>
<a href="#l20.9"></a><span id="l20.9">     let tzids = {};</span>
<a href="#l20.10"></a><span id="l20.10">     let displayNames = [];</span>
<a href="#l20.11"></a><span id="l20.11">     while (enumerator.hasMore()) {</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-        let tz = tzProvider.getTimezone(enumerator.getNext());</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineminus">-        if (tz &amp;&amp; !tz.isFloating &amp;&amp; !tz.isUTC) {</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineminus">-            let displayName = tz.displayName;</span>
<a href="#l20.15"></a><span id="l20.15" class="difflineplus">+        let timezone = tzProvider.getTimezone(enumerator.getNext());</span>
<a href="#l20.16"></a><span id="l20.16" class="difflineplus">+        if (timezone &amp;&amp; !timezone.isFloating &amp;&amp; !timezone.isUTC) {</span>
<a href="#l20.17"></a><span id="l20.17" class="difflineplus">+            let displayName = timezone.displayName;</span>
<a href="#l20.18"></a><span id="l20.18">             displayNames.push(displayName);</span>
<a href="#l20.19"></a><span id="l20.19" class="difflineminus">-            tzids[displayName] = tz.tzid;</span>
<a href="#l20.20"></a><span id="l20.20" class="difflineplus">+            tzids[displayName] = timezone.tzid;</span>
<a href="#l20.21"></a><span id="l20.21">         }</span>
<a href="#l20.22"></a><span id="l20.22">     }</span>
<a href="#l20.23"></a><span id="l20.23">     // the display names need to be sorted</span>
<a href="#l20.24"></a><span id="l20.24">     displayNames.sort(String.localeCompare);</span>
<a href="#l20.25"></a><span id="l20.25">     for (let i = 0; i &lt; displayNames.length; ++i) {</span>
<a href="#l20.26"></a><span id="l20.26">         let displayName = displayNames[i];</span>
<a href="#l20.27"></a><span id="l20.27">         addMenuItem(tzMenuPopup, displayName, tzids[displayName]);</span>
<a href="#l20.28"></a><span id="l20.28">     }</span>
<a href="#l20.29"></a><span id="l20.29" class="difflineat">@@ -85,52 +85,52 @@ function findTimezone(timezone) {</span>
<a href="#l20.30"></a><span id="l20.30"> </span>
<a href="#l20.31"></a><span id="l20.31"> /**</span>
<a href="#l20.32"></a><span id="l20.32">  * Handler function to call when the timezone selection has changed. Updates the</span>
<a href="#l20.33"></a><span id="l20.33">  * timezone-time field and the timezone-stack.</span>
<a href="#l20.34"></a><span id="l20.34">  */</span>
<a href="#l20.35"></a><span id="l20.35"> function updateTimezone() {</span>
<a href="#l20.36"></a><span id="l20.36">     let menulist = document.getElementById(&quot;timezone-menulist&quot;);</span>
<a href="#l20.37"></a><span id="l20.37">     let menuitem = menulist.selectedItem;</span>
<a href="#l20.38"></a><span id="l20.38" class="difflineminus">-    let tz = window.tzProvider.getTimezone(menuitem.getAttribute(&quot;value&quot;));</span>
<a href="#l20.39"></a><span id="l20.39" class="difflineplus">+    let timezone = window.tzProvider.getTimezone(menuitem.getAttribute(&quot;value&quot;));</span>
<a href="#l20.40"></a><span id="l20.40"> </span>
<a href="#l20.41"></a><span id="l20.41">     // convert the date/time to the currently selected timezone</span>
<a href="#l20.42"></a><span id="l20.42">     // and display the result in the appropriate control.</span>
<a href="#l20.43"></a><span id="l20.43">     // before feeding the date/time value into the control we need</span>
<a href="#l20.44"></a><span id="l20.44">     // to set the timezone to 'floating' in order to avoid the</span>
<a href="#l20.45"></a><span id="l20.45">     // automatic conversion back into the OS timezone.</span>
<a href="#l20.46"></a><span id="l20.46">     let datetime = document.getElementById(&quot;timezone-time&quot;);</span>
<a href="#l20.47"></a><span id="l20.47" class="difflineminus">-    let time = window.time.getInTimezone(tz);</span>
<a href="#l20.48"></a><span id="l20.48" class="difflineplus">+    let time = window.time.getInTimezone(timezone);</span>
<a href="#l20.49"></a><span id="l20.49">     time.timezone = cal.floating();</span>
<a href="#l20.50"></a><span id="l20.50">     datetime.value = cal.dateTimeToJsDate(time);</span>
<a href="#l20.51"></a><span id="l20.51"> </span>
<a href="#l20.52"></a><span id="l20.52">     // don't highlight any timezone in the map by default</span>
<a href="#l20.53"></a><span id="l20.53">     let standardTZOffset = &quot;none&quot;;</span>
<a href="#l20.54"></a><span id="l20.54" class="difflineminus">-    if (tz.isUTC) {</span>
<a href="#l20.55"></a><span id="l20.55" class="difflineplus">+    if (timezone.isUTC) {</span>
<a href="#l20.56"></a><span id="l20.56">         standardTZOffset = &quot;+0000&quot;;</span>
<a href="#l20.57"></a><span id="l20.57" class="difflineminus">-    } else if (!tz.isFloating) {</span>
<a href="#l20.58"></a><span id="l20.58" class="difflineminus">-        let standard = tz.icalComponent.getFirstSubcomponent(&quot;STANDARD&quot;);</span>
<a href="#l20.59"></a><span id="l20.59" class="difflineplus">+    } else if (!timezone.isFloating) {</span>
<a href="#l20.60"></a><span id="l20.60" class="difflineplus">+        let standard = timezone.icalComponent.getFirstSubcomponent(&quot;STANDARD&quot;);</span>
<a href="#l20.61"></a><span id="l20.61">         // any reason why valueAsIcalString is used instead of plain value? xxx todo: ask mickey</span>
<a href="#l20.62"></a><span id="l20.62">         standardTZOffset = standard.getFirstProperty(&quot;TZOFFSETTO&quot;).valueAsIcalString;</span>
<a href="#l20.63"></a><span id="l20.63">     }</span>
<a href="#l20.64"></a><span id="l20.64"> </span>
<a href="#l20.65"></a><span id="l20.65">     let image = document.getElementById(&quot;highlighter&quot;);</span>
<a href="#l20.66"></a><span id="l20.66">     image.setAttribute(&quot;tzid&quot;, standardTZOffset);</span>
<a href="#l20.67"></a><span id="l20.67"> }</span>
<a href="#l20.68"></a><span id="l20.68"> /**</span>
<a href="#l20.69"></a><span id="l20.69">  * Handler function to be called when the accept button is pressed.</span>
<a href="#l20.70"></a><span id="l20.70">  *</span>
<a href="#l20.71"></a><span id="l20.71">  * @return      Returns true if the window should be closed</span>
<a href="#l20.72"></a><span id="l20.72">  */</span>
<a href="#l20.73"></a><span id="l20.73"> function onAccept() {</span>
<a href="#l20.74"></a><span id="l20.74">     let menulist = document.getElementById(&quot;timezone-menulist&quot;);</span>
<a href="#l20.75"></a><span id="l20.75">     let menuitem = menulist.selectedItem;</span>
<a href="#l20.76"></a><span id="l20.76" class="difflineminus">-    let timezone = menuitem.getAttribute(&quot;value&quot;);</span>
<a href="#l20.77"></a><span id="l20.77" class="difflineminus">-    let tz = window.tzProvider.getTimezone(timezone);</span>
<a href="#l20.78"></a><span id="l20.78" class="difflineminus">-    let datetime = window.time.getInTimezone(tz);</span>
<a href="#l20.79"></a><span id="l20.79" class="difflineplus">+    let timezoneString = menuitem.getAttribute(&quot;value&quot;);</span>
<a href="#l20.80"></a><span id="l20.80" class="difflineplus">+    let timezone = window.tzProvider.getTimezone(timezoneString);</span>
<a href="#l20.81"></a><span id="l20.81" class="difflineplus">+    let datetime = window.time.getInTimezone(timezone);</span>
<a href="#l20.82"></a><span id="l20.82">     window.onAcceptCallback(datetime);</span>
<a href="#l20.83"></a><span id="l20.83">     return true;</span>
<a href="#l20.84"></a><span id="l20.84"> }</span>
<a href="#l20.85"></a><span id="l20.85"> </span>
<a href="#l20.86"></a><span id="l20.86"> /**</span>
<a href="#l20.87"></a><span id="l20.87">  * Handler function to be called when the cancel button is pressed.</span>
<a href="#l20.88"></a><span id="l20.88">  *</span>
<a href="#l20.89"></a><span id="l20.89">  */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-subscriptions-dialog.js</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-subscriptions-dialog.js</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -101,36 +101,36 @@ function onSearch() {</span>
<a href="#l21.4"></a><span id="l21.4">     richListBox.clear();</span>
<a href="#l21.5"></a><span id="l21.5"> </span>
<a href="#l21.6"></a><span id="l21.6">     let registeredCals = {};</span>
<a href="#l21.7"></a><span id="l21.7">     for (let calendar of getCalendarManager().getCalendars({})) {</span>
<a href="#l21.8"></a><span id="l21.8">         registeredCals[calendar.id] = true;</span>
<a href="#l21.9"></a><span id="l21.9">     }</span>
<a href="#l21.10"></a><span id="l21.10"> </span>
<a href="#l21.11"></a><span id="l21.11">     let opListener = {</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-        onResult: function(op, result) {</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+        onResult: function(operation, result) {</span>
<a href="#l21.14"></a><span id="l21.14">             if (result) {</span>
<a href="#l21.15"></a><span id="l21.15">                 for (let calendar of result) {</span>
<a href="#l21.16"></a><span id="l21.16">                     richListBox.addCalendar(calendar, registeredCals[calendar.id]);</span>
<a href="#l21.17"></a><span id="l21.17">                 }</span>
<a href="#l21.18"></a><span id="l21.18">             }</span>
<a href="#l21.19"></a><span id="l21.19" class="difflineminus">-            if (!op.isPending) {</span>
<a href="#l21.20"></a><span id="l21.20" class="difflineplus">+            if (!operation.isPending) {</span>
<a href="#l21.21"></a><span id="l21.21">                 let statusDeck = document.getElementById(&quot;status-deck&quot;);</span>
<a href="#l21.22"></a><span id="l21.22">                 if (richListBox.getRowCount() &gt; 0) {</span>
<a href="#l21.23"></a><span id="l21.23">                     statusDeck.selectedIndex = 0;</span>
<a href="#l21.24"></a><span id="l21.24">                 } else {</span>
<a href="#l21.25"></a><span id="l21.25">                     statusDeck.selectedIndex = 2;</span>
<a href="#l21.26"></a><span id="l21.26">                 }</span>
<a href="#l21.27"></a><span id="l21.27">             }</span>
<a href="#l21.28"></a><span id="l21.28">         }</span>
<a href="#l21.29"></a><span id="l21.29">     };</span>
<a href="#l21.30"></a><span id="l21.30"> </span>
<a href="#l21.31"></a><span id="l21.31" class="difflineminus">-    let op = getCalendarSearchService().searchForCalendars(document.getElementById(&quot;search-textbox&quot;).value,</span>
<a href="#l21.32"></a><span id="l21.32" class="difflineplus">+    let operation = getCalendarSearchService().searchForCalendars(document.getElementById(&quot;search-textbox&quot;).value,</span>
<a href="#l21.33"></a><span id="l21.33">                                                            0 /* hints */, 50, opListener);</span>
<a href="#l21.34"></a><span id="l21.34" class="difflineminus">-    if (op &amp;&amp; op.isPending) {</span>
<a href="#l21.35"></a><span id="l21.35" class="difflineplus">+    if (operation &amp;&amp; operation.isPending) {</span>
<a href="#l21.36"></a><span id="l21.36">         gCurrentSearchOperation = op;</span>
<a href="#l21.37"></a><span id="l21.37">         document.getElementById(&quot;status-deck&quot;).selectedIndex = 1;</span>
<a href="#l21.38"></a><span id="l21.38">     }</span>
<a href="#l21.39"></a><span id="l21.39"> }</span>
<a href="#l21.40"></a><span id="l21.40"> </span>
<a href="#l21.41"></a><span id="l21.41"> /**</span>
<a href="#l21.42"></a><span id="l21.42">  * Markes the selected item in the subscriptions-listbox for subscribing. The</span>
<a href="#l21.43"></a><span id="l21.43">  * actual subscribe happens when the window is closed.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-summary-dialog.js</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-summary-dialog.js</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -118,33 +118,33 @@ function onLoad() {</span>
<a href="#l22.4"></a><span id="l22.4">     let organizer = item.organizer;</span>
<a href="#l22.5"></a><span id="l22.5">     if (organizer &amp;&amp; organizer.id) {</span>
<a href="#l22.6"></a><span id="l22.6">         document.getElementById(&quot;organizer-row&quot;).removeAttribute(&quot;hidden&quot;);</span>
<a href="#l22.7"></a><span id="l22.7">         let cell = document.getElementsByClassName(&quot;item-organizer-cell&quot;)[0];</span>
<a href="#l22.8"></a><span id="l22.8">         let text = cell.getElementsByTagName(&quot;label&quot;)[0];</span>
<a href="#l22.9"></a><span id="l22.9">         let icon = cell.getElementsByTagName(&quot;img&quot;)[0];</span>
<a href="#l22.10"></a><span id="l22.10"> </span>
<a href="#l22.11"></a><span id="l22.11">         let role = organizer.role || &quot;REQ-PARTICIPANT&quot;;</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-        let ut = organizer.userType || &quot;INDIVIDUAL&quot;;</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineminus">-        let ps = organizer.participationStatus || &quot;NEEDS-ACTION&quot;;</span>
<a href="#l22.14"></a><span id="l22.14" class="difflineplus">+        let userType = organizer.userType || &quot;INDIVIDUAL&quot;;</span>
<a href="#l22.15"></a><span id="l22.15" class="difflineplus">+        let partstat = organizer.participationStatus || &quot;NEEDS-ACTION&quot;;</span>
<a href="#l22.16"></a><span id="l22.16">         let orgName = (organizer.commonName &amp;&amp; organizer.commonName.length)</span>
<a href="#l22.17"></a><span id="l22.17" class="difflineminus">-                      ? organizer.commonName : organizer.toString();</span>
<a href="#l22.18"></a><span id="l22.18" class="difflineminus">-        let utString = cal.calGetString(&quot;calendar&quot;, &quot;dialog.tooltip.attendeeUserType2.&quot; + ut,</span>
<a href="#l22.19"></a><span id="l22.19" class="difflineminus">-                                        [organizer.toString()]);</span>
<a href="#l22.20"></a><span id="l22.20" class="difflineplus">+                       ? organizer.commonName : organizer.toString();</span>
<a href="#l22.21"></a><span id="l22.21" class="difflineplus">+        let userTypeString = cal.calGetString(&quot;calendar&quot;, &quot;dialog.tooltip.attendeeUserType2.&quot; + userType,</span>
<a href="#l22.22"></a><span id="l22.22" class="difflineplus">+                                              [organizer.toString()]);</span>
<a href="#l22.23"></a><span id="l22.23">         let roleString = cal.calGetString(&quot;calendar&quot;, &quot;dialog.tooltip.attendeeRole2.&quot; + role,</span>
<a href="#l22.24"></a><span id="l22.24" class="difflineminus">-                                          [utString]);</span>
<a href="#l22.25"></a><span id="l22.25" class="difflineminus">-        let psString = cal.calGetString(&quot;calendar&quot;, &quot;dialog.tooltip.attendeePartStat2.&quot; + ps,</span>
<a href="#l22.26"></a><span id="l22.26" class="difflineminus">-                                       [orgName]);</span>
<a href="#l22.27"></a><span id="l22.27" class="difflineminus">-        let tt = cal.calGetString(&quot;calendar&quot;, &quot;dialog.tooltip.attendee.combined&quot;,</span>
<a href="#l22.28"></a><span id="l22.28" class="difflineminus">-                                  [roleString, psString]);</span>
<a href="#l22.29"></a><span id="l22.29" class="difflineplus">+                                          [userTypeString]);</span>
<a href="#l22.30"></a><span id="l22.30" class="difflineplus">+        let partstatString = cal.calGetString(&quot;calendar&quot;, &quot;dialog.tooltip.attendeePartStat2.&quot; + partstat,</span>
<a href="#l22.31"></a><span id="l22.31" class="difflineplus">+                                             [orgName]);</span>
<a href="#l22.32"></a><span id="l22.32" class="difflineplus">+        let tooltip = cal.calGetString(&quot;calendar&quot;, &quot;dialog.tooltip.attendee.combined&quot;,</span>
<a href="#l22.33"></a><span id="l22.33" class="difflineplus">+                                       [roleString, partstatString]);</span>
<a href="#l22.34"></a><span id="l22.34"> </span>
<a href="#l22.35"></a><span id="l22.35">         text.setAttribute(&quot;value&quot;, orgName);</span>
<a href="#l22.36"></a><span id="l22.36" class="difflineminus">-        cell.setAttribute(&quot;tooltiptext&quot;, tt);</span>
<a href="#l22.37"></a><span id="l22.37" class="difflineminus">-        icon.setAttribute(&quot;partstat&quot;, ps);</span>
<a href="#l22.38"></a><span id="l22.38" class="difflineminus">-        icon.setAttribute(&quot;usertype&quot;, ut);</span>
<a href="#l22.39"></a><span id="l22.39" class="difflineplus">+        cell.setAttribute(&quot;tooltiptext&quot;, tooltip);</span>
<a href="#l22.40"></a><span id="l22.40" class="difflineplus">+        icon.setAttribute(&quot;partstat&quot;, partstat);</span>
<a href="#l22.41"></a><span id="l22.41" class="difflineplus">+        icon.setAttribute(&quot;usertype&quot;, userType);</span>
<a href="#l22.42"></a><span id="l22.42">         icon.setAttribute(&quot;role&quot;, role);</span>
<a href="#l22.43"></a><span id="l22.43">     }</span>
<a href="#l22.44"></a><span id="l22.44"> </span>
<a href="#l22.45"></a><span id="l22.45">     let status = item.getProperty(&quot;STATUS&quot;);</span>
<a href="#l22.46"></a><span id="l22.46">     if (status &amp;&amp; status.length) {</span>
<a href="#l22.47"></a><span id="l22.47">         let statusRow = document.getElementById(&quot;status-row&quot;);</span>
<a href="#l22.48"></a><span id="l22.48">         for (let i = 0; i &lt; statusRow.childNodes.length; i++) {</span>
<a href="#l22.49"></a><span id="l22.49">             if (statusRow.childNodes[i].getAttribute(&quot;status&quot;) == status) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/calendar/base/content/import-export.js</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/calendar/base/content/import-export.js</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -16,22 +16,22 @@ var MODE_TRUNCATE = 0x20;</span>
<a href="#l23.4"></a><span id="l23.4">  * Shows a file dialog, reads the selected file(s) and tries to parse events from it.</span>
<a href="#l23.5"></a><span id="l23.5">  *</span>
<a href="#l23.6"></a><span id="l23.6">  * @param aCalendar  (optional) If specified, the items will be imported directly</span>
<a href="#l23.7"></a><span id="l23.7">  *                              into the calendar</span>
<a href="#l23.8"></a><span id="l23.8">  */</span>
<a href="#l23.9"></a><span id="l23.9"> function loadEventsFromFile(aCalendar) {</span>
<a href="#l23.10"></a><span id="l23.10">     const nsIFilePicker = Components.interfaces.nsIFilePicker;</span>
<a href="#l23.11"></a><span id="l23.11"> </span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-    let fp = Components.classes[&quot;@mozilla.org/filepicker;1&quot;]</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineminus">-                       .createInstance(nsIFilePicker);</span>
<a href="#l23.14"></a><span id="l23.14" class="difflineminus">-    fp.init(window,</span>
<a href="#l23.15"></a><span id="l23.15" class="difflineminus">-            calGetString(&quot;calendar&quot;, &quot;filepickerTitleImport&quot;),</span>
<a href="#l23.16"></a><span id="l23.16" class="difflineminus">-            nsIFilePicker.modeOpen);</span>
<a href="#l23.17"></a><span id="l23.17" class="difflineminus">-    fp.defaultExtension = &quot;ics&quot;;</span>
<a href="#l23.18"></a><span id="l23.18" class="difflineplus">+    let picker = Components.classes[&quot;@mozilla.org/filepicker;1&quot;]</span>
<a href="#l23.19"></a><span id="l23.19" class="difflineplus">+                           .createInstance(nsIFilePicker);</span>
<a href="#l23.20"></a><span id="l23.20" class="difflineplus">+    picker.init(window,</span>
<a href="#l23.21"></a><span id="l23.21" class="difflineplus">+                calGetString(&quot;calendar&quot;, &quot;filepickerTitleImport&quot;),</span>
<a href="#l23.22"></a><span id="l23.22" class="difflineplus">+                nsIFilePicker.modeOpen);</span>
<a href="#l23.23"></a><span id="l23.23" class="difflineplus">+    picker.defaultExtension = &quot;ics&quot;;</span>
<a href="#l23.24"></a><span id="l23.24"> </span>
<a href="#l23.25"></a><span id="l23.25">     // Get a list of importers</span>
<a href="#l23.26"></a><span id="l23.26">     let contractids = [];</span>
<a href="#l23.27"></a><span id="l23.27">     let catman = Components.classes[&quot;@mozilla.org/categorymanager;1&quot;]</span>
<a href="#l23.28"></a><span id="l23.28">                            .getService(Components.interfaces.nsICategoryManager);</span>
<a href="#l23.29"></a><span id="l23.29">     let catenum = catman.enumerateCategory(&quot;cal-importers&quot;);</span>
<a href="#l23.30"></a><span id="l23.30">     let currentListLength = 0;</span>
<a href="#l23.31"></a><span id="l23.31">     let defaultCIDIndex = 0;</span>
<a href="#l23.32"></a><span id="l23.32" class="difflineat">@@ -44,48 +44,48 @@ function loadEventsFromFile(aCalendar) {</span>
<a href="#l23.33"></a><span id="l23.33">             importer = Components.classes[contractid]</span>
<a href="#l23.34"></a><span id="l23.34">                                  .getService(Components.interfaces.calIImporter);</span>
<a href="#l23.35"></a><span id="l23.35">         } catch (e) {</span>
<a href="#l23.36"></a><span id="l23.36">             cal.WARN(&quot;Could not initialize importer: &quot; + contractid + &quot;\nError: &quot; + e);</span>
<a href="#l23.37"></a><span id="l23.37">             continue;</span>
<a href="#l23.38"></a><span id="l23.38">         }</span>
<a href="#l23.39"></a><span id="l23.39">         let types = importer.getFileTypes({});</span>
<a href="#l23.40"></a><span id="l23.40">         for (let type of types) {</span>
<a href="#l23.41"></a><span id="l23.41" class="difflineminus">-            fp.appendFilter(type.description, type.extensionFilter);</span>
<a href="#l23.42"></a><span id="l23.42" class="difflineminus">-            if (type.extensionFilter == &quot;*.&quot; + fp.defaultExtension) {</span>
<a href="#l23.43"></a><span id="l23.43" class="difflineminus">-                fp.filterIndex = currentListLength;</span>
<a href="#l23.44"></a><span id="l23.44" class="difflineplus">+            picker.appendFilter(type.description, type.extensionFilter);</span>
<a href="#l23.45"></a><span id="l23.45" class="difflineplus">+            if (type.extensionFilter == &quot;*.&quot; + picker.defaultExtension) {</span>
<a href="#l23.46"></a><span id="l23.46" class="difflineplus">+                picker.filterIndex = currentListLength;</span>
<a href="#l23.47"></a><span id="l23.47">                 defaultCIDIndex = currentListLength;</span>
<a href="#l23.48"></a><span id="l23.48">             }</span>
<a href="#l23.49"></a><span id="l23.49">             contractids.push(contractid);</span>
<a href="#l23.50"></a><span id="l23.50">             currentListLength++;</span>
<a href="#l23.51"></a><span id="l23.51">         }</span>
<a href="#l23.52"></a><span id="l23.52">     }</span>
<a href="#l23.53"></a><span id="l23.53"> </span>
<a href="#l23.54"></a><span id="l23.54" class="difflineminus">-    let rv = fp.show();</span>
<a href="#l23.55"></a><span id="l23.55" class="difflineplus">+    let rv = picker.show();</span>
<a href="#l23.56"></a><span id="l23.56"> </span>
<a href="#l23.57"></a><span id="l23.57">     if (rv != nsIFilePicker.returnCancel &amp;&amp;</span>
<a href="#l23.58"></a><span id="l23.58" class="difflineminus">-        fp.file &amp;&amp; fp.file.path &amp;&amp; fp.file.path.length &gt; 0) {</span>
<a href="#l23.59"></a><span id="l23.59" class="difflineminus">-        let filterIndex = fp.filterIndex;</span>
<a href="#l23.60"></a><span id="l23.60" class="difflineminus">-        if (fp.filterIndex &lt; 0 || fp.filterIndex &gt; contractids.length) {</span>
<a href="#l23.61"></a><span id="l23.61" class="difflineplus">+        picker.file &amp;&amp; picker.file.path &amp;&amp; picker.file.path.length &gt; 0) {</span>
<a href="#l23.62"></a><span id="l23.62" class="difflineplus">+        let filterIndex = picker.filterIndex;</span>
<a href="#l23.63"></a><span id="l23.63" class="difflineplus">+        if (picker.filterIndex &lt; 0 || picker.filterIndex &gt; contractids.length) {</span>
<a href="#l23.64"></a><span id="l23.64">             // For some reason the wrong filter was selected, assume default extension</span>
<a href="#l23.65"></a><span id="l23.65">             filterIndex = defaultCIDIndex;</span>
<a href="#l23.66"></a><span id="l23.66">         }</span>
<a href="#l23.67"></a><span id="l23.67"> </span>
<a href="#l23.68"></a><span id="l23.68" class="difflineminus">-        let filePath = fp.file.path;</span>
<a href="#l23.69"></a><span id="l23.69" class="difflineplus">+        let filePath = picker.file.path;</span>
<a href="#l23.70"></a><span id="l23.70">         let importer = Components.classes[contractids[filterIndex]]</span>
<a href="#l23.71"></a><span id="l23.71">                                  .getService(Components.interfaces.calIImporter);</span>
<a href="#l23.72"></a><span id="l23.72"> </span>
<a href="#l23.73"></a><span id="l23.73">         const nsIFileInputStream = Components.interfaces.nsIFileInputStream;</span>
<a href="#l23.74"></a><span id="l23.74"> </span>
<a href="#l23.75"></a><span id="l23.75">         let inputStream = Components.classes[&quot;@mozilla.org/network/file-input-stream;1&quot;]</span>
<a href="#l23.76"></a><span id="l23.76">                                     .createInstance(nsIFileInputStream);</span>
<a href="#l23.77"></a><span id="l23.77">         let items = [];</span>
<a href="#l23.78"></a><span id="l23.78"> </span>
<a href="#l23.79"></a><span id="l23.79">         try {</span>
<a href="#l23.80"></a><span id="l23.80" class="difflineminus">-            inputStream.init(fp.file, MODE_RDONLY, parseInt(&quot;0444&quot;, 8), {});</span>
<a href="#l23.81"></a><span id="l23.81" class="difflineplus">+            inputStream.init(picker.file, MODE_RDONLY, parseInt(&quot;0444&quot;, 8), {});</span>
<a href="#l23.82"></a><span id="l23.82">             items = importer.importFromStream(inputStream, {});</span>
<a href="#l23.83"></a><span id="l23.83">         } catch (ex) {</span>
<a href="#l23.84"></a><span id="l23.84">             switch (ex.result) {</span>
<a href="#l23.85"></a><span id="l23.85">                 case Components.interfaces.calIErrors.INVALID_TIMEZONE:</span>
<a href="#l23.86"></a><span id="l23.86">                     showError(calGetString(&quot;calendar&quot;, &quot;timezoneError&quot;, [filePath]));</span>
<a href="#l23.87"></a><span id="l23.87">                     break;</span>
<a href="#l23.88"></a><span id="l23.88">                 default:</span>
<a href="#l23.89"></a><span id="l23.89">                     showError(calGetString(&quot;calendar&quot;, &quot;unableToRead&quot;) + filePath + &quot;\n&quot; + ex);</span>
<a href="#l23.90"></a><span id="l23.90" class="difflineat">@@ -202,32 +202,32 @@ function putItemsIntoCal(destCal, aItems</span>
<a href="#l23.91"></a><span id="l23.91"> function saveEventsToFile(calendarEventArray, aDefaultFileName) {</span>
<a href="#l23.92"></a><span id="l23.92">     if (!calendarEventArray || !calendarEventArray.length) {</span>
<a href="#l23.93"></a><span id="l23.93">         return;</span>
<a href="#l23.94"></a><span id="l23.94">     }</span>
<a href="#l23.95"></a><span id="l23.95"> </span>
<a href="#l23.96"></a><span id="l23.96">     // Show the 'Save As' dialog and ask for a filename to save to</span>
<a href="#l23.97"></a><span id="l23.97">     const nsIFilePicker = Components.interfaces.nsIFilePicker;</span>
<a href="#l23.98"></a><span id="l23.98"> </span>
<a href="#l23.99"></a><span id="l23.99" class="difflineminus">-    let fp = Components.classes[&quot;@mozilla.org/filepicker;1&quot;]</span>
<a href="#l23.100"></a><span id="l23.100" class="difflineplus">+    let picker = Components.classes[&quot;@mozilla.org/filepicker;1&quot;]</span>
<a href="#l23.101"></a><span id="l23.101">                        .createInstance(nsIFilePicker);</span>
<a href="#l23.102"></a><span id="l23.102"> </span>
<a href="#l23.103"></a><span id="l23.103" class="difflineminus">-    fp.init(window,</span>
<a href="#l23.104"></a><span id="l23.104" class="difflineminus">-            calGetString(&quot;calendar&quot;, &quot;filepickerTitleExport&quot;),</span>
<a href="#l23.105"></a><span id="l23.105" class="difflineminus">-            nsIFilePicker.modeSave);</span>
<a href="#l23.106"></a><span id="l23.106" class="difflineplus">+    picker.init(window,</span>
<a href="#l23.107"></a><span id="l23.107" class="difflineplus">+                calGetString(&quot;calendar&quot;, &quot;filepickerTitleExport&quot;),</span>
<a href="#l23.108"></a><span id="l23.108" class="difflineplus">+                nsIFilePicker.modeSave);</span>
<a href="#l23.109"></a><span id="l23.109"> </span>
<a href="#l23.110"></a><span id="l23.110">     if (aDefaultFileName &amp;&amp; aDefaultFileName.length &amp;&amp; aDefaultFileName.length &gt; 0) {</span>
<a href="#l23.111"></a><span id="l23.111" class="difflineminus">-        fp.defaultString = aDefaultFileName;</span>
<a href="#l23.112"></a><span id="l23.112" class="difflineplus">+        picker.defaultString = aDefaultFileName;</span>
<a href="#l23.113"></a><span id="l23.113">     } else if (calendarEventArray.length == 1 &amp;&amp; calendarEventArray[0].title) {</span>
<a href="#l23.114"></a><span id="l23.114" class="difflineminus">-        fp.defaultString = calendarEventArray[0].title;</span>
<a href="#l23.115"></a><span id="l23.115" class="difflineplus">+        picker.defaultString = calendarEventArray[0].title;</span>
<a href="#l23.116"></a><span id="l23.116">     } else {</span>
<a href="#l23.117"></a><span id="l23.117" class="difflineminus">-        fp.defaultString = calGetString(&quot;calendar&quot;, &quot;defaultFileName&quot;);</span>
<a href="#l23.118"></a><span id="l23.118" class="difflineplus">+        picker.defaultString = calGetString(&quot;calendar&quot;, &quot;defaultFileName&quot;);</span>
<a href="#l23.119"></a><span id="l23.119">     }</span>
<a href="#l23.120"></a><span id="l23.120"> </span>
<a href="#l23.121"></a><span id="l23.121" class="difflineminus">-    fp.defaultExtension = &quot;ics&quot;;</span>
<a href="#l23.122"></a><span id="l23.122" class="difflineplus">+    picker.defaultExtension = &quot;ics&quot;;</span>
<a href="#l23.123"></a><span id="l23.123"> </span>
<a href="#l23.124"></a><span id="l23.124">     // Get a list of exporters</span>
<a href="#l23.125"></a><span id="l23.125">     let contractids = [];</span>
<a href="#l23.126"></a><span id="l23.126">     let catman = Components.classes[&quot;@mozilla.org/categorymanager;1&quot;]</span>
<a href="#l23.127"></a><span id="l23.127">                            .getService(Components.interfaces.nsICategoryManager);</span>
<a href="#l23.128"></a><span id="l23.128">     let catenum = catman.enumerateCategory(&quot;cal-exporters&quot;);</span>
<a href="#l23.129"></a><span id="l23.129">     let currentListLength = 0;</span>
<a href="#l23.130"></a><span id="l23.130">     let defaultCIDIndex = 0;</span>
<a href="#l23.131"></a><span id="l23.131" class="difflineat">@@ -240,40 +240,40 @@ function saveEventsToFile(calendarEventA</span>
<a href="#l23.132"></a><span id="l23.132">             exporter = Components.classes[contractid]</span>
<a href="#l23.133"></a><span id="l23.133">                                  .getService(Components.interfaces.calIExporter);</span>
<a href="#l23.134"></a><span id="l23.134">         } catch (e) {</span>
<a href="#l23.135"></a><span id="l23.135">             cal.WARN(&quot;Could not initialize exporter: &quot; + contractid + &quot;\nError: &quot; + e);</span>
<a href="#l23.136"></a><span id="l23.136">             continue;</span>
<a href="#l23.137"></a><span id="l23.137">         }</span>
<a href="#l23.138"></a><span id="l23.138">         let types = exporter.getFileTypes({});</span>
<a href="#l23.139"></a><span id="l23.139">         for (let type of types) {</span>
<a href="#l23.140"></a><span id="l23.140" class="difflineminus">-            fp.appendFilter(type.description, type.extensionFilter);</span>
<a href="#l23.141"></a><span id="l23.141" class="difflineminus">-            if (type.extensionFilter == &quot;*.&quot; + fp.defaultExtension) {</span>
<a href="#l23.142"></a><span id="l23.142" class="difflineminus">-                fp.filterIndex = currentListLength;</span>
<a href="#l23.143"></a><span id="l23.143" class="difflineplus">+            picker.appendFilter(type.description, type.extensionFilter);</span>
<a href="#l23.144"></a><span id="l23.144" class="difflineplus">+            if (type.extensionFilter == &quot;*.&quot; + picker.defaultExtension) {</span>
<a href="#l23.145"></a><span id="l23.145" class="difflineplus">+                picker.filterIndex = currentListLength;</span>
<a href="#l23.146"></a><span id="l23.146">                 defaultCIDIndex = currentListLength;</span>
<a href="#l23.147"></a><span id="l23.147">             }</span>
<a href="#l23.148"></a><span id="l23.148">             contractids.push(contractid);</span>
<a href="#l23.149"></a><span id="l23.149">             currentListLength++;</span>
<a href="#l23.150"></a><span id="l23.150">         }</span>
<a href="#l23.151"></a><span id="l23.151">     }</span>
<a href="#l23.152"></a><span id="l23.152"> </span>
<a href="#l23.153"></a><span id="l23.153" class="difflineminus">-    let rv = fp.show();</span>
<a href="#l23.154"></a><span id="l23.154" class="difflineplus">+    let rv = picker.show();</span>
<a href="#l23.155"></a><span id="l23.155"> </span>
<a href="#l23.156"></a><span id="l23.156">     // Now find out as what to save, convert the events and save to file.</span>
<a href="#l23.157"></a><span id="l23.157" class="difflineminus">-    if (rv != nsIFilePicker.returnCancel &amp;&amp; fp.file &amp;&amp; fp.file.path.length &gt; 0) {</span>
<a href="#l23.158"></a><span id="l23.158" class="difflineminus">-        let filterIndex = fp.filterIndex;</span>
<a href="#l23.159"></a><span id="l23.159" class="difflineminus">-        if (fp.filterIndex &lt; 0 || fp.filterIndex &gt; contractids.length) {</span>
<a href="#l23.160"></a><span id="l23.160" class="difflineplus">+    if (rv != nsIFilePicker.returnCancel &amp;&amp; picker.file &amp;&amp; picker.file.path.length &gt; 0) {</span>
<a href="#l23.161"></a><span id="l23.161" class="difflineplus">+        let filterIndex = picker.filterIndex;</span>
<a href="#l23.162"></a><span id="l23.162" class="difflineplus">+        if (picker.filterIndex &lt; 0 || picker.filterIndex &gt; contractids.length) {</span>
<a href="#l23.163"></a><span id="l23.163">             // For some reason the wrong filter was selected, assume default extension</span>
<a href="#l23.164"></a><span id="l23.164">             filterIndex = defaultCIDIndex;</span>
<a href="#l23.165"></a><span id="l23.165">         }</span>
<a href="#l23.166"></a><span id="l23.166"> </span>
<a href="#l23.167"></a><span id="l23.167">         let exporter = Components.classes[contractids[filterIndex]]</span>
<a href="#l23.168"></a><span id="l23.168">                                  .getService(Components.interfaces.calIExporter);</span>
<a href="#l23.169"></a><span id="l23.169"> </span>
<a href="#l23.170"></a><span id="l23.170" class="difflineminus">-        let filePath = fp.file.path;</span>
<a href="#l23.171"></a><span id="l23.171" class="difflineplus">+        let filePath = picker.file.path;</span>
<a href="#l23.172"></a><span id="l23.172">         if (!filePath.includes(&quot;.&quot;)) {</span>
<a href="#l23.173"></a><span id="l23.173">             filePath += &quot;.&quot; + exporter.getFileTypes({})[0].defaultExtension;</span>
<a href="#l23.174"></a><span id="l23.174">         }</span>
<a href="#l23.175"></a><span id="l23.175"> </span>
<a href="#l23.176"></a><span id="l23.176">         const nsILocalFile = Components.interfaces.nsILocalFile;</span>
<a href="#l23.177"></a><span id="l23.177">         const nsIFileOutputStream = Components.interfaces.nsIFileOutputStream;</span>
<a href="#l23.178"></a><span id="l23.178"> </span>
<a href="#l23.179"></a><span id="l23.179">         let outputStream;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/calendar/base/content/preferences/alarms.js</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/calendar/base/content/preferences/alarms.js</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -69,32 +69,32 @@ var gAlarmsPane = {</span>
<a href="#l24.4"></a><span id="l24.4">         this.readSoundLocation();</span>
<a href="#l24.5"></a><span id="l24.5">     },</span>
<a href="#l24.6"></a><span id="l24.6"> </span>
<a href="#l24.7"></a><span id="l24.7">     /**</span>
<a href="#l24.8"></a><span id="l24.8">      * Opens a filepicker to open a local sound for the alarm.</span>
<a href="#l24.9"></a><span id="l24.9">      */</span>
<a href="#l24.10"></a><span id="l24.10">     browseAlarm: function() {</span>
<a href="#l24.11"></a><span id="l24.11">         const nsIFilePicker = Components.interfaces.nsIFilePicker;</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-        let fp = Components.classes[&quot;@mozilla.org/filepicker;1&quot;]</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineminus">-                    .createInstance(nsIFilePicker);</span>
<a href="#l24.14"></a><span id="l24.14" class="difflineplus">+        let picker = Components.classes[&quot;@mozilla.org/filepicker;1&quot;]</span>
<a href="#l24.15"></a><span id="l24.15" class="difflineplus">+                               .createInstance(nsIFilePicker);</span>
<a href="#l24.16"></a><span id="l24.16"> </span>
<a href="#l24.17"></a><span id="l24.17">         let bundlePreferences = document.getElementById(&quot;bundleCalendarPreferences&quot;);</span>
<a href="#l24.18"></a><span id="l24.18">         let title = bundlePreferences.getString(&quot;Open&quot;);</span>
<a href="#l24.19"></a><span id="l24.19">         let wildmat = &quot;*.wav&quot;;</span>
<a href="#l24.20"></a><span id="l24.20">         let label = bundlePreferences.getFormattedString(&quot;filterWav&quot;, [wildmat], 1);</span>
<a href="#l24.21"></a><span id="l24.21"> </span>
<a href="#l24.22"></a><span id="l24.22" class="difflineminus">-        fp.init(window, title, nsIFilePicker.modeOpen);</span>
<a href="#l24.23"></a><span id="l24.23" class="difflineminus">-        fp.appendFilter(label, wildmat);</span>
<a href="#l24.24"></a><span id="l24.24" class="difflineminus">-        fp.appendFilters(nsIFilePicker.filterAll);</span>
<a href="#l24.25"></a><span id="l24.25" class="difflineplus">+        picker.init(window, title, nsIFilePicker.modeOpen);</span>
<a href="#l24.26"></a><span id="l24.26" class="difflineplus">+        picker.appendFilter(label, wildmat);</span>
<a href="#l24.27"></a><span id="l24.27" class="difflineplus">+        picker.appendFilters(nsIFilePicker.filterAll);</span>
<a href="#l24.28"></a><span id="l24.28"> </span>
<a href="#l24.29"></a><span id="l24.29" class="difflineminus">-        let ret = fp.show();</span>
<a href="#l24.30"></a><span id="l24.30" class="difflineplus">+        let ret = picker.show();</span>
<a href="#l24.31"></a><span id="l24.31"> </span>
<a href="#l24.32"></a><span id="l24.32">         if (ret == nsIFilePicker.returnOK) {</span>
<a href="#l24.33"></a><span id="l24.33" class="difflineminus">-            document.getElementById(&quot;calendar.alarms.soundURL&quot;).value = fp.fileURL.spec;</span>
<a href="#l24.34"></a><span id="l24.34" class="difflineplus">+            document.getElementById(&quot;calendar.alarms.soundURL&quot;).value = picker.fileURL.spec;</span>
<a href="#l24.35"></a><span id="l24.35">             document.getElementById(&quot;alarmSoundCheckbox&quot;).checked = true;</span>
<a href="#l24.36"></a><span id="l24.36">             this.readSoundLocation();</span>
<a href="#l24.37"></a><span id="l24.37">         }</span>
<a href="#l24.38"></a><span id="l24.38">     },</span>
<a href="#l24.39"></a><span id="l24.39"> </span>
<a href="#l24.40"></a><span id="l24.40">     /**</span>
<a href="#l24.41"></a><span id="l24.41">      * Plays the alarm sound currently selected.</span>
<a href="#l24.42"></a><span id="l24.42">      */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/calendar/base/content/preferences/general.js</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/calendar/base/content/preferences/general.js</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -10,21 +10,21 @@ Components.utils.import(&quot;resource://cale</span>
<a href="#l25.4"></a><span id="l25.4">  * Global Object to hold methods for the general pref pane</span>
<a href="#l25.5"></a><span id="l25.5">  */</span>
<a href="#l25.6"></a><span id="l25.6"> var gCalendarGeneralPane = {</span>
<a href="#l25.7"></a><span id="l25.7">     /**</span>
<a href="#l25.8"></a><span id="l25.8">      * Initialize the general pref pane. Sets up dialog controls to match the</span>
<a href="#l25.9"></a><span id="l25.9">      * values set in prefs.</span>
<a href="#l25.10"></a><span id="l25.10">      */</span>
<a href="#l25.11"></a><span id="l25.11">     init: function() {</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-        let df = Components.classes[&quot;@mozilla.org/calendar/datetime-formatter;1&quot;]</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineminus">-                    .getService(Components.interfaces.calIDateTimeFormatter);</span>
<a href="#l25.14"></a><span id="l25.14" class="difflineplus">+        let formatter = Components.classes[&quot;@mozilla.org/calendar/datetime-formatter;1&quot;]</span>
<a href="#l25.15"></a><span id="l25.15" class="difflineplus">+                                  .getService(Components.interfaces.calIDateTimeFormatter);</span>
<a href="#l25.16"></a><span id="l25.16"> </span>
<a href="#l25.17"></a><span id="l25.17" class="difflineminus">-        let dateFormattedLong = df.formatDateLong(now());</span>
<a href="#l25.18"></a><span id="l25.18" class="difflineminus">-        let dateFormattedShort = df.formatDateShort(now());</span>
<a href="#l25.19"></a><span id="l25.19" class="difflineplus">+        let dateFormattedLong = formatter.formatDateLong(now());</span>
<a href="#l25.20"></a><span id="l25.20" class="difflineplus">+        let dateFormattedShort = formatter.formatDateShort(now());</span>
<a href="#l25.21"></a><span id="l25.21"> </span>
<a href="#l25.22"></a><span id="l25.22">         // menu items include examples of current date formats.</span>
<a href="#l25.23"></a><span id="l25.23">         document.getElementById(&quot;dateformat-long-menuitem&quot;)</span>
<a href="#l25.24"></a><span id="l25.24">                 .setAttribute(&quot;label&quot;, labelLong + &quot;: &quot; + dateFormattedLong);</span>
<a href="#l25.25"></a><span id="l25.25">         document.getElementById(&quot;dateformat-short-menuitem&quot;)</span>
<a href="#l25.26"></a><span id="l25.26">                 .setAttribute(&quot;label&quot;, labelShort + &quot;: &quot; + dateFormattedShort);</span>
<a href="#l25.27"></a><span id="l25.27"> </span>
<a href="#l25.28"></a><span id="l25.28">         // deselect and reselect to update visible item title</span>
<a href="#l25.29"></a><span id="l25.29" class="difflineat">@@ -36,21 +36,21 @@ var gCalendarGeneralPane = {</span>
<a href="#l25.30"></a><span id="l25.30">         let tzMenuPopup = document.getElementById(&quot;calendar-timezone-menupopup&quot;);</span>
<a href="#l25.31"></a><span id="l25.31"> </span>
<a href="#l25.32"></a><span id="l25.32">         let tzService = cal.getTimezoneService();</span>
<a href="#l25.33"></a><span id="l25.33">         let enumerator = tzService.timezoneIds;</span>
<a href="#l25.34"></a><span id="l25.34">         let tzids = {};</span>
<a href="#l25.35"></a><span id="l25.35">         let displayNames = [];</span>
<a href="#l25.36"></a><span id="l25.36">         // don't rely on what order the timezone-service gives you</span>
<a href="#l25.37"></a><span id="l25.37">         while (enumerator.hasMore()) {</span>
<a href="#l25.38"></a><span id="l25.38" class="difflineminus">-            let tz = tzService.getTimezone(enumerator.getNext());</span>
<a href="#l25.39"></a><span id="l25.39" class="difflineminus">-            if (tz &amp;&amp; !tz.isFloating &amp;&amp; !tz.isUTC) {</span>
<a href="#l25.40"></a><span id="l25.40" class="difflineminus">-                let displayName = tz.displayName;</span>
<a href="#l25.41"></a><span id="l25.41" class="difflineplus">+            let timezone = tzService.getTimezone(enumerator.getNext());</span>
<a href="#l25.42"></a><span id="l25.42" class="difflineplus">+            if (timezone &amp;&amp; !timezone.isFloating &amp;&amp; !timezone.isUTC) {</span>
<a href="#l25.43"></a><span id="l25.43" class="difflineplus">+                let displayName = timezone.displayName;</span>
<a href="#l25.44"></a><span id="l25.44">                 displayNames.push(displayName);</span>
<a href="#l25.45"></a><span id="l25.45" class="difflineminus">-                tzids[displayName] = tz.tzid;</span>
<a href="#l25.46"></a><span id="l25.46" class="difflineplus">+                tzids[displayName] = timezone.tzid;</span>
<a href="#l25.47"></a><span id="l25.47">             }</span>
<a href="#l25.48"></a><span id="l25.48">         }</span>
<a href="#l25.49"></a><span id="l25.49">         // the display names need to be sorted</span>
<a href="#l25.50"></a><span id="l25.50">         displayNames.sort(String.localeCompare);</span>
<a href="#l25.51"></a><span id="l25.51">         for (let displayName of displayNames) {</span>
<a href="#l25.52"></a><span id="l25.52">             addMenuItem(tzMenuPopup, displayName, tzids[displayName]);</span>
<a href="#l25.53"></a><span id="l25.53">         }</span>
<a href="#l25.54"></a><span id="l25.54"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/calendar/base/content/widgets/calendar-alarm-widget.xml</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/calendar/base/content/widgets/calendar-alarm-widget.xml</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -280,18 +280,18 @@</span>
<a href="#l26.4"></a><span id="l26.4">           snoozeEvent.detail = minutes;</span>
<a href="#l26.5"></a><span id="l26.5"> </span>
<a href="#l26.6"></a><span id="l26.6">           // The onsnooze attribute is set on the menupopup, this binding is</span>
<a href="#l26.7"></a><span id="l26.7">           // instanciated on the menupopup's arrowscrollbox. Therefore we need</span>
<a href="#l26.8"></a><span id="l26.8">           // to go up one node.</span>
<a href="#l26.9"></a><span id="l26.9">           let handler = this.parentNode.getAttribute(&quot;onsnooze&quot;);</span>
<a href="#l26.10"></a><span id="l26.10">           let cancel = false;</span>
<a href="#l26.11"></a><span id="l26.11">           if (handler) {</span>
<a href="#l26.12"></a><span id="l26.12" class="difflineminus">-              let fn = new Function(&quot;event&quot;, handler);</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineminus">-              cancel = (fn.call(this, snoozeEvent) === false);</span>
<a href="#l26.14"></a><span id="l26.14" class="difflineplus">+              let func = new Function(&quot;event&quot;, handler);</span>
<a href="#l26.15"></a><span id="l26.15" class="difflineplus">+              cancel = (func.call(this, snoozeEvent) === false);</span>
<a href="#l26.16"></a><span id="l26.16">           }</span>
<a href="#l26.17"></a><span id="l26.17"> </span>
<a href="#l26.18"></a><span id="l26.18">           if (!cancel) {</span>
<a href="#l26.19"></a><span id="l26.19">               this.dispatchEvent(snoozeEvent);</span>
<a href="#l26.20"></a><span id="l26.20">           }</span>
<a href="#l26.21"></a><span id="l26.21">         ]]&gt;&lt;/body&gt;</span>
<a href="#l26.22"></a><span id="l26.22">       &lt;/method&gt;</span>
<a href="#l26.23"></a><span id="l26.23"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/calendar/base/content/widgets/calendar-list-tree.xml</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/calendar/base/content/widgets/calendar-list-tree.xml</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -1052,52 +1052,52 @@</span>
<a href="#l27.4"></a><span id="l27.4">             event.preventDefault();</span>
<a href="#l27.5"></a><span id="l27.5">         }</span>
<a href="#l27.6"></a><span id="l27.6">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l27.7"></a><span id="l27.7">       &lt;handler event=&quot;keypress&quot; keycode=&quot;VK_DOWN&quot; modifiers=&quot;control&quot;&gt;&lt;![CDATA[</span>
<a href="#l27.8"></a><span id="l27.8">         if (!this.allowDrag) {</span>
<a href="#l27.9"></a><span id="l27.9">           return;</span>
<a href="#l27.10"></a><span id="l27.10">         }</span>
<a href="#l27.11"></a><span id="l27.11"> </span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-        let ci = this.tree.currentIndex;</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineplus">+        let idx = this.tree.currentIndex;</span>
<a href="#l27.14"></a><span id="l27.14"> </span>
<a href="#l27.15"></a><span id="l27.15" class="difflineminus">-        if (ci &lt; this.mCalendarList.length - 1) {</span>
<a href="#l27.16"></a><span id="l27.16" class="difflineminus">-            this.mCalendarList.splice(ci + 1, 0, this.mCalendarList.splice(ci, 1)[0]);</span>
<a href="#l27.17"></a><span id="l27.17" class="difflineminus">-            this.treebox.invalidateRange(ci, ci + 1);</span>
<a href="#l27.18"></a><span id="l27.18" class="difflineplus">+        if (idx &lt; this.mCalendarList.length - 1) {</span>
<a href="#l27.19"></a><span id="l27.19" class="difflineplus">+            this.mCalendarList.splice(idx + 1, 0, this.mCalendarList.splice(idx, 1)[0]);</span>
<a href="#l27.20"></a><span id="l27.20" class="difflineplus">+            this.treebox.invalidateRange(idx, idx + 1);</span>
<a href="#l27.21"></a><span id="l27.21"> </span>
<a href="#l27.22"></a><span id="l27.22" class="difflineminus">-            if (this.tree.view.selection.isSelected(ci)) {</span>
<a href="#l27.23"></a><span id="l27.23" class="difflineminus">-                this.tree.view.selection.toggleSelect(ci);</span>
<a href="#l27.24"></a><span id="l27.24" class="difflineminus">-                this.tree.view.selection.toggleSelect(ci + 1);</span>
<a href="#l27.25"></a><span id="l27.25" class="difflineplus">+            if (this.tree.view.selection.isSelected(idx)) {</span>
<a href="#l27.26"></a><span id="l27.26" class="difflineplus">+                this.tree.view.selection.toggleSelect(idx);</span>
<a href="#l27.27"></a><span id="l27.27" class="difflineplus">+                this.tree.view.selection.toggleSelect(idx + 1);</span>
<a href="#l27.28"></a><span id="l27.28">             }</span>
<a href="#l27.29"></a><span id="l27.29" class="difflineminus">-            if (this.tree.view.selection.currentIndex == ci) {</span>
<a href="#l27.30"></a><span id="l27.30" class="difflineminus">-                this.tree.view.selection.currentIndex = ci + 1;</span>
<a href="#l27.31"></a><span id="l27.31" class="difflineplus">+            if (this.tree.view.selection.currentIndex == idx) {</span>
<a href="#l27.32"></a><span id="l27.32" class="difflineplus">+                this.tree.view.selection.currentIndex = idx + 1;</span>
<a href="#l27.33"></a><span id="l27.33">             }</span>
<a href="#l27.34"></a><span id="l27.34"> </span>
<a href="#l27.35"></a><span id="l27.35">             // Fire event</span>
<a href="#l27.36"></a><span id="l27.36">             this.sortOrderChanged();</span>
<a href="#l27.37"></a><span id="l27.37">         }</span>
<a href="#l27.38"></a><span id="l27.38">         // Don't call the default &lt;key&gt; handler.</span>
<a href="#l27.39"></a><span id="l27.39">         event.preventDefault();</span>
<a href="#l27.40"></a><span id="l27.40">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l27.41"></a><span id="l27.41">       &lt;handler event=&quot;keypress&quot; keycode=&quot;VK_UP&quot; modifiers=&quot;control&quot;&gt;&lt;![CDATA[</span>
<a href="#l27.42"></a><span id="l27.42">         if (!this.allowDrag) {</span>
<a href="#l27.43"></a><span id="l27.43">           return;</span>
<a href="#l27.44"></a><span id="l27.44">         }</span>
<a href="#l27.45"></a><span id="l27.45"> </span>
<a href="#l27.46"></a><span id="l27.46" class="difflineminus">-        let ci = this.tree.currentIndex;</span>
<a href="#l27.47"></a><span id="l27.47" class="difflineminus">-        if (ci &gt; 0) {</span>
<a href="#l27.48"></a><span id="l27.48" class="difflineminus">-            this.mCalendarList.splice(ci - 1, 0, this.mCalendarList.splice(ci, 1)[0]);</span>
<a href="#l27.49"></a><span id="l27.49" class="difflineminus">-            this.treebox.invalidateRange(ci - 1, ci);</span>
<a href="#l27.50"></a><span id="l27.50" class="difflineplus">+        let idx = this.tree.currentIndex;</span>
<a href="#l27.51"></a><span id="l27.51" class="difflineplus">+        if (idx &gt; 0) {</span>
<a href="#l27.52"></a><span id="l27.52" class="difflineplus">+            this.mCalendarList.splice(idx - 1, 0, this.mCalendarList.splice(idx, 1)[0]);</span>
<a href="#l27.53"></a><span id="l27.53" class="difflineplus">+            this.treebox.invalidateRange(idx - 1, idx);</span>
<a href="#l27.54"></a><span id="l27.54"> </span>
<a href="#l27.55"></a><span id="l27.55" class="difflineminus">-            if (this.tree.view.selection.isSelected(ci)) {</span>
<a href="#l27.56"></a><span id="l27.56" class="difflineminus">-                this.tree.view.selection.toggleSelect(ci);</span>
<a href="#l27.57"></a><span id="l27.57" class="difflineminus">-                this.tree.view.selection.toggleSelect(ci - 1);</span>
<a href="#l27.58"></a><span id="l27.58" class="difflineplus">+            if (this.tree.view.selection.isSelected(idx)) {</span>
<a href="#l27.59"></a><span id="l27.59" class="difflineplus">+                this.tree.view.selection.toggleSelect(idx);</span>
<a href="#l27.60"></a><span id="l27.60" class="difflineplus">+                this.tree.view.selection.toggleSelect(idx - 1);</span>
<a href="#l27.61"></a><span id="l27.61">             }</span>
<a href="#l27.62"></a><span id="l27.62" class="difflineminus">-            if (this.tree.view.selection.currentIndex == ci) {</span>
<a href="#l27.63"></a><span id="l27.63" class="difflineminus">-                this.tree.view.selection.currentIndex = ci - 1;</span>
<a href="#l27.64"></a><span id="l27.64" class="difflineplus">+            if (this.tree.view.selection.currentIndex == idx) {</span>
<a href="#l27.65"></a><span id="l27.65" class="difflineplus">+                this.tree.view.selection.currentIndex = idx - 1;</span>
<a href="#l27.66"></a><span id="l27.66">             }</span>
<a href="#l27.67"></a><span id="l27.67"> </span>
<a href="#l27.68"></a><span id="l27.68">             // Fire event</span>
<a href="#l27.69"></a><span id="l27.69">             this.sortOrderChanged();</span>
<a href="#l27.70"></a><span id="l27.70">         }</span>
<a href="#l27.71"></a><span id="l27.71">         // Don't call the default &lt;key&gt; handler.</span>
<a href="#l27.72"></a><span id="l27.72">         event.preventDefault();</span>
<a href="#l27.73"></a><span id="l27.73">       ]]&gt;&lt;/handler&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/calendar/base/content/widgets/minimonth.xml</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/calendar/base/content/widgets/minimonth.xml</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -402,27 +402,27 @@</span>
<a href="#l28.4"></a><span id="l28.4">       &lt;property name=&quot;extra&quot;</span>
<a href="#l28.5"></a><span id="l28.5">                 onget=&quot;return this.mExtraDate&quot;</span>
<a href="#l28.6"></a><span id="l28.6">                 onset=&quot;this.mExtraDate = val&quot;/&gt;</span>
<a href="#l28.7"></a><span id="l28.7"> </span>
<a href="#l28.8"></a><span id="l28.8">        &lt;!--returns the first (inclusive) date of the minimonth as a calIDateTime object--&gt;</span>
<a href="#l28.9"></a><span id="l28.9">       &lt;property name=&quot;firstDate&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l28.10"></a><span id="l28.10">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l28.11"></a><span id="l28.11">             let calbox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;minimonth-calendar&quot;);</span>
<a href="#l28.12"></a><span id="l28.12" class="difflineminus">-            let dt = calbox.childNodes[1].firstChild.nextSibling.date;</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineminus">-            return cal.jsDateToDateTime(dt);</span>
<a href="#l28.14"></a><span id="l28.14" class="difflineplus">+            let date = calbox.childNodes[1].firstChild.nextSibling.date;</span>
<a href="#l28.15"></a><span id="l28.15" class="difflineplus">+            return cal.jsDateToDateTime(date);</span>
<a href="#l28.16"></a><span id="l28.16">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l28.17"></a><span id="l28.17">       &lt;/property&gt;</span>
<a href="#l28.18"></a><span id="l28.18"> </span>
<a href="#l28.19"></a><span id="l28.19">        &lt;!--returns the last (exclusive) date of the minimonth as a calIDateTime object--&gt;</span>
<a href="#l28.20"></a><span id="l28.20">       &lt;property name=&quot;lastDate&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l28.21"></a><span id="l28.21">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l28.22"></a><span id="l28.22">             let calbox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;minimonth-calendar&quot;);</span>
<a href="#l28.23"></a><span id="l28.23" class="difflineminus">-            let dt = calbox.lastChild.lastChild.date;</span>
<a href="#l28.24"></a><span id="l28.24" class="difflineminus">-            let lastDateTime = cal.jsDateToDateTime(dt);</span>
<a href="#l28.25"></a><span id="l28.25" class="difflineplus">+            let date = calbox.lastChild.lastChild.date;</span>
<a href="#l28.26"></a><span id="l28.26" class="difflineplus">+            let lastDateTime = cal.jsDateToDateTime(date);</span>
<a href="#l28.27"></a><span id="l28.27">             lastDateTime.day = lastDateTime.day + 1;</span>
<a href="#l28.28"></a><span id="l28.28">             return lastDateTime;</span>
<a href="#l28.29"></a><span id="l28.29">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l28.30"></a><span id="l28.30">       &lt;/property&gt;</span>
<a href="#l28.31"></a><span id="l28.31">       &lt;field name=&quot;mDaymap&quot;&gt;null&lt;/field&gt;</span>
<a href="#l28.32"></a><span id="l28.32">       &lt;field name=&quot;mValue&quot;&gt;null&lt;/field&gt;</span>
<a href="#l28.33"></a><span id="l28.33">       &lt;field name=&quot;mEditorDate&quot;&gt;null&lt;/field&gt;</span>
<a href="#l28.34"></a><span id="l28.34">       &lt;field name=&quot;mExtraDate&quot;&gt;null&lt;/field&gt;</span>
<a href="#l28.35"></a><span id="l28.35" class="difflineat">@@ -752,18 +752,18 @@</span>
<a href="#l28.36"></a><span id="l28.36">               for (i = 1; i &lt; dayList.length; i++) {</span>
<a href="#l28.37"></a><span id="l28.37">                   minLength = Math.min(minLength, dayList[i].length);</span>
<a href="#l28.38"></a><span id="l28.38">               }</span>
<a href="#l28.39"></a><span id="l28.39">               // 2. If some day name abbrev. is longer than 2 chars (not Catalan),</span>
<a href="#l28.40"></a><span id="l28.40">               //    and ALL localized day names share same prefix (as in Chinese),</span>
<a href="#l28.41"></a><span id="l28.41">               //    then trim shared &quot;day-&quot; prefix.</span>
<a href="#l28.42"></a><span id="l28.42">               if (dayList.some(dayAbbr =&gt; dayAbbr.length &gt; 2)) {</span>
<a href="#l28.43"></a><span id="l28.43">                   for (let endPrefix = 0; endPrefix &lt; minLength; endPrefix++) {</span>
<a href="#l28.44"></a><span id="l28.44" class="difflineminus">-                      let c = dayList[0][endPrefix];</span>
<a href="#l28.45"></a><span id="l28.45" class="difflineminus">-                      if (dayList.some(dayAbbr =&gt; dayAbbr[endPrefix] != c)) {</span>
<a href="#l28.46"></a><span id="l28.46" class="difflineplus">+                      let suffix = dayList[0][endPrefix];</span>
<a href="#l28.47"></a><span id="l28.47" class="difflineplus">+                      if (dayList.some(dayAbbr =&gt; dayAbbr[endPrefix] != suffix)) {</span>
<a href="#l28.48"></a><span id="l28.48">                           if (endPrefix &gt; 0) {</span>
<a href="#l28.49"></a><span id="l28.49">                               for (i = 0; i &lt; dayList.length; i++) { // trim prefix chars.</span>
<a href="#l28.50"></a><span id="l28.50">                                   dayList[i] = dayList[i].substring(endPrefix);</span>
<a href="#l28.51"></a><span id="l28.51">                               }</span>
<a href="#l28.52"></a><span id="l28.52">                           }</span>
<a href="#l28.53"></a><span id="l28.53">                           break;</span>
<a href="#l28.54"></a><span id="l28.54">                       }</span>
<a href="#l28.55"></a><span id="l28.55">                   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/calendar/base/modules/calAlarmUtils.jsm</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/calendar/base/modules/calAlarmUtils.jsm</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -65,19 +65,19 @@ cal.alarms = {</span>
<a href="#l29.4"></a><span id="l29.4">                 returnDate = aItem[cal.calGetEndDateProp(aItem)];</span>
<a href="#l29.5"></a><span id="l29.5">             }</span>
<a href="#l29.6"></a><span id="l29.6"> </span>
<a href="#l29.7"></a><span id="l29.7">             if (returnDate &amp;&amp; aAlarm.offset) {</span>
<a href="#l29.8"></a><span id="l29.8">                 // Handle all day events.  This is kinda weird, because they don't</span>
<a href="#l29.9"></a><span id="l29.9">                 // have a well defined startTime.  We just consider the start/end</span>
<a href="#l29.10"></a><span id="l29.10">                 // to be midnight in the user's timezone.</span>
<a href="#l29.11"></a><span id="l29.11">                 if (returnDate.isDate) {</span>
<a href="#l29.12"></a><span id="l29.12" class="difflineminus">-                    let tz = cal.calendarDefaultTimezone();</span>
<a href="#l29.13"></a><span id="l29.13" class="difflineplus">+                    let timezone = cal.calendarDefaultTimezone();</span>
<a href="#l29.14"></a><span id="l29.14">                     // This returns a copy, so no extra cloning needed.</span>
<a href="#l29.15"></a><span id="l29.15" class="difflineminus">-                    returnDate = returnDate.getInTimezone(tz);</span>
<a href="#l29.16"></a><span id="l29.16" class="difflineplus">+                    returnDate = returnDate.getInTimezone(timezone);</span>
<a href="#l29.17"></a><span id="l29.17">                     returnDate.isDate = false;</span>
<a href="#l29.18"></a><span id="l29.18">                 } else {</span>
<a href="#l29.19"></a><span id="l29.19">                     // Clone the date to correctly add the duration.</span>
<a href="#l29.20"></a><span id="l29.20">                     returnDate = returnDate.clone();</span>
<a href="#l29.21"></a><span id="l29.21">                 }</span>
<a href="#l29.22"></a><span id="l29.22"> </span>
<a href="#l29.23"></a><span id="l29.23">                 returnDate.addDuration(aAlarm.offset);</span>
<a href="#l29.24"></a><span id="l29.24">                 return returnDate;</span>
<a href="#l29.25"></a><span id="l29.25" class="difflineat">@@ -117,19 +117,19 @@ cal.alarms = {</span>
<a href="#l29.26"></a><span id="l29.26">     /**</span>
<a href="#l29.27"></a><span id="l29.27">      * Adds reminder images to a given node, making sure only one icon per alarm</span>
<a href="#l29.28"></a><span id="l29.28">      * action is added.</span>
<a href="#l29.29"></a><span id="l29.29">      *</span>
<a href="#l29.30"></a><span id="l29.30">      * @param aElement    The element to add the images to.</span>
<a href="#l29.31"></a><span id="l29.31">      * @param aReminders  The set of reminders to add images for.</span>
<a href="#l29.32"></a><span id="l29.32">      */</span>
<a href="#l29.33"></a><span id="l29.33">     addReminderImages: function(aElement, aReminders) {</span>
<a href="#l29.34"></a><span id="l29.34" class="difflineminus">-        function createOwnedXULNode(el) {</span>
<a href="#l29.35"></a><span id="l29.35" class="difflineplus">+        function createOwnedXULNode(elem) {</span>
<a href="#l29.36"></a><span id="l29.36">             const XUL_NS = &quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;;</span>
<a href="#l29.37"></a><span id="l29.37" class="difflineminus">-            return aElement.ownerDocument.createElementNS(XUL_NS, el);</span>
<a href="#l29.38"></a><span id="l29.38" class="difflineplus">+            return aElement.ownerDocument.createElementNS(XUL_NS, elem);</span>
<a href="#l29.39"></a><span id="l29.39">         }</span>
<a href="#l29.40"></a><span id="l29.40"> </span>
<a href="#l29.41"></a><span id="l29.41">         function setupActionImage(node, reminder) {</span>
<a href="#l29.42"></a><span id="l29.42">             let image = node || createOwnedXULNode(&quot;image&quot;);</span>
<a href="#l29.43"></a><span id="l29.43">             image.setAttribute(&quot;class&quot;, &quot;reminder-icon&quot;);</span>
<a href="#l29.44"></a><span id="l29.44">             image.setAttribute(&quot;value&quot;, reminder.action);</span>
<a href="#l29.45"></a><span id="l29.45">             return image;</span>
<a href="#l29.46"></a><span id="l29.46">         }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/calendar/base/modules/calAuthUtils.jsm</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/calendar/base/modules/calAuthUtils.jsm</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -236,20 +236,20 @@ cal.auth.Prompt.prototype = {</span>
<a href="#l30.4"></a><span id="l30.4">         let port = aChannel.URI.port;</span>
<a href="#l30.5"></a><span id="l30.5">         if (port == -1) {</span>
<a href="#l30.6"></a><span id="l30.6">             let handler = Services.io.getProtocolHandler(aChannel.URI.scheme)</span>
<a href="#l30.7"></a><span id="l30.7">                                      .QueryInterface(Components.interfaces.nsIProtocolHandler);</span>
<a href="#l30.8"></a><span id="l30.8">             port = handler.defaultPort;</span>
<a href="#l30.9"></a><span id="l30.9">         }</span>
<a href="#l30.10"></a><span id="l30.10">         hostRealm.passwordRealm = aChannel.URI.host + &quot;:&quot; + port + &quot; (&quot; + aAuthInfo.realm + &quot;)&quot;;</span>
<a href="#l30.11"></a><span id="l30.11"> </span>
<a href="#l30.12"></a><span id="l30.12" class="difflineminus">-        let pw = this.getPasswordInfo(hostRealm);</span>
<a href="#l30.13"></a><span id="l30.13" class="difflineminus">-        aAuthInfo.username = pw.username;</span>
<a href="#l30.14"></a><span id="l30.14" class="difflineminus">-        if (pw &amp;&amp; pw.found) {</span>
<a href="#l30.15"></a><span id="l30.15" class="difflineminus">-            aAuthInfo.password = pw.password;</span>
<a href="#l30.16"></a><span id="l30.16" class="difflineplus">+        let pwInfo = this.getPasswordInfo(hostRealm);</span>
<a href="#l30.17"></a><span id="l30.17" class="difflineplus">+        aAuthInfo.username = pwInfo.username;</span>
<a href="#l30.18"></a><span id="l30.18" class="difflineplus">+        if (pwInfo &amp;&amp; pwInfo.found) {</span>
<a href="#l30.19"></a><span id="l30.19" class="difflineplus">+            aAuthInfo.password = pwInfo.password;</span>
<a href="#l30.20"></a><span id="l30.20">             return true;</span>
<a href="#l30.21"></a><span id="l30.21">         } else {</span>
<a href="#l30.22"></a><span id="l30.22">             let prompter2 = Components.classes[&quot;@mozilla.org/embedcomp/window-watcher;1&quot;]</span>
<a href="#l30.23"></a><span id="l30.23">                                       .getService(Components.interfaces.nsIPromptFactory)</span>
<a href="#l30.24"></a><span id="l30.24">                                       .getPrompt(this.mWindow, Components.interfaces.nsIAuthPrompt2);</span>
<a href="#l30.25"></a><span id="l30.25">             return prompter2.promptAuth(aChannel, aLevel, aAuthInfo);</span>
<a href="#l30.26"></a><span id="l30.26">         }</span>
<a href="#l30.27"></a><span id="l30.27">     },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/calendar/base/modules/calExtract.jsm</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/calendar/base/modules/calExtract.jsm</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -95,19 +95,19 @@ Extractor.prototype = {</span>
<a href="#l31.4"></a><span id="l31.4">         }</span>
<a href="#l31.5"></a><span id="l31.5">     },</span>
<a href="#l31.6"></a><span id="l31.6"> </span>
<a href="#l31.7"></a><span id="l31.7">     avgNonAsciiCharCode: function() {</span>
<a href="#l31.8"></a><span id="l31.8">         let sum = 0;</span>
<a href="#l31.9"></a><span id="l31.9">         let cnt = 0;</span>
<a href="#l31.10"></a><span id="l31.10"> </span>
<a href="#l31.11"></a><span id="l31.11">         for (let i = 0; i &lt; this.email.length; i++) {</span>
<a href="#l31.12"></a><span id="l31.12" class="difflineminus">-            let ch = this.email.charCodeAt(i);</span>
<a href="#l31.13"></a><span id="l31.13" class="difflineminus">-            if (ch &gt; 128) {</span>
<a href="#l31.14"></a><span id="l31.14" class="difflineminus">-                sum += ch;</span>
<a href="#l31.15"></a><span id="l31.15" class="difflineplus">+            let char = this.email.charCodeAt(i);</span>
<a href="#l31.16"></a><span id="l31.16" class="difflineplus">+            if (char &gt; 128) {</span>
<a href="#l31.17"></a><span id="l31.17" class="difflineplus">+                sum += char;</span>
<a href="#l31.18"></a><span id="l31.18">                 cnt++;</span>
<a href="#l31.19"></a><span id="l31.19">             }</span>
<a href="#l31.20"></a><span id="l31.20">         }</span>
<a href="#l31.21"></a><span id="l31.21"> </span>
<a href="#l31.22"></a><span id="l31.22">         let nonAscii = sum / cnt || 0;</span>
<a href="#l31.23"></a><span id="l31.23">         cal.LOG(&quot;[calExtract] Average non-ascii charcode: &quot; + nonAscii);</span>
<a href="#l31.24"></a><span id="l31.24">         return nonAscii;</span>
<a href="#l31.25"></a><span id="l31.25">     },</span>
<a href="#l31.26"></a><span id="l31.26" class="difflineat">@@ -139,64 +139,64 @@ Extractor.prototype = {</span>
<a href="#l31.27"></a><span id="l31.27">                 } else {</span>
<a href="#l31.28"></a><span id="l31.28">                     langs.splice(idx, 1);</span>
<a href="#l31.29"></a><span id="l31.29">                     Preferences.set(pref, this.fallbackLocale + &quot;,&quot; + langs.join(&quot;,&quot;));</span>
<a href="#l31.30"></a><span id="l31.30">                 }</span>
<a href="#l31.31"></a><span id="l31.31">             }</span>
<a href="#l31.32"></a><span id="l31.32">         } else {</span>
<a href="#l31.33"></a><span id="l31.33">             let spellclass = &quot;@mozilla.org/spellchecker/engine;1&quot;;</span>
<a href="#l31.34"></a><span id="l31.34">             let mozISpellCheckingEngine = Components.interfaces.mozISpellCheckingEngine;</span>
<a href="#l31.35"></a><span id="l31.35" class="difflineminus">-            let sp = Components.classes[spellclass]</span>
<a href="#l31.36"></a><span id="l31.36" class="difflineminus">-                               .getService(mozISpellCheckingEngine);</span>
<a href="#l31.37"></a><span id="l31.37" class="difflineplus">+            let spellchecker = Components.classes[spellclass]</span>
<a href="#l31.38"></a><span id="l31.38" class="difflineplus">+                                         .getService(mozISpellCheckingEngine);</span>
<a href="#l31.39"></a><span id="l31.39"> </span>
<a href="#l31.40"></a><span id="l31.40">             let arr = {};</span>
<a href="#l31.41"></a><span id="l31.41">             let cnt = {};</span>
<a href="#l31.42"></a><span id="l31.42" class="difflineminus">-            sp.getDictionaryList(arr, cnt);</span>
<a href="#l31.43"></a><span id="l31.43" class="difflineplus">+            spellchecker.getDictionaryList(arr, cnt);</span>
<a href="#l31.44"></a><span id="l31.44">             let dicts = arr.value;</span>
<a href="#l31.45"></a><span id="l31.45"> </span>
<a href="#l31.46"></a><span id="l31.46">             if (dicts.length == 0) {</span>
<a href="#l31.47"></a><span id="l31.47">                 cal.LOG(&quot;[calExtract] There are no dictionaries installed and &quot; +</span>
<a href="#l31.48"></a><span id="l31.48">                         &quot;enabled. You might want to add some if date and time &quot; +</span>
<a href="#l31.49"></a><span id="l31.49">                         &quot;extraction from emails seems inaccurate.&quot;);</span>
<a href="#l31.50"></a><span id="l31.50">             }</span>
<a href="#l31.51"></a><span id="l31.51"> </span>
<a href="#l31.52"></a><span id="l31.52">             let patterns;</span>
<a href="#l31.53"></a><span id="l31.53">             let words = this.email.split(/\s+/);</span>
<a href="#l31.54"></a><span id="l31.54">             let most = 0;</span>
<a href="#l31.55"></a><span id="l31.55">             let mostLocale;</span>
<a href="#l31.56"></a><span id="l31.56">             for (let dict in dicts) {</span>
<a href="#l31.57"></a><span id="l31.57">                 // dictionary locale and patterns locale match</span>
<a href="#l31.58"></a><span id="l31.58">                 if (this.checkBundle(dicts[dict])) {</span>
<a href="#l31.59"></a><span id="l31.59" class="difflineminus">-                    let t1 = (new Date()).getTime();</span>
<a href="#l31.60"></a><span id="l31.60" class="difflineminus">-                    sp.dictionary = dicts[dict];</span>
<a href="#l31.61"></a><span id="l31.61" class="difflineminus">-                    let dur = (new Date()).getTime() - t1;</span>
<a href="#l31.62"></a><span id="l31.62" class="difflineplus">+                    let time1 = (new Date()).getTime();</span>
<a href="#l31.63"></a><span id="l31.63" class="difflineplus">+                    spellchecker.dictionary = dicts[dict];</span>
<a href="#l31.64"></a><span id="l31.64" class="difflineplus">+                    let dur = (new Date()).getTime() - time1;</span>
<a href="#l31.65"></a><span id="l31.65">                     cal.LOG(&quot;[calExtract] Loading &quot; + dicts[dict] +</span>
<a href="#l31.66"></a><span id="l31.66">                             &quot; dictionary took &quot; + dur + &quot;ms&quot;);</span>
<a href="#l31.67"></a><span id="l31.67">                     patterns = dicts[dict];</span>
<a href="#l31.68"></a><span id="l31.68">                 // beginning of dictionary locale matches patterns locale</span>
<a href="#l31.69"></a><span id="l31.69">                 } else if (this.checkBundle(dicts[dict].substring(0, 2))) {</span>
<a href="#l31.70"></a><span id="l31.70" class="difflineminus">-                    let t1 = (new Date()).getTime();</span>
<a href="#l31.71"></a><span id="l31.71" class="difflineminus">-                    sp.dictionary = dicts[dict];</span>
<a href="#l31.72"></a><span id="l31.72" class="difflineminus">-                    let dur = (new Date()).getTime() - t1;</span>
<a href="#l31.73"></a><span id="l31.73" class="difflineplus">+                    let time1 = (new Date()).getTime();</span>
<a href="#l31.74"></a><span id="l31.74" class="difflineplus">+                    spellchecker.dictionary = dicts[dict];</span>
<a href="#l31.75"></a><span id="l31.75" class="difflineplus">+                    let dur = (new Date()).getTime() - time1;</span>
<a href="#l31.76"></a><span id="l31.76">                     cal.LOG(&quot;[calExtract] Loading &quot; + dicts[dict] +</span>
<a href="#l31.77"></a><span id="l31.77">                             &quot; dictionary took &quot; + dur + &quot;ms&quot;);</span>
<a href="#l31.78"></a><span id="l31.78">                     patterns = dicts[dict].substring(0, 2);</span>
<a href="#l31.79"></a><span id="l31.79">                 // dictionary for which patterns aren't present</span>
<a href="#l31.80"></a><span id="l31.80">                 } else {</span>
<a href="#l31.81"></a><span id="l31.81">                     cal.LOG(&quot;[calExtract] Dictionary present, rules missing: &quot; + dicts[dict]);</span>
<a href="#l31.82"></a><span id="l31.82">                     continue;</span>
<a href="#l31.83"></a><span id="l31.83">                 }</span>
<a href="#l31.84"></a><span id="l31.84"> </span>
<a href="#l31.85"></a><span id="l31.85">                 let correct = 0;</span>
<a href="#l31.86"></a><span id="l31.86">                 let total = 0;</span>
<a href="#l31.87"></a><span id="l31.87">                 for (let word in words) {</span>
<a href="#l31.88"></a><span id="l31.88">                     words[word] = words[word].replace(/[()\d,;:?!#\.]/g, &quot;&quot;);</span>
<a href="#l31.89"></a><span id="l31.89">                     if (words[word].length &gt;= 2) {</span>
<a href="#l31.90"></a><span id="l31.90">                         total++;</span>
<a href="#l31.91"></a><span id="l31.91" class="difflineminus">-                        if (sp.check(words[word])) {</span>
<a href="#l31.92"></a><span id="l31.92" class="difflineplus">+                        if (spellchecker.check(words[word])) {</span>
<a href="#l31.93"></a><span id="l31.93">                             correct++;</span>
<a href="#l31.94"></a><span id="l31.94">                         }</span>
<a href="#l31.95"></a><span id="l31.95">                     }</span>
<a href="#l31.96"></a><span id="l31.96">                 }</span>
<a href="#l31.97"></a><span id="l31.97"> </span>
<a href="#l31.98"></a><span id="l31.98">                 let percentage = correct / total * 100.0;</span>
<a href="#l31.99"></a><span id="l31.99">                 cal.LOG(&quot;[calExtract] &quot; + dicts[dict] + &quot; dictionary matches &quot; +</span>
<a href="#l31.100"></a><span id="l31.100">                         percentage + &quot;% of words&quot;);</span>
<a href="#l31.101"></a><span id="l31.101" class="difflineat">@@ -442,18 +442,18 @@ Extractor.prototype = {</span>
<a href="#l31.102"></a><span id="l31.102"> </span>
<a href="#l31.103"></a><span id="l31.103">             while ((res = re.exec(this.email)) != null) {</span>
<a href="#l31.104"></a><span id="l31.104">                 if (!this.limitNums(res, this.email) &amp;&amp; !this.limitChars(res, this.email)) {</span>
<a href="#l31.105"></a><span id="l31.105">                     let day = this.parseNumber(res[positions[1]], this.numbers);</span>
<a href="#l31.106"></a><span id="l31.106">                     let month = res[positions[2]];</span>
<a href="#l31.107"></a><span id="l31.107"> </span>
<a href="#l31.108"></a><span id="l31.108">                     if (this.isValidDay(day)) {</span>
<a href="#l31.109"></a><span id="l31.109">                         for (let i = 0; i &lt; 12; i++) {</span>
<a href="#l31.110"></a><span id="l31.110" class="difflineminus">-                            let ms = this.unescape(this.months[i]).split(&quot;|&quot;);</span>
<a href="#l31.111"></a><span id="l31.111" class="difflineminus">-                            if (ms.includes(month.toLowerCase())) {</span>
<a href="#l31.112"></a><span id="l31.112" class="difflineplus">+                            let months = this.unescape(this.months[i]).split(&quot;|&quot;);</span>
<a href="#l31.113"></a><span id="l31.113" class="difflineplus">+                            if (months.includes(month.toLowerCase())) {</span>
<a href="#l31.114"></a><span id="l31.114">                                 let date = { year: this.now.getFullYear(), month: i + 1, day: day };</span>
<a href="#l31.115"></a><span id="l31.115">                                 if (this.isPastDate(date, this.now)) {</span>
<a href="#l31.116"></a><span id="l31.116">                                     // find next such date</span>
<a href="#l31.117"></a><span id="l31.117">                                     let item = new Date(this.now.getTime());</span>
<a href="#l31.118"></a><span id="l31.118">                                     while (true) {</span>
<a href="#l31.119"></a><span id="l31.119">                                         item.setDate(item.getDate() + 1);</span>
<a href="#l31.120"></a><span id="l31.120">                                         if (item.getMonth() == date.month - 1 &amp;&amp;</span>
<a href="#l31.121"></a><span id="l31.121">                                             item.getDate() == date.day) {</span>
<a href="#l31.122"></a><span id="l31.122" class="difflineat">@@ -1087,22 +1087,22 @@ Extractor.prototype = {</span>
<a href="#l31.123"></a><span id="l31.123">                 alts[val] = { pattern: patterns[val], positions: positions };</span>
<a href="#l31.124"></a><span id="l31.124">             }</span>
<a href="#l31.125"></a><span id="l31.125">         } catch (ex) {</span>
<a href="#l31.126"></a><span id="l31.126">             cal.LOG(&quot;[calExtract] Pattern not found: &quot; + name);</span>
<a href="#l31.127"></a><span id="l31.127">         }</span>
<a href="#l31.128"></a><span id="l31.128">         return alts;</span>
<a href="#l31.129"></a><span id="l31.129">     },</span>
<a href="#l31.130"></a><span id="l31.130"> </span>
<a href="#l31.131"></a><span id="l31.131" class="difflineminus">-    getPositionsFor: function(s, name, count) {</span>
<a href="#l31.132"></a><span id="l31.132" class="difflineplus">+    getPositionsFor: function(str, name, count) {</span>
<a href="#l31.133"></a><span id="l31.133">         let positions = [];</span>
<a href="#l31.134"></a><span id="l31.134">         let re = /#(\d)/g;</span>
<a href="#l31.135"></a><span id="l31.135">         let match;</span>
<a href="#l31.136"></a><span id="l31.136">         let i = 0;</span>
<a href="#l31.137"></a><span id="l31.137" class="difflineminus">-        while ((match = re.exec(s))) {</span>
<a href="#l31.138"></a><span id="l31.138" class="difflineplus">+        while ((match = re.exec(str))) {</span>
<a href="#l31.139"></a><span id="l31.139">             i++;</span>
<a href="#l31.140"></a><span id="l31.140">             positions[parseInt(match[1], 10)] = i;</span>
<a href="#l31.141"></a><span id="l31.141">         }</span>
<a href="#l31.142"></a><span id="l31.142"> </span>
<a href="#l31.143"></a><span id="l31.143">         // correctness checking</span>
<a href="#l31.144"></a><span id="l31.144">         for (i = 1; i &lt;= count; i++) {</span>
<a href="#l31.145"></a><span id="l31.145">             if (positions[i] === undefined) {</span>
<a href="#l31.146"></a><span id="l31.146">                 Components.utils.reportError(&quot;[calExtract] Faulty extraction pattern &quot; + name +</span>
<a href="#l31.147"></a><span id="l31.147" class="difflineat">@@ -1179,92 +1179,92 @@ Extractor.prototype = {</span>
<a href="#l31.148"></a><span id="l31.148">         if (alphabet == this.defPattern) {</span>
<a href="#l31.149"></a><span id="l31.149">             return false;</span>
<a href="#l31.150"></a><span id="l31.150">         }</span>
<a href="#l31.151"></a><span id="l31.151"> </span>
<a href="#l31.152"></a><span id="l31.152">         let pattern = email.substring(res.index, res.index + res[0].length);</span>
<a href="#l31.153"></a><span id="l31.153">         let before = email.charAt(res.index - 1);</span>
<a href="#l31.154"></a><span id="l31.154">         let after = email.charAt(res.index + res[0].length);</span>
<a href="#l31.155"></a><span id="l31.155"> </span>
<a href="#l31.156"></a><span id="l31.156" class="difflineminus">-        let w = new RegExp(&quot;[&quot; + alphabet + &quot;]&quot;);</span>
<a href="#l31.157"></a><span id="l31.157" class="difflineminus">-        let result = (w.exec(before) &amp;&amp; w.exec(pattern.charAt(0))) ||</span>
<a href="#l31.158"></a><span id="l31.158" class="difflineminus">-                     (w.exec(pattern.charAt(pattern.length - 1)) &amp;&amp; w.exec(after));</span>
<a href="#l31.159"></a><span id="l31.159" class="difflineplus">+        let re = new RegExp(&quot;[&quot; + alphabet + &quot;]&quot;);</span>
<a href="#l31.160"></a><span id="l31.160" class="difflineplus">+        let result = (re.exec(before) &amp;&amp; re.exec(pattern.charAt(0))) ||</span>
<a href="#l31.161"></a><span id="l31.161" class="difflineplus">+                     (re.exec(pattern.charAt(pattern.length - 1)) &amp;&amp; re.exec(after));</span>
<a href="#l31.162"></a><span id="l31.162">         return result != null;</span>
<a href="#l31.163"></a><span id="l31.163">     },</span>
<a href="#l31.164"></a><span id="l31.164"> </span>
<a href="#l31.165"></a><span id="l31.165">     prefixSuffixStartEnd: function(res, relation, email) {</span>
<a href="#l31.166"></a><span id="l31.166">         let pattern = email.substring(res.index, res.index + res[0].length);</span>
<a href="#l31.167"></a><span id="l31.167">         let prev = email.substring(0, res.index);</span>
<a href="#l31.168"></a><span id="l31.168">         let next = email.substring(res.index + res[0].length);</span>
<a href="#l31.169"></a><span id="l31.169">         let prefixSuffix = {</span>
<a href="#l31.170"></a><span id="l31.170">             start: res.index,</span>
<a href="#l31.171"></a><span id="l31.171">             end: res.index + res[0].length,</span>
<a href="#l31.172"></a><span id="l31.172">             pattern: pattern,</span>
<a href="#l31.173"></a><span id="l31.173">             relation: relation</span>
<a href="#l31.174"></a><span id="l31.174">         };</span>
<a href="#l31.175"></a><span id="l31.175" class="difflineminus">-        let ch = &quot;\\s*&quot;;</span>
<a href="#l31.176"></a><span id="l31.176" class="difflineplus">+        let char = &quot;\\s*&quot;;</span>
<a href="#l31.177"></a><span id="l31.177">         let psres;</span>
<a href="#l31.178"></a><span id="l31.178"> </span>
<a href="#l31.179"></a><span id="l31.179" class="difflineminus">-        let re = new RegExp(&quot;(&quot; + this.getPatterns(&quot;end.prefix&quot;) + &quot;)&quot; + ch + &quot;$&quot;, &quot;ig&quot;);</span>
<a href="#l31.180"></a><span id="l31.180" class="difflineplus">+        let re = new RegExp(&quot;(&quot; + this.getPatterns(&quot;end.prefix&quot;) + &quot;)&quot; + char + &quot;$&quot;, &quot;ig&quot;);</span>
<a href="#l31.181"></a><span id="l31.181">         if ((psres = re.exec(prev)) != null) {</span>
<a href="#l31.182"></a><span id="l31.182">             prefixSuffix.relation = &quot;end&quot;;</span>
<a href="#l31.183"></a><span id="l31.183">             prefixSuffix.start = psres.index;</span>
<a href="#l31.184"></a><span id="l31.184">             prefixSuffix.pattern = psres[0] + pattern;</span>
<a href="#l31.185"></a><span id="l31.185">         }</span>
<a href="#l31.186"></a><span id="l31.186"> </span>
<a href="#l31.187"></a><span id="l31.187" class="difflineminus">-        re = new RegExp(&quot;^&quot; + ch + &quot;(&quot; + this.getPatterns(&quot;end.suffix&quot;) + &quot;)&quot;, &quot;ig&quot;);</span>
<a href="#l31.188"></a><span id="l31.188" class="difflineplus">+        re = new RegExp(&quot;^&quot; + char + &quot;(&quot; + this.getPatterns(&quot;end.suffix&quot;) + &quot;)&quot;, &quot;ig&quot;);</span>
<a href="#l31.189"></a><span id="l31.189">         if ((psres = re.exec(next)) != null) {</span>
<a href="#l31.190"></a><span id="l31.190">             prefixSuffix.relation = &quot;end&quot;;</span>
<a href="#l31.191"></a><span id="l31.191">             prefixSuffix.end = prefixSuffix.end + psres[0].length;</span>
<a href="#l31.192"></a><span id="l31.192">             prefixSuffix.pattern = pattern + psres[0];</span>
<a href="#l31.193"></a><span id="l31.193">         }</span>
<a href="#l31.194"></a><span id="l31.194"> </span>
<a href="#l31.195"></a><span id="l31.195" class="difflineminus">-        re = new RegExp(&quot;(&quot; + this.getPatterns(&quot;start.prefix&quot;) + &quot;)&quot; + ch + &quot;$&quot;, &quot;ig&quot;);</span>
<a href="#l31.196"></a><span id="l31.196" class="difflineplus">+        re = new RegExp(&quot;(&quot; + this.getPatterns(&quot;start.prefix&quot;) + &quot;)&quot; + char + &quot;$&quot;, &quot;ig&quot;);</span>
<a href="#l31.197"></a><span id="l31.197">         if ((psres = re.exec(prev)) != null) {</span>
<a href="#l31.198"></a><span id="l31.198">             prefixSuffix.relation = &quot;start&quot;;</span>
<a href="#l31.199"></a><span id="l31.199">             prefixSuffix.start = psres.index;</span>
<a href="#l31.200"></a><span id="l31.200">             prefixSuffix.pattern = psres[0] + pattern;</span>
<a href="#l31.201"></a><span id="l31.201">         }</span>
<a href="#l31.202"></a><span id="l31.202"> </span>
<a href="#l31.203"></a><span id="l31.203" class="difflineminus">-        re = new RegExp(&quot;^&quot; + ch + &quot;(&quot; + this.getPatterns(&quot;start.suffix&quot;) + &quot;)&quot;, &quot;ig&quot;);</span>
<a href="#l31.204"></a><span id="l31.204" class="difflineplus">+        re = new RegExp(&quot;^&quot; + char + &quot;(&quot; + this.getPatterns(&quot;start.suffix&quot;) + &quot;)&quot;, &quot;ig&quot;);</span>
<a href="#l31.205"></a><span id="l31.205">         if ((psres = re.exec(next)) != null) {</span>
<a href="#l31.206"></a><span id="l31.206">             prefixSuffix.relation = &quot;start&quot;;</span>
<a href="#l31.207"></a><span id="l31.207">             prefixSuffix.end = prefixSuffix.end + psres[0].length;</span>
<a href="#l31.208"></a><span id="l31.208">             prefixSuffix.pattern = pattern + psres[0];</span>
<a href="#l31.209"></a><span id="l31.209">         }</span>
<a href="#l31.210"></a><span id="l31.210"> </span>
<a href="#l31.211"></a><span id="l31.211" class="difflineminus">-        re = new RegExp(&quot;\\s(&quot; + this.getPatterns(&quot;no.datetime.prefix&quot;) + &quot;)&quot; + ch + &quot;$&quot;, &quot;ig&quot;);</span>
<a href="#l31.212"></a><span id="l31.212" class="difflineplus">+        re = new RegExp(&quot;\\s(&quot; + this.getPatterns(&quot;no.datetime.prefix&quot;) + &quot;)&quot; + char + &quot;$&quot;, &quot;ig&quot;);</span>
<a href="#l31.213"></a><span id="l31.213"> </span>
<a href="#l31.214"></a><span id="l31.214">         if ((psres = re.exec(prev)) != null) {</span>
<a href="#l31.215"></a><span id="l31.215">             prefixSuffix.relation = &quot;notadatetime&quot;;</span>
<a href="#l31.216"></a><span id="l31.216">         }</span>
<a href="#l31.217"></a><span id="l31.217"> </span>
<a href="#l31.218"></a><span id="l31.218" class="difflineminus">-        re = new RegExp(&quot;^&quot; + ch + &quot;(&quot; + this.getPatterns(&quot;no.datetime.suffix&quot;) + &quot;)&quot;, &quot;ig&quot;);</span>
<a href="#l31.219"></a><span id="l31.219" class="difflineplus">+        re = new RegExp(&quot;^&quot; + char + &quot;(&quot; + this.getPatterns(&quot;no.datetime.suffix&quot;) + &quot;)&quot;, &quot;ig&quot;);</span>
<a href="#l31.220"></a><span id="l31.220">         if ((psres = re.exec(next)) != null) {</span>
<a href="#l31.221"></a><span id="l31.221">             prefixSuffix.relation = &quot;notadatetime&quot;;</span>
<a href="#l31.222"></a><span id="l31.222">         }</span>
<a href="#l31.223"></a><span id="l31.223"> </span>
<a href="#l31.224"></a><span id="l31.224">         return prefixSuffix;</span>
<a href="#l31.225"></a><span id="l31.225">     },</span>
<a href="#l31.226"></a><span id="l31.226"> </span>
<a href="#l31.227"></a><span id="l31.227" class="difflineminus">-    parseNumber: function(number, numbers) {</span>
<a href="#l31.228"></a><span id="l31.228" class="difflineminus">-        let r = parseInt(number, 10);</span>
<a href="#l31.229"></a><span id="l31.229" class="difflineplus">+    parseNumber: function(numberString, numbers) {</span>
<a href="#l31.230"></a><span id="l31.230" class="difflineplus">+        let number = parseInt(numberString, 10);</span>
<a href="#l31.231"></a><span id="l31.231">         // number comes in as plain text, numbers are already adjusted for usage</span>
<a href="#l31.232"></a><span id="l31.232">         // in regular expression</span>
<a href="#l31.233"></a><span id="l31.233" class="difflineminus">-        number = this.cleanPatterns(number);</span>
<a href="#l31.234"></a><span id="l31.234" class="difflineminus">-        if (isNaN(r)) {</span>
<a href="#l31.235"></a><span id="l31.235" class="difflineplus">+        let cleanNumberString = this.cleanPatterns(numberString);</span>
<a href="#l31.236"></a><span id="l31.236" class="difflineplus">+        if (isNaN(number)) {</span>
<a href="#l31.237"></a><span id="l31.237">             for (let i = 0; i &lt;= 31; i++) {</span>
<a href="#l31.238"></a><span id="l31.238" class="difflineminus">-                let ns = numbers[i].split(&quot;|&quot;);</span>
<a href="#l31.239"></a><span id="l31.239" class="difflineminus">-                if (ns.includes(number.toLowerCase())) {</span>
<a href="#l31.240"></a><span id="l31.240" class="difflineplus">+                let numberparts = numbers[i].split(&quot;|&quot;);</span>
<a href="#l31.241"></a><span id="l31.241" class="difflineplus">+                if (numberparts.includes(cleanNumberString.toLowerCase())) {</span>
<a href="#l31.242"></a><span id="l31.242">                     return i;</span>
<a href="#l31.243"></a><span id="l31.243">                 }</span>
<a href="#l31.244"></a><span id="l31.244">             }</span>
<a href="#l31.245"></a><span id="l31.245">             return -1;</span>
<a href="#l31.246"></a><span id="l31.246">         } else {</span>
<a href="#l31.247"></a><span id="l31.247" class="difflineminus">-            return r;</span>
<a href="#l31.248"></a><span id="l31.248" class="difflineplus">+            return number;</span>
<a href="#l31.249"></a><span id="l31.249">         }</span>
<a href="#l31.250"></a><span id="l31.250">     },</span>
<a href="#l31.251"></a><span id="l31.251"> </span>
<a href="#l31.252"></a><span id="l31.252">     guess: function(year, month, day, hour, minute, start, end, str,</span>
<a href="#l31.253"></a><span id="l31.253">                     relation, pattern, ambiguous) {</span>
<a href="#l31.254"></a><span id="l31.254">         let dateGuess = {</span>
<a href="#l31.255"></a><span id="l31.255">             year: year,</span>
<a href="#l31.256"></a><span id="l31.256">             month: month,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/calendar/base/modules/calItipUtils.jsm</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/calendar/base/modules/calItipUtils.jsm</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -54,27 +54,27 @@ cal.itip = {</span>
<a href="#l32.4"></a><span id="l32.4">      * the last received one of an attendee; see</span>
<a href="#l32.5"></a><span id="l32.5">      * &lt;http://tools.ietf.org/html/draft-desruisseaux-caldav-sched-04#section-7.2&gt;.</span>
<a href="#l32.6"></a><span id="l32.6">      */</span>
<a href="#l32.7"></a><span id="l32.7">     getStamp: function(item) {</span>
<a href="#l32.8"></a><span id="l32.8">         let dtstamp = null;</span>
<a href="#l32.9"></a><span id="l32.9"> </span>
<a href="#l32.10"></a><span id="l32.10">         let wrappedItem = cal.wrapInstance(item, Components.interfaces.calIAttendee);</span>
<a href="#l32.11"></a><span id="l32.11">         if (wrappedItem) {</span>
<a href="#l32.12"></a><span id="l32.12" class="difflineminus">-            let st = wrappedItem.getProperty(&quot;RECEIVED-DTSTAMP&quot;);</span>
<a href="#l32.13"></a><span id="l32.13" class="difflineminus">-            if (st) {</span>
<a href="#l32.14"></a><span id="l32.14" class="difflineminus">-                dtstamp = cal.createDateTime(st);</span>
<a href="#l32.15"></a><span id="l32.15" class="difflineplus">+            let stamp = wrappedItem.getProperty(&quot;RECEIVED-DTSTAMP&quot;);</span>
<a href="#l32.16"></a><span id="l32.16" class="difflineplus">+            if (stamp) {</span>
<a href="#l32.17"></a><span id="l32.17" class="difflineplus">+                dtstamp = cal.createDateTime(stamp);</span>
<a href="#l32.18"></a><span id="l32.18">             }</span>
<a href="#l32.19"></a><span id="l32.19">         } else if (item) {</span>
<a href="#l32.20"></a><span id="l32.20">             // Unless the below is standardized, we store the last original</span>
<a href="#l32.21"></a><span id="l32.21">             // REQUEST/PUBLISH DTSTAMP in X-MOZ-RECEIVED-DTSTAMP to test against it</span>
<a href="#l32.22"></a><span id="l32.22">             // when updates come in:</span>
<a href="#l32.23"></a><span id="l32.23" class="difflineminus">-            let st = item.getProperty(&quot;X-MOZ-RECEIVED-DTSTAMP&quot;);</span>
<a href="#l32.24"></a><span id="l32.24" class="difflineminus">-            if (st) {</span>
<a href="#l32.25"></a><span id="l32.25" class="difflineminus">-                dtstamp = cal.createDateTime(st);</span>
<a href="#l32.26"></a><span id="l32.26" class="difflineplus">+            let stamp = item.getProperty(&quot;X-MOZ-RECEIVED-DTSTAMP&quot;);</span>
<a href="#l32.27"></a><span id="l32.27" class="difflineplus">+            if (stamp) {</span>
<a href="#l32.28"></a><span id="l32.28" class="difflineplus">+                dtstamp = cal.createDateTime(stamp);</span>
<a href="#l32.29"></a><span id="l32.29">             } else {</span>
<a href="#l32.30"></a><span id="l32.30">                 // xxx todo: are there similar X-MICROSOFT-CDO properties to be considered here?</span>
<a href="#l32.31"></a><span id="l32.31">                 dtstamp = item.stampTime;</span>
<a href="#l32.32"></a><span id="l32.32">             }</span>
<a href="#l32.33"></a><span id="l32.33">         }</span>
<a href="#l32.34"></a><span id="l32.34"> </span>
<a href="#l32.35"></a><span id="l32.35">         return dtstamp;</span>
<a href="#l32.36"></a><span id="l32.36">     },</span>
<a href="#l32.37"></a><span id="l32.37" class="difflineat">@@ -557,19 +557,19 @@ cal.itip = {</span>
<a href="#l32.38"></a><span id="l32.38">             if (aOriginalItem.recurrenceInfo &amp;&amp; aItem.recurrenceInfo) {</span>
<a href="#l32.39"></a><span id="l32.39">                 // check whether the two differ only in EXDATEs</span>
<a href="#l32.40"></a><span id="l32.40">                 let clonedItem = aItem.clone();</span>
<a href="#l32.41"></a><span id="l32.41">                 let exdates = [];</span>
<a href="#l32.42"></a><span id="l32.42">                 for (let ritem of clonedItem.recurrenceInfo.getRecurrenceItems({})) {</span>
<a href="#l32.43"></a><span id="l32.43">                     let wrappedRItem = cal.wrapInstance(ritem, Components.interfaces.calIRecurrenceDate);</span>
<a href="#l32.44"></a><span id="l32.44">                     if (ritem.isNegative &amp;&amp;</span>
<a href="#l32.45"></a><span id="l32.45">                         wrappedRItem &amp;&amp;</span>
<a href="#l32.46"></a><span id="l32.46" class="difflineminus">-                        !aOriginalItem.recurrenceInfo.getRecurrenceItems({}).some((r) =&gt; {</span>
<a href="#l32.47"></a><span id="l32.47" class="difflineminus">-                            let wrappedR = cal.wrapInstance(r, Components.interfaces.calIRecurrenceDate);</span>
<a href="#l32.48"></a><span id="l32.48" class="difflineminus">-                            return r.isNegative &amp;&amp;</span>
<a href="#l32.49"></a><span id="l32.49" class="difflineplus">+                        !aOriginalItem.recurrenceInfo.getRecurrenceItems({}).some((recitem) =&gt; {</span>
<a href="#l32.50"></a><span id="l32.50" class="difflineplus">+                            let wrappedR = cal.wrapInstance(recitem, Components.interfaces.calIRecurrenceDate);</span>
<a href="#l32.51"></a><span id="l32.51" class="difflineplus">+                            return recitem.isNegative &amp;&amp;</span>
<a href="#l32.52"></a><span id="l32.52">                                    wrappedR &amp;&amp;</span>
<a href="#l32.53"></a><span id="l32.53">                                    wrappedR.date.compare(wrappedRItem.date) == 0;</span>
<a href="#l32.54"></a><span id="l32.54">                         })) {</span>
<a href="#l32.55"></a><span id="l32.55">                         exdates.push(wrappedRItem);</span>
<a href="#l32.56"></a><span id="l32.56">                     }</span>
<a href="#l32.57"></a><span id="l32.57">                 }</span>
<a href="#l32.58"></a><span id="l32.58">                 if (exdates.length &gt; 0) {</span>
<a href="#l32.59"></a><span id="l32.59">                     // check whether really only EXDATEs have been added:</span>
<a href="#l32.60"></a><span id="l32.60" class="difflineat">@@ -809,19 +809,19 @@ cal.itip = {</span>
<a href="#l32.61"></a><span id="l32.61">                         propStrings.push(item.recurrenceId + &quot;#&quot; + prop.icalString);</span>
<a href="#l32.62"></a><span id="l32.62">                     }</span>
<a href="#l32.63"></a><span id="l32.63">                 }</span>
<a href="#l32.64"></a><span id="l32.64">             }</span>
<a href="#l32.65"></a><span id="l32.65">             propStrings.sort();</span>
<a href="#l32.66"></a><span id="l32.66">             return propStrings.join(&quot;&quot;);</span>
<a href="#l32.67"></a><span id="l32.67">         };</span>
<a href="#l32.68"></a><span id="l32.68"> </span>
<a href="#l32.69"></a><span id="l32.69" class="difflineminus">-        let h1 = hashMajorProps(newItem);</span>
<a href="#l32.70"></a><span id="l32.70" class="difflineminus">-        let h2 = hashMajorProps(oldItem);</span>
<a href="#l32.71"></a><span id="l32.71" class="difflineminus">-        if (h1 != h2) {</span>
<a href="#l32.72"></a><span id="l32.72" class="difflineplus">+        let hash1 = hashMajorProps(newItem);</span>
<a href="#l32.73"></a><span id="l32.73" class="difflineplus">+        let hash2 = hashMajorProps(oldItem);</span>
<a href="#l32.74"></a><span id="l32.74" class="difflineplus">+        if (hash1 != hash2) {</span>
<a href="#l32.75"></a><span id="l32.75">             newItem = newItem.clone();</span>
<a href="#l32.76"></a><span id="l32.76">             // bump SEQUENCE, it never decreases (mind undo scenario here)</span>
<a href="#l32.77"></a><span id="l32.77">             newItem.setProperty(&quot;SEQUENCE&quot;,</span>
<a href="#l32.78"></a><span id="l32.78">                                 String(Math.max(cal.itip.getSequence(oldItem),</span>
<a href="#l32.79"></a><span id="l32.79">                                                 cal.itip.getSequence(newItem)) + 1));</span>
<a href="#l32.80"></a><span id="l32.80">         }</span>
<a href="#l32.81"></a><span id="l32.81"> </span>
<a href="#l32.82"></a><span id="l32.82">         return newItem;</span>
<a href="#l32.83"></a><span id="l32.83" class="difflineat">@@ -1491,19 +1491,19 @@ ItipItemFinder.prototype = {</span>
<a href="#l32.84"></a><span id="l32.84">                 }</span>
<a href="#l32.85"></a><span id="l32.85">             }</span>
<a href="#l32.86"></a><span id="l32.86">         }</span>
<a href="#l32.87"></a><span id="l32.87"> </span>
<a href="#l32.88"></a><span id="l32.88">         cal.LOG(&quot;iTIP operations: &quot; + operations.length);</span>
<a href="#l32.89"></a><span id="l32.89">         let actionFunc = null;</span>
<a href="#l32.90"></a><span id="l32.90">         if (operations.length &gt; 0) {</span>
<a href="#l32.91"></a><span id="l32.91">             actionFunc = function(opListener, partStat) {</span>
<a href="#l32.92"></a><span id="l32.92" class="difflineminus">-                for (let op of operations) {</span>
<a href="#l32.93"></a><span id="l32.93" class="difflineplus">+                for (let operation of operations) {</span>
<a href="#l32.94"></a><span id="l32.94">                     try {</span>
<a href="#l32.95"></a><span id="l32.95" class="difflineminus">-                        op(opListener, partStat);</span>
<a href="#l32.96"></a><span id="l32.96" class="difflineplus">+                        operation(opListener, partStat);</span>
<a href="#l32.97"></a><span id="l32.97">                     } catch (exc) {</span>
<a href="#l32.98"></a><span id="l32.98">                         cal.ERROR(exc);</span>
<a href="#l32.99"></a><span id="l32.99">                     }</span>
<a href="#l32.100"></a><span id="l32.100">                 }</span>
<a href="#l32.101"></a><span id="l32.101">             };</span>
<a href="#l32.102"></a><span id="l32.102">             actionFunc.method = actionMethod;</span>
<a href="#l32.103"></a><span id="l32.103">         }</span>
<a href="#l32.104"></a><span id="l32.104"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1" class="difflineminus">--- a/calendar/base/modules/calPrintUtils.jsm</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineplus">+++ b/calendar/base/modules/calPrintUtils.jsm</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineat">@@ -10,18 +10,18 @@ this.EXPORTED_SYMBOLS = [&quot;cal&quot;]; // even</span>
<a href="#l33.4"></a><span id="l33.4"> cal.print = {</span>
<a href="#l33.5"></a><span id="l33.5">     /**</span>
<a href="#l33.6"></a><span id="l33.6">      * Returns a simple key in the format YYYY-MM-DD for use in the table of</span>
<a href="#l33.7"></a><span id="l33.7">      * dates to day boxes</span>
<a href="#l33.8"></a><span id="l33.8">      *</span>
<a href="#l33.9"></a><span id="l33.9">      * @param dt    The date to translate</span>
<a href="#l33.10"></a><span id="l33.10">      * @return      YYYY-MM-DD</span>
<a href="#l33.11"></a><span id="l33.11">      */</span>
<a href="#l33.12"></a><span id="l33.12" class="difflineminus">-    getDateKey: function(dt) {</span>
<a href="#l33.13"></a><span id="l33.13" class="difflineminus">-        return dt.year + &quot;-&quot; + dt.month + &quot;-&quot; + dt.day;</span>
<a href="#l33.14"></a><span id="l33.14" class="difflineplus">+    getDateKey: function(date) {</span>
<a href="#l33.15"></a><span id="l33.15" class="difflineplus">+        return date.year + &quot;-&quot; + date.month + &quot;-&quot; + date.day;</span>
<a href="#l33.16"></a><span id="l33.16">     },</span>
<a href="#l33.17"></a><span id="l33.17"> </span>
<a href="#l33.18"></a><span id="l33.18">     /**</span>
<a href="#l33.19"></a><span id="l33.19">      * Add category styles to the document's &quot;sheet&quot; element. This is needed</span>
<a href="#l33.20"></a><span id="l33.20">      * since the HTML created is serialized, so we can't dynamically set the</span>
<a href="#l33.21"></a><span id="l33.21">      * styles and can be changed if the print formatter decides to return a</span>
<a href="#l33.22"></a><span id="l33.22">      * DOM document instead.</span>
<a href="#l33.23"></a><span id="l33.23">      *</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1" class="difflineminus">--- a/calendar/base/modules/calRecurrenceUtils.jsm</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineplus">+++ b/calendar/base/modules/calRecurrenceUtils.jsm</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineat">@@ -36,17 +36,17 @@ function recurrenceRule2String(recurrenc</span>
<a href="#l34.4"></a><span id="l34.4">                nounClassStr.substr(1);</span>
<a href="#l34.5"></a><span id="l34.5">     }</span>
<a href="#l34.6"></a><span id="l34.6">     function pluralWeekday(aDayString) {</span>
<a href="#l34.7"></a><span id="l34.7">         let plural = getRString(&quot;pluralForWeekdays&quot;) == &quot;true&quot;;</span>
<a href="#l34.8"></a><span id="l34.8">         return (plural ? aDayString + &quot;Plural&quot; : aDayString);</span>
<a href="#l34.9"></a><span id="l34.9">     }</span>
<a href="#l34.10"></a><span id="l34.10">     function everyWeekDay(aByDay) {</span>
<a href="#l34.11"></a><span id="l34.11">         // Checks if aByDay contains only values from 1 to 7 with any order.</span>
<a href="#l34.12"></a><span id="l34.12" class="difflineminus">-        let mask = aByDay.reduce((v, c) =&gt; v | (1 &lt;&lt; c), 1);</span>
<a href="#l34.13"></a><span id="l34.13" class="difflineplus">+        let mask = aByDay.reduce((value, item) =&gt; value | (1 &lt;&lt; item), 1);</span>
<a href="#l34.14"></a><span id="l34.14">         return aByDay.length == 7 &amp;&amp; mask == Math.pow(2, 8) - 1;</span>
<a href="#l34.15"></a><span id="l34.15">     }</span>
<a href="#l34.16"></a><span id="l34.16"> </span>
<a href="#l34.17"></a><span id="l34.17"> </span>
<a href="#l34.18"></a><span id="l34.18">     // Retrieve a valid recurrence rule from the currently</span>
<a href="#l34.19"></a><span id="l34.19">     // set recurrence info. Bail out if there's more</span>
<a href="#l34.20"></a><span id="l34.20">     // than a single rule or something other than a rule.</span>
<a href="#l34.21"></a><span id="l34.21">     recurrenceInfo = recurrenceInfo.clone();</span>
<a href="#l34.22"></a><span id="l34.22" class="difflineat">@@ -368,21 +368,21 @@ function recurrenceRule2String(recurrenc</span>
<a href="#l34.23"></a><span id="l34.23">  * @param recurrenceInfo    An item's recurrence info to parse.</span>
<a href="#l34.24"></a><span id="l34.24">  * @return                  An array with two elements: an array of positive</span>
<a href="#l34.25"></a><span id="l34.25">  *                            rules and an array of negative rules.</span>
<a href="#l34.26"></a><span id="l34.26">  */</span>
<a href="#l34.27"></a><span id="l34.27"> function splitRecurrenceRules(recurrenceInfo) {</span>
<a href="#l34.28"></a><span id="l34.28">     let ritems = recurrenceInfo.getRecurrenceItems({});</span>
<a href="#l34.29"></a><span id="l34.29">     let rules = [];</span>
<a href="#l34.30"></a><span id="l34.30">     let exceptions = [];</span>
<a href="#l34.31"></a><span id="l34.31" class="difflineminus">-    for (let r of ritems) {</span>
<a href="#l34.32"></a><span id="l34.32" class="difflineminus">-        if (r.isNegative) {</span>
<a href="#l34.33"></a><span id="l34.33" class="difflineminus">-            exceptions.push(r);</span>
<a href="#l34.34"></a><span id="l34.34" class="difflineplus">+    for (let ritem of ritems) {</span>
<a href="#l34.35"></a><span id="l34.35" class="difflineplus">+        if (ritem.isNegative) {</span>
<a href="#l34.36"></a><span id="l34.36" class="difflineplus">+            exceptions.push(ritem);</span>
<a href="#l34.37"></a><span id="l34.37">         } else {</span>
<a href="#l34.38"></a><span id="l34.38" class="difflineminus">-            rules.push(r);</span>
<a href="#l34.39"></a><span id="l34.39" class="difflineplus">+            rules.push(ritem);</span>
<a href="#l34.40"></a><span id="l34.40">         }</span>
<a href="#l34.41"></a><span id="l34.41">     }</span>
<a href="#l34.42"></a><span id="l34.42">     return [rules, exceptions];</span>
<a href="#l34.43"></a><span id="l34.43"> }</span>
<a href="#l34.44"></a><span id="l34.44"> </span>
<a href="#l34.45"></a><span id="l34.45"> /**</span>
<a href="#l34.46"></a><span id="l34.46">  * Check if a recurrence rule's component is valid.</span>
<a href="#l34.47"></a><span id="l34.47">  *</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1" class="difflineminus">--- a/calendar/base/modules/calUtils.jsm</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineplus">+++ b/calendar/base/modules/calUtils.jsm</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineat">@@ -153,18 +153,18 @@ var cal = {</span>
<a href="#l35.4"></a><span id="l35.4">      */</span>
<a href="#l35.5"></a><span id="l35.5">     isTaskCalendar: function(aCalendar) {</span>
<a href="#l35.6"></a><span id="l35.6">         return (aCalendar.getProperty(&quot;capabilities.tasks.supported&quot;) !== false);</span>
<a href="#l35.7"></a><span id="l35.7">     },</span>
<a href="#l35.8"></a><span id="l35.8"> </span>
<a href="#l35.9"></a><span id="l35.9">     /**</span>
<a href="#l35.10"></a><span id="l35.10">      * Checks whether a timezone lacks a definition.</span>
<a href="#l35.11"></a><span id="l35.11">      */</span>
<a href="#l35.12"></a><span id="l35.12" class="difflineminus">-    isPhantomTimezone: function(tz) {</span>
<a href="#l35.13"></a><span id="l35.13" class="difflineminus">-        return (!tz.icalComponent &amp;&amp; !tz.isUTC &amp;&amp; !tz.isFloating);</span>
<a href="#l35.14"></a><span id="l35.14" class="difflineplus">+    isPhantomTimezone: function(timezone) {</span>
<a href="#l35.15"></a><span id="l35.15" class="difflineplus">+        return (!timezone.icalComponent &amp;&amp; !timezone.isUTC &amp;&amp; !timezone.isFloating);</span>
<a href="#l35.16"></a><span id="l35.16">     },</span>
<a href="#l35.17"></a><span id="l35.17"> </span>
<a href="#l35.18"></a><span id="l35.18">     /**</span>
<a href="#l35.19"></a><span id="l35.19">      * Shifts an item by the given timely offset.</span>
<a href="#l35.20"></a><span id="l35.20">      *</span>
<a href="#l35.21"></a><span id="l35.21">      * @param item an item</span>
<a href="#l35.22"></a><span id="l35.22">      * @param offset an offset (calIDuration)</span>
<a href="#l35.23"></a><span id="l35.23">      */</span>
<a href="#l35.24"></a><span id="l35.24" class="difflineat">@@ -277,23 +277,23 @@ var cal = {</span>
<a href="#l35.25"></a><span id="l35.25">             }</span>
<a href="#l35.26"></a><span id="l35.26">             let parts = (prefix + member).match(/(.*)( &lt;.*&gt;)/);</span>
<a href="#l35.27"></a><span id="l35.27">             if (parts) {</span>
<a href="#l35.28"></a><span id="l35.28">                 if (parts[2] == &quot; &lt;&gt;&quot;) {</span>
<a href="#l35.29"></a><span id="l35.29">                     // CN but no email address - we keep the CN part to prefix the next member's CN</span>
<a href="#l35.30"></a><span id="l35.30">                     prefix = parts[1];</span>
<a href="#l35.31"></a><span id="l35.31">                 } else {</span>
<a href="#l35.32"></a><span id="l35.32">                     // CN with email address</span>
<a href="#l35.33"></a><span id="l35.33" class="difflineminus">-                    let cn = parts[1].trim();</span>
<a href="#l35.34"></a><span id="l35.34" class="difflineplus">+                    let commonName = parts[1].trim();</span>
<a href="#l35.35"></a><span id="l35.35">                     // in case of any special characters in the CN string, we make sure to enclose</span>
<a href="#l35.36"></a><span id="l35.36">                     // it with dquotes - simple spaces don't require dquotes</span>
<a href="#l35.37"></a><span id="l35.37" class="difflineminus">-                    if (cn.match(/[\-\[\]{}()*+?.,;\\\^$|#\f\n\r\t\v]/)) {</span>
<a href="#l35.38"></a><span id="l35.38" class="difflineminus">-                        cn = '&quot;' + cn.replace(/\\&quot;|&quot;/, &quot;&quot;).trim() + '&quot;';</span>
<a href="#l35.39"></a><span id="l35.39" class="difflineplus">+                    if (commonName.match(/[\-\[\]{}()*+?.,;\\\^$|#\f\n\r\t\v]/)) {</span>
<a href="#l35.40"></a><span id="l35.40" class="difflineplus">+                        commonName = '&quot;' + commonName.replace(/\\&quot;|&quot;/, &quot;&quot;).trim() + '&quot;';</span>
<a href="#l35.41"></a><span id="l35.41">                     }</span>
<a href="#l35.42"></a><span id="l35.42" class="difflineminus">-                    list.push(cn + parts[2]);</span>
<a href="#l35.43"></a><span id="l35.43" class="difflineplus">+                    list.push(commonName + parts[2]);</span>
<a href="#l35.44"></a><span id="l35.44">                     prefix = &quot;&quot;;</span>
<a href="#l35.45"></a><span id="l35.45">                 }</span>
<a href="#l35.46"></a><span id="l35.46">             } else if (member.length) {</span>
<a href="#l35.47"></a><span id="l35.47">                 // email address only</span>
<a href="#l35.48"></a><span id="l35.48">                 list.push(member);</span>
<a href="#l35.49"></a><span id="l35.49">                 prefix = &quot;&quot;;</span>
<a href="#l35.50"></a><span id="l35.50">             }</span>
<a href="#l35.51"></a><span id="l35.51">         }</span>
<a href="#l35.52"></a><span id="l35.52" class="difflineat">@@ -404,24 +404,24 @@ var cal = {</span>
<a href="#l35.53"></a><span id="l35.53">      */</span>
<a href="#l35.54"></a><span id="l35.54">     getAttendeeEmail: function(aAttendee, aIncludeCn) {</span>
<a href="#l35.55"></a><span id="l35.55">         // If the recipient id is of type urn, we need to figure out the email address, otherwise</span>
<a href="#l35.56"></a><span id="l35.56">         // we fall back to the attendee id</span>
<a href="#l35.57"></a><span id="l35.57">         let email = aAttendee.id.match(/^urn:/i) ? aAttendee.getProperty(&quot;EMAIL&quot;) || &quot;&quot; : aAttendee.id;</span>
<a href="#l35.58"></a><span id="l35.58">         // Strip leading &quot;mailto:&quot; if it exists.</span>
<a href="#l35.59"></a><span id="l35.59">         email = email.replace(/^mailto:/i, &quot;&quot;);</span>
<a href="#l35.60"></a><span id="l35.60">         // We add the CN if requested and available</span>
<a href="#l35.61"></a><span id="l35.61" class="difflineminus">-        let cn = aAttendee.commonName;</span>
<a href="#l35.62"></a><span id="l35.62" class="difflineminus">-        if (aIncludeCn &amp;&amp; email.length &gt; 0 &amp;&amp; cn &amp;&amp; cn.length &gt; 0) {</span>
<a href="#l35.63"></a><span id="l35.63" class="difflineminus">-            if (cn.match(/[,;]/)) {</span>
<a href="#l35.64"></a><span id="l35.64" class="difflineminus">-                cn = '&quot;' + cn + '&quot;';</span>
<a href="#l35.65"></a><span id="l35.65" class="difflineplus">+        let commonName = aAttendee.commonName;</span>
<a href="#l35.66"></a><span id="l35.66" class="difflineplus">+        if (aIncludeCn &amp;&amp; email.length &gt; 0 &amp;&amp; commonName &amp;&amp; commonName.length &gt; 0) {</span>
<a href="#l35.67"></a><span id="l35.67" class="difflineplus">+            if (commonName.match(/[,;]/)) {</span>
<a href="#l35.68"></a><span id="l35.68" class="difflineplus">+                commonName = '&quot;' + commonName + '&quot;';</span>
<a href="#l35.69"></a><span id="l35.69">             }</span>
<a href="#l35.70"></a><span id="l35.70" class="difflineminus">-            cn = cn + &quot; &lt;&quot; + email + &quot;&gt;&quot;;</span>
<a href="#l35.71"></a><span id="l35.71" class="difflineminus">-            if (cal.validateRecipientList(cn) == cn) {</span>
<a href="#l35.72"></a><span id="l35.72" class="difflineminus">-                email = cn;</span>
<a href="#l35.73"></a><span id="l35.73" class="difflineplus">+            commonName = commonName + &quot; &lt;&quot; + email + &quot;&gt;&quot;;</span>
<a href="#l35.74"></a><span id="l35.74" class="difflineplus">+            if (cal.validateRecipientList(commonName) == commonName) {</span>
<a href="#l35.75"></a><span id="l35.75" class="difflineplus">+                email = commonName;</span>
<a href="#l35.76"></a><span id="l35.76">             }</span>
<a href="#l35.77"></a><span id="l35.77">         }</span>
<a href="#l35.78"></a><span id="l35.78">         return email;</span>
<a href="#l35.79"></a><span id="l35.79">     },</span>
<a href="#l35.80"></a><span id="l35.80"> </span>
<a href="#l35.81"></a><span id="l35.81">     /**</span>
<a href="#l35.82"></a><span id="l35.82">      * Provides a string to use in email &quot;to&quot; header for given attendees</span>
<a href="#l35.83"></a><span id="l35.83">      *</span>
<a href="#l35.84"></a><span id="l35.84" class="difflineat">@@ -538,26 +538,26 @@ var cal = {</span>
<a href="#l35.85"></a><span id="l35.85">             if (modifier == 1) {</span>
<a href="#l35.86"></a><span id="l35.86">               return cal.compareNativeTimeFilledAsc(nsA, nsB);</span>
<a href="#l35.87"></a><span id="l35.87">             } else {</span>
<a href="#l35.88"></a><span id="l35.88">               return cal.compareNativeTimeFilledDesc(nsA, nsB);</span>
<a href="#l35.89"></a><span id="l35.89">             }</span>
<a href="#l35.90"></a><span id="l35.90">           };</span>
<a href="#l35.91"></a><span id="l35.91">         case &quot;string&quot;:</span>
<a href="#l35.92"></a><span id="l35.92">           return function(sortEntryA, sortEntryB) {</span>
<a href="#l35.93"></a><span id="l35.93" class="difflineminus">-            let sA = cal.sortEntryKey(sortEntryA);</span>
<a href="#l35.94"></a><span id="l35.94" class="difflineminus">-            let sB = cal.sortEntryKey(sortEntryB);</span>
<a href="#l35.95"></a><span id="l35.95" class="difflineminus">-            if (sA.length == 0 || sB.length == 0) {</span>
<a href="#l35.96"></a><span id="l35.96" class="difflineplus">+            let seA = cal.sortEntryKey(sortEntryA);</span>
<a href="#l35.97"></a><span id="l35.97" class="difflineplus">+            let seB = cal.sortEntryKey(sortEntryB);</span>
<a href="#l35.98"></a><span id="l35.98" class="difflineplus">+            if (seA.length == 0 || seB.length == 0) {</span>
<a href="#l35.99"></a><span id="l35.99">               // sort empty values to end (so when users first sort by a</span>
<a href="#l35.100"></a><span id="l35.100">               // column, they can see and find the desired values in that</span>
<a href="#l35.101"></a><span id="l35.101">               // column without scrolling past all the empty values).</span>
<a href="#l35.102"></a><span id="l35.102" class="difflineminus">-              return -(sA.length - sB.length) * modifier;</span>
<a href="#l35.103"></a><span id="l35.103" class="difflineplus">+              return -(seA.length - seB.length) * modifier;</span>
<a href="#l35.104"></a><span id="l35.104">             }</span>
<a href="#l35.105"></a><span id="l35.105">             let collator = cal.createLocaleCollator();</span>
<a href="#l35.106"></a><span id="l35.106" class="difflineminus">-            let comparison = collator.compareString(0, sA, sB);</span>
<a href="#l35.107"></a><span id="l35.107" class="difflineplus">+            let comparison = collator.compareString(0, seA, seB);</span>
<a href="#l35.108"></a><span id="l35.108">             return comparison * modifier;</span>
<a href="#l35.109"></a><span id="l35.109">           };</span>
<a href="#l35.110"></a><span id="l35.110">         default:</span>
<a href="#l35.111"></a><span id="l35.111">           return function(sortEntryA, sortEntryB) {</span>
<a href="#l35.112"></a><span id="l35.112">             return 0;</span>
<a href="#l35.113"></a><span id="l35.113">           };</span>
<a href="#l35.114"></a><span id="l35.114">       }</span>
<a href="#l35.115"></a><span id="l35.115">     },</span>
<a href="#l35.116"></a><span id="l35.116" class="difflineat">@@ -634,21 +634,21 @@ var cal = {</span>
<a href="#l35.117"></a><span id="l35.117">     },</span>
<a href="#l35.118"></a><span id="l35.118"> </span>
<a href="#l35.119"></a><span id="l35.119">     nativeTimeOrNow: function(calDateTime, sortStartedTime) {</span>
<a href="#l35.120"></a><span id="l35.120">         // Treat null/0 as 'now' when sort started, so incomplete tasks stay current.</span>
<a href="#l35.121"></a><span id="l35.121">         // Time is computed once per sort (just before sort) so sort is stable.</span>
<a href="#l35.122"></a><span id="l35.122">         if (calDateTime == null) {</span>
<a href="#l35.123"></a><span id="l35.123">             return sortStartedTime.nativeTime;</span>
<a href="#l35.124"></a><span id="l35.124">         }</span>
<a href="#l35.125"></a><span id="l35.125" class="difflineminus">-        let ns = calDateTime.nativeTime;</span>
<a href="#l35.126"></a><span id="l35.126" class="difflineminus">-        if (ns == -62168601600000000) { // ns value for (0000/00/00 00:00:00)</span>
<a href="#l35.127"></a><span id="l35.127" class="difflineplus">+        let nativeTime = calDateTime.nativeTime;</span>
<a href="#l35.128"></a><span id="l35.128" class="difflineplus">+        if (nativeTime == -62168601600000000) { // nativeTime value for (0000/00/00 00:00:00)</span>
<a href="#l35.129"></a><span id="l35.129">             return sortStartedTime;</span>
<a href="#l35.130"></a><span id="l35.130">         }</span>
<a href="#l35.131"></a><span id="l35.131" class="difflineminus">-        return ns;</span>
<a href="#l35.132"></a><span id="l35.132" class="difflineplus">+        return nativeTime;</span>
<a href="#l35.133"></a><span id="l35.133">     },</span>
<a href="#l35.134"></a><span id="l35.134"> </span>
<a href="#l35.135"></a><span id="l35.135">     nativeTime: function(calDateTime) {</span>
<a href="#l35.136"></a><span id="l35.136">         if (calDateTime == null) {</span>
<a href="#l35.137"></a><span id="l35.137">             return -62168601600000000; // ns value for (0000/00/00 00:00:00)</span>
<a href="#l35.138"></a><span id="l35.138">         }</span>
<a href="#l35.139"></a><span id="l35.139">         return calDateTime.nativeTime;</span>
<a href="#l35.140"></a><span id="l35.140">     },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l36.1"></a><span id="l36.1" class="difflineminus">--- a/calendar/base/src/calAlarm.js</span>
<a href="#l36.2"></a><span id="l36.2" class="difflineplus">+++ b/calendar/base/src/calAlarm.js</span>
<a href="#l36.3"></a><span id="l36.3" class="difflineat">@@ -86,73 +86,73 @@ calAlarm.prototype = {</span>
<a href="#l36.4"></a><span id="l36.4">                 }</span>
<a href="#l36.5"></a><span id="l36.5">             }</span>
<a href="#l36.6"></a><span id="l36.6">         }</span>
<a href="#l36.7"></a><span id="l36.7"> </span>
<a href="#l36.8"></a><span id="l36.8">         this.mImmutable = true;</span>
<a href="#l36.9"></a><span id="l36.9">     },</span>
<a href="#l36.10"></a><span id="l36.10"> </span>
<a href="#l36.11"></a><span id="l36.11">     clone: function() {</span>
<a href="#l36.12"></a><span id="l36.12" class="difflineminus">-        let m = new calAlarm();</span>
<a href="#l36.13"></a><span id="l36.13" class="difflineplus">+        let cloned = new calAlarm();</span>
<a href="#l36.14"></a><span id="l36.14"> </span>
<a href="#l36.15"></a><span id="l36.15" class="difflineminus">-        m.mImmutable = false;</span>
<a href="#l36.16"></a><span id="l36.16" class="difflineplus">+        cloned.mImmutable = false;</span>
<a href="#l36.17"></a><span id="l36.17"> </span>
<a href="#l36.18"></a><span id="l36.18">         const simpleMembers = [&quot;mAction&quot;,</span>
<a href="#l36.19"></a><span id="l36.19">                                &quot;mSummary&quot;,</span>
<a href="#l36.20"></a><span id="l36.20">                                &quot;mDescription&quot;,</span>
<a href="#l36.21"></a><span id="l36.21">                                &quot;mRelated&quot;,</span>
<a href="#l36.22"></a><span id="l36.22">                                &quot;mRepeat&quot;];</span>
<a href="#l36.23"></a><span id="l36.23"> </span>
<a href="#l36.24"></a><span id="l36.24">         const arrayMembers = [&quot;mAttendees&quot;,</span>
<a href="#l36.25"></a><span id="l36.25">                               &quot;mAttachments&quot;];</span>
<a href="#l36.26"></a><span id="l36.26"> </span>
<a href="#l36.27"></a><span id="l36.27">         const objectMembers = [&quot;mAbsoluteDate&quot;,</span>
<a href="#l36.28"></a><span id="l36.28">                                &quot;mOffset&quot;,</span>
<a href="#l36.29"></a><span id="l36.29">                                &quot;mDuration&quot;,</span>
<a href="#l36.30"></a><span id="l36.30">                                &quot;mLastAck&quot;];</span>
<a href="#l36.31"></a><span id="l36.31"> </span>
<a href="#l36.32"></a><span id="l36.32">         for (let member of simpleMembers) {</span>
<a href="#l36.33"></a><span id="l36.33" class="difflineminus">-            m[member] = this[member];</span>
<a href="#l36.34"></a><span id="l36.34" class="difflineplus">+            cloned[member] = this[member];</span>
<a href="#l36.35"></a><span id="l36.35">         }</span>
<a href="#l36.36"></a><span id="l36.36"> </span>
<a href="#l36.37"></a><span id="l36.37">         for (let member of arrayMembers) {</span>
<a href="#l36.38"></a><span id="l36.38">             let newArray = [];</span>
<a href="#l36.39"></a><span id="l36.39">             for (let oldElem of this[member]) {</span>
<a href="#l36.40"></a><span id="l36.40">                 newArray.push(oldElem.clone());</span>
<a href="#l36.41"></a><span id="l36.41">             }</span>
<a href="#l36.42"></a><span id="l36.42" class="difflineminus">-            m[member] = newArray;</span>
<a href="#l36.43"></a><span id="l36.43" class="difflineplus">+            cloned[member] = newArray;</span>
<a href="#l36.44"></a><span id="l36.44">         }</span>
<a href="#l36.45"></a><span id="l36.45"> </span>
<a href="#l36.46"></a><span id="l36.46">         for (let member of objectMembers) {</span>
<a href="#l36.47"></a><span id="l36.47">             if (this[member] &amp;&amp; this[member].clone) {</span>
<a href="#l36.48"></a><span id="l36.48" class="difflineminus">-                m[member] = this[member].clone();</span>
<a href="#l36.49"></a><span id="l36.49" class="difflineplus">+                cloned[member] = this[member].clone();</span>
<a href="#l36.50"></a><span id="l36.50">             } else {</span>
<a href="#l36.51"></a><span id="l36.51" class="difflineminus">-                m[member] = this[member];</span>
<a href="#l36.52"></a><span id="l36.52" class="difflineplus">+                cloned[member] = this[member];</span>
<a href="#l36.53"></a><span id="l36.53">             }</span>
<a href="#l36.54"></a><span id="l36.54">         }</span>
<a href="#l36.55"></a><span id="l36.55"> </span>
<a href="#l36.56"></a><span id="l36.56">         // X-Props</span>
<a href="#l36.57"></a><span id="l36.57" class="difflineminus">-        m.mProperties = new calPropertyBag();</span>
<a href="#l36.58"></a><span id="l36.58" class="difflineplus">+        cloned.mProperties = new calPropertyBag();</span>
<a href="#l36.59"></a><span id="l36.59">         for (let [name, value] of this.mProperties) {</span>
<a href="#l36.60"></a><span id="l36.60">             if (value instanceof Components.interfaces.calIDateTime) {</span>
<a href="#l36.61"></a><span id="l36.61">                 value = value.clone();</span>
<a href="#l36.62"></a><span id="l36.62">             }</span>
<a href="#l36.63"></a><span id="l36.63"> </span>
<a href="#l36.64"></a><span id="l36.64" class="difflineminus">-            m.mProperties.setProperty(name, value);</span>
<a href="#l36.65"></a><span id="l36.65" class="difflineplus">+            cloned.mProperties.setProperty(name, value);</span>
<a href="#l36.66"></a><span id="l36.66"> </span>
<a href="#l36.67"></a><span id="l36.67">             let propBucket = this.mPropertyParams[name];</span>
<a href="#l36.68"></a><span id="l36.68">             if (propBucket) {</span>
<a href="#l36.69"></a><span id="l36.69">                 let newBucket = {};</span>
<a href="#l36.70"></a><span id="l36.70">                 for (let param in propBucket) {</span>
<a href="#l36.71"></a><span id="l36.71">                     newBucket[param] = propBucket[param];</span>
<a href="#l36.72"></a><span id="l36.72">                 }</span>
<a href="#l36.73"></a><span id="l36.73" class="difflineminus">-                m.mPropertyParams[name] = newBucket;</span>
<a href="#l36.74"></a><span id="l36.74" class="difflineplus">+                cloned.mPropertyParams[name] = newBucket;</span>
<a href="#l36.75"></a><span id="l36.75">             }</span>
<a href="#l36.76"></a><span id="l36.76">         }</span>
<a href="#l36.77"></a><span id="l36.77" class="difflineminus">-        return m;</span>
<a href="#l36.78"></a><span id="l36.78" class="difflineplus">+        return cloned;</span>
<a href="#l36.79"></a><span id="l36.79">     },</span>
<a href="#l36.80"></a><span id="l36.80"> </span>
<a href="#l36.81"></a><span id="l36.81"> </span>
<a href="#l36.82"></a><span id="l36.82">     get related() {</span>
<a href="#l36.83"></a><span id="l36.83">         return this.mRelated;</span>
<a href="#l36.84"></a><span id="l36.84">     },</span>
<a href="#l36.85"></a><span id="l36.85">     set related(aValue) {</span>
<a href="#l36.86"></a><span id="l36.86">         this.ensureMutable();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l37.1"></a><span id="l37.1" class="difflineminus">--- a/calendar/base/src/calAttachment.js</span>
<a href="#l37.2"></a><span id="l37.2" class="difflineplus">+++ b/calendar/base/src/calAttachment.js</span>
<a href="#l37.3"></a><span id="l37.3" class="difflineat">@@ -26,27 +26,27 @@ calAttachment.prototype = {</span>
<a href="#l37.4"></a><span id="l37.4">         classID: calAttachmentClassID,</span>
<a href="#l37.5"></a><span id="l37.5">         contractID: &quot;@mozilla.org/calendar/attachment;1&quot;,</span>
<a href="#l37.6"></a><span id="l37.6">         classDescription: &quot;Calendar Item Attachment&quot;,</span>
<a href="#l37.7"></a><span id="l37.7">         interfaces: calAttachmentInterfaces</span>
<a href="#l37.8"></a><span id="l37.8">     }),</span>
<a href="#l37.9"></a><span id="l37.9"> </span>
<a href="#l37.10"></a><span id="l37.10">     get hashId() {</span>
<a href="#l37.11"></a><span id="l37.11">         if (!this.mHashId) {</span>
<a href="#l37.12"></a><span id="l37.12" class="difflineminus">-            let ch = Components.classes[&quot;@mozilla.org/security/hash;1&quot;]</span>
<a href="#l37.13"></a><span id="l37.13" class="difflineminus">-                               .createInstance(Components.interfaces.nsICryptoHash);</span>
<a href="#l37.14"></a><span id="l37.14" class="difflineplus">+            let cryptoHash = Components.classes[&quot;@mozilla.org/security/hash;1&quot;]</span>
<a href="#l37.15"></a><span id="l37.15" class="difflineplus">+                                       .createInstance(Components.interfaces.nsICryptoHash);</span>
<a href="#l37.16"></a><span id="l37.16"> </span>
<a href="#l37.17"></a><span id="l37.17">             let converter = Components.classes[&quot;@mozilla.org/intl/scriptableunicodeconverter&quot;]</span>
<a href="#l37.18"></a><span id="l37.18">                                       .createInstance(Components.interfaces.nsIScriptableUnicodeConverter);</span>
<a href="#l37.19"></a><span id="l37.19">             converter.charset = &quot;UTF-8&quot;;</span>
<a href="#l37.20"></a><span id="l37.20">             let data = converter.convertToByteArray(this.rawData, {});</span>
<a href="#l37.21"></a><span id="l37.21"> </span>
<a href="#l37.22"></a><span id="l37.22" class="difflineminus">-            ch.init(ch.MD5);</span>
<a href="#l37.23"></a><span id="l37.23" class="difflineminus">-            ch.update(data, data.length);</span>
<a href="#l37.24"></a><span id="l37.24" class="difflineminus">-            this.mHashId = ch.finish(true);</span>
<a href="#l37.25"></a><span id="l37.25" class="difflineplus">+            cryptoHash.init(cryptoHash.MD5);</span>
<a href="#l37.26"></a><span id="l37.26" class="difflineplus">+            cryptoHash.update(data, data.length);</span>
<a href="#l37.27"></a><span id="l37.27" class="difflineplus">+            this.mHashId = cryptoHash.finish(true);</span>
<a href="#l37.28"></a><span id="l37.28">         }</span>
<a href="#l37.29"></a><span id="l37.29">         return this.mHashId;</span>
<a href="#l37.30"></a><span id="l37.30">     },</span>
<a href="#l37.31"></a><span id="l37.31"> </span>
<a href="#l37.32"></a><span id="l37.32">     /**</span>
<a href="#l37.33"></a><span id="l37.33">      * calIAttachment</span>
<a href="#l37.34"></a><span id="l37.34">      */</span>
<a href="#l37.35"></a><span id="l37.35"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l38.1"></a><span id="l38.1" class="difflineminus">--- a/calendar/base/src/calCachedCalendar.js</span>
<a href="#l38.2"></a><span id="l38.2" class="difflineplus">+++ b/calendar/base/src/calCachedCalendar.js</span>
<a href="#l38.3"></a><span id="l38.3" class="difflineat">@@ -303,36 +303,36 @@ calCachedCalendar.prototype = {</span>
<a href="#l38.4"></a><span id="l38.4">                 try {</span>
<a href="#l38.5"></a><span id="l38.5">                     func(status);</span>
<a href="#l38.6"></a><span id="l38.6">                 } catch (exc) {</span>
<a href="#l38.7"></a><span id="l38.7">                     cal.ASSERT(false, exc);</span>
<a href="#l38.8"></a><span id="l38.8">                 }</span>
<a href="#l38.9"></a><span id="l38.9">             }</span>
<a href="#l38.10"></a><span id="l38.10">             queue.forEach(execResponseFunc);</span>
<a href="#l38.11"></a><span id="l38.11">             cal.LOG(&quot;[calCachedCalendar] sync queue empty.&quot;);</span>
<a href="#l38.12"></a><span id="l38.12" class="difflineminus">-            let op = self.mPendingSync;</span>
<a href="#l38.13"></a><span id="l38.13" class="difflineplus">+            let operation = self.mPendingSync;</span>
<a href="#l38.14"></a><span id="l38.14">             self.mPendingSync = null;</span>
<a href="#l38.15"></a><span id="l38.15" class="difflineminus">-            return op;</span>
<a href="#l38.16"></a><span id="l38.16" class="difflineplus">+            return operation;</span>
<a href="#l38.17"></a><span id="l38.17">         }</span>
<a href="#l38.18"></a><span id="l38.18"> </span>
<a href="#l38.19"></a><span id="l38.19">         if (this.offline) {</span>
<a href="#l38.20"></a><span id="l38.20">             return emptyQueue(Components.results.NS_OK);</span>
<a href="#l38.21"></a><span id="l38.21">         }</span>
<a href="#l38.22"></a><span id="l38.22"> </span>
<a href="#l38.23"></a><span id="l38.23">         if (this.supportsChangeLog) {</span>
<a href="#l38.24"></a><span id="l38.24">             cal.LOG(&quot;[calCachedCalendar] Doing changelog based sync for calendar &quot; + this.uri.spec);</span>
<a href="#l38.25"></a><span id="l38.25">             let opListener = {</span>
<a href="#l38.26"></a><span id="l38.26" class="difflineminus">-                onResult: function(op, result) {</span>
<a href="#l38.27"></a><span id="l38.27" class="difflineminus">-                    if (!op || !op.isPending) {</span>
<a href="#l38.28"></a><span id="l38.28" class="difflineminus">-                        let status = (op ? op.status : Components.results.NS_OK);</span>
<a href="#l38.29"></a><span id="l38.29" class="difflineplus">+                onResult: function(operation, result) {</span>
<a href="#l38.30"></a><span id="l38.30" class="difflineplus">+                    if (!operation || !operation.isPending) {</span>
<a href="#l38.31"></a><span id="l38.31" class="difflineplus">+                        let status = (operation ? operation.status : Components.results.NS_OK);</span>
<a href="#l38.32"></a><span id="l38.32">                         if (!Components.isSuccessCode(status)) {</span>
<a href="#l38.33"></a><span id="l38.33">                             cal.ERROR(&quot;[calCachedCalendar] replay action failed: &quot; +</span>
<a href="#l38.34"></a><span id="l38.34" class="difflineminus">-                                      (op ? op.id : &quot;&lt;unknown&gt;&quot;) + &quot;, uri=&quot; +</span>
<a href="#l38.35"></a><span id="l38.35" class="difflineplus">+                                      (operation ? operation.id : &quot;&lt;unknown&gt;&quot;) + &quot;, uri=&quot; +</span>
<a href="#l38.36"></a><span id="l38.36">                                       self.uri.spec + &quot;, result=&quot; +</span>
<a href="#l38.37"></a><span id="l38.37" class="difflineminus">-                                      result + &quot;, op=&quot; + op);</span>
<a href="#l38.38"></a><span id="l38.38" class="difflineplus">+                                      result + &quot;, operation=&quot; + operation);</span>
<a href="#l38.39"></a><span id="l38.39">                         }</span>
<a href="#l38.40"></a><span id="l38.40">                         cal.LOG(&quot;[calCachedCalendar] replayChangesOn finished.&quot;);</span>
<a href="#l38.41"></a><span id="l38.41">                         emptyQueue(status);</span>
<a href="#l38.42"></a><span id="l38.42">                     }</span>
<a href="#l38.43"></a><span id="l38.43">                 }</span>
<a href="#l38.44"></a><span id="l38.44">             };</span>
<a href="#l38.45"></a><span id="l38.45">             this.mPendingSync = this.mUncachedCalendar.replayChangesOn(opListener);</span>
<a href="#l38.46"></a><span id="l38.46">             return this.mPendingSync;</span>
<a href="#l38.47"></a><span id="l38.47" class="difflineat">@@ -701,17 +701,17 @@ calCachedCalendar.prototype = {</span>
<a href="#l38.48"></a><span id="l38.48"> </span>
<a href="#l38.49"></a><span id="l38.49">     modifyItem: function(newItem, oldItem, listener) {</span>
<a href="#l38.50"></a><span id="l38.50">         let self = this;</span>
<a href="#l38.51"></a><span id="l38.51"> </span>
<a href="#l38.52"></a><span id="l38.52">         // First of all, we should find out if the item to modify is</span>
<a href="#l38.53"></a><span id="l38.53">         // already an offline item or not.</span>
<a href="#l38.54"></a><span id="l38.54">         let flagListener = {</span>
<a href="#l38.55"></a><span id="l38.55">             onGetResult: function() {},</span>
<a href="#l38.56"></a><span id="l38.56" class="difflineminus">-            onOperationComplete: function(c, s, o, i, offline_flag) {</span>
<a href="#l38.57"></a><span id="l38.57" class="difflineplus">+            onOperationComplete: function(calendar, status, opType, id, offline_flag) {</span>
<a href="#l38.58"></a><span id="l38.58">                 if (offline_flag == cICL.OFFLINE_FLAG_CREATED_RECORD ||</span>
<a href="#l38.59"></a><span id="l38.59">                     offline_flag == cICL.OFFLINE_FLAG_MODIFIED_RECORD) {</span>
<a href="#l38.60"></a><span id="l38.60">                     // The item is already offline, just modify it in the cache</span>
<a href="#l38.61"></a><span id="l38.61">                     self.modifyOfflineItem(newItem, oldItem, listener);</span>
<a href="#l38.62"></a><span id="l38.62">                 } else {</span>
<a href="#l38.63"></a><span id="l38.63">                     // Not an offline item, attempt to modify using provider</span>
<a href="#l38.64"></a><span id="l38.64">                     self.mUncachedCalendar.modifyItem(newItem, oldItem, cacheListener);</span>
<a href="#l38.65"></a><span id="l38.65">                 }</span>
<a href="#l38.66"></a><span id="l38.66" class="difflineat">@@ -782,17 +782,17 @@ calCachedCalendar.prototype = {</span>
<a href="#l38.67"></a><span id="l38.67"> </span>
<a href="#l38.68"></a><span id="l38.68">     deleteItem: function(item, listener) {</span>
<a href="#l38.69"></a><span id="l38.69">         let self = this;</span>
<a href="#l38.70"></a><span id="l38.70"> </span>
<a href="#l38.71"></a><span id="l38.71">         // First of all, we should find out if the item to delete is</span>
<a href="#l38.72"></a><span id="l38.72">         // already an offline item or not.</span>
<a href="#l38.73"></a><span id="l38.73">         let flagListener = {</span>
<a href="#l38.74"></a><span id="l38.74">             onGetResult: function() {},</span>
<a href="#l38.75"></a><span id="l38.75" class="difflineminus">-            onOperationComplete: function(c, s, o, i, offline_flag) {</span>
<a href="#l38.76"></a><span id="l38.76" class="difflineplus">+            onOperationComplete: function(calendar, status, opType, id, offline_flag) {</span>
<a href="#l38.77"></a><span id="l38.77">                 if (offline_flag == cICL.OFFLINE_FLAG_CREATED_RECORD ||</span>
<a href="#l38.78"></a><span id="l38.78">                     offline_flag == cICL.OFFLINE_FLAG_MODIFIED_RECORD) {</span>
<a href="#l38.79"></a><span id="l38.79">                     // The item is already offline, just mark it deleted it in</span>
<a href="#l38.80"></a><span id="l38.80">                     // the cache</span>
<a href="#l38.81"></a><span id="l38.81">                     self.deleteOfflineItem(item, listener);</span>
<a href="#l38.82"></a><span id="l38.82">                 } else {</span>
<a href="#l38.83"></a><span id="l38.83">                     // Not an offline item, attempt to delete using provider</span>
<a href="#l38.84"></a><span id="l38.84">                     self.mUncachedCalendar.deleteItem(item, cacheListener);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l39.1"></a><span id="l39.1" class="difflineminus">--- a/calendar/base/src/calCalendarManager.js</span>
<a href="#l39.2"></a><span id="l39.2" class="difflineplus">+++ b/calendar/base/src/calCalendarManager.js</span>
<a href="#l39.3"></a><span id="l39.3" class="difflineat">@@ -147,25 +147,25 @@ calCalendarManager.prototype = {</span>
<a href="#l39.4"></a><span id="l39.4">                 // Unfortunately, the ability to do this with a general pref has</span>
<a href="#l39.5"></a><span id="l39.5">                 // been removed. Calendar servers might still want to know what</span>
<a href="#l39.6"></a><span id="l39.6">                 // client is used for access, so add our UA String to each</span>
<a href="#l39.7"></a><span id="l39.7">                 // request.</span>
<a href="#l39.8"></a><span id="l39.8">                 let httpChannel = aSubject.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l39.9"></a><span id="l39.9">                 try {</span>
<a href="#l39.10"></a><span id="l39.10">                     // NOTE: For some reason, this observer call doesn't have</span>
<a href="#l39.11"></a><span id="l39.11">                     // the &quot;cal&quot; namespace defined</span>
<a href="#l39.12"></a><span id="l39.12" class="difflineminus">-                    let ua = httpChannel.getRequestHeader(&quot;User-Agent&quot;);</span>
<a href="#l39.13"></a><span id="l39.13" class="difflineplus">+                    let userAgent = httpChannel.getRequestHeader(&quot;User-Agent&quot;);</span>
<a href="#l39.14"></a><span id="l39.14">                     let calUAString = Preferences.get(&quot;calendar.useragent.extra&quot;, &quot;&quot;).trim();</span>
<a href="#l39.15"></a><span id="l39.15"> </span>
<a href="#l39.16"></a><span id="l39.16">                     // Don't add an empty string or an already included token.</span>
<a href="#l39.17"></a><span id="l39.17" class="difflineminus">-                    if (calUAString &amp;&amp; !ua.includes(calUAString)) {</span>
<a href="#l39.18"></a><span id="l39.18" class="difflineplus">+                    if (calUAString &amp;&amp; !userAgent.includes(calUAString)) {</span>
<a href="#l39.19"></a><span id="l39.19">                         // User-Agent is not a mergeable header. We need to</span>
<a href="#l39.20"></a><span id="l39.20">                         // merge the user agent ourselves.</span>
<a href="#l39.21"></a><span id="l39.21">                         httpChannel.setRequestHeader(&quot;User-Agent&quot;,</span>
<a href="#l39.22"></a><span id="l39.22" class="difflineminus">-                                                     ua + &quot; &quot; + calUAString,</span>
<a href="#l39.23"></a><span id="l39.23" class="difflineplus">+                                                     userAgent + &quot; &quot; + calUAString,</span>
<a href="#l39.24"></a><span id="l39.24">                                                      false);</span>
<a href="#l39.25"></a><span id="l39.25">                     }</span>
<a href="#l39.26"></a><span id="l39.26">                 } catch (e) {</span>
<a href="#l39.27"></a><span id="l39.27">                     if (e.result != Components.results.NS_ERROR_NOT_AVAILABLE) {</span>
<a href="#l39.28"></a><span id="l39.28">                         throw e;</span>
<a href="#l39.29"></a><span id="l39.29">                     }</span>
<a href="#l39.30"></a><span id="l39.30">                     // We swallow this error since it means the User Agent</span>
<a href="#l39.31"></a><span id="l39.31">                     // header is not set. We don't want to force it to be set.</span>
<a href="#l39.32"></a><span id="l39.32" class="difflineat">@@ -299,18 +299,17 @@ calCalendarManager.prototype = {</span>
<a href="#l39.33"></a><span id="l39.33">                             break;</span>
<a href="#l39.34"></a><span id="l39.34">                     }</span>
<a href="#l39.35"></a><span id="l39.35">                 }</span>
<a href="#l39.36"></a><span id="l39.36">                 selectPrefs.reset();</span>
<a href="#l39.37"></a><span id="l39.37">             }</span>
<a href="#l39.38"></a><span id="l39.38"> </span>
<a href="#l39.39"></a><span id="l39.39">             let sortOrderAr = [];</span>
<a href="#l39.40"></a><span id="l39.40">             for (let id in sortOrder) {</span>
<a href="#l39.41"></a><span id="l39.41" class="difflineminus">-                let s = sortOrder[id];</span>
<a href="#l39.42"></a><span id="l39.42" class="difflineminus">-                sortOrderAr.push(s);</span>
<a href="#l39.43"></a><span id="l39.43" class="difflineplus">+                sortOrderAr.push(sortOrder[id]);</span>
<a href="#l39.44"></a><span id="l39.44">             }</span>
<a href="#l39.45"></a><span id="l39.45">             Preferences.set(&quot;calendar.list.sortOrder&quot;, sortOrderAr.join(&quot; &quot;));</span>
<a href="#l39.46"></a><span id="l39.46">             flushPrefs();</span>
<a href="#l39.47"></a><span id="l39.47">         } finally {</span>
<a href="#l39.48"></a><span id="l39.48">             selectPrefs.reset();</span>
<a href="#l39.49"></a><span id="l39.49">             selectCalendars.reset();</span>
<a href="#l39.50"></a><span id="l39.50">         }</span>
<a href="#l39.51"></a><span id="l39.51">     },</span>
<a href="#l39.52"></a><span id="l39.52" class="difflineat">@@ -1100,22 +1099,22 @@ var gCalendarManagerAddonListener = {</span>
<a href="#l39.53"></a><span id="l39.53"> };</span>
<a href="#l39.54"></a><span id="l39.54"> </span>
<a href="#l39.55"></a><span id="l39.55"> function appendToRealm(authHeader, appendStr) {</span>
<a href="#l39.56"></a><span id="l39.56">     let isEscaped = false;</span>
<a href="#l39.57"></a><span id="l39.57">     let idx = authHeader.search(/realm=&quot;(.*?)(\\*)&quot;/);</span>
<a href="#l39.58"></a><span id="l39.58">     if (idx &gt; -1) {</span>
<a href="#l39.59"></a><span id="l39.59">         let remain = authHeader.substr(idx + 7); idx += 7;</span>
<a href="#l39.60"></a><span id="l39.60">         while (remain.length &amp;&amp; !isEscaped) {</span>
<a href="#l39.61"></a><span id="l39.61" class="difflineminus">-            let m = remain.match(/(.*?)(\\*)&quot;/);</span>
<a href="#l39.62"></a><span id="l39.62" class="difflineminus">-            idx += m[0].length;</span>
<a href="#l39.63"></a><span id="l39.63" class="difflineplus">+            let match = remain.match(/(.*?)(\\*)&quot;/);</span>
<a href="#l39.64"></a><span id="l39.64" class="difflineplus">+            idx += match[0].length;</span>
<a href="#l39.65"></a><span id="l39.65"> </span>
<a href="#l39.66"></a><span id="l39.66" class="difflineminus">-            isEscaped = ((m[2].length % 2) == 0);</span>
<a href="#l39.67"></a><span id="l39.67" class="difflineplus">+            isEscaped = ((match[2].length % 2) == 0);</span>
<a href="#l39.68"></a><span id="l39.68">             if (!isEscaped) {</span>
<a href="#l39.69"></a><span id="l39.69" class="difflineminus">-                remain = remain.substr(m[0].length);</span>
<a href="#l39.70"></a><span id="l39.70" class="difflineplus">+                remain = remain.substr(match[0].length);</span>
<a href="#l39.71"></a><span id="l39.71">             }</span>
<a href="#l39.72"></a><span id="l39.72">         }</span>
<a href="#l39.73"></a><span id="l39.73">         return authHeader.substr(0, idx - 1) + &quot; &quot; +</span>
<a href="#l39.74"></a><span id="l39.74">                 appendStr + authHeader.substr(idx - 1);</span>
<a href="#l39.75"></a><span id="l39.75">     } else {</span>
<a href="#l39.76"></a><span id="l39.76">         return authHeader;</span>
<a href="#l39.77"></a><span id="l39.77">     }</span>
<a href="#l39.78"></a><span id="l39.78"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l40.1"></a><span id="l40.1" class="difflineminus">--- a/calendar/base/src/calDeletedItems.js</span>
<a href="#l40.2"></a><span id="l40.2" class="difflineplus">+++ b/calendar/base/src/calDeletedItems.js</span>
<a href="#l40.3"></a><span id="l40.3" class="difflineat">@@ -63,19 +63,19 @@ calDeletedItems.prototype = {</span>
<a href="#l40.4"></a><span id="l40.4">             stmt.params.calId = aCalId;</span>
<a href="#l40.5"></a><span id="l40.5">         } else {</span>
<a href="#l40.6"></a><span id="l40.6">             stmt = this.stmtGet;</span>
<a href="#l40.7"></a><span id="l40.7">         }</span>
<a href="#l40.8"></a><span id="l40.8"> </span>
<a href="#l40.9"></a><span id="l40.9">         stmt.params.id = aId;</span>
<a href="#l40.10"></a><span id="l40.10">         try {</span>
<a href="#l40.11"></a><span id="l40.11">             if (stmt.executeStep()) {</span>
<a href="#l40.12"></a><span id="l40.12" class="difflineminus">-                let dt = cal.createDateTime();</span>
<a href="#l40.13"></a><span id="l40.13" class="difflineminus">-                dt.nativeTime = stmt.row.time_deleted;</span>
<a href="#l40.14"></a><span id="l40.14" class="difflineminus">-                return dt.getInTimezone(cal.calendarDefaultTimezone());</span>
<a href="#l40.15"></a><span id="l40.15" class="difflineplus">+                let date = cal.createDateTime();</span>
<a href="#l40.16"></a><span id="l40.16" class="difflineplus">+                date.nativeTime = stmt.row.time_deleted;</span>
<a href="#l40.17"></a><span id="l40.17" class="difflineplus">+                return date.getInTimezone(cal.calendarDefaultTimezone());</span>
<a href="#l40.18"></a><span id="l40.18">             }</span>
<a href="#l40.19"></a><span id="l40.19">         } catch (e) {</span>
<a href="#l40.20"></a><span id="l40.20">             cal.ERROR(e);</span>
<a href="#l40.21"></a><span id="l40.21">         } finally {</span>
<a href="#l40.22"></a><span id="l40.22">             stmt.reset();</span>
<a href="#l40.23"></a><span id="l40.23">         }</span>
<a href="#l40.24"></a><span id="l40.24">         return null;</span>
<a href="#l40.25"></a><span id="l40.25">     },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l41.1"></a><span id="l41.1" class="difflineminus">--- a/calendar/base/src/calEvent.js</span>
<a href="#l41.2"></a><span id="l41.2" class="difflineplus">+++ b/calendar/base/src/calEvent.js</span>
<a href="#l41.3"></a><span id="l41.3" class="difflineat">@@ -31,37 +31,37 @@ calEvent.prototype = {</span>
<a href="#l41.4"></a><span id="l41.4">     classInfo: XPCOMUtils.generateCI({</span>
<a href="#l41.5"></a><span id="l41.5">         classID: calEventClassID,</span>
<a href="#l41.6"></a><span id="l41.6">         contractID: &quot;@mozilla.org/calendar/event;1&quot;,</span>
<a href="#l41.7"></a><span id="l41.7">         classDescription: &quot;Calendar Event&quot;,</span>
<a href="#l41.8"></a><span id="l41.8">         interfaces: calEventInterfaces</span>
<a href="#l41.9"></a><span id="l41.9">     }),</span>
<a href="#l41.10"></a><span id="l41.10"> </span>
<a href="#l41.11"></a><span id="l41.11">     cloneShallow: function(aNewParent) {</span>
<a href="#l41.12"></a><span id="l41.12" class="difflineminus">-        let m = new calEvent();</span>
<a href="#l41.13"></a><span id="l41.13" class="difflineminus">-        this.cloneItemBaseInto(m, aNewParent);</span>
<a href="#l41.14"></a><span id="l41.14" class="difflineminus">-        return m;</span>
<a href="#l41.15"></a><span id="l41.15" class="difflineplus">+        let cloned = new calEvent();</span>
<a href="#l41.16"></a><span id="l41.16" class="difflineplus">+        this.cloneItemBaseInto(cloned, aNewParent);</span>
<a href="#l41.17"></a><span id="l41.17" class="difflineplus">+        return cloned;</span>
<a href="#l41.18"></a><span id="l41.18">     },</span>
<a href="#l41.19"></a><span id="l41.19"> </span>
<a href="#l41.20"></a><span id="l41.20">     createProxy: function(aRecurrenceId) {</span>
<a href="#l41.21"></a><span id="l41.21">         cal.ASSERT(!this.mIsProxy, &quot;Tried to create a proxy for an existing proxy!&quot;, true);</span>
<a href="#l41.22"></a><span id="l41.22"> </span>
<a href="#l41.23"></a><span id="l41.23" class="difflineminus">-        let m = new calEvent();</span>
<a href="#l41.24"></a><span id="l41.24" class="difflineplus">+        let proxy = new calEvent();</span>
<a href="#l41.25"></a><span id="l41.25"> </span>
<a href="#l41.26"></a><span id="l41.26">         // override proxy's DTSTART/DTEND/RECURRENCE-ID</span>
<a href="#l41.27"></a><span id="l41.27">         // before master is set (and item might get immutable):</span>
<a href="#l41.28"></a><span id="l41.28">         let endDate = aRecurrenceId.clone();</span>
<a href="#l41.29"></a><span id="l41.29">         endDate.addDuration(this.duration);</span>
<a href="#l41.30"></a><span id="l41.30" class="difflineminus">-        m.endDate = endDate;</span>
<a href="#l41.31"></a><span id="l41.31" class="difflineminus">-        m.startDate = aRecurrenceId;</span>
<a href="#l41.32"></a><span id="l41.32" class="difflineplus">+        proxy.endDate = endDate;</span>
<a href="#l41.33"></a><span id="l41.33" class="difflineplus">+        proxy.startDate = aRecurrenceId;</span>
<a href="#l41.34"></a><span id="l41.34"> </span>
<a href="#l41.35"></a><span id="l41.35" class="difflineminus">-        m.initializeProxy(this, aRecurrenceId);</span>
<a href="#l41.36"></a><span id="l41.36" class="difflineminus">-        m.mDirty = false;</span>
<a href="#l41.37"></a><span id="l41.37" class="difflineplus">+        proxy.initializeProxy(this, aRecurrenceId);</span>
<a href="#l41.38"></a><span id="l41.38" class="difflineplus">+        proxy.mDirty = false;</span>
<a href="#l41.39"></a><span id="l41.39"> </span>
<a href="#l41.40"></a><span id="l41.40" class="difflineminus">-        return m;</span>
<a href="#l41.41"></a><span id="l41.41" class="difflineplus">+        return proxy;</span>
<a href="#l41.42"></a><span id="l41.42">     },</span>
<a href="#l41.43"></a><span id="l41.43"> </span>
<a href="#l41.44"></a><span id="l41.44">     makeImmutable: function() {</span>
<a href="#l41.45"></a><span id="l41.45">         this.makeItemBaseImmutable();</span>
<a href="#l41.46"></a><span id="l41.46">     },</span>
<a href="#l41.47"></a><span id="l41.47"> </span>
<a href="#l41.48"></a><span id="l41.48">     get duration() {</span>
<a href="#l41.49"></a><span id="l41.49">         if (this.endDate &amp;&amp; this.startDate) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l42.1"></a><span id="l42.1" class="difflineminus">--- a/calendar/base/src/calFilter.js</span>
<a href="#l42.2"></a><span id="l42.2" class="difflineplus">+++ b/calendar/base/src/calFilter.js</span>
<a href="#l42.3"></a><span id="l42.3" class="difflineat">@@ -129,23 +129,23 @@ calFilterProperties.prototype = {</span>
<a href="#l42.4"></a><span id="l42.4">         }</span>
<a href="#l42.5"></a><span id="l42.5">         let props = [&quot;start&quot;, &quot;end&quot;, &quot;due&quot;, &quot;status&quot;, &quot;category&quot;, &quot;occurrences&quot;, &quot;onfilter&quot;];</span>
<a href="#l42.6"></a><span id="l42.6">         return props.every(function(prop) {</span>
<a href="#l42.7"></a><span id="l42.7">             return (this[prop] == aFilterProps[prop]);</span>
<a href="#l42.8"></a><span id="l42.8">         }, this);</span>
<a href="#l42.9"></a><span id="l42.9">     },</span>
<a href="#l42.10"></a><span id="l42.10"> </span>
<a href="#l42.11"></a><span id="l42.11">     clone: function() {</span>
<a href="#l42.12"></a><span id="l42.12" class="difflineminus">-        let cl = new calFilterProperties();</span>
<a href="#l42.13"></a><span id="l42.13" class="difflineplus">+        let cloned = new calFilterProperties();</span>
<a href="#l42.14"></a><span id="l42.14">         let props = [&quot;start&quot;, &quot;end&quot;, &quot;due&quot;, &quot;status&quot;, &quot;category&quot;, &quot;occurrences&quot;, &quot;onfilter&quot;];</span>
<a href="#l42.15"></a><span id="l42.15">         props.forEach(function(prop) {</span>
<a href="#l42.16"></a><span id="l42.16" class="difflineminus">-            cl[prop] = this[prop];</span>
<a href="#l42.17"></a><span id="l42.17" class="difflineplus">+            cloned[prop] = this[prop];</span>
<a href="#l42.18"></a><span id="l42.18">         }, this);</span>
<a href="#l42.19"></a><span id="l42.19"> </span>
<a href="#l42.20"></a><span id="l42.20" class="difflineminus">-        return cl;</span>
<a href="#l42.21"></a><span id="l42.21" class="difflineplus">+        return cloned;</span>
<a href="#l42.22"></a><span id="l42.22">     },</span>
<a href="#l42.23"></a><span id="l42.23"> </span>
<a href="#l42.24"></a><span id="l42.24">     LOG: function(aString) {</span>
<a href="#l42.25"></a><span id="l42.25">         cal.LOG(&quot;[calFilterProperties] &quot; +</span>
<a href="#l42.26"></a><span id="l42.26">                 (aString || &quot;&quot;) +</span>
<a href="#l42.27"></a><span id="l42.27">                 &quot; start=&quot; + this.start +</span>
<a href="#l42.28"></a><span id="l42.28">                 &quot; end=&quot; + this.end +</span>
<a href="#l42.29"></a><span id="l42.29">                 &quot; status=&quot; + this.status +</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l43.1"></a><span id="l43.1" class="difflineminus">--- a/calendar/base/src/calIcsParser.js</span>
<a href="#l43.2"></a><span id="l43.2" class="difflineplus">+++ b/calendar/base/src/calIcsParser.js</span>
<a href="#l43.3"></a><span id="l43.3" class="difflineat">@@ -224,19 +224,19 @@ parserState.prototype = {</span>
<a href="#l43.4"></a><span id="l43.4">     listener: null,</span>
<a href="#l43.5"></a><span id="l43.5"> </span>
<a href="#l43.6"></a><span id="l43.6">     /**</span>
<a href="#l43.7"></a><span id="l43.7">      * Checks if the timezones are missing and notifies the user via error console</span>
<a href="#l43.8"></a><span id="l43.8">      *</span>
<a href="#l43.9"></a><span id="l43.9">      * @param item      The item to check for</span>
<a href="#l43.10"></a><span id="l43.10">      * @param dt        The datetime object to check with</span>
<a href="#l43.11"></a><span id="l43.11">      */</span>
<a href="#l43.12"></a><span id="l43.12" class="difflineminus">-    checkTimezone: function(item, dt) {</span>
<a href="#l43.13"></a><span id="l43.13" class="difflineminus">-        if (dt &amp;&amp; cal.isPhantomTimezone(dt.timezone)) {</span>
<a href="#l43.14"></a><span id="l43.14" class="difflineminus">-            let tzid = dt.timezone.tzid;</span>
<a href="#l43.15"></a><span id="l43.15" class="difflineplus">+    checkTimezone: function(item, date) {</span>
<a href="#l43.16"></a><span id="l43.16" class="difflineplus">+        if (date &amp;&amp; cal.isPhantomTimezone(date.timezone)) {</span>
<a href="#l43.17"></a><span id="l43.17" class="difflineplus">+            let tzid = date.timezone.tzid;</span>
<a href="#l43.18"></a><span id="l43.18">             let hid = item.hashId + &quot;#&quot; + tzid;</span>
<a href="#l43.19"></a><span id="l43.19">             if (!(hid in this.tzErrors)) {</span>
<a href="#l43.20"></a><span id="l43.20">                 // For now, publish errors to console and alert user.</span>
<a href="#l43.21"></a><span id="l43.21">                 // In future, maybe make them available through an interface method</span>
<a href="#l43.22"></a><span id="l43.22">                 // so this UI code can be removed from the parser, and caller can</span>
<a href="#l43.23"></a><span id="l43.23">                 // choose whether to alert, or show user the problem items and ask</span>
<a href="#l43.24"></a><span id="l43.24">                 // for fixes, or something else.</span>
<a href="#l43.25"></a><span id="l43.25">                 let msgArgs = [tzid, item.title, cal.getDateFormatter().formatDateTime(dt)];</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l44.1"></a><span id="l44.1" class="difflineminus">--- a/calendar/base/src/calItemBase.js</span>
<a href="#l44.2"></a><span id="l44.2" class="difflineplus">+++ b/calendar/base/src/calItemBase.js</span>
<a href="#l44.3"></a><span id="l44.3" class="difflineat">@@ -242,85 +242,85 @@ calItemBase.prototype = {</span>
<a href="#l44.4"></a><span id="l44.4"> </span>
<a href="#l44.5"></a><span id="l44.5">     /**</span>
<a href="#l44.6"></a><span id="l44.6">      * Clones the base item's properties into the passed object, potentially</span>
<a href="#l44.7"></a><span id="l44.7">      * setting a new parent item.</span>
<a href="#l44.8"></a><span id="l44.8">      *</span>
<a href="#l44.9"></a><span id="l44.9">      * @param m     The item to clone this item into</span>
<a href="#l44.10"></a><span id="l44.10">      * @param aNewParent    (optional) The new parent item to set on m.</span>
<a href="#l44.11"></a><span id="l44.11">      */</span>
<a href="#l44.12"></a><span id="l44.12" class="difflineminus">-    cloneItemBaseInto: function(m, aNewParent) {</span>
<a href="#l44.13"></a><span id="l44.13" class="difflineminus">-        m.mImmutable = false;</span>
<a href="#l44.14"></a><span id="l44.14" class="difflineminus">-        m.mACLEntry = this.mACLEntry;</span>
<a href="#l44.15"></a><span id="l44.15" class="difflineminus">-        m.mIsProxy = this.mIsProxy;</span>
<a href="#l44.16"></a><span id="l44.16" class="difflineminus">-        m.mParentItem = calTryWrappedJSObject(aNewParent) || this.mParentItem;</span>
<a href="#l44.17"></a><span id="l44.17" class="difflineminus">-        m.mHashId = this.mHashId;</span>
<a href="#l44.18"></a><span id="l44.18" class="difflineminus">-        m.mCalendar = this.mCalendar;</span>
<a href="#l44.19"></a><span id="l44.19" class="difflineplus">+    cloneItemBaseInto: function(cloned, aNewParent) {</span>
<a href="#l44.20"></a><span id="l44.20" class="difflineplus">+        cloned.mImmutable = false;</span>
<a href="#l44.21"></a><span id="l44.21" class="difflineplus">+        cloned.mACLEntry = this.mACLEntry;</span>
<a href="#l44.22"></a><span id="l44.22" class="difflineplus">+        cloned.mIsProxy = this.mIsProxy;</span>
<a href="#l44.23"></a><span id="l44.23" class="difflineplus">+        cloned.mParentItem = calTryWrappedJSObject(aNewParent) || this.mParentItem;</span>
<a href="#l44.24"></a><span id="l44.24" class="difflineplus">+        cloned.mHashId = this.mHashId;</span>
<a href="#l44.25"></a><span id="l44.25" class="difflineplus">+        cloned.mCalendar = this.mCalendar;</span>
<a href="#l44.26"></a><span id="l44.26">         if (this.mRecurrenceInfo) {</span>
<a href="#l44.27"></a><span id="l44.27" class="difflineminus">-            m.mRecurrenceInfo = calTryWrappedJSObject(this.mRecurrenceInfo.clone());</span>
<a href="#l44.28"></a><span id="l44.28" class="difflineminus">-            m.mRecurrenceInfo.item = m;</span>
<a href="#l44.29"></a><span id="l44.29" class="difflineplus">+            cloned.mRecurrenceInfo = calTryWrappedJSObject(this.mRecurrenceInfo.clone());</span>
<a href="#l44.30"></a><span id="l44.30" class="difflineplus">+            cloned.mRecurrenceInfo.item = cloned;</span>
<a href="#l44.31"></a><span id="l44.31">         }</span>
<a href="#l44.32"></a><span id="l44.32"> </span>
<a href="#l44.33"></a><span id="l44.33">         let org = this.organizer;</span>
<a href="#l44.34"></a><span id="l44.34">         if (org) {</span>
<a href="#l44.35"></a><span id="l44.35">             org = org.clone();</span>
<a href="#l44.36"></a><span id="l44.36">         }</span>
<a href="#l44.37"></a><span id="l44.37" class="difflineminus">-        m.mOrganizer = org;</span>
<a href="#l44.38"></a><span id="l44.38" class="difflineplus">+        cloned.mOrganizer = org;</span>
<a href="#l44.39"></a><span id="l44.39"> </span>
<a href="#l44.40"></a><span id="l44.40" class="difflineminus">-        m.mAttendees = [];</span>
<a href="#l44.41"></a><span id="l44.41" class="difflineplus">+        cloned.mAttendees = [];</span>
<a href="#l44.42"></a><span id="l44.42">         for (let att of this.getAttendees({})) {</span>
<a href="#l44.43"></a><span id="l44.43" class="difflineminus">-            m.mAttendees.push(att.clone());</span>
<a href="#l44.44"></a><span id="l44.44" class="difflineplus">+            cloned.mAttendees.push(att.clone());</span>
<a href="#l44.45"></a><span id="l44.45">         }</span>
<a href="#l44.46"></a><span id="l44.46"> </span>
<a href="#l44.47"></a><span id="l44.47" class="difflineminus">-        m.mProperties = new calPropertyBag();</span>
<a href="#l44.48"></a><span id="l44.48" class="difflineplus">+        cloned.mProperties = new calPropertyBag();</span>
<a href="#l44.49"></a><span id="l44.49">         for (let [name, value] of this.mProperties) {</span>
<a href="#l44.50"></a><span id="l44.50">             if (value instanceof Components.interfaces.calIDateTime) {</span>
<a href="#l44.51"></a><span id="l44.51">                 value = value.clone();</span>
<a href="#l44.52"></a><span id="l44.52">             }</span>
<a href="#l44.53"></a><span id="l44.53"> </span>
<a href="#l44.54"></a><span id="l44.54" class="difflineminus">-            m.mProperties.setProperty(name, value);</span>
<a href="#l44.55"></a><span id="l44.55" class="difflineplus">+            cloned.mProperties.setProperty(name, value);</span>
<a href="#l44.56"></a><span id="l44.56"> </span>
<a href="#l44.57"></a><span id="l44.57">             let propBucket = this.mPropertyParams[name];</span>
<a href="#l44.58"></a><span id="l44.58">             if (propBucket) {</span>
<a href="#l44.59"></a><span id="l44.59">                 let newBucket = {};</span>
<a href="#l44.60"></a><span id="l44.60">                 for (let param in propBucket) {</span>
<a href="#l44.61"></a><span id="l44.61">                     newBucket[param] = propBucket[param];</span>
<a href="#l44.62"></a><span id="l44.62">                 }</span>
<a href="#l44.63"></a><span id="l44.63" class="difflineminus">-                m.mPropertyParams[name] = newBucket;</span>
<a href="#l44.64"></a><span id="l44.64" class="difflineplus">+                cloned.mPropertyParams[name] = newBucket;</span>
<a href="#l44.65"></a><span id="l44.65">             }</span>
<a href="#l44.66"></a><span id="l44.66">         }</span>
<a href="#l44.67"></a><span id="l44.67"> </span>
<a href="#l44.68"></a><span id="l44.68" class="difflineminus">-        m.mAttachments = [];</span>
<a href="#l44.69"></a><span id="l44.69" class="difflineplus">+        cloned.mAttachments = [];</span>
<a href="#l44.70"></a><span id="l44.70">         for (let att of this.getAttachments({})) {</span>
<a href="#l44.71"></a><span id="l44.71" class="difflineminus">-            m.mAttachments.push(att.clone());</span>
<a href="#l44.72"></a><span id="l44.72" class="difflineplus">+            cloned.mAttachments.push(att.clone());</span>
<a href="#l44.73"></a><span id="l44.73">         }</span>
<a href="#l44.74"></a><span id="l44.74"> </span>
<a href="#l44.75"></a><span id="l44.75" class="difflineminus">-        m.mRelations = [];</span>
<a href="#l44.76"></a><span id="l44.76" class="difflineplus">+        cloned.mRelations = [];</span>
<a href="#l44.77"></a><span id="l44.77">         for (let rel of this.getRelations({})) {</span>
<a href="#l44.78"></a><span id="l44.78" class="difflineminus">-            m.mRelations.push(rel.clone());</span>
<a href="#l44.79"></a><span id="l44.79" class="difflineplus">+            cloned.mRelations.push(rel.clone());</span>
<a href="#l44.80"></a><span id="l44.80">         }</span>
<a href="#l44.81"></a><span id="l44.81"> </span>
<a href="#l44.82"></a><span id="l44.82" class="difflineminus">-        m.mCategories = this.getCategories({});</span>
<a href="#l44.83"></a><span id="l44.83" class="difflineplus">+        cloned.mCategories = this.getCategories({});</span>
<a href="#l44.84"></a><span id="l44.84"> </span>
<a href="#l44.85"></a><span id="l44.85" class="difflineminus">-        m.mAlarms = [];</span>
<a href="#l44.86"></a><span id="l44.86" class="difflineplus">+        cloned.mAlarms = [];</span>
<a href="#l44.87"></a><span id="l44.87">         for (let alarm of this.getAlarms({})) {</span>
<a href="#l44.88"></a><span id="l44.88">             // Clone alarms into new item, assume the alarms from the old item</span>
<a href="#l44.89"></a><span id="l44.89">             // are valid and don't need validation.</span>
<a href="#l44.90"></a><span id="l44.90" class="difflineminus">-            m.mAlarms.push(alarm.clone());</span>
<a href="#l44.91"></a><span id="l44.91" class="difflineplus">+            cloned.mAlarms.push(alarm.clone());</span>
<a href="#l44.92"></a><span id="l44.92">         }</span>
<a href="#l44.93"></a><span id="l44.93"> </span>
<a href="#l44.94"></a><span id="l44.94">         let alarmLastAck = this.alarmLastAck;</span>
<a href="#l44.95"></a><span id="l44.95">         if (alarmLastAck) {</span>
<a href="#l44.96"></a><span id="l44.96">             alarmLastAck = alarmLastAck.clone();</span>
<a href="#l44.97"></a><span id="l44.97">         }</span>
<a href="#l44.98"></a><span id="l44.98" class="difflineminus">-        m.mAlarmLastAck = alarmLastAck;</span>
<a href="#l44.99"></a><span id="l44.99" class="difflineplus">+        cloned.mAlarmLastAck = alarmLastAck;</span>
<a href="#l44.100"></a><span id="l44.100"> </span>
<a href="#l44.101"></a><span id="l44.101" class="difflineminus">-        m.mDirty = this.mDirty;</span>
<a href="#l44.102"></a><span id="l44.102" class="difflineplus">+        cloned.mDirty = this.mDirty;</span>
<a href="#l44.103"></a><span id="l44.103"> </span>
<a href="#l44.104"></a><span id="l44.104" class="difflineminus">-        return m;</span>
<a href="#l44.105"></a><span id="l44.105" class="difflineplus">+        return cloned;</span>
<a href="#l44.106"></a><span id="l44.106">     },</span>
<a href="#l44.107"></a><span id="l44.107"> </span>
<a href="#l44.108"></a><span id="l44.108">     // attribute calIDateTime alarmLastAck;</span>
<a href="#l44.109"></a><span id="l44.109">     get alarmLastAck() {</span>
<a href="#l44.110"></a><span id="l44.110">         return this.mAlarmLastAck;</span>
<a href="#l44.111"></a><span id="l44.111">     },</span>
<a href="#l44.112"></a><span id="l44.112">     set alarmLastAck(aValue) {</span>
<a href="#l44.113"></a><span id="l44.113">         this.modify();</span>
<a href="#l44.114"></a><span id="l44.114" class="difflineat">@@ -570,23 +570,23 @@ calItemBase.prototype = {</span>
<a href="#l44.115"></a><span id="l44.115">                 this.removeAttendee(exists);</span>
<a href="#l44.116"></a><span id="l44.116">             } else {</span>
<a href="#l44.117"></a><span id="l44.117">                 attendee = null;</span>
<a href="#l44.118"></a><span id="l44.118">             }</span>
<a href="#l44.119"></a><span id="l44.119">         }</span>
<a href="#l44.120"></a><span id="l44.120">         if (attendee) {</span>
<a href="#l44.121"></a><span id="l44.121">             if (attendee.commonName) {</span>
<a href="#l44.122"></a><span id="l44.122">                 // migration code for bug 1209399 to remove leading/training double quotes in</span>
<a href="#l44.123"></a><span id="l44.123" class="difflineminus">-                let cn = attendee.commonName.replace(/^[&quot;]*([^&quot;]*)[&quot;]*$/, &quot;$1&quot;);</span>
<a href="#l44.124"></a><span id="l44.124" class="difflineminus">-                if (cn.length == 0) {</span>
<a href="#l44.125"></a><span id="l44.125" class="difflineminus">-                    cn = null;</span>
<a href="#l44.126"></a><span id="l44.126" class="difflineplus">+                let commonName = attendee.commonName.replace(/^[&quot;]*([^&quot;]*)[&quot;]*$/, &quot;$1&quot;);</span>
<a href="#l44.127"></a><span id="l44.127" class="difflineplus">+                if (commonName.length == 0) {</span>
<a href="#l44.128"></a><span id="l44.128" class="difflineplus">+                    commonName = null;</span>
<a href="#l44.129"></a><span id="l44.129">                 }</span>
<a href="#l44.130"></a><span id="l44.130" class="difflineminus">-                if (cn != attendee.commonName) {</span>
<a href="#l44.131"></a><span id="l44.131" class="difflineplus">+                if (commonName != attendee.commonName) {</span>
<a href="#l44.132"></a><span id="l44.132">                     if (attendee.isMutable) {</span>
<a href="#l44.133"></a><span id="l44.133" class="difflineminus">-                        attendee.commonName = cn;</span>
<a href="#l44.134"></a><span id="l44.134" class="difflineplus">+                        attendee.commonName = commonName;</span>
<a href="#l44.135"></a><span id="l44.135">                     } else {</span>
<a href="#l44.136"></a><span id="l44.136">                         cal.LOG(&quot;Failed to cleanup malformed commonName for immutable attendee &quot; +</span>
<a href="#l44.137"></a><span id="l44.137">                                 attendee.toString() + &quot;\n&quot; + cal.STACK(20));</span>
<a href="#l44.138"></a><span id="l44.138">                     }</span>
<a href="#l44.139"></a><span id="l44.139">                 }</span>
<a href="#l44.140"></a><span id="l44.140">             }</span>
<a href="#l44.141"></a><span id="l44.141">             this.modify();</span>
<a href="#l44.142"></a><span id="l44.142">             this.mAttendees = this.getAttendees({});</span>
<a href="#l44.143"></a><span id="l44.143" class="difflineat">@@ -682,35 +682,35 @@ calItemBase.prototype = {</span>
<a href="#l44.144"></a><span id="l44.144">     // attribute calICalendar calendar;</span>
<a href="#l44.145"></a><span id="l44.145">     get calendar() {</span>
<a href="#l44.146"></a><span id="l44.146">         if (!this.mCalendar &amp;&amp; (this.parentItem != this)) {</span>
<a href="#l44.147"></a><span id="l44.147">             return this.parentItem.calendar;</span>
<a href="#l44.148"></a><span id="l44.148">         } else {</span>
<a href="#l44.149"></a><span id="l44.149">             return this.mCalendar;</span>
<a href="#l44.150"></a><span id="l44.150">         }</span>
<a href="#l44.151"></a><span id="l44.151">     },</span>
<a href="#l44.152"></a><span id="l44.152" class="difflineminus">-    set calendar(v) {</span>
<a href="#l44.153"></a><span id="l44.153" class="difflineplus">+    set calendar(calendar) {</span>
<a href="#l44.154"></a><span id="l44.154">         if (this.mImmutable) {</span>
<a href="#l44.155"></a><span id="l44.155">             throw Components.results.NS_ERROR_OBJECT_IS_IMMUTABLE;</span>
<a href="#l44.156"></a><span id="l44.156">         }</span>
<a href="#l44.157"></a><span id="l44.157">         this.mHashId = null; // recompute hashId</span>
<a href="#l44.158"></a><span id="l44.158" class="difflineminus">-        this.mCalendar = v;</span>
<a href="#l44.159"></a><span id="l44.159" class="difflineplus">+        this.mCalendar = calendar;</span>
<a href="#l44.160"></a><span id="l44.160">     },</span>
<a href="#l44.161"></a><span id="l44.161"> </span>
<a href="#l44.162"></a><span id="l44.162">     // attribute calIAttendee organizer;</span>
<a href="#l44.163"></a><span id="l44.163">     get organizer() {</span>
<a href="#l44.164"></a><span id="l44.164">         if (this.mIsProxy &amp;&amp; (this.mOrganizer === undefined)) {</span>
<a href="#l44.165"></a><span id="l44.165">             return this.mParentItem.organizer;</span>
<a href="#l44.166"></a><span id="l44.166">         } else {</span>
<a href="#l44.167"></a><span id="l44.167">             return this.mOrganizer;</span>
<a href="#l44.168"></a><span id="l44.168">         }</span>
<a href="#l44.169"></a><span id="l44.169">     },</span>
<a href="#l44.170"></a><span id="l44.170" class="difflineminus">-    set organizer(v) {</span>
<a href="#l44.171"></a><span id="l44.171" class="difflineplus">+    set organizer(organizer) {</span>
<a href="#l44.172"></a><span id="l44.172">         this.modify();</span>
<a href="#l44.173"></a><span id="l44.173" class="difflineminus">-        this.mOrganizer = v;</span>
<a href="#l44.174"></a><span id="l44.174" class="difflineplus">+        this.mOrganizer = organizer;</span>
<a href="#l44.175"></a><span id="l44.175">     },</span>
<a href="#l44.176"></a><span id="l44.176"> </span>
<a href="#l44.177"></a><span id="l44.177">     // void getCategories(out PRUint32 aCount,</span>
<a href="#l44.178"></a><span id="l44.178">     //                    [array, size_is(aCount), retval] out wstring aCategories);</span>
<a href="#l44.179"></a><span id="l44.179">     getCategories: function(aCount) {</span>
<a href="#l44.180"></a><span id="l44.180">         if (!this.mCategories &amp;&amp; this.mIsProxy) {</span>
<a href="#l44.181"></a><span id="l44.181">             this.mCategories = this.mParentItem.getCategories(aCount);</span>
<a href="#l44.182"></a><span id="l44.182">         }</span>
<a href="#l44.183"></a><span id="l44.183" class="difflineat">@@ -1117,19 +1117,19 @@ function makeMemberAttr(ctor, varname, d</span>
<a href="#l44.184"></a><span id="l44.184">     // XXX handle defaults!</span>
<a href="#l44.185"></a><span id="l44.185">     let getter = function() {</span>
<a href="#l44.186"></a><span id="l44.186">         if (asProperty) {</span>
<a href="#l44.187"></a><span id="l44.187">             return this.getProperty(varname);</span>
<a href="#l44.188"></a><span id="l44.188">         } else {</span>
<a href="#l44.189"></a><span id="l44.189">             return (varname in this ? this[varname] : undefined);</span>
<a href="#l44.190"></a><span id="l44.190">         }</span>
<a href="#l44.191"></a><span id="l44.191">     };</span>
<a href="#l44.192"></a><span id="l44.192" class="difflineminus">-    let setter = function(v) {</span>
<a href="#l44.193"></a><span id="l44.193" class="difflineplus">+    let setter = function(value) {</span>
<a href="#l44.194"></a><span id="l44.194">         this.modify();</span>
<a href="#l44.195"></a><span id="l44.195">         if (asProperty) {</span>
<a href="#l44.196"></a><span id="l44.196" class="difflineminus">-            return this.setProperty(varname, v);</span>
<a href="#l44.197"></a><span id="l44.197" class="difflineplus">+            return this.setProperty(varname, value);</span>
<a href="#l44.198"></a><span id="l44.198">         } else {</span>
<a href="#l44.199"></a><span id="l44.199" class="difflineminus">-            return (this[varname] = v);</span>
<a href="#l44.200"></a><span id="l44.200" class="difflineplus">+            return (this[varname] = value);</span>
<a href="#l44.201"></a><span id="l44.201">         }</span>
<a href="#l44.202"></a><span id="l44.202">     };</span>
<a href="#l44.203"></a><span id="l44.203">     ctor.prototype.__defineGetter__(attr, getter);</span>
<a href="#l44.204"></a><span id="l44.204">     ctor.prototype.__defineSetter__(attr, setter);</span>
<a href="#l44.205"></a><span id="l44.205"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l45.1"></a><span id="l45.1" class="difflineminus">--- a/calendar/base/src/calRecurrenceInfo.js</span>
<a href="#l45.2"></a><span id="l45.2" class="difflineplus">+++ b/calendar/base/src/calRecurrenceInfo.js</span>
<a href="#l45.3"></a><span id="l45.3" class="difflineat">@@ -1,24 +1,24 @@</span>
<a href="#l45.4"></a><span id="l45.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l45.5"></a><span id="l45.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l45.6"></a><span id="l45.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l45.7"></a><span id="l45.7"> </span>
<a href="#l45.8"></a><span id="l45.8"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l45.9"></a><span id="l45.9"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l45.10"></a><span id="l45.10"> </span>
<a href="#l45.11"></a><span id="l45.11" class="difflineminus">-function getRidKey(dt) {</span>
<a href="#l45.12"></a><span id="l45.12" class="difflineminus">-    if (!dt) {</span>
<a href="#l45.13"></a><span id="l45.13" class="difflineplus">+function getRidKey(date) {</span>
<a href="#l45.14"></a><span id="l45.14" class="difflineplus">+    if (!date) {</span>
<a href="#l45.15"></a><span id="l45.15">         return null;</span>
<a href="#l45.16"></a><span id="l45.16">     }</span>
<a href="#l45.17"></a><span id="l45.17" class="difflineminus">-    let tz = dt.timezone;</span>
<a href="#l45.18"></a><span id="l45.18" class="difflineminus">-    if (!tz.isUTC &amp;&amp; !tz.isFloating) {</span>
<a href="#l45.19"></a><span id="l45.19" class="difflineminus">-        dt = dt.getInTimezone(UTC());</span>
<a href="#l45.20"></a><span id="l45.20" class="difflineplus">+    let timezone = date.timezone;</span>
<a href="#l45.21"></a><span id="l45.21" class="difflineplus">+    if (!timezone.isUTC &amp;&amp; !timezone.isFloating) {</span>
<a href="#l45.22"></a><span id="l45.22" class="difflineplus">+        date = date.getInTimezone(UTC());</span>
<a href="#l45.23"></a><span id="l45.23">     }</span>
<a href="#l45.24"></a><span id="l45.24" class="difflineminus">-    return dt.icalString;</span>
<a href="#l45.25"></a><span id="l45.25" class="difflineplus">+    return date.icalString;</span>
<a href="#l45.26"></a><span id="l45.26"> }</span>
<a href="#l45.27"></a><span id="l45.27"> </span>
<a href="#l45.28"></a><span id="l45.28"> function calRecurrenceInfo() {</span>
<a href="#l45.29"></a><span id="l45.29">     this.mRecurrenceItems = [];</span>
<a href="#l45.30"></a><span id="l45.30">     this.mExceptionMap = {};</span>
<a href="#l45.31"></a><span id="l45.31"> </span>
<a href="#l45.32"></a><span id="l45.32">     this.wrappedJSObject = this;</span>
<a href="#l45.33"></a><span id="l45.33"> }</span>
<a href="#l45.34"></a><span id="l45.34" class="difflineat">@@ -277,18 +277,18 @@ calRecurrenceInfo.prototype = {</span>
<a href="#l45.35"></a><span id="l45.35">                 // occurrs before the event started and its illegal to EXDATE an</span>
<a href="#l45.36"></a><span id="l45.36">                 // RDATE.</span>
<a href="#l45.37"></a><span id="l45.37">                 let rdates = ritem.getOccurrences(startDate,</span>
<a href="#l45.38"></a><span id="l45.38">                                                   startDate,</span>
<a href="#l45.39"></a><span id="l45.39">                                                   null,</span>
<a href="#l45.40"></a><span id="l45.40">                                                   0,</span>
<a href="#l45.41"></a><span id="l45.41">                                                   {});</span>
<a href="#l45.42"></a><span id="l45.42">                 // Map all negative dates.</span>
<a href="#l45.43"></a><span id="l45.43" class="difflineminus">-                for (let r of rdates) {</span>
<a href="#l45.44"></a><span id="l45.44" class="difflineminus">-                    negMap[getRidKey(r)] = true;</span>
<a href="#l45.45"></a><span id="l45.45" class="difflineplus">+                for (let rdate of rdates) {</span>
<a href="#l45.46"></a><span id="l45.46" class="difflineplus">+                    negMap[getRidKey(rdate)] = true;</span>
<a href="#l45.47"></a><span id="l45.47">                 }</span>
<a href="#l45.48"></a><span id="l45.48">             } else {</span>
<a href="#l45.49"></a><span id="l45.49">                 WARN(&quot;Item '&quot; + this.mBaseItem.title + &quot;'&quot; +</span>
<a href="#l45.50"></a><span id="l45.50">                      (this.mBaseItem.calendar ? &quot; (&quot; + this.mBaseItem.calendar.name + &quot;)&quot; : &quot;&quot;) +</span>
<a href="#l45.51"></a><span id="l45.51">                      &quot; has an infinite negative rule (EXRULE)&quot;);</span>
<a href="#l45.52"></a><span id="l45.52">             }</span>
<a href="#l45.53"></a><span id="l45.53">         }</span>
<a href="#l45.54"></a><span id="l45.54"> </span>
<a href="#l45.55"></a><span id="l45.55" class="difflineat">@@ -542,46 +542,46 @@ calRecurrenceInfo.prototype = {</span>
<a href="#l45.56"></a><span id="l45.56">             // check exceptions here</span>
<a href="#l45.57"></a><span id="l45.57">             for (let dateToRemove of cur_dates) {</span>
<a href="#l45.58"></a><span id="l45.58">                 let dateToRemoveKey = getRidKey(dateToRemove);</span>
<a href="#l45.59"></a><span id="l45.59">                 if (dateToRemove.isDate) {</span>
<a href="#l45.60"></a><span id="l45.60">                     // As decided in bug 734245, an EXDATE of type DATE shall also match a DTSTART of type DATE-TIME</span>
<a href="#l45.61"></a><span id="l45.61">                     let toRemove = [];</span>
<a href="#l45.62"></a><span id="l45.62">                     for (let occurenceKey in occurrenceMap) {</span>
<a href="#l45.63"></a><span id="l45.63">                         if (occurrenceMap[occurenceKey] &amp;&amp; occurenceKey.substring(0, 8) == dateToRemoveKey) {</span>
<a href="#l45.64"></a><span id="l45.64" class="difflineminus">-                            dates = dates.filter(d =&gt; d.id.compare(dateToRemove) != 0);</span>
<a href="#l45.65"></a><span id="l45.65" class="difflineplus">+                            dates = dates.filter(date =&gt; date.id.compare(dateToRemove) != 0);</span>
<a href="#l45.66"></a><span id="l45.66">                             toRemove.push(occurenceKey);</span>
<a href="#l45.67"></a><span id="l45.67">                         }</span>
<a href="#l45.68"></a><span id="l45.68">                     }</span>
<a href="#l45.69"></a><span id="l45.69">                     for (let i = 0; i &lt; toRemove.length; i++) {</span>
<a href="#l45.70"></a><span id="l45.70">                         delete occurrenceMap[toRemove[i]];</span>
<a href="#l45.71"></a><span id="l45.71">                     }</span>
<a href="#l45.72"></a><span id="l45.72">                 } else if (occurrenceMap[dateToRemoveKey]) {</span>
<a href="#l45.73"></a><span id="l45.73">                     // TODO PERF Theoretically we could use occurrence map</span>
<a href="#l45.74"></a><span id="l45.74">                     // to construct the array of occurrences. Right now I'm</span>
<a href="#l45.75"></a><span id="l45.75">                     // just using the occurrence map to skip the filter</span>
<a href="#l45.76"></a><span id="l45.76">                     // action if the occurrence isn't there anyway.</span>
<a href="#l45.77"></a><span id="l45.77" class="difflineminus">-                    dates = dates.filter(d =&gt; d.id.compare(dateToRemove) != 0);</span>
<a href="#l45.78"></a><span id="l45.78" class="difflineplus">+                    dates = dates.filter(date =&gt; date.id.compare(dateToRemove) != 0);</span>
<a href="#l45.79"></a><span id="l45.79">                     delete occurrenceMap[dateToRemoveKey];</span>
<a href="#l45.80"></a><span id="l45.80">                 }</span>
<a href="#l45.81"></a><span id="l45.81">             }</span>
<a href="#l45.82"></a><span id="l45.82">         }</span>
<a href="#l45.83"></a><span id="l45.83"> </span>
<a href="#l45.84"></a><span id="l45.84">         // The list was already sorted above, chop anything over aMaxCount, if</span>
<a href="#l45.85"></a><span id="l45.85">         // specified.</span>
<a href="#l45.86"></a><span id="l45.86">         if (aMaxCount &amp;&amp; dates.length &gt; aMaxCount) {</span>
<a href="#l45.87"></a><span id="l45.87">             dates = dates.slice(0, aMaxCount);</span>
<a href="#l45.88"></a><span id="l45.88">         }</span>
<a href="#l45.89"></a><span id="l45.89"> </span>
<a href="#l45.90"></a><span id="l45.90">         return dates;</span>
<a href="#l45.91"></a><span id="l45.91">     },</span>
<a href="#l45.92"></a><span id="l45.92"> </span>
<a href="#l45.93"></a><span id="l45.93">     getOccurrenceDates: function(aRangeStart, aRangeEnd, aMaxCount, aCount) {</span>
<a href="#l45.94"></a><span id="l45.94">         let dates = this.calculateDates(aRangeStart, aRangeEnd, aMaxCount);</span>
<a href="#l45.95"></a><span id="l45.95" class="difflineminus">-        dates = dates.map(d =&gt; d.rstart);</span>
<a href="#l45.96"></a><span id="l45.96" class="difflineplus">+        dates = dates.map(date =&gt; date.rstart);</span>
<a href="#l45.97"></a><span id="l45.97">         aCount.value = dates.length;</span>
<a href="#l45.98"></a><span id="l45.98">         return dates;</span>
<a href="#l45.99"></a><span id="l45.99">     },</span>
<a href="#l45.100"></a><span id="l45.100"> </span>
<a href="#l45.101"></a><span id="l45.101">     getOccurrences: function(aRangeStart, aRangeEnd, aMaxCount, aCount) {</span>
<a href="#l45.102"></a><span id="l45.102">         let results = [];</span>
<a href="#l45.103"></a><span id="l45.103">         let dates = this.calculateDates(aRangeStart, aRangeEnd, aMaxCount);</span>
<a href="#l45.104"></a><span id="l45.104">         if (dates.length) {</span>
<a href="#l45.105"></a><span id="l45.105" class="difflineat">@@ -608,36 +608,35 @@ calRecurrenceInfo.prototype = {</span>
<a href="#l45.106"></a><span id="l45.106">         }</span>
<a href="#l45.107"></a><span id="l45.107">         return proxy;</span>
<a href="#l45.108"></a><span id="l45.108">     },</span>
<a href="#l45.109"></a><span id="l45.109"> </span>
<a href="#l45.110"></a><span id="l45.110">     removeOccurrenceAt: function(aRecurrenceId) {</span>
<a href="#l45.111"></a><span id="l45.111">         this.ensureBaseItem();</span>
<a href="#l45.112"></a><span id="l45.112">         this.ensureMutable();</span>
<a href="#l45.113"></a><span id="l45.113"> </span>
<a href="#l45.114"></a><span id="l45.114" class="difflineminus">-        let d = Components.classes[&quot;@mozilla.org/calendar/recurrence-date;1&quot;]</span>
<a href="#l45.115"></a><span id="l45.115" class="difflineminus">-                          .createInstance(Components.interfaces.calIRecurrenceDate);</span>
<a href="#l45.116"></a><span id="l45.116" class="difflineminus">-        d.isNegative = true;</span>
<a href="#l45.117"></a><span id="l45.117" class="difflineminus">-        d.date = aRecurrenceId.clone();</span>
<a href="#l45.118"></a><span id="l45.118" class="difflineplus">+        let rdate = Components.classes[&quot;@mozilla.org/calendar/recurrence-date;1&quot;]</span>
<a href="#l45.119"></a><span id="l45.119" class="difflineplus">+                              .createInstance(Components.interfaces.calIRecurrenceDate);</span>
<a href="#l45.120"></a><span id="l45.120" class="difflineplus">+        rdate.isNegative = true;</span>
<a href="#l45.121"></a><span id="l45.121" class="difflineplus">+        rdate.date = aRecurrenceId.clone();</span>
<a href="#l45.122"></a><span id="l45.122"> </span>
<a href="#l45.123"></a><span id="l45.123" class="difflineminus">-        this.removeExceptionFor(d.date);</span>
<a href="#l45.124"></a><span id="l45.124" class="difflineplus">+        this.removeExceptionFor(rdate.date);</span>
<a href="#l45.125"></a><span id="l45.125"> </span>
<a href="#l45.126"></a><span id="l45.126" class="difflineminus">-        this.appendRecurrenceItem(d);</span>
<a href="#l45.127"></a><span id="l45.127" class="difflineplus">+        this.appendRecurrenceItem(rdate);</span>
<a href="#l45.128"></a><span id="l45.128">     },</span>
<a href="#l45.129"></a><span id="l45.129"> </span>
<a href="#l45.130"></a><span id="l45.130">     restoreOccurrenceAt: function(aRecurrenceId) {</span>
<a href="#l45.131"></a><span id="l45.131">         this.ensureBaseItem();</span>
<a href="#l45.132"></a><span id="l45.132">         this.ensureMutable();</span>
<a href="#l45.133"></a><span id="l45.133">         this.ensureSortedRecurrenceRules();</span>
<a href="#l45.134"></a><span id="l45.134"> </span>
<a href="#l45.135"></a><span id="l45.135">         for (let i = 0; i &lt; this.mRecurrenceItems.length; i++) {</span>
<a href="#l45.136"></a><span id="l45.136" class="difflineminus">-            let wrappedItem = cal.wrapInstance(this.mRecurrenceItems[i], Components.interfaces.calIRecurrenceDate);</span>
<a href="#l45.137"></a><span id="l45.137" class="difflineminus">-            if (wrappedItem) {</span>
<a href="#l45.138"></a><span id="l45.138" class="difflineminus">-                let rd = wrappedItem;</span>
<a href="#l45.139"></a><span id="l45.139" class="difflineminus">-                if (rd.isNegative &amp;&amp; rd.date.compare(aRecurrenceId) == 0) {</span>
<a href="#l45.140"></a><span id="l45.140" class="difflineplus">+            let rdate = cal.wrapInstance(this.mRecurrenceItems[i], Components.interfaces.calIRecurrenceDate);</span>
<a href="#l45.141"></a><span id="l45.141" class="difflineplus">+            if (rdate) {</span>
<a href="#l45.142"></a><span id="l45.142" class="difflineplus">+                if (rdate.isNegative &amp;&amp; rdate.date.compare(aRecurrenceId) == 0) {</span>
<a href="#l45.143"></a><span id="l45.143">                     return this.deleteRecurrenceItemAt(i);</span>
<a href="#l45.144"></a><span id="l45.144">                 }</span>
<a href="#l45.145"></a><span id="l45.145">             }</span>
<a href="#l45.146"></a><span id="l45.146">         }</span>
<a href="#l45.147"></a><span id="l45.147"> </span>
<a href="#l45.148"></a><span id="l45.148">         throw Components.results.NS_ERROR_INVALID_ARG;</span>
<a href="#l45.149"></a><span id="l45.149">     },</span>
<a href="#l45.150"></a><span id="l45.150"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l46.1"></a><span id="l46.1" class="difflineminus">--- a/calendar/base/src/calTimezoneService.js</span>
<a href="#l46.2"></a><span id="l46.2" class="difflineplus">+++ b/calendar/base/src/calTimezoneService.js</span>
<a href="#l46.3"></a><span id="l46.3" class="difflineat">@@ -189,57 +189,57 @@ calTimezoneService.prototype = {</span>
<a href="#l46.4"></a><span id="l46.4">         if (tzid.startsWith(&quot;/mozilla.org/&quot;)) {</span>
<a href="#l46.5"></a><span id="l46.5">             // We know that our former tzids look like &quot;/mozilla.org/&lt;dtstamp&gt;/continent/...&quot;</span>
<a href="#l46.6"></a><span id="l46.6">             // The ending of the mozilla prefix is the index of that slash before the</span>
<a href="#l46.7"></a><span id="l46.7">             // continent. Therefore, we start looking for the prefix-ending slash</span>
<a href="#l46.8"></a><span id="l46.8">             // after position 13.</span>
<a href="#l46.9"></a><span id="l46.9">             tzid = tzid.substring(tzid.indexOf(&quot;/&quot;, 13) + 1);</span>
<a href="#l46.10"></a><span id="l46.10">         }</span>
<a href="#l46.11"></a><span id="l46.11"> </span>
<a href="#l46.12"></a><span id="l46.12" class="difflineminus">-        let tz = this.mZones.get(tzid);</span>
<a href="#l46.13"></a><span id="l46.13" class="difflineminus">-        if (!tz) {</span>
<a href="#l46.14"></a><span id="l46.14" class="difflineplus">+        let timezone = this.mZones.get(tzid);</span>
<a href="#l46.15"></a><span id="l46.15" class="difflineplus">+        if (!timezone) {</span>
<a href="#l46.16"></a><span id="l46.16">             cal.ERROR(&quot;Couldn't find &quot; + tzid);</span>
<a href="#l46.17"></a><span id="l46.17">             return null;</span>
<a href="#l46.18"></a><span id="l46.18">         }</span>
<a href="#l46.19"></a><span id="l46.19" class="difflineminus">-        if (!tz.zone) {</span>
<a href="#l46.20"></a><span id="l46.20" class="difflineminus">-            if (tz.aliasTo) {</span>
<a href="#l46.21"></a><span id="l46.21" class="difflineplus">+        if (!timezone.zone) {</span>
<a href="#l46.22"></a><span id="l46.22" class="difflineplus">+            if (timezone.aliasTo) {</span>
<a href="#l46.23"></a><span id="l46.23">                 // This zone is an alias.</span>
<a href="#l46.24"></a><span id="l46.24" class="difflineminus">-                tz.zone = this.getTimezone(tz.aliasTo);</span>
<a href="#l46.25"></a><span id="l46.25" class="difflineplus">+                timezone.zone = this.getTimezone(timezone.aliasTo);</span>
<a href="#l46.26"></a><span id="l46.26">             } else if (Preferences.get(&quot;calendar.icaljs&quot;, false)) {</span>
<a href="#l46.27"></a><span id="l46.27" class="difflineminus">-                let parsedComp = ICAL.parse(&quot;BEGIN:VCALENDAR\r\n&quot; + tz.ics + &quot;\r\nEND:VCALENDAR&quot;);</span>
<a href="#l46.28"></a><span id="l46.28" class="difflineplus">+                let parsedComp = ICAL.parse(&quot;BEGIN:VCALENDAR\r\n&quot; + timezone.ics + &quot;\r\nEND:VCALENDAR&quot;);</span>
<a href="#l46.29"></a><span id="l46.29">                 let icalComp = new ICAL.Component(parsedComp);</span>
<a href="#l46.30"></a><span id="l46.30">                 let tzComp = icalComp.getFirstSubcomponent(&quot;vtimezone&quot;);</span>
<a href="#l46.31"></a><span id="l46.31" class="difflineminus">-                tz.zone = new calICALJSTimezone(ICAL.Timezone.fromData({</span>
<a href="#l46.32"></a><span id="l46.32" class="difflineplus">+                timezone.zone = new calICALJSTimezone(ICAL.Timezone.fromData({</span>
<a href="#l46.33"></a><span id="l46.33">                     tzid: tzid,</span>
<a href="#l46.34"></a><span id="l46.34">                     component: tzComp,</span>
<a href="#l46.35"></a><span id="l46.35" class="difflineminus">-                    latitude: tz.latitude,</span>
<a href="#l46.36"></a><span id="l46.36" class="difflineminus">-                    longitude: tz.longitude</span>
<a href="#l46.37"></a><span id="l46.37" class="difflineplus">+                    latitude: timezone.latitude,</span>
<a href="#l46.38"></a><span id="l46.38" class="difflineplus">+                    longitude: timezone.longitude</span>
<a href="#l46.39"></a><span id="l46.39">                 }));</span>
<a href="#l46.40"></a><span id="l46.40">             } else {</span>
<a href="#l46.41"></a><span id="l46.41" class="difflineminus">-                tz.zone = new calLibicalTimezone(tzid, tz.ics, tz.latitude, tz.longitude);</span>
<a href="#l46.42"></a><span id="l46.42" class="difflineplus">+                timezone.zone = new calLibicalTimezone(tzid, timezone.ics, timezone.latitude, timezone.longitude);</span>
<a href="#l46.43"></a><span id="l46.43">             }</span>
<a href="#l46.44"></a><span id="l46.44">         }</span>
<a href="#l46.45"></a><span id="l46.45" class="difflineminus">-        return tz.zone;</span>
<a href="#l46.46"></a><span id="l46.46" class="difflineplus">+        return timezone.zone;</span>
<a href="#l46.47"></a><span id="l46.47">     },</span>
<a href="#l46.48"></a><span id="l46.48"> </span>
<a href="#l46.49"></a><span id="l46.49">     get timezoneIds() {</span>
<a href="#l46.50"></a><span id="l46.50">         let zones = [];</span>
<a href="#l46.51"></a><span id="l46.51">         for (let [k, v] of this.mZones.entries()) {</span>
<a href="#l46.52"></a><span id="l46.52">             if (!v.aliasTo &amp;&amp; k != &quot;UTC&quot; &amp;&amp; k != &quot;floating&quot;) {</span>
<a href="#l46.53"></a><span id="l46.53">                 zones.push(k);</span>
<a href="#l46.54"></a><span id="l46.54">             }</span>
<a href="#l46.55"></a><span id="l46.55">         }</span>
<a href="#l46.56"></a><span id="l46.56">         return new calStringEnumerator(zones);</span>
<a href="#l46.57"></a><span id="l46.57">     },</span>
<a href="#l46.58"></a><span id="l46.58"> </span>
<a href="#l46.59"></a><span id="l46.59">     get aliasIds() {</span>
<a href="#l46.60"></a><span id="l46.60">         let zones = [];</span>
<a href="#l46.61"></a><span id="l46.61" class="difflineminus">-        for (let [k, v] of this.mZones.entries()) {</span>
<a href="#l46.62"></a><span id="l46.62" class="difflineminus">-            if (v.aliasTo &amp;&amp; k != &quot;UTC&quot; &amp;&amp; k != &quot;floating&quot;) {</span>
<a href="#l46.63"></a><span id="l46.63" class="difflineminus">-                zones.push(k);</span>
<a href="#l46.64"></a><span id="l46.64" class="difflineplus">+        for (let [key, value] of this.mZones.entries()) {</span>
<a href="#l46.65"></a><span id="l46.65" class="difflineplus">+            if (value.aliasTo &amp;&amp; key != &quot;UTC&quot; &amp;&amp; key != &quot;floating&quot;) {</span>
<a href="#l46.66"></a><span id="l46.66" class="difflineplus">+                zones.push(key);</span>
<a href="#l46.67"></a><span id="l46.67">             }</span>
<a href="#l46.68"></a><span id="l46.68">         }</span>
<a href="#l46.69"></a><span id="l46.69">         return new calStringEnumerator(zones);</span>
<a href="#l46.70"></a><span id="l46.70">     },</span>
<a href="#l46.71"></a><span id="l46.71"> </span>
<a href="#l46.72"></a><span id="l46.72">     get version() {</span>
<a href="#l46.73"></a><span id="l46.73">         return this.mVersion;</span>
<a href="#l46.74"></a><span id="l46.74">     },</span>
<a href="#l46.75"></a><span id="l46.75" class="difflineat">@@ -325,54 +325,54 @@ function guessSystemTimezone() {</span>
<a href="#l46.76"></a><span id="l46.76">     // * standard offset and daylight/summer offset if present (longitude),</span>
<a href="#l46.77"></a><span id="l46.77">     // * if has summer time, direction of change (northern/southern hemisphere)</span>
<a href="#l46.78"></a><span id="l46.78">     // * if has summer time, dates of next transitions</span>
<a href="#l46.79"></a><span id="l46.79">     // * timezone name (such as &quot;Western European Standard Time&quot;).</span>
<a href="#l46.80"></a><span id="l46.80">     // Score is 3 if matches dates and names, 2 if matches dates without names,</span>
<a href="#l46.81"></a><span id="l46.81">     // 1 if matches dates within a week (so changes on different weekday),</span>
<a href="#l46.82"></a><span id="l46.82">     // otherwise 0 if no match.</span>
<a href="#l46.83"></a><span id="l46.83">     function checkTZ(tzId) {</span>
<a href="#l46.84"></a><span id="l46.84" class="difflineminus">-        let tz = tzSvc.getTimezone(tzId);</span>
<a href="#l46.85"></a><span id="l46.85" class="difflineplus">+        let timezone = tzSvc.getTimezone(tzId);</span>
<a href="#l46.86"></a><span id="l46.86"> </span>
<a href="#l46.87"></a><span id="l46.87">         // Have to handle UTC separately because it has no .icalComponent.</span>
<a href="#l46.88"></a><span id="l46.88" class="difflineminus">-        if (tz.isUTC) {</span>
<a href="#l46.89"></a><span id="l46.89" class="difflineplus">+        if (timezone.isUTC) {</span>
<a href="#l46.90"></a><span id="l46.90">             if (offsetDec == 0 &amp;&amp; offsetJun == 0) {</span>
<a href="#l46.91"></a><span id="l46.91">                 if (tzNameJun == &quot;UTC&quot; &amp;&amp; tzNameDec == &quot;UTC&quot;) {</span>
<a href="#l46.92"></a><span id="l46.92">                     return 3;</span>
<a href="#l46.93"></a><span id="l46.93">                 } else {</span>
<a href="#l46.94"></a><span id="l46.94">                     return 2;</span>
<a href="#l46.95"></a><span id="l46.95">                 }</span>
<a href="#l46.96"></a><span id="l46.96">             } else {</span>
<a href="#l46.97"></a><span id="l46.97">                 return 0;</span>
<a href="#l46.98"></a><span id="l46.98">             }</span>
<a href="#l46.99"></a><span id="l46.99">         }</span>
<a href="#l46.100"></a><span id="l46.100"> </span>
<a href="#l46.101"></a><span id="l46.101" class="difflineminus">-        let subComp = tz.icalComponent;</span>
<a href="#l46.102"></a><span id="l46.102" class="difflineplus">+        let subComp = timezone.icalComponent;</span>
<a href="#l46.103"></a><span id="l46.103">         // find currently applicable time period, not just first,</span>
<a href="#l46.104"></a><span id="l46.104">         // because offsets of timezone may be changed over the years.</span>
<a href="#l46.105"></a><span id="l46.105" class="difflineminus">-        let standard = findCurrentTimePeriod(tz, subComp, &quot;STANDARD&quot;);</span>
<a href="#l46.106"></a><span id="l46.106" class="difflineplus">+        let standard = findCurrentTimePeriod(timezone, subComp, &quot;STANDARD&quot;);</span>
<a href="#l46.107"></a><span id="l46.107">         let standardTZOffset = getIcalString(standard, &quot;TZOFFSETTO&quot;);</span>
<a href="#l46.108"></a><span id="l46.108">         let standardName = getIcalString(standard, &quot;TZNAME&quot;);</span>
<a href="#l46.109"></a><span id="l46.109" class="difflineminus">-        let daylight = findCurrentTimePeriod(tz, subComp, &quot;DAYLIGHT&quot;);</span>
<a href="#l46.110"></a><span id="l46.110" class="difflineplus">+        let daylight = findCurrentTimePeriod(timezone, subComp, &quot;DAYLIGHT&quot;);</span>
<a href="#l46.111"></a><span id="l46.111">         let daylightTZOffset = getIcalString(daylight, &quot;TZOFFSETTO&quot;);</span>
<a href="#l46.112"></a><span id="l46.112">         let daylightName = getIcalString(daylight, &quot;TZNAME&quot;);</span>
<a href="#l46.113"></a><span id="l46.113"> </span>
<a href="#l46.114"></a><span id="l46.114">         // Try northern hemisphere cases.</span>
<a href="#l46.115"></a><span id="l46.115">         if (offsetDec == standardTZOffset &amp;&amp; offsetDec == offsetJun &amp;&amp;</span>
<a href="#l46.116"></a><span id="l46.116">             !daylight) {</span>
<a href="#l46.117"></a><span id="l46.117">             if (standardName &amp;&amp; standardName == tzNameJun) {</span>
<a href="#l46.118"></a><span id="l46.118">                 return 3;</span>
<a href="#l46.119"></a><span id="l46.119">             } else {</span>
<a href="#l46.120"></a><span id="l46.120">                 return 2;</span>
<a href="#l46.121"></a><span id="l46.121">             }</span>
<a href="#l46.122"></a><span id="l46.122">         }</span>
<a href="#l46.123"></a><span id="l46.123"> </span>
<a href="#l46.124"></a><span id="l46.124">         if (offsetDec == standardTZOffset &amp;&amp; offsetJun == daylightTZOffset &amp;&amp;</span>
<a href="#l46.125"></a><span id="l46.125">             daylight) {</span>
<a href="#l46.126"></a><span id="l46.126" class="difflineminus">-            let dateMatchWt = systemTZMatchesTimeShiftDates(tz, subComp);</span>
<a href="#l46.127"></a><span id="l46.127" class="difflineplus">+            let dateMatchWt = systemTZMatchesTimeShiftDates(timezone, subComp);</span>
<a href="#l46.128"></a><span id="l46.128">             if (dateMatchWt &gt; 0) {</span>
<a href="#l46.129"></a><span id="l46.129">                 if (standardName &amp;&amp; standardName == tzNameJun &amp;&amp;</span>
<a href="#l46.130"></a><span id="l46.130">                     daylightName &amp;&amp; daylightName == tzNameDec) {</span>
<a href="#l46.131"></a><span id="l46.131">                     return 3;</span>
<a href="#l46.132"></a><span id="l46.132">                 } else {</span>
<a href="#l46.133"></a><span id="l46.133">                     return dateMatchWt;</span>
<a href="#l46.134"></a><span id="l46.134">                 }</span>
<a href="#l46.135"></a><span id="l46.135">             }</span>
<a href="#l46.136"></a><span id="l46.136" class="difflineat">@@ -385,60 +385,61 @@ function guessSystemTimezone() {</span>
<a href="#l46.137"></a><span id="l46.137">                 return 3;</span>
<a href="#l46.138"></a><span id="l46.138">             } else {</span>
<a href="#l46.139"></a><span id="l46.139">                 return 2;</span>
<a href="#l46.140"></a><span id="l46.140">             }</span>
<a href="#l46.141"></a><span id="l46.141">         }</span>
<a href="#l46.142"></a><span id="l46.142"> </span>
<a href="#l46.143"></a><span id="l46.143">         if (offsetJun == standardTZOffset &amp;&amp; offsetDec == daylightTZOffset &amp;&amp;</span>
<a href="#l46.144"></a><span id="l46.144">             daylight) {</span>
<a href="#l46.145"></a><span id="l46.145" class="difflineminus">-            let dateMatchWt = systemTZMatchesTimeShiftDates(tz, subComp);</span>
<a href="#l46.146"></a><span id="l46.146" class="difflineplus">+            let dateMatchWt = systemTZMatchesTimeShiftDates(timezone, subComp);</span>
<a href="#l46.147"></a><span id="l46.147">             if (dateMatchWt &gt; 0) {</span>
<a href="#l46.148"></a><span id="l46.148">                 if (standardName &amp;&amp; standardName == tzNameJun &amp;&amp;</span>
<a href="#l46.149"></a><span id="l46.149">                     daylightName &amp;&amp; daylightName == tzNameDec) {</span>
<a href="#l46.150"></a><span id="l46.150">                     return 3;</span>
<a href="#l46.151"></a><span id="l46.151">                 } else {</span>
<a href="#l46.152"></a><span id="l46.152">                     return dateMatchWt;</span>
<a href="#l46.153"></a><span id="l46.153">                 }</span>
<a href="#l46.154"></a><span id="l46.154">             }</span>
<a href="#l46.155"></a><span id="l46.155">         }</span>
<a href="#l46.156"></a><span id="l46.156">         return 0;</span>
<a href="#l46.157"></a><span id="l46.157">     }</span>
<a href="#l46.158"></a><span id="l46.158"> </span>
<a href="#l46.159"></a><span id="l46.159">     // returns 2=match-within-hours, 1=match-within-week, 0=no-match</span>
<a href="#l46.160"></a><span id="l46.160" class="difflineminus">-    function systemTZMatchesTimeShiftDates(tz, subComp) {</span>
<a href="#l46.161"></a><span id="l46.161" class="difflineplus">+    function systemTZMatchesTimeShiftDates(timezone, subComp) {</span>
<a href="#l46.162"></a><span id="l46.162">         // Verify local autumn and spring shifts also occur in system timezone</span>
<a href="#l46.163"></a><span id="l46.163">         // (jsDate) on correct date in correct direction.</span>
<a href="#l46.164"></a><span id="l46.164">         // (Differs for northern/southern hemisphere.</span>
<a href="#l46.165"></a><span id="l46.165">         //  Local autumn shift is to local winter STANDARD time.</span>
<a href="#l46.166"></a><span id="l46.166">         //  Local spring shift is to local summer DAYLIGHT time.)</span>
<a href="#l46.167"></a><span id="l46.167">         const autumnShiftJSDate =</span>
<a href="#l46.168"></a><span id="l46.168" class="difflineminus">-            findCurrentTimePeriod(tz, subComp, &quot;STANDARD&quot;, true);</span>
<a href="#l46.169"></a><span id="l46.169" class="difflineplus">+            findCurrentTimePeriod(timezone, subComp, &quot;STANDARD&quot;, true);</span>
<a href="#l46.170"></a><span id="l46.170">         const afterAutumnShiftJSDate = new Date(autumnShiftJSDate);</span>
<a href="#l46.171"></a><span id="l46.171">         const beforeAutumnShiftJSDate = new Date(autumnShiftJSDate);</span>
<a href="#l46.172"></a><span id="l46.172">         const springShiftJSDate =</span>
<a href="#l46.173"></a><span id="l46.173" class="difflineminus">-            findCurrentTimePeriod(tz, subComp, &quot;DAYLIGHT&quot;, true);</span>
<a href="#l46.174"></a><span id="l46.174" class="difflineplus">+            findCurrentTimePeriod(timezone, subComp, &quot;DAYLIGHT&quot;, true);</span>
<a href="#l46.175"></a><span id="l46.175">         const beforeSpringShiftJSDate = new Date(springShiftJSDate);</span>
<a href="#l46.176"></a><span id="l46.176">         const afterSpringShiftJSDate = new Date(springShiftJSDate);</span>
<a href="#l46.177"></a><span id="l46.177">         // Try with 6 HOURS fuzz in either direction, since OS and ZoneInfo</span>
<a href="#l46.178"></a><span id="l46.178">         // may disagree on the exact time of shift (midnight, 2am, 4am, etc).</span>
<a href="#l46.179"></a><span id="l46.179">         beforeAutumnShiftJSDate.setHours(autumnShiftJSDate.getHours() - 6);</span>
<a href="#l46.180"></a><span id="l46.180">         afterAutumnShiftJSDate.setHours(autumnShiftJSDate.getHours() + 6);</span>
<a href="#l46.181"></a><span id="l46.181">         afterSpringShiftJSDate.setHours(afterSpringShiftJSDate.getHours() + 6);</span>
<a href="#l46.182"></a><span id="l46.182">         beforeSpringShiftJSDate.setHours(beforeSpringShiftJSDate.getHours() - 6);</span>
<a href="#l46.183"></a><span id="l46.183">         if ((beforeAutumnShiftJSDate.getTimezoneOffset() &lt;</span>
<a href="#l46.184"></a><span id="l46.184">              afterAutumnShiftJSDate.getTimezoneOffset()) &amp;&amp;</span>
<a href="#l46.185"></a><span id="l46.185">             (beforeSpringShiftJSDate.getTimezoneOffset() &gt;</span>
<a href="#l46.186"></a><span id="l46.186">              afterSpringShiftJSDate.getTimezoneOffset())) {</span>
<a href="#l46.187"></a><span id="l46.187">             return 2;</span>
<a href="#l46.188"></a><span id="l46.188">         }</span>
<a href="#l46.189"></a><span id="l46.189" class="difflineminus">-        // Try with 7 DAYS fuzz in either direction, so if no other tz found,</span>
<a href="#l46.190"></a><span id="l46.190" class="difflineminus">-        // will have a nearby tz that disagrees only on the weekday of shift</span>
<a href="#l46.191"></a><span id="l46.191" class="difflineminus">-        // (sunday vs. friday vs. calendar day), or off by exactly one week,</span>
<a href="#l46.192"></a><span id="l46.192" class="difflineminus">-        // (e.g., needed to guess Africa/Cairo on w2k in 2006).</span>
<a href="#l46.193"></a><span id="l46.193" class="difflineplus">+        // Try with 7 DAYS fuzz in either direction, so if no other timezone</span>
<a href="#l46.194"></a><span id="l46.194" class="difflineplus">+        // found, will have a nearby timezone that disagrees only on the</span>
<a href="#l46.195"></a><span id="l46.195" class="difflineplus">+        // weekday of shift (sunday vs. friday vs. calendar day), or off by</span>
<a href="#l46.196"></a><span id="l46.196" class="difflineplus">+        // exactly one week, (e.g., needed to guess Africa/Cairo on w2k in</span>
<a href="#l46.197"></a><span id="l46.197" class="difflineplus">+        // 2006).</span>
<a href="#l46.198"></a><span id="l46.198">         beforeAutumnShiftJSDate.setDate(autumnShiftJSDate.getDate() - 7);</span>
<a href="#l46.199"></a><span id="l46.199">         afterAutumnShiftJSDate.setDate(autumnShiftJSDate.getDate() + 7);</span>
<a href="#l46.200"></a><span id="l46.200">         afterSpringShiftJSDate.setDate(afterSpringShiftJSDate.getDate() + 7);</span>
<a href="#l46.201"></a><span id="l46.201">         beforeSpringShiftJSDate.setDate(beforeSpringShiftJSDate.getDate() - 7);</span>
<a href="#l46.202"></a><span id="l46.202">         if ((beforeAutumnShiftJSDate.getTimezoneOffset() &lt;</span>
<a href="#l46.203"></a><span id="l46.203">              afterAutumnShiftJSDate.getTimezoneOffset()) &amp;&amp;</span>
<a href="#l46.204"></a><span id="l46.204">             (beforeSpringShiftJSDate.getTimezoneOffset() &gt;</span>
<a href="#l46.205"></a><span id="l46.205">              afterSpringShiftJSDate.getTimezoneOffset())) {</span>
<a href="#l46.206"></a><span id="l46.206" class="difflineat">@@ -450,27 +451,27 @@ function guessSystemTimezone() {</span>
<a href="#l46.207"></a><span id="l46.207"> </span>
<a href="#l46.208"></a><span id="l46.208">     const todayUTC = cal.jsDateToDateTime(new Date());</span>
<a href="#l46.209"></a><span id="l46.209">     const oneYrUTC = todayUTC.clone(); oneYrUTC.year += 1;</span>
<a href="#l46.210"></a><span id="l46.210">     const periodStartCalDate = cal.createDateTime();</span>
<a href="#l46.211"></a><span id="l46.211">     const periodUntilCalDate = cal.createDateTime(); // until timezone is UTC</span>
<a href="#l46.212"></a><span id="l46.212">     const periodCalRule = cal.createRecurrenceRule();</span>
<a href="#l46.213"></a><span id="l46.213">     const untilRegex = /UNTIL=(\d{8}T\d{6}Z)/;</span>
<a href="#l46.214"></a><span id="l46.214"> </span>
<a href="#l46.215"></a><span id="l46.215" class="difflineminus">-    function findCurrentTimePeriod(tz, subComp, standardOrDaylight,</span>
<a href="#l46.216"></a><span id="l46.216" class="difflineplus">+    function findCurrentTimePeriod(timezone, subComp, standardOrDaylight,</span>
<a href="#l46.217"></a><span id="l46.217">                                    isForNextTransitionDate) {</span>
<a href="#l46.218"></a><span id="l46.218">         // Iterate through 'STANDARD' declarations or 'DAYLIGHT' declarations</span>
<a href="#l46.219"></a><span id="l46.219">         // (periods in history with different settings.</span>
<a href="#l46.220"></a><span id="l46.220">         //  e.g., US changes daylight start in 2007 (from April to March).)</span>
<a href="#l46.221"></a><span id="l46.221">         // Each period is marked by a DTSTART.</span>
<a href="#l46.222"></a><span id="l46.222">         // Find the currently applicable period: has most recent DTSTART</span>
<a href="#l46.223"></a><span id="l46.223">         // not later than today and no UNTIL, or UNTIL is greater than today.</span>
<a href="#l46.224"></a><span id="l46.224">         for (let period of cal.ical.subcomponentIterator(subComp, standardOrDaylight)) {</span>
<a href="#l46.225"></a><span id="l46.225">             periodStartCalDate.icalString = getIcalString(period, &quot;DTSTART&quot;);</span>
<a href="#l46.226"></a><span id="l46.226" class="difflineminus">-            periodStartCalDate.timezone = tz;</span>
<a href="#l46.227"></a><span id="l46.227" class="difflineplus">+            periodStartCalDate.timezone = timezone;</span>
<a href="#l46.228"></a><span id="l46.228">             if (oneYrUTC.nativeTime &lt; periodStartCalDate.nativeTime) {</span>
<a href="#l46.229"></a><span id="l46.229">                 continue; // period starts too far in future</span>
<a href="#l46.230"></a><span id="l46.230">             }</span>
<a href="#l46.231"></a><span id="l46.231">             // Must examine UNTIL date (not next daylight start) because</span>
<a href="#l46.232"></a><span id="l46.232">             // some zones (e.g., Arizona, Hawaii) may stop using daylight</span>
<a href="#l46.233"></a><span id="l46.233">             // time, so there might not be a next daylight start.</span>
<a href="#l46.234"></a><span id="l46.234">             let rrule = period.getFirstProperty(&quot;RRULE&quot;);</span>
<a href="#l46.235"></a><span id="l46.235">             if (rrule) {</span>
<a href="#l46.236"></a><span id="l46.236" class="difflineat">@@ -562,19 +563,19 @@ function guessSystemTimezone() {</span>
<a href="#l46.237"></a><span id="l46.237">                 fileInstream.close();</span>
<a href="#l46.238"></a><span id="l46.238">             }</span>
<a href="#l46.239"></a><span id="l46.239">         } catch (ex) {</span>
<a href="#l46.240"></a><span id="l46.240">             Components.utils.reportError(filepath + &quot;: &quot; + ex);</span>
<a href="#l46.241"></a><span id="l46.241">             return &quot;&quot;;</span>
<a href="#l46.242"></a><span id="l46.242">         }</span>
<a href="#l46.243"></a><span id="l46.243">     }</span>
<a href="#l46.244"></a><span id="l46.244"> </span>
<a href="#l46.245"></a><span id="l46.245" class="difflineminus">-    function weekday(icsDate, tz) {</span>
<a href="#l46.246"></a><span id="l46.246" class="difflineplus">+    function weekday(icsDate, timezone) {</span>
<a href="#l46.247"></a><span id="l46.247">         let calDate = cal.createDateTime(icsDate);</span>
<a href="#l46.248"></a><span id="l46.248" class="difflineminus">-        calDate.timezone = tz;</span>
<a href="#l46.249"></a><span id="l46.249" class="difflineplus">+        calDate.timezone = timezone;</span>
<a href="#l46.250"></a><span id="l46.250">         return cal.dateTimeToJsDate(calDate).toLocaleFormat(&quot;%a&quot;);</span>
<a href="#l46.251"></a><span id="l46.251">     }</span>
<a href="#l46.252"></a><span id="l46.252"> </span>
<a href="#l46.253"></a><span id="l46.253">     // Try to find a tz that matches OS/JSDate timezone.  If no name match,</span>
<a href="#l46.254"></a><span id="l46.254">     // will use first of probable timezone(s) with highest score.</span>
<a href="#l46.255"></a><span id="l46.255">     let probableTZId = &quot;floating&quot;; // default fallback tz if no tz matches.</span>
<a href="#l46.256"></a><span id="l46.256">     let probableTZScore = 0;</span>
<a href="#l46.257"></a><span id="l46.257">     let probableTZSource = null;</span>
<a href="#l46.258"></a><span id="l46.258" class="difflineat">@@ -760,34 +761,34 @@ function guessSystemTimezone() {</span>
<a href="#l46.259"></a><span id="l46.259">     // If reach here, there were no score=3 matches, so Warn in console.</span>
<a href="#l46.260"></a><span id="l46.260">     try {</span>
<a href="#l46.261"></a><span id="l46.261">         switch (probableTZScore) {</span>
<a href="#l46.262"></a><span id="l46.262">         case 0:</span>
<a href="#l46.263"></a><span id="l46.263">             cal.WARN(calProperties.GetStringFromName(&quot;warningUsingFloatingTZNoMatch&quot;));</span>
<a href="#l46.264"></a><span id="l46.264">             break;</span>
<a href="#l46.265"></a><span id="l46.265">         case 1: case 2:</span>
<a href="#l46.266"></a><span id="l46.266">             let tzId = probableTZId;</span>
<a href="#l46.267"></a><span id="l46.267" class="difflineminus">-            let tz = tzSvc.getTimezone(tzId);</span>
<a href="#l46.268"></a><span id="l46.268" class="difflineminus">-            let subComp = tz.icalComponent;</span>
<a href="#l46.269"></a><span id="l46.269" class="difflineminus">-            let standard = findCurrentTimePeriod(tz, subComp, &quot;STANDARD&quot;);</span>
<a href="#l46.270"></a><span id="l46.270" class="difflineplus">+            let timezone = tzSvc.getTimezone(tzId);</span>
<a href="#l46.271"></a><span id="l46.271" class="difflineplus">+            let subComp = timezone.icalComponent;</span>
<a href="#l46.272"></a><span id="l46.272" class="difflineplus">+            let standard = findCurrentTimePeriod(timezone, subComp, &quot;STANDARD&quot;);</span>
<a href="#l46.273"></a><span id="l46.273">             let standardTZOffset = getIcalString(standard, &quot;TZOFFSETTO&quot;);</span>
<a href="#l46.274"></a><span id="l46.274" class="difflineminus">-            let daylight = findCurrentTimePeriod(tz, subComp, &quot;DAYLIGHT&quot;);</span>
<a href="#l46.275"></a><span id="l46.275" class="difflineplus">+            let daylight = findCurrentTimePeriod(timezone, subComp, &quot;DAYLIGHT&quot;);</span>
<a href="#l46.276"></a><span id="l46.276">             let daylightTZOffset = getIcalString(daylight, &quot;TZOFFSETTO&quot;);</span>
<a href="#l46.277"></a><span id="l46.277">             let warningDetail;</span>
<a href="#l46.278"></a><span id="l46.278">             if (probableTZScore == 1) {</span>
<a href="#l46.279"></a><span id="l46.279">                 // score 1 means has daylight time,</span>
<a href="#l46.280"></a><span id="l46.280">                 // but transitions start on different weekday from os timezone.</span>
<a href="#l46.281"></a><span id="l46.281">                 let standardStart = getIcalString(standard, &quot;DTSTART&quot;);</span>
<a href="#l46.282"></a><span id="l46.282" class="difflineminus">-                let standardStartWeekday = weekday(standardStart, tz);</span>
<a href="#l46.283"></a><span id="l46.283" class="difflineplus">+                let standardStartWeekday = weekday(standardStart, timezone);</span>
<a href="#l46.284"></a><span id="l46.284">                 let standardRule = getIcalString(standard, &quot;RRULE&quot;);</span>
<a href="#l46.285"></a><span id="l46.285">                 let standardText =</span>
<a href="#l46.286"></a><span id="l46.286">                     &quot;  Standard: &quot; + standardStart + &quot; &quot; + standardStartWeekday + &quot;\n&quot; +</span>
<a href="#l46.287"></a><span id="l46.287">                     &quot;            &quot; + standardRule + &quot;\n&quot;;</span>
<a href="#l46.288"></a><span id="l46.288">                 let daylightStart = getIcalString(daylight, &quot;DTSTART&quot;);</span>
<a href="#l46.289"></a><span id="l46.289" class="difflineminus">-                let daylightStartWeekday = weekday(daylightStart, tz);</span>
<a href="#l46.290"></a><span id="l46.290" class="difflineplus">+                let daylightStartWeekday = weekday(daylightStart, timezone);</span>
<a href="#l46.291"></a><span id="l46.291">                 let daylightRule = getIcalString(daylight, &quot;RRULE&quot;);</span>
<a href="#l46.292"></a><span id="l46.292">                 let daylightText =</span>
<a href="#l46.293"></a><span id="l46.293">                     &quot;  Daylight: &quot; + daylightStart + &quot; &quot; + daylightStartWeekday + &quot;\n&quot; +</span>
<a href="#l46.294"></a><span id="l46.294">                     &quot;            &quot; + daylightRule + &quot;\n&quot;;</span>
<a href="#l46.295"></a><span id="l46.295">                 warningDetail =</span>
<a href="#l46.296"></a><span id="l46.296">                     (standardStart &lt; daylightStart</span>
<a href="#l46.297"></a><span id="l46.297">                       ? standardText + daylightText</span>
<a href="#l46.298"></a><span id="l46.298">                       : daylightText + standardText) +</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l47.1"></a><span id="l47.1" class="difflineminus">--- a/calendar/base/src/calTodo.js</span>
<a href="#l47.2"></a><span id="l47.2" class="difflineplus">+++ b/calendar/base/src/calTodo.js</span>
<a href="#l47.3"></a><span id="l47.3" class="difflineat">@@ -34,54 +34,54 @@ calTodo.prototype = {</span>
<a href="#l47.4"></a><span id="l47.4">     classInfo: XPCOMUtils.generateCI({</span>
<a href="#l47.5"></a><span id="l47.5">         classID: calTodoClassID,</span>
<a href="#l47.6"></a><span id="l47.6">         contractID: &quot;@mozilla.org/calendar/todo;1&quot;,</span>
<a href="#l47.7"></a><span id="l47.7">         classDescription: &quot;Calendar Todo&quot;,</span>
<a href="#l47.8"></a><span id="l47.8">         interfaces: calTodoInterfaces,</span>
<a href="#l47.9"></a><span id="l47.9">     }),</span>
<a href="#l47.10"></a><span id="l47.10"> </span>
<a href="#l47.11"></a><span id="l47.11">     cloneShallow: function(aNewParent) {</span>
<a href="#l47.12"></a><span id="l47.12" class="difflineminus">-        let m = new calTodo();</span>
<a href="#l47.13"></a><span id="l47.13" class="difflineminus">-        this.cloneItemBaseInto(m, aNewParent);</span>
<a href="#l47.14"></a><span id="l47.14" class="difflineminus">-        return m;</span>
<a href="#l47.15"></a><span id="l47.15" class="difflineplus">+        let cloned = new calTodo();</span>
<a href="#l47.16"></a><span id="l47.16" class="difflineplus">+        this.cloneItemBaseInto(cloned, aNewParent);</span>
<a href="#l47.17"></a><span id="l47.17" class="difflineplus">+        return cloned;</span>
<a href="#l47.18"></a><span id="l47.18">     },</span>
<a href="#l47.19"></a><span id="l47.19"> </span>
<a href="#l47.20"></a><span id="l47.20">     createProxy: function(aRecurrenceId) {</span>
<a href="#l47.21"></a><span id="l47.21">         cal.ASSERT(!this.mIsProxy, &quot;Tried to create a proxy for an existing proxy!&quot;, true);</span>
<a href="#l47.22"></a><span id="l47.22"> </span>
<a href="#l47.23"></a><span id="l47.23" class="difflineminus">-        let m = new calTodo();</span>
<a href="#l47.24"></a><span id="l47.24" class="difflineplus">+        let proxy = new calTodo();</span>
<a href="#l47.25"></a><span id="l47.25"> </span>
<a href="#l47.26"></a><span id="l47.26">         // override proxy's DTSTART/DUE/RECURRENCE-ID</span>
<a href="#l47.27"></a><span id="l47.27">         // before master is set (and item might get immutable):</span>
<a href="#l47.28"></a><span id="l47.28">         let duration = this.duration;</span>
<a href="#l47.29"></a><span id="l47.29">         if (duration) {</span>
<a href="#l47.30"></a><span id="l47.30">             let dueDate = aRecurrenceId.clone();</span>
<a href="#l47.31"></a><span id="l47.31">             dueDate.addDuration(duration);</span>
<a href="#l47.32"></a><span id="l47.32" class="difflineminus">-            m.dueDate = dueDate;</span>
<a href="#l47.33"></a><span id="l47.33" class="difflineplus">+            proxy.dueDate = dueDate;</span>
<a href="#l47.34"></a><span id="l47.34">         }</span>
<a href="#l47.35"></a><span id="l47.35" class="difflineminus">-        m.entryDate = aRecurrenceId;</span>
<a href="#l47.36"></a><span id="l47.36" class="difflineplus">+        proxy.entryDate = aRecurrenceId;</span>
<a href="#l47.37"></a><span id="l47.37"> </span>
<a href="#l47.38"></a><span id="l47.38" class="difflineminus">-        m.initializeProxy(this, aRecurrenceId);</span>
<a href="#l47.39"></a><span id="l47.39" class="difflineminus">-        m.mDirty = false;</span>
<a href="#l47.40"></a><span id="l47.40" class="difflineplus">+        proxy.initializeProxy(this, aRecurrenceId);</span>
<a href="#l47.41"></a><span id="l47.41" class="difflineplus">+        proxy.mDirty = false;</span>
<a href="#l47.42"></a><span id="l47.42"> </span>
<a href="#l47.43"></a><span id="l47.43" class="difflineminus">-        return m;</span>
<a href="#l47.44"></a><span id="l47.44" class="difflineplus">+        return proxy;</span>
<a href="#l47.45"></a><span id="l47.45">     },</span>
<a href="#l47.46"></a><span id="l47.46"> </span>
<a href="#l47.47"></a><span id="l47.47">     makeImmutable: function() {</span>
<a href="#l47.48"></a><span id="l47.48">         this.makeItemBaseImmutable();</span>
<a href="#l47.49"></a><span id="l47.49">     },</span>
<a href="#l47.50"></a><span id="l47.50"> </span>
<a href="#l47.51"></a><span id="l47.51">     get isCompleted() {</span>
<a href="#l47.52"></a><span id="l47.52">         return this.completedDate != null ||</span>
<a href="#l47.53"></a><span id="l47.53">                this.percentComplete == 100 ||</span>
<a href="#l47.54"></a><span id="l47.54">                this.status == &quot;COMPLETED&quot;;</span>
<a href="#l47.55"></a><span id="l47.55">     },</span>
<a href="#l47.56"></a><span id="l47.56"> </span>
<a href="#l47.57"></a><span id="l47.57" class="difflineminus">-    set isCompleted(v) {</span>
<a href="#l47.58"></a><span id="l47.58" class="difflineminus">-        if (v) {</span>
<a href="#l47.59"></a><span id="l47.59" class="difflineplus">+    set isCompleted(completed) {</span>
<a href="#l47.60"></a><span id="l47.60" class="difflineplus">+        if (completed) {</span>
<a href="#l47.61"></a><span id="l47.61">             if (!this.completedDate) {</span>
<a href="#l47.62"></a><span id="l47.62">                 this.completedDate = cal.jsDateToDateTime(new Date());</span>
<a href="#l47.63"></a><span id="l47.63">             }</span>
<a href="#l47.64"></a><span id="l47.64">             this.status = &quot;COMPLETED&quot;;</span>
<a href="#l47.65"></a><span id="l47.65">             this.percentComplete = 100;</span>
<a href="#l47.66"></a><span id="l47.66">         } else {</span>
<a href="#l47.67"></a><span id="l47.67">             this.deleteProperty(&quot;COMPLETED&quot;);</span>
<a href="#l47.68"></a><span id="l47.68">             this.deleteProperty(&quot;STATUS&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l48.1"></a><span id="l48.1" class="difflineminus">--- a/calendar/base/src/calUtils.js</span>
<a href="#l48.2"></a><span id="l48.2" class="difflineplus">+++ b/calendar/base/src/calUtils.js</span>
<a href="#l48.3"></a><span id="l48.3" class="difflineat">@@ -173,20 +173,20 @@ function getRecentTimezones(aConvertZone</span>
<a href="#l48.4"></a><span id="l48.4">     if (!Array.isArray(recentTimezones)) {</span>
<a href="#l48.5"></a><span id="l48.5">         recentTimezones = [];</span>
<a href="#l48.6"></a><span id="l48.6">     }</span>
<a href="#l48.7"></a><span id="l48.7"> </span>
<a href="#l48.8"></a><span id="l48.8">     let tzService = cal.getTimezoneService();</span>
<a href="#l48.9"></a><span id="l48.9">     if (aConvertZones) {</span>
<a href="#l48.10"></a><span id="l48.10">         let oldZonesLength = recentTimezones.length;</span>
<a href="#l48.11"></a><span id="l48.11">         for (let i = 0; i &lt; recentTimezones.length; i++) {</span>
<a href="#l48.12"></a><span id="l48.12" class="difflineminus">-            let tz = tzService.getTimezone(recentTimezones[i]);</span>
<a href="#l48.13"></a><span id="l48.13" class="difflineminus">-            if (tz) {</span>
<a href="#l48.14"></a><span id="l48.14" class="difflineplus">+            let timezone = tzService.getTimezone(recentTimezones[i]);</span>
<a href="#l48.15"></a><span id="l48.15" class="difflineplus">+            if (timezone) {</span>
<a href="#l48.16"></a><span id="l48.16">                 // Replace id with found timezone</span>
<a href="#l48.17"></a><span id="l48.17" class="difflineminus">-                recentTimezones[i] = tz;</span>
<a href="#l48.18"></a><span id="l48.18" class="difflineplus">+                recentTimezones[i] = timezone;</span>
<a href="#l48.19"></a><span id="l48.19">             } else {</span>
<a href="#l48.20"></a><span id="l48.20">                 // Looks like the timezone doesn't longer exist, remove it</span>
<a href="#l48.21"></a><span id="l48.21">                 recentTimezones.splice(i, 1);</span>
<a href="#l48.22"></a><span id="l48.22">                 i--;</span>
<a href="#l48.23"></a><span id="l48.23">             }</span>
<a href="#l48.24"></a><span id="l48.24">         }</span>
<a href="#l48.25"></a><span id="l48.25"> </span>
<a href="#l48.26"></a><span id="l48.26">         if (oldZonesLength != recentTimezones.length) {</span>
<a href="#l48.27"></a><span id="l48.27" class="difflineat">@@ -217,19 +217,19 @@ function getRecentTimezones(aConvertZone</span>
<a href="#l48.28"></a><span id="l48.28">  *   nmchar            [_a-zA-Z0-9-]|{nonascii}|{escape}</span>
<a href="#l48.29"></a><span id="l48.29">  *   name              {nmchar}+</span>
<a href="#l48.30"></a><span id="l48.30">  *   http://www.w3.org/TR/CSS21/grammar.html#scanner</span>
<a href="#l48.31"></a><span id="l48.31">  *</span>
<a href="#l48.32"></a><span id="l48.32">  * @param aString       The unicode string to format</span>
<a href="#l48.33"></a><span id="l48.33">  * @return              The formatted string using only chars [_a-zA-Z0-9-]</span>
<a href="#l48.34"></a><span id="l48.34">  */</span>
<a href="#l48.35"></a><span id="l48.35"> function formatStringForCSSRule(aString) {</span>
<a href="#l48.36"></a><span id="l48.36" class="difflineminus">-    function toReplacement(ch) {</span>
<a href="#l48.37"></a><span id="l48.37" class="difflineplus">+    function toReplacement(char) {</span>
<a href="#l48.38"></a><span id="l48.38">         // char code is natural number (positive integer)</span>
<a href="#l48.39"></a><span id="l48.39" class="difflineminus">-        let nat = ch.charCodeAt(0);</span>
<a href="#l48.40"></a><span id="l48.40" class="difflineplus">+        let nat = char.charCodeAt(0);</span>
<a href="#l48.41"></a><span id="l48.41">         switch (nat) {</span>
<a href="#l48.42"></a><span id="l48.42">             case 0x20: // space</span>
<a href="#l48.43"></a><span id="l48.43">                 return &quot;_&quot;;</span>
<a href="#l48.44"></a><span id="l48.44">             default:</span>
<a href="#l48.45"></a><span id="l48.45">                 return &quot;-ux&quot; + nat.toString(16) + &quot;-&quot;; // lowercase</span>
<a href="#l48.46"></a><span id="l48.46">         }</span>
<a href="#l48.47"></a><span id="l48.47">     }</span>
<a href="#l48.48"></a><span id="l48.48">     // Result must be lowercase or style rule will not work.</span>
<a href="#l48.49"></a><span id="l48.49" class="difflineat">@@ -406,18 +406,18 @@ function makeURL(aUriString) {</span>
<a href="#l48.50"></a><span id="l48.50">     return Services.io.newURI(aUriString, null, null);</span>
<a href="#l48.51"></a><span id="l48.51"> }</span>
<a href="#l48.52"></a><span id="l48.52"> </span>
<a href="#l48.53"></a><span id="l48.53"> /**</span>
<a href="#l48.54"></a><span id="l48.54">  * Returns a calIDateTime that corresponds to the current time in the user's</span>
<a href="#l48.55"></a><span id="l48.55">  * default timezone.</span>
<a href="#l48.56"></a><span id="l48.56">  */</span>
<a href="#l48.57"></a><span id="l48.57"> function now() {</span>
<a href="#l48.58"></a><span id="l48.58" class="difflineminus">-    let d = cal.jsDateToDateTime(new Date());</span>
<a href="#l48.59"></a><span id="l48.59" class="difflineminus">-    return d.getInTimezone(calendarDefaultTimezone());</span>
<a href="#l48.60"></a><span id="l48.60" class="difflineplus">+    let date = cal.jsDateToDateTime(new Date());</span>
<a href="#l48.61"></a><span id="l48.61" class="difflineplus">+    return date.getInTimezone(calendarDefaultTimezone());</span>
<a href="#l48.62"></a><span id="l48.62"> }</span>
<a href="#l48.63"></a><span id="l48.63"> </span>
<a href="#l48.64"></a><span id="l48.64"> /**</span>
<a href="#l48.65"></a><span id="l48.65">  * Selects an item with id aItemId in the radio group with id aRadioGroupId</span>
<a href="#l48.66"></a><span id="l48.66">  *</span>
<a href="#l48.67"></a><span id="l48.67">  * @param aRadioGroupId  the id of the radio group which contains the item</span>
<a href="#l48.68"></a><span id="l48.68">  * @param aItemId        the item to be selected</span>
<a href="#l48.69"></a><span id="l48.69">  */</span>
<a href="#l48.70"></a><span id="l48.70" class="difflineat">@@ -696,19 +696,19 @@ function calGetString(aBundleName, aStri</span>
<a href="#l48.71"></a><span id="l48.71">         let props = Services.strings.createBundle(propName);</span>
<a href="#l48.72"></a><span id="l48.72"> </span>
<a href="#l48.73"></a><span id="l48.73">         if (aParams &amp;&amp; aParams.length) {</span>
<a href="#l48.74"></a><span id="l48.74">             return props.formatStringFromName(aStringName, aParams, aParams.length);</span>
<a href="#l48.75"></a><span id="l48.75">         } else {</span>
<a href="#l48.76"></a><span id="l48.76">             return props.GetStringFromName(aStringName);</span>
<a href="#l48.77"></a><span id="l48.77">         }</span>
<a href="#l48.78"></a><span id="l48.78">     } catch (ex) {</span>
<a href="#l48.79"></a><span id="l48.79" class="difflineminus">-        let s = &quot;Failed to read '&quot; + aStringName + &quot;' from &quot; + propName + &quot;.&quot;;</span>
<a href="#l48.80"></a><span id="l48.80" class="difflineminus">-        Components.utils.reportError(s + &quot; Error: &quot; + ex);</span>
<a href="#l48.81"></a><span id="l48.81" class="difflineminus">-        return s;</span>
<a href="#l48.82"></a><span id="l48.82" class="difflineplus">+        let msg = &quot;Failed to read '&quot; + aStringName + &quot;' from &quot; + propName + &quot;.&quot;;</span>
<a href="#l48.83"></a><span id="l48.83" class="difflineplus">+        Components.utils.reportError(msg + &quot; Error: &quot; + ex);</span>
<a href="#l48.84"></a><span id="l48.84" class="difflineplus">+        return msg;</span>
<a href="#l48.85"></a><span id="l48.85">     }</span>
<a href="#l48.86"></a><span id="l48.86"> }</span>
<a href="#l48.87"></a><span id="l48.87"> </span>
<a href="#l48.88"></a><span id="l48.88"> /**</span>
<a href="#l48.89"></a><span id="l48.89">  * Make a UUID using the UUIDGenerator service available, we'll use that.</span>
<a href="#l48.90"></a><span id="l48.90">  */</span>
<a href="#l48.91"></a><span id="l48.91"> function getUUID() {</span>
<a href="#l48.92"></a><span id="l48.92">     let uuidGen = Components.classes[&quot;@mozilla.org/uuid-generator;1&quot;]</span>
<a href="#l48.93"></a><span id="l48.93" class="difflineat">@@ -1289,25 +1289,25 @@ function calOperationGroup(cancelFunc) {</span>
<a href="#l48.94"></a><span id="l48.94"> }</span>
<a href="#l48.95"></a><span id="l48.95"> calOperationGroup.prototype = {</span>
<a href="#l48.96"></a><span id="l48.96">     mCancelFunc: null,</span>
<a href="#l48.97"></a><span id="l48.97">     mId: null,</span>
<a href="#l48.98"></a><span id="l48.98">     mIsPending: true,</span>
<a href="#l48.99"></a><span id="l48.99">     mStatus: Components.results.NS_OK,</span>
<a href="#l48.100"></a><span id="l48.100">     mSubOperations: null,</span>
<a href="#l48.101"></a><span id="l48.101"> </span>
<a href="#l48.102"></a><span id="l48.102" class="difflineminus">-    add: function(op) {</span>
<a href="#l48.103"></a><span id="l48.103" class="difflineminus">-        if (op &amp;&amp; op.isPending) {</span>
<a href="#l48.104"></a><span id="l48.104" class="difflineminus">-            this.mSubOperations.push(op);</span>
<a href="#l48.105"></a><span id="l48.105" class="difflineplus">+    add: function(aOperation) {</span>
<a href="#l48.106"></a><span id="l48.106" class="difflineplus">+        if (aOperation &amp;&amp; aOperation.isPending) {</span>
<a href="#l48.107"></a><span id="l48.107" class="difflineplus">+            this.mSubOperations.push(aOperation);</span>
<a href="#l48.108"></a><span id="l48.108">         }</span>
<a href="#l48.109"></a><span id="l48.109">     },</span>
<a href="#l48.110"></a><span id="l48.110"> </span>
<a href="#l48.111"></a><span id="l48.111" class="difflineminus">-    remove: function(op) {</span>
<a href="#l48.112"></a><span id="l48.112" class="difflineminus">-        if (op) {</span>
<a href="#l48.113"></a><span id="l48.113" class="difflineminus">-            this.mSubOperations = this.mSubOperations.filter(op_ =&gt; op.id != op_.id);</span>
<a href="#l48.114"></a><span id="l48.114" class="difflineplus">+    remove: function(aOperation) {</span>
<a href="#l48.115"></a><span id="l48.115" class="difflineplus">+        if (aOperation) {</span>
<a href="#l48.116"></a><span id="l48.116" class="difflineplus">+            this.mSubOperations = this.mSubOperations.filter(operation =&gt; aOperation.id != operation.id);</span>
<a href="#l48.117"></a><span id="l48.117">         }</span>
<a href="#l48.118"></a><span id="l48.118">     },</span>
<a href="#l48.119"></a><span id="l48.119"> </span>
<a href="#l48.120"></a><span id="l48.120">     get isEmpty() {</span>
<a href="#l48.121"></a><span id="l48.121">         return (this.mSubOperations.length == 0);</span>
<a href="#l48.122"></a><span id="l48.122">     },</span>
<a href="#l48.123"></a><span id="l48.123"> </span>
<a href="#l48.124"></a><span id="l48.124">     notifyCompleted: function(status) {</span>
<a href="#l48.125"></a><span id="l48.125" class="difflineat">@@ -1345,18 +1345,18 @@ calOperationGroup.prototype = {</span>
<a href="#l48.126"></a><span id="l48.126">             this.notifyCompleted(status);</span>
<a href="#l48.127"></a><span id="l48.127">             let cancelFunc = this.mCancelFunc;</span>
<a href="#l48.128"></a><span id="l48.128">             if (cancelFunc) {</span>
<a href="#l48.129"></a><span id="l48.129">                 this.mCancelFunc = null;</span>
<a href="#l48.130"></a><span id="l48.130">                 cancelFunc();</span>
<a href="#l48.131"></a><span id="l48.131">             }</span>
<a href="#l48.132"></a><span id="l48.132">             let subOperations = this.mSubOperations;</span>
<a href="#l48.133"></a><span id="l48.133">             this.mSubOperations = [];</span>
<a href="#l48.134"></a><span id="l48.134" class="difflineminus">-            for (let op of subOperations) {</span>
<a href="#l48.135"></a><span id="l48.135" class="difflineminus">-                op.cancel(Components.interfaces.calIErrors.OPERATION_CANCELLED);</span>
<a href="#l48.136"></a><span id="l48.136" class="difflineplus">+            for (let operation of subOperations) {</span>
<a href="#l48.137"></a><span id="l48.137" class="difflineplus">+                operation.cancel(Components.interfaces.calIErrors.OPERATION_CANCELLED);</span>
<a href="#l48.138"></a><span id="l48.138">             }</span>
<a href="#l48.139"></a><span id="l48.139">         }</span>
<a href="#l48.140"></a><span id="l48.140">     }</span>
<a href="#l48.141"></a><span id="l48.141"> };</span>
<a href="#l48.142"></a><span id="l48.142"> </span>
<a href="#l48.143"></a><span id="l48.143"> function sameDay(date1, date2) {</span>
<a href="#l48.144"></a><span id="l48.144">     if (date1 &amp;&amp; date2) {</span>
<a href="#l48.145"></a><span id="l48.145">         if ((date1.day == date2.day) &amp;&amp;</span>
<a href="#l48.146"></a><span id="l48.146" class="difflineat">@@ -1769,20 +1769,20 @@ function compareItemContent(aFirstItem, </span>
<a href="#l48.147"></a><span id="l48.147"> function binarySearch(itemArray, newItem, comptor) {</span>
<a href="#l48.148"></a><span id="l48.148">     function binarySearchInternal(low, high) {</span>
<a href="#l48.149"></a><span id="l48.149">         // Are we done yet?</span>
<a href="#l48.150"></a><span id="l48.150">         if (low == high) {</span>
<a href="#l48.151"></a><span id="l48.151">             return low + (comptor(newItem, itemArray[low]) &lt; 0 ? 0 : 1);</span>
<a href="#l48.152"></a><span id="l48.152">         }</span>
<a href="#l48.153"></a><span id="l48.153"> </span>
<a href="#l48.154"></a><span id="l48.154">         let mid = Math.floor(low + ((high - low) / 2));</span>
<a href="#l48.155"></a><span id="l48.155" class="difflineminus">-        let q = comptor(newItem, itemArray[mid]);</span>
<a href="#l48.156"></a><span id="l48.156" class="difflineminus">-        if (q &gt; 0) {</span>
<a href="#l48.157"></a><span id="l48.157" class="difflineplus">+        let cmp = comptor(newItem, itemArray[mid]);</span>
<a href="#l48.158"></a><span id="l48.158" class="difflineplus">+        if (cmp &gt; 0) {</span>
<a href="#l48.159"></a><span id="l48.159">             return binarySearchInternal(mid + 1, high);</span>
<a href="#l48.160"></a><span id="l48.160" class="difflineminus">-        } else if (q &lt; 0) {</span>
<a href="#l48.161"></a><span id="l48.161" class="difflineplus">+        } else if (cmp &lt; 0) {</span>
<a href="#l48.162"></a><span id="l48.162">             return binarySearchInternal(low, mid);</span>
<a href="#l48.163"></a><span id="l48.163">         } else {</span>
<a href="#l48.164"></a><span id="l48.164">             return mid;</span>
<a href="#l48.165"></a><span id="l48.165">         }</span>
<a href="#l48.166"></a><span id="l48.166">     }</span>
<a href="#l48.167"></a><span id="l48.167"> </span>
<a href="#l48.168"></a><span id="l48.168">     if (itemArray.length &lt; 1) {</span>
<a href="#l48.169"></a><span id="l48.169">         return -1;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l49.1"></a><span id="l49.1" class="difflineminus">--- a/calendar/import-export/calOutlookCSVImportExport.js</span>
<a href="#l49.2"></a><span id="l49.2" class="difflineplus">+++ b/calendar/import-export/calOutlookCSVImportExport.js</span>
<a href="#l49.3"></a><span id="l49.3" class="difflineat">@@ -363,50 +363,50 @@ calOutlookCSVImporter.prototype = {</span>
<a href="#l49.4"></a><span id="l49.4">         } while (eventRegExp.lastIndex != 0);</span>
<a href="#l49.5"></a><span id="l49.5"> </span>
<a href="#l49.6"></a><span id="l49.6">         // return results</span>
<a href="#l49.7"></a><span id="l49.7">         aCount.value = eventArray.length;</span>
<a href="#l49.8"></a><span id="l49.8">         return eventArray;</span>
<a href="#l49.9"></a><span id="l49.9">     },</span>
<a href="#l49.10"></a><span id="l49.10"> </span>
<a href="#l49.11"></a><span id="l49.11">     parseDateTime: function(aDate, aTime, aLocale) {</span>
<a href="#l49.12"></a><span id="l49.12" class="difflineminus">-        let dt = cal.createDateTime();</span>
<a href="#l49.13"></a><span id="l49.13" class="difflineplus">+        let date = cal.createDateTime();</span>
<a href="#l49.14"></a><span id="l49.14"> </span>
<a href="#l49.15"></a><span id="l49.15">         // XXX Can we do better?</span>
<a href="#l49.16"></a><span id="l49.16" class="difflineminus">-        dt.timezone = cal.floating();</span>
<a href="#l49.17"></a><span id="l49.17" class="difflineplus">+        date.timezone = cal.floating();</span>
<a href="#l49.18"></a><span id="l49.18"> </span>
<a href="#l49.19"></a><span id="l49.19" class="difflineminus">-        let rd = aLocale.dateRe.exec(aDate);</span>
<a href="#l49.20"></a><span id="l49.20" class="difflineminus">-        let rt = aLocale.timeRe.exec(aTime);</span>
<a href="#l49.21"></a><span id="l49.21" class="difflineplus">+        let datepart = aLocale.dateRe.exec(aDate);</span>
<a href="#l49.22"></a><span id="l49.22" class="difflineplus">+        let timepart = aLocale.timeRe.exec(aTime);</span>
<a href="#l49.23"></a><span id="l49.23"> </span>
<a href="#l49.24"></a><span id="l49.24" class="difflineminus">-        if (!rd || !rt) {</span>
<a href="#l49.25"></a><span id="l49.25" class="difflineplus">+        if (!datepart || !timepart) {</span>
<a href="#l49.26"></a><span id="l49.26">             return null;</span>
<a href="#l49.27"></a><span id="l49.27">         }</span>
<a href="#l49.28"></a><span id="l49.28"> </span>
<a href="#l49.29"></a><span id="l49.29" class="difflineminus">-        dt.year = rd[aLocale.dateYearIndex];</span>
<a href="#l49.30"></a><span id="l49.30" class="difflineminus">-        dt.month = rd[aLocale.dateMonthIndex] - 1;</span>
<a href="#l49.31"></a><span id="l49.31" class="difflineminus">-        dt.day = rd[aLocale.dateDayIndex];</span>
<a href="#l49.32"></a><span id="l49.32" class="difflineminus">-        if (rt) {</span>
<a href="#l49.33"></a><span id="l49.33" class="difflineminus">-            dt.hour = Number(rt[aLocale.timeHourIndex]);</span>
<a href="#l49.34"></a><span id="l49.34" class="difflineminus">-            dt.minute = rt[aLocale.timeMinuteIndex];</span>
<a href="#l49.35"></a><span id="l49.35" class="difflineminus">-            dt.second = rt[aLocale.timeSecondIndex];</span>
<a href="#l49.36"></a><span id="l49.36" class="difflineplus">+        date.year = datepart[aLocale.dateYearIndex];</span>
<a href="#l49.37"></a><span id="l49.37" class="difflineplus">+        date.month = datepart[aLocale.dateMonthIndex] - 1;</span>
<a href="#l49.38"></a><span id="l49.38" class="difflineplus">+        date.day = datepart[aLocale.dateDayIndex];</span>
<a href="#l49.39"></a><span id="l49.39" class="difflineplus">+        if (timepart) {</span>
<a href="#l49.40"></a><span id="l49.40" class="difflineplus">+            date.hour = Number(timepart[aLocale.timeHourIndex]);</span>
<a href="#l49.41"></a><span id="l49.41" class="difflineplus">+            date.minute = timepart[aLocale.timeMinuteIndex];</span>
<a href="#l49.42"></a><span id="l49.42" class="difflineplus">+            date.second = timepart[aLocale.timeSecondIndex];</span>
<a href="#l49.43"></a><span id="l49.43">         } else {</span>
<a href="#l49.44"></a><span id="l49.44" class="difflineminus">-            dt.isDate = true;</span>
<a href="#l49.45"></a><span id="l49.45" class="difflineplus">+            date.isDate = true;</span>
<a href="#l49.46"></a><span id="l49.46">         }</span>
<a href="#l49.47"></a><span id="l49.47"> </span>
<a href="#l49.48"></a><span id="l49.48" class="difflineminus">-        if (rt &amp;&amp; aLocale.timeAmPmIndex &amp;&amp;</span>
<a href="#l49.49"></a><span id="l49.49" class="difflineminus">-            rt[aLocale.timeAmPmIndex] != aLocale.timePmString) {</span>
<a href="#l49.50"></a><span id="l49.50" class="difflineplus">+        if (timepart &amp;&amp; aLocale.timeAmPmIndex &amp;&amp;</span>
<a href="#l49.51"></a><span id="l49.51" class="difflineplus">+            timepart[aLocale.timeAmPmIndex] != aLocale.timePmString) {</span>
<a href="#l49.52"></a><span id="l49.52">             // AM</span>
<a href="#l49.53"></a><span id="l49.53" class="difflineminus">-            if (dt.hour == 12) {</span>
<a href="#l49.54"></a><span id="l49.54" class="difflineminus">-                dt.hour = 0;</span>
<a href="#l49.55"></a><span id="l49.55" class="difflineplus">+            if (date.hour == 12) {</span>
<a href="#l49.56"></a><span id="l49.56" class="difflineplus">+                date.hour = 0;</span>
<a href="#l49.57"></a><span id="l49.57">             }</span>
<a href="#l49.58"></a><span id="l49.58" class="difflineminus">-        } else if (dt.hour &lt; 12) {</span>
<a href="#l49.59"></a><span id="l49.59" class="difflineplus">+        } else if (date.hour &lt; 12) {</span>
<a href="#l49.60"></a><span id="l49.60">            // PM</span>
<a href="#l49.61"></a><span id="l49.61" class="difflineminus">-           dt.hour += 12;</span>
<a href="#l49.62"></a><span id="l49.62" class="difflineplus">+           date.hour += 12;</span>
<a href="#l49.63"></a><span id="l49.63">         }</span>
<a href="#l49.64"></a><span id="l49.64" class="difflineminus">-        return dt;</span>
<a href="#l49.65"></a><span id="l49.65" class="difflineplus">+        return date;</span>
<a href="#l49.66"></a><span id="l49.66">     },</span>
<a href="#l49.67"></a><span id="l49.67"> </span>
<a href="#l49.68"></a><span id="l49.68">     parseTextField: function(aTextField) {</span>
<a href="#l49.69"></a><span id="l49.69">         return aTextField ? aTextField.replace(/&quot;&quot;/g, &quot;\&quot;&quot;) : &quot;&quot;;</span>
<a href="#l49.70"></a><span id="l49.70">     }</span>
<a href="#l49.71"></a><span id="l49.71"> };</span>
<a href="#l49.72"></a><span id="l49.72"> </span>
<a href="#l49.73"></a><span id="l49.73"> // Exporter</span>
<a href="#l49.74"></a><span id="l49.74" class="difflineat">@@ -444,17 +444,17 @@ calOutlookCSVExporter.prototype = {</span>
<a href="#l49.75"></a><span id="l49.75">         headers.push(localeEn.headAllDayEvent);</span>
<a href="#l49.76"></a><span id="l49.76">         headers.push(localeEn.headAlarm);</span>
<a href="#l49.77"></a><span id="l49.77">         headers.push(localeEn.headAlarmDate);</span>
<a href="#l49.78"></a><span id="l49.78">         headers.push(localeEn.headAlarmTime);</span>
<a href="#l49.79"></a><span id="l49.79">         headers.push(localeEn.headCategories);</span>
<a href="#l49.80"></a><span id="l49.80">         headers.push(localeEn.headDescription);</span>
<a href="#l49.81"></a><span id="l49.81">         headers.push(localeEn.headLocation);</span>
<a href="#l49.82"></a><span id="l49.82">         headers.push(localeEn.headPrivate);</span>
<a href="#l49.83"></a><span id="l49.83" class="difflineminus">-        headers = headers.map(v =&gt; '&quot;' + v + '&quot;');</span>
<a href="#l49.84"></a><span id="l49.84" class="difflineplus">+        headers = headers.map(hdr =&gt; '&quot;' + hdr + '&quot;');</span>
<a href="#l49.85"></a><span id="l49.85">         str = headers.join(&quot;,&quot;);</span>
<a href="#l49.86"></a><span id="l49.86">         str += exportLineEnding;</span>
<a href="#l49.87"></a><span id="l49.87">         aStream.write(str, str.length);</span>
<a href="#l49.88"></a><span id="l49.88"> </span>
<a href="#l49.89"></a><span id="l49.89">         for (let item of aItems) {</span>
<a href="#l49.90"></a><span id="l49.90">             if (!cal.isEvent(item)) {</span>
<a href="#l49.91"></a><span id="l49.91">                 // XXX TODO: warn the user (once) that tasks are not supported</span>
<a href="#l49.92"></a><span id="l49.92">                 // (bug 336175)</span>
<a href="#l49.93"></a><span id="l49.93" class="difflineat">@@ -475,14 +475,14 @@ calOutlookCSVExporter.prototype = {</span>
<a href="#l49.94"></a><span id="l49.94">             line.push(alarmDate ? localeEn.valueTrue : localeEn.valueFalse);</span>
<a href="#l49.95"></a><span id="l49.95">             line.push(alarmDate ? dateString(alarmDate) : &quot;&quot;);</span>
<a href="#l49.96"></a><span id="l49.96">             line.push(alarmDate ? timeString(alarmDate) : &quot;&quot;);</span>
<a href="#l49.97"></a><span id="l49.97">             line.push(txtString(cal.categoriesArrayToString(item.getCategories({})))); // xxx todo: what's the correct way to encode ',' in csv?, how are multi-values expressed?</span>
<a href="#l49.98"></a><span id="l49.98">             line.push(txtString(item.getProperty(&quot;DESCRIPTION&quot;)));</span>
<a href="#l49.99"></a><span id="l49.99">             line.push(txtString(item.getProperty(&quot;LOCATION&quot;)));</span>
<a href="#l49.100"></a><span id="l49.100">             line.push(item.privacy == &quot;PRIVATE&quot; ? localeEn.valueTrue : localeEn.valueFalse);</span>
<a href="#l49.101"></a><span id="l49.101"> </span>
<a href="#l49.102"></a><span id="l49.102" class="difflineminus">-            line = line.map(v =&gt; `&quot;${String(v).replace(/&quot;/g, '&quot;&quot;')}&quot;`);</span>
<a href="#l49.103"></a><span id="l49.103" class="difflineplus">+            line = line.map(value =&gt; `&quot;${String(value).replace(/&quot;/g, '&quot;&quot;')}&quot;`);</span>
<a href="#l49.104"></a><span id="l49.104">             str = line.join(&quot;,&quot;) + exportLineEnding;</span>
<a href="#l49.105"></a><span id="l49.105">             aStream.write(str, str.length);</span>
<a href="#l49.106"></a><span id="l49.106">         }</span>
<a href="#l49.107"></a><span id="l49.107">     }</span>
<a href="#l49.108"></a><span id="l49.108"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l50.1"></a><span id="l50.1" class="difflineminus">--- a/calendar/itip/calItipEmailTransport.js</span>
<a href="#l50.2"></a><span id="l50.2" class="difflineplus">+++ b/calendar/itip/calItipEmailTransport.js</span>
<a href="#l50.3"></a><span id="l50.3" class="difflineat">@@ -252,17 +252,17 @@ calItipEmailTransport.prototype = {</span>
<a href="#l50.4"></a><span id="l50.4">                 }</span>
<a href="#l50.5"></a><span id="l50.5">                 let cbEmail = function(aVal, aInd, aArr) {</span>
<a href="#l50.6"></a><span id="l50.6">                     let email = cal.getAttendeeEmail(aVal, true);</span>
<a href="#l50.7"></a><span id="l50.7">                     if (!email.length) {</span>
<a href="#l50.8"></a><span id="l50.8">                         cal.LOG(&quot;Invalid recipient for email transport: &quot; + aVal.toString());</span>
<a href="#l50.9"></a><span id="l50.9">                     }</span>
<a href="#l50.10"></a><span id="l50.10">                     return email;</span>
<a href="#l50.11"></a><span id="l50.11">                 };</span>
<a href="#l50.12"></a><span id="l50.12" class="difflineminus">-                let toMap = aToList.map(cbEmail).filter(v =&gt; v.length);</span>
<a href="#l50.13"></a><span id="l50.13" class="difflineplus">+                let toMap = aToList.map(cbEmail).filter(value =&gt; value.length);</span>
<a href="#l50.14"></a><span id="l50.14">                 if (toMap.length &lt; aToList.length) {</span>
<a href="#l50.15"></a><span id="l50.15">                     // at least one invalid recipient, so we skip sending for this message</span>
<a href="#l50.16"></a><span id="l50.16">                     return false;</span>
<a href="#l50.17"></a><span id="l50.17">                 }</span>
<a href="#l50.18"></a><span id="l50.18">                 let toList = toMap.join(&quot;, &quot;);</span>
<a href="#l50.19"></a><span id="l50.19">                 let composeUtils = Components.classes[&quot;@mozilla.org/messengercompose/computils;1&quot;]</span>
<a href="#l50.20"></a><span id="l50.20">                                              .createInstance(Components.interfaces.nsIMsgCompUtils);</span>
<a href="#l50.21"></a><span id="l50.21">                 let messageId = composeUtils.msgGenerateMessageId(identity);</span>
<a href="#l50.22"></a><span id="l50.22" class="difflineat">@@ -277,16 +277,17 @@ calItipEmailTransport.prototype = {</span>
<a href="#l50.23"></a><span id="l50.23">                     composeFields.from = (cal.validateRecipientList(mailfrom) == mailfrom ? mailfrom : identity.email);</span>
<a href="#l50.24"></a><span id="l50.24">                     composeFields.replyTo = identity.replyTo;</span>
<a href="#l50.25"></a><span id="l50.25">                     composeFields.organization = identity.organization;</span>
<a href="#l50.26"></a><span id="l50.26">                     composeFields.messageId = messageId;</span>
<a href="#l50.27"></a><span id="l50.27">                     let validRecipients;</span>
<a href="#l50.28"></a><span id="l50.28">                     if (identity.doCc) {</span>
<a href="#l50.29"></a><span id="l50.29">                         validRecipients = cal.validateRecipientList(identity.doCcList);</span>
<a href="#l50.30"></a><span id="l50.30">                         if (validRecipients != &quot;&quot;) {</span>
<a href="#l50.31"></a><span id="l50.31" class="difflineplus">+                            // eslint-disable-next-line id-length</span>
<a href="#l50.32"></a><span id="l50.32">                             composeFields.cc = validRecipients;</span>
<a href="#l50.33"></a><span id="l50.33">                         }</span>
<a href="#l50.34"></a><span id="l50.34">                     }</span>
<a href="#l50.35"></a><span id="l50.35">                     if (identity.doBcc) {</span>
<a href="#l50.36"></a><span id="l50.36">                         validRecipients = cal.validateRecipientList(identity.doBccList);</span>
<a href="#l50.37"></a><span id="l50.37">                         if (validRecipients != &quot;&quot;) {</span>
<a href="#l50.38"></a><span id="l50.38">                             composeFields.bcc = validRecipients;</span>
<a href="#l50.39"></a><span id="l50.39">                         }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l51.1"></a><span id="l51.1" class="difflineminus">--- a/calendar/lightning/components/calItipProtocolHandler.js</span>
<a href="#l51.2"></a><span id="l51.2" class="difflineplus">+++ b/calendar/lightning/components/calItipProtocolHandler.js</span>
<a href="#l51.3"></a><span id="l51.3" class="difflineat">@@ -1,16 +1,16 @@</span>
<a href="#l51.4"></a><span id="l51.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l51.5"></a><span id="l51.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l51.6"></a><span id="l51.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l51.7"></a><span id="l51.7"> </span>
<a href="#l51.8"></a><span id="l51.8"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l51.9"></a><span id="l51.9"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l51.10"></a><span id="l51.10"> </span>
<a href="#l51.11"></a><span id="l51.11" class="difflineminus">-var CI = Components.interfaces;</span>
<a href="#l51.12"></a><span id="l51.12" class="difflineplus">+var Ci = Components.interfaces;</span>
<a href="#l51.13"></a><span id="l51.13"> </span>
<a href="#l51.14"></a><span id="l51.14"> var ITIP_HANDLER_MIMETYPE = &quot;application/x-itip-internal&quot;;</span>
<a href="#l51.15"></a><span id="l51.15"> var ITIP_HANDLER_PROTOCOL = &quot;moz-cal-handle-itip&quot;;</span>
<a href="#l51.16"></a><span id="l51.16"> var NS_ERROR_WONT_HANDLE_CONTENT = 0x805d0001;</span>
<a href="#l51.17"></a><span id="l51.17"> </span>
<a href="#l51.18"></a><span id="l51.18"> </span>
<a href="#l51.19"></a><span id="l51.19"> function NYI() {</span>
<a href="#l51.20"></a><span id="l51.20">     throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l51.21"></a><span id="l51.21" class="difflineat">@@ -67,25 +67,25 @@ ItipProtocolHandler.prototype = {</span>
<a href="#l51.22"></a><span id="l51.22">     QueryInterface: XPCOMUtils.generateQI(ItipProtocolHandlerInterfaces),</span>
<a href="#l51.23"></a><span id="l51.23">     classInfo: XPCOMUtils.generateCI({</span>
<a href="#l51.24"></a><span id="l51.24">         classID: ItipProtocolHandlerClassID,</span>
<a href="#l51.25"></a><span id="l51.25">         contractID: &quot;@mozilla.org/network/protocol;1?name=&quot; + ITIP_HANDLER_PROTOCOL,</span>
<a href="#l51.26"></a><span id="l51.26">         classDescription: &quot;iTIP Protocol Handler&quot;,</span>
<a href="#l51.27"></a><span id="l51.27">         interfaces: ItipProtocolHandlerInterfaces</span>
<a href="#l51.28"></a><span id="l51.28">     }),</span>
<a href="#l51.29"></a><span id="l51.29"> </span>
<a href="#l51.30"></a><span id="l51.30" class="difflineminus">-    protocolFlags: CI.nsIProtocolHandler.URI_NORELATIVE | CI.nsIProtocolHandler.URI_DANGEROUS_TO_LOAD,</span>
<a href="#l51.31"></a><span id="l51.31" class="difflineplus">+    protocolFlags: Ci.nsIProtocolHandler.URI_NORELATIVE | Ci.nsIProtocolHandler.URI_DANGEROUS_TO_LOAD,</span>
<a href="#l51.32"></a><span id="l51.32">     allowPort: () =&gt; false,</span>
<a href="#l51.33"></a><span id="l51.33">     isSecure: false,</span>
<a href="#l51.34"></a><span id="l51.34">     newURI: function(spec, charSet, baseURI) {</span>
<a href="#l51.35"></a><span id="l51.35">         let cls = Components.classes[&quot;@mozilla.org/network/standard-url;1&quot;];</span>
<a href="#l51.36"></a><span id="l51.36" class="difflineminus">-        let url = cls.createInstance(CI.nsIStandardURL);</span>
<a href="#l51.37"></a><span id="l51.37" class="difflineminus">-        url.init(CI.nsIStandardURL.URLTYPE_STANDARD, 0, spec, charSet, baseURI);</span>
<a href="#l51.38"></a><span id="l51.38" class="difflineplus">+        let url = cls.createInstance(Ci.nsIStandardURL);</span>
<a href="#l51.39"></a><span id="l51.39" class="difflineplus">+        url.init(Ci.nsIStandardURL.URLTYPE_STANDARD, 0, spec, charSet, baseURI);</span>
<a href="#l51.40"></a><span id="l51.40">         dump(&quot;Creating new URI for &quot; + spec + &quot;\n&quot;);</span>
<a href="#l51.41"></a><span id="l51.41" class="difflineminus">-        return url.QueryInterface(CI.nsIURI);</span>
<a href="#l51.42"></a><span id="l51.42" class="difflineplus">+        return url.QueryInterface(Ci.nsIURI);</span>
<a href="#l51.43"></a><span id="l51.43">     },</span>
<a href="#l51.44"></a><span id="l51.44"> </span>
<a href="#l51.45"></a><span id="l51.45">     newChannel: function(URI) {</span>
<a href="#l51.46"></a><span id="l51.46">         return this.newChannel2(URI, null);</span>
<a href="#l51.47"></a><span id="l51.47">     },</span>
<a href="#l51.48"></a><span id="l51.48"> </span>
<a href="#l51.49"></a><span id="l51.49">     newChannel2: function(URI, aLoadInfo) {</span>
<a href="#l51.50"></a><span id="l51.50">         dump(&quot;Creating new ItipChannel for &quot; + URI + &quot;\n&quot;);</span>
<a href="#l51.51"></a><span id="l51.51" class="difflineat">@@ -104,28 +104,28 @@ ItipContentHandler.prototype = {</span>
<a href="#l51.52"></a><span id="l51.52">     classInfo: XPCOMUtils.generateCI({</span>
<a href="#l51.53"></a><span id="l51.53">         classID: ItipContentHandlerClassID,</span>
<a href="#l51.54"></a><span id="l51.54">         contractID: &quot;@mozilla.org/uriloader/content-handler;1?type=&quot; + ITIP_HANDLER_MIMETYPE,</span>
<a href="#l51.55"></a><span id="l51.55">         classDescription: &quot;Lightning text/calendar content handler&quot;,</span>
<a href="#l51.56"></a><span id="l51.56">         interfaces: ItipContentHandlerInterfaces</span>
<a href="#l51.57"></a><span id="l51.57">     }),</span>
<a href="#l51.58"></a><span id="l51.58"> </span>
<a href="#l51.59"></a><span id="l51.59">     handleContent: function(contentType, windowTarget, request) {</span>
<a href="#l51.60"></a><span id="l51.60" class="difflineminus">-        let channel = request.QueryInterface(CI.nsIChannel);</span>
<a href="#l51.61"></a><span id="l51.61" class="difflineplus">+        let channel = request.QueryInterface(Ci.nsIChannel);</span>
<a href="#l51.62"></a><span id="l51.62">         let uri = channel.URI.spec;</span>
<a href="#l51.63"></a><span id="l51.63">         if (!uri.startsWith(ITIP_HANDLER_PROTOCOL + &quot;:&quot;)) {</span>
<a href="#l51.64"></a><span id="l51.64">             cal.ERROR(&quot;Unexpected iTIP uri: &quot; + uri + &quot;\n&quot;);</span>
<a href="#l51.65"></a><span id="l51.65">             throw NS_ERROR_WONT_HANDLE_CONTENT;</span>
<a href="#l51.66"></a><span id="l51.66">         }</span>
<a href="#l51.67"></a><span id="l51.67">         // moz-cal-handle-itip:///?</span>
<a href="#l51.68"></a><span id="l51.68">         let paramString = uri.substring(ITIP_HANDLER_PROTOCOL.length + 4);</span>
<a href="#l51.69"></a><span id="l51.69">         let paramArray = paramString.split(&quot;&amp;&quot;);</span>
<a href="#l51.70"></a><span id="l51.70">         let paramBlock = { };</span>
<a href="#l51.71"></a><span id="l51.71" class="difflineminus">-        paramArray.forEach((v) =&gt; {</span>
<a href="#l51.72"></a><span id="l51.72" class="difflineminus">-            let parts = v.split(&quot;=&quot;);</span>
<a href="#l51.73"></a><span id="l51.73" class="difflineplus">+        paramArray.forEach((value) =&gt; {</span>
<a href="#l51.74"></a><span id="l51.74" class="difflineplus">+            let parts = value.split(&quot;=&quot;);</span>
<a href="#l51.75"></a><span id="l51.75">             paramBlock[parts[0]] = unescape(unescape(parts[1]));</span>
<a href="#l51.76"></a><span id="l51.76">         });</span>
<a href="#l51.77"></a><span id="l51.77">         // dump(&quot;content-handler: have params &quot; + paramBlock.toSource() + &quot;\n&quot;);</span>
<a href="#l51.78"></a><span id="l51.78">         let event = cal.createEvent(paramBlock.data);</span>
<a href="#l51.79"></a><span id="l51.79">         dump(&quot;Processing iTIP event '&quot; + event.title + &quot;' from &quot; +</span>
<a href="#l51.80"></a><span id="l51.80">             event.organizer.id + &quot; (&quot; + event.id + &quot;)\n&quot;);</span>
<a href="#l51.81"></a><span id="l51.81">         let calMgr = cal.getCalendarManager();</span>
<a href="#l51.82"></a><span id="l51.82">         let cals = calMgr.getCalendars({});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l52.1"></a><span id="l52.1" class="difflineminus">--- a/calendar/lightning/content/html-item-editing/react-code.js</span>
<a href="#l52.2"></a><span id="l52.2" class="difflineplus">+++ b/calendar/lightning/content/html-item-editing/react-code.js</span>
<a href="#l52.3"></a><span id="l52.3" class="difflineat">@@ -249,19 +249,19 @@ var TopComponent = React.createClass({</span>
<a href="#l52.4"></a><span id="l52.4">             categoriesList: this.props.initialCategoriesList,</span>
<a href="#l52.5"></a><span id="l52.5">             attachments: this.props.initialAttachments,</span>
<a href="#l52.6"></a><span id="l52.6"> </span>
<a href="#l52.7"></a><span id="l52.7">             isWideview: (window.innerWidth &gt; 750),</span>
<a href="#l52.8"></a><span id="l52.8">             activeTab: 0</span>
<a href="#l52.9"></a><span id="l52.9">         };</span>
<a href="#l52.10"></a><span id="l52.10">     },</span>
<a href="#l52.11"></a><span id="l52.11">     updateWideview: function() {</span>
<a href="#l52.12"></a><span id="l52.12" class="difflineminus">-        let wv = (window.innerWidth &gt; 750);</span>
<a href="#l52.13"></a><span id="l52.13" class="difflineminus">-        if (wv != this.state.isWideview) {</span>
<a href="#l52.14"></a><span id="l52.14" class="difflineminus">-            this.setState({ isWideview: wv });</span>
<a href="#l52.15"></a><span id="l52.15" class="difflineplus">+        let wideview = (window.innerWidth &gt; 750);</span>
<a href="#l52.16"></a><span id="l52.16" class="difflineplus">+        if (wideview != this.state.isWideview) {</span>
<a href="#l52.17"></a><span id="l52.17" class="difflineplus">+            this.setState({ isWideview: wideview });</span>
<a href="#l52.18"></a><span id="l52.18">         }</span>
<a href="#l52.19"></a><span id="l52.19">     },</span>
<a href="#l52.20"></a><span id="l52.20">     componentWillMount: function() {</span>
<a href="#l52.21"></a><span id="l52.21">         this.updateWideview();</span>
<a href="#l52.22"></a><span id="l52.22">     },</span>
<a href="#l52.23"></a><span id="l52.23">     componentDidMount: function() {</span>
<a href="#l52.24"></a><span id="l52.24">         window.addEventListener(&quot;resize&quot;, this.updateWideview);</span>
<a href="#l52.25"></a><span id="l52.25">     },</span>
<a href="#l52.26"></a><span id="l52.26" class="difflineat">@@ -281,17 +281,17 @@ var TopComponent = React.createClass({</span>
<a href="#l52.27"></a><span id="l52.27">     handleSimpleChange: function(aKey, aValue) {</span>
<a href="#l52.28"></a><span id="l52.28">         let obj = {};</span>
<a href="#l52.29"></a><span id="l52.29">         obj[aKey] = aValue;</span>
<a href="#l52.30"></a><span id="l52.30">         this.setState(obj);</span>
<a href="#l52.31"></a><span id="l52.31">     },</span>
<a href="#l52.32"></a><span id="l52.32">     handleShowTimeAsChange: function(aKey, aValue) {</span>
<a href="#l52.33"></a><span id="l52.33">         // convert from true/false to OPAQUE/TRANSPARENT</span>
<a href="#l52.34"></a><span id="l52.34">         let list = this.props.showTimeAsList;</span>
<a href="#l52.35"></a><span id="l52.35" class="difflineminus">-        let index = list.findIndex((t) =&gt; (t[1] == aValue));</span>
<a href="#l52.36"></a><span id="l52.36" class="difflineplus">+        let index = list.findIndex(i =&gt; (i[1] == aValue));</span>
<a href="#l52.37"></a><span id="l52.37">         let newValue = list[index][0];</span>
<a href="#l52.38"></a><span id="l52.38">         this.handleSimpleChange(aKey, newValue);</span>
<a href="#l52.39"></a><span id="l52.39">     },</span>
<a href="#l52.40"></a><span id="l52.40">     linkClicked: function(aValue) {</span>
<a href="#l52.41"></a><span id="l52.41"> </span>
<a href="#l52.42"></a><span id="l52.42">     },</span>
<a href="#l52.43"></a><span id="l52.43">     onDeleteCapsule: function(aKey, aValue) {</span>
<a href="#l52.44"></a><span id="l52.44">         let a = this.state[aKey];</span>
<a href="#l52.45"></a><span id="l52.45" class="difflineat">@@ -475,18 +475,17 @@ var TopComponent = React.createClass({</span>
<a href="#l52.46"></a><span id="l52.46">                 keyprop: &quot;priority&quot;,</span>
<a href="#l52.47"></a><span id="l52.47">                 value: this.state.priority,</span>
<a href="#l52.48"></a><span id="l52.48">                 options: this.props.priorityList,</span>
<a href="#l52.49"></a><span id="l52.49">                 onInput: this.handleSimpleChange,</span>
<a href="#l52.50"></a><span id="l52.50">                 disabled: !this.props.supportsPriority</span>
<a href="#l52.51"></a><span id="l52.51">             })</span>
<a href="#l52.52"></a><span id="l52.52">         );</span>
<a href="#l52.53"></a><span id="l52.53"> </span>
<a href="#l52.54"></a><span id="l52.54" class="difflineminus">-        let tIndex = this.props.showTimeAsList.findIndex(</span>
<a href="#l52.55"></a><span id="l52.55" class="difflineminus">-            (t) =&gt; (t[0] == this.state.showTimeAs));</span>
<a href="#l52.56"></a><span id="l52.56" class="difflineplus">+        let tIndex = this.props.showTimeAsList.findIndex(i =&gt; (i[0] == this.state.showTimeAs));</span>
<a href="#l52.57"></a><span id="l52.57">         let showTimeAsDiv = React.DOM.div(</span>
<a href="#l52.58"></a><span id="l52.58">             { id: &quot;showTimeAsDiv&quot;, className: &quot;box&quot; },</span>
<a href="#l52.59"></a><span id="l52.59">             React.createElement(Checkbox, {</span>
<a href="#l52.60"></a><span id="l52.60">                 keyprop: &quot;showTimeAs&quot;,</span>
<a href="#l52.61"></a><span id="l52.61">                 checked: (tIndex == -1 ? false : this.props.showTimeAsList[tIndex][1]),</span>
<a href="#l52.62"></a><span id="l52.62">                 onInput: this.handleShowTimeAsChange,</span>
<a href="#l52.63"></a><span id="l52.63">                 options: this.props.showTimeAsList</span>
<a href="#l52.64"></a><span id="l52.64">             }),</span>
<a href="#l52.65"></a><span id="l52.65" class="difflineat">@@ -540,17 +539,17 @@ var TopComponent = React.createClass({</span>
<a href="#l52.66"></a><span id="l52.66">                     statusDiv,</span>
<a href="#l52.67"></a><span id="l52.67">                     priorityDiv,</span>
<a href="#l52.68"></a><span id="l52.68">                     showTimeAsDiv</span>
<a href="#l52.69"></a><span id="l52.69">                 ),</span>
<a href="#l52.70"></a><span id="l52.70">                 remindersDiv,</span>
<a href="#l52.71"></a><span id="l52.71">                 attachmentsDiv,</span>
<a href="#l52.72"></a><span id="l52.72">                 attendeesDiv</span>
<a href="#l52.73"></a><span id="l52.73">             ];</span>
<a href="#l52.74"></a><span id="l52.74" class="difflineminus">-            let tabpanels = this.props.tabs.map((m, index) =&gt; {</span>
<a href="#l52.75"></a><span id="l52.75" class="difflineplus">+            let tabpanels = this.props.tabs.map((elem, index) =&gt; {</span>
<a href="#l52.76"></a><span id="l52.76">                 return React.DOM.div({</span>
<a href="#l52.77"></a><span id="l52.77">                         className: &quot;box tabpanel &quot; + (this.state.activeTab == index ? &quot;&quot; : &quot;hidden&quot;),</span>
<a href="#l52.78"></a><span id="l52.78">                         key: &quot;tabpanelkey &quot; + index</span>
<a href="#l52.79"></a><span id="l52.79">                     },</span>
<a href="#l52.80"></a><span id="l52.80">                     tabpanelChildren[index]</span>
<a href="#l52.81"></a><span id="l52.81">                 );</span>
<a href="#l52.82"></a><span id="l52.82">             });</span>
<a href="#l52.83"></a><span id="l52.83">             return React.DOM.div({ id: &quot;topwrapper&quot; },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l53.1"></a><span id="l53.1" class="difflineminus">--- a/calendar/lightning/content/imip-bar.js</span>
<a href="#l53.2"></a><span id="l53.2" class="difflineplus">+++ b/calendar/lightning/content/imip-bar.js</span>
<a href="#l53.3"></a><span id="l53.3" class="difflineat">@@ -122,25 +122,19 @@ var ltnImipBar = {</span>
<a href="#l53.4"></a><span id="l53.4">         buttons.forEach(hideElement);</span>
<a href="#l53.5"></a><span id="l53.5">         buttons.forEach(aButton =&gt; ltnImipBar.getMenuItems(aButton).forEach(showElement));</span>
<a href="#l53.6"></a><span id="l53.6">     },</span>
<a href="#l53.7"></a><span id="l53.7"> </span>
<a href="#l53.8"></a><span id="l53.8">     /**</span>
<a href="#l53.9"></a><span id="l53.9">      * Provides a list of all available buttons</span>
<a href="#l53.10"></a><span id="l53.10">      */</span>
<a href="#l53.11"></a><span id="l53.11">     getButtons: function() {</span>
<a href="#l53.12"></a><span id="l53.12" class="difflineminus">-        let buttons = [];</span>
<a href="#l53.13"></a><span id="l53.13" class="difflineminus">-        let nl = document.getElementById(&quot;imip-view-toolbar&quot;)</span>
<a href="#l53.14"></a><span id="l53.14" class="difflineminus">-                         .getElementsByTagName(&quot;toolbarbutton&quot;);</span>
<a href="#l53.15"></a><span id="l53.15" class="difflineminus">-        if (nl != null &amp;&amp; nl.length &gt; 0) {</span>
<a href="#l53.16"></a><span id="l53.16" class="difflineminus">-            for (let button of nl) {</span>
<a href="#l53.17"></a><span id="l53.17" class="difflineminus">-                buttons.push(button);</span>
<a href="#l53.18"></a><span id="l53.18" class="difflineminus">-            }</span>
<a href="#l53.19"></a><span id="l53.19" class="difflineminus">-        }</span>
<a href="#l53.20"></a><span id="l53.20" class="difflineminus">-        return buttons;</span>
<a href="#l53.21"></a><span id="l53.21" class="difflineplus">+        let toolbarbuttons = document.getElementById(&quot;imip-view-toolbar&quot;)</span>
<a href="#l53.22"></a><span id="l53.22" class="difflineplus">+                                     .getElementsByTagName(&quot;toolbarbutton&quot;);</span>
<a href="#l53.23"></a><span id="l53.23" class="difflineplus">+        return Array.from(toolbarbuttons);</span>
<a href="#l53.24"></a><span id="l53.24">     },</span>
<a href="#l53.25"></a><span id="l53.25"> </span>
<a href="#l53.26"></a><span id="l53.26">     /**</span>
<a href="#l53.27"></a><span id="l53.27">      * Provides a list of available menuitems of a button</span>
<a href="#l53.28"></a><span id="l53.28">      *</span>
<a href="#l53.29"></a><span id="l53.29">      * @param aButton        button node</span>
<a href="#l53.30"></a><span id="l53.30">      */</span>
<a href="#l53.31"></a><span id="l53.31">     getMenuItems: function(aButton) {</span>
<a href="#l53.32"></a><span id="l53.32" class="difflineat">@@ -208,18 +202,18 @@ var ltnImipBar = {</span>
<a href="#l53.33"></a><span id="l53.33">         // folder flags only may lead to false positives.</span>
<a href="#l53.34"></a><span id="l53.34">         let isOutgoing = function(aMsgHdr) {</span>
<a href="#l53.35"></a><span id="l53.35">             if (!aMsgHdr) {</span>
<a href="#l53.36"></a><span id="l53.36">                 return false;</span>
<a href="#l53.37"></a><span id="l53.37">             }</span>
<a href="#l53.38"></a><span id="l53.38">             let author = aMsgHdr.mime2DecodedAuthor;</span>
<a href="#l53.39"></a><span id="l53.39">             let isSentFolder = aMsgHdr.folder.flags &amp; nsMsgFolderFlags.SentMail;</span>
<a href="#l53.40"></a><span id="l53.40">             if (author &amp;&amp; isSentFolder) {</span>
<a href="#l53.41"></a><span id="l53.41" class="difflineminus">-                let am = MailServices.accounts;</span>
<a href="#l53.42"></a><span id="l53.42" class="difflineminus">-                for (let identity in fixIterator(am.allIdentities,</span>
<a href="#l53.43"></a><span id="l53.43" class="difflineplus">+                let accounts = MailServices.accounts;</span>
<a href="#l53.44"></a><span id="l53.44" class="difflineplus">+                for (let identity in fixIterator(accounts.allIdentities,</span>
<a href="#l53.45"></a><span id="l53.45">                                                  Components.interfaces.nsIMsgIdentity)) {</span>
<a href="#l53.46"></a><span id="l53.46">                     if (author.includes(identity.email) &amp;&amp; !identity.fccReplyFollowParent) {</span>
<a href="#l53.47"></a><span id="l53.47">                         return true;</span>
<a href="#l53.48"></a><span id="l53.48">                     }</span>
<a href="#l53.49"></a><span id="l53.49">                 }</span>
<a href="#l53.50"></a><span id="l53.50">             }</span>
<a href="#l53.51"></a><span id="l53.51">             return false;</span>
<a href="#l53.52"></a><span id="l53.52">         };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l54.1"></a><span id="l54.1" class="difflineminus">--- a/calendar/lightning/content/lightning-item-iframe.js</span>
<a href="#l54.2"></a><span id="l54.2" class="difflineplus">+++ b/calendar/lightning/content/lightning-item-iframe.js</span>
<a href="#l54.3"></a><span id="l54.3" class="difflineat">@@ -565,21 +565,21 @@ function loadDialog(aItem) {</span>
<a href="#l54.4"></a><span id="l54.4">         let calendarList = unfilteredList.filter((calendar) =&gt;</span>
<a href="#l54.5"></a><span id="l54.5">            (calendar.id == calendarToUse.id ||</span>
<a href="#l54.6"></a><span id="l54.6">             (calendar &amp;&amp;</span>
<a href="#l54.7"></a><span id="l54.7">              isCalendarWritable(calendar) &amp;&amp;</span>
<a href="#l54.8"></a><span id="l54.8">              (userCanAddItemsToCalendar(calendar) ||</span>
<a href="#l54.9"></a><span id="l54.9">               (calendar == aItem.calendar &amp;&amp; userCanModifyItem(aItem))) &amp;&amp;</span>
<a href="#l54.10"></a><span id="l54.10">              isItemSupported(aItem, calendar))));</span>
<a href="#l54.11"></a><span id="l54.11"> </span>
<a href="#l54.12"></a><span id="l54.12" class="difflineminus">-        itemProps.calendarList = calendarList.map((c) =&gt; [c.id, c.name]);</span>
<a href="#l54.13"></a><span id="l54.13" class="difflineplus">+        itemProps.calendarList = calendarList.map(calendar =&gt; [calendar.id, calendar.name]);</span>
<a href="#l54.14"></a><span id="l54.14"> </span>
<a href="#l54.15"></a><span id="l54.15">         if (calendarToUse &amp;&amp; calendarToUse.id) {</span>
<a href="#l54.16"></a><span id="l54.16">             let index = itemProps.calendarList.findIndex(</span>
<a href="#l54.17"></a><span id="l54.17" class="difflineminus">-                (c) =&gt; (c[0] == calendarToUse.id));</span>
<a href="#l54.18"></a><span id="l54.18" class="difflineplus">+                calendar =&gt; (calendar[0] == calendarToUse.id));</span>
<a href="#l54.19"></a><span id="l54.19">             if (index != -1) {</span>
<a href="#l54.20"></a><span id="l54.20">                 itemProps.initialCalendarId = calendarToUse.id;</span>
<a href="#l54.21"></a><span id="l54.21">             }</span>
<a href="#l54.22"></a><span id="l54.22">         }</span>
<a href="#l54.23"></a><span id="l54.23">     } else {</span>
<a href="#l54.24"></a><span id="l54.24">         let calendarList = document.getElementById(&quot;item-calendar&quot;);</span>
<a href="#l54.25"></a><span id="l54.25">         removeChildren(calendarList);</span>
<a href="#l54.26"></a><span id="l54.26">         let indexToSelect = appendCalendarItems(aItem, calendarList, aItem.calendar || window.arguments[0].calendar);</span>
<a href="#l54.27"></a><span id="l54.27" class="difflineat">@@ -1128,35 +1128,35 @@ function dateTimeControls2State(aStartDa</span>
<a href="#l54.28"></a><span id="l54.28"> function updateEntryDate() {</span>
<a href="#l54.29"></a><span id="l54.29">     updateDateCheckboxes(</span>
<a href="#l54.30"></a><span id="l54.30">         &quot;todo-entrydate&quot;,</span>
<a href="#l54.31"></a><span id="l54.31">         &quot;todo-has-entrydate&quot;,</span>
<a href="#l54.32"></a><span id="l54.32">         {</span>
<a href="#l54.33"></a><span id="l54.33">             isValid: function() {</span>
<a href="#l54.34"></a><span id="l54.34">                 return gStartTime != null;</span>
<a href="#l54.35"></a><span id="l54.35">             },</span>
<a href="#l54.36"></a><span id="l54.36" class="difflineminus">-            setDateTime: function(dt) {</span>
<a href="#l54.37"></a><span id="l54.37" class="difflineminus">-                gStartTime = dt;</span>
<a href="#l54.38"></a><span id="l54.38" class="difflineplus">+            setDateTime: function(date) {</span>
<a href="#l54.39"></a><span id="l54.39" class="difflineplus">+                gStartTime = date;</span>
<a href="#l54.40"></a><span id="l54.40">             }</span>
<a href="#l54.41"></a><span id="l54.41">         });</span>
<a href="#l54.42"></a><span id="l54.42"> }</span>
<a href="#l54.43"></a><span id="l54.43"> </span>
<a href="#l54.44"></a><span id="l54.44"> /**</span>
<a href="#l54.45"></a><span id="l54.45">  * Updates the due date checkboxes.</span>
<a href="#l54.46"></a><span id="l54.46">  */</span>
<a href="#l54.47"></a><span id="l54.47"> function updateDueDate() {</span>
<a href="#l54.48"></a><span id="l54.48">     updateDateCheckboxes(</span>
<a href="#l54.49"></a><span id="l54.49">         &quot;todo-duedate&quot;,</span>
<a href="#l54.50"></a><span id="l54.50">         &quot;todo-has-duedate&quot;,</span>
<a href="#l54.51"></a><span id="l54.51">         {</span>
<a href="#l54.52"></a><span id="l54.52">             isValid: function() {</span>
<a href="#l54.53"></a><span id="l54.53">                 return gEndTime != null;</span>
<a href="#l54.54"></a><span id="l54.54">             },</span>
<a href="#l54.55"></a><span id="l54.55" class="difflineminus">-            setDateTime: function(dt) {</span>
<a href="#l54.56"></a><span id="l54.56" class="difflineminus">-                gEndTime = dt;</span>
<a href="#l54.57"></a><span id="l54.57" class="difflineplus">+            setDateTime: function(date) {</span>
<a href="#l54.58"></a><span id="l54.58" class="difflineplus">+                gEndTime = date;</span>
<a href="#l54.59"></a><span id="l54.59">             }</span>
<a href="#l54.60"></a><span id="l54.60">         });</span>
<a href="#l54.61"></a><span id="l54.61"> }</span>
<a href="#l54.62"></a><span id="l54.62"> </span>
<a href="#l54.63"></a><span id="l54.63"> /**</span>
<a href="#l54.64"></a><span id="l54.64">  * Common function used by updateEntryDate and updateDueDate to set up the</span>
<a href="#l54.65"></a><span id="l54.65">  * checkboxes correctly.</span>
<a href="#l54.66"></a><span id="l54.66">  *</span>
<a href="#l54.67"></a><span id="l54.67" class="difflineat">@@ -1178,18 +1178,18 @@ function updateDateCheckboxes(aDatePicke</span>
<a href="#l54.68"></a><span id="l54.68">     setElementValue(aDatePickerId, getElementValue(aDatePickerId));</span>
<a href="#l54.69"></a><span id="l54.69"> </span>
<a href="#l54.70"></a><span id="l54.70">     // first of all disable the datetime picker if we don't have a date</span>
<a href="#l54.71"></a><span id="l54.71">     let hasDate = getElementValue(aCheckboxId, &quot;checked&quot;);</span>
<a href="#l54.72"></a><span id="l54.72">     setElementValue(aDatePickerId, !hasDate, &quot;disabled&quot;);</span>
<a href="#l54.73"></a><span id="l54.73"> </span>
<a href="#l54.74"></a><span id="l54.74">     // create a new datetime object if date is now checked for the first time</span>
<a href="#l54.75"></a><span id="l54.75">     if (hasDate &amp;&amp; !aDateTime.isValid()) {</span>
<a href="#l54.76"></a><span id="l54.76" class="difflineminus">-        let dt = cal.jsDateToDateTime(getElementValue(aDatePickerId), cal.calendarDefaultTimezone());</span>
<a href="#l54.77"></a><span id="l54.77" class="difflineminus">-        aDateTime.setDateTime(dt);</span>
<a href="#l54.78"></a><span id="l54.78" class="difflineplus">+        let date = cal.jsDateToDateTime(getElementValue(aDatePickerId), cal.calendarDefaultTimezone());</span>
<a href="#l54.79"></a><span id="l54.79" class="difflineplus">+        aDateTime.setDateTime(date);</span>
<a href="#l54.80"></a><span id="l54.80">     } else if (!hasDate &amp;&amp; aDateTime.isValid()) {</span>
<a href="#l54.81"></a><span id="l54.81">         aDateTime.setDateTime(null);</span>
<a href="#l54.82"></a><span id="l54.82">     }</span>
<a href="#l54.83"></a><span id="l54.83"> </span>
<a href="#l54.84"></a><span id="l54.84">     // calculate the duration if possible</span>
<a href="#l54.85"></a><span id="l54.85">     let hasEntryDate = getElementValue(&quot;todo-has-entrydate&quot;, &quot;checked&quot;);</span>
<a href="#l54.86"></a><span id="l54.86">     let hasDueDate = getElementValue(&quot;todo-has-duedate&quot;, &quot;checked&quot;);</span>
<a href="#l54.87"></a><span id="l54.87">     if (hasEntryDate &amp;&amp; hasDueDate) {</span>
<a href="#l54.88"></a><span id="l54.88" class="difflineat">@@ -1231,21 +1231,21 @@ function getRepeatTypeAndUntilDate(aItem</span>
<a href="#l54.89"></a><span id="l54.89">         }</span>
<a href="#l54.90"></a><span id="l54.90">     };</span>
<a href="#l54.91"></a><span id="l54.91"> </span>
<a href="#l54.92"></a><span id="l54.92">     if (recurrenceInfo) {</span>
<a href="#l54.93"></a><span id="l54.93">         repeatType = &quot;custom&quot;;</span>
<a href="#l54.94"></a><span id="l54.94">         let ritems = recurrenceInfo.getRecurrenceItems({});</span>
<a href="#l54.95"></a><span id="l54.95">         let rules = [];</span>
<a href="#l54.96"></a><span id="l54.96">         let exceptions = [];</span>
<a href="#l54.97"></a><span id="l54.97" class="difflineminus">-        for (let r of ritems) {</span>
<a href="#l54.98"></a><span id="l54.98" class="difflineminus">-            if (r.isNegative) {</span>
<a href="#l54.99"></a><span id="l54.99" class="difflineminus">-                exceptions.push(r);</span>
<a href="#l54.100"></a><span id="l54.100" class="difflineplus">+        for (let ritem of ritems) {</span>
<a href="#l54.101"></a><span id="l54.101" class="difflineplus">+            if (ritem.isNegative) {</span>
<a href="#l54.102"></a><span id="l54.102" class="difflineplus">+                exceptions.push(ritem);</span>
<a href="#l54.103"></a><span id="l54.103">             } else {</span>
<a href="#l54.104"></a><span id="l54.104" class="difflineminus">-                rules.push(r);</span>
<a href="#l54.105"></a><span id="l54.105" class="difflineplus">+                rules.push(ritem);</span>
<a href="#l54.106"></a><span id="l54.106">             }</span>
<a href="#l54.107"></a><span id="l54.107">         }</span>
<a href="#l54.108"></a><span id="l54.108">         if (rules.length == 1) {</span>
<a href="#l54.109"></a><span id="l54.109">             let rule = cal.wrapInstance(rules[0], Components.interfaces.calIRecurrenceRule);</span>
<a href="#l54.110"></a><span id="l54.110">             if (rule) {</span>
<a href="#l54.111"></a><span id="l54.111">                 switch (rule.type) {</span>
<a href="#l54.112"></a><span id="l54.112">                     case &quot;DAILY&quot;:</span>
<a href="#l54.113"></a><span id="l54.113">                         if (!checkRecurrenceRule(rule, [&quot;BYSECOND&quot;,</span>
<a href="#l54.114"></a><span id="l54.114" class="difflineat">@@ -2006,31 +2006,31 @@ function attachFileByAccountKey(aAccount</span>
<a href="#l54.115"></a><span id="l54.115"> function attachFile(cloudProvider) {</span>
<a href="#l54.116"></a><span id="l54.116">     if (!cloudProvider) {</span>
<a href="#l54.117"></a><span id="l54.117">         cal.ERROR(&quot;[calendar-event-dialog] Could not attach file without cloud provider&quot; + cal.STACK(10));</span>
<a href="#l54.118"></a><span id="l54.118">     }</span>
<a href="#l54.119"></a><span id="l54.119"> </span>
<a href="#l54.120"></a><span id="l54.120">     let files;</span>
<a href="#l54.121"></a><span id="l54.121">     try {</span>
<a href="#l54.122"></a><span id="l54.122">         const nsIFilePicker = Components.interfaces.nsIFilePicker;</span>
<a href="#l54.123"></a><span id="l54.123" class="difflineminus">-        let fp = Components.classes[&quot;@mozilla.org/filepicker;1&quot;]</span>
<a href="#l54.124"></a><span id="l54.124" class="difflineminus">-                           .createInstance(nsIFilePicker);</span>
<a href="#l54.125"></a><span id="l54.125" class="difflineminus">-        fp.init(window,</span>
<a href="#l54.126"></a><span id="l54.126" class="difflineminus">-                calGetString(&quot;calendar-event-dialog&quot;, &quot;selectAFile&quot;),</span>
<a href="#l54.127"></a><span id="l54.127" class="difflineminus">-                nsIFilePicker.modeOpenMultiple);</span>
<a href="#l54.128"></a><span id="l54.128" class="difflineplus">+        let filePicker = Components.classes[&quot;@mozilla.org/filepicker;1&quot;]</span>
<a href="#l54.129"></a><span id="l54.129" class="difflineplus">+                                   .createInstance(nsIFilePicker);</span>
<a href="#l54.130"></a><span id="l54.130" class="difflineplus">+        filePicker.init(window,</span>
<a href="#l54.131"></a><span id="l54.131" class="difflineplus">+                        calGetString(&quot;calendar-event-dialog&quot;, &quot;selectAFile&quot;),</span>
<a href="#l54.132"></a><span id="l54.132" class="difflineplus">+                        nsIFilePicker.modeOpenMultiple);</span>
<a href="#l54.133"></a><span id="l54.133"> </span>
<a href="#l54.134"></a><span id="l54.134">         // Check for the last directory</span>
<a href="#l54.135"></a><span id="l54.135">         let lastDir = lastDirectory();</span>
<a href="#l54.136"></a><span id="l54.136">         if (lastDir) {</span>
<a href="#l54.137"></a><span id="l54.137" class="difflineminus">-            fp.displayDirectory = lastDir;</span>
<a href="#l54.138"></a><span id="l54.138" class="difflineplus">+            filePicker.displayDirectory = lastDir;</span>
<a href="#l54.139"></a><span id="l54.139">         }</span>
<a href="#l54.140"></a><span id="l54.140"> </span>
<a href="#l54.141"></a><span id="l54.141">         // Get the attachment</span>
<a href="#l54.142"></a><span id="l54.142" class="difflineminus">-        if (fp.show() == nsIFilePicker.returnOK) {</span>
<a href="#l54.143"></a><span id="l54.143" class="difflineminus">-            files = fp.files;</span>
<a href="#l54.144"></a><span id="l54.144" class="difflineplus">+        if (filePicker.show() == nsIFilePicker.returnOK) {</span>
<a href="#l54.145"></a><span id="l54.145" class="difflineplus">+            files = filePicker.files;</span>
<a href="#l54.146"></a><span id="l54.146">         }</span>
<a href="#l54.147"></a><span id="l54.147">     } catch (ex) {</span>
<a href="#l54.148"></a><span id="l54.148">         dump(&quot;failed to get attachments: &quot; +ex+ &quot;\n&quot;);</span>
<a href="#l54.149"></a><span id="l54.149">     }</span>
<a href="#l54.150"></a><span id="l54.150"> </span>
<a href="#l54.151"></a><span id="l54.151">     // Check if something has to be done</span>
<a href="#l54.152"></a><span id="l54.152">     if (!files || !files.hasMoreElements()) {</span>
<a href="#l54.153"></a><span id="l54.153">         return;</span>
<a href="#l54.154"></a><span id="l54.154" class="difflineat">@@ -2252,25 +2252,25 @@ function deleteAttachment() {</span>
<a href="#l54.155"></a><span id="l54.155"> }</span>
<a href="#l54.156"></a><span id="l54.156"> </span>
<a href="#l54.157"></a><span id="l54.157"> /**</span>
<a href="#l54.158"></a><span id="l54.158">  * Removes all attachments from the dialog controls.</span>
<a href="#l54.159"></a><span id="l54.159">  */</span>
<a href="#l54.160"></a><span id="l54.160"> function deleteAllAttachments() {</span>
<a href="#l54.161"></a><span id="l54.161">     let documentLink = document.getElementById(&quot;attachment-link&quot;);</span>
<a href="#l54.162"></a><span id="l54.162">     let itemCount = documentLink.getRowCount();</span>
<a href="#l54.163"></a><span id="l54.163" class="difflineminus">-    let ok = (itemCount &lt; 2);</span>
<a href="#l54.164"></a><span id="l54.164" class="difflineplus">+    let canRemove = (itemCount &lt; 2);</span>
<a href="#l54.165"></a><span id="l54.165"> </span>
<a href="#l54.166"></a><span id="l54.166">     if (itemCount &gt; 1) {</span>
<a href="#l54.167"></a><span id="l54.167">         let removeText = PluralForm.get(itemCount, cal.calGetString(&quot;calendar-event-dialog&quot;, &quot;removeAttachmentsText&quot;));</span>
<a href="#l54.168"></a><span id="l54.168">         let removeTitle = cal.calGetString(&quot;calendar-event-dialog&quot;, &quot;removeCalendarsTitle&quot;);</span>
<a href="#l54.169"></a><span id="l54.169" class="difflineminus">-        ok = Services.prompt.confirm(window, removeTitle, removeText.replace(&quot;#1&quot;, itemCount), {});</span>
<a href="#l54.170"></a><span id="l54.170" class="difflineplus">+        canRemove = Services.prompt.confirm(window, removeTitle, removeText.replace(&quot;#1&quot;, itemCount), {});</span>
<a href="#l54.171"></a><span id="l54.171">     }</span>
<a href="#l54.172"></a><span id="l54.172"> </span>
<a href="#l54.173"></a><span id="l54.173" class="difflineminus">-    if (ok) {</span>
<a href="#l54.174"></a><span id="l54.174" class="difflineplus">+    if (canRemove) {</span>
<a href="#l54.175"></a><span id="l54.175">         let child;</span>
<a href="#l54.176"></a><span id="l54.176">         while (documentLink.hasChildNodes()) {</span>
<a href="#l54.177"></a><span id="l54.177">             child = documentLink.lastChild;</span>
<a href="#l54.178"></a><span id="l54.178">             child.attachment = null;</span>
<a href="#l54.179"></a><span id="l54.179">             child.remove();</span>
<a href="#l54.180"></a><span id="l54.180">         }</span>
<a href="#l54.181"></a><span id="l54.181">         gAttachMap = {};</span>
<a href="#l54.182"></a><span id="l54.182">     }</span>
<a href="#l54.183"></a><span id="l54.183" class="difflineat">@@ -3187,20 +3187,20 @@ function showTimezonePopup(event, dateTi</span>
<a href="#l54.184"></a><span id="l54.184">     timezoneDefaultItem.label = defaultTimezone.displayName;</span>
<a href="#l54.185"></a><span id="l54.185"> </span>
<a href="#l54.186"></a><span id="l54.186">     // Clear out any old recent timezones</span>
<a href="#l54.187"></a><span id="l54.187">     while (timezoneDefaultItem.nextSibling != timezoneSeparator) {</span>
<a href="#l54.188"></a><span id="l54.188">         timezoneDefaultItem.nextSibling.remove();</span>
<a href="#l54.189"></a><span id="l54.189">     }</span>
<a href="#l54.190"></a><span id="l54.190"> </span>
<a href="#l54.191"></a><span id="l54.191">     // Fill in the new recent timezones</span>
<a href="#l54.192"></a><span id="l54.192" class="difflineminus">-    for (let tz of recentTimezones) {</span>
<a href="#l54.193"></a><span id="l54.193" class="difflineplus">+    for (let timezone of recentTimezones) {</span>
<a href="#l54.194"></a><span id="l54.194">         let menuItem = createXULElement(&quot;menuitem&quot;);</span>
<a href="#l54.195"></a><span id="l54.195" class="difflineminus">-        menuItem.setAttribute(&quot;value&quot;, tz.tzid);</span>
<a href="#l54.196"></a><span id="l54.196" class="difflineminus">-        menuItem.setAttribute(&quot;label&quot;, tz.displayName);</span>
<a href="#l54.197"></a><span id="l54.197" class="difflineplus">+        menuItem.setAttribute(&quot;value&quot;, timezone.tzid);</span>
<a href="#l54.198"></a><span id="l54.198" class="difflineplus">+        menuItem.setAttribute(&quot;label&quot;, timezone.displayName);</span>
<a href="#l54.199"></a><span id="l54.199">         timezonePopup.insertBefore(menuItem, timezoneDefaultItem.nextSibling);</span>
<a href="#l54.200"></a><span id="l54.200">     }</span>
<a href="#l54.201"></a><span id="l54.201"> </span>
<a href="#l54.202"></a><span id="l54.202">     // Show the popup</span>
<a href="#l54.203"></a><span id="l54.203">     timezonePopup.openPopup(event.target, &quot;after_start&quot;, 0, 0, true);</span>
<a href="#l54.204"></a><span id="l54.204"> }</span>
<a href="#l54.205"></a><span id="l54.205"> </span>
<a href="#l54.206"></a><span id="l54.206"> /**</span>
<a href="#l54.207"></a><span id="l54.207" class="difflineat">@@ -3538,34 +3538,34 @@ function updateAttendees() {</span>
<a href="#l54.208"></a><span id="l54.208"> </span>
<a href="#l54.209"></a><span id="l54.209">         if (window.organizer &amp;&amp; window.organizer.id) {</span>
<a href="#l54.210"></a><span id="l54.210">             document.getElementById(&quot;item-organizer-row&quot;).removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l54.211"></a><span id="l54.211">             let cell = document.querySelector(&quot;.item-organizer-cell&quot;);</span>
<a href="#l54.212"></a><span id="l54.212">             let icon = cell.querySelector(&quot;img:nth-of-type(1)&quot;);</span>
<a href="#l54.213"></a><span id="l54.213">             let text = cell.querySelector(&quot;label:nth-of-type(1)&quot;);</span>
<a href="#l54.214"></a><span id="l54.214"> </span>
<a href="#l54.215"></a><span id="l54.215">             let role = organizer.role || &quot;REQ-PARTICIPANT&quot;;</span>
<a href="#l54.216"></a><span id="l54.216" class="difflineminus">-            let ut = organizer.userType || &quot;INDIVIDUAL&quot;;</span>
<a href="#l54.217"></a><span id="l54.217" class="difflineminus">-            let ps = organizer.participationStatus || &quot;NEEDS-ACTION&quot;;</span>
<a href="#l54.218"></a><span id="l54.218" class="difflineplus">+            let userType = organizer.userType || &quot;INDIVIDUAL&quot;;</span>
<a href="#l54.219"></a><span id="l54.219" class="difflineplus">+            let partStat = organizer.participationStatus || &quot;NEEDS-ACTION&quot;;</span>
<a href="#l54.220"></a><span id="l54.220"> </span>
<a href="#l54.221"></a><span id="l54.221">             let orgName = (organizer.commonName &amp;&amp; organizer.commonName.length)</span>
<a href="#l54.222"></a><span id="l54.222">                           ? organizer.commonName : organizer.toString();</span>
<a href="#l54.223"></a><span id="l54.223" class="difflineminus">-            let utString = cal.calGetString(&quot;calendar&quot;, &quot;dialog.tooltip.attendeeUserType2.&quot; + ut,</span>
<a href="#l54.224"></a><span id="l54.224" class="difflineplus">+            let userTypeString = cal.calGetString(&quot;calendar&quot;, &quot;dialog.tooltip.attendeeUserType2.&quot; + userType,</span>
<a href="#l54.225"></a><span id="l54.225">                                             [organizer.toString()]);</span>
<a href="#l54.226"></a><span id="l54.226">             let roleString = cal.calGetString(&quot;calendar&quot;, &quot;dialog.tooltip.attendeeRole2.&quot; + role,</span>
<a href="#l54.227"></a><span id="l54.227" class="difflineminus">-                                              [utString]);</span>
<a href="#l54.228"></a><span id="l54.228" class="difflineminus">-            let psString = cal.calGetString(&quot;calendar&quot;, &quot;dialog.tooltip.attendeePartStat2.&quot; + ps,</span>
<a href="#l54.229"></a><span id="l54.229" class="difflineplus">+                                              [userTypeString]);</span>
<a href="#l54.230"></a><span id="l54.230" class="difflineplus">+            let partStatString = cal.calGetString(&quot;calendar&quot;, &quot;dialog.tooltip.attendeePartStat2.&quot; + partStat,</span>
<a href="#l54.231"></a><span id="l54.231">                                             [orgName]);</span>
<a href="#l54.232"></a><span id="l54.232" class="difflineminus">-            let tt = cal.calGetString(&quot;calendar&quot;, &quot;dialog.tooltip.attendee.combined&quot;,</span>
<a href="#l54.233"></a><span id="l54.233" class="difflineminus">-                                      [roleString, psString]);</span>
<a href="#l54.234"></a><span id="l54.234" class="difflineplus">+            let tooltip = cal.calGetString(&quot;calendar&quot;, &quot;dialog.tooltip.attendee.combined&quot;,</span>
<a href="#l54.235"></a><span id="l54.235" class="difflineplus">+                                           [roleString, partStatString]);</span>
<a href="#l54.236"></a><span id="l54.236"> </span>
<a href="#l54.237"></a><span id="l54.237">             text.setAttribute(&quot;value&quot;, orgName);</span>
<a href="#l54.238"></a><span id="l54.238" class="difflineminus">-            cell.setAttribute(&quot;tooltiptext&quot;, tt);</span>
<a href="#l54.239"></a><span id="l54.239" class="difflineminus">-            icon.setAttribute(&quot;partstat&quot;, ps);</span>
<a href="#l54.240"></a><span id="l54.240" class="difflineminus">-            icon.setAttribute(&quot;usertype&quot;, ut);</span>
<a href="#l54.241"></a><span id="l54.241" class="difflineplus">+            cell.setAttribute(&quot;tooltiptext&quot;, tooltip);</span>
<a href="#l54.242"></a><span id="l54.242" class="difflineplus">+            icon.setAttribute(&quot;partstat&quot;, partStat);</span>
<a href="#l54.243"></a><span id="l54.243" class="difflineplus">+            icon.setAttribute(&quot;usertype&quot;, userType);</span>
<a href="#l54.244"></a><span id="l54.244">             icon.setAttribute(&quot;role&quot;, role);</span>
<a href="#l54.245"></a><span id="l54.245">         } else {</span>
<a href="#l54.246"></a><span id="l54.246">             setBooleanAttribute(&quot;item-organizer-row&quot;, &quot;collapsed&quot;, true);</span>
<a href="#l54.247"></a><span id="l54.247">         }</span>
<a href="#l54.248"></a><span id="l54.248">         setupAttendees();</span>
<a href="#l54.249"></a><span id="l54.249">     } else {</span>
<a href="#l54.250"></a><span id="l54.250">         attendeeTab.setAttribute(&quot;collapsed&quot;, &quot;true&quot;);</span>
<a href="#l54.251"></a><span id="l54.251">         attendeePanel.setAttribute(&quot;collapsed&quot;, &quot;true&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l55.1"></a><span id="l55.1" class="difflineminus">--- a/calendar/lightning/modules/ltnInvitationUtils.jsm</span>
<a href="#l55.2"></a><span id="l55.2" class="difflineplus">+++ b/calendar/lightning/modules/ltnInvitationUtils.jsm</span>
<a href="#l55.3"></a><span id="l55.3" class="difflineat">@@ -219,32 +219,32 @@ ltn.invitation = {</span>
<a href="#l55.4"></a><span id="l55.4">             let del = cal.resolveDelegation(aAttendee, attendees);</span>
<a href="#l55.5"></a><span id="l55.5">             if (del.delegators != &quot;&quot;) {</span>
<a href="#l55.6"></a><span id="l55.6">                 del.delegators = &quot; &quot; + ltn.getString(&quot;lightning&quot;, &quot;imipHtml.attendeeDelegatedFrom&quot;,</span>
<a href="#l55.7"></a><span id="l55.7">                                                      [del.delegators]);</span>
<a href="#l55.8"></a><span id="l55.8">             }</span>
<a href="#l55.9"></a><span id="l55.9"> </span>
<a href="#l55.10"></a><span id="l55.10">             // display itip icon</span>
<a href="#l55.11"></a><span id="l55.11">             let role = aAttendee.role || &quot;REQ-PARTICIPANT&quot;;</span>
<a href="#l55.12"></a><span id="l55.12" class="difflineminus">-            let ps = aAttendee.participationStatus || &quot;NEEDS-ACTION&quot;;</span>
<a href="#l55.13"></a><span id="l55.13" class="difflineminus">-            let ut = aAttendee.userType || &quot;INDIVIDUAL&quot;;</span>
<a href="#l55.14"></a><span id="l55.14" class="difflineplus">+            let partstat = aAttendee.participationStatus || &quot;NEEDS-ACTION&quot;;</span>
<a href="#l55.15"></a><span id="l55.15" class="difflineplus">+            let userType = aAttendee.userType || &quot;INDIVIDUAL&quot;;</span>
<a href="#l55.16"></a><span id="l55.16">             let itipIcon = row.getElementsByClassName(&quot;itip-icon&quot;)[0];</span>
<a href="#l55.17"></a><span id="l55.17">             itipIcon.setAttribute(&quot;role&quot;, role);</span>
<a href="#l55.18"></a><span id="l55.18" class="difflineminus">-            itipIcon.setAttribute(&quot;usertype&quot;, ut);</span>
<a href="#l55.19"></a><span id="l55.19" class="difflineminus">-            itipIcon.setAttribute(&quot;partstat&quot;, ps);</span>
<a href="#l55.20"></a><span id="l55.20" class="difflineplus">+            itipIcon.setAttribute(&quot;usertype&quot;, userType);</span>
<a href="#l55.21"></a><span id="l55.21" class="difflineplus">+            itipIcon.setAttribute(&quot;partstat&quot;, partstat);</span>
<a href="#l55.22"></a><span id="l55.22">             let attName = aAttendee.commonName &amp;&amp; aAttendee.commonName.length</span>
<a href="#l55.23"></a><span id="l55.23">                           ? aAttendee.commonName : aAttendee.toString();</span>
<a href="#l55.24"></a><span id="l55.24" class="difflineminus">-            let utString = ltn.getString(&quot;lightning&quot;, &quot;imipHtml.attendeeUserType2.&quot; + ut,</span>
<a href="#l55.25"></a><span id="l55.25" class="difflineminus">-                                         [aAttendee.toString()]);</span>
<a href="#l55.26"></a><span id="l55.26" class="difflineplus">+            let userTypeString = ltn.getString(&quot;lightning&quot;, &quot;imipHtml.attendeeUserType2.&quot; + userType,</span>
<a href="#l55.27"></a><span id="l55.27" class="difflineplus">+                                               [aAttendee.toString()]);</span>
<a href="#l55.28"></a><span id="l55.28">             let roleString = ltn.getString(&quot;lightning&quot;, &quot;imipHtml.attendeeRole2.&quot; + role,</span>
<a href="#l55.29"></a><span id="l55.29" class="difflineminus">-                                           [utString]);</span>
<a href="#l55.30"></a><span id="l55.30" class="difflineminus">-            let psString = ltn.getString(&quot;lightning&quot;, &quot;imipHtml.attendeePartStat2.&quot; + ps,</span>
<a href="#l55.31"></a><span id="l55.31" class="difflineminus">-                                         [attName, del.delegatees]);</span>
<a href="#l55.32"></a><span id="l55.32" class="difflineplus">+                                           [userTypeString]);</span>
<a href="#l55.33"></a><span id="l55.33" class="difflineplus">+            let partstatString = ltn.getString(&quot;lightning&quot;, &quot;imipHtml.attendeePartStat2.&quot; + partstat,</span>
<a href="#l55.34"></a><span id="l55.34" class="difflineplus">+                                               [attName, del.delegatees]);</span>
<a href="#l55.35"></a><span id="l55.35">             let itipTooltip = ltn.getString(&quot;lightning&quot;, &quot;imipHtml.attendee.combined&quot;,</span>
<a href="#l55.36"></a><span id="l55.36" class="difflineminus">-                                            [roleString, psString]);</span>
<a href="#l55.37"></a><span id="l55.37" class="difflineplus">+                                            [roleString, partstatString]);</span>
<a href="#l55.38"></a><span id="l55.38">             row.setAttribute(&quot;title&quot;, itipTooltip);</span>
<a href="#l55.39"></a><span id="l55.39">             // display attendee</span>
<a href="#l55.40"></a><span id="l55.40">             row.getElementsByClassName(&quot;attendee-name&quot;)[0].textContent = aAttendee.toString() +</span>
<a href="#l55.41"></a><span id="l55.41">                                                                          del.delegators;</span>
<a href="#l55.42"></a><span id="l55.42">             return row;</span>
<a href="#l55.43"></a><span id="l55.43">         };</span>
<a href="#l55.44"></a><span id="l55.44"> </span>
<a href="#l55.45"></a><span id="l55.45">         // Fill rows for attendees and organizer</span>
<a href="#l55.46"></a><span id="l55.46" class="difflineat">@@ -446,18 +446,18 @@ ltn.invitation = {</span>
<a href="#l55.47"></a><span id="l55.47">      */</span>
<a href="#l55.48"></a><span id="l55.48">     getRfc5322FormattedDate: function(aDate = null) {</span>
<a href="#l55.49"></a><span id="l55.49">         let date = aDate || new Date();</span>
<a href="#l55.50"></a><span id="l55.50">         let str = date.toString()</span>
<a href="#l55.51"></a><span id="l55.51">                       .replace(/^(\w{3}) (\w{3}) (\d{2}) (\d{4}) ([0-9:]{8}) GMT([+-])(\d{4}).*$/,</span>
<a href="#l55.52"></a><span id="l55.52">                                &quot;$1, $3 $2 $4 $5 $6$7&quot;);</span>
<a href="#l55.53"></a><span id="l55.53">         // according to section 3.3 of RfC5322, +0000 should be used for defined timezones using</span>
<a href="#l55.54"></a><span id="l55.54">         // UTC time, while -0000 should indicate a floating time instead</span>
<a href="#l55.55"></a><span id="l55.55" class="difflineminus">-        let tz = cal.calendarDefaultTimezone();</span>
<a href="#l55.56"></a><span id="l55.56" class="difflineminus">-        if (tz &amp;&amp; tz.isFloating) {</span>
<a href="#l55.57"></a><span id="l55.57" class="difflineplus">+        let timezone = cal.calendarDefaultTimezone();</span>
<a href="#l55.58"></a><span id="l55.58" class="difflineplus">+        if (timezone &amp;&amp; timezone.isFloating) {</span>
<a href="#l55.59"></a><span id="l55.59">             str.replace(/\+0000$/, &quot;-0000&quot;);</span>
<a href="#l55.60"></a><span id="l55.60">         }</span>
<a href="#l55.61"></a><span id="l55.61">         return str;</span>
<a href="#l55.62"></a><span id="l55.62">     },</span>
<a href="#l55.63"></a><span id="l55.63"> </span>
<a href="#l55.64"></a><span id="l55.64">     /**</span>
<a href="#l55.65"></a><span id="l55.65">      * Converts a given unicode text to utf-8 and normalizes line-breaks to \r\n</span>
<a href="#l55.66"></a><span id="l55.66">      * @param  {String} aText   a unicode encoded string</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l56.1"></a><span id="l56.1" class="difflineminus">--- a/calendar/providers/caldav/calDavCalendar.js</span>
<a href="#l56.2"></a><span id="l56.2" class="difflineplus">+++ b/calendar/providers/caldav/calDavCalendar.js</span>
<a href="#l56.3"></a><span id="l56.3" class="difflineat">@@ -28,23 +28,25 @@ var davNS = &quot;DAV:&quot;;</span>
<a href="#l56.4"></a><span id="l56.4"> var caldavNS = &quot;urn:ietf:params:xml:ns:caldav&quot;;</span>
<a href="#l56.5"></a><span id="l56.5"> var calservNS = &quot;http://calendarserver.org/ns/&quot;;</span>
<a href="#l56.6"></a><span id="l56.6"> var MIME_TEXT_CALENDAR = &quot;text/calendar; charset=utf-8&quot;;</span>
<a href="#l56.7"></a><span id="l56.7"> var MIME_TEXT_XML = &quot;text/xml; charset=utf-8&quot;;</span>
<a href="#l56.8"></a><span id="l56.8"> </span>
<a href="#l56.9"></a><span id="l56.9"> var cIOL = Components.interfaces.calIOperationListener;</span>
<a href="#l56.10"></a><span id="l56.10"> </span>
<a href="#l56.11"></a><span id="l56.11"> function caldavNSResolver(prefix) {</span>
<a href="#l56.12"></a><span id="l56.12" class="difflineminus">-    const ns = {</span>
<a href="#l56.13"></a><span id="l56.13" class="difflineplus">+    /* eslint-disable id-length */</span>
<a href="#l56.14"></a><span id="l56.14" class="difflineplus">+    const namespaces = {</span>
<a href="#l56.15"></a><span id="l56.15">         D: davNS,</span>
<a href="#l56.16"></a><span id="l56.16">         C: caldavNS,</span>
<a href="#l56.17"></a><span id="l56.17">         CS: calservNS</span>
<a href="#l56.18"></a><span id="l56.18">     };</span>
<a href="#l56.19"></a><span id="l56.19" class="difflineplus">+    /* eslint-enable id-length */</span>
<a href="#l56.20"></a><span id="l56.20"> </span>
<a href="#l56.21"></a><span id="l56.21" class="difflineminus">-    return ns[prefix] || null;</span>
<a href="#l56.22"></a><span id="l56.22" class="difflineplus">+    return namespaces[prefix] || null;</span>
<a href="#l56.23"></a><span id="l56.23"> }</span>
<a href="#l56.24"></a><span id="l56.24"> </span>
<a href="#l56.25"></a><span id="l56.25"> function caldavXPath(aNode, aExpr, aType) {</span>
<a href="#l56.26"></a><span id="l56.26">     return cal.xml.evalXPath(aNode, aExpr, caldavNSResolver, aType);</span>
<a href="#l56.27"></a><span id="l56.27"> }</span>
<a href="#l56.28"></a><span id="l56.28"> function caldavXPathFirst(aNode, aExpr, aType) {</span>
<a href="#l56.29"></a><span id="l56.29">     return cal.xml.evalXPathFirst(aNode, aExpr, caldavNSResolver, aType);</span>
<a href="#l56.30"></a><span id="l56.30"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l57.1"></a><span id="l57.1" class="difflineminus">--- a/calendar/providers/caldav/calDavRequestHandlers.js</span>
<a href="#l57.2"></a><span id="l57.2" class="difflineplus">+++ b/calendar/providers/caldav/calDavRequestHandlers.js</span>
<a href="#l57.3"></a><span id="l57.3" class="difflineat">@@ -217,42 +217,42 @@ etagsHandler.prototype = {</span>
<a href="#l57.4"></a><span id="l57.4">             this.logXML += &quot;&lt;&quot; + aQName + &quot;&gt;&quot;;</span>
<a href="#l57.5"></a><span id="l57.5">         }</span>
<a href="#l57.6"></a><span id="l57.6">     },</span>
<a href="#l57.7"></a><span id="l57.7"> </span>
<a href="#l57.8"></a><span id="l57.8">     endElement: function(aUri, aLocalName, aQName) {</span>
<a href="#l57.9"></a><span id="l57.9">         switch (aLocalName) {</span>
<a href="#l57.10"></a><span id="l57.10">             case &quot;response&quot;:</span>
<a href="#l57.11"></a><span id="l57.11">                 this.tag = null;</span>
<a href="#l57.12"></a><span id="l57.12" class="difflineminus">-                let r = this.currentResponse;</span>
<a href="#l57.13"></a><span id="l57.13" class="difflineminus">-                if (r.getetag &amp;&amp; r.getetag.length &amp;&amp;</span>
<a href="#l57.14"></a><span id="l57.14" class="difflineminus">-                    r.href &amp;&amp; r.href.length &amp;&amp;</span>
<a href="#l57.15"></a><span id="l57.15" class="difflineminus">-                    r.getcontenttype &amp;&amp; r.getcontenttype.length &amp;&amp;</span>
<a href="#l57.16"></a><span id="l57.16" class="difflineminus">-                    !r.isCollection) {</span>
<a href="#l57.17"></a><span id="l57.17" class="difflineminus">-                    r.href = this.calendar.ensureDecodedPath(r.href);</span>
<a href="#l57.18"></a><span id="l57.18" class="difflineplus">+                let resp = this.currentResponse;</span>
<a href="#l57.19"></a><span id="l57.19" class="difflineplus">+                if (resp.getetag &amp;&amp; resp.getetag.length &amp;&amp;</span>
<a href="#l57.20"></a><span id="l57.20" class="difflineplus">+                    resp.href &amp;&amp; resp.href.length &amp;&amp;</span>
<a href="#l57.21"></a><span id="l57.21" class="difflineplus">+                    resp.getcontenttype &amp;&amp; resp.getcontenttype.length &amp;&amp;</span>
<a href="#l57.22"></a><span id="l57.22" class="difflineplus">+                    !resp.isCollection) {</span>
<a href="#l57.23"></a><span id="l57.23" class="difflineplus">+                    resp.href = this.calendar.ensureDecodedPath(resp.href);</span>
<a href="#l57.24"></a><span id="l57.24"> </span>
<a href="#l57.25"></a><span id="l57.25" class="difflineminus">-                    if (r.getcontenttype.substr(0, 14) == &quot;message/rfc822&quot;) {</span>
<a href="#l57.26"></a><span id="l57.26" class="difflineplus">+                    if (resp.getcontenttype.substr(0, 14) == &quot;message/rfc822&quot;) {</span>
<a href="#l57.27"></a><span id="l57.27">                         // workaround for a Scalix bug which causes incorrect</span>
<a href="#l57.28"></a><span id="l57.28">                         // contenttype to be returned.</span>
<a href="#l57.29"></a><span id="l57.29" class="difflineminus">-                        r.getcontenttype = &quot;text/calendar&quot;;</span>
<a href="#l57.30"></a><span id="l57.30" class="difflineplus">+                        resp.getcontenttype = &quot;text/calendar&quot;;</span>
<a href="#l57.31"></a><span id="l57.31">                     }</span>
<a href="#l57.32"></a><span id="l57.32" class="difflineminus">-                    if (r.getcontenttype == &quot;text/vtodo&quot;) {</span>
<a href="#l57.33"></a><span id="l57.33" class="difflineplus">+                    if (resp.getcontenttype == &quot;text/vtodo&quot;) {</span>
<a href="#l57.34"></a><span id="l57.34">                         // workaround Kerio wierdness</span>
<a href="#l57.35"></a><span id="l57.35" class="difflineminus">-                        r.getcontenttype = &quot;text/calendar&quot;;</span>
<a href="#l57.36"></a><span id="l57.36" class="difflineplus">+                        resp.getcontenttype = &quot;text/calendar&quot;;</span>
<a href="#l57.37"></a><span id="l57.37">                     }</span>
<a href="#l57.38"></a><span id="l57.38"> </span>
<a href="#l57.39"></a><span id="l57.39">                     // Only handle calendar items</span>
<a href="#l57.40"></a><span id="l57.40" class="difflineminus">-                    if (r.getcontenttype.substr(0, 13) == &quot;text/calendar&quot;) {</span>
<a href="#l57.41"></a><span id="l57.41" class="difflineminus">-                        if (r.href &amp;&amp; r.href.length) {</span>
<a href="#l57.42"></a><span id="l57.42" class="difflineminus">-                            this.itemsReported[r.href] = r.getetag;</span>
<a href="#l57.43"></a><span id="l57.43" class="difflineplus">+                    if (resp.getcontenttype.substr(0, 13) == &quot;text/calendar&quot;) {</span>
<a href="#l57.44"></a><span id="l57.44" class="difflineplus">+                        if (resp.href &amp;&amp; resp.href.length) {</span>
<a href="#l57.45"></a><span id="l57.45" class="difflineplus">+                            this.itemsReported[resp.href] = resp.getetag;</span>
<a href="#l57.46"></a><span id="l57.46"> </span>
<a href="#l57.47"></a><span id="l57.47" class="difflineminus">-                            let itemUid = this.calendar.mHrefIndex[r.href];</span>
<a href="#l57.48"></a><span id="l57.48" class="difflineplus">+                            let itemUid = this.calendar.mHrefIndex[resp.href];</span>
<a href="#l57.49"></a><span id="l57.49">                             if (!itemUid ||</span>
<a href="#l57.50"></a><span id="l57.50" class="difflineminus">-                                r.getetag != this.calendar.mItemInfoCache[itemUid].etag) {</span>
<a href="#l57.51"></a><span id="l57.51" class="difflineminus">-                                this.itemsNeedFetching.push(r.href);</span>
<a href="#l57.52"></a><span id="l57.52" class="difflineplus">+                                resp.getetag != this.calendar.mItemInfoCache[itemUid].etag) {</span>
<a href="#l57.53"></a><span id="l57.53" class="difflineplus">+                                this.itemsNeedFetching.push(resp.href);</span>
<a href="#l57.54"></a><span id="l57.54">                             }</span>
<a href="#l57.55"></a><span id="l57.55">                         }</span>
<a href="#l57.56"></a><span id="l57.56">                     }</span>
<a href="#l57.57"></a><span id="l57.57">                 }</span>
<a href="#l57.58"></a><span id="l57.58">                 break;</span>
<a href="#l57.59"></a><span id="l57.59">             case &quot;href&quot;:</span>
<a href="#l57.60"></a><span id="l57.60">             case &quot;getetag&quot;:</span>
<a href="#l57.61"></a><span id="l57.61">             case &quot;getcontenttype&quot;:</span>
<a href="#l57.62"></a><span id="l57.62" class="difflineat">@@ -528,93 +528,93 @@ webDavSyncHandler.prototype = {</span>
<a href="#l57.63"></a><span id="l57.63">             this.logXML += &quot;&lt;&quot; + aQName + &quot;&gt;&quot;;</span>
<a href="#l57.64"></a><span id="l57.64">         }</span>
<a href="#l57.65"></a><span id="l57.65">     },</span>
<a href="#l57.66"></a><span id="l57.66"> </span>
<a href="#l57.67"></a><span id="l57.67">     endElement: function(aUri, aLocalName, aQName) {</span>
<a href="#l57.68"></a><span id="l57.68">         switch (aLocalName) {</span>
<a href="#l57.69"></a><span id="l57.69">             case &quot;response&quot;: // WebDAV Sync draft 3</span>
<a href="#l57.70"></a><span id="l57.70">             case &quot;sync-response&quot;: // WebDAV Sync draft 0,1,2</span>
<a href="#l57.71"></a><span id="l57.71" class="difflineminus">-                let r = this.currentResponse;</span>
<a href="#l57.72"></a><span id="l57.72" class="difflineminus">-                if (r.href &amp;&amp; r.href.length) {</span>
<a href="#l57.73"></a><span id="l57.73" class="difflineminus">-                    r.href = this.calendar.ensureDecodedPath(r.href);</span>
<a href="#l57.74"></a><span id="l57.74" class="difflineplus">+                let resp = this.currentResponse;</span>
<a href="#l57.75"></a><span id="l57.75" class="difflineplus">+                if (resp.href &amp;&amp; resp.href.length) {</span>
<a href="#l57.76"></a><span id="l57.76" class="difflineplus">+                    resp.href = this.calendar.ensureDecodedPath(resp.href);</span>
<a href="#l57.77"></a><span id="l57.77">                 }</span>
<a href="#l57.78"></a><span id="l57.78"> </span>
<a href="#l57.79"></a><span id="l57.79" class="difflineminus">-                if ((!r.getcontenttype || r.getcontenttype == &quot;text/plain&quot;) &amp;&amp;</span>
<a href="#l57.80"></a><span id="l57.80" class="difflineminus">-                    r.href &amp;&amp;</span>
<a href="#l57.81"></a><span id="l57.81" class="difflineminus">-                    r.href.endsWith(&quot;.ics&quot;)) {</span>
<a href="#l57.82"></a><span id="l57.82" class="difflineplus">+                if ((!resp.getcontenttype || resp.getcontenttype == &quot;text/plain&quot;) &amp;&amp;</span>
<a href="#l57.83"></a><span id="l57.83" class="difflineplus">+                    resp.href &amp;&amp;</span>
<a href="#l57.84"></a><span id="l57.84" class="difflineplus">+                    resp.href.endsWith(&quot;.ics&quot;)) {</span>
<a href="#l57.85"></a><span id="l57.85">                   // If there is no content-type (iCloud) or text/plain was passed</span>
<a href="#l57.86"></a><span id="l57.86">                   // (iCal Server) for the resource but its name ends with &quot;.ics&quot;</span>
<a href="#l57.87"></a><span id="l57.87">                   // assume the content type to be text/calendar. Apple</span>
<a href="#l57.88"></a><span id="l57.88">                   // iCloud/iCal Server interoperability fix.</span>
<a href="#l57.89"></a><span id="l57.89" class="difflineminus">-                  r.getcontenttype = &quot;text/calendar&quot;;</span>
<a href="#l57.90"></a><span id="l57.90" class="difflineplus">+                  resp.getcontenttype = &quot;text/calendar&quot;;</span>
<a href="#l57.91"></a><span id="l57.91">                 }</span>
<a href="#l57.92"></a><span id="l57.92"> </span>
<a href="#l57.93"></a><span id="l57.93">                 // Deleted item</span>
<a href="#l57.94"></a><span id="l57.94" class="difflineminus">-                if (r.href &amp;&amp; r.href.length &amp;&amp;</span>
<a href="#l57.95"></a><span id="l57.95" class="difflineminus">-                    r.status &amp;&amp;</span>
<a href="#l57.96"></a><span id="l57.96" class="difflineminus">-                    r.status.length &amp;&amp;</span>
<a href="#l57.97"></a><span id="l57.97" class="difflineminus">-                    r.status.indexOf(&quot; 404&quot;) &gt; 0) {</span>
<a href="#l57.98"></a><span id="l57.98" class="difflineminus">-                    if (this.calendar.mHrefIndex[r.href]) {</span>
<a href="#l57.99"></a><span id="l57.99" class="difflineplus">+                if (resp.href &amp;&amp; resp.href.length &amp;&amp;</span>
<a href="#l57.100"></a><span id="l57.100" class="difflineplus">+                    resp.status &amp;&amp;</span>
<a href="#l57.101"></a><span id="l57.101" class="difflineplus">+                    resp.status.length &amp;&amp;</span>
<a href="#l57.102"></a><span id="l57.102" class="difflineplus">+                    resp.status.indexOf(&quot; 404&quot;) &gt; 0) {</span>
<a href="#l57.103"></a><span id="l57.103" class="difflineplus">+                    if (this.calendar.mHrefIndex[resp.href]) {</span>
<a href="#l57.104"></a><span id="l57.104">                         this.changeCount++;</span>
<a href="#l57.105"></a><span id="l57.105" class="difflineminus">-                        this.calendar.deleteTargetCalendarItem(r.href);</span>
<a href="#l57.106"></a><span id="l57.106" class="difflineplus">+                        this.calendar.deleteTargetCalendarItem(resp.href);</span>
<a href="#l57.107"></a><span id="l57.107">                     } else {</span>
<a href="#l57.108"></a><span id="l57.108" class="difflineminus">-                        cal.LOG(&quot;CalDAV: skipping unfound deleted item : &quot; + r.href);</span>
<a href="#l57.109"></a><span id="l57.109" class="difflineplus">+                        cal.LOG(&quot;CalDAV: skipping unfound deleted item : &quot; + resp.href);</span>
<a href="#l57.110"></a><span id="l57.110">                     }</span>
<a href="#l57.111"></a><span id="l57.111">                 // Only handle Created or Updated calendar items</span>
<a href="#l57.112"></a><span id="l57.112" class="difflineminus">-                } else if (r.getcontenttype &amp;&amp;</span>
<a href="#l57.113"></a><span id="l57.113" class="difflineminus">-                           r.getcontenttype.substr(0, 13) == &quot;text/calendar&quot; &amp;&amp;</span>
<a href="#l57.114"></a><span id="l57.114" class="difflineminus">-                           r.getetag &amp;&amp; r.getetag.length &amp;&amp;</span>
<a href="#l57.115"></a><span id="l57.115" class="difflineminus">-                           r.href &amp;&amp; r.href.length &amp;&amp;</span>
<a href="#l57.116"></a><span id="l57.116" class="difflineminus">-                           (!r.status ||                 // Draft 3 does not require</span>
<a href="#l57.117"></a><span id="l57.117" class="difflineminus">-                            r.status.length == 0 ||      // a status for created or updated items but</span>
<a href="#l57.118"></a><span id="l57.118" class="difflineminus">-                            r.status.indexOf(&quot; 204&quot;) ||  // draft 0, 1 and 2 needed it so treat no status</span>
<a href="#l57.119"></a><span id="l57.119" class="difflineminus">-                            r.status.indexOf(&quot; 200&quot;) ||  // Apple iCloud returns 200 status for each item</span>
<a href="#l57.120"></a><span id="l57.120" class="difflineminus">-                            r.status.indexOf(&quot; 201&quot;))) { // and status 201 and 204 the same</span>
<a href="#l57.121"></a><span id="l57.121" class="difflineminus">-                    this.itemsReported[r.href] = r.getetag;</span>
<a href="#l57.122"></a><span id="l57.122" class="difflineminus">-                    let itemId = this.calendar.mHrefIndex[r.href];</span>
<a href="#l57.123"></a><span id="l57.123" class="difflineplus">+                } else if (resp.getcontenttype &amp;&amp;</span>
<a href="#l57.124"></a><span id="l57.124" class="difflineplus">+                           resp.getcontenttype.substr(0, 13) == &quot;text/calendar&quot; &amp;&amp;</span>
<a href="#l57.125"></a><span id="l57.125" class="difflineplus">+                           resp.getetag &amp;&amp; resp.getetag.length &amp;&amp;</span>
<a href="#l57.126"></a><span id="l57.126" class="difflineplus">+                           resp.href &amp;&amp; resp.href.length &amp;&amp;</span>
<a href="#l57.127"></a><span id="l57.127" class="difflineplus">+                           (!resp.status ||                 // Draft 3 does not require</span>
<a href="#l57.128"></a><span id="l57.128" class="difflineplus">+                            resp.status.length == 0 ||      // a status for created or updated items but</span>
<a href="#l57.129"></a><span id="l57.129" class="difflineplus">+                            resp.status.indexOf(&quot; 204&quot;) ||  // draft 0, 1 and 2 needed it so treat no status</span>
<a href="#l57.130"></a><span id="l57.130" class="difflineplus">+                            resp.status.indexOf(&quot; 200&quot;) ||  // Apple iCloud returns 200 status for each item</span>
<a href="#l57.131"></a><span id="l57.131" class="difflineplus">+                            resp.status.indexOf(&quot; 201&quot;))) { // and status 201 and 204 the same</span>
<a href="#l57.132"></a><span id="l57.132" class="difflineplus">+                    this.itemsReported[resp.href] = resp.getetag;</span>
<a href="#l57.133"></a><span id="l57.133" class="difflineplus">+                    let itemId = this.calendar.mHrefIndex[resp.href];</span>
<a href="#l57.134"></a><span id="l57.134">                     let oldEtag = itemId &amp;&amp; this.calendar.mItemInfoCache[itemId].etag;</span>
<a href="#l57.135"></a><span id="l57.135"> </span>
<a href="#l57.136"></a><span id="l57.136" class="difflineminus">-                    if (!oldEtag || oldEtag != r.getetag) {</span>
<a href="#l57.137"></a><span id="l57.137" class="difflineplus">+                    if (!oldEtag || oldEtag != resp.getetag) {</span>
<a href="#l57.138"></a><span id="l57.138">                         // Etag mismatch, getting new/updated item.</span>
<a href="#l57.139"></a><span id="l57.139" class="difflineminus">-                        this.itemsNeedFetching.push(r.href);</span>
<a href="#l57.140"></a><span id="l57.140" class="difflineplus">+                        this.itemsNeedFetching.push(resp.href);</span>
<a href="#l57.141"></a><span id="l57.141">                     }</span>
<a href="#l57.142"></a><span id="l57.142" class="difflineminus">-                } else if (r.status &amp;&amp;</span>
<a href="#l57.143"></a><span id="l57.143" class="difflineminus">-                           r.status.includes(&quot; 507&quot;)) {</span>
<a href="#l57.144"></a><span id="l57.144" class="difflineplus">+                } else if (resp.status &amp;&amp;</span>
<a href="#l57.145"></a><span id="l57.145" class="difflineplus">+                           resp.status.includes(&quot; 507&quot;)) {</span>
<a href="#l57.146"></a><span id="l57.146">                     // webdav-sync says that if a 507 is encountered and the</span>
<a href="#l57.147"></a><span id="l57.147">                     // url matches the request, the current token should be</span>
<a href="#l57.148"></a><span id="l57.148">                     // saved and another request should be made. We don't</span>
<a href="#l57.149"></a><span id="l57.149">                     // actually compare the URL, its too easy to get this</span>
<a href="#l57.150"></a><span id="l57.150">                     // wrong.</span>
<a href="#l57.151"></a><span id="l57.151"> </span>
<a href="#l57.152"></a><span id="l57.152">                     // The 507 doesn't mean the data received is invalid, so</span>
<a href="#l57.153"></a><span id="l57.153">                     // continue processing.</span>
<a href="#l57.154"></a><span id="l57.154">                     this.additionalSyncNeeded = true;</span>
<a href="#l57.155"></a><span id="l57.155" class="difflineminus">-                } else if (r.status &amp;&amp;</span>
<a href="#l57.156"></a><span id="l57.156" class="difflineminus">-                           r.status.indexOf(&quot; 200&quot;) &amp;&amp;</span>
<a href="#l57.157"></a><span id="l57.157" class="difflineminus">-                           r.href &amp;&amp;</span>
<a href="#l57.158"></a><span id="l57.158" class="difflineminus">-                           r.href.endsWith(&quot;/&quot;)) {</span>
<a href="#l57.159"></a><span id="l57.159" class="difflineplus">+                } else if (resp.status &amp;&amp;</span>
<a href="#l57.160"></a><span id="l57.160" class="difflineplus">+                           resp.status.indexOf(&quot; 200&quot;) &amp;&amp;</span>
<a href="#l57.161"></a><span id="l57.161" class="difflineplus">+                           resp.href &amp;&amp;</span>
<a href="#l57.162"></a><span id="l57.162" class="difflineplus">+                           resp.href.endsWith(&quot;/&quot;)) {</span>
<a href="#l57.163"></a><span id="l57.163">                     // iCloud returns status responses for directories too</span>
<a href="#l57.164"></a><span id="l57.164">                     // so we just ignore them if they have status code 200. We</span>
<a href="#l57.165"></a><span id="l57.165">                     // want to make sure these are not counted as unhandled</span>
<a href="#l57.166"></a><span id="l57.166">                     // errors in the next block</span>
<a href="#l57.167"></a><span id="l57.167" class="difflineminus">-                } else if ((r.getcontenttype &amp;&amp;</span>
<a href="#l57.168"></a><span id="l57.168" class="difflineminus">-                            r.getcontenttype.startsWith(&quot;text/calendar&quot;)) ||</span>
<a href="#l57.169"></a><span id="l57.169" class="difflineminus">-                           (r.status &amp;&amp;</span>
<a href="#l57.170"></a><span id="l57.170" class="difflineminus">-                            !r.status.includes(&quot; 404&quot;))) {</span>
<a href="#l57.171"></a><span id="l57.171" class="difflineplus">+                } else if ((resp.getcontenttype &amp;&amp;</span>
<a href="#l57.172"></a><span id="l57.172" class="difflineplus">+                            resp.getcontenttype.startsWith(&quot;text/calendar&quot;)) ||</span>
<a href="#l57.173"></a><span id="l57.173" class="difflineplus">+                           (resp.status &amp;&amp;</span>
<a href="#l57.174"></a><span id="l57.174" class="difflineplus">+                            !resp.status.includes(&quot; 404&quot;))) {</span>
<a href="#l57.175"></a><span id="l57.175">                     // If the response element is still not handled, log an</span>
<a href="#l57.176"></a><span id="l57.176">                     // error only if the content-type is text/calendar or the</span>
<a href="#l57.177"></a><span id="l57.177">                     // response status is different than 404 not found.  We</span>
<a href="#l57.178"></a><span id="l57.178">                     // don't care about response elements on non-calendar</span>
<a href="#l57.179"></a><span id="l57.179">                     // resources or whose status is not indicating a deleted</span>
<a href="#l57.180"></a><span id="l57.180">                     // resource.</span>
<a href="#l57.181"></a><span id="l57.181" class="difflineminus">-                    cal.WARN(&quot;CalDAV: Unexpected response, status: &quot; + r.status + &quot;, href: &quot; + r.href);</span>
<a href="#l57.182"></a><span id="l57.182" class="difflineplus">+                    cal.WARN(&quot;CalDAV: Unexpected response, status: &quot; + resp.status + &quot;, href: &quot; + resp.href);</span>
<a href="#l57.183"></a><span id="l57.183">                     this.unhandledErrors++;</span>
<a href="#l57.184"></a><span id="l57.184">                 } else {</span>
<a href="#l57.185"></a><span id="l57.185" class="difflineminus">-                    cal.LOG(&quot;CalDAV: Unhandled response element, status: &quot; + r.status + &quot;, href: &quot; + r.href + &quot; contenttype:&quot; + r.getcontenttype);</span>
<a href="#l57.186"></a><span id="l57.186" class="difflineplus">+                    cal.LOG(&quot;CalDAV: Unhandled response element, status: &quot; + resp.status + &quot;, href: &quot; + resp.href + &quot; contenttype:&quot; + resp.getcontenttype);</span>
<a href="#l57.187"></a><span id="l57.187">                 }</span>
<a href="#l57.188"></a><span id="l57.188">                 break;</span>
<a href="#l57.189"></a><span id="l57.189">             case &quot;sync-token&quot;:</span>
<a href="#l57.190"></a><span id="l57.190">                 this.newSyncToken = this.currentResponse[this.tag];</span>
<a href="#l57.191"></a><span id="l57.191">                 break;</span>
<a href="#l57.192"></a><span id="l57.192">             case &quot;propstat&quot;:</span>
<a href="#l57.193"></a><span id="l57.193">                 this.isInPropStat = false;</span>
<a href="#l57.194"></a><span id="l57.194">                 break;</span>
<a href="#l57.195"></a><span id="l57.195" class="difflineat">@@ -881,55 +881,55 @@ multigetSyncHandler.prototype = {</span>
<a href="#l57.196"></a><span id="l57.196">         if (this.calendar.verboseLogging()) {</span>
<a href="#l57.197"></a><span id="l57.197">             this.logXML += &quot;&lt;&quot; + aQName + &quot;&gt;&quot;;</span>
<a href="#l57.198"></a><span id="l57.198">         }</span>
<a href="#l57.199"></a><span id="l57.199">     },</span>
<a href="#l57.200"></a><span id="l57.200"> </span>
<a href="#l57.201"></a><span id="l57.201">     endElement: function(aUri, aLocalName, aQName) {</span>
<a href="#l57.202"></a><span id="l57.202">         switch (aLocalName) {</span>
<a href="#l57.203"></a><span id="l57.203">             case &quot;response&quot;:</span>
<a href="#l57.204"></a><span id="l57.204" class="difflineminus">-                let r = this.currentResponse;</span>
<a href="#l57.205"></a><span id="l57.205" class="difflineminus">-                if (r.href &amp;&amp;</span>
<a href="#l57.206"></a><span id="l57.206" class="difflineminus">-                    r.href.length) {</span>
<a href="#l57.207"></a><span id="l57.207" class="difflineminus">-                    r.href = this.calendar.ensureDecodedPath(r.href);</span>
<a href="#l57.208"></a><span id="l57.208" class="difflineplus">+                let resp = this.currentResponse;</span>
<a href="#l57.209"></a><span id="l57.209" class="difflineplus">+                if (resp.href &amp;&amp;</span>
<a href="#l57.210"></a><span id="l57.210" class="difflineplus">+                    resp.href.length) {</span>
<a href="#l57.211"></a><span id="l57.211" class="difflineplus">+                    resp.href = this.calendar.ensureDecodedPath(resp.href);</span>
<a href="#l57.212"></a><span id="l57.212">                 }</span>
<a href="#l57.213"></a><span id="l57.213" class="difflineminus">-                if (r.href &amp;&amp; r.href.length &amp;&amp;</span>
<a href="#l57.214"></a><span id="l57.214" class="difflineminus">-                    r.status &amp;&amp;</span>
<a href="#l57.215"></a><span id="l57.215" class="difflineminus">-                    r.status.length &amp;&amp;</span>
<a href="#l57.216"></a><span id="l57.216" class="difflineminus">-                    r.status.indexOf(&quot; 404&quot;) &gt; 0) {</span>
<a href="#l57.217"></a><span id="l57.217" class="difflineminus">-                    if (this.calendar.mHrefIndex[r.href]) {</span>
<a href="#l57.218"></a><span id="l57.218" class="difflineplus">+                if (resp.href &amp;&amp; resp.href.length &amp;&amp;</span>
<a href="#l57.219"></a><span id="l57.219" class="difflineplus">+                    resp.status &amp;&amp;</span>
<a href="#l57.220"></a><span id="l57.220" class="difflineplus">+                    resp.status.length &amp;&amp;</span>
<a href="#l57.221"></a><span id="l57.221" class="difflineplus">+                    resp.status.indexOf(&quot; 404&quot;) &gt; 0) {</span>
<a href="#l57.222"></a><span id="l57.222" class="difflineplus">+                    if (this.calendar.mHrefIndex[resp.href]) {</span>
<a href="#l57.223"></a><span id="l57.223">                         this.changeCount++;</span>
<a href="#l57.224"></a><span id="l57.224" class="difflineminus">-                        this.calendar.deleteTargetCalendarItem(r.href);</span>
<a href="#l57.225"></a><span id="l57.225" class="difflineplus">+                        this.calendar.deleteTargetCalendarItem(resp.href);</span>
<a href="#l57.226"></a><span id="l57.226">                     } else {</span>
<a href="#l57.227"></a><span id="l57.227" class="difflineminus">-                        cal.LOG(&quot;CalDAV: skipping unfound deleted item : &quot; + r.href);</span>
<a href="#l57.228"></a><span id="l57.228" class="difflineplus">+                        cal.LOG(&quot;CalDAV: skipping unfound deleted item : &quot; + resp.href);</span>
<a href="#l57.229"></a><span id="l57.229">                     }</span>
<a href="#l57.230"></a><span id="l57.230">                 // Created or Updated item</span>
<a href="#l57.231"></a><span id="l57.231" class="difflineminus">-                } else if (r.getetag &amp;&amp; r.getetag.length &amp;&amp;</span>
<a href="#l57.232"></a><span id="l57.232" class="difflineminus">-                           r.href &amp;&amp; r.href.length &amp;&amp;</span>
<a href="#l57.233"></a><span id="l57.233" class="difflineminus">-                           r.calendardata &amp;&amp; r.calendardata.length) {</span>
<a href="#l57.234"></a><span id="l57.234" class="difflineplus">+                } else if (resp.getetag &amp;&amp; resp.getetag.length &amp;&amp;</span>
<a href="#l57.235"></a><span id="l57.235" class="difflineplus">+                           resp.href &amp;&amp; resp.href.length &amp;&amp;</span>
<a href="#l57.236"></a><span id="l57.236" class="difflineplus">+                           resp.calendardata &amp;&amp; resp.calendardata.length) {</span>
<a href="#l57.237"></a><span id="l57.237">                     let oldEtag;</span>
<a href="#l57.238"></a><span id="l57.238" class="difflineminus">-                    let itemId = this.calendar.mHrefIndex[r.href];</span>
<a href="#l57.239"></a><span id="l57.239" class="difflineplus">+                    let itemId = this.calendar.mHrefIndex[resp.href];</span>
<a href="#l57.240"></a><span id="l57.240">                     if (itemId) {</span>
<a href="#l57.241"></a><span id="l57.241">                         oldEtag = this.calendar.mItemInfoCache[itemId].etag;</span>
<a href="#l57.242"></a><span id="l57.242">                     } else {</span>
<a href="#l57.243"></a><span id="l57.243">                         oldEtag = null;</span>
<a href="#l57.244"></a><span id="l57.244">                     }</span>
<a href="#l57.245"></a><span id="l57.245" class="difflineminus">-                    if (!oldEtag || oldEtag != r.getetag) {</span>
<a href="#l57.246"></a><span id="l57.246" class="difflineplus">+                    if (!oldEtag || oldEtag != resp.getetag) {</span>
<a href="#l57.247"></a><span id="l57.247">                         this.changeCount++;</span>
<a href="#l57.248"></a><span id="l57.248" class="difflineminus">-                        this.calendar.addTargetCalendarItem(r.href,</span>
<a href="#l57.249"></a><span id="l57.249" class="difflineminus">-                                                            r.calendardata,</span>
<a href="#l57.250"></a><span id="l57.250" class="difflineplus">+                        this.calendar.addTargetCalendarItem(resp.href,</span>
<a href="#l57.251"></a><span id="l57.251" class="difflineplus">+                                                            resp.calendardata,</span>
<a href="#l57.252"></a><span id="l57.252">                                                             this.baseUri,</span>
<a href="#l57.253"></a><span id="l57.253" class="difflineminus">-                                                            r.getetag,</span>
<a href="#l57.254"></a><span id="l57.254" class="difflineplus">+                                                            resp.getetag,</span>
<a href="#l57.255"></a><span id="l57.255">                                                             this.listener);</span>
<a href="#l57.256"></a><span id="l57.256">                     } else {</span>
<a href="#l57.257"></a><span id="l57.257">                         cal.LOG(&quot;CalDAV: skipping item with unmodified etag : &quot; + oldEtag);</span>
<a href="#l57.258"></a><span id="l57.258">                     }</span>
<a href="#l57.259"></a><span id="l57.259">                 } else {</span>
<a href="#l57.260"></a><span id="l57.260">                     cal.WARN(&quot;CalDAV: Unexpected response, status: &quot; +</span>
<a href="#l57.261"></a><span id="l57.261" class="difflineminus">-                             r.status + &quot;, href: &quot; + r.href + &quot; calendar-data:\n&quot; + r.calendardata);</span>
<a href="#l57.262"></a><span id="l57.262" class="difflineplus">+                             resp.status + &quot;, href: &quot; + resp.href + &quot; calendar-data:\n&quot; + resp.calendardata);</span>
<a href="#l57.263"></a><span id="l57.263">                     this.unhandledErrors++;</span>
<a href="#l57.264"></a><span id="l57.264">                 }</span>
<a href="#l57.265"></a><span id="l57.265">                 break;</span>
<a href="#l57.266"></a><span id="l57.266">             case &quot;propstat&quot;:</span>
<a href="#l57.267"></a><span id="l57.267">                 this.isInPropStat = false;</span>
<a href="#l57.268"></a><span id="l57.268">                 break;</span>
<a href="#l57.269"></a><span id="l57.269">         }</span>
<a href="#l57.270"></a><span id="l57.270">         this.tag = null;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l58.1"></a><span id="l58.1" class="difflineminus">--- a/calendar/providers/composite/calCompositeCalendar.js</span>
<a href="#l58.2"></a><span id="l58.2" class="difflineplus">+++ b/calendar/providers/composite/calCompositeCalendar.js</span>
<a href="#l58.3"></a><span id="l58.3" class="difflineat">@@ -133,22 +133,22 @@ calCompositeCalendar.prototype = {</span>
<a href="#l58.4"></a><span id="l58.4">             }</span>
<a href="#l58.5"></a><span id="l58.5">         }</span>
<a href="#l58.6"></a><span id="l58.6">         this.mPrefPrefix = aPrefPrefix;</span>
<a href="#l58.7"></a><span id="l58.7">         this.mActivePref = aPrefPrefix + &quot;-in-composite&quot;;</span>
<a href="#l58.8"></a><span id="l58.8">         this.mDefaultPref = aPrefPrefix + &quot;-default&quot;;</span>
<a href="#l58.9"></a><span id="l58.9">         let mgr = cal.getCalendarManager();</span>
<a href="#l58.10"></a><span id="l58.10">         let cals = mgr.getCalendars({});</span>
<a href="#l58.11"></a><span id="l58.11"> </span>
<a href="#l58.12"></a><span id="l58.12" class="difflineminus">-        cals.forEach(function(c) {</span>
<a href="#l58.13"></a><span id="l58.13" class="difflineminus">-            if (c.getProperty(this.mActivePref)) {</span>
<a href="#l58.14"></a><span id="l58.14" class="difflineminus">-                this.addCalendar(c);</span>
<a href="#l58.15"></a><span id="l58.15" class="difflineplus">+        cals.forEach(function(calendar) {</span>
<a href="#l58.16"></a><span id="l58.16" class="difflineplus">+            if (calendar.getProperty(this.mActivePref)) {</span>
<a href="#l58.17"></a><span id="l58.17" class="difflineplus">+                this.addCalendar(calendar);</span>
<a href="#l58.18"></a><span id="l58.18">             }</span>
<a href="#l58.19"></a><span id="l58.19" class="difflineminus">-            if (c.getProperty(this.mDefaultPref)) {</span>
<a href="#l58.20"></a><span id="l58.20" class="difflineminus">-                this.setDefaultCalendar(c, false);</span>
<a href="#l58.21"></a><span id="l58.21" class="difflineplus">+            if (calendar.getProperty(this.mDefaultPref)) {</span>
<a href="#l58.22"></a><span id="l58.22" class="difflineplus">+                this.setDefaultCalendar(calendar, false);</span>
<a href="#l58.23"></a><span id="l58.23">             }</span>
<a href="#l58.24"></a><span id="l58.24">         }, this);</span>
<a href="#l58.25"></a><span id="l58.25">     },</span>
<a href="#l58.26"></a><span id="l58.26"> </span>
<a href="#l58.27"></a><span id="l58.27">     get prefPrefix() {</span>
<a href="#l58.28"></a><span id="l58.28">         return this.mPrefPrefix;</span>
<a href="#l58.29"></a><span id="l58.29">     },</span>
<a href="#l58.30"></a><span id="l58.30"> </span>
<a href="#l58.31"></a><span id="l58.31" class="difflineat">@@ -220,18 +220,18 @@ calCompositeCalendar.prototype = {</span>
<a href="#l58.32"></a><span id="l58.32">             if (calendar) {</span>
<a href="#l58.33"></a><span id="l58.33">                 calendar.setProperty(this.mDefaultPref, true);</span>
<a href="#l58.34"></a><span id="l58.34">             }</span>
<a href="#l58.35"></a><span id="l58.35">         }</span>
<a href="#l58.36"></a><span id="l58.36">         this.mDefaultCalendar = calendar;</span>
<a href="#l58.37"></a><span id="l58.37">         this.mCompositeObservers.notify(&quot;onDefaultCalendarChanged&quot;, [calendar]);</span>
<a href="#l58.38"></a><span id="l58.38">     },</span>
<a href="#l58.39"></a><span id="l58.39"> </span>
<a href="#l58.40"></a><span id="l58.40" class="difflineminus">-    set defaultCalendar(v) {</span>
<a href="#l58.41"></a><span id="l58.41" class="difflineminus">-        this.setDefaultCalendar(v, true);</span>
<a href="#l58.42"></a><span id="l58.42" class="difflineplus">+    set defaultCalendar(calendar) {</span>
<a href="#l58.43"></a><span id="l58.43" class="difflineplus">+        this.setDefaultCalendar(calendar, true);</span>
<a href="#l58.44"></a><span id="l58.44">     },</span>
<a href="#l58.45"></a><span id="l58.45"> </span>
<a href="#l58.46"></a><span id="l58.46">     //</span>
<a href="#l58.47"></a><span id="l58.47">     // calICalendar interface</span>
<a href="#l58.48"></a><span id="l58.48">     //</span>
<a href="#l58.49"></a><span id="l58.49">     // Write operations here are forwarded to either the item's</span>
<a href="#l58.50"></a><span id="l58.50">     // parent calendar, or to the default calendar if one is set.</span>
<a href="#l58.51"></a><span id="l58.51">     // Get operations are sent to each calendar.</span>
<a href="#l58.52"></a><span id="l58.52" class="difflineat">@@ -253,17 +253,17 @@ calCompositeCalendar.prototype = {</span>
<a href="#l58.53"></a><span id="l58.53">     },</span>
<a href="#l58.54"></a><span id="l58.54"> </span>
<a href="#l58.55"></a><span id="l58.55">     // this could, at some point, return some kind of URI identifying</span>
<a href="#l58.56"></a><span id="l58.56">     // all the child calendars, thus letting us create nifty calendar</span>
<a href="#l58.57"></a><span id="l58.57">     // trees.</span>
<a href="#l58.58"></a><span id="l58.58">     get uri() {</span>
<a href="#l58.59"></a><span id="l58.59">         throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l58.60"></a><span id="l58.60">     },</span>
<a href="#l58.61"></a><span id="l58.61" class="difflineminus">-    set uri(v) {</span>
<a href="#l58.62"></a><span id="l58.62" class="difflineplus">+    set uri(val) {</span>
<a href="#l58.63"></a><span id="l58.63">         throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l58.64"></a><span id="l58.64">     },</span>
<a href="#l58.65"></a><span id="l58.65"> </span>
<a href="#l58.66"></a><span id="l58.66">     get readOnly() {</span>
<a href="#l58.67"></a><span id="l58.67">         throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l58.68"></a><span id="l58.68">     },</span>
<a href="#l58.69"></a><span id="l58.69">     set readOnly(bool) {</span>
<a href="#l58.70"></a><span id="l58.70">         throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l58.71"></a><span id="l58.71" class="difflineat">@@ -271,17 +271,17 @@ calCompositeCalendar.prototype = {</span>
<a href="#l58.72"></a><span id="l58.72"> </span>
<a href="#l58.73"></a><span id="l58.73">     get canRefresh() {</span>
<a href="#l58.74"></a><span id="l58.74">         return true;</span>
<a href="#l58.75"></a><span id="l58.75">     },</span>
<a href="#l58.76"></a><span id="l58.76"> </span>
<a href="#l58.77"></a><span id="l58.77">     get name() {</span>
<a href="#l58.78"></a><span id="l58.78">         throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l58.79"></a><span id="l58.79">     },</span>
<a href="#l58.80"></a><span id="l58.80" class="difflineminus">-    set name(v) {</span>
<a href="#l58.81"></a><span id="l58.81" class="difflineplus">+    set name(val) {</span>
<a href="#l58.82"></a><span id="l58.82">         throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l58.83"></a><span id="l58.83">     },</span>
<a href="#l58.84"></a><span id="l58.84"> </span>
<a href="#l58.85"></a><span id="l58.85">     get type() {</span>
<a href="#l58.86"></a><span id="l58.86">         return &quot;composite&quot;;</span>
<a href="#l58.87"></a><span id="l58.87">     },</span>
<a href="#l58.88"></a><span id="l58.88"> </span>
<a href="#l58.89"></a><span id="l58.89">     getProperty: function(aName) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l59.1"></a><span id="l59.1" class="difflineminus">--- a/calendar/providers/ics/calICSCalendar.js</span>
<a href="#l59.2"></a><span id="l59.2" class="difflineplus">+++ b/calendar/providers/ics/calICSCalendar.js</span>
<a href="#l59.3"></a><span id="l59.3" class="difflineat">@@ -14,22 +14,22 @@ Components.utils.import(&quot;resource://cale</span>
<a href="#l59.4"></a><span id="l59.4"> // calICSCalendar.js</span>
<a href="#l59.5"></a><span id="l59.5"> //</span>
<a href="#l59.6"></a><span id="l59.6"> // This is a non-sync ics file. It reads the file pointer to by uri when set,</span>
<a href="#l59.7"></a><span id="l59.7"> // then writes it on updates. External changes to the file will be</span>
<a href="#l59.8"></a><span id="l59.8"> // ignored and overwritten.</span>
<a href="#l59.9"></a><span id="l59.9"> //</span>
<a href="#l59.10"></a><span id="l59.10"> // XXX Should do locks, so that external changes are not overwritten.</span>
<a href="#l59.11"></a><span id="l59.11"> </span>
<a href="#l59.12"></a><span id="l59.12" class="difflineminus">-var CI = Components.interfaces;</span>
<a href="#l59.13"></a><span id="l59.13" class="difflineplus">+var Ci = Components.interfaces;</span>
<a href="#l59.14"></a><span id="l59.14"> var calICalendar = Components.interfaces.calICalendar;</span>
<a href="#l59.15"></a><span id="l59.15"> var calIErrors = Components.interfaces.calIErrors;</span>
<a href="#l59.16"></a><span id="l59.16"> </span>
<a href="#l59.17"></a><span id="l59.17"> function icsNSResolver(prefix) {</span>
<a href="#l59.18"></a><span id="l59.18" class="difflineminus">-    const ns = { D: &quot;DAV:&quot; };</span>
<a href="#l59.19"></a><span id="l59.19" class="difflineplus">+    const ns = { D: &quot;DAV:&quot; }; // eslint-disable-line id-length</span>
<a href="#l59.20"></a><span id="l59.20">     return ns[prefix] || null;</span>
<a href="#l59.21"></a><span id="l59.21"> }</span>
<a href="#l59.22"></a><span id="l59.22"> </span>
<a href="#l59.23"></a><span id="l59.23"> function icsXPathFirst(aNode, aExpr, aType) {</span>
<a href="#l59.24"></a><span id="l59.24">     return cal.xml.evalXPathFirst(aNode, aExpr, icsNSResolver, aType);</span>
<a href="#l59.25"></a><span id="l59.25"> }</span>
<a href="#l59.26"></a><span id="l59.26"> </span>
<a href="#l59.27"></a><span id="l59.27"> function calICSCalendar() {</span>
<a href="#l59.28"></a><span id="l59.28" class="difflineat">@@ -647,34 +647,34 @@ calICSCalendar.prototype = {</span>
<a href="#l59.29"></a><span id="l59.29">         // but we don't use that file. All we want is a filename, to be used</span>
<a href="#l59.30"></a><span id="l59.30">         // in the call to copyTo later. So we create a file, get the filename,</span>
<a href="#l59.31"></a><span id="l59.31">         // and never use the file again, but write over it.</span>
<a href="#l59.32"></a><span id="l59.32">         // Using createUnique anyway, because I don't feel like</span>
<a href="#l59.33"></a><span id="l59.33">         // re-implementing it</span>
<a href="#l59.34"></a><span id="l59.34">         function makeDailyFileName() {</span>
<a href="#l59.35"></a><span id="l59.35">             let dailyBackupFile = backupDir.clone();</span>
<a href="#l59.36"></a><span id="l59.36">             dailyBackupFile.append(makeName(&quot;day&quot;));</span>
<a href="#l59.37"></a><span id="l59.37" class="difflineminus">-            dailyBackupFile.createUnique(CI.nsIFile.NORMAL_FILE_TYPE,</span>
<a href="#l59.38"></a><span id="l59.38" class="difflineplus">+            dailyBackupFile.createUnique(Ci.nsIFile.NORMAL_FILE_TYPE,</span>
<a href="#l59.39"></a><span id="l59.39">                                          parseInt(&quot;0600&quot;, 8));</span>
<a href="#l59.40"></a><span id="l59.40">             dailyBackupFileName = dailyBackupFile.leafName;</span>
<a href="#l59.41"></a><span id="l59.41"> </span>
<a href="#l59.42"></a><span id="l59.42">             // Remove the reference to the nsIFile, because we need to</span>
<a href="#l59.43"></a><span id="l59.43">             // write over the file later, and you never know what happens</span>
<a href="#l59.44"></a><span id="l59.44">             // if something still has a reference.</span>
<a href="#l59.45"></a><span id="l59.45">             // Also makes it explicit that we don't need the file itself,</span>
<a href="#l59.46"></a><span id="l59.46">             // just the name.</span>
<a href="#l59.47"></a><span id="l59.47">             dailyBackupFile = null;</span>
<a href="#l59.48"></a><span id="l59.48"> </span>
<a href="#l59.49"></a><span id="l59.49">             return dailyBackupFileName;</span>
<a href="#l59.50"></a><span id="l59.50">         }</span>
<a href="#l59.51"></a><span id="l59.51"> </span>
<a href="#l59.52"></a><span id="l59.52">         function purgeBackupsByType(files, type) {</span>
<a href="#l59.53"></a><span id="l59.53">             // filter out backups of the type we care about.</span>
<a href="#l59.54"></a><span id="l59.54">             let filteredFiles = files.filter(</span>
<a href="#l59.55"></a><span id="l59.55" class="difflineminus">-                v =&gt; v.name.includes(&quot;calBackupData_&quot; + pseudoID + &quot;_&quot; + type)</span>
<a href="#l59.56"></a><span id="l59.56" class="difflineplus">+                file =&gt; file.name.includes(&quot;calBackupData_&quot; + pseudoID + &quot;_&quot; + type)</span>
<a href="#l59.57"></a><span id="l59.57">             );</span>
<a href="#l59.58"></a><span id="l59.58">             // Sort by lastmodifed</span>
<a href="#l59.59"></a><span id="l59.59">             filteredFiles.sort((a, b) =&gt; a.lastmodified - b.lastmodified);</span>
<a href="#l59.60"></a><span id="l59.60">             // And delete the oldest files, and keep the desired number of</span>
<a href="#l59.61"></a><span id="l59.61">             // old backups</span>
<a href="#l59.62"></a><span id="l59.62">             for (let i = 0; i &lt; filteredFiles.length - numBackupFiles; ++i) {</span>
<a href="#l59.63"></a><span id="l59.63">                 let file = backupDir.clone();</span>
<a href="#l59.64"></a><span id="l59.64">                 file.append(filteredFiles[i].name);</span>
<a href="#l59.65"></a><span id="l59.65" class="difflineat">@@ -690,17 +690,17 @@ calICSCalendar.prototype = {</span>
<a href="#l59.66"></a><span id="l59.66">             return;</span>
<a href="#l59.67"></a><span id="l59.67">         }</span>
<a href="#l59.68"></a><span id="l59.68"> </span>
<a href="#l59.69"></a><span id="l59.69">         function purgeOldBackups() {</span>
<a href="#l59.70"></a><span id="l59.70">             // Enumerate files in the backupdir for expiry of old backups</span>
<a href="#l59.71"></a><span id="l59.71">             let dirEnum = backupDir.directoryEntries;</span>
<a href="#l59.72"></a><span id="l59.72">             let files = [];</span>
<a href="#l59.73"></a><span id="l59.73">             while (dirEnum.hasMoreElements()) {</span>
<a href="#l59.74"></a><span id="l59.74" class="difflineminus">-                let file = dirEnum.getNext().QueryInterface(CI.nsIFile);</span>
<a href="#l59.75"></a><span id="l59.75" class="difflineplus">+                let file = dirEnum.getNext().QueryInterface(Ci.nsIFile);</span>
<a href="#l59.76"></a><span id="l59.76">                 if (file.isFile()) {</span>
<a href="#l59.77"></a><span id="l59.77">                     files.push({ name: file.leafName, lastmodified: file.lastModifiedTime });</span>
<a href="#l59.78"></a><span id="l59.78">                 }</span>
<a href="#l59.79"></a><span id="l59.79">             }</span>
<a href="#l59.80"></a><span id="l59.80"> </span>
<a href="#l59.81"></a><span id="l59.81">             if (doDailyBackup) {</span>
<a href="#l59.82"></a><span id="l59.82">                 purgeBackupsByType(files, &quot;day&quot;);</span>
<a href="#l59.83"></a><span id="l59.83">             } else {</span>
<a href="#l59.84"></a><span id="l59.84" class="difflineat">@@ -729,17 +729,17 @@ calICSCalendar.prototype = {</span>
<a href="#l59.85"></a><span id="l59.85">         let backupDays = Preferences.get(&quot;calendar.backup.days&quot;, 1);</span>
<a href="#l59.86"></a><span id="l59.86">         let numBackupFiles = Preferences.get(&quot;calendar.backup.filenum&quot;, 3);</span>
<a href="#l59.87"></a><span id="l59.87"> </span>
<a href="#l59.88"></a><span id="l59.88">         let backupDir;</span>
<a href="#l59.89"></a><span id="l59.89">         try {</span>
<a href="#l59.90"></a><span id="l59.90">             backupDir = cal.getCalendarDirectory();</span>
<a href="#l59.91"></a><span id="l59.91">             backupDir.append(&quot;backup&quot;);</span>
<a href="#l59.92"></a><span id="l59.92">             if (!backupDir.exists()) {</span>
<a href="#l59.93"></a><span id="l59.93" class="difflineminus">-                backupDir.create(CI.nsIFile.DIRECTORY_TYPE, parseInt(&quot;0755&quot;, 8));</span>
<a href="#l59.94"></a><span id="l59.94" class="difflineplus">+                backupDir.create(Ci.nsIFile.DIRECTORY_TYPE, parseInt(&quot;0755&quot;, 8));</span>
<a href="#l59.95"></a><span id="l59.95">             }</span>
<a href="#l59.96"></a><span id="l59.96">         } catch (e) {</span>
<a href="#l59.97"></a><span id="l59.97">             // Backup dir wasn't found. Likely because we are running in</span>
<a href="#l59.98"></a><span id="l59.98">             // xpcshell. Don't die, but continue the upload.</span>
<a href="#l59.99"></a><span id="l59.99">             cal.ERROR(&quot;[calICSCalendar] Backup failed, no backupdir:&quot; + e);</span>
<a href="#l59.100"></a><span id="l59.100">             aCallback.call(this);</span>
<a href="#l59.101"></a><span id="l59.101">             return;</span>
<a href="#l59.102"></a><span id="l59.102">         }</span>
<a href="#l59.103"></a><span id="l59.103" class="difflineat">@@ -777,32 +777,32 @@ calICSCalendar.prototype = {</span>
<a href="#l59.104"></a><span id="l59.104"> </span>
<a href="#l59.105"></a><span id="l59.105">         let dailyBackupFileName;</span>
<a href="#l59.106"></a><span id="l59.106">         if (doDailyBackup) {</span>
<a href="#l59.107"></a><span id="l59.107">             dailyBackupFileName = makeDailyFileName(backupDir);</span>
<a href="#l59.108"></a><span id="l59.108">         }</span>
<a href="#l59.109"></a><span id="l59.109"> </span>
<a href="#l59.110"></a><span id="l59.110">         let backupFile = backupDir.clone();</span>
<a href="#l59.111"></a><span id="l59.111">         backupFile.append(makeName(&quot;edit&quot;));</span>
<a href="#l59.112"></a><span id="l59.112" class="difflineminus">-        backupFile.createUnique(CI.nsIFile.NORMAL_FILE_TYPE, parseInt(&quot;0600&quot;, 8));</span>
<a href="#l59.113"></a><span id="l59.113" class="difflineplus">+        backupFile.createUnique(Ci.nsIFile.NORMAL_FILE_TYPE, parseInt(&quot;0600&quot;, 8));</span>
<a href="#l59.114"></a><span id="l59.114"> </span>
<a href="#l59.115"></a><span id="l59.115">         purgeOldBackups();</span>
<a href="#l59.116"></a><span id="l59.116"> </span>
<a href="#l59.117"></a><span id="l59.117">         // Now go download the remote file, and store it somewhere local.</span>
<a href="#l59.118"></a><span id="l59.118">         let channel = Services.io.newChannelFromURI2(this.mUri,</span>
<a href="#l59.119"></a><span id="l59.119">                                                      null,</span>
<a href="#l59.120"></a><span id="l59.120">                                                      Services.scriptSecurityManager.getSystemPrincipal(),</span>
<a href="#l59.121"></a><span id="l59.121">                                                      null,</span>
<a href="#l59.122"></a><span id="l59.122">                                                      Components.interfaces.nsILoadInfo.SEC_NORMAL,</span>
<a href="#l59.123"></a><span id="l59.123">                                                      Components.interfaces.nsIContentPolicy.TYPE_OTHER);</span>
<a href="#l59.124"></a><span id="l59.124">         channel.loadFlags |= Components.interfaces.nsIRequest.LOAD_BYPASS_CACHE;</span>
<a href="#l59.125"></a><span id="l59.125">         channel.notificationCallbacks = this;</span>
<a href="#l59.126"></a><span id="l59.126"> </span>
<a href="#l59.127"></a><span id="l59.127">         let downloader = Components.classes[&quot;@mozilla.org/network/downloader;1&quot;]</span>
<a href="#l59.128"></a><span id="l59.128" class="difflineminus">-                                   .createInstance(CI.nsIDownloader);</span>
<a href="#l59.129"></a><span id="l59.129" class="difflineplus">+                                   .createInstance(Ci.nsIDownloader);</span>
<a href="#l59.130"></a><span id="l59.130"> </span>
<a href="#l59.131"></a><span id="l59.131">         let self = this;</span>
<a href="#l59.132"></a><span id="l59.132">         let listener = {</span>
<a href="#l59.133"></a><span id="l59.133">             onDownloadComplete: function(opdownloader, request, ctxt, status, result) {</span>
<a href="#l59.134"></a><span id="l59.134">                 if (doInitialBackup) {</span>
<a href="#l59.135"></a><span id="l59.135">                     copyToOverwriting(result, backupDir, makeName(&quot;initial&quot;));</span>
<a href="#l59.136"></a><span id="l59.136">                 }</span>
<a href="#l59.137"></a><span id="l59.137">                 if (doDailyBackup) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l60.1"></a><span id="l60.1" class="difflineminus">--- a/calendar/providers/storage/calStorageCalendar.js</span>
<a href="#l60.2"></a><span id="l60.2" class="difflineplus">+++ b/calendar/providers/storage/calStorageCalendar.js</span>
<a href="#l60.3"></a><span id="l60.3" class="difflineat">@@ -802,36 +802,36 @@ calStorageCalendar.prototype = {</span>
<a href="#l60.4"></a><span id="l60.4">                 return true;</span>
<a href="#l60.5"></a><span id="l60.5">             }</span>
<a href="#l60.6"></a><span id="l60.6"> </span>
<a href="#l60.7"></a><span id="l60.7">             return false;</span>
<a href="#l60.8"></a><span id="l60.8">         }</span>
<a href="#l60.9"></a><span id="l60.9"> </span>
<a href="#l60.10"></a><span id="l60.10">         // First fetch all the events</span>
<a href="#l60.11"></a><span id="l60.11">         if (wantEvents) {</span>
<a href="#l60.12"></a><span id="l60.12" class="difflineminus">-            let sp;             // stmt params</span>
<a href="#l60.13"></a><span id="l60.13" class="difflineplus">+            let params;             // stmt params</span>
<a href="#l60.14"></a><span id="l60.14">             let resultItems = [];</span>
<a href="#l60.15"></a><span id="l60.15"> </span>
<a href="#l60.16"></a><span id="l60.16">             // first get non-recurring events that happen to fall within the range</span>
<a href="#l60.17"></a><span id="l60.17">             //</span>
<a href="#l60.18"></a><span id="l60.18">             try {</span>
<a href="#l60.19"></a><span id="l60.19">                 this.prepareStatement(this.mSelectNonRecurringEventsByRange);</span>
<a href="#l60.20"></a><span id="l60.20" class="difflineminus">-                sp = this.mSelectNonRecurringEventsByRange.params;</span>
<a href="#l60.21"></a><span id="l60.21" class="difflineminus">-                sp.range_start = startTime;</span>
<a href="#l60.22"></a><span id="l60.22" class="difflineminus">-                sp.range_end = endTime;</span>
<a href="#l60.23"></a><span id="l60.23" class="difflineminus">-                sp.start_offset = aRangeStart ? aRangeStart.timezoneOffset * USECS_PER_SECOND : 0;</span>
<a href="#l60.24"></a><span id="l60.24" class="difflineminus">-                sp.end_offset = aRangeEnd ? aRangeEnd.timezoneOffset * USECS_PER_SECOND : 0;</span>
<a href="#l60.25"></a><span id="l60.25" class="difflineminus">-                sp.offline_journal = null;</span>
<a href="#l60.26"></a><span id="l60.26" class="difflineplus">+                params = this.mSelectNonRecurringEventsByRange.params;</span>
<a href="#l60.27"></a><span id="l60.27" class="difflineplus">+                params.range_start = startTime;</span>
<a href="#l60.28"></a><span id="l60.28" class="difflineplus">+                params.range_end = endTime;</span>
<a href="#l60.29"></a><span id="l60.29" class="difflineplus">+                params.start_offset = aRangeStart ? aRangeStart.timezoneOffset * USECS_PER_SECOND : 0;</span>
<a href="#l60.30"></a><span id="l60.30" class="difflineplus">+                params.end_offset = aRangeEnd ? aRangeEnd.timezoneOffset * USECS_PER_SECOND : 0;</span>
<a href="#l60.31"></a><span id="l60.31" class="difflineplus">+                params.offline_journal = null;</span>
<a href="#l60.32"></a><span id="l60.32"> </span>
<a href="#l60.33"></a><span id="l60.33">                 if (wantOfflineDeletedItems) {</span>
<a href="#l60.34"></a><span id="l60.34" class="difflineminus">-                    sp.offline_journal = cICL.OFFLINE_FLAG_DELETED_RECORD;</span>
<a href="#l60.35"></a><span id="l60.35" class="difflineplus">+                    params.offline_journal = cICL.OFFLINE_FLAG_DELETED_RECORD;</span>
<a href="#l60.36"></a><span id="l60.36">                 } else if (wantOfflineCreatedItems) {</span>
<a href="#l60.37"></a><span id="l60.37" class="difflineminus">-                    sp.offline_journal = cICL.OFFLINE_FLAG_CREATED_RECORD;</span>
<a href="#l60.38"></a><span id="l60.38" class="difflineplus">+                    params.offline_journal = cICL.OFFLINE_FLAG_CREATED_RECORD;</span>
<a href="#l60.39"></a><span id="l60.39">                 } else if (wantOfflineModifiedItems) {</span>
<a href="#l60.40"></a><span id="l60.40" class="difflineminus">-                    sp.offline_journal = cICL.OFFLINE_FLAG_MODIFIED_RECORD;</span>
<a href="#l60.41"></a><span id="l60.41" class="difflineplus">+                    params.offline_journal = cICL.OFFLINE_FLAG_MODIFIED_RECORD;</span>
<a href="#l60.42"></a><span id="l60.42">                 }</span>
<a href="#l60.43"></a><span id="l60.43"> </span>
<a href="#l60.44"></a><span id="l60.44">                 while (this.mSelectNonRecurringEventsByRange.executeStep()) {</span>
<a href="#l60.45"></a><span id="l60.45">                     let row = this.mSelectNonRecurringEventsByRange.row;</span>
<a href="#l60.46"></a><span id="l60.46">                     resultItems.push(this.getEventFromRow(row, {}));</span>
<a href="#l60.47"></a><span id="l60.47">                 }</span>
<a href="#l60.48"></a><span id="l60.48">             } catch (e) {</span>
<a href="#l60.49"></a><span id="l60.49">                 this.logError(&quot;Error selecting non recurring events by range!\n&quot;, e);</span>
<a href="#l60.50"></a><span id="l60.50" class="difflineat">@@ -846,50 +846,50 @@ calStorageCalendar.prototype = {</span>
<a href="#l60.51"></a><span id="l60.51">                     return;</span>
<a href="#l60.52"></a><span id="l60.52">                 }</span>
<a href="#l60.53"></a><span id="l60.53">             }</span>
<a href="#l60.54"></a><span id="l60.54"> </span>
<a href="#l60.55"></a><span id="l60.55">             // Process the recurring events from the cache</span>
<a href="#l60.56"></a><span id="l60.56">             for (let id in this.mRecEventCache) {</span>
<a href="#l60.57"></a><span id="l60.57">                 let evitem = this.mRecEventCache[id];</span>
<a href="#l60.58"></a><span id="l60.58">                 let offline_journal_flag = this.mRecEventCacheOfflineFlags[evitem.id] || null;</span>
<a href="#l60.59"></a><span id="l60.59" class="difflineminus">-                // No need to return flagged unless asked i.e. sp.offline_journal == offline_journal_flag</span>
<a href="#l60.60"></a><span id="l60.60" class="difflineminus">-                // Return created and modified offline records if sp.offline_journal is null alongwith events that have no flag</span>
<a href="#l60.61"></a><span id="l60.61" class="difflineminus">-                if ((sp.offline_journal == null &amp;&amp; offline_journal_flag != cICL.OFFLINE_FLAG_DELETED_RECORD) ||</span>
<a href="#l60.62"></a><span id="l60.62" class="difflineminus">-                    (sp.offline_journal != null &amp;&amp; offline_journal_flag == sp.offline_journal)) {</span>
<a href="#l60.63"></a><span id="l60.63" class="difflineplus">+                // No need to return flagged unless asked i.e. params.offline_journal == offline_journal_flag</span>
<a href="#l60.64"></a><span id="l60.64" class="difflineplus">+                // Return created and modified offline records if params.offline_journal is null alongwith events that have no flag</span>
<a href="#l60.65"></a><span id="l60.65" class="difflineplus">+                if ((params.offline_journal == null &amp;&amp; offline_journal_flag != cICL.OFFLINE_FLAG_DELETED_RECORD) ||</span>
<a href="#l60.66"></a><span id="l60.66" class="difflineplus">+                    (params.offline_journal != null &amp;&amp; offline_journal_flag == params.offline_journal)) {</span>
<a href="#l60.67"></a><span id="l60.67">                     count += handleResultItem(evitem, Components.interfaces.calIEvent);</span>
<a href="#l60.68"></a><span id="l60.68">                     if (checkCount()) {</span>
<a href="#l60.69"></a><span id="l60.69">                         return;</span>
<a href="#l60.70"></a><span id="l60.70">                     }</span>
<a href="#l60.71"></a><span id="l60.71">                 }</span>
<a href="#l60.72"></a><span id="l60.72">             }</span>
<a href="#l60.73"></a><span id="l60.73">         }</span>
<a href="#l60.74"></a><span id="l60.74"> </span>
<a href="#l60.75"></a><span id="l60.75">         // if todos are wanted, do them next</span>
<a href="#l60.76"></a><span id="l60.76">         if (wantTodos) {</span>
<a href="#l60.77"></a><span id="l60.77" class="difflineminus">-            let sp;             // stmt params</span>
<a href="#l60.78"></a><span id="l60.78" class="difflineplus">+            let params;             // stmt params</span>
<a href="#l60.79"></a><span id="l60.79">             let resultItems = [];</span>
<a href="#l60.80"></a><span id="l60.80"> </span>
<a href="#l60.81"></a><span id="l60.81">             // first get non-recurring todos that happen to fall within the range</span>
<a href="#l60.82"></a><span id="l60.82">             try {</span>
<a href="#l60.83"></a><span id="l60.83">                 this.prepareStatement(this.mSelectNonRecurringTodosByRange);</span>
<a href="#l60.84"></a><span id="l60.84" class="difflineminus">-                sp = this.mSelectNonRecurringTodosByRange.params;</span>
<a href="#l60.85"></a><span id="l60.85" class="difflineminus">-                sp.range_start = startTime;</span>
<a href="#l60.86"></a><span id="l60.86" class="difflineminus">-                sp.range_end = endTime;</span>
<a href="#l60.87"></a><span id="l60.87" class="difflineminus">-                sp.start_offset = aRangeStart ? aRangeStart.timezoneOffset * USECS_PER_SECOND : 0;</span>
<a href="#l60.88"></a><span id="l60.88" class="difflineminus">-                sp.end_offset = aRangeEnd ? aRangeEnd.timezoneOffset * USECS_PER_SECOND : 0;</span>
<a href="#l60.89"></a><span id="l60.89" class="difflineminus">-                sp.offline_journal = null;</span>
<a href="#l60.90"></a><span id="l60.90" class="difflineplus">+                params = this.mSelectNonRecurringTodosByRange.params;</span>
<a href="#l60.91"></a><span id="l60.91" class="difflineplus">+                params.range_start = startTime;</span>
<a href="#l60.92"></a><span id="l60.92" class="difflineplus">+                params.range_end = endTime;</span>
<a href="#l60.93"></a><span id="l60.93" class="difflineplus">+                params.start_offset = aRangeStart ? aRangeStart.timezoneOffset * USECS_PER_SECOND : 0;</span>
<a href="#l60.94"></a><span id="l60.94" class="difflineplus">+                params.end_offset = aRangeEnd ? aRangeEnd.timezoneOffset * USECS_PER_SECOND : 0;</span>
<a href="#l60.95"></a><span id="l60.95" class="difflineplus">+                params.offline_journal = null;</span>
<a href="#l60.96"></a><span id="l60.96">                 if (wantOfflineCreatedItems) {</span>
<a href="#l60.97"></a><span id="l60.97" class="difflineminus">-                    sp.offline_journal = cICL.OFFLINE_FLAG_CREATED_RECORD;</span>
<a href="#l60.98"></a><span id="l60.98" class="difflineplus">+                    params.offline_journal = cICL.OFFLINE_FLAG_CREATED_RECORD;</span>
<a href="#l60.99"></a><span id="l60.99">                 }</span>
<a href="#l60.100"></a><span id="l60.100">                 if (wantOfflineDeletedItems) {</span>
<a href="#l60.101"></a><span id="l60.101" class="difflineminus">-                    sp.offline_journal = cICL.OFFLINE_FLAG_DELETED_RECORD;</span>
<a href="#l60.102"></a><span id="l60.102" class="difflineplus">+                    params.offline_journal = cICL.OFFLINE_FLAG_DELETED_RECORD;</span>
<a href="#l60.103"></a><span id="l60.103">                 }</span>
<a href="#l60.104"></a><span id="l60.104">                 if (wantOfflineModifiedItems) {</span>
<a href="#l60.105"></a><span id="l60.105" class="difflineminus">-                    sp.offline_journal = cICL.OFFLINE_FLAG_MODIFIED_RECORD;</span>
<a href="#l60.106"></a><span id="l60.106" class="difflineplus">+                    params.offline_journal = cICL.OFFLINE_FLAG_MODIFIED_RECORD;</span>
<a href="#l60.107"></a><span id="l60.107">                 }</span>
<a href="#l60.108"></a><span id="l60.108"> </span>
<a href="#l60.109"></a><span id="l60.109">                 while (this.mSelectNonRecurringTodosByRange.executeStep()) {</span>
<a href="#l60.110"></a><span id="l60.110">                     let row = this.mSelectNonRecurringTodosByRange.row;</span>
<a href="#l60.111"></a><span id="l60.111">                     resultItems.push(this.getTodoFromRow(row, {}));</span>
<a href="#l60.112"></a><span id="l60.112">                 }</span>
<a href="#l60.113"></a><span id="l60.113">             } catch (e) {</span>
<a href="#l60.114"></a><span id="l60.114">                 this.logError(&quot;Error selecting non recurring todos by range&quot;, e);</span>
<a href="#l60.115"></a><span id="l60.115" class="difflineat">@@ -908,22 +908,22 @@ calStorageCalendar.prototype = {</span>
<a href="#l60.116"></a><span id="l60.116">             // Note: Reading the code, completed *occurrences* seems to be broken, because</span>
<a href="#l60.117"></a><span id="l60.117">             //       only the parent item has been filtered; I fixed that.</span>
<a href="#l60.118"></a><span id="l60.118">             //       Moreover item.todo_complete etc seems to be a leftover...</span>
<a href="#l60.119"></a><span id="l60.119"> </span>
<a href="#l60.120"></a><span id="l60.120">             // process the recurring todos from the cache</span>
<a href="#l60.121"></a><span id="l60.121">             for (let id in this.mRecTodoCache) {</span>
<a href="#l60.122"></a><span id="l60.122">                 let todoitem = this.mRecTodoCache[id];</span>
<a href="#l60.123"></a><span id="l60.123">                 let offline_journal_flag = this.mRecTodoCacheOfflineFlags[todoitem.id] || null;</span>
<a href="#l60.124"></a><span id="l60.124" class="difflineminus">-                if ((sp.offline_journal == null &amp;&amp;</span>
<a href="#l60.125"></a><span id="l60.125" class="difflineplus">+                if ((params.offline_journal == null &amp;&amp;</span>
<a href="#l60.126"></a><span id="l60.126">                      (offline_journal_flag == cICL.OFFLINE_FLAG_MODIFIED_RECORD ||</span>
<a href="#l60.127"></a><span id="l60.127">                       offline_journal_flag == cICL.OFFLINE_FLAG_CREATED_RECORD ||</span>
<a href="#l60.128"></a><span id="l60.128">                       offline_journal_flag == null)) ||</span>
<a href="#l60.129"></a><span id="l60.129" class="difflineminus">-                    (sp.offline_journal != null &amp;&amp;</span>
<a href="#l60.130"></a><span id="l60.130" class="difflineminus">-                     (offline_journal_flag == sp.offline_journal))) {</span>
<a href="#l60.131"></a><span id="l60.131" class="difflineplus">+                    (params.offline_journal != null &amp;&amp;</span>
<a href="#l60.132"></a><span id="l60.132" class="difflineplus">+                     (offline_journal_flag == params.offline_journal))) {</span>
<a href="#l60.133"></a><span id="l60.133">                     count += handleResultItem(todoitem,</span>
<a href="#l60.134"></a><span id="l60.134">                                               Components.interfaces.calITodo,</span>
<a href="#l60.135"></a><span id="l60.135">                                               checkCompleted);</span>
<a href="#l60.136"></a><span id="l60.136">                     if (checkCount()) {</span>
<a href="#l60.137"></a><span id="l60.137">                         return;</span>
<a href="#l60.138"></a><span id="l60.138">                     }</span>
<a href="#l60.139"></a><span id="l60.139">                 }</span>
<a href="#l60.140"></a><span id="l60.140">             }</span>
<a href="#l60.141"></a><span id="l60.141" class="difflineat">@@ -1948,22 +1948,22 @@ calStorageCalendar.prototype = {</span>
<a href="#l60.142"></a><span id="l60.142"> </span>
<a href="#l60.143"></a><span id="l60.143">     //</span>
<a href="#l60.144"></a><span id="l60.144">     // database writing functions</span>
<a href="#l60.145"></a><span id="l60.145">     //</span>
<a href="#l60.146"></a><span id="l60.146"> </span>
<a href="#l60.147"></a><span id="l60.147">     setDateParamHelper: function(params, entryname, cdt) {</span>
<a href="#l60.148"></a><span id="l60.148">         if (cdt) {</span>
<a href="#l60.149"></a><span id="l60.149">             params[entryname] = cdt.nativeTime;</span>
<a href="#l60.150"></a><span id="l60.150" class="difflineminus">-            let tz = cdt.timezone;</span>
<a href="#l60.151"></a><span id="l60.151" class="difflineminus">-            let ownTz = cal.getTimezoneService().getTimezone(tz.tzid);</span>
<a href="#l60.152"></a><span id="l60.152" class="difflineplus">+            let timezone = cdt.timezone;</span>
<a href="#l60.153"></a><span id="l60.153" class="difflineplus">+            let ownTz = cal.getTimezoneService().getTimezone(timezone.tzid);</span>
<a href="#l60.154"></a><span id="l60.154">             if (ownTz) { // if we know that TZID, we use it</span>
<a href="#l60.155"></a><span id="l60.155">                 params[entryname + &quot;_tz&quot;] = ownTz.tzid;</span>
<a href="#l60.156"></a><span id="l60.156" class="difflineminus">-            } else if (tz.icalComponent) { // foreign one</span>
<a href="#l60.157"></a><span id="l60.157" class="difflineminus">-                params[entryname + &quot;_tz&quot;] = tz.icalComponent.serializeToICS();</span>
<a href="#l60.158"></a><span id="l60.158" class="difflineplus">+            } else if (timezone.icalComponent) { // foreign one</span>
<a href="#l60.159"></a><span id="l60.159" class="difflineplus">+                params[entryname + &quot;_tz&quot;] = timezone.icalComponent.serializeToICS();</span>
<a href="#l60.160"></a><span id="l60.160">             } else { // timezone component missing</span>
<a href="#l60.161"></a><span id="l60.161">                 params[entryname + &quot;_tz&quot;] = &quot;floating&quot;;</span>
<a href="#l60.162"></a><span id="l60.162">             }</span>
<a href="#l60.163"></a><span id="l60.163">         } else {</span>
<a href="#l60.164"></a><span id="l60.164">             params[entryname] = null;</span>
<a href="#l60.165"></a><span id="l60.165">             params[entryname + &quot;_tz&quot;] = null;</span>
<a href="#l60.166"></a><span id="l60.166">         }</span>
<a href="#l60.167"></a><span id="l60.167">     },</span>
<a href="#l60.168"></a><span id="l60.168" class="difflineat">@@ -2008,142 +2008,142 @@ calStorageCalendar.prototype = {</span>
<a href="#l60.169"></a><span id="l60.169">         } else {</span>
<a href="#l60.170"></a><span id="l60.170">             throw Components.results.NS_ERROR_UNEXPECTED;</span>
<a href="#l60.171"></a><span id="l60.171">         }</span>
<a href="#l60.172"></a><span id="l60.172">     },</span>
<a href="#l60.173"></a><span id="l60.173"> </span>
<a href="#l60.174"></a><span id="l60.174">     writeEvent: function(item, olditem, flags) {</span>
<a href="#l60.175"></a><span id="l60.175">         try {</span>
<a href="#l60.176"></a><span id="l60.176">             this.prepareStatement(this.mInsertEvent);</span>
<a href="#l60.177"></a><span id="l60.177" class="difflineminus">-            let ip = this.mInsertEvent.params;</span>
<a href="#l60.178"></a><span id="l60.178" class="difflineminus">-            this.setupItemBaseParams(item, olditem, ip);</span>
<a href="#l60.179"></a><span id="l60.179" class="difflineplus">+            let params = this.mInsertEvent.params;</span>
<a href="#l60.180"></a><span id="l60.180" class="difflineplus">+            this.setupItemBaseParams(item, olditem, params);</span>
<a href="#l60.181"></a><span id="l60.181"> </span>
<a href="#l60.182"></a><span id="l60.182" class="difflineminus">-            this.setDateParamHelper(ip, &quot;event_start&quot;, item.startDate);</span>
<a href="#l60.183"></a><span id="l60.183" class="difflineminus">-            this.setDateParamHelper(ip, &quot;event_end&quot;, item.endDate);</span>
<a href="#l60.184"></a><span id="l60.184" class="difflineplus">+            this.setDateParamHelper(params, &quot;event_start&quot;, item.startDate);</span>
<a href="#l60.185"></a><span id="l60.185" class="difflineplus">+            this.setDateParamHelper(params, &quot;event_end&quot;, item.endDate);</span>
<a href="#l60.186"></a><span id="l60.186">             let dtstamp = item.stampTime;</span>
<a href="#l60.187"></a><span id="l60.187">             if (dtstamp) {</span>
<a href="#l60.188"></a><span id="l60.188" class="difflineminus">-                ip.event_stamp = dtstamp.nativeTime;</span>
<a href="#l60.189"></a><span id="l60.189" class="difflineplus">+                params.event_stamp = dtstamp.nativeTime;</span>
<a href="#l60.190"></a><span id="l60.190">             }</span>
<a href="#l60.191"></a><span id="l60.191"> </span>
<a href="#l60.192"></a><span id="l60.192">             if (item.startDate.isDate) {</span>
<a href="#l60.193"></a><span id="l60.193">                 flags |= CAL_ITEM_FLAG.EVENT_ALLDAY;</span>
<a href="#l60.194"></a><span id="l60.194">             }</span>
<a href="#l60.195"></a><span id="l60.195"> </span>
<a href="#l60.196"></a><span id="l60.196" class="difflineminus">-            ip.flags = flags;</span>
<a href="#l60.197"></a><span id="l60.197" class="difflineplus">+            params.flags = flags;</span>
<a href="#l60.198"></a><span id="l60.198"> </span>
<a href="#l60.199"></a><span id="l60.199">             this.mInsertEvent.executeStep();</span>
<a href="#l60.200"></a><span id="l60.200">         } finally {</span>
<a href="#l60.201"></a><span id="l60.201">             this.mInsertEvent.reset();</span>
<a href="#l60.202"></a><span id="l60.202">         }</span>
<a href="#l60.203"></a><span id="l60.203">     },</span>
<a href="#l60.204"></a><span id="l60.204"> </span>
<a href="#l60.205"></a><span id="l60.205">     writeTodo: function(item, olditem, flags) {</span>
<a href="#l60.206"></a><span id="l60.206">         try {</span>
<a href="#l60.207"></a><span id="l60.207">             this.prepareStatement(this.mInsertTodo);</span>
<a href="#l60.208"></a><span id="l60.208" class="difflineminus">-            let ip = this.mInsertTodo.params;</span>
<a href="#l60.209"></a><span id="l60.209" class="difflineplus">+            let params = this.mInsertTodo.params;</span>
<a href="#l60.210"></a><span id="l60.210"> </span>
<a href="#l60.211"></a><span id="l60.211" class="difflineminus">-            this.setupItemBaseParams(item, olditem, ip);</span>
<a href="#l60.212"></a><span id="l60.212" class="difflineplus">+            this.setupItemBaseParams(item, olditem, params);</span>
<a href="#l60.213"></a><span id="l60.213"> </span>
<a href="#l60.214"></a><span id="l60.214" class="difflineminus">-            this.setDateParamHelper(ip, &quot;todo_entry&quot;, item.entryDate);</span>
<a href="#l60.215"></a><span id="l60.215" class="difflineminus">-            this.setDateParamHelper(ip, &quot;todo_due&quot;, item.dueDate);</span>
<a href="#l60.216"></a><span id="l60.216" class="difflineplus">+            this.setDateParamHelper(params, &quot;todo_entry&quot;, item.entryDate);</span>
<a href="#l60.217"></a><span id="l60.217" class="difflineplus">+            this.setDateParamHelper(params, &quot;todo_due&quot;, item.dueDate);</span>
<a href="#l60.218"></a><span id="l60.218">             let dtstamp = item.stampTime;</span>
<a href="#l60.219"></a><span id="l60.219">             if (dtstamp) {</span>
<a href="#l60.220"></a><span id="l60.220" class="difflineminus">-                ip.todo_stamp = dtstamp.nativeTime;</span>
<a href="#l60.221"></a><span id="l60.221" class="difflineplus">+                params.todo_stamp = dtstamp.nativeTime;</span>
<a href="#l60.222"></a><span id="l60.222">             }</span>
<a href="#l60.223"></a><span id="l60.223" class="difflineminus">-            this.setDateParamHelper(ip, &quot;todo_completed&quot;, item.getProperty(&quot;COMPLETED&quot;));</span>
<a href="#l60.224"></a><span id="l60.224" class="difflineplus">+            this.setDateParamHelper(params, &quot;todo_completed&quot;, item.getProperty(&quot;COMPLETED&quot;));</span>
<a href="#l60.225"></a><span id="l60.225"> </span>
<a href="#l60.226"></a><span id="l60.226" class="difflineminus">-            ip.todo_complete = item.getProperty(&quot;PERCENT-COMPLETED&quot;);</span>
<a href="#l60.227"></a><span id="l60.227" class="difflineplus">+            params.todo_complete = item.getProperty(&quot;PERCENT-COMPLETED&quot;);</span>
<a href="#l60.228"></a><span id="l60.228"> </span>
<a href="#l60.229"></a><span id="l60.229">             let someDate = item.entryDate || item.dueDate;</span>
<a href="#l60.230"></a><span id="l60.230">             if (someDate &amp;&amp; someDate.isDate) {</span>
<a href="#l60.231"></a><span id="l60.231">                 flags |= CAL_ITEM_FLAG.EVENT_ALLDAY;</span>
<a href="#l60.232"></a><span id="l60.232">             }</span>
<a href="#l60.233"></a><span id="l60.233"> </span>
<a href="#l60.234"></a><span id="l60.234" class="difflineminus">-            ip.flags = flags;</span>
<a href="#l60.235"></a><span id="l60.235" class="difflineplus">+            params.flags = flags;</span>
<a href="#l60.236"></a><span id="l60.236"> </span>
<a href="#l60.237"></a><span id="l60.237">             this.mInsertTodo.executeStep();</span>
<a href="#l60.238"></a><span id="l60.238">         } finally {</span>
<a href="#l60.239"></a><span id="l60.239">             this.mInsertTodo.reset();</span>
<a href="#l60.240"></a><span id="l60.240">         }</span>
<a href="#l60.241"></a><span id="l60.241">     },</span>
<a href="#l60.242"></a><span id="l60.242"> </span>
<a href="#l60.243"></a><span id="l60.243" class="difflineminus">-    setupItemBaseParams: function(item, olditem, ip) {</span>
<a href="#l60.244"></a><span id="l60.244" class="difflineminus">-        ip.id = item.id;</span>
<a href="#l60.245"></a><span id="l60.245" class="difflineplus">+    setupItemBaseParams: function(item, olditem, params) {</span>
<a href="#l60.246"></a><span id="l60.246" class="difflineplus">+        params.id = item.id;</span>
<a href="#l60.247"></a><span id="l60.247"> </span>
<a href="#l60.248"></a><span id="l60.248">         if (item.recurrenceId) {</span>
<a href="#l60.249"></a><span id="l60.249" class="difflineminus">-            this.setDateParamHelper(ip, &quot;recurrence_id&quot;, item.recurrenceId);</span>
<a href="#l60.250"></a><span id="l60.250" class="difflineplus">+            this.setDateParamHelper(params, &quot;recurrence_id&quot;, item.recurrenceId);</span>
<a href="#l60.251"></a><span id="l60.251">         }</span>
<a href="#l60.252"></a><span id="l60.252"> </span>
<a href="#l60.253"></a><span id="l60.253">         let tmp;</span>
<a href="#l60.254"></a><span id="l60.254"> </span>
<a href="#l60.255"></a><span id="l60.255">         if ((tmp = item.getProperty(&quot;CREATED&quot;))) {</span>
<a href="#l60.256"></a><span id="l60.256" class="difflineminus">-            ip.time_created = tmp.nativeTime;</span>
<a href="#l60.257"></a><span id="l60.257" class="difflineplus">+            params.time_created = tmp.nativeTime;</span>
<a href="#l60.258"></a><span id="l60.258">         }</span>
<a href="#l60.259"></a><span id="l60.259">         if ((tmp = item.getProperty(&quot;LAST-MODIFIED&quot;))) {</span>
<a href="#l60.260"></a><span id="l60.260" class="difflineminus">-            ip.last_modified = tmp.nativeTime;</span>
<a href="#l60.261"></a><span id="l60.261" class="difflineplus">+            params.last_modified = tmp.nativeTime;</span>
<a href="#l60.262"></a><span id="l60.262">         }</span>
<a href="#l60.263"></a><span id="l60.263"> </span>
<a href="#l60.264"></a><span id="l60.264" class="difflineminus">-        ip.title = item.getProperty(&quot;SUMMARY&quot;);</span>
<a href="#l60.265"></a><span id="l60.265" class="difflineminus">-        ip.priority = item.getProperty(&quot;PRIORITY&quot;);</span>
<a href="#l60.266"></a><span id="l60.266" class="difflineminus">-        ip.privacy = item.getProperty(&quot;CLASS&quot;);</span>
<a href="#l60.267"></a><span id="l60.267" class="difflineminus">-        ip.ical_status = item.getProperty(&quot;STATUS&quot;);</span>
<a href="#l60.268"></a><span id="l60.268" class="difflineplus">+        params.title = item.getProperty(&quot;SUMMARY&quot;);</span>
<a href="#l60.269"></a><span id="l60.269" class="difflineplus">+        params.priority = item.getProperty(&quot;PRIORITY&quot;);</span>
<a href="#l60.270"></a><span id="l60.270" class="difflineplus">+        params.privacy = item.getProperty(&quot;CLASS&quot;);</span>
<a href="#l60.271"></a><span id="l60.271" class="difflineplus">+        params.ical_status = item.getProperty(&quot;STATUS&quot;);</span>
<a href="#l60.272"></a><span id="l60.272"> </span>
<a href="#l60.273"></a><span id="l60.273">         if (item.alarmLastAck) {</span>
<a href="#l60.274"></a><span id="l60.274" class="difflineminus">-            ip.alarm_last_ack = item.alarmLastAck.nativeTime;</span>
<a href="#l60.275"></a><span id="l60.275" class="difflineplus">+            params.alarm_last_ack = item.alarmLastAck.nativeTime;</span>
<a href="#l60.276"></a><span id="l60.276">         }</span>
<a href="#l60.277"></a><span id="l60.277">     },</span>
<a href="#l60.278"></a><span id="l60.278"> </span>
<a href="#l60.279"></a><span id="l60.279">     writeAttendees: function(item, olditem) {</span>
<a href="#l60.280"></a><span id="l60.280">         let attendees = item.getAttendees({});</span>
<a href="#l60.281"></a><span id="l60.281">         if (item.organizer) {</span>
<a href="#l60.282"></a><span id="l60.282">             attendees = attendees.concat([]);</span>
<a href="#l60.283"></a><span id="l60.283">             attendees.push(item.organizer);</span>
<a href="#l60.284"></a><span id="l60.284">         }</span>
<a href="#l60.285"></a><span id="l60.285">         if (attendees.length &gt; 0) {</span>
<a href="#l60.286"></a><span id="l60.286">             for (let att of attendees) {</span>
<a href="#l60.287"></a><span id="l60.287" class="difflineminus">-                let ap = this.mInsertAttendee.params;</span>
<a href="#l60.288"></a><span id="l60.288" class="difflineminus">-                ap.item_id = item.id;</span>
<a href="#l60.289"></a><span id="l60.289" class="difflineplus">+                let params = this.mInsertAttendee.params;</span>
<a href="#l60.290"></a><span id="l60.290" class="difflineplus">+                params.item_id = item.id;</span>
<a href="#l60.291"></a><span id="l60.291">                 try {</span>
<a href="#l60.292"></a><span id="l60.292">                     this.prepareStatement(this.mInsertAttendee);</span>
<a href="#l60.293"></a><span id="l60.293" class="difflineminus">-                    this.setDateParamHelper(ap, &quot;recurrence_id&quot;, item.recurrenceId);</span>
<a href="#l60.294"></a><span id="l60.294" class="difflineminus">-                    ap.icalString = att.icalString;</span>
<a href="#l60.295"></a><span id="l60.295" class="difflineplus">+                    this.setDateParamHelper(params, &quot;recurrence_id&quot;, item.recurrenceId);</span>
<a href="#l60.296"></a><span id="l60.296" class="difflineplus">+                    params.icalString = att.icalString;</span>
<a href="#l60.297"></a><span id="l60.297">                     this.mInsertAttendee.executeStep();</span>
<a href="#l60.298"></a><span id="l60.298">                 } finally {</span>
<a href="#l60.299"></a><span id="l60.299">                     this.mInsertAttendee.reset();</span>
<a href="#l60.300"></a><span id="l60.300">                 }</span>
<a href="#l60.301"></a><span id="l60.301">             }</span>
<a href="#l60.302"></a><span id="l60.302"> </span>
<a href="#l60.303"></a><span id="l60.303">             return CAL_ITEM_FLAG.HAS_ATTENDEES;</span>
<a href="#l60.304"></a><span id="l60.304">         }</span>
<a href="#l60.305"></a><span id="l60.305"> </span>
<a href="#l60.306"></a><span id="l60.306">         return 0;</span>
<a href="#l60.307"></a><span id="l60.307">     },</span>
<a href="#l60.308"></a><span id="l60.308"> </span>
<a href="#l60.309"></a><span id="l60.309">     writeProperty: function(item, propName, propValue) {</span>
<a href="#l60.310"></a><span id="l60.310">         try {</span>
<a href="#l60.311"></a><span id="l60.311">             this.prepareStatement(this.mInsertProperty);</span>
<a href="#l60.312"></a><span id="l60.312" class="difflineminus">-            let pp = this.mInsertProperty.params;</span>
<a href="#l60.313"></a><span id="l60.313" class="difflineminus">-            pp.key = propName;</span>
<a href="#l60.314"></a><span id="l60.314" class="difflineplus">+            let params = this.mInsertProperty.params;</span>
<a href="#l60.315"></a><span id="l60.315" class="difflineplus">+            params.key = propName;</span>
<a href="#l60.316"></a><span id="l60.316">             let wPropValue = cal.wrapInstance(propValue, Components.interfaces.calIDateTime);</span>
<a href="#l60.317"></a><span id="l60.317">             if (wPropValue) {</span>
<a href="#l60.318"></a><span id="l60.318" class="difflineminus">-                pp.value = wPropValue.nativeTime;</span>
<a href="#l60.319"></a><span id="l60.319" class="difflineplus">+                params.value = wPropValue.nativeTime;</span>
<a href="#l60.320"></a><span id="l60.320">             } else {</span>
<a href="#l60.321"></a><span id="l60.321">                 try {</span>
<a href="#l60.322"></a><span id="l60.322" class="difflineminus">-                    pp.value = propValue;</span>
<a href="#l60.323"></a><span id="l60.323" class="difflineplus">+                    params.value = propValue;</span>
<a href="#l60.324"></a><span id="l60.324">                 } catch (e) {</span>
<a href="#l60.325"></a><span id="l60.325">                     // The storage service throws an NS_ERROR_ILLEGAL_VALUE in</span>
<a href="#l60.326"></a><span id="l60.326">                     // case pval is something complex (i.e not a string or</span>
<a href="#l60.327"></a><span id="l60.327">                     // number). Swallow this error, leaving the value empty.</span>
<a href="#l60.328"></a><span id="l60.328">                     if (e.result != Components.results.NS_ERROR_ILLEGAL_VALUE) {</span>
<a href="#l60.329"></a><span id="l60.329">                         throw e;</span>
<a href="#l60.330"></a><span id="l60.330">                     }</span>
<a href="#l60.331"></a><span id="l60.331">                 }</span>
<a href="#l60.332"></a><span id="l60.332">             }</span>
<a href="#l60.333"></a><span id="l60.333" class="difflineminus">-            pp.item_id = item.id;</span>
<a href="#l60.334"></a><span id="l60.334" class="difflineminus">-            this.setDateParamHelper(pp, &quot;recurrence_id&quot;, item.recurrenceId);</span>
<a href="#l60.335"></a><span id="l60.335" class="difflineplus">+            params.item_id = item.id;</span>
<a href="#l60.336"></a><span id="l60.336" class="difflineplus">+            this.setDateParamHelper(params, &quot;recurrence_id&quot;, item.recurrenceId);</span>
<a href="#l60.337"></a><span id="l60.337">             this.mInsertProperty.executeStep();</span>
<a href="#l60.338"></a><span id="l60.338">         } finally {</span>
<a href="#l60.339"></a><span id="l60.339">             this.mInsertProperty.reset();</span>
<a href="#l60.340"></a><span id="l60.340">         }</span>
<a href="#l60.341"></a><span id="l60.341">     },</span>
<a href="#l60.342"></a><span id="l60.342"> </span>
<a href="#l60.343"></a><span id="l60.343">     writeProperties: function(item, olditem) {</span>
<a href="#l60.344"></a><span id="l60.344">         let ret = 0;</span>
<a href="#l60.345"></a><span id="l60.345" class="difflineat">@@ -2169,21 +2169,21 @@ calStorageCalendar.prototype = {</span>
<a href="#l60.346"></a><span id="l60.346">     writeRecurrence: function(item, olditem) {</span>
<a href="#l60.347"></a><span id="l60.347">         let flags = 0;</span>
<a href="#l60.348"></a><span id="l60.348"> </span>
<a href="#l60.349"></a><span id="l60.349">         let rec = item.recurrenceInfo;</span>
<a href="#l60.350"></a><span id="l60.350">         if (rec) {</span>
<a href="#l60.351"></a><span id="l60.351">             flags = CAL_ITEM_FLAG.HAS_RECURRENCE;</span>
<a href="#l60.352"></a><span id="l60.352">             let ritems = rec.getRecurrenceItems({});</span>
<a href="#l60.353"></a><span id="l60.353">             for (let ritem of ritems) {</span>
<a href="#l60.354"></a><span id="l60.354" class="difflineminus">-                let ap = this.mInsertRecurrence.params;</span>
<a href="#l60.355"></a><span id="l60.355" class="difflineplus">+                let params = this.mInsertRecurrence.params;</span>
<a href="#l60.356"></a><span id="l60.356">                 try {</span>
<a href="#l60.357"></a><span id="l60.357">                     this.prepareStatement(this.mInsertRecurrence);</span>
<a href="#l60.358"></a><span id="l60.358" class="difflineminus">-                    ap.item_id = item.id;</span>
<a href="#l60.359"></a><span id="l60.359" class="difflineminus">-                    ap.icalString = ritem.icalString;</span>
<a href="#l60.360"></a><span id="l60.360" class="difflineplus">+                    params.item_id = item.id;</span>
<a href="#l60.361"></a><span id="l60.361" class="difflineplus">+                    params.icalString = ritem.icalString;</span>
<a href="#l60.362"></a><span id="l60.362">                     this.mInsertRecurrence.executeStep();</span>
<a href="#l60.363"></a><span id="l60.363">                 } finally {</span>
<a href="#l60.364"></a><span id="l60.364">                     this.mInsertRecurrence.reset();</span>
<a href="#l60.365"></a><span id="l60.365">                 }</span>
<a href="#l60.366"></a><span id="l60.366">             }</span>
<a href="#l60.367"></a><span id="l60.367"> </span>
<a href="#l60.368"></a><span id="l60.368">             let exceptions = rec.getExceptionIds({});</span>
<a href="#l60.369"></a><span id="l60.369">             if (exceptions.length &gt; 0) {</span>
<a href="#l60.370"></a><span id="l60.370" class="difflineat">@@ -2206,43 +2206,43 @@ calStorageCalendar.prototype = {</span>
<a href="#l60.371"></a><span id="l60.371"> </span>
<a href="#l60.372"></a><span id="l60.372">         return flags;</span>
<a href="#l60.373"></a><span id="l60.373">     },</span>
<a href="#l60.374"></a><span id="l60.374"> </span>
<a href="#l60.375"></a><span id="l60.375">     writeAttachments: function(item, olditem) {</span>
<a href="#l60.376"></a><span id="l60.376">         let attachments = item.getAttachments({});</span>
<a href="#l60.377"></a><span id="l60.377">         if (attachments &amp;&amp; attachments.length &gt; 0) {</span>
<a href="#l60.378"></a><span id="l60.378">             for (let att of attachments) {</span>
<a href="#l60.379"></a><span id="l60.379" class="difflineminus">-                let ap = this.mInsertAttachment.params;</span>
<a href="#l60.380"></a><span id="l60.380" class="difflineplus">+                let params = this.mInsertAttachment.params;</span>
<a href="#l60.381"></a><span id="l60.381">                 try {</span>
<a href="#l60.382"></a><span id="l60.382">                     this.prepareStatement(this.mInsertAttachment);</span>
<a href="#l60.383"></a><span id="l60.383" class="difflineminus">-                    this.setDateParamHelper(ap, &quot;recurrence_id&quot;, item.recurrenceId);</span>
<a href="#l60.384"></a><span id="l60.384" class="difflineminus">-                    ap.item_id = item.id;</span>
<a href="#l60.385"></a><span id="l60.385" class="difflineminus">-                    ap.icalString = att.icalString;</span>
<a href="#l60.386"></a><span id="l60.386" class="difflineplus">+                    this.setDateParamHelper(params, &quot;recurrence_id&quot;, item.recurrenceId);</span>
<a href="#l60.387"></a><span id="l60.387" class="difflineplus">+                    params.item_id = item.id;</span>
<a href="#l60.388"></a><span id="l60.388" class="difflineplus">+                    params.icalString = att.icalString;</span>
<a href="#l60.389"></a><span id="l60.389"> </span>
<a href="#l60.390"></a><span id="l60.390">                     this.mInsertAttachment.executeStep();</span>
<a href="#l60.391"></a><span id="l60.391">                 } finally {</span>
<a href="#l60.392"></a><span id="l60.392">                     this.mInsertAttachment.reset();</span>
<a href="#l60.393"></a><span id="l60.393">                 }</span>
<a href="#l60.394"></a><span id="l60.394">             }</span>
<a href="#l60.395"></a><span id="l60.395">             return CAL_ITEM_FLAG.HAS_ATTACHMENTS;</span>
<a href="#l60.396"></a><span id="l60.396">         }</span>
<a href="#l60.397"></a><span id="l60.397">         return 0;</span>
<a href="#l60.398"></a><span id="l60.398">     },</span>
<a href="#l60.399"></a><span id="l60.399"> </span>
<a href="#l60.400"></a><span id="l60.400">     writeRelations: function(item, olditem) {</span>
<a href="#l60.401"></a><span id="l60.401">         let relations = item.getRelations({});</span>
<a href="#l60.402"></a><span id="l60.402">         if (relations &amp;&amp; relations.length &gt; 0) {</span>
<a href="#l60.403"></a><span id="l60.403">             for (let rel of relations) {</span>
<a href="#l60.404"></a><span id="l60.404" class="difflineminus">-                let rp = this.mInsertRelation.params;</span>
<a href="#l60.405"></a><span id="l60.405" class="difflineplus">+                let params = this.mInsertRelation.params;</span>
<a href="#l60.406"></a><span id="l60.406">                 try {</span>
<a href="#l60.407"></a><span id="l60.407">                     this.prepareStatement(this.mInsertRelation);</span>
<a href="#l60.408"></a><span id="l60.408" class="difflineminus">-                    this.setDateParamHelper(rp, &quot;recurrence_id&quot;, item.recurrenceId);</span>
<a href="#l60.409"></a><span id="l60.409" class="difflineminus">-                    rp.item_id = item.id;</span>
<a href="#l60.410"></a><span id="l60.410" class="difflineminus">-                    rp.icalString = rel.icalString;</span>
<a href="#l60.411"></a><span id="l60.411" class="difflineplus">+                    this.setDateParamHelper(params, &quot;recurrence_id&quot;, item.recurrenceId);</span>
<a href="#l60.412"></a><span id="l60.412" class="difflineplus">+                    params.item_id = item.id;</span>
<a href="#l60.413"></a><span id="l60.413" class="difflineplus">+                    params.icalString = rel.icalString;</span>
<a href="#l60.414"></a><span id="l60.414"> </span>
<a href="#l60.415"></a><span id="l60.415">                     this.mInsertRelation.executeStep();</span>
<a href="#l60.416"></a><span id="l60.416">                 } finally {</span>
<a href="#l60.417"></a><span id="l60.417">                     this.mInsertRelation.reset();</span>
<a href="#l60.418"></a><span id="l60.418">                 }</span>
<a href="#l60.419"></a><span id="l60.419">             }</span>
<a href="#l60.420"></a><span id="l60.420">             return CAL_ITEM_FLAG.HAS_RELATIONS;</span>
<a href="#l60.421"></a><span id="l60.421">         }</span>
<a href="#l60.422"></a><span id="l60.422" class="difflineat">@@ -2251,22 +2251,22 @@ calStorageCalendar.prototype = {</span>
<a href="#l60.423"></a><span id="l60.423"> </span>
<a href="#l60.424"></a><span id="l60.424">     writeAlarms: function(item, olditem) {</span>
<a href="#l60.425"></a><span id="l60.425">         let alarms = item.getAlarms({});</span>
<a href="#l60.426"></a><span id="l60.426">         if (alarms.length &lt; 1) {</span>
<a href="#l60.427"></a><span id="l60.427">             return 0;</span>
<a href="#l60.428"></a><span id="l60.428">         }</span>
<a href="#l60.429"></a><span id="l60.429"> </span>
<a href="#l60.430"></a><span id="l60.430">         for (let alarm of alarms) {</span>
<a href="#l60.431"></a><span id="l60.431" class="difflineminus">-            let pp = this.mInsertAlarm.params;</span>
<a href="#l60.432"></a><span id="l60.432" class="difflineplus">+            let params = this.mInsertAlarm.params;</span>
<a href="#l60.433"></a><span id="l60.433">             try {</span>
<a href="#l60.434"></a><span id="l60.434">                 this.prepareStatement(this.mInsertAlarm);</span>
<a href="#l60.435"></a><span id="l60.435" class="difflineminus">-                this.setDateParamHelper(pp, &quot;recurrence_id&quot;, item.recurrenceId);</span>
<a href="#l60.436"></a><span id="l60.436" class="difflineminus">-                pp.item_id = item.id;</span>
<a href="#l60.437"></a><span id="l60.437" class="difflineminus">-                pp.icalString = alarm.icalString;</span>
<a href="#l60.438"></a><span id="l60.438" class="difflineplus">+                this.setDateParamHelper(params, &quot;recurrence_id&quot;, item.recurrenceId);</span>
<a href="#l60.439"></a><span id="l60.439" class="difflineplus">+                params.item_id = item.id;</span>
<a href="#l60.440"></a><span id="l60.440" class="difflineplus">+                params.icalString = alarm.icalString;</span>
<a href="#l60.441"></a><span id="l60.441">                 this.mInsertAlarm.executeStep();</span>
<a href="#l60.442"></a><span id="l60.442">             } catch (e) {</span>
<a href="#l60.443"></a><span id="l60.443">                 this.logError(&quot;Error writing alarm for item &quot; + item.title + &quot; (&quot; + item.id + &quot;)&quot;, e);</span>
<a href="#l60.444"></a><span id="l60.444">             } finally {</span>
<a href="#l60.445"></a><span id="l60.445">                 this.mInsertAlarm.reset();</span>
<a href="#l60.446"></a><span id="l60.446">             }</span>
<a href="#l60.447"></a><span id="l60.447">         }</span>
<a href="#l60.448"></a><span id="l60.448"> </span>
<a href="#l60.449"></a><span id="l60.449" class="difflineat">@@ -2329,19 +2329,19 @@ calStorageCalendar.prototype = {</span>
<a href="#l60.450"></a><span id="l60.450">     //</span>
<a href="#l60.451"></a><span id="l60.451">     // calISyncWriteCalendar interface</span>
<a href="#l60.452"></a><span id="l60.452">     //</span>
<a href="#l60.453"></a><span id="l60.453"> </span>
<a href="#l60.454"></a><span id="l60.454">     setMetaData: function(id, value) {</span>
<a href="#l60.455"></a><span id="l60.455">         this.executeItemStatement(this.mDeleteMetaData, &quot;item_id&quot;, id);</span>
<a href="#l60.456"></a><span id="l60.456">         try {</span>
<a href="#l60.457"></a><span id="l60.457">             this.prepareStatement(this.mInsertMetaData);</span>
<a href="#l60.458"></a><span id="l60.458" class="difflineminus">-            let sp = this.mInsertMetaData.params;</span>
<a href="#l60.459"></a><span id="l60.459" class="difflineminus">-            sp.item_id = id;</span>
<a href="#l60.460"></a><span id="l60.460" class="difflineminus">-            sp.value = value;</span>
<a href="#l60.461"></a><span id="l60.461" class="difflineplus">+            let params = this.mInsertMetaData.params;</span>
<a href="#l60.462"></a><span id="l60.462" class="difflineplus">+            params.item_id = id;</span>
<a href="#l60.463"></a><span id="l60.463" class="difflineplus">+            params.value = value;</span>
<a href="#l60.464"></a><span id="l60.464">             this.mInsertMetaData.executeStep();</span>
<a href="#l60.465"></a><span id="l60.465">         } catch (e) {</span>
<a href="#l60.466"></a><span id="l60.466">             if (e.result == Components.results.NS_ERROR_ILLEGAL_VALUE) {</span>
<a href="#l60.467"></a><span id="l60.467">                 this.logError(&quot;Unknown error!&quot;, e);</span>
<a href="#l60.468"></a><span id="l60.468">             } else {</span>
<a href="#l60.469"></a><span id="l60.469">                 // The storage service throws an NS_ERROR_ILLEGAL_VALUE in</span>
<a href="#l60.470"></a><span id="l60.470">                 // case pval is something complex (i.e not a string or</span>
<a href="#l60.471"></a><span id="l60.471">                 // number). Swallow this error, leaving the value empty.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l61.1"></a><span id="l61.1" class="difflineminus">--- a/calendar/providers/storage/calStorageHelpers.jsm</span>
<a href="#l61.2"></a><span id="l61.2" class="difflineplus">+++ b/calendar/providers/storage/calStorageHelpers.jsm</span>
<a href="#l61.3"></a><span id="l61.3" class="difflineat">@@ -36,79 +36,79 @@ var CAL_ITEM_FLAG = {</span>
<a href="#l61.4"></a><span id="l61.4"> </span>
<a href="#l61.5"></a><span id="l61.5"> // The cache of foreign timezones</span>
<a href="#l61.6"></a><span id="l61.6"> var gForeignTimezonesCache = {};</span>
<a href="#l61.7"></a><span id="l61.7"> </span>
<a href="#l61.8"></a><span id="l61.8"> /**</span>
<a href="#l61.9"></a><span id="l61.9">  * Returns the passed date in UTC, unless it is floating. In this case, it is</span>
<a href="#l61.10"></a><span id="l61.10">  * kept floating.</span>
<a href="#l61.11"></a><span id="l61.11">  *</span>
<a href="#l61.12"></a><span id="l61.12" class="difflineminus">- * @param dt        The calIDateTime to convert.</span>
<a href="#l61.13"></a><span id="l61.13" class="difflineplus">+ * @param date      The calIDateTime to convert.</span>
<a href="#l61.14"></a><span id="l61.14">  * @return          The possibly converted calIDateTime.</span>
<a href="#l61.15"></a><span id="l61.15">  */</span>
<a href="#l61.16"></a><span id="l61.16" class="difflineminus">-function getInUtcOrKeepFloating(dt) {</span>
<a href="#l61.17"></a><span id="l61.17" class="difflineminus">-    let tz = dt.timezone;</span>
<a href="#l61.18"></a><span id="l61.18" class="difflineminus">-    if (tz.isFloating || tz.isUTC) {</span>
<a href="#l61.19"></a><span id="l61.19" class="difflineminus">-        return dt;</span>
<a href="#l61.20"></a><span id="l61.20" class="difflineplus">+function getInUtcOrKeepFloating(date) {</span>
<a href="#l61.21"></a><span id="l61.21" class="difflineplus">+    let timezone = date.timezone;</span>
<a href="#l61.22"></a><span id="l61.22" class="difflineplus">+    if (timezone.isFloating || timezone.isUTC) {</span>
<a href="#l61.23"></a><span id="l61.23" class="difflineplus">+        return date;</span>
<a href="#l61.24"></a><span id="l61.24">     } else {</span>
<a href="#l61.25"></a><span id="l61.25" class="difflineminus">-        return dt.getInTimezone(cal.UTC());</span>
<a href="#l61.26"></a><span id="l61.26" class="difflineplus">+        return date.getInTimezone(cal.UTC());</span>
<a href="#l61.27"></a><span id="l61.27">     }</span>
<a href="#l61.28"></a><span id="l61.28"> }</span>
<a href="#l61.29"></a><span id="l61.29"> </span>
<a href="#l61.30"></a><span id="l61.30"> /**</span>
<a href="#l61.31"></a><span id="l61.31">  * Transforms a date object to a text which is suitable for the database</span>
<a href="#l61.32"></a><span id="l61.32">  *</span>
<a href="#l61.33"></a><span id="l61.33" class="difflineminus">- * @param d     The calIDateTime to transform.</span>
<a href="#l61.34"></a><span id="l61.34" class="difflineplus">+ * @param date  The calIDateTime to transform.</span>
<a href="#l61.35"></a><span id="l61.35">  * @return      The string representation of the date object.</span>
<a href="#l61.36"></a><span id="l61.36">  */</span>
<a href="#l61.37"></a><span id="l61.37" class="difflineminus">-function dateToText(d) {</span>
<a href="#l61.38"></a><span id="l61.38" class="difflineplus">+function dateToText(date) {</span>
<a href="#l61.39"></a><span id="l61.39">     let zonestr;</span>
<a href="#l61.40"></a><span id="l61.40" class="difflineminus">-    if (d.timezone.isFloating) {</span>
<a href="#l61.41"></a><span id="l61.41" class="difflineplus">+    if (date.timezone.isFloating) {</span>
<a href="#l61.42"></a><span id="l61.42">         zonestr = &quot;L&quot;;</span>
<a href="#l61.43"></a><span id="l61.43" class="difflineminus">-    } else if (d.timezone.isUTC) {</span>
<a href="#l61.44"></a><span id="l61.44" class="difflineplus">+    } else if (date.timezone.isUTC) {</span>
<a href="#l61.45"></a><span id="l61.45">         zonestr = &quot;U&quot;;</span>
<a href="#l61.46"></a><span id="l61.46">     } else {</span>
<a href="#l61.47"></a><span id="l61.47">         zonestr = &quot;Z&quot;;</span>
<a href="#l61.48"></a><span id="l61.48">     }</span>
<a href="#l61.49"></a><span id="l61.49"> </span>
<a href="#l61.50"></a><span id="l61.50" class="difflineminus">-    let datestr = zonestr + (d.isDate ? &quot;D&quot; : &quot;T&quot;) + d.nativeTime;</span>
<a href="#l61.51"></a><span id="l61.51" class="difflineminus">-    if (!d.timezone.isFloating &amp;&amp; !d.timezone.isUTC) {</span>
<a href="#l61.52"></a><span id="l61.52" class="difflineminus">-        datestr += &quot;:&quot; + d.timezone.tzid.replace(/%/g, &quot;%%&quot;).replace(/:/g, &quot;%:&quot;);</span>
<a href="#l61.53"></a><span id="l61.53" class="difflineplus">+    let datestr = zonestr + (date.isDate ? &quot;D&quot; : &quot;T&quot;) + date.nativeTime;</span>
<a href="#l61.54"></a><span id="l61.54" class="difflineplus">+    if (!date.timezone.isFloating &amp;&amp; !date.timezone.isUTC) {</span>
<a href="#l61.55"></a><span id="l61.55" class="difflineplus">+        datestr += &quot;:&quot; + date.timezone.tzid.replace(/%/g, &quot;%%&quot;).replace(/:/g, &quot;%:&quot;);</span>
<a href="#l61.56"></a><span id="l61.56">     }</span>
<a href="#l61.57"></a><span id="l61.57">     return datestr;</span>
<a href="#l61.58"></a><span id="l61.58"> }</span>
<a href="#l61.59"></a><span id="l61.59"> </span>
<a href="#l61.60"></a><span id="l61.60"> /**</span>
<a href="#l61.61"></a><span id="l61.61">  * Transforms the text representation of this date object to a calIDateTime</span>
<a href="#l61.62"></a><span id="l61.62">  * object.</span>
<a href="#l61.63"></a><span id="l61.63">  *</span>
<a href="#l61.64"></a><span id="l61.64" class="difflineminus">- * @param d     The text to transform.</span>
<a href="#l61.65"></a><span id="l61.65" class="difflineplus">+ * @param text  The text to transform.</span>
<a href="#l61.66"></a><span id="l61.66">  * @return      The resulting calIDateTime.</span>
<a href="#l61.67"></a><span id="l61.67">  */</span>
<a href="#l61.68"></a><span id="l61.68" class="difflineminus">-function textToDate(d) {</span>
<a href="#l61.69"></a><span id="l61.69" class="difflineminus">-    let dval;</span>
<a href="#l61.70"></a><span id="l61.70" class="difflineminus">-    let tz = &quot;UTC&quot;;</span>
<a href="#l61.71"></a><span id="l61.71" class="difflineplus">+function textToDate(text) {</span>
<a href="#l61.72"></a><span id="l61.72" class="difflineplus">+    let textval;</span>
<a href="#l61.73"></a><span id="l61.73" class="difflineplus">+    let timezone = &quot;UTC&quot;;</span>
<a href="#l61.74"></a><span id="l61.74"> </span>
<a href="#l61.75"></a><span id="l61.75" class="difflineminus">-    if (d[0] == &quot;Z&quot;) {</span>
<a href="#l61.76"></a><span id="l61.76" class="difflineminus">-        let strs = d.substr(2).split(&quot;:&quot;);</span>
<a href="#l61.77"></a><span id="l61.77" class="difflineminus">-        dval = parseInt(strs[0], 10);</span>
<a href="#l61.78"></a><span id="l61.78" class="difflineminus">-        tz = strs[1].replace(/%:/g, &quot;:&quot;).replace(/%%/g, &quot;%&quot;);</span>
<a href="#l61.79"></a><span id="l61.79" class="difflineplus">+    if (text[0] == &quot;Z&quot;) {</span>
<a href="#l61.80"></a><span id="l61.80" class="difflineplus">+        let strs = text.substr(2).split(&quot;:&quot;);</span>
<a href="#l61.81"></a><span id="l61.81" class="difflineplus">+        textval = parseInt(strs[0], 10);</span>
<a href="#l61.82"></a><span id="l61.82" class="difflineplus">+        timezone = strs[1].replace(/%:/g, &quot;:&quot;).replace(/%%/g, &quot;%&quot;);</span>
<a href="#l61.83"></a><span id="l61.83">     } else {</span>
<a href="#l61.84"></a><span id="l61.84" class="difflineminus">-        dval = parseInt(d.substr(2), 10);</span>
<a href="#l61.85"></a><span id="l61.85" class="difflineplus">+        textval = parseInt(text.substr(2), 10);</span>
<a href="#l61.86"></a><span id="l61.86">     }</span>
<a href="#l61.87"></a><span id="l61.87"> </span>
<a href="#l61.88"></a><span id="l61.88">     let date;</span>
<a href="#l61.89"></a><span id="l61.89" class="difflineminus">-    if (d[0] == &quot;U&quot; || d[0] == &quot;Z&quot;) {</span>
<a href="#l61.90"></a><span id="l61.90" class="difflineminus">-        date = newDateTime(dval, tz);</span>
<a href="#l61.91"></a><span id="l61.91" class="difflineminus">-    } else if (d[0] == &quot;L&quot;) {</span>
<a href="#l61.92"></a><span id="l61.92" class="difflineplus">+    if (text[0] == &quot;U&quot; || text[0] == &quot;Z&quot;) {</span>
<a href="#l61.93"></a><span id="l61.93" class="difflineplus">+        date = newDateTime(textval, timezone);</span>
<a href="#l61.94"></a><span id="l61.94" class="difflineplus">+    } else if (text[0] == &quot;L&quot;) {</span>
<a href="#l61.95"></a><span id="l61.95">         // is local time</span>
<a href="#l61.96"></a><span id="l61.96" class="difflineminus">-        date = newDateTime(dval, &quot;floating&quot;);</span>
<a href="#l61.97"></a><span id="l61.97" class="difflineplus">+        date = newDateTime(textval, &quot;floating&quot;);</span>
<a href="#l61.98"></a><span id="l61.98">     }</span>
<a href="#l61.99"></a><span id="l61.99"> </span>
<a href="#l61.100"></a><span id="l61.100" class="difflineminus">-    if (d[1] == &quot;D&quot;) {</span>
<a href="#l61.101"></a><span id="l61.101" class="difflineplus">+    if (text[1] == &quot;D&quot;) {</span>
<a href="#l61.102"></a><span id="l61.102">         date.isDate = true;</span>
<a href="#l61.103"></a><span id="l61.103">     }</span>
<a href="#l61.104"></a><span id="l61.104">     return date;</span>
<a href="#l61.105"></a><span id="l61.105"> }</span>
<a href="#l61.106"></a><span id="l61.106"> </span>
<a href="#l61.107"></a><span id="l61.107"> //</span>
<a href="#l61.108"></a><span id="l61.108"> // other helpers</span>
<a href="#l61.109"></a><span id="l61.109"> //</span>
<a href="#l61.110"></a><span id="l61.110" class="difflineat">@@ -135,61 +135,61 @@ calStorageTimezone.prototype = {</span>
<a href="#l61.111"></a><span id="l61.111"> </span>
<a href="#l61.112"></a><span id="l61.112"> /**</span>
<a href="#l61.113"></a><span id="l61.113">  * Gets the timezone for the given definition or identifier</span>
<a href="#l61.114"></a><span id="l61.114">  *</span>
<a href="#l61.115"></a><span id="l61.115">  * @param aTimezone     The timezone data</span>
<a href="#l61.116"></a><span id="l61.116">  * @return              The calITimezone object</span>
<a href="#l61.117"></a><span id="l61.117">  */</span>
<a href="#l61.118"></a><span id="l61.118"> function getTimezone(aTimezone) {</span>
<a href="#l61.119"></a><span id="l61.119" class="difflineminus">-    let tz = null;</span>
<a href="#l61.120"></a><span id="l61.120" class="difflineplus">+    let timezone = null;</span>
<a href="#l61.121"></a><span id="l61.121">     if (aTimezone.indexOf(&quot;BEGIN:VTIMEZONE&quot;) == 0) {</span>
<a href="#l61.122"></a><span id="l61.122" class="difflineminus">-        tz = gForeignTimezonesCache[aTimezone]; // using full definition as key</span>
<a href="#l61.123"></a><span id="l61.123" class="difflineminus">-        if (!tz) {</span>
<a href="#l61.124"></a><span id="l61.124" class="difflineplus">+        timezone = gForeignTimezonesCache[aTimezone]; // using full definition as key</span>
<a href="#l61.125"></a><span id="l61.125" class="difflineplus">+        if (!timezone) {</span>
<a href="#l61.126"></a><span id="l61.126">             try {</span>
<a href="#l61.127"></a><span id="l61.127">                 // cannot cope without parent VCALENDAR:</span>
<a href="#l61.128"></a><span id="l61.128">                 let comp = cal.getIcsService().parseICS(&quot;BEGIN:VCALENDAR\n&quot; + aTimezone + &quot;\nEND:VCALENDAR&quot;, null);</span>
<a href="#l61.129"></a><span id="l61.129" class="difflineminus">-                tz = new calStorageTimezone(comp.getFirstSubcomponent(&quot;VTIMEZONE&quot;));</span>
<a href="#l61.130"></a><span id="l61.130" class="difflineminus">-                gForeignTimezonesCache[aTimezone] = tz;</span>
<a href="#l61.131"></a><span id="l61.131" class="difflineplus">+                timezone = new calStorageTimezone(comp.getFirstSubcomponent(&quot;VTIMEZONE&quot;));</span>
<a href="#l61.132"></a><span id="l61.132" class="difflineplus">+                gForeignTimezonesCache[aTimezone] = timezone;</span>
<a href="#l61.133"></a><span id="l61.133">             } catch (e) {</span>
<a href="#l61.134"></a><span id="l61.134">                 cal.ASSERT(false, e);</span>
<a href="#l61.135"></a><span id="l61.135">             }</span>
<a href="#l61.136"></a><span id="l61.136">         }</span>
<a href="#l61.137"></a><span id="l61.137">     } else {</span>
<a href="#l61.138"></a><span id="l61.138" class="difflineminus">-        tz = cal.getTimezoneService().getTimezone(aTimezone);</span>
<a href="#l61.139"></a><span id="l61.139" class="difflineplus">+        timezone = cal.getTimezoneService().getTimezone(aTimezone);</span>
<a href="#l61.140"></a><span id="l61.140">     }</span>
<a href="#l61.141"></a><span id="l61.141" class="difflineminus">-    return tz;</span>
<a href="#l61.142"></a><span id="l61.142" class="difflineplus">+    return timezone;</span>
<a href="#l61.143"></a><span id="l61.143"> }</span>
<a href="#l61.144"></a><span id="l61.144"> </span>
<a href="#l61.145"></a><span id="l61.145"> /**</span>
<a href="#l61.146"></a><span id="l61.146">  * Creates a new calIDateTime from the given native time and optionally</span>
<a href="#l61.147"></a><span id="l61.147">  * the passed timezone. The timezone can either be the TZID of the timezone (in</span>
<a href="#l61.148"></a><span id="l61.148">  * this case the timezone service will be asked for the definition), or a string</span>
<a href="#l61.149"></a><span id="l61.149">  * representation of the timezone component (i.e a VTIMEZONE component).</span>
<a href="#l61.150"></a><span id="l61.150">  *</span>
<a href="#l61.151"></a><span id="l61.151">  * @param aNativeTime       The native time, in microseconds</span>
<a href="#l61.152"></a><span id="l61.152">  * @param aTimezone         The timezone identifier or definition.</span>
<a href="#l61.153"></a><span id="l61.153">  */</span>
<a href="#l61.154"></a><span id="l61.154"> function newDateTime(aNativeTime, aTimezone) {</span>
<a href="#l61.155"></a><span id="l61.155" class="difflineminus">-    let t = cal.createDateTime();</span>
<a href="#l61.156"></a><span id="l61.156" class="difflineplus">+    let date = cal.createDateTime();</span>
<a href="#l61.157"></a><span id="l61.157"> </span>
<a href="#l61.158"></a><span id="l61.158">     // Bug 751821 - Dates before 1970 were incorrectly stored with an unsigned nativeTime value, we need to</span>
<a href="#l61.159"></a><span id="l61.159">     // convert back to a negative value</span>
<a href="#l61.160"></a><span id="l61.160">     if (aNativeTime &gt; 0x7fffffffffffffff) {</span>
<a href="#l61.161"></a><span id="l61.161">         cal.WARN(&quot;[calStorageCalendar] Converting invalid native time value: &quot; + aNativeTime);</span>
<a href="#l61.162"></a><span id="l61.162">         aNativeTime = -0x7fffffffffffffff + (aNativeTime - 0x7fffffffffffffff);</span>
<a href="#l61.163"></a><span id="l61.163">         // Round to nearest second to fix microsecond rounding errors</span>
<a href="#l61.164"></a><span id="l61.164">         aNativeTime = Math.round(aNativeTime / 1000000) * 1000000;</span>
<a href="#l61.165"></a><span id="l61.165">     }</span>
<a href="#l61.166"></a><span id="l61.166"> </span>
<a href="#l61.167"></a><span id="l61.167" class="difflineminus">-    t.nativeTime = aNativeTime;</span>
<a href="#l61.168"></a><span id="l61.168" class="difflineplus">+    date.nativeTime = aNativeTime;</span>
<a href="#l61.169"></a><span id="l61.169">     if (aTimezone) {</span>
<a href="#l61.170"></a><span id="l61.170" class="difflineminus">-        let tz = getTimezone(aTimezone);</span>
<a href="#l61.171"></a><span id="l61.171" class="difflineminus">-        if (tz) {</span>
<a href="#l61.172"></a><span id="l61.172" class="difflineminus">-            t = t.getInTimezone(tz);</span>
<a href="#l61.173"></a><span id="l61.173" class="difflineplus">+        let timezone = getTimezone(aTimezone);</span>
<a href="#l61.174"></a><span id="l61.174" class="difflineplus">+        if (timezone) {</span>
<a href="#l61.175"></a><span id="l61.175" class="difflineplus">+            date = date.getInTimezone(timezone);</span>
<a href="#l61.176"></a><span id="l61.176">         } else {</span>
<a href="#l61.177"></a><span id="l61.177">             cal.ASSERT(false, &quot;Timezone not available: &quot; + aTimezone);</span>
<a href="#l61.178"></a><span id="l61.178">         }</span>
<a href="#l61.179"></a><span id="l61.179">     } else {</span>
<a href="#l61.180"></a><span id="l61.180" class="difflineminus">-        t.timezone = cal.floating();</span>
<a href="#l61.181"></a><span id="l61.181" class="difflineplus">+        date.timezone = cal.floating();</span>
<a href="#l61.182"></a><span id="l61.182">     }</span>
<a href="#l61.183"></a><span id="l61.183" class="difflineminus">-    return t;</span>
<a href="#l61.184"></a><span id="l61.184" class="difflineplus">+    return date;</span>
<a href="#l61.185"></a><span id="l61.185"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l62.1"></a><span id="l62.1" class="difflineminus">--- a/calendar/providers/storage/calStorageUpgrade.jsm</span>
<a href="#l62.2"></a><span id="l62.2" class="difflineplus">+++ b/calendar/providers/storage/calStorageUpgrade.jsm</span>
<a href="#l62.3"></a><span id="l62.3" class="difflineat">@@ -386,19 +386,19 @@ function ensureUpdatedTimezones(db) {</span>
<a href="#l62.4"></a><span id="l62.4">             &quot;SELECT recurrence_id_tz AS zone FROM cal_alarms       WHERE recurrence_id_tz IS NOT NULL UNION &quot; +</span>
<a href="#l62.5"></a><span id="l62.5">             &quot;SELECT recurrence_id_tz AS zone FROM cal_relations    WHERE recurrence_id_tz IS NOT NULL UNION &quot; +</span>
<a href="#l62.6"></a><span id="l62.6">             &quot;SELECT recurrence_id_tz AS zone FROM cal_attachments  WHERE recurrence_id_tz IS NOT NULL&quot; +</span>
<a href="#l62.7"></a><span id="l62.7">             &quot;);&quot;);</span>
<a href="#l62.8"></a><span id="l62.8">         try {</span>
<a href="#l62.9"></a><span id="l62.9">             while (getZones.executeStep()) {</span>
<a href="#l62.10"></a><span id="l62.10">                 let zone = getZones.row.zone;</span>
<a href="#l62.11"></a><span id="l62.11">                 // Send the timezones off to the timezone service to attempt conversion:</span>
<a href="#l62.12"></a><span id="l62.12" class="difflineminus">-                let tz = getTimezone(zone);</span>
<a href="#l62.13"></a><span id="l62.13" class="difflineminus">-                if (tz) {</span>
<a href="#l62.14"></a><span id="l62.14" class="difflineminus">-                    let refTz = cal.getTimezoneService().getTimezone(tz.tzid);</span>
<a href="#l62.15"></a><span id="l62.15" class="difflineplus">+                let timezone = getTimezone(zone);</span>
<a href="#l62.16"></a><span id="l62.16" class="difflineplus">+                if (timezone) {</span>
<a href="#l62.17"></a><span id="l62.17" class="difflineplus">+                    let refTz = cal.getTimezoneService().getTimezone(timezone.tzid);</span>
<a href="#l62.18"></a><span id="l62.18">                     if (refTz &amp;&amp; refTz.tzid != zone) {</span>
<a href="#l62.19"></a><span id="l62.19">                         zonesToUpdate.push({ oldTzId: zone, newTzId: refTz.tzid });</span>
<a href="#l62.20"></a><span id="l62.20">                     }</span>
<a href="#l62.21"></a><span id="l62.21">                 }</span>
<a href="#l62.22"></a><span id="l62.22">             }</span>
<a href="#l62.23"></a><span id="l62.23">         } catch (e) {</span>
<a href="#l62.24"></a><span id="l62.24">             cal.ERROR(&quot;Error updating timezones: &quot; + e +</span>
<a href="#l62.25"></a><span id="l62.25">                       &quot;\nDB Error &quot; + lastErrorString(db));</span>
<a href="#l62.26"></a><span id="l62.26" class="difflineat">@@ -636,17 +636,17 @@ var upgrade = {};</span>
<a href="#l62.27"></a><span id="l62.27">  * Returns the initial storage database schema. Note this is not the current</span>
<a href="#l62.28"></a><span id="l62.28">  * schema, it will be modified by the upgrade.vNN() functions. This function</span>
<a href="#l62.29"></a><span id="l62.29">  * returns the initial v1 with modifications from v2 applied.</span>
<a href="#l62.30"></a><span id="l62.30">  *</span>
<a href="#l62.31"></a><span id="l62.31">  * No bug - new recurrence system. exceptions supported now, along with</span>
<a href="#l62.32"></a><span id="l62.32">  * everything else ical can throw at us. I hope.</span>
<a href="#l62.33"></a><span id="l62.33">  * p=vlad</span>
<a href="#l62.34"></a><span id="l62.34">  */</span>
<a href="#l62.35"></a><span id="l62.35" class="difflineminus">-upgrade.v2 = upgrade.v1 = function(db, version) {</span>
<a href="#l62.36"></a><span id="l62.36" class="difflineplus">+upgrade.v2 = upgrade.v1 = function(db, version) { // eslint-disable-line id-length</span>
<a href="#l62.37"></a><span id="l62.37">     LOGdb(db, &quot;Storage: Upgrading to v1/v2&quot;);</span>
<a href="#l62.38"></a><span id="l62.38">     let tblData = {</span>
<a href="#l62.39"></a><span id="l62.39">       cal_calendar_schema_version: { version: &quot;INTEGER&quot; },</span>
<a href="#l62.40"></a><span id="l62.40"> </span>
<a href="#l62.41"></a><span id="l62.41">     /* While this table is in v1, actually keeping it in the sql object will</span>
<a href="#l62.42"></a><span id="l62.42">      * cause problems when migrating from storage.sdb to local.sqlite. There,</span>
<a href="#l62.43"></a><span id="l62.43">      * all tables from storage.sdb will be moved to local.sqlite and so starting</span>
<a href="#l62.44"></a><span id="l62.44">      * sunbird again afterwards causes a borked upgrade since its missing tables</span>
<a href="#l62.45"></a><span id="l62.45" class="difflineat">@@ -728,17 +728,17 @@ upgrade.v2 = upgrade.v1 = function(db, v</span>
<a href="#l62.46"></a><span id="l62.46"> };</span>
<a href="#l62.47"></a><span id="l62.47"> </span>
<a href="#l62.48"></a><span id="l62.48"> /**</span>
<a href="#l62.49"></a><span id="l62.49">  * Upgrade to version 3.</span>
<a href="#l62.50"></a><span id="l62.50">  * Bug 293707, updates to storage provider; calendar manager database locked</span>
<a href="#l62.51"></a><span id="l62.51">  * fix, r=shaver, p=vlad</span>
<a href="#l62.52"></a><span id="l62.52">  * p=vlad</span>
<a href="#l62.53"></a><span id="l62.53">  */</span>
<a href="#l62.54"></a><span id="l62.54" class="difflineminus">-upgrade.v3 = function(db, version) {</span>
<a href="#l62.55"></a><span id="l62.55" class="difflineplus">+upgrade.v3 = function(db, version) { // eslint-disable-line id-length</span>
<a href="#l62.56"></a><span id="l62.56">     function updateSql(tbl, field) {</span>
<a href="#l62.57"></a><span id="l62.57">         executeSimpleSQL(db, &quot;UPDATE &quot; + tbl + &quot; SET &quot; + field + &quot;_tz='UTC'&quot; +</span>
<a href="#l62.58"></a><span id="l62.58">                              &quot; WHERE &quot; + field + &quot; IS NOT NULL&quot;);</span>
<a href="#l62.59"></a><span id="l62.59">     }</span>
<a href="#l62.60"></a><span id="l62.60"> </span>
<a href="#l62.61"></a><span id="l62.61">     let tbl = upgrade.v2(version &lt; 2 &amp;&amp; db, version);</span>
<a href="#l62.62"></a><span id="l62.62">     LOGdb(db, &quot;Storage: Upgrading to v3&quot;);</span>
<a href="#l62.63"></a><span id="l62.63"> </span>
<a href="#l62.64"></a><span id="l62.64" class="difflineat">@@ -798,17 +798,17 @@ upgrade.v3 = function(db, version) {</span>
<a href="#l62.65"></a><span id="l62.65">     return tbl;</span>
<a href="#l62.66"></a><span id="l62.66"> };</span>
<a href="#l62.67"></a><span id="l62.67"> </span>
<a href="#l62.68"></a><span id="l62.68"> /**</span>
<a href="#l62.69"></a><span id="l62.69">  * Upgrade to version 4.</span>
<a href="#l62.70"></a><span id="l62.70">  * Bug 293183 - implement exception support for recurrence.</span>
<a href="#l62.71"></a><span id="l62.71">  * r=shaver,p=vlad</span>
<a href="#l62.72"></a><span id="l62.72">  */</span>
<a href="#l62.73"></a><span id="l62.73" class="difflineminus">-upgrade.v4 = function(db, version) {</span>
<a href="#l62.74"></a><span id="l62.74" class="difflineplus">+upgrade.v4 = function(db, version) { // eslint-disable-line id-length</span>
<a href="#l62.75"></a><span id="l62.75">     let tbl = upgrade.v3(version &lt; 3 &amp;&amp; db, version);</span>
<a href="#l62.76"></a><span id="l62.76">     LOGdb(db, &quot;Storage: Upgrading to v4&quot;);</span>
<a href="#l62.77"></a><span id="l62.77"> </span>
<a href="#l62.78"></a><span id="l62.78">     beginTransaction(db);</span>
<a href="#l62.79"></a><span id="l62.79">     try {</span>
<a href="#l62.80"></a><span id="l62.80">         for (let tblid of [&quot;events&quot;, &quot;todos&quot;, &quot;attendees&quot;, &quot;properties&quot;]) {</span>
<a href="#l62.81"></a><span id="l62.81">             addColumn(tbl, &quot;cal_&quot; + tblid, &quot;recurrence_id&quot;, &quot;INTEGER&quot;, db);</span>
<a href="#l62.82"></a><span id="l62.82">             addColumn(tbl, &quot;cal_&quot; + tblid, &quot;recurrence_id_tz&quot;, &quot;VARCHAR&quot;, db);</span>
<a href="#l62.83"></a><span id="l62.83" class="difflineat">@@ -821,17 +821,17 @@ upgrade.v4 = function(db, version) {</span>
<a href="#l62.84"></a><span id="l62.84">     return tbl;</span>
<a href="#l62.85"></a><span id="l62.85"> };</span>
<a href="#l62.86"></a><span id="l62.86"> </span>
<a href="#l62.87"></a><span id="l62.87"> /**</span>
<a href="#l62.88"></a><span id="l62.88">  * Bug 315051 - Switch to storing alarms based on offsets from start/end time</span>
<a href="#l62.89"></a><span id="l62.89">  * rather than as absolute times. Ensure that missed alarms are fired.</span>
<a href="#l62.90"></a><span id="l62.90">  * r=dmose, p=jminta</span>
<a href="#l62.91"></a><span id="l62.91">  */</span>
<a href="#l62.92"></a><span id="l62.92" class="difflineminus">-upgrade.v5 = function(db, version) {</span>
<a href="#l62.93"></a><span id="l62.93" class="difflineplus">+upgrade.v5 = function(db, version) { // eslint-disable-line id-length</span>
<a href="#l62.94"></a><span id="l62.94">     let tbl = upgrade.v4(version &lt; 4 &amp;&amp; db, version);</span>
<a href="#l62.95"></a><span id="l62.95">     LOGdb(db, &quot;Storage: Upgrading to v5&quot;);</span>
<a href="#l62.96"></a><span id="l62.96"> </span>
<a href="#l62.97"></a><span id="l62.97">     beginTransaction(db);</span>
<a href="#l62.98"></a><span id="l62.98">     try {</span>
<a href="#l62.99"></a><span id="l62.99">         for (let tblid of [&quot;events&quot;, &quot;todos&quot;]) {</span>
<a href="#l62.100"></a><span id="l62.100">             addColumn(tbl, &quot;cal_&quot; + tblid, &quot;alarm_offset&quot;, &quot;INTEGER&quot;, db);</span>
<a href="#l62.101"></a><span id="l62.101">             addColumn(tbl, &quot;cal_&quot; + tblid, &quot;alarm_related&quot;, &quot;INTEGER&quot;, db);</span>
<a href="#l62.102"></a><span id="l62.102" class="difflineat">@@ -845,17 +845,17 @@ upgrade.v5 = function(db, version) {</span>
<a href="#l62.103"></a><span id="l62.103">     return tbl;</span>
<a href="#l62.104"></a><span id="l62.104"> };</span>
<a href="#l62.105"></a><span id="l62.105"> </span>
<a href="#l62.106"></a><span id="l62.106"> /**</span>
<a href="#l62.107"></a><span id="l62.107">  * Bug 333688 - Converts STRING and VARCHAR columns to TEXT to avoid SQLite's</span>
<a href="#l62.108"></a><span id="l62.108">  * auto-conversion of strings to numbers (10e4 to 10000)</span>
<a href="#l62.109"></a><span id="l62.109">  * r=ctalbert,jminta p=lilmatt</span>
<a href="#l62.110"></a><span id="l62.110">  */</span>
<a href="#l62.111"></a><span id="l62.111" class="difflineminus">-upgrade.v6 = function(db, version) {</span>
<a href="#l62.112"></a><span id="l62.112" class="difflineplus">+upgrade.v6 = function(db, version) { // eslint-disable-line id-length</span>
<a href="#l62.113"></a><span id="l62.113">     let tbl = upgrade.v5(version &lt; 5 &amp;&amp; db, version);</span>
<a href="#l62.114"></a><span id="l62.114">     LOGdb(db, &quot;Storage: Upgrading to v6&quot;);</span>
<a href="#l62.115"></a><span id="l62.115"> </span>
<a href="#l62.116"></a><span id="l62.116">     beginTransaction(db);</span>
<a href="#l62.117"></a><span id="l62.117">     try {</span>
<a href="#l62.118"></a><span id="l62.118">         let eventCols = [&quot;id&quot;, &quot;title&quot;, &quot;privacy&quot;, &quot;ical_status&quot;,</span>
<a href="#l62.119"></a><span id="l62.119">                          &quot;recurrence_id_tz&quot;, &quot;event_start_tz&quot;,</span>
<a href="#l62.120"></a><span id="l62.120">                          &quot;event_end_tz&quot;, &quot;alarm_time_tz&quot;];</span>
<a href="#l62.121"></a><span id="l62.121" class="difflineat">@@ -885,39 +885,39 @@ upgrade.v6 = function(db, version) {</span>
<a href="#l62.122"></a><span id="l62.122"> </span>
<a href="#l62.123"></a><span id="l62.123">     return tbl;</span>
<a href="#l62.124"></a><span id="l62.124"> };</span>
<a href="#l62.125"></a><span id="l62.125"> </span>
<a href="#l62.126"></a><span id="l62.126"> /**</span>
<a href="#l62.127"></a><span id="l62.127">  * Bug 369010: Migrate all old tzids in storage to new one.</span>
<a href="#l62.128"></a><span id="l62.128">  * r=ctalbert,dmose p=lilmatt</span>
<a href="#l62.129"></a><span id="l62.129">  */</span>
<a href="#l62.130"></a><span id="l62.130" class="difflineminus">-upgrade.v7 = function(db, version) {</span>
<a href="#l62.131"></a><span id="l62.131" class="difflineplus">+upgrade.v7 = function(db, version) { // eslint-disable-line id-length</span>
<a href="#l62.132"></a><span id="l62.132">     // No schema changes in v7</span>
<a href="#l62.133"></a><span id="l62.133">     let tbl = upgrade.v6(db, version);</span>
<a href="#l62.134"></a><span id="l62.134">     LOGdb(db, &quot;Storage: Upgrading to v7&quot;);</span>
<a href="#l62.135"></a><span id="l62.135">     return tbl;</span>
<a href="#l62.136"></a><span id="l62.136"> };</span>
<a href="#l62.137"></a><span id="l62.137"> </span>
<a href="#l62.138"></a><span id="l62.138"> /**</span>
<a href="#l62.139"></a><span id="l62.139">  * Bug 410931 - Update internal timezone definitions</span>
<a href="#l62.140"></a><span id="l62.140">  * r=ctalbert, p=dbo,nth10sd,hb</span>
<a href="#l62.141"></a><span id="l62.141">  */</span>
<a href="#l62.142"></a><span id="l62.142" class="difflineminus">-upgrade.v8 = function(db, version) {</span>
<a href="#l62.143"></a><span id="l62.143" class="difflineplus">+upgrade.v8 = function(db, version) { // eslint-disable-line id-length</span>
<a href="#l62.144"></a><span id="l62.144">     // No schema changes in v8</span>
<a href="#l62.145"></a><span id="l62.145">     let tbl = upgrade.v7(db, version);</span>
<a href="#l62.146"></a><span id="l62.146">     LOGdb(db, &quot;Storage: Upgrading to v8&quot;);</span>
<a href="#l62.147"></a><span id="l62.147">     return tbl;</span>
<a href="#l62.148"></a><span id="l62.148"> };</span>
<a href="#l62.149"></a><span id="l62.149"> </span>
<a href="#l62.150"></a><span id="l62.150"> /**</span>
<a href="#l62.151"></a><span id="l62.151">  * Bug 363191 - Handle Timezones more efficiently (Timezone Database)</span>
<a href="#l62.152"></a><span id="l62.152">  * r=philipp,ctalbert, p=dbo</span>
<a href="#l62.153"></a><span id="l62.153">  */</span>
<a href="#l62.154"></a><span id="l62.154" class="difflineminus">-upgrade.v9 = function(db, version) {</span>
<a href="#l62.155"></a><span id="l62.155" class="difflineplus">+upgrade.v9 = function(db, version) { // eslint-disable-line id-length</span>
<a href="#l62.156"></a><span id="l62.156">     // No schema changes in v9</span>
<a href="#l62.157"></a><span id="l62.157">     let tbl = upgrade.v8(db, version);</span>
<a href="#l62.158"></a><span id="l62.158">     LOGdb(db, &quot;Storage: Upgrading to v9&quot;);</span>
<a href="#l62.159"></a><span id="l62.159">     return tbl;</span>
<a href="#l62.160"></a><span id="l62.160"> };</span>
<a href="#l62.161"></a><span id="l62.161"> </span>
<a href="#l62.162"></a><span id="l62.162"> /**</span>
<a href="#l62.163"></a><span id="l62.163">  * Bug 413908 – Events using internal timezones are no longer updated to</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l63.1"></a><span id="l63.1" class="difflineminus">--- a/calendar/providers/wcap/calWcapCalendar.js</span>
<a href="#l63.2"></a><span id="l63.2" class="difflineplus">+++ b/calendar/providers/wcap/calWcapCalendar.js</span>
<a href="#l63.3"></a><span id="l63.3" class="difflineat">@@ -243,49 +243,49 @@ calWcapCalendar.prototype = {</span>
<a href="#l63.4"></a><span id="l63.4">     },</span>
<a href="#l63.5"></a><span id="l63.5"> </span>
<a href="#l63.6"></a><span id="l63.6">     m_calId: null,</span>
<a href="#l63.7"></a><span id="l63.7">     get calId() {</span>
<a href="#l63.8"></a><span id="l63.8">         return this.m_calId || this.session.defaultCalId;</span>
<a href="#l63.9"></a><span id="l63.9">     },</span>
<a href="#l63.10"></a><span id="l63.10"> </span>
<a href="#l63.11"></a><span id="l63.11">     get ownerId() {</span>
<a href="#l63.12"></a><span id="l63.12" class="difflineminus">-        let ar = this.getCalendarProperties(&quot;X-NSCP-CALPROPS-PRIMARY-OWNER&quot;);</span>
<a href="#l63.13"></a><span id="l63.13" class="difflineminus">-        if (ar.length == 0) {</span>
<a href="#l63.14"></a><span id="l63.14" class="difflineplus">+        let owner = this.getCalendarProperties(&quot;X-NSCP-CALPROPS-PRIMARY-OWNER&quot;);</span>
<a href="#l63.15"></a><span id="l63.15" class="difflineplus">+        if (owner.length == 0) {</span>
<a href="#l63.16"></a><span id="l63.16">             let calId = this.calId;</span>
<a href="#l63.17"></a><span id="l63.17">             log(&quot;cannot determine primary owner of calendar &quot; + calId, this);</span>
<a href="#l63.18"></a><span id="l63.18">             // fallback to calId prefix:</span>
<a href="#l63.19"></a><span id="l63.19">             let nColon = calId.indexOf(&quot;:&quot;);</span>
<a href="#l63.20"></a><span id="l63.20">             if (nColon &gt;= 0) {</span>
<a href="#l63.21"></a><span id="l63.21">                 calId = calId.substring(0, nColon);</span>
<a href="#l63.22"></a><span id="l63.22">             }</span>
<a href="#l63.23"></a><span id="l63.23">             return calId;</span>
<a href="#l63.24"></a><span id="l63.24">         }</span>
<a href="#l63.25"></a><span id="l63.25" class="difflineminus">-        return ar[0];</span>
<a href="#l63.26"></a><span id="l63.26" class="difflineplus">+        return owner[0];</span>
<a href="#l63.27"></a><span id="l63.27">     },</span>
<a href="#l63.28"></a><span id="l63.28"> </span>
<a href="#l63.29"></a><span id="l63.29">     get description() {</span>
<a href="#l63.30"></a><span id="l63.30" class="difflineminus">-        let ar = this.getCalendarProperties(&quot;X-NSCP-CALPROPS-DESCRIPTION&quot;);</span>
<a href="#l63.31"></a><span id="l63.31" class="difflineminus">-        if (ar.length == 0) {</span>
<a href="#l63.32"></a><span id="l63.32" class="difflineplus">+        let descr = this.getCalendarProperties(&quot;X-NSCP-CALPROPS-DESCRIPTION&quot;);</span>
<a href="#l63.33"></a><span id="l63.33" class="difflineplus">+        if (descr.length == 0) {</span>
<a href="#l63.34"></a><span id="l63.34">             // fallback to display name:</span>
<a href="#l63.35"></a><span id="l63.35">             return this.displayName;</span>
<a href="#l63.36"></a><span id="l63.36">         }</span>
<a href="#l63.37"></a><span id="l63.37" class="difflineminus">-        return ar[0];</span>
<a href="#l63.38"></a><span id="l63.38" class="difflineplus">+        return descr[0];</span>
<a href="#l63.39"></a><span id="l63.39">     },</span>
<a href="#l63.40"></a><span id="l63.40"> </span>
<a href="#l63.41"></a><span id="l63.41">     get displayName() {</span>
<a href="#l63.42"></a><span id="l63.42" class="difflineminus">-        let ar = this.getCalendarProperties(&quot;X-NSCP-CALPROPS-NAME&quot;);</span>
<a href="#l63.43"></a><span id="l63.43" class="difflineminus">-        if (ar.length == 0) {</span>
<a href="#l63.44"></a><span id="l63.44" class="difflineplus">+        let displayName = this.getCalendarProperties(&quot;X-NSCP-CALPROPS-NAME&quot;);</span>
<a href="#l63.45"></a><span id="l63.45" class="difflineplus">+        if (displayName.length == 0) {</span>
<a href="#l63.46"></a><span id="l63.46">             // fallback to common name:</span>
<a href="#l63.47"></a><span id="l63.47" class="difflineminus">-            ar = this.getCalendarProperties(&quot;X-S1CS-CALPROPS-COMMON-NAME&quot;);</span>
<a href="#l63.48"></a><span id="l63.48" class="difflineminus">-            if (ar.length == 0) {</span>
<a href="#l63.49"></a><span id="l63.49" class="difflineminus">-                ar = [this.calId];</span>
<a href="#l63.50"></a><span id="l63.50" class="difflineplus">+            displayName = this.getCalendarProperties(&quot;X-S1CS-CALPROPS-COMMON-NAME&quot;);</span>
<a href="#l63.51"></a><span id="l63.51" class="difflineplus">+            if (displayName.length == 0) {</span>
<a href="#l63.52"></a><span id="l63.52" class="difflineplus">+                displayName = [this.calId];</span>
<a href="#l63.53"></a><span id="l63.53">             }</span>
<a href="#l63.54"></a><span id="l63.54">         }</span>
<a href="#l63.55"></a><span id="l63.55" class="difflineminus">-        return ar[0];</span>
<a href="#l63.56"></a><span id="l63.56" class="difflineplus">+        return displayName[0];</span>
<a href="#l63.57"></a><span id="l63.57">     },</span>
<a href="#l63.58"></a><span id="l63.58"> </span>
<a href="#l63.59"></a><span id="l63.59">     get isOwnedCalendar() {</span>
<a href="#l63.60"></a><span id="l63.60">         if (this.isDefaultCalendar) {</span>
<a href="#l63.61"></a><span id="l63.61">             return true; // default calendar is owned</span>
<a href="#l63.62"></a><span id="l63.62">         }</span>
<a href="#l63.63"></a><span id="l63.63">         return (this.ownerId == this.session.userId);</span>
<a href="#l63.64"></a><span id="l63.64">     },</span>
<a href="#l63.65"></a><span id="l63.65" class="difflineat">@@ -313,20 +313,20 @@ calWcapCalendar.prototype = {</span>
<a href="#l63.66"></a><span id="l63.66">         } else {</span>
<a href="#l63.67"></a><span id="l63.67">             logWarning(&quot;defaultTimezone: cannot get X-NSCP-CALPROPS-TZID!&quot;, this);</span>
<a href="#l63.68"></a><span id="l63.68">             // try to use local one if supported:</span>
<a href="#l63.69"></a><span id="l63.69">             tzid = cal.getTimezoneService().defaultTimezone.tzid;</span>
<a href="#l63.70"></a><span id="l63.70">             return (this.session.getTimezone(tzid) ? tzid : &quot;UTC&quot;);</span>
<a href="#l63.71"></a><span id="l63.71">         }</span>
<a href="#l63.72"></a><span id="l63.72">     },</span>
<a href="#l63.73"></a><span id="l63.73"> </span>
<a href="#l63.74"></a><span id="l63.74" class="difflineminus">-    getAlignedTzid: function(tz) {</span>
<a href="#l63.75"></a><span id="l63.75" class="difflineminus">-        let tzid = tz.tzid;</span>
<a href="#l63.76"></a><span id="l63.76" class="difflineplus">+    getAlignedTzid: function(timezone) {</span>
<a href="#l63.77"></a><span id="l63.77" class="difflineplus">+        let tzid = timezone.tzid;</span>
<a href="#l63.78"></a><span id="l63.78">         // check whether it is one cs supports:</span>
<a href="#l63.79"></a><span id="l63.79" class="difflineminus">-        if (tz.isFloating || !this.session.getTimezone(tzid)) {</span>
<a href="#l63.80"></a><span id="l63.80" class="difflineplus">+        if (timezone.isFloating || !this.session.getTimezone(tzid)) {</span>
<a href="#l63.81"></a><span id="l63.81">             log(&quot;not a supported timezone: &quot; + tzid);</span>
<a href="#l63.82"></a><span id="l63.82">             // bug 435436:</span>
<a href="#l63.83"></a><span id="l63.83">             // xxx todo: we could further on search for a matching region,</span>
<a href="#l63.84"></a><span id="l63.84">             //           e.g. CET (in TZNAME), but for now stick to</span>
<a href="#l63.85"></a><span id="l63.85">             //           user's default if not supported directly</span>
<a href="#l63.86"></a><span id="l63.86">             let ret = this.defaultTimezone;</span>
<a href="#l63.87"></a><span id="l63.87">             // use calendar's default:</span>
<a href="#l63.88"></a><span id="l63.88">             log(tzid + &quot; not supported, falling back to default: &quot; + ret, this);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l64.1"></a><span id="l64.1" class="difflineminus">--- a/calendar/providers/wcap/calWcapCalendarItems.js</span>
<a href="#l64.2"></a><span id="l64.2" class="difflineplus">+++ b/calendar/providers/wcap/calWcapCalendarItems.js</span>
<a href="#l64.3"></a><span id="l64.3" class="difflineat">@@ -20,19 +20,19 @@ calWcapCalendar.prototype.encodeAttendee</span>
<a href="#l64.4"></a><span id="l64.4">             }</span>
<a href="#l64.5"></a><span id="l64.5">             params += encodeURIComponent(val);</span>
<a href="#l64.6"></a><span id="l64.6">         }</span>
<a href="#l64.7"></a><span id="l64.7">         return params;</span>
<a href="#l64.8"></a><span id="l64.8">     }</span>
<a href="#l64.9"></a><span id="l64.9">     let params = encodeAttr(att.rsvp, &quot;RSVP&quot;, &quot;&quot;);</span>
<a href="#l64.10"></a><span id="l64.10">     params = encodeAttr(att.participationStatus, &quot;PARTSTAT&quot;, params);</span>
<a href="#l64.11"></a><span id="l64.11">     params = encodeAttr(att.role, &quot;ROLE&quot;, params);</span>
<a href="#l64.12"></a><span id="l64.12" class="difflineminus">-    let cn = att.commonName;</span>
<a href="#l64.13"></a><span id="l64.13" class="difflineminus">-    if (cn) {</span>
<a href="#l64.14"></a><span id="l64.14" class="difflineminus">-        params = encodeAttr(cn.replace(/[;:]/g, &quot; &quot;), &quot;CN&quot;, params); // remove ';' and ':' from CN</span>
<a href="#l64.15"></a><span id="l64.15" class="difflineplus">+    let commonName = att.commonName;</span>
<a href="#l64.16"></a><span id="l64.16" class="difflineplus">+    if (commonName) {</span>
<a href="#l64.17"></a><span id="l64.17" class="difflineplus">+        params = encodeAttr(commonName.replace(/[;:]/g, &quot; &quot;), &quot;CN&quot;, params); // remove ';' and ':' from CN</span>
<a href="#l64.18"></a><span id="l64.18">     }</span>
<a href="#l64.19"></a><span id="l64.19">     return encodeAttr(att.id, null, params);</span>
<a href="#l64.20"></a><span id="l64.20"> };</span>
<a href="#l64.21"></a><span id="l64.21"> </span>
<a href="#l64.22"></a><span id="l64.22"> calWcapCalendar.prototype.getRecurrenceParams = function(item, out_rrules, out_rdates, out_exrules, out_exdates) {</span>
<a href="#l64.23"></a><span id="l64.23">     // recurrences:</span>
<a href="#l64.24"></a><span id="l64.24">     out_rrules.value = [];</span>
<a href="#l64.25"></a><span id="l64.25">     out_rdates.value = [];</span>
<a href="#l64.26"></a><span id="l64.26" class="difflineat">@@ -195,19 +195,19 @@ calWcapCalendar.prototype.isInvitation =</span>
<a href="#l64.27"></a><span id="l64.27">         return false;</span>
<a href="#l64.28"></a><span id="l64.28">     }</span>
<a href="#l64.29"></a><span id="l64.29">     return (this.getInvitedAttendee(item) != null);</span>
<a href="#l64.30"></a><span id="l64.30"> };</span>
<a href="#l64.31"></a><span id="l64.31"> </span>
<a href="#l64.32"></a><span id="l64.32"> calWcapCalendar.prototype.getInvitedAttendee = function(item) {</span>
<a href="#l64.33"></a><span id="l64.33">     let att = getAttendeeByCalId(item.getAttendees({}), this.calId);</span>
<a href="#l64.34"></a><span id="l64.34">     if (!att) { // try to find mail address</span>
<a href="#l64.35"></a><span id="l64.35" class="difflineminus">-        let ar = this.session.getUserPreferences(&quot;X-NSCP-WCAP-PREF-mail&quot;);</span>
<a href="#l64.36"></a><span id="l64.36" class="difflineminus">-        if (ar.length &gt; 0 &amp;&amp; ar[0].length &gt; 0) {</span>
<a href="#l64.37"></a><span id="l64.37" class="difflineminus">-            att = item.getAttendeeById(&quot;mailto:&quot; + ar[0]);</span>
<a href="#l64.38"></a><span id="l64.38" class="difflineplus">+        let prefMail = this.session.getUserPreferences(&quot;X-NSCP-WCAP-PREF-mail&quot;);</span>
<a href="#l64.39"></a><span id="l64.39" class="difflineplus">+        if (prefMail.length &gt; 0 &amp;&amp; prefMail[0].length &gt; 0) {</span>
<a href="#l64.40"></a><span id="l64.40" class="difflineplus">+            att = item.getAttendeeById(&quot;mailto:&quot; + prefMail[0]);</span>
<a href="#l64.41"></a><span id="l64.41">         }</span>
<a href="#l64.42"></a><span id="l64.42">     }</span>
<a href="#l64.43"></a><span id="l64.43">     return att;</span>
<a href="#l64.44"></a><span id="l64.44"> };</span>
<a href="#l64.45"></a><span id="l64.45"> </span>
<a href="#l64.46"></a><span id="l64.46"> calWcapCalendar.prototype.canNotify = function(method, item) {</span>
<a href="#l64.47"></a><span id="l64.47">     if (!this.session.isLoggedIn) {</span>
<a href="#l64.48"></a><span id="l64.48">         return false;</span>
<a href="#l64.49"></a><span id="l64.49" class="difflineat">@@ -777,42 +777,42 @@ calWcapCalendar.prototype.deleteItem = f</span>
<a href="#l64.50"></a><span id="l64.50">                                  params, calIWcapCalendar.AC_COMP_WRITE);</span>
<a href="#l64.51"></a><span id="l64.51">     } catch (exc) {</span>
<a href="#l64.52"></a><span id="l64.52">         request.execRespFunc(exc);</span>
<a href="#l64.53"></a><span id="l64.53">     }</span>
<a href="#l64.54"></a><span id="l64.54">     return request;</span>
<a href="#l64.55"></a><span id="l64.55"> };</span>
<a href="#l64.56"></a><span id="l64.56"> </span>
<a href="#l64.57"></a><span id="l64.57"> calWcapCalendar.prototype.patchTimezone = function(subComp, attr, xpropOrTz) {</span>
<a href="#l64.58"></a><span id="l64.58" class="difflineminus">-    let dt = subComp[attr];</span>
<a href="#l64.59"></a><span id="l64.59" class="difflineplus">+    let date = subComp[attr];</span>
<a href="#l64.60"></a><span id="l64.60">     // if TZID parameter present (all-day items), it takes precedence:</span>
<a href="#l64.61"></a><span id="l64.61" class="difflineminus">-    if (dt &amp;&amp; (dt.timezone.isUTC || dt.timezone.isFloating)) {</span>
<a href="#l64.62"></a><span id="l64.62" class="difflineplus">+    if (date &amp;&amp; (date.timezone.isUTC || date.timezone.isFloating)) {</span>
<a href="#l64.63"></a><span id="l64.63">         if (LOG_LEVEL &gt; 2) {</span>
<a href="#l64.64"></a><span id="l64.64" class="difflineminus">-            log(attr + &quot; is &quot; + dt, this);</span>
<a href="#l64.65"></a><span id="l64.65" class="difflineplus">+            log(attr + &quot; is &quot; + date, this);</span>
<a href="#l64.66"></a><span id="l64.66">         }</span>
<a href="#l64.67"></a><span id="l64.67" class="difflineminus">-        let tz;</span>
<a href="#l64.68"></a><span id="l64.68" class="difflineplus">+        let timezone;</span>
<a href="#l64.69"></a><span id="l64.69">         if (typeof xpropOrTz == &quot;string&quot;) {</span>
<a href="#l64.70"></a><span id="l64.70">             let tzid = subComp.getFirstProperty(xpropOrTz);</span>
<a href="#l64.71"></a><span id="l64.71">             if (tzid) {</span>
<a href="#l64.72"></a><span id="l64.72" class="difflineminus">-                tz = this.session.getTimezone(tzid.value);</span>
<a href="#l64.73"></a><span id="l64.73" class="difflineminus">-                ASSERT(tz, &quot;timezone not found: &quot; + tzid);</span>
<a href="#l64.74"></a><span id="l64.74" class="difflineplus">+                timezone = this.session.getTimezone(tzid.value);</span>
<a href="#l64.75"></a><span id="l64.75" class="difflineplus">+                ASSERT(timezone, &quot;timezone not found: &quot; + tzid);</span>
<a href="#l64.76"></a><span id="l64.76">             }</span>
<a href="#l64.77"></a><span id="l64.77">         } else {</span>
<a href="#l64.78"></a><span id="l64.78" class="difflineminus">-            tz = xpropOrTz;</span>
<a href="#l64.79"></a><span id="l64.79" class="difflineplus">+            timezone = xpropOrTz;</span>
<a href="#l64.80"></a><span id="l64.80">         }</span>
<a href="#l64.81"></a><span id="l64.81" class="difflineminus">-        if (tz) {</span>
<a href="#l64.82"></a><span id="l64.82" class="difflineplus">+        if (timezone) {</span>
<a href="#l64.83"></a><span id="l64.83">             if (LOG_LEVEL &gt; 2) {</span>
<a href="#l64.84"></a><span id="l64.84">                 log(&quot;patching &quot; + xpropOrTz + &quot;: from &quot; +</span>
<a href="#l64.85"></a><span id="l64.85" class="difflineminus">-                    dt + &quot; to &quot; + dt.getInTimezone(tz), this);</span>
<a href="#l64.86"></a><span id="l64.86" class="difflineplus">+                    date + &quot; to &quot; + date.getInTimezone(timezone), this);</span>
<a href="#l64.87"></a><span id="l64.87">             }</span>
<a href="#l64.88"></a><span id="l64.88" class="difflineminus">-            dt = dt.getInTimezone(tz);</span>
<a href="#l64.89"></a><span id="l64.89" class="difflineminus">-            subComp[attr] = dt;</span>
<a href="#l64.90"></a><span id="l64.90" class="difflineplus">+            date = date.getInTimezone(timezone);</span>
<a href="#l64.91"></a><span id="l64.91" class="difflineplus">+            subComp[attr] = date;</span>
<a href="#l64.92"></a><span id="l64.92">         }</span>
<a href="#l64.93"></a><span id="l64.93">     }</span>
<a href="#l64.94"></a><span id="l64.94" class="difflineminus">-    return dt;</span>
<a href="#l64.95"></a><span id="l64.95" class="difflineplus">+    return date;</span>
<a href="#l64.96"></a><span id="l64.96"> };</span>
<a href="#l64.97"></a><span id="l64.97"> </span>
<a href="#l64.98"></a><span id="l64.98"> calWcapCalendar.prototype.parseItems = function(</span>
<a href="#l64.99"></a><span id="l64.99">     icalRootComp, itemFilter, maxResults, rangeStart, rangeEnd, bLeaveMutable) {</span>
<a href="#l64.100"></a><span id="l64.100">     let items = [];</span>
<a href="#l64.101"></a><span id="l64.101">     let unexpandedItems = [];</span>
<a href="#l64.102"></a><span id="l64.102">     let uid2parent = {};</span>
<a href="#l64.103"></a><span id="l64.103">     let excItems = [];</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l65.1"></a><span id="l65.1" class="difflineminus">--- a/calendar/providers/wcap/calWcapSession.js</span>
<a href="#l65.2"></a><span id="l65.2" class="difflineplus">+++ b/calendar/providers/wcap/calWcapSession.js</span>
<a href="#l65.3"></a><span id="l65.3" class="difflineat">@@ -19,18 +19,18 @@ function calWcapTimezone(tzProvider, tzi</span>
<a href="#l65.4"></a><span id="l65.4">     this.isFloating = false;</span>
<a href="#l65.5"></a><span id="l65.5">     this.latitude = null;</span>
<a href="#l65.6"></a><span id="l65.6">     this.longitude = null;</span>
<a href="#l65.7"></a><span id="l65.7"> }</span>
<a href="#l65.8"></a><span id="l65.8"> calWcapTimezone.prototype = {</span>
<a href="#l65.9"></a><span id="l65.9">     get displayName() {</span>
<a href="#l65.10"></a><span id="l65.10">         if (this.mDisplayName === undefined) {</span>
<a href="#l65.11"></a><span id="l65.11">             // used l10n'ed display name if available:</span>
<a href="#l65.12"></a><span id="l65.12" class="difflineminus">-            let tz = cal.getTimezoneService().getTimezone(this.tzid);</span>
<a href="#l65.13"></a><span id="l65.13" class="difflineminus">-            this.mDisplayName = (tz ? tz.displayName : this.tzid);</span>
<a href="#l65.14"></a><span id="l65.14" class="difflineplus">+            let timezone = cal.getTimezoneService().getTimezone(this.tzid);</span>
<a href="#l65.15"></a><span id="l65.15" class="difflineplus">+            this.mDisplayName = (timezone ? timezone.displayName : this.tzid);</span>
<a href="#l65.16"></a><span id="l65.16">         }</span>
<a href="#l65.17"></a><span id="l65.17">         return this.mDisplayName;</span>
<a href="#l65.18"></a><span id="l65.18">     },</span>
<a href="#l65.19"></a><span id="l65.19">     toString: function() {</span>
<a href="#l65.20"></a><span id="l65.20">         return this.icalComponent.toString();</span>
<a href="#l65.21"></a><span id="l65.21">     }</span>
<a href="#l65.22"></a><span id="l65.22"> };</span>
<a href="#l65.23"></a><span id="l65.23"> </span>
<a href="#l65.24"></a><span id="l65.24" class="difflineat">@@ -302,30 +302,30 @@ calWcapSession.prototype = {</span>
<a href="#l65.25"></a><span id="l65.25">                     } else if (loginerr) {</span>
<a href="#l65.26"></a><span id="l65.26">                         respFunc(loginerr);</span>
<a href="#l65.27"></a><span id="l65.27">                     } else {</span>
<a href="#l65.28"></a><span id="l65.28">                         if (outSavePW.value) {</span>
<a href="#l65.29"></a><span id="l65.29">                             // so try to remove old pw from db first:</span>
<a href="#l65.30"></a><span id="l65.30">                             cal.auth.passwordManagerSave(outUser.value, outPW.value, this.uri.spec, &quot;wcap login&quot;);</span>
<a href="#l65.31"></a><span id="l65.31">                         }</span>
<a href="#l65.32"></a><span id="l65.32">                         this.credentials.userId = outUser.value;</span>
<a href="#l65.33"></a><span id="l65.33" class="difflineminus">-                        this.credentials.pw = outPW.value;</span>
<a href="#l65.34"></a><span id="l65.34" class="difflineplus">+                        this.credentials.pw = outPW.value; // eslint-disable-line id-length</span>
<a href="#l65.35"></a><span id="l65.35">                         this.setupSession(sessionId, request, (setuperr) =&gt; respFunc(setuperr, sessionId));</span>
<a href="#l65.36"></a><span id="l65.36">                     }</span>
<a href="#l65.37"></a><span id="l65.37">                 };</span>
<a href="#l65.38"></a><span id="l65.38"> </span>
<a href="#l65.39"></a><span id="l65.39">                 if (outPW.value) {</span>
<a href="#l65.40"></a><span id="l65.40">                     this.login(request, promptAndLoginLoop_resp, outUser.value, outPW.value);</span>
<a href="#l65.41"></a><span id="l65.41">                 } else {</span>
<a href="#l65.42"></a><span id="l65.42">                     promptAndLoginLoop_resp(calIWcapErrors.WCAP_LOGIN_FAILED);</span>
<a href="#l65.43"></a><span id="l65.43">                 }</span>
<a href="#l65.44"></a><span id="l65.44">             });</span>
<a href="#l65.45"></a><span id="l65.45">     },</span>
<a href="#l65.46"></a><span id="l65.46"> </span>
<a href="#l65.47"></a><span id="l65.47" class="difflineminus">-    login: function(request, respFunc, user, pw) {</span>
<a href="#l65.48"></a><span id="l65.48" class="difflineplus">+    login: function(request, respFunc, user, password) {</span>
<a href="#l65.49"></a><span id="l65.49">         issueNetworkRequest(</span>
<a href="#l65.50"></a><span id="l65.50">             request,</span>
<a href="#l65.51"></a><span id="l65.51">             (err, str) =&gt; {</span>
<a href="#l65.52"></a><span id="l65.52">                 let sessionId;</span>
<a href="#l65.53"></a><span id="l65.53">                 try {</span>
<a href="#l65.54"></a><span id="l65.54">                     if (err) {</span>
<a href="#l65.55"></a><span id="l65.55">                         throw err;</span>
<a href="#l65.56"></a><span id="l65.56">                     }</span>
<a href="#l65.57"></a><span id="l65.57" class="difflineat">@@ -355,17 +355,17 @@ calWcapSession.prototype = {</span>
<a href="#l65.58"></a><span id="l65.58">                         // server seems unavailable:</span>
<a href="#l65.59"></a><span id="l65.59">                         err = new Components.Exception(cal.calGetString(&quot;wcap&quot;, &quot;accessingServerFailedError.text&quot;,</span>
<a href="#l65.60"></a><span id="l65.60">                                                                         [this.sessionUri.hostPort]), exc);</span>
<a href="#l65.61"></a><span id="l65.61">                     }</span>
<a href="#l65.62"></a><span id="l65.62">                 }</span>
<a href="#l65.63"></a><span id="l65.63">                 respFunc(err, sessionId);</span>
<a href="#l65.64"></a><span id="l65.64">             },</span>
<a href="#l65.65"></a><span id="l65.65">             this.sessionUri.spec + &quot;login.wcap?fmt-out=text%2Fcalendar&amp;user=&quot; +</span>
<a href="#l65.66"></a><span id="l65.66" class="difflineminus">-            encodeURIComponent(user) + &quot;&amp;password=&quot; + encodeURIComponent(pw),</span>
<a href="#l65.67"></a><span id="l65.67" class="difflineplus">+            encodeURIComponent(user) + &quot;&amp;password=&quot; + encodeURIComponent(password),</span>
<a href="#l65.68"></a><span id="l65.68">             false /* no logging */);</span>
<a href="#l65.69"></a><span id="l65.69">     },</span>
<a href="#l65.70"></a><span id="l65.70"> </span>
<a href="#l65.71"></a><span id="l65.71">     logout: function(listener) {</span>
<a href="#l65.72"></a><span id="l65.72">         let request = new calWcapRequest(</span>
<a href="#l65.73"></a><span id="l65.73">             (oprequest, err) =&gt; {</span>
<a href="#l65.74"></a><span id="l65.74">                 if (err) {</span>
<a href="#l65.75"></a><span id="l65.75">                     logError(err, this);</span>
<a href="#l65.76"></a><span id="l65.76" class="difflineat">@@ -489,22 +489,22 @@ calWcapSession.prototype = {</span>
<a href="#l65.77"></a><span id="l65.77">                     let defaultCal = this.defaultCalendar;</span>
<a href="#l65.78"></a><span id="l65.78">                     if (defaultCal &amp;&amp; cals[defaultCal.calId] &amp;&amp; // default calendar is registered</span>
<a href="#l65.79"></a><span id="l65.79">                         getPref(&quot;calendar.wcap.subscriptions&quot;, true) &amp;&amp;</span>
<a href="#l65.80"></a><span id="l65.80">                         !defaultCal.getProperty(&quot;subscriptions_registered&quot;)) {</span>
<a href="#l65.81"></a><span id="l65.81">                         let hasSubscriptions = false;</span>
<a href="#l65.82"></a><span id="l65.82">                         // post register subscribed calendars:</span>
<a href="#l65.83"></a><span id="l65.83">                         let list = this.getUserPreferences(&quot;X-NSCP-WCAP-PREF-icsSubscribed&quot;);</span>
<a href="#l65.84"></a><span id="l65.84">                         for (let item of list) {</span>
<a href="#l65.85"></a><span id="l65.85" class="difflineminus">-                            let ar = item.split(&quot;,&quot;);</span>
<a href="#l65.86"></a><span id="l65.86" class="difflineplus">+                            let itemparts = item.split(&quot;,&quot;);</span>
<a href="#l65.87"></a><span id="l65.87">                             // ',', '$' are not encoded. ',' can be handled here. WTF.</span>
<a href="#l65.88"></a><span id="l65.88" class="difflineminus">-                            for (let a of ar) {</span>
<a href="#l65.89"></a><span id="l65.89" class="difflineminus">-                                let dollar = a.indexOf(&quot;$&quot;);</span>
<a href="#l65.90"></a><span id="l65.90" class="difflineplus">+                            for (let part of itemparts) {</span>
<a href="#l65.91"></a><span id="l65.91" class="difflineplus">+                                let dollar = part.indexOf(&quot;$&quot;);</span>
<a href="#l65.92"></a><span id="l65.92">                                 if (dollar &gt;= 0) {</span>
<a href="#l65.93"></a><span id="l65.93" class="difflineminus">-                                    let calId = a.substring(0, dollar);</span>
<a href="#l65.94"></a><span id="l65.94" class="difflineplus">+                                    let calId = part.substring(0, dollar);</span>
<a href="#l65.95"></a><span id="l65.95">                                     if (calId != this.defaultCalId) {</span>
<a href="#l65.96"></a><span id="l65.96">                                         cals[calId] = null;</span>
<a href="#l65.97"></a><span id="l65.97">                                         hasSubscriptions = true;</span>
<a href="#l65.98"></a><span id="l65.98">                                     }</span>
<a href="#l65.99"></a><span id="l65.99">                                 }</span>
<a href="#l65.100"></a><span id="l65.100">                             }</span>
<a href="#l65.101"></a><span id="l65.101">                         }</span>
<a href="#l65.102"></a><span id="l65.102"> </span>
<a href="#l65.103"></a><span id="l65.103" class="difflineat">@@ -555,19 +555,19 @@ calWcapSession.prototype = {</span>
<a href="#l65.104"></a><span id="l65.104">                                                calIWcapErrors.WCAP_LOGIN_FAILED);</span>
<a href="#l65.105"></a><span id="l65.105">             }</span>
<a href="#l65.106"></a><span id="l65.106">             let xml = getDomParser().parseFromString(data, &quot;text/xml&quot;);</span>
<a href="#l65.107"></a><span id="l65.107">             let nodeList = xml.getElementsByTagName(&quot;iCal&quot;);</span>
<a href="#l65.108"></a><span id="l65.108">             for (let i = 0; i &lt; nodeList.length; ++i) {</span>
<a href="#l65.109"></a><span id="l65.109">                 try {</span>
<a href="#l65.110"></a><span id="l65.110">                     let node = nodeList.item(i);</span>
<a href="#l65.111"></a><span id="l65.111">                     checkWcapXmlErrno(node);</span>
<a href="#l65.112"></a><span id="l65.112" class="difflineminus">-                    let ar = filterXmlNodes(&quot;X-NSCP-CALPROPS-RELATIVE-CALID&quot;, node);</span>
<a href="#l65.113"></a><span id="l65.113" class="difflineminus">-                    if (ar.length &gt; 0) {</span>
<a href="#l65.114"></a><span id="l65.114" class="difflineminus">-                        let calId = ar[0];</span>
<a href="#l65.115"></a><span id="l65.115" class="difflineplus">+                    let calid = filterXmlNodes(&quot;X-NSCP-CALPROPS-RELATIVE-CALID&quot;, node);</span>
<a href="#l65.116"></a><span id="l65.116" class="difflineplus">+                    if (calid.length &gt; 0) {</span>
<a href="#l65.117"></a><span id="l65.117" class="difflineplus">+                        let calId = calid[0];</span>
<a href="#l65.118"></a><span id="l65.118">                         let calendar = cals[calId];</span>
<a href="#l65.119"></a><span id="l65.119">                         if (calendar === null) {</span>
<a href="#l65.120"></a><span id="l65.120">                             calendar = new calWcapCalendar(this);</span>
<a href="#l65.121"></a><span id="l65.121">                             let uri = this.uri.clone();</span>
<a href="#l65.122"></a><span id="l65.122">                             uri.path += &quot;?calid=&quot; + encodeURIComponent(calId);</span>
<a href="#l65.123"></a><span id="l65.123">                             calendar.uri = uri;</span>
<a href="#l65.124"></a><span id="l65.124">                         }</span>
<a href="#l65.125"></a><span id="l65.125">                         if (calendar) {</span>
<a href="#l65.126"></a><span id="l65.126" class="difflineat">@@ -818,32 +818,32 @@ calWcapSession.prototype = {</span>
<a href="#l65.127"></a><span id="l65.127"> </span>
<a href="#l65.128"></a><span id="l65.128">     getUserPreferences: function(prefName) {</span>
<a href="#l65.129"></a><span id="l65.129">         let prefs = filterXmlNodes(prefName, this.credentials.userPrefs);</span>
<a href="#l65.130"></a><span id="l65.130">         return prefs;</span>
<a href="#l65.131"></a><span id="l65.131">     },</span>
<a href="#l65.132"></a><span id="l65.132"> </span>
<a href="#l65.133"></a><span id="l65.133">     get defaultAlarmStart() {</span>
<a href="#l65.134"></a><span id="l65.134">         let alarmStart = null;</span>
<a href="#l65.135"></a><span id="l65.135" class="difflineminus">-        let ar = this.getUserPreferences(&quot;X-NSCP-WCAP-PREF-ceDefaultAlarmStart&quot;);</span>
<a href="#l65.136"></a><span id="l65.136" class="difflineminus">-        if (ar.length &gt; 0 &amp;&amp; ar[0].length &gt; 0) {</span>
<a href="#l65.137"></a><span id="l65.137" class="difflineplus">+        let alarmStartPref = this.getUserPreferences(&quot;X-NSCP-WCAP-PREF-ceDefaultAlarmStart&quot;);</span>
<a href="#l65.138"></a><span id="l65.138" class="difflineplus">+        if (alarmStartPref.length &gt; 0 &amp;&amp; alarmStartPref[0].length &gt; 0) {</span>
<a href="#l65.139"></a><span id="l65.139">             // workarounding cs duration bug, missing &quot;T&quot;:</span>
<a href="#l65.140"></a><span id="l65.140" class="difflineminus">-            let dur = ar[0].replace(/(^P)(\d+[HMS]$)/, &quot;$1T$2&quot;);</span>
<a href="#l65.141"></a><span id="l65.141" class="difflineplus">+            let dur = alarmStartPref[0].replace(/(^P)(\d+[HMS]$)/, &quot;$1T$2&quot;);</span>
<a href="#l65.142"></a><span id="l65.142">             alarmStart = cal.createDuration(dur);</span>
<a href="#l65.143"></a><span id="l65.143">             alarmStart.isNegative = !alarmStart.isNegative;</span>
<a href="#l65.144"></a><span id="l65.144">         }</span>
<a href="#l65.145"></a><span id="l65.145">         return alarmStart;</span>
<a href="#l65.146"></a><span id="l65.146">     },</span>
<a href="#l65.147"></a><span id="l65.147"> </span>
<a href="#l65.148"></a><span id="l65.148">     getDefaultAlarmEmails: function(out_count) {</span>
<a href="#l65.149"></a><span id="l65.149">         let ret = [];</span>
<a href="#l65.150"></a><span id="l65.150" class="difflineminus">-        let ar = this.getUserPreferences(&quot;X-NSCP-WCAP-PREF-ceDefaultAlarmEmail&quot;);</span>
<a href="#l65.151"></a><span id="l65.151" class="difflineminus">-        if (ar.length &gt; 0 &amp;&amp; ar[0].length &gt; 0) {</span>
<a href="#l65.152"></a><span id="l65.152" class="difflineminus">-            for (let i of ar) {</span>
<a href="#l65.153"></a><span id="l65.153" class="difflineminus">-                ret = ret.concat(i.split(/[;,]/).map(String.trim));</span>
<a href="#l65.154"></a><span id="l65.154" class="difflineplus">+        let alarmEmails = this.getUserPreferences(&quot;X-NSCP-WCAP-PREF-ceDefaultAlarmEmail&quot;);</span>
<a href="#l65.155"></a><span id="l65.155" class="difflineplus">+        if (alarmEmails.length &gt; 0 &amp;&amp; alarmEmails[0].length &gt; 0) {</span>
<a href="#l65.156"></a><span id="l65.156" class="difflineplus">+            for (let email of alarmEmails) {</span>
<a href="#l65.157"></a><span id="l65.157" class="difflineplus">+                ret = ret.concat(email.split(/[;,]/).map(String.trim));</span>
<a href="#l65.158"></a><span id="l65.158">             }</span>
<a href="#l65.159"></a><span id="l65.159">         }</span>
<a href="#l65.160"></a><span id="l65.160">         out_count.value = ret.length;</span>
<a href="#l65.161"></a><span id="l65.161">         return ret;</span>
<a href="#l65.162"></a><span id="l65.162">     },</span>
<a href="#l65.163"></a><span id="l65.163"> </span>
<a href="#l65.164"></a><span id="l65.164">     // calICalendarSearchProvider:</span>
<a href="#l65.165"></a><span id="l65.165">     searchForCalendars: function(searchString, hints, maxResults, listener) {</span>
<a href="#l65.166"></a><span id="l65.166" class="difflineat">@@ -881,19 +881,19 @@ calWcapSession.prototype = {</span>
<a href="#l65.167"></a><span id="l65.167">                     }</span>
<a href="#l65.168"></a><span id="l65.168">                     let xml = getDomParser().parseFromString(data, &quot;text/xml&quot;);</span>
<a href="#l65.169"></a><span id="l65.169">                     let ret = [];</span>
<a href="#l65.170"></a><span id="l65.170">                     let nodeList = xml.getElementsByTagName(&quot;iCal&quot;);</span>
<a href="#l65.171"></a><span id="l65.171">                     for (let i = 0; i &lt; nodeList.length; ++i) {</span>
<a href="#l65.172"></a><span id="l65.172">                         let node = nodeList.item(i);</span>
<a href="#l65.173"></a><span id="l65.173">                         try {</span>
<a href="#l65.174"></a><span id="l65.174">                             checkWcapXmlErrno(node);</span>
<a href="#l65.175"></a><span id="l65.175" class="difflineminus">-                            let ar = filterXmlNodes(&quot;X-NSCP-CALPROPS-RELATIVE-CALID&quot;, node);</span>
<a href="#l65.176"></a><span id="l65.176" class="difflineminus">-                            if (ar.length &gt; 0) {</span>
<a href="#l65.177"></a><span id="l65.177" class="difflineminus">-                                let calId = ar[0];</span>
<a href="#l65.178"></a><span id="l65.178" class="difflineplus">+                            let calIdNodes = filterXmlNodes(&quot;X-NSCP-CALPROPS-RELATIVE-CALID&quot;, node);</span>
<a href="#l65.179"></a><span id="l65.179" class="difflineplus">+                            if (calIdNodes.length &gt; 0) {</span>
<a href="#l65.180"></a><span id="l65.180" class="difflineplus">+                                let calId = calIdNodes[0];</span>
<a href="#l65.181"></a><span id="l65.181">                                 let calendar = registeredCalendars[calId];</span>
<a href="#l65.182"></a><span id="l65.182">                                 if (calendar) {</span>
<a href="#l65.183"></a><span id="l65.183">                                     calendar.m_calProps = node; // update calprops</span>
<a href="#l65.184"></a><span id="l65.184">                                 } else {</span>
<a href="#l65.185"></a><span id="l65.185">                                     calendar = new calWcapCalendar(this, node);</span>
<a href="#l65.186"></a><span id="l65.186">                                     let uri = this.uri.clone();</span>
<a href="#l65.187"></a><span id="l65.187">                                     uri.path += &quot;?calid=&quot; + encodeURIComponent(calId);</span>
<a href="#l65.188"></a><span id="l65.188">                                     calendar.uri = uri;</span>
<a href="#l65.189"></a><span id="l65.189" class="difflineat">@@ -1092,18 +1092,18 @@ calWcapSession.prototype = {</span>
<a href="#l65.190"></a><span id="l65.190"> };</span>
<a href="#l65.191"></a><span id="l65.191"> </span>
<a href="#l65.192"></a><span id="l65.192"> function confirmInsecureLogin(uri) {</span>
<a href="#l65.193"></a><span id="l65.193">     if (!confirmInsecureLogin.m_confirmedHttpLogins) {</span>
<a href="#l65.194"></a><span id="l65.194">         confirmInsecureLogin.m_confirmedHttpLogins = {};</span>
<a href="#l65.195"></a><span id="l65.195">         let confirmedHttpLogins = getPref(&quot;calendar.wcap.confirmed_http_logins&quot;, &quot;&quot;);</span>
<a href="#l65.196"></a><span id="l65.196">         let tuples = confirmedHttpLogins.split(&quot;,&quot;);</span>
<a href="#l65.197"></a><span id="l65.197">         for (let tuple of tuples) {</span>
<a href="#l65.198"></a><span id="l65.198" class="difflineminus">-            let ar = tuple.split(&quot;:&quot;);</span>
<a href="#l65.199"></a><span id="l65.199" class="difflineminus">-            confirmInsecureLogin.m_confirmedHttpLogins[ar[0]] = ar[1];</span>
<a href="#l65.200"></a><span id="l65.200" class="difflineplus">+            let part = tuple.split(&quot;:&quot;);</span>
<a href="#l65.201"></a><span id="l65.201" class="difflineplus">+            confirmInsecureLogin.m_confirmedHttpLogins[part[0]] = part[1];</span>
<a href="#l65.202"></a><span id="l65.202">         }</span>
<a href="#l65.203"></a><span id="l65.203">     }</span>
<a href="#l65.204"></a><span id="l65.204"> </span>
<a href="#l65.205"></a><span id="l65.205">     let bConfirmed = false;</span>
<a href="#l65.206"></a><span id="l65.206"> </span>
<a href="#l65.207"></a><span id="l65.207">     let host = uri.hostPort;</span>
<a href="#l65.208"></a><span id="l65.208">     let encodedHost = encodeURIComponent(host);</span>
<a href="#l65.209"></a><span id="l65.209">     let confirmedEntry = confirmInsecureLogin.m_confirmedHttpLogins[encodedHost];</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l66.1"></a><span id="l66.1" class="difflineminus">--- a/calendar/providers/wcap/calWcapUtils.js</span>
<a href="#l66.2"></a><span id="l66.2" class="difflineplus">+++ b/calendar/providers/wcap/calWcapUtils.js</span>
<a href="#l66.3"></a><span id="l66.3" class="difflineat">@@ -178,37 +178,37 @@ function filterXmlNodes(name, rootNode) </span>
<a href="#l66.4"></a><span id="l66.4"> </span>
<a href="#l66.5"></a><span id="l66.5"> function getTime() {</span>
<a href="#l66.6"></a><span id="l66.6">     if (g_bShutdown) {</span>
<a href="#l66.7"></a><span id="l66.7">         return null;</span>
<a href="#l66.8"></a><span id="l66.8">     }</span>
<a href="#l66.9"></a><span id="l66.9">     return cal.jsDateToDateTime(new Date());</span>
<a href="#l66.10"></a><span id="l66.10"> }</span>
<a href="#l66.11"></a><span id="l66.11"> </span>
<a href="#l66.12"></a><span id="l66.12" class="difflineminus">-function getIcalUTC(dt) {</span>
<a href="#l66.13"></a><span id="l66.13" class="difflineminus">-    if (!dt || !dt.isValid) {</span>
<a href="#l66.14"></a><span id="l66.14" class="difflineplus">+function getIcalUTC(date) {</span>
<a href="#l66.15"></a><span id="l66.15" class="difflineplus">+    if (!date || !date.isValid) {</span>
<a href="#l66.16"></a><span id="l66.16">         return &quot;0&quot;;</span>
<a href="#l66.17"></a><span id="l66.17">     } else {</span>
<a href="#l66.18"></a><span id="l66.18" class="difflineminus">-        let dtz = dt.timezone;</span>
<a href="#l66.19"></a><span id="l66.19" class="difflineplus">+        let dtz = date.timezone;</span>
<a href="#l66.20"></a><span id="l66.20">         if (dtz.isUTC || dtz.isFloating) {</span>
<a href="#l66.21"></a><span id="l66.21" class="difflineminus">-            return dt.icalString;</span>
<a href="#l66.22"></a><span id="l66.22" class="difflineplus">+            return date.icalString;</span>
<a href="#l66.23"></a><span id="l66.23">         } else {</span>
<a href="#l66.24"></a><span id="l66.24" class="difflineminus">-            return dt.getInTimezone(UTC()).icalString;</span>
<a href="#l66.25"></a><span id="l66.25" class="difflineplus">+            return date.getInTimezone(UTC()).icalString;</span>
<a href="#l66.26"></a><span id="l66.26">         }</span>
<a href="#l66.27"></a><span id="l66.27">     }</span>
<a href="#l66.28"></a><span id="l66.28"> }</span>
<a href="#l66.29"></a><span id="l66.29"> </span>
<a href="#l66.30"></a><span id="l66.30"> function getDatetimeFromIcalString(val) {</span>
<a href="#l66.31"></a><span id="l66.31">     if (!val || val.length == 0 || val == &quot;0&quot;) {</span>
<a href="#l66.32"></a><span id="l66.32">         return null;</span>
<a href="#l66.33"></a><span id="l66.33">     }</span>
<a href="#l66.34"></a><span id="l66.34">     // assuming timezone is known:</span>
<a href="#l66.35"></a><span id="l66.35" class="difflineminus">-    let dt = createDateTime();</span>
<a href="#l66.36"></a><span id="l66.36" class="difflineminus">-    dt.icalString = val;</span>
<a href="#l66.37"></a><span id="l66.37" class="difflineminus">-    return dt;</span>
<a href="#l66.38"></a><span id="l66.38" class="difflineplus">+    let date = createDateTime();</span>
<a href="#l66.39"></a><span id="l66.39" class="difflineplus">+    date.icalString = val;</span>
<a href="#l66.40"></a><span id="l66.40" class="difflineplus">+    return date;</span>
<a href="#l66.41"></a><span id="l66.41"> }</span>
<a href="#l66.42"></a><span id="l66.42"> </span>
<a href="#l66.43"></a><span id="l66.43"> function getDatetimeFromIcalProp(prop) {</span>
<a href="#l66.44"></a><span id="l66.44">     if (!prop) {</span>
<a href="#l66.45"></a><span id="l66.45">         return null;</span>
<a href="#l66.46"></a><span id="l66.46">     }</span>
<a href="#l66.47"></a><span id="l66.47">     return getDatetimeFromIcalString(prop.valueAsIcalString);</span>
<a href="#l66.48"></a><span id="l66.48"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l67.1"></a><span id="l67.1" class="difflineminus">--- a/calendar/resources/content/calendarCreation.js</span>
<a href="#l67.2"></a><span id="l67.2" class="difflineplus">+++ b/calendar/resources/content/calendarCreation.js</span>
<a href="#l67.3"></a><span id="l67.3" class="difflineat">@@ -225,17 +225,17 @@ function parseUri(aUri) {</span>
<a href="#l67.4"></a><span id="l67.4">         uri = makeURL(aUri);</span>
<a href="#l67.5"></a><span id="l67.5">     } catch (ex) {</span>
<a href="#l67.6"></a><span id="l67.6">         return [errorConstants.INVALID_URI, null];</span>
<a href="#l67.7"></a><span id="l67.7">     }</span>
<a href="#l67.8"></a><span id="l67.8"> </span>
<a href="#l67.9"></a><span id="l67.9">     let calManager = cal.getCalendarManager();</span>
<a href="#l67.10"></a><span id="l67.10">     let cals = calManager.getCalendars({});</span>
<a href="#l67.11"></a><span id="l67.11">     let type = document.getElementById(&quot;calendar-type&quot;).selectedItem.value;</span>
<a href="#l67.12"></a><span id="l67.12" class="difflineminus">-    if (type != &quot;local&quot; &amp;&amp; cals.some(c =&gt; c.uri.spec == uri.spec)) {</span>
<a href="#l67.13"></a><span id="l67.13" class="difflineplus">+    if (type != &quot;local&quot; &amp;&amp; cals.some(calendar =&gt; calendar.uri.spec == uri.spec)) {</span>
<a href="#l67.14"></a><span id="l67.14">         // If the calendar is not local, we check if there is already a calendar</span>
<a href="#l67.15"></a><span id="l67.15">         // with the same uri spec. Storage calendars all have the same uri, so</span>
<a href="#l67.16"></a><span id="l67.16">         // we have to specialcase them.</span>
<a href="#l67.17"></a><span id="l67.17">         return [errorConstants.ALREADY_EXISTS, null];</span>
<a href="#l67.18"></a><span id="l67.18">     }</span>
<a href="#l67.19"></a><span id="l67.19"> </span>
<a href="#l67.20"></a><span id="l67.20">     return [errorConstants.SUCCESS, uri];</span>
<a href="#l67.21"></a><span id="l67.21"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l68.1"></a><span id="l68.1" class="difflineminus">--- a/calendar/resources/content/datetimepickers/datetimepickers.xml</span>
<a href="#l68.2"></a><span id="l68.2" class="difflineplus">+++ b/calendar/resources/content/datetimepickers/datetimepickers.xml</span>
<a href="#l68.3"></a><span id="l68.3" class="difflineat">@@ -1630,19 +1630,19 @@</span>
<a href="#l68.4"></a><span id="l68.4">               // regexp derived from the Alphabetic ranges in</span>
<a href="#l68.5"></a><span id="l68.5">               // http://www.unicode.org/Public/UNIDATA/DerivedCoreProperties.txt)</span>
<a href="#l68.6"></a><span id="l68.6">               // (.*)? binds to null if no suffix.</span>
<a href="#l68.7"></a><span id="l68.7">               let parseAlphShortDateRegex = /^\s*(\d+|[^\d\W]+)\W{0,2}(\d+|[^\d\W]+)\W{0,2}(\d+|[^\d\W]+)(.*)?$/;</span>
<a href="#l68.8"></a><span id="l68.8">               let datePartsArray = parseAlphShortDateRegex.exec(aValue);</span>
<a href="#l68.9"></a><span id="l68.9">               if (datePartsArray != null) {</span>
<a href="#l68.10"></a><span id="l68.10">                 year = Number(datePartsArray[this.yearIndex]);</span>
<a href="#l68.11"></a><span id="l68.11">                 let monthString = datePartsArray[this.monthIndex].toUpperCase();</span>
<a href="#l68.12"></a><span id="l68.12" class="difflineminus">-                for (let m = 0; m &lt; this.alphaMonths.length; m++) {</span>
<a href="#l68.13"></a><span id="l68.13" class="difflineminus">-                  if (monthString == this.alphaMonths[m]) {</span>
<a href="#l68.14"></a><span id="l68.14" class="difflineminus">-                    month = m;</span>
<a href="#l68.15"></a><span id="l68.15" class="difflineplus">+                for (let monthIdx = 0; monthIdx &lt; this.alphaMonths.length; monthIdx++) {</span>
<a href="#l68.16"></a><span id="l68.16" class="difflineplus">+                  if (monthString == this.alphaMonths[monthIdx]) {</span>
<a href="#l68.17"></a><span id="l68.17" class="difflineplus">+                    month = monthIdx;</span>
<a href="#l68.18"></a><span id="l68.18">                     break;</span>
<a href="#l68.19"></a><span id="l68.19">                   }</span>
<a href="#l68.20"></a><span id="l68.20">                 }</span>
<a href="#l68.21"></a><span id="l68.21">                 day = Number(datePartsArray[this.dayIndex]);</span>
<a href="#l68.22"></a><span id="l68.22">                 timeString = datePartsArray[4];</span>
<a href="#l68.23"></a><span id="l68.23">               }</span>
<a href="#l68.24"></a><span id="l68.24">             }</span>
<a href="#l68.25"></a><span id="l68.25">             if (year != Number.MIN_VALUE &amp;&amp; month != -1 &amp;&amp; day != -1) {</span>
<a href="#l68.26"></a><span id="l68.26" class="difflineat">@@ -1829,22 +1829,22 @@</span>
<a href="#l68.27"></a><span id="l68.27">                     case 4: this.dayIndex = j; break;</span>
<a href="#l68.28"></a><span id="l68.28">                     default: this.monthIndex = j; break;</span>
<a href="#l68.29"></a><span id="l68.29">                   }</span>
<a href="#l68.30"></a><span id="l68.30">                 }</span>
<a href="#l68.31"></a><span id="l68.31">                 if (this.yearIndex != -1 &amp;&amp; this.dayIndex != -1 &amp;&amp; this.monthIndex != -1) {</span>
<a href="#l68.32"></a><span id="l68.32">                   this.probeSucceeded = true;</span>
<a href="#l68.33"></a><span id="l68.33">                   // Fill this.alphaMonths with month names.</span>
<a href="#l68.34"></a><span id="l68.34">                   this.alphaMonths = new Array(12);</span>
<a href="#l68.35"></a><span id="l68.35" class="difflineminus">-                  for (let m = 0; m &lt; 12; m++) {</span>
<a href="#l68.36"></a><span id="l68.36" class="difflineminus">-                    probeDate.setMonth(m);</span>
<a href="#l68.37"></a><span id="l68.37" class="difflineplus">+                  for (let monthIdx = 0; monthIdx &lt; 12; monthIdx++) {</span>
<a href="#l68.38"></a><span id="l68.38" class="difflineplus">+                    probeDate.setMonth(monthIdx);</span>
<a href="#l68.39"></a><span id="l68.39">                     probeString = this.formatDate(probeDate);</span>
<a href="#l68.40"></a><span id="l68.40">                     probeArray = this.parseShortDateRegex.exec(probeString);</span>
<a href="#l68.41"></a><span id="l68.41">                     if (probeArray) {</span>
<a href="#l68.42"></a><span id="l68.42" class="difflineminus">-                      this.alphaMonths[m] = probeArray[this.monthIndex].toUpperCase();</span>
<a href="#l68.43"></a><span id="l68.43" class="difflineplus">+                      this.alphaMonths[monthIdx] = probeArray[this.monthIndex].toUpperCase();</span>
<a href="#l68.44"></a><span id="l68.44">                     } else {</span>
<a href="#l68.45"></a><span id="l68.45">                       this.probeSucceeded = false;</span>
<a href="#l68.46"></a><span id="l68.46">                     }</span>
<a href="#l68.47"></a><span id="l68.47">                   }</span>
<a href="#l68.48"></a><span id="l68.48">                 }</span>
<a href="#l68.49"></a><span id="l68.49">               }</span>
<a href="#l68.50"></a><span id="l68.50">             }</span>
<a href="#l68.51"></a><span id="l68.51">             if (!this.probeSucceeded) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l69.1"></a><span id="l69.1" class="difflineminus">--- a/calendar/test/mozmill/eventDialog/testEventDialog.js</span>
<a href="#l69.2"></a><span id="l69.2" class="difflineplus">+++ b/calendar/test/mozmill/eventDialog/testEventDialog.js</span>
<a href="#l69.3"></a><span id="l69.3" class="difflineat">@@ -113,18 +113,18 @@ var testEventDialog = function() {</span>
<a href="#l69.4"></a><span id="l69.4"> </span>
<a href="#l69.5"></a><span id="l69.5">   // repeat daily</span>
<a href="#l69.6"></a><span id="l69.6">   event.click(new elementslib.ID(event.window.document, &quot;repeat-daily-menuitem&quot;));</span>
<a href="#l69.7"></a><span id="l69.7"> </span>
<a href="#l69.8"></a><span id="l69.8">   // add reminder</span>
<a href="#l69.9"></a><span id="l69.9">   event.click(new elementslib.ID(event.window.document, &quot;reminder-5minutes-menuitem&quot;));</span>
<a href="#l69.10"></a><span id="l69.10"> </span>
<a href="#l69.11"></a><span id="l69.11">   // add an attendee and verify added</span>
<a href="#l69.12"></a><span id="l69.12" class="difflineminus">-  let md = new modalDialog.modalDialog(event.window);</span>
<a href="#l69.13"></a><span id="l69.13" class="difflineminus">-  md.start(handleAttendees);</span>
<a href="#l69.14"></a><span id="l69.14" class="difflineplus">+  let dialog = new modalDialog.modalDialog(event.window);</span>
<a href="#l69.15"></a><span id="l69.15" class="difflineplus">+  dialog.start(handleAttendees);</span>
<a href="#l69.16"></a><span id="l69.16">   event.click(new elementslib.ID(event.window.document, &quot;button-attendees&quot;));</span>
<a href="#l69.17"></a><span id="l69.17">   event.assertValue(new elementslib.ID(event.window.document, &quot;attendee-list&quot;),</span>
<a href="#l69.18"></a><span id="l69.18">     attendee);</span>
<a href="#l69.19"></a><span id="l69.19"> </span>
<a href="#l69.20"></a><span id="l69.20">   // make it private and verify label visible</span>
<a href="#l69.21"></a><span id="l69.21">   event.click(new elementslib.ID(event.window.document, &quot;button-privacy&quot;));</span>
<a href="#l69.22"></a><span id="l69.22">   event.click(new elementslib.ID(event.window.document, &quot;event-privacy-private-menuitem&quot;));</span>
<a href="#l69.23"></a><span id="l69.23">   let label = new elementslib.ID(event.window.document, &quot;status-privacy-private-box&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l70.1"></a><span id="l70.1" class="difflineminus">--- a/calendar/test/mozmill/eventDialog/testEventDialogModificationPrompt.js</span>
<a href="#l70.2"></a><span id="l70.2" class="difflineplus">+++ b/calendar/test/mozmill/eventDialog/testEventDialogModificationPrompt.js</span>
<a href="#l70.3"></a><span id="l70.3" class="difflineat">@@ -87,46 +87,46 @@ var testEventDialogModificationPrompt = </span>
<a href="#l70.4"></a><span id="l70.4">     '/{&quot;tooltip&quot;:&quot;itemTooltip&quot;}');</span>
<a href="#l70.5"></a><span id="l70.5">   controller.waitForElement(eventBox);</span>
<a href="#l70.6"></a><span id="l70.6">   controller.doubleClick(eventBox);</span>
<a href="#l70.7"></a><span id="l70.7">   controller.waitFor(() =&gt; mozmill.utils.getWindows(&quot;Calendar:EventDialog&quot;).length &gt; 0, sleep);</span>
<a href="#l70.8"></a><span id="l70.8">   event = new mozmill.controller.MozMillController(mozmill.utils</span>
<a href="#l70.9"></a><span id="l70.9">     .getWindows(&quot;Calendar:EventDialog&quot;)[0]);</span>
<a href="#l70.10"></a><span id="l70.10"> </span>
<a href="#l70.11"></a><span id="l70.11">   // modal dialog setup</span>
<a href="#l70.12"></a><span id="l70.12" class="difflineminus">-  let md = new modalDialog.modalDialog(event.window);</span>
<a href="#l70.13"></a><span id="l70.13" class="difflineminus">-  md.start(handleSavePrompt);</span>
<a href="#l70.14"></a><span id="l70.14" class="difflineplus">+  let dialog = new modalDialog.modalDialog(event.window);</span>
<a href="#l70.15"></a><span id="l70.15" class="difflineplus">+  dialog.start(handleSavePrompt);</span>
<a href="#l70.16"></a><span id="l70.16"> </span>
<a href="#l70.17"></a><span id="l70.17">   // escape the event window, there should be no prompt to save event</span>
<a href="#l70.18"></a><span id="l70.18">   event.keypress(undefined, &quot;VK_ESCAPE&quot;, {});</span>
<a href="#l70.19"></a><span id="l70.19">   controller.sleep(sleep);</span>
<a href="#l70.20"></a><span id="l70.20" class="difflineminus">-  md.stop();</span>
<a href="#l70.21"></a><span id="l70.21" class="difflineplus">+  dialog.stop();</span>
<a href="#l70.22"></a><span id="l70.22"> </span>
<a href="#l70.23"></a><span id="l70.23">   // open</span>
<a href="#l70.24"></a><span id="l70.24">   controller.doubleClick(new elementslib.Lookup(controller.window.document,</span>
<a href="#l70.25"></a><span id="l70.25">     calUtils.getEventBoxPath(controller, &quot;day&quot;, calUtils.EVENT_BOX, undefined, 1, 8) +</span>
<a href="#l70.26"></a><span id="l70.26">     '/{&quot;tooltip&quot;:&quot;itemTooltip&quot;}'));</span>
<a href="#l70.27"></a><span id="l70.27">   controller.waitFor(() =&gt; mozmill.utils.getWindows(&quot;Calendar:EventDialog&quot;).length &gt; 0, sleep);</span>
<a href="#l70.28"></a><span id="l70.28">   event = new mozmill.controller.MozMillController(mozmill.utils</span>
<a href="#l70.29"></a><span id="l70.29">     .getWindows(&quot;Calendar:EventDialog&quot;)[0]);</span>
<a href="#l70.30"></a><span id="l70.30"> </span>
<a href="#l70.31"></a><span id="l70.31">   // change all values</span>
<a href="#l70.32"></a><span id="l70.32">   calUtils.setData(event, data[1]);</span>
<a href="#l70.33"></a><span id="l70.33"> </span>
<a href="#l70.34"></a><span id="l70.34">   // edit all values back to original</span>
<a href="#l70.35"></a><span id="l70.35">   calUtils.setData(event, data[0]);</span>
<a href="#l70.36"></a><span id="l70.36"> </span>
<a href="#l70.37"></a><span id="l70.37">   // this is set up after data entry because otherwise it tries to handle attachment dialog</span>
<a href="#l70.38"></a><span id="l70.38" class="difflineminus">-  md = new modalDialog.modalDialog(event.window);</span>
<a href="#l70.39"></a><span id="l70.39" class="difflineminus">-  md.start(handleSavePrompt);</span>
<a href="#l70.40"></a><span id="l70.40" class="difflineplus">+  dialog = new modalDialog.modalDialog(event.window);</span>
<a href="#l70.41"></a><span id="l70.41" class="difflineplus">+  dialog.start(handleSavePrompt);</span>
<a href="#l70.42"></a><span id="l70.42"> </span>
<a href="#l70.43"></a><span id="l70.43">   // escape the event window, there should be no prompt to save event</span>
<a href="#l70.44"></a><span id="l70.44">   event.keypress(undefined, &quot;VK_ESCAPE&quot;, {});</span>
<a href="#l70.45"></a><span id="l70.45">   controller.sleep(sleep);</span>
<a href="#l70.46"></a><span id="l70.46" class="difflineminus">-  md.stop();</span>
<a href="#l70.47"></a><span id="l70.47" class="difflineplus">+  dialog.stop();</span>
<a href="#l70.48"></a><span id="l70.48"> </span>
<a href="#l70.49"></a><span id="l70.49">   // delete event</span>
<a href="#l70.50"></a><span id="l70.50">   controller.click(new elementslib.Lookup(controller.window.document,</span>
<a href="#l70.51"></a><span id="l70.51">     calUtils.getEventBoxPath(controller, &quot;day&quot;, calUtils.EVENT_BOX, undefined, 1, 8)));</span>
<a href="#l70.52"></a><span id="l70.52">   controller.keypress(new elementslib.ID(controller.window.document, &quot;day-view&quot;),</span>
<a href="#l70.53"></a><span id="l70.53">     &quot;VK_DELETE&quot;, {});</span>
<a href="#l70.54"></a><span id="l70.54">   controller.waitForElementNotPresent(new elementslib.Lookup(controller.window.document,</span>
<a href="#l70.55"></a><span id="l70.55">     calUtils.getEventBoxPath(controller, &quot;day&quot;, calUtils.EVENT_BOX, undefined, 1, 8)));</span>
<a href="#l70.56"></a><span id="l70.56" class="difflineat">@@ -145,21 +145,21 @@ var testEventDialogModificationPrompt = </span>
<a href="#l70.57"></a><span id="l70.57">     eventBox = new elementslib.Lookup(controller.window.document,</span>
<a href="#l70.58"></a><span id="l70.58">       calUtils.getEventBoxPath(controller, &quot;day&quot;, calUtils.EVENT_BOX, undefined, 1, 8) +</span>
<a href="#l70.59"></a><span id="l70.59">       '/{&quot;tooltip&quot;:&quot;itemTooltip&quot;}');</span>
<a href="#l70.60"></a><span id="l70.60">     controller.waitForElement(eventBox);</span>
<a href="#l70.61"></a><span id="l70.61">     controller.doubleClick(eventBox);</span>
<a href="#l70.62"></a><span id="l70.62">     controller.waitFor(() =&gt; mozmill.utils.getWindows(&quot;Calendar:EventDialog&quot;).length &gt; 0, sleep);</span>
<a href="#l70.63"></a><span id="l70.63">     event = new mozmill.controller.MozMillController(mozmill.utils</span>
<a href="#l70.64"></a><span id="l70.64">       .getWindows(&quot;Calendar:EventDialog&quot;)[0]);</span>
<a href="#l70.65"></a><span id="l70.65" class="difflineminus">-    md = new modalDialog.modalDialog(event.window);</span>
<a href="#l70.66"></a><span id="l70.66" class="difflineminus">-    md.start(handleSavePrompt);</span>
<a href="#l70.67"></a><span id="l70.67" class="difflineplus">+    dialog = new modalDialog.modalDialog(event.window);</span>
<a href="#l70.68"></a><span id="l70.68" class="difflineplus">+    dialog.start(handleSavePrompt);</span>
<a href="#l70.69"></a><span id="l70.69">     event.keypress(undefined, &quot;VK_ESCAPE&quot;, {});</span>
<a href="#l70.70"></a><span id="l70.70">     controller.sleep(sleep);</span>
<a href="#l70.71"></a><span id="l70.71" class="difflineminus">-    md.stop();</span>
<a href="#l70.72"></a><span id="l70.72" class="difflineplus">+    dialog.stop();</span>
<a href="#l70.73"></a><span id="l70.73"> </span>
<a href="#l70.74"></a><span id="l70.74">     // delete it</span>
<a href="#l70.75"></a><span id="l70.75">     // XXX somehow the event is selected at this point, this didn't use to be the case</span>
<a href="#l70.76"></a><span id="l70.76">     // and can't be reproduced manually</span>
<a href="#l70.77"></a><span id="l70.77">     controller.keypress(new elementslib.ID(controller.window.document, &quot;day-view&quot;),</span>
<a href="#l70.78"></a><span id="l70.78">       &quot;VK_DELETE&quot;, {});</span>
<a href="#l70.79"></a><span id="l70.79">     controller.waitForElementNotPresent(new elementslib.Lookup(controller.window.document,</span>
<a href="#l70.80"></a><span id="l70.80">       calUtils.getEventBoxPath(controller, &quot;day&quot;, calUtils.EVENT_BOX, undefined, 1, 8)));</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l71.1"></a><span id="l71.1" class="difflineminus">--- a/calendar/test/mozmill/recurrence/testLastDayOfMonthRecurrence.js</span>
<a href="#l71.2"></a><span id="l71.2" class="difflineplus">+++ b/calendar/test/mozmill/recurrence/testLastDayOfMonthRecurrence.js</span>
<a href="#l71.3"></a><span id="l71.3" class="difflineat">@@ -22,18 +22,18 @@ var testLastDayOfMonthRecurrence = funct</span>
<a href="#l71.4"></a><span id="l71.4"> </span>
<a href="#l71.5"></a><span id="l71.5">   // create monthly recurring event</span>
<a href="#l71.6"></a><span id="l71.6">   controller.doubleClick(new elementslib.Lookup(controller.window.document,</span>
<a href="#l71.7"></a><span id="l71.7">     calUtils.getEventBoxPath(controller, &quot;day&quot;, calUtils.CANVAS_BOX, undefined, 1, hour)), 1, 1);</span>
<a href="#l71.8"></a><span id="l71.8">   controller.waitFor(() =&gt; mozmill.utils.getWindows(&quot;Calendar:EventDialog&quot;).length &gt; 0, sleep);</span>
<a href="#l71.9"></a><span id="l71.9">   let event = new mozmill.controller.MozMillController(mozmill.utils</span>
<a href="#l71.10"></a><span id="l71.10">     .getWindows(&quot;Calendar:EventDialog&quot;)[0]);</span>
<a href="#l71.11"></a><span id="l71.11"> </span>
<a href="#l71.12"></a><span id="l71.12" class="difflineminus">-  let md = new modalDialog.modalDialog(event.window);</span>
<a href="#l71.13"></a><span id="l71.13" class="difflineminus">-  md.start(setRecurrence);</span>
<a href="#l71.14"></a><span id="l71.14" class="difflineplus">+  let dialog = new modalDialog.modalDialog(event.window);</span>
<a href="#l71.15"></a><span id="l71.15" class="difflineplus">+  dialog.start(setRecurrence);</span>
<a href="#l71.16"></a><span id="l71.16">   event.waitForElement(new elementslib.ID(event.window.document, &quot;item-repeat&quot;));</span>
<a href="#l71.17"></a><span id="l71.17">   event.select(new elementslib.ID(event.window.document, &quot;item-repeat&quot;), undefined, undefined,</span>
<a href="#l71.18"></a><span id="l71.18">     &quot;custom&quot;);</span>
<a href="#l71.19"></a><span id="l71.19"> </span>
<a href="#l71.20"></a><span id="l71.20">   event.click(new elementslib.ID(event.window.document, &quot;button-save&quot;));</span>
<a href="#l71.21"></a><span id="l71.21">   controller.waitFor(() =&gt; mozmill.utils.getWindows(&quot;Calendar:EventDialog&quot;).length == 0);</span>
<a href="#l71.22"></a><span id="l71.22"> </span>
<a href="#l71.23"></a><span id="l71.23">   //                        date     correct row in month view</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l72.1"></a><span id="l72.1" class="difflineminus">--- a/calendar/test/mozmill/recurrence/testWeeklyNRecurrence.js</span>
<a href="#l72.2"></a><span id="l72.2" class="difflineplus">+++ b/calendar/test/mozmill/recurrence/testWeeklyNRecurrence.js</span>
<a href="#l72.3"></a><span id="l72.3" class="difflineat">@@ -22,18 +22,18 @@ var testWeeklyNRecurrence = function() {</span>
<a href="#l72.4"></a><span id="l72.4">   calUtils.goToDate(controller, 2009, 1, 5);</span>
<a href="#l72.5"></a><span id="l72.5"> </span>
<a href="#l72.6"></a><span id="l72.6">   // create weekly recurring event</span>
<a href="#l72.7"></a><span id="l72.7">   controller.doubleClick(new elementslib.Lookup(controller.window.document,</span>
<a href="#l72.8"></a><span id="l72.8">     calUtils.getEventBoxPath(controller, &quot;day&quot;, calUtils.CANVAS_BOX, undefined, 1, hour)), 1, 1);</span>
<a href="#l72.9"></a><span id="l72.9">   controller.waitFor(() =&gt; mozmill.utils.getWindows(&quot;Calendar:EventDialog&quot;).length &gt; 0, sleep);</span>
<a href="#l72.10"></a><span id="l72.10">   let event = new mozmill.controller.MozMillController(mozmill.utils.getWindows(&quot;Calendar:EventDialog&quot;)[0]);</span>
<a href="#l72.11"></a><span id="l72.11"> </span>
<a href="#l72.12"></a><span id="l72.12" class="difflineminus">-  let md = new modalDialog.modalDialog(event.window);</span>
<a href="#l72.13"></a><span id="l72.13" class="difflineminus">-  md.start(setRecurrence);</span>
<a href="#l72.14"></a><span id="l72.14" class="difflineplus">+  let dialog = new modalDialog.modalDialog(event.window);</span>
<a href="#l72.15"></a><span id="l72.15" class="difflineplus">+  dialog.start(setRecurrence);</span>
<a href="#l72.16"></a><span id="l72.16">   event.waitForElement(new elementslib.ID(event.window.document, &quot;item-repeat&quot;));</span>
<a href="#l72.17"></a><span id="l72.17">   event.select(new elementslib.ID(event.window.document, &quot;item-repeat&quot;), undefined, undefined, &quot;custom&quot;);</span>
<a href="#l72.18"></a><span id="l72.18"> </span>
<a href="#l72.19"></a><span id="l72.19">   event.click(new elementslib.ID(event.window.document, &quot;button-save&quot;));</span>
<a href="#l72.20"></a><span id="l72.20"> </span>
<a href="#l72.21"></a><span id="l72.21">   // check day view</span>
<a href="#l72.22"></a><span id="l72.22">   let box = calUtils.getEventBoxPath(controller, &quot;day&quot;, calUtils.EVENT_BOX, undefined, 1, hour) +</span>
<a href="#l72.23"></a><span id="l72.23">     eventPath;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l73.1"></a><span id="l73.1" class="difflineminus">--- a/calendar/test/mozmill/recurrence/testWeeklyUntilRecurrence.js</span>
<a href="#l73.2"></a><span id="l73.2" class="difflineplus">+++ b/calendar/test/mozmill/recurrence/testWeeklyUntilRecurrence.js</span>
<a href="#l73.3"></a><span id="l73.3" class="difflineat">@@ -24,18 +24,18 @@ var testWeeklyUntilRecurrence = function</span>
<a href="#l73.4"></a><span id="l73.4">   calUtils.goToDate(controller, 2009, 1, 5); // Monday</span>
<a href="#l73.5"></a><span id="l73.5"> </span>
<a href="#l73.6"></a><span id="l73.6">   // create weekly recurring event</span>
<a href="#l73.7"></a><span id="l73.7">   controller.doubleClick(new elementslib.Lookup(controller.window.document,</span>
<a href="#l73.8"></a><span id="l73.8">     calUtils.getEventBoxPath(controller, &quot;day&quot;, calUtils.CANVAS_BOX, undefined, 1, hour)), 1, 1);</span>
<a href="#l73.9"></a><span id="l73.9">   controller.waitFor(() =&gt; mozmill.utils.getWindows(&quot;Calendar:EventDialog&quot;).length &gt; 0, sleep);</span>
<a href="#l73.10"></a><span id="l73.10">   let event = new mozmill.controller.MozMillController(mozmill.utils.getWindows(&quot;Calendar:EventDialog&quot;)[0]);</span>
<a href="#l73.11"></a><span id="l73.11"> </span>
<a href="#l73.12"></a><span id="l73.12" class="difflineminus">-  let md = new modalDialog.modalDialog(event.window);</span>
<a href="#l73.13"></a><span id="l73.13" class="difflineminus">-  md.start(setRecurrence);</span>
<a href="#l73.14"></a><span id="l73.14" class="difflineplus">+  let dialog = new modalDialog.modalDialog(event.window);</span>
<a href="#l73.15"></a><span id="l73.15" class="difflineplus">+  dialog.start(setRecurrence);</span>
<a href="#l73.16"></a><span id="l73.16">   event.waitForElement(new elementslib.ID(event.window.document, &quot;item-repeat&quot;));</span>
<a href="#l73.17"></a><span id="l73.17">   event.select(new elementslib.ID(event.window.document, &quot;item-repeat&quot;), undefined, undefined, &quot;custom&quot;);</span>
<a href="#l73.18"></a><span id="l73.18"> </span>
<a href="#l73.19"></a><span id="l73.19">   event.click(new elementslib.ID(event.window.document, &quot;button-save&quot;));</span>
<a href="#l73.20"></a><span id="l73.20">   controller.waitFor(() =&gt; mozmill.utils.getWindows(&quot;Calendar:EventDialog&quot;).length == 0);</span>
<a href="#l73.21"></a><span id="l73.21"> </span>
<a href="#l73.22"></a><span id="l73.22">   let box = calUtils.getEventBoxPath(controller, &quot;day&quot;, calUtils.EVENT_BOX, undefined, 1, hour) +</span>
<a href="#l73.23"></a><span id="l73.23">     eventPath;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l74.1"></a><span id="l74.1" class="difflineminus">--- a/calendar/test/mozmill/recurrence/testWeeklyWithExceptionRecurrence.js</span>
<a href="#l74.2"></a><span id="l74.2" class="difflineplus">+++ b/calendar/test/mozmill/recurrence/testWeeklyWithExceptionRecurrence.js</span>
<a href="#l74.3"></a><span id="l74.3" class="difflineat">@@ -23,18 +23,18 @@ var testWeeklyWithExceptionRecurrence = </span>
<a href="#l74.4"></a><span id="l74.4">   calUtils.goToDate(controller, 2009, 1, 5);</span>
<a href="#l74.5"></a><span id="l74.5"> </span>
<a href="#l74.6"></a><span id="l74.6">   // create weekly recurring event</span>
<a href="#l74.7"></a><span id="l74.7">   controller.doubleClick(new elementslib.Lookup(controller.window.document,</span>
<a href="#l74.8"></a><span id="l74.8">     calUtils.getEventBoxPath(controller, &quot;day&quot;, calUtils.CANVAS_BOX, undefined, 1, hour)), 1, 1);</span>
<a href="#l74.9"></a><span id="l74.9">   controller.waitFor(() =&gt; mozmill.utils.getWindows(&quot;Calendar:EventDialog&quot;).length &gt; 0, sleep);</span>
<a href="#l74.10"></a><span id="l74.10">   let event = new mozmill.controller.MozMillController(mozmill.utils.getWindows(&quot;Calendar:EventDialog&quot;)[0]);</span>
<a href="#l74.11"></a><span id="l74.11"> </span>
<a href="#l74.12"></a><span id="l74.12" class="difflineminus">-  let md = new modalDialog.modalDialog(event.window);</span>
<a href="#l74.13"></a><span id="l74.13" class="difflineminus">-  md.start(setRecurrence);</span>
<a href="#l74.14"></a><span id="l74.14" class="difflineplus">+  let dialog = new modalDialog.modalDialog(event.window);</span>
<a href="#l74.15"></a><span id="l74.15" class="difflineplus">+  dialog.start(setRecurrence);</span>
<a href="#l74.16"></a><span id="l74.16">   event.waitForElement(new elementslib.ID(event.window.document, &quot;item-repeat&quot;));</span>
<a href="#l74.17"></a><span id="l74.17">   event.select(new elementslib.ID(event.window.document, &quot;item-repeat&quot;), undefined, undefined, &quot;custom&quot;);</span>
<a href="#l74.18"></a><span id="l74.18"> </span>
<a href="#l74.19"></a><span id="l74.19">   event.click(new elementslib.ID(event.window.document, &quot;button-save&quot;));</span>
<a href="#l74.20"></a><span id="l74.20">   controller.waitFor(() =&gt; mozmill.utils.getWindows(&quot;Calendar:EventDialog&quot;).length == 0);</span>
<a href="#l74.21"></a><span id="l74.21"> </span>
<a href="#l74.22"></a><span id="l74.22">   // move 5th January occurrence to 6th January</span>
<a href="#l74.23"></a><span id="l74.23">   calUtils.handleOccurrenceModification(controller, false);</span>
<a href="#l74.24"></a><span id="l74.24" class="difflineat">@@ -74,18 +74,18 @@ var testWeeklyWithExceptionRecurrence = </span>
<a href="#l74.25"></a><span id="l74.25">   calUtils.goToDate(controller, 2009, 1, 7);</span>
<a href="#l74.26"></a><span id="l74.26">   calUtils.handleParentModification(controller, false);</span>
<a href="#l74.27"></a><span id="l74.27">   controller.doubleClick(new elementslib.Lookup(controller.window.document,</span>
<a href="#l74.28"></a><span id="l74.28">     calUtils.getEventBoxPath(controller, &quot;day&quot;, calUtils.EVENT_BOX, undefined, 1, hour) +</span>
<a href="#l74.29"></a><span id="l74.29">       eventPath));</span>
<a href="#l74.30"></a><span id="l74.30">   controller.waitFor(() =&gt; mozmill.utils.getWindows(&quot;Calendar:EventDialog&quot;).length &gt; 0, sleep);</span>
<a href="#l74.31"></a><span id="l74.31">   event = new mozmill.controller.MozMillController(mozmill.utils.getWindows(&quot;Calendar:EventDialog&quot;)[0]);</span>
<a href="#l74.32"></a><span id="l74.32"> </span>
<a href="#l74.33"></a><span id="l74.33" class="difflineminus">-  md = new modalDialog.modalDialog(event.window);</span>
<a href="#l74.34"></a><span id="l74.34" class="difflineminus">-  md.start(changeRecurrence);</span>
<a href="#l74.35"></a><span id="l74.35" class="difflineplus">+  dialog = new modalDialog.modalDialog(event.window);</span>
<a href="#l74.36"></a><span id="l74.36" class="difflineplus">+  dialog.start(changeRecurrence);</span>
<a href="#l74.37"></a><span id="l74.37">   event.waitForElement(new elementslib.ID(event.window.document, &quot;item-repeat&quot;));</span>
<a href="#l74.38"></a><span id="l74.38">   event.select(new elementslib.ID(event.window.document, &quot;item-repeat&quot;), undefined, undefined, &quot;custom&quot;);</span>
<a href="#l74.39"></a><span id="l74.39"> </span>
<a href="#l74.40"></a><span id="l74.40">   event.click(new elementslib.ID(event.window.document, &quot;button-save&quot;));</span>
<a href="#l74.41"></a><span id="l74.41">   controller.waitFor(() =&gt; mozmill.utils.getWindows(&quot;Calendar:EventDialog&quot;).length == 0);</span>
<a href="#l74.42"></a><span id="l74.42"> </span>
<a href="#l74.43"></a><span id="l74.43">   // check two weeks</span>
<a href="#l74.44"></a><span id="l74.44">   // day view</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l75.1"></a><span id="l75.1" class="difflineminus">--- a/calendar/test/mozmill/recurrenceRotated/testLastDayOfMonthRecurrence.js</span>
<a href="#l75.2"></a><span id="l75.2" class="difflineplus">+++ b/calendar/test/mozmill/recurrenceRotated/testLastDayOfMonthRecurrence.js</span>
<a href="#l75.3"></a><span id="l75.3" class="difflineat">@@ -29,18 +29,18 @@ var testLastDayOfMonthRecurrence = funct</span>
<a href="#l75.4"></a><span id="l75.4"> </span>
<a href="#l75.5"></a><span id="l75.5">   // create monthly recurring event</span>
<a href="#l75.6"></a><span id="l75.6">   controller.doubleClick(new elementslib.Lookup(controller.window.document,</span>
<a href="#l75.7"></a><span id="l75.7">     calUtils.getEventBoxPath(controller, &quot;day&quot;, calUtils.CANVAS_BOX, undefined, 1, hour)), 1, 1);</span>
<a href="#l75.8"></a><span id="l75.8">   controller.waitFor(() =&gt; mozmill.utils.getWindows(&quot;Calendar:EventDialog&quot;).length &gt; 0, sleep);</span>
<a href="#l75.9"></a><span id="l75.9">   let event = new mozmill.controller.MozMillController(mozmill.utils</span>
<a href="#l75.10"></a><span id="l75.10">     .getWindows(&quot;Calendar:EventDialog&quot;)[0]);</span>
<a href="#l75.11"></a><span id="l75.11"> </span>
<a href="#l75.12"></a><span id="l75.12" class="difflineminus">-  let md = new modalDialog.modalDialog(event.window);</span>
<a href="#l75.13"></a><span id="l75.13" class="difflineminus">-  md.start(setRecurrence);</span>
<a href="#l75.14"></a><span id="l75.14" class="difflineplus">+  let dialog = new modalDialog.modalDialog(event.window);</span>
<a href="#l75.15"></a><span id="l75.15" class="difflineplus">+  dialog.start(setRecurrence);</span>
<a href="#l75.16"></a><span id="l75.16">   event.waitForElement(new elementslib.ID(event.window.document, &quot;item-repeat&quot;));</span>
<a href="#l75.17"></a><span id="l75.17">   event.select(new elementslib.ID(event.window.document, &quot;item-repeat&quot;), undefined, undefined,</span>
<a href="#l75.18"></a><span id="l75.18">     &quot;custom&quot;);</span>
<a href="#l75.19"></a><span id="l75.19"> </span>
<a href="#l75.20"></a><span id="l75.20">   event.click(new elementslib.ID(event.window.document, &quot;button-save&quot;));</span>
<a href="#l75.21"></a><span id="l75.21">   controller.waitFor(() =&gt; mozmill.utils.getWindows(&quot;Calendar:EventDialog&quot;).length == 0);</span>
<a href="#l75.22"></a><span id="l75.22"> </span>
<a href="#l75.23"></a><span id="l75.23">   //                      date      correct row in month view</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l76.1"></a><span id="l76.1" class="difflineminus">--- a/calendar/test/mozmill/recurrenceRotated/testWeeklyNRecurrence.js</span>
<a href="#l76.2"></a><span id="l76.2" class="difflineplus">+++ b/calendar/test/mozmill/recurrenceRotated/testWeeklyNRecurrence.js</span>
<a href="#l76.3"></a><span id="l76.3" class="difflineat">@@ -29,18 +29,18 @@ var testWeeklyNRecurrence = function() {</span>
<a href="#l76.4"></a><span id="l76.4">   });</span>
<a href="#l76.5"></a><span id="l76.5"> </span>
<a href="#l76.6"></a><span id="l76.6">   // create weekly recurring event</span>
<a href="#l76.7"></a><span id="l76.7">   controller.doubleClick(new elementslib.Lookup(controller.window.document,</span>
<a href="#l76.8"></a><span id="l76.8">     calUtils.getEventBoxPath(controller, &quot;day&quot;, calUtils.CANVAS_BOX, undefined, 1, hour)), 1, 1);</span>
<a href="#l76.9"></a><span id="l76.9">   controller.waitFor(() =&gt; mozmill.utils.getWindows(&quot;Calendar:EventDialog&quot;).length &gt; 0, sleep);</span>
<a href="#l76.10"></a><span id="l76.10">   let event = new mozmill.controller.MozMillController(mozmill.utils.getWindows(&quot;Calendar:EventDialog&quot;)[0]);</span>
<a href="#l76.11"></a><span id="l76.11"> </span>
<a href="#l76.12"></a><span id="l76.12" class="difflineminus">-  let md = new modalDialog.modalDialog(event.window);</span>
<a href="#l76.13"></a><span id="l76.13" class="difflineminus">-  md.start(setRecurrence);</span>
<a href="#l76.14"></a><span id="l76.14" class="difflineplus">+  let dialog = new modalDialog.modalDialog(event.window);</span>
<a href="#l76.15"></a><span id="l76.15" class="difflineplus">+  dialog.start(setRecurrence);</span>
<a href="#l76.16"></a><span id="l76.16">   event.waitForElement(new elementslib.ID(event.window.document, &quot;item-repeat&quot;));</span>
<a href="#l76.17"></a><span id="l76.17">   event.select(new elementslib.ID(event.window.document, &quot;item-repeat&quot;), undefined, undefined, &quot;custom&quot;);</span>
<a href="#l76.18"></a><span id="l76.18"> </span>
<a href="#l76.19"></a><span id="l76.19">   event.click(new elementslib.ID(event.window.document, &quot;button-save&quot;));</span>
<a href="#l76.20"></a><span id="l76.20"> </span>
<a href="#l76.21"></a><span id="l76.21">   // check day view</span>
<a href="#l76.22"></a><span id="l76.22">   let box = calUtils.getEventBoxPath(controller, &quot;day&quot;, calUtils.EVENT_BOX, undefined, 1, hour) +</span>
<a href="#l76.23"></a><span id="l76.23">     eventPath;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l77.1"></a><span id="l77.1" class="difflineminus">--- a/calendar/test/mozmill/recurrenceRotated/testWeeklyUntilRecurrence.js</span>
<a href="#l77.2"></a><span id="l77.2" class="difflineplus">+++ b/calendar/test/mozmill/recurrenceRotated/testWeeklyUntilRecurrence.js</span>
<a href="#l77.3"></a><span id="l77.3" class="difflineat">@@ -30,18 +30,18 @@ var testWeeklyUntilRecurrence = function</span>
<a href="#l77.4"></a><span id="l77.4">   });</span>
<a href="#l77.5"></a><span id="l77.5"> </span>
<a href="#l77.6"></a><span id="l77.6">   // create weekly recurring event</span>
<a href="#l77.7"></a><span id="l77.7">   controller.doubleClick(new elementslib.Lookup(controller.window.document,</span>
<a href="#l77.8"></a><span id="l77.8">     calUtils.getEventBoxPath(controller, &quot;day&quot;, calUtils.CANVAS_BOX, undefined, 1, hour)), 1, 1);</span>
<a href="#l77.9"></a><span id="l77.9">   controller.waitFor(() =&gt; mozmill.utils.getWindows(&quot;Calendar:EventDialog&quot;).length &gt; 0, sleep);</span>
<a href="#l77.10"></a><span id="l77.10">   let event = new mozmill.controller.MozMillController(mozmill.utils.getWindows(&quot;Calendar:EventDialog&quot;)[0]);</span>
<a href="#l77.11"></a><span id="l77.11"> </span>
<a href="#l77.12"></a><span id="l77.12" class="difflineminus">-  let md = new modalDialog.modalDialog(event.window);</span>
<a href="#l77.13"></a><span id="l77.13" class="difflineminus">-  md.start(setRecurrence);</span>
<a href="#l77.14"></a><span id="l77.14" class="difflineplus">+  let dialog = new modalDialog.modalDialog(event.window);</span>
<a href="#l77.15"></a><span id="l77.15" class="difflineplus">+  dialog.start(setRecurrence);</span>
<a href="#l77.16"></a><span id="l77.16">   event.waitForElement(new elementslib.ID(event.window.document, &quot;item-repeat&quot;));</span>
<a href="#l77.17"></a><span id="l77.17">   event.select(new elementslib.ID(event.window.document, &quot;item-repeat&quot;), undefined, undefined, &quot;custom&quot;);</span>
<a href="#l77.18"></a><span id="l77.18"> </span>
<a href="#l77.19"></a><span id="l77.19">   event.click(new elementslib.ID(event.window.document, &quot;button-save&quot;));</span>
<a href="#l77.20"></a><span id="l77.20">   controller.waitFor(() =&gt; mozmill.utils.getWindows(&quot;Calendar:EventDialog&quot;).length == 0);</span>
<a href="#l77.21"></a><span id="l77.21"> </span>
<a href="#l77.22"></a><span id="l77.22">   let box = calUtils.getEventBoxPath(controller, &quot;day&quot;, calUtils.EVENT_BOX, undefined, 1, hour) +</span>
<a href="#l77.23"></a><span id="l77.23">     eventPath;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l78.1"></a><span id="l78.1" class="difflineminus">--- a/calendar/test/mozmill/recurrenceRotated/testWeeklyWithExceptionRecurrence.js</span>
<a href="#l78.2"></a><span id="l78.2" class="difflineplus">+++ b/calendar/test/mozmill/recurrenceRotated/testWeeklyWithExceptionRecurrence.js</span>
<a href="#l78.3"></a><span id="l78.3" class="difflineat">@@ -30,18 +30,18 @@ var testWeeklyWithExceptionRecurrence = </span>
<a href="#l78.4"></a><span id="l78.4">   });</span>
<a href="#l78.5"></a><span id="l78.5"> </span>
<a href="#l78.6"></a><span id="l78.6">   // create weekly recurring event</span>
<a href="#l78.7"></a><span id="l78.7">   controller.doubleClick(new elementslib.Lookup(controller.window.document,</span>
<a href="#l78.8"></a><span id="l78.8">     calUtils.getEventBoxPath(controller, &quot;day&quot;, calUtils.CANVAS_BOX, undefined, 1, hour)), 1, 1);</span>
<a href="#l78.9"></a><span id="l78.9">   controller.waitFor(() =&gt; mozmill.utils.getWindows(&quot;Calendar:EventDialog&quot;).length &gt; 0, sleep);</span>
<a href="#l78.10"></a><span id="l78.10">   let event = new mozmill.controller.MozMillController(mozmill.utils.getWindows(&quot;Calendar:EventDialog&quot;)[0]);</span>
<a href="#l78.11"></a><span id="l78.11"> </span>
<a href="#l78.12"></a><span id="l78.12" class="difflineminus">-  let md = new modalDialog.modalDialog(event.window);</span>
<a href="#l78.13"></a><span id="l78.13" class="difflineminus">-  md.start(setRecurrence);</span>
<a href="#l78.14"></a><span id="l78.14" class="difflineplus">+  let dialog = new modalDialog.modalDialog(event.window);</span>
<a href="#l78.15"></a><span id="l78.15" class="difflineplus">+  dialog.start(setRecurrence);</span>
<a href="#l78.16"></a><span id="l78.16">   event.waitForElement(new elementslib.ID(event.window.document, &quot;item-repeat&quot;));</span>
<a href="#l78.17"></a><span id="l78.17">   event.select(new elementslib.ID(event.window.document, &quot;item-repeat&quot;), undefined, undefined, &quot;custom&quot;);</span>
<a href="#l78.18"></a><span id="l78.18"> </span>
<a href="#l78.19"></a><span id="l78.19">   event.click(new elementslib.ID(event.window.document, &quot;button-save&quot;));</span>
<a href="#l78.20"></a><span id="l78.20"> </span>
<a href="#l78.21"></a><span id="l78.21">   // move 5th January occurrence to 6th January</span>
<a href="#l78.22"></a><span id="l78.22">   calUtils.handleOccurrenceModification(controller, false);</span>
<a href="#l78.23"></a><span id="l78.23">   controller.doubleClick(new elementslib.Lookup(controller.window.document,</span>
<a href="#l78.24"></a><span id="l78.24" class="difflineat">@@ -80,18 +80,18 @@ var testWeeklyWithExceptionRecurrence = </span>
<a href="#l78.25"></a><span id="l78.25">   calUtils.goToDate(controller, 2009, 1, 7);</span>
<a href="#l78.26"></a><span id="l78.26">   calUtils.handleParentModification(controller, false);</span>
<a href="#l78.27"></a><span id="l78.27">   controller.doubleClick(new elementslib.Lookup(controller.window.document,</span>
<a href="#l78.28"></a><span id="l78.28">     calUtils.getEventBoxPath(controller, &quot;day&quot;, calUtils.EVENT_BOX, undefined, 1, hour) +</span>
<a href="#l78.29"></a><span id="l78.29">       eventPath));</span>
<a href="#l78.30"></a><span id="l78.30">   controller.waitFor(() =&gt; mozmill.utils.getWindows(&quot;Calendar:EventDialog&quot;).length &gt; 0, sleep);</span>
<a href="#l78.31"></a><span id="l78.31">   event = new mozmill.controller.MozMillController(mozmill.utils.getWindows(&quot;Calendar:EventDialog&quot;)[0]);</span>
<a href="#l78.32"></a><span id="l78.32"> </span>
<a href="#l78.33"></a><span id="l78.33" class="difflineminus">-  md = new modalDialog.modalDialog(event.window);</span>
<a href="#l78.34"></a><span id="l78.34" class="difflineminus">-  md.start(changeRecurrence);</span>
<a href="#l78.35"></a><span id="l78.35" class="difflineplus">+  dialog = new modalDialog.modalDialog(event.window);</span>
<a href="#l78.36"></a><span id="l78.36" class="difflineplus">+  dialog.start(changeRecurrence);</span>
<a href="#l78.37"></a><span id="l78.37">   event.waitForElement(new elementslib.ID(event.window.document, &quot;item-repeat&quot;));</span>
<a href="#l78.38"></a><span id="l78.38">   event.select(new elementslib.ID(event.window.document, &quot;item-repeat&quot;), undefined, undefined, &quot;custom&quot;);</span>
<a href="#l78.39"></a><span id="l78.39"> </span>
<a href="#l78.40"></a><span id="l78.40">   event.click(new elementslib.ID(event.window.document, &quot;button-save&quot;));</span>
<a href="#l78.41"></a><span id="l78.41">   controller.waitFor(() =&gt; mozmill.utils.getWindows(&quot;Calendar:EventDialog&quot;).length == 0);</span>
<a href="#l78.42"></a><span id="l78.42"> </span>
<a href="#l78.43"></a><span id="l78.43">   // check two weeks</span>
<a href="#l78.44"></a><span id="l78.44">   // day view</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l79.1"></a><span id="l79.1" class="difflineminus">--- a/calendar/test/mozmill/shared-modules/calendar-utils.js</span>
<a href="#l79.2"></a><span id="l79.2" class="difflineplus">+++ b/calendar/test/mozmill/shared-modules/calendar-utils.js</span>
<a href="#l79.3"></a><span id="l79.3" class="difflineat">@@ -48,37 +48,37 @@ function handleAddingAttachment(controll</span>
<a href="#l79.4"></a><span id="l79.4"> }</span>
<a href="#l79.5"></a><span id="l79.5"> </span>
<a href="#l79.6"></a><span id="l79.6"> /**</span>
<a href="#l79.7"></a><span id="l79.7">  *  Choose to delete just one occurrence of a repeating event</span>
<a href="#l79.8"></a><span id="l79.8">  *  @param controller - Mozmill window controller</span>
<a href="#l79.9"></a><span id="l79.9">  *  @param attendees - whether there are attendees that can be notified or not</span>
<a href="#l79.10"></a><span id="l79.10">  */</span>
<a href="#l79.11"></a><span id="l79.11"> function handleOccurrenceDeletion(controller, attendees) {</span>
<a href="#l79.12"></a><span id="l79.12" class="difflineminus">-  let md = new modalDialog.modalDialog(controller.window);</span>
<a href="#l79.13"></a><span id="l79.13" class="difflineminus">-  md.start((dialog) =&gt; {</span>
<a href="#l79.14"></a><span id="l79.14" class="difflineplus">+  let dialog = new modalDialog.modalDialog(controller.window);</span>
<a href="#l79.15"></a><span id="l79.15" class="difflineplus">+  dialog.start((dialogController) =&gt; {</span>
<a href="#l79.16"></a><span id="l79.16">     if (attendees) {</span>
<a href="#l79.17"></a><span id="l79.17">       acceptSendingNotificationMail();</span>
<a href="#l79.18"></a><span id="l79.18">     }</span>
<a href="#l79.19"></a><span id="l79.19" class="difflineminus">-    dialog.waitThenClick(new elementslib.ID(dialog.window.document, &quot;accept-occurrence-button&quot;));</span>
<a href="#l79.20"></a><span id="l79.20" class="difflineplus">+    dialogController.waitThenClick(new elementslib.ID(dialog.window.document, &quot;accept-occurrence-button&quot;));</span>
<a href="#l79.21"></a><span id="l79.21">   });</span>
<a href="#l79.22"></a><span id="l79.22"> }</span>
<a href="#l79.23"></a><span id="l79.23"> </span>
<a href="#l79.24"></a><span id="l79.24"> /**</span>
<a href="#l79.25"></a><span id="l79.25">  *  Choose to delete all occurrences of a repeating event</span>
<a href="#l79.26"></a><span id="l79.26">  *  @param controller - Mozmill window controller</span>
<a href="#l79.27"></a><span id="l79.27">  *  @param attendees - whether there are attendees that can be notified or not</span>
<a href="#l79.28"></a><span id="l79.28">  */</span>
<a href="#l79.29"></a><span id="l79.29"> function handleParentDeletion(controller, attendees) {</span>
<a href="#l79.30"></a><span id="l79.30" class="difflineminus">-  let md = new modalDialog.modalDialog(controller.window);</span>
<a href="#l79.31"></a><span id="l79.31" class="difflineminus">-  md.start((dialog) =&gt; {</span>
<a href="#l79.32"></a><span id="l79.32" class="difflineplus">+  let dialog = new modalDialog.modalDialog(controller.window);</span>
<a href="#l79.33"></a><span id="l79.33" class="difflineplus">+  dialog.start((dialogController) =&gt; {</span>
<a href="#l79.34"></a><span id="l79.34">     if (attendees) {</span>
<a href="#l79.35"></a><span id="l79.35">       acceptSendingNotificationMail();</span>
<a href="#l79.36"></a><span id="l79.36">     }</span>
<a href="#l79.37"></a><span id="l79.37" class="difflineminus">-    dialog.waitThenClick(new elementslib.ID(dialog.window.document, &quot;accept-parent-button&quot;));</span>
<a href="#l79.38"></a><span id="l79.38" class="difflineplus">+    dialogController.waitThenClick(new elementslib.ID(dialog.window.document, &quot;accept-parent-button&quot;));</span>
<a href="#l79.39"></a><span id="l79.39">   });</span>
<a href="#l79.40"></a><span id="l79.40"> }</span>
<a href="#l79.41"></a><span id="l79.41"> </span>
<a href="#l79.42"></a><span id="l79.42"> /**</span>
<a href="#l79.43"></a><span id="l79.43">  *  Choose to modify just one occurrence of a repeating event</span>
<a href="#l79.44"></a><span id="l79.44">  *  @param controller - Mozmill window controller</span>
<a href="#l79.45"></a><span id="l79.45">  *  @param attendees - whether there are attendees that can be notified or not</span>
<a href="#l79.46"></a><span id="l79.46">  */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l80.1"></a><span id="l80.1" class="difflineminus">--- a/calendar/test/mozmill/shared-modules/timezone-utils.js</span>
<a href="#l80.2"></a><span id="l80.2" class="difflineplus">+++ b/calendar/test/mozmill/shared-modules/timezone-utils.js</span>
<a href="#l80.3"></a><span id="l80.3" class="difflineat">@@ -26,22 +26,22 @@ function verify(controller, dates, timez</span>
<a href="#l80.4"></a><span id="l80.4">      a spacer is added to push the event to it's correct location.             |__event_box___|</span>
<a href="#l80.5"></a><span id="l80.5">      But timeline can be used to retrieve the position of a particular hour    |day continues |</span>
<a href="#l80.6"></a><span id="l80.6">      on screen and it can be compared against the position of the event.       ----------------</span>
<a href="#l80.7"></a><span id="l80.7">   */</span>
<a href="#l80.8"></a><span id="l80.8">   for (let date = 0; date &lt; dates.length; date++) {</span>
<a href="#l80.9"></a><span id="l80.9">     calUtils.goToDate(controller, dates[date][0], dates[date][1], dates[date][2]);</span>
<a href="#l80.10"></a><span id="l80.10"> </span>
<a href="#l80.11"></a><span id="l80.11">     // find event with timezone tz</span>
<a href="#l80.12"></a><span id="l80.12" class="difflineminus">-    for (let tz = 0; tz &lt; timezones.length; tz++) {</span>
<a href="#l80.13"></a><span id="l80.13" class="difflineplus">+    for (let tzIdx = 0; tzIdx &lt; timezones.length; tzIdx++) {</span>
<a href="#l80.14"></a><span id="l80.14">       let found = false;</span>
<a href="#l80.15"></a><span id="l80.15"> </span>
<a href="#l80.16"></a><span id="l80.16" class="difflineminus">-      let correctHour = times[date][tz][0];</span>
<a href="#l80.17"></a><span id="l80.17" class="difflineminus">-      let minutes = times[date][tz][1];</span>
<a href="#l80.18"></a><span id="l80.18" class="difflineminus">-      let day = times[date][tz][2];</span>
<a href="#l80.19"></a><span id="l80.19" class="difflineplus">+      let correctHour = times[date][tzIdx][0];</span>
<a href="#l80.20"></a><span id="l80.20" class="difflineplus">+      let minutes = times[date][tzIdx][1];</span>
<a href="#l80.21"></a><span id="l80.21" class="difflineplus">+      let day = times[date][tzIdx][2];</span>
<a href="#l80.22"></a><span id="l80.22"> </span>
<a href="#l80.23"></a><span id="l80.23">       let timeNode = (new elementslib.Lookup(controller.window.document,</span>
<a href="#l80.24"></a><span id="l80.24">                                              timeLine + &quot;[&quot; + correctHour + &quot;]&quot;)).getNode();</span>
<a href="#l80.25"></a><span id="l80.25">       let timeY = timeNode.boxObject.y;</span>
<a href="#l80.26"></a><span id="l80.26">       timeY += timeNode.boxObject.height * (minutes / 60);</span>
<a href="#l80.27"></a><span id="l80.27"> </span>
<a href="#l80.28"></a><span id="l80.28">       let stackNode;</span>
<a href="#l80.29"></a><span id="l80.29">       let eventNodes = [];</span>
<a href="#l80.30"></a><span id="l80.30" class="difflineat">@@ -62,17 +62,17 @@ function verify(controller, dates, timez</span>
<a href="#l80.31"></a><span id="l80.31">         calUtils.back(controller, 1);</span>
<a href="#l80.32"></a><span id="l80.32">         stackNode = (new elementslib.Lookup(controller.window.document, dayStack)).getNode();</span>
<a href="#l80.33"></a><span id="l80.33">       }</span>
<a href="#l80.34"></a><span id="l80.34"> </span>
<a href="#l80.35"></a><span id="l80.35">       calUtils.findEventsInNode(stackNode, eventNodes);</span>
<a href="#l80.36"></a><span id="l80.36"> </span>
<a href="#l80.37"></a><span id="l80.37">       for (let node of eventNodes) {</span>
<a href="#l80.38"></a><span id="l80.38">         if (Math.abs(timeY - node.boxObject.y) &lt; allowedDifference &amp;&amp;</span>
<a href="#l80.39"></a><span id="l80.39" class="difflineminus">-                     timezones[tz] == node.mOccurrence.title) {</span>
<a href="#l80.40"></a><span id="l80.40" class="difflineplus">+                     timezones[tzIdx] == node.mOccurrence.title) {</span>
<a href="#l80.41"></a><span id="l80.41">           found = true;</span>
<a href="#l80.42"></a><span id="l80.42">           break;</span>
<a href="#l80.43"></a><span id="l80.43">         }</span>
<a href="#l80.44"></a><span id="l80.44">       }</span>
<a href="#l80.45"></a><span id="l80.45"> </span>
<a href="#l80.46"></a><span id="l80.46">       if (day != undefined &amp;&amp; day == 1) {</span>
<a href="#l80.47"></a><span id="l80.47">         calUtils.back(controller, 1);</span>
<a href="#l80.48"></a><span id="l80.48">       }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l81.1"></a><span id="l81.1" class="difflineminus">--- a/calendar/test/unit/head_consts.js</span>
<a href="#l81.2"></a><span id="l81.2" class="difflineplus">+++ b/calendar/test/unit/head_consts.js</span>
<a href="#l81.3"></a><span id="l81.3" class="difflineat">@@ -28,27 +28,27 @@ var { classes: Cc, interfaces: Ci, resul</span>
<a href="#l81.4"></a><span id="l81.4"> </span>
<a href="#l81.5"></a><span id="l81.5"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l81.6"></a><span id="l81.6"> </span>
<a href="#l81.7"></a><span id="l81.7"> // we might want to use calUtils.jsm only in the future throughout all tests,</span>
<a href="#l81.8"></a><span id="l81.8"> // but for now source in good old calUtils.js:</span>
<a href="#l81.9"></a><span id="l81.9"> cal.loadScripts([&quot;calUtils.js&quot;], Components.utils.getGlobalForObject(Cc));</span>
<a href="#l81.10"></a><span id="l81.10"> </span>
<a href="#l81.11"></a><span id="l81.11"> function createDate(aYear, aMonth, aDay, aHasTime, aHour, aMinute, aSecond, aTimezone) {</span>
<a href="#l81.12"></a><span id="l81.12" class="difflineminus">-    let cd = Cc[&quot;@mozilla.org/calendar/datetime;1&quot;]</span>
<a href="#l81.13"></a><span id="l81.13" class="difflineminus">-             .createInstance(Ci.calIDateTime);</span>
<a href="#l81.14"></a><span id="l81.14" class="difflineminus">-    cd.resetTo(aYear,</span>
<a href="#l81.15"></a><span id="l81.15" class="difflineplus">+    let date = Cc[&quot;@mozilla.org/calendar/datetime;1&quot;]</span>
<a href="#l81.16"></a><span id="l81.16" class="difflineplus">+               .createInstance(Ci.calIDateTime);</span>
<a href="#l81.17"></a><span id="l81.17" class="difflineplus">+    date.resetTo(aYear,</span>
<a href="#l81.18"></a><span id="l81.18">                aMonth,</span>
<a href="#l81.19"></a><span id="l81.19">                aDay,</span>
<a href="#l81.20"></a><span id="l81.20">                aHour || 0,</span>
<a href="#l81.21"></a><span id="l81.21">                aMinute || 0,</span>
<a href="#l81.22"></a><span id="l81.22">                aSecond || 0,</span>
<a href="#l81.23"></a><span id="l81.23">                aTimezone || UTC());</span>
<a href="#l81.24"></a><span id="l81.24" class="difflineminus">-    cd.isDate = !aHasTime;</span>
<a href="#l81.25"></a><span id="l81.25" class="difflineminus">-    return cd;</span>
<a href="#l81.26"></a><span id="l81.26" class="difflineplus">+    date.isDate = !aHasTime;</span>
<a href="#l81.27"></a><span id="l81.27" class="difflineplus">+    return date;</span>
<a href="#l81.28"></a><span id="l81.28"> }</span>
<a href="#l81.29"></a><span id="l81.29"> </span>
<a href="#l81.30"></a><span id="l81.30"> function createEventFromIcalString(icalString) {</span>
<a href="#l81.31"></a><span id="l81.31">     if (/^BEGIN:VCALENDAR/.test(icalString)) {</span>
<a href="#l81.32"></a><span id="l81.32">         let parser = Components.classes[&quot;@mozilla.org/calendar/ics-parser;1&quot;]</span>
<a href="#l81.33"></a><span id="l81.33">                                .createInstance(Components.interfaces.calIIcsParser);</span>
<a href="#l81.34"></a><span id="l81.34">         parser.parseString(icalString);</span>
<a href="#l81.35"></a><span id="l81.35">         let items = parser.getItems({});</span>
<a href="#l81.36"></a><span id="l81.36" class="difflineat">@@ -234,20 +234,20 @@ function do_calendar_startup(callback) {</span>
<a href="#l81.37"></a><span id="l81.37">     let obs = {</span>
<a href="#l81.38"></a><span id="l81.38">       observe: function() {</span>
<a href="#l81.39"></a><span id="l81.39">         Services.obs.removeObserver(this, &quot;calendar-startup-done&quot;);</span>
<a href="#l81.40"></a><span id="l81.40">         do_test_finished();</span>
<a href="#l81.41"></a><span id="l81.41">         do_execute_soon(callback);</span>
<a href="#l81.42"></a><span id="l81.42">       }</span>
<a href="#l81.43"></a><span id="l81.43">     };</span>
<a href="#l81.44"></a><span id="l81.44"> </span>
<a href="#l81.45"></a><span id="l81.45" class="difflineminus">-    let ss = Components.classes[&quot;@mozilla.org/calendar/startup-service;1&quot;]</span>
<a href="#l81.46"></a><span id="l81.46" class="difflineminus">-                       .getService(Components.interfaces.nsISupports).wrappedJSObject;</span>
<a href="#l81.47"></a><span id="l81.47" class="difflineplus">+    let startupService = Components.classes[&quot;@mozilla.org/calendar/startup-service;1&quot;]</span>
<a href="#l81.48"></a><span id="l81.48" class="difflineplus">+                                   .getService(Components.interfaces.nsISupports).wrappedJSObject;</span>
<a href="#l81.49"></a><span id="l81.49"> </span>
<a href="#l81.50"></a><span id="l81.50" class="difflineminus">-    if (ss.started) {</span>
<a href="#l81.51"></a><span id="l81.51" class="difflineplus">+    if (startupService.started) {</span>
<a href="#l81.52"></a><span id="l81.52">         callback();</span>
<a href="#l81.53"></a><span id="l81.53">     } else {</span>
<a href="#l81.54"></a><span id="l81.54">         do_test_pending();</span>
<a href="#l81.55"></a><span id="l81.55">         Services.obs.addObserver(obs, &quot;calendar-startup-done&quot;, false);</span>
<a href="#l81.56"></a><span id="l81.56">         if (_profileInitialized) {</span>
<a href="#l81.57"></a><span id="l81.57">             Services.obs.notifyObservers(null, &quot;profile-after-change&quot;, &quot;xpcshell-do-get-profile&quot;);</span>
<a href="#l81.58"></a><span id="l81.58">         } else {</span>
<a href="#l81.59"></a><span id="l81.59">             do_get_profile(true);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l82.1"></a><span id="l82.1" class="difflineminus">--- a/calendar/test/unit/test_alarm.js</span>
<a href="#l82.2"></a><span id="l82.2" class="difflineplus">+++ b/calendar/test/unit/test_alarm.js</span>
<a href="#l82.3"></a><span id="l82.3" class="difflineat">@@ -285,44 +285,44 @@ function test_repeat() {</span>
<a href="#l82.4"></a><span id="l82.4">     // Check repeatDate</span>
<a href="#l82.5"></a><span id="l82.5">     alarm = cal.createAlarm();</span>
<a href="#l82.6"></a><span id="l82.6">     alarm.related = Components.interfaces.calIAlarm.ALARM_RELATED_ABSOLUTE;</span>
<a href="#l82.7"></a><span id="l82.7">     alarm.alarmDate = cal.createDateTime();</span>
<a href="#l82.8"></a><span id="l82.8">     alarm.repeat = 1;</span>
<a href="#l82.9"></a><span id="l82.9">     alarm.repeatOffset = cal.createDuration();</span>
<a href="#l82.10"></a><span id="l82.10">     alarm.repeatOffset.inSeconds = 3600;</span>
<a href="#l82.11"></a><span id="l82.11"> </span>
<a href="#l82.12"></a><span id="l82.12" class="difflineminus">-    let dt = alarm.alarmDate.clone();</span>
<a href="#l82.13"></a><span id="l82.13" class="difflineminus">-    dt.second += 3600;</span>
<a href="#l82.14"></a><span id="l82.14" class="difflineminus">-    equal(alarm.repeatDate.icalString, dt.icalString);</span>
<a href="#l82.15"></a><span id="l82.15" class="difflineplus">+    let date = alarm.alarmDate.clone();</span>
<a href="#l82.16"></a><span id="l82.16" class="difflineplus">+    date.second += 3600;</span>
<a href="#l82.17"></a><span id="l82.17" class="difflineplus">+    equal(alarm.repeatDate.icalString, date.icalString);</span>
<a href="#l82.18"></a><span id="l82.18"> </span>
<a href="#l82.19"></a><span id="l82.19">     dump(&quot;Done\n&quot;);</span>
<a href="#l82.20"></a><span id="l82.20"> }</span>
<a href="#l82.21"></a><span id="l82.21"> </span>
<a href="#l82.22"></a><span id="l82.22"> function test_xprop() {</span>
<a href="#l82.23"></a><span id="l82.23">     dump(&quot;Testing X-Props...&quot;);</span>
<a href="#l82.24"></a><span id="l82.24">     let alarm = cal.createAlarm();</span>
<a href="#l82.25"></a><span id="l82.25">     alarm.setProperty(&quot;X-PROP&quot;, &quot;X-VALUE&quot;);</span>
<a href="#l82.26"></a><span id="l82.26">     ok(alarm.hasProperty(&quot;X-PROP&quot;));</span>
<a href="#l82.27"></a><span id="l82.27">     equal(alarm.getProperty(&quot;X-PROP&quot;), &quot;X-VALUE&quot;);</span>
<a href="#l82.28"></a><span id="l82.28">     alarm.deleteProperty(&quot;X-PROP&quot;);</span>
<a href="#l82.29"></a><span id="l82.29">     ok(!alarm.hasProperty(&quot;X-PROP&quot;));</span>
<a href="#l82.30"></a><span id="l82.30">     equal(alarm.getProperty(&quot;X-PROP&quot;), null);</span>
<a href="#l82.31"></a><span id="l82.31"> </span>
<a href="#l82.32"></a><span id="l82.32">     // also check X-MOZ-LASTACK prop</span>
<a href="#l82.33"></a><span id="l82.33" class="difflineminus">-    let dt = cal.createDateTime();</span>
<a href="#l82.34"></a><span id="l82.34" class="difflineminus">-    alarm.setProperty(&quot;X-MOZ-LASTACK&quot;, dt.icalString);</span>
<a href="#l82.35"></a><span id="l82.35" class="difflineplus">+    let date = cal.createDateTime();</span>
<a href="#l82.36"></a><span id="l82.36" class="difflineplus">+    alarm.setProperty(&quot;X-MOZ-LASTACK&quot;, date.icalString);</span>
<a href="#l82.37"></a><span id="l82.37">     alarm.action = &quot;DISPLAY&quot;;</span>
<a href="#l82.38"></a><span id="l82.38">     alarm.description = &quot;test&quot;;</span>
<a href="#l82.39"></a><span id="l82.39">     alarm.related = Ci.calIAlarm.ALARM_RELATED_START;</span>
<a href="#l82.40"></a><span id="l82.40">     alarm.offset = createDuration(&quot;-PT5M&quot;);</span>
<a href="#l82.41"></a><span id="l82.41" class="difflineminus">-    ok(alarm.icalComponent.serializeToICS().includes(dt.icalString));</span>
<a href="#l82.42"></a><span id="l82.42" class="difflineplus">+    ok(alarm.icalComponent.serializeToICS().includes(date.icalString));</span>
<a href="#l82.43"></a><span id="l82.43"> </span>
<a href="#l82.44"></a><span id="l82.44">     alarm.deleteProperty(&quot;X-MOZ-LASTACK&quot;);</span>
<a href="#l82.45"></a><span id="l82.45" class="difflineminus">-    ok(!alarm.icalComponent.serializeToICS().includes(dt.icalString));</span>
<a href="#l82.46"></a><span id="l82.46" class="difflineplus">+    ok(!alarm.icalComponent.serializeToICS().includes(date.icalString));</span>
<a href="#l82.47"></a><span id="l82.47">     dump(&quot;Done\n&quot;);</span>
<a href="#l82.48"></a><span id="l82.48"> }</span>
<a href="#l82.49"></a><span id="l82.49"> </span>
<a href="#l82.50"></a><span id="l82.50"> function test_dates() {</span>
<a href="#l82.51"></a><span id="l82.51">     dump(&quot;Testing alarm dates...&quot;);</span>
<a href="#l82.52"></a><span id="l82.52">     let passed;</span>
<a href="#l82.53"></a><span id="l82.53">     // Initial value</span>
<a href="#l82.54"></a><span id="l82.54">     let alarm = cal.createAlarm();</span>
<a href="#l82.55"></a><span id="l82.55" class="difflineat">@@ -468,18 +468,18 @@ function test_clone() {</span>
<a href="#l82.56"></a><span id="l82.56">         notEqual(alarm[prop], newAlarm[prop]);</span>
<a href="#l82.57"></a><span id="l82.57">         dump(&quot;OK!\n&quot;);</span>
<a href="#l82.58"></a><span id="l82.58">         break;</span>
<a href="#l82.59"></a><span id="l82.59">     }</span>
<a href="#l82.60"></a><span id="l82.60"> </span>
<a href="#l82.61"></a><span id="l82.61">     // Check x props</span>
<a href="#l82.62"></a><span id="l82.62">     alarm.setProperty(&quot;X-FOO&quot;, &quot;BAR&quot;);</span>
<a href="#l82.63"></a><span id="l82.63">     equal(alarm.getProperty(&quot;X-FOO&quot;), &quot;BAR&quot;);</span>
<a href="#l82.64"></a><span id="l82.64" class="difflineminus">-    let dt = alarm.getProperty(&quot;X-DATEPROP&quot;);</span>
<a href="#l82.65"></a><span id="l82.65" class="difflineminus">-    equal(dt.isMutable, true);</span>
<a href="#l82.66"></a><span id="l82.66" class="difflineplus">+    let date = alarm.getProperty(&quot;X-DATEPROP&quot;);</span>
<a href="#l82.67"></a><span id="l82.67" class="difflineplus">+    equal(date.isMutable, true);</span>
<a href="#l82.68"></a><span id="l82.68"> </span>
<a href="#l82.69"></a><span id="l82.69">     // Test xprop params</span>
<a href="#l82.70"></a><span id="l82.70">     alarm.icalString =</span>
<a href="#l82.71"></a><span id="l82.71">         &quot;BEGIN:VALARM\n&quot; +</span>
<a href="#l82.72"></a><span id="l82.72">         &quot;ACTION:DISPLAY\n&quot; +</span>
<a href="#l82.73"></a><span id="l82.73">         &quot;TRIGGER:-PT15M\n&quot; +</span>
<a href="#l82.74"></a><span id="l82.74">         &quot;X-FOO;X-PARAM=PARAMVAL:BAR\n&quot; +</span>
<a href="#l82.75"></a><span id="l82.75">         &quot;DESCRIPTION:TEST\n&quot; +</span>
<a href="#l82.76"></a><span id="l82.76" class="difflineat">@@ -495,20 +495,20 @@ function test_serialize() {</span>
<a href="#l82.77"></a><span id="l82.77">     // most checks done by other tests, these don't fit into categories</span>
<a href="#l82.78"></a><span id="l82.78">     let alarm = cal.createAlarm();</span>
<a href="#l82.79"></a><span id="l82.79">     let srv = cal.getIcsService();</span>
<a href="#l82.80"></a><span id="l82.80"> </span>
<a href="#l82.81"></a><span id="l82.81">     throws(() =&gt; {</span>
<a href="#l82.82"></a><span id="l82.82">         alarm.icalComponent = srv.createIcalComponent(&quot;BARF&quot;);</span>
<a href="#l82.83"></a><span id="l82.83">     }, /0x80070057/, &quot;Invalid Argument&quot;);</span>
<a href="#l82.84"></a><span id="l82.84"> </span>
<a href="#l82.85"></a><span id="l82.85" class="difflineminus">-    function addProp(k, v) {</span>
<a href="#l82.86"></a><span id="l82.86" class="difflineminus">-        let p = srv.createIcalProperty(k);</span>
<a href="#l82.87"></a><span id="l82.87" class="difflineminus">-        p.value = v;</span>
<a href="#l82.88"></a><span id="l82.88" class="difflineminus">-        comp.addProperty(p);</span>
<a href="#l82.89"></a><span id="l82.89" class="difflineplus">+    function addProp(name, value) {</span>
<a href="#l82.90"></a><span id="l82.90" class="difflineplus">+        let prop = srv.createIcalProperty(name);</span>
<a href="#l82.91"></a><span id="l82.91" class="difflineplus">+        prop.value = value;</span>
<a href="#l82.92"></a><span id="l82.92" class="difflineplus">+        comp.addProperty(prop);</span>
<a href="#l82.93"></a><span id="l82.93">     }</span>
<a href="#l82.94"></a><span id="l82.94">     function addActionDisplay() { addProp(&quot;ACTION&quot;, &quot;DISPLAY&quot;); }</span>
<a href="#l82.95"></a><span id="l82.95">     function addActionEmail() { addProp(&quot;ACTION&quot;, &quot;EMAIL&quot;); }</span>
<a href="#l82.96"></a><span id="l82.96">     function addTrigger() { addProp(&quot;TRIGGER&quot;, &quot;-PT15M&quot;); }</span>
<a href="#l82.97"></a><span id="l82.97">     function addDescr() { addProp(&quot;DESCRIPTION&quot;, &quot;TEST&quot;); }</span>
<a href="#l82.98"></a><span id="l82.98">     function addDuration() { addProp(&quot;DURATION&quot;, &quot;-PT15M&quot;); }</span>
<a href="#l82.99"></a><span id="l82.99">     function addRepeat() { addProp(&quot;REPEAT&quot;, &quot;1&quot;); }</span>
<a href="#l82.100"></a><span id="l82.100">     function addAttendee() { addProp(&quot;ATTENDEE&quot;, &quot;mailto:horst&quot;); }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l83.1"></a><span id="l83.1" class="difflineminus">--- a/calendar/test/unit/test_alarmservice.js</span>
<a href="#l83.2"></a><span id="l83.2" class="difflineplus">+++ b/calendar/test/unit/test_alarmservice.js</span>
<a href="#l83.3"></a><span id="l83.3" class="difflineat">@@ -59,22 +59,22 @@ var alarmObserver = {</span>
<a href="#l83.4"></a><span id="l83.4">     expectResult: function(aCalendar, aItem, aAlarm, aExpected) {</span>
<a href="#l83.5"></a><span id="l83.5">         this.expectedMap[aCalendar.id] = this.expectedMap[aCalendar.id] || {};</span>
<a href="#l83.6"></a><span id="l83.6">         this.expectedMap[aCalendar.id][aItem.hashId] = this.expectedMap[aCalendar.id][aItem.hashId] || {};</span>
<a href="#l83.7"></a><span id="l83.7">         this.expectedMap[aCalendar.id][aItem.hashId][aAlarm.icalString] = aExpected;</span>
<a href="#l83.8"></a><span id="l83.8">     },</span>
<a href="#l83.9"></a><span id="l83.9"> </span>
<a href="#l83.10"></a><span id="l83.10">     expectOccurrences: function(aCalendar, aItem, aAlarm, aExpectedArray) {</span>
<a href="#l83.11"></a><span id="l83.11">         // we need to be earlier than the first occurrence</span>
<a href="#l83.12"></a><span id="l83.12" class="difflineminus">-        let dt = aItem.startDate.clone();</span>
<a href="#l83.13"></a><span id="l83.13" class="difflineminus">-        dt.second -= 1;</span>
<a href="#l83.14"></a><span id="l83.14" class="difflineplus">+        let date = aItem.startDate.clone();</span>
<a href="#l83.15"></a><span id="l83.15" class="difflineplus">+        date.second -= 1;</span>
<a href="#l83.16"></a><span id="l83.16"> </span>
<a href="#l83.17"></a><span id="l83.17">         for (let expected of aExpectedArray) {</span>
<a href="#l83.18"></a><span id="l83.18" class="difflineminus">-            let occ = aItem.recurrenceInfo.getNextOccurrence(dt);</span>
<a href="#l83.19"></a><span id="l83.19" class="difflineminus">-            dt = occ.startDate;</span>
<a href="#l83.20"></a><span id="l83.20" class="difflineplus">+            let occ = aItem.recurrenceInfo.getNextOccurrence(date);</span>
<a href="#l83.21"></a><span id="l83.21" class="difflineplus">+            date = occ.startDate;</span>
<a href="#l83.22"></a><span id="l83.22">             this.expectResult(aCalendar, occ, aAlarm, expected);</span>
<a href="#l83.23"></a><span id="l83.23">         }</span>
<a href="#l83.24"></a><span id="l83.24">     },</span>
<a href="#l83.25"></a><span id="l83.25"> </span>
<a href="#l83.26"></a><span id="l83.26">     checkExpected: function() {</span>
<a href="#l83.27"></a><span id="l83.27">         for (let calId in this.expectedMap) {</span>
<a href="#l83.28"></a><span id="l83.28">             for (let id in this.expectedMap[calId]) {</span>
<a href="#l83.29"></a><span id="l83.29">                 for (let icalString in this.expectedMap[calId][id]) {</span>
<a href="#l83.30"></a><span id="l83.30" class="difflineat">@@ -168,117 +168,117 @@ function createEventWithAlarm(aCalendar,</span>
<a href="#l83.31"></a><span id="l83.31">     }</span>
<a href="#l83.32"></a><span id="l83.32">     return [item, alarm];</span>
<a href="#l83.33"></a><span id="l83.33"> }</span>
<a href="#l83.34"></a><span id="l83.34"> </span>
<a href="#l83.35"></a><span id="l83.35"> function addTestItems(aCalendar) {</span>
<a href="#l83.36"></a><span id="l83.36">     let item, alarm;</span>
<a href="#l83.37"></a><span id="l83.37"> </span>
<a href="#l83.38"></a><span id="l83.38">     // alarm on an item starting more than a month in the past should not fire</span>
<a href="#l83.39"></a><span id="l83.39" class="difflineminus">-    let dt = cal.now();</span>
<a href="#l83.40"></a><span id="l83.40" class="difflineminus">-    dt.day -= 32;</span>
<a href="#l83.41"></a><span id="l83.41" class="difflineminus">-    [item, alarm] = createEventWithAlarm(aCalendar, dt, dt, &quot;P7D&quot;);</span>
<a href="#l83.42"></a><span id="l83.42" class="difflineplus">+    let date = cal.now();</span>
<a href="#l83.43"></a><span id="l83.43" class="difflineplus">+    date.day -= 32;</span>
<a href="#l83.44"></a><span id="l83.44" class="difflineplus">+    [item, alarm] = createEventWithAlarm(aCalendar, date, date, &quot;P7D&quot;);</span>
<a href="#l83.45"></a><span id="l83.45">     alarmObserver.expectResult(aCalendar, item, alarm, EXPECT_NONE);</span>
<a href="#l83.46"></a><span id="l83.46">     aCalendar.addItem(item, null);</span>
<a href="#l83.47"></a><span id="l83.47"> </span>
<a href="#l83.48"></a><span id="l83.48">     // alarm 15 minutes ago should fire</span>
<a href="#l83.49"></a><span id="l83.49" class="difflineminus">-    dt = cal.now();</span>
<a href="#l83.50"></a><span id="l83.50" class="difflineminus">-    [item, alarm] = createEventWithAlarm(aCalendar, dt, dt, &quot;-PT15M&quot;);</span>
<a href="#l83.51"></a><span id="l83.51" class="difflineplus">+    date = cal.now();</span>
<a href="#l83.52"></a><span id="l83.52" class="difflineplus">+    [item, alarm] = createEventWithAlarm(aCalendar, date, date, &quot;-PT15M&quot;);</span>
<a href="#l83.53"></a><span id="l83.53">     alarmObserver.expectResult(aCalendar, item, alarm, EXPECT_FIRED);</span>
<a href="#l83.54"></a><span id="l83.54">     aCalendar.addItem(item, null);</span>
<a href="#l83.55"></a><span id="l83.55"> </span>
<a href="#l83.56"></a><span id="l83.56">     // alarm within 6 hours should have a timer set</span>
<a href="#l83.57"></a><span id="l83.57" class="difflineminus">-    [item, alarm] = createEventWithAlarm(aCalendar, dt, dt, &quot;PT1H&quot;);</span>
<a href="#l83.58"></a><span id="l83.58" class="difflineplus">+    [item, alarm] = createEventWithAlarm(aCalendar, date, date, &quot;PT1H&quot;);</span>
<a href="#l83.59"></a><span id="l83.59">     alarmObserver.expectResult(aCalendar, item, alarm, EXPECT_TIMER);</span>
<a href="#l83.60"></a><span id="l83.60">     aCalendar.addItem(item, null);</span>
<a href="#l83.61"></a><span id="l83.61"> </span>
<a href="#l83.62"></a><span id="l83.62">     // alarm more than 6 hours in the future should not have a timer set</span>
<a href="#l83.63"></a><span id="l83.63" class="difflineminus">-    [item, alarm] = createEventWithAlarm(aCalendar, dt, dt, &quot;PT7H&quot;);</span>
<a href="#l83.64"></a><span id="l83.64" class="difflineplus">+    [item, alarm] = createEventWithAlarm(aCalendar, date, date, &quot;PT7H&quot;);</span>
<a href="#l83.65"></a><span id="l83.65">     alarmObserver.expectResult(aCalendar, item, alarm, EXPECT_NONE);</span>
<a href="#l83.66"></a><span id="l83.66">     aCalendar.addItem(item, null);</span>
<a href="#l83.67"></a><span id="l83.67"> </span>
<a href="#l83.68"></a><span id="l83.68">     // test multiple alarms on an item</span>
<a href="#l83.69"></a><span id="l83.69" class="difflineminus">-    [item, alarm] = createEventWithAlarm(aCalendar, dt, dt);</span>
<a href="#l83.70"></a><span id="l83.70" class="difflineplus">+    [item, alarm] = createEventWithAlarm(aCalendar, date, date);</span>
<a href="#l83.71"></a><span id="l83.71">     [[&quot;-PT1H&quot;, EXPECT_FIRED], [&quot;-PT15M&quot;, EXPECT_FIRED], [&quot;PT1H&quot;, EXPECT_TIMER],</span>
<a href="#l83.72"></a><span id="l83.72">      [&quot;PT7H&quot;, EXPECT_NONE], [&quot;P7D&quot;, EXPECT_NONE]].forEach(([offset, expected]) =&gt; {</span>
<a href="#l83.73"></a><span id="l83.73">         alarm = createAlarmFromDuration(offset);</span>
<a href="#l83.74"></a><span id="l83.74">         item.addAlarm(alarm);</span>
<a href="#l83.75"></a><span id="l83.75">         alarmObserver.expectResult(aCalendar, item, alarm, expected);</span>
<a href="#l83.76"></a><span id="l83.76">     });</span>
<a href="#l83.77"></a><span id="l83.77">     aCalendar.addItem(item, null);</span>
<a href="#l83.78"></a><span id="l83.78"> </span>
<a href="#l83.79"></a><span id="l83.79">     // daily repeating event starting almost 2 full days ago. The alarms on the first 2 occurrences</span>
<a href="#l83.80"></a><span id="l83.80">     // should fire, and a timer should be set for the next occurrence only</span>
<a href="#l83.81"></a><span id="l83.81" class="difflineminus">-    dt = cal.now();</span>
<a href="#l83.82"></a><span id="l83.82" class="difflineminus">-    dt.hour -= 47;</span>
<a href="#l83.83"></a><span id="l83.83" class="difflineminus">-    [item, alarm] = createEventWithAlarm(aCalendar, dt, dt, &quot;-PT15M&quot;, &quot;RRULE:FREQ=DAILY&quot;);</span>
<a href="#l83.84"></a><span id="l83.84" class="difflineplus">+    date = cal.now();</span>
<a href="#l83.85"></a><span id="l83.85" class="difflineplus">+    date.hour -= 47;</span>
<a href="#l83.86"></a><span id="l83.86" class="difflineplus">+    [item, alarm] = createEventWithAlarm(aCalendar, date, date, &quot;-PT15M&quot;, &quot;RRULE:FREQ=DAILY&quot;);</span>
<a href="#l83.87"></a><span id="l83.87">     alarmObserver.expectOccurrences(aCalendar, item, alarm,</span>
<a href="#l83.88"></a><span id="l83.88">                                    [EXPECT_FIRED, EXPECT_FIRED, EXPECT_TIMER,</span>
<a href="#l83.89"></a><span id="l83.89">                                     EXPECT_NONE, EXPECT_NONE]);</span>
<a href="#l83.90"></a><span id="l83.90">     aCalendar.addItem(item, null);</span>
<a href="#l83.91"></a><span id="l83.91"> </span>
<a href="#l83.92"></a><span id="l83.92">     // monthly repeating event starting 2 months and a day ago. The alarms on the first 2 occurrences</span>
<a href="#l83.93"></a><span id="l83.93">     // should be ignored, the alarm on the next occurrence only should fire</span>
<a href="#l83.94"></a><span id="l83.94" class="difflineminus">-    dt = cal.now();</span>
<a href="#l83.95"></a><span id="l83.95" class="difflineminus">-    dt.month -= 2;</span>
<a href="#l83.96"></a><span id="l83.96" class="difflineminus">-    dt.day -= 1;</span>
<a href="#l83.97"></a><span id="l83.97" class="difflineminus">-    [item, alarm] = createEventWithAlarm(aCalendar, dt, dt, &quot;-PT15M&quot;, &quot;RRULE:FREQ=MONTHLY&quot;);</span>
<a href="#l83.98"></a><span id="l83.98" class="difflineplus">+    date = cal.now();</span>
<a href="#l83.99"></a><span id="l83.99" class="difflineplus">+    date.month -= 2;</span>
<a href="#l83.100"></a><span id="l83.100" class="difflineplus">+    date.day -= 1;</span>
<a href="#l83.101"></a><span id="l83.101" class="difflineplus">+    [item, alarm] = createEventWithAlarm(aCalendar, date, date, &quot;-PT15M&quot;, &quot;RRULE:FREQ=MONTHLY&quot;);</span>
<a href="#l83.102"></a><span id="l83.102">     alarmObserver.expectOccurrences(aCalendar, item, alarm,</span>
<a href="#l83.103"></a><span id="l83.103">                                    [EXPECT_NONE, EXPECT_NONE, EXPECT_FIRED,</span>
<a href="#l83.104"></a><span id="l83.104">                                     EXPECT_NONE, EXPECT_NONE]);</span>
<a href="#l83.105"></a><span id="l83.105">     aCalendar.addItem(item, null);</span>
<a href="#l83.106"></a><span id="l83.106"> }</span>
<a href="#l83.107"></a><span id="l83.107"> </span>
<a href="#l83.108"></a><span id="l83.108"> function doModifyItemTest(aCalendar) {</span>
<a href="#l83.109"></a><span id="l83.109">     let item, alarm;</span>
<a href="#l83.110"></a><span id="l83.110"> </span>
<a href="#l83.111"></a><span id="l83.111">     // begin with item starting before the alarm date range</span>
<a href="#l83.112"></a><span id="l83.112" class="difflineminus">-    let dt = cal.now();</span>
<a href="#l83.113"></a><span id="l83.113" class="difflineminus">-    dt.day -= 32;</span>
<a href="#l83.114"></a><span id="l83.114" class="difflineminus">-    [item, alarm] = createEventWithAlarm(aCalendar, dt, dt, &quot;PT0S&quot;);</span>
<a href="#l83.115"></a><span id="l83.115" class="difflineplus">+    let date = cal.now();</span>
<a href="#l83.116"></a><span id="l83.116" class="difflineplus">+    date.day -= 32;</span>
<a href="#l83.117"></a><span id="l83.117" class="difflineplus">+    [item, alarm] = createEventWithAlarm(aCalendar, date, date, &quot;PT0S&quot;);</span>
<a href="#l83.118"></a><span id="l83.118">     aCalendar.addItem(item, null);</span>
<a href="#l83.119"></a><span id="l83.119">     alarmObserver.expectResult(aCalendar, item, alarm, EXPECT_NONE);</span>
<a href="#l83.120"></a><span id="l83.120">     alarmObserver.checkExpected();</span>
<a href="#l83.121"></a><span id="l83.121"> </span>
<a href="#l83.122"></a><span id="l83.122">     // move event into the fired range</span>
<a href="#l83.123"></a><span id="l83.123">     let oldItem = item.clone();</span>
<a href="#l83.124"></a><span id="l83.124" class="difflineminus">-    dt.day += 31;</span>
<a href="#l83.125"></a><span id="l83.125" class="difflineminus">-    item.startDate = dt.clone();</span>
<a href="#l83.126"></a><span id="l83.126" class="difflineplus">+    date.day += 31;</span>
<a href="#l83.127"></a><span id="l83.127" class="difflineplus">+    item.startDate = date.clone();</span>
<a href="#l83.128"></a><span id="l83.128">     item.generation++;</span>
<a href="#l83.129"></a><span id="l83.129">     aCalendar.modifyItem(item, oldItem, null);</span>
<a href="#l83.130"></a><span id="l83.130">     alarmObserver.expectResult(aCalendar, item, alarm, EXPECT_FIRED);</span>
<a href="#l83.131"></a><span id="l83.131">     alarmObserver.checkExpected();</span>
<a href="#l83.132"></a><span id="l83.132"> </span>
<a href="#l83.133"></a><span id="l83.133">     // move event into the timer range</span>
<a href="#l83.134"></a><span id="l83.134">     oldItem = item.clone();</span>
<a href="#l83.135"></a><span id="l83.135" class="difflineminus">-    dt.hour += 25;</span>
<a href="#l83.136"></a><span id="l83.136" class="difflineminus">-    item.startDate = dt.clone();</span>
<a href="#l83.137"></a><span id="l83.137" class="difflineplus">+    date.hour += 25;</span>
<a href="#l83.138"></a><span id="l83.138" class="difflineplus">+    item.startDate = date.clone();</span>
<a href="#l83.139"></a><span id="l83.139">     item.generation++;</span>
<a href="#l83.140"></a><span id="l83.140">     aCalendar.modifyItem(item, oldItem, null);</span>
<a href="#l83.141"></a><span id="l83.141">     alarmObserver.expectResult(aCalendar, item, alarm, EXPECT_TIMER);</span>
<a href="#l83.142"></a><span id="l83.142">     alarmObserver.checkExpected();</span>
<a href="#l83.143"></a><span id="l83.143"> </span>
<a href="#l83.144"></a><span id="l83.144">     // move event past the timer range</span>
<a href="#l83.145"></a><span id="l83.145">     oldItem = item.clone();</span>
<a href="#l83.146"></a><span id="l83.146" class="difflineminus">-    dt.hour += 6;</span>
<a href="#l83.147"></a><span id="l83.147" class="difflineminus">-    item.startDate = dt.clone();</span>
<a href="#l83.148"></a><span id="l83.148" class="difflineplus">+    date.hour += 6;</span>
<a href="#l83.149"></a><span id="l83.149" class="difflineplus">+    item.startDate = date.clone();</span>
<a href="#l83.150"></a><span id="l83.150">     item.generation++;</span>
<a href="#l83.151"></a><span id="l83.151">     aCalendar.modifyItem(item, oldItem, null);</span>
<a href="#l83.152"></a><span id="l83.152">     alarmObserver.expectResult(aCalendar, item, alarm, EXPECT_NONE);</span>
<a href="#l83.153"></a><span id="l83.153">     alarmObserver.checkExpected();</span>
<a href="#l83.154"></a><span id="l83.154"> }</span>
<a href="#l83.155"></a><span id="l83.155"> </span>
<a href="#l83.156"></a><span id="l83.156"> function doDeleteItemTest(aCalendar) {</span>
<a href="#l83.157"></a><span id="l83.157">     let item, alarm;</span>
<a href="#l83.158"></a><span id="l83.158">     let item2, alarm2;</span>
<a href="#l83.159"></a><span id="l83.159"> </span>
<a href="#l83.160"></a><span id="l83.160">     // create a fired alarm and a timer</span>
<a href="#l83.161"></a><span id="l83.161" class="difflineminus">-    let dt = cal.now();</span>
<a href="#l83.162"></a><span id="l83.162" class="difflineminus">-    [item, alarm] = createEventWithAlarm(aCalendar, dt, dt, &quot;-PT5M&quot;);</span>
<a href="#l83.163"></a><span id="l83.163" class="difflineminus">-    [item2, alarm2] = createEventWithAlarm(aCalendar, dt, dt, &quot;PT1H&quot;);</span>
<a href="#l83.164"></a><span id="l83.164" class="difflineplus">+    let date = cal.now();</span>
<a href="#l83.165"></a><span id="l83.165" class="difflineplus">+    [item, alarm] = createEventWithAlarm(aCalendar, date, date, &quot;-PT5M&quot;);</span>
<a href="#l83.166"></a><span id="l83.166" class="difflineplus">+    [item2, alarm2] = createEventWithAlarm(aCalendar, date, date, &quot;PT1H&quot;);</span>
<a href="#l83.167"></a><span id="l83.167">     aCalendar.addItem(item, null);</span>
<a href="#l83.168"></a><span id="l83.168">     aCalendar.addItem(item2, null);</span>
<a href="#l83.169"></a><span id="l83.169">     alarmObserver.expectResult(aCalendar, item, alarm, EXPECT_FIRED);</span>
<a href="#l83.170"></a><span id="l83.170">     alarmObserver.expectResult(aCalendar, item2, alarm2, EXPECT_TIMER);</span>
<a href="#l83.171"></a><span id="l83.171">     alarmObserver.checkExpected();</span>
<a href="#l83.172"></a><span id="l83.172"> </span>
<a href="#l83.173"></a><span id="l83.173">     // item deletion should clear the fired alarm and timer</span>
<a href="#l83.174"></a><span id="l83.174">     aCalendar.deleteItem(item, null);</span>
<a href="#l83.175"></a><span id="l83.175" class="difflineat">@@ -288,19 +288,19 @@ function doDeleteItemTest(aCalendar) {</span>
<a href="#l83.176"></a><span id="l83.176">     alarmObserver.checkExpected();</span>
<a href="#l83.177"></a><span id="l83.177"> }</span>
<a href="#l83.178"></a><span id="l83.178"> </span>
<a href="#l83.179"></a><span id="l83.179"> function doAcknowledgeTest(aCalendar) {</span>
<a href="#l83.180"></a><span id="l83.180">     let item, alarm;</span>
<a href="#l83.181"></a><span id="l83.181">     let item2, alarm2;</span>
<a href="#l83.182"></a><span id="l83.182"> </span>
<a href="#l83.183"></a><span id="l83.183">     // create the fired alarms</span>
<a href="#l83.184"></a><span id="l83.184" class="difflineminus">-    let dt = cal.now();</span>
<a href="#l83.185"></a><span id="l83.185" class="difflineminus">-    [item, alarm] = createEventWithAlarm(aCalendar, dt, dt, &quot;-PT5M&quot;);</span>
<a href="#l83.186"></a><span id="l83.186" class="difflineminus">-    [item2, alarm2] = createEventWithAlarm(aCalendar, dt, dt, &quot;-PT5M&quot;);</span>
<a href="#l83.187"></a><span id="l83.187" class="difflineplus">+    let date = cal.now();</span>
<a href="#l83.188"></a><span id="l83.188" class="difflineplus">+    [item, alarm] = createEventWithAlarm(aCalendar, date, date, &quot;-PT5M&quot;);</span>
<a href="#l83.189"></a><span id="l83.189" class="difflineplus">+    [item2, alarm2] = createEventWithAlarm(aCalendar, date, date, &quot;-PT5M&quot;);</span>
<a href="#l83.190"></a><span id="l83.190">     aCalendar.addItem(item, null);</span>
<a href="#l83.191"></a><span id="l83.191">     aCalendar.addItem(item2, null);</span>
<a href="#l83.192"></a><span id="l83.192">     alarmObserver.expectResult(aCalendar, item, alarm, EXPECT_FIRED);</span>
<a href="#l83.193"></a><span id="l83.193">     alarmObserver.expectResult(aCalendar, item2, alarm2, EXPECT_FIRED);</span>
<a href="#l83.194"></a><span id="l83.194">     alarmObserver.checkExpected();</span>
<a href="#l83.195"></a><span id="l83.195"> </span>
<a href="#l83.196"></a><span id="l83.196">     // test snooze alarm</span>
<a href="#l83.197"></a><span id="l83.197">     alarmObserver.service.snoozeAlarm(item, alarm, cal.createDuration(&quot;PT1H&quot;));</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l84.1"></a><span id="l84.1" class="difflineminus">--- a/calendar/test/unit/test_attendee.js</span>
<a href="#l84.2"></a><span id="l84.2" class="difflineplus">+++ b/calendar/test/unit/test_attendee.js</span>
<a href="#l84.3"></a><span id="l84.3" class="difflineat">@@ -43,75 +43,75 @@ function test_values() {</span>
<a href="#l84.4"></a><span id="l84.4">                 a[properties[i]] = old + 1;</span>
<a href="#l84.5"></a><span id="l84.5">             }, /Can not modify immutable data container/);</span>
<a href="#l84.6"></a><span id="l84.6"> </span>
<a href="#l84.7"></a><span id="l84.7">             equal(a[properties[i]], old);</span>
<a href="#l84.8"></a><span id="l84.8">         }</span>
<a href="#l84.9"></a><span id="l84.9">     }</span>
<a href="#l84.10"></a><span id="l84.10"> </span>
<a href="#l84.11"></a><span id="l84.11">     // Create Attendee</span>
<a href="#l84.12"></a><span id="l84.12" class="difflineminus">-    let a1 = cal.createAttendee();</span>
<a href="#l84.13"></a><span id="l84.13" class="difflineplus">+    let attendee1 = cal.createAttendee();</span>
<a href="#l84.14"></a><span id="l84.14">     // Testing attendee set/get.</span>
<a href="#l84.15"></a><span id="l84.15">     let properties = [&quot;id&quot;, &quot;commonName&quot;, &quot;rsvp&quot;, &quot;role&quot;, &quot;participationStatus&quot;,</span>
<a href="#l84.16"></a><span id="l84.16">                       &quot;userType&quot;];</span>
<a href="#l84.17"></a><span id="l84.17">     let values = [&quot;myid&quot;, &quot;mycn&quot;, &quot;TRUE&quot;, &quot;CHAIR&quot;, &quot;DECLINED&quot;, &quot;RESOURCE&quot;];</span>
<a href="#l84.18"></a><span id="l84.18">     // Make sure test is valid</span>
<a href="#l84.19"></a><span id="l84.19">     equal(properties.length, values.length);</span>
<a href="#l84.20"></a><span id="l84.20"> </span>
<a href="#l84.21"></a><span id="l84.21">     for (let i = 0; i &lt; properties.length; i++) {</span>
<a href="#l84.22"></a><span id="l84.22" class="difflineminus">-        a1[properties[i]] = values[i];</span>
<a href="#l84.23"></a><span id="l84.23" class="difflineminus">-        equal(a1[properties[i]], values[i]);</span>
<a href="#l84.24"></a><span id="l84.24" class="difflineplus">+        attendee1[properties[i]] = values[i];</span>
<a href="#l84.25"></a><span id="l84.25" class="difflineplus">+        equal(attendee1[properties[i]], values[i]);</span>
<a href="#l84.26"></a><span id="l84.26">     }</span>
<a href="#l84.27"></a><span id="l84.27"> </span>
<a href="#l84.28"></a><span id="l84.28">     // Create event</span>
<a href="#l84.29"></a><span id="l84.29">     let event = cal.createEvent();</span>
<a href="#l84.30"></a><span id="l84.30"> </span>
<a href="#l84.31"></a><span id="l84.31">     // Add attendee to event</span>
<a href="#l84.32"></a><span id="l84.32" class="difflineminus">-    event.addAttendee(a1);</span>
<a href="#l84.33"></a><span id="l84.33" class="difflineplus">+    event.addAttendee(attendee1);</span>
<a href="#l84.34"></a><span id="l84.34"> </span>
<a href="#l84.35"></a><span id="l84.35">     // Add 2nd attendee to event.</span>
<a href="#l84.36"></a><span id="l84.36" class="difflineminus">-    let a2 = cal.createAttendee();</span>
<a href="#l84.37"></a><span id="l84.37" class="difflineminus">-    a2.id = &quot;myid2&quot;;</span>
<a href="#l84.38"></a><span id="l84.38" class="difflineminus">-    event.addAttendee(a2);</span>
<a href="#l84.39"></a><span id="l84.39" class="difflineplus">+    let attendee2 = cal.createAttendee();</span>
<a href="#l84.40"></a><span id="l84.40" class="difflineplus">+    attendee2.id = &quot;myid2&quot;;</span>
<a href="#l84.41"></a><span id="l84.41" class="difflineplus">+    event.addAttendee(attendee2);</span>
<a href="#l84.42"></a><span id="l84.42"> </span>
<a href="#l84.43"></a><span id="l84.43">     // Finding by ID</span>
<a href="#l84.44"></a><span id="l84.44" class="difflineminus">-    findById(event, &quot;myid&quot;, a1);</span>
<a href="#l84.45"></a><span id="l84.45" class="difflineminus">-    findById(event, &quot;myid2&quot;, a2);</span>
<a href="#l84.46"></a><span id="l84.46" class="difflineplus">+    findById(event, &quot;myid&quot;, attendee1);</span>
<a href="#l84.47"></a><span id="l84.47" class="difflineplus">+    findById(event, &quot;myid2&quot;, attendee2);</span>
<a href="#l84.48"></a><span id="l84.48"> </span>
<a href="#l84.49"></a><span id="l84.49" class="difflineminus">-    findAttendeesInResults(event, [a1, a2]);</span>
<a href="#l84.50"></a><span id="l84.50" class="difflineplus">+    findAttendeesInResults(event, [attendee1, attendee2]);</span>
<a href="#l84.51"></a><span id="l84.51"> </span>
<a href="#l84.52"></a><span id="l84.52">     // Making attendee immutable</span>
<a href="#l84.53"></a><span id="l84.53" class="difflineminus">-    a1.makeImmutable();</span>
<a href="#l84.54"></a><span id="l84.54" class="difflineminus">-    testImmutability(a1, properties);</span>
<a href="#l84.55"></a><span id="l84.55" class="difflineplus">+    attendee1.makeImmutable();</span>
<a href="#l84.56"></a><span id="l84.56" class="difflineplus">+    testImmutability(attendee1, properties);</span>
<a href="#l84.57"></a><span id="l84.57">     // Testing cascaded immutability (event -&gt; attendee)</span>
<a href="#l84.58"></a><span id="l84.58">     event.makeImmutable();</span>
<a href="#l84.59"></a><span id="l84.59" class="difflineminus">-    testImmutability(a2, properties);</span>
<a href="#l84.60"></a><span id="l84.60" class="difflineplus">+    testImmutability(attendee2, properties);</span>
<a href="#l84.61"></a><span id="l84.61"> </span>
<a href="#l84.62"></a><span id="l84.62">     // Testing cloning</span>
<a href="#l84.63"></a><span id="l84.63" class="difflineminus">-    let ec = event.clone();</span>
<a href="#l84.64"></a><span id="l84.64" class="difflineminus">-    let clonedatts = ec.getAttendees({});</span>
<a href="#l84.65"></a><span id="l84.65" class="difflineplus">+    let eventClone = event.clone();</span>
<a href="#l84.66"></a><span id="l84.66" class="difflineplus">+    let clonedatts = eventClone.getAttendees({});</span>
<a href="#l84.67"></a><span id="l84.67">     let atts = event.getAttendees({});</span>
<a href="#l84.68"></a><span id="l84.68">     equal(atts.length, clonedatts.length);</span>
<a href="#l84.69"></a><span id="l84.69"> </span>
<a href="#l84.70"></a><span id="l84.70">     for (let i = 0; i &lt; clonedatts.length; i++) {</span>
<a href="#l84.71"></a><span id="l84.71">         // The attributes should not be equal</span>
<a href="#l84.72"></a><span id="l84.72">         notEqual(atts[i], clonedatts[i]);</span>
<a href="#l84.73"></a><span id="l84.73">         // But the ids should</span>
<a href="#l84.74"></a><span id="l84.74">         equal(atts[i].id, clonedatts[i].id);</span>
<a href="#l84.75"></a><span id="l84.75">     }</span>
<a href="#l84.76"></a><span id="l84.76"> </span>
<a href="#l84.77"></a><span id="l84.77">     // Make sure organizers are also cloned correctly</span>
<a href="#l84.78"></a><span id="l84.78" class="difflineminus">-    let a3 = cal.createAttendee();</span>
<a href="#l84.79"></a><span id="l84.79" class="difflineminus">-    a3.id = &quot;horst&quot;;</span>
<a href="#l84.80"></a><span id="l84.80" class="difflineminus">-    a3.isOrganizer = true;</span>
<a href="#l84.81"></a><span id="l84.81" class="difflineminus">-    let a4 = a3.clone();</span>
<a href="#l84.82"></a><span id="l84.82" class="difflineplus">+    let attendee3 = cal.createAttendee();</span>
<a href="#l84.83"></a><span id="l84.83" class="difflineplus">+    attendee3.id = &quot;horst&quot;;</span>
<a href="#l84.84"></a><span id="l84.84" class="difflineplus">+    attendee3.isOrganizer = true;</span>
<a href="#l84.85"></a><span id="l84.85" class="difflineplus">+    let attendee4 = attendee3.clone();</span>
<a href="#l84.86"></a><span id="l84.86"> </span>
<a href="#l84.87"></a><span id="l84.87" class="difflineminus">-    ok(a4.isOrganizer);</span>
<a href="#l84.88"></a><span id="l84.88" class="difflineminus">-    a3.isOrganizer = false;</span>
<a href="#l84.89"></a><span id="l84.89" class="difflineminus">-    ok(a4.isOrganizer);</span>
<a href="#l84.90"></a><span id="l84.90" class="difflineplus">+    ok(attendee4.isOrganizer);</span>
<a href="#l84.91"></a><span id="l84.91" class="difflineplus">+    attendee3.isOrganizer = false;</span>
<a href="#l84.92"></a><span id="l84.92" class="difflineplus">+    ok(attendee4.isOrganizer);</span>
<a href="#l84.93"></a><span id="l84.93"> }</span>
<a href="#l84.94"></a><span id="l84.94"> </span>
<a href="#l84.95"></a><span id="l84.95"> function test_serialize() {</span>
<a href="#l84.96"></a><span id="l84.96">     let a = cal.createAttendee();</span>
<a href="#l84.97"></a><span id="l84.97"> </span>
<a href="#l84.98"></a><span id="l84.98">     throws(() =&gt; {</span>
<a href="#l84.99"></a><span id="l84.99">         // eslint-disable-next-line no-unused-expressions</span>
<a href="#l84.100"></a><span id="l84.100">         a.icalProperty;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l85.1"></a><span id="l85.1" class="difflineminus">--- a/calendar/test/unit/test_bug1204255.js</span>
<a href="#l85.2"></a><span id="l85.2" class="difflineplus">+++ b/calendar/test/unit/test_bug1204255.js</span>
<a href="#l85.3"></a><span id="l85.3" class="difflineat">@@ -8,65 +8,65 @@ function run_test() {</span>
<a href="#l85.4"></a><span id="l85.4">     // Test attendee duplicate handling for bug 1204255</span>
<a href="#l85.5"></a><span id="l85.5">     test_newAttendee();</span>
<a href="#l85.6"></a><span id="l85.6">     test_fromICS();</span>
<a href="#l85.7"></a><span id="l85.7"> }</span>
<a href="#l85.8"></a><span id="l85.8"> </span>
<a href="#l85.9"></a><span id="l85.9"> function test_newAttendee() {</span>
<a href="#l85.10"></a><span id="l85.10">     let data = [{</span>
<a href="#l85.11"></a><span id="l85.11">         input: [</span>
<a href="#l85.12"></a><span id="l85.12" class="difflineminus">-            { id: &quot;user2@example.net&quot;, partstat: &quot;NEEDS-ACTION&quot;, cn: &quot;NOT PREFIXED&quot; },</span>
<a href="#l85.13"></a><span id="l85.13" class="difflineminus">-            { id: &quot;mailto:user2@example.net&quot;, partstat: &quot;NEEDS-ACTION&quot;, cn: &quot;PREFIXED&quot; }</span>
<a href="#l85.14"></a><span id="l85.14" class="difflineplus">+            { id: &quot;user2@example.net&quot;, partstat: &quot;NEEDS-ACTION&quot;, cname: &quot;NOT PREFIXED&quot; },</span>
<a href="#l85.15"></a><span id="l85.15" class="difflineplus">+            { id: &quot;mailto:user2@example.net&quot;, partstat: &quot;NEEDS-ACTION&quot;, cname: &quot;PREFIXED&quot; }</span>
<a href="#l85.16"></a><span id="l85.16">         ],</span>
<a href="#l85.17"></a><span id="l85.17" class="difflineminus">-        expected: { id: &quot;mailto:user2@example.net&quot;, partstat: &quot;NEEDS-ACTION&quot;, cn: &quot;PREFIXED&quot; }</span>
<a href="#l85.18"></a><span id="l85.18" class="difflineplus">+        expected: { id: &quot;mailto:user2@example.net&quot;, partstat: &quot;NEEDS-ACTION&quot;, cname: &quot;PREFIXED&quot; }</span>
<a href="#l85.19"></a><span id="l85.19">     }, {</span>
<a href="#l85.20"></a><span id="l85.20">         input: [</span>
<a href="#l85.21"></a><span id="l85.21" class="difflineminus">-            { id: &quot;mailto:user3@example.net&quot;, partstat: &quot;NEEDS-ACTION&quot;, cn: &quot;PREFIXED&quot; },</span>
<a href="#l85.22"></a><span id="l85.22" class="difflineminus">-            { id: &quot;user3@example.net&quot;, partstat: &quot;NEEDS-ACTION&quot;, cn: &quot;NOT PREFIXED&quot; }</span>
<a href="#l85.23"></a><span id="l85.23" class="difflineplus">+            { id: &quot;mailto:user3@example.net&quot;, partstat: &quot;NEEDS-ACTION&quot;, cname: &quot;PREFIXED&quot; },</span>
<a href="#l85.24"></a><span id="l85.24" class="difflineplus">+            { id: &quot;user3@example.net&quot;, partstat: &quot;NEEDS-ACTION&quot;, cname: &quot;NOT PREFIXED&quot; }</span>
<a href="#l85.25"></a><span id="l85.25">         ],</span>
<a href="#l85.26"></a><span id="l85.26" class="difflineminus">-        expected: { id: &quot;mailto:user3@example.net&quot;, partstat: &quot;NEEDS-ACTION&quot;, cn: &quot;NOT PREFIXED&quot; }</span>
<a href="#l85.27"></a><span id="l85.27" class="difflineplus">+        expected: { id: &quot;mailto:user3@example.net&quot;, partstat: &quot;NEEDS-ACTION&quot;, cname: &quot;NOT PREFIXED&quot; }</span>
<a href="#l85.28"></a><span id="l85.28">     }, {</span>
<a href="#l85.29"></a><span id="l85.29">         input: [</span>
<a href="#l85.30"></a><span id="l85.30" class="difflineminus">-            { id: &quot;mailto:user4@example.net&quot;, partstat: &quot;ACCEPTED&quot;, cn: &quot;PREFIXED&quot; },</span>
<a href="#l85.31"></a><span id="l85.31" class="difflineminus">-            { id: &quot;user4@example.net&quot;, partstat: &quot;TENTATIVE&quot;, cn: &quot;NOT PREFIXED&quot; }</span>
<a href="#l85.32"></a><span id="l85.32" class="difflineplus">+            { id: &quot;mailto:user4@example.net&quot;, partstat: &quot;ACCEPTED&quot;, cname: &quot;PREFIXED&quot; },</span>
<a href="#l85.33"></a><span id="l85.33" class="difflineplus">+            { id: &quot;user4@example.net&quot;, partstat: &quot;TENTATIVE&quot;, cname: &quot;NOT PREFIXED&quot; }</span>
<a href="#l85.34"></a><span id="l85.34">         ],</span>
<a href="#l85.35"></a><span id="l85.35" class="difflineminus">-        expected: { id: &quot;mailto:user4@example.net&quot;, partstat: &quot;ACCEPTED&quot;, cn: &quot;PREFIXED&quot; }</span>
<a href="#l85.36"></a><span id="l85.36" class="difflineplus">+        expected: { id: &quot;mailto:user4@example.net&quot;, partstat: &quot;ACCEPTED&quot;, cname: &quot;PREFIXED&quot; }</span>
<a href="#l85.37"></a><span id="l85.37">     }, {</span>
<a href="#l85.38"></a><span id="l85.38">         input: [</span>
<a href="#l85.39"></a><span id="l85.39" class="difflineminus">-            { id: &quot;user5@example.net&quot;, partstat: &quot;TENTATIVE&quot;, cn: &quot;NOT PREFIXED&quot; },</span>
<a href="#l85.40"></a><span id="l85.40" class="difflineminus">-            { id: &quot;mailto:user5@example.net&quot;, partstat: &quot;ACCEPTED&quot;, cn: &quot;PREFIXED&quot; }</span>
<a href="#l85.41"></a><span id="l85.41" class="difflineplus">+            { id: &quot;user5@example.net&quot;, partstat: &quot;TENTATIVE&quot;, cname: &quot;NOT PREFIXED&quot; },</span>
<a href="#l85.42"></a><span id="l85.42" class="difflineplus">+            { id: &quot;mailto:user5@example.net&quot;, partstat: &quot;ACCEPTED&quot;, cname: &quot;PREFIXED&quot; }</span>
<a href="#l85.43"></a><span id="l85.43">         ],</span>
<a href="#l85.44"></a><span id="l85.44" class="difflineminus">-        expected: { id: &quot;mailto:user5@example.net&quot;, partstat: &quot;TENTATIVE&quot;, cn: &quot;NOT PREFIXED&quot; }</span>
<a href="#l85.45"></a><span id="l85.45" class="difflineplus">+        expected: { id: &quot;mailto:user5@example.net&quot;, partstat: &quot;TENTATIVE&quot;, cname: &quot;NOT PREFIXED&quot; }</span>
<a href="#l85.46"></a><span id="l85.46">     }, {</span>
<a href="#l85.47"></a><span id="l85.47">         input: [</span>
<a href="#l85.48"></a><span id="l85.48" class="difflineminus">-            { id: &quot;user6@example.net&quot;, partstat: &quot;DECLINED&quot;, cn: &quot;NOT PREFIXED&quot; },</span>
<a href="#l85.49"></a><span id="l85.49" class="difflineminus">-            { id: &quot;mailto:user6@example.net&quot;, partstat: &quot;TENTATIVE&quot;, cn: &quot;PREFIXED&quot; }</span>
<a href="#l85.50"></a><span id="l85.50" class="difflineplus">+            { id: &quot;user6@example.net&quot;, partstat: &quot;DECLINED&quot;, cname: &quot;NOT PREFIXED&quot; },</span>
<a href="#l85.51"></a><span id="l85.51" class="difflineplus">+            { id: &quot;mailto:user6@example.net&quot;, partstat: &quot;TENTATIVE&quot;, cname: &quot;PREFIXED&quot; }</span>
<a href="#l85.52"></a><span id="l85.52">         ],</span>
<a href="#l85.53"></a><span id="l85.53" class="difflineminus">-        expected: { id: &quot;mailto:user6@example.net&quot;, partstat: &quot;DECLINED&quot;, cn: &quot;NOT PREFIXED&quot; }</span>
<a href="#l85.54"></a><span id="l85.54" class="difflineplus">+        expected: { id: &quot;mailto:user6@example.net&quot;, partstat: &quot;DECLINED&quot;, cname: &quot;NOT PREFIXED&quot; }</span>
<a href="#l85.55"></a><span id="l85.55">     }, {</span>
<a href="#l85.56"></a><span id="l85.56">         input: [</span>
<a href="#l85.57"></a><span id="l85.57" class="difflineminus">-            { id: &quot;user7@example.net&quot;, partstat: &quot;TENTATIVE&quot;, cn: &quot;NOT PREFIXED&quot; },</span>
<a href="#l85.58"></a><span id="l85.58" class="difflineminus">-            { id: &quot;mailto:user7@example.net&quot;, partstat: &quot;DECLINED&quot;, cn: &quot;PREFIXED&quot; }</span>
<a href="#l85.59"></a><span id="l85.59" class="difflineplus">+            { id: &quot;user7@example.net&quot;, partstat: &quot;TENTATIVE&quot;, cname: &quot;NOT PREFIXED&quot; },</span>
<a href="#l85.60"></a><span id="l85.60" class="difflineplus">+            { id: &quot;mailto:user7@example.net&quot;, partstat: &quot;DECLINED&quot;, cname: &quot;PREFIXED&quot; }</span>
<a href="#l85.61"></a><span id="l85.61">         ],</span>
<a href="#l85.62"></a><span id="l85.62" class="difflineminus">-        expected: { id: &quot;mailto:user7@example.net&quot;, partstat: &quot;DECLINED&quot;, cn: &quot;PREFIXED&quot; }</span>
<a href="#l85.63"></a><span id="l85.63" class="difflineplus">+        expected: { id: &quot;mailto:user7@example.net&quot;, partstat: &quot;DECLINED&quot;, cname: &quot;PREFIXED&quot; }</span>
<a href="#l85.64"></a><span id="l85.64">     }];</span>
<a href="#l85.65"></a><span id="l85.65"> </span>
<a href="#l85.66"></a><span id="l85.66">     let event = cal.createEvent();</span>
<a href="#l85.67"></a><span id="l85.67">     for (let test of data) {</span>
<a href="#l85.68"></a><span id="l85.68">         for (let input of test.input) {</span>
<a href="#l85.69"></a><span id="l85.69">             let attendee = cal.createAttendee();</span>
<a href="#l85.70"></a><span id="l85.70">             attendee.id = input.id;</span>
<a href="#l85.71"></a><span id="l85.71">             attendee.participationStatus = input.partstat;</span>
<a href="#l85.72"></a><span id="l85.72" class="difflineminus">-            attendee.commonName = input.cn;</span>
<a href="#l85.73"></a><span id="l85.73" class="difflineplus">+            attendee.commonName = input.cname;</span>
<a href="#l85.74"></a><span id="l85.74">             event.addAttendee(attendee);</span>
<a href="#l85.75"></a><span id="l85.75">         }</span>
<a href="#l85.76"></a><span id="l85.76">         let readAttendee = event.getAttendeeById(cal.prependMailTo(test.expected.id));</span>
<a href="#l85.77"></a><span id="l85.77">         equal(readAttendee.id, test.expected.id);</span>
<a href="#l85.78"></a><span id="l85.78">         equal(readAttendee.participationStatus, test.expected.partstat, &quot;partstat matches for &quot; + test.expected.id);</span>
<a href="#l85.79"></a><span id="l85.79" class="difflineminus">-        equal(readAttendee.commonName, test.expected.cn, &quot;cn matches for &quot; + test.expected.id);</span>
<a href="#l85.80"></a><span id="l85.80" class="difflineplus">+        equal(readAttendee.commonName, test.expected.cname, &quot;commonName matches for &quot; + test.expected.id);</span>
<a href="#l85.81"></a><span id="l85.81">     }</span>
<a href="#l85.82"></a><span id="l85.82"> }</span>
<a href="#l85.83"></a><span id="l85.83"> </span>
<a href="#l85.84"></a><span id="l85.84"> function test_fromICS() {</span>
<a href="#l85.85"></a><span id="l85.85">     let ics = [</span>
<a href="#l85.86"></a><span id="l85.86">         &quot;BEGIN:VCALENDAR&quot;,</span>
<a href="#l85.87"></a><span id="l85.87">         &quot;PRODID:-//Mozilla.org/NONSGML Mozilla Calendar V1.1//EN&quot;,</span>
<a href="#l85.88"></a><span id="l85.88">         &quot;VERSION:2.0&quot;,</span>
<a href="#l85.89"></a><span id="l85.89" class="difflineat">@@ -94,32 +94,32 @@ function test_fromICS() {</span>
<a href="#l85.90"></a><span id="l85.90"> </span>
<a href="#l85.91"></a><span id="l85.91">         'ATTENDEE;RSVP=TRUE;PARTSTAT=TENTATIVE;CN=&quot;NOT PREFIXED&quot;;ROLE=REQ-PARTICIPANT:user7@example.net',</span>
<a href="#l85.92"></a><span id="l85.92">         'ATTENDEE;RSVP=TRUE;PARTSTAT=DECLINED;CN=&quot;PREFIXED&quot;;ROLE=REQ-PARTICIPANT:mailto:user7@example.net',</span>
<a href="#l85.93"></a><span id="l85.93">         &quot;END:VEVENT&quot;,</span>
<a href="#l85.94"></a><span id="l85.94">         &quot;END:VCALENDAR&quot;</span>
<a href="#l85.95"></a><span id="l85.95">     ].join(&quot;\n&quot;);</span>
<a href="#l85.96"></a><span id="l85.96"> </span>
<a href="#l85.97"></a><span id="l85.97">     let expected = [</span>
<a href="#l85.98"></a><span id="l85.98" class="difflineminus">-        { id: &quot;mailto:user2@example.net&quot;, partstat: &quot;NEEDS-ACTION&quot;, cn: &quot;PREFIXED&quot; },</span>
<a href="#l85.99"></a><span id="l85.99" class="difflineminus">-        { id: &quot;mailto:user3@example.net&quot;, partstat: &quot;NEEDS-ACTION&quot;, cn: &quot;NOT PREFIXED&quot; },</span>
<a href="#l85.100"></a><span id="l85.100" class="difflineminus">-        { id: &quot;mailto:user4@example.net&quot;, partstat: &quot;ACCEPTED&quot;, cn: &quot;PREFIXED&quot; },</span>
<a href="#l85.101"></a><span id="l85.101" class="difflineminus">-        { id: &quot;mailto:user5@example.net&quot;, partstat: &quot;TENTATIVE&quot;, cn: &quot;NOT PREFIXED&quot; },</span>
<a href="#l85.102"></a><span id="l85.102" class="difflineminus">-        { id: &quot;mailto:user6@example.net&quot;, partstat: &quot;DECLINED&quot;, cn: &quot;NOT PREFIXED&quot; },</span>
<a href="#l85.103"></a><span id="l85.103" class="difflineminus">-        { id: &quot;mailto:user7@example.net&quot;, partstat: &quot;DECLINED&quot;, cn: &quot;PREFIXED&quot; }</span>
<a href="#l85.104"></a><span id="l85.104" class="difflineplus">+        { id: &quot;mailto:user2@example.net&quot;, partstat: &quot;NEEDS-ACTION&quot;, cname: &quot;PREFIXED&quot; },</span>
<a href="#l85.105"></a><span id="l85.105" class="difflineplus">+        { id: &quot;mailto:user3@example.net&quot;, partstat: &quot;NEEDS-ACTION&quot;, cname: &quot;NOT PREFIXED&quot; },</span>
<a href="#l85.106"></a><span id="l85.106" class="difflineplus">+        { id: &quot;mailto:user4@example.net&quot;, partstat: &quot;ACCEPTED&quot;, cname: &quot;PREFIXED&quot; },</span>
<a href="#l85.107"></a><span id="l85.107" class="difflineplus">+        { id: &quot;mailto:user5@example.net&quot;, partstat: &quot;TENTATIVE&quot;, cname: &quot;NOT PREFIXED&quot; },</span>
<a href="#l85.108"></a><span id="l85.108" class="difflineplus">+        { id: &quot;mailto:user6@example.net&quot;, partstat: &quot;DECLINED&quot;, cname: &quot;NOT PREFIXED&quot; },</span>
<a href="#l85.109"></a><span id="l85.109" class="difflineplus">+        { id: &quot;mailto:user7@example.net&quot;, partstat: &quot;DECLINED&quot;, cname: &quot;PREFIXED&quot; }</span>
<a href="#l85.110"></a><span id="l85.110">     ];</span>
<a href="#l85.111"></a><span id="l85.111">     let event = createEventFromIcalString(ics);</span>
<a href="#l85.112"></a><span id="l85.112">     let attendees = event.getAttendees({});</span>
<a href="#l85.113"></a><span id="l85.113"> </span>
<a href="#l85.114"></a><span id="l85.114">     // check whether all attendees get returned as expected</span>
<a href="#l85.115"></a><span id="l85.115">     equal(attendees.length, expected.length);</span>
<a href="#l85.116"></a><span id="l85.116">     let count = 0;</span>
<a href="#l85.117"></a><span id="l85.117">     for (let attendee of attendees) {</span>
<a href="#l85.118"></a><span id="l85.118">         for (let exp of expected) {</span>
<a href="#l85.119"></a><span id="l85.119">             if (attendee.id == exp.id) {</span>
<a href="#l85.120"></a><span id="l85.120">                 equal(attendee.participationStatus, exp.partstat, &quot;partstat matches for &quot; + exp.id);</span>
<a href="#l85.121"></a><span id="l85.121" class="difflineminus">-                equal(attendee.commonName, exp.cn, &quot;cn matches for &quot; + exp.id);</span>
<a href="#l85.122"></a><span id="l85.122" class="difflineplus">+                equal(attendee.commonName, exp.cname, &quot;commonName matches for &quot; + exp.id);</span>
<a href="#l85.123"></a><span id="l85.123">                 count++;</span>
<a href="#l85.124"></a><span id="l85.124">             }</span>
<a href="#l85.125"></a><span id="l85.125">         }</span>
<a href="#l85.126"></a><span id="l85.126">     }</span>
<a href="#l85.127"></a><span id="l85.127">     equal(count, expected.length, &quot;all attendees were processed&quot;);</span>
<a href="#l85.128"></a><span id="l85.128"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l86.1"></a><span id="l86.1" class="difflineminus">--- a/calendar/test/unit/test_bug1209399.js</span>
<a href="#l86.2"></a><span id="l86.2" class="difflineplus">+++ b/calendar/test/unit/test_bug1209399.js</span>
<a href="#l86.3"></a><span id="l86.3" class="difflineat">@@ -7,56 +7,56 @@ Components.utils.import(&quot;resource://cale</span>
<a href="#l86.4"></a><span id="l86.4"> function run_test() {</span>
<a href="#l86.5"></a><span id="l86.5">     // Test handling for multiple double quotes leading/trailing to attendee CN for bug 1209399</span>
<a href="#l86.6"></a><span id="l86.6">     test_newAttendee();</span>
<a href="#l86.7"></a><span id="l86.7">     test_fromICS();</span>
<a href="#l86.8"></a><span id="l86.8"> }</span>
<a href="#l86.9"></a><span id="l86.9"> </span>
<a href="#l86.10"></a><span id="l86.10"> function test_newAttendee() {</span>
<a href="#l86.11"></a><span id="l86.11">     let data = [{</span>
<a href="#l86.12"></a><span id="l86.12" class="difflineminus">-        input: { cn: null, id: &quot;mailto:user1@example.net&quot; },</span>
<a href="#l86.13"></a><span id="l86.13" class="difflineminus">-        expected: { cn: null }</span>
<a href="#l86.14"></a><span id="l86.14" class="difflineplus">+        input: { cname: null, id: &quot;mailto:user1@example.net&quot; },</span>
<a href="#l86.15"></a><span id="l86.15" class="difflineplus">+        expected: { cname: null }</span>
<a href="#l86.16"></a><span id="l86.16">     }, {</span>
<a href="#l86.17"></a><span id="l86.17" class="difflineminus">-        input: { cn: &quot;Test2&quot;, id: &quot;mailto:user2@example.net&quot; },</span>
<a href="#l86.18"></a><span id="l86.18" class="difflineminus">-        expected: { cn: &quot;Test2&quot; }</span>
<a href="#l86.19"></a><span id="l86.19" class="difflineplus">+        input: { cname: &quot;Test2&quot;, id: &quot;mailto:user2@example.net&quot; },</span>
<a href="#l86.20"></a><span id="l86.20" class="difflineplus">+        expected: { cname: &quot;Test2&quot; }</span>
<a href="#l86.21"></a><span id="l86.21">     }, {</span>
<a href="#l86.22"></a><span id="l86.22" class="difflineminus">-        input: { cn: '&quot;Test3&quot;', id: &quot;mailto:user3@example.net&quot; },</span>
<a href="#l86.23"></a><span id="l86.23" class="difflineminus">-        expected: { cn: &quot;Test3&quot; }</span>
<a href="#l86.24"></a><span id="l86.24" class="difflineplus">+        input: { cname: '&quot;Test3&quot;', id: &quot;mailto:user3@example.net&quot; },</span>
<a href="#l86.25"></a><span id="l86.25" class="difflineplus">+        expected: { cname: &quot;Test3&quot; }</span>
<a href="#l86.26"></a><span id="l86.26">     }, {</span>
<a href="#l86.27"></a><span id="l86.27" class="difflineminus">-        input: { cn: '&quot;&quot;Test4&quot;&quot;', id: &quot;mailto:user4@example.net&quot; },</span>
<a href="#l86.28"></a><span id="l86.28" class="difflineminus">-        expected: { cn: &quot;Test4&quot; }</span>
<a href="#l86.29"></a><span id="l86.29" class="difflineplus">+        input: { cname: '&quot;&quot;Test4&quot;&quot;', id: &quot;mailto:user4@example.net&quot; },</span>
<a href="#l86.30"></a><span id="l86.30" class="difflineplus">+        expected: { cname: &quot;Test4&quot; }</span>
<a href="#l86.31"></a><span id="l86.31">     }, {</span>
<a href="#l86.32"></a><span id="l86.32" class="difflineminus">-        input: { cn: '&quot;&quot;Test5&quot;', id: &quot;mailto:user5@example.net&quot; },</span>
<a href="#l86.33"></a><span id="l86.33" class="difflineminus">-        expected: { cn: &quot;Test5&quot; }</span>
<a href="#l86.34"></a><span id="l86.34" class="difflineplus">+        input: { cname: '&quot;&quot;Test5&quot;', id: &quot;mailto:user5@example.net&quot; },</span>
<a href="#l86.35"></a><span id="l86.35" class="difflineplus">+        expected: { cname: &quot;Test5&quot; }</span>
<a href="#l86.36"></a><span id="l86.36">     }, {</span>
<a href="#l86.37"></a><span id="l86.37" class="difflineminus">-        input: { cn: '&quot;Test6&quot;&quot;', id: &quot;mailto:user6@example.net&quot; },</span>
<a href="#l86.38"></a><span id="l86.38" class="difflineminus">-        expected: { cn: &quot;Test6&quot; }</span>
<a href="#l86.39"></a><span id="l86.39" class="difflineplus">+        input: { cname: '&quot;Test6&quot;&quot;', id: &quot;mailto:user6@example.net&quot; },</span>
<a href="#l86.40"></a><span id="l86.40" class="difflineplus">+        expected: { cname: &quot;Test6&quot; }</span>
<a href="#l86.41"></a><span id="l86.41">     }, {</span>
<a href="#l86.42"></a><span id="l86.42" class="difflineminus">-        input: { cn: &quot;&quot;, id: &quot;mailto:user7@example.net&quot; },</span>
<a href="#l86.43"></a><span id="l86.43" class="difflineminus">-        expected: { cn: &quot;&quot; }</span>
<a href="#l86.44"></a><span id="l86.44" class="difflineplus">+        input: { cname: &quot;&quot;, id: &quot;mailto:user7@example.net&quot; },</span>
<a href="#l86.45"></a><span id="l86.45" class="difflineplus">+        expected: { cname: &quot;&quot; }</span>
<a href="#l86.46"></a><span id="l86.46">     }, {</span>
<a href="#l86.47"></a><span id="l86.47" class="difflineminus">-        input: { cn: '&quot;&quot;', id: &quot;mailto:user8@example.net&quot; },</span>
<a href="#l86.48"></a><span id="l86.48" class="difflineminus">-        expected: { cn: null }</span>
<a href="#l86.49"></a><span id="l86.49" class="difflineplus">+        input: { cname: '&quot;&quot;', id: &quot;mailto:user8@example.net&quot; },</span>
<a href="#l86.50"></a><span id="l86.50" class="difflineplus">+        expected: { cname: null }</span>
<a href="#l86.51"></a><span id="l86.51">     }, {</span>
<a href="#l86.52"></a><span id="l86.52" class="difflineminus">-        input: { cn: '&quot;&quot;&quot;&quot;', id: &quot;mailto:user9@example.net&quot; },</span>
<a href="#l86.53"></a><span id="l86.53" class="difflineminus">-        expected: { cn: null }</span>
<a href="#l86.54"></a><span id="l86.54" class="difflineplus">+        input: { cname: '&quot;&quot;&quot;&quot;', id: &quot;mailto:user9@example.net&quot; },</span>
<a href="#l86.55"></a><span id="l86.55" class="difflineplus">+        expected: { cname: null }</span>
<a href="#l86.56"></a><span id="l86.56">     }];</span>
<a href="#l86.57"></a><span id="l86.57"> </span>
<a href="#l86.58"></a><span id="l86.58">     let i = 0;</span>
<a href="#l86.59"></a><span id="l86.59">     let event = cal.createEvent();</span>
<a href="#l86.60"></a><span id="l86.60">     for (let test of data) {</span>
<a href="#l86.61"></a><span id="l86.61">         i++;</span>
<a href="#l86.62"></a><span id="l86.62">         let attendee = cal.createAttendee();</span>
<a href="#l86.63"></a><span id="l86.63">         attendee.id = test.input.id;</span>
<a href="#l86.64"></a><span id="l86.64" class="difflineminus">-        attendee.commonName = test.input.cn;</span>
<a href="#l86.65"></a><span id="l86.65" class="difflineplus">+        attendee.commonName = test.input.cname;</span>
<a href="#l86.66"></a><span id="l86.66"> </span>
<a href="#l86.67"></a><span id="l86.67">         event.addAttendee(attendee);</span>
<a href="#l86.68"></a><span id="l86.68">         let readAttendee = event.getAttendeeById(test.input.id);</span>
<a href="#l86.69"></a><span id="l86.69" class="difflineminus">-        equal(readAttendee.commonName, test.expected.cn,</span>
<a href="#l86.70"></a><span id="l86.70" class="difflineminus">-              &quot;Test #&quot; + i + &quot; for cn matching of &quot; + test.input.id);</span>
<a href="#l86.71"></a><span id="l86.71" class="difflineplus">+        equal(readAttendee.commonName, test.expected.cname,</span>
<a href="#l86.72"></a><span id="l86.72" class="difflineplus">+              &quot;Test #&quot; + i + &quot; for commonName matching of &quot; + test.input.id);</span>
<a href="#l86.73"></a><span id="l86.73">     }</span>
<a href="#l86.74"></a><span id="l86.74"> }</span>
<a href="#l86.75"></a><span id="l86.75"> </span>
<a href="#l86.76"></a><span id="l86.76"> function test_fromICS() {</span>
<a href="#l86.77"></a><span id="l86.77">     let ics = [</span>
<a href="#l86.78"></a><span id="l86.78">         &quot;BEGIN:VCALENDAR&quot;,</span>
<a href="#l86.79"></a><span id="l86.79">         &quot;PRODID:-//Mozilla.org/NONSGML Mozilla Calendar V1.1//EN&quot;,</span>
<a href="#l86.80"></a><span id="l86.80">         &quot;VERSION:2.0&quot;,</span>
<a href="#l86.81"></a><span id="l86.81" class="difflineat">@@ -75,24 +75,24 @@ function test_fromICS() {</span>
<a href="#l86.82"></a><span id="l86.82">         'ATTENDEE;RSVP=TRUE;PARTSTAT=NEEDS-ACTION;CN=&quot;&quot;;ROLE=REQ-PARTICIPANT:mailto:user7@example.net',</span>
<a href="#l86.83"></a><span id="l86.83">         'ATTENDEE;RSVP=TRUE;PARTSTAT=NEEDS-ACTION;CN=&quot;&quot;&quot;&quot;;ROLE=REQ-PARTICIPANT:mailto:user8@example.net',</span>
<a href="#l86.84"></a><span id="l86.84"> </span>
<a href="#l86.85"></a><span id="l86.85">         &quot;END:VEVENT&quot;,</span>
<a href="#l86.86"></a><span id="l86.86">         &quot;END:VCALENDAR&quot;</span>
<a href="#l86.87"></a><span id="l86.87">     ].join(&quot;\n&quot;);</span>
<a href="#l86.88"></a><span id="l86.88"> </span>
<a href="#l86.89"></a><span id="l86.89">     let expected = [</span>
<a href="#l86.90"></a><span id="l86.90" class="difflineminus">-        { id: &quot;mailto:user2@example.net&quot;, cn: &quot;Test2&quot; },</span>
<a href="#l86.91"></a><span id="l86.91" class="difflineminus">-        { id: &quot;mailto:user3@example.net&quot;, cn: &quot;Test3&quot; },</span>
<a href="#l86.92"></a><span id="l86.92" class="difflineminus">-        { id: &quot;mailto:user4@example.net&quot;, cn: &quot;&quot; },</span>
<a href="#l86.93"></a><span id="l86.93" class="difflineminus">-        { id: &quot;mailto:user5@example.net&quot;, cn: &quot;&quot; },</span>
<a href="#l86.94"></a><span id="l86.94" class="difflineminus">-        { id: &quot;mailto:user6@example.net&quot;, cn: null },</span>
<a href="#l86.95"></a><span id="l86.95" class="difflineminus">-        { id: &quot;mailto:user7@example.net&quot;, cn: &quot;&quot; },</span>
<a href="#l86.96"></a><span id="l86.96" class="difflineminus">-        { id: &quot;mailto:user8@example.net&quot;, cn: &quot;&quot; }</span>
<a href="#l86.97"></a><span id="l86.97" class="difflineplus">+        { id: &quot;mailto:user2@example.net&quot;, cname: &quot;Test2&quot; },</span>
<a href="#l86.98"></a><span id="l86.98" class="difflineplus">+        { id: &quot;mailto:user3@example.net&quot;, cname: &quot;Test3&quot; },</span>
<a href="#l86.99"></a><span id="l86.99" class="difflineplus">+        { id: &quot;mailto:user4@example.net&quot;, cname: &quot;&quot; },</span>
<a href="#l86.100"></a><span id="l86.100" class="difflineplus">+        { id: &quot;mailto:user5@example.net&quot;, cname: &quot;&quot; },</span>
<a href="#l86.101"></a><span id="l86.101" class="difflineplus">+        { id: &quot;mailto:user6@example.net&quot;, cname: null },</span>
<a href="#l86.102"></a><span id="l86.102" class="difflineplus">+        { id: &quot;mailto:user7@example.net&quot;, cname: &quot;&quot; },</span>
<a href="#l86.103"></a><span id="l86.103" class="difflineplus">+        { id: &quot;mailto:user8@example.net&quot;, cname: &quot;&quot; }</span>
<a href="#l86.104"></a><span id="l86.104">     ];</span>
<a href="#l86.105"></a><span id="l86.105">     let event = createEventFromIcalString(ics);</span>
<a href="#l86.106"></a><span id="l86.106"> </span>
<a href="#l86.107"></a><span id="l86.107">     equal(event.getAttendees({}).length, expected.length, &quot;Check test consistency&quot;);</span>
<a href="#l86.108"></a><span id="l86.108">     for (let exp of expected) {</span>
<a href="#l86.109"></a><span id="l86.109">         let attendee = event.getAttendeeById(exp.id);</span>
<a href="#l86.110"></a><span id="l86.110" class="difflineminus">-        equal(attendee.commonName, exp.cn, &quot;Test for cn matching of &quot; + exp.id);</span>
<a href="#l86.111"></a><span id="l86.111" class="difflineplus">+        equal(attendee.commonName, exp.cname, &quot;Test for commonName matching of &quot; + exp.id);</span>
<a href="#l86.112"></a><span id="l86.112">     }</span>
<a href="#l86.113"></a><span id="l86.113"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l87.1"></a><span id="l87.1" class="difflineminus">--- a/calendar/test/unit/test_bug759324.js</span>
<a href="#l87.2"></a><span id="l87.2" class="difflineplus">+++ b/calendar/test/unit/test_bug759324.js</span>
<a href="#l87.3"></a><span id="l87.3" class="difflineat">@@ -22,46 +22,46 @@ function run_test() {</span>
<a href="#l87.4"></a><span id="l87.4">     let rid = cal.createDateTime(&quot;20120101T010101Z&quot;);</span>
<a href="#l87.5"></a><span id="l87.5">     let rec = item.recurrenceInfo.getOccurrenceFor(rid);</span>
<a href="#l87.6"></a><span id="l87.6">     rec.title = &quot;changed&quot;;</span>
<a href="#l87.7"></a><span id="l87.7">     item.recurrenceInfo.modifyException(rec, true);</span>
<a href="#l87.8"></a><span id="l87.8"> </span>
<a href="#l87.9"></a><span id="l87.9">     do_test_pending();</span>
<a href="#l87.10"></a><span id="l87.10">     storage.addItem(item, { onOperationComplete: checkAddedItem });</span>
<a href="#l87.11"></a><span id="l87.11"> </span>
<a href="#l87.12"></a><span id="l87.12" class="difflineminus">-    function checkAddedItem(c, s, o, i, addedItem) {</span>
<a href="#l87.13"></a><span id="l87.13" class="difflineplus">+    function checkAddedItem(calendar, status, opType, id, addedItem) {</span>
<a href="#l87.14"></a><span id="l87.14">         let seq = addedItem.getProperty(&quot;SEQUENCE&quot;);</span>
<a href="#l87.15"></a><span id="l87.15">         let occ = addedItem.recurrenceInfo.getOccurrenceFor(rid);</span>
<a href="#l87.16"></a><span id="l87.16"> </span>
<a href="#l87.17"></a><span id="l87.17">         equal(seq, 3);</span>
<a href="#l87.18"></a><span id="l87.18">         equal(occ.getProperty(&quot;SEQUENCE&quot;), seq);</span>
<a href="#l87.19"></a><span id="l87.19"> </span>
<a href="#l87.20"></a><span id="l87.20">         let changedItem = addedItem.clone();</span>
<a href="#l87.21"></a><span id="l87.21">         changedItem.setProperty(&quot;SEQUENCE&quot;, parseInt(seq, 10) + 1);</span>
<a href="#l87.22"></a><span id="l87.22"> </span>
<a href="#l87.23"></a><span id="l87.23">         storage.modifyItem(changedItem, addedItem, { onOperationComplete: checkModifiedItem });</span>
<a href="#l87.24"></a><span id="l87.24">     }</span>
<a href="#l87.25"></a><span id="l87.25"> </span>
<a href="#l87.26"></a><span id="l87.26" class="difflineminus">-    function checkModifiedItem(c, s, o, i, changedItem) {</span>
<a href="#l87.27"></a><span id="l87.27" class="difflineplus">+    function checkModifiedItem(calendar, status, opType, id, changedItem) {</span>
<a href="#l87.28"></a><span id="l87.28">         let seq = changedItem.getProperty(&quot;SEQUENCE&quot;);</span>
<a href="#l87.29"></a><span id="l87.29">         let occ = changedItem.recurrenceInfo.getOccurrenceFor(rid);</span>
<a href="#l87.30"></a><span id="l87.30"> </span>
<a href="#l87.31"></a><span id="l87.31">         equal(seq, 4);</span>
<a href="#l87.32"></a><span id="l87.32">         equal(occ.getProperty(&quot;SEQUENCE&quot;), seq);</span>
<a href="#l87.33"></a><span id="l87.33"> </span>
<a href="#l87.34"></a><span id="l87.34">         // Now check with the pref off</span>
<a href="#l87.35"></a><span id="l87.35">         storage.deleteProperty(&quot;capabilities.propagate-sequence&quot;);</span>
<a href="#l87.36"></a><span id="l87.36"> </span>
<a href="#l87.37"></a><span id="l87.37">         let changedItem2 = changedItem.clone();</span>
<a href="#l87.38"></a><span id="l87.38">         changedItem2.setProperty(&quot;SEQUENCE&quot;, parseInt(seq, 10) + 1);</span>
<a href="#l87.39"></a><span id="l87.39"> </span>
<a href="#l87.40"></a><span id="l87.40">         storage.modifyItem(changedItem2, changedItem, { onOperationComplete: checkNormalItem });</span>
<a href="#l87.41"></a><span id="l87.41">     }</span>
<a href="#l87.42"></a><span id="l87.42"> </span>
<a href="#l87.43"></a><span id="l87.43" class="difflineminus">-    function checkNormalItem(c, s, o, i, changedItem) {</span>
<a href="#l87.44"></a><span id="l87.44" class="difflineplus">+    function checkNormalItem(calendar, status, opType, id, changedItem) {</span>
<a href="#l87.45"></a><span id="l87.45">         let seq = changedItem.getProperty(&quot;SEQUENCE&quot;);</span>
<a href="#l87.46"></a><span id="l87.46">         let occ = changedItem.recurrenceInfo.getOccurrenceFor(rid);</span>
<a href="#l87.47"></a><span id="l87.47"> </span>
<a href="#l87.48"></a><span id="l87.48">         equal(seq, 5);</span>
<a href="#l87.49"></a><span id="l87.49">         equal(occ.getProperty(&quot;SEQUENCE&quot;), 4);</span>
<a href="#l87.50"></a><span id="l87.50">         completeTest();</span>
<a href="#l87.51"></a><span id="l87.51">     }</span>
<a href="#l87.52"></a><span id="l87.52"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l88.1"></a><span id="l88.1" class="difflineminus">--- a/calendar/test/unit/test_calutils.js</span>
<a href="#l88.2"></a><span id="l88.2" class="difflineplus">+++ b/calendar/test/unit/test_calutils.js</span>
<a href="#l88.3"></a><span id="l88.3" class="difflineat">@@ -12,97 +12,97 @@ function run_test() {</span>
<a href="#l88.4"></a><span id="l88.4">     resolveDelegation_test();</span>
<a href="#l88.5"></a><span id="l88.5">     validateRecipientList_test();</span>
<a href="#l88.6"></a><span id="l88.6"> }</span>
<a href="#l88.7"></a><span id="l88.7"> </span>
<a href="#l88.8"></a><span id="l88.8"> // tests for calUtils.jsm</span>
<a href="#l88.9"></a><span id="l88.9"> </span>
<a href="#l88.10"></a><span id="l88.10"> function getAttendeeEmail_test() {</span>
<a href="#l88.11"></a><span id="l88.11">     let data = [{</span>
<a href="#l88.12"></a><span id="l88.12" class="difflineminus">-        input: { id: &quot;mailto:first.last@example.net&quot;, cn: &quot;Last, First&quot;, email: null, useCn: true },</span>
<a href="#l88.13"></a><span id="l88.13" class="difflineplus">+        input: { id: &quot;mailto:first.last@example.net&quot;, cname: &quot;Last, First&quot;, email: null, useCn: true },</span>
<a href="#l88.14"></a><span id="l88.14">         expected: &quot;\&quot;Last, First\&quot; &lt;first.last@example.net&gt;&quot;</span>
<a href="#l88.15"></a><span id="l88.15">     }, {</span>
<a href="#l88.16"></a><span id="l88.16" class="difflineminus">-        input: { id: &quot;mailto:first.last@example.net&quot;, cn: &quot;Last; First&quot;, email: null, useCn: true },</span>
<a href="#l88.17"></a><span id="l88.17" class="difflineplus">+        input: { id: &quot;mailto:first.last@example.net&quot;, cname: &quot;Last; First&quot;, email: null, useCn: true },</span>
<a href="#l88.18"></a><span id="l88.18">         expected: &quot;\&quot;Last; First\&quot; &lt;first.last@example.net&gt;&quot;</span>
<a href="#l88.19"></a><span id="l88.19">     }, {</span>
<a href="#l88.20"></a><span id="l88.20" class="difflineminus">-        input: { id: &quot;mailto:first.last@example.net&quot;, cn: &quot;First Last&quot;, email: null, useCn: true },</span>
<a href="#l88.21"></a><span id="l88.21" class="difflineplus">+        input: { id: &quot;mailto:first.last@example.net&quot;, cname: &quot;First Last&quot;, email: null, useCn: true },</span>
<a href="#l88.22"></a><span id="l88.22">         expected: &quot;First Last &lt;first.last@example.net&gt;&quot;</span>
<a href="#l88.23"></a><span id="l88.23">     }, {</span>
<a href="#l88.24"></a><span id="l88.24" class="difflineminus">-        input: { id: &quot;mailto:first.last@example.net&quot;, cn: &quot;Last, First&quot;, email: null, useCn: false },</span>
<a href="#l88.25"></a><span id="l88.25" class="difflineplus">+        input: { id: &quot;mailto:first.last@example.net&quot;, cname: &quot;Last, First&quot;, email: null, useCn: false },</span>
<a href="#l88.26"></a><span id="l88.26">         expected: &quot;first.last@example.net&quot;</span>
<a href="#l88.27"></a><span id="l88.27">     }, {</span>
<a href="#l88.28"></a><span id="l88.28" class="difflineminus">-        input: { id: &quot;mailto:first.last@example.net&quot;, cn: null, email: null, useCn: true },</span>
<a href="#l88.29"></a><span id="l88.29" class="difflineplus">+        input: { id: &quot;mailto:first.last@example.net&quot;, cname: null, email: null, useCn: true },</span>
<a href="#l88.30"></a><span id="l88.30">         expected: &quot;first.last@example.net&quot;</span>
<a href="#l88.31"></a><span id="l88.31">     }, {</span>
<a href="#l88.32"></a><span id="l88.32" class="difflineminus">-        input: { id: &quot;urn:uuid:first.last.example.net&quot;, cn: null, email: &quot;first.last@example.net&quot;, useCn: false },</span>
<a href="#l88.33"></a><span id="l88.33" class="difflineplus">+        input: { id: &quot;urn:uuid:first.last.example.net&quot;, cname: null, email: &quot;first.last@example.net&quot;, useCn: false },</span>
<a href="#l88.34"></a><span id="l88.34">         expected: &quot;first.last@example.net&quot;</span>
<a href="#l88.35"></a><span id="l88.35">     }, {</span>
<a href="#l88.36"></a><span id="l88.36" class="difflineminus">-        input: { id: &quot;urn:uuid:first.last.example.net&quot;, cn: null, email: &quot;first.last@example.net&quot;, useCn: true },</span>
<a href="#l88.37"></a><span id="l88.37" class="difflineplus">+        input: { id: &quot;urn:uuid:first.last.example.net&quot;, cname: null, email: &quot;first.last@example.net&quot;, useCn: true },</span>
<a href="#l88.38"></a><span id="l88.38">         expected: &quot;first.last@example.net&quot;</span>
<a href="#l88.39"></a><span id="l88.39">     }, {</span>
<a href="#l88.40"></a><span id="l88.40" class="difflineminus">-        input: { id: &quot;urn:uuid:first.last.example.net&quot;, cn: &quot;First Last&quot;, email: &quot;first.last@example.net&quot;, useCn: true },</span>
<a href="#l88.41"></a><span id="l88.41" class="difflineplus">+        input: { id: &quot;urn:uuid:first.last.example.net&quot;, cname: &quot;First Last&quot;, email: &quot;first.last@example.net&quot;, useCn: true },</span>
<a href="#l88.42"></a><span id="l88.42">         expected: &quot;First Last &lt;first.last@example.net&gt;&quot;</span>
<a href="#l88.43"></a><span id="l88.43">     }, {</span>
<a href="#l88.44"></a><span id="l88.44" class="difflineminus">-        input: { id: &quot;urn:uuid:first.last.example.net&quot;, cn: null, email: null, useCn: false },</span>
<a href="#l88.45"></a><span id="l88.45" class="difflineplus">+        input: { id: &quot;urn:uuid:first.last.example.net&quot;, cname: null, email: null, useCn: false },</span>
<a href="#l88.46"></a><span id="l88.46">         expected: &quot;&quot;</span>
<a href="#l88.47"></a><span id="l88.47">     }];</span>
<a href="#l88.48"></a><span id="l88.48">     let i = 0;</span>
<a href="#l88.49"></a><span id="l88.49">     for (let test of data) {</span>
<a href="#l88.50"></a><span id="l88.50">         i++;</span>
<a href="#l88.51"></a><span id="l88.51">         let attendee = cal.createAttendee();</span>
<a href="#l88.52"></a><span id="l88.52">         attendee.id = test.input.id;</span>
<a href="#l88.53"></a><span id="l88.53" class="difflineminus">-        if (test.input.cn) {</span>
<a href="#l88.54"></a><span id="l88.54" class="difflineminus">-            attendee.commonName = test.input.cn;</span>
<a href="#l88.55"></a><span id="l88.55" class="difflineplus">+        if (test.input.cname) {</span>
<a href="#l88.56"></a><span id="l88.56" class="difflineplus">+            attendee.commonName = test.input.cname;</span>
<a href="#l88.57"></a><span id="l88.57">         }</span>
<a href="#l88.58"></a><span id="l88.58">         if (test.input.email) {</span>
<a href="#l88.59"></a><span id="l88.59">             attendee.setProperty(&quot;EMAIL&quot;, test.input.email);</span>
<a href="#l88.60"></a><span id="l88.60">         }</span>
<a href="#l88.61"></a><span id="l88.61">         equal(cal.getAttendeeEmail(attendee, test.input.useCn), test.expected, &quot;(test #&quot; + i + &quot;)&quot;);</span>
<a href="#l88.62"></a><span id="l88.62">     }</span>
<a href="#l88.63"></a><span id="l88.63"> }</span>
<a href="#l88.64"></a><span id="l88.64"> </span>
<a href="#l88.65"></a><span id="l88.65"> function getRecipientList_test() {</span>
<a href="#l88.66"></a><span id="l88.66">     let data = [{</span>
<a href="#l88.67"></a><span id="l88.67" class="difflineminus">-        input: [{ id: &quot;mailto:first@example.net&quot;, cn: null },</span>
<a href="#l88.68"></a><span id="l88.68" class="difflineminus">-                { id: &quot;mailto:second@example.net&quot;, cn: null },</span>
<a href="#l88.69"></a><span id="l88.69" class="difflineminus">-                { id: &quot;mailto:third@example.net&quot;, cn: null }],</span>
<a href="#l88.70"></a><span id="l88.70" class="difflineplus">+        input: [{ id: &quot;mailto:first@example.net&quot;, cname: null },</span>
<a href="#l88.71"></a><span id="l88.71" class="difflineplus">+                { id: &quot;mailto:second@example.net&quot;, cname: null },</span>
<a href="#l88.72"></a><span id="l88.72" class="difflineplus">+                { id: &quot;mailto:third@example.net&quot;, cname: null }],</span>
<a href="#l88.73"></a><span id="l88.73">         expected: &quot;first@example.net, second@example.net, third@example.net&quot;</span>
<a href="#l88.74"></a><span id="l88.74">     }, {</span>
<a href="#l88.75"></a><span id="l88.75" class="difflineminus">-        input: [{ id: &quot;mailto:first@example.net&quot;, cn: &quot;first example&quot; },</span>
<a href="#l88.76"></a><span id="l88.76" class="difflineminus">-                { id: &quot;mailto:second@example.net&quot;, cn: &quot;second example&quot; },</span>
<a href="#l88.77"></a><span id="l88.77" class="difflineminus">-                { id: &quot;mailto:third@example.net&quot;, cn: &quot;third example&quot; }],</span>
<a href="#l88.78"></a><span id="l88.78" class="difflineplus">+        input: [{ id: &quot;mailto:first@example.net&quot;, cname: &quot;first example&quot; },</span>
<a href="#l88.79"></a><span id="l88.79" class="difflineplus">+                { id: &quot;mailto:second@example.net&quot;, cname: &quot;second example&quot; },</span>
<a href="#l88.80"></a><span id="l88.80" class="difflineplus">+                { id: &quot;mailto:third@example.net&quot;, cname: &quot;third example&quot; }],</span>
<a href="#l88.81"></a><span id="l88.81">         expected: &quot;first example &lt;first@example.net&gt;, second example &lt;second@example.net&gt;, &quot; +</span>
<a href="#l88.82"></a><span id="l88.82">                   &quot;third example &lt;third@example.net&gt;&quot;</span>
<a href="#l88.83"></a><span id="l88.83">     }, {</span>
<a href="#l88.84"></a><span id="l88.84" class="difflineminus">-        input: [{ id: &quot;mailto:first@example.net&quot;, cn: &quot;example, first&quot; },</span>
<a href="#l88.85"></a><span id="l88.85" class="difflineminus">-                { id: &quot;mailto:second@example.net&quot;, cn: &quot;example, second&quot; },</span>
<a href="#l88.86"></a><span id="l88.86" class="difflineminus">-                { id: &quot;mailto:third@example.net&quot;, cn: &quot;example, third&quot; }],</span>
<a href="#l88.87"></a><span id="l88.87" class="difflineplus">+        input: [{ id: &quot;mailto:first@example.net&quot;, cname: &quot;example, first&quot; },</span>
<a href="#l88.88"></a><span id="l88.88" class="difflineplus">+                { id: &quot;mailto:second@example.net&quot;, cname: &quot;example, second&quot; },</span>
<a href="#l88.89"></a><span id="l88.89" class="difflineplus">+                { id: &quot;mailto:third@example.net&quot;, cname: &quot;example, third&quot; }],</span>
<a href="#l88.90"></a><span id="l88.90">         expected: &quot;\&quot;example, first\&quot; &lt;first@example.net&gt;, \&quot;example, second\&quot; &lt;second@example.net&gt;, &quot; +</span>
<a href="#l88.91"></a><span id="l88.91">                   &quot;\&quot;example, third\&quot; &lt;third@example.net&gt;&quot;</span>
<a href="#l88.92"></a><span id="l88.92">     }, {</span>
<a href="#l88.93"></a><span id="l88.93" class="difflineminus">-        input: [{ id: &quot;mailto:first@example.net&quot;, cn: null },</span>
<a href="#l88.94"></a><span id="l88.94" class="difflineminus">-                { id: &quot;urn:uuid:second.example.net&quot;, cn: null },</span>
<a href="#l88.95"></a><span id="l88.95" class="difflineminus">-                { id: &quot;mailto:third@example.net&quot;, cn: null }],</span>
<a href="#l88.96"></a><span id="l88.96" class="difflineplus">+        input: [{ id: &quot;mailto:first@example.net&quot;, cname: null },</span>
<a href="#l88.97"></a><span id="l88.97" class="difflineplus">+                { id: &quot;urn:uuid:second.example.net&quot;, cname: null },</span>
<a href="#l88.98"></a><span id="l88.98" class="difflineplus">+                { id: &quot;mailto:third@example.net&quot;, cname: null }],</span>
<a href="#l88.99"></a><span id="l88.99">         expected: &quot;first@example.net, third@example.net&quot;</span>
<a href="#l88.100"></a><span id="l88.100">     }, {</span>
<a href="#l88.101"></a><span id="l88.101" class="difflineminus">-        input: [{ id: &quot;mailto:first@example.net&quot;, cn: &quot;first&quot; },</span>
<a href="#l88.102"></a><span id="l88.102" class="difflineminus">-                { id: &quot;urn:uuid:second.example.net&quot;, cn: &quot;second&quot; },</span>
<a href="#l88.103"></a><span id="l88.103" class="difflineminus">-                { id: &quot;mailto:third@example.net&quot;, cn: &quot;third&quot; }],</span>
<a href="#l88.104"></a><span id="l88.104" class="difflineplus">+        input: [{ id: &quot;mailto:first@example.net&quot;, cname: &quot;first&quot; },</span>
<a href="#l88.105"></a><span id="l88.105" class="difflineplus">+                { id: &quot;urn:uuid:second.example.net&quot;, cname: &quot;second&quot; },</span>
<a href="#l88.106"></a><span id="l88.106" class="difflineplus">+                { id: &quot;mailto:third@example.net&quot;, cname: &quot;third&quot; }],</span>
<a href="#l88.107"></a><span id="l88.107">         expected: &quot;first &lt;first@example.net&gt;, third &lt;third@example.net&gt;&quot;</span>
<a href="#l88.108"></a><span id="l88.108">     }];</span>
<a href="#l88.109"></a><span id="l88.109"> </span>
<a href="#l88.110"></a><span id="l88.110">     let i = 0;</span>
<a href="#l88.111"></a><span id="l88.111">     for (let test of data) {</span>
<a href="#l88.112"></a><span id="l88.112">         i++;</span>
<a href="#l88.113"></a><span id="l88.113">         let attendees = [];</span>
<a href="#l88.114"></a><span id="l88.114">         for (let att of test.input) {</span>
<a href="#l88.115"></a><span id="l88.115">             let attendee = cal.createAttendee();</span>
<a href="#l88.116"></a><span id="l88.116">             attendee.id = att.id;</span>
<a href="#l88.117"></a><span id="l88.117" class="difflineminus">-            if (att.cn) {</span>
<a href="#l88.118"></a><span id="l88.118" class="difflineminus">-                attendee.commonName = att.cn;</span>
<a href="#l88.119"></a><span id="l88.119" class="difflineplus">+            if (att.cname) {</span>
<a href="#l88.120"></a><span id="l88.120" class="difflineplus">+                attendee.commonName = att.cname;</span>
<a href="#l88.121"></a><span id="l88.121">             }</span>
<a href="#l88.122"></a><span id="l88.122">             attendees.push(attendee);</span>
<a href="#l88.123"></a><span id="l88.123">         }</span>
<a href="#l88.124"></a><span id="l88.124">         equal(cal.getRecipientList(attendees), test.expected, &quot;(test #&quot; + i + &quot;)&quot;);</span>
<a href="#l88.125"></a><span id="l88.125">     }</span>
<a href="#l88.126"></a><span id="l88.126"> }</span>
<a href="#l88.127"></a><span id="l88.127"> </span>
<a href="#l88.128"></a><span id="l88.128"> function prependMailTo_test() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l89.1"></a><span id="l89.1" class="difflineminus">--- a/calendar/test/unit/test_datetime.js</span>
<a href="#l89.2"></a><span id="l89.2" class="difflineplus">+++ b/calendar/test/unit/test_datetime.js</span>
<a href="#l89.3"></a><span id="l89.3" class="difflineat">@@ -6,55 +6,55 @@ function run_test() {</span>
<a href="#l89.4"></a><span id="l89.4">     do_calendar_startup(really_run_test);</span>
<a href="#l89.5"></a><span id="l89.5"> }</span>
<a href="#l89.6"></a><span id="l89.6"> </span>
<a href="#l89.7"></a><span id="l89.7"> function really_run_test() {</span>
<a href="#l89.8"></a><span id="l89.8">     function getMozTimezone(tzid) {</span>
<a href="#l89.9"></a><span id="l89.9">         return cal.getTimezoneService().getTimezone(tzid);</span>
<a href="#l89.10"></a><span id="l89.10">     }</span>
<a href="#l89.11"></a><span id="l89.11"> </span>
<a href="#l89.12"></a><span id="l89.12" class="difflineminus">-    let cd = cal.createDateTime();</span>
<a href="#l89.13"></a><span id="l89.13" class="difflineminus">-    cd.resetTo(2005, 10, 13,</span>
<a href="#l89.14"></a><span id="l89.14" class="difflineminus">-               10, 0, 0,</span>
<a href="#l89.15"></a><span id="l89.15" class="difflineminus">-               getMozTimezone(&quot;/mozilla.org/20050126_1/America/Bogota&quot;));</span>
<a href="#l89.16"></a><span id="l89.16" class="difflineplus">+    let date = cal.createDateTime();</span>
<a href="#l89.17"></a><span id="l89.17" class="difflineplus">+    date.resetTo(2005, 10, 13,</span>
<a href="#l89.18"></a><span id="l89.18" class="difflineplus">+                 10, 0, 0,</span>
<a href="#l89.19"></a><span id="l89.19" class="difflineplus">+                 getMozTimezone(&quot;/mozilla.org/20050126_1/America/Bogota&quot;));</span>
<a href="#l89.20"></a><span id="l89.20"> </span>
<a href="#l89.21"></a><span id="l89.21" class="difflineminus">-    equal(cd.hour, 10);</span>
<a href="#l89.22"></a><span id="l89.22" class="difflineminus">-    equal(cd.icalString, &quot;20051113T100000&quot;);</span>
<a href="#l89.23"></a><span id="l89.23" class="difflineplus">+    equal(date.hour, 10);</span>
<a href="#l89.24"></a><span id="l89.24" class="difflineplus">+    equal(date.icalString, &quot;20051113T100000&quot;);</span>
<a href="#l89.25"></a><span id="l89.25"> </span>
<a href="#l89.26"></a><span id="l89.26" class="difflineminus">-    let cd_floating = cd.getInTimezone(cal.floating());</span>
<a href="#l89.27"></a><span id="l89.27" class="difflineminus">-    equal(cd_floating.hour, 10);</span>
<a href="#l89.28"></a><span id="l89.28" class="difflineplus">+    let date_floating = date.getInTimezone(cal.floating());</span>
<a href="#l89.29"></a><span id="l89.29" class="difflineplus">+    equal(date_floating.hour, 10);</span>
<a href="#l89.30"></a><span id="l89.30"> </span>
<a href="#l89.31"></a><span id="l89.31"> </span>
<a href="#l89.32"></a><span id="l89.32" class="difflineminus">-    let cd_utc = cd.getInTimezone(cal.UTC());</span>
<a href="#l89.33"></a><span id="l89.33" class="difflineminus">-    equal(cd_utc.hour, 15);</span>
<a href="#l89.34"></a><span id="l89.34" class="difflineminus">-    equal(cd_utc.icalString, &quot;20051113T150000Z&quot;);</span>
<a href="#l89.35"></a><span id="l89.35" class="difflineplus">+    let date_utc = date.getInTimezone(cal.UTC());</span>
<a href="#l89.36"></a><span id="l89.36" class="difflineplus">+    equal(date_utc.hour, 15);</span>
<a href="#l89.37"></a><span id="l89.37" class="difflineplus">+    equal(date_utc.icalString, &quot;20051113T150000Z&quot;);</span>
<a href="#l89.38"></a><span id="l89.38"> </span>
<a href="#l89.39"></a><span id="l89.39" class="difflineminus">-    cd.hour = 25;</span>
<a href="#l89.40"></a><span id="l89.40" class="difflineminus">-    equal(cd.hour, 1);</span>
<a href="#l89.41"></a><span id="l89.41" class="difflineminus">-    equal(cd.day, 14);</span>
<a href="#l89.42"></a><span id="l89.42" class="difflineplus">+    date.hour = 25;</span>
<a href="#l89.43"></a><span id="l89.43" class="difflineplus">+    equal(date.hour, 1);</span>
<a href="#l89.44"></a><span id="l89.44" class="difflineplus">+    equal(date.day, 14);</span>
<a href="#l89.45"></a><span id="l89.45"> </span>
<a href="#l89.46"></a><span id="l89.46"> </span>
<a href="#l89.47"></a><span id="l89.47">     // Test nativeTime on dates</span>
<a href="#l89.48"></a><span id="l89.48">     // setting .isDate to be true on a date should not change its nativeTime</span>
<a href="#l89.49"></a><span id="l89.49">     // bug 315954,</span>
<a href="#l89.50"></a><span id="l89.50" class="difflineminus">-    cd.hour = 0;</span>
<a href="#l89.51"></a><span id="l89.51" class="difflineminus">-    let cd_allday = cd.clone();</span>
<a href="#l89.52"></a><span id="l89.52" class="difflineminus">-    cd_allday.isDate = true;</span>
<a href="#l89.53"></a><span id="l89.53" class="difflineminus">-    equal(cd.nativeTime, cd_allday.nativeTime);</span>
<a href="#l89.54"></a><span id="l89.54" class="difflineplus">+    date.hour = 0;</span>
<a href="#l89.55"></a><span id="l89.55" class="difflineplus">+    let date_allday = date.clone();</span>
<a href="#l89.56"></a><span id="l89.56" class="difflineplus">+    date_allday.isDate = true;</span>
<a href="#l89.57"></a><span id="l89.57" class="difflineplus">+    equal(date.nativeTime, date_allday.nativeTime);</span>
<a href="#l89.58"></a><span id="l89.58"> </span>
<a href="#l89.59"></a><span id="l89.59">     // Daylight savings test</span>
<a href="#l89.60"></a><span id="l89.60" class="difflineminus">-    cd.resetTo(2006, 2, 26,</span>
<a href="#l89.61"></a><span id="l89.61" class="difflineplus">+    date.resetTo(2006, 2, 26,</span>
<a href="#l89.62"></a><span id="l89.62">                1, 0, 0,</span>
<a href="#l89.63"></a><span id="l89.63">                getMozTimezone(&quot;/mozilla.org/20050126_1/Europe/Amsterdam&quot;));</span>
<a href="#l89.64"></a><span id="l89.64"> </span>
<a href="#l89.65"></a><span id="l89.65" class="difflineminus">-    equal(cd.weekday, 0);</span>
<a href="#l89.66"></a><span id="l89.66" class="difflineminus">-    equal(cd.timezoneOffset, 1 * 3600);</span>
<a href="#l89.67"></a><span id="l89.67" class="difflineplus">+    equal(date.weekday, 0);</span>
<a href="#l89.68"></a><span id="l89.68" class="difflineplus">+    equal(date.timezoneOffset, 1 * 3600);</span>
<a href="#l89.69"></a><span id="l89.69"> </span>
<a href="#l89.70"></a><span id="l89.70" class="difflineminus">-    cd.day += 1;</span>
<a href="#l89.71"></a><span id="l89.71" class="difflineminus">-    equal(cd.timezoneOffset, 2 * 3600);</span>
<a href="#l89.72"></a><span id="l89.72" class="difflineplus">+    date.day += 1;</span>
<a href="#l89.73"></a><span id="l89.73" class="difflineplus">+    equal(date.timezoneOffset, 2 * 3600);</span>
<a href="#l89.74"></a><span id="l89.74"> </span>
<a href="#l89.75"></a><span id="l89.75">     // Bug 398724 - Problems with floating all-day items</span>
<a href="#l89.76"></a><span id="l89.76">     let event = cal.createEvent(&quot;BEGIN:VEVENT\nUID:45674d53-229f-48c6-9f3b-f2b601e7ae4d\nSUMMARY:New Event\nDTSTART;VALUE=DATE:20071003\nDTEND;VALUE=DATE:20071004\nEND:VEVENT&quot;);</span>
<a href="#l89.77"></a><span id="l89.77">     ok(event.startDate.timezone.isFloating);</span>
<a href="#l89.78"></a><span id="l89.78">     ok(event.endDate.timezone.isFloating);</span>
<a href="#l89.79"></a><span id="l89.79"> </span>
<a href="#l89.80"></a><span id="l89.80">     // Bug 392853 - Same times, different timezones, but subtractDate says times are PT0S apart</span>
<a href="#l89.81"></a><span id="l89.81">     const zeroLength = cal.createDuration();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l90.1"></a><span id="l90.1" class="difflineminus">--- a/calendar/test/unit/test_freebusy_service.js</span>
<a href="#l90.2"></a><span id="l90.2" class="difflineplus">+++ b/calendar/test/unit/test_freebusy_service.js</span>
<a href="#l90.3"></a><span id="l90.3" class="difflineat">@@ -109,17 +109,17 @@ function test_cancel() {</span>
<a href="#l90.4"></a><span id="l90.4">     _clearProviders();</span>
<a href="#l90.5"></a><span id="l90.5"> </span>
<a href="#l90.6"></a><span id="l90.6">     let provider = {</span>
<a href="#l90.7"></a><span id="l90.7">         QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calIFreeBusyProvider, Components.interfaces.calIOperation]),</span>
<a href="#l90.8"></a><span id="l90.8">         getFreeBusyIntervals: function(aCalId, aStart, aEnd, aTypes, aListener) {</span>
<a href="#l90.9"></a><span id="l90.9">             Services.tm.currentThread.dispatch({</span>
<a href="#l90.10"></a><span id="l90.10">                 run: function() {</span>
<a href="#l90.11"></a><span id="l90.11">                     dump(&quot;Cancelling freebusy query...&quot;);</span>
<a href="#l90.12"></a><span id="l90.12" class="difflineminus">-                    op.cancel();</span>
<a href="#l90.13"></a><span id="l90.13" class="difflineplus">+                    operation.cancel();</span>
<a href="#l90.14"></a><span id="l90.14">                 }</span>
<a href="#l90.15"></a><span id="l90.15">             }, Components.interfaces.nsIEventTarget.DISPATCH_NORMAL);</span>
<a href="#l90.16"></a><span id="l90.16"> </span>
<a href="#l90.17"></a><span id="l90.17">             // No listener call, we emulate a long running search</span>
<a href="#l90.18"></a><span id="l90.18">             // Do return the operation though</span>
<a href="#l90.19"></a><span id="l90.19">             return this;</span>
<a href="#l90.20"></a><span id="l90.20">         },</span>
<a href="#l90.21"></a><span id="l90.21"> </span>
<a href="#l90.22"></a><span id="l90.22" class="difflineat">@@ -140,21 +140,21 @@ function test_cancel() {</span>
<a href="#l90.23"></a><span id="l90.23">             ok(!provider.cancelCalled);</span>
<a href="#l90.24"></a><span id="l90.24">             do_test_finished();</span>
<a href="#l90.25"></a><span id="l90.25">         }</span>
<a href="#l90.26"></a><span id="l90.26">     };</span>
<a href="#l90.27"></a><span id="l90.27"> </span>
<a href="#l90.28"></a><span id="l90.28">     freebusy.addProvider(provider);</span>
<a href="#l90.29"></a><span id="l90.29"> </span>
<a href="#l90.30"></a><span id="l90.30">     do_test_pending();</span>
<a href="#l90.31"></a><span id="l90.31" class="difflineminus">-    let op = freebusy.getFreeBusyIntervals(&quot;email&quot;,</span>
<a href="#l90.32"></a><span id="l90.32" class="difflineminus">-                                           cal.createDateTime(&quot;20120101T010101&quot;),</span>
<a href="#l90.33"></a><span id="l90.33" class="difflineminus">-                                           cal.createDateTime(&quot;20120102T010101&quot;),</span>
<a href="#l90.34"></a><span id="l90.34" class="difflineminus">-                                           cIFI.BUSY_ALL,</span>
<a href="#l90.35"></a><span id="l90.35" class="difflineminus">-                                           listener);</span>
<a href="#l90.36"></a><span id="l90.36" class="difflineplus">+    let operation = freebusy.getFreeBusyIntervals(&quot;email&quot;,</span>
<a href="#l90.37"></a><span id="l90.37" class="difflineplus">+                                                  cal.createDateTime(&quot;20120101T010101&quot;),</span>
<a href="#l90.38"></a><span id="l90.38" class="difflineplus">+                                                  cal.createDateTime(&quot;20120102T010101&quot;),</span>
<a href="#l90.39"></a><span id="l90.39" class="difflineplus">+                                                  cIFI.BUSY_ALL,</span>
<a href="#l90.40"></a><span id="l90.40" class="difflineplus">+                                                  listener);</span>
<a href="#l90.41"></a><span id="l90.41"> }</span>
<a href="#l90.42"></a><span id="l90.42"> </span>
<a href="#l90.43"></a><span id="l90.43"> // The following functions are not in the interface description and probably</span>
<a href="#l90.44"></a><span id="l90.44"> // don't need to be. Make assumptions about the implementation instead.</span>
<a href="#l90.45"></a><span id="l90.45"> </span>
<a href="#l90.46"></a><span id="l90.46"> function _clearProviders() {</span>
<a href="#l90.47"></a><span id="l90.47">     freebusy.wrappedJSObject.mProviders = new calInterfaceBag(Components.interfaces.calIFreeBusyProvider);</span>
<a href="#l90.48"></a><span id="l90.48"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l91.1"></a><span id="l91.1" class="difflineminus">--- a/calendar/test/unit/test_gdata_provider.js</span>
<a href="#l91.2"></a><span id="l91.2" class="difflineplus">+++ b/calendar/test/unit/test_gdata_provider.js</span>
<a href="#l91.3"></a><span id="l91.3" class="difflineat">@@ -90,19 +90,19 @@ function GDataServer(calendarId, tasksId</span>
<a href="#l91.4"></a><span id="l91.4">     this.resetRequest();</span>
<a href="#l91.5"></a><span id="l91.5"> </span>
<a href="#l91.6"></a><span id="l91.6">     let sessionMgr = getGoogleSessionManager();</span>
<a href="#l91.7"></a><span id="l91.7">     this.session = sessionMgr.getSessionById(&quot;xpcshell&quot;, true);</span>
<a href="#l91.8"></a><span id="l91.8">     this.session.oauth = {</span>
<a href="#l91.9"></a><span id="l91.9">         accessToken: &quot;accessToken&quot;,</span>
<a href="#l91.10"></a><span id="l91.10">         refreshToken: &quot;refreshToken&quot;,</span>
<a href="#l91.11"></a><span id="l91.11">         tokenExpires: Number.MAX_VALUE,</span>
<a href="#l91.12"></a><span id="l91.12" class="difflineminus">-        connect: function(succ, fail, ui, refresh) {</span>
<a href="#l91.13"></a><span id="l91.13" class="difflineplus">+        connect: function(success, failure, withUi, refresh) {</span>
<a href="#l91.14"></a><span id="l91.14">             this.accessToken = &quot;accessToken&quot;;</span>
<a href="#l91.15"></a><span id="l91.15" class="difflineminus">-            succ();</span>
<a href="#l91.16"></a><span id="l91.16" class="difflineplus">+            success();</span>
<a href="#l91.17"></a><span id="l91.17">         }</span>
<a href="#l91.18"></a><span id="l91.18">     };</span>
<a href="#l91.19"></a><span id="l91.19"> }</span>
<a href="#l91.20"></a><span id="l91.20"> </span>
<a href="#l91.21"></a><span id="l91.21"> GDataServer.prototype = {</span>
<a href="#l91.22"></a><span id="l91.22">     items: null,</span>
<a href="#l91.23"></a><span id="l91.23"> </span>
<a href="#l91.24"></a><span id="l91.24">     get baseUri() { return &quot;http://localhost:&quot; + this.server.identity.primaryPort + &quot;/&quot;; },</span>
<a href="#l91.25"></a><span id="l91.25" class="difflineat">@@ -198,20 +198,20 @@ GDataServer.prototype = {</span>
<a href="#l91.26"></a><span id="l91.26">         let calmgr = cal.getCalendarManager();</span>
<a href="#l91.27"></a><span id="l91.27">         let client = calmgr.createCalendar(&quot;gdata&quot;, Services.io.newURI(uri, null, null));</span>
<a href="#l91.28"></a><span id="l91.28">         let uclient = client.wrappedJSObject;</span>
<a href="#l91.29"></a><span id="l91.29">         client.name = &quot;xpcshell&quot;;</span>
<a href="#l91.30"></a><span id="l91.30"> </span>
<a href="#l91.31"></a><span id="l91.31">         // Make sure we catch the last error message in case sync fails</span>
<a href="#l91.32"></a><span id="l91.32">         monkeyPatch(uclient, &quot;replayChangesOn&quot;, (protofunc, aListener) =&gt; {</span>
<a href="#l91.33"></a><span id="l91.33">             protofunc({</span>
<a href="#l91.34"></a><span id="l91.34" class="difflineminus">-              onResult: function(op, detail) {</span>
<a href="#l91.35"></a><span id="l91.35" class="difflineminus">-                uclient._lastStatus = op.status;</span>
<a href="#l91.36"></a><span id="l91.36" class="difflineplus">+              onResult: function(operation, detail) {</span>
<a href="#l91.37"></a><span id="l91.37" class="difflineplus">+                uclient._lastStatus = operation.status;</span>
<a href="#l91.38"></a><span id="l91.38">                 uclient._lastMessage = detail;</span>
<a href="#l91.39"></a><span id="l91.39" class="difflineminus">-                aListener.onResult(op, detail);</span>
<a href="#l91.40"></a><span id="l91.40" class="difflineplus">+                aListener.onResult(operation, detail);</span>
<a href="#l91.41"></a><span id="l91.41">               }</span>
<a href="#l91.42"></a><span id="l91.42">            });</span>
<a href="#l91.43"></a><span id="l91.43">         });</span>
<a href="#l91.44"></a><span id="l91.44"> </span>
<a href="#l91.45"></a><span id="l91.45">         calmgr.registerCalendar(client);</span>
<a href="#l91.46"></a><span id="l91.46">         uclient.mThrottleLimits = {};</span>
<a href="#l91.47"></a><span id="l91.47">         MockConflictPrompt.register();</span>
<a href="#l91.48"></a><span id="l91.48"> </span>
<a href="#l91.49"></a><span id="l91.49" class="difflineat">@@ -219,17 +219,17 @@ GDataServer.prototype = {</span>
<a href="#l91.50"></a><span id="l91.50">         return this.waitForLoad(cachedCalendar);</span>
<a href="#l91.51"></a><span id="l91.51">     },</span>
<a href="#l91.52"></a><span id="l91.52"> </span>
<a href="#l91.53"></a><span id="l91.53">     router: function(nextHandler, request, response) {</span>
<a href="#l91.54"></a><span id="l91.54">         try {</span>
<a href="#l91.55"></a><span id="l91.55">             let method = request.hasHeader(&quot;X-HTTP-Method-Override&quot;)</span>
<a href="#l91.56"></a><span id="l91.56">                          ? request.getHeader(&quot;X-HTTP-Method-Override&quot;)</span>
<a href="#l91.57"></a><span id="l91.57">                          : request.method;</span>
<a href="#l91.58"></a><span id="l91.58" class="difflineminus">-            let parameters = new Map(request.queryString.split(&quot;&amp;&quot;).map(p =&gt; p.split(&quot;=&quot;, 2)));</span>
<a href="#l91.59"></a><span id="l91.59" class="difflineplus">+            let parameters = new Map(request.queryString.split(&quot;&amp;&quot;).map(part =&gt; part.split(&quot;=&quot;, 2)));</span>
<a href="#l91.60"></a><span id="l91.60"> </span>
<a href="#l91.61"></a><span id="l91.61">             let body;</span>
<a href="#l91.62"></a><span id="l91.62">             try {</span>
<a href="#l91.63"></a><span id="l91.63">                 body = JSON.parse(NetUtil.readInputStreamToString(request.bodyInputStream,</span>
<a href="#l91.64"></a><span id="l91.64">                                   request.bodyInputStream.available()));</span>
<a href="#l91.65"></a><span id="l91.65">             } catch (e) {</span>
<a href="#l91.66"></a><span id="l91.66">                 // Don't bail if json parsing failed.</span>
<a href="#l91.67"></a><span id="l91.67">             }</span>
<a href="#l91.68"></a><span id="l91.68" class="difflineat">@@ -471,22 +471,22 @@ function findKey(container, key, searchK</span>
<a href="#l91.69"></a><span id="l91.69">         }</span>
<a href="#l91.70"></a><span id="l91.70">     }</span>
<a href="#l91.71"></a><span id="l91.71"> </span>
<a href="#l91.72"></a><span id="l91.72">     let foundItem = foundIndex == -1 ? null : container[foundIndex];</span>
<a href="#l91.73"></a><span id="l91.73">     return [foundIndex, foundItem];</span>
<a href="#l91.74"></a><span id="l91.74"> }</span>
<a href="#l91.75"></a><span id="l91.75"> </span>
<a href="#l91.76"></a><span id="l91.76"> function generateID() {</span>
<a href="#l91.77"></a><span id="l91.77" class="difflineminus">-    let c = &quot;abcdefghijklmnopqrstuvwxyz0123456789&quot;;</span>
<a href="#l91.78"></a><span id="l91.78" class="difflineminus">-    let s = &quot;&quot;;</span>
<a href="#l91.79"></a><span id="l91.79" class="difflineplus">+    let chars = &quot;abcdefghijklmnopqrstuvwxyz0123456789&quot;;</span>
<a href="#l91.80"></a><span id="l91.80" class="difflineplus">+    let str = &quot;&quot;;</span>
<a href="#l91.81"></a><span id="l91.81">     for (let i = 26; i; i--) {</span>
<a href="#l91.82"></a><span id="l91.82" class="difflineminus">-      s += c[Math.floor(Math.random() * c.length)];</span>
<a href="#l91.83"></a><span id="l91.83" class="difflineplus">+      str += chars[Math.floor(Math.random() * chars.length)];</span>
<a href="#l91.84"></a><span id="l91.84">     }</span>
<a href="#l91.85"></a><span id="l91.85" class="difflineminus">-    return s;</span>
<a href="#l91.86"></a><span id="l91.86" class="difflineplus">+    return str;</span>
<a href="#l91.87"></a><span id="l91.87"> }</span>
<a href="#l91.88"></a><span id="l91.88"> </span>
<a href="#l91.89"></a><span id="l91.89"> function getAllMeta(calendar) {</span>
<a href="#l91.90"></a><span id="l91.90">     let keys = {}, values = {};</span>
<a href="#l91.91"></a><span id="l91.91">     calendar.getAllMetaData({}, keys, values);</span>
<a href="#l91.92"></a><span id="l91.92">     return new Map(keys.value.map((k, i) =&gt; [k, values.value[i]]));</span>
<a href="#l91.93"></a><span id="l91.93"> }</span>
<a href="#l91.94"></a><span id="l91.94"> </span>
<a href="#l91.95"></a><span id="l91.95" class="difflineat">@@ -605,86 +605,86 @@ add_task(function* test_dateToJSON() {</span>
<a href="#l91.96"></a><span id="l91.96"> </span>
<a href="#l91.97"></a><span id="l91.97">         let parser = Components.classes[&quot;@mozilla.org/calendar/ics-parser;1&quot;]</span>
<a href="#l91.98"></a><span id="l91.98">                                .createInstance(Components.interfaces.calIIcsParser);</span>
<a href="#l91.99"></a><span id="l91.99">         parser.parseString(ics);</span>
<a href="#l91.100"></a><span id="l91.100">         let items = parser.getItems({});</span>
<a href="#l91.101"></a><span id="l91.101">         return items[0].startDate;</span>
<a href="#l91.102"></a><span id="l91.102">     }</span>
<a href="#l91.103"></a><span id="l91.103"> </span>
<a href="#l91.104"></a><span id="l91.104" class="difflineminus">-    let dt;</span>
<a href="#l91.105"></a><span id="l91.105" class="difflineplus">+    let date;</span>
<a href="#l91.106"></a><span id="l91.106"> </span>
<a href="#l91.107"></a><span id="l91.107">     // no timezone</span>
<a href="#l91.108"></a><span id="l91.108" class="difflineminus">-    dt = _createDateTime(cal.floating());</span>
<a href="#l91.109"></a><span id="l91.109" class="difflineminus">-    deepEqual(dateToJSON(dt), { dateTime: &quot;2015-01-30T12:00:00-00:00&quot; });</span>
<a href="#l91.110"></a><span id="l91.110" class="difflineplus">+    date = _createDateTime(cal.floating());</span>
<a href="#l91.111"></a><span id="l91.111" class="difflineplus">+    deepEqual(dateToJSON(date), { dateTime: &quot;2015-01-30T12:00:00-00:00&quot; });</span>
<a href="#l91.112"></a><span id="l91.112"> </span>
<a href="#l91.113"></a><span id="l91.113">     // valid non-Olson tz name</span>
<a href="#l91.114"></a><span id="l91.114" class="difflineminus">-    dt = _createDateTime(&quot;Eastern Standard Time&quot;);</span>
<a href="#l91.115"></a><span id="l91.115" class="difflineminus">-    deepEqual(dateToJSON(dt), { dateTime: &quot;2015-01-30T12:00:00&quot;, timeZone: &quot;America/New_York&quot; });</span>
<a href="#l91.116"></a><span id="l91.116" class="difflineplus">+    date = _createDateTime(&quot;Eastern Standard Time&quot;);</span>
<a href="#l91.117"></a><span id="l91.117" class="difflineplus">+    deepEqual(dateToJSON(date), { dateTime: &quot;2015-01-30T12:00:00&quot;, timeZone: &quot;America/New_York&quot; });</span>
<a href="#l91.118"></a><span id="l91.118"> </span>
<a href="#l91.119"></a><span id="l91.119">     // valid continent/city Olson tz</span>
<a href="#l91.120"></a><span id="l91.120" class="difflineminus">-    dt = _createDateTime(&quot;America/New_York&quot;);</span>
<a href="#l91.121"></a><span id="l91.121" class="difflineminus">-    deepEqual(dateToJSON(dt), { dateTime: &quot;2015-01-30T12:00:00&quot;, timeZone: &quot;America/New_York&quot; });</span>
<a href="#l91.122"></a><span id="l91.122" class="difflineplus">+    date = _createDateTime(&quot;America/New_York&quot;);</span>
<a href="#l91.123"></a><span id="l91.123" class="difflineplus">+    deepEqual(dateToJSON(date), { dateTime: &quot;2015-01-30T12:00:00&quot;, timeZone: &quot;America/New_York&quot; });</span>
<a href="#l91.124"></a><span id="l91.124"> </span>
<a href="#l91.125"></a><span id="l91.125">     // valid continent/region/city Olson tz</span>
<a href="#l91.126"></a><span id="l91.126" class="difflineminus">-    dt = _createDateTime(&quot;America/Argentina/Buenos_Aires&quot;);</span>
<a href="#l91.127"></a><span id="l91.127" class="difflineminus">-    deepEqual(dateToJSON(dt), { dateTime: &quot;2015-01-30T12:00:00&quot;, timeZone: &quot;America/Argentina/Buenos_Aires&quot; });</span>
<a href="#l91.128"></a><span id="l91.128" class="difflineplus">+    date = _createDateTime(&quot;America/Argentina/Buenos_Aires&quot;);</span>
<a href="#l91.129"></a><span id="l91.129" class="difflineplus">+    deepEqual(dateToJSON(date), { dateTime: &quot;2015-01-30T12:00:00&quot;, timeZone: &quot;America/Argentina/Buenos_Aires&quot; });</span>
<a href="#l91.130"></a><span id="l91.130"> </span>
<a href="#l91.131"></a><span id="l91.131">     // ical.js and libical currently have slightly different timezone handling.</span>
<a href="#l91.132"></a><span id="l91.132">     if (Preferences.get(&quot;calendar.icaljs&quot;, false)) {</span>
<a href="#l91.133"></a><span id="l91.133">         // unknown but formal valid Olson tz. ical.js assumes floating</span>
<a href="#l91.134"></a><span id="l91.134" class="difflineminus">-        dt = _createDateTime(&quot;Unknown/Olson/Timezone&quot;);</span>
<a href="#l91.135"></a><span id="l91.135" class="difflineminus">-        deepEqual(dateToJSON(dt), { dateTime: &quot;2015-01-30T12:00:00-00:00&quot; });</span>
<a href="#l91.136"></a><span id="l91.136" class="difflineplus">+        date = _createDateTime(&quot;Unknown/Olson/Timezone&quot;);</span>
<a href="#l91.137"></a><span id="l91.137" class="difflineplus">+        deepEqual(dateToJSON(date), { dateTime: &quot;2015-01-30T12:00:00-00:00&quot; });</span>
<a href="#l91.138"></a><span id="l91.138"> </span>
<a href="#l91.139"></a><span id="l91.139">         // Etc with offset. ical.js doesn't understand third party zones and uses floating</span>
<a href="#l91.140"></a><span id="l91.140" class="difflineminus">-        dt = _createDateTime(&quot;ThirdPartyZone&quot;, 5);</span>
<a href="#l91.141"></a><span id="l91.141" class="difflineminus">-        deepEqual(dateToJSON(dt), { dateTime: &quot;2015-01-30T12:00:00-00:00&quot; });</span>
<a href="#l91.142"></a><span id="l91.142" class="difflineplus">+        date = _createDateTime(&quot;ThirdPartyZone&quot;, 5);</span>
<a href="#l91.143"></a><span id="l91.143" class="difflineplus">+        deepEqual(dateToJSON(date), { dateTime: &quot;2015-01-30T12:00:00-00:00&quot; });</span>
<a href="#l91.144"></a><span id="l91.144"> </span>
<a href="#l91.145"></a><span id="l91.145">         // Etc with zero offset. ical.js doesn't understand third party zones and uses floating</span>
<a href="#l91.146"></a><span id="l91.146" class="difflineminus">-        dt = _createDateTime(&quot;ThirdPartyZone&quot;, 0);</span>
<a href="#l91.147"></a><span id="l91.147" class="difflineminus">-        deepEqual(dateToJSON(dt), { dateTime: &quot;2015-01-30T12:00:00-00:00&quot; });</span>
<a href="#l91.148"></a><span id="l91.148" class="difflineplus">+        date = _createDateTime(&quot;ThirdPartyZone&quot;, 0);</span>
<a href="#l91.149"></a><span id="l91.149" class="difflineplus">+        deepEqual(dateToJSON(date), { dateTime: &quot;2015-01-30T12:00:00-00:00&quot; });</span>
<a href="#l91.150"></a><span id="l91.150">     } else {</span>
<a href="#l91.151"></a><span id="l91.151">         // This causes an assertion failure.</span>
<a href="#l91.152"></a><span id="l91.152">         if (!mozinfo.debug) {</span>
<a href="#l91.153"></a><span id="l91.153">             // unknown but formal valid Olson tz</span>
<a href="#l91.154"></a><span id="l91.154" class="difflineminus">-            dt = _createDateTime(&quot;Unknown/Olson/Timezone&quot;);</span>
<a href="#l91.155"></a><span id="l91.155" class="difflineminus">-            deepEqual(dateToJSON(dt), { dateTime: &quot;2015-01-30T12:00:00&quot;, timeZone: &quot;Unknown/Olson/Timezone&quot; });</span>
<a href="#l91.156"></a><span id="l91.156" class="difflineplus">+            date = _createDateTime(&quot;Unknown/Olson/Timezone&quot;);</span>
<a href="#l91.157"></a><span id="l91.157" class="difflineplus">+            deepEqual(dateToJSON(date), { dateTime: &quot;2015-01-30T12:00:00&quot;, timeZone: &quot;Unknown/Olson/Timezone&quot; });</span>
<a href="#l91.158"></a><span id="l91.158">         }</span>
<a href="#l91.159"></a><span id="l91.159"> </span>
<a href="#l91.160"></a><span id="l91.160">         // Etc with offset</span>
<a href="#l91.161"></a><span id="l91.161" class="difflineminus">-        dt = _createDateTime(&quot;ThirdPartyZone&quot;, 5);</span>
<a href="#l91.162"></a><span id="l91.162" class="difflineminus">-        deepEqual(dateToJSON(dt), { dateTime: &quot;2015-01-30T12:00:00&quot;, timeZone: &quot;Etc/GMT-5&quot; });</span>
<a href="#l91.163"></a><span id="l91.163" class="difflineplus">+        date = _createDateTime(&quot;ThirdPartyZone&quot;, 5);</span>
<a href="#l91.164"></a><span id="l91.164" class="difflineplus">+        deepEqual(dateToJSON(date), { dateTime: &quot;2015-01-30T12:00:00&quot;, timeZone: &quot;Etc/GMT-5&quot; });</span>
<a href="#l91.165"></a><span id="l91.165"> </span>
<a href="#l91.166"></a><span id="l91.166">         // Etc with zero offset</span>
<a href="#l91.167"></a><span id="l91.167" class="difflineminus">-        dt = _createDateTime(&quot;ThirdPartyZone&quot;, 0);</span>
<a href="#l91.168"></a><span id="l91.168" class="difflineminus">-        deepEqual(dateToJSON(dt), { dateTime: &quot;2015-01-30T12:00:00Z&quot;, timeZone: &quot;UTC&quot; });</span>
<a href="#l91.169"></a><span id="l91.169" class="difflineplus">+        date = _createDateTime(&quot;ThirdPartyZone&quot;, 0);</span>
<a href="#l91.170"></a><span id="l91.170" class="difflineplus">+        deepEqual(dateToJSON(date), { dateTime: &quot;2015-01-30T12:00:00Z&quot;, timeZone: &quot;UTC&quot; });</span>
<a href="#l91.171"></a><span id="l91.171">     }</span>
<a href="#l91.172"></a><span id="l91.172"> </span>
<a href="#l91.173"></a><span id="l91.173">     // This causes an assertion failure.</span>
<a href="#l91.174"></a><span id="l91.174">     if (!mozinfo.debug) {</span>
<a href="#l91.175"></a><span id="l91.175">         // invalid non-Olson tz</span>
<a href="#l91.176"></a><span id="l91.176" class="difflineminus">-        dt = _createDateTime(&quot;InvalidTimeZone&quot;);</span>
<a href="#l91.177"></a><span id="l91.177" class="difflineminus">-        notEqual(dateToJSON(dt), { dateTime: &quot;2015-01-30T12:00:00&quot;, timeZone: &quot;InvalidTimeZone&quot; });</span>
<a href="#l91.178"></a><span id="l91.178" class="difflineplus">+        date = _createDateTime(&quot;InvalidTimeZone&quot;);</span>
<a href="#l91.179"></a><span id="l91.179" class="difflineplus">+        notEqual(dateToJSON(date), { dateTime: &quot;2015-01-30T12:00:00&quot;, timeZone: &quot;InvalidTimeZone&quot; });</span>
<a href="#l91.180"></a><span id="l91.180">     }</span>
<a href="#l91.181"></a><span id="l91.181"> </span>
<a href="#l91.182"></a><span id="l91.182">     // Zone with 0 offset but not UTC</span>
<a href="#l91.183"></a><span id="l91.183" class="difflineminus">-    dt = _createDateTime(&quot;Europe/London&quot;);</span>
<a href="#l91.184"></a><span id="l91.184" class="difflineminus">-    deepEqual(dateToJSON(dt), { dateTime: &quot;2015-01-30T12:00:00&quot;, timeZone: &quot;Europe/London&quot; });</span>
<a href="#l91.185"></a><span id="l91.185" class="difflineplus">+    date = _createDateTime(&quot;Europe/London&quot;);</span>
<a href="#l91.186"></a><span id="l91.186" class="difflineplus">+    deepEqual(dateToJSON(date), { dateTime: &quot;2015-01-30T12:00:00&quot;, timeZone: &quot;Europe/London&quot; });</span>
<a href="#l91.187"></a><span id="l91.187"> </span>
<a href="#l91.188"></a><span id="l91.188">     // date only</span>
<a href="#l91.189"></a><span id="l91.189" class="difflineminus">-    dt.isDate = true;</span>
<a href="#l91.190"></a><span id="l91.190" class="difflineminus">-    deepEqual(dateToJSON(dt), { date: &quot;2015-01-30&quot; });</span>
<a href="#l91.191"></a><span id="l91.191" class="difflineplus">+    date.isDate = true;</span>
<a href="#l91.192"></a><span id="l91.192" class="difflineplus">+    deepEqual(dateToJSON(date), { date: &quot;2015-01-30&quot; });</span>
<a href="#l91.193"></a><span id="l91.193"> });</span>
<a href="#l91.194"></a><span id="l91.194"> </span>
<a href="#l91.195"></a><span id="l91.195"> add_task(function* test_JSONToDate() {</span>
<a href="#l91.196"></a><span id="l91.196">     function convert(aEntry, aTimezone=&quot;Europe/Berlin&quot;) {</span>
<a href="#l91.197"></a><span id="l91.197">         let tzs = cal.getTimezoneService();</span>
<a href="#l91.198"></a><span id="l91.198">         let calendarTz = tzs.getTimezone(aTimezone);</span>
<a href="#l91.199"></a><span id="l91.199" class="difflineminus">-        let dt = JSONToDate(aEntry, calendarTz);</span>
<a href="#l91.200"></a><span id="l91.200" class="difflineminus">-        return dt ? dt.icalString + &quot; in &quot; + dt.timezone.tzid : null;</span>
<a href="#l91.201"></a><span id="l91.201" class="difflineplus">+        let date = JSONToDate(aEntry, calendarTz);</span>
<a href="#l91.202"></a><span id="l91.202" class="difflineplus">+        return date ? date.icalString + &quot; in &quot; + date.timezone.tzid : null;</span>
<a href="#l91.203"></a><span id="l91.203">     }</span>
<a href="#l91.204"></a><span id="l91.204"> </span>
<a href="#l91.205"></a><span id="l91.205">     // A date, using the passed in default timezone</span>
<a href="#l91.206"></a><span id="l91.206">     equal(convert({ date: &quot;2015-01-02&quot; }), &quot;20150102 in Europe/Berlin&quot;);</span>
<a href="#l91.207"></a><span id="l91.207"> </span>
<a href="#l91.208"></a><span id="l91.208">     // A date, with a timezone that has zero offset</span>
<a href="#l91.209"></a><span id="l91.209">     equal(convert({ date: &quot;2015-01-02&quot;, timeZone: &quot;Africa/Accra&quot; }), &quot;20150102 in Africa/Accra&quot;);</span>
<a href="#l91.210"></a><span id="l91.210"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l92.1"></a><span id="l92.1" class="difflineminus">--- a/calendar/test/unit/test_hashedarray.js</span>
<a href="#l92.2"></a><span id="l92.2" class="difflineplus">+++ b/calendar/test/unit/test_hashedarray.js</span>
<a href="#l92.3"></a><span id="l92.3" class="difflineat">@@ -47,23 +47,23 @@ function titleComptor(a, b) {</span>
<a href="#l92.4"></a><span id="l92.4">  * items array.</span>
<a href="#l92.5"></a><span id="l92.5">  *</span>
<a href="#l92.6"></a><span id="l92.6">  * @param har           The Hashed Array</span>
<a href="#l92.7"></a><span id="l92.7">  * @param testItems     The array of test items</span>
<a href="#l92.8"></a><span id="l92.8">  * @param itemAccessor  The accessor func to retrieve the items</span>
<a href="#l92.9"></a><span id="l92.9">  * @throws Exception    If the arrays are not the same.</span>
<a href="#l92.10"></a><span id="l92.10">  */</span>
<a href="#l92.11"></a><span id="l92.11"> function checkConsistancy(har, testItems, itemAccessor) {</span>
<a href="#l92.12"></a><span id="l92.12" class="difflineminus">-    itemAccessor = itemAccessor || function(o) { return o; };</span>
<a href="#l92.13"></a><span id="l92.13" class="difflineplus">+    itemAccessor = itemAccessor || function(item) { return item; };</span>
<a href="#l92.14"></a><span id="l92.14">     for (let idx in testItems) {</span>
<a href="#l92.15"></a><span id="l92.15" class="difflineminus">-        let ti = itemAccessor(testItems[idx]);</span>
<a href="#l92.16"></a><span id="l92.16" class="difflineplus">+        let testItem = itemAccessor(testItems[idx]);</span>
<a href="#l92.17"></a><span id="l92.17">         equal(itemAccessor(har.itemByIndex(idx)).title,</span>
<a href="#l92.18"></a><span id="l92.18" class="difflineminus">-                    ti.title);</span>
<a href="#l92.19"></a><span id="l92.19" class="difflineminus">-        equal(itemAccessor(har.itemById(ti.hashId)).title,</span>
<a href="#l92.20"></a><span id="l92.20" class="difflineminus">-                    ti.title);</span>
<a href="#l92.21"></a><span id="l92.21" class="difflineplus">+                    testItem.title);</span>
<a href="#l92.22"></a><span id="l92.22" class="difflineplus">+        equal(itemAccessor(har.itemById(testItem.hashId)).title,</span>
<a href="#l92.23"></a><span id="l92.23" class="difflineplus">+                    testItem.title);</span>
<a href="#l92.24"></a><span id="l92.24">         equal(har.indexOf(testItems[idx]), idx);</span>
<a href="#l92.25"></a><span id="l92.25">     }</span>
<a href="#l92.26"></a><span id="l92.26"> }</span>
<a href="#l92.27"></a><span id="l92.27"> </span>
<a href="#l92.28"></a><span id="l92.28"> /**</span>
<a href="#l92.29"></a><span id="l92.29">  * Man, this function is really hard to keep general enough, I'm almost tempted</span>
<a href="#l92.30"></a><span id="l92.30">  * to duplicate the code. It checks if the remove and modify operations work for</span>
<a href="#l92.31"></a><span id="l92.31">  * the given hashed array.</span>
<a href="#l92.32"></a><span id="l92.32" class="difflineat">@@ -75,17 +75,17 @@ function checkConsistancy(har, testItems</span>
<a href="#l92.33"></a><span id="l92.33">  * @param itemAccessor      (optional) The function to access the item for an</span>
<a href="#l92.34"></a><span id="l92.34">  *                            array element.</span>
<a href="#l92.35"></a><span id="l92.35">  * @param itemCreator       (optional) Function to create a new item for the</span>
<a href="#l92.36"></a><span id="l92.36">  *                            array.</span>
<a href="#l92.37"></a><span id="l92.37">  */</span>
<a href="#l92.38"></a><span id="l92.38"> function testRemoveModify(har, testItems, postprocessFunc, itemAccessor, itemCreator) {</span>
<a href="#l92.39"></a><span id="l92.39">     postprocessFunc = postprocessFunc || function(a, b) { return [a, b]; };</span>
<a href="#l92.40"></a><span id="l92.40">     itemCreator = itemCreator || (title =&gt; hashedCreateItem(title));</span>
<a href="#l92.41"></a><span id="l92.41" class="difflineminus">-    itemAccessor = itemAccessor || function(o) { return o; };</span>
<a href="#l92.42"></a><span id="l92.42" class="difflineplus">+    itemAccessor = itemAccessor || function(item) { return item; };</span>
<a href="#l92.43"></a><span id="l92.43"> </span>
<a href="#l92.44"></a><span id="l92.44">     // Now, delete the second item and check again</span>
<a href="#l92.45"></a><span id="l92.45">     har.removeById(itemAccessor(testItems[1]).hashId);</span>
<a href="#l92.46"></a><span id="l92.46">     testItems.splice(1, 1);</span>
<a href="#l92.47"></a><span id="l92.47">     [har, testItems] = postprocessFunc(har, testItems);</span>
<a href="#l92.48"></a><span id="l92.48"> </span>
<a href="#l92.49"></a><span id="l92.49">     checkConsistancy(har, testItems, itemAccessor);</span>
<a href="#l92.50"></a><span id="l92.50"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l93.1"></a><span id="l93.1" class="difflineminus">--- a/calendar/test/unit/test_ics_service.js</span>
<a href="#l93.2"></a><span id="l93.2" class="difflineplus">+++ b/calendar/test/unit/test_ics_service.js</span>
<a href="#l93.3"></a><span id="l93.3" class="difflineat">@@ -167,24 +167,24 @@ function test_icalcomponent() {</span>
<a href="#l93.4"></a><span id="l93.4">     let alarm = svc.createIcalComponent(&quot;VALARM&quot;);</span>
<a href="#l93.5"></a><span id="l93.5">     event.addSubcomponent(alarm);</span>
<a href="#l93.6"></a><span id="l93.6"> </span>
<a href="#l93.7"></a><span id="l93.7">     // Check that the parent works and does not appear on cloned instances</span>
<a href="#l93.8"></a><span id="l93.8">     let alarm2 = alarm.clone();</span>
<a href="#l93.9"></a><span id="l93.9">     equal(alarm.parent.toString(), event.toString());</span>
<a href="#l93.10"></a><span id="l93.10">     equal(alarm2.parent, null);</span>
<a href="#l93.11"></a><span id="l93.11"> </span>
<a href="#l93.12"></a><span id="l93.12" class="difflineminus">-    function check_getset(k, v) {</span>
<a href="#l93.13"></a><span id="l93.13" class="difflineminus">-        dump(&quot;Checking &quot; + k + &quot; = &quot; + v + &quot;\n&quot;);</span>
<a href="#l93.14"></a><span id="l93.14" class="difflineminus">-        event[k] = v;</span>
<a href="#l93.15"></a><span id="l93.15" class="difflineminus">-        let vstring = v.icalString || v;</span>
<a href="#l93.16"></a><span id="l93.16" class="difflineminus">-        equal(event[k].icalString || event[k], vstring);</span>
<a href="#l93.17"></a><span id="l93.17" class="difflineminus">-        equal(event.serializeToICS().match(new RegExp(vstring, &quot;g&quot;)).length, 1);</span>
<a href="#l93.18"></a><span id="l93.18" class="difflineminus">-        event[k] = v;</span>
<a href="#l93.19"></a><span id="l93.19" class="difflineminus">-        equal(event.serializeToICS().match(new RegExp(vstring, &quot;g&quot;)).length, 1);</span>
<a href="#l93.20"></a><span id="l93.20" class="difflineplus">+    function check_getset(key, value) {</span>
<a href="#l93.21"></a><span id="l93.21" class="difflineplus">+        dump(&quot;Checking &quot; + key + &quot; = &quot; + value + &quot;\n&quot;);</span>
<a href="#l93.22"></a><span id="l93.22" class="difflineplus">+        event[key] = value;</span>
<a href="#l93.23"></a><span id="l93.23" class="difflineplus">+        let valuestring = value.icalString || value;</span>
<a href="#l93.24"></a><span id="l93.24" class="difflineplus">+        equal(event[key].icalString || event[key], valuestring);</span>
<a href="#l93.25"></a><span id="l93.25" class="difflineplus">+        equal(event.serializeToICS().match(new RegExp(valuestring, &quot;g&quot;)).length, 1);</span>
<a href="#l93.26"></a><span id="l93.26" class="difflineplus">+        event[key] = value;</span>
<a href="#l93.27"></a><span id="l93.27" class="difflineplus">+        equal(event.serializeToICS().match(new RegExp(valuestring, &quot;g&quot;)).length, 1);</span>
<a href="#l93.28"></a><span id="l93.28">     }</span>
<a href="#l93.29"></a><span id="l93.29"> </span>
<a href="#l93.30"></a><span id="l93.30">     let props = [</span>
<a href="#l93.31"></a><span id="l93.31">        [&quot;uid&quot;, &quot;123&quot;],</span>
<a href="#l93.32"></a><span id="l93.32">        [&quot;prodid&quot;, &quot;//abc/123&quot;],</span>
<a href="#l93.33"></a><span id="l93.33">        [&quot;version&quot;, &quot;2.0&quot;],</span>
<a href="#l93.34"></a><span id="l93.34">        [&quot;method&quot;, &quot;REQUEST&quot;],</span>
<a href="#l93.35"></a><span id="l93.35">        [&quot;status&quot;, &quot;TENTATIVE&quot;],</span>
<a href="#l93.36"></a><span id="l93.36" class="difflineat">@@ -233,56 +233,56 @@ function test_iterator() {</span>
<a href="#l93.37"></a><span id="l93.37">     let comp = svc.createIcalComponent(&quot;VEVENT&quot;);</span>
<a href="#l93.38"></a><span id="l93.38">     let propNames = [&quot;X-ONE&quot;, &quot;X-TWO&quot;];</span>
<a href="#l93.39"></a><span id="l93.39">     for (let i = 0; i &lt; propNames.length; i++) {</span>
<a href="#l93.40"></a><span id="l93.40">         let prop = svc.createIcalProperty(propNames[i]);</span>
<a href="#l93.41"></a><span id="l93.41">         prop.value = &quot;&quot; + (i + 1);</span>
<a href="#l93.42"></a><span id="l93.42">         comp.addProperty(prop);</span>
<a href="#l93.43"></a><span id="l93.43">     }</span>
<a href="#l93.44"></a><span id="l93.44"> </span>
<a href="#l93.45"></a><span id="l93.45" class="difflineminus">-    for (let p = comp.getFirstProperty(&quot;ANY&quot;);</span>
<a href="#l93.46"></a><span id="l93.46" class="difflineminus">-         p;</span>
<a href="#l93.47"></a><span id="l93.47" class="difflineminus">-         p = comp.getNextProperty(&quot;ANY&quot;)) {</span>
<a href="#l93.48"></a><span id="l93.48" class="difflineminus">-        equal(p.propertyName, propNames.shift());</span>
<a href="#l93.49"></a><span id="l93.49" class="difflineminus">-        equal(p.parent.toString(), comp.toString());</span>
<a href="#l93.50"></a><span id="l93.50" class="difflineplus">+    for (let prop = comp.getFirstProperty(&quot;ANY&quot;);</span>
<a href="#l93.51"></a><span id="l93.51" class="difflineplus">+         prop;</span>
<a href="#l93.52"></a><span id="l93.52" class="difflineplus">+         prop = comp.getNextProperty(&quot;ANY&quot;)) {</span>
<a href="#l93.53"></a><span id="l93.53" class="difflineplus">+        equal(prop.propertyName, propNames.shift());</span>
<a href="#l93.54"></a><span id="l93.54" class="difflineplus">+        equal(prop.parent.toString(), comp.toString());</span>
<a href="#l93.55"></a><span id="l93.55">     }</span>
<a href="#l93.56"></a><span id="l93.56">     propNames = [&quot;X-ONE&quot;, &quot;X-TWO&quot;];</span>
<a href="#l93.57"></a><span id="l93.57" class="difflineminus">-    for (let p = comp.getNextProperty(&quot;ANY&quot;);</span>
<a href="#l93.58"></a><span id="l93.58" class="difflineminus">-         p;</span>
<a href="#l93.59"></a><span id="l93.59" class="difflineminus">-         p = comp.getNextProperty(&quot;ANY&quot;)) {</span>
<a href="#l93.60"></a><span id="l93.60" class="difflineminus">-        equal(p.propertyName, propNames.shift());</span>
<a href="#l93.61"></a><span id="l93.61" class="difflineminus">-        equal(p.parent.toString(), comp.toString());</span>
<a href="#l93.62"></a><span id="l93.62" class="difflineplus">+    for (let prop = comp.getNextProperty(&quot;ANY&quot;);</span>
<a href="#l93.63"></a><span id="l93.63" class="difflineplus">+         prop;</span>
<a href="#l93.64"></a><span id="l93.64" class="difflineplus">+         prop = comp.getNextProperty(&quot;ANY&quot;)) {</span>
<a href="#l93.65"></a><span id="l93.65" class="difflineplus">+        equal(prop.propertyName, propNames.shift());</span>
<a href="#l93.66"></a><span id="l93.66" class="difflineplus">+        equal(prop.parent.toString(), comp.toString());</span>
<a href="#l93.67"></a><span id="l93.67">     }</span>
<a href="#l93.68"></a><span id="l93.68"> </span>
<a href="#l93.69"></a><span id="l93.69">     // Property iterator with multiple values</span>
<a href="#l93.70"></a><span id="l93.70">     comp = svc.parseICS(&quot;BEGIN:VEVENT\r\n&quot; +</span>
<a href="#l93.71"></a><span id="l93.71">                         &quot;CATEGORIES:a,b,c\r\n&quot; +</span>
<a href="#l93.72"></a><span id="l93.72">                         &quot;END:VEVENT&quot;, null);</span>
<a href="#l93.73"></a><span id="l93.73">     let propValues = [&quot;a&quot;, &quot;b&quot;, &quot;c&quot;];</span>
<a href="#l93.74"></a><span id="l93.74" class="difflineminus">-    for (let p = comp.getFirstProperty(&quot;CATEGORIES&quot;);</span>
<a href="#l93.75"></a><span id="l93.75" class="difflineminus">-         p;</span>
<a href="#l93.76"></a><span id="l93.76" class="difflineminus">-         p = comp.getNextProperty(&quot;CATEGORIES&quot;)) {</span>
<a href="#l93.77"></a><span id="l93.77" class="difflineminus">-        equal(p.propertyName, &quot;CATEGORIES&quot;);</span>
<a href="#l93.78"></a><span id="l93.78" class="difflineminus">-        equal(p.value, propValues.shift());</span>
<a href="#l93.79"></a><span id="l93.79" class="difflineminus">-        equal(p.parent.toString(), comp.toString());</span>
<a href="#l93.80"></a><span id="l93.80" class="difflineplus">+    for (let prop = comp.getFirstProperty(&quot;CATEGORIES&quot;);</span>
<a href="#l93.81"></a><span id="l93.81" class="difflineplus">+         prop;</span>
<a href="#l93.82"></a><span id="l93.82" class="difflineplus">+         prop = comp.getNextProperty(&quot;CATEGORIES&quot;)) {</span>
<a href="#l93.83"></a><span id="l93.83" class="difflineplus">+        equal(prop.propertyName, &quot;CATEGORIES&quot;);</span>
<a href="#l93.84"></a><span id="l93.84" class="difflineplus">+        equal(prop.value, propValues.shift());</span>
<a href="#l93.85"></a><span id="l93.85" class="difflineplus">+        equal(prop.parent.toString(), comp.toString());</span>
<a href="#l93.86"></a><span id="l93.86">     }</span>
<a href="#l93.87"></a><span id="l93.87"> </span>
<a href="#l93.88"></a><span id="l93.88">     // Param iterator</span>
<a href="#l93.89"></a><span id="l93.89" class="difflineminus">-    let prop = svc.createIcalProperty(&quot;DTSTART&quot;);</span>
<a href="#l93.90"></a><span id="l93.90" class="difflineplus">+    let dtstart = svc.createIcalProperty(&quot;DTSTART&quot;);</span>
<a href="#l93.91"></a><span id="l93.91">     let params = [&quot;X-ONE&quot;, &quot;X-TWO&quot;];</span>
<a href="#l93.92"></a><span id="l93.92">     for (let i = 0; i &lt; params.length; i++) {</span>
<a href="#l93.93"></a><span id="l93.93" class="difflineminus">-        prop.setParameter(params[i], &quot;&quot; + (i + 1));</span>
<a href="#l93.94"></a><span id="l93.94" class="difflineplus">+        dtstart.setParameter(params[i], &quot;&quot; + (i + 1));</span>
<a href="#l93.95"></a><span id="l93.95">     }</span>
<a href="#l93.96"></a><span id="l93.96"> </span>
<a href="#l93.97"></a><span id="l93.97" class="difflineminus">-    for (let p = prop.getFirstParameterName();</span>
<a href="#l93.98"></a><span id="l93.98" class="difflineminus">-         p;</span>
<a href="#l93.99"></a><span id="l93.99" class="difflineminus">-         p = prop.getNextParameterName()) {</span>
<a href="#l93.100"></a><span id="l93.100" class="difflineminus">-        equal(p, params.shift());</span>
<a href="#l93.101"></a><span id="l93.101" class="difflineplus">+    for (let prop = dtstart.getFirstParameterName();</span>
<a href="#l93.102"></a><span id="l93.102" class="difflineplus">+         prop;</span>
<a href="#l93.103"></a><span id="l93.103" class="difflineplus">+         prop = dtstart.getNextParameterName()) {</span>
<a href="#l93.104"></a><span id="l93.104" class="difflineplus">+        equal(prop, params.shift());</span>
<a href="#l93.105"></a><span id="l93.105">     }</span>
<a href="#l93.106"></a><span id="l93.106"> </span>
<a href="#l93.107"></a><span id="l93.107">     // Now try again, but start with next. Should act like first</span>
<a href="#l93.108"></a><span id="l93.108">     params = [&quot;X-ONE&quot;, &quot;X-TWO&quot;];</span>
<a href="#l93.109"></a><span id="l93.109" class="difflineminus">-    for (let p = prop.getNextParameterName();</span>
<a href="#l93.110"></a><span id="l93.110" class="difflineminus">-         p;</span>
<a href="#l93.111"></a><span id="l93.111" class="difflineminus">-         p = prop.getNextParameterName()) {</span>
<a href="#l93.112"></a><span id="l93.112" class="difflineminus">-        equal(p, params.shift());</span>
<a href="#l93.113"></a><span id="l93.113" class="difflineplus">+    for (let param = dtstart.getNextParameterName();</span>
<a href="#l93.114"></a><span id="l93.114" class="difflineplus">+         param;</span>
<a href="#l93.115"></a><span id="l93.115" class="difflineplus">+         param = dtstart.getNextParameterName()) {</span>
<a href="#l93.116"></a><span id="l93.116" class="difflineplus">+        equal(param, params.shift());</span>
<a href="#l93.117"></a><span id="l93.117">     }</span>
<a href="#l93.118"></a><span id="l93.118"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l94.1"></a><span id="l94.1" class="difflineminus">--- a/calendar/test/unit/test_items.js</span>
<a href="#l94.2"></a><span id="l94.2" class="difflineplus">+++ b/calendar/test/unit/test_items.js</span>
<a href="#l94.3"></a><span id="l94.3" class="difflineat">@@ -37,55 +37,55 @@ function test_aclmanager() {</span>
<a href="#l94.4"></a><span id="l94.4">     let itemEntry = {</span>
<a href="#l94.5"></a><span id="l94.5">         QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calIItemACLEntry]),</span>
<a href="#l94.6"></a><span id="l94.6">         userCanModify: true,</span>
<a href="#l94.7"></a><span id="l94.7">         userCanRespond: false,</span>
<a href="#l94.8"></a><span id="l94.8">         userCanViewAll: true,</span>
<a href="#l94.9"></a><span id="l94.9">         userCanViewDateAndTime: false,</span>
<a href="#l94.10"></a><span id="l94.10">     };</span>
<a href="#l94.11"></a><span id="l94.11"> </span>
<a href="#l94.12"></a><span id="l94.12" class="difflineminus">-    let e = cal.createEvent();</span>
<a href="#l94.13"></a><span id="l94.13" class="difflineminus">-    e.id = &quot;withentry&quot;;</span>
<a href="#l94.14"></a><span id="l94.14" class="difflineminus">-    e.calendar = mockCalendar;</span>
<a href="#l94.15"></a><span id="l94.15" class="difflineplus">+    let event = cal.createEvent();</span>
<a href="#l94.16"></a><span id="l94.16" class="difflineplus">+    event.id = &quot;withentry&quot;;</span>
<a href="#l94.17"></a><span id="l94.17" class="difflineplus">+    event.calendar = mockCalendar;</span>
<a href="#l94.18"></a><span id="l94.18"> </span>
<a href="#l94.19"></a><span id="l94.19" class="difflineminus">-    equal(e.aclEntry.userCanModify, itemEntry.userCanModify);</span>
<a href="#l94.20"></a><span id="l94.20" class="difflineminus">-    equal(e.aclEntry.userCanRespond, itemEntry.userCanRespond);</span>
<a href="#l94.21"></a><span id="l94.21" class="difflineminus">-    equal(e.aclEntry.userCanViewAll, itemEntry.userCanViewAll);</span>
<a href="#l94.22"></a><span id="l94.22" class="difflineminus">-    equal(e.aclEntry.userCanViewDateAndTime, itemEntry.userCanViewDateAndTime);</span>
<a href="#l94.23"></a><span id="l94.23" class="difflineplus">+    equal(event.aclEntry.userCanModify, itemEntry.userCanModify);</span>
<a href="#l94.24"></a><span id="l94.24" class="difflineplus">+    equal(event.aclEntry.userCanRespond, itemEntry.userCanRespond);</span>
<a href="#l94.25"></a><span id="l94.25" class="difflineplus">+    equal(event.aclEntry.userCanViewAll, itemEntry.userCanViewAll);</span>
<a href="#l94.26"></a><span id="l94.26" class="difflineplus">+    equal(event.aclEntry.userCanViewDateAndTime, itemEntry.userCanViewDateAndTime);</span>
<a href="#l94.27"></a><span id="l94.27"> </span>
<a href="#l94.28"></a><span id="l94.28" class="difflineminus">-    let pe = cal.createEvent();</span>
<a href="#l94.29"></a><span id="l94.29" class="difflineminus">-    pe.id = &quot;parententry&quot;;</span>
<a href="#l94.30"></a><span id="l94.30" class="difflineminus">-    pe.calendar = mockCalendar;</span>
<a href="#l94.31"></a><span id="l94.31" class="difflineminus">-    pe.parentItem = e;</span>
<a href="#l94.32"></a><span id="l94.32" class="difflineplus">+    let parentEntry = cal.createEvent();</span>
<a href="#l94.33"></a><span id="l94.33" class="difflineplus">+    parentEntry.id = &quot;parententry&quot;;</span>
<a href="#l94.34"></a><span id="l94.34" class="difflineplus">+    parentEntry.calendar = mockCalendar;</span>
<a href="#l94.35"></a><span id="l94.35" class="difflineplus">+    parentEntry.parentItem = event;</span>
<a href="#l94.36"></a><span id="l94.36"> </span>
<a href="#l94.37"></a><span id="l94.37" class="difflineminus">-    equal(pe.aclEntry.userCanModify, itemEntry.userCanModify);</span>
<a href="#l94.38"></a><span id="l94.38" class="difflineminus">-    equal(pe.aclEntry.userCanRespond, itemEntry.userCanRespond);</span>
<a href="#l94.39"></a><span id="l94.39" class="difflineminus">-    equal(pe.aclEntry.userCanViewAll, itemEntry.userCanViewAll);</span>
<a href="#l94.40"></a><span id="l94.40" class="difflineminus">-    equal(pe.aclEntry.userCanViewDateAndTime, itemEntry.userCanViewDateAndTime);</span>
<a href="#l94.41"></a><span id="l94.41" class="difflineplus">+    equal(parentEntry.aclEntry.userCanModify, itemEntry.userCanModify);</span>
<a href="#l94.42"></a><span id="l94.42" class="difflineplus">+    equal(parentEntry.aclEntry.userCanRespond, itemEntry.userCanRespond);</span>
<a href="#l94.43"></a><span id="l94.43" class="difflineplus">+    equal(parentEntry.aclEntry.userCanViewAll, itemEntry.userCanViewAll);</span>
<a href="#l94.44"></a><span id="l94.44" class="difflineplus">+    equal(parentEntry.aclEntry.userCanViewDateAndTime, itemEntry.userCanViewDateAndTime);</span>
<a href="#l94.45"></a><span id="l94.45"> </span>
<a href="#l94.46"></a><span id="l94.46" class="difflineminus">-    e = cal.createEvent();</span>
<a href="#l94.47"></a><span id="l94.47" class="difflineminus">-    e.id = &quot;noentry&quot;;</span>
<a href="#l94.48"></a><span id="l94.48" class="difflineminus">-    e.calendar = mockCalendar;</span>
<a href="#l94.49"></a><span id="l94.49" class="difflineminus">-    equal(e.aclEntry, null);</span>
<a href="#l94.50"></a><span id="l94.50" class="difflineplus">+    event = cal.createEvent();</span>
<a href="#l94.51"></a><span id="l94.51" class="difflineplus">+    event.id = &quot;noentry&quot;;</span>
<a href="#l94.52"></a><span id="l94.52" class="difflineplus">+    event.calendar = mockCalendar;</span>
<a href="#l94.53"></a><span id="l94.53" class="difflineplus">+    equal(event.aclEntry, null);</span>
<a href="#l94.54"></a><span id="l94.54"> }</span>
<a href="#l94.55"></a><span id="l94.55"> </span>
<a href="#l94.56"></a><span id="l94.56"> function test_calendar() {</span>
<a href="#l94.57"></a><span id="l94.57" class="difflineminus">-    let e = cal.createEvent();</span>
<a href="#l94.58"></a><span id="l94.58" class="difflineminus">-    let pe = cal.createEvent();</span>
<a href="#l94.59"></a><span id="l94.59" class="difflineplus">+    let event = cal.createEvent();</span>
<a href="#l94.60"></a><span id="l94.60" class="difflineplus">+    let parentEntry = cal.createEvent();</span>
<a href="#l94.61"></a><span id="l94.61"> </span>
<a href="#l94.62"></a><span id="l94.62">     let mockCalendar = {</span>
<a href="#l94.63"></a><span id="l94.63">         QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calICalendar]),</span>
<a href="#l94.64"></a><span id="l94.64">         id: &quot;one&quot;</span>
<a href="#l94.65"></a><span id="l94.65">     };</span>
<a href="#l94.66"></a><span id="l94.66"> </span>
<a href="#l94.67"></a><span id="l94.67" class="difflineminus">-    pe.calendar = mockCalendar;</span>
<a href="#l94.68"></a><span id="l94.68" class="difflineminus">-    e.parentItem = pe;</span>
<a href="#l94.69"></a><span id="l94.69" class="difflineplus">+    parentEntry.calendar = mockCalendar;</span>
<a href="#l94.70"></a><span id="l94.70" class="difflineplus">+    event.parentItem = parentEntry;</span>
<a href="#l94.71"></a><span id="l94.71"> </span>
<a href="#l94.72"></a><span id="l94.72" class="difflineminus">-    notEqual(e.calendar, null);</span>
<a href="#l94.73"></a><span id="l94.73" class="difflineminus">-    equal(e.calendar.id, &quot;one&quot;);</span>
<a href="#l94.74"></a><span id="l94.74" class="difflineplus">+    notEqual(event.calendar, null);</span>
<a href="#l94.75"></a><span id="l94.75" class="difflineplus">+    equal(event.calendar.id, &quot;one&quot;);</span>
<a href="#l94.76"></a><span id="l94.76"> }</span>
<a href="#l94.77"></a><span id="l94.77"> </span>
<a href="#l94.78"></a><span id="l94.78"> function test_attachment() {</span>
<a href="#l94.79"></a><span id="l94.79">     let e = cal.createEvent();</span>
<a href="#l94.80"></a><span id="l94.80"> </span>
<a href="#l94.81"></a><span id="l94.81">     let a = cal.createAttachment();</span>
<a href="#l94.82"></a><span id="l94.82">     a.rawData = &quot;horst&quot;;</span>
<a href="#l94.83"></a><span id="l94.83"> </span>
<a href="#l94.84"></a><span id="l94.84" class="difflineat">@@ -181,73 +181,73 @@ function test_alarm() {</span>
<a href="#l94.85"></a><span id="l94.85">     equal(e.getAlarms({}).length, 1);</span>
<a href="#l94.86"></a><span id="l94.86">     equal(e.getAlarms({})[0], alarm2);</span>
<a href="#l94.87"></a><span id="l94.87"> </span>
<a href="#l94.88"></a><span id="l94.88">     e.clearAlarms();</span>
<a href="#l94.89"></a><span id="l94.89">     equal(e.getAlarms({}).length, 0);</span>
<a href="#l94.90"></a><span id="l94.90"> }</span>
<a href="#l94.91"></a><span id="l94.91"> </span>
<a href="#l94.92"></a><span id="l94.92"> function test_immutable() {</span>
<a href="#l94.93"></a><span id="l94.93" class="difflineminus">-    let e = cal.createEvent();</span>
<a href="#l94.94"></a><span id="l94.94" class="difflineplus">+    let event = cal.createEvent();</span>
<a href="#l94.95"></a><span id="l94.95"> </span>
<a href="#l94.96"></a><span id="l94.96" class="difflineminus">-    let dt = cal.createDateTime();</span>
<a href="#l94.97"></a><span id="l94.97" class="difflineminus">-    dt.timezone = cal.getTimezoneService().getTimezone(&quot;Europe/Berlin&quot;);</span>
<a href="#l94.98"></a><span id="l94.98" class="difflineminus">-    e.alarmLastAck = dt;</span>
<a href="#l94.99"></a><span id="l94.99" class="difflineplus">+    let date = cal.createDateTime();</span>
<a href="#l94.100"></a><span id="l94.100" class="difflineplus">+    date.timezone = cal.getTimezoneService().getTimezone(&quot;Europe/Berlin&quot;);</span>
<a href="#l94.101"></a><span id="l94.101" class="difflineplus">+    event.alarmLastAck = date;</span>
<a href="#l94.102"></a><span id="l94.102"> </span>
<a href="#l94.103"></a><span id="l94.103">     let org = cal.createAttendee();</span>
<a href="#l94.104"></a><span id="l94.104">     org.id = &quot;one&quot;;</span>
<a href="#l94.105"></a><span id="l94.105" class="difflineminus">-    e.organizer = org;</span>
<a href="#l94.106"></a><span id="l94.106" class="difflineplus">+    event.organizer = org;</span>
<a href="#l94.107"></a><span id="l94.107"> </span>
<a href="#l94.108"></a><span id="l94.108">     let alarm = cal.createAlarm();</span>
<a href="#l94.109"></a><span id="l94.109">     alarm.action = &quot;DISPLAY&quot;;</span>
<a href="#l94.110"></a><span id="l94.110">     alarm.description = &quot;foo&quot;;</span>
<a href="#l94.111"></a><span id="l94.111">     alarm.related = alarm.ALARM_RELATED_START;</span>
<a href="#l94.112"></a><span id="l94.112">     alarm.offset = cal.createDuration(&quot;PT1S&quot;);</span>
<a href="#l94.113"></a><span id="l94.113" class="difflineminus">-    e.addAlarm(alarm);</span>
<a href="#l94.114"></a><span id="l94.114" class="difflineplus">+    event.addAlarm(alarm);</span>
<a href="#l94.115"></a><span id="l94.115"> </span>
<a href="#l94.116"></a><span id="l94.116" class="difflineminus">-    e.setProperty(&quot;X-NAME&quot;, &quot;X-VALUE&quot;);</span>
<a href="#l94.117"></a><span id="l94.117" class="difflineminus">-    e.setPropertyParameter(&quot;X-NAME&quot;, &quot;X-PARAM&quot;, &quot;X-PARAMVAL&quot;);</span>
<a href="#l94.118"></a><span id="l94.118" class="difflineplus">+    event.setProperty(&quot;X-NAME&quot;, &quot;X-VALUE&quot;);</span>
<a href="#l94.119"></a><span id="l94.119" class="difflineplus">+    event.setPropertyParameter(&quot;X-NAME&quot;, &quot;X-PARAM&quot;, &quot;X-PARAMVAL&quot;);</span>
<a href="#l94.120"></a><span id="l94.120"> </span>
<a href="#l94.121"></a><span id="l94.121" class="difflineminus">-    e.setCategories(3, [&quot;a&quot;, &quot;b&quot;, &quot;c&quot;]);</span>
<a href="#l94.122"></a><span id="l94.122" class="difflineplus">+    event.setCategories(3, [&quot;a&quot;, &quot;b&quot;, &quot;c&quot;]);</span>
<a href="#l94.123"></a><span id="l94.123"> </span>
<a href="#l94.124"></a><span id="l94.124" class="difflineminus">-    equal(e.alarmLastAck.timezone.tzid, cal.UTC().tzid);</span>
<a href="#l94.125"></a><span id="l94.125" class="difflineplus">+    equal(event.alarmLastAck.timezone.tzid, cal.UTC().tzid);</span>
<a href="#l94.126"></a><span id="l94.126"> </span>
<a href="#l94.127"></a><span id="l94.127" class="difflineminus">-    e.makeImmutable();</span>
<a href="#l94.128"></a><span id="l94.128" class="difflineplus">+    event.makeImmutable();</span>
<a href="#l94.129"></a><span id="l94.129"> </span>
<a href="#l94.130"></a><span id="l94.130">     // call again, should not throw</span>
<a href="#l94.131"></a><span id="l94.131" class="difflineminus">-    e.makeImmutable();</span>
<a href="#l94.132"></a><span id="l94.132" class="difflineplus">+    event.makeImmutable();</span>
<a href="#l94.133"></a><span id="l94.133"> </span>
<a href="#l94.134"></a><span id="l94.134" class="difflineminus">-    ok(!e.alarmLastAck.isMutable);</span>
<a href="#l94.135"></a><span id="l94.135" class="difflineplus">+    ok(!event.alarmLastAck.isMutable);</span>
<a href="#l94.136"></a><span id="l94.136">     ok(!org.isMutable);</span>
<a href="#l94.137"></a><span id="l94.137">     ok(!alarm.isMutable);</span>
<a href="#l94.138"></a><span id="l94.138"> </span>
<a href="#l94.139"></a><span id="l94.139">     throws(() =&gt; {</span>
<a href="#l94.140"></a><span id="l94.140" class="difflineminus">-        e.alarmLastAck = cal.createDateTime();</span>
<a href="#l94.141"></a><span id="l94.141" class="difflineplus">+        event.alarmLastAck = cal.createDateTime();</span>
<a href="#l94.142"></a><span id="l94.142">     }, /Can not modify immutable data container/);</span>
<a href="#l94.143"></a><span id="l94.143">     throws(() =&gt; {</span>
<a href="#l94.144"></a><span id="l94.144" class="difflineminus">-        e.calendar = null;</span>
<a href="#l94.145"></a><span id="l94.145" class="difflineplus">+        event.calendar = null;</span>
<a href="#l94.146"></a><span id="l94.146">     }, /Can not modify immutable data container/);</span>
<a href="#l94.147"></a><span id="l94.147">     throws(() =&gt; {</span>
<a href="#l94.148"></a><span id="l94.148" class="difflineminus">-        e.parentItem = null;</span>
<a href="#l94.149"></a><span id="l94.149" class="difflineplus">+        event.parentItem = null;</span>
<a href="#l94.150"></a><span id="l94.150">     }, /Can not modify immutable data container/);</span>
<a href="#l94.151"></a><span id="l94.151">     throws(() =&gt; {</span>
<a href="#l94.152"></a><span id="l94.152" class="difflineminus">-        e.setCategories(3, [&quot;d&quot;, &quot;e&quot;, &quot;f&quot;]);</span>
<a href="#l94.153"></a><span id="l94.153" class="difflineplus">+        event.setCategories(3, [&quot;d&quot;, &quot;e&quot;, &quot;f&quot;]);</span>
<a href="#l94.154"></a><span id="l94.154">     }, /Can not modify immutable data container/);</span>
<a href="#l94.155"></a><span id="l94.155"> </span>
<a href="#l94.156"></a><span id="l94.156" class="difflineminus">-    let e2 = e.clone();</span>
<a href="#l94.157"></a><span id="l94.157" class="difflineminus">-    e2.organizer.id = &quot;two&quot;;</span>
<a href="#l94.158"></a><span id="l94.158" class="difflineplus">+    let event2 = event.clone();</span>
<a href="#l94.159"></a><span id="l94.159" class="difflineplus">+    event2.organizer.id = &quot;two&quot;;</span>
<a href="#l94.160"></a><span id="l94.160"> </span>
<a href="#l94.161"></a><span id="l94.161">     equal(org.id, &quot;one&quot;);</span>
<a href="#l94.162"></a><span id="l94.162" class="difflineminus">-    equal(e2.organizer.id, &quot;two&quot;);</span>
<a href="#l94.163"></a><span id="l94.163" class="difflineplus">+    equal(event2.organizer.id, &quot;two&quot;);</span>
<a href="#l94.164"></a><span id="l94.164"> </span>
<a href="#l94.165"></a><span id="l94.165" class="difflineminus">-    equal(e2.getProperty(&quot;X-NAME&quot;), &quot;X-VALUE&quot;);</span>
<a href="#l94.166"></a><span id="l94.166" class="difflineminus">-    equal(e2.getPropertyParameter(&quot;X-NAME&quot;, &quot;X-PARAM&quot;), &quot;X-PARAMVAL&quot;);</span>
<a href="#l94.167"></a><span id="l94.167" class="difflineplus">+    equal(event2.getProperty(&quot;X-NAME&quot;), &quot;X-VALUE&quot;);</span>
<a href="#l94.168"></a><span id="l94.168" class="difflineplus">+    equal(event2.getPropertyParameter(&quot;X-NAME&quot;, &quot;X-PARAM&quot;), &quot;X-PARAMVAL&quot;);</span>
<a href="#l94.169"></a><span id="l94.169"> </span>
<a href="#l94.170"></a><span id="l94.170" class="difflineminus">-    e2.setPropertyParameter(&quot;X-NAME&quot;, &quot;X-PARAM&quot;, null);</span>
<a href="#l94.171"></a><span id="l94.171" class="difflineminus">-    equal(e2.getPropertyParameter(&quot;X-NAME&quot;, &quot;X-PARAM&quot;), null);</span>
<a href="#l94.172"></a><span id="l94.172" class="difflineplus">+    event2.setPropertyParameter(&quot;X-NAME&quot;, &quot;X-PARAM&quot;, null);</span>
<a href="#l94.173"></a><span id="l94.173" class="difflineplus">+    equal(event2.getPropertyParameter(&quot;X-NAME&quot;, &quot;X-PARAM&quot;), null);</span>
<a href="#l94.174"></a><span id="l94.174"> </span>
<a href="#l94.175"></a><span id="l94.175">     // TODO more clone checks</span>
<a href="#l94.176"></a><span id="l94.176"> }</span>
<a href="#l94.177"></a><span id="l94.177"> </span>
<a href="#l94.178"></a><span id="l94.178"> function test_lastack() {</span>
<a href="#l94.179"></a><span id="l94.179">     let e = cal.createEvent();</span>
<a href="#l94.180"></a><span id="l94.180"> </span>
<a href="#l94.181"></a><span id="l94.181">     e.alarmLastAck = cal.createDateTime(&quot;20120101T010101&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l95.1"></a><span id="l95.1" class="difflineminus">--- a/calendar/test/unit/test_ltninvitationutils.js</span>
<a href="#l95.2"></a><span id="l95.2" class="difflineplus">+++ b/calendar/test/unit/test_ltninvitationutils.js</span>
<a href="#l95.3"></a><span id="l95.3" class="difflineat">@@ -697,50 +697,50 @@ add_task(function* encodeMimeHeader_test</span>
<a href="#l95.4"></a><span id="l95.4">         equal(ltn.invitation.encodeMimeHeader(test.input.header, test.input.isEmail), test.expected,</span>
<a href="#l95.5"></a><span id="l95.5">               &quot;(test #&quot; + i + &quot;)&quot;);</span>
<a href="#l95.6"></a><span id="l95.6">     }</span>
<a href="#l95.7"></a><span id="l95.7"> });</span>
<a href="#l95.8"></a><span id="l95.8"> </span>
<a href="#l95.9"></a><span id="l95.9"> add_task(function* getRfc5322FormattedDate_test() {</span>
<a href="#l95.10"></a><span id="l95.10">     let data = {</span>
<a href="#l95.11"></a><span id="l95.11">         input: [{</span>
<a href="#l95.12"></a><span id="l95.12" class="difflineminus">-            dt: null,</span>
<a href="#l95.13"></a><span id="l95.13" class="difflineminus">-            dtz: &quot;America/New_York&quot;</span>
<a href="#l95.14"></a><span id="l95.14" class="difflineplus">+            date: null,</span>
<a href="#l95.15"></a><span id="l95.15" class="difflineplus">+            timezone: &quot;America/New_York&quot;</span>
<a href="#l95.16"></a><span id="l95.16">         }, {</span>
<a href="#l95.17"></a><span id="l95.17" class="difflineminus">-            dt: &quot;Sat, 24 Jan 2015 09:24:49 +0100&quot;,</span>
<a href="#l95.18"></a><span id="l95.18" class="difflineminus">-            dtz: &quot;America/New_York&quot;</span>
<a href="#l95.19"></a><span id="l95.19" class="difflineplus">+            date: &quot;Sat, 24 Jan 2015 09:24:49 +0100&quot;,</span>
<a href="#l95.20"></a><span id="l95.20" class="difflineplus">+            timezone: &quot;America/New_York&quot;</span>
<a href="#l95.21"></a><span id="l95.21">         }, {</span>
<a href="#l95.22"></a><span id="l95.22" class="difflineminus">-            dt: &quot;Sat, 24 Jan 2015 09:24:49 GMT+0100&quot;,</span>
<a href="#l95.23"></a><span id="l95.23" class="difflineminus">-            dtz: &quot;America/New_York&quot;</span>
<a href="#l95.24"></a><span id="l95.24" class="difflineplus">+            date: &quot;Sat, 24 Jan 2015 09:24:49 GMT+0100&quot;,</span>
<a href="#l95.25"></a><span id="l95.25" class="difflineplus">+            timezone: &quot;America/New_York&quot;</span>
<a href="#l95.26"></a><span id="l95.26">         }, {</span>
<a href="#l95.27"></a><span id="l95.27" class="difflineminus">-            dt: &quot;Sat, 24 Jan 2015 09:24:49 GMT&quot;,</span>
<a href="#l95.28"></a><span id="l95.28" class="difflineminus">-            dtz: &quot;America/New_York&quot;</span>
<a href="#l95.29"></a><span id="l95.29" class="difflineplus">+            date: &quot;Sat, 24 Jan 2015 09:24:49 GMT&quot;,</span>
<a href="#l95.30"></a><span id="l95.30" class="difflineplus">+            timezone: &quot;America/New_York&quot;</span>
<a href="#l95.31"></a><span id="l95.31">         }, {</span>
<a href="#l95.32"></a><span id="l95.32" class="difflineminus">-            dt: &quot;Sat, 24 Jan 2015 09:24:49&quot;,</span>
<a href="#l95.33"></a><span id="l95.33" class="difflineminus">-            dtz: &quot;America/New_York&quot;</span>
<a href="#l95.34"></a><span id="l95.34" class="difflineplus">+            date: &quot;Sat, 24 Jan 2015 09:24:49&quot;,</span>
<a href="#l95.35"></a><span id="l95.35" class="difflineplus">+            timezone: &quot;America/New_York&quot;</span>
<a href="#l95.36"></a><span id="l95.36">         }, {</span>
<a href="#l95.37"></a><span id="l95.37" class="difflineminus">-            dt: &quot;Sat, 24 Jan 2015 09:24:49&quot;,</span>
<a href="#l95.38"></a><span id="l95.38" class="difflineminus">-            dtz: null</span>
<a href="#l95.39"></a><span id="l95.39" class="difflineplus">+            date: &quot;Sat, 24 Jan 2015 09:24:49&quot;,</span>
<a href="#l95.40"></a><span id="l95.40" class="difflineplus">+            timezone: null</span>
<a href="#l95.41"></a><span id="l95.41">         }, {</span>
<a href="#l95.42"></a><span id="l95.42" class="difflineminus">-            dt: &quot;Sat, 24 Jan 2015 09:24:49&quot;,</span>
<a href="#l95.43"></a><span id="l95.43" class="difflineminus">-            dtz: &quot;UTC&quot;</span>
<a href="#l95.44"></a><span id="l95.44" class="difflineplus">+            date: &quot;Sat, 24 Jan 2015 09:24:49&quot;,</span>
<a href="#l95.45"></a><span id="l95.45" class="difflineplus">+            timezone: &quot;UTC&quot;</span>
<a href="#l95.46"></a><span id="l95.46">         }, {</span>
<a href="#l95.47"></a><span id="l95.47" class="difflineminus">-            dt: &quot;Sat, 24 Jan 2015 09:24:49&quot;,</span>
<a href="#l95.48"></a><span id="l95.48" class="difflineminus">-            dtz: &quot;floating&quot;</span>
<a href="#l95.49"></a><span id="l95.49" class="difflineplus">+            date: &quot;Sat, 24 Jan 2015 09:24:49&quot;,</span>
<a href="#l95.50"></a><span id="l95.50" class="difflineplus">+            timezone: &quot;floating&quot;</span>
<a href="#l95.51"></a><span id="l95.51">         }],</span>
<a href="#l95.52"></a><span id="l95.52">         expected: /^\w{3}, \d{2} \w{3} \d{4} \d{2}:\d{2}:\d{2} [+-]\d{4}$/</span>
<a href="#l95.53"></a><span id="l95.53">     };</span>
<a href="#l95.54"></a><span id="l95.54"> </span>
<a href="#l95.55"></a><span id="l95.55">     let i = 0;</span>
<a href="#l95.56"></a><span id="l95.56" class="difflineminus">-    let dtz = Preferences.get(&quot;calendar.timezone.local&quot;, null);</span>
<a href="#l95.57"></a><span id="l95.57" class="difflineplus">+    let timezone = Preferences.get(&quot;calendar.timezone.local&quot;, null);</span>
<a href="#l95.58"></a><span id="l95.58">     for (let test of data.input) {</span>
<a href="#l95.59"></a><span id="l95.59">         i++;</span>
<a href="#l95.60"></a><span id="l95.60" class="difflineminus">-        if (test.dtz) {</span>
<a href="#l95.61"></a><span id="l95.61" class="difflineminus">-            Preferences.set(&quot;calendar.timezone.local&quot;, test.dtz);</span>
<a href="#l95.62"></a><span id="l95.62" class="difflineplus">+        if (test.timezone) {</span>
<a href="#l95.63"></a><span id="l95.63" class="difflineplus">+            Preferences.set(&quot;calendar.timezone.local&quot;, test.timezone);</span>
<a href="#l95.64"></a><span id="l95.64">         } else {</span>
<a href="#l95.65"></a><span id="l95.65">             Preferences.reset(&quot;calendar.timezone.local&quot;);</span>
<a href="#l95.66"></a><span id="l95.66">         }</span>
<a href="#l95.67"></a><span id="l95.67" class="difflineminus">-        let dt = test.dt ? new Date(test.dt) : null;</span>
<a href="#l95.68"></a><span id="l95.68" class="difflineminus">-        let r = new RegExp(data.expected);</span>
<a href="#l95.69"></a><span id="l95.69" class="difflineminus">-        ok(r.test(ltn.invitation.getRfc5322FormattedDate(dt)), &quot;(test #&quot; + i + &quot;)&quot;);</span>
<a href="#l95.70"></a><span id="l95.70" class="difflineplus">+        let date = test.date ? new Date(test.date) : null;</span>
<a href="#l95.71"></a><span id="l95.71" class="difflineplus">+        let re = new RegExp(data.expected);</span>
<a href="#l95.72"></a><span id="l95.72" class="difflineplus">+        ok(re.test(ltn.invitation.getRfc5322FormattedDate(date)), &quot;(test #&quot; + i + &quot;)&quot;);</span>
<a href="#l95.73"></a><span id="l95.73">     }</span>
<a href="#l95.74"></a><span id="l95.74" class="difflineminus">-    Preferences.set(&quot;calendar.timezone.local&quot;, dtz);</span>
<a href="#l95.75"></a><span id="l95.75" class="difflineplus">+    Preferences.set(&quot;calendar.timezone.local&quot;, timezone);</span>
<a href="#l95.76"></a><span id="l95.76"> });</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l96.1"></a><span id="l96.1" class="difflineminus">--- a/calendar/test/unit/test_recur.js</span>
<a href="#l96.2"></a><span id="l96.2" class="difflineplus">+++ b/calendar/test/unit/test_recur.js</span>
<a href="#l96.3"></a><span id="l96.3" class="difflineat">@@ -34,18 +34,18 @@ function test_rules() {</span>
<a href="#l96.4"></a><span id="l96.4">         // Check number of items</span>
<a href="#l96.5"></a><span id="l96.5">         dump(&quot;Expected &quot; + expected.length + &quot; occurrences\n&quot;);</span>
<a href="#l96.6"></a><span id="l96.6">         dump(&quot;Got: &quot; + recdates.map(x =&gt; x.toString()) + &quot;\n&quot;);</span>
<a href="#l96.7"></a><span id="l96.7">         equal(recdates.length, expected.length);</span>
<a href="#l96.8"></a><span id="l96.8">         let fmt = cal.getDateFormatter();</span>
<a href="#l96.9"></a><span id="l96.9"> </span>
<a href="#l96.10"></a><span id="l96.10">         for (let i = 0; i &lt; expected.length; i++) {</span>
<a href="#l96.11"></a><span id="l96.11">             // Check each date</span>
<a href="#l96.12"></a><span id="l96.12" class="difflineminus">-            let ed = cal.createDateTime(expected[i]);</span>
<a href="#l96.13"></a><span id="l96.13" class="difflineminus">-            dump(&quot;Expecting instance at &quot; + ed + &quot;(&quot; + fmt.dayName(ed.weekday) + &quot;)\n&quot;);</span>
<a href="#l96.14"></a><span id="l96.14" class="difflineplus">+            let expectedDate = cal.createDateTime(expected[i]);</span>
<a href="#l96.15"></a><span id="l96.15" class="difflineplus">+            dump(&quot;Expecting instance at &quot; + expectedDate + &quot;(&quot; + fmt.dayName(expectedDate.weekday) + &quot;)\n&quot;);</span>
<a href="#l96.16"></a><span id="l96.16">             dump(&quot;Recdate:&quot;);</span>
<a href="#l96.17"></a><span id="l96.17">             equal(recdates[i].icalString, expected[i]);</span>
<a href="#l96.18"></a><span id="l96.18"> </span>
<a href="#l96.19"></a><span id="l96.19">             // Make sure occurrences are correct</span>
<a href="#l96.20"></a><span id="l96.20">             dump(&quot;Occurrence:&quot;);</span>
<a href="#l96.21"></a><span id="l96.21">             equal(occurrences[i].startDate.icalString, expected[i]);</span>
<a href="#l96.22"></a><span id="l96.22"> </span>
<a href="#l96.23"></a><span id="l96.23">             if (ignoreNextOccCheck) {</span>
<a href="#l96.24"></a><span id="l96.24" class="difflineat">@@ -511,17 +511,17 @@ function test_interface() {</span>
<a href="#l96.25"></a><span id="l96.25">     let rinfo = item.recurrenceInfo;</span>
<a href="#l96.26"></a><span id="l96.26">     ok(compareObjects(rinfo.item, item, Components.interfaces.calIEvent));</span>
<a href="#l96.27"></a><span id="l96.27"> </span>
<a href="#l96.28"></a><span id="l96.28">     // getRecurrenceItems</span>
<a href="#l96.29"></a><span id="l96.29">     let ritems = rinfo.getRecurrenceItems({});</span>
<a href="#l96.30"></a><span id="l96.30">     equal(ritems.length, 3);</span>
<a href="#l96.31"></a><span id="l96.31"> </span>
<a href="#l96.32"></a><span id="l96.32">     let checkritems = new Map(ritems.map(ritem =&gt; [ritem.icalProperty.propertyName, ritem.icalProperty]));</span>
<a href="#l96.33"></a><span id="l96.33" class="difflineminus">-    let rparts = new Map(checkritems.get(&quot;RRULE&quot;).value.split(&quot;;&quot;).map(v =&gt; v.split(&quot;=&quot;, 2)));</span>
<a href="#l96.34"></a><span id="l96.34" class="difflineplus">+    let rparts = new Map(checkritems.get(&quot;RRULE&quot;).value.split(&quot;;&quot;).map(value =&gt; value.split(&quot;=&quot;, 2)));</span>
<a href="#l96.35"></a><span id="l96.35">     equal(rparts.size, 3);</span>
<a href="#l96.36"></a><span id="l96.36">     equal(rparts.get(&quot;FREQ&quot;), &quot;WEEKLY&quot;);</span>
<a href="#l96.37"></a><span id="l96.37">     equal(rparts.get(&quot;COUNT&quot;), &quot;6&quot;);</span>
<a href="#l96.38"></a><span id="l96.38">     equal(rparts.get(&quot;BYDAY&quot;), &quot;TU,WE&quot;);</span>
<a href="#l96.39"></a><span id="l96.39">     equal(checkritems.get(&quot;EXDATE&quot;).value, &quot;20020403T114500Z&quot;);</span>
<a href="#l96.40"></a><span id="l96.40">     equal(checkritems.get(&quot;RDATE&quot;).value, &quot;20020401T114500Z&quot;);</span>
<a href="#l96.41"></a><span id="l96.41"> </span>
<a href="#l96.42"></a><span id="l96.42">     // setRecurrenceItems</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l97.1"></a><span id="l97.1" class="difflineminus">--- a/calendar/test/unit/test_relation.js</span>
<a href="#l97.2"></a><span id="l97.2" class="difflineplus">+++ b/calendar/test/unit/test_relation.js</span>
<a href="#l97.3"></a><span id="l97.3" class="difflineat">@@ -1,48 +1,48 @@</span>
<a href="#l97.4"></a><span id="l97.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l97.5"></a><span id="l97.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l97.6"></a><span id="l97.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l97.7"></a><span id="l97.7"> </span>
<a href="#l97.8"></a><span id="l97.8"> function run_test() {</span>
<a href="#l97.9"></a><span id="l97.9">     // Create Relation</span>
<a href="#l97.10"></a><span id="l97.10" class="difflineminus">-    let r1 = cal.createRelation();</span>
<a href="#l97.11"></a><span id="l97.11" class="difflineplus">+    let relation1 = cal.createRelation();</span>
<a href="#l97.12"></a><span id="l97.12"> </span>
<a href="#l97.13"></a><span id="l97.13">     // Create Items</span>
<a href="#l97.14"></a><span id="l97.14" class="difflineminus">-    let e1 = cal.createEvent();</span>
<a href="#l97.15"></a><span id="l97.15" class="difflineminus">-    let e2 = cal.createEvent();</span>
<a href="#l97.16"></a><span id="l97.16" class="difflineplus">+    let event1 = cal.createEvent();</span>
<a href="#l97.17"></a><span id="l97.17" class="difflineplus">+    let event2 = cal.createEvent();</span>
<a href="#l97.18"></a><span id="l97.18"> </span>
<a href="#l97.19"></a><span id="l97.19">     // Testing relation set/get.</span>
<a href="#l97.20"></a><span id="l97.20">     let properties = {</span>
<a href="#l97.21"></a><span id="l97.21">         relType: &quot;PARENT&quot;,</span>
<a href="#l97.22"></a><span id="l97.22" class="difflineminus">-        relId: e2.id</span>
<a href="#l97.23"></a><span id="l97.23" class="difflineplus">+        relId: event2.id</span>
<a href="#l97.24"></a><span id="l97.24">     };</span>
<a href="#l97.25"></a><span id="l97.25"> </span>
<a href="#l97.26"></a><span id="l97.26">     for (let [property, value] in Iterator(properties)) {</span>
<a href="#l97.27"></a><span id="l97.27" class="difflineminus">-        r1[property] = value;</span>
<a href="#l97.28"></a><span id="l97.28" class="difflineminus">-        equal(r1[property], value);</span>
<a href="#l97.29"></a><span id="l97.29" class="difflineplus">+        relation1[property] = value;</span>
<a href="#l97.30"></a><span id="l97.30" class="difflineplus">+        equal(relation1[property], value);</span>
<a href="#l97.31"></a><span id="l97.31">     }</span>
<a href="#l97.32"></a><span id="l97.32"> </span>
<a href="#l97.33"></a><span id="l97.33">     // Add relation to event</span>
<a href="#l97.34"></a><span id="l97.34" class="difflineminus">-    e1.addRelation(r1);</span>
<a href="#l97.35"></a><span id="l97.35" class="difflineplus">+    event1.addRelation(relation1);</span>
<a href="#l97.36"></a><span id="l97.36"> </span>
<a href="#l97.37"></a><span id="l97.37">     // Add 2nd relation to event.</span>
<a href="#l97.38"></a><span id="l97.38" class="difflineminus">-    let r2 = cal.createRelation();</span>
<a href="#l97.39"></a><span id="l97.39" class="difflineminus">-    r2.relId = &quot;myid2&quot;;</span>
<a href="#l97.40"></a><span id="l97.40" class="difflineminus">-    e1.addRelation(r2);</span>
<a href="#l97.41"></a><span id="l97.41" class="difflineplus">+    let relation2 = cal.createRelation();</span>
<a href="#l97.42"></a><span id="l97.42" class="difflineplus">+    relation2.relId = &quot;myid2&quot;;</span>
<a href="#l97.43"></a><span id="l97.43" class="difflineplus">+    event1.addRelation(relation2);</span>
<a href="#l97.44"></a><span id="l97.44"> </span>
<a href="#l97.45"></a><span id="l97.45">     // Check the item functions</span>
<a href="#l97.46"></a><span id="l97.46" class="difflineminus">-    checkRelations(e1, [r1, r2]);</span>
<a href="#l97.47"></a><span id="l97.47" class="difflineplus">+    checkRelations(event1, [relation1, relation2]);</span>
<a href="#l97.48"></a><span id="l97.48"> </span>
<a href="#l97.49"></a><span id="l97.49">     // modify the Relations</span>
<a href="#l97.50"></a><span id="l97.50" class="difflineminus">-    modifyRelations(e1, [r1, r2]);</span>
<a href="#l97.51"></a><span id="l97.51" class="difflineplus">+    modifyRelations(event1, [relation1, relation2]);</span>
<a href="#l97.52"></a><span id="l97.52"> </span>
<a href="#l97.53"></a><span id="l97.53">     // test icalproperty</span>
<a href="#l97.54"></a><span id="l97.54">     // eslint-disable-next-line no-unused-expressions</span>
<a href="#l97.55"></a><span id="l97.55" class="difflineminus">-    r2.icalProperty;</span>
<a href="#l97.56"></a><span id="l97.56" class="difflineplus">+    relation2.icalProperty;</span>
<a href="#l97.57"></a><span id="l97.57"> </span>
<a href="#l97.58"></a><span id="l97.58">     test_icalprop();</span>
<a href="#l97.59"></a><span id="l97.59"> }</span>
<a href="#l97.60"></a><span id="l97.60"> </span>
<a href="#l97.61"></a><span id="l97.61"> function checkRelations(event, expRel) {</span>
<a href="#l97.62"></a><span id="l97.62">     let countObj = {};</span>
<a href="#l97.63"></a><span id="l97.63">     let allRel = event.getRelations(countObj);</span>
<a href="#l97.64"></a><span id="l97.64">     equal(countObj.value, allRel.length);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l98.1"></a><span id="l98.1" class="difflineminus">--- a/calendar/test/unit/test_search_service.js</span>
<a href="#l98.2"></a><span id="l98.2" class="difflineplus">+++ b/calendar/test/unit/test_search_service.js</span>
<a href="#l98.3"></a><span id="l98.3" class="difflineat">@@ -94,17 +94,17 @@ function test_cancel() {</span>
<a href="#l98.4"></a><span id="l98.4">     search.getProviders({}).forEach(search.removeProvider, search);</span>
<a href="#l98.5"></a><span id="l98.5"> </span>
<a href="#l98.6"></a><span id="l98.6">     let provider = {</span>
<a href="#l98.7"></a><span id="l98.7">         QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calICalendarSearchProvider, Components.interfaces.calIOperation]),</span>
<a href="#l98.8"></a><span id="l98.8">         searchForCalendars: function(aStr, aHint, aMax, aListener) {</span>
<a href="#l98.9"></a><span id="l98.9">             Services.tm.currentThread.dispatch({</span>
<a href="#l98.10"></a><span id="l98.10">                 run: function() {</span>
<a href="#l98.11"></a><span id="l98.11">                     dump(&quot;Cancelling search...&quot;);</span>
<a href="#l98.12"></a><span id="l98.12" class="difflineminus">-                    op.cancel();</span>
<a href="#l98.13"></a><span id="l98.13" class="difflineplus">+                    operation.cancel();</span>
<a href="#l98.14"></a><span id="l98.14">                 }</span>
<a href="#l98.15"></a><span id="l98.15">             }, Components.interfaces.nsIEventTarget.DISPATCH_NORMAL);</span>
<a href="#l98.16"></a><span id="l98.16"> </span>
<a href="#l98.17"></a><span id="l98.17">             // No listener call, we emulate a long running search</span>
<a href="#l98.18"></a><span id="l98.18">             // Do return the operation though</span>
<a href="#l98.19"></a><span id="l98.19">             return this;</span>
<a href="#l98.20"></a><span id="l98.20">         },</span>
<a href="#l98.21"></a><span id="l98.21"> </span>
<a href="#l98.22"></a><span id="l98.22" class="difflineat">@@ -125,10 +125,10 @@ function test_cancel() {</span>
<a href="#l98.23"></a><span id="l98.23">             ok(!provider.cancelCalled);</span>
<a href="#l98.24"></a><span id="l98.24">             do_test_finished();</span>
<a href="#l98.25"></a><span id="l98.25">         }</span>
<a href="#l98.26"></a><span id="l98.26">     };</span>
<a href="#l98.27"></a><span id="l98.27"> </span>
<a href="#l98.28"></a><span id="l98.28">     search.addProvider(provider);</span>
<a href="#l98.29"></a><span id="l98.29"> </span>
<a href="#l98.30"></a><span id="l98.30">     do_test_pending();</span>
<a href="#l98.31"></a><span id="l98.31" class="difflineminus">-    let op = search.searchForCalendars(&quot;str&quot;, HINT_EXACT_MATCH, 0, listener);</span>
<a href="#l98.32"></a><span id="l98.32" class="difflineplus">+    let operation = search.searchForCalendars(&quot;str&quot;, HINT_EXACT_MATCH, 0, listener);</span>
<a href="#l98.33"></a><span id="l98.33"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l99.1"></a><span id="l99.1" class="difflineminus">--- a/calendar/test/unit/test_storage.js</span>
<a href="#l99.2"></a><span id="l99.2" class="difflineplus">+++ b/calendar/test/unit/test_storage.js</span>
<a href="#l99.3"></a><span id="l99.3" class="difflineat">@@ -18,28 +18,28 @@ function testAttachRoundtrip() {</span>
<a href="#l99.4"></a><span id="l99.4">                &quot;RDATE:20120201T010101Z&quot;,</span>
<a href="#l99.5"></a><span id="l99.5">                &quot;EXDATE:20120301T010101Z&quot;,</span>
<a href="#l99.6"></a><span id="l99.6">                &quot;END:VEVENT&quot;].join(&quot;\r\n&quot;);</span>
<a href="#l99.7"></a><span id="l99.7"> </span>
<a href="#l99.8"></a><span id="l99.8">     let storageItem = createEventFromIcalString(str);</span>
<a href="#l99.9"></a><span id="l99.9"> </span>
<a href="#l99.10"></a><span id="l99.10">     do_test_pending();</span>
<a href="#l99.11"></a><span id="l99.11">     storage.addItem(storageItem, {</span>
<a href="#l99.12"></a><span id="l99.12" class="difflineminus">-        onOperationComplete: function(c, s, o, i, addedItem) {</span>
<a href="#l99.13"></a><span id="l99.13" class="difflineplus">+        onOperationComplete: function(calendar, status, opType, id, addedItem) {</span>
<a href="#l99.14"></a><span id="l99.14">             do_execute_soon(() =&gt; {</span>
<a href="#l99.15"></a><span id="l99.15">                 // Make sure the cache is cleared, otherwise we'll get the cached item.</span>
<a href="#l99.16"></a><span id="l99.16">                 delete storage.wrappedJSObject.mItemCache[addedItem.id];</span>
<a href="#l99.17"></a><span id="l99.17">                 storage.getItem(addedItem.id, retrieveItem);</span>
<a href="#l99.18"></a><span id="l99.18">             });</span>
<a href="#l99.19"></a><span id="l99.19">         }</span>
<a href="#l99.20"></a><span id="l99.20">     });</span>
<a href="#l99.21"></a><span id="l99.21"> </span>
<a href="#l99.22"></a><span id="l99.22">     let retrieveItem = {</span>
<a href="#l99.23"></a><span id="l99.23">         found: false,</span>
<a href="#l99.24"></a><span id="l99.24" class="difflineminus">-        onGetResult: function(ca, st, ty, de, co, items) {</span>
<a href="#l99.25"></a><span id="l99.25" class="difflineplus">+        onGetResult: function(calendar, status, type, detail, count, items) {</span>
<a href="#l99.26"></a><span id="l99.26">             let item = items[0];</span>
<a href="#l99.27"></a><span id="l99.27"> </span>
<a href="#l99.28"></a><span id="l99.28">             // Check start date</span>
<a href="#l99.29"></a><span id="l99.29">             equal(item.startDate.compare(cal.createDateTime(&quot;20120101T010101Z&quot;)), 0);</span>
<a href="#l99.30"></a><span id="l99.30"> </span>
<a href="#l99.31"></a><span id="l99.31">             // Check attachment</span>
<a href="#l99.32"></a><span id="l99.32">             let attaches = item.getAttachments({});</span>
<a href="#l99.33"></a><span id="l99.33">             let attach = attaches[0];</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l100.1"></a><span id="l100.1" class="difflineminus">--- a/calendar/test/unit/test_timezone.js</span>
<a href="#l100.2"></a><span id="l100.2" class="difflineplus">+++ b/calendar/test/unit/test_timezone.js</span>
<a href="#l100.3"></a><span id="l100.3" class="difflineat">@@ -8,17 +8,17 @@ function run_test() {</span>
<a href="#l100.4"></a><span id="l100.4">         onResult: function() {</span>
<a href="#l100.5"></a><span id="l100.5">             really_run_test();</span>
<a href="#l100.6"></a><span id="l100.6">             do_test_finished();</span>
<a href="#l100.7"></a><span id="l100.7">         }</span>
<a href="#l100.8"></a><span id="l100.8">     });</span>
<a href="#l100.9"></a><span id="l100.9"> }</span>
<a href="#l100.10"></a><span id="l100.10"> </span>
<a href="#l100.11"></a><span id="l100.11"> function really_run_test() {</span>
<a href="#l100.12"></a><span id="l100.12" class="difflineminus">-    let f = cal.createEvent();</span>
<a href="#l100.13"></a><span id="l100.13" class="difflineplus">+    let event = cal.createEvent();</span>
<a href="#l100.14"></a><span id="l100.14"> </span>
<a href="#l100.15"></a><span id="l100.15">     let str =</span>
<a href="#l100.16"></a><span id="l100.16">          [&quot;BEGIN:VCALENDAR&quot;,</span>
<a href="#l100.17"></a><span id="l100.17">           &quot;PRODID:-//RDU Software//NONSGML HandCal//EN&quot;,</span>
<a href="#l100.18"></a><span id="l100.18">           &quot;VERSION:2.0&quot;,</span>
<a href="#l100.19"></a><span id="l100.19">           &quot;BEGIN:VTIMEZONE&quot;,</span>
<a href="#l100.20"></a><span id="l100.20">           &quot;TZID:America/New_York&quot;,</span>
<a href="#l100.21"></a><span id="l100.21">           &quot;BEGIN:STANDARD&quot;,</span>
<a href="#l100.22"></a><span id="l100.22" class="difflineat">@@ -67,17 +67,17 @@ function really_run_test() {</span>
<a href="#l100.23"></a><span id="l100.23">           &quot;TZOFFSETTO:-0400&quot;,</span>
<a href="#l100.24"></a><span id="l100.24">           &quot;TZNAME:EDT&quot;,</span>
<a href="#l100.25"></a><span id="l100.25">           &quot;END:DAYLIGHT&quot;,</span>
<a href="#l100.26"></a><span id="l100.26">           &quot;END:VTIMEZONE&quot;,</span>
<a href="#l100.27"></a><span id="l100.27">           &quot;&quot;].join(&quot;\r\n&quot;);</span>
<a href="#l100.28"></a><span id="l100.28"> </span>
<a href="#l100.29"></a><span id="l100.29">     let tzs = cal.getTimezoneService();</span>
<a href="#l100.30"></a><span id="l100.30"> </span>
<a href="#l100.31"></a><span id="l100.31" class="difflineminus">-    f.icalString = str;</span>
<a href="#l100.32"></a><span id="l100.32" class="difflineplus">+    event.icalString = str;</span>
<a href="#l100.33"></a><span id="l100.33"> </span>
<a href="#l100.34"></a><span id="l100.34" class="difflineminus">-    let g = f.startDate;</span>
<a href="#l100.35"></a><span id="l100.35" class="difflineminus">-    let h = f.endDate;</span>
<a href="#l100.36"></a><span id="l100.36" class="difflineplus">+    let startDate = event.startDate;</span>
<a href="#l100.37"></a><span id="l100.37" class="difflineplus">+    let endDate = event.endDate;</span>
<a href="#l100.38"></a><span id="l100.38"> </span>
<a href="#l100.39"></a><span id="l100.39" class="difflineminus">-    g.timezone = tzs.getTimezone(g.timezone.tzid);</span>
<a href="#l100.40"></a><span id="l100.40" class="difflineminus">-    h.timezone = tzs.getTimezone(h.timezone.tzid);</span>
<a href="#l100.41"></a><span id="l100.41" class="difflineminus">-    notEqual(strTz, g.timezone.toString());</span>
<a href="#l100.42"></a><span id="l100.42" class="difflineplus">+    startDate.timezone = tzs.getTimezone(startDate.timezone.tzid);</span>
<a href="#l100.43"></a><span id="l100.43" class="difflineplus">+    endDate.timezone = tzs.getTimezone(endDate.timezone.tzid);</span>
<a href="#l100.44"></a><span id="l100.44" class="difflineplus">+    notEqual(strTz, startDate.timezone.toString());</span>
<a href="#l100.45"></a><span id="l100.45"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l101.1"></a><span id="l101.1" class="difflineminus">--- a/calendar/test/unit/test_timezone_definition.js</span>
<a href="#l101.2"></a><span id="l101.2" class="difflineplus">+++ b/calendar/test/unit/test_timezone_definition.js</span>
<a href="#l101.3"></a><span id="l101.3" class="difflineat">@@ -19,40 +19,40 @@ function valid_tz_version(aVersionString</span>
<a href="#l101.4"></a><span id="l101.4"> add_task(function* version_test() {</span>
<a href="#l101.5"></a><span id="l101.5">     let tzs = cal.getTimezoneService();</span>
<a href="#l101.6"></a><span id="l101.6">     ok(valid_tz_version(tzs.version), &quot;timezone version&quot;);</span>
<a href="#l101.7"></a><span id="l101.7"> });</span>
<a href="#l101.8"></a><span id="l101.8"> </span>
<a href="#l101.9"></a><span id="l101.9"> // check whether all tz definitions have all properties</span>
<a href="#l101.10"></a><span id="l101.10"> add_task(function* zone_test() {</span>
<a href="#l101.11"></a><span id="l101.11">     function resolveZone(aZoneId) {</span>
<a href="#l101.12"></a><span id="l101.12" class="difflineminus">-        let tz = tzs.getTimezone(aZoneId);</span>
<a href="#l101.13"></a><span id="l101.13" class="difflineminus">-        equal(aZoneId, tz.tzid, &quot;Zone test &quot; + aZoneId);</span>
<a href="#l101.14"></a><span id="l101.14" class="difflineminus">-        ok(tz.icalComponent.serializeToICS().startsWith(&quot;BEGIN:VTIMEZONE&quot;),</span>
<a href="#l101.15"></a><span id="l101.15" class="difflineplus">+        let timezone = tzs.getTimezone(aZoneId);</span>
<a href="#l101.16"></a><span id="l101.16" class="difflineplus">+        equal(aZoneId, timezone.tzid, &quot;Zone test &quot; + aZoneId);</span>
<a href="#l101.17"></a><span id="l101.17" class="difflineplus">+        ok(timezone.icalComponent.serializeToICS().startsWith(&quot;BEGIN:VTIMEZONE&quot;),</span>
<a href="#l101.18"></a><span id="l101.18">            &quot;VTIMEZONE test &quot; + aZoneId);</span>
<a href="#l101.19"></a><span id="l101.19" class="difflineminus">-        ok(tz.latitude &amp;&amp; !!tz.latitude.match(/^[+-]\d{7}$/), &quot;Latitude test &quot; + aZoneId);</span>
<a href="#l101.20"></a><span id="l101.20" class="difflineminus">-        ok(tz.longitude &amp;&amp; !!tz.longitude.match(/^[+-]\d{7}$/), &quot;Longitude test &quot; + aZoneId);</span>
<a href="#l101.21"></a><span id="l101.21" class="difflineplus">+        ok(timezone.latitude &amp;&amp; !!timezone.latitude.match(/^[+-]\d{7}$/), &quot;Latitude test &quot; + aZoneId);</span>
<a href="#l101.22"></a><span id="l101.22" class="difflineplus">+        ok(timezone.longitude &amp;&amp; !!timezone.longitude.match(/^[+-]\d{7}$/), &quot;Longitude test &quot; + aZoneId);</span>
<a href="#l101.23"></a><span id="l101.23">     }</span>
<a href="#l101.24"></a><span id="l101.24"> </span>
<a href="#l101.25"></a><span id="l101.25">     let tzs = cal.getTimezoneService();</span>
<a href="#l101.26"></a><span id="l101.26">     let zones = tzs.timezoneIds;</span>
<a href="#l101.27"></a><span id="l101.27">     let foundZone = false;</span>
<a href="#l101.28"></a><span id="l101.28">     while (zones.hasMore()) {</span>
<a href="#l101.29"></a><span id="l101.29">         foundZone = true;</span>
<a href="#l101.30"></a><span id="l101.30">         resolveZone(zones.getNext());</span>
<a href="#l101.31"></a><span id="l101.31">     }</span>
<a href="#l101.32"></a><span id="l101.32"> </span>
<a href="#l101.33"></a><span id="l101.33">     ok(foundZone, &quot;There is at least one timezone&quot;);</span>
<a href="#l101.34"></a><span id="l101.34"> });</span>
<a href="#l101.35"></a><span id="l101.35"> </span>
<a href="#l101.36"></a><span id="l101.36"> // check whether all tz aliases resolve to a tz definition</span>
<a href="#l101.37"></a><span id="l101.37"> add_task(function* alias_test() {</span>
<a href="#l101.38"></a><span id="l101.38">     function resolveAlias(aAliasId) {</span>
<a href="#l101.39"></a><span id="l101.39" class="difflineminus">-        let tz = tzs.getTimezone(aAliasId);</span>
<a href="#l101.40"></a><span id="l101.40" class="difflineminus">-        let tzid = tz &amp;&amp; tz.tzid ? tz.tzid : &quot;&quot;;</span>
<a href="#l101.41"></a><span id="l101.41" class="difflineplus">+        let timezone = tzs.getTimezone(aAliasId);</span>
<a href="#l101.42"></a><span id="l101.42" class="difflineplus">+        let tzid = timezone &amp;&amp; timezone.tzid ? timezone.tzid : &quot;&quot;;</span>
<a href="#l101.43"></a><span id="l101.43">         notEqual(tzid, &quot;&quot;, &quot;Alias resolution &quot; + aAliasId + &quot; -&gt; &quot; + tzid);</span>
<a href="#l101.44"></a><span id="l101.44">     }</span>
<a href="#l101.45"></a><span id="l101.45"> </span>
<a href="#l101.46"></a><span id="l101.46">     let tzs = cal.getTimezoneService();</span>
<a href="#l101.47"></a><span id="l101.47">     let aliases = tzs.aliasIds;</span>
<a href="#l101.48"></a><span id="l101.48">     let foundAlias = false;</span>
<a href="#l101.49"></a><span id="l101.49">     while (aliases.hasMore()) {</span>
<a href="#l101.50"></a><span id="l101.50">         foundAlias = true;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l102.1"></a><span id="l102.1" class="difflineminus">--- a/calendar/test/unit/test_utils.js</span>
<a href="#l102.2"></a><span id="l102.2" class="difflineplus">+++ b/calendar/test/unit/test_utils.js</span>
<a href="#l102.3"></a><span id="l102.3" class="difflineat">@@ -66,39 +66,40 @@ function test_attendeeMatchesAddresses()</span>
<a href="#l102.4"></a><span id="l102.4"> </span>
<a href="#l102.5"></a><span id="l102.5">     a = cal.createAttendee(&quot;ATTENDEE;EMAIL=\&quot;horst\&quot;:urn:uuid:horst&quot;);</span>
<a href="#l102.6"></a><span id="l102.6">     ok(cal.attendeeMatchesAddresses(a, [&quot;HORST&quot;, &quot;peter&quot;]));</span>
<a href="#l102.7"></a><span id="l102.7">     ok(!cal.attendeeMatchesAddresses(a, [&quot;HORSTpeter&quot;, &quot;peter&quot;]));</span>
<a href="#l102.8"></a><span id="l102.8">     ok(!cal.attendeeMatchesAddresses(a, [&quot;peter&quot;]));</span>
<a href="#l102.9"></a><span id="l102.9"> }</span>
<a href="#l102.10"></a><span id="l102.10"> </span>
<a href="#l102.11"></a><span id="l102.11"> function test_getDefaultStartDate() {</span>
<a href="#l102.12"></a><span id="l102.12" class="difflineminus">-    function tt(n, t) {</span>
<a href="#l102.13"></a><span id="l102.13" class="difflineminus">-        now = cal.createDateTime(n);</span>
<a href="#l102.14"></a><span id="l102.14" class="difflineminus">-        return cal.getDefaultStartDate(t ? cal.createDateTime(t) : null);</span>
<a href="#l102.15"></a><span id="l102.15" class="difflineplus">+    function transform(nowString, refDateString) {</span>
<a href="#l102.16"></a><span id="l102.16" class="difflineplus">+        now = cal.createDateTime(nowString);</span>
<a href="#l102.17"></a><span id="l102.17" class="difflineplus">+        let refDate = refDateString ? cal.createDateTime(refDateString) : null;</span>
<a href="#l102.18"></a><span id="l102.18" class="difflineplus">+        return cal.getDefaultStartDate(refDate);</span>
<a href="#l102.19"></a><span id="l102.19">     }</span>
<a href="#l102.20"></a><span id="l102.20"> </span>
<a href="#l102.21"></a><span id="l102.21">     let oldNow = cal.now;</span>
<a href="#l102.22"></a><span id="l102.22">     let now = cal.createDateTime(&quot;20120101T000000&quot;);</span>
<a href="#l102.23"></a><span id="l102.23">     cal.now = function() {</span>
<a href="#l102.24"></a><span id="l102.24">         return now;</span>
<a href="#l102.25"></a><span id="l102.25">     };</span>
<a href="#l102.26"></a><span id="l102.26"> </span>
<a href="#l102.27"></a><span id="l102.27">     dump(&quot;TT: &quot; + cal.createDateTime(&quot;20120101T000000&quot;) + &quot;\n&quot;);</span>
<a href="#l102.28"></a><span id="l102.28">     dump(&quot;TT: &quot; + cal.getDefaultStartDate(cal.createDateTime(&quot;20120101T000000&quot;)) + &quot;\n&quot;);</span>
<a href="#l102.29"></a><span id="l102.29"> </span>
<a href="#l102.30"></a><span id="l102.30" class="difflineminus">-    equal(tt(&quot;20120101T000000&quot;).icalString, &quot;20120101T010000&quot;);</span>
<a href="#l102.31"></a><span id="l102.31" class="difflineminus">-    equal(tt(&quot;20120101T015959&quot;).icalString, &quot;20120101T020000&quot;);</span>
<a href="#l102.32"></a><span id="l102.32" class="difflineminus">-    equal(tt(&quot;20120101T230000&quot;).icalString, &quot;20120101T230000&quot;);</span>
<a href="#l102.33"></a><span id="l102.33" class="difflineminus">-    equal(tt(&quot;20120101T235959&quot;).icalString, &quot;20120101T230000&quot;);</span>
<a href="#l102.34"></a><span id="l102.34" class="difflineplus">+    equal(transform(&quot;20120101T000000&quot;).icalString, &quot;20120101T010000&quot;);</span>
<a href="#l102.35"></a><span id="l102.35" class="difflineplus">+    equal(transform(&quot;20120101T015959&quot;).icalString, &quot;20120101T020000&quot;);</span>
<a href="#l102.36"></a><span id="l102.36" class="difflineplus">+    equal(transform(&quot;20120101T230000&quot;).icalString, &quot;20120101T230000&quot;);</span>
<a href="#l102.37"></a><span id="l102.37" class="difflineplus">+    equal(transform(&quot;20120101T235959&quot;).icalString, &quot;20120101T230000&quot;);</span>
<a href="#l102.38"></a><span id="l102.38"> </span>
<a href="#l102.39"></a><span id="l102.39" class="difflineminus">-    equal(tt(&quot;20120101T000000&quot;, &quot;20120202&quot;).icalString, &quot;20120202T010000&quot;);</span>
<a href="#l102.40"></a><span id="l102.40" class="difflineminus">-    equal(tt(&quot;20120101T015959&quot;, &quot;20120202&quot;).icalString, &quot;20120202T020000&quot;);</span>
<a href="#l102.41"></a><span id="l102.41" class="difflineminus">-    equal(tt(&quot;20120101T230000&quot;, &quot;20120202&quot;).icalString, &quot;20120202T230000&quot;);</span>
<a href="#l102.42"></a><span id="l102.42" class="difflineminus">-    equal(tt(&quot;20120101T235959&quot;, &quot;20120202&quot;).icalString, &quot;20120202T230000&quot;);</span>
<a href="#l102.43"></a><span id="l102.43" class="difflineplus">+    equal(transform(&quot;20120101T000000&quot;, &quot;20120202&quot;).icalString, &quot;20120202T010000&quot;);</span>
<a href="#l102.44"></a><span id="l102.44" class="difflineplus">+    equal(transform(&quot;20120101T015959&quot;, &quot;20120202&quot;).icalString, &quot;20120202T020000&quot;);</span>
<a href="#l102.45"></a><span id="l102.45" class="difflineplus">+    equal(transform(&quot;20120101T230000&quot;, &quot;20120202&quot;).icalString, &quot;20120202T230000&quot;);</span>
<a href="#l102.46"></a><span id="l102.46" class="difflineplus">+    equal(transform(&quot;20120101T235959&quot;, &quot;20120202&quot;).icalString, &quot;20120202T230000&quot;);</span>
<a href="#l102.47"></a><span id="l102.47"> </span>
<a href="#l102.48"></a><span id="l102.48">     let event = cal.createEvent();</span>
<a href="#l102.49"></a><span id="l102.49">     now = cal.createDateTime(&quot;20120101T015959&quot;);</span>
<a href="#l102.50"></a><span id="l102.50">     cal.setDefaultStartEndHour(event, cal.createDateTime(&quot;20120202&quot;));</span>
<a href="#l102.51"></a><span id="l102.51">     equal(event.startDate.icalString, &quot;20120202T020000&quot;);</span>
<a href="#l102.52"></a><span id="l102.52">     equal(event.endDate.icalString, &quot;20120202T030000&quot;);</span>
<a href="#l102.53"></a><span id="l102.53"> </span>
<a href="#l102.54"></a><span id="l102.54">     let todo = cal.createTodo();</span>
<a href="#l102.55"></a><span id="l102.55" class="difflineat">@@ -166,22 +167,22 @@ function test_calOperationGroup() {</span>
<a href="#l102.56"></a><span id="l102.56"> </span>
<a href="#l102.57"></a><span id="l102.57">     equal(group.status, Components.interfaces.calIErrors.OPERATION_CANCELLED);</span>
<a href="#l102.58"></a><span id="l102.58">     ok(!group.isPending);</span>
<a href="#l102.59"></a><span id="l102.59">     ok(cancelCalled);</span>
<a href="#l102.60"></a><span id="l102.60">     ok(pendingOp2.cancelCalled);</span>
<a href="#l102.61"></a><span id="l102.61"> }</span>
<a href="#l102.62"></a><span id="l102.62"> </span>
<a href="#l102.63"></a><span id="l102.63"> function test_sameDay() {</span>
<a href="#l102.64"></a><span id="l102.64" class="difflineminus">-    let dt = cal.createDateTime;</span>
<a href="#l102.65"></a><span id="l102.65" class="difflineplus">+    let createDate = cal.createDateTime.bind(cal);</span>
<a href="#l102.66"></a><span id="l102.66"> </span>
<a href="#l102.67"></a><span id="l102.67" class="difflineminus">-    ok(cal.sameDay(dt(&quot;20120101&quot;), dt(&quot;20120101T120000&quot;)));</span>
<a href="#l102.68"></a><span id="l102.68" class="difflineminus">-    ok(cal.sameDay(dt(&quot;20120101&quot;), dt(&quot;20120101&quot;)));</span>
<a href="#l102.69"></a><span id="l102.69" class="difflineminus">-    ok(!cal.sameDay(dt(&quot;20120101&quot;), dt(&quot;20120102&quot;)));</span>
<a href="#l102.70"></a><span id="l102.70" class="difflineminus">-    ok(!cal.sameDay(dt(&quot;20120101T120000&quot;), dt(&quot;20120102T120000&quot;)));</span>
<a href="#l102.71"></a><span id="l102.71" class="difflineplus">+    ok(cal.sameDay(createDate(&quot;20120101&quot;), createDate(&quot;20120101T120000&quot;)));</span>
<a href="#l102.72"></a><span id="l102.72" class="difflineplus">+    ok(cal.sameDay(createDate(&quot;20120101&quot;), createDate(&quot;20120101&quot;)));</span>
<a href="#l102.73"></a><span id="l102.73" class="difflineplus">+    ok(!cal.sameDay(createDate(&quot;20120101&quot;), createDate(&quot;20120102&quot;)));</span>
<a href="#l102.74"></a><span id="l102.74" class="difflineplus">+    ok(!cal.sameDay(createDate(&quot;20120101T120000&quot;), createDate(&quot;20120102T120000&quot;)));</span>
<a href="#l102.75"></a><span id="l102.75"> }</span>
<a href="#l102.76"></a><span id="l102.76"> </span>
<a href="#l102.77"></a><span id="l102.77"> function test_binarySearch() {</span>
<a href="#l102.78"></a><span id="l102.78">     let arr = [2, 5, 7, 9, 20, 27, 34, 39, 41, 53, 62];</span>
<a href="#l102.79"></a><span id="l102.79">     equal(binarySearch(arr, 27), 5); // Center</span>
<a href="#l102.80"></a><span id="l102.80">     equal(binarySearch(arr, 2), 0); // Left most</span>
<a href="#l102.81"></a><span id="l102.81">     equal(binarySearch(arr, 62), 11); // Right most</span>
<a href="#l102.82"></a><span id="l102.82"> </span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

