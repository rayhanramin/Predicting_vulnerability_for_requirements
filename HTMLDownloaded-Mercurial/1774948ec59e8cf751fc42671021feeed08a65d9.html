<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 964:1774948ec59e8cf751fc42671021feeed08a65d9</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 1774948ec59e8cf751fc42671021feeed08a65d9" />
<meta property="og:url" content="/comm-central/rev/1774948ec59e8cf751fc42671021feeed08a65d9" />
<meta property="og:description" content="remove the speculative gloda message view and some support code.  this code" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 1774948ec59e8cf751fc42671021feeed08a65d9 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/1774948ec59e8cf751fc42671021feeed08a65d9">shortlog</a> |
<a href="/comm-central/log/1774948ec59e8cf751fc42671021feeed08a65d9">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/1774948ec59e8cf751fc42671021feeed08a65d9">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/1774948ec59e8cf751fc42671021feeed08a65d9">files</a> |
changeset |
<a href="/comm-central/raw-rev/1774948ec59e8cf751fc42671021feeed08a65d9">raw</a>  | <a href="/comm-central/archive/1774948ec59e8cf751fc42671021feeed08a65d9.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
remove the speculative gloda message view and some support code.  this code
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#65;&#110;&#100;&#114;&#101;&#119;&#32;&#83;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#32;&#60;&#97;&#115;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#64;&#97;&#115;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#46;&#111;&#114;&#103;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 07 Oct 2008 02:20:37 -0700</td></tr>

<tr>
 <td>changeset 964</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/1774948ec59e8cf751fc42671021feeed08a65d9">1774948ec59e8cf751fc42671021feeed08a65d9</a></td>
</tr>



<tr>
<td>parent 963</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/e0ac27addd7e653f317606dfd7b3b3610c382d77">e0ac27addd7e653f317606dfd7b3b3610c382d77</a>
</td>
</tr>

<tr>
<td>child 965</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/30ffa9c8661a1e766b44c0162f1db6e87c340fa2">30ffa9c8661a1e766b44c0162f1db6e87c340fa2</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=1774948ec59e8cf751fc42671021feeed08a65d9">743</a></td></tr>
<tr><td>push user</td><td>dmosedale@mozilla.com</td></tr>
<tr><td>push date</td><td class="date age">Tue, 04 Nov 2008 20:01:44 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@a79b923a9cba [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=a79b923a9cba395cb3911b27c9599ffb8c997caf">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=a79b923a9cba395cb3911b27c9599ffb8c997caf&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a79b923a9cba395cb3911b27c9599ffb8c997caf&newProject=comm-central&newRevision=d32b4cc6f46d1195ae66fd0cf8395c60b9259ca6&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a79b923a9cba395cb3911b27c9599ffb8c997caf&newProject=comm-central&newRevision=d32b4cc6f46d1195ae66fd0cf8395c60b9259ca6&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a79b923a9cba395cb3911b27c9599ffb8c997caf&newProject=comm-central&newRevision=d32b4cc6f46d1195ae66fd0cf8395c60b9259ca6&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>






</table></div>

<div class="page_body description">remove the speculative gloda message view and some support code.  this code
barely works, and has various issues, so it's best if it wasn't confusing
people by existing.  we can always bring it back later.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1774948ec59e8cf751fc42671021feeed08a65d9/components/glmsgdbview.js">components/glmsgdbview.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/1774948ec59e8cf751fc42671021feeed08a65d9/components/glmsgdbview.js">diff</a> |
<a href="/comm-central/comparison/1774948ec59e8cf751fc42671021feeed08a65d9/components/glmsgdbview.js">comparison</a> |
<a href="/comm-central/log/1774948ec59e8cf751fc42671021feeed08a65d9/components/glmsgdbview.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1774948ec59e8cf751fc42671021feeed08a65d9/modules/utils.js">modules/utils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1774948ec59e8cf751fc42671021feeed08a65d9/modules/utils.js">file</a> |
<a href="/comm-central/annotate/1774948ec59e8cf751fc42671021feeed08a65d9/modules/utils.js">annotate</a> |
<a href="/comm-central/diff/1774948ec59e8cf751fc42671021feeed08a65d9/modules/utils.js">diff</a> |
<a href="/comm-central/comparison/1774948ec59e8cf751fc42671021feeed08a65d9/modules/utils.js">comparison</a> |
<a href="/comm-central/log/1774948ec59e8cf751fc42671021feeed08a65d9/modules/utils.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1">deleted file mode 100644</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineminus">--- a/components/glmsgdbview.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineplus">+++ /dev/null</span>
<a href="#l1.4"></a><span id="l1.4" class="difflineat">@@ -1,1264 +0,0 @@</span>
<a href="#l1.5"></a><span id="l1.5" class="difflineminus">-/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l1.6"></a><span id="l1.6" class="difflineminus">- *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l1.7"></a><span id="l1.7" class="difflineminus">- *</span>
<a href="#l1.8"></a><span id="l1.8" class="difflineminus">- * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l1.9"></a><span id="l1.9" class="difflineminus">- * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l1.10"></a><span id="l1.10" class="difflineminus">- * the License. You may obtain a copy of the License at</span>
<a href="#l1.11"></a><span id="l1.11" class="difflineminus">- * http://www.mozilla.org/MPL/</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">- * </span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">- * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineminus">- * for the specific language governing rights and limitations under the</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineminus">- * License.</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineminus">- *</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineminus">- * The Original Code is Thunderbird Global Database.</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineminus">- *</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineminus">- * The Initial Developer of the Original Code is</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineminus">- * Mozilla Messaging, Inc.</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineminus">- * Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineminus">- * the Initial Developer. All Rights Reserved.</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineminus">- *</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineminus">- * Contributor(s):</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineminus">- *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineminus">- *</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineminus">- * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineminus">- * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineminus">- * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">- * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineminus">- * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineminus">- * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineminus">- * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineminus">- * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineminus">- * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineminus">- * the provisions above, a recipient may use your version of this file under</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineminus">- * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineminus">- * </span>
<a href="#l1.40"></a><span id="l1.40" class="difflineminus">- * ***** END LICENSE BLOCK ***** */</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineminus">-</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineminus">-/*</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineminus">- * This file contains a partially implemented nsIMsgDBView backed by gloda.</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineminus">- * It is not a sufficient replacement for any nsIMsgDBView at this time.</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineminus">- * The plan is to cram messages into a cross-folder search view implementation</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineminus">- *  and use it to display the gloda messages for now. </span>
<a href="#l1.47"></a><span id="l1.47" class="difflineminus">- */</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineminus">-</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineminus">-const Cc = Components.classes;</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineminus">-const Ci = Components.interfaces;</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineminus">-const Cr = Components.results;</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineminus">-const Cu = Components.utils;</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineminus">-</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineminus">-Cu.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineminus">-</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineminus">-// because of the XPCOM creation stuff, we need to import our globals later...</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineminus">-var Gloda = null;</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineminus">-var GlodaUtils = null;</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineminus">-</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineminus">-// flags are from MailNewsTypes.h</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineminus">-// -- status flags</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineminus">-const MSG_FLAG_READ      = 0x0001;</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineminus">-const MSG_FLAG_REPLIED   = 0x0002;</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineminus">-const MSG_FLAG_FORWARDED = 0x1000;</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineminus">-const MSG_FLAG_NEW       = 0x10000;</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineminus">-// -- general use flags</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineminus">-const MSG_FLAG_ATTACHMENT = 0x10000000;</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineminus">-</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineminus">-const NO_SUCH_MESSAGE_KEY = 0xFFFFFFFF; // nsMsgKey_none</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineminus">-const NO_SUCH_VIEW_INDEX = 0xFFFFFFFF;</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineminus">-</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineminus">-function messageStatusString(aFlags) {</span>
<a href="#l1.73"></a><span id="l1.73" class="difflineminus">-  if (aFlags &amp; MSG_FLAG_REPLIED)</span>
<a href="#l1.74"></a><span id="l1.74" class="difflineminus">-    return &quot;replied&quot;; // L10N-me</span>
<a href="#l1.75"></a><span id="l1.75" class="difflineminus">-  if (aFlags &amp; MSG_FLAG_FORWARDED)</span>
<a href="#l1.76"></a><span id="l1.76" class="difflineminus">-    return &quot;forwarded&quot;; // L10N-me</span>
<a href="#l1.77"></a><span id="l1.77" class="difflineminus">-  if (aFlags &amp; MSG_FLAG_NEW)</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineminus">-    return &quot;new&quot;; // L10N-me</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineminus">-  if (aFlags &amp; MSG_FLAG_READ)</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineminus">-    return &quot;read&quot;; // L10N-me</span>
<a href="#l1.81"></a><span id="l1.81" class="difflineminus">-}</span>
<a href="#l1.82"></a><span id="l1.82" class="difflineminus">-</span>
<a href="#l1.83"></a><span id="l1.83" class="difflineminus">-function messagePriorityString(aPriority) { // L10n-me, XXX ugly</span>
<a href="#l1.84"></a><span id="l1.84" class="difflineminus">-  switch (aPriority) {</span>
<a href="#l1.85"></a><span id="l1.85" class="difflineminus">-    case Ci.nsMsgPriority.normal:</span>
<a href="#l1.86"></a><span id="l1.86" class="difflineminus">-      return &quot;normal&quot;;</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineminus">-    case Ci.nsMsgPriority.notSet:</span>
<a href="#l1.88"></a><span id="l1.88" class="difflineminus">-      return &quot;not set&quot;;</span>
<a href="#l1.89"></a><span id="l1.89" class="difflineminus">-    case Ci.nsMsgPriority.lowest:</span>
<a href="#l1.90"></a><span id="l1.90" class="difflineminus">-      return &quot;lowest&quot;;</span>
<a href="#l1.91"></a><span id="l1.91" class="difflineminus">-    case Ci.nsMsgPriority.low:</span>
<a href="#l1.92"></a><span id="l1.92" class="difflineminus">-      return &quot;low&quot;;</span>
<a href="#l1.93"></a><span id="l1.93" class="difflineminus">-    case Ci.nsMsgPriority.high:</span>
<a href="#l1.94"></a><span id="l1.94" class="difflineminus">-      return &quot;high&quot;;</span>
<a href="#l1.95"></a><span id="l1.95" class="difflineminus">-    case Ci.nsMsgPriority.highest:</span>
<a href="#l1.96"></a><span id="l1.96" class="difflineminus">-      return &quot;highest&quot;;</span>
<a href="#l1.97"></a><span id="l1.97" class="difflineminus">-    default:</span>
<a href="#l1.98"></a><span id="l1.98" class="difflineminus">-      return &quot;illegal&quot;;</span>
<a href="#l1.99"></a><span id="l1.99" class="difflineminus">-  }</span>
<a href="#l1.100"></a><span id="l1.100" class="difflineminus">-}</span>
<a href="#l1.101"></a><span id="l1.101" class="difflineminus">-</span>
<a href="#l1.102"></a><span id="l1.102" class="difflineminus">-const SORT_NONE = Ci.nsMsgViewSortOrder.none;</span>
<a href="#l1.103"></a><span id="l1.103" class="difflineminus">-const SORT_ASCENDING = Ci.nsMsgViewSortOrder.ascending;</span>
<a href="#l1.104"></a><span id="l1.104" class="difflineminus">-const SORT_DESCENDING = Ci.nsMsgViewSortOrder.descending;</span>
<a href="#l1.105"></a><span id="l1.105" class="difflineminus">-</span>
<a href="#l1.106"></a><span id="l1.106" class="difflineminus">-function GMTreeNode(aMessage) {</span>
<a href="#l1.107"></a><span id="l1.107" class="difflineminus">-  this.message = aMessage;</span>
<a href="#l1.108"></a><span id="l1.108" class="difflineminus">-  this.parent = null;</span>
<a href="#l1.109"></a><span id="l1.109" class="difflineminus">-  this.children = null;</span>
<a href="#l1.110"></a><span id="l1.110" class="difflineminus">-  this.open = false;</span>
<a href="#l1.111"></a><span id="l1.111" class="difflineminus">-  this.level = 0;</span>
<a href="#l1.112"></a><span id="l1.112" class="difflineminus">-}</span>
<a href="#l1.113"></a><span id="l1.113" class="difflineminus">-</span>
<a href="#l1.114"></a><span id="l1.114" class="difflineminus">-GMTreeNode.prototype = {</span>
<a href="#l1.115"></a><span id="l1.115" class="difflineminus">-  setLevel: function(aLevel) {</span>
<a href="#l1.116"></a><span id="l1.116" class="difflineminus">-    this.level = aLevel;</span>
<a href="#l1.117"></a><span id="l1.117" class="difflineminus">-    if (this.children) {</span>
<a href="#l1.118"></a><span id="l1.118" class="difflineminus">-      for (let iChild = 0; iChild &lt; this.children.length; iChild++) {</span>
<a href="#l1.119"></a><span id="l1.119" class="difflineminus">-        this.children[iChild].setLevel(aLevel+1);</span>
<a href="#l1.120"></a><span id="l1.120" class="difflineminus">-      }</span>
<a href="#l1.121"></a><span id="l1.121" class="difflineminus">-    }</span>
<a href="#l1.122"></a><span id="l1.122" class="difflineminus">-  },</span>
<a href="#l1.123"></a><span id="l1.123" class="difflineminus">-  </span>
<a href="#l1.124"></a><span id="l1.124" class="difflineminus">-  get nodesInSubTree() {</span>
<a href="#l1.125"></a><span id="l1.125" class="difflineminus">-    let numNodes = 1;</span>
<a href="#l1.126"></a><span id="l1.126" class="difflineminus">-    if (this.children) {</span>
<a href="#l1.127"></a><span id="l1.127" class="difflineminus">-      for (let iChild = 0; iChild &lt; this.children.length; iChild++)</span>
<a href="#l1.128"></a><span id="l1.128" class="difflineminus">-        numNodes += this.children[iChild].nodesInSubTree;</span>
<a href="#l1.129"></a><span id="l1.129" class="difflineminus">-    }</span>
<a href="#l1.130"></a><span id="l1.130" class="difflineminus">-    return numNodes;</span>
<a href="#l1.131"></a><span id="l1.131" class="difflineminus">-  },</span>
<a href="#l1.132"></a><span id="l1.132" class="difflineminus">-  </span>
<a href="#l1.133"></a><span id="l1.133" class="difflineminus">-  // this pierces the message representation, which is unusual, but ok.</span>
<a href="#l1.134"></a><span id="l1.134" class="difflineminus">-  get unreadInSubTree() {</span>
<a href="#l1.135"></a><span id="l1.135" class="difflineminus">-    let numUnread = this.message.folderMessage.isRead ? 0 : 1;</span>
<a href="#l1.136"></a><span id="l1.136" class="difflineminus">-    if (this.children) {</span>
<a href="#l1.137"></a><span id="l1.137" class="difflineminus">-      for (let iChild = 0; iChild &lt; this.children.length; iChild++)</span>
<a href="#l1.138"></a><span id="l1.138" class="difflineminus">-        numUnread += this.children[iChild].unreadInSubTree;</span>
<a href="#l1.139"></a><span id="l1.139" class="difflineminus">-    }</span>
<a href="#l1.140"></a><span id="l1.140" class="difflineminus">-    return numUnread;</span>
<a href="#l1.141"></a><span id="l1.141" class="difflineminus">-  },</span>
<a href="#l1.142"></a><span id="l1.142" class="difflineminus">-};</span>
<a href="#l1.143"></a><span id="l1.143" class="difflineminus">-</span>
<a href="#l1.144"></a><span id="l1.144" class="difflineminus">-function GlodaMsgDBView() {</span>
<a href="#l1.145"></a><span id="l1.145" class="difflineminus">-  this.wrappedJSObject = this;</span>
<a href="#l1.146"></a><span id="l1.146" class="difflineminus">-</span>
<a href="#l1.147"></a><span id="l1.147" class="difflineminus">-  this._messenger = null;</span>
<a href="#l1.148"></a><span id="l1.148" class="difflineminus">-  this._msgWindow = null;</span>
<a href="#l1.149"></a><span id="l1.149" class="difflineminus">-  this._commandUpdater = null;</span>
<a href="#l1.150"></a><span id="l1.150" class="difflineminus">-</span>
<a href="#l1.151"></a><span id="l1.151" class="difflineminus">-  this._sortType = Ci.nsMsgViewSortType.byDate;</span>
<a href="#l1.152"></a><span id="l1.152" class="difflineminus">-  this._sortOrder = SORT_DESCENDING;</span>
<a href="#l1.153"></a><span id="l1.153" class="difflineminus">-  this._viewFlags = Ci.nsMsgViewFlagsType.kNone;</span>
<a href="#l1.154"></a><span id="l1.154" class="difflineminus">-  </span>
<a href="#l1.155"></a><span id="l1.155" class="difflineminus">-  this._collection = null;</span>
<a href="#l1.156"></a><span id="l1.156" class="difflineminus">-  this._messages = [];</span>
<a href="#l1.157"></a><span id="l1.157" class="difflineminus">-  this._toplevelNodes = [];</span>
<a href="#l1.158"></a><span id="l1.158" class="difflineminus">-  this._rows = [];</span>
<a href="#l1.159"></a><span id="l1.159" class="difflineminus">-  this._idToNode = null;</span>
<a href="#l1.160"></a><span id="l1.160" class="difflineminus">-  </span>
<a href="#l1.161"></a><span id="l1.161" class="difflineminus">-  this._customColumns = {};</span>
<a href="#l1.162"></a><span id="l1.162" class="difflineminus">-  this._customSortColumn = null;</span>
<a href="#l1.163"></a><span id="l1.163" class="difflineminus">-  </span>
<a href="#l1.164"></a><span id="l1.164" class="difflineminus">-  this._treeSelection = null;</span>
<a href="#l1.165"></a><span id="l1.165" class="difflineminus">-  this._selectedNodes = null;</span>
<a href="#l1.166"></a><span id="l1.166" class="difflineminus">-  this._selectedIndices = null;</span>
<a href="#l1.167"></a><span id="l1.167" class="difflineminus">-  </span>
<a href="#l1.168"></a><span id="l1.168" class="difflineminus">-  //: the currently displayed message's node</span>
<a href="#l1.169"></a><span id="l1.169" class="difflineminus">-  this._displayedNode = null;</span>
<a href="#l1.170"></a><span id="l1.170" class="difflineminus">-  </span>
<a href="#l1.171"></a><span id="l1.171" class="difflineminus">-  this._suppressDisplay = false;</span>
<a href="#l1.172"></a><span id="l1.172" class="difflineminus">-  </span>
<a href="#l1.173"></a><span id="l1.173" class="difflineminus">-  // set up our awesome globals!</span>
<a href="#l1.174"></a><span id="l1.174" class="difflineminus">-  if (Gloda === null) {</span>
<a href="#l1.175"></a><span id="l1.175" class="difflineminus">-    let loadNS = {};</span>
<a href="#l1.176"></a><span id="l1.176" class="difflineminus">-    Cu.import(&quot;resource://gloda/modules/gloda.js&quot;, loadNS);</span>
<a href="#l1.177"></a><span id="l1.177" class="difflineminus">-    Gloda = loadNS.Gloda;</span>
<a href="#l1.178"></a><span id="l1.178" class="difflineminus">-    Cu.import(&quot;resource://gloda/modules/utils.js&quot;, loadNS);</span>
<a href="#l1.179"></a><span id="l1.179" class="difflineminus">-    GlodaUtils = loadNS.GlodaUtils;</span>
<a href="#l1.180"></a><span id="l1.180" class="difflineminus">-  }</span>
<a href="#l1.181"></a><span id="l1.181" class="difflineminus">-  </span>
<a href="#l1.182"></a><span id="l1.182" class="difflineminus">-  try {</span>
<a href="#l1.183"></a><span id="l1.183" class="difflineminus">-    this._initComparisonFuncs();</span>
<a href="#l1.184"></a><span id="l1.184" class="difflineminus">-  }</span>
<a href="#l1.185"></a><span id="l1.185" class="difflineminus">-  catch (ex) {</span>
<a href="#l1.186"></a><span id="l1.186" class="difflineminus">-    dump(&quot;Exception (source: &quot; + ex.fileName + &quot;:&quot; + ex.lineNumber + &quot;) &quot; +</span>
<a href="#l1.187"></a><span id="l1.187" class="difflineminus">-         ex + &quot;\n&quot;);</span>
<a href="#l1.188"></a><span id="l1.188" class="difflineminus">-  }</span>
<a href="#l1.189"></a><span id="l1.189" class="difflineminus">-}</span>
<a href="#l1.190"></a><span id="l1.190" class="difflineminus">-</span>
<a href="#l1.191"></a><span id="l1.191" class="difflineminus">-GlodaMsgDBView.prototype = {</span>
<a href="#l1.192"></a><span id="l1.192" class="difflineminus">-  classDescription: &quot;Gloda Message View&quot;,</span>
<a href="#l1.193"></a><span id="l1.193" class="difflineminus">-  classID: Components.ID(&quot;{b7979f43-0188-445a-92e0-492350047254}&quot;),</span>
<a href="#l1.194"></a><span id="l1.194" class="difflineminus">-  contractID: &quot;@mozilla.org/messenger/msgdbview;1?type=gloda&quot;,</span>
<a href="#l1.195"></a><span id="l1.195" class="difflineminus">-  </span>
<a href="#l1.196"></a><span id="l1.196" class="difflineminus">-  QueryInterface: XPCOMUtils.generateQI([Ci.nsIMsgDBView,</span>
<a href="#l1.197"></a><span id="l1.197" class="difflineminus">-                                         Ci.nsITreeView]),</span>
<a href="#l1.198"></a><span id="l1.198" class="difflineminus">-</span>
<a href="#l1.199"></a><span id="l1.199" class="difflineminus">-  get _isThreaded() {</span>
<a href="#l1.200"></a><span id="l1.200" class="difflineminus">-    return this._viewFlags &amp; Ci.nsMsgViewFlagsType.kThreadedDisplay;</span>
<a href="#l1.201"></a><span id="l1.201" class="difflineminus">-  },</span>
<a href="#l1.202"></a><span id="l1.202" class="difflineminus">-  </span>
<a href="#l1.203"></a><span id="l1.203" class="difflineminus">-  get _isGroupBySort() {</span>
<a href="#l1.204"></a><span id="l1.204" class="difflineminus">-    return this._viewFlags &amp; Ci.nsMsgViewFlagsType.kGroupBySort;</span>
<a href="#l1.205"></a><span id="l1.205" class="difflineminus">-  },</span>
<a href="#l1.206"></a><span id="l1.206" class="difflineminus">-  </span>
<a href="#l1.207"></a><span id="l1.207" class="difflineminus">-  /**</span>
<a href="#l1.208"></a><span id="l1.208" class="difflineminus">-   * Return the list of currently selected GMTreeNodes.  Special-casing handles</span>
<a href="#l1.209"></a><span id="l1.209" class="difflineminus">-   *  the &quot;stand alone mode&quot; where we lack a _treeSelection.</span>
<a href="#l1.210"></a><span id="l1.210" class="difflineminus">-   */</span>
<a href="#l1.211"></a><span id="l1.211" class="difflineminus">-  get selectedNodes() {</span>
<a href="#l1.212"></a><span id="l1.212" class="difflineminus">-    if (this._selectedNodes === null) {</span>
<a href="#l1.213"></a><span id="l1.213" class="difflineminus">-      if (this._treeSelection !== null) {</span>
<a href="#l1.214"></a><span id="l1.214" class="difflineminus">-        let selNodes;</span>
<a href="#l1.215"></a><span id="l1.215" class="difflineminus">-        this._selectedNodes = selNodes = [];</span>
<a href="#l1.216"></a><span id="l1.216" class="difflineminus">-        </span>
<a href="#l1.217"></a><span id="l1.217" class="difflineminus">-        let rangeCount = this._treeSelection.getRangeCount();</span>
<a href="#l1.218"></a><span id="l1.218" class="difflineminus">-        let rangeMinObj = {}, rangeMaxObj = {};</span>
<a href="#l1.219"></a><span id="l1.219" class="difflineminus">-        for (let iRange = 0; iRange &lt; rangeCount; iRange++) {</span>
<a href="#l1.220"></a><span id="l1.220" class="difflineminus">-          this._treeSelection.getRangeAt(iRange, rangeMinObj, rangeMaxObj);</span>
<a href="#l1.221"></a><span id="l1.221" class="difflineminus">-          selNodes.push.apply(selNodes, this._rows.slice(rangeMinObj.value,</span>
<a href="#l1.222"></a><span id="l1.222" class="difflineminus">-                                                         rangeMaxObj.value+1));</span>
<a href="#l1.223"></a><span id="l1.223" class="difflineminus">-        }</span>
<a href="#l1.224"></a><span id="l1.224" class="difflineminus">-      }</span>
<a href="#l1.225"></a><span id="l1.225" class="difflineminus">-      else if (this._displayedNode) { // stand-alone mode</span>
<a href="#l1.226"></a><span id="l1.226" class="difflineminus">-        this._selectedNodes = [this._displayedNode];</span>
<a href="#l1.227"></a><span id="l1.227" class="difflineminus">-      }</span>
<a href="#l1.228"></a><span id="l1.228" class="difflineminus">-      else</span>
<a href="#l1.229"></a><span id="l1.229" class="difflineminus">-        this._selectedNodes = [];</span>
<a href="#l1.230"></a><span id="l1.230" class="difflineminus">-    }</span>
<a href="#l1.231"></a><span id="l1.231" class="difflineminus">-    return this._selectedNodes;</span>
<a href="#l1.232"></a><span id="l1.232" class="difflineminus">-  },</span>
<a href="#l1.233"></a><span id="l1.233" class="difflineminus">-  </span>
<a href="#l1.234"></a><span id="l1.234" class="difflineminus">-  get selectedIndices() {</span>
<a href="#l1.235"></a><span id="l1.235" class="difflineminus">-    if (this._selectedIndices === null) {</span>
<a href="#l1.236"></a><span id="l1.236" class="difflineminus">-      if (this._treeSelection !== null) {</span>
<a href="#l1.237"></a><span id="l1.237" class="difflineminus">-        let selIndices;</span>
<a href="#l1.238"></a><span id="l1.238" class="difflineminus">-        this._selectedIndices = selIndices = [];</span>
<a href="#l1.239"></a><span id="l1.239" class="difflineminus">-        </span>
<a href="#l1.240"></a><span id="l1.240" class="difflineminus">-        let rangeCount = this._treeSelection.getRangeCount();</span>
<a href="#l1.241"></a><span id="l1.241" class="difflineminus">-        let rangeMinObj = {}, rangeMaxObj = {};</span>
<a href="#l1.242"></a><span id="l1.242" class="difflineminus">-        for (let iRange = 0; iRange &lt; rangeCount; iRange++) {</span>
<a href="#l1.243"></a><span id="l1.243" class="difflineminus">-          this._treeSelection.getRangeAt(iRange, rangeMinObj, rangeMaxObj);</span>
<a href="#l1.244"></a><span id="l1.244" class="difflineminus">-          let rangeMax = rangeMaxObj.value;</span>
<a href="#l1.245"></a><span id="l1.245" class="difflineminus">-          for (let i = rangeMinObj.value; i &lt; rangeMaxObj.value; i++)</span>
<a href="#l1.246"></a><span id="l1.246" class="difflineminus">-            selIndices.push(i);</span>
<a href="#l1.247"></a><span id="l1.247" class="difflineminus">-        }</span>
<a href="#l1.248"></a><span id="l1.248" class="difflineminus">-      }</span>
<a href="#l1.249"></a><span id="l1.249" class="difflineminus">-      else if (this._displayedNode) { // stand-alone mode</span>
<a href="#l1.250"></a><span id="l1.250" class="difflineminus">-        this._selectedIndices = [this._rows.indexOf(this._displayedNode)];</span>
<a href="#l1.251"></a><span id="l1.251" class="difflineminus">-      }</span>
<a href="#l1.252"></a><span id="l1.252" class="difflineminus">-      else</span>
<a href="#l1.253"></a><span id="l1.253" class="difflineminus">-        this._selectedIndices = [];</span>
<a href="#l1.254"></a><span id="l1.254" class="difflineminus">-    }</span>
<a href="#l1.255"></a><span id="l1.255" class="difflineminus">-    return this._selectedIndices;</span>
<a href="#l1.256"></a><span id="l1.256" class="difflineminus">-  },</span>
<a href="#l1.257"></a><span id="l1.257" class="difflineminus">-</span>
<a href="#l1.258"></a><span id="l1.258" class="difflineminus">-  _comparisonFuncs: null,</span>
<a href="#l1.259"></a><span id="l1.259" class="difflineminus">-  _initComparisonFuncs: function() {</span>
<a href="#l1.260"></a><span id="l1.260" class="difflineminus">-    if (this._comparisonFuncs !== null)</span>
<a href="#l1.261"></a><span id="l1.261" class="difflineminus">-      return;</span>
<a href="#l1.262"></a><span id="l1.262" class="difflineminus">-    this.__proto__._comparisonFuncs = {};</span>
<a href="#l1.263"></a><span id="l1.263" class="difflineminus">-    </span>
<a href="#l1.264"></a><span id="l1.264" class="difflineminus">-    // Ci.nsMsgViewSortType.byNone means do nothing!</span>
<a href="#l1.265"></a><span id="l1.265" class="difflineminus">-    this._comparisonFuncs[Ci.nsMsgViewSortType.byDate] = function(a, b) {</span>
<a href="#l1.266"></a><span id="l1.266" class="difflineminus">-      return a.message.date - b.message.date;</span>
<a href="#l1.267"></a><span id="l1.267" class="difflineminus">-    };</span>
<a href="#l1.268"></a><span id="l1.268" class="difflineminus">-    this._comparisonFuncs[Ci.nsMsgViewSortType.bySubject] = function(a, b) {</span>
<a href="#l1.269"></a><span id="l1.269" class="difflineminus">-      return a.message.conversation.subject.localeCompare(</span>
<a href="#l1.270"></a><span id="l1.270" class="difflineminus">-        b.message.conversation.subject);</span>
<a href="#l1.271"></a><span id="l1.271" class="difflineminus">-    };</span>
<a href="#l1.272"></a><span id="l1.272" class="difflineminus">-    this._comparisonFuncs[Ci.nsMsgViewSortType.byAuthor] = function(a, b) {</span>
<a href="#l1.273"></a><span id="l1.273" class="difflineminus">-      return a.message.from.contact.name.localeCompare(</span>
<a href="#l1.274"></a><span id="l1.274" class="difflineminus">-        b.message.from.contact.name);</span>
<a href="#l1.275"></a><span id="l1.275" class="difflineminus">-    };</span>
<a href="#l1.276"></a><span id="l1.276" class="difflineminus">-    this._comparisonFuncs[Ci.nsMsgViewSortType.byId] = function(a, b) {</span>
<a href="#l1.277"></a><span id="l1.277" class="difflineminus">-      return a.message.headerMessageId.localeCompare(</span>
<a href="#l1.278"></a><span id="l1.278" class="difflineminus">-        b.message.headerMessageId);</span>
<a href="#l1.279"></a><span id="l1.279" class="difflineminus">-    };</span>
<a href="#l1.280"></a><span id="l1.280" class="difflineminus">-    // Ci.nsMsgViewSortType.byThread is special (and apparently a nop)</span>
<a href="#l1.281"></a><span id="l1.281" class="difflineminus">-    this._comparisonFuncs[Ci.nsMsgViewSortType.byPriority] = function(a, b) {</span>
<a href="#l1.282"></a><span id="l1.282" class="difflineminus">-      // XXX this might be backwards</span>
<a href="#l1.283"></a><span id="l1.283" class="difflineminus">-      return a.message.folderMessage.priority -</span>
<a href="#l1.284"></a><span id="l1.284" class="difflineminus">-        b.message.folderMessage.priority;</span>
<a href="#l1.285"></a><span id="l1.285" class="difflineminus">-    };</span>
<a href="#l1.286"></a><span id="l1.286" class="difflineminus">-    this._comparisonFuncs[Ci.nsMsgViewSortType.byStatus] = function(a, b) {</span>
<a href="#l1.287"></a><span id="l1.287" class="difflineminus">-      let aStatus = messageStatusString(a.message.folderMessage.flags);</span>
<a href="#l1.288"></a><span id="l1.288" class="difflineminus">-      let bStatus = messageStatusString(b.message.folderMessage.flags);</span>
<a href="#l1.289"></a><span id="l1.289" class="difflineminus">-      return aStatus.localeCompare(bStatus);</span>
<a href="#l1.290"></a><span id="l1.290" class="difflineminus">-    };</span>
<a href="#l1.291"></a><span id="l1.291" class="difflineminus">-    this._comparisonFuncs[Ci.nsMsgViewSortType.bySize] = function(a, b) {</span>
<a href="#l1.292"></a><span id="l1.292" class="difflineminus">-      // XXX line usage predication</span>
<a href="#l1.293"></a><span id="l1.293" class="difflineminus">-      return a.message.folderMessage.messageSize -</span>
<a href="#l1.294"></a><span id="l1.294" class="difflineminus">-        b.message.folderMessage.messageSize;</span>
<a href="#l1.295"></a><span id="l1.295" class="difflineminus">-    };</span>
<a href="#l1.296"></a><span id="l1.296" class="difflineminus">-    this._comparisonFuncs[Ci.nsMsgViewSortType.byFlagged] = function(a, b) {</span>
<a href="#l1.297"></a><span id="l1.297" class="difflineminus">-      // XXX this might be backwards... starred as earlier for now</span>
<a href="#l1.298"></a><span id="l1.298" class="difflineminus">-      // TODO: when starred status is tracked immediately, use our message rep.</span>
<a href="#l1.299"></a><span id="l1.299" class="difflineminus">-      let aFlagged = a.message.folderMessage.isFlagged ? 1 : 0;</span>
<a href="#l1.300"></a><span id="l1.300" class="difflineminus">-      let bFlagged = b.message.folderMessage.isFlagged ? 1 : 0;</span>
<a href="#l1.301"></a><span id="l1.301" class="difflineminus">-      return bFlagged - aFlagged;</span>
<a href="#l1.302"></a><span id="l1.302" class="difflineminus">-    };</span>
<a href="#l1.303"></a><span id="l1.303" class="difflineminus">-    this._comparisonFuncs[Ci.nsMsgViewSortType.byUnread] = function(a, b) {</span>
<a href="#l1.304"></a><span id="l1.304" class="difflineminus">-      // XXX this might be backwards... unread as earlier for now</span>
<a href="#l1.305"></a><span id="l1.305" class="difflineminus">-      // TODO: when unread status is tracked immediately, use our message rep.</span>
<a href="#l1.306"></a><span id="l1.306" class="difflineminus">-      let aUnread = a.message.folderMessage.isRead ? 0 : 1;</span>
<a href="#l1.307"></a><span id="l1.307" class="difflineminus">-      let bUnread = b.message.folderMessage.isRead ? 0 : 1;</span>
<a href="#l1.308"></a><span id="l1.308" class="difflineminus">-      return bUnread - aUnread;</span>
<a href="#l1.309"></a><span id="l1.309" class="difflineminus">-    };</span>
<a href="#l1.310"></a><span id="l1.310" class="difflineminus">-    this._comparisonFuncs[Ci.nsMsgViewSortType.byRecipient] = function(a, b) {</span>
<a href="#l1.311"></a><span id="l1.311" class="difflineminus">-      let aRecip = a.message.folderMessage.recipients;</span>
<a href="#l1.312"></a><span id="l1.312" class="difflineminus">-      let bRecip = b.message.folderMessage.recipients;</span>
<a href="#l1.313"></a><span id="l1.313" class="difflineminus">-      return aRecip.localeCompare(bRecip); </span>
<a href="#l1.314"></a><span id="l1.314" class="difflineminus">-    };</span>
<a href="#l1.315"></a><span id="l1.315" class="difflineminus">-    this._comparisonFuncs[Ci.nsMsgViewSortType.byLocation] = function(a, b) {</span>
<a href="#l1.316"></a><span id="l1.316" class="difflineminus">-      return a.message.folderURI.localeCompare(b.message.folderURI);</span>
<a href="#l1.317"></a><span id="l1.317" class="difflineminus">-    };</span>
<a href="#l1.318"></a><span id="l1.318" class="difflineminus">-    this._comparisonFuncs[Ci.nsMsgViewSortType.byTags] = function(a, b) {</span>
<a href="#l1.319"></a><span id="l1.319" class="difflineminus">-      let aKeywords = a.message.folderMessage.getStringProperty(&quot;keywords&quot;);</span>
<a href="#l1.320"></a><span id="l1.320" class="difflineminus">-      let bKeywords = b.message.folderMessage.getStringProperty(&quot;keywords&quot;);</span>
<a href="#l1.321"></a><span id="l1.321" class="difflineminus">-      return aKeywords.localeCompare(bKeywords);</span>
<a href="#l1.322"></a><span id="l1.322" class="difflineminus">-    };</span>
<a href="#l1.323"></a><span id="l1.323" class="difflineminus">-    this._comparisonFuncs[Ci.nsMsgViewSortType.byJunkStatus] = function(a, b) {</span>
<a href="#l1.324"></a><span id="l1.324" class="difflineminus">-      // XXX backwards?</span>
<a href="#l1.325"></a><span id="l1.325" class="difflineminus">-      let aScore = a.message.folderMessage.getStringProperty(&quot;junkscore&quot;);</span>
<a href="#l1.326"></a><span id="l1.326" class="difflineminus">-      let bScore = b.message.folderMessage.getStringProperty(&quot;junkscore&quot;);</span>
<a href="#l1.327"></a><span id="l1.327" class="difflineminus">-      let aNum = aScore ? parseInt(aScore) : 0;</span>
<a href="#l1.328"></a><span id="l1.328" class="difflineminus">-      let bNum = bScore ? parseInt(bScore) : 0;</span>
<a href="#l1.329"></a><span id="l1.329" class="difflineminus">-      return aNum - bNum;</span>
<a href="#l1.330"></a><span id="l1.330" class="difflineminus">-    };</span>
<a href="#l1.331"></a><span id="l1.331" class="difflineminus">-    this._comparisonFuncs[Ci.nsMsgViewSortType.byAttachments] = function(a, b) {</span>
<a href="#l1.332"></a><span id="l1.332" class="difflineminus">-      // XXX backwards?</span>
<a href="#l1.333"></a><span id="l1.333" class="difflineminus">-      let aAttach = a.message.folderMessage.flags&amp;MSG_FLAG_ATTACHMENT ? 1 : 0;</span>
<a href="#l1.334"></a><span id="l1.334" class="difflineminus">-      let bAttach = b.message.folderMessage.flags&amp;MSG_FLAG_ATTACHMENT ? 1 : 0;</span>
<a href="#l1.335"></a><span id="l1.335" class="difflineminus">-      return aAttach - bAttach;</span>
<a href="#l1.336"></a><span id="l1.336" class="difflineminus">-    };</span>
<a href="#l1.337"></a><span id="l1.337" class="difflineminus">-    this._comparisonFuncs[Ci.nsMsgViewSortType.byAccount] = function(a, b) {</span>
<a href="#l1.338"></a><span id="l1.338" class="difflineminus">-      // XXX should use more gloda-centric account conceptualization</span>
<a href="#l1.339"></a><span id="l1.339" class="difflineminus">-      return a.message.folderMessage.accountKey.localeCompare(</span>
<a href="#l1.340"></a><span id="l1.340" class="difflineminus">-        b.message.folderMessage.accountKey);</span>
<a href="#l1.341"></a><span id="l1.341" class="difflineminus">-    };</span>
<a href="#l1.342"></a><span id="l1.342" class="difflineminus">-    // Ci.nsMsgViewSortType.byCustom is handled specially</span>
<a href="#l1.343"></a><span id="l1.343" class="difflineminus">-    this._comparisonFuncs[Ci.nsMsgViewSortType.byReceived] = function(a, b) {</span>
<a href="#l1.344"></a><span id="l1.344" class="difflineminus">-      let aRec = a.message.folderMessage.getUint32Property(&quot;dateReceived&quot;);</span>
<a href="#l1.345"></a><span id="l1.345" class="difflineminus">-      let bRec = b.message.folderMessage.getUint32Property(&quot;dateReceived&quot;);</span>
<a href="#l1.346"></a><span id="l1.346" class="difflineminus">-      return aRec - bRec;</span>
<a href="#l1.347"></a><span id="l1.347" class="difflineminus">-    };</span>
<a href="#l1.348"></a><span id="l1.348" class="difflineminus">-  },</span>
<a href="#l1.349"></a><span id="l1.349" class="difflineminus">-  </span>
<a href="#l1.350"></a><span id="l1.350" class="difflineminus">-  onItemsAdded: function gloda_mdbv_itemsAdded(aItems) {</span>
<a href="#l1.351"></a><span id="l1.351" class="difflineminus">-  },</span>
<a href="#l1.352"></a><span id="l1.352" class="difflineminus">-  onItemsModified: function gloda_mdbv_itemsModified(aItems) {</span>
<a href="#l1.353"></a><span id="l1.353" class="difflineminus">-  },</span>
<a href="#l1.354"></a><span id="l1.354" class="difflineminus">-  onItemsRemoved: function gloda_mdbv_itemsRemoved(aItems) {</span>
<a href="#l1.355"></a><span id="l1.355" class="difflineminus">-  },</span>
<a href="#l1.356"></a><span id="l1.356" class="difflineminus">-  </span>
<a href="#l1.357"></a><span id="l1.357" class="difflineminus">-  _sort: function gloda_mdbv_realSort() {</span>
<a href="#l1.358"></a><span id="l1.358" class="difflineminus">-    // TODO: kShowIgnored</span>
<a href="#l1.359"></a><span id="l1.359" class="difflineminus">-    // TODO: kUnreadOnly</span>
<a href="#l1.360"></a><span id="l1.360" class="difflineminus">-    // TODO: kExpandAll</span>
<a href="#l1.361"></a><span id="l1.361" class="difflineminus">-    let allExpanded = false;</span>
<a href="#l1.362"></a><span id="l1.362" class="difflineminus">-    </span>
<a href="#l1.363"></a><span id="l1.363" class="difflineminus">-    let nodes;</span>
<a href="#l1.364"></a><span id="l1.364" class="difflineminus">-    let idToNode = {};</span>
<a href="#l1.365"></a><span id="l1.365" class="difflineminus">-  </span>
<a href="#l1.366"></a><span id="l1.366" class="difflineminus">-    if (this._isThreaded) {</span>
<a href="#l1.367"></a><span id="l1.367" class="difflineminus">-      nodes = [];</span>
<a href="#l1.368"></a><span id="l1.368" class="difflineminus">-      // cluster by conversation</span>
<a href="#l1.369"></a><span id="l1.369" class="difflineminus">-      let conversations = {};</span>
<a href="#l1.370"></a><span id="l1.370" class="difflineminus">-      let dupeCheck = {};</span>
<a href="#l1.371"></a><span id="l1.371" class="difflineminus">-      </span>
<a href="#l1.372"></a><span id="l1.372" class="difflineminus">-      for (let iMsg = 0; iMsg &lt; this._messages.length; iMsg++) {</span>
<a href="#l1.373"></a><span id="l1.373" class="difflineminus">-        let message = this._messages[iMsg];</span>
<a href="#l1.374"></a><span id="l1.374" class="difflineminus">-        if (message.id in dupeCheck) {</span>
<a href="#l1.375"></a><span id="l1.375" class="difflineminus">-          throw Error(&quot;DUPLICATE!&quot;);</span>
<a href="#l1.376"></a><span id="l1.376" class="difflineminus">-        }</span>
<a href="#l1.377"></a><span id="l1.377" class="difflineminus">-        dupeCheck[message.id] = true;</span>
<a href="#l1.378"></a><span id="l1.378" class="difflineminus">-        </span>
<a href="#l1.379"></a><span id="l1.379" class="difflineminus">-        if (!(message.conversationID in conversations))</span>
<a href="#l1.380"></a><span id="l1.380" class="difflineminus">-          conversations[message.conversationID] = [message];</span>
<a href="#l1.381"></a><span id="l1.381" class="difflineminus">-        else</span>
<a href="#l1.382"></a><span id="l1.382" class="difflineminus">-          conversations[message.conversationID].push(message);</span>
<a href="#l1.383"></a><span id="l1.383" class="difflineminus">-      }</span>
<a href="#l1.384"></a><span id="l1.384" class="difflineminus">-      </span>
<a href="#l1.385"></a><span id="l1.385" class="difflineminus">-      // build hierarchy within each conversation</span>
<a href="#l1.386"></a><span id="l1.386" class="difflineminus">-      for each (let convMsgs in conversations) {</span>
<a href="#l1.387"></a><span id="l1.387" class="difflineminus">-        // fast-track conversations with only one messages</span>
<a href="#l1.388"></a><span id="l1.388" class="difflineminus">-        if (convMsgs.length == 1) {</span>
<a href="#l1.389"></a><span id="l1.389" class="difflineminus">-          let node = new GMTreeNode(convMsgs[0]);</span>
<a href="#l1.390"></a><span id="l1.390" class="difflineminus">-          idToNode[convMsgs[0].id] = node;</span>
<a href="#l1.391"></a><span id="l1.391" class="difflineminus">-          nodes.push(node);</span>
<a href="#l1.392"></a><span id="l1.392" class="difflineminus">-          continue;</span>
<a href="#l1.393"></a><span id="l1.393" class="difflineminus">-        }</span>
<a href="#l1.394"></a><span id="l1.394" class="difflineminus">-      </span>
<a href="#l1.395"></a><span id="l1.395" class="difflineminus">-        // we basically thread from nothing; we pull up the message headers</span>
<a href="#l1.396"></a><span id="l1.396" class="difflineminus">-        //  and do the full references hashmap stuff.  other alternative are:</span>
<a href="#l1.397"></a><span id="l1.397" class="difflineminus">-        // 1) go back to maintaining parentId for each message and pull up all</span>
<a href="#l1.398"></a><span id="l1.398" class="difflineminus">-        //    the messages in the conversation.  (although the conversation may</span>
<a href="#l1.399"></a><span id="l1.399" class="difflineminus">-        //    not have every actual message that ever happened in the thread,</span>
<a href="#l1.400"></a><span id="l1.400" class="difflineminus">-        //    the parentIds will form a proper tree structure.)</span>
<a href="#l1.401"></a><span id="l1.401" class="difflineminus">-        // 2) somehow encode the path to a message in the tree hierarchy in our</span>
<a href="#l1.402"></a><span id="l1.402" class="difflineminus">-        //    message representation.</span>
<a href="#l1.403"></a><span id="l1.403" class="difflineminus">-        // we do it the way we do it because the cost is proportional to the</span>
<a href="#l1.404"></a><span id="l1.404" class="difflineminus">-        //  number of messages being displayed, plus we might have to hit the</span>
<a href="#l1.405"></a><span id="l1.405" class="difflineminus">-        //  backing header later on anyways.</span>
<a href="#l1.406"></a><span id="l1.406" class="difflineminus">-        let messageIdMap = {};</span>
<a href="#l1.407"></a><span id="l1.407" class="difflineminus">-</span>
<a href="#l1.408"></a><span id="l1.408" class="difflineminus">-        // so, map everyone by their message-id, wrapping them in tree nodes as</span>
<a href="#l1.409"></a><span id="l1.409" class="difflineminus">-        //  we go.  we didn't do this in the conversation-binning pass because</span>
<a href="#l1.410"></a><span id="l1.410" class="difflineminus">-        //  we don't need the mapping object's lifetimes so large.  (perhaps</span>
<a href="#l1.411"></a><span id="l1.411" class="difflineminus">-        //  silly?  worst case is an extra N objects for N messages.)</span>
<a href="#l1.412"></a><span id="l1.412" class="difflineminus">-        for (let iMsg = 0; iMsg &lt; convMsgs.length; iMsg++) {</span>
<a href="#l1.413"></a><span id="l1.413" class="difflineminus">-          let message = convMsgs[iMsg];</span>
<a href="#l1.414"></a><span id="l1.414" class="difflineminus">-          let node = new GMTreeNode(message);</span>
<a href="#l1.415"></a><span id="l1.415" class="difflineminus">-          messageIdMap[message.headerMessageID] = node;</span>
<a href="#l1.416"></a><span id="l1.416" class="difflineminus">-          idToNode[message.id] = node;</span>
<a href="#l1.417"></a><span id="l1.417" class="difflineminus">-        }</span>
<a href="#l1.418"></a><span id="l1.418" class="difflineminus">-        // now find their closest parent...</span>
<a href="#l1.419"></a><span id="l1.419" class="difflineminus">-        for each (let treeNode in messageIdMap) {</span>
<a href="#l1.420"></a><span id="l1.420" class="difflineminus">-          let msgHdr = treeNode.message.folderMessage;</span>
<a href="#l1.421"></a><span id="l1.421" class="difflineminus">-          // references are ordered from old (0) to new (n-1), so walk backwards</span>
<a href="#l1.422"></a><span id="l1.422" class="difflineminus">-          for (let iRef = msgHdr.numReferences-1; iRef &gt;= 0; iRef--) {</span>
<a href="#l1.423"></a><span id="l1.423" class="difflineminus">-            let ref = msgHdr.getStringReference(iRef);</span>
<a href="#l1.424"></a><span id="l1.424" class="difflineminus">-            if (ref in messageIdMap) {</span>
<a href="#l1.425"></a><span id="l1.425" class="difflineminus">-              // link them to their parent</span>
<a href="#l1.426"></a><span id="l1.426" class="difflineminus">-              let parentNode = messageIdMap[ref];</span>
<a href="#l1.427"></a><span id="l1.427" class="difflineminus">-              if (parentNode.children === null)</span>
<a href="#l1.428"></a><span id="l1.428" class="difflineminus">-                parentNode.children = [treeNode];</span>
<a href="#l1.429"></a><span id="l1.429" class="difflineminus">-              else</span>
<a href="#l1.430"></a><span id="l1.430" class="difflineminus">-                parentNode.children.push(treeNode);</span>
<a href="#l1.431"></a><span id="l1.431" class="difflineminus">-              treeNode.parent = parentNode;</span>
<a href="#l1.432"></a><span id="l1.432" class="difflineminus">-              break; </span>
<a href="#l1.433"></a><span id="l1.433" class="difflineminus">-            }</span>
<a href="#l1.434"></a><span id="l1.434" class="difflineminus">-          }</span>
<a href="#l1.435"></a><span id="l1.435" class="difflineminus">-          </span>
<a href="#l1.436"></a><span id="l1.436" class="difflineminus">-          if (treeNode.parent === null) {</span>
<a href="#l1.437"></a><span id="l1.437" class="difflineminus">-            nodes.push(treeNode);</span>
<a href="#l1.438"></a><span id="l1.438" class="difflineminus">-          }</span>
<a href="#l1.439"></a><span id="l1.439" class="difflineminus">-        }</span>
<a href="#l1.440"></a><span id="l1.440" class="difflineminus">-      } // (done building hierarchy)</span>
<a href="#l1.441"></a><span id="l1.441" class="difflineminus">-    } // (done dealing with threading)</span>
<a href="#l1.442"></a><span id="l1.442" class="difflineminus">-    else {</span>
<a href="#l1.443"></a><span id="l1.443" class="difflineminus">-      nodes = [(idToNode[msg.id] = new GMTreeNode(msg)) for each</span>
<a href="#l1.444"></a><span id="l1.444" class="difflineminus">-               (msg in this._messages)];</span>
<a href="#l1.445"></a><span id="l1.445" class="difflineminus">-    }</span>
<a href="#l1.446"></a><span id="l1.446" class="difflineminus">-    </span>
<a href="#l1.447"></a><span id="l1.447" class="difflineminus">-    // SORT!</span>
<a href="#l1.448"></a><span id="l1.448" class="difflineminus">-    switch (this._sortType) {</span>
<a href="#l1.449"></a><span id="l1.449" class="difflineminus">-      case Ci.nsMsgViewSortType.byNone:</span>
<a href="#l1.450"></a><span id="l1.450" class="difflineminus">-        // nothing to do!</span>
<a href="#l1.451"></a><span id="l1.451" class="difflineminus">-      case Ci.nsMsgViewSortType.byThread:</span>
<a href="#l1.452"></a><span id="l1.452" class="difflineminus">-        // also nothing to do!</span>
<a href="#l1.453"></a><span id="l1.453" class="difflineminus">-        break;</span>
<a href="#l1.454"></a><span id="l1.454" class="difflineminus">-      case Ci.nsMsgViewSortType.byCustom:</span>
<a href="#l1.455"></a><span id="l1.455" class="difflineminus">-        if (this._customSortColumn) {</span>
<a href="#l1.456"></a><span id="l1.456" class="difflineminus">-          let sortColumn = this._customSortColumn;</span>
<a href="#l1.457"></a><span id="l1.457" class="difflineminus">-          if (this._customSortColumn.IsString)</span>
<a href="#l1.458"></a><span id="l1.458" class="difflineminus">-            nodes.sort(function (a, b) {</span>
<a href="#l1.459"></a><span id="l1.459" class="difflineminus">-              let aStr = sortColumn.getSortStringForRow(</span>
<a href="#l1.460"></a><span id="l1.460" class="difflineminus">-                a.message.folderMessage) || &quot;&quot;;</span>
<a href="#l1.461"></a><span id="l1.461" class="difflineminus">-              let bStr = sortColumn.getSortStringForRow(</span>
<a href="#l1.462"></a><span id="l1.462" class="difflineminus">-                b.message.folderMessage) || &quot;&quot;;</span>
<a href="#l1.463"></a><span id="l1.463" class="difflineminus">-              return aStr.localeCompare(bStr)</span>
<a href="#l1.464"></a><span id="l1.464" class="difflineminus">-            });</span>
<a href="#l1.465"></a><span id="l1.465" class="difflineminus">-          else</span>
<a href="#l1.466"></a><span id="l1.466" class="difflineminus">-            nodes.sort(function (a, b) {</span>
<a href="#l1.467"></a><span id="l1.467" class="difflineminus">-              return sortColumn.getSortLongForRow(a.message.folderMessage) -</span>
<a href="#l1.468"></a><span id="l1.468" class="difflineminus">-                     sortColumn.getSortLongForRow(b.message.folderMessage);</span>
<a href="#l1.469"></a><span id="l1.469" class="difflineminus">-            });</span>
<a href="#l1.470"></a><span id="l1.470" class="difflineminus">-        }</span>
<a href="#l1.471"></a><span id="l1.471" class="difflineminus">-        break;</span>
<a href="#l1.472"></a><span id="l1.472" class="difflineminus">-      default:</span>
<a href="#l1.473"></a><span id="l1.473" class="difflineminus">-        nodes.sort(this._comparisonFuncs[this._sortType]);</span>
<a href="#l1.474"></a><span id="l1.474" class="difflineminus">-        break;</span>
<a href="#l1.475"></a><span id="l1.475" class="difflineminus">-    }</span>
<a href="#l1.476"></a><span id="l1.476" class="difflineminus">-    // XXX backwards-consistency etc etc.</span>
<a href="#l1.477"></a><span id="l1.477" class="difflineminus">-    // FIXME: secondary sort</span>
<a href="#l1.478"></a><span id="l1.478" class="difflineminus">-    if (this._sortOrder == SORT_DESCENDING)</span>
<a href="#l1.479"></a><span id="l1.479" class="difflineminus">-      nodes.reverse();</span>
<a href="#l1.480"></a><span id="l1.480" class="difflineminus">-    </span>
<a href="#l1.481"></a><span id="l1.481" class="difflineminus">-    if (this._isGroupBySort) {</span>
<a href="#l1.482"></a><span id="l1.482" class="difflineminus">-      let comparator = this._comparisonFuncs[this._sortType];</span>
<a href="#l1.483"></a><span id="l1.483" class="difflineminus">-      let groupedNodes = [];</span>
<a href="#l1.484"></a><span id="l1.484" class="difflineminus">-    </span>
<a href="#l1.485"></a><span id="l1.485" class="difflineminus">-      let groupNode = null, groupExampleNode = null;</span>
<a href="#l1.486"></a><span id="l1.486" class="difflineminus">-      for (let iNode = 0; iNode &lt; nodes.length; iNode++) {</span>
<a href="#l1.487"></a><span id="l1.487" class="difflineminus">-        let curNode = nodes[iNode];</span>
<a href="#l1.488"></a><span id="l1.488" class="difflineminus">-        </span>
<a href="#l1.489"></a><span id="l1.489" class="difflineminus">-        if ((groupNode === null) || comparator(groupExampleNode, curNode)) {</span>
<a href="#l1.490"></a><span id="l1.490" class="difflineminus">-          // TODO: make the group node not just a duplicate of the message!</span>
<a href="#l1.491"></a><span id="l1.491" class="difflineminus">-          groupNode = new GMTreeNode(curNode.message);</span>
<a href="#l1.492"></a><span id="l1.492" class="difflineminus">-          groupExampleNode = curNode;</span>
<a href="#l1.493"></a><span id="l1.493" class="difflineminus">-          </span>
<a href="#l1.494"></a><span id="l1.494" class="difflineminus">-          curNode.parent = groupNode;</span>
<a href="#l1.495"></a><span id="l1.495" class="difflineminus">-          groupNode.children = [curNode];</span>
<a href="#l1.496"></a><span id="l1.496" class="difflineminus">-          </span>
<a href="#l1.497"></a><span id="l1.497" class="difflineminus">-          groupedNodes.push(groupNode);</span>
<a href="#l1.498"></a><span id="l1.498" class="difflineminus">-        }</span>
<a href="#l1.499"></a><span id="l1.499" class="difflineminus">-        else {</span>
<a href="#l1.500"></a><span id="l1.500" class="difflineminus">-          curNode.parent = groupNode;</span>
<a href="#l1.501"></a><span id="l1.501" class="difflineminus">-          groupNode.children.push(curNode);</span>
<a href="#l1.502"></a><span id="l1.502" class="difflineminus">-        }</span>
<a href="#l1.503"></a><span id="l1.503" class="difflineminus">-      }</span>
<a href="#l1.504"></a><span id="l1.504" class="difflineminus">-dump(&quot;@@@@@@ GROUPING @@@@@@@@@\n&quot;);      </span>
<a href="#l1.505"></a><span id="l1.505" class="difflineminus">-      nodes = groupedNodes;</span>
<a href="#l1.506"></a><span id="l1.506" class="difflineminus">-    }</span>
<a href="#l1.507"></a><span id="l1.507" class="difflineminus">-    </span>
<a href="#l1.508"></a><span id="l1.508" class="difflineminus">-    if (this._rows &amp;&amp; this._treeBox) {</span>
<a href="#l1.509"></a><span id="l1.509" class="difflineminus">-      this._treeBox.rowCountChanged(0, -this._rows.length);</span>
<a href="#l1.510"></a><span id="l1.510" class="difflineminus">-    }</span>
<a href="#l1.511"></a><span id="l1.511" class="difflineminus">-    </span>
<a href="#l1.512"></a><span id="l1.512" class="difflineminus">-    this._toplevelNodes = nodes;</span>
<a href="#l1.513"></a><span id="l1.513" class="difflineminus">-    this._idToNode = idToNode;</span>
<a href="#l1.514"></a><span id="l1.514" class="difflineminus">-    for (let iNode = 0; iNode &lt; nodes.length; iNode++)</span>
<a href="#l1.515"></a><span id="l1.515" class="difflineminus">-      nodes[iNode].setLevel(0);</span>
<a href="#l1.516"></a><span id="l1.516" class="difflineminus">-    // by default, just show the top-level nodes...</span>
<a href="#l1.517"></a><span id="l1.517" class="difflineminus">-    this._rows = nodes.concat();</span>
<a href="#l1.518"></a><span id="l1.518" class="difflineminus">-    </span>
<a href="#l1.519"></a><span id="l1.519" class="difflineminus">-    if (this._treeBox) {</span>
<a href="#l1.520"></a><span id="l1.520" class="difflineminus">-      this._treeBox.rowCountChanged(0, this._rows.length); </span>
<a href="#l1.521"></a><span id="l1.521" class="difflineminus">-    }</span>
<a href="#l1.522"></a><span id="l1.522" class="difflineminus">-  },</span>
<a href="#l1.523"></a><span id="l1.523" class="difflineminus">-</span>
<a href="#l1.524"></a><span id="l1.524" class="difflineminus">-  absorbNewCollection: function(aCollection) {</span>
<a href="#l1.525"></a><span id="l1.525" class="difflineminus">-    this._collection = aCollection;</span>
<a href="#l1.526"></a><span id="l1.526" class="difflineminus">-    this._messages = this._collection.items;</span>
<a href="#l1.527"></a><span id="l1.527" class="difflineminus">-    this._sort();</span>
<a href="#l1.528"></a><span id="l1.528" class="difflineminus">-  },</span>
<a href="#l1.529"></a><span id="l1.529" class="difflineminus">-</span>
<a href="#l1.530"></a><span id="l1.530" class="difflineminus">-  /* ========== nsIMsgDBView ========== */</span>
<a href="#l1.531"></a><span id="l1.531" class="difflineminus">-</span>
<a href="#l1.532"></a><span id="l1.532" class="difflineminus">-  init: function gloda_mdbv_init(aMessengerInstance, aMsgWindow,</span>
<a href="#l1.533"></a><span id="l1.533" class="difflineminus">-                                 aCommandUpdater) {</span>
<a href="#l1.534"></a><span id="l1.534" class="difflineminus">-    this._messenger = aMessengerInstance;</span>
<a href="#l1.535"></a><span id="l1.535" class="difflineminus">-    this._msgWindow = aMsgWindow;</span>
<a href="#l1.536"></a><span id="l1.536" class="difflineminus">-    this._commandUpdater = aCommandUpdater;</span>
<a href="#l1.537"></a><span id="l1.537" class="difflineminus">-  },</span>
<a href="#l1.538"></a><span id="l1.538" class="difflineminus">-  </span>
<a href="#l1.539"></a><span id="l1.539" class="difflineminus">-  open: function gloda_mdbv_open(aFolder, aSortType, aSortOrder, aViewFlags,</span>
<a href="#l1.540"></a><span id="l1.540" class="difflineminus">-                                 aOutCount) {</span>
<a href="#l1.541"></a><span id="l1.541" class="difflineminus">-    this._sortType = aSortType;</span>
<a href="#l1.542"></a><span id="l1.542" class="difflineminus">-    this._sortOrder = aSortOrder;</span>
<a href="#l1.543"></a><span id="l1.543" class="difflineminus">-    this._viewFlags = aViewFlags;</span>
<a href="#l1.544"></a><span id="l1.544" class="difflineminus">-    </span>
<a href="#l1.545"></a><span id="l1.545" class="difflineminus">-    let query = Gloda.newQuery(Gloda.NOUN_MESSAGE);</span>
<a href="#l1.546"></a><span id="l1.546" class="difflineminus">-    query.folderURI(aFolder.URI);</span>
<a href="#l1.547"></a><span id="l1.547" class="difflineminus">-    this._collection = query.getAllSync();</span>
<a href="#l1.548"></a><span id="l1.548" class="difflineminus">-    this._messages = this._collection.items;</span>
<a href="#l1.549"></a><span id="l1.549" class="difflineminus">-    this._sort();</span>
<a href="#l1.550"></a><span id="l1.550" class="difflineminus">-  },</span>
<a href="#l1.551"></a><span id="l1.551" class="difflineminus">-  openWithHdrs: function gloda_mdbv_openWithHdrs(aHeaders, aSortType,</span>
<a href="#l1.552"></a><span id="l1.552" class="difflineminus">-                                                 aSortOrder, aViewFlags,</span>
<a href="#l1.553"></a><span id="l1.553" class="difflineminus">-                                                 aOutCount) {</span>
<a href="#l1.554"></a><span id="l1.554" class="difflineminus">-    this._sortType = aSortType;</span>
<a href="#l1.555"></a><span id="l1.555" class="difflineminus">-    this._sortOrder = aSortOrder;</span>
<a href="#l1.556"></a><span id="l1.556" class="difflineminus">-    this._viewFlags = aViewFlags;</span>
<a href="#l1.557"></a><span id="l1.557" class="difflineminus">-    </span>
<a href="#l1.558"></a><span id="l1.558" class="difflineminus">-    this._messages = [Gloda.getMessageForHeader(hdr) for each</span>
<a href="#l1.559"></a><span id="l1.559" class="difflineminus">-                      (hdr in aHeaders)];</span>
<a href="#l1.560"></a><span id="l1.560" class="difflineminus">-    // we want to create an explicit collection so we at least get notifications</span>
<a href="#l1.561"></a><span id="l1.561" class="difflineminus">-    //  for the ids we already have...</span>
<a href="#l1.562"></a><span id="l1.562" class="difflineminus">-    this._collection = Gloda.explicitCollection(Gloda.NOUN_MESSAGE,</span>
<a href="#l1.563"></a><span id="l1.563" class="difflineminus">-                                                this._messages);</span>
<a href="#l1.564"></a><span id="l1.564" class="difflineminus">-    this._sort();</span>
<a href="#l1.565"></a><span id="l1.565" class="difflineminus">-    </span>
<a href="#l1.566"></a><span id="l1.566" class="difflineminus">-    aOutCount.value = this._messages.length;</span>
<a href="#l1.567"></a><span id="l1.567" class="difflineminus">-  },</span>
<a href="#l1.568"></a><span id="l1.568" class="difflineminus">-</span>
<a href="#l1.569"></a><span id="l1.569" class="difflineminus">-  cloneDBView: function gloda_mdbv_cloneDBView(aMessengerInstance,</span>
<a href="#l1.570"></a><span id="l1.570" class="difflineminus">-                                               aMsgWindow, aCommandUpdater) {</span>
<a href="#l1.571"></a><span id="l1.571" class="difflineminus">-    let newView = new GlodaMsgDBView();</span>
<a href="#l1.572"></a><span id="l1.572" class="difflineminus">-    newView._messenger = aMessengerInstance;</span>
<a href="#l1.573"></a><span id="l1.573" class="difflineminus">-    newView._msgWindow = aMsgWindow;</span>
<a href="#l1.574"></a><span id="l1.574" class="difflineminus">-    newView._commandUpdater = aCommandUpdater;</span>
<a href="#l1.575"></a><span id="l1.575" class="difflineminus">-    </span>
<a href="#l1.576"></a><span id="l1.576" class="difflineminus">-    newView._sortType  = this._sortType;</span>
<a href="#l1.577"></a><span id="l1.577" class="difflineminus">-    newView._sortOrder = this._sortOrder;</span>
<a href="#l1.578"></a><span id="l1.578" class="difflineminus">-    newView._viewFlags = this._viewFlags;</span>
<a href="#l1.579"></a><span id="l1.579" class="difflineminus">-    newView._messages  = this._messages; // XXX may need to clone someday soon</span>
<a href="#l1.580"></a><span id="l1.580" class="difflineminus">-    newView._sort();</span>
<a href="#l1.581"></a><span id="l1.581" class="difflineminus">-    </span>
<a href="#l1.582"></a><span id="l1.582" class="difflineminus">-    return newView;</span>
<a href="#l1.583"></a><span id="l1.583" class="difflineminus">-  },</span>
<a href="#l1.584"></a><span id="l1.584" class="difflineminus">-</span>
<a href="#l1.585"></a><span id="l1.585" class="difflineminus">-  close: function gloda_mdbv_close() {</span>
<a href="#l1.586"></a><span id="l1.586" class="difflineminus">-    this._messenger = null;</span>
<a href="#l1.587"></a><span id="l1.587" class="difflineminus">-    this._msgWindow = null;</span>
<a href="#l1.588"></a><span id="l1.588" class="difflineminus">-    this._commandUpdater = null;</span>
<a href="#l1.589"></a><span id="l1.589" class="difflineminus">-    this._messages = null;</span>
<a href="#l1.590"></a><span id="l1.590" class="difflineminus">-    this._toplevelNodes = null;</span>
<a href="#l1.591"></a><span id="l1.591" class="difflineminus">-    this._rows = null;</span>
<a href="#l1.592"></a><span id="l1.592" class="difflineminus">-    this._customColumns = null;</span>
<a href="#l1.593"></a><span id="l1.593" class="difflineminus">-    this._customSortColumn = null;</span>
<a href="#l1.594"></a><span id="l1.594" class="difflineminus">-    this._treeSelection = null;</span>
<a href="#l1.595"></a><span id="l1.595" class="difflineminus">-    this._selectedNodes = null;</span>
<a href="#l1.596"></a><span id="l1.596" class="difflineminus">-    this._selectedIndices = null;</span>
<a href="#l1.597"></a><span id="l1.597" class="difflineminus">-  },</span>
<a href="#l1.598"></a><span id="l1.598" class="difflineminus">-</span>
<a href="#l1.599"></a><span id="l1.599" class="difflineminus">-  sort: function gloda_mdbv_sort(aSortType, aSortOrder) {</span>
<a href="#l1.600"></a><span id="l1.600" class="difflineminus">-    this._sortType = aSortType;</span>
<a href="#l1.601"></a><span id="l1.601" class="difflineminus">-    this._sortOrder = aSortOrder;</span>
<a href="#l1.602"></a><span id="l1.602" class="difflineminus">-    </span>
<a href="#l1.603"></a><span id="l1.603" class="difflineminus">-    this._sort();</span>
<a href="#l1.604"></a><span id="l1.604" class="difflineminus">-  },</span>
<a href="#l1.605"></a><span id="l1.605" class="difflineminus">-  </span>
<a href="#l1.606"></a><span id="l1.606" class="difflineminus">-  doCommand: function gloda_mdbv_doCommand(aCommand) {</span>
<a href="#l1.607"></a><span id="l1.607" class="difflineminus">-    switch (aCommand) { // no 5</span>
<a href="#l1.608"></a><span id="l1.608" class="difflineminus">-      // -- selection related (15,18,19)</span>
<a href="#l1.609"></a><span id="l1.609" class="difflineminus">-      case Ci.nsMsgViewCommandType.selectAll:</span>
<a href="#l1.610"></a><span id="l1.610" class="difflineminus">-      case Ci.nsMsgViewCommandType.selectThread:</span>
<a href="#l1.611"></a><span id="l1.611" class="difflineminus">-      case Ci.nsMsgViewCommandType.selectFlagged:</span>
<a href="#l1.612"></a><span id="l1.612" class="difflineminus">-      // -- re-dispatch (0-4,7-9,27-29)</span>
<a href="#l1.613"></a><span id="l1.613" class="difflineminus">-      case Ci.nsMsgViewCommandType.markMessagesRead:</span>
<a href="#l1.614"></a><span id="l1.614" class="difflineminus">-      case Ci.nsMsgViewCommandType.markMessagesUnread:</span>
<a href="#l1.615"></a><span id="l1.615" class="difflineminus">-      case Ci.nsMsgViewCommandType.toggleMessageRead:</span>
<a href="#l1.616"></a><span id="l1.616" class="difflineminus">-      case Ci.nsMsgViewCommandType.flagMessages:</span>
<a href="#l1.617"></a><span id="l1.617" class="difflineminus">-      case Ci.nsMsgViewCommandType.unflagMessages:</span>
<a href="#l1.618"></a><span id="l1.618" class="difflineminus">-      case Ci.nsMsgViewCommandType.deleteMsg:</span>
<a href="#l1.619"></a><span id="l1.619" class="difflineminus">-      case Ci.nsMsgViewCommandType.deleteNoTrash:</span>
<a href="#l1.620"></a><span id="l1.620" class="difflineminus">-      case Ci.nsMsgViewCommandType.markThreadRead:</span>
<a href="#l1.621"></a><span id="l1.621" class="difflineminus">-      </span>
<a href="#l1.622"></a><span id="l1.622" class="difflineminus">-      case Ci.nsMsgViewCommandType.junk:</span>
<a href="#l1.623"></a><span id="l1.623" class="difflineminus">-      case Ci.nsMsgViewCommandType.unjunk:</span>
<a href="#l1.624"></a><span id="l1.624" class="difflineminus">-      case Ci.nsMsgViewCommandType.undeleteMsg:</span>
<a href="#l1.625"></a><span id="l1.625" class="difflineminus">-      </span>
<a href="#l1.626"></a><span id="l1.626" class="difflineminus">-      case Ci.nsMsgViewCommandType.toggleThreadWatched:</span>
<a href="#l1.627"></a><span id="l1.627" class="difflineminus">-      case Ci.nsMsgViewCommandType.expandAll:</span>
<a href="#l1.628"></a><span id="l1.628" class="difflineminus">-      case Ci.nsMsgViewCommandType.collapseAll:</span>
<a href="#l1.629"></a><span id="l1.629" class="difflineminus">-      </span>
<a href="#l1.630"></a><span id="l1.630" class="difflineminus">-      case Ci.nsMsgViewCommandType.copyMessages:</span>
<a href="#l1.631"></a><span id="l1.631" class="difflineminus">-      case Ci.nsMsgViewCommandType.moveMessages:</span>
<a href="#l1.632"></a><span id="l1.632" class="difflineminus">-      case Ci.nsMsgViewCommandType.downloadSelectedForOffline:</span>
<a href="#l1.633"></a><span id="l1.633" class="difflineminus">-      case Ci.nsMsgViewCommandType.downloadFlaggedForOffline:</span>
<a href="#l1.634"></a><span id="l1.634" class="difflineminus">-      </span>
<a href="#l1.635"></a><span id="l1.635" class="difflineminus">-      case Ci.nsMsgViewCommandType.cmdRequiringMsgBody:</span>
<a href="#l1.636"></a><span id="l1.636" class="difflineminus">-      </span>
<a href="#l1.637"></a><span id="l1.637" class="difflineminus">-      case Ci.nsMsgViewCommandType.label0:</span>
<a href="#l1.638"></a><span id="l1.638" class="difflineminus">-      case Ci.nsMsgViewCommandType.label1:</span>
<a href="#l1.639"></a><span id="l1.639" class="difflineminus">-      case Ci.nsMsgViewCommandType.label2:</span>
<a href="#l1.640"></a><span id="l1.640" class="difflineminus">-      case Ci.nsMsgViewCommandType.label3:</span>
<a href="#l1.641"></a><span id="l1.641" class="difflineminus">-      case Ci.nsMsgViewCommandType.label4:</span>
<a href="#l1.642"></a><span id="l1.642" class="difflineminus">-      case Ci.nsMsgViewCommandType.label5:</span>
<a href="#l1.643"></a><span id="l1.643" class="difflineminus">-      </span>
<a href="#l1.644"></a><span id="l1.644" class="difflineminus">-      case Ci.nsMsgViewCommandType.applyFilters:</span>
<a href="#l1.645"></a><span id="l1.645" class="difflineminus">-      case Ci.nsMsgViewCommandType.runJunkControls:</span>
<a href="#l1.646"></a><span id="l1.646" class="difflineminus">-      case Ci.nsMsgViewCommandType.deleteJunk:</span>
<a href="#l1.647"></a><span id="l1.647" class="difflineminus">-    }</span>
<a href="#l1.648"></a><span id="l1.648" class="difflineminus">-  },</span>
<a href="#l1.649"></a><span id="l1.649" class="difflineminus">-  doCommandWithFolder: function gloda_mdbv_doCommandWithFolder(aCommand,</span>
<a href="#l1.650"></a><span id="l1.650" class="difflineminus">-                                                               aFolder) {</span>
<a href="#l1.651"></a><span id="l1.651" class="difflineminus">-    // only copyMessages and moveMessages can do stuff here...\</span>
<a href="#l1.652"></a><span id="l1.652" class="difflineminus">-    switch (aCommand) { // no 5</span>
<a href="#l1.653"></a><span id="l1.653" class="difflineminus">-      case Ci.nsMsgViewCommandType.copyMessages:</span>
<a href="#l1.654"></a><span id="l1.654" class="difflineminus">-      case Ci.nsMsgViewCommandType.moveMessages:</span>
<a href="#l1.655"></a><span id="l1.655" class="difflineminus">-      // error!</span>
<a href="#l1.656"></a><span id="l1.656" class="difflineminus">-      default:</span>
<a href="#l1.657"></a><span id="l1.657" class="difflineminus">-    }</span>
<a href="#l1.658"></a><span id="l1.658" class="difflineminus">-  },</span>
<a href="#l1.659"></a><span id="l1.659" class="difflineminus">-  getCommandStatus: function gloda_mdbv_getCommandStatus(</span>
<a href="#l1.660"></a><span id="l1.660" class="difflineminus">-      aCommand, aOutIsSelectable) { // aOutIsSelected...</span>
<a href="#l1.661"></a><span id="l1.661" class="difflineminus">-    </span>
<a href="#l1.662"></a><span id="l1.662" class="difflineminus">-    let selNodes = this.selectedNodes;</span>
<a href="#l1.663"></a><span id="l1.663" class="difflineminus">-    let haveSelection = (selNodes.length &gt; 0);</span>
<a href="#l1.664"></a><span id="l1.664" class="difflineminus">-    let haveNewsMessages = false; // XXX news message specialization</span>
<a href="#l1.665"></a><span id="l1.665" class="difflineminus">-    </span>
<a href="#l1.666"></a><span id="l1.666" class="difflineminus">-    let canDelete = function() {</span>
<a href="#l1.667"></a><span id="l1.667" class="difflineminus">-      let lastCheckedFolderID = null;</span>
<a href="#l1.668"></a><span id="l1.668" class="difflineminus">-      for (let iNode = 0; iNode &lt; selNodes.length; iNode++) {</span>
<a href="#l1.669"></a><span id="l1.669" class="difflineminus">-        let message = selNodes[iNode].message;</span>
<a href="#l1.670"></a><span id="l1.670" class="difflineminus">-        if (lastCheckedFolderID != message.folderID) {</span>
<a href="#l1.671"></a><span id="l1.671" class="difflineminus">-          if (message.folderMessage === null ||</span>
<a href="#l1.672"></a><span id="l1.672" class="difflineminus">-              !message.folderMessage.folder.canDeleteMessages)</span>
<a href="#l1.673"></a><span id="l1.673" class="difflineminus">-            return false;</span>
<a href="#l1.674"></a><span id="l1.674" class="difflineminus">-          lastCheckedFolderID = message.folderID;</span>
<a href="#l1.675"></a><span id="l1.675" class="difflineminus">-        }</span>
<a href="#l1.676"></a><span id="l1.676" class="difflineminus">-      }</span>
<a href="#l1.677"></a><span id="l1.677" class="difflineminus">-      return true;</span>
<a href="#l1.678"></a><span id="l1.678" class="difflineminus">-    };</span>
<a href="#l1.679"></a><span id="l1.679" class="difflineminus">-    </span>
<a href="#l1.680"></a><span id="l1.680" class="difflineminus">-    let commandOkay;</span>
<a href="#l1.681"></a><span id="l1.681" class="difflineminus">-    </span>
<a href="#l1.682"></a><span id="l1.682" class="difflineminus">-    switch (aCommand) { // no 5</span>
<a href="#l1.683"></a><span id="l1.683" class="difflineminus">-      case Ci.nsMsgViewCommandType.deleteMsg:</span>
<a href="#l1.684"></a><span id="l1.684" class="difflineminus">-      case Ci.nsMsgViewCommandType.deleteNoTrash:</span>
<a href="#l1.685"></a><span id="l1.685" class="difflineminus">-        // it's okay if all the messages' folders support deletion.  now, news</span>
<a href="#l1.686"></a><span id="l1.686" class="difflineminus">-        //  does't support deletion, but it does support cancelation, and we</span>
<a href="#l1.687"></a><span id="l1.687" class="difflineminus">-        //  use delete to mean cancel right now (even though it's dubious.)</span>
<a href="#l1.688"></a><span id="l1.688" class="difflineminus">-        // XXX this logic is not exhaustively correct in the face of news</span>
<a href="#l1.689"></a><span id="l1.689" class="difflineminus">-        //  inter-mingled with other message types...</span>
<a href="#l1.690"></a><span id="l1.690" class="difflineminus">-        commandOkay = haveSelection &amp;&amp; (haveNewsMessages || canDelete());</span>
<a href="#l1.691"></a><span id="l1.691" class="difflineminus">-        break;</span>
<a href="#l1.692"></a><span id="l1.692" class="difflineminus">-      case Ci.nsMsgViewCommandType.applyFilters:</span>
<a href="#l1.693"></a><span id="l1.693" class="difflineminus">-        // XXX do server-based check required for applyFilters</span>
<a href="#l1.694"></a><span id="l1.694" class="difflineminus">-        commandOkay = false;</span>
<a href="#l1.695"></a><span id="l1.695" class="difflineminus">-        break;</span>
<a href="#l1.696"></a><span id="l1.696" class="difflineminus">-      case Ci.nsMsgViewCommandType.runJunkControls:</span>
<a href="#l1.697"></a><span id="l1.697" class="difflineminus">-        commandOkay = haveSelection &amp;&amp; !haveNewsMessages;</span>
<a href="#l1.698"></a><span id="l1.698" class="difflineminus">-        break;</span>
<a href="#l1.699"></a><span id="l1.699" class="difflineminus">-      case Ci.nsMsgViewCommandType.deleteJunk:</span>
<a href="#l1.700"></a><span id="l1.700" class="difflineminus">-        commandOkay = haveSelection &amp;&amp; canDelete();</span>
<a href="#l1.701"></a><span id="l1.701" class="difflineminus">-        break;</span>
<a href="#l1.702"></a><span id="l1.702" class="difflineminus">-</span>
<a href="#l1.703"></a><span id="l1.703" class="difflineminus">-      case Ci.nsMsgViewCommandType.markMessagesRead:</span>
<a href="#l1.704"></a><span id="l1.704" class="difflineminus">-      case Ci.nsMsgViewCommandType.markMessagesUnread:</span>
<a href="#l1.705"></a><span id="l1.705" class="difflineminus">-      case Ci.nsMsgViewCommandType.toggleMessageRead:</span>
<a href="#l1.706"></a><span id="l1.706" class="difflineminus">-      case Ci.nsMsgViewCommandType.flagMessages:</span>
<a href="#l1.707"></a><span id="l1.707" class="difflineminus">-      case Ci.nsMsgViewCommandType.unflagMessages:</span>
<a href="#l1.708"></a><span id="l1.708" class="difflineminus">-      case Ci.nsMsgViewCommandType.toggleThreadWatched:</span>
<a href="#l1.709"></a><span id="l1.709" class="difflineminus">-      case Ci.nsMsgViewCommandType.markThreadRead:</span>
<a href="#l1.710"></a><span id="l1.710" class="difflineminus">-      case Ci.nsMsgViewCommandType.downloadSelectedForOffline:</span>
<a href="#l1.711"></a><span id="l1.711" class="difflineminus">-        aOutIsSelectable.value = haveSelection;</span>
<a href="#l1.712"></a><span id="l1.712" class="difflineminus">-        break;</span>
<a href="#l1.713"></a><span id="l1.713" class="difflineminus">-      </span>
<a href="#l1.714"></a><span id="l1.714" class="difflineminus">-      </span>
<a href="#l1.715"></a><span id="l1.715" class="difflineminus">-      case Ci.nsMsgViewCommandType.junk:</span>
<a href="#l1.716"></a><span id="l1.716" class="difflineminus">-      case Ci.nsMsgViewCommandType.unjunk:</span>
<a href="#l1.717"></a><span id="l1.717" class="difflineminus">-        commandOkay = !haveNewsMessages;</span>
<a href="#l1.718"></a><span id="l1.718" class="difflineminus">-        break;</span>
<a href="#l1.719"></a><span id="l1.719" class="difflineminus">-</span>
<a href="#l1.720"></a><span id="l1.720" class="difflineminus">-      case Ci.nsMsgViewCommandType.cmdRequiringMsgBody:</span>
<a href="#l1.721"></a><span id="l1.721" class="difflineminus">-        // XXX support offline detection/offline message detection...</span>
<a href="#l1.722"></a><span id="l1.722" class="difflineminus">-        commandOkay = haveSelection; // &amp;&amp; (!areOffline() || offlineMessages());</span>
<a href="#l1.723"></a><span id="l1.723" class="difflineminus">-        break;</span>
<a href="#l1.724"></a><span id="l1.724" class="difflineminus">-        </span>
<a href="#l1.725"></a><span id="l1.725" class="difflineminus">-      case Ci.nsMsgViewCommandType.downloadFlaggedForOffline:</span>
<a href="#l1.726"></a><span id="l1.726" class="difflineminus">-      case Ci.nsMsgViewCommandType.markAllRead:</span>
<a href="#l1.727"></a><span id="l1.727" class="difflineminus">-        commandOkay = true;</span>
<a href="#l1.728"></a><span id="l1.728" class="difflineminus">-        break;</span>
<a href="#l1.729"></a><span id="l1.729" class="difflineminus">-</span>
<a href="#l1.730"></a><span id="l1.730" class="difflineminus">-      // the C++ code doesn't call anything from here on out.. perhaps the</span>
<a href="#l1.731"></a><span id="l1.731" class="difflineminus">-      //   check does't reach us?</span>
<a href="#l1.732"></a><span id="l1.732" class="difflineminus">-      case Ci.nsMsgViewCommandType.copyMessages:</span>
<a href="#l1.733"></a><span id="l1.733" class="difflineminus">-      case Ci.nsMsgViewCommandType.moveMessages:</span>
<a href="#l1.734"></a><span id="l1.734" class="difflineminus">-        commandOkay = haveselection;</span>
<a href="#l1.735"></a><span id="l1.735" class="difflineminus">-        break;</span>
<a href="#l1.736"></a><span id="l1.736" class="difflineminus">-</span>
<a href="#l1.737"></a><span id="l1.737" class="difflineminus">-      case Ci.nsMsgViewCommandType.expandAll:</span>
<a href="#l1.738"></a><span id="l1.738" class="difflineminus">-      case Ci.nsMsgViewCommandType.collapseAll:</span>
<a href="#l1.739"></a><span id="l1.739" class="difflineminus">-      case Ci.nsMsgViewCommandType.selectAll:</span>
<a href="#l1.740"></a><span id="l1.740" class="difflineminus">-      case Ci.nsMsgViewCommandType.selectThread:</span>
<a href="#l1.741"></a><span id="l1.741" class="difflineminus">-      case Ci.nsMsgViewCommandType.selectFlagged:</span>
<a href="#l1.742"></a><span id="l1.742" class="difflineminus">-        commandOkay = true;</span>
<a href="#l1.743"></a><span id="l1.743" class="difflineminus">-        break;</span>
<a href="#l1.744"></a><span id="l1.744" class="difflineminus">-      </span>
<a href="#l1.745"></a><span id="l1.745" class="difflineminus">-      default:</span>
<a href="#l1.746"></a><span id="l1.746" class="difflineminus">-        commandOkay = false;</span>
<a href="#l1.747"></a><span id="l1.747" class="difflineminus">-        break;</span>
<a href="#l1.748"></a><span id="l1.748" class="difflineminus">-    }</span>
<a href="#l1.749"></a><span id="l1.749" class="difflineminus">-    </span>
<a href="#l1.750"></a><span id="l1.750" class="difflineminus">-    aOutIsSelectable.value = commandOkay;</span>
<a href="#l1.751"></a><span id="l1.751" class="difflineminus">-  },</span>
<a href="#l1.752"></a><span id="l1.752" class="difflineminus">-  </span>
<a href="#l1.753"></a><span id="l1.753" class="difflineminus">-  get viewType() {</span>
<a href="#l1.754"></a><span id="l1.754" class="difflineminus">-    // XXX TODO: do something about the viewtype enumeration issue</span>
<a href="#l1.755"></a><span id="l1.755" class="difflineminus">-    return 0; // show all threads...</span>
<a href="#l1.756"></a><span id="l1.756" class="difflineminus">-  },</span>
<a href="#l1.757"></a><span id="l1.757" class="difflineminus">-  </span>
<a href="#l1.758"></a><span id="l1.758" class="difflineminus">-  get viewFlags() {</span>
<a href="#l1.759"></a><span id="l1.759" class="difflineminus">-    return this._viewFlags;</span>
<a href="#l1.760"></a><span id="l1.760" class="difflineminus">-  },</span>
<a href="#l1.761"></a><span id="l1.761" class="difflineminus">-  set viewFlags(aViewFlags) {</span>
<a href="#l1.762"></a><span id="l1.762" class="difflineminus">-    this._viewFlags = aViewFlags;</span>
<a href="#l1.763"></a><span id="l1.763" class="difflineminus">-  },</span>
<a href="#l1.764"></a><span id="l1.764" class="difflineminus">-  </span>
<a href="#l1.765"></a><span id="l1.765" class="difflineminus">-  get sortType() {</span>
<a href="#l1.766"></a><span id="l1.766" class="difflineminus">-    return this._sortType;</span>
<a href="#l1.767"></a><span id="l1.767" class="difflineminus">-  },</span>
<a href="#l1.768"></a><span id="l1.768" class="difflineminus">-  set sortType(aSortType) {</span>
<a href="#l1.769"></a><span id="l1.769" class="difflineminus">-    this._sortType = aSortType;</span>
<a href="#l1.770"></a><span id="l1.770" class="difflineminus">-    this._sort();</span>
<a href="#l1.771"></a><span id="l1.771" class="difflineminus">-  },</span>
<a href="#l1.772"></a><span id="l1.772" class="difflineminus">-  </span>
<a href="#l1.773"></a><span id="l1.773" class="difflineminus">-  get sortOrder() {</span>
<a href="#l1.774"></a><span id="l1.774" class="difflineminus">-    return this._sortOrder;</span>
<a href="#l1.775"></a><span id="l1.775" class="difflineminus">-  },</span>
<a href="#l1.776"></a><span id="l1.776" class="difflineminus">-  </span>
<a href="#l1.777"></a><span id="l1.777" class="difflineminus">-  get keyForFirstSelectedMessage() {</span>
<a href="#l1.778"></a><span id="l1.778" class="difflineminus">-    let selNodes = this.selectedNodes;</span>
<a href="#l1.779"></a><span id="l1.779" class="difflineminus">-    if (selNodes.length)</span>
<a href="#l1.780"></a><span id="l1.780" class="difflineminus">-      return selNodes[0].message.id;</span>
<a href="#l1.781"></a><span id="l1.781" class="difflineminus">-    else</span>
<a href="#l1.782"></a><span id="l1.782" class="difflineminus">-      return NO_SUCH_MESSAGE_KEY;</span>
<a href="#l1.783"></a><span id="l1.783" class="difflineminus">-  },</span>
<a href="#l1.784"></a><span id="l1.784" class="difflineminus">-  </span>
<a href="#l1.785"></a><span id="l1.785" class="difflineminus">-  get viewIndexForFirstSelectedMsg() {</span>
<a href="#l1.786"></a><span id="l1.786" class="difflineminus">-    let selIndices = this.selectedIndices;</span>
<a href="#l1.787"></a><span id="l1.787" class="difflineminus">-    return selIndices.length ? selIndices[0] : NO_SUCH_VIEW_INDEX;</span>
<a href="#l1.788"></a><span id="l1.788" class="difflineminus">-  },</span>
<a href="#l1.789"></a><span id="l1.789" class="difflineminus">-  </span>
<a href="#l1.790"></a><span id="l1.790" class="difflineminus">-  viewNavigate: function gloda_mdbv_viewNavigate(aMotion, aOutResultId,</span>
<a href="#l1.791"></a><span id="l1.791" class="difflineminus">-                                                 aOutResultIndex,</span>
<a href="#l1.792"></a><span id="l1.792" class="difflineminus">-                                                 aOutThreadIndex, aWrap) {</span>
<a href="#l1.793"></a><span id="l1.793" class="difflineminus">-    switch (aMotion) {</span>
<a href="#l1.794"></a><span id="l1.794" class="difflineminus">-      case Ci.nsMsgNavigationType.firstMessage:</span>
<a href="#l1.795"></a><span id="l1.795" class="difflineminus">-      case Ci.nsMsgNavigationType.nextMessage:</span>
<a href="#l1.796"></a><span id="l1.796" class="difflineminus">-      case Ci.nsMsgNavigationType.previousMessage:</span>
<a href="#l1.797"></a><span id="l1.797" class="difflineminus">-      case Ci.nsMsgNavigationType.lastMessage:</span>
<a href="#l1.798"></a><span id="l1.798" class="difflineminus">-      case Ci.nsMsgNavigationType.toggleThreadKilled:</span>
<a href="#l1.799"></a><span id="l1.799" class="difflineminus">-      case Ci.nsMsgNavigationType.firstUnreadMessage:</span>
<a href="#l1.800"></a><span id="l1.800" class="difflineminus">-      case Ci.nsMsgNavigationType.nextUnreadMessage:</span>
<a href="#l1.801"></a><span id="l1.801" class="difflineminus">-      case Ci.nsMsgNavigationType.previousUnreadMessage:</span>
<a href="#l1.802"></a><span id="l1.802" class="difflineminus">-      case Ci.nsMsgNavigationType.lastUnreadMessage:</span>
<a href="#l1.803"></a><span id="l1.803" class="difflineminus">-      case Ci.nsMsgNavigationType.nextUnreadThread:</span>
<a href="#l1.804"></a><span id="l1.804" class="difflineminus">-      case Ci.nsMsgNavigationType.nextUnreadFolder:</span>
<a href="#l1.805"></a><span id="l1.805" class="difflineminus">-      case Ci.nsMsgNavigationType.nextFolder:</span>
<a href="#l1.806"></a><span id="l1.806" class="difflineminus">-      case Ci.nsMsgNavigationType.readMore:</span>
<a href="#l1.807"></a><span id="l1.807" class="difflineminus">-      case Ci.nsMsgNavigationType.back:</span>
<a href="#l1.808"></a><span id="l1.808" class="difflineminus">-      case Ci.nsMsgNavigationType.forward:</span>
<a href="#l1.809"></a><span id="l1.809" class="difflineminus">-      case Ci.nsMsgNavigationType.firstFlagged:</span>
<a href="#l1.810"></a><span id="l1.810" class="difflineminus">-      case Ci.nsMsgNavigationType.nextFlagged:</span>
<a href="#l1.811"></a><span id="l1.811" class="difflineminus">-      case Ci.nsMsgNavigationType.previousFlagged:</span>
<a href="#l1.812"></a><span id="l1.812" class="difflineminus">-      case Ci.nsMsgNavigationType.firstNew:</span>
<a href="#l1.813"></a><span id="l1.813" class="difflineminus">-      case Ci.nsMsgNavigationType.editUndo:</span>
<a href="#l1.814"></a><span id="l1.814" class="difflineminus">-      case Ci.nsMsgNavigationType.editRedo:</span>
<a href="#l1.815"></a><span id="l1.815" class="difflineminus">-      case Ci.nsMsgNavigationType.toggleSubthreadKilled:</span>
<a href="#l1.816"></a><span id="l1.816" class="difflineminus">-    }</span>
<a href="#l1.817"></a><span id="l1.817" class="difflineminus">-  },</span>
<a href="#l1.818"></a><span id="l1.818" class="difflineminus">-  </span>
<a href="#l1.819"></a><span id="l1.819" class="difflineminus">-  navigateStatus: function gloda_mdbv_navigateStatus(aMotion) {</span>
<a href="#l1.820"></a><span id="l1.820" class="difflineminus">-    switch (aMotion) {</span>
<a href="#l1.821"></a><span id="l1.821" class="difflineminus">-      case Ci.nsMsgNavigationType.firstMessage:</span>
<a href="#l1.822"></a><span id="l1.822" class="difflineminus">-      case Ci.nsMsgNavigationType.lastMessage:</span>
<a href="#l1.823"></a><span id="l1.823" class="difflineminus">-        return this._rows.length != 0;</span>
<a href="#l1.824"></a><span id="l1.824" class="difflineminus">-      case Ci.nsMsgNavigationType.nextMessage:</span>
<a href="#l1.825"></a><span id="l1.825" class="difflineminus">-</span>
<a href="#l1.826"></a><span id="l1.826" class="difflineminus">-      case Ci.nsMsgNavigationType.previousMessage:</span>
<a href="#l1.827"></a><span id="l1.827" class="difflineminus">-      case Ci.nsMsgNavigationType.toggleThreadKilled:</span>
<a href="#l1.828"></a><span id="l1.828" class="difflineminus">-      case Ci.nsMsgNavigationType.firstUnreadMessage:</span>
<a href="#l1.829"></a><span id="l1.829" class="difflineminus">-      case Ci.nsMsgNavigationType.nextUnreadMessage:</span>
<a href="#l1.830"></a><span id="l1.830" class="difflineminus">-      case Ci.nsMsgNavigationType.previousUnreadMessage:</span>
<a href="#l1.831"></a><span id="l1.831" class="difflineminus">-      case Ci.nsMsgNavigationType.lastUnreadMessage:</span>
<a href="#l1.832"></a><span id="l1.832" class="difflineminus">-      case Ci.nsMsgNavigationType.nextUnreadThread:</span>
<a href="#l1.833"></a><span id="l1.833" class="difflineminus">-      case Ci.nsMsgNavigationType.nextUnreadFolder:</span>
<a href="#l1.834"></a><span id="l1.834" class="difflineminus">-      case Ci.nsMsgNavigationType.nextFolder:</span>
<a href="#l1.835"></a><span id="l1.835" class="difflineminus">-      case Ci.nsMsgNavigationType.readMore:</span>
<a href="#l1.836"></a><span id="l1.836" class="difflineminus">-      case Ci.nsMsgNavigationType.back:</span>
<a href="#l1.837"></a><span id="l1.837" class="difflineminus">-      case Ci.nsMsgNavigationType.forward:</span>
<a href="#l1.838"></a><span id="l1.838" class="difflineminus">-      case Ci.nsMsgNavigationType.firstFlagged:</span>
<a href="#l1.839"></a><span id="l1.839" class="difflineminus">-      case Ci.nsMsgNavigationType.nextFlagged:</span>
<a href="#l1.840"></a><span id="l1.840" class="difflineminus">-      case Ci.nsMsgNavigationType.previousFlagged:</span>
<a href="#l1.841"></a><span id="l1.841" class="difflineminus">-      case Ci.nsMsgNavigationType.firstNew:</span>
<a href="#l1.842"></a><span id="l1.842" class="difflineminus">-      case Ci.nsMsgNavigationType.editUndo:</span>
<a href="#l1.843"></a><span id="l1.843" class="difflineminus">-      case Ci.nsMsgNavigationType.editRedo:</span>
<a href="#l1.844"></a><span id="l1.844" class="difflineminus">-      case Ci.nsMsgNavigationType.toggleSubthreadKilled:</span>
<a href="#l1.845"></a><span id="l1.845" class="difflineminus">-    }</span>
<a href="#l1.846"></a><span id="l1.846" class="difflineminus">-  },</span>
<a href="#l1.847"></a><span id="l1.847" class="difflineminus">-  </span>
<a href="#l1.848"></a><span id="l1.848" class="difflineminus">-  get msgFolder() {</span>
<a href="#l1.849"></a><span id="l1.849" class="difflineminus">-dump(&quot;&amp;&amp;&amp; get msgFolder\n&quot;);</span>
<a href="#l1.850"></a><span id="l1.850" class="difflineminus">-    if (this._messages.length &amp;&amp; this._messages[0].folderMessage)</span>
<a href="#l1.851"></a><span id="l1.851" class="difflineminus">-      return this._messages[0].folderMessage.folder;</span>
<a href="#l1.852"></a><span id="l1.852" class="difflineminus">-    return null;</span>
<a href="#l1.853"></a><span id="l1.853" class="difflineminus">-  },</span>
<a href="#l1.854"></a><span id="l1.854" class="difflineminus">-  get viewFolder() {</span>
<a href="#l1.855"></a><span id="l1.855" class="difflineminus">-dump(&quot;&amp;&amp;&amp; get viewFolder\n&quot;);</span>
<a href="#l1.856"></a><span id="l1.856" class="difflineminus">-    return null;</span>
<a href="#l1.857"></a><span id="l1.857" class="difflineminus">-  },</span>
<a href="#l1.858"></a><span id="l1.858" class="difflineminus">-  </span>
<a href="#l1.859"></a><span id="l1.859" class="difflineminus">-  getKeyAt: function gloda_mdbv_getKeyAt(aViewIndex) {</span>
<a href="#l1.860"></a><span id="l1.860" class="difflineminus">-dump(&quot;&amp;&amp;&amp; getKeyAt\n&quot;);</span>
<a href="#l1.861"></a><span id="l1.861" class="difflineminus">-    return this._rows[aViewIndex].message.folderMessage.messageKey;</span>
<a href="#l1.862"></a><span id="l1.862" class="difflineminus">-  },</span>
<a href="#l1.863"></a><span id="l1.863" class="difflineminus">-  getFolderForViewIndex: function gloda_mdbv_getFolderForViewIndex(aViewIndex) {</span>
<a href="#l1.864"></a><span id="l1.864" class="difflineminus">-dump(&quot;&amp;&amp;&amp; getFolderForViewIndex\n&quot;);</span>
<a href="#l1.865"></a><span id="l1.865" class="difflineminus">-    return this._rows[aViewIndex].message.folderMessage.folder;</span>
<a href="#l1.866"></a><span id="l1.866" class="difflineminus">-  },</span>
<a href="#l1.867"></a><span id="l1.867" class="difflineminus">-  getURIForViewIndex: function gloda_mdbv_getURIForViewIndex(aViewIndex) {</span>
<a href="#l1.868"></a><span id="l1.868" class="difflineminus">-dump(&quot;&amp;&amp;&amp; getURIForViewIndex\n&quot;);</span>
<a href="#l1.869"></a><span id="l1.869" class="difflineminus">-    return this._rows[aViewIndex].message.folderMessageURI;</span>
<a href="#l1.870"></a><span id="l1.870" class="difflineminus">-  },</span>
<a href="#l1.871"></a><span id="l1.871" class="difflineminus">-  </span>
<a href="#l1.872"></a><span id="l1.872" class="difflineminus">-  getURIsForSelection: function gloda_mdbv_getURIsForSelection(</span>
<a href="#l1.873"></a><span id="l1.873" class="difflineminus">-      aOutCount) {</span>
<a href="#l1.874"></a><span id="l1.874" class="difflineminus">-    let selNodes = this.selectedNodes;</span>
<a href="#l1.875"></a><span id="l1.875" class="difflineminus">-    aOutCount.value = selNodes.length;</span>
<a href="#l1.876"></a><span id="l1.876" class="difflineminus">-    return [node.message.folderMessageURI for each</span>
<a href="#l1.877"></a><span id="l1.877" class="difflineminus">-                      (node in selNodes)];</span>
<a href="#l1.878"></a><span id="l1.878" class="difflineminus">-  },</span>
<a href="#l1.879"></a><span id="l1.879" class="difflineminus">-  getIndicesForSelection: function gloda_mdbv_getIndicesForSelection(</span>
<a href="#l1.880"></a><span id="l1.880" class="difflineminus">-      aOutCount) {</span>
<a href="#l1.881"></a><span id="l1.881" class="difflineminus">-    let selIndices = this.selectedIndices;</span>
<a href="#l1.882"></a><span id="l1.882" class="difflineminus">-    aOutCount.value = selIndices.length;</span>
<a href="#l1.883"></a><span id="l1.883" class="difflineminus">-    return selIndices;</span>
<a href="#l1.884"></a><span id="l1.884" class="difflineminus">-  },</span>
<a href="#l1.885"></a><span id="l1.885" class="difflineminus">-  </span>
<a href="#l1.886"></a><span id="l1.886" class="difflineminus">-  get URIForFirstSelectedMessage() {</span>
<a href="#l1.887"></a><span id="l1.887" class="difflineminus">-    let selNodes = this.selectedNodes;</span>
<a href="#l1.888"></a><span id="l1.888" class="difflineminus">-    if (selNodes.length)</span>
<a href="#l1.889"></a><span id="l1.889" class="difflineminus">-      return selNodes[0].message.folderMessageURI;</span>
<a href="#l1.890"></a><span id="l1.890" class="difflineminus">-    else</span>
<a href="#l1.891"></a><span id="l1.891" class="difflineminus">-      return null;</span>
<a href="#l1.892"></a><span id="l1.892" class="difflineminus">-  },</span>
<a href="#l1.893"></a><span id="l1.893" class="difflineminus">-  get hdrForFirstSelectedMessage() {</span>
<a href="#l1.894"></a><span id="l1.894" class="difflineminus">-    let selNodes = this.selectedNodes;</span>
<a href="#l1.895"></a><span id="l1.895" class="difflineminus">-    if (selNodes.length)</span>
<a href="#l1.896"></a><span id="l1.896" class="difflineminus">-      return selNodes[0].message.folderMessage;</span>
<a href="#l1.897"></a><span id="l1.897" class="difflineminus">-    else</span>
<a href="#l1.898"></a><span id="l1.898" class="difflineminus">-      return null;</span>
<a href="#l1.899"></a><span id="l1.899" class="difflineminus">-  },</span>
<a href="#l1.900"></a><span id="l1.900" class="difflineminus">-  </span>
<a href="#l1.901"></a><span id="l1.901" class="difflineminus">-  _clearDisplay: function() {</span>
<a href="#l1.902"></a><span id="l1.902" class="difflineminus">-    this._msgWindow.windowCommands.clearMsgPane();</span>
<a href="#l1.903"></a><span id="l1.903" class="difflineminus">-    this._commandUpdater.updateCommandStatus();</span>
<a href="#l1.904"></a><span id="l1.904" class="difflineminus">-  },</span>
<a href="#l1.905"></a><span id="l1.905" class="difflineminus">-  </span>
<a href="#l1.906"></a><span id="l1.906" class="difflineminus">-  _displayNode: function(aTreeNode) {</span>
<a href="#l1.907"></a><span id="l1.907" class="difflineminus">-    if (!this._suppressDisplay &amp;&amp;</span>
<a href="#l1.908"></a><span id="l1.908" class="difflineminus">-        this._displayedNode !== aTreeNode) {</span>
<a href="#l1.909"></a><span id="l1.909" class="difflineminus">-      this._displayedNode = aTreeNode;</span>
<a href="#l1.910"></a><span id="l1.910" class="difflineminus">-      this._messenger.openURL(this._displayedNode.message.folderMessageURI);</span>
<a href="#l1.911"></a><span id="l1.911" class="difflineminus">-      this._commandUpdater.updateCommandStatus();</span>
<a href="#l1.912"></a><span id="l1.912" class="difflineminus">-    }</span>
<a href="#l1.913"></a><span id="l1.913" class="difflineminus">-  },</span>
<a href="#l1.914"></a><span id="l1.914" class="difflineminus">-  </span>
<a href="#l1.915"></a><span id="l1.915" class="difflineminus">-  loadMessageByMsgKey: function gloda_mdbv_loadMessageByMsgKey(aMsgKey) {</span>
<a href="#l1.916"></a><span id="l1.916" class="difflineminus">-dump(&quot;&amp;&amp;&amp; loadMessageByMsgKey\n&quot;);</span>
<a href="#l1.917"></a><span id="l1.917" class="difflineminus">-    // ambiguity as to what message key we are dealing with.  let's assume it's</span>
<a href="#l1.918"></a><span id="l1.918" class="difflineminus">-    //  a gloda message id for the sake of this method...</span>
<a href="#l1.919"></a><span id="l1.919" class="difflineminus">-    this._displayNode(this._idToNode(aMsgKey));</span>
<a href="#l1.920"></a><span id="l1.920" class="difflineminus">-  },</span>
<a href="#l1.921"></a><span id="l1.921" class="difflineminus">-  loadMessageByViewIndex: function gloda_mdbv_loadMessageByViewIndex(</span>
<a href="#l1.922"></a><span id="l1.922" class="difflineminus">-      aViewIndex) {</span>
<a href="#l1.923"></a><span id="l1.923" class="difflineminus">-dump(&quot;&amp;&amp;&amp; loadMessageByViewIndex\n&quot;);</span>
<a href="#l1.924"></a><span id="l1.924" class="difflineminus">-    this._displayNode(this._rows[aViewIndex]);</span>
<a href="#l1.925"></a><span id="l1.925" class="difflineminus">-  },</span>
<a href="#l1.926"></a><span id="l1.926" class="difflineminus">-  /*</span>
<a href="#l1.927"></a><span id="l1.927" class="difflineminus">-   * Displays a presumably attached message rather than a message that's</span>
<a href="#l1.928"></a><span id="l1.928" class="difflineminus">-   *  in our list of messages...</span>
<a href="#l1.929"></a><span id="l1.929" class="difflineminus">-   */</span>
<a href="#l1.930"></a><span id="l1.930" class="difflineminus">-  loadMessageByUrl: function gloda_mdbv_loadMessageByUrl(aUrl) {</span>
<a href="#l1.931"></a><span id="l1.931" class="difflineminus">-    this._messenger.LoadURL(null, aUrl);</span>
<a href="#l1.932"></a><span id="l1.932" class="difflineminus">-  },</span>
<a href="#l1.933"></a><span id="l1.933" class="difflineminus">-  </span>
<a href="#l1.934"></a><span id="l1.934" class="difflineminus">-  reloadMessage: function gloda_mdbv_reloadMessage() {</span>
<a href="#l1.935"></a><span id="l1.935" class="difflineminus">-  },</span>
<a href="#l1.936"></a><span id="l1.936" class="difflineminus">-  reloadMessageWithAllParts: function gloda_mdbv_reloadMessageWithAllParts() {</span>
<a href="#l1.937"></a><span id="l1.937" class="difflineminus">-  },</span>
<a href="#l1.938"></a><span id="l1.938" class="difflineminus">-  </span>
<a href="#l1.939"></a><span id="l1.939" class="difflineminus">-  get numSelected() {</span>
<a href="#l1.940"></a><span id="l1.940" class="difflineminus">-    return this.selectedIndices.length;</span>
<a href="#l1.941"></a><span id="l1.941" class="difflineminus">-  },</span>
<a href="#l1.942"></a><span id="l1.942" class="difflineminus">-  get msgToSelectAfterDelete() {</span>
<a href="#l1.943"></a><span id="l1.943" class="difflineminus">-  },</span>
<a href="#l1.944"></a><span id="l1.944" class="difflineminus">-  get currentlyDisplayedMessage() {</span>
<a href="#l1.945"></a><span id="l1.945" class="difflineminus">-dump(&quot;~~~ get currentDisplayedMessage\n&quot;);</span>
<a href="#l1.946"></a><span id="l1.946" class="difflineminus">-    if (this._rows &amp;&amp; this._displayedNode)</span>
<a href="#l1.947"></a><span id="l1.947" class="difflineminus">-      return this._rows.indexOf(this._displayedNode);</span>
<a href="#l1.948"></a><span id="l1.948" class="difflineminus">-    else</span>
<a href="#l1.949"></a><span id="l1.949" class="difflineminus">-      return NO_SUCH_VIEW_INDEX;</span>
<a href="#l1.950"></a><span id="l1.950" class="difflineminus">-  },</span>
<a href="#l1.951"></a><span id="l1.951" class="difflineminus">-  </span>
<a href="#l1.952"></a><span id="l1.952" class="difflineminus">-  selectMsgByKey: function gloda_mdbv_selectMsgByKey(aMsgKey) {</span>
<a href="#l1.953"></a><span id="l1.953" class="difflineminus">-  },</span>
<a href="#l1.954"></a><span id="l1.954" class="difflineminus">-  selectFolderMsgByKey: function gloda_mdbv_selectFolderMsgByKey(</span>
<a href="#l1.955"></a><span id="l1.955" class="difflineminus">-      aMsgFolder, aMsgKey) {</span>
<a href="#l1.956"></a><span id="l1.956" class="difflineminus">-  },</span>
<a href="#l1.957"></a><span id="l1.957" class="difflineminus">-  </span>
<a href="#l1.958"></a><span id="l1.958" class="difflineminus">-  get suppressMsgDisplay() {</span>
<a href="#l1.959"></a><span id="l1.959" class="difflineminus">-    return this._suppressDisplay;</span>
<a href="#l1.960"></a><span id="l1.960" class="difflineminus">-  },</span>
<a href="#l1.961"></a><span id="l1.961" class="difflineminus">-  set suppressMsgDisplay(aSuppress) {</span>
<a href="#l1.962"></a><span id="l1.962" class="difflineminus">-    this._suppressDisplay = aSuppress;</span>
<a href="#l1.963"></a><span id="l1.963" class="difflineminus">-  },</span>
<a href="#l1.964"></a><span id="l1.964" class="difflineminus">-  </span>
<a href="#l1.965"></a><span id="l1.965" class="difflineminus">-  get suppressCommandUpdating() {</span>
<a href="#l1.966"></a><span id="l1.966" class="difflineminus">-  },</span>
<a href="#l1.967"></a><span id="l1.967" class="difflineminus">-  set suppressCommandUpdating(aSuppress) {</span>
<a href="#l1.968"></a><span id="l1.968" class="difflineminus">-  },</span>
<a href="#l1.969"></a><span id="l1.969" class="difflineminus">-  </span>
<a href="#l1.970"></a><span id="l1.970" class="difflineminus">-  onDeleteCompleted: function gloda_mdbv_onDeleteCompleted(aSucceeded) {</span>
<a href="#l1.971"></a><span id="l1.971" class="difflineminus">-  },</span>
<a href="#l1.972"></a><span id="l1.972" class="difflineminus">-  </span>
<a href="#l1.973"></a><span id="l1.973" class="difflineminus">-  get db() {</span>
<a href="#l1.974"></a><span id="l1.974" class="difflineminus">-dump(&quot;&amp;&amp;&amp; get db\n&quot;);</span>
<a href="#l1.975"></a><span id="l1.975" class="difflineminus">-    return null;</span>
<a href="#l1.976"></a><span id="l1.976" class="difflineminus">-  },</span>
<a href="#l1.977"></a><span id="l1.977" class="difflineminus">-  </span>
<a href="#l1.978"></a><span id="l1.978" class="difflineminus">-  get supportsThreading() {</span>
<a href="#l1.979"></a><span id="l1.979" class="difflineminus">-dump(&quot;&amp;&amp;&amp; get supportsThreading\n&quot;);</span>
<a href="#l1.980"></a><span id="l1.980" class="difflineminus">-    return true;</span>
<a href="#l1.981"></a><span id="l1.981" class="difflineminus">-  },</span>
<a href="#l1.982"></a><span id="l1.982" class="difflineminus">-  </span>
<a href="#l1.983"></a><span id="l1.983" class="difflineminus">-  get searchSession() {</span>
<a href="#l1.984"></a><span id="l1.984" class="difflineminus">-    // TODO: support searches</span>
<a href="#l1.985"></a><span id="l1.985" class="difflineminus">-    return null;</span>
<a href="#l1.986"></a><span id="l1.986" class="difflineminus">-  },</span>
<a href="#l1.987"></a><span id="l1.987" class="difflineminus">-  set searchSession(aMsgSearchSession) {</span>
<a href="#l1.988"></a><span id="l1.988" class="difflineminus">-    // TODO: support searches</span>
<a href="#l1.989"></a><span id="l1.989" class="difflineminus">-    // nop for now</span>
<a href="#l1.990"></a><span id="l1.990" class="difflineminus">-  },</span>
<a href="#l1.991"></a><span id="l1.991" class="difflineminus">-  </span>
<a href="#l1.992"></a><span id="l1.992" class="difflineminus">-  get removeRowOnMoveOrDelete() {</span>
<a href="#l1.993"></a><span id="l1.993" class="difflineminus">-    // this depends on the delete model in the underlying world.</span>
<a href="#l1.994"></a><span id="l1.994" class="difflineminus">-    // for now, we will always get rid of it</span>
<a href="#l1.995"></a><span id="l1.995" class="difflineminus">-    return true;</span>
<a href="#l1.996"></a><span id="l1.996" class="difflineminus">-  },</span>
<a href="#l1.997"></a><span id="l1.997" class="difflineminus">-  </span>
<a href="#l1.998"></a><span id="l1.998" class="difflineminus">-  findIndexFromKey: function gloda_mdbv_findIndexFromKey(aMsgKey, aExpand) {</span>
<a href="#l1.999"></a><span id="l1.999" class="difflineminus">-dump(&quot;&amp;&amp;&amp; findIndexFromKey\n&quot;);</span>
<a href="#l1.1000"></a><span id="l1.1000" class="difflineminus">-  },</span>
<a href="#l1.1001"></a><span id="l1.1001" class="difflineminus">-  ExpandAndSelectThreadByIndex:</span>
<a href="#l1.1002"></a><span id="l1.1002" class="difflineminus">-    function gloda_mdbv_ExpandAndSelectThreadByIndex(aViewIndex, aAugment) {</span>
<a href="#l1.1003"></a><span id="l1.1003" class="difflineminus">-  },</span>
<a href="#l1.1004"></a><span id="l1.1004" class="difflineminus">-  </span>
<a href="#l1.1005"></a><span id="l1.1005" class="difflineminus">-  get usingLines() {</span>
<a href="#l1.1006"></a><span id="l1.1006" class="difflineminus">-    return true;</span>
<a href="#l1.1007"></a><span id="l1.1007" class="difflineminus">-  },</span>
<a href="#l1.1008"></a><span id="l1.1008" class="difflineminus">-  </span>
<a href="#l1.1009"></a><span id="l1.1009" class="difflineminus">-  addColumnHandler: function gloda_mdbv_addColumnHandler(aColumn, aHandler) {</span>
<a href="#l1.1010"></a><span id="l1.1010" class="difflineminus">-    this._customColumns[aColumn] = aHandler;</span>
<a href="#l1.1011"></a><span id="l1.1011" class="difflineminus">-  },</span>
<a href="#l1.1012"></a><span id="l1.1012" class="difflineminus">-  removeColumnHandler: function gloda_mdbv_removeColumnHandler(aColumn) {</span>
<a href="#l1.1013"></a><span id="l1.1013" class="difflineminus">-    if (aColumn in this._customColumns)</span>
<a href="#l1.1014"></a><span id="l1.1014" class="difflineminus">-      delete this._customColumns[aColumn];</span>
<a href="#l1.1015"></a><span id="l1.1015" class="difflineminus">-  },</span>
<a href="#l1.1016"></a><span id="l1.1016" class="difflineminus">-  getColumnHandler: function gloda_mdbv_getColumnHandler(aColumn) {</span>
<a href="#l1.1017"></a><span id="l1.1017" class="difflineminus">-    return this._customColumns[aColumn];</span>
<a href="#l1.1018"></a><span id="l1.1018" class="difflineminus">-  },</span>
<a href="#l1.1019"></a><span id="l1.1019" class="difflineminus">-  </span>
<a href="#l1.1020"></a><span id="l1.1020" class="difflineminus">-  /* ========== nsITreeView ========== */</span>
<a href="#l1.1021"></a><span id="l1.1021" class="difflineminus">-  get selection() {</span>
<a href="#l1.1022"></a><span id="l1.1022" class="difflineminus">-    return this._treeSelection;</span>
<a href="#l1.1023"></a><span id="l1.1023" class="difflineminus">-  },</span>
<a href="#l1.1024"></a><span id="l1.1024" class="difflineminus">-  set selection(aTreeSelection) {</span>
<a href="#l1.1025"></a><span id="l1.1025" class="difflineminus">-    this._treeSelection = aTreeSelection;</span>
<a href="#l1.1026"></a><span id="l1.1026" class="difflineminus">-  },</span>
<a href="#l1.1027"></a><span id="l1.1027" class="difflineminus">-  </span>
<a href="#l1.1028"></a><span id="l1.1028" class="difflineminus">-  get rowCount() {</span>
<a href="#l1.1029"></a><span id="l1.1029" class="difflineminus">-    if (this._rows === null)</span>
<a href="#l1.1030"></a><span id="l1.1030" class="difflineminus">-      return 0;</span>
<a href="#l1.1031"></a><span id="l1.1031" class="difflineminus">-    return this._rows.length;</span>
<a href="#l1.1032"></a><span id="l1.1032" class="difflineminus">-  },</span>
<a href="#l1.1033"></a><span id="l1.1033" class="difflineminus">-  </span>
<a href="#l1.1034"></a><span id="l1.1034" class="difflineminus">-  setTree: function gloda_mdbv_setTree(aTreeBox) {</span>
<a href="#l1.1035"></a><span id="l1.1035" class="difflineminus">-    this._treeBox = aTreeBox;</span>
<a href="#l1.1036"></a><span id="l1.1036" class="difflineminus">-  },</span>
<a href="#l1.1037"></a><span id="l1.1037" class="difflineminus">-</span>
<a href="#l1.1038"></a><span id="l1.1038" class="difflineminus">-  getCellText: function gloda_mdbv_getCellText(aRow, aTreeCol) {</span>
<a href="#l1.1039"></a><span id="l1.1039" class="difflineminus">-    let columnId = aTreeCol.id;</span>
<a href="#l1.1040"></a><span id="l1.1040" class="difflineminus">-    if (columnId in this._customColumns) {</span>
<a href="#l1.1041"></a><span id="l1.1041" class="difflineminus">-      let customColumn = this._customColumns[columnId];</span>
<a href="#l1.1042"></a><span id="l1.1042" class="difflineminus">-      customColumn.getCellText(aRow, aTreeCol);</span>
<a href="#l1.1043"></a><span id="l1.1043" class="difflineminus">-    }</span>
<a href="#l1.1044"></a><span id="l1.1044" class="difflineminus">-</span>
<a href="#l1.1045"></a><span id="l1.1045" class="difflineminus">-    let message = this._rows[aRow].message;</span>
<a href="#l1.1046"></a><span id="l1.1046" class="difflineminus">-    // if we can't find the underlying message, be sad and return nothing...</span>
<a href="#l1.1047"></a><span id="l1.1047" class="difflineminus">-    let folderMessage = message.folderMessage;</span>
<a href="#l1.1048"></a><span id="l1.1048" class="difflineminus">-    if (folderMessage === null)</span>
<a href="#l1.1049"></a><span id="l1.1049" class="difflineminus">-      return &quot;&quot;;</span>
<a href="#l1.1050"></a><span id="l1.1050" class="difflineminus">-    </span>
<a href="#l1.1051"></a><span id="l1.1051" class="difflineminus">-    switch(columnId[0]) {</span>
<a href="#l1.1052"></a><span id="l1.1052" class="difflineminus">-      case &quot;s&quot;: // subject, sender, size, status</span>
<a href="#l1.1053"></a><span id="l1.1053" class="difflineminus">-        switch(columnId[1]) {</span>
<a href="#l1.1054"></a><span id="l1.1054" class="difflineminus">-          case &quot;u&quot;: // subject</span>
<a href="#l1.1055"></a><span id="l1.1055" class="difflineminus">-            return message.conversation.subject; //folderMessage.mime2DecodedSubject;</span>
<a href="#l1.1056"></a><span id="l1.1056" class="difflineminus">-          case &quot;e&quot;: // sender</span>
<a href="#l1.1057"></a><span id="l1.1057" class="difflineminus">-            if (message.from)</span>
<a href="#l1.1058"></a><span id="l1.1058" class="difflineminus">-              return message.from.contact.name;</span>
<a href="#l1.1059"></a><span id="l1.1059" class="difflineminus">-            else</span>
<a href="#l1.1060"></a><span id="l1.1060" class="difflineminus">-              return &quot;???&quot;;</span>
<a href="#l1.1061"></a><span id="l1.1061" class="difflineminus">-          case &quot;i&quot;: // size</span>
<a href="#l1.1062"></a><span id="l1.1062" class="difflineminus">-            return folderMessage.messageSize;</span>
<a href="#l1.1063"></a><span id="l1.1063" class="difflineminus">-          case &quot;t&quot;: // status</span>
<a href="#l1.1064"></a><span id="l1.1064" class="difflineminus">-            return messageStatusString(folderMessage.flags);</span>
<a href="#l1.1065"></a><span id="l1.1065" class="difflineminus">-        }</span>
<a href="#l1.1066"></a><span id="l1.1066" class="difflineminus">-        break;</span>
<a href="#l1.1067"></a><span id="l1.1067" class="difflineminus">-      case &quot;r&quot;: // recipient, received</span>
<a href="#l1.1068"></a><span id="l1.1068" class="difflineminus">-        switch(columnId[3]) {</span>
<a href="#l1.1069"></a><span id="l1.1069" class="difflineminus">-          case &quot;i&quot;: // recipient</span>
<a href="#l1.1070"></a><span id="l1.1070" class="difflineminus">-            return [recip.contact.name for each</span>
<a href="#l1.1071"></a><span id="l1.1071" class="difflineminus">-                    (recip in message.to)].join(&quot; &quot;) // folderMessage.recipients;</span>
<a href="#l1.1072"></a><span id="l1.1072" class="difflineminus">-          case &quot;e&quot;: // received</span>
<a href="#l1.1073"></a><span id="l1.1073" class="difflineminus">-            let recDate = new Date(1000 *</span>
<a href="#l1.1074"></a><span id="l1.1074" class="difflineminus">-              folderMessage.getUint32Property(&quot;dateReceived&quot;));</span>
<a href="#l1.1075"></a><span id="l1.1075" class="difflineminus">-            return GlodaUtils.dateFormat(recDate);</span>
<a href="#l1.1076"></a><span id="l1.1076" class="difflineminus">-        }</span>
<a href="#l1.1077"></a><span id="l1.1077" class="difflineminus">-        break;</span>
<a href="#l1.1078"></a><span id="l1.1078" class="difflineminus">-      case &quot;d&quot;: // date</span>
<a href="#l1.1079"></a><span id="l1.1079" class="difflineminus">-        if (message.date)</span>
<a href="#l1.1080"></a><span id="l1.1080" class="difflineminus">-          return GlodaUtils.dateFormat(message.date);</span>
<a href="#l1.1081"></a><span id="l1.1081" class="difflineminus">-        else</span>
<a href="#l1.1082"></a><span id="l1.1082" class="difflineminus">-          return &quot;???&quot;;</span>
<a href="#l1.1083"></a><span id="l1.1083" class="difflineminus">-      case &quot;p&quot;: // priority</span>
<a href="#l1.1084"></a><span id="l1.1084" class="difflineminus">-        return messagePriorityString(folderMessage.priority);</span>
<a href="#l1.1085"></a><span id="l1.1085" class="difflineminus">-      case &quot;a&quot;: // account</span>
<a href="#l1.1086"></a><span id="l1.1086" class="difflineminus">-        return folderMessage.accountKey;</span>
<a href="#l1.1087"></a><span id="l1.1087" class="difflineminus">-      case &quot;t&quot;: // total messages in thread, tags</span>
<a href="#l1.1088"></a><span id="l1.1088" class="difflineminus">-        switch (columnId[1]) {</span>
<a href="#l1.1089"></a><span id="l1.1089" class="difflineminus">-          case &quot;h&quot;: // total messages in thread</span>
<a href="#l1.1090"></a><span id="l1.1090" class="difflineminus">-            // per idiom, only return this for top-level nodes</span>
<a href="#l1.1091"></a><span id="l1.1091" class="difflineminus">-            let node = this._rows[aRow];</span>
<a href="#l1.1092"></a><span id="l1.1092" class="difflineminus">-            if (node.parent === null)</span>
<a href="#l1.1093"></a><span id="l1.1093" class="difflineminus">-              return &quot;&quot; + node.nodesInSubTree;</span>
<a href="#l1.1094"></a><span id="l1.1094" class="difflineminus">-            else</span>
<a href="#l1.1095"></a><span id="l1.1095" class="difflineminus">-              return &quot;&quot;;</span>
<a href="#l1.1096"></a><span id="l1.1096" class="difflineminus">-          case &quot;a&quot;: // tags</span>
<a href="#l1.1097"></a><span id="l1.1097" class="difflineminus">-            return [tag.tag.tag for each (tag in message.tags)].join(&quot; &quot;);</span>
<a href="#l1.1098"></a><span id="l1.1098" class="difflineminus">-        }</span>
<a href="#l1.1099"></a><span id="l1.1099" class="difflineminus">-        break;</span>
<a href="#l1.1100"></a><span id="l1.1100" class="difflineminus">-      case &quot;u&quot;: // unread messages in thread</span>
<a href="#l1.1101"></a><span id="l1.1101" class="difflineminus">-        // per idiom, only return this for top-level nodes</span>
<a href="#l1.1102"></a><span id="l1.1102" class="difflineminus">-        let node = this._Rows[aRow];</span>
<a href="#l1.1103"></a><span id="l1.1103" class="difflineminus">-        if (node.parent === null)</span>
<a href="#l1.1104"></a><span id="l1.1104" class="difflineminus">-          return &quot;&quot; + node.unreadInSubTree;</span>
<a href="#l1.1105"></a><span id="l1.1105" class="difflineminus">-        else</span>
<a href="#l1.1106"></a><span id="l1.1106" class="difflineminus">-          return &quot;&quot;;        </span>
<a href="#l1.1107"></a><span id="l1.1107" class="difflineminus">-      case &quot;j&quot;: // junk score</span>
<a href="#l1.1108"></a><span id="l1.1108" class="difflineminus">-        return folderMessage.getStringProperty(&quot;junkscore&quot;);</span>
<a href="#l1.1109"></a><span id="l1.1109" class="difflineminus">-      case &quot;i&quot;: // id</span>
<a href="#l1.1110"></a><span id="l1.1110" class="difflineminus">-        // I don't think this is exposed anymore; perhaps only ever for</span>
<a href="#l1.1111"></a><span id="l1.1111" class="difflineminus">-        //  debugging?  (The C++ impl exposes the messageKey, which has no</span>
<a href="#l1.1112"></a><span id="l1.1112" class="difflineminus">-        //  reason to be user visible.)</span>
<a href="#l1.1113"></a><span id="l1.1113" class="difflineminus">-        return &quot;&quot; + message.id;</span>
<a href="#l1.1114"></a><span id="l1.1114" class="difflineminus">-      case &quot;l&quot;: // location, previously label too?</span>
<a href="#l1.1115"></a><span id="l1.1115" class="difflineminus">-        switch (columnId[1]) {</span>
<a href="#l1.1116"></a><span id="l1.1116" class="difflineminus">-          case &quot;o&quot;: // location</span>
<a href="#l1.1117"></a><span id="l1.1117" class="difflineminus">-            return folderMessage.folder.prettiestName;</span>
<a href="#l1.1118"></a><span id="l1.1118" class="difflineminus">-            break;</span>
<a href="#l1.1119"></a><span id="l1.1119" class="difflineminus">-        }</span>
<a href="#l1.1120"></a><span id="l1.1120" class="difflineminus">-      default:</span>
<a href="#l1.1121"></a><span id="l1.1121" class="difflineminus">-        break;</span>
<a href="#l1.1122"></a><span id="l1.1122" class="difflineminus">-    }</span>
<a href="#l1.1123"></a><span id="l1.1123" class="difflineminus">-    return &quot;&quot;;</span>
<a href="#l1.1124"></a><span id="l1.1124" class="difflineminus">-  },</span>
<a href="#l1.1125"></a><span id="l1.1125" class="difflineminus">-  </span>
<a href="#l1.1126"></a><span id="l1.1126" class="difflineminus">-  isContainer: function gloda_mdbv_isContainer(aIndex) {</span>
<a href="#l1.1127"></a><span id="l1.1127" class="difflineminus">-    return this._rows[aIndex].children &amp;&amp;</span>
<a href="#l1.1128"></a><span id="l1.1128" class="difflineminus">-           this._rows[aIndex].children.length != 0;</span>
<a href="#l1.1129"></a><span id="l1.1129" class="difflineminus">-  },</span>
<a href="#l1.1130"></a><span id="l1.1130" class="difflineminus">-  isContainerOpen: function gloda_mdbv_isContainerOpen(aIndex) {</span>
<a href="#l1.1131"></a><span id="l1.1131" class="difflineminus">-    return this._rows[aIndex].open;</span>
<a href="#l1.1132"></a><span id="l1.1132" class="difflineminus">-  },</span>
<a href="#l1.1133"></a><span id="l1.1133" class="difflineminus">-  isContainerEmpty: function gloda_mdbv_isContainerEmpty(aIndex) {</span>
<a href="#l1.1134"></a><span id="l1.1134" class="difflineminus">-    // we won't report something is a container if it lacks children</span>
<a href="#l1.1135"></a><span id="l1.1135" class="difflineminus">-    return false;</span>
<a href="#l1.1136"></a><span id="l1.1136" class="difflineminus">-  },</span>
<a href="#l1.1137"></a><span id="l1.1137" class="difflineminus">-  isSeparator: function gloda_mdbv_isSeparator(aIndex) {</span>
<a href="#l1.1138"></a><span id="l1.1138" class="difflineminus">-    // no message is a separator, unless this involves grouping, in which case</span>
<a href="#l1.1139"></a><span id="l1.1139" class="difflineminus">-    //  we need to do something about that.</span>
<a href="#l1.1140"></a><span id="l1.1140" class="difflineminus">-    return false;</span>
<a href="#l1.1141"></a><span id="l1.1141" class="difflineminus">-  },</span>
<a href="#l1.1142"></a><span id="l1.1142" class="difflineminus">-  </span>
<a href="#l1.1143"></a><span id="l1.1143" class="difflineminus">-  isSorted: function gloda_mdbv_isSorted() {</span>
<a href="#l1.1144"></a><span id="l1.1144" class="difflineminus">-    return this._sortType != Ci.nsMsgViewSortType.byNone;</span>
<a href="#l1.1145"></a><span id="l1.1145" class="difflineminus">-  },</span>
<a href="#l1.1146"></a><span id="l1.1146" class="difflineminus">-  isEditable: function gloda_mdbv_isEditable(idx, column) {</span>
<a href="#l1.1147"></a><span id="l1.1147" class="difflineminus">-    return false;</span>
<a href="#l1.1148"></a><span id="l1.1148" class="difflineminus">-  },</span>
<a href="#l1.1149"></a><span id="l1.1149" class="difflineminus">-  </span>
<a href="#l1.1150"></a><span id="l1.1150" class="difflineminus">-  getParentIndex: function gloda_mdbv_getParentIndex(aIndex) {</span>
<a href="#l1.1151"></a><span id="l1.1151" class="difflineminus">-    let selNode = this._rows[aIndex];</span>
<a href="#l1.1152"></a><span id="l1.1152" class="difflineminus">-    // a reverse search would be nicer.</span>
<a href="#l1.1153"></a><span id="l1.1153" class="difflineminus">-    // potentially nicest would be just leveraging our knowledge of the tree to</span>
<a href="#l1.1154"></a><span id="l1.1154" class="difflineminus">-    //  do our own traversal, although the indexOf has a fair chance of winning</span>
<a href="#l1.1155"></a><span id="l1.1155" class="difflineminus">-    //  in many cases (assuming it is optimized).</span>
<a href="#l1.1156"></a><span id="l1.1156" class="difflineminus">-dump(&quot;$$$ getParentIndex\n&quot;);</span>
<a href="#l1.1157"></a><span id="l1.1157" class="difflineminus">-    return this._rows.indexOf(selNode.parent);</span>
<a href="#l1.1158"></a><span id="l1.1158" class="difflineminus">-  },</span>
<a href="#l1.1159"></a><span id="l1.1159" class="difflineminus">-  getLevel: function gloda_mdbv_getLevel(aIndex) {</span>
<a href="#l1.1160"></a><span id="l1.1160" class="difflineminus">-    return this._rows[aIndex].level;</span>
<a href="#l1.1161"></a><span id="l1.1161" class="difflineminus">-  },</span>
<a href="#l1.1162"></a><span id="l1.1162" class="difflineminus">-  </span>
<a href="#l1.1163"></a><span id="l1.1163" class="difflineminus">-  hasNextSibling: function gloda_mdbv_hasNextSibling(aIndex, aAfterIndex) {</span>
<a href="#l1.1164"></a><span id="l1.1164" class="difflineminus">-    let selNode = this._rows[aIndex];</span>
<a href="#l1.1165"></a><span id="l1.1165" class="difflineminus">-dump(&quot;~~~ hasNextSibling\n&quot;);</span>
<a href="#l1.1166"></a><span id="l1.1166" class="difflineminus">-    // if we have no parent or we are the last child, just rule it out.</span>
<a href="#l1.1167"></a><span id="l1.1167" class="difflineminus">-    if ((selNode.parent === null) ||</span>
<a href="#l1.1168"></a><span id="l1.1168" class="difflineminus">-        (selNode.parent.indexOf(selNode) == selNode.parent.children.length - 1))</span>
<a href="#l1.1169"></a><span id="l1.1169" class="difflineminus">-      return false;</span>
<a href="#l1.1170"></a><span id="l1.1170" class="difflineminus">-    // walk to the after index looking for our last sibling.  if we find it</span>
<a href="#l1.1171"></a><span id="l1.1171" class="difflineminus">-    //  before we run out of indices, we have no sibling, otherwise our sibling</span>
<a href="#l1.1172"></a><span id="l1.1172" class="difflineminus">-    //  must exist there.  we are assuming afterIndex is partitioned in such</span>
<a href="#l1.1173"></a><span id="l1.1173" class="difflineminus">-    //  a way that this walk is probably shorter than walking potentially the</span>
<a href="#l1.1174"></a><span id="l1.1174" class="difflineminus">-    //  entire row list.</span>
<a href="#l1.1175"></a><span id="l1.1175" class="difflineminus">-    let lastSibling = selNode.parent.children[selNode.parent.children.length-1];</span>
<a href="#l1.1176"></a><span id="l1.1176" class="difflineminus">-    for (let iCur = aIndex+1; iCur &lt;= aAfterIndex; iCur++) {</span>
<a href="#l1.1177"></a><span id="l1.1177" class="difflineminus">-      if (this._rows[iCur] === lastSibling)</span>
<a href="#l1.1178"></a><span id="l1.1178" class="difflineminus">-        return false;</span>
<a href="#l1.1179"></a><span id="l1.1179" class="difflineminus">-    }</span>
<a href="#l1.1180"></a><span id="l1.1180" class="difflineminus">-    return true;</span>
<a href="#l1.1181"></a><span id="l1.1181" class="difflineminus">-  },</span>
<a href="#l1.1182"></a><span id="l1.1182" class="difflineminus">-  toggleOpenState: function gloda_mdbv_toggleOpenState(aIndex) {</span>
<a href="#l1.1183"></a><span id="l1.1183" class="difflineminus">-    let selNode = this._rows[aIndex];</span>
<a href="#l1.1184"></a><span id="l1.1184" class="difflineminus">-    selNode.open = !selNode.open;</span>
<a href="#l1.1185"></a><span id="l1.1185" class="difflineminus">-    </span>
<a href="#l1.1186"></a><span id="l1.1186" class="difflineminus">-    if(selNode.open) {</span>
<a href="#l1.1187"></a><span id="l1.1187" class="difflineminus">-      // we're now open, we were previously closed.</span>
<a href="#l1.1188"></a><span id="l1.1188" class="difflineminus">-      // since our children retain their open/closed status, we may need to</span>
<a href="#l1.1189"></a><span id="l1.1189" class="difflineminus">-      //  recursively open such children.</span>
<a href="#l1.1190"></a><span id="l1.1190" class="difflineminus">-      </span>
<a href="#l1.1191"></a><span id="l1.1191" class="difflineminus">-      // to avoid pathological insertion to _rows, build a list of what we</span>
<a href="#l1.1192"></a><span id="l1.1192" class="difflineminus">-      //  are going to insert, and since we plan on using splice via apply,</span>
<a href="#l1.1193"></a><span id="l1.1193" class="difflineminus">-      //  put the initial args in...</span>
<a href="#l1.1194"></a><span id="l1.1194" class="difflineminus">-      let spliceArgs = [aIndex+1, 0];</span>
<a href="#l1.1195"></a><span id="l1.1195" class="difflineminus">-      </span>
<a href="#l1.1196"></a><span id="l1.1196" class="difflineminus">-      function expandNode(aNode) {</span>
<a href="#l1.1197"></a><span id="l1.1197" class="difflineminus">-        for (let iChild = 0; iChild &lt; aNode.children.length; iChild++) {</span>
<a href="#l1.1198"></a><span id="l1.1198" class="difflineminus">-          let child = aNode.children[iChild];</span>
<a href="#l1.1199"></a><span id="l1.1199" class="difflineminus">-          spliceArgs.push(child);</span>
<a href="#l1.1200"></a><span id="l1.1200" class="difflineminus">-          if (child.open)</span>
<a href="#l1.1201"></a><span id="l1.1201" class="difflineminus">-            expandNode(child);</span>
<a href="#l1.1202"></a><span id="l1.1202" class="difflineminus">-        }</span>
<a href="#l1.1203"></a><span id="l1.1203" class="difflineminus">-      }</span>
<a href="#l1.1204"></a><span id="l1.1204" class="difflineminus">-      </span>
<a href="#l1.1205"></a><span id="l1.1205" class="difflineminus">-      expandNode(selNode);</span>
<a href="#l1.1206"></a><span id="l1.1206" class="difflineminus">-      let rowsInserted = spliceArgs.length - 2;</span>
<a href="#l1.1207"></a><span id="l1.1207" class="difflineminus">-      this._rows.splice.apply(this._rows, spliceArgs);</span>
<a href="#l1.1208"></a><span id="l1.1208" class="difflineminus">-      </span>
<a href="#l1.1209"></a><span id="l1.1209" class="difflineminus">-      if (this._treeBox) {</span>
<a href="#l1.1210"></a><span id="l1.1210" class="difflineminus">-        this._treeBox.invalidateRange(aIndex, aIndex);</span>
<a href="#l1.1211"></a><span id="l1.1211" class="difflineminus">-        this._treeBox.rowCountChanged(aIndex+1, rowsInserted);</span>
<a href="#l1.1212"></a><span id="l1.1212" class="difflineminus">-      }</span>
<a href="#l1.1213"></a><span id="l1.1213" class="difflineminus">-    }</span>
<a href="#l1.1214"></a><span id="l1.1214" class="difflineminus">-    else {</span>
<a href="#l1.1215"></a><span id="l1.1215" class="difflineminus">-      // we're closed now, we were previously open</span>
<a href="#l1.1216"></a><span id="l1.1216" class="difflineminus">-      </span>
<a href="#l1.1217"></a><span id="l1.1217" class="difflineminus">-      // since we don't have a root node, locating the next sibling/uncle is not</span>
<a href="#l1.1218"></a><span id="l1.1218" class="difflineminus">-      //  tremendously easy to just scan for that. so we do a level scan</span>
<a href="#l1.1219"></a><span id="l1.1219" class="difflineminus">-      //  for the first node at or above the given node's level (which must be</span>
<a href="#l1.1220"></a><span id="l1.1220" class="difflineminus">-      //  a sibling or uncle)</span>
<a href="#l1.1221"></a><span id="l1.1221" class="difflineminus">-      let curLevel = selNode.level;</span>
<a href="#l1.1222"></a><span id="l1.1222" class="difflineminus">-      let iRow;</span>
<a href="#l1.1223"></a><span id="l1.1223" class="difflineminus">-      for (iRow = aIndex+1; iRow &lt; this._rows.length; iRow++) {</span>
<a href="#l1.1224"></a><span id="l1.1224" class="difflineminus">-        if (this._rows[iRow].level &lt;= curLevel)</span>
<a href="#l1.1225"></a><span id="l1.1225" class="difflineminus">-          break;</span>
<a href="#l1.1226"></a><span id="l1.1226" class="difflineminus">-      }</span>
<a href="#l1.1227"></a><span id="l1.1227" class="difflineminus">-      let rowsToDelete = iRow - (aIndex+1);</span>
<a href="#l1.1228"></a><span id="l1.1228" class="difflineminus">-      if (rowsToDelete) {</span>
<a href="#l1.1229"></a><span id="l1.1229" class="difflineminus">-        this._rows.splice(aIndex+1, rowsToDelete);</span>
<a href="#l1.1230"></a><span id="l1.1230" class="difflineminus">-        if (this._treeBox) {</span>
<a href="#l1.1231"></a><span id="l1.1231" class="difflineminus">-          this._treeBox.invalidateRange(aIndex, aIndex);</span>
<a href="#l1.1232"></a><span id="l1.1232" class="difflineminus">-          this._treeBox.rowCountChanged(aIndex+1, -rowsToDelete);</span>
<a href="#l1.1233"></a><span id="l1.1233" class="difflineminus">-        }</span>
<a href="#l1.1234"></a><span id="l1.1234" class="difflineminus">-      }</span>
<a href="#l1.1235"></a><span id="l1.1235" class="difflineminus">-    }</span>
<a href="#l1.1236"></a><span id="l1.1236" class="difflineminus">-  },</span>
<a href="#l1.1237"></a><span id="l1.1237" class="difflineminus">-  </span>
<a href="#l1.1238"></a><span id="l1.1238" class="difflineminus">-  getImageSrc: function(idx, column) {},</span>
<a href="#l1.1239"></a><span id="l1.1239" class="difflineminus">-  getProgressMode : function(idx,column) {},</span>
<a href="#l1.1240"></a><span id="l1.1240" class="difflineminus">-  getCellValue: function(idx, column) {},</span>
<a href="#l1.1241"></a><span id="l1.1241" class="difflineminus">-  cycleHeader: function(col, elem) {},</span>
<a href="#l1.1242"></a><span id="l1.1242" class="difflineminus">-  selectionChanged: function gloda_mdbv_selectionChanged() {</span>
<a href="#l1.1243"></a><span id="l1.1243" class="difflineminus">-    this._selectedNodes = null;</span>
<a href="#l1.1244"></a><span id="l1.1244" class="difflineminus">-    if (this.selectedNodes.length == 1)</span>
<a href="#l1.1245"></a><span id="l1.1245" class="difflineminus">-      this._displayNode(this.selectedNodes[0]);</span>
<a href="#l1.1246"></a><span id="l1.1246" class="difflineminus">-    else</span>
<a href="#l1.1247"></a><span id="l1.1247" class="difflineminus">-      this._clearDisplay();</span>
<a href="#l1.1248"></a><span id="l1.1248" class="difflineminus">-  },</span>
<a href="#l1.1249"></a><span id="l1.1249" class="difflineminus">-  cycleCell: function(idx, column) {},</span>
<a href="#l1.1250"></a><span id="l1.1250" class="difflineminus">-  performAction: function(action) {},</span>
<a href="#l1.1251"></a><span id="l1.1251" class="difflineminus">-  performActionOnCell: function(action, index, column) {},</span>
<a href="#l1.1252"></a><span id="l1.1252" class="difflineminus">-  getRowProperties: function(idx, column, prop) {</span>
<a href="#l1.1253"></a><span id="l1.1253" class="difflineminus">-  },</span>
<a href="#l1.1254"></a><span id="l1.1254" class="difflineminus">-  getCellProperties: function(idx, column, prop) {</span>
<a href="#l1.1255"></a><span id="l1.1255" class="difflineminus">-  },</span>
<a href="#l1.1256"></a><span id="l1.1256" class="difflineminus">-  getColumnProperties: function(column, element, prop) {</span>
<a href="#l1.1257"></a><span id="l1.1257" class="difflineminus">-  },</span>
<a href="#l1.1258"></a><span id="l1.1258" class="difflineminus">-  // no drag and drop!</span>
<a href="#l1.1259"></a><span id="l1.1259" class="difflineminus">-  canDrop: function(aIndex, aOrient) {</span>
<a href="#l1.1260"></a><span id="l1.1260" class="difflineminus">-    return false;</span>
<a href="#l1.1261"></a><span id="l1.1261" class="difflineminus">-  },</span>
<a href="#l1.1262"></a><span id="l1.1262" class="difflineminus">-  </span>
<a href="#l1.1263"></a><span id="l1.1263" class="difflineminus">-};</span>
<a href="#l1.1264"></a><span id="l1.1264" class="difflineminus">-</span>
<a href="#l1.1265"></a><span id="l1.1265" class="difflineminus">-var components = [GlodaMsgDBView];</span>
<a href="#l1.1266"></a><span id="l1.1266" class="difflineminus">-function NSGetModule(compMgr, fileSpec) {</span>
<a href="#l1.1267"></a><span id="l1.1267" class="difflineminus">-  return XPCOMUtils.generateModule(components);</span>
<a href="#l1.1268"></a><span id="l1.1268" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/modules/utils.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/modules/utils.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -102,13 +102,9 @@ var GlodaUtils = {</span>
<a href="#l2.4"></a><span id="l2.4">      // return the two-digit hexadecimal code for a byte</span>
<a href="#l2.5"></a><span id="l2.5">     function toHexString(charCode) {</span>
<a href="#l2.6"></a><span id="l2.6">       return (&quot;0&quot; + charCode.toString(16)).slice(-2);</span>
<a href="#l2.7"></a><span id="l2.7">     }</span>
<a href="#l2.8"></a><span id="l2.8"> </span>
<a href="#l2.9"></a><span id="l2.9">     // convert the binary hash data to a hex string.</span>
<a href="#l2.10"></a><span id="l2.10">     return [toHexString(hash.charCodeAt(i)) for (i in hash)].join(&quot;&quot;);</span>
<a href="#l2.11"></a><span id="l2.11">   },</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-  </span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-  dateFormat: function gloda_utils_dateFormat(aDate) {</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-    return aDate.toLocaleString();</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineminus">-  },</span>
<a href="#l2.16"></a><span id="l2.16"> };</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

