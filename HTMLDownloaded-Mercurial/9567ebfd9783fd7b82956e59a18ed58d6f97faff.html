<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 24783:9567ebfd9783fd7b82956e59a18ed58d6f97faff</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 9567ebfd9783fd7b82956e59a18ed58d6f97faff" />
<meta property="og:url" content="/comm-central/rev/9567ebfd9783fd7b82956e59a18ed58d6f97faff" />
<meta property="og:description" content="Bug 1478572 - Turn on ESLint in mail/components/activity. r=aceman" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 9567ebfd9783fd7b82956e59a18ed58d6f97faff 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/9567ebfd9783fd7b82956e59a18ed58d6f97faff">shortlog</a> |
<a href="/comm-central/log/9567ebfd9783fd7b82956e59a18ed58d6f97faff">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/9567ebfd9783fd7b82956e59a18ed58d6f97faff">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/9567ebfd9783fd7b82956e59a18ed58d6f97faff">files</a> |
changeset |
<a href="/comm-central/raw-rev/9567ebfd9783fd7b82956e59a18ed58d6f97faff">raw</a>  | <a href="/comm-central/archive/9567ebfd9783fd7b82956e59a18ed58d6f97faff.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1478572">Bug 1478572</a> - Turn on ESLint in mail/components/activity. r=aceman
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#71;&#101;&#111;&#102;&#102;&#32;&#76;&#97;&#110;&#107;&#111;&#119;&#32;&#60;&#103;&#101;&#111;&#102;&#102;&#64;&#100;&#97;&#114;&#107;&#116;&#114;&#111;&#106;&#97;&#110;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 20 Sep 2018 11:11:55 +1200</td></tr>

<tr>
 <td>changeset 24783</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/9567ebfd9783fd7b82956e59a18ed58d6f97faff">9567ebfd9783fd7b82956e59a18ed58d6f97faff</a></td>
</tr>



<tr>
<td>parent 24782</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/5fca7138f5f682d588e3a7784673e9214dcf8e26">5fca7138f5f682d588e3a7784673e9214dcf8e26</a>
</td>
</tr>

<tr>
<td>child 24784</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/c33ef0679b50abf286fae6f23b6786ff87ae6552">c33ef0679b50abf286fae6f23b6786ff87ae6552</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=9567ebfd9783fd7b82956e59a18ed58d6f97faff">14912</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Thu, 20 Sep 2018 22:17:59 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@c33ef0679b50 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=c33ef0679b50abf286fae6f23b6786ff87ae6552">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=c33ef0679b50abf286fae6f23b6786ff87ae6552&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=c33ef0679b50abf286fae6f23b6786ff87ae6552&newProject=comm-central&newRevision=9567ebfd9783fd7b82956e59a18ed58d6f97faff&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=c33ef0679b50abf286fae6f23b6786ff87ae6552&newProject=comm-central&newRevision=9567ebfd9783fd7b82956e59a18ed58d6f97faff&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=c33ef0679b50abf286fae6f23b6786ff87ae6552&newProject=comm-central&newRevision=9567ebfd9783fd7b82956e59a18ed58d6f97faff&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28aceman%29&revcount=50">aceman</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1478572">1478572</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1478572">Bug 1478572</a> - Turn on ESLint in mail/components/activity. r=aceman</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9567ebfd9783fd7b82956e59a18ed58d6f97faff/.eslintignore">.eslintignore</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9567ebfd9783fd7b82956e59a18ed58d6f97faff/.eslintignore">file</a> |
<a href="/comm-central/annotate/9567ebfd9783fd7b82956e59a18ed58d6f97faff/.eslintignore">annotate</a> |
<a href="/comm-central/diff/9567ebfd9783fd7b82956e59a18ed58d6f97faff/.eslintignore">diff</a> |
<a href="/comm-central/comparison/9567ebfd9783fd7b82956e59a18ed58d6f97faff/.eslintignore">comparison</a> |
<a href="/comm-central/log/9567ebfd9783fd7b82956e59a18ed58d6f97faff/.eslintignore">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/base/content/msgMail3PaneWindow.js">mail/base/content/msgMail3PaneWindow.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/base/content/msgMail3PaneWindow.js">file</a> |
<a href="/comm-central/annotate/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/base/content/msgMail3PaneWindow.js">annotate</a> |
<a href="/comm-central/diff/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/base/content/msgMail3PaneWindow.js">diff</a> |
<a href="/comm-central/comparison/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/base/content/msgMail3PaneWindow.js">comparison</a> |
<a href="/comm-central/log/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/base/content/msgMail3PaneWindow.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/base/test/unit/test_alertHook.js">mail/base/test/unit/test_alertHook.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/base/test/unit/test_alertHook.js">file</a> |
<a href="/comm-central/annotate/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/base/test/unit/test_alertHook.js">annotate</a> |
<a href="/comm-central/diff/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/base/test/unit/test_alertHook.js">diff</a> |
<a href="/comm-central/comparison/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/base/test/unit/test_alertHook.js">comparison</a> |
<a href="/comm-central/log/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/base/test/unit/test_alertHook.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/content/activity.js">mail/components/activity/content/activity.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/content/activity.js">file</a> |
<a href="/comm-central/annotate/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/content/activity.js">annotate</a> |
<a href="/comm-central/diff/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/content/activity.js">diff</a> |
<a href="/comm-central/comparison/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/content/activity.js">comparison</a> |
<a href="/comm-central/log/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/content/activity.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/content/activity.xml">mail/components/activity/content/activity.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/content/activity.xml">file</a> |
<a href="/comm-central/annotate/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/content/activity.xml">annotate</a> |
<a href="/comm-central/diff/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/content/activity.xml">diff</a> |
<a href="/comm-central/comparison/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/content/activity.xml">comparison</a> |
<a href="/comm-central/log/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/content/activity.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/modules/activityModules.js">mail/components/activity/modules/activityModules.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/modules/activityModules.js">diff</a> |
<a href="/comm-central/comparison/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/modules/activityModules.js">comparison</a> |
<a href="/comm-central/log/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/modules/activityModules.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/modules/activityModules.jsm">mail/components/activity/modules/activityModules.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/modules/activityModules.jsm">file</a> |
<a href="/comm-central/annotate/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/modules/activityModules.jsm">annotate</a> |
<a href="/comm-central/diff/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/modules/activityModules.jsm">diff</a> |
<a href="/comm-central/comparison/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/modules/activityModules.jsm">comparison</a> |
<a href="/comm-central/log/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/modules/activityModules.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/modules/alertHook.js">mail/components/activity/modules/alertHook.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/modules/alertHook.js">diff</a> |
<a href="/comm-central/comparison/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/modules/alertHook.js">comparison</a> |
<a href="/comm-central/log/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/modules/alertHook.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/modules/alertHook.jsm">mail/components/activity/modules/alertHook.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/modules/alertHook.jsm">file</a> |
<a href="/comm-central/annotate/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/modules/alertHook.jsm">annotate</a> |
<a href="/comm-central/diff/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/modules/alertHook.jsm">diff</a> |
<a href="/comm-central/comparison/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/modules/alertHook.jsm">comparison</a> |
<a href="/comm-central/log/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/modules/alertHook.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/modules/autosync.js">mail/components/activity/modules/autosync.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/modules/autosync.js">diff</a> |
<a href="/comm-central/comparison/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/modules/autosync.js">comparison</a> |
<a href="/comm-central/log/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/modules/autosync.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/modules/autosync.jsm">mail/components/activity/modules/autosync.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/modules/autosync.jsm">file</a> |
<a href="/comm-central/annotate/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/modules/autosync.jsm">annotate</a> |
<a href="/comm-central/diff/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/modules/autosync.jsm">diff</a> |
<a href="/comm-central/comparison/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/modules/autosync.jsm">comparison</a> |
<a href="/comm-central/log/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/modules/autosync.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/modules/glodaIndexer.js">mail/components/activity/modules/glodaIndexer.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/modules/glodaIndexer.js">diff</a> |
<a href="/comm-central/comparison/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/modules/glodaIndexer.js">comparison</a> |
<a href="/comm-central/log/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/modules/glodaIndexer.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/modules/glodaIndexer.jsm">mail/components/activity/modules/glodaIndexer.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/modules/glodaIndexer.jsm">file</a> |
<a href="/comm-central/annotate/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/modules/glodaIndexer.jsm">annotate</a> |
<a href="/comm-central/diff/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/modules/glodaIndexer.jsm">diff</a> |
<a href="/comm-central/comparison/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/modules/glodaIndexer.jsm">comparison</a> |
<a href="/comm-central/log/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/modules/glodaIndexer.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/modules/moveCopy.js">mail/components/activity/modules/moveCopy.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/modules/moveCopy.js">diff</a> |
<a href="/comm-central/comparison/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/modules/moveCopy.js">comparison</a> |
<a href="/comm-central/log/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/modules/moveCopy.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/modules/moveCopy.jsm">mail/components/activity/modules/moveCopy.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/modules/moveCopy.jsm">file</a> |
<a href="/comm-central/annotate/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/modules/moveCopy.jsm">annotate</a> |
<a href="/comm-central/diff/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/modules/moveCopy.jsm">diff</a> |
<a href="/comm-central/comparison/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/modules/moveCopy.jsm">comparison</a> |
<a href="/comm-central/log/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/modules/moveCopy.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/modules/pop3Download.js">mail/components/activity/modules/pop3Download.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/modules/pop3Download.js">diff</a> |
<a href="/comm-central/comparison/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/modules/pop3Download.js">comparison</a> |
<a href="/comm-central/log/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/modules/pop3Download.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/modules/pop3Download.jsm">mail/components/activity/modules/pop3Download.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/modules/pop3Download.jsm">file</a> |
<a href="/comm-central/annotate/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/modules/pop3Download.jsm">annotate</a> |
<a href="/comm-central/diff/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/modules/pop3Download.jsm">diff</a> |
<a href="/comm-central/comparison/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/modules/pop3Download.jsm">comparison</a> |
<a href="/comm-central/log/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/modules/pop3Download.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/modules/sendLater.js">mail/components/activity/modules/sendLater.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/modules/sendLater.js">diff</a> |
<a href="/comm-central/comparison/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/modules/sendLater.js">comparison</a> |
<a href="/comm-central/log/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/modules/sendLater.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/modules/sendLater.jsm">mail/components/activity/modules/sendLater.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/modules/sendLater.jsm">file</a> |
<a href="/comm-central/annotate/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/modules/sendLater.jsm">annotate</a> |
<a href="/comm-central/diff/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/modules/sendLater.jsm">diff</a> |
<a href="/comm-central/comparison/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/modules/sendLater.jsm">comparison</a> |
<a href="/comm-central/log/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/modules/sendLater.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/moz.build">mail/components/activity/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/moz.build">file</a> |
<a href="/comm-central/annotate/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/moz.build">annotate</a> |
<a href="/comm-central/diff/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/moz.build">diff</a> |
<a href="/comm-central/comparison/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/moz.build">comparison</a> |
<a href="/comm-central/log/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/moz.build">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/nsActivity.js">mail/components/activity/nsActivity.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/nsActivity.js">file</a> |
<a href="/comm-central/annotate/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/nsActivity.js">annotate</a> |
<a href="/comm-central/diff/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/nsActivity.js">diff</a> |
<a href="/comm-central/comparison/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/nsActivity.js">comparison</a> |
<a href="/comm-central/log/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/nsActivity.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/nsActivityManager.js">mail/components/activity/nsActivityManager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/nsActivityManager.js">file</a> |
<a href="/comm-central/annotate/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/nsActivityManager.js">annotate</a> |
<a href="/comm-central/diff/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/nsActivityManager.js">diff</a> |
<a href="/comm-central/comparison/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/nsActivityManager.js">comparison</a> |
<a href="/comm-central/log/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/nsActivityManager.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/nsActivityManagerUI.js">mail/components/activity/nsActivityManagerUI.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/nsActivityManagerUI.js">file</a> |
<a href="/comm-central/annotate/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/nsActivityManagerUI.js">annotate</a> |
<a href="/comm-central/diff/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/nsActivityManagerUI.js">diff</a> |
<a href="/comm-central/comparison/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/nsActivityManagerUI.js">comparison</a> |
<a href="/comm-central/log/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/activity/nsActivityManagerUI.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/addrbook/content/addressbook.js">mail/components/addrbook/content/addressbook.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/addrbook/content/addressbook.js">file</a> |
<a href="/comm-central/annotate/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/addrbook/content/addressbook.js">annotate</a> |
<a href="/comm-central/diff/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/addrbook/content/addressbook.js">diff</a> |
<a href="/comm-central/comparison/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/addrbook/content/addressbook.js">comparison</a> |
<a href="/comm-central/log/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/addrbook/content/addressbook.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/compose/content/MsgComposeCommands.js">mail/components/compose/content/MsgComposeCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/compose/content/MsgComposeCommands.js">file</a> |
<a href="/comm-central/annotate/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/compose/content/MsgComposeCommands.js">annotate</a> |
<a href="/comm-central/diff/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/compose/content/MsgComposeCommands.js">diff</a> |
<a href="/comm-central/comparison/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/compose/content/MsgComposeCommands.js">comparison</a> |
<a href="/comm-central/log/9567ebfd9783fd7b82956e59a18ed58d6f97faff/mail/components/compose/content/MsgComposeCommands.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/.eslintignore</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/.eslintignore</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -46,17 +46,16 @@ mailnews/test/*</span>
<a href="#l1.4"></a><span id="l1.4"> # mailnews/extensions exclusions</span>
<a href="#l1.5"></a><span id="l1.5"> mailnews/extensions/*</span>
<a href="#l1.6"></a><span id="l1.6"> !mailnews/extensions/newsblog</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8"> # mail exclusions</span>
<a href="#l1.9"></a><span id="l1.9"> mail/app/**</span>
<a href="#l1.10"></a><span id="l1.10"> mail/base/**</span>
<a href="#l1.11"></a><span id="l1.11"> mail/branding/**</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-mail/components/activity/**</span>
<a href="#l1.13"></a><span id="l1.13"> mail/components/cloudfile/**</span>
<a href="#l1.14"></a><span id="l1.14"> mail/components/compose/**</span>
<a href="#l1.15"></a><span id="l1.15"> mail/components/im/**</span>
<a href="#l1.16"></a><span id="l1.16"> mail/components/newmailaccount/**</span>
<a href="#l1.17"></a><span id="l1.17"> mail/components/search/**</span>
<a href="#l1.18"></a><span id="l1.18"> mail/config/**</span>
<a href="#l1.19"></a><span id="l1.19"> mail/extensions/**</span>
<a href="#l1.20"></a><span id="l1.20"> mail/installer/**</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/base/content/msgMail3PaneWindow.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/base/content/msgMail3PaneWindow.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -1,14 +1,14 @@</span>
<a href="#l2.4"></a><span id="l2.4"> /**</span>
<a href="#l2.5"></a><span id="l2.5">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l2.6"></a><span id="l2.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l2.7"></a><span id="l2.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l2.8"></a><span id="l2.8"> </span>
<a href="#l2.9"></a><span id="l2.9" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/activity/activityModules.js&quot;);</span>
<a href="#l2.10"></a><span id="l2.10" class="difflineplus">+ChromeUtils.import(&quot;resource:///modules/activity/activityModules.jsm&quot;);</span>
<a href="#l2.11"></a><span id="l2.11"> ChromeUtils.import(&quot;resource:///modules/errUtils.js&quot;);</span>
<a href="#l2.12"></a><span id="l2.12"> ChromeUtils.import(&quot;resource:///modules/folderUtils.jsm&quot;);</span>
<a href="#l2.13"></a><span id="l2.13"> ChromeUtils.import(&quot;resource:///modules/IOUtils.js&quot;);</span>
<a href="#l2.14"></a><span id="l2.14"> ChromeUtils.import(&quot;resource:///modules/jsTreeSelection.js&quot;);</span>
<a href="#l2.15"></a><span id="l2.15"> ChromeUtils.import(&quot;resource:///modules/MailConsts.js&quot;);</span>
<a href="#l2.16"></a><span id="l2.16"> ChromeUtils.import(&quot;resource:///modules/mailInstrumentation.js&quot;);</span>
<a href="#l2.17"></a><span id="l2.17"> ChromeUtils.import(&quot;resource:///modules/mailnewsMigrator.js&quot;);</span>
<a href="#l2.18"></a><span id="l2.18"> ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/base/test/unit/test_alertHook.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/base/test/unit/test_alertHook.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -1,14 +1,14 @@</span>
<a href="#l3.4"></a><span id="l3.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l3.5"></a><span id="l3.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l3.6"></a><span id="l3.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8"> ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l3.9"></a><span id="l3.9" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/activity/alertHook.js&quot;);</span>
<a href="#l3.10"></a><span id="l3.10" class="difflineplus">+ChromeUtils.import(&quot;resource:///modules/activity/alertHook.jsm&quot;);</span>
<a href="#l3.11"></a><span id="l3.11"> ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l3.12"></a><span id="l3.12"> ChromeUtils.import(&quot;resource://testing-common/mailnews/MockFactory.js&quot;);</span>
<a href="#l3.13"></a><span id="l3.13"> alertHook.init();</span>
<a href="#l3.14"></a><span id="l3.14"> </span>
<a href="#l3.15"></a><span id="l3.15"> // Replace the alerts service with our own. This will let us check if we're</span>
<a href="#l3.16"></a><span id="l3.16"> // prompting or not.</span>
<a href="#l3.17"></a><span id="l3.17"> var gAlertShown = false;</span>
<a href="#l3.18"></a><span id="l3.18"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/components/activity/content/activity.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/components/activity/content/activity.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -1,183 +1,165 @@</span>
<a href="#l4.4"></a><span id="l4.4"> /* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l4.5"></a><span id="l4.5">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l4.6"></a><span id="l4.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l4.7"></a><span id="l4.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l4.8"></a><span id="l4.8"> </span>
<a href="#l4.9"></a><span id="l4.9" class="difflineminus">-////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l4.10"></a><span id="l4.10" class="difflineminus">-//// Globals</span>
<a href="#l4.11"></a><span id="l4.11" class="difflineminus">-</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-ChromeUtils.import(&quot;resource://gre/modules/PluralForm.jsm&quot;);</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/gloda/log4moz.js&quot;);</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+const { Log4Moz } = ChromeUtils.import(&quot;resource:///modules/gloda/log4moz.js&quot;, null);</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+const activityManager = Cc[&quot;@mozilla.org/activity-manager;1&quot;].getService(Ci.nsIActivityManager);</span>
<a href="#l4.17"></a><span id="l4.17"> </span>
<a href="#l4.18"></a><span id="l4.18" class="difflineminus">-var nsActProcess = Components.Constructor(&quot;@mozilla.org/activity-process;1&quot;,</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineminus">-                                            &quot;nsIActivityProcess&quot;, &quot;init&quot;);</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineminus">-var nsActEvent = Components.Constructor(&quot;@mozilla.org/activity-event;1&quot;,</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineminus">-                                          &quot;nsIActivityEvent&quot;, &quot;init&quot;);</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineminus">-var nsActWarning = Components.Constructor(&quot;@mozilla.org/activity-warning;1&quot;,</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineminus">-                                            &quot;nsIActivityWarning&quot;, &quot;init&quot;);</span>
<a href="#l4.24"></a><span id="l4.24"> var ACTIVITY_LIMIT = 250;</span>
<a href="#l4.25"></a><span id="l4.25"> </span>
<a href="#l4.26"></a><span id="l4.26" class="difflineminus">-var activityObject =</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineminus">-{</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineminus">-</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineplus">+var activityObject = {</span>
<a href="#l4.30"></a><span id="l4.30">   _activityMgrListener: null,</span>
<a href="#l4.31"></a><span id="l4.31">   _activitiesView: null,</span>
<a href="#l4.32"></a><span id="l4.32">   _activityLogger: Log4Moz.getConfiguredLogger(&quot;activitymgr&quot;),</span>
<a href="#l4.33"></a><span id="l4.33">   _ignoreNotifications: false,</span>
<a href="#l4.34"></a><span id="l4.34">   _groupCache: new Map(),</span>
<a href="#l4.35"></a><span id="l4.35"> </span>
<a href="#l4.36"></a><span id="l4.36" class="difflineminus">-  selectAll: function() {</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+  selectAll() {</span>
<a href="#l4.38"></a><span id="l4.38">     this._activitiesView.selectAll();</span>
<a href="#l4.39"></a><span id="l4.39">   },</span>
<a href="#l4.40"></a><span id="l4.40"> </span>
<a href="#l4.41"></a><span id="l4.41" class="difflineminus">-  //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineminus">-  //// An object to monitor nsActivityManager operations. This class acts as</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineminus">-  //// binding layer between nsActivityManager and nsActivityManagerUI objects.</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+  // An object to monitor nsActivityManager operations. This class acts as</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+  // binding layer between nsActivityManager and nsActivityManagerUI objects.</span>
<a href="#l4.46"></a><span id="l4.46"> </span>
<a href="#l4.47"></a><span id="l4.47">   /**</span>
<a href="#l4.48"></a><span id="l4.48">    * Note: The prototype for this function is set at the bottom of this file.</span>
<a href="#l4.49"></a><span id="l4.49">    */</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineminus">-  ActivityMgrListener: function() {},</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineplus">+  ActivityMgrListener() {},</span>
<a href="#l4.52"></a><span id="l4.52"> </span>
<a href="#l4.53"></a><span id="l4.53" class="difflineminus">-  //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineminus">-  //// Utility Functions for Activity binding management</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineplus">+  // Utility Functions for Activity binding management</span>
<a href="#l4.56"></a><span id="l4.56"> </span>
<a href="#l4.57"></a><span id="l4.57">   /**</span>
<a href="#l4.58"></a><span id="l4.58">    * Creates the proper binding for the given activity</span>
<a href="#l4.59"></a><span id="l4.59">    */</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineminus">-  createActivityBinding: function(aActivity) {</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineplus">+  createActivityBinding(aActivity) {</span>
<a href="#l4.62"></a><span id="l4.62">     let bindingName = aActivity.bindingName;</span>
<a href="#l4.63"></a><span id="l4.63">     let binding = document.createElement(bindingName);</span>
<a href="#l4.64"></a><span id="l4.64"> </span>
<a href="#l4.65"></a><span id="l4.65">     if (binding)</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineminus">-      binding.setAttribute('actID', aActivity.id);</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineplus">+      binding.setAttribute(&quot;actID&quot;, aActivity.id);</span>
<a href="#l4.68"></a><span id="l4.68"> </span>
<a href="#l4.69"></a><span id="l4.69">     return binding;</span>
<a href="#l4.70"></a><span id="l4.70">   },</span>
<a href="#l4.71"></a><span id="l4.71"> </span>
<a href="#l4.72"></a><span id="l4.72">   /**</span>
<a href="#l4.73"></a><span id="l4.73">    * Returns the activity group binding that matches the context_type</span>
<a href="#l4.74"></a><span id="l4.74">    * and context of the given activity, if any.</span>
<a href="#l4.75"></a><span id="l4.75">    */</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineminus">-  getActivityGroupBindingByContext: function(aContextType, aContextObj) {</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineplus">+  getActivityGroupBindingByContext(aContextType, aContextObj) {</span>
<a href="#l4.78"></a><span id="l4.78">     return this._groupCache.get(aContextType + &quot;:&quot; + aContextObj);</span>
<a href="#l4.79"></a><span id="l4.79">   },</span>
<a href="#l4.80"></a><span id="l4.80"> </span>
<a href="#l4.81"></a><span id="l4.81">   /**</span>
<a href="#l4.82"></a><span id="l4.82">    * Inserts the given binding into the correct position on the</span>
<a href="#l4.83"></a><span id="l4.83">    * activity manager window.</span>
<a href="#l4.84"></a><span id="l4.84">    */</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineminus">-  placeActivityBinding: function(aBinding) {</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineplus">+  placeActivityBinding(aBinding) {</span>
<a href="#l4.87"></a><span id="l4.87">     if (aBinding.isGroup || aBinding.isProcess)</span>
<a href="#l4.88"></a><span id="l4.88">       this._activitiesView.insertBefore(aBinding,</span>
<a href="#l4.89"></a><span id="l4.89">                                         this._activitiesView.firstChild);</span>
<a href="#l4.90"></a><span id="l4.90">     else {</span>
<a href="#l4.91"></a><span id="l4.91">       let next = this._activitiesView.firstChild;</span>
<a href="#l4.92"></a><span id="l4.92">       while (next &amp;&amp; (next.isWarning || next.isProcess || next.isGroup))</span>
<a href="#l4.93"></a><span id="l4.93">         next = next.nextSibling;</span>
<a href="#l4.94"></a><span id="l4.94">       if (next)</span>
<a href="#l4.95"></a><span id="l4.95">         this._activitiesView.insertBefore(aBinding, next);</span>
<a href="#l4.96"></a><span id="l4.96">       else</span>
<a href="#l4.97"></a><span id="l4.97">         this._activitiesView.appendChild(aBinding);</span>
<a href="#l4.98"></a><span id="l4.98">     }</span>
<a href="#l4.99"></a><span id="l4.99">     if (aBinding.isGroup)</span>
<a href="#l4.100"></a><span id="l4.100">       this._groupCache.set(aBinding.contextType + &quot;:&quot; + aBinding.contextObj,</span>
<a href="#l4.101"></a><span id="l4.101">                            aBinding);</span>
<a href="#l4.102"></a><span id="l4.102">     while (this._activitiesView.childNodes.length &gt; ACTIVITY_LIMIT)</span>
<a href="#l4.103"></a><span id="l4.103" class="difflineminus">-      this.removeActivityBinding(this._activitiesView.lastChild.getAttribute('actID'));</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineplus">+      this.removeActivityBinding(this._activitiesView.lastChild.getAttribute(&quot;actID&quot;));</span>
<a href="#l4.105"></a><span id="l4.105">   },</span>
<a href="#l4.106"></a><span id="l4.106"> </span>
<a href="#l4.107"></a><span id="l4.107">   /**</span>
<a href="#l4.108"></a><span id="l4.108">    * Adds a new binding to activity manager window for the</span>
<a href="#l4.109"></a><span id="l4.109">    * given activity. It is called by ActivityMgrListener when</span>
<a href="#l4.110"></a><span id="l4.110">    * a new activity is added into the activity manager's internal</span>
<a href="#l4.111"></a><span id="l4.111">    * list.</span>
<a href="#l4.112"></a><span id="l4.112">    */</span>
<a href="#l4.113"></a><span id="l4.113" class="difflineminus">-  addActivityBinding: function(aID, aActivity) {</span>
<a href="#l4.114"></a><span id="l4.114" class="difflineplus">+  addActivityBinding(aID, aActivity) {</span>
<a href="#l4.115"></a><span id="l4.115">     try {</span>
<a href="#l4.116"></a><span id="l4.116" class="difflineminus">-      this._activityLogger.info(&quot;Adding ActivityBinding: &quot; + aID + &quot;, &quot; +</span>
<a href="#l4.117"></a><span id="l4.117" class="difflineminus">-                                aActivity)</span>
<a href="#l4.118"></a><span id="l4.118" class="difflineplus">+      this._activityLogger.info(`Adding ActivityBinding: ${aID}, ${aActivity}`);</span>
<a href="#l4.119"></a><span id="l4.119">       // get |groupingStyle| of the activity. Grouping style determines</span>
<a href="#l4.120"></a><span id="l4.120">       // whether we show the activity standalone or grouped by context in</span>
<a href="#l4.121"></a><span id="l4.121">       // the activity manager window.</span>
<a href="#l4.122"></a><span id="l4.122">       let isGroupByContext = (aActivity.groupingStyle ==</span>
<a href="#l4.123"></a><span id="l4.123">                               Ci.nsIActivity</span>
<a href="#l4.124"></a><span id="l4.124">                                 .GROUPING_STYLE_BYCONTEXT);</span>
<a href="#l4.125"></a><span id="l4.125"> </span>
<a href="#l4.126"></a><span id="l4.126">       // find out if an activity group has already been created for this context</span>
<a href="#l4.127"></a><span id="l4.127">       let group = null;</span>
<a href="#l4.128"></a><span id="l4.128">       if (isGroupByContext) {</span>
<a href="#l4.129"></a><span id="l4.129">         group = this.getActivityGroupBindingByContext(aActivity.contextType,</span>
<a href="#l4.130"></a><span id="l4.130">                                                  aActivity.contextObj);</span>
<a href="#l4.131"></a><span id="l4.131">         // create a group if it's not already created.</span>
<a href="#l4.132"></a><span id="l4.132">         if (!group) {</span>
<a href="#l4.133"></a><span id="l4.133">           group = document.createElement(&quot;activity-group&quot;);</span>
<a href="#l4.134"></a><span id="l4.134" class="difflineminus">-          this._activityLogger.info(&quot;created group element&quot;)</span>
<a href="#l4.135"></a><span id="l4.135" class="difflineplus">+          this._activityLogger.info(&quot;created group element&quot;);</span>
<a href="#l4.136"></a><span id="l4.136">           // Set the context type and object of the newly created group</span>
<a href="#l4.137"></a><span id="l4.137">           group.contextType = aActivity.contextType;</span>
<a href="#l4.138"></a><span id="l4.138">           group.contextObj = aActivity.contextObj;</span>
<a href="#l4.139"></a><span id="l4.139">           group.contextDisplayText = aActivity.contextDisplayText;</span>
<a href="#l4.140"></a><span id="l4.140"> </span>
<a href="#l4.141"></a><span id="l4.141">           // add group into the list</span>
<a href="#l4.142"></a><span id="l4.142">           this.placeActivityBinding(group);</span>
<a href="#l4.143"></a><span id="l4.143">         }</span>
<a href="#l4.144"></a><span id="l4.144">       }</span>
<a href="#l4.145"></a><span id="l4.145"> </span>
<a href="#l4.146"></a><span id="l4.146">       // create the appropriate binding for the activity</span>
<a href="#l4.147"></a><span id="l4.147">       let actBinding = this.createActivityBinding(aActivity);</span>
<a href="#l4.148"></a><span id="l4.148" class="difflineminus">-      this._activityLogger.info(&quot;created activity binding&quot;)</span>
<a href="#l4.149"></a><span id="l4.149" class="difflineplus">+      this._activityLogger.info(&quot;created activity binding&quot;);</span>
<a href="#l4.150"></a><span id="l4.150"> </span>
<a href="#l4.151"></a><span id="l4.151">       if (group) {</span>
<a href="#l4.152"></a><span id="l4.152">         // get the inner list element of the group</span>
<a href="#l4.153"></a><span id="l4.153">         let groupView = document.getAnonymousElementByAttribute(group, &quot;anonid&quot;,</span>
<a href="#l4.154"></a><span id="l4.154">                                                            &quot;activityGroupView&quot;);</span>
<a href="#l4.155"></a><span id="l4.155">         groupView.appendChild(actBinding);</span>
<a href="#l4.156"></a><span id="l4.156" class="difflineminus">-      }</span>
<a href="#l4.157"></a><span id="l4.157" class="difflineminus">-      else {</span>
<a href="#l4.158"></a><span id="l4.158" class="difflineplus">+      } else {</span>
<a href="#l4.159"></a><span id="l4.159">         this.placeActivityBinding(actBinding);</span>
<a href="#l4.160"></a><span id="l4.160">       }</span>
<a href="#l4.161"></a><span id="l4.161">     } catch (e) {</span>
<a href="#l4.162"></a><span id="l4.162">       this._activityLogger.error(&quot;addActivityBinding: &quot; + e);</span>
<a href="#l4.163"></a><span id="l4.163" class="difflineminus">-      throw(e);</span>
<a href="#l4.164"></a><span id="l4.164" class="difflineplus">+      throw e;</span>
<a href="#l4.165"></a><span id="l4.165">     }</span>
<a href="#l4.166"></a><span id="l4.166">   },</span>
<a href="#l4.167"></a><span id="l4.167"> </span>
<a href="#l4.168"></a><span id="l4.168">   /**</span>
<a href="#l4.169"></a><span id="l4.169">    * Removes the activity binding from the activity manager window.</span>
<a href="#l4.170"></a><span id="l4.170">    * It is called by ActivityMgrListener when the activity in question</span>
<a href="#l4.171"></a><span id="l4.171">    * is removed from the activity manager's internal list.</span>
<a href="#l4.172"></a><span id="l4.172">    */</span>
<a href="#l4.173"></a><span id="l4.173" class="difflineminus">-  removeActivityBinding: function(aID) {</span>
<a href="#l4.174"></a><span id="l4.174" class="difflineplus">+  removeActivityBinding(aID) {</span>
<a href="#l4.175"></a><span id="l4.175">     // Note: document.getAnonymousNodes(_activitiesView); didn't work</span>
<a href="#l4.176"></a><span id="l4.176">     this._activityLogger.info(&quot;removing Activity ID: &quot; + aID);</span>
<a href="#l4.177"></a><span id="l4.177">     let activities = this._activitiesView.childNodes;</span>
<a href="#l4.178"></a><span id="l4.178">     for (let i = 0; i &lt; activities.length; i++) {</span>
<a href="#l4.179"></a><span id="l4.179">       let item = activities[i];</span>
<a href="#l4.180"></a><span id="l4.180">       if (!item) {</span>
<a href="#l4.181"></a><span id="l4.181" class="difflineminus">-        this._activityLogger.debug(&quot;returning as empty&quot;)</span>
<a href="#l4.182"></a><span id="l4.182" class="difflineplus">+        this._activityLogger.debug(&quot;returning as empty&quot;);</span>
<a href="#l4.183"></a><span id="l4.183">         return;</span>
<a href="#l4.184"></a><span id="l4.184">       }</span>
<a href="#l4.185"></a><span id="l4.185"> </span>
<a href="#l4.186"></a><span id="l4.186">       if (!item.isGroup) {</span>
<a href="#l4.187"></a><span id="l4.187" class="difflineminus">-        this._activityLogger.debug(&quot;is not a group, &quot;)</span>
<a href="#l4.188"></a><span id="l4.188" class="difflineminus">-        if (item.getAttribute('actID') == aID) {</span>
<a href="#l4.189"></a><span id="l4.189" class="difflineplus">+        this._activityLogger.debug(&quot;is not a group, &quot;);</span>
<a href="#l4.190"></a><span id="l4.190" class="difflineplus">+        if (item.getAttribute(&quot;actID&quot;) == aID) {</span>
<a href="#l4.191"></a><span id="l4.191">           // since XBL dtors are not working properly when we remove the</span>
<a href="#l4.192"></a><span id="l4.192">           // element, we have to explicitly remove the binding from</span>
<a href="#l4.193"></a><span id="l4.193">           // activities' listeners list. See bug 230086 for details.</span>
<a href="#l4.194"></a><span id="l4.194">           item.detachFromActivity();</span>
<a href="#l4.195"></a><span id="l4.195">           item.remove();</span>
<a href="#l4.196"></a><span id="l4.196">           break;</span>
<a href="#l4.197"></a><span id="l4.197">         }</span>
<a href="#l4.198"></a><span id="l4.198" class="difflineminus">-      }</span>
<a href="#l4.199"></a><span id="l4.199" class="difflineminus">-      else {</span>
<a href="#l4.200"></a><span id="l4.200" class="difflineminus">-        let actbinding = document.getAnonymousElementByAttribute(item, 'actID',</span>
<a href="#l4.201"></a><span id="l4.201" class="difflineminus">-                                                                 aID);</span>
<a href="#l4.202"></a><span id="l4.202" class="difflineplus">+      } else {</span>
<a href="#l4.203"></a><span id="l4.203" class="difflineplus">+        let actbinding = document.getAnonymousElementByAttribute(item, &quot;actID&quot;, aID);</span>
<a href="#l4.204"></a><span id="l4.204">         if (actbinding) {</span>
<a href="#l4.205"></a><span id="l4.205">           let groupView = document.getAnonymousElementByAttribute(item,</span>
<a href="#l4.206"></a><span id="l4.206">                                                  &quot;anonid&quot;, &quot;activityGroupView&quot;);</span>
<a href="#l4.207"></a><span id="l4.207">           // since XBL dtors are not working properly when we remove the</span>
<a href="#l4.208"></a><span id="l4.208">           // element, we have to explicitly remove the binding from</span>
<a href="#l4.209"></a><span id="l4.209">           // activities' listeners list. See bug 230086 for details.</span>
<a href="#l4.210"></a><span id="l4.210">           actbinding.detachFromActivity();</span>
<a href="#l4.211"></a><span id="l4.211">           actbinding.remove();</span>
<a href="#l4.212"></a><span id="l4.212" class="difflineat">@@ -190,134 +172,123 @@ var activityObject =</span>
<a href="#l4.213"></a><span id="l4.213">           }</span>
<a href="#l4.214"></a><span id="l4.214"> </span>
<a href="#l4.215"></a><span id="l4.215">           break;</span>
<a href="#l4.216"></a><span id="l4.216">         }</span>
<a href="#l4.217"></a><span id="l4.217">       }</span>
<a href="#l4.218"></a><span id="l4.218">     }</span>
<a href="#l4.219"></a><span id="l4.219">   },</span>
<a href="#l4.220"></a><span id="l4.220"> </span>
<a href="#l4.221"></a><span id="l4.221" class="difflineminus">-  //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l4.222"></a><span id="l4.222" class="difflineminus">-  //// Startup, Shutdown</span>
<a href="#l4.223"></a><span id="l4.223" class="difflineplus">+  // -----------------</span>
<a href="#l4.224"></a><span id="l4.224" class="difflineplus">+  // Startup, Shutdown</span>
<a href="#l4.225"></a><span id="l4.225"> </span>
<a href="#l4.226"></a><span id="l4.226" class="difflineminus">-  startup: function() {</span>
<a href="#l4.227"></a><span id="l4.227" class="difflineplus">+  startup() {</span>
<a href="#l4.228"></a><span id="l4.228">     try {</span>
<a href="#l4.229"></a><span id="l4.229">       this._activitiesView = document.getElementById(&quot;activityView&quot;);</span>
<a href="#l4.230"></a><span id="l4.230"> </span>
<a href="#l4.231"></a><span id="l4.231" class="difflineminus">-      let activityManager = Cc[&quot;@mozilla.org/activity-manager;1&quot;]</span>
<a href="#l4.232"></a><span id="l4.232" class="difflineminus">-                         .getService(Ci.nsIActivityManager);</span>
<a href="#l4.233"></a><span id="l4.233">       let activities = activityManager.getActivities({});</span>
<a href="#l4.234"></a><span id="l4.234">       for (let iActivity = Math.max(0, activities.length - ACTIVITY_LIMIT);</span>
<a href="#l4.235"></a><span id="l4.235">            iActivity &lt; activities.length; iActivity++) {</span>
<a href="#l4.236"></a><span id="l4.236">         let activity = activities[iActivity];</span>
<a href="#l4.237"></a><span id="l4.237">         this.addActivityBinding(activity.id, activity);</span>
<a href="#l4.238"></a><span id="l4.238">       }</span>
<a href="#l4.239"></a><span id="l4.239"> </span>
<a href="#l4.240"></a><span id="l4.240">       // start listening changes in the activity manager's</span>
<a href="#l4.241"></a><span id="l4.241">       // internal list</span>
<a href="#l4.242"></a><span id="l4.242">       this._activityMgrListener = new this.ActivityMgrListener();</span>
<a href="#l4.243"></a><span id="l4.243">       activityManager.addListener(this._activityMgrListener);</span>
<a href="#l4.244"></a><span id="l4.244"> </span>
<a href="#l4.245"></a><span id="l4.245">     } catch (e) {</span>
<a href="#l4.246"></a><span id="l4.246" class="difflineminus">-      this._activityLogger.error(&quot;Exception: &quot; + e )</span>
<a href="#l4.247"></a><span id="l4.247" class="difflineplus">+      this._activityLogger.error(&quot;Exception: &quot; + e);</span>
<a href="#l4.248"></a><span id="l4.248">     }</span>
<a href="#l4.249"></a><span id="l4.249">   },</span>
<a href="#l4.250"></a><span id="l4.250"> </span>
<a href="#l4.251"></a><span id="l4.251" class="difflineminus">-  rebuild: function() {</span>
<a href="#l4.252"></a><span id="l4.252" class="difflineminus">-    let activityManager = Cc[&quot;@mozilla.org/activity-manager;1&quot;]</span>
<a href="#l4.253"></a><span id="l4.253" class="difflineminus">-      .getService(Ci.nsIActivityManager);</span>
<a href="#l4.254"></a><span id="l4.254" class="difflineplus">+  rebuild() {</span>
<a href="#l4.255"></a><span id="l4.255">     let activities = activityManager.getActivities({});</span>
<a href="#l4.256"></a><span id="l4.256">     for (let activity of activities)</span>
<a href="#l4.257"></a><span id="l4.257">       this.addActivityBinding(activity.id, activity);</span>
<a href="#l4.258"></a><span id="l4.258">   },</span>
<a href="#l4.259"></a><span id="l4.259"> </span>
<a href="#l4.260"></a><span id="l4.260" class="difflineminus">-  shutdown: function() {</span>
<a href="#l4.261"></a><span id="l4.261" class="difflineminus">-    let activityManager = Cc[&quot;@mozilla.org/activity-manager;1&quot;]</span>
<a href="#l4.262"></a><span id="l4.262" class="difflineminus">-      .getService(Ci.nsIActivityManager);</span>
<a href="#l4.263"></a><span id="l4.263" class="difflineplus">+  shutdown() {</span>
<a href="#l4.264"></a><span id="l4.264">     activityManager.removeListener(this._activityMgrListener);</span>
<a href="#l4.265"></a><span id="l4.265">   },</span>
<a href="#l4.266"></a><span id="l4.266"> </span>
<a href="#l4.267"></a><span id="l4.267" class="difflineminus">-  //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l4.268"></a><span id="l4.268" class="difflineminus">-  //// Utility Functions</span>
<a href="#l4.269"></a><span id="l4.269" class="difflineplus">+  // -----------------</span>
<a href="#l4.270"></a><span id="l4.270" class="difflineplus">+  // Utility Functions</span>
<a href="#l4.271"></a><span id="l4.271"> </span>
<a href="#l4.272"></a><span id="l4.272">   /**</span>
<a href="#l4.273"></a><span id="l4.273">    * Remove all activities not in-progress from the activity list.</span>
<a href="#l4.274"></a><span id="l4.274">    */</span>
<a href="#l4.275"></a><span id="l4.275" class="difflineminus">-  clearActivityList: function() {</span>
<a href="#l4.276"></a><span id="l4.276" class="difflineplus">+  clearActivityList() {</span>
<a href="#l4.277"></a><span id="l4.277">     this._activityLogger.debug(&quot;clearActivityList&quot;);</span>
<a href="#l4.278"></a><span id="l4.278"> </span>
<a href="#l4.279"></a><span id="l4.279">     this._ignoreNotifications = true;</span>
<a href="#l4.280"></a><span id="l4.280">     // If/when we implement search, we'll want to remove just the items</span>
<a href="#l4.281"></a><span id="l4.281">     // that are on the search display, however for now, we'll just clear up</span>
<a href="#l4.282"></a><span id="l4.282">     // everything.</span>
<a href="#l4.283"></a><span id="l4.283" class="difflineminus">-    Cc[&quot;@mozilla.org/activity-manager;1&quot;]</span>
<a href="#l4.284"></a><span id="l4.284" class="difflineminus">-      .getService(Ci.nsIActivityManager)</span>
<a href="#l4.285"></a><span id="l4.285" class="difflineminus">-      .cleanUp();</span>
<a href="#l4.286"></a><span id="l4.286" class="difflineplus">+    activityManager.cleanUp();</span>
<a href="#l4.287"></a><span id="l4.287"> </span>
<a href="#l4.288"></a><span id="l4.288">     // since XBL dtors are not working properly when we remove the element,</span>
<a href="#l4.289"></a><span id="l4.289">     // we have to explicitly remove the binding from activities' listeners</span>
<a href="#l4.290"></a><span id="l4.290">     // list. See bug 230086 for details.</span>
<a href="#l4.291"></a><span id="l4.291">     let activities = this._activitiesView.childNodes;</span>
<a href="#l4.292"></a><span id="l4.292">     for (let i = activities.length - 1; i &gt;= 0; i--) {</span>
<a href="#l4.293"></a><span id="l4.293">       let item = activities[i];</span>
<a href="#l4.294"></a><span id="l4.294" class="difflineminus">-      if (!item.isGroup)</span>
<a href="#l4.295"></a><span id="l4.295" class="difflineplus">+      if (!item.isGroup) {</span>
<a href="#l4.296"></a><span id="l4.296">         item.detachFromActivity();</span>
<a href="#l4.297"></a><span id="l4.297" class="difflineminus">-      else {</span>
<a href="#l4.298"></a><span id="l4.298" class="difflineminus">-        let actbinding = document.getAnonymousElementByAttribute(item,</span>
<a href="#l4.299"></a><span id="l4.299" class="difflineminus">-                                                                 'actID', '*');</span>
<a href="#l4.300"></a><span id="l4.300" class="difflineplus">+      } else {</span>
<a href="#l4.301"></a><span id="l4.301" class="difflineplus">+        let actbinding = document.getAnonymousElementByAttribute(item, &quot;actID&quot;, &quot;*&quot;);</span>
<a href="#l4.302"></a><span id="l4.302">         while (actbinding) {</span>
<a href="#l4.303"></a><span id="l4.303">           actbinding.detachFromActivity();</span>
<a href="#l4.304"></a><span id="l4.304">           actbinding.remove();</span>
<a href="#l4.305"></a><span id="l4.305" class="difflineminus">-          actbinding = document.getAnonymousElementByAttribute(item,</span>
<a href="#l4.306"></a><span id="l4.306" class="difflineminus">-                                                               'actID', '*');</span>
<a href="#l4.307"></a><span id="l4.307" class="difflineplus">+          actbinding = document.getAnonymousElementByAttribute(item, &quot;actID&quot;, &quot;*&quot;);</span>
<a href="#l4.308"></a><span id="l4.308">         }</span>
<a href="#l4.309"></a><span id="l4.309">       }</span>
<a href="#l4.310"></a><span id="l4.310">     }</span>
<a href="#l4.311"></a><span id="l4.311"> </span>
<a href="#l4.312"></a><span id="l4.312">     let empty = this._activitiesView.cloneNode(false);</span>
<a href="#l4.313"></a><span id="l4.313">     this._activitiesView.parentNode.replaceChild(empty, this._activitiesView);</span>
<a href="#l4.314"></a><span id="l4.314">     this._activitiesView = empty;</span>
<a href="#l4.315"></a><span id="l4.315"> </span>
<a href="#l4.316"></a><span id="l4.316">     this._groupCache.clear();</span>
<a href="#l4.317"></a><span id="l4.317">     this.rebuild();</span>
<a href="#l4.318"></a><span id="l4.318">     this._ignoreNotifications = false;</span>
<a href="#l4.319"></a><span id="l4.319">     this._activitiesView.focus();</span>
<a href="#l4.320"></a><span id="l4.320">   },</span>
<a href="#l4.321"></a><span id="l4.321"> </span>
<a href="#l4.322"></a><span id="l4.322" class="difflineminus">-  processKeyEvent: function(event) {</span>
<a href="#l4.323"></a><span id="l4.323" class="difflineplus">+  processKeyEvent(event) {</span>
<a href="#l4.324"></a><span id="l4.324">     switch (event.keyCode) {</span>
<a href="#l4.325"></a><span id="l4.325">       case event.DOM_VK_RIGHT:</span>
<a href="#l4.326"></a><span id="l4.326" class="difflineminus">-        if (event.target.tagName == 'richlistbox') {</span>
<a href="#l4.327"></a><span id="l4.327" class="difflineplus">+        if (event.target.tagName == &quot;richlistbox&quot;) {</span>
<a href="#l4.328"></a><span id="l4.328">           let richlistbox = event.target.selectedItem.processes;</span>
<a href="#l4.329"></a><span id="l4.329" class="difflineminus">-          if (richlistbox.tagName == 'xul:richlistbox') {</span>
<a href="#l4.330"></a><span id="l4.330" class="difflineplus">+          if (richlistbox.tagName == &quot;xul:richlistbox&quot;) {</span>
<a href="#l4.331"></a><span id="l4.331">             richlistbox.focus();</span>
<a href="#l4.332"></a><span id="l4.332">             richlistbox.selectItem(richlistbox.getItemAtIndex(0));</span>
<a href="#l4.333"></a><span id="l4.333">           }</span>
<a href="#l4.334"></a><span id="l4.334">         }</span>
<a href="#l4.335"></a><span id="l4.335">         break;</span>
<a href="#l4.336"></a><span id="l4.336">       case event.DOM_VK_LEFT:</span>
<a href="#l4.337"></a><span id="l4.337" class="difflineminus">-        if (event.target.tagName == 'activity-group') {</span>
<a href="#l4.338"></a><span id="l4.338" class="difflineplus">+        if (event.target.tagName == &quot;activity-group&quot;) {</span>
<a href="#l4.339"></a><span id="l4.339">           var parent = event.target.parentNode;</span>
<a href="#l4.340"></a><span id="l4.340" class="difflineminus">-          if (parent.tagName == 'richlistbox') {</span>
<a href="#l4.341"></a><span id="l4.341" class="difflineplus">+          if (parent.tagName == &quot;richlistbox&quot;) {</span>
<a href="#l4.342"></a><span id="l4.342">             event.target.processes.clearSelection();</span>
<a href="#l4.343"></a><span id="l4.343">             parent.selectItem(event.target);</span>
<a href="#l4.344"></a><span id="l4.344">             parent.focus();</span>
<a href="#l4.345"></a><span id="l4.345">           }</span>
<a href="#l4.346"></a><span id="l4.346">         }</span>
<a href="#l4.347"></a><span id="l4.347">         break;</span>
<a href="#l4.348"></a><span id="l4.348">     }</span>
<a href="#l4.349"></a><span id="l4.349">   },</span>
<a href="#l4.350"></a><span id="l4.350"> };</span>
<a href="#l4.351"></a><span id="l4.351"> </span>
<a href="#l4.352"></a><span id="l4.352"> activityObject.ActivityMgrListener.prototype = {</span>
<a href="#l4.353"></a><span id="l4.353"> </span>
<a href="#l4.354"></a><span id="l4.354" class="difflineminus">-  onAddedActivity: function(aID, aActivity) {</span>
<a href="#l4.355"></a><span id="l4.355" class="difflineminus">-    activityObject._activityLogger.info(&quot;added activity: &quot; + aID + &quot; &quot; +</span>
<a href="#l4.356"></a><span id="l4.356" class="difflineminus">-                                        aActivity)</span>
<a href="#l4.357"></a><span id="l4.357" class="difflineplus">+  onAddedActivity(aID, aActivity) {</span>
<a href="#l4.358"></a><span id="l4.358" class="difflineplus">+    activityObject._activityLogger.info(`added activity: ${aID} ${aActivity}`);</span>
<a href="#l4.359"></a><span id="l4.359">     if (!activityObject._ignoreNotifications)</span>
<a href="#l4.360"></a><span id="l4.360">       activityObject.addActivityBinding(aID, aActivity);</span>
<a href="#l4.361"></a><span id="l4.361">   },</span>
<a href="#l4.362"></a><span id="l4.362"> </span>
<a href="#l4.363"></a><span id="l4.363" class="difflineminus">-  onRemovedActivity: function(aID) {</span>
<a href="#l4.364"></a><span id="l4.364" class="difflineplus">+  onRemovedActivity(aID) {</span>
<a href="#l4.365"></a><span id="l4.365">     if (!activityObject._ignoreNotifications)</span>
<a href="#l4.366"></a><span id="l4.366">       activityObject.removeActivityBinding(aID);</span>
<a href="#l4.367"></a><span id="l4.367" class="difflineminus">-  }</span>
<a href="#l4.368"></a><span id="l4.368" class="difflineplus">+  },</span>
<a href="#l4.369"></a><span id="l4.369"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/components/activity/content/activity.xml</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/components/activity/content/activity.xml</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -17,17 +17,17 @@</span>
<a href="#l5.4"></a><span id="l5.4">           xmlns:xul=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;</span>
<a href="#l5.5"></a><span id="l5.5">           xmlns:xbl=&quot;http://www.mozilla.org/xbl&quot;&gt;</span>
<a href="#l5.6"></a><span id="l5.6"> </span>
<a href="#l5.7"></a><span id="l5.7">   &lt;binding id=&quot;activity-group&quot;</span>
<a href="#l5.8"></a><span id="l5.8">            extends=&quot;chrome://global/content/bindings/richlistbox.xml#richlistitem&quot;&gt;</span>
<a href="#l5.9"></a><span id="l5.9">     &lt;implementation&gt;</span>
<a href="#l5.10"></a><span id="l5.10">       &lt;constructor&gt;</span>
<a href="#l5.11"></a><span id="l5.11">        &lt;![CDATA[</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-          this.setAttribute('contextDisplayText', this.contextDisplayText);</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+          this.setAttribute(&quot;contextDisplayText&quot;, this.contextDisplayText);</span>
<a href="#l5.14"></a><span id="l5.14">         ]]&gt;</span>
<a href="#l5.15"></a><span id="l5.15">       &lt;/constructor&gt;</span>
<a href="#l5.16"></a><span id="l5.16">       &lt;field name=&quot;contextType&quot;&gt;</span>
<a href="#l5.17"></a><span id="l5.17">        &quot;&quot;</span>
<a href="#l5.18"></a><span id="l5.18">       &lt;/field&gt;</span>
<a href="#l5.19"></a><span id="l5.19">       &lt;field name=&quot;contextObj&quot;&gt;</span>
<a href="#l5.20"></a><span id="l5.20">        null</span>
<a href="#l5.21"></a><span id="l5.21">       &lt;/field&gt;</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineat">@@ -38,17 +38,17 @@</span>
<a href="#l5.23"></a><span id="l5.23">         &lt;getter&gt;</span>
<a href="#l5.24"></a><span id="l5.24">           &lt;![CDATA[</span>
<a href="#l5.25"></a><span id="l5.25">             return this._contextDisplayText;</span>
<a href="#l5.26"></a><span id="l5.26">           ]]&gt;</span>
<a href="#l5.27"></a><span id="l5.27">         &lt;/getter&gt;</span>
<a href="#l5.28"></a><span id="l5.28">         &lt;setter&gt;</span>
<a href="#l5.29"></a><span id="l5.29">           &lt;![CDATA[</span>
<a href="#l5.30"></a><span id="l5.30">             this._contextDisplayText = val;</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineminus">-            document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;contextlbl&quot;).setAttribute(&quot;value&quot;, val)</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+            document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;contextlbl&quot;).setAttribute(&quot;value&quot;, val);</span>
<a href="#l5.33"></a><span id="l5.33">           ]]&gt;</span>
<a href="#l5.34"></a><span id="l5.34">         &lt;/setter&gt;</span>
<a href="#l5.35"></a><span id="l5.35">       &lt;/property&gt;</span>
<a href="#l5.36"></a><span id="l5.36">       &lt;property name=&quot;isGroup&quot;&gt;</span>
<a href="#l5.37"></a><span id="l5.37">         &lt;getter&gt;</span>
<a href="#l5.38"></a><span id="l5.38">         &lt;![CDATA[</span>
<a href="#l5.39"></a><span id="l5.39">           return true;</span>
<a href="#l5.40"></a><span id="l5.40">         ]]&gt;</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineat">@@ -60,22 +60,19 @@</span>
<a href="#l5.42"></a><span id="l5.42">           return document.getAnonymousElementByAttribute(this, &quot;anonid&quot;,</span>
<a href="#l5.43"></a><span id="l5.43">                                                          &quot;activityGroupView&quot;);</span>
<a href="#l5.44"></a><span id="l5.44">         ]]&gt;</span>
<a href="#l5.45"></a><span id="l5.45">         &lt;/getter&gt;</span>
<a href="#l5.46"></a><span id="l5.46">       &lt;/property&gt;</span>
<a href="#l5.47"></a><span id="l5.47">       &lt;method name=&quot;retry&quot;&gt;</span>
<a href="#l5.48"></a><span id="l5.48">         &lt;body&gt;</span>
<a href="#l5.49"></a><span id="l5.49">           &lt;![CDATA[</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineminus">-            let activityManager = Cc[&quot;@mozilla.org/activity-manager;1&quot;]</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineminus">-                                    .getService(Ci.nsIActivityManager);</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineminus">-</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineminus">-            let processes = activityManager</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineminus">-                                  .getProcessesByContext(this.contextType,</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineminus">-                                                         this.contextObj, {});</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineplus">+            /* globals activityManager */</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineplus">+            let processes = activityManager.getProcessesByContext(this.contextType,</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineplus">+                                                                  this.contextObj, {});</span>
<a href="#l5.59"></a><span id="l5.59">             for (let process of processes) {</span>
<a href="#l5.60"></a><span id="l5.60">               if (process.retryHandler)</span>
<a href="#l5.61"></a><span id="l5.61">                 process.retryHandler.retry(process);</span>
<a href="#l5.62"></a><span id="l5.62">             }</span>
<a href="#l5.63"></a><span id="l5.63">           ]]&gt;</span>
<a href="#l5.64"></a><span id="l5.64">         &lt;/body&gt;</span>
<a href="#l5.65"></a><span id="l5.65">       &lt;/method&gt;</span>
<a href="#l5.66"></a><span id="l5.66">     &lt;/implementation&gt;</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineat">@@ -101,27 +98,26 @@</span>
<a href="#l5.68"></a><span id="l5.68">       &lt;/xul:vbox&gt;</span>
<a href="#l5.69"></a><span id="l5.69">     &lt;/content&gt;</span>
<a href="#l5.70"></a><span id="l5.70">   &lt;/binding&gt;</span>
<a href="#l5.71"></a><span id="l5.71"> </span>
<a href="#l5.72"></a><span id="l5.72">   &lt;binding id=&quot;activity-base&quot; extends=&quot;chrome://global/content/bindings/richlistbox.xml#richlistitem&quot;&gt;</span>
<a href="#l5.73"></a><span id="l5.73">     &lt;implementation implements=&quot;nsIActivityListener&quot;&gt;</span>
<a href="#l5.74"></a><span id="l5.74">       &lt;constructor&gt;</span>
<a href="#l5.75"></a><span id="l5.75">        &lt;![CDATA[</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineplus">+        /* globals activityManager */</span>
<a href="#l5.77"></a><span id="l5.77">         ChromeUtils.import(&quot;resource:///modules/templateUtils.js&quot;, this);</span>
<a href="#l5.78"></a><span id="l5.78">         try {</span>
<a href="#l5.79"></a><span id="l5.79" class="difflineminus">-          ChromeUtils.import(&quot;resource:///modules/gloda/log4moz.js&quot;);</span>
<a href="#l5.80"></a><span id="l5.80" class="difflineminus">-          let activityManager = Cc[&quot;@mozilla.org/activity-manager;1&quot;]</span>
<a href="#l5.81"></a><span id="l5.81" class="difflineminus">-                                  .getService(Ci.nsIActivityManager);</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineplus">+          const { Log4Moz } = ChromeUtils.import(&quot;resource:///modules/gloda/log4moz.js&quot;, null);</span>
<a href="#l5.83"></a><span id="l5.83"> </span>
<a href="#l5.84"></a><span id="l5.84">           // fetch the activity and set the base attributes</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineminus">-          let actID = this.getAttribute('actID');</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineplus">+          let actID = this.getAttribute(&quot;actID&quot;);</span>
<a href="#l5.87"></a><span id="l5.87">           this._activity = activityManager.getActivity(actID);</span>
<a href="#l5.88"></a><span id="l5.88">           this._activity.addListener(this);</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineminus">-          this.setAttribute('iconclass', this._activity.iconClass);</span>
<a href="#l5.90"></a><span id="l5.90" class="difflineplus">+          this.setAttribute(&quot;iconclass&quot;, this._activity.iconClass);</span>
<a href="#l5.91"></a><span id="l5.91">           this.log = Log4Moz.getConfiguredLogger(&quot;activity-base&quot;);</span>
<a href="#l5.92"></a><span id="l5.92"> </span>
<a href="#l5.93"></a><span id="l5.93">           this.text = {</span>
<a href="#l5.94"></a><span id="l5.94">             paused: &quot;paused2&quot;,</span>
<a href="#l5.95"></a><span id="l5.95">             canceled: &quot;canceled&quot;,</span>
<a href="#l5.96"></a><span id="l5.96">             failed: &quot;failed&quot;,</span>
<a href="#l5.97"></a><span id="l5.97">             waitingforinput: &quot;waitingForInput&quot;,</span>
<a href="#l5.98"></a><span id="l5.98">             waitingforretry: &quot;waitingForRetry&quot;,</span>
<a href="#l5.99"></a><span id="l5.99" class="difflineat">@@ -173,21 +169,21 @@</span>
<a href="#l5.100"></a><span id="l5.100">           return this._activity &amp;&amp; (this._activity instanceof</span>
<a href="#l5.101"></a><span id="l5.101">                                     Ci.nsIActivityWarning);</span>
<a href="#l5.102"></a><span id="l5.102">         ]]&gt;</span>
<a href="#l5.103"></a><span id="l5.103">         &lt;/getter&gt;</span>
<a href="#l5.104"></a><span id="l5.104">       &lt;/property&gt;</span>
<a href="#l5.105"></a><span id="l5.105">       &lt;property name=&quot;isOrphan&quot;&gt;</span>
<a href="#l5.106"></a><span id="l5.106">         &lt;getter&gt;</span>
<a href="#l5.107"></a><span id="l5.107">         &lt;![CDATA[</span>
<a href="#l5.108"></a><span id="l5.108" class="difflineplus">+          /* globals activityManager */</span>
<a href="#l5.109"></a><span id="l5.109">           try {</span>
<a href="#l5.110"></a><span id="l5.110" class="difflineminus">-           let activity = activityManager.getActivity(this._activity.id);</span>
<a href="#l5.111"></a><span id="l5.111" class="difflineminus">-           return false;</span>
<a href="#l5.112"></a><span id="l5.112" class="difflineminus">-          }</span>
<a href="#l5.113"></a><span id="l5.113" class="difflineminus">-          catch(e) {</span>
<a href="#l5.114"></a><span id="l5.114" class="difflineplus">+            activityManager.getActivity(this._activity.id);</span>
<a href="#l5.115"></a><span id="l5.115" class="difflineplus">+            return false;</span>
<a href="#l5.116"></a><span id="l5.116" class="difflineplus">+          } catch (e) {</span>
<a href="#l5.117"></a><span id="l5.117">             // happens when the given activity is already removed form</span>
<a href="#l5.118"></a><span id="l5.118">             //   the activity manager. Returning true indicates that the</span>
<a href="#l5.119"></a><span id="l5.119">             //   XBL doesn't have any associated activity - orphan.</span>
<a href="#l5.120"></a><span id="l5.120">           }</span>
<a href="#l5.121"></a><span id="l5.121">           return true;</span>
<a href="#l5.122"></a><span id="l5.122">         ]]&gt;</span>
<a href="#l5.123"></a><span id="l5.123">         &lt;/getter&gt;</span>
<a href="#l5.124"></a><span id="l5.124">       &lt;/property&gt;</span>
<a href="#l5.125"></a><span id="l5.125" class="difflineat">@@ -217,27 +213,28 @@</span>
<a href="#l5.126"></a><span id="l5.126">         ]]&gt;</span>
<a href="#l5.127"></a><span id="l5.127">         &lt;/getter&gt;</span>
<a href="#l5.128"></a><span id="l5.128">       &lt;/property&gt;</span>
<a href="#l5.129"></a><span id="l5.129">       &lt;method name=&quot;setVisibility&quot;&gt;</span>
<a href="#l5.130"></a><span id="l5.130">         &lt;parameter name=&quot;anonid&quot;/&gt;</span>
<a href="#l5.131"></a><span id="l5.131">         &lt;parameter name=&quot;visible&quot;/&gt;</span>
<a href="#l5.132"></a><span id="l5.132">         &lt;body&gt;</span>
<a href="#l5.133"></a><span id="l5.133">           &lt;![CDATA[</span>
<a href="#l5.134"></a><span id="l5.134" class="difflineminus">-            document.getAnonymousElementByAttribute(this, &quot;anonid&quot;,</span>
<a href="#l5.135"></a><span id="l5.135" class="difflineminus">-             anonid).setAttribute('hidden', !visible);</span>
<a href="#l5.136"></a><span id="l5.136" class="difflineplus">+            document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, anonid)</span>
<a href="#l5.137"></a><span id="l5.137" class="difflineplus">+                    .setAttribute(&quot;hidden&quot;, !visible);</span>
<a href="#l5.138"></a><span id="l5.138">           ]]&gt;</span>
<a href="#l5.139"></a><span id="l5.139">         &lt;/body&gt;</span>
<a href="#l5.140"></a><span id="l5.140">       &lt;/method&gt;</span>
<a href="#l5.141"></a><span id="l5.141">       &lt;method name=&quot;formatTimeTip&quot;&gt;</span>
<a href="#l5.142"></a><span id="l5.142">         &lt;parameter name=&quot;time&quot;/&gt;</span>
<a href="#l5.143"></a><span id="l5.143">         &lt;body&gt;</span>
<a href="#l5.144"></a><span id="l5.144">           &lt;![CDATA[</span>
<a href="#l5.145"></a><span id="l5.145" class="difflineplus">+            ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l5.146"></a><span id="l5.146">             const dateTimeFormatter = new Services.intl.DateTimeFormat(undefined, {</span>
<a href="#l5.147"></a><span id="l5.147" class="difflineminus">-              dateStyle: &quot;long&quot;, timeStyle: &quot;short&quot;</span>
<a href="#l5.148"></a><span id="l5.148" class="difflineplus">+              dateStyle: &quot;long&quot;, timeStyle: &quot;short&quot;,</span>
<a href="#l5.149"></a><span id="l5.149">             });</span>
<a href="#l5.150"></a><span id="l5.150"> </span>
<a href="#l5.151"></a><span id="l5.151">             // Get the end time to display</span>
<a href="#l5.152"></a><span id="l5.152">             let end = new Date(parseInt(time));</span>
<a href="#l5.153"></a><span id="l5.153"> </span>
<a href="#l5.154"></a><span id="l5.154">             // Set the tooltip to be the full date and time</span>
<a href="#l5.155"></a><span id="l5.155">             return dateTimeFormatter.format(end);</span>
<a href="#l5.156"></a><span id="l5.156">           ]]&gt;</span>
<a href="#l5.157"></a><span id="l5.157" class="difflineat">@@ -260,100 +257,96 @@</span>
<a href="#l5.158"></a><span id="l5.158">           this.displayText = this._activity.displayText;</span>
<a href="#l5.159"></a><span id="l5.159">           // make sure that binding reflects the latest state of the process</span>
<a href="#l5.160"></a><span id="l5.160">           this.onStateChanged(this._activity.state,</span>
<a href="#l5.161"></a><span id="l5.161">                               Ci.nsIActivityProcess.STATE_NOTSTARTED);</span>
<a href="#l5.162"></a><span id="l5.162">           this.onProgressChanged(this._activity,</span>
<a href="#l5.163"></a><span id="l5.163">                                  this._activity.lastStatusText,</span>
<a href="#l5.164"></a><span id="l5.164">                                  this._activity.workUnitComplete,</span>
<a href="#l5.165"></a><span id="l5.165">                                  this._activity.totalWorkUnits);</span>
<a href="#l5.166"></a><span id="l5.166" class="difflineminus">-         }</span>
<a href="#l5.167"></a><span id="l5.167" class="difflineminus">-         catch(e) {</span>
<a href="#l5.168"></a><span id="l5.168" class="difflineplus">+         } catch (e) {</span>
<a href="#l5.169"></a><span id="l5.169">             this.log.error(&quot;Exception constructing activity-process: &quot; + e);</span>
<a href="#l5.170"></a><span id="l5.170" class="difflineminus">-            throw(e)</span>
<a href="#l5.171"></a><span id="l5.171" class="difflineplus">+            throw e;</span>
<a href="#l5.172"></a><span id="l5.172">          }</span>
<a href="#l5.173"></a><span id="l5.173">         ]]&gt;</span>
<a href="#l5.174"></a><span id="l5.174">       &lt;/constructor&gt;</span>
<a href="#l5.175"></a><span id="l5.175">       &lt;property name=&quot;displayText&quot;&gt;</span>
<a href="#l5.176"></a><span id="l5.176">         &lt;getter&gt;</span>
<a href="#l5.177"></a><span id="l5.177">           &lt;![CDATA[</span>
<a href="#l5.178"></a><span id="l5.178" class="difflineminus">-            return this.getAttribute('displayText');</span>
<a href="#l5.179"></a><span id="l5.179" class="difflineplus">+            return this.getAttribute(&quot;displayText&quot;);</span>
<a href="#l5.180"></a><span id="l5.180">           ]]&gt;</span>
<a href="#l5.181"></a><span id="l5.181">         &lt;/getter&gt;</span>
<a href="#l5.182"></a><span id="l5.182">         &lt;setter&gt;</span>
<a href="#l5.183"></a><span id="l5.183">           &lt;![CDATA[</span>
<a href="#l5.184"></a><span id="l5.184" class="difflineminus">-            this.setAttribute('displayText', val);</span>
<a href="#l5.185"></a><span id="l5.185" class="difflineplus">+            this.setAttribute(&quot;displayText&quot;, val);</span>
<a href="#l5.186"></a><span id="l5.186">           ]]&gt;</span>
<a href="#l5.187"></a><span id="l5.187">         &lt;/setter&gt;</span>
<a href="#l5.188"></a><span id="l5.188">       &lt;/property&gt;</span>
<a href="#l5.189"></a><span id="l5.189">       &lt;property name=&quot;statusText&quot;&gt;</span>
<a href="#l5.190"></a><span id="l5.190">         &lt;getter&gt;</span>
<a href="#l5.191"></a><span id="l5.191">           &lt;![CDATA[</span>
<a href="#l5.192"></a><span id="l5.192" class="difflineminus">-            return this.getAttribute('statusText');</span>
<a href="#l5.193"></a><span id="l5.193" class="difflineplus">+            return this.getAttribute(&quot;statusText&quot;);</span>
<a href="#l5.194"></a><span id="l5.194">           ]]&gt;</span>
<a href="#l5.195"></a><span id="l5.195">         &lt;/getter&gt;</span>
<a href="#l5.196"></a><span id="l5.196">         &lt;setter&gt;</span>
<a href="#l5.197"></a><span id="l5.197">           &lt;![CDATA[</span>
<a href="#l5.198"></a><span id="l5.198" class="difflineminus">-            this.setAttribute('statusText', val);</span>
<a href="#l5.199"></a><span id="l5.199" class="difflineplus">+            this.setAttribute(&quot;statusText&quot;, val);</span>
<a href="#l5.200"></a><span id="l5.200">           ]]&gt;</span>
<a href="#l5.201"></a><span id="l5.201">         &lt;/setter&gt;</span>
<a href="#l5.202"></a><span id="l5.202">       &lt;/property&gt;</span>
<a href="#l5.203"></a><span id="l5.203">       &lt;property name=&quot;inProgress&quot;&gt;</span>
<a href="#l5.204"></a><span id="l5.204">         &lt;getter&gt;</span>
<a href="#l5.205"></a><span id="l5.205">           &lt;![CDATA[</span>
<a href="#l5.206"></a><span id="l5.206">            return (this._activity.state ==</span>
<a href="#l5.207"></a><span id="l5.207">                    Ci.nsIActivityProcess.STATE_INPROGRESS);</span>
<a href="#l5.208"></a><span id="l5.208">           ]]&gt;</span>
<a href="#l5.209"></a><span id="l5.209">         &lt;/getter&gt;</span>
<a href="#l5.210"></a><span id="l5.210">       &lt;/property&gt;</span>
<a href="#l5.211"></a><span id="l5.211">       &lt;property name=&quot;isRemovable&quot;&gt;</span>
<a href="#l5.212"></a><span id="l5.212">         &lt;getter&gt;</span>
<a href="#l5.213"></a><span id="l5.213">           &lt;![CDATA[</span>
<a href="#l5.214"></a><span id="l5.214">             return this._activity.state == Ci.nsIActivityProcess.STATE_COMPLETED ||</span>
<a href="#l5.215"></a><span id="l5.215" class="difflineminus">-                   this._activity.state == Ci.nsIActivityProcess.STATE_CANCELED</span>
<a href="#l5.216"></a><span id="l5.216" class="difflineplus">+                   this._activity.state == Ci.nsIActivityProcess.STATE_CANCELED;</span>
<a href="#l5.217"></a><span id="l5.217">           ]]&gt;</span>
<a href="#l5.218"></a><span id="l5.218">         &lt;/getter&gt;</span>
<a href="#l5.219"></a><span id="l5.219">       &lt;/property&gt;</span>
<a href="#l5.220"></a><span id="l5.220">       &lt;property name=&quot;canCancel&quot;&gt;</span>
<a href="#l5.221"></a><span id="l5.221">         &lt;getter&gt;</span>
<a href="#l5.222"></a><span id="l5.222">         &lt;![CDATA[</span>
<a href="#l5.223"></a><span id="l5.223">           try {</span>
<a href="#l5.224"></a><span id="l5.224">            return (this._activity.cancelHandler != null);</span>
<a href="#l5.225"></a><span id="l5.225" class="difflineminus">-          }</span>
<a href="#l5.226"></a><span id="l5.226" class="difflineminus">-          catch(e) {</span>
<a href="#l5.227"></a><span id="l5.227" class="difflineplus">+          } catch (e) {</span>
<a href="#l5.228"></a><span id="l5.228">             // In normal conditions, we shouldn't endup here. This can only</span>
<a href="#l5.229"></a><span id="l5.229">             // happen if the XBL is orphan - associated activity has been</span>
<a href="#l5.230"></a><span id="l5.230">             // deleted but XBL stays alive.</span>
<a href="#l5.231"></a><span id="l5.231">           }</span>
<a href="#l5.232"></a><span id="l5.232">           return false;</span>
<a href="#l5.233"></a><span id="l5.233">         ]]&gt;</span>
<a href="#l5.234"></a><span id="l5.234">         &lt;/getter&gt;</span>
<a href="#l5.235"></a><span id="l5.235">       &lt;/property&gt;</span>
<a href="#l5.236"></a><span id="l5.236">       &lt;property name=&quot;canPause&quot;&gt;</span>
<a href="#l5.237"></a><span id="l5.237">         &lt;getter&gt;</span>
<a href="#l5.238"></a><span id="l5.238">         &lt;![CDATA[</span>
<a href="#l5.239"></a><span id="l5.239">           try {</span>
<a href="#l5.240"></a><span id="l5.240">            return (this._activity.pauseHandler != null);</span>
<a href="#l5.241"></a><span id="l5.241" class="difflineminus">-          }</span>
<a href="#l5.242"></a><span id="l5.242" class="difflineminus">-          catch(e) {</span>
<a href="#l5.243"></a><span id="l5.243" class="difflineplus">+          } catch (e) {</span>
<a href="#l5.244"></a><span id="l5.244">             // In normal conditions, we shouldn't endup here. This can only</span>
<a href="#l5.245"></a><span id="l5.245">             // happen if the XBL is orphan - associated activity has been</span>
<a href="#l5.246"></a><span id="l5.246">             // deleted but XBL stays alive.</span>
<a href="#l5.247"></a><span id="l5.247">           }</span>
<a href="#l5.248"></a><span id="l5.248">           return false;</span>
<a href="#l5.249"></a><span id="l5.249">         ]]&gt;</span>
<a href="#l5.250"></a><span id="l5.250">         &lt;/getter&gt;</span>
<a href="#l5.251"></a><span id="l5.251">       &lt;/property&gt;</span>
<a href="#l5.252"></a><span id="l5.252">       &lt;property name=&quot;canRetry&quot;&gt;</span>
<a href="#l5.253"></a><span id="l5.253">         &lt;getter&gt;</span>
<a href="#l5.254"></a><span id="l5.254">         &lt;![CDATA[</span>
<a href="#l5.255"></a><span id="l5.255">           try {</span>
<a href="#l5.256"></a><span id="l5.256">            return (this._activity.retryHandler != null);</span>
<a href="#l5.257"></a><span id="l5.257" class="difflineminus">-          }</span>
<a href="#l5.258"></a><span id="l5.258" class="difflineminus">-          catch(e) {</span>
<a href="#l5.259"></a><span id="l5.259" class="difflineplus">+          } catch (e) {</span>
<a href="#l5.260"></a><span id="l5.260">             // In normal conditions, we shouldn't endup here. This can only</span>
<a href="#l5.261"></a><span id="l5.261">             // happen if the XBL is orphan - associated activity has been</span>
<a href="#l5.262"></a><span id="l5.262">             // deleted but XBL stays alive.</span>
<a href="#l5.263"></a><span id="l5.263">           }</span>
<a href="#l5.264"></a><span id="l5.264">           return false;</span>
<a href="#l5.265"></a><span id="l5.265">         ]]&gt;</span>
<a href="#l5.266"></a><span id="l5.266">         &lt;/getter&gt;</span>
<a href="#l5.267"></a><span id="l5.267">       &lt;/property&gt;</span>
<a href="#l5.268"></a><span id="l5.268" class="difflineat">@@ -368,17 +361,17 @@</span>
<a href="#l5.269"></a><span id="l5.269">           let hideCancelBut = true;</span>
<a href="#l5.270"></a><span id="l5.270">           let hideRetryBut = true;</span>
<a href="#l5.271"></a><span id="l5.271">           let hidePauseBut = true;</span>
<a href="#l5.272"></a><span id="l5.272">           let hideResumeBut = true;</span>
<a href="#l5.273"></a><span id="l5.273">           let hideProgressMeter = false;</span>
<a href="#l5.274"></a><span id="l5.274">           let displayText = this.displayText;</span>
<a href="#l5.275"></a><span id="l5.275">           let statusText = this.statusText;</span>
<a href="#l5.276"></a><span id="l5.276"> </span>
<a href="#l5.277"></a><span id="l5.277" class="difflineminus">-          switch(this._activity.state) {</span>
<a href="#l5.278"></a><span id="l5.278" class="difflineplus">+          switch (this._activity.state) {</span>
<a href="#l5.279"></a><span id="l5.279">             case Ci.nsIActivityProcess.STATE_INPROGRESS:</span>
<a href="#l5.280"></a><span id="l5.280">               hideCancelBut = !this.canCancel;</span>
<a href="#l5.281"></a><span id="l5.281">               hidePauseBut = !this.canPause;</span>
<a href="#l5.282"></a><span id="l5.282">                // status text is empty</span>
<a href="#l5.283"></a><span id="l5.283">                statusText = &quot;&quot;;</span>
<a href="#l5.284"></a><span id="l5.284">               break;</span>
<a href="#l5.285"></a><span id="l5.285">             case Ci.nsIActivityProcess.STATE_COMPLETED:</span>
<a href="#l5.286"></a><span id="l5.286">               // all buttons and progress meter are hidden</span>
<a href="#l5.287"></a><span id="l5.287" class="difflineat">@@ -440,22 +433,21 @@</span>
<a href="#l5.288"></a><span id="l5.288">         &lt;body&gt;</span>
<a href="#l5.289"></a><span id="l5.289">           &lt;![CDATA[</span>
<a href="#l5.290"></a><span id="l5.290">             let element =</span>
<a href="#l5.291"></a><span id="l5.291">               document.getAnonymousElementByAttribute(this, &quot;anonid&quot;,</span>
<a href="#l5.292"></a><span id="l5.292">                                                       &quot;progressmeter&quot;);</span>
<a href="#l5.293"></a><span id="l5.293">             if (aTotalWorkUnits == 0) {</span>
<a href="#l5.294"></a><span id="l5.294">               element.setAttribute(&quot;mode&quot;, &quot;undetermined&quot;);</span>
<a href="#l5.295"></a><span id="l5.295">               element.setAttribute(&quot;value&quot;, 0);</span>
<a href="#l5.296"></a><span id="l5.296" class="difflineminus">-            }</span>
<a href="#l5.297"></a><span id="l5.297" class="difflineminus">-            else {</span>
<a href="#l5.298"></a><span id="l5.298" class="difflineplus">+            } else {</span>
<a href="#l5.299"></a><span id="l5.299">               let _percentComplete = 100.0 * aWorkUnitsComplete /</span>
<a href="#l5.300"></a><span id="l5.300">                                      aTotalWorkUnits;</span>
<a href="#l5.301"></a><span id="l5.301">               element.setAttribute(&quot;mode&quot;, &quot;determined&quot;);</span>
<a href="#l5.302"></a><span id="l5.302" class="difflineminus">-              element.setAttribute('value', _percentComplete);</span>
<a href="#l5.303"></a><span id="l5.303" class="difflineplus">+              element.setAttribute(&quot;value&quot;, _percentComplete);</span>
<a href="#l5.304"></a><span id="l5.304">             }</span>
<a href="#l5.305"></a><span id="l5.305">             this.statusText = aStatusText;</span>
<a href="#l5.306"></a><span id="l5.306">           ]]&gt;</span>
<a href="#l5.307"></a><span id="l5.307">         &lt;/body&gt;</span>
<a href="#l5.308"></a><span id="l5.308">       &lt;/method&gt;</span>
<a href="#l5.309"></a><span id="l5.309">       &lt;method name=&quot;onHandlerChanged&quot;&gt;</span>
<a href="#l5.310"></a><span id="l5.310">         &lt;parameter name=&quot;aActivity&quot;/&gt;</span>
<a href="#l5.311"></a><span id="l5.311">         &lt;body&gt;</span>
<a href="#l5.312"></a><span id="l5.312" class="difflineat">@@ -467,18 +459,17 @@</span>
<a href="#l5.313"></a><span id="l5.313">             let hideResumeBut = !this.canPause ||</span>
<a href="#l5.314"></a><span id="l5.314">                 this._activity.state == Ci.nsIActivityProcess.STATE_PAUSED;</span>
<a href="#l5.315"></a><span id="l5.315"> </span>
<a href="#l5.316"></a><span id="l5.316">             this.setVisibility(&quot;button_cancel&quot;, !hideCancelBut);</span>
<a href="#l5.317"></a><span id="l5.317">             this.setVisibility(&quot;button_retry&quot;, !hideRetryBut);</span>
<a href="#l5.318"></a><span id="l5.318">             if (hidePauseBut) {</span>
<a href="#l5.319"></a><span id="l5.319">               this.setVisibility(&quot;button_pause&quot;, !hidePauseBut);</span>
<a href="#l5.320"></a><span id="l5.320">               this.setVisibility(&quot;button_resume&quot;, !hideResumeBut);</span>
<a href="#l5.321"></a><span id="l5.321" class="difflineminus">-            }</span>
<a href="#l5.322"></a><span id="l5.322" class="difflineminus">-            else {</span>
<a href="#l5.323"></a><span id="l5.323" class="difflineplus">+            } else {</span>
<a href="#l5.324"></a><span id="l5.324">               this.setVisibility(&quot;button_pause&quot;, this.paused);</span>
<a href="#l5.325"></a><span id="l5.325">               this.setVisibility(&quot;button_resume&quot;, !this.paused);</span>
<a href="#l5.326"></a><span id="l5.326">             }</span>
<a href="#l5.327"></a><span id="l5.327">           ]]&gt;</span>
<a href="#l5.328"></a><span id="l5.328">         &lt;/body&gt;</span>
<a href="#l5.329"></a><span id="l5.329">       &lt;/method&gt;</span>
<a href="#l5.330"></a><span id="l5.330">       &lt;property name=&quot;paused&quot;&gt;</span>
<a href="#l5.331"></a><span id="l5.331">         &lt;getter&gt;</span>
<a href="#l5.332"></a><span id="l5.332" class="difflineat">@@ -558,68 +549,66 @@</span>
<a href="#l5.333"></a><span id="l5.333">         // We deliberately propagate the exceptions to the caller.</span>
<a href="#l5.334"></a><span id="l5.334">         this._activity.QueryInterface(Ci.nsIActivityEvent);</span>
<a href="#l5.335"></a><span id="l5.335"> </span>
<a href="#l5.336"></a><span id="l5.336">         try {</span>
<a href="#l5.337"></a><span id="l5.337">           this.displayText = this._activity.displayText;</span>
<a href="#l5.338"></a><span id="l5.338">           this.statusText =  this._activity.statusText;</span>
<a href="#l5.339"></a><span id="l5.339">           this.completionTime = this._activity.completionTime;</span>
<a href="#l5.340"></a><span id="l5.340">           this.setVisibility(&quot;button_undo&quot;, this._activity.undoHandler);</span>
<a href="#l5.341"></a><span id="l5.341" class="difflineminus">-        }</span>
<a href="#l5.342"></a><span id="l5.342" class="difflineminus">-        catch(e) {</span>
<a href="#l5.343"></a><span id="l5.343" class="difflineplus">+        } catch (e) {</span>
<a href="#l5.344"></a><span id="l5.344">           this.log.error(&quot;Exception constructing activity-event: &quot; + e);</span>
<a href="#l5.345"></a><span id="l5.345" class="difflineminus">-          throw(e)</span>
<a href="#l5.346"></a><span id="l5.346" class="difflineplus">+          throw e;</span>
<a href="#l5.347"></a><span id="l5.347">         }</span>
<a href="#l5.348"></a><span id="l5.348">         ]]&gt;</span>
<a href="#l5.349"></a><span id="l5.349">       &lt;/constructor&gt;</span>
<a href="#l5.350"></a><span id="l5.350">        &lt;property name=&quot;displayText&quot;&gt;</span>
<a href="#l5.351"></a><span id="l5.351">         &lt;getter&gt;</span>
<a href="#l5.352"></a><span id="l5.352">           &lt;![CDATA[</span>
<a href="#l5.353"></a><span id="l5.353" class="difflineminus">-            return this.getAttribute('displayText');</span>
<a href="#l5.354"></a><span id="l5.354" class="difflineplus">+            return this.getAttribute(&quot;displayText&quot;);</span>
<a href="#l5.355"></a><span id="l5.355">           ]]&gt;</span>
<a href="#l5.356"></a><span id="l5.356">         &lt;/getter&gt;</span>
<a href="#l5.357"></a><span id="l5.357">         &lt;setter&gt;</span>
<a href="#l5.358"></a><span id="l5.358">           &lt;![CDATA[</span>
<a href="#l5.359"></a><span id="l5.359" class="difflineminus">-            this.setAttribute('displayText', val);</span>
<a href="#l5.360"></a><span id="l5.360" class="difflineplus">+            this.setAttribute(&quot;displayText&quot;, val);</span>
<a href="#l5.361"></a><span id="l5.361">           ]]&gt;</span>
<a href="#l5.362"></a><span id="l5.362">         &lt;/setter&gt;</span>
<a href="#l5.363"></a><span id="l5.363">       &lt;/property&gt;</span>
<a href="#l5.364"></a><span id="l5.364">       &lt;property name=&quot;statusText&quot;&gt;</span>
<a href="#l5.365"></a><span id="l5.365">         &lt;getter&gt;</span>
<a href="#l5.366"></a><span id="l5.366">           &lt;![CDATA[</span>
<a href="#l5.367"></a><span id="l5.367" class="difflineminus">-            return this.getAttribute('statusText');</span>
<a href="#l5.368"></a><span id="l5.368" class="difflineplus">+            return this.getAttribute(&quot;statusText&quot;);</span>
<a href="#l5.369"></a><span id="l5.369">           ]]&gt;</span>
<a href="#l5.370"></a><span id="l5.370">         &lt;/getter&gt;</span>
<a href="#l5.371"></a><span id="l5.371">         &lt;setter&gt;</span>
<a href="#l5.372"></a><span id="l5.372">           &lt;![CDATA[</span>
<a href="#l5.373"></a><span id="l5.373" class="difflineminus">-            this.setAttribute('statusText', val);</span>
<a href="#l5.374"></a><span id="l5.374" class="difflineplus">+            this.setAttribute(&quot;statusText&quot;, val);</span>
<a href="#l5.375"></a><span id="l5.375">           ]]&gt;</span>
<a href="#l5.376"></a><span id="l5.376">         &lt;/setter&gt;</span>
<a href="#l5.377"></a><span id="l5.377">       &lt;/property&gt;</span>
<a href="#l5.378"></a><span id="l5.378">       &lt;property name=&quot;completionTime&quot;&gt;</span>
<a href="#l5.379"></a><span id="l5.379">         &lt;getter&gt;</span>
<a href="#l5.380"></a><span id="l5.380">           &lt;![CDATA[</span>
<a href="#l5.381"></a><span id="l5.381" class="difflineminus">-            return this.getAttribute('completionTime');</span>
<a href="#l5.382"></a><span id="l5.382" class="difflineplus">+            return this.getAttribute(&quot;completionTime&quot;);</span>
<a href="#l5.383"></a><span id="l5.383">           ]]&gt;</span>
<a href="#l5.384"></a><span id="l5.384">         &lt;/getter&gt;</span>
<a href="#l5.385"></a><span id="l5.385">         &lt;setter&gt;</span>
<a href="#l5.386"></a><span id="l5.386">           &lt;![CDATA[</span>
<a href="#l5.387"></a><span id="l5.387">             this.setAttribute(&quot;completionTime&quot;,</span>
<a href="#l5.388"></a><span id="l5.388">                               this.makeFriendlyDateAgo(new Date(parseInt(val))));</span>
<a href="#l5.389"></a><span id="l5.389">             this.setAttribute(&quot;completionTimeTip&quot;, this.formatTimeTip(val));</span>
<a href="#l5.390"></a><span id="l5.390">           ]]&gt;</span>
<a href="#l5.391"></a><span id="l5.391">         &lt;/setter&gt;</span>
<a href="#l5.392"></a><span id="l5.392">       &lt;/property&gt;</span>
<a href="#l5.393"></a><span id="l5.393">       &lt;property name=&quot;canUndo&quot;&gt;</span>
<a href="#l5.394"></a><span id="l5.394">         &lt;getter&gt;</span>
<a href="#l5.395"></a><span id="l5.395">         &lt;![CDATA[</span>
<a href="#l5.396"></a><span id="l5.396">           try {</span>
<a href="#l5.397"></a><span id="l5.397">            return (this._activity.undoHandler != null);</span>
<a href="#l5.398"></a><span id="l5.398" class="difflineminus">-          }</span>
<a href="#l5.399"></a><span id="l5.399" class="difflineminus">-          catch(e) {</span>
<a href="#l5.400"></a><span id="l5.400" class="difflineplus">+          } catch (e) {</span>
<a href="#l5.401"></a><span id="l5.401">             // In normal conditions, we shouldn't endup here. This can only</span>
<a href="#l5.402"></a><span id="l5.402">             // happen if the XBL is orphan - associated activity has been</span>
<a href="#l5.403"></a><span id="l5.403">             // deleted but XBL stays alive.</span>
<a href="#l5.404"></a><span id="l5.404">           }</span>
<a href="#l5.405"></a><span id="l5.405">           return false;</span>
<a href="#l5.406"></a><span id="l5.406">         ]]&gt;</span>
<a href="#l5.407"></a><span id="l5.407">         &lt;/getter&gt;</span>
<a href="#l5.408"></a><span id="l5.408">       &lt;/property&gt;</span>
<a href="#l5.409"></a><span id="l5.409" class="difflineat">@@ -669,67 +658,65 @@</span>
<a href="#l5.410"></a><span id="l5.410">         // We deliberately propagate the exceptions to the caller.</span>
<a href="#l5.411"></a><span id="l5.411">         this._activity.QueryInterface(Ci.nsIActivityWarning);</span>
<a href="#l5.412"></a><span id="l5.412"> </span>
<a href="#l5.413"></a><span id="l5.413">         try {</span>
<a href="#l5.414"></a><span id="l5.414">           this.displayText = this._activity.displayText;</span>
<a href="#l5.415"></a><span id="l5.415">           this.dateTime = this._activity.time;</span>
<a href="#l5.416"></a><span id="l5.416">           this.recoveryTipText =  this._activity.recoveryTipText;</span>
<a href="#l5.417"></a><span id="l5.417">           this.setVisibility(&quot;button_recover&quot;, this._activity.recoveryHandler);</span>
<a href="#l5.418"></a><span id="l5.418" class="difflineminus">-        }</span>
<a href="#l5.419"></a><span id="l5.419" class="difflineminus">-        catch(e) {</span>
<a href="#l5.420"></a><span id="l5.420" class="difflineplus">+        } catch (e) {</span>
<a href="#l5.421"></a><span id="l5.421">           this.log.error(&quot;Exception constructing activity-warning: &quot; + e);</span>
<a href="#l5.422"></a><span id="l5.422" class="difflineminus">-          throw(e)</span>
<a href="#l5.423"></a><span id="l5.423" class="difflineplus">+          throw e;</span>
<a href="#l5.424"></a><span id="l5.424">         }</span>
<a href="#l5.425"></a><span id="l5.425">         ]]&gt;</span>
<a href="#l5.426"></a><span id="l5.426">       &lt;/constructor&gt;</span>
<a href="#l5.427"></a><span id="l5.427">        &lt;property name=&quot;displayText&quot;&gt;</span>
<a href="#l5.428"></a><span id="l5.428">         &lt;getter&gt;</span>
<a href="#l5.429"></a><span id="l5.429">           &lt;![CDATA[</span>
<a href="#l5.430"></a><span id="l5.430" class="difflineminus">-            return this.getAttribute('displayText');</span>
<a href="#l5.431"></a><span id="l5.431" class="difflineplus">+            return this.getAttribute(&quot;displayText&quot;);</span>
<a href="#l5.432"></a><span id="l5.432">           ]]&gt;</span>
<a href="#l5.433"></a><span id="l5.433">         &lt;/getter&gt;</span>
<a href="#l5.434"></a><span id="l5.434">         &lt;setter&gt;</span>
<a href="#l5.435"></a><span id="l5.435">           &lt;![CDATA[</span>
<a href="#l5.436"></a><span id="l5.436" class="difflineminus">-            this.setAttribute('displayText', val);</span>
<a href="#l5.437"></a><span id="l5.437" class="difflineplus">+            this.setAttribute(&quot;displayText&quot;, val);</span>
<a href="#l5.438"></a><span id="l5.438">           ]]&gt;</span>
<a href="#l5.439"></a><span id="l5.439">         &lt;/setter&gt;</span>
<a href="#l5.440"></a><span id="l5.440">       &lt;/property&gt;</span>
<a href="#l5.441"></a><span id="l5.441">       &lt;property name=&quot;recoveryTipText&quot;&gt;</span>
<a href="#l5.442"></a><span id="l5.442">         &lt;getter&gt;</span>
<a href="#l5.443"></a><span id="l5.443">           &lt;![CDATA[</span>
<a href="#l5.444"></a><span id="l5.444" class="difflineminus">-            return this.getAttribute('recoveryTipText');</span>
<a href="#l5.445"></a><span id="l5.445" class="difflineplus">+            return this.getAttribute(&quot;recoveryTipText&quot;);</span>
<a href="#l5.446"></a><span id="l5.446">           ]]&gt;</span>
<a href="#l5.447"></a><span id="l5.447">         &lt;/getter&gt;</span>
<a href="#l5.448"></a><span id="l5.448">         &lt;setter&gt;</span>
<a href="#l5.449"></a><span id="l5.449">           &lt;![CDATA[</span>
<a href="#l5.450"></a><span id="l5.450" class="difflineminus">-            this.setAttribute('recoveryTipText', val);</span>
<a href="#l5.451"></a><span id="l5.451" class="difflineplus">+            this.setAttribute(&quot;recoveryTipText&quot;, val);</span>
<a href="#l5.452"></a><span id="l5.452">           ]]&gt;</span>
<a href="#l5.453"></a><span id="l5.453">         &lt;/setter&gt;</span>
<a href="#l5.454"></a><span id="l5.454">       &lt;/property&gt;</span>
<a href="#l5.455"></a><span id="l5.455">       &lt;property name=&quot;dateTime&quot;&gt;</span>
<a href="#l5.456"></a><span id="l5.456">         &lt;getter&gt;</span>
<a href="#l5.457"></a><span id="l5.457">           &lt;![CDATA[</span>
<a href="#l5.458"></a><span id="l5.458" class="difflineminus">-            return this.getAttribute('dateTime');</span>
<a href="#l5.459"></a><span id="l5.459" class="difflineplus">+            return this.getAttribute(&quot;dateTime&quot;);</span>
<a href="#l5.460"></a><span id="l5.460">           ]]&gt;</span>
<a href="#l5.461"></a><span id="l5.461">         &lt;/getter&gt;</span>
<a href="#l5.462"></a><span id="l5.462">         &lt;setter&gt;</span>
<a href="#l5.463"></a><span id="l5.463">           &lt;![CDATA[</span>
<a href="#l5.464"></a><span id="l5.464">             this.setAttribute(&quot;dateTime&quot;,</span>
<a href="#l5.465"></a><span id="l5.465">                               this.makeFriendlyDateAgo(new Date(parseInt(val))));</span>
<a href="#l5.466"></a><span id="l5.466">           ]]&gt;</span>
<a href="#l5.467"></a><span id="l5.467">         &lt;/setter&gt;</span>
<a href="#l5.468"></a><span id="l5.468">       &lt;/property&gt;</span>
<a href="#l5.469"></a><span id="l5.469">       &lt;property name=&quot;canRecover&quot;&gt;</span>
<a href="#l5.470"></a><span id="l5.470">         &lt;getter&gt;</span>
<a href="#l5.471"></a><span id="l5.471">         &lt;![CDATA[</span>
<a href="#l5.472"></a><span id="l5.472">           try {</span>
<a href="#l5.473"></a><span id="l5.473">            return (this._activity.recoveryHandler != null);</span>
<a href="#l5.474"></a><span id="l5.474" class="difflineminus">-          }</span>
<a href="#l5.475"></a><span id="l5.475" class="difflineminus">-          catch(e) {</span>
<a href="#l5.476"></a><span id="l5.476" class="difflineplus">+          } catch (e) {</span>
<a href="#l5.477"></a><span id="l5.477">             // In normal conditions, we shouldn't endup here. This can only</span>
<a href="#l5.478"></a><span id="l5.478">             // happen if the XBL is orphan - associated activity has been</span>
<a href="#l5.479"></a><span id="l5.479">             // deleted but XBL stays alive.</span>
<a href="#l5.480"></a><span id="l5.480">           }</span>
<a href="#l5.481"></a><span id="l5.481">           return false;</span>
<a href="#l5.482"></a><span id="l5.482">         ]]&gt;</span>
<a href="#l5.483"></a><span id="l5.483">         &lt;/getter&gt;</span>
<a href="#l5.484"></a><span id="l5.484">       &lt;/property&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1">rename from mail/components/activity/modules/activityModules.js</span>
<a href="#l6.2"></a><span id="l6.2">rename to mail/components/activity/modules/activityModules.jsm</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineminus">--- a/mail/components/activity/modules/activityModules.js</span>
<a href="#l6.4"></a><span id="l6.4" class="difflineplus">+++ b/mail/components/activity/modules/activityModules.jsm</span>
<a href="#l6.5"></a><span id="l6.5" class="difflineat">@@ -3,20 +3,20 @@</span>
<a href="#l6.6"></a><span id="l6.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l6.7"></a><span id="l6.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l6.8"></a><span id="l6.8"> </span>
<a href="#l6.9"></a><span id="l6.9"> // This module is designed to be a central place to initialise activity related</span>
<a href="#l6.10"></a><span id="l6.10"> // modules.</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12"> this.EXPORTED_SYMBOLS = [];</span>
<a href="#l6.13"></a><span id="l6.13"> </span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/activity/sendLater.js&quot;);</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+const { sendLaterModule } = ChromeUtils.import(&quot;resource:///modules/activity/sendLater.jsm&quot;, null);</span>
<a href="#l6.16"></a><span id="l6.16"> sendLaterModule.init();</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/activity/moveCopy.js&quot;);</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+const { moveCopyModule } = ChromeUtils.import(&quot;resource:///modules/activity/moveCopy.jsm&quot;, null);</span>
<a href="#l6.19"></a><span id="l6.19"> moveCopyModule.init();</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/activity/glodaIndexer.js&quot;);</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineplus">+const { glodaIndexerActivity } = ChromeUtils.import(&quot;resource:///modules/activity/glodaIndexer.jsm&quot;, null);</span>
<a href="#l6.22"></a><span id="l6.22"> glodaIndexerActivity.init();</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/activity/autosync.js&quot;);</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineplus">+const { autosyncModule } = ChromeUtils.import(&quot;resource:///modules/activity/autosync.jsm&quot;, null);</span>
<a href="#l6.25"></a><span id="l6.25"> autosyncModule.init();</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/activity/alertHook.js&quot;);</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineplus">+ChromeUtils.import(&quot;resource:///modules/activity/alertHook.jsm&quot;);</span>
<a href="#l6.28"></a><span id="l6.28"> alertHook.init();</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/activity/pop3Download.js&quot;);</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineplus">+const { pop3DownloadModule } = ChromeUtils.import(&quot;resource:///modules/activity/pop3Download.jsm&quot;, null);</span>
<a href="#l6.31"></a><span id="l6.31"> pop3DownloadModule.init();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1">rename from mail/components/activity/modules/alertHook.js</span>
<a href="#l7.2"></a><span id="l7.2">rename to mail/components/activity/modules/alertHook.jsm</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineminus">--- a/mail/components/activity/modules/alertHook.js</span>
<a href="#l7.4"></a><span id="l7.4" class="difflineplus">+++ b/mail/components/activity/modules/alertHook.jsm</span>
<a href="#l7.5"></a><span id="l7.5" class="difflineat">@@ -1,26 +1,24 @@</span>
<a href="#l7.6"></a><span id="l7.6"> /* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l7.7"></a><span id="l7.7"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l7.8"></a><span id="l7.8">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l7.9"></a><span id="l7.9">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l7.10"></a><span id="l7.10"> </span>
<a href="#l7.11"></a><span id="l7.11" class="difflineminus">-this.EXPORTED_SYMBOLS = ['alertHook'];</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+this.EXPORTED_SYMBOLS = [&quot;alertHook&quot;];</span>
<a href="#l7.13"></a><span id="l7.13"> </span>
<a href="#l7.14"></a><span id="l7.14"> var nsActWarning = Components.Constructor(&quot;@mozilla.org/activity-warning;1&quot;,</span>
<a href="#l7.15"></a><span id="l7.15">                                             &quot;nsIActivityWarning&quot;, &quot;init&quot;);</span>
<a href="#l7.16"></a><span id="l7.16"> </span>
<a href="#l7.17"></a><span id="l7.17"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l7.18"></a><span id="l7.18"> ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineminus">-ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l7.20"></a><span id="l7.20"> </span>
<a href="#l7.21"></a><span id="l7.21"> // This module provides a link between the send later service and the activity</span>
<a href="#l7.22"></a><span id="l7.22"> // manager.</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineminus">-var alertHook =</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineminus">-{</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineplus">+var alertHook = {</span>
<a href="#l7.26"></a><span id="l7.26">   get activityMgr() {</span>
<a href="#l7.27"></a><span id="l7.27">     delete this.activityMgr;</span>
<a href="#l7.28"></a><span id="l7.28">     return this.activityMgr = Cc[&quot;@mozilla.org/activity-manager;1&quot;]</span>
<a href="#l7.29"></a><span id="l7.29">                                 .getService(Ci.nsIActivityManager);</span>
<a href="#l7.30"></a><span id="l7.30">   },</span>
<a href="#l7.31"></a><span id="l7.31"> </span>
<a href="#l7.32"></a><span id="l7.32">   get alertService() {</span>
<a href="#l7.33"></a><span id="l7.33">     delete this.alertService;</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineat">@@ -32,60 +30,57 @@ var alertHook =</span>
<a href="#l7.35"></a><span id="l7.35">     delete this.brandShortName;</span>
<a href="#l7.36"></a><span id="l7.36">     return this.brandShortName = Services.strings</span>
<a href="#l7.37"></a><span id="l7.37">       .createBundle(&quot;chrome://branding/locale/brand.properties&quot;)</span>
<a href="#l7.38"></a><span id="l7.38">       .GetStringFromName(&quot;brandShortName&quot;);</span>
<a href="#l7.39"></a><span id="l7.39">   },</span>
<a href="#l7.40"></a><span id="l7.40"> </span>
<a href="#l7.41"></a><span id="l7.41">   QueryInterface: ChromeUtils.generateQI([Ci.nsIMsgUserFeedbackListener]),</span>
<a href="#l7.42"></a><span id="l7.42"> </span>
<a href="#l7.43"></a><span id="l7.43" class="difflineminus">-  onAlert: function (aMessage, aUrl) {</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineplus">+  onAlert(aMessage, aUrl) {</span>
<a href="#l7.45"></a><span id="l7.45">     // Create a new warning.</span>
<a href="#l7.46"></a><span id="l7.46">     let warning = new nsActWarning(aMessage, this.activityMgr, &quot;&quot;);</span>
<a href="#l7.47"></a><span id="l7.47"> </span>
<a href="#l7.48"></a><span id="l7.48">     if (aUrl &amp;&amp; aUrl.server &amp;&amp; aUrl.server.prettyName) {</span>
<a href="#l7.49"></a><span id="l7.49">       warning.groupingStyle = Ci.nsIActivity.GROUPING_STYLE_BYCONTEXT;</span>
<a href="#l7.50"></a><span id="l7.50">       warning.contextType = &quot;incomingServer&quot;;</span>
<a href="#l7.51"></a><span id="l7.51">       warning.contextDisplayText = aUrl.server.prettyName;</span>
<a href="#l7.52"></a><span id="l7.52">       warning.contextObj = aUrl.server;</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineplus">+    } else {</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineplus">+      warning.groupingStyle = Ci.nsIActivity.GROUPING_STYLE_STANDALONE;</span>
<a href="#l7.55"></a><span id="l7.55">     }</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineminus">-    else</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineminus">-      warning.groupingStyle = Ci.nsIActivity.GROUPING_STYLE_STANDALONE;</span>
<a href="#l7.58"></a><span id="l7.58"> </span>
<a href="#l7.59"></a><span id="l7.59">     this.activityMgr.addActivity(warning);</span>
<a href="#l7.60"></a><span id="l7.60"> </span>
<a href="#l7.61"></a><span id="l7.61">     // If we have a message window in the url, then show a warning prompt,</span>
<a href="#l7.62"></a><span id="l7.62">     // just like the modal code used to. Otherwise, don't.</span>
<a href="#l7.63"></a><span id="l7.63">     try {</span>
<a href="#l7.64"></a><span id="l7.64">       if (!aUrl || !aUrl.msgWindow)</span>
<a href="#l7.65"></a><span id="l7.65">         return true;</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineminus">-    }</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineminus">-    // nsIMsgMailNewsUrl.msgWindow will throw on a null pointer, so that's</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineminus">-    // what we're handling here.</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineminus">-    catch (ex) {</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineplus">+    } catch (ex) {</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineplus">+      // nsIMsgMailNewsUrl.msgWindow will throw on a null pointer, so that's</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineplus">+      // what we're handling here.</span>
<a href="#l7.73"></a><span id="l7.73">       if (ex instanceof Ci.nsIException &amp;&amp;</span>
<a href="#l7.74"></a><span id="l7.74">           ex.result == Cr.NS_ERROR_INVALID_POINTER) {</span>
<a href="#l7.75"></a><span id="l7.75">         return true;</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineminus">-      } else {</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineminus">-        throw ex;</span>
<a href="#l7.78"></a><span id="l7.78">       }</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineplus">+      throw ex;</span>
<a href="#l7.80"></a><span id="l7.80">     }</span>
<a href="#l7.81"></a><span id="l7.81"> </span>
<a href="#l7.82"></a><span id="l7.82">     try {</span>
<a href="#l7.83"></a><span id="l7.83">       this.alertService</span>
<a href="#l7.84"></a><span id="l7.84">           .showAlertNotification(&quot;chrome://branding/content/icon48.png&quot;,</span>
<a href="#l7.85"></a><span id="l7.85">                                  this.brandShortName, aMessage);</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineminus">-    }</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineminus">-    catch (ex) {</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineplus">+    } catch (ex) {</span>
<a href="#l7.89"></a><span id="l7.89">       // XXX On Linux, if libnotify isn't supported, showAlertNotification</span>
<a href="#l7.90"></a><span id="l7.90">       // can throw an error, so fall-back to the old method of modal dialogs.</span>
<a href="#l7.91"></a><span id="l7.91">       return false;</span>
<a href="#l7.92"></a><span id="l7.92">     }</span>
<a href="#l7.93"></a><span id="l7.93"> </span>
<a href="#l7.94"></a><span id="l7.94">     return true;</span>
<a href="#l7.95"></a><span id="l7.95">   },</span>
<a href="#l7.96"></a><span id="l7.96"> </span>
<a href="#l7.97"></a><span id="l7.97" class="difflineminus">-  init: function() {</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineplus">+  init() {</span>
<a href="#l7.99"></a><span id="l7.99">     // We shouldn't need to remove the listener as we're not being held by</span>
<a href="#l7.100"></a><span id="l7.100">     // anyone except by the send later instance.</span>
<a href="#l7.101"></a><span id="l7.101">     MailServices.mailSession.addUserFeedbackListener(this);</span>
<a href="#l7.102"></a><span id="l7.102" class="difflineminus">-  }</span>
<a href="#l7.103"></a><span id="l7.103" class="difflineplus">+  },</span>
<a href="#l7.104"></a><span id="l7.104"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1">rename from mail/components/activity/modules/autosync.js</span>
<a href="#l8.2"></a><span id="l8.2">rename to mail/components/activity/modules/autosync.jsm</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineminus">--- a/mail/components/activity/modules/autosync.js</span>
<a href="#l8.4"></a><span id="l8.4" class="difflineplus">+++ b/mail/components/activity/modules/autosync.jsm</span>
<a href="#l8.5"></a><span id="l8.5" class="difflineat">@@ -1,43 +1,39 @@</span>
<a href="#l8.6"></a><span id="l8.6"> /* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l8.7"></a><span id="l8.7"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l8.8"></a><span id="l8.8">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l8.9"></a><span id="l8.9">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l8.10"></a><span id="l8.10"> </span>
<a href="#l8.11"></a><span id="l8.11" class="difflineminus">-this.EXPORTED_SYMBOLS = ['autosyncModule'];</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+this.EXPORTED_SYMBOLS = [&quot;autosyncModule&quot;];</span>
<a href="#l8.13"></a><span id="l8.13"> </span>
<a href="#l8.14"></a><span id="l8.14"> var nsActProcess = Components.Constructor(&quot;@mozilla.org/activity-process;1&quot;,</span>
<a href="#l8.15"></a><span id="l8.15">                                             &quot;nsIActivityProcess&quot;, &quot;init&quot;);</span>
<a href="#l8.16"></a><span id="l8.16"> var nsActEvent = Components.Constructor(&quot;@mozilla.org/activity-event;1&quot;,</span>
<a href="#l8.17"></a><span id="l8.17">                                           &quot;nsIActivityEvent&quot;, &quot;init&quot;);</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineminus">-var nsActWarning = Components.Constructor(&quot;@mozilla.org/activity-warning;1&quot;,</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineminus">-                                            &quot;nsIActivityWarning&quot;, &quot;init&quot;);</span>
<a href="#l8.20"></a><span id="l8.20"> </span>
<a href="#l8.21"></a><span id="l8.21"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineminus">-ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineminus">-ChromeUtils.import(&quot;resource://gre/modules/PluralForm.jsm&quot;);</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/gloda/log4moz.js&quot;);</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineplus">+const { Log4Moz } = ChromeUtils.import(&quot;resource:///modules/gloda/log4moz.js&quot;, null);</span>
<a href="#l8.26"></a><span id="l8.26"> </span>
<a href="#l8.27"></a><span id="l8.27"> var nsIAutoSyncMgrListener = Ci.nsIAutoSyncMgrListener;</span>
<a href="#l8.28"></a><span id="l8.28"> </span>
<a href="#l8.29"></a><span id="l8.29"> /**</span>
<a href="#l8.30"></a><span id="l8.30">  * This code aims to mediate between the auto-sync code and the activity mgr.</span>
<a href="#l8.31"></a><span id="l8.31">  *</span>
<a href="#l8.32"></a><span id="l8.32">  * Not every auto-sync activity is directly  mapped to a process or event.</span>
<a href="#l8.33"></a><span id="l8.33">  * To prevent a possible event overflow, Auto-Sync monitor generates one</span>
<a href="#l8.34"></a><span id="l8.34">  * sync'd event per account when after all its _pending_ folders are sync'd,</span>
<a href="#l8.35"></a><span id="l8.35">  * rather than generating one event per folder sync.</span>
<a href="#l8.36"></a><span id="l8.36">  */</span>
<a href="#l8.37"></a><span id="l8.37"> </span>
<a href="#l8.38"></a><span id="l8.38"> var autosyncModule =</span>
<a href="#l8.39"></a><span id="l8.39"> {</span>
<a href="#l8.40"></a><span id="l8.40"> </span>
<a href="#l8.41"></a><span id="l8.41" class="difflineminus">-  _inQFolderList : [],</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineminus">-  _running : false,</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineplus">+  _inQFolderList: [],</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineplus">+  _running: false,</span>
<a href="#l8.45"></a><span id="l8.45">   _syncInfoPerFolder: new Map(),</span>
<a href="#l8.46"></a><span id="l8.46">   _syncInfoPerServer: new Map(),</span>
<a href="#l8.47"></a><span id="l8.47">   _lastMessage: new Map(),</span>
<a href="#l8.48"></a><span id="l8.48"> </span>
<a href="#l8.49"></a><span id="l8.49">   get log() {</span>
<a href="#l8.50"></a><span id="l8.50">     delete this.log;</span>
<a href="#l8.51"></a><span id="l8.51">     return this.log = Log4Moz.getConfiguredLogger(&quot;autosyncActivities&quot;);</span>
<a href="#l8.52"></a><span id="l8.52">   },</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineat">@@ -55,50 +51,50 @@ var autosyncModule =</span>
<a href="#l8.54"></a><span id="l8.54">   },</span>
<a href="#l8.55"></a><span id="l8.55"> </span>
<a href="#l8.56"></a><span id="l8.56">   get bundle() {</span>
<a href="#l8.57"></a><span id="l8.57">     delete this.bundle;</span>
<a href="#l8.58"></a><span id="l8.58">     return this.bundle = Services.strings</span>
<a href="#l8.59"></a><span id="l8.59">       .createBundle(&quot;chrome://messenger/locale/activity.properties&quot;);</span>
<a href="#l8.60"></a><span id="l8.60">   },</span>
<a href="#l8.61"></a><span id="l8.61"> </span>
<a href="#l8.62"></a><span id="l8.62" class="difflineminus">-  getString: function(stringName) {</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineplus">+  getString(stringName) {</span>
<a href="#l8.64"></a><span id="l8.64">     try {</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineminus">-      return this.bundle.GetStringFromName(stringName)</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineplus">+      return this.bundle.GetStringFromName(stringName);</span>
<a href="#l8.67"></a><span id="l8.67">     } catch (e) {</span>
<a href="#l8.68"></a><span id="l8.68">       this.log.error(&quot;error trying to get a string called: &quot; + stringName);</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineminus">-      throw(e);</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineplus">+      throw e;</span>
<a href="#l8.71"></a><span id="l8.71">     }</span>
<a href="#l8.72"></a><span id="l8.72">   },</span>
<a href="#l8.73"></a><span id="l8.73"> </span>
<a href="#l8.74"></a><span id="l8.74" class="difflineminus">-  createSyncMailProcess : function(folder) {</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineplus">+  createSyncMailProcess(folder) {</span>
<a href="#l8.76"></a><span id="l8.76">     try {</span>
<a href="#l8.77"></a><span id="l8.77">       // create an activity process for this folder</span>
<a href="#l8.78"></a><span id="l8.78">       let msg = this.bundle.formatStringFromName(&quot;autosyncProcessDisplayText&quot;,</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineminus">-                                                 [folder.prettyName], 1)</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineplus">+                                                 [folder.prettyName], 1);</span>
<a href="#l8.81"></a><span id="l8.81">       let process = new nsActProcess(msg, this.autoSyncManager);</span>
<a href="#l8.82"></a><span id="l8.82">       // we want to use default auto-sync icon</span>
<a href="#l8.83"></a><span id="l8.83">       process.iconClass = &quot;syncMail&quot;;</span>
<a href="#l8.84"></a><span id="l8.84">       process.addSubject(folder);</span>
<a href="#l8.85"></a><span id="l8.85">       // group processes under folder's imap account</span>
<a href="#l8.86"></a><span id="l8.86">       process.contextType = &quot;account&quot;;</span>
<a href="#l8.87"></a><span id="l8.87">       process.contextDisplayText = this.bundle.formatStringFromName(&quot;autosyncContextDisplayText&quot;,</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineminus">-                                        [folder.server.prettyName], 1)</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineplus">+                                        [folder.server.prettyName], 1);</span>
<a href="#l8.90"></a><span id="l8.90"> </span>
<a href="#l8.91"></a><span id="l8.91"> </span>
<a href="#l8.92"></a><span id="l8.92">       process.contextObj = folder.server;</span>
<a href="#l8.93"></a><span id="l8.93"> </span>
<a href="#l8.94"></a><span id="l8.94">       return process;</span>
<a href="#l8.95"></a><span id="l8.95">     } catch (e) {</span>
<a href="#l8.96"></a><span id="l8.96">       this.log.error(&quot;createSyncMailProcess: &quot; + e);</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineminus">-      throw(e);</span>
<a href="#l8.98"></a><span id="l8.98" class="difflineplus">+      throw e;</span>
<a href="#l8.99"></a><span id="l8.99">     }</span>
<a href="#l8.100"></a><span id="l8.100">   },</span>
<a href="#l8.101"></a><span id="l8.101"> </span>
<a href="#l8.102"></a><span id="l8.102" class="difflineminus">-  createSyncMailEvent : function(syncItem) {</span>
<a href="#l8.103"></a><span id="l8.103" class="difflineplus">+  createSyncMailEvent(syncItem) {</span>
<a href="#l8.104"></a><span id="l8.104">     try {</span>
<a href="#l8.105"></a><span id="l8.105">       // extract the relevant parts</span>
<a href="#l8.106"></a><span id="l8.106">       let process = syncItem.activity;</span>
<a href="#l8.107"></a><span id="l8.107">       let folder = syncItem.syncFolder;</span>
<a href="#l8.108"></a><span id="l8.108"> </span>
<a href="#l8.109"></a><span id="l8.109">       // create an activity event</span>
<a href="#l8.110"></a><span id="l8.110"> </span>
<a href="#l8.111"></a><span id="l8.111">       let msg = this.bundle.formatStringFromName(&quot;autosyncEventDisplayText&quot;,</span>
<a href="#l8.112"></a><span id="l8.112" class="difflineat">@@ -115,122 +111,118 @@ var autosyncModule =</span>
<a href="#l8.113"></a><span id="l8.113">       let event = new nsActEvent(msg, this.autoSyncManager, statusMsg,</span>
<a href="#l8.114"></a><span id="l8.114">                                  this._syncInfoPerServer.get(folder.server).startTime,</span>
<a href="#l8.115"></a><span id="l8.115">                                  Date.now());               // completion time</span>
<a href="#l8.116"></a><span id="l8.116"> </span>
<a href="#l8.117"></a><span id="l8.117">       // since auto-sync events do not have undo option by nature,</span>
<a href="#l8.118"></a><span id="l8.118">       // setting these values are informational only.</span>
<a href="#l8.119"></a><span id="l8.119">       event.contextType = process.contextType;</span>
<a href="#l8.120"></a><span id="l8.120">       event.contextDisplayText = this.bundle.formatStringFromName(&quot;autosyncContextDisplayText&quot;,</span>
<a href="#l8.121"></a><span id="l8.121" class="difflineminus">-                                        [folder.server.prettyName], 1)</span>
<a href="#l8.122"></a><span id="l8.122" class="difflineplus">+                                        [folder.server.prettyName], 1);</span>
<a href="#l8.123"></a><span id="l8.123">       event.contextObj = process.contextObj;</span>
<a href="#l8.124"></a><span id="l8.124">       event.iconClass = &quot;syncMail&quot;;</span>
<a href="#l8.125"></a><span id="l8.125"> </span>
<a href="#l8.126"></a><span id="l8.126">       // transfer all subjects.</span>
<a href="#l8.127"></a><span id="l8.127">       // same as above, not mandatory</span>
<a href="#l8.128"></a><span id="l8.128">       let subjects = process.getSubjects({});</span>
<a href="#l8.129"></a><span id="l8.129">       for (let subject of subjects)</span>
<a href="#l8.130"></a><span id="l8.130">         event.addSubject(subject);</span>
<a href="#l8.131"></a><span id="l8.131"> </span>
<a href="#l8.132"></a><span id="l8.132">       return event;</span>
<a href="#l8.133"></a><span id="l8.133">     } catch (e) {</span>
<a href="#l8.134"></a><span id="l8.134">       this.log.error(&quot;createSyncMailEvent: &quot; + e);</span>
<a href="#l8.135"></a><span id="l8.135" class="difflineminus">-      throw(e);</span>
<a href="#l8.136"></a><span id="l8.136" class="difflineplus">+      throw e;</span>
<a href="#l8.137"></a><span id="l8.137">     }</span>
<a href="#l8.138"></a><span id="l8.138">   },</span>
<a href="#l8.139"></a><span id="l8.139"> </span>
<a href="#l8.140"></a><span id="l8.140" class="difflineminus">-  onStateChanged : function(running) {</span>
<a href="#l8.141"></a><span id="l8.141" class="difflineplus">+  onStateChanged(running) {</span>
<a href="#l8.142"></a><span id="l8.142">     try {</span>
<a href="#l8.143"></a><span id="l8.143">       this._running = running;</span>
<a href="#l8.144"></a><span id="l8.144">       this.log.info(&quot;OnStatusChanged: &quot; + (running ? &quot;running&quot; : &quot;sleeping&quot;) + &quot;\n&quot;);</span>
<a href="#l8.145"></a><span id="l8.145">     } catch (e) {</span>
<a href="#l8.146"></a><span id="l8.146">       this.log.error(&quot;onStateChanged: &quot; + e);</span>
<a href="#l8.147"></a><span id="l8.147" class="difflineminus">-      throw(e);</span>
<a href="#l8.148"></a><span id="l8.148" class="difflineplus">+      throw e;</span>
<a href="#l8.149"></a><span id="l8.149">     }</span>
<a href="#l8.150"></a><span id="l8.150">   },</span>
<a href="#l8.151"></a><span id="l8.151"> </span>
<a href="#l8.152"></a><span id="l8.152" class="difflineminus">-  onFolderAddedIntoQ : function(queue, folder) {</span>
<a href="#l8.153"></a><span id="l8.153" class="difflineplus">+  onFolderAddedIntoQ(queue, folder) {</span>
<a href="#l8.154"></a><span id="l8.154">     try {</span>
<a href="#l8.155"></a><span id="l8.155">       if (folder instanceof Ci.nsIMsgFolder &amp;&amp;</span>
<a href="#l8.156"></a><span id="l8.156">           queue == nsIAutoSyncMgrListener.PriorityQueue) {</span>
<a href="#l8.157"></a><span id="l8.157">         this._inQFolderList.push(folder);</span>
<a href="#l8.158"></a><span id="l8.158">         this.log.info(&quot;Auto_Sync OnFolderAddedIntoQ [&quot; + this._inQFolderList.length + &quot;] &quot; +</span>
<a href="#l8.159"></a><span id="l8.159">                         folder.prettyName + &quot; of &quot; + folder.server.prettyName);</span>
<a href="#l8.160"></a><span id="l8.160">         // create an activity process for this folder</span>
<a href="#l8.161"></a><span id="l8.161">         let process = this.createSyncMailProcess(folder);</span>
<a href="#l8.162"></a><span id="l8.162"> </span>
<a href="#l8.163"></a><span id="l8.163">         // create a sync object to keep track of the process of this folder</span>
<a href="#l8.164"></a><span id="l8.164">         let imapFolder = folder.QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l8.165"></a><span id="l8.165">         let syncItem = { syncFolder: folder,</span>
<a href="#l8.166"></a><span id="l8.166">                          activity: process,</span>
<a href="#l8.167"></a><span id="l8.167">                          percentComplete: 0,</span>
<a href="#l8.168"></a><span id="l8.168">                          totalDownloaded: 0,</span>
<a href="#l8.169"></a><span id="l8.169" class="difflineminus">-                         pendingMsgCount: imapFolder.autoSyncStateObj.pendingMessageCount</span>
<a href="#l8.170"></a><span id="l8.170" class="difflineplus">+                         pendingMsgCount: imapFolder.autoSyncStateObj.pendingMessageCount,</span>
<a href="#l8.171"></a><span id="l8.171">                        };</span>
<a href="#l8.172"></a><span id="l8.172"> </span>
<a href="#l8.173"></a><span id="l8.173">         // if this is the first folder of this server in the queue, then set the sync start time</span>
<a href="#l8.174"></a><span id="l8.174">         // for activity event</span>
<a href="#l8.175"></a><span id="l8.175">         if (!this._syncInfoPerServer.has(folder.server)) {</span>
<a href="#l8.176"></a><span id="l8.176">           this._syncInfoPerServer.set(folder.server, { startTime: Date.now(),</span>
<a href="#l8.177"></a><span id="l8.177" class="difflineminus">-                                                       totalDownloads: 0</span>
<a href="#l8.178"></a><span id="l8.178" class="difflineplus">+                                                       totalDownloads: 0,</span>
<a href="#l8.179"></a><span id="l8.179">                                                      });</span>
<a href="#l8.180"></a><span id="l8.180">         }</span>
<a href="#l8.181"></a><span id="l8.181"> </span>
<a href="#l8.182"></a><span id="l8.182">         // associate the sync object with the folder in question</span>
<a href="#l8.183"></a><span id="l8.183">         // use folder.URI as key</span>
<a href="#l8.184"></a><span id="l8.184">         this._syncInfoPerFolder.set(folder.URI, syncItem);</span>
<a href="#l8.185"></a><span id="l8.185">       }</span>
<a href="#l8.186"></a><span id="l8.186">     } catch (e) {</span>
<a href="#l8.187"></a><span id="l8.187">       this.log.error(&quot;onFolderAddedIntoQ: &quot; + e);</span>
<a href="#l8.188"></a><span id="l8.188" class="difflineminus">-      throw(e);</span>
<a href="#l8.189"></a><span id="l8.189" class="difflineplus">+      throw e;</span>
<a href="#l8.190"></a><span id="l8.190">     }</span>
<a href="#l8.191"></a><span id="l8.191">   },</span>
<a href="#l8.192"></a><span id="l8.192" class="difflineminus">-  onFolderRemovedFromQ : function(queue, folder) {</span>
<a href="#l8.193"></a><span id="l8.193" class="difflineplus">+  onFolderRemovedFromQ(queue, folder) {</span>
<a href="#l8.194"></a><span id="l8.194">     try {</span>
<a href="#l8.195"></a><span id="l8.195">       if (folder instanceof Ci.nsIMsgFolder &amp;&amp;</span>
<a href="#l8.196"></a><span id="l8.196">           queue == nsIAutoSyncMgrListener.PriorityQueue) {</span>
<a href="#l8.197"></a><span id="l8.197">         let i = this._inQFolderList.indexOf(folder);</span>
<a href="#l8.198"></a><span id="l8.198">         if (i &gt; -1)</span>
<a href="#l8.199"></a><span id="l8.199">           this._inQFolderList.splice(i, 1);</span>
<a href="#l8.200"></a><span id="l8.200"> </span>
<a href="#l8.201"></a><span id="l8.201">         this.log.info(&quot;OnFolderRemovedFromQ [&quot; + this._inQFolderList.length + &quot;] &quot; +</span>
<a href="#l8.202"></a><span id="l8.202">                         folder.prettyName + &quot; of &quot; + folder.server.prettyName + &quot;\n&quot;);</span>
<a href="#l8.203"></a><span id="l8.203"> </span>
<a href="#l8.204"></a><span id="l8.204">         let syncItem = this._syncInfoPerFolder.get(folder.URI);</span>
<a href="#l8.205"></a><span id="l8.205">         let process = syncItem.activity;</span>
<a href="#l8.206"></a><span id="l8.206">         let canceled = false;</span>
<a href="#l8.207"></a><span id="l8.207" class="difflineminus">-        if (process instanceof Ci.nsIActivityProcess)</span>
<a href="#l8.208"></a><span id="l8.208" class="difflineminus">-        {</span>
<a href="#l8.209"></a><span id="l8.209" class="difflineplus">+        if (process instanceof Ci.nsIActivityProcess) {</span>
<a href="#l8.210"></a><span id="l8.210">           canceled = (process.state == Ci.nsIActivityProcess.STATE_CANCELED);</span>
<a href="#l8.211"></a><span id="l8.211">           process.state = Ci.nsIActivityProcess.STATE_COMPLETED;</span>
<a href="#l8.212"></a><span id="l8.212"> </span>
<a href="#l8.213"></a><span id="l8.213">           try {</span>
<a href="#l8.214"></a><span id="l8.214">             this.activityMgr.removeActivity(process.id);</span>
<a href="#l8.215"></a><span id="l8.215" class="difflineminus">-          }</span>
<a href="#l8.216"></a><span id="l8.216" class="difflineminus">-          catch(e) {</span>
<a href="#l8.217"></a><span id="l8.217" class="difflineplus">+          } catch (e) {</span>
<a href="#l8.218"></a><span id="l8.218">             // It is OK to end up here; If the folder is queued and the</span>
<a href="#l8.219"></a><span id="l8.219">             // message get manually downloaded by the user, we might get</span>
<a href="#l8.220"></a><span id="l8.220">             // a folder removed notification even before a download</span>
<a href="#l8.221"></a><span id="l8.221">             // started for this folder. This behavior stems from the fact</span>
<a href="#l8.222"></a><span id="l8.222">             // that we add activities into the activity manager in</span>
<a href="#l8.223"></a><span id="l8.223">             // onDownloadStarted notification rather than onFolderAddedIntoQ.</span>
<a href="#l8.224"></a><span id="l8.224">             // This is an expected side effect.</span>
<a href="#l8.225"></a><span id="l8.225">           }</span>
<a href="#l8.226"></a><span id="l8.226"> </span>
<a href="#l8.227"></a><span id="l8.227">           // remove the folder/syncItem association from the table</span>
<a href="#l8.228"></a><span id="l8.228">           this._syncInfoPerFolder.delete(folder.URI);</span>
<a href="#l8.229"></a><span id="l8.229">         }</span>
<a href="#l8.230"></a><span id="l8.230"> </span>
<a href="#l8.231"></a><span id="l8.231">         // if this is the last folder of this server in the queue</span>
<a href="#l8.232"></a><span id="l8.232">         // create a sync event and clean the sync start time</span>
<a href="#l8.233"></a><span id="l8.233">         let found = false;</span>
<a href="#l8.234"></a><span id="l8.234" class="difflineminus">-        for (let value of this._syncInfoPerFolder.values())</span>
<a href="#l8.235"></a><span id="l8.235" class="difflineminus">-        {</span>
<a href="#l8.236"></a><span id="l8.236" class="difflineminus">-          if (value.syncFolder.server == folder.server)</span>
<a href="#l8.237"></a><span id="l8.237" class="difflineminus">-          {</span>
<a href="#l8.238"></a><span id="l8.238" class="difflineplus">+        for (let value of this._syncInfoPerFolder.values()) {</span>
<a href="#l8.239"></a><span id="l8.239" class="difflineplus">+          if (value.syncFolder.server == folder.server) {</span>
<a href="#l8.240"></a><span id="l8.240">             found = true;</span>
<a href="#l8.241"></a><span id="l8.241">             break;</span>
<a href="#l8.242"></a><span id="l8.242">           }</span>
<a href="#l8.243"></a><span id="l8.243">         }</span>
<a href="#l8.244"></a><span id="l8.244">         this.log.info(&quot;Auto_Sync OnFolderRemovedFromQ Last folder of the server: &quot; + !found);</span>
<a href="#l8.245"></a><span id="l8.245">         if (!found) {</span>
<a href="#l8.246"></a><span id="l8.246">           // create an sync event for the completed process if it's not canceled</span>
<a href="#l8.247"></a><span id="l8.247">           if (!canceled) {</span>
<a href="#l8.248"></a><span id="l8.248" class="difflineat">@@ -241,20 +233,20 @@ var autosyncModule =</span>
<a href="#l8.249"></a><span id="l8.249">             this._lastMessage.set(key, this.activityMgr</span>
<a href="#l8.250"></a><span id="l8.250">               .addActivity(this.createSyncMailEvent(syncItem)));</span>
<a href="#l8.251"></a><span id="l8.251">           }</span>
<a href="#l8.252"></a><span id="l8.252">           this._syncInfoPerServer.delete(folder.server);</span>
<a href="#l8.253"></a><span id="l8.253">         }</span>
<a href="#l8.254"></a><span id="l8.254">       }</span>
<a href="#l8.255"></a><span id="l8.255">     } catch (e) {</span>
<a href="#l8.256"></a><span id="l8.256">       this.log.error(&quot;onFolderRemovedFromQ: &quot; + e);</span>
<a href="#l8.257"></a><span id="l8.257" class="difflineminus">-      throw(e);</span>
<a href="#l8.258"></a><span id="l8.258" class="difflineplus">+      throw e;</span>
<a href="#l8.259"></a><span id="l8.259">     }</span>
<a href="#l8.260"></a><span id="l8.260">   },</span>
<a href="#l8.261"></a><span id="l8.261" class="difflineminus">-  onDownloadStarted : function(folder, numOfMessages, totalPending) {</span>
<a href="#l8.262"></a><span id="l8.262" class="difflineplus">+  onDownloadStarted(folder, numOfMessages, totalPending) {</span>
<a href="#l8.263"></a><span id="l8.263">     try {</span>
<a href="#l8.264"></a><span id="l8.264">       if (folder instanceof Ci.nsIMsgFolder) {</span>
<a href="#l8.265"></a><span id="l8.265">         this.log.info(&quot;OnDownloadStarted (&quot; + numOfMessages + &quot;/&quot; + totalPending + &quot;): &quot; +</span>
<a href="#l8.266"></a><span id="l8.266">                                 folder.prettyName + &quot; of &quot; + folder.server.prettyName + &quot;\n&quot;);</span>
<a href="#l8.267"></a><span id="l8.267"> </span>
<a href="#l8.268"></a><span id="l8.268">         let syncItem = this._syncInfoPerFolder.get(folder.URI);</span>
<a href="#l8.269"></a><span id="l8.269">         let process = syncItem.activity;</span>
<a href="#l8.270"></a><span id="l8.270"> </span>
<a href="#l8.271"></a><span id="l8.271" class="difflineat">@@ -269,17 +261,17 @@ var autosyncModule =</span>
<a href="#l8.272"></a><span id="l8.272">           if (!this.activityMgr.containsActivity(process.id)) {</span>
<a href="#l8.273"></a><span id="l8.273">             this.log.info(&quot;Auto_Sync OnDownloadStarted: No process, adding a new process&quot;);</span>
<a href="#l8.274"></a><span id="l8.274">             this.activityMgr.addActivity(process);</span>
<a href="#l8.275"></a><span id="l8.275">           }</span>
<a href="#l8.276"></a><span id="l8.276"> </span>
<a href="#l8.277"></a><span id="l8.277">           syncItem.totalDownloaded += numOfMessages;</span>
<a href="#l8.278"></a><span id="l8.278"> </span>
<a href="#l8.279"></a><span id="l8.279">           process.state = Ci.nsIActivityProcess.STATE_INPROGRESS;</span>
<a href="#l8.280"></a><span id="l8.280" class="difflineminus">-          let percent = (syncItem.totalDownloaded/syncItem.pendingMsgCount)*100;</span>
<a href="#l8.281"></a><span id="l8.281" class="difflineplus">+          let percent = (syncItem.totalDownloaded / syncItem.pendingMsgCount) * 100;</span>
<a href="#l8.282"></a><span id="l8.282">           if (percent &gt; syncItem.percentComplete)</span>
<a href="#l8.283"></a><span id="l8.283">             syncItem.percentComplete = percent;</span>
<a href="#l8.284"></a><span id="l8.284"> </span>
<a href="#l8.285"></a><span id="l8.285">           let msg = this.bundle.formatStringFromName(&quot;autosyncProcessProgress2&quot;,</span>
<a href="#l8.286"></a><span id="l8.286">                                                  [syncItem.totalDownloaded,</span>
<a href="#l8.287"></a><span id="l8.287">                                                   syncItem.pendingMsgCount,</span>
<a href="#l8.288"></a><span id="l8.288">                                                   folder.prettyName,</span>
<a href="#l8.289"></a><span id="l8.289">                                                   folder.server.prettyName], 4);</span>
<a href="#l8.290"></a><span id="l8.290" class="difflineat">@@ -288,55 +280,55 @@ var autosyncModule =</span>
<a href="#l8.291"></a><span id="l8.291"> </span>
<a href="#l8.292"></a><span id="l8.292">           let serverInfo = this._syncInfoPerServer.get(syncItem.syncFolder.server);</span>
<a href="#l8.293"></a><span id="l8.293">           serverInfo.totalDownloads += numOfMessages;</span>
<a href="#l8.294"></a><span id="l8.294">           this._syncInfoPerServer.set(syncItem.syncFolder.server, serverInfo);</span>
<a href="#l8.295"></a><span id="l8.295">         }</span>
<a href="#l8.296"></a><span id="l8.296">       }</span>
<a href="#l8.297"></a><span id="l8.297">     } catch (e) {</span>
<a href="#l8.298"></a><span id="l8.298">       this.log.error(&quot;onDownloadStarted: &quot; + e);</span>
<a href="#l8.299"></a><span id="l8.299" class="difflineminus">-      throw(e);</span>
<a href="#l8.300"></a><span id="l8.300" class="difflineplus">+      throw e;</span>
<a href="#l8.301"></a><span id="l8.301">     }</span>
<a href="#l8.302"></a><span id="l8.302">   },</span>
<a href="#l8.303"></a><span id="l8.303"> </span>
<a href="#l8.304"></a><span id="l8.304" class="difflineminus">-  onDownloadCompleted : function(folder) {</span>
<a href="#l8.305"></a><span id="l8.305" class="difflineplus">+  onDownloadCompleted(folder) {</span>
<a href="#l8.306"></a><span id="l8.306">     try {</span>
<a href="#l8.307"></a><span id="l8.307">       if (folder instanceof Ci.nsIMsgFolder) {</span>
<a href="#l8.308"></a><span id="l8.308">         this.log.info(&quot;OnDownloadCompleted: &quot; + folder.prettyName + &quot; of &quot; +</span>
<a href="#l8.309"></a><span id="l8.309">                       folder.server.prettyName);</span>
<a href="#l8.310"></a><span id="l8.310"> </span>
<a href="#l8.311"></a><span id="l8.311">         let process = this._syncInfoPerFolder.get(folder.URI).activity;</span>
<a href="#l8.312"></a><span id="l8.312">         if (process instanceof Ci.nsIActivityProcess &amp;&amp;</span>
<a href="#l8.313"></a><span id="l8.313">            !this._running) {</span>
<a href="#l8.314"></a><span id="l8.314">           this.log.info(&quot;OnDownloadCompleted: Auto-Sync Manager is paused, pausing the process&quot;);</span>
<a href="#l8.315"></a><span id="l8.315">           process.state = Ci.nsIActivityProcess.STATE_PAUSED;</span>
<a href="#l8.316"></a><span id="l8.316">         }</span>
<a href="#l8.317"></a><span id="l8.317">       }</span>
<a href="#l8.318"></a><span id="l8.318">     } catch (e) {</span>
<a href="#l8.319"></a><span id="l8.319">       this.log.error(&quot;onDownloadCompleted: &quot; + e);</span>
<a href="#l8.320"></a><span id="l8.320" class="difflineminus">-      throw(e);</span>
<a href="#l8.321"></a><span id="l8.321" class="difflineplus">+      throw e;</span>
<a href="#l8.322"></a><span id="l8.322">     }</span>
<a href="#l8.323"></a><span id="l8.323">   },</span>
<a href="#l8.324"></a><span id="l8.324"> </span>
<a href="#l8.325"></a><span id="l8.325" class="difflineminus">-  onDownloadError : function(folder) {</span>
<a href="#l8.326"></a><span id="l8.326" class="difflineplus">+  onDownloadError(folder) {</span>
<a href="#l8.327"></a><span id="l8.327">     if (folder instanceof Ci.nsIMsgFolder) {</span>
<a href="#l8.328"></a><span id="l8.328">       this.log.error(&quot;OnDownloadError: &quot; + folder.prettyName + &quot; of &quot; +</span>
<a href="#l8.329"></a><span id="l8.329">                      folder.server.prettyName + &quot;\n&quot;);</span>
<a href="#l8.330"></a><span id="l8.330">     }</span>
<a href="#l8.331"></a><span id="l8.331">   },</span>
<a href="#l8.332"></a><span id="l8.332"> </span>
<a href="#l8.333"></a><span id="l8.333" class="difflineminus">-  onDiscoveryQProcessed : function (folder, numOfHdrsProcessed, leftToProcess) {</span>
<a href="#l8.334"></a><span id="l8.334" class="difflineplus">+  onDiscoveryQProcessed(folder, numOfHdrsProcessed, leftToProcess) {</span>
<a href="#l8.335"></a><span id="l8.335">     this.log.info(&quot;onDiscoveryQProcessed: Processed &quot; + numOfHdrsProcessed + &quot;/&quot; +</span>
<a href="#l8.336"></a><span id="l8.336" class="difflineminus">-                  (leftToProcess+numOfHdrsProcessed) + &quot; of &quot; + folder.prettyName + &quot;\n&quot;);</span>
<a href="#l8.337"></a><span id="l8.337" class="difflineplus">+                  (leftToProcess + numOfHdrsProcessed) + &quot; of &quot; + folder.prettyName + &quot;\n&quot;);</span>
<a href="#l8.338"></a><span id="l8.338">   },</span>
<a href="#l8.339"></a><span id="l8.339"> </span>
<a href="#l8.340"></a><span id="l8.340" class="difflineminus">-  onAutoSyncInitiated : function (folder) {</span>
<a href="#l8.341"></a><span id="l8.341" class="difflineplus">+  onAutoSyncInitiated(folder) {</span>
<a href="#l8.342"></a><span id="l8.342">       this.log.info(&quot;onAutoSyncInitiated: &quot; + folder.prettyName + &quot; of &quot; +</span>
<a href="#l8.343"></a><span id="l8.343">                     folder.server.prettyName + &quot; has been updated.\n&quot;);</span>
<a href="#l8.344"></a><span id="l8.344">   },</span>
<a href="#l8.345"></a><span id="l8.345"> </span>
<a href="#l8.346"></a><span id="l8.346" class="difflineminus">-  init: function() {</span>
<a href="#l8.347"></a><span id="l8.347" class="difflineplus">+  init() {</span>
<a href="#l8.348"></a><span id="l8.348">     // XXX when do we need to remove ourselves?</span>
<a href="#l8.349"></a><span id="l8.349" class="difflineminus">-    this.log.info('initing');</span>
<a href="#l8.350"></a><span id="l8.350" class="difflineplus">+    this.log.info(&quot;initing&quot;);</span>
<a href="#l8.351"></a><span id="l8.351">     Cc[&quot;@mozilla.org/imap/autosyncmgr;1&quot;]</span>
<a href="#l8.352"></a><span id="l8.352">       .getService(Ci.nsIAutoSyncManager).addListener(this);</span>
<a href="#l8.353"></a><span id="l8.353">   },</span>
<a href="#l8.354"></a><span id="l8.354" class="difflineminus">-}</span>
<a href="#l8.355"></a><span id="l8.355" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1">rename from mail/components/activity/modules/glodaIndexer.js</span>
<a href="#l9.2"></a><span id="l9.2">rename to mail/components/activity/modules/glodaIndexer.jsm</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineminus">--- a/mail/components/activity/modules/glodaIndexer.js</span>
<a href="#l9.4"></a><span id="l9.4" class="difflineplus">+++ b/mail/components/activity/modules/glodaIndexer.jsm</span>
<a href="#l9.5"></a><span id="l9.5" class="difflineat">@@ -4,25 +4,22 @@</span>
<a href="#l9.6"></a><span id="l9.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l9.7"></a><span id="l9.7"> </span>
<a href="#l9.8"></a><span id="l9.8"> this.EXPORTED_SYMBOLS = [&quot;glodaIndexerActivity&quot;];</span>
<a href="#l9.9"></a><span id="l9.9"> </span>
<a href="#l9.10"></a><span id="l9.10"> var nsActProcess = Components.Constructor(&quot;@mozilla.org/activity-process;1&quot;,</span>
<a href="#l9.11"></a><span id="l9.11">                                             &quot;nsIActivityProcess&quot;, &quot;init&quot;);</span>
<a href="#l9.12"></a><span id="l9.12"> var nsActEvent   = Components.Constructor(&quot;@mozilla.org/activity-event;1&quot;,</span>
<a href="#l9.13"></a><span id="l9.13">                                             &quot;nsIActivityEvent&quot;, &quot;init&quot;);</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineminus">-var nsActWarning = Components.Constructor(&quot;@mozilla.org/activity-warning;1&quot;,</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineminus">-                                            &quot;nsIActivityWarning&quot;, &quot;init&quot;);</span>
<a href="#l9.16"></a><span id="l9.16"> </span>
<a href="#l9.17"></a><span id="l9.17"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineminus">-ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l9.19"></a><span id="l9.19"> ChromeUtils.import(&quot;resource://gre/modules/PluralForm.jsm&quot;);</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/gloda/log4moz.js&quot;);</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/gloda/public.js&quot;);</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/gloda/indexer.js&quot;);</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineplus">+const { Log4Moz } = ChromeUtils.import(&quot;resource:///modules/gloda/log4moz.js&quot;, null);</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineplus">+const { Gloda } = ChromeUtils.import(&quot;resource:///modules/gloda/public.js&quot;, null);</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineplus">+const { GlodaIndexer } = ChromeUtils.import(&quot;resource:///modules/gloda/indexer.js&quot;, null);</span>
<a href="#l9.26"></a><span id="l9.26"> </span>
<a href="#l9.27"></a><span id="l9.27"> /**</span>
<a href="#l9.28"></a><span id="l9.28">  * Gloda message indexer feedback.</span>
<a href="#l9.29"></a><span id="l9.29">  */</span>
<a href="#l9.30"></a><span id="l9.30"> var glodaIndexerActivity =</span>
<a href="#l9.31"></a><span id="l9.31"> {</span>
<a href="#l9.32"></a><span id="l9.32">   get log() {</span>
<a href="#l9.33"></a><span id="l9.33">     delete this.log;</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineat">@@ -36,33 +33,32 @@ var glodaIndexerActivity =</span>
<a href="#l9.35"></a><span id="l9.35">   },</span>
<a href="#l9.36"></a><span id="l9.36"> </span>
<a href="#l9.37"></a><span id="l9.37">   get bundle() {</span>
<a href="#l9.38"></a><span id="l9.38">     delete this.bundle;</span>
<a href="#l9.39"></a><span id="l9.39">     return this.bundle = Services.strings</span>
<a href="#l9.40"></a><span id="l9.40">       .createBundle(&quot;chrome://messenger/locale/activity.properties&quot;);</span>
<a href="#l9.41"></a><span id="l9.41">   },</span>
<a href="#l9.42"></a><span id="l9.42"> </span>
<a href="#l9.43"></a><span id="l9.43" class="difflineminus">-  getString: function(stringName) {</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineplus">+  getString(stringName) {</span>
<a href="#l9.45"></a><span id="l9.45">     try {</span>
<a href="#l9.46"></a><span id="l9.46">       return this.bundle.GetStringFromName(stringName);</span>
<a href="#l9.47"></a><span id="l9.47">     } catch (e) {</span>
<a href="#l9.48"></a><span id="l9.48">       this.log.error(&quot;error trying to get a string called: &quot; + stringName);</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineminus">-      throw(e);</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineplus">+      throw e;</span>
<a href="#l9.51"></a><span id="l9.51">     }</span>
<a href="#l9.52"></a><span id="l9.52">   },</span>
<a href="#l9.53"></a><span id="l9.53"> </span>
<a href="#l9.54"></a><span id="l9.54" class="difflineminus">-  init: function() {</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineplus">+  init() {</span>
<a href="#l9.56"></a><span id="l9.56">     // Register a listener with the Gloda indexer that receives notifications</span>
<a href="#l9.57"></a><span id="l9.57">     // about Gloda indexing status.  We wrap the listener in this function so we</span>
<a href="#l9.58"></a><span id="l9.58">     // can set |this| to the GlodaIndexerActivity object inside the listener.</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineminus">-    function listenerWrapper(...aArgs)</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineminus">-    {</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineplus">+    function listenerWrapper(...aArgs) {</span>
<a href="#l9.62"></a><span id="l9.62">       glodaIndexerActivity.listener(...aArgs);</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineminus">-    };</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineplus">+    }</span>
<a href="#l9.65"></a><span id="l9.65">     GlodaIndexer.addListener(listenerWrapper);</span>
<a href="#l9.66"></a><span id="l9.66">   },</span>
<a href="#l9.67"></a><span id="l9.67"> </span>
<a href="#l9.68"></a><span id="l9.68">   /**</span>
<a href="#l9.69"></a><span id="l9.69">    * Information about the current job.  An object with these properties:</span>
<a href="#l9.70"></a><span id="l9.70">    *</span>
<a href="#l9.71"></a><span id="l9.71">    *   folder       {String}</span>
<a href="#l9.72"></a><span id="l9.72">    *                the name of the folder being processed by the job</span>
<a href="#l9.73"></a><span id="l9.73" class="difflineat">@@ -74,30 +70,25 @@ var glodaIndexerActivity =</span>
<a href="#l9.74"></a><span id="l9.74">    *                the time at which we were first notified about the job</span>
<a href="#l9.75"></a><span id="l9.75">    *   totalItemNum {Number}</span>
<a href="#l9.76"></a><span id="l9.76">    *                the total number of messages being indexed in the job</span>
<a href="#l9.77"></a><span id="l9.77">    *   jobType      {String}</span>
<a href="#l9.78"></a><span id="l9.78">    *                The IndexinbJob jobType (ex: &quot;folder&quot;, &quot;folderCompact&quot;)</span>
<a href="#l9.79"></a><span id="l9.79">    */</span>
<a href="#l9.80"></a><span id="l9.80">   currentJob: null,</span>
<a href="#l9.81"></a><span id="l9.81"> </span>
<a href="#l9.82"></a><span id="l9.82" class="difflineminus">-  listener: function(aStatus, aFolder, aJobNumber, aItemNumber,</span>
<a href="#l9.83"></a><span id="l9.83" class="difflineminus">-                     aTotalItemNum, aJobType)</span>
<a href="#l9.84"></a><span id="l9.84" class="difflineminus">-  {</span>
<a href="#l9.85"></a><span id="l9.85" class="difflineplus">+  listener(aStatus, aFolder, aJobNumber, aItemNumber, aTotalItemNum, aJobType) {</span>
<a href="#l9.86"></a><span id="l9.86">     this.log.debug(&quot;Gloda Indexer Folder/Status: &quot; + aFolder + &quot;/&quot; + aStatus);</span>
<a href="#l9.87"></a><span id="l9.87">     this.log.debug(&quot;Gloda Indexer Job: &quot; + aJobNumber);</span>
<a href="#l9.88"></a><span id="l9.88">     this.log.debug(&quot;Gloda Indexer Item: &quot; + aItemNumber + &quot;/&quot; + aTotalItemNum);</span>
<a href="#l9.89"></a><span id="l9.89"> </span>
<a href="#l9.90"></a><span id="l9.90" class="difflineminus">-    if (aStatus == Gloda.kIndexerIdle)</span>
<a href="#l9.91"></a><span id="l9.91" class="difflineminus">-    {</span>
<a href="#l9.92"></a><span id="l9.92" class="difflineplus">+    if (aStatus == Gloda.kIndexerIdle) {</span>
<a href="#l9.93"></a><span id="l9.93">       if (this.currentJob)</span>
<a href="#l9.94"></a><span id="l9.94">         this.onJobCompleted();</span>
<a href="#l9.95"></a><span id="l9.95" class="difflineminus">-    }</span>
<a href="#l9.96"></a><span id="l9.96" class="difflineminus">-    else</span>
<a href="#l9.97"></a><span id="l9.97" class="difflineminus">-    {</span>
<a href="#l9.98"></a><span id="l9.98" class="difflineplus">+    } else {</span>
<a href="#l9.99"></a><span id="l9.99">       // If the job numbers have changed, the indexer has finished the job</span>
<a href="#l9.100"></a><span id="l9.100">       // we were previously tracking, so convert the corresponding process</span>
<a href="#l9.101"></a><span id="l9.101">       // into an event and start a new process to track the new job.</span>
<a href="#l9.102"></a><span id="l9.102">       if (this.currentJob &amp;&amp; aJobNumber != this.currentJob.jobNumber)</span>
<a href="#l9.103"></a><span id="l9.103">         this.onJobCompleted();</span>
<a href="#l9.104"></a><span id="l9.104"> </span>
<a href="#l9.105"></a><span id="l9.105">       // If we aren't tracking a job, either this is the first time we've been</span>
<a href="#l9.106"></a><span id="l9.106">       // called or the last job we were tracking was completed.  Either way,</span>
<a href="#l9.107"></a><span id="l9.107" class="difflineat">@@ -106,54 +97,53 @@ var glodaIndexerActivity =</span>
<a href="#l9.108"></a><span id="l9.108">         this.onJobBegun(aFolder, aJobNumber, aTotalItemNum, aJobType);</span>
<a href="#l9.109"></a><span id="l9.109"> </span>
<a href="#l9.110"></a><span id="l9.110">       // If there is only one item, don't bother creating a progress item.</span>
<a href="#l9.111"></a><span id="l9.111">       if (aTotalItemNum != 1)</span>
<a href="#l9.112"></a><span id="l9.112">         this.onJobProgress(aFolder, aItemNumber, aTotalItemNum);</span>
<a href="#l9.113"></a><span id="l9.113">     }</span>
<a href="#l9.114"></a><span id="l9.114">   },</span>
<a href="#l9.115"></a><span id="l9.115"> </span>
<a href="#l9.116"></a><span id="l9.116" class="difflineminus">-  onJobBegun: function(aFolder, aJobNumber, aTotalItemNum, aJobType) {</span>
<a href="#l9.117"></a><span id="l9.117" class="difflineplus">+  onJobBegun(aFolder, aJobNumber, aTotalItemNum, aJobType) {</span>
<a href="#l9.118"></a><span id="l9.118">     let displayText =</span>
<a href="#l9.119"></a><span id="l9.119">       aFolder ? this.getString(&quot;indexingFolder&quot;).replace(&quot;#1&quot;, aFolder)</span>
<a href="#l9.120"></a><span id="l9.120">               : this.getString(&quot;indexing&quot;);</span>
<a href="#l9.121"></a><span id="l9.121">     let process = new nsActProcess(displayText, Gloda);</span>
<a href="#l9.122"></a><span id="l9.122"> </span>
<a href="#l9.123"></a><span id="l9.123">     process.iconClass   = &quot;indexMail&quot;;</span>
<a href="#l9.124"></a><span id="l9.124">     process.contextType = &quot;account&quot;;</span>
<a href="#l9.125"></a><span id="l9.125">     process.contextObj  = aFolder;</span>
<a href="#l9.126"></a><span id="l9.126">     process.addSubject(aFolder);</span>
<a href="#l9.127"></a><span id="l9.127"> </span>
<a href="#l9.128"></a><span id="l9.128">     this.currentJob = {</span>
<a href="#l9.129"></a><span id="l9.129">       folder:       aFolder,</span>
<a href="#l9.130"></a><span id="l9.130">       jobNumber:    aJobNumber,</span>
<a href="#l9.131"></a><span id="l9.131" class="difflineminus">-      process:      process,</span>
<a href="#l9.132"></a><span id="l9.132" class="difflineplus">+      process,</span>
<a href="#l9.133"></a><span id="l9.133">       startTime:    new Date(),</span>
<a href="#l9.134"></a><span id="l9.134">       totalItemNum: aTotalItemNum,</span>
<a href="#l9.135"></a><span id="l9.135">       jobType:      aJobType,</span>
<a href="#l9.136"></a><span id="l9.136">     };</span>
<a href="#l9.137"></a><span id="l9.137"> </span>
<a href="#l9.138"></a><span id="l9.138">     this.activityMgr.addActivity(process);</span>
<a href="#l9.139"></a><span id="l9.139">   },</span>
<a href="#l9.140"></a><span id="l9.140"> </span>
<a href="#l9.141"></a><span id="l9.141" class="difflineminus">-  onJobProgress: function(aFolder, aItemNumber, aTotalItemNum) {</span>
<a href="#l9.142"></a><span id="l9.142" class="difflineplus">+  onJobProgress(aFolder, aItemNumber, aTotalItemNum) {</span>
<a href="#l9.143"></a><span id="l9.143">     this.currentJob.process.state = Ci.nsIActivityProcess.STATE_INPROGRESS;</span>
<a href="#l9.144"></a><span id="l9.144">     // The total number of items being processed in the job can change, as can</span>
<a href="#l9.145"></a><span id="l9.145">     // the folder being processed, since we sometimes get notified about a job</span>
<a href="#l9.146"></a><span id="l9.146">     // before it has determined these things, so we update them here.</span>
<a href="#l9.147"></a><span id="l9.147">     this.currentJob.folder = aFolder;</span>
<a href="#l9.148"></a><span id="l9.148">     this.currentJob.totalItemNum = aTotalItemNum;</span>
<a href="#l9.149"></a><span id="l9.149"> </span>
<a href="#l9.150"></a><span id="l9.150">     let statusText;</span>
<a href="#l9.151"></a><span id="l9.151">     if (aTotalItemNum == null) {</span>
<a href="#l9.152"></a><span id="l9.152">       statusText = aFolder ? this.getString(&quot;indexingFolderStatusVague&quot;)</span>
<a href="#l9.153"></a><span id="l9.153">                                .replace(&quot;#1&quot;, aFolder)</span>
<a href="#l9.154"></a><span id="l9.154">                            : this.getString(&quot;indexingStatusVague&quot;);</span>
<a href="#l9.155"></a><span id="l9.155" class="difflineminus">-    }</span>
<a href="#l9.156"></a><span id="l9.156" class="difflineminus">-    else {</span>
<a href="#l9.157"></a><span id="l9.157" class="difflineplus">+    } else {</span>
<a href="#l9.158"></a><span id="l9.158">       let percentComplete =</span>
<a href="#l9.159"></a><span id="l9.159">         aTotalItemNum == 0 ? 100 : parseInt(aItemNumber / aTotalItemNum * 100);</span>
<a href="#l9.160"></a><span id="l9.160">       // Note: we must replace the folder name placeholder last; otherwise,</span>
<a href="#l9.161"></a><span id="l9.161">       // if the name happens to contain another one of the placeholders, we'll</span>
<a href="#l9.162"></a><span id="l9.162">       // hork the name when replacing it.</span>
<a href="#l9.163"></a><span id="l9.163">       statusText = this.getString(aFolder ? &quot;indexingFolderStatusExact&quot;</span>
<a href="#l9.164"></a><span id="l9.164">                                           : &quot;indexingStatusExact&quot;);</span>
<a href="#l9.165"></a><span id="l9.165">       statusText = PluralForm.get(aTotalItemNum, statusText)</span>
<a href="#l9.166"></a><span id="l9.166" class="difflineat">@@ -161,17 +151,17 @@ var glodaIndexerActivity =</span>
<a href="#l9.167"></a><span id="l9.167">                      .replace(&quot;#2&quot;, aTotalItemNum)</span>
<a href="#l9.168"></a><span id="l9.168">                      .replace(&quot;#3&quot;, percentComplete)</span>
<a href="#l9.169"></a><span id="l9.169">                      .replace(&quot;#4&quot;, aFolder);</span>
<a href="#l9.170"></a><span id="l9.170">     }</span>
<a href="#l9.171"></a><span id="l9.171"> </span>
<a href="#l9.172"></a><span id="l9.172">     this.currentJob.process.setProgress(statusText, aItemNumber, aTotalItemNum);</span>
<a href="#l9.173"></a><span id="l9.173">   },</span>
<a href="#l9.174"></a><span id="l9.174"> </span>
<a href="#l9.175"></a><span id="l9.175" class="difflineminus">-  onJobCompleted: function() {</span>
<a href="#l9.176"></a><span id="l9.176" class="difflineplus">+  onJobCompleted() {</span>
<a href="#l9.177"></a><span id="l9.177">     this.currentJob.process.state = Ci.nsIActivityProcess.STATE_COMPLETED;</span>
<a href="#l9.178"></a><span id="l9.178"> </span>
<a href="#l9.179"></a><span id="l9.179">     this.activityMgr.removeActivity(this.currentJob.process.id);</span>
<a href="#l9.180"></a><span id="l9.180"> </span>
<a href="#l9.181"></a><span id="l9.181">     // this.currentJob.totalItemNum might still be null at this point</span>
<a href="#l9.182"></a><span id="l9.182">     // if we were first notified about the job before the indexer determined</span>
<a href="#l9.183"></a><span id="l9.183">     // the number of messages to index and then it didn't find any to index.</span>
<a href="#l9.184"></a><span id="l9.184">     let totalItemNum = this.currentJob.totalItemNum || 0;</span>
<a href="#l9.185"></a><span id="l9.185" class="difflineat">@@ -189,17 +179,17 @@ var glodaIndexerActivity =</span>
<a href="#l9.186"></a><span id="l9.186">       // if the name happens to contain another one of the placeholders, we'll</span>
<a href="#l9.187"></a><span id="l9.187">       // hork the name when replacing it.</span>
<a href="#l9.188"></a><span id="l9.188">       let displayText = PluralForm.get(totalItemNum,</span>
<a href="#l9.189"></a><span id="l9.189">                                        this.getString(&quot;indexedFolder&quot;))</span>
<a href="#l9.190"></a><span id="l9.190">                           .replace(&quot;#1&quot;, totalItemNum)</span>
<a href="#l9.191"></a><span id="l9.191">                           .replace(&quot;#2&quot;, this.currentJob.folder);</span>
<a href="#l9.192"></a><span id="l9.192"> </span>
<a href="#l9.193"></a><span id="l9.193">       let endTime = new Date();</span>
<a href="#l9.194"></a><span id="l9.194" class="difflineminus">-      let secondsElapsed = parseInt((endTime - this.currentJob.startTime)/1000);</span>
<a href="#l9.195"></a><span id="l9.195" class="difflineplus">+      let secondsElapsed = parseInt((endTime - this.currentJob.startTime) / 1000);</span>
<a href="#l9.196"></a><span id="l9.196"> </span>
<a href="#l9.197"></a><span id="l9.197">       let statusText = PluralForm.get(secondsElapsed,</span>
<a href="#l9.198"></a><span id="l9.198">                                       this.getString(&quot;indexedFolderStatus&quot;))</span>
<a href="#l9.199"></a><span id="l9.199">                          .replace(&quot;#1&quot;, secondsElapsed);</span>
<a href="#l9.200"></a><span id="l9.200"> </span>
<a href="#l9.201"></a><span id="l9.201">       let event = new nsActEvent(displayText,</span>
<a href="#l9.202"></a><span id="l9.202">                                  Gloda,</span>
<a href="#l9.203"></a><span id="l9.203">                                  statusText,</span>
<a href="#l9.204"></a><span id="l9.204" class="difflineat">@@ -213,11 +203,11 @@ var glodaIndexerActivity =</span>
<a href="#l9.205"></a><span id="l9.205">       let subjects = this.currentJob.process.getSubjects({});</span>
<a href="#l9.206"></a><span id="l9.206">       for (let subject of subjects)</span>
<a href="#l9.207"></a><span id="l9.207">         event.addSubject(subject);</span>
<a href="#l9.208"></a><span id="l9.208"> </span>
<a href="#l9.209"></a><span id="l9.209">       this.activityMgr.addActivity(event);</span>
<a href="#l9.210"></a><span id="l9.210">     }</span>
<a href="#l9.211"></a><span id="l9.211"> </span>
<a href="#l9.212"></a><span id="l9.212">     this.currentJob = null;</span>
<a href="#l9.213"></a><span id="l9.213" class="difflineminus">-  }</span>
<a href="#l9.214"></a><span id="l9.214" class="difflineplus">+  },</span>
<a href="#l9.215"></a><span id="l9.215"> </span>
<a href="#l9.216"></a><span id="l9.216"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1">rename from mail/components/activity/modules/moveCopy.js</span>
<a href="#l10.2"></a><span id="l10.2">rename to mail/components/activity/modules/moveCopy.jsm</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineminus">--- a/mail/components/activity/modules/moveCopy.js</span>
<a href="#l10.4"></a><span id="l10.4" class="difflineplus">+++ b/mail/components/activity/modules/moveCopy.jsm</span>
<a href="#l10.5"></a><span id="l10.5" class="difflineat">@@ -1,28 +1,23 @@</span>
<a href="#l10.6"></a><span id="l10.6"> /* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l10.7"></a><span id="l10.7"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l10.8"></a><span id="l10.8">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l10.9"></a><span id="l10.9">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l10.10"></a><span id="l10.10"> </span>
<a href="#l10.11"></a><span id="l10.11" class="difflineminus">-this.EXPORTED_SYMBOLS = ['moveCopyModule'];</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+this.EXPORTED_SYMBOLS = [&quot;moveCopyModule&quot;];</span>
<a href="#l10.13"></a><span id="l10.13"> </span>
<a href="#l10.14"></a><span id="l10.14" class="difflineminus">-var nsActProcess = Components.Constructor(&quot;@mozilla.org/activity-process;1&quot;,</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineminus">-                                            &quot;nsIActivityProcess&quot;, &quot;init&quot;);</span>
<a href="#l10.16"></a><span id="l10.16"> var nsActEvent = Components.Constructor(&quot;@mozilla.org/activity-event;1&quot;,</span>
<a href="#l10.17"></a><span id="l10.17">                                           &quot;nsIActivityEvent&quot;, &quot;init&quot;);</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineminus">-var nsActWarning = Components.Constructor(&quot;@mozilla.org/activity-warning;1&quot;,</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineminus">-                                            &quot;nsIActivityWarning&quot;, &quot;init&quot;);</span>
<a href="#l10.20"></a><span id="l10.20"> var nsMsgFolderFlags = Ci.nsMsgFolderFlags;</span>
<a href="#l10.21"></a><span id="l10.21"> </span>
<a href="#l10.22"></a><span id="l10.22"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l10.23"></a><span id="l10.23"> ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineminus">-ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l10.25"></a><span id="l10.25"> ChromeUtils.import(&quot;resource://gre/modules/PluralForm.jsm&quot;);</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/gloda/log4moz.js&quot;);</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineplus">+const { Log4Moz } = ChromeUtils.import(&quot;resource:///modules/gloda/log4moz.js&quot;, null);</span>
<a href="#l10.28"></a><span id="l10.28"> </span>
<a href="#l10.29"></a><span id="l10.29"> // This module provides a link between the move/copy code and the activity</span>
<a href="#l10.30"></a><span id="l10.30"> // manager.</span>
<a href="#l10.31"></a><span id="l10.31"> var moveCopyModule =</span>
<a href="#l10.32"></a><span id="l10.32"> {</span>
<a href="#l10.33"></a><span id="l10.33">   lastMessage: {},</span>
<a href="#l10.34"></a><span id="l10.34">   lastFolder: {},</span>
<a href="#l10.35"></a><span id="l10.35"> </span>
<a href="#l10.36"></a><span id="l10.36" class="difflineat">@@ -38,164 +33,156 @@ var moveCopyModule =</span>
<a href="#l10.37"></a><span id="l10.37">   },</span>
<a href="#l10.38"></a><span id="l10.38"> </span>
<a href="#l10.39"></a><span id="l10.39">   get bundle() {</span>
<a href="#l10.40"></a><span id="l10.40">     delete this.bundle;</span>
<a href="#l10.41"></a><span id="l10.41">     return this.bundle = Services.strings</span>
<a href="#l10.42"></a><span id="l10.42">       .createBundle(&quot;chrome://messenger/locale/activity.properties&quot;);</span>
<a href="#l10.43"></a><span id="l10.43">   },</span>
<a href="#l10.44"></a><span id="l10.44"> </span>
<a href="#l10.45"></a><span id="l10.45" class="difflineminus">-  getString: function(stringName) {</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineplus">+  getString(stringName) {</span>
<a href="#l10.47"></a><span id="l10.47">     try {</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineminus">-      return this.bundle.GetStringFromName(stringName)</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineplus">+      return this.bundle.GetStringFromName(stringName);</span>
<a href="#l10.50"></a><span id="l10.50">     } catch (e) {</span>
<a href="#l10.51"></a><span id="l10.51">       this.log.error(&quot;error trying to get a string called: &quot; + stringName);</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineminus">-      throw(e);</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineplus">+      throw e;</span>
<a href="#l10.54"></a><span id="l10.54">     }</span>
<a href="#l10.55"></a><span id="l10.55">   },</span>
<a href="#l10.56"></a><span id="l10.56"> </span>
<a href="#l10.57"></a><span id="l10.57" class="difflineminus">-  msgAdded : function(aMsg) {</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineplus">+  msgAdded(aMsg) {</span>
<a href="#l10.59"></a><span id="l10.59">   },</span>
<a href="#l10.60"></a><span id="l10.60"> </span>
<a href="#l10.61"></a><span id="l10.61" class="difflineminus">-  msgsDeleted : function(aMsgList) {</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineplus">+  msgsDeleted(aMsgList) {</span>
<a href="#l10.63"></a><span id="l10.63">     this.log.info(&quot;in msgsDeleted&quot;);</span>
<a href="#l10.64"></a><span id="l10.64"> </span>
<a href="#l10.65"></a><span id="l10.65">     let count = aMsgList.length;</span>
<a href="#l10.66"></a><span id="l10.66">     if (count &lt;= 0)</span>
<a href="#l10.67"></a><span id="l10.67">       return;</span>
<a href="#l10.68"></a><span id="l10.68"> </span>
<a href="#l10.69"></a><span id="l10.69">     let displayCount = count;</span>
<a href="#l10.70"></a><span id="l10.70">     // get the folder of the deleted messages</span>
<a href="#l10.71"></a><span id="l10.71">     let folder = aMsgList.queryElementAt(0, Ci.nsIMsgDBHdr).folder;</span>
<a href="#l10.72"></a><span id="l10.72"> </span>
<a href="#l10.73"></a><span id="l10.73" class="difflineminus">-    let activities = this.activityMgr.getActivities({})</span>
<a href="#l10.74"></a><span id="l10.74" class="difflineplus">+    let activities = this.activityMgr.getActivities({});</span>
<a href="#l10.75"></a><span id="l10.75">     if (activities.length &gt; 0 &amp;&amp;</span>
<a href="#l10.76"></a><span id="l10.76" class="difflineminus">-        activities[activities.length-1].id == this.lastMessage.id &amp;&amp;</span>
<a href="#l10.77"></a><span id="l10.77" class="difflineplus">+        activities[activities.length - 1].id == this.lastMessage.id &amp;&amp;</span>
<a href="#l10.78"></a><span id="l10.78">         this.lastMessage.type == &quot;deleteMail&quot; &amp;&amp;</span>
<a href="#l10.79"></a><span id="l10.79" class="difflineminus">-        this.lastMessage.folder == folder.prettyName)</span>
<a href="#l10.80"></a><span id="l10.80" class="difflineminus">-    {</span>
<a href="#l10.81"></a><span id="l10.81" class="difflineplus">+        this.lastMessage.folder == folder.prettyName) {</span>
<a href="#l10.82"></a><span id="l10.82">       displayCount += this.lastMessage.count;</span>
<a href="#l10.83"></a><span id="l10.83">       this.activityMgr.removeActivity(this.lastMessage.id);</span>
<a href="#l10.84"></a><span id="l10.84">     }</span>
<a href="#l10.85"></a><span id="l10.85"> </span>
<a href="#l10.86"></a><span id="l10.86">     this.lastMessage = {};</span>
<a href="#l10.87"></a><span id="l10.87">     let displayText = PluralForm.get(displayCount, this.getString(&quot;deletedMessages2&quot;));</span>
<a href="#l10.88"></a><span id="l10.88" class="difflineminus">-    displayText = displayText.replace(&quot;#1&quot;, displayCount)</span>
<a href="#l10.89"></a><span id="l10.89" class="difflineplus">+    displayText = displayText.replace(&quot;#1&quot;, displayCount);</span>
<a href="#l10.90"></a><span id="l10.90">     this.lastMessage.count = displayCount;</span>
<a href="#l10.91"></a><span id="l10.91" class="difflineminus">-    displayText = displayText.replace(&quot;#2&quot;, folder.prettyName)</span>
<a href="#l10.92"></a><span id="l10.92" class="difflineplus">+    displayText = displayText.replace(&quot;#2&quot;, folder.prettyName);</span>
<a href="#l10.93"></a><span id="l10.93">     this.lastMessage.folder = folder.prettyName;</span>
<a href="#l10.94"></a><span id="l10.94"> </span>
<a href="#l10.95"></a><span id="l10.95">     let statusText = folder.server.prettyName;</span>
<a href="#l10.96"></a><span id="l10.96"> </span>
<a href="#l10.97"></a><span id="l10.97">     // create an activity event</span>
<a href="#l10.98"></a><span id="l10.98">     let event = new nsActEvent(displayText,</span>
<a href="#l10.99"></a><span id="l10.99">                                folder,</span>
<a href="#l10.100"></a><span id="l10.100">                                statusText,</span>
<a href="#l10.101"></a><span id="l10.101">                                Date.now(),  // start time</span>
<a href="#l10.102"></a><span id="l10.102">                                Date.now()); // completion time</span>
<a href="#l10.103"></a><span id="l10.103"> </span>
<a href="#l10.104"></a><span id="l10.104">     event.iconClass = &quot;deleteMail&quot;;</span>
<a href="#l10.105"></a><span id="l10.105">     this.lastMessage.type = event.iconClass;</span>
<a href="#l10.106"></a><span id="l10.106"> </span>
<a href="#l10.107"></a><span id="l10.107" class="difflineminus">-    for (let i = 0; i &lt; count; i++)</span>
<a href="#l10.108"></a><span id="l10.108" class="difflineminus">-    {</span>
<a href="#l10.109"></a><span id="l10.109" class="difflineplus">+    for (let i = 0; i &lt; count; i++) {</span>
<a href="#l10.110"></a><span id="l10.110">       let msgHdr = aMsgList.queryElementAt(i, Ci.nsIMsgDBHdr);</span>
<a href="#l10.111"></a><span id="l10.111">       event.addSubject(msgHdr.messageId);</span>
<a href="#l10.112"></a><span id="l10.112">     }</span>
<a href="#l10.113"></a><span id="l10.113"> </span>
<a href="#l10.114"></a><span id="l10.114">     this.lastMessage.id = this.activityMgr.addActivity(event);</span>
<a href="#l10.115"></a><span id="l10.115">   },</span>
<a href="#l10.116"></a><span id="l10.116"> </span>
<a href="#l10.117"></a><span id="l10.117" class="difflineminus">-  msgsMoveCopyCompleted : function(aMove, aSrcMsgList, aDestFolder) {</span>
<a href="#l10.118"></a><span id="l10.118" class="difflineplus">+  msgsMoveCopyCompleted(aMove, aSrcMsgList, aDestFolder) {</span>
<a href="#l10.119"></a><span id="l10.119">     try {</span>
<a href="#l10.120"></a><span id="l10.120">       this.log.info(&quot;in msgsMoveCopyCompleted&quot;);</span>
<a href="#l10.121"></a><span id="l10.121"> </span>
<a href="#l10.122"></a><span id="l10.122">       let count = aSrcMsgList.length;</span>
<a href="#l10.123"></a><span id="l10.123">       if (count &lt;= 0)</span>
<a href="#l10.124"></a><span id="l10.124">         return;</span>
<a href="#l10.125"></a><span id="l10.125"> </span>
<a href="#l10.126"></a><span id="l10.126">       // get the folder of the moved/copied messages</span>
<a href="#l10.127"></a><span id="l10.127">       let folder = aSrcMsgList.queryElementAt(0, Ci.nsIMsgDBHdr).folder;</span>
<a href="#l10.128"></a><span id="l10.128">       this.log.info(&quot;got folder&quot;);</span>
<a href="#l10.129"></a><span id="l10.129"> </span>
<a href="#l10.130"></a><span id="l10.130">       let displayCount = count;</span>
<a href="#l10.131"></a><span id="l10.131"> </span>
<a href="#l10.132"></a><span id="l10.132">       let activities = this.activityMgr.getActivities({});</span>
<a href="#l10.133"></a><span id="l10.133">       if (activities.length &gt; 0 &amp;&amp;</span>
<a href="#l10.134"></a><span id="l10.134" class="difflineminus">-          activities[activities.length-1].id == this.lastMessage.id &amp;&amp;</span>
<a href="#l10.135"></a><span id="l10.135" class="difflineplus">+          activities[activities.length - 1].id == this.lastMessage.id &amp;&amp;</span>
<a href="#l10.136"></a><span id="l10.136">           this.lastMessage.type == (aMove ? &quot;moveMail&quot; : &quot;copyMail&quot;) &amp;&amp;</span>
<a href="#l10.137"></a><span id="l10.137">           this.lastMessage.sourceFolder == folder.prettyName &amp;&amp;</span>
<a href="#l10.138"></a><span id="l10.138" class="difflineminus">-          this.lastMessage.destFolder == aDestFolder.prettyName)</span>
<a href="#l10.139"></a><span id="l10.139" class="difflineminus">-      {</span>
<a href="#l10.140"></a><span id="l10.140" class="difflineplus">+          this.lastMessage.destFolder == aDestFolder.prettyName) {</span>
<a href="#l10.141"></a><span id="l10.141">         displayCount += this.lastMessage.count;</span>
<a href="#l10.142"></a><span id="l10.142">         this.activityMgr.removeActivity(this.lastMessage.id);</span>
<a href="#l10.143"></a><span id="l10.143">       }</span>
<a href="#l10.144"></a><span id="l10.144"> </span>
<a href="#l10.145"></a><span id="l10.145" class="difflineminus">-      let statusText = '';</span>
<a href="#l10.146"></a><span id="l10.146" class="difflineminus">-      if (folder.server != aDestFolder.server)</span>
<a href="#l10.147"></a><span id="l10.147" class="difflineminus">-      {</span>
<a href="#l10.148"></a><span id="l10.148" class="difflineplus">+      let statusText = &quot;&quot;;</span>
<a href="#l10.149"></a><span id="l10.149" class="difflineplus">+      if (folder.server != aDestFolder.server) {</span>
<a href="#l10.150"></a><span id="l10.150">         statusText = this.getString(&quot;fromServerToServer&quot;);</span>
<a href="#l10.151"></a><span id="l10.151">         statusText = statusText.replace(&quot;#1&quot;, folder.server.prettyName);</span>
<a href="#l10.152"></a><span id="l10.152">         statusText = statusText.replace(&quot;#2&quot;, aDestFolder.server.prettyName);</span>
<a href="#l10.153"></a><span id="l10.153" class="difflineminus">-      }</span>
<a href="#l10.154"></a><span id="l10.154" class="difflineminus">-      else</span>
<a href="#l10.155"></a><span id="l10.155" class="difflineminus">-      {</span>
<a href="#l10.156"></a><span id="l10.156" class="difflineplus">+      } else {</span>
<a href="#l10.157"></a><span id="l10.157">         statusText = folder.server.prettyName;</span>
<a href="#l10.158"></a><span id="l10.158">       }</span>
<a href="#l10.159"></a><span id="l10.159"> </span>
<a href="#l10.160"></a><span id="l10.160">       this.lastMessage = {};</span>
<a href="#l10.161"></a><span id="l10.161">       let displayText;</span>
<a href="#l10.162"></a><span id="l10.162">       if (aMove)</span>
<a href="#l10.163"></a><span id="l10.163">         displayText = PluralForm.get(displayCount,</span>
<a href="#l10.164"></a><span id="l10.164">                                      this.getString(&quot;movedMessages&quot;));</span>
<a href="#l10.165"></a><span id="l10.165">       else</span>
<a href="#l10.166"></a><span id="l10.166">         displayText = PluralForm.get(displayCount,</span>
<a href="#l10.167"></a><span id="l10.167">                                      this.getString(&quot;copiedMessages&quot;));</span>
<a href="#l10.168"></a><span id="l10.168"> </span>
<a href="#l10.169"></a><span id="l10.169" class="difflineminus">-      displayText = displayText.replace(&quot;#1&quot;, displayCount)</span>
<a href="#l10.170"></a><span id="l10.170" class="difflineplus">+      displayText = displayText.replace(&quot;#1&quot;, displayCount);</span>
<a href="#l10.171"></a><span id="l10.171">       this.lastMessage.count = displayCount;</span>
<a href="#l10.172"></a><span id="l10.172" class="difflineminus">-      displayText = displayText.replace(&quot;#2&quot;, folder.prettyName)</span>
<a href="#l10.173"></a><span id="l10.173" class="difflineplus">+      displayText = displayText.replace(&quot;#2&quot;, folder.prettyName);</span>
<a href="#l10.174"></a><span id="l10.174">       this.lastMessage.sourceFolder = folder.prettyName;</span>
<a href="#l10.175"></a><span id="l10.175" class="difflineminus">-      displayText = displayText.replace(&quot;#3&quot;, aDestFolder.prettyName)</span>
<a href="#l10.176"></a><span id="l10.176" class="difflineplus">+      displayText = displayText.replace(&quot;#3&quot;, aDestFolder.prettyName);</span>
<a href="#l10.177"></a><span id="l10.177">       this.lastMessage.destFolder = aDestFolder.prettyName;</span>
<a href="#l10.178"></a><span id="l10.178"> </span>
<a href="#l10.179"></a><span id="l10.179">       // create an activity event</span>
<a href="#l10.180"></a><span id="l10.180">       let event = new nsActEvent(displayText,</span>
<a href="#l10.181"></a><span id="l10.181">                                  folder,</span>
<a href="#l10.182"></a><span id="l10.182">                                  statusText,</span>
<a href="#l10.183"></a><span id="l10.183">                                  Date.now(),    // start time</span>
<a href="#l10.184"></a><span id="l10.184">                                  Date.now());   // completion time</span>
<a href="#l10.185"></a><span id="l10.185">       event.iconClass = aMove ? &quot;moveMail&quot; : &quot;copyMail&quot;;</span>
<a href="#l10.186"></a><span id="l10.186">       this.lastMessage.type = event.iconClass;</span>
<a href="#l10.187"></a><span id="l10.187"> </span>
<a href="#l10.188"></a><span id="l10.188" class="difflineminus">-      for (let i = 0; i &lt; count; i++)</span>
<a href="#l10.189"></a><span id="l10.189" class="difflineminus">-      {</span>
<a href="#l10.190"></a><span id="l10.190" class="difflineplus">+      for (let i = 0; i &lt; count; i++) {</span>
<a href="#l10.191"></a><span id="l10.191">         let msgHdr = aSrcMsgList.queryElementAt(i, Ci.nsIMsgDBHdr);</span>
<a href="#l10.192"></a><span id="l10.192">         event.addSubject(msgHdr.messageId);</span>
<a href="#l10.193"></a><span id="l10.193">       }</span>
<a href="#l10.194"></a><span id="l10.194">       this.lastMessage.id = this.activityMgr.addActivity(event);</span>
<a href="#l10.195"></a><span id="l10.195">     } catch (e) {</span>
<a href="#l10.196"></a><span id="l10.196" class="difflineminus">-      this.log.error(&quot;Exception: &quot; + e)</span>
<a href="#l10.197"></a><span id="l10.197" class="difflineplus">+      this.log.error(&quot;Exception: &quot; + e);</span>
<a href="#l10.198"></a><span id="l10.198">     }</span>
<a href="#l10.199"></a><span id="l10.199">   },</span>
<a href="#l10.200"></a><span id="l10.200"> </span>
<a href="#l10.201"></a><span id="l10.201" class="difflineminus">-  folderAdded: function(aFolder) {</span>
<a href="#l10.202"></a><span id="l10.202" class="difflineplus">+  folderAdded(aFolder) {</span>
<a href="#l10.203"></a><span id="l10.203">   },</span>
<a href="#l10.204"></a><span id="l10.204"> </span>
<a href="#l10.205"></a><span id="l10.205" class="difflineminus">-  folderDeleted : function(aFolder) {</span>
<a href="#l10.206"></a><span id="l10.206" class="difflineplus">+  folderDeleted(aFolder) {</span>
<a href="#l10.207"></a><span id="l10.207">     let server;</span>
<a href="#l10.208"></a><span id="l10.208">     try {</span>
<a href="#l10.209"></a><span id="l10.209">       // When a new account is created we get this notification with an empty named</span>
<a href="#l10.210"></a><span id="l10.210">       // folder that can't return its server. Ignore it.</span>
<a href="#l10.211"></a><span id="l10.211">       // TODO: find out what it is.</span>
<a href="#l10.212"></a><span id="l10.212">       server = aFolder.server;</span>
<a href="#l10.213"></a><span id="l10.213">       // If the account has been removed, we're going to ignore this notification.</span>
<a href="#l10.214"></a><span id="l10.214">       MailServices.accounts.FindServer(server.username, server.hostName, server.type);</span>
<a href="#l10.215"></a><span id="l10.215" class="difflineminus">-    }</span>
<a href="#l10.216"></a><span id="l10.216" class="difflineminus">-    catch(ex) {return;}</span>
<a href="#l10.217"></a><span id="l10.217" class="difflineplus">+    } catch (ex) { return; }</span>
<a href="#l10.218"></a><span id="l10.218"> </span>
<a href="#l10.219"></a><span id="l10.219">     let displayText;</span>
<a href="#l10.220"></a><span id="l10.220">     let statusText = server.prettyName;</span>
<a href="#l10.221"></a><span id="l10.221"> </span>
<a href="#l10.222"></a><span id="l10.222">     // Display a different message depending on whether we emptied the trash</span>
<a href="#l10.223"></a><span id="l10.223">     // or actually deleted a folder</span>
<a href="#l10.224"></a><span id="l10.224">     if (aFolder.isSpecialFolder(nsMsgFolderFlags.Trash, false))</span>
<a href="#l10.225"></a><span id="l10.225">       displayText = this.getString(&quot;emptiedTrash&quot;);</span>
<a href="#l10.226"></a><span id="l10.226" class="difflineat">@@ -214,69 +201,63 @@ var moveCopyModule =</span>
<a href="#l10.227"></a><span id="l10.227"> </span>
<a href="#l10.228"></a><span id="l10.228">     // When we rename, we get a delete event as well as a rename, so store</span>
<a href="#l10.229"></a><span id="l10.229">     // the last folder we deleted</span>
<a href="#l10.230"></a><span id="l10.230">     this.lastFolder = {};</span>
<a href="#l10.231"></a><span id="l10.231">     this.lastFolder.URI = aFolder.URI;</span>
<a href="#l10.232"></a><span id="l10.232">     this.lastFolder.event = this.activityMgr.addActivity(event);</span>
<a href="#l10.233"></a><span id="l10.233">   },</span>
<a href="#l10.234"></a><span id="l10.234"> </span>
<a href="#l10.235"></a><span id="l10.235" class="difflineminus">-  folderMoveCopyCompleted: function(aMove, aSrcFolder, aDestFolder) {</span>
<a href="#l10.236"></a><span id="l10.236" class="difflineplus">+  folderMoveCopyCompleted(aMove, aSrcFolder, aDestFolder) {</span>
<a href="#l10.237"></a><span id="l10.237">     this.log.info(&quot;in folderMoveCopyCompleted, aMove = &quot; + aMove);</span>
<a href="#l10.238"></a><span id="l10.238"> </span>
<a href="#l10.239"></a><span id="l10.239">     let displayText;</span>
<a href="#l10.240"></a><span id="l10.240">     if (aMove)</span>
<a href="#l10.241"></a><span id="l10.241">       displayText = this.getString(&quot;movedFolder&quot;);</span>
<a href="#l10.242"></a><span id="l10.242">     else</span>
<a href="#l10.243"></a><span id="l10.243">       displayText = this.getString(&quot;copiedFolder&quot;);</span>
<a href="#l10.244"></a><span id="l10.244"> </span>
<a href="#l10.245"></a><span id="l10.245" class="difflineminus">-    displayText = displayText.replace('#1', aSrcFolder.prettyName);</span>
<a href="#l10.246"></a><span id="l10.246" class="difflineminus">-    displayText = displayText.replace('#2', aDestFolder.prettyName);</span>
<a href="#l10.247"></a><span id="l10.247" class="difflineplus">+    displayText = displayText.replace(&quot;#1&quot;, aSrcFolder.prettyName);</span>
<a href="#l10.248"></a><span id="l10.248" class="difflineplus">+    displayText = displayText.replace(&quot;#2&quot;, aDestFolder.prettyName);</span>
<a href="#l10.249"></a><span id="l10.249"> </span>
<a href="#l10.250"></a><span id="l10.250" class="difflineminus">-    let statusText = '';</span>
<a href="#l10.251"></a><span id="l10.251" class="difflineminus">-    if (aSrcFolder.server != aDestFolder.server)</span>
<a href="#l10.252"></a><span id="l10.252" class="difflineminus">-    {</span>
<a href="#l10.253"></a><span id="l10.253" class="difflineplus">+    let statusText = &quot;&quot;;</span>
<a href="#l10.254"></a><span id="l10.254" class="difflineplus">+    if (aSrcFolder.server != aDestFolder.server) {</span>
<a href="#l10.255"></a><span id="l10.255">       statusText = this.getString(&quot;fromServerToServer&quot;);</span>
<a href="#l10.256"></a><span id="l10.256">       statusText = statusText.replace(&quot;#1&quot;, aSrcFolder.server.prettyName);</span>
<a href="#l10.257"></a><span id="l10.257">       statusText = statusText.replace(&quot;#2&quot;, aDestFolder.server.prettyName);</span>
<a href="#l10.258"></a><span id="l10.258" class="difflineminus">-    }</span>
<a href="#l10.259"></a><span id="l10.259" class="difflineminus">-    else</span>
<a href="#l10.260"></a><span id="l10.260" class="difflineminus">-    {</span>
<a href="#l10.261"></a><span id="l10.261" class="difflineplus">+    } else {</span>
<a href="#l10.262"></a><span id="l10.262">       statusText = aSrcFolder.server.prettyName;</span>
<a href="#l10.263"></a><span id="l10.263">     }</span>
<a href="#l10.264"></a><span id="l10.264">     // create an activity event</span>
<a href="#l10.265"></a><span id="l10.265">     let event = new nsActEvent(displayText,</span>
<a href="#l10.266"></a><span id="l10.266">                                aSrcFolder.server,</span>
<a href="#l10.267"></a><span id="l10.267">                                statusText,</span>
<a href="#l10.268"></a><span id="l10.268">                                Date.now(),    // start time</span>
<a href="#l10.269"></a><span id="l10.269">                                Date.now());   // completion time</span>
<a href="#l10.270"></a><span id="l10.270"> </span>
<a href="#l10.271"></a><span id="l10.271">     event.addSubject(aSrcFolder);</span>
<a href="#l10.272"></a><span id="l10.272">     event.addSubject(aDestFolder);</span>
<a href="#l10.273"></a><span id="l10.273">     event.iconClass = aMove ? &quot;moveMail&quot; : &quot;copyMail&quot;;</span>
<a href="#l10.274"></a><span id="l10.274"> </span>
<a href="#l10.275"></a><span id="l10.275">     this.activityMgr.addActivity(event);</span>
<a href="#l10.276"></a><span id="l10.276">   },</span>
<a href="#l10.277"></a><span id="l10.277"> </span>
<a href="#l10.278"></a><span id="l10.278" class="difflineminus">-  folderRenamed: function(aOrigFolder, aNewFolder) {</span>
<a href="#l10.279"></a><span id="l10.279" class="difflineminus">-    this.log.info(&quot;in folderRenamed, aOrigFolder = &quot;+ aOrigFolder.prettyName+&quot;, aNewFolder = &quot;+</span>
<a href="#l10.280"></a><span id="l10.280" class="difflineminus">-             aNewFolder.prettyName);</span>
<a href="#l10.281"></a><span id="l10.281" class="difflineplus">+  folderRenamed(aOrigFolder, aNewFolder) {</span>
<a href="#l10.282"></a><span id="l10.282" class="difflineplus">+    this.log.info(&quot;in folderRenamed, aOrigFolder = &quot; + aOrigFolder.prettyName +</span>
<a href="#l10.283"></a><span id="l10.283" class="difflineplus">+                  &quot;, aNewFolder = &quot; + aNewFolder.prettyName);</span>
<a href="#l10.284"></a><span id="l10.284"> </span>
<a href="#l10.285"></a><span id="l10.285">     let displayText;</span>
<a href="#l10.286"></a><span id="l10.286">     let statusText = aNewFolder.server.prettyName;</span>
<a href="#l10.287"></a><span id="l10.287"> </span>
<a href="#l10.288"></a><span id="l10.288">     // Display a different message depending on whether we moved the folder</span>
<a href="#l10.289"></a><span id="l10.289">     // to the trash or actually renamed the folder.</span>
<a href="#l10.290"></a><span id="l10.290" class="difflineminus">-    if (aNewFolder.isSpecialFolder(nsMsgFolderFlags.Trash, true))</span>
<a href="#l10.291"></a><span id="l10.291" class="difflineminus">-    {</span>
<a href="#l10.292"></a><span id="l10.292" class="difflineplus">+    if (aNewFolder.isSpecialFolder(nsMsgFolderFlags.Trash, true)) {</span>
<a href="#l10.293"></a><span id="l10.293">       displayText = this.getString(&quot;movedFolderToTrash&quot;);</span>
<a href="#l10.294"></a><span id="l10.294">       displayText = displayText.replace(&quot;#1&quot;, aOrigFolder.prettyName);</span>
<a href="#l10.295"></a><span id="l10.295" class="difflineminus">-    }</span>
<a href="#l10.296"></a><span id="l10.296" class="difflineminus">-    else</span>
<a href="#l10.297"></a><span id="l10.297" class="difflineminus">-    {</span>
<a href="#l10.298"></a><span id="l10.298" class="difflineplus">+    } else {</span>
<a href="#l10.299"></a><span id="l10.299">       displayText = this.getString(&quot;renamedFolder&quot;);</span>
<a href="#l10.300"></a><span id="l10.300">       displayText = displayText.replace(&quot;#1&quot;, aOrigFolder.prettyName);</span>
<a href="#l10.301"></a><span id="l10.301">       displayText = displayText.replace(&quot;#2&quot;, aNewFolder.prettyName);</span>
<a href="#l10.302"></a><span id="l10.302">     }</span>
<a href="#l10.303"></a><span id="l10.303"> </span>
<a href="#l10.304"></a><span id="l10.304">     // When renaming a folder, a delete event is always fired first</span>
<a href="#l10.305"></a><span id="l10.305">     if (this.lastFolder.URI == aOrigFolder.URI)</span>
<a href="#l10.306"></a><span id="l10.306">       this.activityMgr.removeActivity(this.lastFolder.event);</span>
<a href="#l10.307"></a><span id="l10.307" class="difflineat">@@ -289,85 +270,81 @@ var moveCopyModule =</span>
<a href="#l10.308"></a><span id="l10.308">                                Date.now()); // completion time</span>
<a href="#l10.309"></a><span id="l10.309"> </span>
<a href="#l10.310"></a><span id="l10.310">     event.addSubject(aOrigFolder);</span>
<a href="#l10.311"></a><span id="l10.311">     event.addSubject(aNewFolder);</span>
<a href="#l10.312"></a><span id="l10.312"> </span>
<a href="#l10.313"></a><span id="l10.313">     this.activityMgr.addActivity(event);</span>
<a href="#l10.314"></a><span id="l10.314">   },</span>
<a href="#l10.315"></a><span id="l10.315"> </span>
<a href="#l10.316"></a><span id="l10.316" class="difflineminus">-  itemEvent: function(aItem, aEvent, aData, aString) {</span>
<a href="#l10.317"></a><span id="l10.317" class="difflineplus">+  itemEvent(aItem, aEvent, aData, aString) {</span>
<a href="#l10.318"></a><span id="l10.318">     if (aEvent == &quot;UnincorporatedMessageMoved&quot;) {</span>
<a href="#l10.319"></a><span id="l10.319">       let srcFolder = aItem.QueryInterface(Ci.nsIMsgFolder);</span>
<a href="#l10.320"></a><span id="l10.320">       let msgHdr = aData.QueryInterface(Ci.nsIMsgDBHdr);</span>
<a href="#l10.321"></a><span id="l10.321"> </span>
<a href="#l10.322"></a><span id="l10.322">       try {</span>
<a href="#l10.323"></a><span id="l10.323">         this.log.info(&quot;in UnincorporatedMessageMoved&quot;);</span>
<a href="#l10.324"></a><span id="l10.324"> </span>
<a href="#l10.325"></a><span id="l10.325">         // get the folder of the moved/copied messages</span>
<a href="#l10.326"></a><span id="l10.326">         let destFolder = msgHdr.folder;</span>
<a href="#l10.327"></a><span id="l10.327">         this.log.info(&quot;got folder&quot;);</span>
<a href="#l10.328"></a><span id="l10.328"> </span>
<a href="#l10.329"></a><span id="l10.329">         let displayCount = 1;</span>
<a href="#l10.330"></a><span id="l10.330"> </span>
<a href="#l10.331"></a><span id="l10.331">         let activities = this.activityMgr.getActivities({});</span>
<a href="#l10.332"></a><span id="l10.332">         if (activities.length &gt; 0 &amp;&amp;</span>
<a href="#l10.333"></a><span id="l10.333" class="difflineminus">-            activities[activities.length-1].id == this.lastMessage.id &amp;&amp;</span>
<a href="#l10.334"></a><span id="l10.334" class="difflineplus">+            activities[activities.length - 1].id == this.lastMessage.id &amp;&amp;</span>
<a href="#l10.335"></a><span id="l10.335">             this.lastMessage.type == &quot;moveMail&quot; &amp;&amp;</span>
<a href="#l10.336"></a><span id="l10.336">             this.lastMessage.sourceFolder == srcFolder.prettyName &amp;&amp;</span>
<a href="#l10.337"></a><span id="l10.337" class="difflineminus">-            this.lastMessage.destFolder == destFolder.prettyName)</span>
<a href="#l10.338"></a><span id="l10.338" class="difflineminus">-        {</span>
<a href="#l10.339"></a><span id="l10.339" class="difflineplus">+            this.lastMessage.destFolder == destFolder.prettyName) {</span>
<a href="#l10.340"></a><span id="l10.340">           displayCount += this.lastMessage.count;</span>
<a href="#l10.341"></a><span id="l10.341">           this.activityMgr.removeActivity(this.lastMessage.id);</span>
<a href="#l10.342"></a><span id="l10.342">         }</span>
<a href="#l10.343"></a><span id="l10.343"> </span>
<a href="#l10.344"></a><span id="l10.344" class="difflineminus">-        let statusText = '';</span>
<a href="#l10.345"></a><span id="l10.345" class="difflineminus">-        if (srcFolder.server != destFolder.server)</span>
<a href="#l10.346"></a><span id="l10.346" class="difflineminus">-        {</span>
<a href="#l10.347"></a><span id="l10.347" class="difflineplus">+        let statusText = &quot;&quot;;</span>
<a href="#l10.348"></a><span id="l10.348" class="difflineplus">+        if (srcFolder.server != destFolder.server) {</span>
<a href="#l10.349"></a><span id="l10.349">           statusText = this.getString(&quot;fromServerToServer&quot;);</span>
<a href="#l10.350"></a><span id="l10.350">           statusText = statusText.replace(&quot;#1&quot;, srcFolder.server.prettyName);</span>
<a href="#l10.351"></a><span id="l10.351">           statusText = statusText.replace(&quot;#2&quot;, destFolder.server.prettyName);</span>
<a href="#l10.352"></a><span id="l10.352" class="difflineminus">-        }</span>
<a href="#l10.353"></a><span id="l10.353" class="difflineminus">-        else</span>
<a href="#l10.354"></a><span id="l10.354" class="difflineminus">-        {</span>
<a href="#l10.355"></a><span id="l10.355" class="difflineplus">+        } else {</span>
<a href="#l10.356"></a><span id="l10.356">           statusText = srcFolder.server.prettyName;</span>
<a href="#l10.357"></a><span id="l10.357">         }</span>
<a href="#l10.358"></a><span id="l10.358"> </span>
<a href="#l10.359"></a><span id="l10.359">         this.lastMessage = {};</span>
<a href="#l10.360"></a><span id="l10.360">         let displayText;</span>
<a href="#l10.361"></a><span id="l10.361">         displayText = PluralForm.get(displayCount,</span>
<a href="#l10.362"></a><span id="l10.362">                                      this.getString(&quot;movedMessages&quot;));</span>
<a href="#l10.363"></a><span id="l10.363"> </span>
<a href="#l10.364"></a><span id="l10.364" class="difflineminus">-        displayText = displayText.replace(&quot;#1&quot;, displayCount)</span>
<a href="#l10.365"></a><span id="l10.365" class="difflineplus">+        displayText = displayText.replace(&quot;#1&quot;, displayCount);</span>
<a href="#l10.366"></a><span id="l10.366">         this.lastMessage.count = displayCount;</span>
<a href="#l10.367"></a><span id="l10.367" class="difflineminus">-        displayText = displayText.replace(&quot;#2&quot;, srcFolder.prettyName)</span>
<a href="#l10.368"></a><span id="l10.368" class="difflineplus">+        displayText = displayText.replace(&quot;#2&quot;, srcFolder.prettyName);</span>
<a href="#l10.369"></a><span id="l10.369">         this.lastMessage.sourceFolder = srcFolder.prettyName;</span>
<a href="#l10.370"></a><span id="l10.370" class="difflineminus">-        displayText = displayText.replace(&quot;#3&quot;, destFolder.prettyName)</span>
<a href="#l10.371"></a><span id="l10.371" class="difflineplus">+        displayText = displayText.replace(&quot;#3&quot;, destFolder.prettyName);</span>
<a href="#l10.372"></a><span id="l10.372">         this.lastMessage.destFolder = destFolder.prettyName;</span>
<a href="#l10.373"></a><span id="l10.373"> </span>
<a href="#l10.374"></a><span id="l10.374">         // create an activity event</span>
<a href="#l10.375"></a><span id="l10.375">         let event = new nsActEvent(displayText,</span>
<a href="#l10.376"></a><span id="l10.376">                                    srcFolder,</span>
<a href="#l10.377"></a><span id="l10.377">                                    statusText,</span>
<a href="#l10.378"></a><span id="l10.378">                                    Date.now(),    // start time</span>
<a href="#l10.379"></a><span id="l10.379">                                    Date.now());   // completion time</span>
<a href="#l10.380"></a><span id="l10.380"> </span>
<a href="#l10.381"></a><span id="l10.381">         event.iconClass = &quot;moveMail&quot;;</span>
<a href="#l10.382"></a><span id="l10.382">         this.lastMessage.type = event.iconClass;</span>
<a href="#l10.383"></a><span id="l10.383">         event.addSubject(msgHdr.messageId);</span>
<a href="#l10.384"></a><span id="l10.384">         this.lastMessage.id = this.activityMgr.addActivity(event);</span>
<a href="#l10.385"></a><span id="l10.385">       } catch (e) {</span>
<a href="#l10.386"></a><span id="l10.386" class="difflineminus">-        this.log.error(&quot;Exception: &quot; + e)</span>
<a href="#l10.387"></a><span id="l10.387" class="difflineplus">+        this.log.error(&quot;Exception: &quot; + e);</span>
<a href="#l10.388"></a><span id="l10.388">       }</span>
<a href="#l10.389"></a><span id="l10.389">     }</span>
<a href="#l10.390"></a><span id="l10.390">   },</span>
<a href="#l10.391"></a><span id="l10.391"> </span>
<a href="#l10.392"></a><span id="l10.392" class="difflineminus">-  init: function() {</span>
<a href="#l10.393"></a><span id="l10.393" class="difflineplus">+  init() {</span>
<a href="#l10.394"></a><span id="l10.394">     // XXX when do we need to remove ourselves?</span>
<a href="#l10.395"></a><span id="l10.395">     MailServices.mfn.addListener(this,</span>
<a href="#l10.396"></a><span id="l10.396">                                  MailServices.mfn.msgsDeleted |</span>
<a href="#l10.397"></a><span id="l10.397">                                  MailServices.mfn.msgsMoveCopyCompleted |</span>
<a href="#l10.398"></a><span id="l10.398">                                  MailServices.mfn.folderDeleted |</span>
<a href="#l10.399"></a><span id="l10.399">                                  MailServices.mfn.folderMoveCopyCompleted |</span>
<a href="#l10.400"></a><span id="l10.400">                                  MailServices.mfn.folderRenamed |</span>
<a href="#l10.401"></a><span id="l10.401">                                  MailServices.mfn.itemEvent);</span>
<a href="#l10.402"></a><span id="l10.402" class="difflineminus">-  }</span>
<a href="#l10.403"></a><span id="l10.403" class="difflineminus">-}</span>
<a href="#l10.404"></a><span id="l10.404" class="difflineplus">+  },</span>
<a href="#l10.405"></a><span id="l10.405" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1">rename from mail/components/activity/modules/pop3Download.js</span>
<a href="#l11.2"></a><span id="l11.2">rename to mail/components/activity/modules/pop3Download.jsm</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineminus">--- a/mail/components/activity/modules/pop3Download.js</span>
<a href="#l11.4"></a><span id="l11.4" class="difflineplus">+++ b/mail/components/activity/modules/pop3Download.jsm</span>
<a href="#l11.5"></a><span id="l11.5" class="difflineat">@@ -1,27 +1,22 @@</span>
<a href="#l11.6"></a><span id="l11.6"> /* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l11.7"></a><span id="l11.7"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l11.8"></a><span id="l11.8">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l11.9"></a><span id="l11.9">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l11.10"></a><span id="l11.10"> </span>
<a href="#l11.11"></a><span id="l11.11" class="difflineminus">-this.EXPORTED_SYMBOLS = ['pop3DownloadModule'];</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+this.EXPORTED_SYMBOLS = [&quot;pop3DownloadModule&quot;];</span>
<a href="#l11.13"></a><span id="l11.13"> </span>
<a href="#l11.14"></a><span id="l11.14" class="difflineminus">-var nsActProcess = Components.Constructor(&quot;@mozilla.org/activity-process;1&quot;,</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineminus">-                                            &quot;nsIActivityProcess&quot;, &quot;init&quot;);</span>
<a href="#l11.16"></a><span id="l11.16"> var nsActEvent = Components.Constructor(&quot;@mozilla.org/activity-event;1&quot;,</span>
<a href="#l11.17"></a><span id="l11.17">                                           &quot;nsIActivityEvent&quot;, &quot;init&quot;);</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineminus">-var nsActWarning = Components.Constructor(&quot;@mozilla.org/activity-warning;1&quot;,</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineminus">-                                            &quot;nsIActivityWarning&quot;, &quot;init&quot;);</span>
<a href="#l11.20"></a><span id="l11.20"> </span>
<a href="#l11.21"></a><span id="l11.21"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l11.22"></a><span id="l11.22"> ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineminus">-ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l11.24"></a><span id="l11.24"> ChromeUtils.import(&quot;resource://gre/modules/PluralForm.jsm&quot;);</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/gloda/log4moz.js&quot;);</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineplus">+const { Log4Moz } = ChromeUtils.import(&quot;resource:///modules/gloda/log4moz.js&quot;, null);</span>
<a href="#l11.27"></a><span id="l11.27"> </span>
<a href="#l11.28"></a><span id="l11.28"> // This module provides a link between the pop3 service code and the activity</span>
<a href="#l11.29"></a><span id="l11.29"> // manager.</span>
<a href="#l11.30"></a><span id="l11.30"> var pop3DownloadModule =</span>
<a href="#l11.31"></a><span id="l11.31"> {</span>
<a href="#l11.32"></a><span id="l11.32">   // hash table of most recent download items per folder</span>
<a href="#l11.33"></a><span id="l11.33">   _mostRecentActivityForFolder: new Map(),</span>
<a href="#l11.34"></a><span id="l11.34">   // hash table of prev download items per folder, so we can</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineat">@@ -40,26 +35,26 @@ var pop3DownloadModule =</span>
<a href="#l11.36"></a><span id="l11.36">   },</span>
<a href="#l11.37"></a><span id="l11.37"> </span>
<a href="#l11.38"></a><span id="l11.38">   get bundle() {</span>
<a href="#l11.39"></a><span id="l11.39">     delete this.bundle;</span>
<a href="#l11.40"></a><span id="l11.40">     return this.bundle = Services.strings</span>
<a href="#l11.41"></a><span id="l11.41">       .createBundle(&quot;chrome://messenger/locale/activity.properties&quot;);</span>
<a href="#l11.42"></a><span id="l11.42">   },</span>
<a href="#l11.43"></a><span id="l11.43"> </span>
<a href="#l11.44"></a><span id="l11.44" class="difflineminus">-  getString: function(stringName) {</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineplus">+  getString(stringName) {</span>
<a href="#l11.46"></a><span id="l11.46">     try {</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineminus">-      return this.bundle.GetStringFromName(stringName)</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineplus">+      return this.bundle.GetStringFromName(stringName);</span>
<a href="#l11.49"></a><span id="l11.49">     } catch (e) {</span>
<a href="#l11.50"></a><span id="l11.50">       this.log.error(&quot;error trying to get a string called: &quot; + stringName);</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineminus">-      throw(e);</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineplus">+      throw e;</span>
<a href="#l11.53"></a><span id="l11.53">     }</span>
<a href="#l11.54"></a><span id="l11.54">   },</span>
<a href="#l11.55"></a><span id="l11.55"> </span>
<a href="#l11.56"></a><span id="l11.56" class="difflineminus">-  onDownloadStarted : function(aFolder) {</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineplus">+  onDownloadStarted(aFolder) {</span>
<a href="#l11.58"></a><span id="l11.58">     this.log.info(&quot;in onDownloadStarted&quot;);</span>
<a href="#l11.59"></a><span id="l11.59"> </span>
<a href="#l11.60"></a><span id="l11.60">     let displayText =</span>
<a href="#l11.61"></a><span id="l11.61">       this.bundle.formatStringFromName(&quot;pop3EventStartDisplayText2&quot;,</span>
<a href="#l11.62"></a><span id="l11.62">                                        [aFolder.server.prettyName, // account name</span>
<a href="#l11.63"></a><span id="l11.63">                                         aFolder.prettyName], 2);   // folder name</span>
<a href="#l11.64"></a><span id="l11.64">     // remember the prev activity for this folder, if any.</span>
<a href="#l11.65"></a><span id="l11.65">     this._prevActivityForFolder.set(aFolder.URI,</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineat">@@ -75,39 +70,38 @@ var pop3DownloadModule =</span>
<a href="#l11.67"></a><span id="l11.67"> </span>
<a href="#l11.68"></a><span id="l11.68">     event.iconClass = &quot;syncMail&quot;;</span>
<a href="#l11.69"></a><span id="l11.69"> </span>
<a href="#l11.70"></a><span id="l11.70">     let downloadItem = {};</span>
<a href="#l11.71"></a><span id="l11.71">     downloadItem.eventID = this.activityMgr.addActivity(event);</span>
<a href="#l11.72"></a><span id="l11.72">     this._mostRecentActivityForFolder.set(aFolder.URI, downloadItem);</span>
<a href="#l11.73"></a><span id="l11.73">   },</span>
<a href="#l11.74"></a><span id="l11.74"> </span>
<a href="#l11.75"></a><span id="l11.75" class="difflineminus">-  onDownloadProgress : function(aFolder, aNumMsgsDownloaded, aTotalMsgs) {</span>
<a href="#l11.76"></a><span id="l11.76" class="difflineplus">+  onDownloadProgress(aFolder, aNumMsgsDownloaded, aTotalMsgs) {</span>
<a href="#l11.77"></a><span id="l11.77">     this.log.info(&quot;in onDownloadProgress&quot;);</span>
<a href="#l11.78"></a><span id="l11.78">   },</span>
<a href="#l11.79"></a><span id="l11.79"> </span>
<a href="#l11.80"></a><span id="l11.80" class="difflineminus">-  onDownloadCompleted : function(aFolder, aNumMsgsDownloaded) {</span>
<a href="#l11.81"></a><span id="l11.81" class="difflineplus">+  onDownloadCompleted(aFolder, aNumMsgsDownloaded) {</span>
<a href="#l11.82"></a><span id="l11.82">     this.log.info(&quot;in onDownloadCompleted&quot;);</span>
<a href="#l11.83"></a><span id="l11.83"> </span>
<a href="#l11.84"></a><span id="l11.84">     // Remove activity if there was any.</span>
<a href="#l11.85"></a><span id="l11.85">     // It can happen that download never started (e.g. couldn't connect to server),</span>
<a href="#l11.86"></a><span id="l11.86">     // with onDownloadStarted, but we still get a onDownloadCompleted event</span>
<a href="#l11.87"></a><span id="l11.87">     // when the connection is given up.</span>
<a href="#l11.88"></a><span id="l11.88">     let recentActivity = this._mostRecentActivityForFolder.get(aFolder.URI);</span>
<a href="#l11.89"></a><span id="l11.89">     if (recentActivity)</span>
<a href="#l11.90"></a><span id="l11.90">       this.activityMgr.removeActivity(recentActivity.eventID);</span>
<a href="#l11.91"></a><span id="l11.91"> </span>
<a href="#l11.92"></a><span id="l11.92">     let displayText;</span>
<a href="#l11.93"></a><span id="l11.93" class="difflineminus">-    if (aNumMsgsDownloaded &gt; 0)</span>
<a href="#l11.94"></a><span id="l11.94" class="difflineminus">-    {</span>
<a href="#l11.95"></a><span id="l11.95" class="difflineplus">+    if (aNumMsgsDownloaded &gt; 0) {</span>
<a href="#l11.96"></a><span id="l11.96">       displayText = PluralForm.get(aNumMsgsDownloaded, this.getString(&quot;pop3EventStatusText&quot;));</span>
<a href="#l11.97"></a><span id="l11.97">       displayText = displayText.replace(&quot;#1&quot;, aNumMsgsDownloaded);</span>
<a href="#l11.98"></a><span id="l11.98" class="difflineplus">+    } else {</span>
<a href="#l11.99"></a><span id="l11.99" class="difflineplus">+      displayText = this.getString(&quot;pop3EventStatusTextNoMsgs&quot;);</span>
<a href="#l11.100"></a><span id="l11.100">     }</span>
<a href="#l11.101"></a><span id="l11.101" class="difflineminus">-    else</span>
<a href="#l11.102"></a><span id="l11.102" class="difflineminus">-      displayText = this.getString(&quot;pop3EventStatusTextNoMsgs&quot;);</span>
<a href="#l11.103"></a><span id="l11.103"> </span>
<a href="#l11.104"></a><span id="l11.104">     let statusText = aFolder.server.prettyName;</span>
<a href="#l11.105"></a><span id="l11.105"> </span>
<a href="#l11.106"></a><span id="l11.106">     // create an activity event</span>
<a href="#l11.107"></a><span id="l11.107">     let event = new nsActEvent(displayText,</span>
<a href="#l11.108"></a><span id="l11.108">                                aFolder,</span>
<a href="#l11.109"></a><span id="l11.109">                                statusText,</span>
<a href="#l11.110"></a><span id="l11.110">                                Date.now(),  // start time</span>
<a href="#l11.111"></a><span id="l11.111" class="difflineat">@@ -124,13 +118,13 @@ var pop3DownloadModule =</span>
<a href="#l11.112"></a><span id="l11.112">       // prev event from the activity manager.</span>
<a href="#l11.113"></a><span id="l11.113">       let prevItem = this._prevActivityForFolder.get(aFolder.URI);</span>
<a href="#l11.114"></a><span id="l11.114">       if (prevItem != undefined &amp;&amp; !prevItem.numMsgsDownloaded) {</span>
<a href="#l11.115"></a><span id="l11.115">         if (this.activityMgr.containsActivity(prevItem.eventID))</span>
<a href="#l11.116"></a><span id="l11.116">           this.activityMgr.removeActivity(prevItem.eventID);</span>
<a href="#l11.117"></a><span id="l11.117">       }</span>
<a href="#l11.118"></a><span id="l11.118">     }</span>
<a href="#l11.119"></a><span id="l11.119">   },</span>
<a href="#l11.120"></a><span id="l11.120" class="difflineminus">-  init: function() {</span>
<a href="#l11.121"></a><span id="l11.121" class="difflineplus">+  init() {</span>
<a href="#l11.122"></a><span id="l11.122">     // XXX when do we need to remove ourselves?</span>
<a href="#l11.123"></a><span id="l11.123">     MailServices.pop3.addListener(this);</span>
<a href="#l11.124"></a><span id="l11.124" class="difflineminus">-  }</span>
<a href="#l11.125"></a><span id="l11.125" class="difflineplus">+  },</span>
<a href="#l11.126"></a><span id="l11.126"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1">rename from mail/components/activity/modules/sendLater.js</span>
<a href="#l12.2"></a><span id="l12.2">rename to mail/components/activity/modules/sendLater.jsm</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineminus">--- a/mail/components/activity/modules/sendLater.js</span>
<a href="#l12.4"></a><span id="l12.4" class="difflineplus">+++ b/mail/components/activity/modules/sendLater.jsm</span>
<a href="#l12.5"></a><span id="l12.5" class="difflineat">@@ -1,51 +1,49 @@</span>
<a href="#l12.6"></a><span id="l12.6"> /* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l12.7"></a><span id="l12.7"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l12.8"></a><span id="l12.8">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l12.9"></a><span id="l12.9">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l12.10"></a><span id="l12.10"> </span>
<a href="#l12.11"></a><span id="l12.11" class="difflineminus">-this.EXPORTED_SYMBOLS = ['sendLaterModule'];</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+this.EXPORTED_SYMBOLS = [&quot;sendLaterModule&quot;];</span>
<a href="#l12.13"></a><span id="l12.13"> </span>
<a href="#l12.14"></a><span id="l12.14"> var nsActProcess = Components.Constructor(&quot;@mozilla.org/activity-process;1&quot;,</span>
<a href="#l12.15"></a><span id="l12.15">                                             &quot;nsIActivityProcess&quot;, &quot;init&quot;);</span>
<a href="#l12.16"></a><span id="l12.16"> var nsActEvent = Components.Constructor(&quot;@mozilla.org/activity-event;1&quot;,</span>
<a href="#l12.17"></a><span id="l12.17">                                           &quot;nsIActivityEvent&quot;, &quot;init&quot;);</span>
<a href="#l12.18"></a><span id="l12.18"> var nsActWarning = Components.Constructor(&quot;@mozilla.org/activity-warning;1&quot;,</span>
<a href="#l12.19"></a><span id="l12.19">                                             &quot;nsIActivityWarning&quot;, &quot;init&quot;);</span>
<a href="#l12.20"></a><span id="l12.20"> </span>
<a href="#l12.21"></a><span id="l12.21"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineminus">-ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineminus">-ChromeUtils.import(&quot;resource://gre/modules/PluralForm.jsm&quot;);</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/gloda/log4moz.js&quot;);</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineplus">+const { Log4Moz } = ChromeUtils.import(&quot;resource:///modules/gloda/log4moz.js&quot;, null);</span>
<a href="#l12.26"></a><span id="l12.26"> </span>
<a href="#l12.27"></a><span id="l12.27"> /**</span>
<a href="#l12.28"></a><span id="l12.28">  * This really, really, sucks. Due to mailnews widespread use of</span>
<a href="#l12.29"></a><span id="l12.29">  * nsIMsgStatusFeedback we're bound to the UI to get any sensible feedback of</span>
<a href="#l12.30"></a><span id="l12.30">  * mail sending operations. The current send later code can't hook into the</span>
<a href="#l12.31"></a><span id="l12.31">  * progress listener easily to get the state of messages being sent, so we'll</span>
<a href="#l12.32"></a><span id="l12.32">  * just have to do it here.</span>
<a href="#l12.33"></a><span id="l12.33">  */</span>
<a href="#l12.34"></a><span id="l12.34"> var sendMsgProgressListener = {</span>
<a href="#l12.35"></a><span id="l12.35">   QueryInterface: ChromeUtils.generateQI([Ci.nsIMsgStatusFeedback,</span>
<a href="#l12.36"></a><span id="l12.36">                                           Ci.nsISupportsWeakReference]),</span>
<a href="#l12.37"></a><span id="l12.37"> </span>
<a href="#l12.38"></a><span id="l12.38" class="difflineminus">-  showStatusString: function(aStatusText) {</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineplus">+  showStatusString(aStatusText) {</span>
<a href="#l12.40"></a><span id="l12.40">     sendLaterModule.onMsgStatus(aStatusText);</span>
<a href="#l12.41"></a><span id="l12.41">   },</span>
<a href="#l12.42"></a><span id="l12.42"> </span>
<a href="#l12.43"></a><span id="l12.43" class="difflineminus">-  startMeteors: function() {</span>
<a href="#l12.44"></a><span id="l12.44" class="difflineplus">+  startMeteors() {</span>
<a href="#l12.45"></a><span id="l12.45">   },</span>
<a href="#l12.46"></a><span id="l12.46"> </span>
<a href="#l12.47"></a><span id="l12.47" class="difflineminus">-  stopMeteors: function() {</span>
<a href="#l12.48"></a><span id="l12.48" class="difflineplus">+  stopMeteors() {</span>
<a href="#l12.49"></a><span id="l12.49">   },</span>
<a href="#l12.50"></a><span id="l12.50"> </span>
<a href="#l12.51"></a><span id="l12.51" class="difflineminus">-  showProgress: function (aPercentage) {</span>
<a href="#l12.52"></a><span id="l12.52" class="difflineplus">+  showProgress(aPercentage) {</span>
<a href="#l12.53"></a><span id="l12.53">     sendLaterModule.onMessageSendProgress(0, 0, aPercentage, 0);</span>
<a href="#l12.54"></a><span id="l12.54" class="difflineminus">-  }</span>
<a href="#l12.55"></a><span id="l12.55" class="difflineplus">+  },</span>
<a href="#l12.56"></a><span id="l12.56"> };</span>
<a href="#l12.57"></a><span id="l12.57"> </span>
<a href="#l12.58"></a><span id="l12.58"> // This module provides a link between the send later service and the activity</span>
<a href="#l12.59"></a><span id="l12.59"> // manager.</span>
<a href="#l12.60"></a><span id="l12.60"> var sendLaterModule =</span>
<a href="#l12.61"></a><span id="l12.61"> {</span>
<a href="#l12.62"></a><span id="l12.62">   _sendProcess: null,</span>
<a href="#l12.63"></a><span id="l12.63">   _copyProcess: null,</span>
<a href="#l12.64"></a><span id="l12.64" class="difflineat">@@ -66,24 +64,24 @@ var sendLaterModule =</span>
<a href="#l12.65"></a><span id="l12.65">   get bundle() {</span>
<a href="#l12.66"></a><span id="l12.66">     delete this.bundle;</span>
<a href="#l12.67"></a><span id="l12.67">     return this.bundle = Services.strings</span>
<a href="#l12.68"></a><span id="l12.68">       .createBundle(&quot;chrome://messenger/locale/activity.properties&quot;);</span>
<a href="#l12.69"></a><span id="l12.69">   },</span>
<a href="#l12.70"></a><span id="l12.70"> </span>
<a href="#l12.71"></a><span id="l12.71">   QueryInterface: ChromeUtils.generateQI([Ci.nsIMsgSendLaterListener]),</span>
<a href="#l12.72"></a><span id="l12.72"> </span>
<a href="#l12.73"></a><span id="l12.73" class="difflineminus">-  _displayTextForHeader: function(aLocaleStringBase, aSubject) {</span>
<a href="#l12.74"></a><span id="l12.74" class="difflineplus">+  _displayTextForHeader(aLocaleStringBase, aSubject) {</span>
<a href="#l12.75"></a><span id="l12.75">     return aSubject ?</span>
<a href="#l12.76"></a><span id="l12.76">            this.bundle.formatStringFromName(aLocaleStringBase + &quot;WithSubject&quot;,</span>
<a href="#l12.77"></a><span id="l12.77">                                             [aSubject], 1) :</span>
<a href="#l12.78"></a><span id="l12.78">            this.bundle.GetStringFromName(aLocaleStringBase);</span>
<a href="#l12.79"></a><span id="l12.79">   },</span>
<a href="#l12.80"></a><span id="l12.80"> </span>
<a href="#l12.81"></a><span id="l12.81" class="difflineminus">-  _newProcess: function(aLocaleStringBase, aAddSubject) {</span>
<a href="#l12.82"></a><span id="l12.82" class="difflineplus">+  _newProcess(aLocaleStringBase, aAddSubject) {</span>
<a href="#l12.83"></a><span id="l12.83">     let process =</span>
<a href="#l12.84"></a><span id="l12.84">       new nsActProcess(this._displayTextForHeader(aLocaleStringBase,</span>
<a href="#l12.85"></a><span id="l12.85">                                                   aAddSubject ?</span>
<a href="#l12.86"></a><span id="l12.86">                                                   this._subject :</span>
<a href="#l12.87"></a><span id="l12.87">                                                   &quot;&quot;),</span>
<a href="#l12.88"></a><span id="l12.88">                                    this.activityMgr);</span>
<a href="#l12.89"></a><span id="l12.89"> </span>
<a href="#l12.90"></a><span id="l12.90">     process.iconClass = &quot;sendMail&quot;;</span>
<a href="#l12.91"></a><span id="l12.91" class="difflineat">@@ -91,72 +89,70 @@ var sendLaterModule =</span>
<a href="#l12.92"></a><span id="l12.92">     process.contextObj = this;</span>
<a href="#l12.93"></a><span id="l12.93">     process.contextType = &quot;SendLater&quot;;</span>
<a href="#l12.94"></a><span id="l12.94">     process.contextDisplayText = this.bundle.GetStringFromName(&quot;sendingMessages&quot;);</span>
<a href="#l12.95"></a><span id="l12.95"> </span>
<a href="#l12.96"></a><span id="l12.96">     return process;</span>
<a href="#l12.97"></a><span id="l12.97">   },</span>
<a href="#l12.98"></a><span id="l12.98"> </span>
<a href="#l12.99"></a><span id="l12.99">   // Use this to group an activity by the identity if we have one.</span>
<a href="#l12.100"></a><span id="l12.100" class="difflineminus">-  _applyIdentityGrouping: function(aActivity) {</span>
<a href="#l12.101"></a><span id="l12.101" class="difflineplus">+  _applyIdentityGrouping(aActivity) {</span>
<a href="#l12.102"></a><span id="l12.102">     if (this._identity) {</span>
<a href="#l12.103"></a><span id="l12.103">       aActivity.groupingStyle = Ci.nsIActivity.GROUPING_STYLE_BYCONTEXT;</span>
<a href="#l12.104"></a><span id="l12.104">       aActivity.contextType = this._identity.key;</span>
<a href="#l12.105"></a><span id="l12.105">       aActivity.contextObj = this._identity;</span>
<a href="#l12.106"></a><span id="l12.106">       let contextDisplayText = this._identity.identityName;</span>
<a href="#l12.107"></a><span id="l12.107">       if (!contextDisplayText)</span>
<a href="#l12.108"></a><span id="l12.108">         contextDisplayText = this._identity.email;</span>
<a href="#l12.109"></a><span id="l12.109"> </span>
<a href="#l12.110"></a><span id="l12.110">       aActivity.contextDisplayText = contextDisplayText;</span>
<a href="#l12.111"></a><span id="l12.111"> </span>
<a href="#l12.112"></a><span id="l12.112" class="difflineplus">+    } else {</span>
<a href="#l12.113"></a><span id="l12.113" class="difflineplus">+      aActivity.groupingStyle = Ci.nsIActivity.GROUPING_STYLE_STANDALONE;</span>
<a href="#l12.114"></a><span id="l12.114">     }</span>
<a href="#l12.115"></a><span id="l12.115" class="difflineminus">-    else</span>
<a href="#l12.116"></a><span id="l12.116" class="difflineminus">-      aActivity.groupingStyle = Ci.nsIActivity.GROUPING_STYLE_STANDALONE;</span>
<a href="#l12.117"></a><span id="l12.117">   },</span>
<a href="#l12.118"></a><span id="l12.118"> </span>
<a href="#l12.119"></a><span id="l12.119">   // Replaces the process with an event that reflects a completed process.</span>
<a href="#l12.120"></a><span id="l12.120" class="difflineminus">-  _replaceProcessWithEvent: function(aProcess) {</span>
<a href="#l12.121"></a><span id="l12.121" class="difflineplus">+  _replaceProcessWithEvent(aProcess) {</span>
<a href="#l12.122"></a><span id="l12.122">     this.activityMgr.removeActivity(aProcess.id);</span>
<a href="#l12.123"></a><span id="l12.123"> </span>
<a href="#l12.124"></a><span id="l12.124">     let event = new nsActEvent(this._displayTextForHeader(&quot;sentMessage&quot;,</span>
<a href="#l12.125"></a><span id="l12.125">                                                           this._subject),</span>
<a href="#l12.126"></a><span id="l12.126">                                this.activityMgr, &quot;&quot;, aProcess.startTime,</span>
<a href="#l12.127"></a><span id="l12.127">                                new Date());</span>
<a href="#l12.128"></a><span id="l12.128"> </span>
<a href="#l12.129"></a><span id="l12.129">     event.iconClass = &quot;sendMail&quot;;</span>
<a href="#l12.130"></a><span id="l12.130">     this._applyIdentityGrouping(event);</span>
<a href="#l12.131"></a><span id="l12.131"> </span>
<a href="#l12.132"></a><span id="l12.132">     this.activityMgr.addActivity(event);</span>
<a href="#l12.133"></a><span id="l12.133">   },</span>
<a href="#l12.134"></a><span id="l12.134"> </span>
<a href="#l12.135"></a><span id="l12.135">   // Replaces the process with a warning that reflects the failed process.</span>
<a href="#l12.136"></a><span id="l12.136" class="difflineminus">-  _replaceProcessWithWarning: function(aProcess, aCopyOrSend, aStatus, aMsg,</span>
<a href="#l12.137"></a><span id="l12.137" class="difflineminus">-                                       aMessageHeader) {</span>
<a href="#l12.138"></a><span id="l12.138" class="difflineplus">+  _replaceProcessWithWarning(aProcess, aCopyOrSend, aStatus, aMsg, aMessageHeader) {</span>
<a href="#l12.139"></a><span id="l12.139">     this.activityMgr.removeActivity(aProcess.id);</span>
<a href="#l12.140"></a><span id="l12.140"> </span>
<a href="#l12.141"></a><span id="l12.141">     let warning =</span>
<a href="#l12.142"></a><span id="l12.142">       new nsActWarning(this._displayTextForHeader(&quot;failedTo&quot; + aCopyOrSend,</span>
<a href="#l12.143"></a><span id="l12.143">                                                   this._subject),</span>
<a href="#l12.144"></a><span id="l12.144">                        this.activityMgr, &quot;&quot;);</span>
<a href="#l12.145"></a><span id="l12.145"> </span>
<a href="#l12.146"></a><span id="l12.146">     warning.groupingStyle = Ci.nsIActivity.GROUPING_STYLE_STANDALONE;</span>
<a href="#l12.147"></a><span id="l12.147">     this._applyIdentityGrouping(warning);</span>
<a href="#l12.148"></a><span id="l12.148"> </span>
<a href="#l12.149"></a><span id="l12.149">     this.activityMgr.addActivity(warning);</span>
<a href="#l12.150"></a><span id="l12.150">   },</span>
<a href="#l12.151"></a><span id="l12.151"> </span>
<a href="#l12.152"></a><span id="l12.152" class="difflineminus">-  onStartSending: function(aTotalMessageCount) {</span>
<a href="#l12.153"></a><span id="l12.153" class="difflineplus">+  onStartSending(aTotalMessageCount) {</span>
<a href="#l12.154"></a><span id="l12.154">     if (!aTotalMessageCount) {</span>
<a href="#l12.155"></a><span id="l12.155">       this.log.error(&quot;onStartSending called with zero messages\n&quot;);</span>
<a href="#l12.156"></a><span id="l12.156" class="difflineminus">-      return;</span>
<a href="#l12.157"></a><span id="l12.157" class="difflineplus">+</span>
<a href="#l12.158"></a><span id="l12.158">     }</span>
<a href="#l12.159"></a><span id="l12.159">   },</span>
<a href="#l12.160"></a><span id="l12.160"> </span>
<a href="#l12.161"></a><span id="l12.161" class="difflineminus">-  onMessageStartSending: function(aCurrentMessage, aTotalMessageCount,</span>
<a href="#l12.162"></a><span id="l12.162" class="difflineminus">-                                  aMessageHeader, aIdentity) {</span>
<a href="#l12.163"></a><span id="l12.163" class="difflineplus">+  onMessageStartSending(aCurrentMessage, aTotalMessageCount, aMessageHeader, aIdentity) {</span>
<a href="#l12.164"></a><span id="l12.164"> </span>
<a href="#l12.165"></a><span id="l12.165">     // We want to use the identity and subject later, so store them for now.</span>
<a href="#l12.166"></a><span id="l12.166">     this._identity = aIdentity;</span>
<a href="#l12.167"></a><span id="l12.167">     if (aMessageHeader)</span>
<a href="#l12.168"></a><span id="l12.168">       this._subject = aMessageHeader.mime2DecodedSubject;</span>
<a href="#l12.169"></a><span id="l12.169"> </span>
<a href="#l12.170"></a><span id="l12.170">     // Create the process to display the send activity.</span>
<a href="#l12.171"></a><span id="l12.171">     let process = this._newProcess(&quot;sendingMessage&quot;, true);</span>
<a href="#l12.172"></a><span id="l12.172" class="difflineat">@@ -164,95 +160,89 @@ var sendLaterModule =</span>
<a href="#l12.173"></a><span id="l12.173">     this.activityMgr.addActivity(process);</span>
<a href="#l12.174"></a><span id="l12.174"> </span>
<a href="#l12.175"></a><span id="l12.175">     // Now the one for the copy process.</span>
<a href="#l12.176"></a><span id="l12.176">     process = this._newProcess(&quot;copyMessage&quot;, false);</span>
<a href="#l12.177"></a><span id="l12.177">     this._copyProcess = process;</span>
<a href="#l12.178"></a><span id="l12.178">     this.activityMgr.addActivity(process);</span>
<a href="#l12.179"></a><span id="l12.179">   },</span>
<a href="#l12.180"></a><span id="l12.180"> </span>
<a href="#l12.181"></a><span id="l12.181" class="difflineminus">-  onMessageSendProgress: function(aCurrentMessage, aTotalMessageCount,</span>
<a href="#l12.182"></a><span id="l12.182" class="difflineminus">-                                  aMessageSendPercent,</span>
<a href="#l12.183"></a><span id="l12.183" class="difflineminus">-                                  aMessageCopyPercent) {</span>
<a href="#l12.184"></a><span id="l12.184" class="difflineplus">+  onMessageSendProgress(aCurrentMessage, aTotalMessageCount,</span>
<a href="#l12.185"></a><span id="l12.185" class="difflineplus">+                        aMessageSendPercent, aMessageCopyPercent) {</span>
<a href="#l12.186"></a><span id="l12.186">     if (aMessageSendPercent &lt; 100) {</span>
<a href="#l12.187"></a><span id="l12.187">       // Ensure we are in progress...</span>
<a href="#l12.188"></a><span id="l12.188">       if (this._sendProcess.state != Ci.nsIActivityProcess.STATE_INPROGRESS)</span>
<a href="#l12.189"></a><span id="l12.189">         this._sendProcess.state = Ci.nsIActivityProcess.STATE_INPROGRESS;</span>
<a href="#l12.190"></a><span id="l12.190"> </span>
<a href="#l12.191"></a><span id="l12.191">       // ... and update the progress.</span>
<a href="#l12.192"></a><span id="l12.192">       this._sendProcess.setProgress(this._sendProcess.lastStatusText,</span>
<a href="#l12.193"></a><span id="l12.193">                                     aMessageSendPercent, 100);</span>
<a href="#l12.194"></a><span id="l12.194" class="difflineminus">-    }</span>
<a href="#l12.195"></a><span id="l12.195" class="difflineminus">-    else if (aMessageSendPercent == 100) {</span>
<a href="#l12.196"></a><span id="l12.196" class="difflineplus">+    } else if (aMessageSendPercent == 100) {</span>
<a href="#l12.197"></a><span id="l12.197">       if (aMessageCopyPercent == 0) {</span>
<a href="#l12.198"></a><span id="l12.198">         // Set send state to completed</span>
<a href="#l12.199"></a><span id="l12.199">         if (this._sendProcess.state != Ci.nsIActivityProcess.STATE_COMPLETED)</span>
<a href="#l12.200"></a><span id="l12.200">           this._sendProcess.state = Ci.nsIActivityProcess.STATE_COMPLETED;</span>
<a href="#l12.201"></a><span id="l12.201">         this._replaceProcessWithEvent(this._sendProcess);</span>
<a href="#l12.202"></a><span id="l12.202"> </span>
<a href="#l12.203"></a><span id="l12.203">         // Set copy state to in progress.</span>
<a href="#l12.204"></a><span id="l12.204">         if (this._copyProcess.state != Ci.nsIActivityProcess.STATE_INPROGRESS)</span>
<a href="#l12.205"></a><span id="l12.205">           this._copyProcess.state = Ci.nsIActivityProcess.STATE_INPROGRESS;</span>
<a href="#l12.206"></a><span id="l12.206"> </span>
<a href="#l12.207"></a><span id="l12.207">         // We don't know the progress of the copy, so just set to 0, and we'll</span>
<a href="#l12.208"></a><span id="l12.208">         // display an undetermined progress meter.</span>
<a href="#l12.209"></a><span id="l12.209">         this._copyProcess.setProgress(this._copyProcess.lastStatusText,</span>
<a href="#l12.210"></a><span id="l12.210">                                       0, 0);</span>
<a href="#l12.211"></a><span id="l12.211" class="difflineminus">-      }</span>
<a href="#l12.212"></a><span id="l12.212" class="difflineminus">-      else if (aMessageCopyPercent &lt; 100) {</span>
<a href="#l12.213"></a><span id="l12.213" class="difflineminus">-      }</span>
<a href="#l12.214"></a><span id="l12.214" class="difflineminus">-      else {</span>
<a href="#l12.215"></a><span id="l12.215" class="difflineplus">+      } else if (aMessageCopyPercent &gt;= 100) {</span>
<a href="#l12.216"></a><span id="l12.216">         // We need to set this to completed otherwise activity manager</span>
<a href="#l12.217"></a><span id="l12.217">         // complains.</span>
<a href="#l12.218"></a><span id="l12.218">         if (this._copyProcess.state != Ci.nsIActivityProcess.STATE_COMPLETED)</span>
<a href="#l12.219"></a><span id="l12.219">           this._copyProcess.state = Ci.nsIActivityProcess.STATE_COMPLETED;</span>
<a href="#l12.220"></a><span id="l12.220"> </span>
<a href="#l12.221"></a><span id="l12.221">         // Just drop the copy process, we don't need it now.</span>
<a href="#l12.222"></a><span id="l12.222">         this.activityMgr.removeActivity(this._copyProcess.id);</span>
<a href="#l12.223"></a><span id="l12.223">         this._sendProcess = null;</span>
<a href="#l12.224"></a><span id="l12.224">         this._copyProcess = null;</span>
<a href="#l12.225"></a><span id="l12.225">       }</span>
<a href="#l12.226"></a><span id="l12.226">     }</span>
<a href="#l12.227"></a><span id="l12.227">   },</span>
<a href="#l12.228"></a><span id="l12.228"> </span>
<a href="#l12.229"></a><span id="l12.229" class="difflineminus">-  onMessageSendError: function(aCurrentMessage, aMessageHeader, aStatus,</span>
<a href="#l12.230"></a><span id="l12.230" class="difflineminus">-                               aMsg) {</span>
<a href="#l12.231"></a><span id="l12.231" class="difflineplus">+  onMessageSendError(aCurrentMessage, aMessageHeader, aStatus, aMsg) {</span>
<a href="#l12.232"></a><span id="l12.232">     if (this._sendProcess &amp;&amp;</span>
<a href="#l12.233"></a><span id="l12.233">         this._sendProcess.state != Ci.nsIActivityProcess.STATE_COMPLETED) {</span>
<a href="#l12.234"></a><span id="l12.234">       this._sendProcess.state = Ci.nsIActivityProcess.STATE_COMPLETED;</span>
<a href="#l12.235"></a><span id="l12.235">       this._replaceProcessWithWarning(this._sendProcess, &quot;SendMessage&quot;, aStatus, aMsg,</span>
<a href="#l12.236"></a><span id="l12.236">                                       aMessageHeader);</span>
<a href="#l12.237"></a><span id="l12.237">       this._sendProcess = null;</span>
<a href="#l12.238"></a><span id="l12.238"> </span>
<a href="#l12.239"></a><span id="l12.239">       if (this._copyProcess &amp;&amp;</span>
<a href="#l12.240"></a><span id="l12.240">           this._copyProcess.state != Ci.nsIActivityProcess.STATE_COMPLETED) {</span>
<a href="#l12.241"></a><span id="l12.241">         this._copyProcess.state = Ci.nsIActivityProcess.STATE_COMPLETED;</span>
<a href="#l12.242"></a><span id="l12.242">         this.activityMgr.removeActivity(this._copyProcess.id);</span>
<a href="#l12.243"></a><span id="l12.243">         this._copyProcess = null;</span>
<a href="#l12.244"></a><span id="l12.244">       }</span>
<a href="#l12.245"></a><span id="l12.245">     }</span>
<a href="#l12.246"></a><span id="l12.246">   },</span>
<a href="#l12.247"></a><span id="l12.247"> </span>
<a href="#l12.248"></a><span id="l12.248" class="difflineminus">-  onMsgStatus: function(aStatusText) {</span>
<a href="#l12.249"></a><span id="l12.249" class="difflineplus">+  onMsgStatus(aStatusText) {</span>
<a href="#l12.250"></a><span id="l12.250">     this._sendProcess.setProgress(aStatusText, this._sendProcess.workUnitComplete,</span>
<a href="#l12.251"></a><span id="l12.251">                                   this._sendProcess.totalWorkUnits);</span>
<a href="#l12.252"></a><span id="l12.252">   },</span>
<a href="#l12.253"></a><span id="l12.253"> </span>
<a href="#l12.254"></a><span id="l12.254" class="difflineminus">-  onStopSending: function(aStatus, aMsg, aTotalTried, aSuccessful) {</span>
<a href="#l12.255"></a><span id="l12.255" class="difflineplus">+  onStopSending(aStatus, aMsg, aTotalTried, aSuccessful) {</span>
<a href="#l12.256"></a><span id="l12.256">   },</span>
<a href="#l12.257"></a><span id="l12.257"> </span>
<a href="#l12.258"></a><span id="l12.258" class="difflineminus">-  init: function() {</span>
<a href="#l12.259"></a><span id="l12.259" class="difflineplus">+  init() {</span>
<a href="#l12.260"></a><span id="l12.260">     // We should need to remove the listener as we're not being held by anyone</span>
<a href="#l12.261"></a><span id="l12.261">     // except by the send later instance.</span>
<a href="#l12.262"></a><span id="l12.262">     let sendLaterService = Cc[&quot;@mozilla.org/messengercompose/sendlater;1&quot;]</span>
<a href="#l12.263"></a><span id="l12.263">                              .getService(Ci.nsIMsgSendLater);</span>
<a href="#l12.264"></a><span id="l12.264"> </span>
<a href="#l12.265"></a><span id="l12.265">     sendLaterService.addListener(this);</span>
<a href="#l12.266"></a><span id="l12.266"> </span>
<a href="#l12.267"></a><span id="l12.267">     // Also add the nsIMsgStatusFeedback object.</span>
<a href="#l12.268"></a><span id="l12.268">     let statusFeedback = Cc[&quot;@mozilla.org/messenger/statusfeedback;1&quot;]</span>
<a href="#l12.269"></a><span id="l12.269">                            .createInstance(Ci.nsIMsgStatusFeedback);</span>
<a href="#l12.270"></a><span id="l12.270"> </span>
<a href="#l12.271"></a><span id="l12.271">     statusFeedback.setWrappedStatusFeedback(sendMsgProgressListener);</span>
<a href="#l12.272"></a><span id="l12.272"> </span>
<a href="#l12.273"></a><span id="l12.273">     sendLaterService.statusFeedback = statusFeedback;</span>
<a href="#l12.274"></a><span id="l12.274" class="difflineminus">-  }</span>
<a href="#l12.275"></a><span id="l12.275" class="difflineplus">+  },</span>
<a href="#l12.276"></a><span id="l12.276"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mail/components/activity/moz.build</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mail/components/activity/moz.build</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -14,18 +14,18 @@ XPIDL_MODULE = 'activity'</span>
<a href="#l13.4"></a><span id="l13.4"> EXTRA_COMPONENTS += [</span>
<a href="#l13.5"></a><span id="l13.5">     'activityComponents.manifest',</span>
<a href="#l13.6"></a><span id="l13.6">     'nsActivity.js',</span>
<a href="#l13.7"></a><span id="l13.7">     'nsActivityManager.js',</span>
<a href="#l13.8"></a><span id="l13.8">     'nsActivityManagerUI.js',</span>
<a href="#l13.9"></a><span id="l13.9"> ]</span>
<a href="#l13.10"></a><span id="l13.10"> </span>
<a href="#l13.11"></a><span id="l13.11"> EXTRA_JS_MODULES.activity += [</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-    'modules/activityModules.js',</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-    'modules/alertHook.js',</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineminus">-    'modules/autosync.js',</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineminus">-    'modules/glodaIndexer.js',</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineminus">-    'modules/moveCopy.js',</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineminus">-    'modules/pop3Download.js',</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineminus">-    'modules/sendLater.js',</span>
<a href="#l13.19"></a><span id="l13.19" class="difflineplus">+    'modules/activityModules.jsm',</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineplus">+    'modules/alertHook.jsm',</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineplus">+    'modules/autosync.jsm',</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineplus">+    'modules/glodaIndexer.jsm',</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineplus">+    'modules/moveCopy.jsm',</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineplus">+    'modules/pop3Download.jsm',</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineplus">+    'modules/sendLater.jsm',</span>
<a href="#l13.26"></a><span id="l13.26"> ]</span>
<a href="#l13.27"></a><span id="l13.27"> </span>
<a href="#l13.28"></a><span id="l13.28"> JAR_MANIFESTS += ['jar.mn']</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mail/components/activity/nsActivity.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mail/components/activity/nsActivity.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -1,98 +1,85 @@</span>
<a href="#l14.4"></a><span id="l14.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l14.5"></a><span id="l14.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l14.6"></a><span id="l14.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l14.7"></a><span id="l14.7"> </span>
<a href="#l14.8"></a><span id="l14.8"> ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l14.9"></a><span id="l14.9" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/gloda/log4moz.js&quot;);</span>
<a href="#l14.10"></a><span id="l14.10" class="difflineminus">-</span>
<a href="#l14.11"></a><span id="l14.11" class="difflineminus">-////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-//// Constants</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+const { Log4Moz } = ChromeUtils.import(&quot;resource:///modules/gloda/log4moz.js&quot;, null);</span>
<a href="#l14.14"></a><span id="l14.14"> </span>
<a href="#l14.15"></a><span id="l14.15" class="difflineminus">-////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineminus">-//// Base class for nsActivityProcess and nsActivityEvent objects</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineplus">+// Base class for nsActivityProcess and nsActivityEvent objects</span>
<a href="#l14.18"></a><span id="l14.18"> </span>
<a href="#l14.19"></a><span id="l14.19" class="difflineminus">-function nsActivity()</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineminus">-{</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineplus">+function nsActivity() {</span>
<a href="#l14.22"></a><span id="l14.22">   this._initLogging();</span>
<a href="#l14.23"></a><span id="l14.23">   this._listeners = [];</span>
<a href="#l14.24"></a><span id="l14.24">   this._subjects = [];</span>
<a href="#l14.25"></a><span id="l14.25"> }</span>
<a href="#l14.26"></a><span id="l14.26"> </span>
<a href="#l14.27"></a><span id="l14.27"> nsActivity.prototype = {</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineminus">-</span>
<a href="#l14.29"></a><span id="l14.29">   id: -1,</span>
<a href="#l14.30"></a><span id="l14.30">   bindingName: &quot;&quot;,</span>
<a href="#l14.31"></a><span id="l14.31">   iconClass: &quot;&quot;,</span>
<a href="#l14.32"></a><span id="l14.32">   groupingStyle: Ci.nsIActivity.GROUPING_STYLE_BYCONTEXT,</span>
<a href="#l14.33"></a><span id="l14.33">   facet: &quot;&quot;,</span>
<a href="#l14.34"></a><span id="l14.34">   displayText: &quot;&quot;,</span>
<a href="#l14.35"></a><span id="l14.35">   initiator: null,</span>
<a href="#l14.36"></a><span id="l14.36">   contextType: &quot;&quot;,</span>
<a href="#l14.37"></a><span id="l14.37">   context: &quot;&quot;,</span>
<a href="#l14.38"></a><span id="l14.38">   contextObj: null,</span>
<a href="#l14.39"></a><span id="l14.39"> </span>
<a href="#l14.40"></a><span id="l14.40" class="difflineminus">-  _initLogging: function () {</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineplus">+  _initLogging() {</span>
<a href="#l14.42"></a><span id="l14.42">     this.log = Log4Moz.getConfiguredLogger(&quot;nsActivity&quot;);</span>
<a href="#l14.43"></a><span id="l14.43">   },</span>
<a href="#l14.44"></a><span id="l14.44"> </span>
<a href="#l14.45"></a><span id="l14.45" class="difflineminus">-  addListener: function(aListener) {</span>
<a href="#l14.46"></a><span id="l14.46" class="difflineplus">+  addListener(aListener) {</span>
<a href="#l14.47"></a><span id="l14.47">     this._listeners.push(aListener);</span>
<a href="#l14.48"></a><span id="l14.48">   },</span>
<a href="#l14.49"></a><span id="l14.49"> </span>
<a href="#l14.50"></a><span id="l14.50" class="difflineminus">-  removeListener: function(aListener) {</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineplus">+  removeListener(aListener) {</span>
<a href="#l14.52"></a><span id="l14.52">     for (let i = 0; i &lt; this._listeners.length; i++) {</span>
<a href="#l14.53"></a><span id="l14.53">       if (this._listeners[i] == aListener) {</span>
<a href="#l14.54"></a><span id="l14.54">         this._listeners.splice(i, 1);</span>
<a href="#l14.55"></a><span id="l14.55">         break;</span>
<a href="#l14.56"></a><span id="l14.56">       }</span>
<a href="#l14.57"></a><span id="l14.57">     }</span>
<a href="#l14.58"></a><span id="l14.58">   },</span>
<a href="#l14.59"></a><span id="l14.59"> </span>
<a href="#l14.60"></a><span id="l14.60" class="difflineminus">-  addSubject: function(aSubject) {</span>
<a href="#l14.61"></a><span id="l14.61" class="difflineplus">+  addSubject(aSubject) {</span>
<a href="#l14.62"></a><span id="l14.62">     this._subjects.push(aSubject);</span>
<a href="#l14.63"></a><span id="l14.63">   },</span>
<a href="#l14.64"></a><span id="l14.64"> </span>
<a href="#l14.65"></a><span id="l14.65" class="difflineminus">-  getSubjects: function(aCount) {</span>
<a href="#l14.66"></a><span id="l14.66" class="difflineplus">+  getSubjects(aCount) {</span>
<a href="#l14.67"></a><span id="l14.67">     let list = this._subjects.slice();</span>
<a href="#l14.68"></a><span id="l14.68"> </span>
<a href="#l14.69"></a><span id="l14.69">     aCount.value = list.length;</span>
<a href="#l14.70"></a><span id="l14.70">     return list;</span>
<a href="#l14.71"></a><span id="l14.71">   },</span>
<a href="#l14.72"></a><span id="l14.72"> };</span>
<a href="#l14.73"></a><span id="l14.73"> </span>
<a href="#l14.74"></a><span id="l14.74" class="difflineminus">-////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l14.75"></a><span id="l14.75" class="difflineminus">-//// nsActivityProcess class</span>
<a href="#l14.76"></a><span id="l14.76" class="difflineminus">-</span>
<a href="#l14.77"></a><span id="l14.77" class="difflineminus">-function nsActivityProcess()</span>
<a href="#l14.78"></a><span id="l14.78" class="difflineminus">-{</span>
<a href="#l14.79"></a><span id="l14.79" class="difflineplus">+function nsActivityProcess() {</span>
<a href="#l14.80"></a><span id="l14.80">   nsActivity.call(this);</span>
<a href="#l14.81"></a><span id="l14.81">   this.bindingName = &quot;activity-process&quot;;</span>
<a href="#l14.82"></a><span id="l14.82">   this.groupingStyle = Ci.nsIActivity.GROUPING_STYLE_BYCONTEXT;</span>
<a href="#l14.83"></a><span id="l14.83"> }</span>
<a href="#l14.84"></a><span id="l14.84"> </span>
<a href="#l14.85"></a><span id="l14.85"> nsActivityProcess.prototype = {</span>
<a href="#l14.86"></a><span id="l14.86">   __proto__: nsActivity.prototype,</span>
<a href="#l14.87"></a><span id="l14.87">   classID: Components.ID(&quot;B2C036A3-F7CE-401C-95EE-9C21505167FD&quot;),</span>
<a href="#l14.88"></a><span id="l14.88"> </span>
<a href="#l14.89"></a><span id="l14.89" class="difflineminus">-  //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l14.90"></a><span id="l14.90" class="difflineminus">-  //// nsIActivityProcess</span>
<a href="#l14.91"></a><span id="l14.91" class="difflineminus">-</span>
<a href="#l14.92"></a><span id="l14.92">   percentComplete: -1,</span>
<a href="#l14.93"></a><span id="l14.93">   lastStatusText: &quot;&quot;,</span>
<a href="#l14.94"></a><span id="l14.94">   workUnitComplete: 0,</span>
<a href="#l14.95"></a><span id="l14.95">   totalWorkUnits: 0,</span>
<a href="#l14.96"></a><span id="l14.96">   startTime: Date.now(),</span>
<a href="#l14.97"></a><span id="l14.97">   _cancelHandler: null,</span>
<a href="#l14.98"></a><span id="l14.98">   _pauseHandler: null,</span>
<a href="#l14.99"></a><span id="l14.99">   _retryHandler: null,</span>
<a href="#l14.100"></a><span id="l14.100">   _state: Ci.nsIActivityProcess.STATE_INPROGRESS,</span>
<a href="#l14.101"></a><span id="l14.101"> </span>
<a href="#l14.102"></a><span id="l14.102" class="difflineminus">-  init: function(aDisplayText, aInitiator) {</span>
<a href="#l14.103"></a><span id="l14.103" class="difflineplus">+  init(aDisplayText, aInitiator) {</span>
<a href="#l14.104"></a><span id="l14.104">     this.displayText = aDisplayText;</span>
<a href="#l14.105"></a><span id="l14.105">     this.initiator = aInitiator;</span>
<a href="#l14.106"></a><span id="l14.106">   },</span>
<a href="#l14.107"></a><span id="l14.107"> </span>
<a href="#l14.108"></a><span id="l14.108">   get state() {</span>
<a href="#l14.109"></a><span id="l14.109">     return this._state;</span>
<a href="#l14.110"></a><span id="l14.110">   },</span>
<a href="#l14.111"></a><span id="l14.111"> </span>
<a href="#l14.112"></a><span id="l14.112" class="difflineat">@@ -141,43 +128,40 @@ nsActivityProcess.prototype = {</span>
<a href="#l14.113"></a><span id="l14.113">     let oldState = this._state;</span>
<a href="#l14.114"></a><span id="l14.114">     this._state = val;</span>
<a href="#l14.115"></a><span id="l14.115"> </span>
<a href="#l14.116"></a><span id="l14.116">     // let the listeners know about the change</span>
<a href="#l14.117"></a><span id="l14.117">     this.log.debug(&quot;Notifying onStateChanged listeners&quot;);</span>
<a href="#l14.118"></a><span id="l14.118">     for (let value of this._listeners) {</span>
<a href="#l14.119"></a><span id="l14.119">       try {</span>
<a href="#l14.120"></a><span id="l14.120">         value.onStateChanged(this, oldState);</span>
<a href="#l14.121"></a><span id="l14.121" class="difflineminus">-      }</span>
<a href="#l14.122"></a><span id="l14.122" class="difflineminus">-      catch(e) {</span>
<a href="#l14.123"></a><span id="l14.123" class="difflineminus">-        this.log.error(&quot;Exception thrown by onStateChanged listener: &quot;+ e);</span>
<a href="#l14.124"></a><span id="l14.124" class="difflineplus">+      } catch (e) {</span>
<a href="#l14.125"></a><span id="l14.125" class="difflineplus">+        this.log.error(&quot;Exception thrown by onStateChanged listener: &quot; + e);</span>
<a href="#l14.126"></a><span id="l14.126">       }</span>
<a href="#l14.127"></a><span id="l14.127">     }</span>
<a href="#l14.128"></a><span id="l14.128">   },</span>
<a href="#l14.129"></a><span id="l14.129"> </span>
<a href="#l14.130"></a><span id="l14.130" class="difflineminus">-  setProgress: function(aStatusText, aWorkUnitsComplete, aTotalWorkUnits) {</span>
<a href="#l14.131"></a><span id="l14.131" class="difflineplus">+  setProgress(aStatusText, aWorkUnitsComplete, aTotalWorkUnits) {</span>
<a href="#l14.132"></a><span id="l14.132">     if (aTotalWorkUnits == 0) {</span>
<a href="#l14.133"></a><span id="l14.133">       this.percentComplete = -1;</span>
<a href="#l14.134"></a><span id="l14.134">       this.workUnitComplete = 0;</span>
<a href="#l14.135"></a><span id="l14.135">       this.totalWorkUnits = 0;</span>
<a href="#l14.136"></a><span id="l14.136" class="difflineminus">-    }</span>
<a href="#l14.137"></a><span id="l14.137" class="difflineminus">-    else {</span>
<a href="#l14.138"></a><span id="l14.138" class="difflineplus">+    } else {</span>
<a href="#l14.139"></a><span id="l14.139">       this.percentComplete = parseInt(100.0 * aWorkUnitsComplete / aTotalWorkUnits);</span>
<a href="#l14.140"></a><span id="l14.140">       this.workUnitComplete = aWorkUnitsComplete;</span>
<a href="#l14.141"></a><span id="l14.141">       this.totalWorkUnits = aTotalWorkUnits;</span>
<a href="#l14.142"></a><span id="l14.142">     }</span>
<a href="#l14.143"></a><span id="l14.143">     this.lastStatusText = aStatusText;</span>
<a href="#l14.144"></a><span id="l14.144"> </span>
<a href="#l14.145"></a><span id="l14.145">     // notify listeners</span>
<a href="#l14.146"></a><span id="l14.146">     for (let value of this._listeners) {</span>
<a href="#l14.147"></a><span id="l14.147">       try {</span>
<a href="#l14.148"></a><span id="l14.148">         value.onProgressChanged(this, aStatusText, aWorkUnitsComplete,</span>
<a href="#l14.149"></a><span id="l14.149">                                 aTotalWorkUnits);</span>
<a href="#l14.150"></a><span id="l14.150" class="difflineminus">-      }</span>
<a href="#l14.151"></a><span id="l14.151" class="difflineminus">-      catch(e) {</span>
<a href="#l14.152"></a><span id="l14.152" class="difflineplus">+      } catch (e) {</span>
<a href="#l14.153"></a><span id="l14.153">         this.log.error(&quot;Exception thrown by onProgressChanged listener: &quot; + e);</span>
<a href="#l14.154"></a><span id="l14.154">       }</span>
<a href="#l14.155"></a><span id="l14.155">     }</span>
<a href="#l14.156"></a><span id="l14.156">   },</span>
<a href="#l14.157"></a><span id="l14.157"> </span>
<a href="#l14.158"></a><span id="l14.158">   get cancelHandler() {</span>
<a href="#l14.159"></a><span id="l14.159">     return this._cancelHandler;</span>
<a href="#l14.160"></a><span id="l14.160">   },</span>
<a href="#l14.161"></a><span id="l14.161" class="difflineat">@@ -185,18 +169,17 @@ nsActivityProcess.prototype = {</span>
<a href="#l14.162"></a><span id="l14.162">   set cancelHandler(val) {</span>
<a href="#l14.163"></a><span id="l14.163">     this._cancelHandler = val;</span>
<a href="#l14.164"></a><span id="l14.164"> </span>
<a href="#l14.165"></a><span id="l14.165">     // let the listeners know about the change</span>
<a href="#l14.166"></a><span id="l14.166">     this.log.debug(&quot;Notifying onHandlerChanged listeners&quot;);</span>
<a href="#l14.167"></a><span id="l14.167">     for (let value of this._listeners) {</span>
<a href="#l14.168"></a><span id="l14.168">       try {</span>
<a href="#l14.169"></a><span id="l14.169">         value.onHandlerChanged(this);</span>
<a href="#l14.170"></a><span id="l14.170" class="difflineminus">-      }</span>
<a href="#l14.171"></a><span id="l14.171" class="difflineminus">-      catch(e) {</span>
<a href="#l14.172"></a><span id="l14.172" class="difflineplus">+      } catch (e) {</span>
<a href="#l14.173"></a><span id="l14.173">         this.log.error(&quot;Exception thrown by onHandlerChanged listener: &quot; + e);</span>
<a href="#l14.174"></a><span id="l14.174">       }</span>
<a href="#l14.175"></a><span id="l14.175">     }</span>
<a href="#l14.176"></a><span id="l14.176">   },</span>
<a href="#l14.177"></a><span id="l14.177"> </span>
<a href="#l14.178"></a><span id="l14.178">   get pauseHandler() {</span>
<a href="#l14.179"></a><span id="l14.179">     return this._pauseHandler;</span>
<a href="#l14.180"></a><span id="l14.180">   },</span>
<a href="#l14.181"></a><span id="l14.181" class="difflineat">@@ -220,53 +203,42 @@ nsActivityProcess.prototype = {</span>
<a href="#l14.182"></a><span id="l14.182"> </span>
<a href="#l14.183"></a><span id="l14.183">     // let the listeners know about the change</span>
<a href="#l14.184"></a><span id="l14.184">     this.log.debug(&quot;Notifying onHandlerChanged listeners&quot;);</span>
<a href="#l14.185"></a><span id="l14.185">     for (let value of this._listeners) {</span>
<a href="#l14.186"></a><span id="l14.186">       value.onHandlerChanged(this);</span>
<a href="#l14.187"></a><span id="l14.187">     }</span>
<a href="#l14.188"></a><span id="l14.188">   },</span>
<a href="#l14.189"></a><span id="l14.189"> </span>
<a href="#l14.190"></a><span id="l14.190" class="difflineminus">-  //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l14.191"></a><span id="l14.191" class="difflineminus">-  //// nsISupports</span>
<a href="#l14.192"></a><span id="l14.192" class="difflineminus">-</span>
<a href="#l14.193"></a><span id="l14.193" class="difflineminus">-  QueryInterface: ChromeUtils.generateQI([Ci.nsIActivityProcess, Ci.nsIActivity])</span>
<a href="#l14.194"></a><span id="l14.194" class="difflineplus">+  QueryInterface: ChromeUtils.generateQI([Ci.nsIActivityProcess, Ci.nsIActivity]),</span>
<a href="#l14.195"></a><span id="l14.195"> };</span>
<a href="#l14.196"></a><span id="l14.196"> </span>
<a href="#l14.197"></a><span id="l14.197" class="difflineminus">-///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l14.198"></a><span id="l14.198" class="difflineminus">-//// nsActivityEvent class</span>
<a href="#l14.199"></a><span id="l14.199" class="difflineminus">-</span>
<a href="#l14.200"></a><span id="l14.200" class="difflineminus">-function nsActivityEvent()</span>
<a href="#l14.201"></a><span id="l14.201" class="difflineminus">-{</span>
<a href="#l14.202"></a><span id="l14.202" class="difflineplus">+function nsActivityEvent() {</span>
<a href="#l14.203"></a><span id="l14.203">   nsActivity.call(this);</span>
<a href="#l14.204"></a><span id="l14.204">   this.bindingName = &quot;activity-event&quot;;</span>
<a href="#l14.205"></a><span id="l14.205">   this.groupingStyle = Ci.nsIActivity.GROUPING_STYLE_STANDALONE;</span>
<a href="#l14.206"></a><span id="l14.206"> }</span>
<a href="#l14.207"></a><span id="l14.207"> </span>
<a href="#l14.208"></a><span id="l14.208"> nsActivityEvent.prototype = {</span>
<a href="#l14.209"></a><span id="l14.209">   __proto__: nsActivity.prototype,</span>
<a href="#l14.210"></a><span id="l14.210">   classID: Components.ID(&quot;87AAEB20-89D9-4B95-9542-3BF72405CAB2&quot;),</span>
<a href="#l14.211"></a><span id="l14.211"> </span>
<a href="#l14.212"></a><span id="l14.212" class="difflineminus">-  //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l14.213"></a><span id="l14.213" class="difflineminus">-  //// nsIActivityEvent</span>
<a href="#l14.214"></a><span id="l14.214" class="difflineminus">-</span>
<a href="#l14.215"></a><span id="l14.215">   statusText: &quot;&quot;,</span>
<a href="#l14.216"></a><span id="l14.216">   startTime: 0,</span>
<a href="#l14.217"></a><span id="l14.217">   completionTime: 0,</span>
<a href="#l14.218"></a><span id="l14.218">   _undoHandler: null,</span>
<a href="#l14.219"></a><span id="l14.219"> </span>
<a href="#l14.220"></a><span id="l14.220" class="difflineminus">-  init: function(aDisplayText, aInitiator, aStatusText, aStartTime,</span>
<a href="#l14.221"></a><span id="l14.221" class="difflineminus">-                 aCompletionTime) {</span>
<a href="#l14.222"></a><span id="l14.222" class="difflineplus">+  init(aDisplayText, aInitiator, aStatusText, aStartTime, aCompletionTime) {</span>
<a href="#l14.223"></a><span id="l14.223">     this.displayText = aDisplayText;</span>
<a href="#l14.224"></a><span id="l14.224">     this.statusText = aStatusText;</span>
<a href="#l14.225"></a><span id="l14.225">     this.startTime = aStartTime;</span>
<a href="#l14.226"></a><span id="l14.226">     if (aCompletionTime)</span>
<a href="#l14.227"></a><span id="l14.227">       this.completionTime = aCompletionTime;</span>
<a href="#l14.228"></a><span id="l14.228">     else</span>
<a href="#l14.229"></a><span id="l14.229" class="difflineminus">-      this.completionTime = Date.now()</span>
<a href="#l14.230"></a><span id="l14.230" class="difflineplus">+      this.completionTime = Date.now();</span>
<a href="#l14.231"></a><span id="l14.231">     this.initiator = aInitiator;</span>
<a href="#l14.232"></a><span id="l14.232">     this._completionTime = aCompletionTime;</span>
<a href="#l14.233"></a><span id="l14.233">   },</span>
<a href="#l14.234"></a><span id="l14.234"> </span>
<a href="#l14.235"></a><span id="l14.235">   get undoHandler() {</span>
<a href="#l14.236"></a><span id="l14.236">     return this._undoHandler;</span>
<a href="#l14.237"></a><span id="l14.237">   },</span>
<a href="#l14.238"></a><span id="l14.238"> </span>
<a href="#l14.239"></a><span id="l14.239" class="difflineat">@@ -275,44 +247,34 @@ nsActivityEvent.prototype = {</span>
<a href="#l14.240"></a><span id="l14.240"> </span>
<a href="#l14.241"></a><span id="l14.241">     // let the listeners know about the change</span>
<a href="#l14.242"></a><span id="l14.242">     this.log.debug(&quot;Notifying onHandlerChanged listeners&quot;);</span>
<a href="#l14.243"></a><span id="l14.243">     for (let value of this._listeners) {</span>
<a href="#l14.244"></a><span id="l14.244">       value.onHandlerChanged(this);</span>
<a href="#l14.245"></a><span id="l14.245">     }</span>
<a href="#l14.246"></a><span id="l14.246">   },</span>
<a href="#l14.247"></a><span id="l14.247"> </span>
<a href="#l14.248"></a><span id="l14.248" class="difflineminus">-  //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l14.249"></a><span id="l14.249" class="difflineminus">-  //// nsISupports</span>
<a href="#l14.250"></a><span id="l14.250" class="difflineminus">-</span>
<a href="#l14.251"></a><span id="l14.251" class="difflineminus">-  QueryInterface: ChromeUtils.generateQI([Ci.nsIActivityEvent, Ci.nsIActivity])</span>
<a href="#l14.252"></a><span id="l14.252" class="difflineplus">+  QueryInterface: ChromeUtils.generateQI([Ci.nsIActivityEvent, Ci.nsIActivity]),</span>
<a href="#l14.253"></a><span id="l14.253"> };</span>
<a href="#l14.254"></a><span id="l14.254"> </span>
<a href="#l14.255"></a><span id="l14.255" class="difflineminus">-///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l14.256"></a><span id="l14.256" class="difflineminus">-//// nsActivityWarning class</span>
<a href="#l14.257"></a><span id="l14.257" class="difflineminus">-</span>
<a href="#l14.258"></a><span id="l14.258" class="difflineminus">-function nsActivityWarning()</span>
<a href="#l14.259"></a><span id="l14.259" class="difflineminus">-{</span>
<a href="#l14.260"></a><span id="l14.260" class="difflineplus">+function nsActivityWarning() {</span>
<a href="#l14.261"></a><span id="l14.261">   nsActivity.call(this);</span>
<a href="#l14.262"></a><span id="l14.262">   this.bindingName = &quot;activity-warning&quot;;</span>
<a href="#l14.263"></a><span id="l14.263">   this.groupingStyle = Ci.nsIActivity.GROUPING_STYLE_BYCONTEXT;</span>
<a href="#l14.264"></a><span id="l14.264"> }</span>
<a href="#l14.265"></a><span id="l14.265"> </span>
<a href="#l14.266"></a><span id="l14.266"> nsActivityWarning.prototype = {</span>
<a href="#l14.267"></a><span id="l14.267">   __proto__: nsActivity.prototype,</span>
<a href="#l14.268"></a><span id="l14.268">   classID: Components.ID(&quot;968BAC9E-798B-4952-B384-86B21B8CC71E&quot;),</span>
<a href="#l14.269"></a><span id="l14.269"> </span>
<a href="#l14.270"></a><span id="l14.270" class="difflineminus">-  //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l14.271"></a><span id="l14.271" class="difflineminus">-  //// nsIActivityWarning</span>
<a href="#l14.272"></a><span id="l14.272" class="difflineminus">-</span>
<a href="#l14.273"></a><span id="l14.273">   recoveryTipText: &quot;&quot;,</span>
<a href="#l14.274"></a><span id="l14.274">   _time: 0,</span>
<a href="#l14.275"></a><span id="l14.275">   _recoveryHandler: null,</span>
<a href="#l14.276"></a><span id="l14.276"> </span>
<a href="#l14.277"></a><span id="l14.277" class="difflineminus">-  init: function(aWarningText, aInitiator, aRecoveryTipText) {</span>
<a href="#l14.278"></a><span id="l14.278" class="difflineplus">+  init(aWarningText, aInitiator, aRecoveryTipText) {</span>
<a href="#l14.279"></a><span id="l14.279">     this.displayText = aWarningText;</span>
<a href="#l14.280"></a><span id="l14.280">     this.initiator = aInitiator;</span>
<a href="#l14.281"></a><span id="l14.281">     this.recoveryTipText = aRecoveryTipText;</span>
<a href="#l14.282"></a><span id="l14.282">     this._time = Date.now();</span>
<a href="#l14.283"></a><span id="l14.283">   },</span>
<a href="#l14.284"></a><span id="l14.284"> </span>
<a href="#l14.285"></a><span id="l14.285">   get recoveryHandler() {</span>
<a href="#l14.286"></a><span id="l14.286">     return this._recoveryHandler;</span>
<a href="#l14.287"></a><span id="l14.287" class="difflineat">@@ -327,19 +289,13 @@ nsActivityWarning.prototype = {</span>
<a href="#l14.288"></a><span id="l14.288">       value.onHandlerChanged(this);</span>
<a href="#l14.289"></a><span id="l14.289">     }</span>
<a href="#l14.290"></a><span id="l14.290">   },</span>
<a href="#l14.291"></a><span id="l14.291"> </span>
<a href="#l14.292"></a><span id="l14.292">   get time() {</span>
<a href="#l14.293"></a><span id="l14.293">     return this._time;</span>
<a href="#l14.294"></a><span id="l14.294">   },</span>
<a href="#l14.295"></a><span id="l14.295"> </span>
<a href="#l14.296"></a><span id="l14.296" class="difflineminus">-  //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l14.297"></a><span id="l14.297" class="difflineminus">-  //// nsISupports</span>
<a href="#l14.298"></a><span id="l14.298" class="difflineminus">-</span>
<a href="#l14.299"></a><span id="l14.299" class="difflineminus">-  QueryInterface: ChromeUtils.generateQI([Ci.nsIActivityWarning, Ci.nsIActivity])</span>
<a href="#l14.300"></a><span id="l14.300" class="difflineplus">+  QueryInterface: ChromeUtils.generateQI([Ci.nsIActivityWarning, Ci.nsIActivity]),</span>
<a href="#l14.301"></a><span id="l14.301"> };</span>
<a href="#l14.302"></a><span id="l14.302"> </span>
<a href="#l14.303"></a><span id="l14.303" class="difflineminus">-///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l14.304"></a><span id="l14.304" class="difflineminus">-//// Module</span>
<a href="#l14.305"></a><span id="l14.305" class="difflineminus">-</span>
<a href="#l14.306"></a><span id="l14.306"> var components = [nsActivityProcess, nsActivityEvent, nsActivityWarning];</span>
<a href="#l14.307"></a><span id="l14.307"> var NSGetFactory = XPCOMUtils.generateNSGetFactory(components);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mail/components/activity/nsActivityManager.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mail/components/activity/nsActivityManager.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -1,30 +1,21 @@</span>
<a href="#l15.4"></a><span id="l15.4"> /* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l15.5"></a><span id="l15.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l15.6"></a><span id="l15.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l15.7"></a><span id="l15.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l15.8"></a><span id="l15.8"> </span>
<a href="#l15.9"></a><span id="l15.9"> ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l15.10"></a><span id="l15.10" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/gloda/log4moz.js&quot;);</span>
<a href="#l15.11"></a><span id="l15.11" class="difflineminus">-</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineminus">-//// Constants</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineplus">+const { Log4Moz } = ChromeUtils.import(&quot;resource:///modules/gloda/log4moz.js&quot;, null);</span>
<a href="#l15.15"></a><span id="l15.15"> </span>
<a href="#l15.16"></a><span id="l15.16" class="difflineminus">-////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineminus">-//// nsActivityManager class</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineminus">-</span>
<a href="#l15.19"></a><span id="l15.19" class="difflineminus">-function nsActivityManager()</span>
<a href="#l15.20"></a><span id="l15.20" class="difflineminus">-{}</span>
<a href="#l15.21"></a><span id="l15.21" class="difflineplus">+function nsActivityManager() {}</span>
<a href="#l15.22"></a><span id="l15.22"> </span>
<a href="#l15.23"></a><span id="l15.23"> nsActivityManager.prototype = {</span>
<a href="#l15.24"></a><span id="l15.24">   classID: Components.ID(&quot;8aa5972e-19cb-41cc-9696-645f8a8d1a06&quot;),</span>
<a href="#l15.25"></a><span id="l15.25"> </span>
<a href="#l15.26"></a><span id="l15.26" class="difflineminus">-  //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l15.27"></a><span id="l15.27" class="difflineminus">-  //// nsIActivityManager</span>
<a href="#l15.28"></a><span id="l15.28">   log: Log4Moz.getConfiguredLogger(&quot;nsActivityManager&quot;),</span>
<a href="#l15.29"></a><span id="l15.29">   _listeners: [],</span>
<a href="#l15.30"></a><span id="l15.30">   _processCount: 0,</span>
<a href="#l15.31"></a><span id="l15.31">   _db: null,</span>
<a href="#l15.32"></a><span id="l15.32">   _idCounter: 1,</span>
<a href="#l15.33"></a><span id="l15.33">   _activities: new Map(),</span>
<a href="#l15.34"></a><span id="l15.34"> </span>
<a href="#l15.35"></a><span id="l15.35">   get processCount() {</span>
<a href="#l15.36"></a><span id="l15.36" class="difflineat">@@ -32,17 +23,17 @@ nsActivityManager.prototype = {</span>
<a href="#l15.37"></a><span id="l15.37">     for (let value of this._activities.values()) {</span>
<a href="#l15.38"></a><span id="l15.38">       if (value instanceof Ci.nsIActivityProcess)</span>
<a href="#l15.39"></a><span id="l15.39">         count++;</span>
<a href="#l15.40"></a><span id="l15.40">     }</span>
<a href="#l15.41"></a><span id="l15.41"> </span>
<a href="#l15.42"></a><span id="l15.42">     return count;</span>
<a href="#l15.43"></a><span id="l15.43">   },</span>
<a href="#l15.44"></a><span id="l15.44"> </span>
<a href="#l15.45"></a><span id="l15.45" class="difflineminus">-  getProcessesByContext: function(aContextType, aContextObj, aCount) {</span>
<a href="#l15.46"></a><span id="l15.46" class="difflineplus">+  getProcessesByContext(aContextType, aContextObj, aCount) {</span>
<a href="#l15.47"></a><span id="l15.47">     let list = [];</span>
<a href="#l15.48"></a><span id="l15.48">     for (let activity of this._activities.values()) {</span>
<a href="#l15.49"></a><span id="l15.49">       if (activity instanceof Ci.nsIActivityProcess &amp;&amp;</span>
<a href="#l15.50"></a><span id="l15.50">           activity.contextType == aContextType &amp;&amp;</span>
<a href="#l15.51"></a><span id="l15.51">           activity.contextObj == aContextObj) {</span>
<a href="#l15.52"></a><span id="l15.52">         list.push(activity);</span>
<a href="#l15.53"></a><span id="l15.53">       }</span>
<a href="#l15.54"></a><span id="l15.54">     }</span>
<a href="#l15.55"></a><span id="l15.55" class="difflineat">@@ -54,117 +45,109 @@ nsActivityManager.prototype = {</span>
<a href="#l15.56"></a><span id="l15.56">   get db() {</span>
<a href="#l15.57"></a><span id="l15.57">     return null;</span>
<a href="#l15.58"></a><span id="l15.58">   },</span>
<a href="#l15.59"></a><span id="l15.59"> </span>
<a href="#l15.60"></a><span id="l15.60">   get nextId() {</span>
<a href="#l15.61"></a><span id="l15.61">     return this._idCounter++;</span>
<a href="#l15.62"></a><span id="l15.62">   },</span>
<a href="#l15.63"></a><span id="l15.63"> </span>
<a href="#l15.64"></a><span id="l15.64" class="difflineminus">-  addActivity: function (aActivity) {</span>
<a href="#l15.65"></a><span id="l15.65" class="difflineplus">+  addActivity(aActivity) {</span>
<a href="#l15.66"></a><span id="l15.66">     try {</span>
<a href="#l15.67"></a><span id="l15.67">       this.log.info(&quot;adding Activity&quot;);</span>
<a href="#l15.68"></a><span id="l15.68">       // get the next valid id for this activity</span>
<a href="#l15.69"></a><span id="l15.69">       let id = this.nextId;</span>
<a href="#l15.70"></a><span id="l15.70">       aActivity.id = id;</span>
<a href="#l15.71"></a><span id="l15.71"> </span>
<a href="#l15.72"></a><span id="l15.72">       // add activity into the activities table</span>
<a href="#l15.73"></a><span id="l15.73">       this._activities.set(id, aActivity);</span>
<a href="#l15.74"></a><span id="l15.74">       // notify all the listeners</span>
<a href="#l15.75"></a><span id="l15.75">       for (let value of this._listeners) {</span>
<a href="#l15.76"></a><span id="l15.76">         try {</span>
<a href="#l15.77"></a><span id="l15.77">           value.onAddedActivity(id, aActivity);</span>
<a href="#l15.78"></a><span id="l15.78" class="difflineminus">-        }</span>
<a href="#l15.79"></a><span id="l15.79" class="difflineminus">-        catch(e) {</span>
<a href="#l15.80"></a><span id="l15.80" class="difflineminus">-          this.log.error(&quot;Exception calling onAddedActivity&quot; + e)</span>
<a href="#l15.81"></a><span id="l15.81" class="difflineplus">+        } catch (e) {</span>
<a href="#l15.82"></a><span id="l15.82" class="difflineplus">+          this.log.error(&quot;Exception calling onAddedActivity&quot; + e);</span>
<a href="#l15.83"></a><span id="l15.83">         }</span>
<a href="#l15.84"></a><span id="l15.84">       }</span>
<a href="#l15.85"></a><span id="l15.85">       return id;</span>
<a href="#l15.86"></a><span id="l15.86">     } catch (e) {</span>
<a href="#l15.87"></a><span id="l15.87">       // for some reason exceptions don't end up on the console if we don't</span>
<a href="#l15.88"></a><span id="l15.88">       // explicitly log them.</span>
<a href="#l15.89"></a><span id="l15.89">       this.log.error(&quot;Exception: &quot; + e);</span>
<a href="#l15.90"></a><span id="l15.90" class="difflineminus">-      throw(e);</span>
<a href="#l15.91"></a><span id="l15.91" class="difflineplus">+      throw e;</span>
<a href="#l15.92"></a><span id="l15.92">     }</span>
<a href="#l15.93"></a><span id="l15.93">   },</span>
<a href="#l15.94"></a><span id="l15.94"> </span>
<a href="#l15.95"></a><span id="l15.95" class="difflineminus">-  removeActivity: function (aID) {</span>
<a href="#l15.96"></a><span id="l15.96" class="difflineplus">+  removeActivity(aID) {</span>
<a href="#l15.97"></a><span id="l15.97">     let activity = this.getActivity(aID);</span>
<a href="#l15.98"></a><span id="l15.98"> </span>
<a href="#l15.99"></a><span id="l15.99">     // make sure that the activity is not in-progress state</span>
<a href="#l15.100"></a><span id="l15.100">     if (activity instanceof Ci.nsIActivityProcess &amp;&amp;</span>
<a href="#l15.101"></a><span id="l15.101">         activity.state == Ci.nsIActivityProcess.STATE_INPROGRESS)</span>
<a href="#l15.102"></a><span id="l15.102">       throw Cr.NS_ERROR_FAILURE;</span>
<a href="#l15.103"></a><span id="l15.103"> </span>
<a href="#l15.104"></a><span id="l15.104">     // remove the activity</span>
<a href="#l15.105"></a><span id="l15.105">     this._activities.delete(aID);</span>
<a href="#l15.106"></a><span id="l15.106"> </span>
<a href="#l15.107"></a><span id="l15.107">     // notify all the listeners</span>
<a href="#l15.108"></a><span id="l15.108">     for (let value of this._listeners) {</span>
<a href="#l15.109"></a><span id="l15.109">       try {</span>
<a href="#l15.110"></a><span id="l15.110">         value.onRemovedActivity(aID);</span>
<a href="#l15.111"></a><span id="l15.111" class="difflineminus">-      }</span>
<a href="#l15.112"></a><span id="l15.112" class="difflineminus">-      catch(e) {</span>
<a href="#l15.113"></a><span id="l15.113" class="difflineplus">+      } catch (e) {</span>
<a href="#l15.114"></a><span id="l15.114">         // ignore the exception</span>
<a href="#l15.115"></a><span id="l15.115">       }</span>
<a href="#l15.116"></a><span id="l15.116">     }</span>
<a href="#l15.117"></a><span id="l15.117">   },</span>
<a href="#l15.118"></a><span id="l15.118"> </span>
<a href="#l15.119"></a><span id="l15.119" class="difflineminus">-  cleanUp: function () {</span>
<a href="#l15.120"></a><span id="l15.120" class="difflineplus">+  cleanUp() {</span>
<a href="#l15.121"></a><span id="l15.121">     // Get the list of aIDs.</span>
<a href="#l15.122"></a><span id="l15.122">     this.log.info(&quot;cleanUp\n&quot;);</span>
<a href="#l15.123"></a><span id="l15.123">     for (let [id, activity] of this._activities) {</span>
<a href="#l15.124"></a><span id="l15.124">       if (activity instanceof Ci.nsIActivityProcess) {</span>
<a href="#l15.125"></a><span id="l15.125">         // Note: The .state property will return undefined if you aren't in</span>
<a href="#l15.126"></a><span id="l15.126">         //       this if-instanceof block.</span>
<a href="#l15.127"></a><span id="l15.127">         let state = activity.state;</span>
<a href="#l15.128"></a><span id="l15.128">         if (state != Ci.nsIActivityProcess.STATE_INPROGRESS &amp;&amp;</span>
<a href="#l15.129"></a><span id="l15.129">             state != Ci.nsIActivityProcess.STATE_PAUSED &amp;&amp;</span>
<a href="#l15.130"></a><span id="l15.130">             state != Ci.nsIActivityProcess.STATE_WAITINGFORINPUT &amp;&amp;</span>
<a href="#l15.131"></a><span id="l15.131">             state != Ci.nsIActivityProcess.STATE_WAITINGFORRETRY)</span>
<a href="#l15.132"></a><span id="l15.132">           this.removeActivity(id);</span>
<a href="#l15.133"></a><span id="l15.133" class="difflineplus">+      } else {</span>
<a href="#l15.134"></a><span id="l15.134" class="difflineplus">+        this.removeActivity(id);</span>
<a href="#l15.135"></a><span id="l15.135">       }</span>
<a href="#l15.136"></a><span id="l15.136" class="difflineminus">-      else</span>
<a href="#l15.137"></a><span id="l15.137" class="difflineminus">-        this.removeActivity(id);</span>
<a href="#l15.138"></a><span id="l15.138">     }</span>
<a href="#l15.139"></a><span id="l15.139">   },</span>
<a href="#l15.140"></a><span id="l15.140"> </span>
<a href="#l15.141"></a><span id="l15.141" class="difflineminus">-  getActivity: function(aID) {</span>
<a href="#l15.142"></a><span id="l15.142" class="difflineplus">+  getActivity(aID) {</span>
<a href="#l15.143"></a><span id="l15.143">     if (!this._activities.has(aID))</span>
<a href="#l15.144"></a><span id="l15.144">       throw Cr.NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l15.145"></a><span id="l15.145">     return this._activities.get(aID);</span>
<a href="#l15.146"></a><span id="l15.146">   },</span>
<a href="#l15.147"></a><span id="l15.147"> </span>
<a href="#l15.148"></a><span id="l15.148" class="difflineminus">-  containsActivity: function (aID) {</span>
<a href="#l15.149"></a><span id="l15.149" class="difflineplus">+  containsActivity(aID) {</span>
<a href="#l15.150"></a><span id="l15.150">     return this._activities.has(aID);</span>
<a href="#l15.151"></a><span id="l15.151">   },</span>
<a href="#l15.152"></a><span id="l15.152"> </span>
<a href="#l15.153"></a><span id="l15.153" class="difflineminus">-  getActivities: function(aCount) {</span>
<a href="#l15.154"></a><span id="l15.154" class="difflineplus">+  getActivities(aCount) {</span>
<a href="#l15.155"></a><span id="l15.155">     let list = [...this._activities.values()];</span>
<a href="#l15.156"></a><span id="l15.156"> </span>
<a href="#l15.157"></a><span id="l15.157">     aCount.value = list.length;</span>
<a href="#l15.158"></a><span id="l15.158">     return list;</span>
<a href="#l15.159"></a><span id="l15.159">   },</span>
<a href="#l15.160"></a><span id="l15.160"> </span>
<a href="#l15.161"></a><span id="l15.161" class="difflineminus">-  addListener: function(aListener) {</span>
<a href="#l15.162"></a><span id="l15.162" class="difflineplus">+  addListener(aListener) {</span>
<a href="#l15.163"></a><span id="l15.163">     this.log.info(&quot;addListener\n&quot;);</span>
<a href="#l15.164"></a><span id="l15.164">     this._listeners.push(aListener);</span>
<a href="#l15.165"></a><span id="l15.165">   },</span>
<a href="#l15.166"></a><span id="l15.166"> </span>
<a href="#l15.167"></a><span id="l15.167" class="difflineminus">-  removeListener: function(aListener) {</span>
<a href="#l15.168"></a><span id="l15.168" class="difflineplus">+  removeListener(aListener) {</span>
<a href="#l15.169"></a><span id="l15.169">     this.log.info(&quot;removeListener\n&quot;);</span>
<a href="#l15.170"></a><span id="l15.170">     for (let i = 0; i &lt; this._listeners.length; i++) {</span>
<a href="#l15.171"></a><span id="l15.171">       if (this._listeners[i] == aListener)</span>
<a href="#l15.172"></a><span id="l15.172">         this._listeners.splice(i, 1);</span>
<a href="#l15.173"></a><span id="l15.173">     }</span>
<a href="#l15.174"></a><span id="l15.174">   },</span>
<a href="#l15.175"></a><span id="l15.175"> </span>
<a href="#l15.176"></a><span id="l15.176" class="difflineminus">-  //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l15.177"></a><span id="l15.177" class="difflineminus">-  //// nsISupports</span>
<a href="#l15.178"></a><span id="l15.178" class="difflineminus">-</span>
<a href="#l15.179"></a><span id="l15.179" class="difflineminus">-  QueryInterface: ChromeUtils.generateQI([Ci.nsIActivityManager])</span>
<a href="#l15.180"></a><span id="l15.180" class="difflineplus">+  QueryInterface: ChromeUtils.generateQI([Ci.nsIActivityManager]),</span>
<a href="#l15.181"></a><span id="l15.181"> };</span>
<a href="#l15.182"></a><span id="l15.182"> </span>
<a href="#l15.183"></a><span id="l15.183" class="difflineminus">-////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l15.184"></a><span id="l15.184" class="difflineminus">-//// Module</span>
<a href="#l15.185"></a><span id="l15.185" class="difflineminus">-</span>
<a href="#l15.186"></a><span id="l15.186"> var components = [nsActivityManager];</span>
<a href="#l15.187"></a><span id="l15.187"> var NSGetFactory = XPCOMUtils.generateNSGetFactory(components);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mail/components/activity/nsActivityManagerUI.js</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mail/components/activity/nsActivityManagerUI.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -1,33 +1,23 @@</span>
<a href="#l16.4"></a><span id="l16.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l16.5"></a><span id="l16.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l16.6"></a><span id="l16.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l16.7"></a><span id="l16.7"> </span>
<a href="#l16.8"></a><span id="l16.8"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l16.9"></a><span id="l16.9"> ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l16.10"></a><span id="l16.10"> </span>
<a href="#l16.11"></a><span id="l16.11" class="difflineminus">-////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-//// Constants</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineminus">-</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineminus">-var ACTIVITY_MANAGER_URL = &quot;chrome://messenger/content/activity.xul&quot;;</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineminus">-var PREF_FLASH_COUNT = &quot;messenger.activity.manager.flashCount&quot;;</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineplus">+const ACTIVITY_MANAGER_URL = &quot;chrome://messenger/content/activity.xul&quot;;</span>
<a href="#l16.17"></a><span id="l16.17" class="difflineplus">+const PREF_FLASH_COUNT = &quot;messenger.activity.manager.flashCount&quot;;</span>
<a href="#l16.18"></a><span id="l16.18"> </span>
<a href="#l16.19"></a><span id="l16.19" class="difflineminus">-////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l16.20"></a><span id="l16.20" class="difflineminus">-//// nsActivityManagerUI class</span>
<a href="#l16.21"></a><span id="l16.21" class="difflineminus">-</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineminus">-function nsActivityManagerUI()</span>
<a href="#l16.23"></a><span id="l16.23" class="difflineminus">-{}</span>
<a href="#l16.24"></a><span id="l16.24" class="difflineplus">+function nsActivityManagerUI() {}</span>
<a href="#l16.25"></a><span id="l16.25"> </span>
<a href="#l16.26"></a><span id="l16.26"> nsActivityManagerUI.prototype = {</span>
<a href="#l16.27"></a><span id="l16.27">   classID: Components.ID(&quot;5fa5974e-09cb-40cc-9696-643f8a8d9a06&quot;),</span>
<a href="#l16.28"></a><span id="l16.28"> </span>
<a href="#l16.29"></a><span id="l16.29" class="difflineminus">-  //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l16.30"></a><span id="l16.30" class="difflineminus">-  //// nsIActivityManagerUI</span>
<a href="#l16.31"></a><span id="l16.31" class="difflineminus">-</span>
<a href="#l16.32"></a><span id="l16.32">   show: function show(aWindowContext, aID) {</span>
<a href="#l16.33"></a><span id="l16.33">     // First we see if it is already visible</span>
<a href="#l16.34"></a><span id="l16.34">     let window = this.recentWindow;</span>
<a href="#l16.35"></a><span id="l16.35">     if (window) {</span>
<a href="#l16.36"></a><span id="l16.36">       window.focus();</span>
<a href="#l16.37"></a><span id="l16.37">       return;</span>
<a href="#l16.38"></a><span id="l16.38">     }</span>
<a href="#l16.39"></a><span id="l16.39"> </span>
<a href="#l16.40"></a><span id="l16.40" class="difflineat">@@ -43,26 +33,17 @@ nsActivityManagerUI.prototype = {</span>
<a href="#l16.41"></a><span id="l16.41">                            &quot;chrome,dialog=no,resizable&quot;,</span>
<a href="#l16.42"></a><span id="l16.42">                            {});</span>
<a href="#l16.43"></a><span id="l16.43">   },</span>
<a href="#l16.44"></a><span id="l16.44"> </span>
<a href="#l16.45"></a><span id="l16.45">   get visible() {</span>
<a href="#l16.46"></a><span id="l16.46">     return (null != this.recentWindow);</span>
<a href="#l16.47"></a><span id="l16.47">   },</span>
<a href="#l16.48"></a><span id="l16.48"> </span>
<a href="#l16.49"></a><span id="l16.49" class="difflineminus">-  //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l16.50"></a><span id="l16.50" class="difflineminus">-  //// nsActivityManagerUI</span>
<a href="#l16.51"></a><span id="l16.51" class="difflineminus">-</span>
<a href="#l16.52"></a><span id="l16.52">   get recentWindow() {</span>
<a href="#l16.53"></a><span id="l16.53">     return Services.wm.getMostRecentWindow(&quot;Activity:Manager&quot;);</span>
<a href="#l16.54"></a><span id="l16.54">   },</span>
<a href="#l16.55"></a><span id="l16.55"> </span>
<a href="#l16.56"></a><span id="l16.56" class="difflineminus">-  //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l16.57"></a><span id="l16.57" class="difflineminus">-  //// nsISupports</span>
<a href="#l16.58"></a><span id="l16.58" class="difflineminus">-</span>
<a href="#l16.59"></a><span id="l16.59" class="difflineminus">-  QueryInterface: ChromeUtils.generateQI([Ci.nsIActivityManagerUI])</span>
<a href="#l16.60"></a><span id="l16.60" class="difflineplus">+  QueryInterface: ChromeUtils.generateQI([Ci.nsIActivityManagerUI]),</span>
<a href="#l16.61"></a><span id="l16.61"> };</span>
<a href="#l16.62"></a><span id="l16.62"> </span>
<a href="#l16.63"></a><span id="l16.63" class="difflineminus">-////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l16.64"></a><span id="l16.64" class="difflineminus">-//// Module</span>
<a href="#l16.65"></a><span id="l16.65" class="difflineminus">-</span>
<a href="#l16.66"></a><span id="l16.66"> var components = [nsActivityManagerUI];</span>
<a href="#l16.67"></a><span id="l16.67"> var NSGetFactory = XPCOMUtils.generateNSGetFactory(components);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mail/components/addrbook/content/addressbook.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mail/components/addrbook/content/addressbook.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -20,17 +20,17 @@</span>
<a href="#l17.4"></a><span id="l17.4"> /* globals printEngineWindow */</span>
<a href="#l17.5"></a><span id="l17.5"> // mailnews/base/util/ABQueryUtils.jsm</span>
<a href="#l17.6"></a><span id="l17.6"> /* globals getModelQuery, getSearchTokens, generateQueryURI */</span>
<a href="#l17.7"></a><span id="l17.7"> </span>
<a href="#l17.8"></a><span id="l17.8"> // toolkit/content/globalOverlay.js</span>
<a href="#l17.9"></a><span id="l17.9"> /* globals goUpdateCommand */</span>
<a href="#l17.10"></a><span id="l17.10"> </span>
<a href="#l17.11"></a><span id="l17.11"> // Ensure the activity modules are loaded for this window.</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/activity/activityModules.js&quot;);</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+ChromeUtils.import(&quot;resource:///modules/activity/activityModules.jsm&quot;);</span>
<a href="#l17.14"></a><span id="l17.14"> ChromeUtils.import(&quot;resource:///modules/ABQueryUtils.jsm&quot;);</span>
<a href="#l17.15"></a><span id="l17.15"> ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l17.16"></a><span id="l17.16"> ChromeUtils.import(&quot;resource://gre/modules/PluralForm.jsm&quot;);</span>
<a href="#l17.17"></a><span id="l17.17"> ChromeUtils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l17.18"></a><span id="l17.18"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l17.19"></a><span id="l17.19"> ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l17.20"></a><span id="l17.20"> </span>
<a href="#l17.21"></a><span id="l17.21"> XPCOMUtils.defineLazyModuleGetters(this, {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mail/components/compose/content/MsgComposeCommands.js</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mail/components/compose/content/MsgComposeCommands.js</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -2,17 +2,17 @@</span>
<a href="#l18.4"></a><span id="l18.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l18.5"></a><span id="l18.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l18.6"></a><span id="l18.6"> </span>
<a href="#l18.7"></a><span id="l18.7"> /**</span>
<a href="#l18.8"></a><span id="l18.8">  * Commands for the message composition window.</span>
<a href="#l18.9"></a><span id="l18.9">  */</span>
<a href="#l18.10"></a><span id="l18.10"> </span>
<a href="#l18.11"></a><span id="l18.11"> // Ensure the activity modules are loaded for this window.</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/activity/activityModules.js&quot;);</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+ChromeUtils.import(&quot;resource:///modules/activity/activityModules.jsm&quot;);</span>
<a href="#l18.14"></a><span id="l18.14"> ChromeUtils.import(&quot;resource:///modules/attachmentChecker.js&quot;);</span>
<a href="#l18.15"></a><span id="l18.15"> ChromeUtils.import(&quot;resource:///modules/cloudFileAccounts.js&quot;);</span>
<a href="#l18.16"></a><span id="l18.16"> ChromeUtils.import(&quot;resource:///modules/mimeParser.jsm&quot;);</span>
<a href="#l18.17"></a><span id="l18.17"> ChromeUtils.import(&quot;resource:///modules/errUtils.js&quot;);</span>
<a href="#l18.18"></a><span id="l18.18"> ChromeUtils.import(&quot;resource:///modules/folderUtils.jsm&quot;);</span>
<a href="#l18.19"></a><span id="l18.19"> ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l18.20"></a><span id="l18.20"> ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l18.21"></a><span id="l18.21"> ChromeUtils.import(&quot;resource:///modules/MailUtils.js&quot;);</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

