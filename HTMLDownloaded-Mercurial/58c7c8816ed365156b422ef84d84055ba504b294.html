<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 1203:58c7c8816ed365156b422ef84d84055ba504b294</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 58c7c8816ed365156b422ef84d84055ba504b294" />
<meta property="og:url" content="/comm-central/rev/58c7c8816ed365156b422ef84d84055ba504b294" />
<meta property="og:description" content="Fix bug 392465 - Accept meeting invitation fails (has RECURRENCE-ID but no parent item). r=philipp" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 58c7c8816ed365156b422ef84d84055ba504b294 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/58c7c8816ed365156b422ef84d84055ba504b294">shortlog</a> |
<a href="/comm-central/log/58c7c8816ed365156b422ef84d84055ba504b294">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/58c7c8816ed365156b422ef84d84055ba504b294">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/58c7c8816ed365156b422ef84d84055ba504b294">files</a> |
changeset |
<a href="/comm-central/raw-rev/58c7c8816ed365156b422ef84d84055ba504b294">raw</a>  | <a href="/comm-central/archive/58c7c8816ed365156b422ef84d84055ba504b294.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
Fix <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=392465">bug 392465</a> - Accept meeting invitation fails (has RECURRENCE-ID but no parent item). r=philipp
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#68;&#97;&#110;&#105;&#101;&#108;&#32;&#66;&#111;&#101;&#108;&#122;&#108;&#101;&#32;&#91;&#58;&#100;&#98;&#111;&#93;&#32;&#60;&#100;&#97;&#110;&#105;&#101;&#108;&#46;&#98;&#111;&#101;&#108;&#122;&#108;&#101;&#64;&#115;&#117;&#110;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 24 Nov 2008 12:40:38 +0100</td></tr>

<tr>
 <td>changeset 1203</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/58c7c8816ed365156b422ef84d84055ba504b294">58c7c8816ed365156b422ef84d84055ba504b294</a></td>
</tr>



<tr>
<td>parent 1202</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/2bb74cea362be87cb7db40f7ede67cce852bb671">2bb74cea362be87cb7db40f7ede67cce852bb671</a>
</td>
</tr>

<tr>
<td>child 1204</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/30dfde4050464087a83edc3bb2dc3b5526d721ea">30dfde4050464087a83edc3bb2dc3b5526d721ea</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=58c7c8816ed365156b422ef84d84055ba504b294">929</a></td></tr>
<tr><td>push user</td><td>daniel.boelzle@sun.com</td></tr>
<tr><td>push date</td><td class="date age">Mon, 24 Nov 2008 11:43:25 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@58c7c8816ed3 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=58c7c8816ed365156b422ef84d84055ba504b294">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=58c7c8816ed365156b422ef84d84055ba504b294&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=58c7c8816ed365156b422ef84d84055ba504b294&newProject=comm-central&newRevision=58c7c8816ed365156b422ef84d84055ba504b294&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=58c7c8816ed365156b422ef84d84055ba504b294&newProject=comm-central&newRevision=58c7c8816ed365156b422ef84d84055ba504b294&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=58c7c8816ed365156b422ef84d84055ba504b294&newProject=comm-central&newRevision=58c7c8816ed365156b422ef84d84055ba504b294&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28philipp%29&revcount=50">philipp</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=392465">392465</a></td></tr>




</table></div>

<div class="page_body description">Fix <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=392465">bug 392465</a> - Accept meeting invitation fails (has RECURRENCE-ID but no parent item). r=philipp</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/content/calendar-invitations-manager.js">calendar/base/content/calendar-invitations-manager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/content/calendar-invitations-manager.js">file</a> |
<a href="/comm-central/annotate/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/content/calendar-invitations-manager.js">annotate</a> |
<a href="/comm-central/diff/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/content/calendar-invitations-manager.js">diff</a> |
<a href="/comm-central/comparison/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/content/calendar-invitations-manager.js">comparison</a> |
<a href="/comm-central/log/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/content/calendar-invitations-manager.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/content/calendar-item-editing.js">calendar/base/content/calendar-item-editing.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/content/calendar-item-editing.js">file</a> |
<a href="/comm-central/annotate/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/content/calendar-item-editing.js">annotate</a> |
<a href="/comm-central/diff/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/content/calendar-item-editing.js">diff</a> |
<a href="/comm-central/comparison/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/content/calendar-item-editing.js">comparison</a> |
<a href="/comm-central/log/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/content/calendar-item-editing.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/content/dialogs/calendar-event-dialog.js">calendar/base/content/dialogs/calendar-event-dialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/content/dialogs/calendar-event-dialog.js">file</a> |
<a href="/comm-central/annotate/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/content/dialogs/calendar-event-dialog.js">annotate</a> |
<a href="/comm-central/diff/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/content/dialogs/calendar-event-dialog.js">diff</a> |
<a href="/comm-central/comparison/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/content/dialogs/calendar-event-dialog.js">comparison</a> |
<a href="/comm-central/log/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/content/dialogs/calendar-event-dialog.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/modules/calIteratorUtils.jsm">calendar/base/modules/calIteratorUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/modules/calIteratorUtils.jsm">file</a> |
<a href="/comm-central/annotate/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/modules/calIteratorUtils.jsm">annotate</a> |
<a href="/comm-central/diff/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/modules/calIteratorUtils.jsm">diff</a> |
<a href="/comm-central/comparison/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/modules/calIteratorUtils.jsm">comparison</a> |
<a href="/comm-central/log/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/modules/calIteratorUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/modules/calItipUtils.jsm">calendar/base/modules/calItipUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/modules/calItipUtils.jsm">file</a> |
<a href="/comm-central/annotate/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/modules/calItipUtils.jsm">annotate</a> |
<a href="/comm-central/diff/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/modules/calItipUtils.jsm">diff</a> |
<a href="/comm-central/comparison/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/modules/calItipUtils.jsm">comparison</a> |
<a href="/comm-central/log/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/modules/calItipUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/public/calIItemBase.idl">calendar/base/public/calIItemBase.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/public/calIItemBase.idl">file</a> |
<a href="/comm-central/annotate/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/public/calIItemBase.idl">annotate</a> |
<a href="/comm-central/diff/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/public/calIItemBase.idl">diff</a> |
<a href="/comm-central/comparison/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/public/calIItemBase.idl">comparison</a> |
<a href="/comm-central/log/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/public/calIItemBase.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/public/calIRecurrenceInfo.idl">calendar/base/public/calIRecurrenceInfo.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/public/calIRecurrenceInfo.idl">file</a> |
<a href="/comm-central/annotate/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/public/calIRecurrenceInfo.idl">annotate</a> |
<a href="/comm-central/diff/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/public/calIRecurrenceInfo.idl">diff</a> |
<a href="/comm-central/comparison/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/public/calIRecurrenceInfo.idl">comparison</a> |
<a href="/comm-central/log/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/public/calIRecurrenceInfo.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/src/calEvent.js">calendar/base/src/calEvent.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/src/calEvent.js">file</a> |
<a href="/comm-central/annotate/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/src/calEvent.js">annotate</a> |
<a href="/comm-central/diff/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/src/calEvent.js">diff</a> |
<a href="/comm-central/comparison/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/src/calEvent.js">comparison</a> |
<a href="/comm-central/log/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/src/calEvent.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/src/calIcsParser.js">calendar/base/src/calIcsParser.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/src/calIcsParser.js">file</a> |
<a href="/comm-central/annotate/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/src/calIcsParser.js">annotate</a> |
<a href="/comm-central/diff/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/src/calIcsParser.js">diff</a> |
<a href="/comm-central/comparison/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/src/calIcsParser.js">comparison</a> |
<a href="/comm-central/log/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/src/calIcsParser.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/src/calInternalInterfaces.idl">calendar/base/src/calInternalInterfaces.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/src/calInternalInterfaces.idl">file</a> |
<a href="/comm-central/annotate/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/src/calInternalInterfaces.idl">annotate</a> |
<a href="/comm-central/diff/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/src/calInternalInterfaces.idl">diff</a> |
<a href="/comm-central/comparison/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/src/calInternalInterfaces.idl">comparison</a> |
<a href="/comm-central/log/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/src/calInternalInterfaces.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/src/calItemBase.js">calendar/base/src/calItemBase.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/src/calItemBase.js">file</a> |
<a href="/comm-central/annotate/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/src/calItemBase.js">annotate</a> |
<a href="/comm-central/diff/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/src/calItemBase.js">diff</a> |
<a href="/comm-central/comparison/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/src/calItemBase.js">comparison</a> |
<a href="/comm-central/log/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/src/calItemBase.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/src/calRecurrenceInfo.js">calendar/base/src/calRecurrenceInfo.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/src/calRecurrenceInfo.js">file</a> |
<a href="/comm-central/annotate/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/src/calRecurrenceInfo.js">annotate</a> |
<a href="/comm-central/diff/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/src/calRecurrenceInfo.js">diff</a> |
<a href="/comm-central/comparison/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/src/calRecurrenceInfo.js">comparison</a> |
<a href="/comm-central/log/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/src/calRecurrenceInfo.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/src/calTodo.js">calendar/base/src/calTodo.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/src/calTodo.js">file</a> |
<a href="/comm-central/annotate/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/src/calTodo.js">annotate</a> |
<a href="/comm-central/diff/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/src/calTodo.js">diff</a> |
<a href="/comm-central/comparison/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/src/calTodo.js">comparison</a> |
<a href="/comm-central/log/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/src/calTodo.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/src/calUtils.js">calendar/base/src/calUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/src/calUtils.js">file</a> |
<a href="/comm-central/annotate/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/src/calUtils.js">annotate</a> |
<a href="/comm-central/diff/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/src/calUtils.js">diff</a> |
<a href="/comm-central/comparison/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/src/calUtils.js">comparison</a> |
<a href="/comm-central/log/58c7c8816ed365156b422ef84d84055ba504b294/calendar/base/src/calUtils.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/58c7c8816ed365156b422ef84d84055ba504b294/calendar/providers/gdata/components/calGoogleCalendar.js">calendar/providers/gdata/components/calGoogleCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/58c7c8816ed365156b422ef84d84055ba504b294/calendar/providers/gdata/components/calGoogleCalendar.js">file</a> |
<a href="/comm-central/annotate/58c7c8816ed365156b422ef84d84055ba504b294/calendar/providers/gdata/components/calGoogleCalendar.js">annotate</a> |
<a href="/comm-central/diff/58c7c8816ed365156b422ef84d84055ba504b294/calendar/providers/gdata/components/calGoogleCalendar.js">diff</a> |
<a href="/comm-central/comparison/58c7c8816ed365156b422ef84d84055ba504b294/calendar/providers/gdata/components/calGoogleCalendar.js">comparison</a> |
<a href="/comm-central/log/58c7c8816ed365156b422ef84d84055ba504b294/calendar/providers/gdata/components/calGoogleCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/58c7c8816ed365156b422ef84d84055ba504b294/calendar/providers/memory/calMemoryCalendar.js">calendar/providers/memory/calMemoryCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/58c7c8816ed365156b422ef84d84055ba504b294/calendar/providers/memory/calMemoryCalendar.js">file</a> |
<a href="/comm-central/annotate/58c7c8816ed365156b422ef84d84055ba504b294/calendar/providers/memory/calMemoryCalendar.js">annotate</a> |
<a href="/comm-central/diff/58c7c8816ed365156b422ef84d84055ba504b294/calendar/providers/memory/calMemoryCalendar.js">diff</a> |
<a href="/comm-central/comparison/58c7c8816ed365156b422ef84d84055ba504b294/calendar/providers/memory/calMemoryCalendar.js">comparison</a> |
<a href="/comm-central/log/58c7c8816ed365156b422ef84d84055ba504b294/calendar/providers/memory/calMemoryCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/58c7c8816ed365156b422ef84d84055ba504b294/calendar/providers/storage/calStorageCalendar.js">calendar/providers/storage/calStorageCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/58c7c8816ed365156b422ef84d84055ba504b294/calendar/providers/storage/calStorageCalendar.js">file</a> |
<a href="/comm-central/annotate/58c7c8816ed365156b422ef84d84055ba504b294/calendar/providers/storage/calStorageCalendar.js">annotate</a> |
<a href="/comm-central/diff/58c7c8816ed365156b422ef84d84055ba504b294/calendar/providers/storage/calStorageCalendar.js">diff</a> |
<a href="/comm-central/comparison/58c7c8816ed365156b422ef84d84055ba504b294/calendar/providers/storage/calStorageCalendar.js">comparison</a> |
<a href="/comm-central/log/58c7c8816ed365156b422ef84d84055ba504b294/calendar/providers/storage/calStorageCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/58c7c8816ed365156b422ef84d84055ba504b294/calendar/providers/wcap/calWcapCalendarItems.js">calendar/providers/wcap/calWcapCalendarItems.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/58c7c8816ed365156b422ef84d84055ba504b294/calendar/providers/wcap/calWcapCalendarItems.js">file</a> |
<a href="/comm-central/annotate/58c7c8816ed365156b422ef84d84055ba504b294/calendar/providers/wcap/calWcapCalendarItems.js">annotate</a> |
<a href="/comm-central/diff/58c7c8816ed365156b422ef84d84055ba504b294/calendar/providers/wcap/calWcapCalendarItems.js">diff</a> |
<a href="/comm-central/comparison/58c7c8816ed365156b422ef84d84055ba504b294/calendar/providers/wcap/calWcapCalendarItems.js">comparison</a> |
<a href="/comm-central/log/58c7c8816ed365156b422ef84d84055ba504b294/calendar/providers/wcap/calWcapCalendarItems.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/58c7c8816ed365156b422ef84d84055ba504b294/calendar/test/unit/test_alarm.js">calendar/test/unit/test_alarm.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/58c7c8816ed365156b422ef84d84055ba504b294/calendar/test/unit/test_alarm.js">file</a> |
<a href="/comm-central/annotate/58c7c8816ed365156b422ef84d84055ba504b294/calendar/test/unit/test_alarm.js">annotate</a> |
<a href="/comm-central/diff/58c7c8816ed365156b422ef84d84055ba504b294/calendar/test/unit/test_alarm.js">diff</a> |
<a href="/comm-central/comparison/58c7c8816ed365156b422ef84d84055ba504b294/calendar/test/unit/test_alarm.js">comparison</a> |
<a href="/comm-central/log/58c7c8816ed365156b422ef84d84055ba504b294/calendar/test/unit/test_alarm.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/58c7c8816ed365156b422ef84d84055ba504b294/calendar/test/unit/test_recur.js">calendar/test/unit/test_recur.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/58c7c8816ed365156b422ef84d84055ba504b294/calendar/test/unit/test_recur.js">file</a> |
<a href="/comm-central/annotate/58c7c8816ed365156b422ef84d84055ba504b294/calendar/test/unit/test_recur.js">annotate</a> |
<a href="/comm-central/diff/58c7c8816ed365156b422ef84d84055ba504b294/calendar/test/unit/test_recur.js">diff</a> |
<a href="/comm-central/comparison/58c7c8816ed365156b422ef84d84055ba504b294/calendar/test/unit/test_recur.js">comparison</a> |
<a href="/comm-central/log/58c7c8816ed365156b422ef84d84055ba504b294/calendar/test/unit/test_recur.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/calendar/base/content/calendar-invitations-manager.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/calendar/base/content/calendar-invitations-manager.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -300,17 +300,17 @@ InvitationsManager.prototype = {</span>
<a href="#l1.4"></a><span id="l1.4">     },</span>
<a href="#l1.5"></a><span id="l1.5"> </span>
<a href="#l1.6"></a><span id="l1.6">     addItem: function IM_addItem(item) {</span>
<a href="#l1.7"></a><span id="l1.7">         var recInfo = item.recurrenceInfo;</span>
<a href="#l1.8"></a><span id="l1.8">         if (recInfo &amp;&amp; !cal.isOpenInvitation(item)) {</span>
<a href="#l1.9"></a><span id="l1.9">             // scan exceptions:</span>
<a href="#l1.10"></a><span id="l1.10">             var ids = recInfo.getExceptionIds({});</span>
<a href="#l1.11"></a><span id="l1.11">             for each (var id in ids) {</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-                var ex = recInfo.getExceptionFor(id, false);</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+                var ex = recInfo.getExceptionFor(id);</span>
<a href="#l1.14"></a><span id="l1.14">                 if (ex &amp;&amp; this.validateItem(ex) &amp;&amp; !this.hasItem(ex)) {</span>
<a href="#l1.15"></a><span id="l1.15">                     this.mItemList.push(ex);</span>
<a href="#l1.16"></a><span id="l1.16">                 }</span>
<a href="#l1.17"></a><span id="l1.17">             }</span>
<a href="#l1.18"></a><span id="l1.18">         } else if (this.validateItem(item) &amp;&amp; !this.hasItem(item)) {</span>
<a href="#l1.19"></a><span id="l1.19">             this.mItemList.push(item);</span>
<a href="#l1.20"></a><span id="l1.20">         }</span>
<a href="#l1.21"></a><span id="l1.21">     },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/calendar/base/content/calendar-item-editing.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/calendar/base/content/calendar-item-editing.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -305,18 +305,17 @@ function promptOccurrenceModification(aI</span>
<a href="#l2.4"></a><span id="l2.4"> </span>
<a href="#l2.5"></a><span id="l2.5">     var futureItem = false;</span>
<a href="#l2.6"></a><span id="l2.6">     var pastItem;</span>
<a href="#l2.7"></a><span id="l2.7">     var type = CANCEL;</span>
<a href="#l2.8"></a><span id="l2.8"> </span>
<a href="#l2.9"></a><span id="l2.9">     // Check if this actually is an instance of a recurring event</span>
<a href="#l2.10"></a><span id="l2.10">     if (aItem == aItem.parentItem) {</span>
<a href="#l2.11"></a><span id="l2.11">         type = MODIFY_PARENT;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-    } else if (aItem.parentItem.recurrenceInfo</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-                    .getExceptionFor(aItem.recurrenceId, false) != null) {</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+    } else if (aItem.parentItem.recurrenceInfo.getExceptionFor(aItem.recurrenceId)) {</span>
<a href="#l2.15"></a><span id="l2.15">         // If the user wants to edit an occurrence which is already an exception</span>
<a href="#l2.16"></a><span id="l2.16">         // always edit this single item.</span>
<a href="#l2.17"></a><span id="l2.17">         // XXX  Why? I think its ok to ask also for exceptions.</span>
<a href="#l2.18"></a><span id="l2.18">         type = MODIFY_OCCURRENCE;</span>
<a href="#l2.19"></a><span id="l2.19">     } else {</span>
<a href="#l2.20"></a><span id="l2.20">         // Prompt the user. Setting modal blocks the dialog until it is closed. We</span>
<a href="#l2.21"></a><span id="l2.21">         // use rv to pass our return value.</span>
<a href="#l2.22"></a><span id="l2.22">         var rv = { value: CANCEL, item: aItem, action: aAction};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-event-dialog.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-event-dialog.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -33,16 +33,18 @@</span>
<a href="#l3.4"></a><span id="l3.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l3.5"></a><span id="l3.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l3.6"></a><span id="l3.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l3.7"></a><span id="l3.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l3.8"></a><span id="l3.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l3.9"></a><span id="l3.9">  *</span>
<a href="#l3.10"></a><span id="l3.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+</span>
<a href="#l3.14"></a><span id="l3.14"> // the following variables are constructed if the jsContext this file</span>
<a href="#l3.15"></a><span id="l3.15"> // belongs to gets constructed. all those variables are meant to be accessed</span>
<a href="#l3.16"></a><span id="l3.16"> // from within this file only.</span>
<a href="#l3.17"></a><span id="l3.17"> var gStartTime = null;</span>
<a href="#l3.18"></a><span id="l3.18"> var gEndTime = null;</span>
<a href="#l3.19"></a><span id="l3.19"> var gItemDuration = null;</span>
<a href="#l3.20"></a><span id="l3.20"> var gStartTimezone = null;</span>
<a href="#l3.21"></a><span id="l3.21"> var gEndTimezone = null;</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineat">@@ -150,24 +152,31 @@ function onLoad() {</span>
<a href="#l3.23"></a><span id="l3.23">     window.attendees = [];</span>
<a href="#l3.24"></a><span id="l3.24">     var attendees = item.getAttendees({});</span>
<a href="#l3.25"></a><span id="l3.25">     if (attendees &amp;&amp; attendees.length) {</span>
<a href="#l3.26"></a><span id="l3.26">         for each (var attendee in attendees) {</span>
<a href="#l3.27"></a><span id="l3.27">             window.attendees.push(attendee.clone());</span>
<a href="#l3.28"></a><span id="l3.28">         }</span>
<a href="#l3.29"></a><span id="l3.29">     }</span>
<a href="#l3.30"></a><span id="l3.30"> </span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-    // we store the organizer of the item in the window.</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineminus">-    // TODO: we clone the object since foreign X-props get lost</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineminus">-    // during the roundtrip. In order to detect whether or not</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineminus">-    // the item has been changed by the dialog we clone the organizer</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineminus">-    // in any case to get rid of the X-props.</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineminus">-    window.organizer = item.organizer &amp;&amp; item.organizer.clone();</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineminus">-</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineminus">-    window.isOccurrence = (item != item.parentItem);</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+    if (item.organizer) {</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+        window.organizer = item.organizer.clone();</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+    } else if (item.getAttendees({}).length &gt; 0) {</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineplus">+        // previous versions of calendar may have filled ORGANIZER correctly on overridden instances:</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+        let orgId = item.calendar.getProperty(&quot;organizerId&quot;);</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+        if (orgId) {</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineplus">+            let organizer = cal.createAttendee();</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineplus">+            organizer.id = orgId;</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineplus">+            organizer.commonName = item.calendar.getProperty(&quot;organizerCN&quot;);</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineplus">+            organizer.role = &quot;REQ-PARTICIPANT&quot;;</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineplus">+            organizer.participationStatus = &quot;ACCEPTED&quot;;</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineplus">+            organizer.isOrganizer = true;</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+            window.organizer = organizer;</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineplus">+        }</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineplus">+    }</span>
<a href="#l3.54"></a><span id="l3.54"> </span>
<a href="#l3.55"></a><span id="l3.55">     // we store the recurrence info in the window so it</span>
<a href="#l3.56"></a><span id="l3.56">     // can be accessed from any location. since the recurrence</span>
<a href="#l3.57"></a><span id="l3.57">     // info is a property of the parent item we need to check</span>
<a href="#l3.58"></a><span id="l3.58">     // whether or not this item is a proxy or a parent.</span>
<a href="#l3.59"></a><span id="l3.59">     var parentItem = item;</span>
<a href="#l3.60"></a><span id="l3.60">     if (parentItem.parentItem != parentItem) {</span>
<a href="#l3.61"></a><span id="l3.61">         parentItem = parentItem.parentItem;</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineat">@@ -1866,28 +1875,24 @@ function saveItem() {</span>
<a href="#l3.63"></a><span id="l3.63">     // it is important to not apply the changes to the original item</span>
<a href="#l3.64"></a><span id="l3.64">     // (even if it happens to be mutable) in order to guarantee</span>
<a href="#l3.65"></a><span id="l3.65">     // that providers see a proper oldItem/newItem pair in case</span>
<a href="#l3.66"></a><span id="l3.66">     // they rely on this fact (e.g. WCAP does).</span>
<a href="#l3.67"></a><span id="l3.67">     var originalItem = window.calendarItem;</span>
<a href="#l3.68"></a><span id="l3.68">     var item = originalItem.clone();</span>
<a href="#l3.69"></a><span id="l3.69"> </span>
<a href="#l3.70"></a><span id="l3.70">     // override item's recurrenceInfo *before* serializing date/time-objects.</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineminus">-    if (!window.isOccurrence) {</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineplus">+    if (!item.recurrenceId) {</span>
<a href="#l3.73"></a><span id="l3.73">         item.recurrenceInfo = window.recurrenceInfo;</span>
<a href="#l3.74"></a><span id="l3.74">     }</span>
<a href="#l3.75"></a><span id="l3.75"> </span>
<a href="#l3.76"></a><span id="l3.76">     // serialize the item</span>
<a href="#l3.77"></a><span id="l3.77">     saveDialog(item);</span>
<a href="#l3.78"></a><span id="l3.78"> </span>
<a href="#l3.79"></a><span id="l3.79" class="difflineminus">-    // we set the organizer of this item only if</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineminus">-    // it is a stand-alone instance [not an occurrence].</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineminus">-    if (!window.isOccurrence) {</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineminus">-        item.organizer = window.organizer;</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineminus">-    }</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineplus">+    item.organizer = window.organizer;</span>
<a href="#l3.85"></a><span id="l3.85"> </span>
<a href="#l3.86"></a><span id="l3.86">     item.removeAllAttendees();</span>
<a href="#l3.87"></a><span id="l3.87">     if (window.attendees &amp;&amp; (window.attendees.length &gt; 0)) {</span>
<a href="#l3.88"></a><span id="l3.88">         for each (var attendee in window.attendees) {</span>
<a href="#l3.89"></a><span id="l3.89">            item.addAttendee(attendee);</span>
<a href="#l3.90"></a><span id="l3.90">         }</span>
<a href="#l3.91"></a><span id="l3.91"> </span>
<a href="#l3.92"></a><span id="l3.92">         let notifyCheckbox = document.getElementById(&quot;notify-attendees-checkbox&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/calendar/base/modules/calIteratorUtils.jsm</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/calendar/base/modules/calIteratorUtils.jsm</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -48,17 +48,17 @@ cal.itemIterator = function cal_itemIter</span>
<a href="#l4.4"></a><span id="l4.4">     return {</span>
<a href="#l4.5"></a><span id="l4.5">         __iterator__: function itemIterator(aWantKeys) {</span>
<a href="#l4.6"></a><span id="l4.6">             cal.ASSERT(aWantKeys, &quot;Please use for() on the item iterator&quot;);</span>
<a href="#l4.7"></a><span id="l4.7">             for each (let item in items) {</span>
<a href="#l4.8"></a><span id="l4.8">                 yield item;</span>
<a href="#l4.9"></a><span id="l4.9">                 let rec = item.recurrenceInfo;</span>
<a href="#l4.10"></a><span id="l4.10">                 if (rec) {</span>
<a href="#l4.11"></a><span id="l4.11">                     for each (let exid in rec.getExceptionIds({})) {</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-                        yield rec.getExceptionFor(exid, false);</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+                        yield rec.getExceptionFor(exid);</span>
<a href="#l4.14"></a><span id="l4.14">                     }</span>
<a href="#l4.15"></a><span id="l4.15">                 }</span>
<a href="#l4.16"></a><span id="l4.16">             }</span>
<a href="#l4.17"></a><span id="l4.17">         }</span>
<a href="#l4.18"></a><span id="l4.18">     };</span>
<a href="#l4.19"></a><span id="l4.19"> };</span>
<a href="#l4.20"></a><span id="l4.20"> </span>
<a href="#l4.21"></a><span id="l4.21"> /**</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/calendar/base/modules/calItipUtils.jsm</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/calendar/base/modules/calItipUtils.jsm</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -33,17 +33,16 @@</span>
<a href="#l5.4"></a><span id="l5.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l5.5"></a><span id="l5.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l5.6"></a><span id="l5.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l5.7"></a><span id="l5.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l5.8"></a><span id="l5.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l5.9"></a><span id="l5.9">  *</span>
<a href="#l5.10"></a><span id="l5.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-Components.utils.import(&quot;resource://gre/modules/debug.js&quot;);</span>
<a href="#l5.13"></a><span id="l5.13"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l5.14"></a><span id="l5.14"> Components.utils.import(&quot;resource://calendar/modules/calIteratorUtils.jsm&quot;);</span>
<a href="#l5.15"></a><span id="l5.15"> </span>
<a href="#l5.16"></a><span id="l5.16"> /*</span>
<a href="#l5.17"></a><span id="l5.17">  * Scheduling and iTIP helper code;</span>
<a href="#l5.18"></a><span id="l5.18">  * don't use deliberately, because it'll be moved into interfaces/components.</span>
<a href="#l5.19"></a><span id="l5.19">  *</span>
<a href="#l5.20"></a><span id="l5.20">  * May replace the current calItipProcessor.js code soon.</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineat">@@ -259,25 +258,25 @@ cal.itip = {</span>
<a href="#l5.22"></a><span id="l5.22">             }</span>
<a href="#l5.23"></a><span id="l5.23"> </span>
<a href="#l5.24"></a><span id="l5.24">             for each (let cancAtt in attMap) {</span>
<a href="#l5.25"></a><span id="l5.25">                 canceledAttendees.push(cancAtt);</span>
<a href="#l5.26"></a><span id="l5.26">             }</span>
<a href="#l5.27"></a><span id="l5.27">         }</span>
<a href="#l5.28"></a><span id="l5.28"> </span>
<a href="#l5.29"></a><span id="l5.29">         // Check to see if some part of the item was updated, if so, re-send REQUEST</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineminus">-        if (!aOriginalItem || aItem.generation != aOriginalItem.generation) { // REQUEST</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+        if (!aOriginalItem || (cal.itip.compare(aItem, aOriginalItem) &gt; 0)) { // REQUEST</span>
<a href="#l5.32"></a><span id="l5.32">             let requestItem = aItem.clone();</span>
<a href="#l5.33"></a><span id="l5.33"> </span>
<a href="#l5.34"></a><span id="l5.34">             // check whether it's a simple UPDATE (no SEQUENCE change) or real (RE)REQUEST,</span>
<a href="#l5.35"></a><span id="l5.35">             // in case of time or location/description change.</span>
<a href="#l5.36"></a><span id="l5.36">             let isMinorUpdate = (aOriginalItem &amp;&amp; (cal.itip.getSequence(aItem) == cal.itip.getSequence(aOriginalItem)));</span>
<a href="#l5.37"></a><span id="l5.37"> </span>
<a href="#l5.38"></a><span id="l5.38">             if (!requestItem.organizer) {</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineminus">-                let organizer = createAttendee();</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineplus">+                let organizer = cal.createAttendee();</span>
<a href="#l5.41"></a><span id="l5.41">                 organizer.id = requestItem.calendar.getProperty(&quot;organizerId&quot;);</span>
<a href="#l5.42"></a><span id="l5.42">                 organizer.commonName = requestItem.calendar.getProperty(&quot;organizerCN&quot;);</span>
<a href="#l5.43"></a><span id="l5.43">                 organizer.role = &quot;REQ-PARTICIPANT&quot;;</span>
<a href="#l5.44"></a><span id="l5.44">                 organizer.participationStatus = &quot;ACCEPTED&quot;;</span>
<a href="#l5.45"></a><span id="l5.45">                 organizer.isOrganizer = true;</span>
<a href="#l5.46"></a><span id="l5.46">                 requestItem.organizer = organizer;</span>
<a href="#l5.47"></a><span id="l5.47">             }</span>
<a href="#l5.48"></a><span id="l5.48"> </span>
<a href="#l5.49"></a><span id="l5.49" class="difflineat">@@ -328,29 +327,29 @@ cal.itip = {</span>
<a href="#l5.50"></a><span id="l5.50">             oldItem = oldItem.recurrenceInfo.getOccurrenceFor(newItem.recurrenceId);</span>
<a href="#l5.51"></a><span id="l5.51">             cal.ASSERT(oldItem, &quot;unexpected!&quot;);</span>
<a href="#l5.52"></a><span id="l5.52">             if (!oldItem) {</span>
<a href="#l5.53"></a><span id="l5.53">                 return newItem;</span>
<a href="#l5.54"></a><span id="l5.54">             }</span>
<a href="#l5.55"></a><span id="l5.55">         }</span>
<a href="#l5.56"></a><span id="l5.56"> </span>
<a href="#l5.57"></a><span id="l5.57">         function hashMajorProps(aItem) {</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineminus">-            let propStrings = [];</span>
<a href="#l5.59"></a><span id="l5.59">             const majorProps = {</span>
<a href="#l5.60"></a><span id="l5.60">                 DTSTART: true,</span>
<a href="#l5.61"></a><span id="l5.61">                 DTEND: true,</span>
<a href="#l5.62"></a><span id="l5.62">                 DURATION: true,</span>
<a href="#l5.63"></a><span id="l5.63">                 DUE: true,</span>
<a href="#l5.64"></a><span id="l5.64">                 RDATE: true,</span>
<a href="#l5.65"></a><span id="l5.65">                 RRULE: true,</span>
<a href="#l5.66"></a><span id="l5.66">                 EXDATE: true,</span>
<a href="#l5.67"></a><span id="l5.67">                 STATUS: true,</span>
<a href="#l5.68"></a><span id="l5.68">                 LOCATION: true</span>
<a href="#l5.69"></a><span id="l5.69">             };</span>
<a href="#l5.70"></a><span id="l5.70"> </span>
<a href="#l5.71"></a><span id="l5.71" class="difflineplus">+            let propStrings = [];</span>
<a href="#l5.72"></a><span id="l5.72">             for (let item in cal.itemIterator([aItem])) {</span>
<a href="#l5.73"></a><span id="l5.73">                 for (let prop in cal.ical.propertyIterator(item.icalComponent)) {</span>
<a href="#l5.74"></a><span id="l5.74">                     if (prop.propertyName in majorProps) {</span>
<a href="#l5.75"></a><span id="l5.75">                         propStrings.push(item.recurrenceId + &quot;#&quot; + prop.icalString);</span>
<a href="#l5.76"></a><span id="l5.76">                     }</span>
<a href="#l5.77"></a><span id="l5.77">                 }</span>
<a href="#l5.78"></a><span id="l5.78">             }</span>
<a href="#l5.79"></a><span id="l5.79">             propStrings.sort();</span>
<a href="#l5.80"></a><span id="l5.80" class="difflineat">@@ -385,16 +384,33 @@ function setReceivedInfo(item, itipItemI</span>
<a href="#l5.81"></a><span id="l5.81">     if (dtstamp) {</span>
<a href="#l5.82"></a><span id="l5.82">         item.setProperty(cal.calInstanceOf(item, Components.interfaces.calIAttendee) ? &quot;RECEIVED-DTSTAMP&quot;</span>
<a href="#l5.83"></a><span id="l5.83">                                                                                      : &quot;X-MOZ-RECEIVED-DTSTAMP&quot;,</span>
<a href="#l5.84"></a><span id="l5.84">                          dtstamp.getInTimezone(cal.UTC()).icalString);</span>
<a href="#l5.85"></a><span id="l5.85">     }</span>
<a href="#l5.86"></a><span id="l5.86"> }</span>
<a href="#l5.87"></a><span id="l5.87"> </span>
<a href="#l5.88"></a><span id="l5.88"> /** local to this module file</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineplus">+ * Takes over relevant item information from iTIP item and sets received info.</span>
<a href="#l5.90"></a><span id="l5.90" class="difflineplus">+ *</span>
<a href="#l5.91"></a><span id="l5.91" class="difflineplus">+ * @param item   the stored calendar item to update</span>
<a href="#l5.92"></a><span id="l5.92" class="difflineplus">+ * @param itipItemItem the received item</span>
<a href="#l5.93"></a><span id="l5.93" class="difflineplus">+ */</span>
<a href="#l5.94"></a><span id="l5.94" class="difflineplus">+function updateItem(item, itipItemItem) {</span>
<a href="#l5.95"></a><span id="l5.95" class="difflineplus">+    let newItem = item.clone();</span>
<a href="#l5.96"></a><span id="l5.96" class="difflineplus">+    newItem.icalComponent = itipItemItem.icalComponent;</span>
<a href="#l5.97"></a><span id="l5.97" class="difflineplus">+    setReceivedInfo(newItem, itipItemItem);</span>
<a href="#l5.98"></a><span id="l5.98" class="difflineplus">+    newItem.generation = item.generation;</span>
<a href="#l5.99"></a><span id="l5.99" class="difflineplus">+    newItem.alarmOffset = item.alarmOffset;</span>
<a href="#l5.100"></a><span id="l5.100" class="difflineplus">+    newItem.alarmRelated = item.alarmRelated;</span>
<a href="#l5.101"></a><span id="l5.101" class="difflineplus">+    newItem.alarmLastAck = item.alarmLastAck;</span>
<a href="#l5.102"></a><span id="l5.102" class="difflineplus">+    return newItem;</span>
<a href="#l5.103"></a><span id="l5.103" class="difflineplus">+}</span>
<a href="#l5.104"></a><span id="l5.104" class="difflineplus">+</span>
<a href="#l5.105"></a><span id="l5.105" class="difflineplus">+/** local to this module file</span>
<a href="#l5.106"></a><span id="l5.106">  * Creates an organizer calIAttendee object based on the calendar's configured organizer id.</span>
<a href="#l5.107"></a><span id="l5.107">  *</span>
<a href="#l5.108"></a><span id="l5.108">  * @return calIAttendee object</span>
<a href="#l5.109"></a><span id="l5.109">  */</span>
<a href="#l5.110"></a><span id="l5.110"> function createOrganizer(aCalendar) {</span>
<a href="#l5.111"></a><span id="l5.111">     let orgId = aCalendar.getProperty(&quot;organizerId&quot;);</span>
<a href="#l5.112"></a><span id="l5.112">     if (!orgId) {</span>
<a href="#l5.113"></a><span id="l5.113">         return null;</span>
<a href="#l5.114"></a><span id="l5.114" class="difflineat">@@ -507,45 +523,40 @@ ItipFindItemListener.prototype = {</span>
<a href="#l5.115"></a><span id="l5.115">                                                                            aId,</span>
<a href="#l5.116"></a><span id="l5.116">                                                                            aDetail) {</span>
<a href="#l5.117"></a><span id="l5.117">         let rc = Components.results.NS_OK;</span>
<a href="#l5.118"></a><span id="l5.118">         const method = this.mItipItem.receivedMethod.toUpperCase();</span>
<a href="#l5.119"></a><span id="l5.119">         let actionMethod = method;</span>
<a href="#l5.120"></a><span id="l5.120">         let operations = [];</span>
<a href="#l5.121"></a><span id="l5.121"> </span>
<a href="#l5.122"></a><span id="l5.122">         if (this.mFoundItems.length &gt; 0) {</span>
<a href="#l5.123"></a><span id="l5.123" class="difflineminus">-            cal.LOG(&quot;iTIP on &quot; + method + &quot;: found items.&quot;);</span>
<a href="#l5.124"></a><span id="l5.124" class="difflineplus">+            cal.LOG(&quot;iTIP on &quot; + method + &quot;: found &quot; + this.mFoundItems.length + &quot; items.&quot;);</span>
<a href="#l5.125"></a><span id="l5.125">             switch (method) {</span>
<a href="#l5.126"></a><span id="l5.126">                 // XXX todo: there's still a potential flaw, if multiple PUBLISH/REPLY/REQUEST on</span>
<a href="#l5.127"></a><span id="l5.127">                 //           occurrences happen at once; those lead to multiple</span>
<a href="#l5.128"></a><span id="l5.128">                 //           occurrence modifications. Since those modifications happen</span>
<a href="#l5.129"></a><span id="l5.129">                 //           implicitly on the parent (ics/memory/storage calls modifyException),</span>
<a href="#l5.130"></a><span id="l5.130">                 //           the generation check will fail. We should really consider to allow</span>
<a href="#l5.131"></a><span id="l5.131">                 //           deletion/modification/addition of occurrences directly on the providers,</span>
<a href="#l5.132"></a><span id="l5.132">                 //           which would ease client code a lot.</span>
<a href="#l5.133"></a><span id="l5.133">                 case &quot;REFRESH&quot;:</span>
<a href="#l5.134"></a><span id="l5.134">                 case &quot;PUBLISH&quot;:</span>
<a href="#l5.135"></a><span id="l5.135">                 case &quot;REQUEST&quot;:</span>
<a href="#l5.136"></a><span id="l5.136">                 case &quot;REPLY&quot;:</span>
<a href="#l5.137"></a><span id="l5.137">                     for each (let itipItemItem in this.mItipItem.getItemList({})) {</span>
<a href="#l5.138"></a><span id="l5.138">                         for each (let item in this.mFoundItems) {</span>
<a href="#l5.139"></a><span id="l5.139">                             let rid = itipItemItem.recurrenceId; //  XXX todo support multiple</span>
<a href="#l5.140"></a><span id="l5.140" class="difflineminus">-                            if (rid) { // actually a REPLY to single occurrence(s)</span>
<a href="#l5.141"></a><span id="l5.141" class="difflineplus">+                            if (rid) { // actually applies to individual occurrence(s)</span>
<a href="#l5.142"></a><span id="l5.142">                                 if (item.recurrenceInfo) {</span>
<a href="#l5.143"></a><span id="l5.143">                                     item = item.recurrenceInfo.getOccurrenceFor(rid);</span>
<a href="#l5.144"></a><span id="l5.144">                                     if (!item) {</span>
<a href="#l5.145"></a><span id="l5.145">                                         continue;</span>
<a href="#l5.146"></a><span id="l5.146">                                     }</span>
<a href="#l5.147"></a><span id="l5.147" class="difflineminus">-                                } else if (item.recurrenceId &amp;&amp; (item.recurrenceId.compare(rid) != 0)) {</span>
<a href="#l5.148"></a><span id="l5.148" class="difflineminus">-                                    // filter out non-parentless occurrences (future)</span>
<a href="#l5.149"></a><span id="l5.149" class="difflineminus">-                                    continue;</span>
<a href="#l5.150"></a><span id="l5.150" class="difflineminus">-                                }</span>
<a href="#l5.151"></a><span id="l5.151" class="difflineminus">-                                if (!itipItemItem.parentItem) { // install parent, if known from previous</span>
<a href="#l5.152"></a><span id="l5.152" class="difflineminus">-                                                                // REQUEST/PUBLISH messages</span>
<a href="#l5.153"></a><span id="l5.153" class="difflineminus">-                                    itipItemItem.parentItem = newItem.parentItem;</span>
<a href="#l5.154"></a><span id="l5.154" class="difflineplus">+                                } else { // the item has been rescheduled with master:</span>
<a href="#l5.155"></a><span id="l5.155" class="difflineplus">+                                    itipItemItem = itipItemItem.parentItem;</span>
<a href="#l5.156"></a><span id="l5.156">                                 }</span>
<a href="#l5.157"></a><span id="l5.157">                             }</span>
<a href="#l5.158"></a><span id="l5.158">                             switch (method) {</span>
<a href="#l5.159"></a><span id="l5.159">                                 case &quot;REFRESH&quot;: { // xxx todo test</span>
<a href="#l5.160"></a><span id="l5.160">                                     let attendees = itipItemItem.getAttendees({});</span>
<a href="#l5.161"></a><span id="l5.161">                                     cal.ASSERT(attendees.length == 1, &quot;invalid number of attendees in REFRESH!&quot;);</span>
<a href="#l5.162"></a><span id="l5.162">                                     if (attendees.length &gt; 0) {</span>
<a href="#l5.163"></a><span id="l5.163">                                         let action = function(opListener) {</span>
<a href="#l5.164"></a><span id="l5.164" class="difflineat">@@ -562,55 +573,45 @@ ItipFindItemListener.prototype = {</span>
<a href="#l5.165"></a><span id="l5.165">                                     }</span>
<a href="#l5.166"></a><span id="l5.166">                                     break;</span>
<a href="#l5.167"></a><span id="l5.167">                                 }</span>
<a href="#l5.168"></a><span id="l5.168">                                 case &quot;PUBLISH&quot;:</span>
<a href="#l5.169"></a><span id="l5.169">                                     cal.ASSERT(itipItemItem.getAttendees({}).length == 0,</span>
<a href="#l5.170"></a><span id="l5.170">                                                &quot;invalid number of attendees in PUBLISH!&quot;);</span>
<a href="#l5.171"></a><span id="l5.171">                                     if (item.calendar.getProperty(&quot;itip.disableRevisionChecks&quot;) ||</span>
<a href="#l5.172"></a><span id="l5.172">                                         cal.itip.compare(itipItemItem, item) &gt; 0) {</span>
<a href="#l5.173"></a><span id="l5.173" class="difflineminus">-                                        let newItem = itipItemItem.clone(); // xxx todo, this is dirty</span>
<a href="#l5.174"></a><span id="l5.174" class="difflineminus">-                                        setReceivedInfo(newItem, itipItemItem);</span>
<a href="#l5.175"></a><span id="l5.175" class="difflineminus">-                                        newItem.calendar = item.calendar;</span>
<a href="#l5.176"></a><span id="l5.176" class="difflineminus">-                                        newItem.generation = item.generation;</span>
<a href="#l5.177"></a><span id="l5.177" class="difflineminus">-                                        newItem.alarmOffset = item.alarmOffset;</span>
<a href="#l5.178"></a><span id="l5.178" class="difflineminus">-                                        newItem.alarmRelated = item.alarmRelated;</span>
<a href="#l5.179"></a><span id="l5.179" class="difflineminus">-                                        newItem.alarmLastAck = item.alarmLastAck;</span>
<a href="#l5.180"></a><span id="l5.180" class="difflineplus">+                                        let newItem = updateItem(newItem, itipItemItem);</span>
<a href="#l5.181"></a><span id="l5.181">                                         let action = function(opListener) {</span>
<a href="#l5.182"></a><span id="l5.182">                                             return newItem.calendar.modifyItem(newItem, item, opListener);</span>
<a href="#l5.183"></a><span id="l5.183">                                         };</span>
<a href="#l5.184"></a><span id="l5.184">                                         actionMethod = method + &quot;:UPDATE&quot;;</span>
<a href="#l5.185"></a><span id="l5.185">                                         operations.push(action);</span>
<a href="#l5.186"></a><span id="l5.186">                                     }</span>
<a href="#l5.187"></a><span id="l5.187">                                     break;</span>
<a href="#l5.188"></a><span id="l5.188">                                 case &quot;REQUEST&quot;:</span>
<a href="#l5.189"></a><span id="l5.189">                                     if (item.calendar.getProperty(&quot;itip.disableRevisionChecks&quot;) ||</span>
<a href="#l5.190"></a><span id="l5.190">                                         cal.itip.compare(itipItemItem, item) &gt; 0) {</span>
<a href="#l5.191"></a><span id="l5.191" class="difflineminus">-                                        let newItem = itipItemItem.clone(); // xxx todo, this is dirty</span>
<a href="#l5.192"></a><span id="l5.192" class="difflineminus">-                                        setReceivedInfo(newItem, itipItemItem);</span>
<a href="#l5.193"></a><span id="l5.193" class="difflineminus">-                                        newItem.calendar = item.calendar;</span>
<a href="#l5.194"></a><span id="l5.194" class="difflineminus">-                                        newItem.generation = item.generation;</span>
<a href="#l5.195"></a><span id="l5.195" class="difflineminus">-                                        newItem.alarmOffset = item.alarmOffset;</span>
<a href="#l5.196"></a><span id="l5.196" class="difflineminus">-                                        newItem.alarmRelated = item.alarmRelated;</span>
<a href="#l5.197"></a><span id="l5.197" class="difflineminus">-                                        newItem.alarmLastAck = item.alarmLastAck;</span>
<a href="#l5.198"></a><span id="l5.198" class="difflineplus">+                                        let newItem = updateItem(item, itipItemItem);</span>
<a href="#l5.199"></a><span id="l5.199">                                         let att = cal.getInvitedAttendee(newItem);</span>
<a href="#l5.200"></a><span id="l5.200">                                         if (!att) { // fall back to using configured organizer</span>
<a href="#l5.201"></a><span id="l5.201">                                             att = createOrganizer(newItem.calendar);</span>
<a href="#l5.202"></a><span id="l5.202">                                             if (att) {</span>
<a href="#l5.203"></a><span id="l5.203">                                                 att.isOrganizer = false;</span>
<a href="#l5.204"></a><span id="l5.204" class="difflineminus">-                                                newItem.addAttendee(att);</span>
<a href="#l5.205"></a><span id="l5.205">                                             }</span>
<a href="#l5.206"></a><span id="l5.206">                                         }</span>
<a href="#l5.207"></a><span id="l5.207">                                         if (att) {</span>
<a href="#l5.208"></a><span id="l5.208" class="difflineplus">+                                            newItem.removeAttendee(att);</span>
<a href="#l5.209"></a><span id="l5.209" class="difflineplus">+                                            att = att.clone();</span>
<a href="#l5.210"></a><span id="l5.210">                                             let action = function(opListener, partStat) {</span>
<a href="#l5.211"></a><span id="l5.211">                                                 if (!partStat) { // keep PARTSTAT</span>
<a href="#l5.212"></a><span id="l5.212">                                                     let att_ = cal.getInvitedAttendee(item);</span>
<a href="#l5.213"></a><span id="l5.213">                                                     partStat = (att_ ? att_.participationStatus : &quot;NEEDS-ACTION&quot;);</span>
<a href="#l5.214"></a><span id="l5.214">                                                 }</span>
<a href="#l5.215"></a><span id="l5.215">                                                 att.participationStatus = partStat;</span>
<a href="#l5.216"></a><span id="l5.216" class="difflineplus">+                                                newItem.addAttendee(att);</span>
<a href="#l5.217"></a><span id="l5.217">                                                 return newItem.calendar.modifyItem(</span>
<a href="#l5.218"></a><span id="l5.218">                                                     newItem, item, new ItipOpListener(opListener, item));</span>
<a href="#l5.219"></a><span id="l5.219">                                             };</span>
<a href="#l5.220"></a><span id="l5.220">                                             let isMinorUpdate = (cal.itip.getSequence(newItem) ==</span>
<a href="#l5.221"></a><span id="l5.221">                                                                  cal.itip.getSequence(item));</span>
<a href="#l5.222"></a><span id="l5.222">                                             actionMethod = (isMinorUpdate ? method + &quot;:UPDATE-MINOR&quot;</span>
<a href="#l5.223"></a><span id="l5.223">                                                                           : method + &quot;:UPDATE&quot;);</span>
<a href="#l5.224"></a><span id="l5.224">                                             operations.push(action);</span>
<a href="#l5.225"></a><span id="l5.225" class="difflineat">@@ -692,34 +693,34 @@ ItipFindItemListener.prototype = {</span>
<a href="#l5.226"></a><span id="l5.226">             for each (let itipItemItem in this.mItipItem.getItemList({})) {</span>
<a href="#l5.227"></a><span id="l5.227">                 switch (method) {</span>
<a href="#l5.228"></a><span id="l5.228">                     case &quot;REQUEST&quot;:</span>
<a href="#l5.229"></a><span id="l5.229">                     case &quot;PUBLISH&quot;: {</span>
<a href="#l5.230"></a><span id="l5.230">                         let this_ = this;</span>
<a href="#l5.231"></a><span id="l5.231">                         let action = function(opListener, partStat) {</span>
<a href="#l5.232"></a><span id="l5.232">                             let newItem = itipItemItem.clone();</span>
<a href="#l5.233"></a><span id="l5.233">                             setReceivedInfo(newItem, itipItemItem);</span>
<a href="#l5.234"></a><span id="l5.234" class="difflineminus">-                            newItem.calendar = this_.mItipItem.targetCalendar;</span>
<a href="#l5.235"></a><span id="l5.235" class="difflineplus">+                            newItem.parentItem.calendar = this_.mItipItem.targetCalendar;</span>
<a href="#l5.236"></a><span id="l5.236">                             if (partStat) {</span>
<a href="#l5.237"></a><span id="l5.237">                                 if (partStat != &quot;DECLINED&quot;) {</span>
<a href="#l5.238"></a><span id="l5.238">                                     cal.setDefaultAlarmValues(newItem);</span>
<a href="#l5.239"></a><span id="l5.239">                                 }</span>
<a href="#l5.240"></a><span id="l5.240">                                 let att = cal.getInvitedAttendee(newItem);</span>
<a href="#l5.241"></a><span id="l5.241">                                 if (!att) { // fall back to using configured organizer</span>
<a href="#l5.242"></a><span id="l5.242">                                     att = createOrganizer(newItem.calendar);</span>
<a href="#l5.243"></a><span id="l5.243">                                     if (att) {</span>
<a href="#l5.244"></a><span id="l5.244">                                         att.isOrganizer = false;</span>
<a href="#l5.245"></a><span id="l5.245">                                         newItem.addAttendee(att);</span>
<a href="#l5.246"></a><span id="l5.246">                                     }</span>
<a href="#l5.247"></a><span id="l5.247">                                 }</span>
<a href="#l5.248"></a><span id="l5.248">                                 if (att) {</span>
<a href="#l5.249"></a><span id="l5.249">                                     att.participationStatus = partStat;</span>
<a href="#l5.250"></a><span id="l5.250">                                 } else {</span>
<a href="#l5.251"></a><span id="l5.251">                                     cal.ASSERT(att, &quot;no attendee to reply REQUEST!&quot;);</span>
<a href="#l5.252"></a><span id="l5.252" class="difflineminus">-                                    return;</span>
<a href="#l5.253"></a><span id="l5.253" class="difflineplus">+                                    return null;</span>
<a href="#l5.254"></a><span id="l5.254">                                 }</span>
<a href="#l5.255"></a><span id="l5.255">                             } else {</span>
<a href="#l5.256"></a><span id="l5.256">                                 cal.ASSERT(itipItemItem.getAttendees({}).length == 0,</span>
<a href="#l5.257"></a><span id="l5.257">                                            &quot;invalid number of attendees in PUBLISH!&quot;);</span>
<a href="#l5.258"></a><span id="l5.258">                             }</span>
<a href="#l5.259"></a><span id="l5.259">                             return newItem.calendar.addItem(newItem,</span>
<a href="#l5.260"></a><span id="l5.260">                                                             (method == &quot;REQUEST&quot;)</span>
<a href="#l5.261"></a><span id="l5.261">                                                             ? new ItipOpListener(opListener, null)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/calendar/base/public/calIItemBase.idl</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/calendar/base/public/calIItemBase.idl</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -204,18 +204,35 @@ interface calIItemBase : nsISupports</span>
<a href="#l6.4"></a><span id="l6.4">   // 'inviteEmailAddress' - string</span>
<a href="#l6.5"></a><span id="l6.5">   // alarmLength/alarmUnits/alarmEmailAddress/lastAlarmAck</span>
<a href="#l6.6"></a><span id="l6.6">   // recurInterval/recurCount/recurWeekdays/recurWeeknumber</span>
<a href="#l6.7"></a><span id="l6.7"> </span>
<a href="#l6.8"></a><span id="l6.8">   // these forward to an internal property bag; implemented here, so we can</span>
<a href="#l6.9"></a><span id="l6.9">   // do access control on set/delete to have control over mutability.</span>
<a href="#l6.10"></a><span id="l6.10">   readonly attribute nsISimpleEnumerator propertyEnumerator;</span>
<a href="#l6.11"></a><span id="l6.11">   boolean hasProperty(in AString name);</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+  /**</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+   * Gets a particular property.</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+   * Objects passed back are still owned by the item, e.g. if callers need to</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+   * store or modify a calIDateTime they must clone it.</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+   */</span>
<a href="#l6.18"></a><span id="l6.18">   nsIVariant getProperty(in AString name);</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineplus">+</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+  /**</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineplus">+   * Sets a particular property.</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+   * Ownership of objects gets passed to the item, e.g. callers must not</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineplus">+   * modify a calIDateTime after it's been passed to an item.</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineplus">+   *</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineplus">+   * @warning this reflects the current implementation</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineplus">+   *          xxx todo: rethink whether it's more sensible to store</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineplus">+   *                    clones in calItemBase.</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineplus">+   */</span>
<a href="#l6.29"></a><span id="l6.29">   void setProperty(in AString name, in nsIVariant value);</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineplus">+</span>
<a href="#l6.31"></a><span id="l6.31">   // will not throw an error if you delete a property that doesn't exist</span>
<a href="#l6.32"></a><span id="l6.32">   void deleteProperty(in AString name);</span>
<a href="#l6.33"></a><span id="l6.33"> </span>
<a href="#l6.34"></a><span id="l6.34">   // returns true if the given property is promoted to some</span>
<a href="#l6.35"></a><span id="l6.35">   // top-level attribute (e.g. id or title)</span>
<a href="#l6.36"></a><span id="l6.36">   boolean isPropertyPromoted(in AString name);</span>
<a href="#l6.37"></a><span id="l6.37"> </span>
<a href="#l6.38"></a><span id="l6.38">   /**</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/calendar/base/public/calIRecurrenceInfo.idl</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/calendar/base/public/calIRecurrenceInfo.idl</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -119,20 +119,19 @@ interface calIRecurrenceInfo : nsISuppor</span>
<a href="#l7.4"></a><span id="l7.4">    * @param anItem exceptional/overridden item</span>
<a href="#l7.5"></a><span id="l7.5">    * @param aTakeOverOwnership whether the recurrence info object can take over</span>
<a href="#l7.6"></a><span id="l7.6">    *        the item or needs to clone it</span>
<a href="#l7.7"></a><span id="l7.7">    */</span>
<a href="#l7.8"></a><span id="l7.8">   void modifyException(in calIItemBase anItem, in boolean aTakeOverOwnership);</span>
<a href="#l7.9"></a><span id="l7.9"> </span>
<a href="#l7.10"></a><span id="l7.10">   /**</span>
<a href="#l7.11"></a><span id="l7.11">    * Return an existing exception item for the given recurrence ID.</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-   * If an exception does not exist, and aCreate is set, a new one</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-   * is created and returned.  Otherwise, null is returned.</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+   * If an exception does not exist, null is returned.</span>
<a href="#l7.15"></a><span id="l7.15">    */</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineminus">-  calIItemBase getExceptionFor(in calIDateTime aRecurrenceId, in boolean aCreate);</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+  calIItemBase getExceptionFor(in calIDateTime aRecurrenceId);</span>
<a href="#l7.18"></a><span id="l7.18"> </span>
<a href="#l7.19"></a><span id="l7.19">   /**</span>
<a href="#l7.20"></a><span id="l7.20">    * Removes an exception item for the given recurrence ID, if</span>
<a href="#l7.21"></a><span id="l7.21">    * any exist.</span>
<a href="#l7.22"></a><span id="l7.22">    */</span>
<a href="#l7.23"></a><span id="l7.23">   void removeExceptionFor(in calIDateTime aRecurrenceId);</span>
<a href="#l7.24"></a><span id="l7.24"> </span>
<a href="#l7.25"></a><span id="l7.25">   /**</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/calendar/base/src/calEvent.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/calendar/base/src/calEvent.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -17,34 +17,33 @@</span>
<a href="#l8.4"></a><span id="l8.4">  *  Oracle Corporation</span>
<a href="#l8.5"></a><span id="l8.5">  * Portions created by the Initial Developer are Copyright (C) 2004</span>
<a href="#l8.6"></a><span id="l8.6">  * the Initial Developer. All Rights Reserved.</span>
<a href="#l8.7"></a><span id="l8.7">  *</span>
<a href="#l8.8"></a><span id="l8.8">  * Contributor(s):</span>
<a href="#l8.9"></a><span id="l8.9">  *   Vladimir Vukicevic &lt;vladimir.vukicevic@oracle.com&gt;</span>
<a href="#l8.10"></a><span id="l8.10">  *   Mike Shaver &lt;shaver@off.net&gt;</span>
<a href="#l8.11"></a><span id="l8.11">  *   Philipp Kewisch &lt;mozilla@kewis.ch&gt;</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+ *   Daniel Boelzle &lt;daniel.boelzle@sun.com&gt;</span>
<a href="#l8.13"></a><span id="l8.13">  *</span>
<a href="#l8.14"></a><span id="l8.14">  * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l8.15"></a><span id="l8.15">  * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l8.16"></a><span id="l8.16">  * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l8.17"></a><span id="l8.17">  * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l8.18"></a><span id="l8.18">  * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l8.19"></a><span id="l8.19">  * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l8.20"></a><span id="l8.20">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l8.21"></a><span id="l8.21">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l8.22"></a><span id="l8.22">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l8.23"></a><span id="l8.23">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l8.24"></a><span id="l8.24">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l8.25"></a><span id="l8.25">  *</span>
<a href="#l8.26"></a><span id="l8.26">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l8.27"></a><span id="l8.27"> </span>
<a href="#l8.28"></a><span id="l8.28" class="difflineminus">-//</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineminus">-// calEvent.js</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineminus">-//</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l8.32"></a><span id="l8.32"> </span>
<a href="#l8.33"></a><span id="l8.33"> //</span>
<a href="#l8.34"></a><span id="l8.34"> // constructor</span>
<a href="#l8.35"></a><span id="l8.35"> //</span>
<a href="#l8.36"></a><span id="l8.36"> function calEvent() {</span>
<a href="#l8.37"></a><span id="l8.37">     this.initItemBase();</span>
<a href="#l8.38"></a><span id="l8.38"> </span>
<a href="#l8.39"></a><span id="l8.39">     this.eventPromotedProps = {</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineat">@@ -81,30 +80,35 @@ var calEventClassInfo = {</span>
<a href="#l8.41"></a><span id="l8.41"> calEvent.prototype = {</span>
<a href="#l8.42"></a><span id="l8.42">     __proto__: calItemBase.prototype,</span>
<a href="#l8.43"></a><span id="l8.43"> </span>
<a href="#l8.44"></a><span id="l8.44">     QueryInterface: function (aIID) {</span>
<a href="#l8.45"></a><span id="l8.45">         return doQueryInterface(this, calEvent.prototype, aIID, null, calEventClassInfo);</span>
<a href="#l8.46"></a><span id="l8.46">     },</span>
<a href="#l8.47"></a><span id="l8.47"> </span>
<a href="#l8.48"></a><span id="l8.48">     cloneShallow: function (aNewParent) {</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineminus">-        var m = new calEvent();</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineplus">+        let m = new calEvent();</span>
<a href="#l8.51"></a><span id="l8.51">         this.cloneItemBaseInto(m, aNewParent);</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineminus">-</span>
<a href="#l8.53"></a><span id="l8.53">         return m;</span>
<a href="#l8.54"></a><span id="l8.54">     },</span>
<a href="#l8.55"></a><span id="l8.55"> </span>
<a href="#l8.56"></a><span id="l8.56" class="difflineminus">-    createProxy: function () {</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineminus">-        if (this.mIsProxy) {</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineminus">-            calDebug(&quot;Tried to create a proxy for an existing proxy!\n&quot;);</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineminus">-            throw Components.results.NS_ERROR_UNEXPECTED;</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineminus">-        }</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineplus">+    createProxy: function calEvent_createProxy(aRecurrenceId) {</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineplus">+        cal.ASSERT(!this.mIsProxy, &quot;Tried to create a proxy for an existing proxy!&quot;, true);</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineplus">+</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineplus">+        let m = new calEvent();</span>
<a href="#l8.65"></a><span id="l8.65"> </span>
<a href="#l8.66"></a><span id="l8.66" class="difflineminus">-        var m = new calEvent();</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineminus">-        m.initializeProxy(this);</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineplus">+        // override proxy's DTSTART/DTEND/RECURRENCE-ID</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineplus">+        // before master is set (and item might get immutable):</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineplus">+        let endDate = aRecurrenceId.clone();</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineplus">+        endDate.addDuration(this.duration);</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineplus">+        m.endDate = endDate;</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineplus">+        m.startDate = aRecurrenceId;</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineplus">+</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineplus">+        m.initializeProxy(this, aRecurrenceId);</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineplus">+        m.mDirty = false;</span>
<a href="#l8.77"></a><span id="l8.77"> </span>
<a href="#l8.78"></a><span id="l8.78">         return m;</span>
<a href="#l8.79"></a><span id="l8.79">     },</span>
<a href="#l8.80"></a><span id="l8.80"> </span>
<a href="#l8.81"></a><span id="l8.81">     makeImmutable: function () {</span>
<a href="#l8.82"></a><span id="l8.82">         this.makeItemBaseImmutable();</span>
<a href="#l8.83"></a><span id="l8.83">     },</span>
<a href="#l8.84"></a><span id="l8.84"> </span>
<a href="#l8.85"></a><span id="l8.85" class="difflineat">@@ -166,17 +170,17 @@ calEvent.prototype = {</span>
<a href="#l8.86"></a><span id="l8.86">     set icalComponent(event) {</span>
<a href="#l8.87"></a><span id="l8.87">         this.modify();</span>
<a href="#l8.88"></a><span id="l8.88">         if (event.componentType != &quot;VEVENT&quot;) {</span>
<a href="#l8.89"></a><span id="l8.89">             event = event.getFirstSubcomponent(&quot;VEVENT&quot;);</span>
<a href="#l8.90"></a><span id="l8.90">             if (!event)</span>
<a href="#l8.91"></a><span id="l8.91">                 throw Components.results.NS_ERROR_INVALID_ARG;</span>
<a href="#l8.92"></a><span id="l8.92">         }</span>
<a href="#l8.93"></a><span id="l8.93"> </span>
<a href="#l8.94"></a><span id="l8.94" class="difflineminus">-        // xxx todo: Bug 463195 make sure object is properly reset</span>
<a href="#l8.95"></a><span id="l8.95" class="difflineplus">+        this.mEndDate = undefined;</span>
<a href="#l8.96"></a><span id="l8.96">         this.setItemBaseFromICS(event);</span>
<a href="#l8.97"></a><span id="l8.97">         this.mapPropsFromICS(event, this.icsEventPropMap);</span>
<a href="#l8.98"></a><span id="l8.98"> </span>
<a href="#l8.99"></a><span id="l8.99">         this.importUnpromotedProperties(event, this.eventPromotedProps);</span>
<a href="#l8.100"></a><span id="l8.100"> </span>
<a href="#l8.101"></a><span id="l8.101">         // Importing didn't really change anything</span>
<a href="#l8.102"></a><span id="l8.102">         this.mDirty = false;</span>
<a href="#l8.103"></a><span id="l8.103">     },</span>
<a href="#l8.104"></a><span id="l8.104" class="difflineat">@@ -211,20 +215,17 @@ calEvent.prototype = {</span>
<a href="#l8.105"></a><span id="l8.105">         var endDate = this.mEndDate;</span>
<a href="#l8.106"></a><span id="l8.106">         if (endDate === undefined) {</span>
<a href="#l8.107"></a><span id="l8.107">             endDate = this.getProperty(&quot;DTEND&quot;);</span>
<a href="#l8.108"></a><span id="l8.108">             if (!endDate) {</span>
<a href="#l8.109"></a><span id="l8.109">                 endDate = this.startDate.clone();</span>
<a href="#l8.110"></a><span id="l8.110">                 var dur = this.getProperty(&quot;DURATION&quot;);</span>
<a href="#l8.111"></a><span id="l8.111">                 if (dur) {</span>
<a href="#l8.112"></a><span id="l8.112">                     // If there is a duration set on the event, calculate the right end time.</span>
<a href="#l8.113"></a><span id="l8.113" class="difflineminus">-                    var icalDur = Components.classes[&quot;@mozilla.org/calendar/duration;1&quot;]</span>
<a href="#l8.114"></a><span id="l8.114" class="difflineminus">-                                            .createInstance(Components.interfaces.calIDuration);</span>
<a href="#l8.115"></a><span id="l8.115" class="difflineminus">-                    icalDur.icalString = dur;</span>
<a href="#l8.116"></a><span id="l8.116" class="difflineminus">-                    endDate.addDuration(icalDur);</span>
<a href="#l8.117"></a><span id="l8.117" class="difflineplus">+                    endDate.addDuration(cal.createDuration(dur));</span>
<a href="#l8.118"></a><span id="l8.118">                 } else {</span>
<a href="#l8.119"></a><span id="l8.119">                     // If the start time is a date-time the event ends on the same calendar</span>
<a href="#l8.120"></a><span id="l8.120">                     // date and time of day. If the start time is a date the events</span>
<a href="#l8.121"></a><span id="l8.121">                     // non-inclusive end is the end of the calendar date.</span>
<a href="#l8.122"></a><span id="l8.122">                     if (endDate.isDate) {</span>
<a href="#l8.123"></a><span id="l8.123">                         endDate.day += 1;</span>
<a href="#l8.124"></a><span id="l8.124">                     }</span>
<a href="#l8.125"></a><span id="l8.125">                 }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/calendar/base/src/calIcsParser.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/calendar/base/src/calIcsParser.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -137,18 +137,16 @@ function ip_parseString(aICSString, aTzP</span>
<a href="#l9.4"></a><span id="l9.4"> </span>
<a href="#l9.5"></a><span id="l9.5">                 let rid = item.recurrenceId;</span>
<a href="#l9.6"></a><span id="l9.6">                 if (!rid) {</span>
<a href="#l9.7"></a><span id="l9.7">                     this.mItems.push(item);</span>
<a href="#l9.8"></a><span id="l9.8">                     if (item.recurrenceInfo) {</span>
<a href="#l9.9"></a><span id="l9.9">                         uid2parent[item.id] = item;</span>
<a href="#l9.10"></a><span id="l9.10">                     }</span>
<a href="#l9.11"></a><span id="l9.11">                 } else {</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-                    // force no recurrence info:</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-                    item.recurrenceInfo = null;</span>
<a href="#l9.14"></a><span id="l9.14">                     excItems.push(item);</span>
<a href="#l9.15"></a><span id="l9.15">                 }</span>
<a href="#l9.16"></a><span id="l9.16">             }</span>
<a href="#l9.17"></a><span id="l9.17">         }</span>
<a href="#l9.18"></a><span id="l9.18">         calComp = rootComp.getNextSubcomponent(&quot;VCALENDAR&quot;);</span>
<a href="#l9.19"></a><span id="l9.19">     }</span>
<a href="#l9.20"></a><span id="l9.20"> </span>
<a href="#l9.21"></a><span id="l9.21">     // tag &quot;exceptions&quot;, i.e. items with rid:</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/calendar/base/src/calInternalInterfaces.idl</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/calendar/base/src/calInternalInterfaces.idl</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -37,24 +37,27 @@</span>
<a href="#l10.4"></a><span id="l10.4">  *</span>
<a href="#l10.5"></a><span id="l10.5">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l10.6"></a><span id="l10.6"> </span>
<a href="#l10.7"></a><span id="l10.7"> /** Don't use these if you're not the calendar glue code! **/</span>
<a href="#l10.8"></a><span id="l10.8"> </span>
<a href="#l10.9"></a><span id="l10.9"> #include &quot;nsISupports.idl&quot;</span>
<a href="#l10.10"></a><span id="l10.10"> </span>
<a href="#l10.11"></a><span id="l10.11"> interface calIItemBase;</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+interface calIDateTime;</span>
<a href="#l10.13"></a><span id="l10.13"> </span>
<a href="#l10.14"></a><span id="l10.14"> [scriptable, uuid(1903648f-a0ee-4ae1-84b0-d8e8d0b10506)]</span>
<a href="#l10.15"></a><span id="l10.15"> interface calIInternalShallowCopy : nsISupports</span>
<a href="#l10.16"></a><span id="l10.16"> {</span>
<a href="#l10.17"></a><span id="l10.17">   /**</span>
<a href="#l10.18"></a><span id="l10.18">    * create a proxy for this item; the returned item</span>
<a href="#l10.19"></a><span id="l10.19">    * proxy will have parentItem set to this instance.</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineplus">+   *</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineplus">+   * @param aRecurrenceId RECURRENCE-ID of the proxy to be created </span>
<a href="#l10.22"></a><span id="l10.22">    */</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineminus">-  calIItemBase createProxy();</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineplus">+  calIItemBase createProxy(in calIDateTime aRecurrenceId);</span>
<a href="#l10.25"></a><span id="l10.25"> </span>
<a href="#l10.26"></a><span id="l10.26">   // used by recurrenceInfo when cloning proxy objects to</span>
<a href="#l10.27"></a><span id="l10.27">   // avoid an infinite loop.  aNewParent is optional, and is</span>
<a href="#l10.28"></a><span id="l10.28">   // used to set the parent of the new item; it should be null</span>
<a href="#l10.29"></a><span id="l10.29">   // if no new parent is passed in.</span>
<a href="#l10.30"></a><span id="l10.30">   calIItemBase cloneShallow(in calIItemBase aNewParent);</span>
<a href="#l10.31"></a><span id="l10.31"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/calendar/base/src/calItemBase.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/calendar/base/src/calItemBase.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -43,23 +43,31 @@</span>
<a href="#l11.4"></a><span id="l11.4"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l11.5"></a><span id="l11.5"> Components.utils.import(&quot;resource://calendar/modules/calIteratorUtils.jsm&quot;);</span>
<a href="#l11.6"></a><span id="l11.6"> </span>
<a href="#l11.7"></a><span id="l11.7"> //</span>
<a href="#l11.8"></a><span id="l11.8"> // calItemBase.js</span>
<a href="#l11.9"></a><span id="l11.9"> //</span>
<a href="#l11.10"></a><span id="l11.10"> </span>
<a href="#l11.11"></a><span id="l11.11"> function calItemBase() {</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-    ASSERT(false, &quot;Inheriting objects call initItemBase!&quot;);</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+    cal.ASSERT(false, &quot;Inheriting objects call initItemBase()!&quot;);</span>
<a href="#l11.14"></a><span id="l11.14"> }</span>
<a href="#l11.15"></a><span id="l11.15"> </span>
<a href="#l11.16"></a><span id="l11.16"> calItemBase.prototype = {</span>
<a href="#l11.17"></a><span id="l11.17">     mPropertyParams: null,</span>
<a href="#l11.18"></a><span id="l11.18">     mIsProxy: false,</span>
<a href="#l11.19"></a><span id="l11.19"> </span>
<a href="#l11.20"></a><span id="l11.20" class="difflineplus">+    // initialize this class's members</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineplus">+    initItemBase: function cib_initItemBase() {</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineplus">+        this.wrappedJSObject = this;</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineplus">+        this.mProperties = new calPropertyBag();</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineplus">+        this.mPropertyParams = {};</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineplus">+        this.mProperties.setProperty(&quot;CREATED&quot;, jsDateToDateTime(new Date()));</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineplus">+    },</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineplus">+</span>
<a href="#l11.28"></a><span id="l11.28">     QueryInterface: function (aIID) {</span>
<a href="#l11.29"></a><span id="l11.29">         return doQueryInterface(this, calItemBase.prototype, aIID,</span>
<a href="#l11.30"></a><span id="l11.30">                                 [Components.interfaces.calIItemBase]);</span>
<a href="#l11.31"></a><span id="l11.31">     },</span>
<a href="#l11.32"></a><span id="l11.32"> </span>
<a href="#l11.33"></a><span id="l11.33">     mHashId: null,</span>
<a href="#l11.34"></a><span id="l11.34">     get hashId() {</span>
<a href="#l11.35"></a><span id="l11.35">         if (this.mHashId === null) {</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineat">@@ -72,90 +80,77 @@ calItemBase.prototype = {</span>
<a href="#l11.37"></a><span id="l11.37">         }</span>
<a href="#l11.38"></a><span id="l11.38">         return this.mHashId;</span>
<a href="#l11.39"></a><span id="l11.39">     },</span>
<a href="#l11.40"></a><span id="l11.40"> </span>
<a href="#l11.41"></a><span id="l11.41">     get id() {</span>
<a href="#l11.42"></a><span id="l11.42">         return this.getProperty(&quot;UID&quot;);</span>
<a href="#l11.43"></a><span id="l11.43">     },</span>
<a href="#l11.44"></a><span id="l11.44">     set id(uid) {</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineminus">-        this.modify();</span>
<a href="#l11.46"></a><span id="l11.46">         this.mHashId = null; // recompute hashId</span>
<a href="#l11.47"></a><span id="l11.47">         return this.setProperty(&quot;UID&quot;, uid);</span>
<a href="#l11.48"></a><span id="l11.48">     },</span>
<a href="#l11.49"></a><span id="l11.49"> </span>
<a href="#l11.50"></a><span id="l11.50">     get recurrenceId() {</span>
<a href="#l11.51"></a><span id="l11.51">         return this.getProperty(&quot;RECURRENCE-ID&quot;);</span>
<a href="#l11.52"></a><span id="l11.52">     },</span>
<a href="#l11.53"></a><span id="l11.53">     set recurrenceId(rid) {</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineminus">-        this.modify();</span>
<a href="#l11.55"></a><span id="l11.55">         this.mHashId = null; // recompute hashId</span>
<a href="#l11.56"></a><span id="l11.56">         return this.setProperty(&quot;RECURRENCE-ID&quot;, rid);</span>
<a href="#l11.57"></a><span id="l11.57">     },</span>
<a href="#l11.58"></a><span id="l11.58"> </span>
<a href="#l11.59"></a><span id="l11.59">     get recurrenceInfo() {</span>
<a href="#l11.60"></a><span id="l11.60">         return this.mRecurrenceInfo;</span>
<a href="#l11.61"></a><span id="l11.61">     },</span>
<a href="#l11.62"></a><span id="l11.62">     set recurrenceInfo(value) {</span>
<a href="#l11.63"></a><span id="l11.63">         this.modify();</span>
<a href="#l11.64"></a><span id="l11.64">         return (this.mRecurrenceInfo = calTryWrappedJSObject(value));</span>
<a href="#l11.65"></a><span id="l11.65">     },</span>
<a href="#l11.66"></a><span id="l11.66"> </span>
<a href="#l11.67"></a><span id="l11.67">     mParentItem: null,</span>
<a href="#l11.68"></a><span id="l11.68">     get parentItem() {</span>
<a href="#l11.69"></a><span id="l11.69" class="difflineminus">-        if (this.mParentItem)</span>
<a href="#l11.70"></a><span id="l11.70" class="difflineminus">-            return this.mParentItem;</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineminus">-        else</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineminus">-            return this;</span>
<a href="#l11.73"></a><span id="l11.73" class="difflineplus">+        return (this.mParentItem || this);</span>
<a href="#l11.74"></a><span id="l11.74">     },</span>
<a href="#l11.75"></a><span id="l11.75">     set parentItem(value) {</span>
<a href="#l11.76"></a><span id="l11.76">         if (this.mImmutable)</span>
<a href="#l11.77"></a><span id="l11.77">             throw Components.results.NS_ERROR_OBJECT_IS_IMMUTABLE;</span>
<a href="#l11.78"></a><span id="l11.78">         return (this.mParentItem = calTryWrappedJSObject(value));</span>
<a href="#l11.79"></a><span id="l11.79">     },</span>
<a href="#l11.80"></a><span id="l11.80"> </span>
<a href="#l11.81"></a><span id="l11.81" class="difflineminus">-    initializeProxy: function (aParentItem) {</span>
<a href="#l11.82"></a><span id="l11.82" class="difflineminus">-        if (this.mImmutable)</span>
<a href="#l11.83"></a><span id="l11.83" class="difflineminus">-            throw Components.results.NS_ERROR_OBJECT_IS_IMMUTABLE;</span>
<a href="#l11.84"></a><span id="l11.84" class="difflineminus">-</span>
<a href="#l11.85"></a><span id="l11.85" class="difflineminus">-        if (this.mParentItem != null)</span>
<a href="#l11.86"></a><span id="l11.86" class="difflineminus">-            throw Components.results.NS_ERROR_FAILURE;</span>
<a href="#l11.87"></a><span id="l11.87" class="difflineplus">+    initializeProxy: function cib_initializeProxy(aParentItem, aRecurrenceId) {</span>
<a href="#l11.88"></a><span id="l11.88" class="difflineplus">+        this.mIsProxy = true;</span>
<a href="#l11.89"></a><span id="l11.89"> </span>
<a href="#l11.90"></a><span id="l11.90">         aParentItem = calTryWrappedJSObject(aParentItem);</span>
<a href="#l11.91"></a><span id="l11.91">         this.mParentItem = aParentItem;</span>
<a href="#l11.92"></a><span id="l11.92">         this.mCalendar = aParentItem.mCalendar;</span>
<a href="#l11.93"></a><span id="l11.93" class="difflineminus">-        this.mIsProxy = true;</span>
<a href="#l11.94"></a><span id="l11.94" class="difflineplus">+        this.recurrenceId = aRecurrenceId;</span>
<a href="#l11.95"></a><span id="l11.95" class="difflineplus">+</span>
<a href="#l11.96"></a><span id="l11.96" class="difflineplus">+        this.mImmutable = aParentItem.mImmutable;</span>
<a href="#l11.97"></a><span id="l11.97">     },</span>
<a href="#l11.98"></a><span id="l11.98"> </span>
<a href="#l11.99"></a><span id="l11.99">     //</span>
<a href="#l11.100"></a><span id="l11.100">     // calIItemBase</span>
<a href="#l11.101"></a><span id="l11.101">     //</span>
<a href="#l11.102"></a><span id="l11.102">     mImmutable: false,</span>
<a href="#l11.103"></a><span id="l11.103">     get isMutable() { return !this.mImmutable; },</span>
<a href="#l11.104"></a><span id="l11.104"> </span>
<a href="#l11.105"></a><span id="l11.105">     mDirty: false,</span>
<a href="#l11.106"></a><span id="l11.106">     modify: function() {</span>
<a href="#l11.107"></a><span id="l11.107">         if (this.mImmutable)</span>
<a href="#l11.108"></a><span id="l11.108">             throw Components.results.NS_ERROR_OBJECT_IS_IMMUTABLE;</span>
<a href="#l11.109"></a><span id="l11.109">         this.mDirty = true;</span>
<a href="#l11.110"></a><span id="l11.110">     },</span>
<a href="#l11.111"></a><span id="l11.111"> </span>
<a href="#l11.112"></a><span id="l11.112">     ensureNotDirty: function() {</span>
<a href="#l11.113"></a><span id="l11.113" class="difflineminus">-        if (!this.mDirty) {</span>
<a href="#l11.114"></a><span id="l11.114" class="difflineminus">-            return;</span>
<a href="#l11.115"></a><span id="l11.115" class="difflineplus">+        if (this.mDirty) {</span>
<a href="#l11.116"></a><span id="l11.116" class="difflineplus">+            let now = jsDateToDateTime(new Date());</span>
<a href="#l11.117"></a><span id="l11.117" class="difflineplus">+            this.setProperty(&quot;LAST-MODIFIED&quot;, now);</span>
<a href="#l11.118"></a><span id="l11.118" class="difflineplus">+            this.setProperty(&quot;DTSTAMP&quot;, now);</span>
<a href="#l11.119"></a><span id="l11.119" class="difflineplus">+            this.mDirty = false;</span>
<a href="#l11.120"></a><span id="l11.120">         }</span>
<a href="#l11.121"></a><span id="l11.121" class="difflineminus">-        if (this.mImmutable) {</span>
<a href="#l11.122"></a><span id="l11.122" class="difflineminus">-            dump (&quot;### Something tried to undirty a dirty immutable event!\n&quot;);</span>
<a href="#l11.123"></a><span id="l11.123" class="difflineminus">-            throw Components.results.NS_ERROR_OBJECT_IS_IMMUTABLE;</span>
<a href="#l11.124"></a><span id="l11.124" class="difflineminus">-        }</span>
<a href="#l11.125"></a><span id="l11.125" class="difflineminus">-</span>
<a href="#l11.126"></a><span id="l11.126" class="difflineminus">-        var now = jsDateToDateTime(new Date());</span>
<a href="#l11.127"></a><span id="l11.127" class="difflineminus">-        this.setProperty(&quot;LAST-MODIFIED&quot;, now);</span>
<a href="#l11.128"></a><span id="l11.128" class="difflineminus">-        this.setProperty(&quot;DTSTAMP&quot;, now.clone());</span>
<a href="#l11.129"></a><span id="l11.129" class="difflineminus">-        this.mDirty = false;</span>
<a href="#l11.130"></a><span id="l11.130">     },</span>
<a href="#l11.131"></a><span id="l11.131"> </span>
<a href="#l11.132"></a><span id="l11.132">     makeItemBaseImmutable: function() {</span>
<a href="#l11.133"></a><span id="l11.133">         if (this.mImmutable) {</span>
<a href="#l11.134"></a><span id="l11.134">             return;</span>
<a href="#l11.135"></a><span id="l11.135">         }</span>
<a href="#l11.136"></a><span id="l11.136"> </span>
<a href="#l11.137"></a><span id="l11.137">         // make all our components immutable</span>
<a href="#l11.138"></a><span id="l11.138" class="difflineat">@@ -171,53 +166,34 @@ calItemBase.prototype = {</span>
<a href="#l11.139"></a><span id="l11.139"> </span>
<a href="#l11.140"></a><span id="l11.140">         for each (let [propKey, propValue] in this.mProperties) {</span>
<a href="#l11.141"></a><span id="l11.141">             if (propValue instanceof Components.interfaces.calIDateTime &amp;&amp;</span>
<a href="#l11.142"></a><span id="l11.142">                 propValue.isMutable) {</span>
<a href="#l11.143"></a><span id="l11.143">                 propValue.makeImmutable();</span>
<a href="#l11.144"></a><span id="l11.144">             }</span>
<a href="#l11.145"></a><span id="l11.145">         }</span>
<a href="#l11.146"></a><span id="l11.146"> </span>
<a href="#l11.147"></a><span id="l11.147" class="difflineminus">-        if (this.alarmOffset) {</span>
<a href="#l11.148"></a><span id="l11.148" class="difflineminus">-            this.alarmOffset.makeImmutable();</span>
<a href="#l11.149"></a><span id="l11.149" class="difflineplus">+        if (this.mAlarmOffset) {</span>
<a href="#l11.150"></a><span id="l11.150" class="difflineplus">+            this.mAlarmOffset.makeImmutable();</span>
<a href="#l11.151"></a><span id="l11.151">         }</span>
<a href="#l11.152"></a><span id="l11.152" class="difflineminus">-        if (this.alarmLastAck) {</span>
<a href="#l11.153"></a><span id="l11.153" class="difflineminus">-            this.alarmLastAck.makeImmutable();</span>
<a href="#l11.154"></a><span id="l11.154" class="difflineplus">+        if (this.mAlarmLastAck) {</span>
<a href="#l11.155"></a><span id="l11.155" class="difflineplus">+            this.mAlarmLastAck.makeImmutable();</span>
<a href="#l11.156"></a><span id="l11.156">         }</span>
<a href="#l11.157"></a><span id="l11.157"> </span>
<a href="#l11.158"></a><span id="l11.158">         this.ensureNotDirty();</span>
<a href="#l11.159"></a><span id="l11.159">         this.mImmutable = true;</span>
<a href="#l11.160"></a><span id="l11.160">     },</span>
<a href="#l11.161"></a><span id="l11.161"> </span>
<a href="#l11.162"></a><span id="l11.162">     hasSameIds: function(that) {</span>
<a href="#l11.163"></a><span id="l11.163">         return (that &amp;&amp; this.id == that.id &amp;&amp;</span>
<a href="#l11.164"></a><span id="l11.164">                 (this.recurrenceId == that.recurrenceId || // both null</span>
<a href="#l11.165"></a><span id="l11.165">                  (this.recurrenceId &amp;&amp; that.recurrenceId &amp;&amp;</span>
<a href="#l11.166"></a><span id="l11.166">                   this.recurrenceId.compare(that.recurrenceId) == 0)));</span>
<a href="#l11.167"></a><span id="l11.167">     },</span>
<a href="#l11.168"></a><span id="l11.168"> </span>
<a href="#l11.169"></a><span id="l11.169" class="difflineminus">-    // initialize this class's members</span>
<a href="#l11.170"></a><span id="l11.170" class="difflineminus">-    initItemBase: function () {</span>
<a href="#l11.171"></a><span id="l11.171" class="difflineminus">-        this.wrappedJSObject = this;</span>
<a href="#l11.172"></a><span id="l11.172" class="difflineminus">-        var now = jsDateToDateTime(new Date());</span>
<a href="#l11.173"></a><span id="l11.173" class="difflineminus">-</span>
<a href="#l11.174"></a><span id="l11.174" class="difflineminus">-        this.mProperties = new calPropertyBag();</span>
<a href="#l11.175"></a><span id="l11.175" class="difflineminus">-        this.mPropertyParams = {};</span>
<a href="#l11.176"></a><span id="l11.176" class="difflineminus">-</span>
<a href="#l11.177"></a><span id="l11.177" class="difflineminus">-        this.setProperty(&quot;CREATED&quot;, now);</span>
<a href="#l11.178"></a><span id="l11.178" class="difflineminus">-</span>
<a href="#l11.179"></a><span id="l11.179" class="difflineminus">-        this.mAttendees = null;</span>
<a href="#l11.180"></a><span id="l11.180" class="difflineminus">-</span>
<a href="#l11.181"></a><span id="l11.181" class="difflineminus">-        this.mRecurrenceInfo = null;</span>
<a href="#l11.182"></a><span id="l11.182" class="difflineminus">-</span>
<a href="#l11.183"></a><span id="l11.183" class="difflineminus">-        this.mAttachments = null;</span>
<a href="#l11.184"></a><span id="l11.184" class="difflineminus">-</span>
<a href="#l11.185"></a><span id="l11.185" class="difflineminus">-        this.mRelations = null;</span>
<a href="#l11.186"></a><span id="l11.186" class="difflineminus">-    },</span>
<a href="#l11.187"></a><span id="l11.187" class="difflineminus">-</span>
<a href="#l11.188"></a><span id="l11.188">     clone: function () {</span>
<a href="#l11.189"></a><span id="l11.189">         return this.cloneShallow(this.mParentItem);</span>
<a href="#l11.190"></a><span id="l11.190">     },</span>
<a href="#l11.191"></a><span id="l11.191"> </span>
<a href="#l11.192"></a><span id="l11.192">     // for subclasses to use; copies the ItemBase's values</span>
<a href="#l11.193"></a><span id="l11.193">     // into m. aNewParent is optional</span>
<a href="#l11.194"></a><span id="l11.194">     cloneItemBaseInto: function (m, aNewParent) {</span>
<a href="#l11.195"></a><span id="l11.195">         m.mImmutable = false;</span>
<a href="#l11.196"></a><span id="l11.196" class="difflineat">@@ -225,27 +201,26 @@ calItemBase.prototype = {</span>
<a href="#l11.197"></a><span id="l11.197">         m.mParentItem = (calTryWrappedJSObject(aNewParent) || this.mParentItem);</span>
<a href="#l11.198"></a><span id="l11.198">         m.mHashId = this.mHashId;</span>
<a href="#l11.199"></a><span id="l11.199">         m.mCalendar = this.mCalendar;</span>
<a href="#l11.200"></a><span id="l11.200">         if (this.mRecurrenceInfo) {</span>
<a href="#l11.201"></a><span id="l11.201">             m.mRecurrenceInfo = calTryWrappedJSObject(this.mRecurrenceInfo.clone());</span>
<a href="#l11.202"></a><span id="l11.202">             m.mRecurrenceInfo.item = m;</span>
<a href="#l11.203"></a><span id="l11.203">         }</span>
<a href="#l11.204"></a><span id="l11.204"> </span>
<a href="#l11.205"></a><span id="l11.205" class="difflineminus">-        if (this.mOrganizer) {</span>
<a href="#l11.206"></a><span id="l11.206" class="difflineminus">-            m.mOrganizer = this.mOrganizer.clone();</span>
<a href="#l11.207"></a><span id="l11.207" class="difflineplus">+        let org = this.organizer;</span>
<a href="#l11.208"></a><span id="l11.208" class="difflineplus">+        if (org) {</span>
<a href="#l11.209"></a><span id="l11.209" class="difflineplus">+            org = org.clone();</span>
<a href="#l11.210"></a><span id="l11.210">         }</span>
<a href="#l11.211"></a><span id="l11.211" class="difflineplus">+        m.mOrganizer = org;</span>
<a href="#l11.212"></a><span id="l11.212"> </span>
<a href="#l11.213"></a><span id="l11.213" class="difflineminus">-        if (this.mAttendees) {</span>
<a href="#l11.214"></a><span id="l11.214" class="difflineminus">-            m.mAttendees = new Array(this.mAttendees.length);</span>
<a href="#l11.215"></a><span id="l11.215" class="difflineminus">-            for (var i = 0; i &lt; this.mAttendees.length; i++)</span>
<a href="#l11.216"></a><span id="l11.216" class="difflineminus">-                m.mAttendees[i] = this.mAttendees[i].clone();</span>
<a href="#l11.217"></a><span id="l11.217" class="difflineplus">+        m.mAttendees = [];</span>
<a href="#l11.218"></a><span id="l11.218" class="difflineplus">+        for each (let att in this.getAttendees({})) {</span>
<a href="#l11.219"></a><span id="l11.219" class="difflineplus">+            m.mAttendees.push(att.clone());</span>
<a href="#l11.220"></a><span id="l11.220">         }</span>
<a href="#l11.221"></a><span id="l11.221" class="difflineminus">-        else</span>
<a href="#l11.222"></a><span id="l11.222" class="difflineminus">-            m.mAttendees = null;</span>
<a href="#l11.223"></a><span id="l11.223"> </span>
<a href="#l11.224"></a><span id="l11.224">         m.mProperties = new calPropertyBag();</span>
<a href="#l11.225"></a><span id="l11.225">         for each (let [name, value] in this.mProperties) {</span>
<a href="#l11.226"></a><span id="l11.226">             if (value instanceof Components.interfaces.calIDateTime) {</span>
<a href="#l11.227"></a><span id="l11.227">                 value = value.clone();</span>
<a href="#l11.228"></a><span id="l11.228">             }</span>
<a href="#l11.229"></a><span id="l11.229"> </span>
<a href="#l11.230"></a><span id="l11.230">             m.mProperties.setProperty(name, value);</span>
<a href="#l11.231"></a><span id="l11.231" class="difflineat">@@ -255,39 +230,37 @@ calItemBase.prototype = {</span>
<a href="#l11.232"></a><span id="l11.232">                 let newBucket = {};</span>
<a href="#l11.233"></a><span id="l11.233">                 for (let param in propBucket) {</span>
<a href="#l11.234"></a><span id="l11.234">                     newBucket[param] = propBucket[param];</span>
<a href="#l11.235"></a><span id="l11.235">                 }</span>
<a href="#l11.236"></a><span id="l11.236">                 m.mPropertyParams[name] = newBucket;</span>
<a href="#l11.237"></a><span id="l11.237">             }</span>
<a href="#l11.238"></a><span id="l11.238">         }</span>
<a href="#l11.239"></a><span id="l11.239"> </span>
<a href="#l11.240"></a><span id="l11.240" class="difflineminus">-        if (this.mAttachments) {</span>
<a href="#l11.241"></a><span id="l11.241" class="difflineminus">-            m.mAttachments = this.mAttachments.concat([]);</span>
<a href="#l11.242"></a><span id="l11.242" class="difflineminus">-        }</span>
<a href="#l11.243"></a><span id="l11.243" class="difflineplus">+        // xxx todo: the below two need proper cloning,</span>
<a href="#l11.244"></a><span id="l11.244" class="difflineplus">+        //           calIAttachment::item, calIRelation::item are wrong</span>
<a href="#l11.245"></a><span id="l11.245" class="difflineplus">+        //           bug 466439</span>
<a href="#l11.246"></a><span id="l11.246" class="difflineplus">+        m.mAttachments = this.getAttachments({});</span>
<a href="#l11.247"></a><span id="l11.247" class="difflineplus">+        m.mRelations = this.getRelations({});</span>
<a href="#l11.248"></a><span id="l11.248"> </span>
<a href="#l11.249"></a><span id="l11.249" class="difflineminus">-        if (this.mRelations) {</span>
<a href="#l11.250"></a><span id="l11.250" class="difflineminus">-            m.mRelations = this.mRelations.concat([]);</span>
<a href="#l11.251"></a><span id="l11.251" class="difflineminus">-        }</span>
<a href="#l11.252"></a><span id="l11.252" class="difflineminus">-</span>
<a href="#l11.253"></a><span id="l11.253" class="difflineminus">-        if (this.mCategories) {</span>
<a href="#l11.254"></a><span id="l11.254" class="difflineminus">-            m.mCategories = this.mCategories.concat([]);</span>
<a href="#l11.255"></a><span id="l11.255" class="difflineminus">-        }</span>
<a href="#l11.256"></a><span id="l11.256" class="difflineplus">+        m.mCategories = this.getCategories({});</span>
<a href="#l11.257"></a><span id="l11.257"> </span>
<a href="#l11.258"></a><span id="l11.258">         // Clone any alarm info that exists, set it to null if it doesn't</span>
<a href="#l11.259"></a><span id="l11.259" class="difflineminus">-        if (this.alarmOffset) {</span>
<a href="#l11.260"></a><span id="l11.260" class="difflineminus">-            m.alarmOffset = this.alarmOffset.clone();</span>
<a href="#l11.261"></a><span id="l11.261" class="difflineminus">-        } else {</span>
<a href="#l11.262"></a><span id="l11.262" class="difflineminus">-            m.alarmOffset = null;</span>
<a href="#l11.263"></a><span id="l11.263" class="difflineplus">+        let alarmOffset = this.alarmOffset;</span>
<a href="#l11.264"></a><span id="l11.264" class="difflineplus">+        if (alarmOffset) {</span>
<a href="#l11.265"></a><span id="l11.265" class="difflineplus">+            alarmOffset = alarmOffset.clone();</span>
<a href="#l11.266"></a><span id="l11.266">         }</span>
<a href="#l11.267"></a><span id="l11.267" class="difflineminus">-        if (this.alarmLastAck) {</span>
<a href="#l11.268"></a><span id="l11.268" class="difflineminus">-            m.alarmLastAck = this.alarmLastAck.clone();</span>
<a href="#l11.269"></a><span id="l11.269" class="difflineminus">-        } else {</span>
<a href="#l11.270"></a><span id="l11.270" class="difflineminus">-            m.alarmLastAck = null;</span>
<a href="#l11.271"></a><span id="l11.271" class="difflineplus">+        m.mAlarmOffset = alarmOffset;</span>
<a href="#l11.272"></a><span id="l11.272" class="difflineplus">+</span>
<a href="#l11.273"></a><span id="l11.273" class="difflineplus">+        let alarmLastAck = this.alarmLastAck;</span>
<a href="#l11.274"></a><span id="l11.274" class="difflineplus">+        if (alarmLastAck) {</span>
<a href="#l11.275"></a><span id="l11.275" class="difflineplus">+            alarmLastAck = alarmLastAck.clone();</span>
<a href="#l11.276"></a><span id="l11.276">         }</span>
<a href="#l11.277"></a><span id="l11.277" class="difflineplus">+        m.mAlarmLastAck = alarmLastAck;</span>
<a href="#l11.278"></a><span id="l11.278" class="difflineplus">+</span>
<a href="#l11.279"></a><span id="l11.279">         m.alarmRelated = this.alarmRelated;</span>
<a href="#l11.280"></a><span id="l11.280"> </span>
<a href="#l11.281"></a><span id="l11.281">         m.mDirty = this.mDirty;</span>
<a href="#l11.282"></a><span id="l11.282"> </span>
<a href="#l11.283"></a><span id="l11.283">         return m;</span>
<a href="#l11.284"></a><span id="l11.284">     },</span>
<a href="#l11.285"></a><span id="l11.285"> </span>
<a href="#l11.286"></a><span id="l11.286">     get alarmOffset() {</span>
<a href="#l11.287"></a><span id="l11.287" class="difflineat">@@ -323,17 +296,17 @@ calItemBase.prototype = {</span>
<a href="#l11.288"></a><span id="l11.288"> </span>
<a href="#l11.289"></a><span id="l11.289">     get stampTime() {</span>
<a href="#l11.290"></a><span id="l11.290">         this.ensureNotDirty();</span>
<a href="#l11.291"></a><span id="l11.291">         return this.getProperty(&quot;DTSTAMP&quot;);</span>
<a href="#l11.292"></a><span id="l11.292">     },</span>
<a href="#l11.293"></a><span id="l11.293"> </span>
<a href="#l11.294"></a><span id="l11.294">     get propertyEnumerator() {</span>
<a href="#l11.295"></a><span id="l11.295">         if (this.mIsProxy) {</span>
<a href="#l11.296"></a><span id="l11.296" class="difflineminus">-            ASSERT(this.parentItem != this);</span>
<a href="#l11.297"></a><span id="l11.297" class="difflineplus">+            cal.ASSERT(this.parentItem != this);</span>
<a href="#l11.298"></a><span id="l11.298">             return { // nsISimpleEnumerator:</span>
<a href="#l11.299"></a><span id="l11.299">                 mProxyEnum: this.mProperties.enumerator,</span>
<a href="#l11.300"></a><span id="l11.300">                 mParentEnum: this.mParentItem.propertyEnumerator,</span>
<a href="#l11.301"></a><span id="l11.301">                 mHandledProps: { },</span>
<a href="#l11.302"></a><span id="l11.302">                 mCurrentProp: null,</span>
<a href="#l11.303"></a><span id="l11.303"> </span>
<a href="#l11.304"></a><span id="l11.304">                 hasMoreElements: function cib_pe_hasMoreElements() {</span>
<a href="#l11.305"></a><span id="l11.305">                     if (this.mCurrentProp) {</span>
<a href="#l11.306"></a><span id="l11.306" class="difflineat">@@ -357,17 +330,17 @@ calItemBase.prototype = {</span>
<a href="#l11.307"></a><span id="l11.307">                             return true;</span>
<a href="#l11.308"></a><span id="l11.308">                         }</span>
<a href="#l11.309"></a><span id="l11.309">                     }</span>
<a href="#l11.310"></a><span id="l11.310">                     return false;</span>
<a href="#l11.311"></a><span id="l11.311">                 },</span>
<a href="#l11.312"></a><span id="l11.312"> </span>
<a href="#l11.313"></a><span id="l11.313">                 getNext: function cib_pe_getNext() {</span>
<a href="#l11.314"></a><span id="l11.314">                     if (!this.hasMoreElements()) { // hasMoreElements is called by intention to skip yet deleted properties</span>
<a href="#l11.315"></a><span id="l11.315" class="difflineminus">-                        ASSERT(false, Components.results.NS_ERROR_UNEXPECTED);</span>
<a href="#l11.316"></a><span id="l11.316" class="difflineplus">+                        cal.ASSERT(false, Components.results.NS_ERROR_UNEXPECTED);</span>
<a href="#l11.317"></a><span id="l11.317">                         throw Components.results.NS_ERROR_UNEXPECTED;</span>
<a href="#l11.318"></a><span id="l11.318">                     }</span>
<a href="#l11.319"></a><span id="l11.319">                     var ret = this.mCurrentProp;</span>
<a href="#l11.320"></a><span id="l11.320">                     this.mCurrentProp = null;</span>
<a href="#l11.321"></a><span id="l11.321">                     return ret;</span>
<a href="#l11.322"></a><span id="l11.322">                 }</span>
<a href="#l11.323"></a><span id="l11.323">             };</span>
<a href="#l11.324"></a><span id="l11.324">         } else {</span>
<a href="#l11.325"></a><span id="l11.325" class="difflineat">@@ -415,17 +388,17 @@ calItemBase.prototype = {</span>
<a href="#l11.326"></a><span id="l11.326">         }</span>
<a href="#l11.327"></a><span id="l11.327">     },</span>
<a href="#l11.328"></a><span id="l11.328"> </span>
<a href="#l11.329"></a><span id="l11.329">     getPropertyParameter: function getPP(aPropName, aParamName) {</span>
<a href="#l11.330"></a><span id="l11.330">         return this.mPropertyParams[aPropName][aParamName];</span>
<a href="#l11.331"></a><span id="l11.331">     },</span>
<a href="#l11.332"></a><span id="l11.332"> </span>
<a href="#l11.333"></a><span id="l11.333">     getAttendees: function (countObj) {</span>
<a href="#l11.334"></a><span id="l11.334" class="difflineminus">-        if (!this.mAttendees &amp;&amp; this.mIsProxy &amp;&amp; this.mParentItem) {</span>
<a href="#l11.335"></a><span id="l11.335" class="difflineplus">+        if (!this.mAttendees &amp;&amp; this.mIsProxy) {</span>
<a href="#l11.336"></a><span id="l11.336">             this.mAttendees = this.mParentItem.getAttendees(countObj);</span>
<a href="#l11.337"></a><span id="l11.337">         }</span>
<a href="#l11.338"></a><span id="l11.338">         if (this.mAttendees) {</span>
<a href="#l11.339"></a><span id="l11.339">             countObj.value = this.mAttendees.length;</span>
<a href="#l11.340"></a><span id="l11.340">             return this.mAttendees.concat([]); // clone</span>
<a href="#l11.341"></a><span id="l11.341">         }</span>
<a href="#l11.342"></a><span id="l11.342">         else {</span>
<a href="#l11.343"></a><span id="l11.343">             countObj.value = 0;</span>
<a href="#l11.344"></a><span id="l11.344" class="difflineat">@@ -472,17 +445,17 @@ calItemBase.prototype = {</span>
<a href="#l11.345"></a><span id="l11.345">     addAttendee: function (attendee) {</span>
<a href="#l11.346"></a><span id="l11.346">         this.modify();</span>
<a href="#l11.347"></a><span id="l11.347">         this.mAttendees = this.getAttendees({});</span>
<a href="#l11.348"></a><span id="l11.348">         this.mAttendees.push(attendee);</span>
<a href="#l11.349"></a><span id="l11.349">         // XXX ensure that the attendee isn't already there?</span>
<a href="#l11.350"></a><span id="l11.350">     },</span>
<a href="#l11.351"></a><span id="l11.351"> </span>
<a href="#l11.352"></a><span id="l11.352">     getAttachments: function cIB_getAttachments(aCount) {</span>
<a href="#l11.353"></a><span id="l11.353" class="difflineminus">-        if (!this.mAttachments &amp;&amp; this.mIsProxy &amp;&amp; this.mParentItem) {</span>
<a href="#l11.354"></a><span id="l11.354" class="difflineplus">+        if (!this.mAttachments &amp;&amp; this.mIsProxy) {</span>
<a href="#l11.355"></a><span id="l11.355">             this.mAttachments = this.mParentItem.getAttachments(aCount);</span>
<a href="#l11.356"></a><span id="l11.356">         }</span>
<a href="#l11.357"></a><span id="l11.357">         if (this.mAttachments) {</span>
<a href="#l11.358"></a><span id="l11.358">             aCount.value = this.mAttachments.length;</span>
<a href="#l11.359"></a><span id="l11.359">             return this.mAttachments.concat([]); // clone</span>
<a href="#l11.360"></a><span id="l11.360">         } else {</span>
<a href="#l11.361"></a><span id="l11.361">             aCount.value = 0;</span>
<a href="#l11.362"></a><span id="l11.362">             return [];</span>
<a href="#l11.363"></a><span id="l11.363" class="difflineat">@@ -508,16 +481,19 @@ calItemBase.prototype = {</span>
<a href="#l11.364"></a><span id="l11.364">     },</span>
<a href="#l11.365"></a><span id="l11.365"> </span>
<a href="#l11.366"></a><span id="l11.366">     removeAllAttachments: function () {</span>
<a href="#l11.367"></a><span id="l11.367">         this.modify();</span>
<a href="#l11.368"></a><span id="l11.368">         this.mAttachments = [];</span>
<a href="#l11.369"></a><span id="l11.369">     },</span>
<a href="#l11.370"></a><span id="l11.370"> </span>
<a href="#l11.371"></a><span id="l11.371">     getRelations: function cIB_getRelations(aCount) {</span>
<a href="#l11.372"></a><span id="l11.372" class="difflineplus">+        if (!this.mRelations &amp;&amp; this.mIsProxy) {</span>
<a href="#l11.373"></a><span id="l11.373" class="difflineplus">+            this.mRelations = this.mParentItem.getRelations(aCount);</span>
<a href="#l11.374"></a><span id="l11.374" class="difflineplus">+        }</span>
<a href="#l11.375"></a><span id="l11.375">         if (this.mRelations) {</span>
<a href="#l11.376"></a><span id="l11.376">             aCount.value = this.mRelations.length;</span>
<a href="#l11.377"></a><span id="l11.377">             return this.mRelations.concat([]);</span>
<a href="#l11.378"></a><span id="l11.378">         } else {</span>
<a href="#l11.379"></a><span id="l11.379">             aCount.value = 0;</span>
<a href="#l11.380"></a><span id="l11.380">             return [];</span>
<a href="#l11.381"></a><span id="l11.381">         }</span>
<a href="#l11.382"></a><span id="l11.382">     },</span>
<a href="#l11.383"></a><span id="l11.383" class="difflineat">@@ -558,32 +534,31 @@ calItemBase.prototype = {</span>
<a href="#l11.384"></a><span id="l11.384"> </span>
<a href="#l11.385"></a><span id="l11.385">     set calendar (v) {</span>
<a href="#l11.386"></a><span id="l11.386">         if (this.mImmutable)</span>
<a href="#l11.387"></a><span id="l11.387">             throw Components.results.NS_ERROR_OBJECT_IS_IMMUTABLE;</span>
<a href="#l11.388"></a><span id="l11.388">         this.mHashId = null; // recompute hashId</span>
<a href="#l11.389"></a><span id="l11.389">         this.mCalendar = v;</span>
<a href="#l11.390"></a><span id="l11.390">     },</span>
<a href="#l11.391"></a><span id="l11.391"> </span>
<a href="#l11.392"></a><span id="l11.392" class="difflineminus">-    mOrganizer: null,</span>
<a href="#l11.393"></a><span id="l11.393">     get organizer() {</span>
<a href="#l11.394"></a><span id="l11.394" class="difflineminus">-        if (!this.mOrganizer &amp;&amp; this.mIsProxy &amp;&amp; this.mParentItem) {</span>
<a href="#l11.395"></a><span id="l11.395" class="difflineplus">+        if (this.mIsProxy &amp;&amp; (this.mOrganizer === undefined)) {</span>
<a href="#l11.396"></a><span id="l11.396">             return this.mParentItem.organizer;</span>
<a href="#l11.397"></a><span id="l11.397" class="difflineplus">+        } else {</span>
<a href="#l11.398"></a><span id="l11.398" class="difflineplus">+            return this.mOrganizer;</span>
<a href="#l11.399"></a><span id="l11.399">         }</span>
<a href="#l11.400"></a><span id="l11.400" class="difflineminus">-        else</span>
<a href="#l11.401"></a><span id="l11.401" class="difflineminus">-            return this.mOrganizer;</span>
<a href="#l11.402"></a><span id="l11.402">     },</span>
<a href="#l11.403"></a><span id="l11.403"> </span>
<a href="#l11.404"></a><span id="l11.404">     set organizer(v) {</span>
<a href="#l11.405"></a><span id="l11.405">         this.modify();</span>
<a href="#l11.406"></a><span id="l11.406">         this.mOrganizer = v;</span>
<a href="#l11.407"></a><span id="l11.407">     },</span>
<a href="#l11.408"></a><span id="l11.408"> </span>
<a href="#l11.409"></a><span id="l11.409">     getCategories: function cib_getCategories(aCount) {</span>
<a href="#l11.410"></a><span id="l11.410" class="difflineminus">-        if (!this.mCategories &amp;&amp; this.mIsProxy &amp;&amp; this.mParentItem) {</span>
<a href="#l11.411"></a><span id="l11.411" class="difflineplus">+        if (!this.mCategories &amp;&amp; this.mIsProxy) {</span>
<a href="#l11.412"></a><span id="l11.412">             this.mCategories = this.mParentItem.getCategories(aCount);</span>
<a href="#l11.413"></a><span id="l11.413">         }</span>
<a href="#l11.414"></a><span id="l11.414">         if (this.mCategories) {</span>
<a href="#l11.415"></a><span id="l11.415">             aCount.value = this.mCategories.length;</span>
<a href="#l11.416"></a><span id="l11.416">             return this.mCategories.concat([]); // clone</span>
<a href="#l11.417"></a><span id="l11.417">         } else {</span>
<a href="#l11.418"></a><span id="l11.418">             aCount.value = 0;</span>
<a href="#l11.419"></a><span id="l11.419">             return [];</span>
<a href="#l11.420"></a><span id="l11.420" class="difflineat">@@ -651,103 +626,115 @@ calItemBase.prototype = {</span>
<a href="#l11.421"></a><span id="l11.421">             if (val != null &amp;&amp; val != Components.interfaces.calIIcalComponent.INVALID_VALUE)</span>
<a href="#l11.422"></a><span id="l11.422">                 icalcomp[prop.ics] = val;</span>
<a href="#l11.423"></a><span id="l11.423">         }</span>
<a href="#l11.424"></a><span id="l11.424">     },</span>
<a href="#l11.425"></a><span id="l11.425"> </span>
<a href="#l11.426"></a><span id="l11.426">     setItemBaseFromICS: function (icalcomp) {</span>
<a href="#l11.427"></a><span id="l11.427">         this.modify();</span>
<a href="#l11.428"></a><span id="l11.428"> </span>
<a href="#l11.429"></a><span id="l11.429" class="difflineplus">+        // re-initializing from scratch -- no light proxy anymore:</span>
<a href="#l11.430"></a><span id="l11.430" class="difflineplus">+        this.mIsProxy = false;</span>
<a href="#l11.431"></a><span id="l11.431" class="difflineplus">+        this.mProperties = new calPropertyBag();</span>
<a href="#l11.432"></a><span id="l11.432" class="difflineplus">+        this.mPropertyParams = {};</span>
<a href="#l11.433"></a><span id="l11.433" class="difflineplus">+</span>
<a href="#l11.434"></a><span id="l11.434">         this.mapPropsFromICS(icalcomp, this.icsBasePropMap);</span>
<a href="#l11.435"></a><span id="l11.435"> </span>
<a href="#l11.436"></a><span id="l11.436" class="difflineplus">+        this.mAttendees = []; // don't inherit anything from parent</span>
<a href="#l11.437"></a><span id="l11.437">         for (let attprop in cal.ical.propertyIterator(icalcomp, &quot;ATTENDEE&quot;)) {</span>
<a href="#l11.438"></a><span id="l11.438">             let att = new calAttendee();</span>
<a href="#l11.439"></a><span id="l11.439">             att.icalProperty = attprop;</span>
<a href="#l11.440"></a><span id="l11.440">             this.addAttendee(att);</span>
<a href="#l11.441"></a><span id="l11.441">         }</span>
<a href="#l11.442"></a><span id="l11.442"> </span>
<a href="#l11.443"></a><span id="l11.443" class="difflineplus">+        this.mAttachments = []; // don't inherit anything from parent</span>
<a href="#l11.444"></a><span id="l11.444">         for (let attprop in cal.ical.propertyIterator(icalcomp, &quot;ATTACH&quot;)) {</span>
<a href="#l11.445"></a><span id="l11.445">             let att = new calAttachment();</span>
<a href="#l11.446"></a><span id="l11.446">             att.icalProperty = attprop;</span>
<a href="#l11.447"></a><span id="l11.447">             this.addAttachment(att);</span>
<a href="#l11.448"></a><span id="l11.448">         }</span>
<a href="#l11.449"></a><span id="l11.449"> </span>
<a href="#l11.450"></a><span id="l11.450" class="difflineminus">-</span>
<a href="#l11.451"></a><span id="l11.451" class="difflineplus">+        this.mRelations = []; // don't inherit anything from parent</span>
<a href="#l11.452"></a><span id="l11.452">         for (let relprop in cal.ical.propertyIterator(icalcomp, &quot;RELATED-TO&quot;)) {</span>
<a href="#l11.453"></a><span id="l11.453">             let rel = new calRelation();</span>
<a href="#l11.454"></a><span id="l11.454">             rel.icalProperty = relprop;</span>
<a href="#l11.455"></a><span id="l11.455">             this.addRelation(rel);</span>
<a href="#l11.456"></a><span id="l11.456">         }</span>
<a href="#l11.457"></a><span id="l11.457"> </span>
<a href="#l11.458"></a><span id="l11.458" class="difflineplus">+        let org = null;</span>
<a href="#l11.459"></a><span id="l11.459">         let orgprop = icalcomp.getFirstProperty(&quot;ORGANIZER&quot;);</span>
<a href="#l11.460"></a><span id="l11.460">         if (orgprop) {</span>
<a href="#l11.461"></a><span id="l11.461" class="difflineminus">-            let org = new calAttendee();</span>
<a href="#l11.462"></a><span id="l11.462" class="difflineplus">+            org = new calAttendee();</span>
<a href="#l11.463"></a><span id="l11.463">             org.icalProperty = orgprop;</span>
<a href="#l11.464"></a><span id="l11.464">             org.isOrganizer = true;</span>
<a href="#l11.465"></a><span id="l11.465" class="difflineminus">-            this.mOrganizer = org;</span>
<a href="#l11.466"></a><span id="l11.466">         }</span>
<a href="#l11.467"></a><span id="l11.467" class="difflineplus">+        this.mOrganizer = org;</span>
<a href="#l11.468"></a><span id="l11.468"> </span>
<a href="#l11.469"></a><span id="l11.469">         this.mCategories = [ catprop.value for (catprop in cal.ical.propertyIterator(icalcomp, &quot;CATEGORIES&quot;)) ];</span>
<a href="#l11.470"></a><span id="l11.470"> </span>
<a href="#l11.471"></a><span id="l11.471">         // find recurrence properties</span>
<a href="#l11.472"></a><span id="l11.472">         let rec = null;</span>
<a href="#l11.473"></a><span id="l11.473" class="difflineminus">-        for (let recprop in cal.ical.propertyIterator(icalcomp)) {</span>
<a href="#l11.474"></a><span id="l11.474" class="difflineminus">-            let ritem = null;</span>
<a href="#l11.475"></a><span id="l11.475" class="difflineminus">-            switch (recprop.propertyName) {</span>
<a href="#l11.476"></a><span id="l11.476" class="difflineminus">-                case &quot;RRULE&quot;:</span>
<a href="#l11.477"></a><span id="l11.477" class="difflineminus">-                case &quot;EXRULE&quot;:</span>
<a href="#l11.478"></a><span id="l11.478" class="difflineminus">-                    ritem = new CalRecurrenceRule();</span>
<a href="#l11.479"></a><span id="l11.479" class="difflineminus">-                    break;</span>
<a href="#l11.480"></a><span id="l11.480" class="difflineminus">-                case &quot;RDATE&quot;:</span>
<a href="#l11.481"></a><span id="l11.481" class="difflineminus">-                case &quot;EXDATE&quot;:</span>
<a href="#l11.482"></a><span id="l11.482" class="difflineminus">-                    ritem = new CalRecurrenceDate();</span>
<a href="#l11.483"></a><span id="l11.483" class="difflineminus">-                    break;</span>
<a href="#l11.484"></a><span id="l11.484" class="difflineminus">-                default:</span>
<a href="#l11.485"></a><span id="l11.485" class="difflineminus">-                    continue;</span>
<a href="#l11.486"></a><span id="l11.486" class="difflineplus">+        if (!this.recurrenceId) {</span>
<a href="#l11.487"></a><span id="l11.487" class="difflineplus">+            for (let recprop in cal.ical.propertyIterator(icalcomp)) {</span>
<a href="#l11.488"></a><span id="l11.488" class="difflineplus">+                let ritem = null;</span>
<a href="#l11.489"></a><span id="l11.489" class="difflineplus">+                switch (recprop.propertyName) {</span>
<a href="#l11.490"></a><span id="l11.490" class="difflineplus">+                    case &quot;RRULE&quot;:</span>
<a href="#l11.491"></a><span id="l11.491" class="difflineplus">+                    case &quot;EXRULE&quot;:</span>
<a href="#l11.492"></a><span id="l11.492" class="difflineplus">+                        ritem = new CalRecurrenceRule();</span>
<a href="#l11.493"></a><span id="l11.493" class="difflineplus">+                        break;</span>
<a href="#l11.494"></a><span id="l11.494" class="difflineplus">+                    case &quot;RDATE&quot;:</span>
<a href="#l11.495"></a><span id="l11.495" class="difflineplus">+                    case &quot;EXDATE&quot;:</span>
<a href="#l11.496"></a><span id="l11.496" class="difflineplus">+                        ritem = new CalRecurrenceDate();</span>
<a href="#l11.497"></a><span id="l11.497" class="difflineplus">+                        break;</span>
<a href="#l11.498"></a><span id="l11.498" class="difflineplus">+                    default:</span>
<a href="#l11.499"></a><span id="l11.499" class="difflineplus">+                        continue;</span>
<a href="#l11.500"></a><span id="l11.500" class="difflineplus">+                }</span>
<a href="#l11.501"></a><span id="l11.501" class="difflineplus">+                ritem.icalProperty = recprop;</span>
<a href="#l11.502"></a><span id="l11.502" class="difflineplus">+</span>
<a href="#l11.503"></a><span id="l11.503" class="difflineplus">+                if (!rec) {</span>
<a href="#l11.504"></a><span id="l11.504" class="difflineplus">+                    rec = new calRecurrenceInfo();</span>
<a href="#l11.505"></a><span id="l11.505" class="difflineplus">+                    rec.item = this;</span>
<a href="#l11.506"></a><span id="l11.506" class="difflineplus">+                }</span>
<a href="#l11.507"></a><span id="l11.507" class="difflineplus">+                rec.appendRecurrenceItem(ritem);</span>
<a href="#l11.508"></a><span id="l11.508">             }</span>
<a href="#l11.509"></a><span id="l11.509" class="difflineminus">-</span>
<a href="#l11.510"></a><span id="l11.510" class="difflineminus">-            ritem.icalProperty = recprop;</span>
<a href="#l11.511"></a><span id="l11.511" class="difflineminus">-</span>
<a href="#l11.512"></a><span id="l11.512" class="difflineminus">-            if (!rec) {</span>
<a href="#l11.513"></a><span id="l11.513" class="difflineminus">-                rec = new calRecurrenceInfo();</span>
<a href="#l11.514"></a><span id="l11.514" class="difflineminus">-                rec.item = this;</span>
<a href="#l11.515"></a><span id="l11.515" class="difflineminus">-            }</span>
<a href="#l11.516"></a><span id="l11.516" class="difflineminus">-</span>
<a href="#l11.517"></a><span id="l11.517" class="difflineminus">-            rec.appendRecurrenceItem(ritem);</span>
<a href="#l11.518"></a><span id="l11.518">         }</span>
<a href="#l11.519"></a><span id="l11.519">         this.mRecurrenceInfo = rec;</span>
<a href="#l11.520"></a><span id="l11.520"> </span>
<a href="#l11.521"></a><span id="l11.521" class="difflineplus">+        this.mAlarmOffset = null;</span>
<a href="#l11.522"></a><span id="l11.522" class="difflineplus">+        this.alarmRelated = Components.interfaces.calIItemBase.ALARM_RELATED_START;</span>
<a href="#l11.523"></a><span id="l11.523" class="difflineplus">+        this.mAlarmLastAck = null;</span>
<a href="#l11.524"></a><span id="l11.524" class="difflineplus">+</span>
<a href="#l11.525"></a><span id="l11.525">         let alarmComp = icalcomp.getFirstSubcomponent(&quot;VALARM&quot;);</span>
<a href="#l11.526"></a><span id="l11.526">         if (alarmComp) {</span>
<a href="#l11.527"></a><span id="l11.527">             let triggerProp = alarmComp.getFirstProperty(&quot;TRIGGER&quot;);</span>
<a href="#l11.528"></a><span id="l11.528">             if (triggerProp) {</span>
<a href="#l11.529"></a><span id="l11.529" class="difflineminus">-                this.alarmOffset = cal.createDuration(triggerProp.valueAsIcalString);</span>
<a href="#l11.530"></a><span id="l11.530" class="difflineplus">+                this.mAlarmOffset = cal.createDuration(triggerProp.valueAsIcalString);</span>
<a href="#l11.531"></a><span id="l11.531"> </span>
<a href="#l11.532"></a><span id="l11.532">                 let related = triggerProp.getParameter(&quot;RELATED&quot;);</span>
<a href="#l11.533"></a><span id="l11.533">                 if (related &amp;&amp; related == &quot;END&quot;) {</span>
<a href="#l11.534"></a><span id="l11.534">                     this.alarmRelated = Components.interfaces.calIItemBase.ALARM_RELATED_END;</span>
<a href="#l11.535"></a><span id="l11.535" class="difflineminus">-                } else {</span>
<a href="#l11.536"></a><span id="l11.536" class="difflineminus">-                    this.alarmRelated = Components.interfaces.calIItemBase.ALARM_RELATED_START;</span>
<a href="#l11.537"></a><span id="l11.537">                 }</span>
<a href="#l11.538"></a><span id="l11.538"> </span>
<a href="#l11.539"></a><span id="l11.539">                 let email = alarmComp.getFirstProperty(&quot;X-EMAILADDRESS&quot;);</span>
<a href="#l11.540"></a><span id="l11.540">                 if (email) {</span>
<a href="#l11.541"></a><span id="l11.541">                     this.setProperty(&quot;alarmEmailAddress&quot;, email.value);</span>
<a href="#l11.542"></a><span id="l11.542">                 }</span>
<a href="#l11.543"></a><span id="l11.543">             } else {</span>
<a href="#l11.544"></a><span id="l11.544">                 // Really, really old Sunbird/Calendar versions didn't give us a</span>
<a href="#l11.545"></a><span id="l11.545">                 // trigger.</span>
<a href="#l11.546"></a><span id="l11.546">                 cal.ERROR(&quot;No trigger property for alarm on item: &quot; + this.id);</span>
<a href="#l11.547"></a><span id="l11.547">             }</span>
<a href="#l11.548"></a><span id="l11.548" class="difflineplus">+</span>
<a href="#l11.549"></a><span id="l11.549" class="difflineplus">+            let lastAck = icalcomp.getFirstProperty(&quot;X-MOZ-LASTACK&quot;);</span>
<a href="#l11.550"></a><span id="l11.550" class="difflineplus">+            if (lastAck) {</span>
<a href="#l11.551"></a><span id="l11.551" class="difflineplus">+                this.mAlarmLastAck = cal.createDateTime(lastAck.value);</span>
<a href="#l11.552"></a><span id="l11.552" class="difflineplus">+            }</span>
<a href="#l11.553"></a><span id="l11.553">         }</span>
<a href="#l11.554"></a><span id="l11.554"> </span>
<a href="#l11.555"></a><span id="l11.555" class="difflineminus">-        let lastAck = icalcomp.getFirstProperty(&quot;X-MOZ-LASTACK&quot;);</span>
<a href="#l11.556"></a><span id="l11.556" class="difflineminus">-        if (lastAck) {</span>
<a href="#l11.557"></a><span id="l11.557" class="difflineminus">-            this.alarmLastAck = cal.createDateTime(lastAck.value);</span>
<a href="#l11.558"></a><span id="l11.558" class="difflineminus">-        }</span>
<a href="#l11.559"></a><span id="l11.559" class="difflineplus">+        this.mDirty = false;</span>
<a href="#l11.560"></a><span id="l11.560">     },</span>
<a href="#l11.561"></a><span id="l11.561"> </span>
<a href="#l11.562"></a><span id="l11.562">     importUnpromotedProperties: function (icalcomp, promoted) {</span>
<a href="#l11.563"></a><span id="l11.563">         for (let prop in cal.ical.propertyIterator(icalcomp)) {</span>
<a href="#l11.564"></a><span id="l11.564">             let propName = prop.propertyName;</span>
<a href="#l11.565"></a><span id="l11.565">             if (!promoted[propName]) {</span>
<a href="#l11.566"></a><span id="l11.566">                 this.setProperty(propName, prop.value);</span>
<a href="#l11.567"></a><span id="l11.567">                 for each (let [paramName, paramValue] in cal.ical.paramIterator(prop)) {</span>
<a href="#l11.568"></a><span id="l11.568" class="difflineat">@@ -765,100 +752,97 @@ calItemBase.prototype = {</span>
<a href="#l11.569"></a><span id="l11.569">         return (this.itemBasePromotedProps[name.toUpperCase()]);</span>
<a href="#l11.570"></a><span id="l11.570">     },</span>
<a href="#l11.571"></a><span id="l11.571"> </span>
<a href="#l11.572"></a><span id="l11.572">     get icalComponent() {</span>
<a href="#l11.573"></a><span id="l11.573">         throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l11.574"></a><span id="l11.574">     },</span>
<a href="#l11.575"></a><span id="l11.575"> </span>
<a href="#l11.576"></a><span id="l11.576">     get generation() {</span>
<a href="#l11.577"></a><span id="l11.577" class="difflineminus">-        if (this.mGeneration === undefined) {</span>
<a href="#l11.578"></a><span id="l11.578" class="difflineminus">-            var gen = this.getProperty(&quot;X-MOZ-GENERATION&quot;);</span>
<a href="#l11.579"></a><span id="l11.579" class="difflineminus">-            this.mGeneration = (gen ? parseInt(gen) : 0);</span>
<a href="#l11.580"></a><span id="l11.580" class="difflineminus">-        }</span>
<a href="#l11.581"></a><span id="l11.581" class="difflineminus">-        return this.mGeneration;</span>
<a href="#l11.582"></a><span id="l11.582" class="difflineplus">+        let gen = this.getProperty(&quot;X-MOZ-GENERATION&quot;);</span>
<a href="#l11.583"></a><span id="l11.583" class="difflineplus">+        return (gen ? parseInt(gen, 10) : 0);</span>
<a href="#l11.584"></a><span id="l11.584">     },</span>
<a href="#l11.585"></a><span id="l11.585">     set generation(aValue) {</span>
<a href="#l11.586"></a><span id="l11.586" class="difflineminus">-        this.modify();</span>
<a href="#l11.587"></a><span id="l11.587" class="difflineminus">-        this.mGeneration = aValue;</span>
<a href="#l11.588"></a><span id="l11.588" class="difflineminus">-        this.setProperty(&quot;X-MOZ-GENERATION&quot;, String(aValue));</span>
<a href="#l11.589"></a><span id="l11.589" class="difflineminus">-        return aValue;</span>
<a href="#l11.590"></a><span id="l11.590" class="difflineplus">+        return this.setProperty(&quot;X-MOZ-GENERATION&quot;, String(aValue));</span>
<a href="#l11.591"></a><span id="l11.591">     },</span>
<a href="#l11.592"></a><span id="l11.592"> </span>
<a href="#l11.593"></a><span id="l11.593">     fillIcalComponentFromBase: function (icalcomp) {</span>
<a href="#l11.594"></a><span id="l11.594">         this.ensureNotDirty();</span>
<a href="#l11.595"></a><span id="l11.595"> </span>
<a href="#l11.596"></a><span id="l11.596">         this.mapPropsToICS(icalcomp, this.icsBasePropMap);</span>
<a href="#l11.597"></a><span id="l11.597"> </span>
<a href="#l11.598"></a><span id="l11.598" class="difflineminus">-        if (this.mOrganizer)</span>
<a href="#l11.599"></a><span id="l11.599" class="difflineminus">-            icalcomp.addProperty(this.mOrganizer.icalProperty);</span>
<a href="#l11.600"></a><span id="l11.600" class="difflineminus">-        var attendees = this.getAttendees({});</span>
<a href="#l11.601"></a><span id="l11.601" class="difflineminus">-        if (attendees.length &gt; 0) {</span>
<a href="#l11.602"></a><span id="l11.602" class="difflineminus">-          for (var i = 0; i &lt; attendees.length; i++) {</span>
<a href="#l11.603"></a><span id="l11.603" class="difflineminus">-            icalcomp.addProperty(attendees[i].icalProperty);</span>
<a href="#l11.604"></a><span id="l11.604" class="difflineminus">-          }</span>
<a href="#l11.605"></a><span id="l11.605" class="difflineplus">+        let org = this.organizer;</span>
<a href="#l11.606"></a><span id="l11.606" class="difflineplus">+        if (org) {</span>
<a href="#l11.607"></a><span id="l11.607" class="difflineplus">+            icalcomp.addProperty(org.icalProperty);</span>
<a href="#l11.608"></a><span id="l11.608">         }</span>
<a href="#l11.609"></a><span id="l11.609"> </span>
<a href="#l11.610"></a><span id="l11.610" class="difflineminus">-        for each (var att in this.mAttachments) {</span>
<a href="#l11.611"></a><span id="l11.611" class="difflineminus">-            icalcomp.addProperty(att.icalProperty);</span>
<a href="#l11.612"></a><span id="l11.612" class="difflineplus">+        for each (let attendee in this.getAttendees({})) {</span>
<a href="#l11.613"></a><span id="l11.613" class="difflineplus">+            icalcomp.addProperty(attendee.icalProperty);</span>
<a href="#l11.614"></a><span id="l11.614">         }</span>
<a href="#l11.615"></a><span id="l11.615"> </span>
<a href="#l11.616"></a><span id="l11.616" class="difflineminus">-        for (var relIndex in this.mRelations) {</span>
<a href="#l11.617"></a><span id="l11.617" class="difflineminus">-            icalcomp.addProperty(this.mRelations[relIndex].icalProperty);</span>
<a href="#l11.618"></a><span id="l11.618" class="difflineplus">+        for each (let attachment in this.getAttachments({})) {</span>
<a href="#l11.619"></a><span id="l11.619" class="difflineplus">+            icalcomp.addProperty(attachment.icalProperty);</span>
<a href="#l11.620"></a><span id="l11.620" class="difflineplus">+        }</span>
<a href="#l11.621"></a><span id="l11.621" class="difflineplus">+</span>
<a href="#l11.622"></a><span id="l11.622" class="difflineplus">+        for each (let relation in this.getRelations({})) {</span>
<a href="#l11.623"></a><span id="l11.623" class="difflineplus">+            icalcomp.addProperty(relation.icalProperty);</span>
<a href="#l11.624"></a><span id="l11.624">         }</span>
<a href="#l11.625"></a><span id="l11.625"> </span>
<a href="#l11.626"></a><span id="l11.626">         if (this.mRecurrenceInfo) {</span>
<a href="#l11.627"></a><span id="l11.627" class="difflineminus">-            var ritems = this.mRecurrenceInfo.getRecurrenceItems({});</span>
<a href="#l11.628"></a><span id="l11.628" class="difflineminus">-            for (i in ritems) {</span>
<a href="#l11.629"></a><span id="l11.629" class="difflineminus">-                icalcomp.addProperty(ritems[i].icalProperty);</span>
<a href="#l11.630"></a><span id="l11.630" class="difflineplus">+            for each (let ritem in this.mRecurrenceInfo.getRecurrenceItems({})) {</span>
<a href="#l11.631"></a><span id="l11.631" class="difflineplus">+                icalcomp.addProperty(ritem.icalProperty);</span>
<a href="#l11.632"></a><span id="l11.632">             }</span>
<a href="#l11.633"></a><span id="l11.633">         }</span>
<a href="#l11.634"></a><span id="l11.634"> </span>
<a href="#l11.635"></a><span id="l11.635" class="difflineminus">-        for each (var cat in this.getCategories({})) {</span>
<a href="#l11.636"></a><span id="l11.636" class="difflineminus">-            var catprop = getIcsService().createIcalProperty(&quot;CATEGORIES&quot;);</span>
<a href="#l11.637"></a><span id="l11.637" class="difflineplus">+        for each (let cat in this.getCategories({})) {</span>
<a href="#l11.638"></a><span id="l11.638" class="difflineplus">+            let catprop = getIcsService().createIcalProperty(&quot;CATEGORIES&quot;);</span>
<a href="#l11.639"></a><span id="l11.639">             catprop.value = cat;</span>
<a href="#l11.640"></a><span id="l11.640">             icalcomp.addProperty(catprop);</span>
<a href="#l11.641"></a><span id="l11.641">         }</span>
<a href="#l11.642"></a><span id="l11.642"> </span>
<a href="#l11.643"></a><span id="l11.643" class="difflineminus">-        if (this.alarmOffset) {</span>
<a href="#l11.644"></a><span id="l11.644" class="difflineminus">-            var icssvc = getIcsService();</span>
<a href="#l11.645"></a><span id="l11.645" class="difflineminus">-            var alarmComp = icssvc.createIcalComponent(&quot;VALARM&quot;);</span>
<a href="#l11.646"></a><span id="l11.646" class="difflineplus">+        let alarmOffset = this.alarmOffset;</span>
<a href="#l11.647"></a><span id="l11.647" class="difflineplus">+        if (alarmOffset) {</span>
<a href="#l11.648"></a><span id="l11.648" class="difflineplus">+            let icssvc = cal.getIcsService();</span>
<a href="#l11.649"></a><span id="l11.649" class="difflineplus">+            let alarmComp = icssvc.createIcalComponent(&quot;VALARM&quot;);</span>
<a href="#l11.650"></a><span id="l11.650"> </span>
<a href="#l11.651"></a><span id="l11.651" class="difflineminus">-            var triggerProp = icssvc.createIcalProperty(&quot;TRIGGER&quot;);</span>
<a href="#l11.652"></a><span id="l11.652" class="difflineminus">-            triggerProp.valueAsIcalString = this.alarmOffset.icalString;</span>
<a href="#l11.653"></a><span id="l11.653" class="difflineplus">+            let triggerProp = icssvc.createIcalProperty(&quot;TRIGGER&quot;);</span>
<a href="#l11.654"></a><span id="l11.654" class="difflineplus">+            triggerProp.valueAsIcalString = alarmOffset.icalString;</span>
<a href="#l11.655"></a><span id="l11.655"> </span>
<a href="#l11.656"></a><span id="l11.656" class="difflineminus">-            if (this.alarmRelated == Components.interfaces.calIItemBase.ALARM_RELATED_END)</span>
<a href="#l11.657"></a><span id="l11.657" class="difflineplus">+            if (this.alarmRelated == Components.interfaces.calIItemBase.ALARM_RELATED_END) {</span>
<a href="#l11.658"></a><span id="l11.658">                 triggerProp.setParameter(&quot;RELATED&quot;, &quot;END&quot;);</span>
<a href="#l11.659"></a><span id="l11.659" class="difflineplus">+            }</span>
<a href="#l11.660"></a><span id="l11.660"> </span>
<a href="#l11.661"></a><span id="l11.661">             alarmComp.addProperty(triggerProp);</span>
<a href="#l11.662"></a><span id="l11.662"> </span>
<a href="#l11.663"></a><span id="l11.663">             // We don't use this, but the ics-spec requires it</span>
<a href="#l11.664"></a><span id="l11.664" class="difflineminus">-            var descProp = icssvc.createIcalProperty(&quot;DESCRIPTION&quot;);</span>
<a href="#l11.665"></a><span id="l11.665" class="difflineplus">+            let descProp = icssvc.createIcalProperty(&quot;DESCRIPTION&quot;);</span>
<a href="#l11.666"></a><span id="l11.666">             descProp.value = &quot;Mozilla Alarm: &quot;+ this.title;</span>
<a href="#l11.667"></a><span id="l11.667">             alarmComp.addProperty(descProp);</span>
<a href="#l11.668"></a><span id="l11.668"> </span>
<a href="#l11.669"></a><span id="l11.669" class="difflineminus">-            var actionProp = icssvc.createIcalProperty(&quot;ACTION&quot;);</span>
<a href="#l11.670"></a><span id="l11.670" class="difflineplus">+            let actionProp = icssvc.createIcalProperty(&quot;ACTION&quot;);</span>
<a href="#l11.671"></a><span id="l11.671">             actionProp.value = &quot;DISPLAY&quot;;</span>
<a href="#l11.672"></a><span id="l11.672"> </span>
<a href="#l11.673"></a><span id="l11.673" class="difflineminus">-            if (this.getProperty(&quot;alarmEmailAddress&quot;)) {</span>
<a href="#l11.674"></a><span id="l11.674" class="difflineminus">-                var emailProp = icssvc.createIcalProperty(&quot;X-EMAILADDRESS&quot;);</span>
<a href="#l11.675"></a><span id="l11.675" class="difflineminus">-                emailProp.value = this.getProperty(&quot;alarmEmailAddress&quot;);</span>
<a href="#l11.676"></a><span id="l11.676" class="difflineplus">+            let alarmEmailAddress = this.getProperty(&quot;alarmEmailAddress&quot;);</span>
<a href="#l11.677"></a><span id="l11.677" class="difflineplus">+            if (alarmEmailAddress) {</span>
<a href="#l11.678"></a><span id="l11.678" class="difflineplus">+                let emailProp = icssvc.createIcalProperty(&quot;X-EMAILADDRESS&quot;);</span>
<a href="#l11.679"></a><span id="l11.679" class="difflineplus">+                emailProp.value = alarmEmailAddress;</span>
<a href="#l11.680"></a><span id="l11.680">                 actionProp.value = &quot;EMAIL&quot;;</span>
<a href="#l11.681"></a><span id="l11.681">                 alarmComp.addProperty(emailProp);</span>
<a href="#l11.682"></a><span id="l11.682">             }</span>
<a href="#l11.683"></a><span id="l11.683"> </span>
<a href="#l11.684"></a><span id="l11.684">             alarmComp.addProperty(actionProp);</span>
<a href="#l11.685"></a><span id="l11.685"> </span>
<a href="#l11.686"></a><span id="l11.686">             icalcomp.addSubcomponent(alarmComp);</span>
<a href="#l11.687"></a><span id="l11.687">         }</span>
<a href="#l11.688"></a><span id="l11.688"> </span>
<a href="#l11.689"></a><span id="l11.689" class="difflineminus">-        if (this.alarmLastAck) {</span>
<a href="#l11.690"></a><span id="l11.690" class="difflineminus">-            var lastAck = getIcsService().createIcalProperty(&quot;X-MOZ-LASTACK&quot;);</span>
<a href="#l11.691"></a><span id="l11.691" class="difflineplus">+        let alarmLastAck = this.alarmLastAck;</span>
<a href="#l11.692"></a><span id="l11.692" class="difflineplus">+        if (alarmLastAck) {</span>
<a href="#l11.693"></a><span id="l11.693" class="difflineplus">+            let lastAck = cal.getIcsService().createIcalProperty(&quot;X-MOZ-LASTACK&quot;);</span>
<a href="#l11.694"></a><span id="l11.694">             // - should we further ensure that those are UTC or rely on calAlarmService doing so?</span>
<a href="#l11.695"></a><span id="l11.695" class="difflineminus">-            lastAck.value = this.alarmLastAck.icalString;</span>
<a href="#l11.696"></a><span id="l11.696" class="difflineplus">+            lastAck.value = alarmLastAck.icalString;</span>
<a href="#l11.697"></a><span id="l11.697">             icalcomp.addProperty(lastAck);</span>
<a href="#l11.698"></a><span id="l11.698">         }</span>
<a href="#l11.699"></a><span id="l11.699">     },</span>
<a href="#l11.700"></a><span id="l11.700"> </span>
<a href="#l11.701"></a><span id="l11.701">     getOccurrencesBetween: function cIB_getOccurrencesBetween(aStartDate, aEndDate, aCount) {</span>
<a href="#l11.702"></a><span id="l11.702">         if (this.recurrenceInfo) {</span>
<a href="#l11.703"></a><span id="l11.703">             return this.recurrenceInfo.getOccurrences(aStartDate, aEndDate, 0, aCount);</span>
<a href="#l11.704"></a><span id="l11.704">         }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/calendar/base/src/calRecurrenceInfo.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/calendar/base/src/calRecurrenceInfo.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -630,39 +630,19 @@ calRecurrenceInfo.prototype = {</span>
<a href="#l12.4"></a><span id="l12.4">             }</span>
<a href="#l12.5"></a><span id="l12.5">         }</span>
<a href="#l12.6"></a><span id="l12.6"> </span>
<a href="#l12.7"></a><span id="l12.7">         aCount.value = results.length;</span>
<a href="#l12.8"></a><span id="l12.8">         return results;</span>
<a href="#l12.9"></a><span id="l12.9">     },</span>
<a href="#l12.10"></a><span id="l12.10"> </span>
<a href="#l12.11"></a><span id="l12.11">     getOccurrenceFor: function cRI_getOccurrenceFor(aRecurrenceId) {</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-        var proxy = this.getExceptionFor(aRecurrenceId, false);</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+        let proxy = this.getExceptionFor(aRecurrenceId);</span>
<a href="#l12.14"></a><span id="l12.14">         if (!proxy) {</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineminus">-            var duration = null;</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineminus">-</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineminus">-            var name = &quot;DTEND&quot;;</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineminus">-            if (isToDo(this.mBaseItem))</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineminus">-                name = &quot;DUE&quot;;</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineminus">-</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineminus">-            if (this.mBaseItem.hasProperty(name)) {</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineminus">-                duration = this.mBaseItem.duration;</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineminus">-            }</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineminus">-</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineminus">-            proxy = this.mBaseItem.createProxy();</span>
<a href="#l12.26"></a><span id="l12.26" class="difflineminus">-            proxy.recurrenceId = aRecurrenceId;</span>
<a href="#l12.27"></a><span id="l12.27" class="difflineminus">-            proxy.setProperty(&quot;DTSTART&quot;, aRecurrenceId.clone());</span>
<a href="#l12.28"></a><span id="l12.28" class="difflineminus">-            if (duration) {</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineminus">-                var enddate = aRecurrenceId.clone();</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineminus">-                enddate.addDuration(duration);</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineminus">-                proxy.setProperty(name, enddate);</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineminus">-            }</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineminus">-            if (!this.mBaseItem.isMutable) {</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineminus">-                proxy.makeImmutable();</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineminus">-            }</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineplus">+            return this.item.createProxy(aRecurrenceId);</span>
<a href="#l12.37"></a><span id="l12.37">         }</span>
<a href="#l12.38"></a><span id="l12.38">         return proxy;</span>
<a href="#l12.39"></a><span id="l12.39">     },</span>
<a href="#l12.40"></a><span id="l12.40"> </span>
<a href="#l12.41"></a><span id="l12.41">     removeOccurrenceAt: function cRI_removeOccurrenceAt(aRecurrenceId) {</span>
<a href="#l12.42"></a><span id="l12.42">         this.ensureBaseItem();</span>
<a href="#l12.43"></a><span id="l12.43">         this.ensureMutable();</span>
<a href="#l12.44"></a><span id="l12.44"> </span>
<a href="#l12.45"></a><span id="l12.45" class="difflineat">@@ -752,66 +732,19 @@ calRecurrenceInfo.prototype = {</span>
<a href="#l12.46"></a><span id="l12.46"> </span>
<a href="#l12.47"></a><span id="l12.47">         // we're going to assume that the recurrenceId is valid here,</span>
<a href="#l12.48"></a><span id="l12.48">         // because presumably the item came from one of our functions</span>
<a href="#l12.49"></a><span id="l12.49"> </span>
<a href="#l12.50"></a><span id="l12.50">         var exKey = getRidKey(itemtoadd.recurrenceId);</span>
<a href="#l12.51"></a><span id="l12.51">         this.mExceptionMap[exKey] = itemtoadd;</span>
<a href="#l12.52"></a><span id="l12.52">     },</span>
<a href="#l12.53"></a><span id="l12.53"> </span>
<a href="#l12.54"></a><span id="l12.54" class="difflineminus">-    createExceptionFor: function cRI_createExceptionFor(aRecurrenceId) {</span>
<a href="#l12.55"></a><span id="l12.55" class="difflineplus">+    getExceptionFor: function cRI_getExceptionFor(aRecurrenceId) {</span>
<a href="#l12.56"></a><span id="l12.56">         this.ensureBaseItem();</span>
<a href="#l12.57"></a><span id="l12.57" class="difflineminus">-</span>
<a href="#l12.58"></a><span id="l12.58" class="difflineminus">-        // XX should it be an error to createExceptionFor</span>
<a href="#l12.59"></a><span id="l12.59" class="difflineminus">-        // an already-existing recurrenceId?</span>
<a href="#l12.60"></a><span id="l12.60" class="difflineminus">-        var existing = this.getExceptionFor(aRecurrenceId, false);</span>
<a href="#l12.61"></a><span id="l12.61" class="difflineminus">-        if (existing)</span>
<a href="#l12.62"></a><span id="l12.62" class="difflineminus">-            return existing;</span>
<a href="#l12.63"></a><span id="l12.63" class="difflineminus">-</span>
<a href="#l12.64"></a><span id="l12.64" class="difflineminus">-        // check if aRecurrenceId is valid.</span>
<a href="#l12.65"></a><span id="l12.65" class="difflineminus">-</span>
<a href="#l12.66"></a><span id="l12.66" class="difflineminus">-        // this is a bit of a hack; we know that ranges are defined as [start, end),</span>
<a href="#l12.67"></a><span id="l12.67" class="difflineminus">-        // so we do a search on aRecurrenceId and aRecurrenceId.seconds + 1.</span>
<a href="#l12.68"></a><span id="l12.68" class="difflineminus">-        var rangeStart = aRecurrenceId;</span>
<a href="#l12.69"></a><span id="l12.69" class="difflineminus">-        var rangeEnd = aRecurrenceId.clone();</span>
<a href="#l12.70"></a><span id="l12.70" class="difflineminus">-        rangeEnd.second += 1;</span>
<a href="#l12.71"></a><span id="l12.71" class="difflineminus">-</span>
<a href="#l12.72"></a><span id="l12.72" class="difflineminus">-        var dates = this.getOccurrenceDates(rangeStart, rangeEnd, 1, {});</span>
<a href="#l12.73"></a><span id="l12.73" class="difflineminus">-        var found = false;</span>
<a href="#l12.74"></a><span id="l12.74" class="difflineminus">-        for each (d in dates) {</span>
<a href="#l12.75"></a><span id="l12.75" class="difflineminus">-            if (d.compare(aRecurrenceId) == 0) {</span>
<a href="#l12.76"></a><span id="l12.76" class="difflineminus">-                found = true;</span>
<a href="#l12.77"></a><span id="l12.77" class="difflineminus">-                break;</span>
<a href="#l12.78"></a><span id="l12.78" class="difflineminus">-            }</span>
<a href="#l12.79"></a><span id="l12.79" class="difflineminus">-        }</span>
<a href="#l12.80"></a><span id="l12.80" class="difflineminus">-</span>
<a href="#l12.81"></a><span id="l12.81" class="difflineminus">-        // not found; the recurrence id is invalid</span>
<a href="#l12.82"></a><span id="l12.82" class="difflineminus">-        if (!found)</span>
<a href="#l12.83"></a><span id="l12.83" class="difflineminus">-            throw Components.results.NS_ERROR_INVALID_ARG;</span>
<a href="#l12.84"></a><span id="l12.84" class="difflineminus">-</span>
<a href="#l12.85"></a><span id="l12.85" class="difflineminus">-        var rid = aRecurrenceId.clone();</span>
<a href="#l12.86"></a><span id="l12.86" class="difflineminus">-        rid.makeImmutable();</span>
<a href="#l12.87"></a><span id="l12.87" class="difflineminus">-</span>
<a href="#l12.88"></a><span id="l12.88" class="difflineminus">-        var newex = this.mBaseItem.createProxy();</span>
<a href="#l12.89"></a><span id="l12.89" class="difflineminus">-        newex.recurrenceId = rid;</span>
<a href="#l12.90"></a><span id="l12.90" class="difflineminus">-        this.mExceptionMap[getRidKey(rid)] = newex;</span>
<a href="#l12.91"></a><span id="l12.91" class="difflineminus">-</span>
<a href="#l12.92"></a><span id="l12.92" class="difflineminus">-        return newex;</span>
<a href="#l12.93"></a><span id="l12.93" class="difflineminus">-    },</span>
<a href="#l12.94"></a><span id="l12.94" class="difflineminus">-</span>
<a href="#l12.95"></a><span id="l12.95" class="difflineminus">-    getExceptionFor: function cRI_getExceptionFor(aRecurrenceId, aCreate) {</span>
<a href="#l12.96"></a><span id="l12.96" class="difflineminus">-        this.ensureBaseItem();</span>
<a href="#l12.97"></a><span id="l12.97" class="difflineminus">-</span>
<a href="#l12.98"></a><span id="l12.98" class="difflineminus">-        var exc = this.mExceptionMap[getRidKey(aRecurrenceId)];</span>
<a href="#l12.99"></a><span id="l12.99" class="difflineminus">-        if (exc) {</span>
<a href="#l12.100"></a><span id="l12.100" class="difflineminus">-            return exc;</span>
<a href="#l12.101"></a><span id="l12.101" class="difflineminus">-        } else if (aCreate) {</span>
<a href="#l12.102"></a><span id="l12.102" class="difflineminus">-            return this.createExceptionFor(aRecurrenceId);</span>
<a href="#l12.103"></a><span id="l12.103" class="difflineminus">-        }</span>
<a href="#l12.104"></a><span id="l12.104" class="difflineminus">-        return null;</span>
<a href="#l12.105"></a><span id="l12.105" class="difflineplus">+        return this.mExceptionMap[getRidKey(aRecurrenceId)];</span>
<a href="#l12.106"></a><span id="l12.106">     },</span>
<a href="#l12.107"></a><span id="l12.107"> </span>
<a href="#l12.108"></a><span id="l12.108">     removeExceptionFor: function cRI_removeExceptionFor(aRecurrenceId) {</span>
<a href="#l12.109"></a><span id="l12.109">         this.ensureBaseItem();</span>
<a href="#l12.110"></a><span id="l12.110">         delete this.mExceptionMap[getRidKey(aRecurrenceId)];</span>
<a href="#l12.111"></a><span id="l12.111">     },</span>
<a href="#l12.112"></a><span id="l12.112"> </span>
<a href="#l12.113"></a><span id="l12.113">     getExceptionIds: function cRI_getExceptionIds(aCount) {</span>
<a href="#l12.114"></a><span id="l12.114" class="difflineat">@@ -881,17 +814,17 @@ calRecurrenceInfo.prototype = {</span>
<a href="#l12.115"></a><span id="l12.115">                 }</span>
<a href="#l12.116"></a><span id="l12.116">             }</span>
<a href="#l12.117"></a><span id="l12.117">         }</span>
<a href="#l12.118"></a><span id="l12.118"> </span>
<a href="#l12.119"></a><span id="l12.119">         var startTimezone = aNewStartTime.timezone;</span>
<a href="#l12.120"></a><span id="l12.120">         var exceptions = this.getExceptionIds({});</span>
<a href="#l12.121"></a><span id="l12.121">         var modifiedExceptions = [];</span>
<a href="#l12.122"></a><span id="l12.122">         for each (var exid in exceptions) {</span>
<a href="#l12.123"></a><span id="l12.123" class="difflineminus">-            var ex = this.getExceptionFor(exid, false);</span>
<a href="#l12.124"></a><span id="l12.124" class="difflineplus">+            let ex = this.getExceptionFor(exid);</span>
<a href="#l12.125"></a><span id="l12.125">             if (ex) {</span>
<a href="#l12.126"></a><span id="l12.126">                 ex = ex.clone();</span>
<a href="#l12.127"></a><span id="l12.127">                 // track RECURRENCE-IDs in DTSTART's or RDATE's timezone,</span>
<a href="#l12.128"></a><span id="l12.128">                 // otherwise those won't match any longer w.r.t DST:</span>
<a href="#l12.129"></a><span id="l12.129">                 var rid = ex.recurrenceId;</span>
<a href="#l12.130"></a><span id="l12.130">                 rid = rid.getInTimezone(rdates[getRidKey(rid)]</span>
<a href="#l12.131"></a><span id="l12.131">                                         ? rdates[getRidKey(rid)].timezone</span>
<a href="#l12.132"></a><span id="l12.132">                                         : startTimezone);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/calendar/base/src/calTodo.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/calendar/base/src/calTodo.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -32,19 +32,17 @@</span>
<a href="#l13.4"></a><span id="l13.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l13.5"></a><span id="l13.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l13.6"></a><span id="l13.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l13.7"></a><span id="l13.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l13.8"></a><span id="l13.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l13.9"></a><span id="l13.9">  *</span>
<a href="#l13.10"></a><span id="l13.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l13.11"></a><span id="l13.11"> </span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-//</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-// calTodo.js</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineminus">-//</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l13.16"></a><span id="l13.16"> </span>
<a href="#l13.17"></a><span id="l13.17"> //</span>
<a href="#l13.18"></a><span id="l13.18"> // constructor</span>
<a href="#l13.19"></a><span id="l13.19"> //</span>
<a href="#l13.20"></a><span id="l13.20"> function calTodo() {</span>
<a href="#l13.21"></a><span id="l13.21">     this.initItemBase();</span>
<a href="#l13.22"></a><span id="l13.22"> </span>
<a href="#l13.23"></a><span id="l13.23">     this.todoPromotedProps = {</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineat">@@ -83,30 +81,38 @@ var calTodoClassInfo = {</span>
<a href="#l13.25"></a><span id="l13.25"> calTodo.prototype = {</span>
<a href="#l13.26"></a><span id="l13.26">     __proto__: calItemBase.prototype,</span>
<a href="#l13.27"></a><span id="l13.27"> </span>
<a href="#l13.28"></a><span id="l13.28">     QueryInterface: function (aIID) {</span>
<a href="#l13.29"></a><span id="l13.29">         return doQueryInterface(this, calEvent.prototype, aIID, null, calTodoClassInfo);</span>
<a href="#l13.30"></a><span id="l13.30">     },</span>
<a href="#l13.31"></a><span id="l13.31"> </span>
<a href="#l13.32"></a><span id="l13.32">     cloneShallow: function (aNewParent) {</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineminus">-        var m = new calTodo();</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineplus">+        let m = new calTodo();</span>
<a href="#l13.35"></a><span id="l13.35">         this.cloneItemBaseInto(m, aNewParent);</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineminus">-</span>
<a href="#l13.37"></a><span id="l13.37">         return m;</span>
<a href="#l13.38"></a><span id="l13.38">     },</span>
<a href="#l13.39"></a><span id="l13.39"> </span>
<a href="#l13.40"></a><span id="l13.40" class="difflineminus">-    createProxy: function () {</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineminus">-        if (this.mIsProxy) {</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineminus">-            calDebug(&quot;Tried to create a proxy for an existing proxy!\n&quot;);</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineminus">-            throw Components.results.NS_ERROR_UNEXPECTED;</span>
<a href="#l13.44"></a><span id="l13.44" class="difflineplus">+    createProxy: function calTodo_createProxy(aRecurrenceId) {</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineplus">+        cal.ASSERT(!this.mIsProxy, &quot;Tried to create a proxy for an existing proxy!&quot;, true);</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineplus">+</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineplus">+        let m = new calTodo();</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineplus">+</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineplus">+        // override proxy's DTSTART/DUE/RECURRENCE-ID</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineplus">+        // before master is set (and item might get immutable):</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineplus">+        let duration = this.duration;</span>
<a href="#l13.52"></a><span id="l13.52" class="difflineplus">+        if (duration) {</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineplus">+            let dueDate = aRecurrenceId.clone();</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineplus">+            dueDate.addDuration(duration);</span>
<a href="#l13.55"></a><span id="l13.55" class="difflineplus">+            m.dueDate = dueDate;</span>
<a href="#l13.56"></a><span id="l13.56">         }</span>
<a href="#l13.57"></a><span id="l13.57" class="difflineplus">+        m.entryDate = aRecurrenceId;</span>
<a href="#l13.58"></a><span id="l13.58"> </span>
<a href="#l13.59"></a><span id="l13.59" class="difflineminus">-        var m = new calTodo();</span>
<a href="#l13.60"></a><span id="l13.60" class="difflineminus">-        m.initializeProxy(this);</span>
<a href="#l13.61"></a><span id="l13.61" class="difflineplus">+        m.initializeProxy(this, aRecurrenceId);</span>
<a href="#l13.62"></a><span id="l13.62" class="difflineplus">+        m.mDirty = false;</span>
<a href="#l13.63"></a><span id="l13.63"> </span>
<a href="#l13.64"></a><span id="l13.64">         return m;</span>
<a href="#l13.65"></a><span id="l13.65">     },</span>
<a href="#l13.66"></a><span id="l13.66"> </span>
<a href="#l13.67"></a><span id="l13.67">     makeImmutable: function () {</span>
<a href="#l13.68"></a><span id="l13.68">         this.makeItemBaseImmutable();</span>
<a href="#l13.69"></a><span id="l13.69">     },</span>
<a href="#l13.70"></a><span id="l13.70"> </span>
<a href="#l13.71"></a><span id="l13.71" class="difflineat">@@ -194,20 +200,19 @@ calTodo.prototype = {</span>
<a href="#l13.72"></a><span id="l13.72">     set icalComponent(todo) {</span>
<a href="#l13.73"></a><span id="l13.73">         this.modify();</span>
<a href="#l13.74"></a><span id="l13.74">         if (todo.componentType != &quot;VTODO&quot;) {</span>
<a href="#l13.75"></a><span id="l13.75">             todo = todo.getFirstSubcomponent(&quot;VTODO&quot;);</span>
<a href="#l13.76"></a><span id="l13.76">             if (!todo)</span>
<a href="#l13.77"></a><span id="l13.77">                 throw Components.results.NS_ERROR_INVALID_ARG;</span>
<a href="#l13.78"></a><span id="l13.78">         }</span>
<a href="#l13.79"></a><span id="l13.79"> </span>
<a href="#l13.80"></a><span id="l13.80" class="difflineminus">-        // xxx todo: Bug 463195 make sure object is properly reset</span>
<a href="#l13.81"></a><span id="l13.81" class="difflineplus">+        this.mDueDate = undefined;</span>
<a href="#l13.82"></a><span id="l13.82">         this.setItemBaseFromICS(todo);</span>
<a href="#l13.83"></a><span id="l13.83">         this.mapPropsFromICS(todo, this.icsEventPropMap);</span>
<a href="#l13.84"></a><span id="l13.84" class="difflineminus">-        this.mIsAllDay = this.mStartDate &amp;&amp; this.mStartDate.isDate;</span>
<a href="#l13.85"></a><span id="l13.85"> </span>
<a href="#l13.86"></a><span id="l13.86">         this.importUnpromotedProperties(todo, this.todoPromotedProps);</span>
<a href="#l13.87"></a><span id="l13.87">         // Importing didn't really change anything</span>
<a href="#l13.88"></a><span id="l13.88">         this.mDirty = false;</span>
<a href="#l13.89"></a><span id="l13.89">     },</span>
<a href="#l13.90"></a><span id="l13.90"> </span>
<a href="#l13.91"></a><span id="l13.91">     isPropertyPromoted: function (name) {</span>
<a href="#l13.92"></a><span id="l13.92">         return (this.todoPromotedProps[name]);</span>
<a href="#l13.93"></a><span id="l13.93" class="difflineat">@@ -240,20 +245,17 @@ calTodo.prototype = {</span>
<a href="#l13.94"></a><span id="l13.94">         if (dueDate === undefined) {</span>
<a href="#l13.95"></a><span id="l13.95">             dueDate = this.getProperty(&quot;DUE&quot;);</span>
<a href="#l13.96"></a><span id="l13.96">             if (!dueDate) {</span>
<a href="#l13.97"></a><span id="l13.97">                 var entryDate = this.entryDate;</span>
<a href="#l13.98"></a><span id="l13.98">                 var dur = this.getProperty(&quot;DURATION&quot;);</span>
<a href="#l13.99"></a><span id="l13.99">                 if (entryDate &amp;&amp; dur) {</span>
<a href="#l13.100"></a><span id="l13.100">                     // If there is a duration set on the todo, calculate the right end time.</span>
<a href="#l13.101"></a><span id="l13.101">                     dueDate = entryDate.clone();</span>
<a href="#l13.102"></a><span id="l13.102" class="difflineminus">-                    var icalDur = Components.classes[&quot;@mozilla.org/calendar/duration;1&quot;]</span>
<a href="#l13.103"></a><span id="l13.103" class="difflineminus">-                                            .createInstance(Components.interfaces.calIDuration);</span>
<a href="#l13.104"></a><span id="l13.104" class="difflineminus">-                    icalDur.icalString = dur;</span>
<a href="#l13.105"></a><span id="l13.105" class="difflineminus">-                    dueDate.addDuration(icalDur);</span>
<a href="#l13.106"></a><span id="l13.106" class="difflineplus">+                    dueDate.addDuration(cal.createDuration(dur));</span>
<a href="#l13.107"></a><span id="l13.107">                 }</span>
<a href="#l13.108"></a><span id="l13.108">             }</span>
<a href="#l13.109"></a><span id="l13.109">             this.mDueDate = dueDate;</span>
<a href="#l13.110"></a><span id="l13.110">         }</span>
<a href="#l13.111"></a><span id="l13.111">         return dueDate;</span>
<a href="#l13.112"></a><span id="l13.112">     },</span>
<a href="#l13.113"></a><span id="l13.113"> </span>
<a href="#l13.114"></a><span id="l13.114">     set dueDate(value) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/calendar/base/src/calUtils.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/calendar/base/src/calUtils.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -32,18 +32,16 @@</span>
<a href="#l14.4"></a><span id="l14.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l14.5"></a><span id="l14.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l14.6"></a><span id="l14.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l14.7"></a><span id="l14.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l14.8"></a><span id="l14.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l14.9"></a><span id="l14.9">  *</span>
<a href="#l14.10"></a><span id="l14.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l14.11"></a><span id="l14.11"> </span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-Components.utils.import(&quot;resource://gre/modules/debug.js&quot;);</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineminus">-</span>
<a href="#l14.14"></a><span id="l14.14"> /* This file contains commonly used functions in a centralized place so that</span>
<a href="#l14.15"></a><span id="l14.15">  * various components (and other js scopes) don't need to replicate them. Note</span>
<a href="#l14.16"></a><span id="l14.16">  * that loading this file twice in the same scope will throw errors.</span>
<a href="#l14.17"></a><span id="l14.17">  */</span>
<a href="#l14.18"></a><span id="l14.18"> </span>
<a href="#l14.19"></a><span id="l14.19"> /* Returns a clean new calIEvent */</span>
<a href="#l14.20"></a><span id="l14.20"> function createEvent() {</span>
<a href="#l14.21"></a><span id="l14.21">     return Components.classes[&quot;@mozilla.org/calendar/event;1&quot;].</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineat">@@ -950,17 +948,17 @@ function ERROR(aMessage) {</span>
<a href="#l14.23"></a><span id="l14.23"> /**</span>
<a href="#l14.24"></a><span id="l14.24">  * Returns a string describing the current js-stack with filename and line</span>
<a href="#l14.25"></a><span id="l14.25">  * numbers.</span>
<a href="#l14.26"></a><span id="l14.26">  *</span>
<a href="#l14.27"></a><span id="l14.27">  * @param aDepth (optional) The number of frames to include. Defaults to 5.</span>
<a href="#l14.28"></a><span id="l14.28">  * @param aSkip  (optional) Number of frames to skip</span>
<a href="#l14.29"></a><span id="l14.29">  */</span>
<a href="#l14.30"></a><span id="l14.30"> function STACK(aDepth, aSkip) {</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineminus">-    let depth = aDepth || 5;</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineplus">+    let depth = aDepth || 10;</span>
<a href="#l14.33"></a><span id="l14.33">     let skip = aSkip || 0;</span>
<a href="#l14.34"></a><span id="l14.34">     let stack = &quot;&quot;;</span>
<a href="#l14.35"></a><span id="l14.35">     let frame = Components.stack.caller;</span>
<a href="#l14.36"></a><span id="l14.36">     for (let i = 1; i &lt;= depth + skip &amp;&amp; frame; i++) {</span>
<a href="#l14.37"></a><span id="l14.37">         if (i &gt; skip) {</span>
<a href="#l14.38"></a><span id="l14.38">             stack += i + &quot;: [&quot; + frame.filename + &quot;:&quot; +</span>
<a href="#l14.39"></a><span id="l14.39">                      frame.lineNumber + &quot;] &quot; + frame.name + &quot;\n&quot;;</span>
<a href="#l14.40"></a><span id="l14.40">         }</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineat">@@ -1864,19 +1862,18 @@ function setDefaultAlarmValues(aItem)</span>
<a href="#l14.42"></a><span id="l14.42"> {</span>
<a href="#l14.43"></a><span id="l14.43">     var prefService = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l14.44"></a><span id="l14.44">                                 .getService(Components.interfaces.nsIPrefService);</span>
<a href="#l14.45"></a><span id="l14.45">     var alarmsBranch = prefService.getBranch(&quot;calendar.alarms.&quot;);</span>
<a href="#l14.46"></a><span id="l14.46"> </span>
<a href="#l14.47"></a><span id="l14.47">     if (isEvent(aItem)) {</span>
<a href="#l14.48"></a><span id="l14.48">         try {</span>
<a href="#l14.49"></a><span id="l14.49">             if (alarmsBranch.getIntPref(&quot;onforevents&quot;) == 1) {</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineminus">-                var alarmOffset = Components.classes[&quot;@mozilla.org/calendar/duration;1&quot;]</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineminus">-                                            .createInstance(Components.interfaces.calIDuration);</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineminus">-                var units = alarmsBranch.getCharPref(&quot;eventalarmunit&quot;);</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineplus">+                let alarmOffset = createDuration();</span>
<a href="#l14.54"></a><span id="l14.54" class="difflineplus">+                let units = alarmsBranch.getCharPref(&quot;eventalarmunit&quot;);</span>
<a href="#l14.55"></a><span id="l14.55">                 alarmOffset[units] = alarmsBranch.getIntPref(&quot;eventalarmlen&quot;);</span>
<a href="#l14.56"></a><span id="l14.56">                 alarmOffset.isNegative = true;</span>
<a href="#l14.57"></a><span id="l14.57">                 aItem.alarmOffset = alarmOffset;</span>
<a href="#l14.58"></a><span id="l14.58">                 aItem.alarmRelated = Components.interfaces.calIItemBase.ALARM_RELATED_START;</span>
<a href="#l14.59"></a><span id="l14.59">             }</span>
<a href="#l14.60"></a><span id="l14.60">         } catch (ex) {</span>
<a href="#l14.61"></a><span id="l14.61">             Components.utils.reportError(</span>
<a href="#l14.62"></a><span id="l14.62">                 &quot;Failed to apply default alarm settings to event: &quot; + ex);</span>
<a href="#l14.63"></a><span id="l14.63" class="difflineat">@@ -1884,19 +1881,18 @@ function setDefaultAlarmValues(aItem)</span>
<a href="#l14.64"></a><span id="l14.64">     } else if (isToDo(aItem)) {</span>
<a href="#l14.65"></a><span id="l14.65">         try {</span>
<a href="#l14.66"></a><span id="l14.66">             if (alarmsBranch.getIntPref(&quot;onfortodos&quot;) == 1) {</span>
<a href="#l14.67"></a><span id="l14.67">                 // You can't have an alarm if the entryDate doesn't exist.</span>
<a href="#l14.68"></a><span id="l14.68">                 if (!aItem.entryDate) {</span>
<a href="#l14.69"></a><span id="l14.69">                     aItem.entryDate = getSelectedDay() &amp;&amp;</span>
<a href="#l14.70"></a><span id="l14.70">                                       getSelectedDay().clone() || now();</span>
<a href="#l14.71"></a><span id="l14.71">                 }</span>
<a href="#l14.72"></a><span id="l14.72" class="difflineminus">-                var alarmOffset = Components.classes[&quot;@mozilla.org/calendar/duration;1&quot;]</span>
<a href="#l14.73"></a><span id="l14.73" class="difflineminus">-                                            .createInstance(Components.interfaces.calIDuration);</span>
<a href="#l14.74"></a><span id="l14.74" class="difflineminus">-                var units = alarmsBranch.getCharPref(&quot;todoalarmunit&quot;);</span>
<a href="#l14.75"></a><span id="l14.75" class="difflineplus">+                let alarmOffset = createDuration();</span>
<a href="#l14.76"></a><span id="l14.76" class="difflineplus">+                let units = alarmsBranch.getCharPref(&quot;todoalarmunit&quot;);</span>
<a href="#l14.77"></a><span id="l14.77">                 alarmOffset[units] = alarmsBranch.getIntPref(&quot;todoalarmlen&quot;);</span>
<a href="#l14.78"></a><span id="l14.78">                 alarmOffset.isNegative = true;</span>
<a href="#l14.79"></a><span id="l14.79">                 aItem.alarmOffset = alarmOffset;</span>
<a href="#l14.80"></a><span id="l14.80">                 aItem.alarmRelated = Components.interfaces.calIItemBase.ALARM_RELATED_START;</span>
<a href="#l14.81"></a><span id="l14.81">             }</span>
<a href="#l14.82"></a><span id="l14.82">         } catch (ex) {</span>
<a href="#l14.83"></a><span id="l14.83">             Components.utils.reportError(</span>
<a href="#l14.84"></a><span id="l14.84">                 &quot;Failed to apply default alarm settings to task: &quot; + ex);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/calendar/providers/gdata/components/calGoogleCalendar.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/calendar/providers/gdata/components/calGoogleCalendar.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -398,17 +398,17 @@ calGoogleCalendar.prototype = {</span>
<a href="#l15.4"></a><span id="l15.4">             // therefore not be added in the returned item. </span>
<a href="#l15.5"></a><span id="l15.5">             var newItem = aNewItem.clone();</span>
<a href="#l15.6"></a><span id="l15.6"> </span>
<a href="#l15.7"></a><span id="l15.7">             var xmlEntry = ItemToXMLEntry(newItem,</span>
<a href="#l15.8"></a><span id="l15.8">                                           this.session.userName,</span>
<a href="#l15.9"></a><span id="l15.9">                                           this.session.fullName);</span>
<a href="#l15.10"></a><span id="l15.10"> </span>
<a href="#l15.11"></a><span id="l15.11">             if (aOldItem.parentItem != aOldItem &amp;&amp;</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-                !aOldItem.parentItem.recurrenceInfo.getExceptionFor(aOldItem.startDate, false)) {</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+                !aOldItem.parentItem.recurrenceInfo.getExceptionFor(aOldItem.startDate)) {</span>
<a href="#l15.14"></a><span id="l15.14"> </span>
<a href="#l15.15"></a><span id="l15.15">                 // In this case we are modifying an occurence, not deleting it</span>
<a href="#l15.16"></a><span id="l15.16">                 request.type = request.ADD;</span>
<a href="#l15.17"></a><span id="l15.17">                 request.uri = this.fullUri.spec;</span>
<a href="#l15.18"></a><span id="l15.18">             } else {</span>
<a href="#l15.19"></a><span id="l15.19">                 // We are  making a negative exception or modifying a parent item</span>
<a href="#l15.20"></a><span id="l15.20">                 request.type = request.MODIFY;</span>
<a href="#l15.21"></a><span id="l15.21">                 request.uri = getItemEditURI(aOldItem);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/calendar/providers/memory/calMemoryCalendar.js</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/calendar/providers/memory/calMemoryCalendar.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -147,17 +147,21 @@ calMemoryCalendar.prototype = {</span>
<a href="#l16.4"></a><span id="l16.4">                                              Components.interfaces.calIErrors.DUPLICATE_ID,</span>
<a href="#l16.5"></a><span id="l16.5">                                              Components.interfaces.calIOperationListener.ADD,</span>
<a href="#l16.6"></a><span id="l16.6">                                              aItem.id,</span>
<a href="#l16.7"></a><span id="l16.7">                                              &quot;ID already exists for addItem&quot;);</span>
<a href="#l16.8"></a><span id="l16.8">                 return;</span>
<a href="#l16.9"></a><span id="l16.9">             }</span>
<a href="#l16.10"></a><span id="l16.10">         }</span>
<a href="#l16.11"></a><span id="l16.11"> </span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-        let parentItem = aItem.parentItem</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+        let parentItem = aItem.parentItem;</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineplus">+        if (parentItem != aItem) {</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineplus">+            parentItem = parentItem.clone();</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineplus">+            parentItem.recurrenceInfo.modifyException(aItem, true);</span>
<a href="#l16.17"></a><span id="l16.17" class="difflineplus">+        }</span>
<a href="#l16.18"></a><span id="l16.18">         parentItem.calendar = this.superCalendar;</span>
<a href="#l16.19"></a><span id="l16.19"> </span>
<a href="#l16.20"></a><span id="l16.20">         parentItem.makeImmutable();</span>
<a href="#l16.21"></a><span id="l16.21">         this.mItems[aItem.id] = parentItem;</span>
<a href="#l16.22"></a><span id="l16.22"> </span>
<a href="#l16.23"></a><span id="l16.23">         // notify the listener</span>
<a href="#l16.24"></a><span id="l16.24">         this.notifyOperationComplete(aListener,</span>
<a href="#l16.25"></a><span id="l16.25">                                      Components.results.NS_OK,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/calendar/providers/storage/calStorageCalendar.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/calendar/providers/storage/calStorageCalendar.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -425,16 +425,20 @@ calStorageCalendar.prototype = {</span>
<a href="#l17.4"></a><span id="l17.4">                                                  aItem.id,</span>
<a href="#l17.5"></a><span id="l17.5">                                                  &quot;ID already exists for addItem&quot;);</span>
<a href="#l17.6"></a><span id="l17.6">                     return;</span>
<a href="#l17.7"></a><span id="l17.7">                 }</span>
<a href="#l17.8"></a><span id="l17.8">             }</span>
<a href="#l17.9"></a><span id="l17.9">         }</span>
<a href="#l17.10"></a><span id="l17.10"> </span>
<a href="#l17.11"></a><span id="l17.11">         let parentItem = aItem.parentItem;</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineplus">+        if (parentItem != aItem) {</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+            parentItem = parentItem.clone();</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineplus">+            parentItem.recurrenceInfo.modifyException(aItem, true);</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineplus">+        }</span>
<a href="#l17.16"></a><span id="l17.16">         parentItem.calendar = this.superCalendar;</span>
<a href="#l17.17"></a><span id="l17.17">         parentItem.makeImmutable();</span>
<a href="#l17.18"></a><span id="l17.18"> </span>
<a href="#l17.19"></a><span id="l17.19">         this.flushItem(parentItem, null);</span>
<a href="#l17.20"></a><span id="l17.20"> </span>
<a href="#l17.21"></a><span id="l17.21">         // notify the listener</span>
<a href="#l17.22"></a><span id="l17.22">         this.notifyOperationComplete(aListener,</span>
<a href="#l17.23"></a><span id="l17.23">                                      Components.results.NS_OK,</span>
<a href="#l17.24"></a><span id="l17.24" class="difflineat">@@ -494,16 +498,19 @@ calStorageCalendar.prototype = {</span>
<a href="#l17.25"></a><span id="l17.25">                 return reportError(&quot;ID does not already exist for modifyItem&quot;);</span>
<a href="#l17.26"></a><span id="l17.26">             }</span>
<a href="#l17.27"></a><span id="l17.27">             aOldItem = aOldItem.parentItem;</span>
<a href="#l17.28"></a><span id="l17.28"> </span>
<a href="#l17.29"></a><span id="l17.29">             if (aOldItem.generation != storedOldItem.generation) {</span>
<a href="#l17.30"></a><span id="l17.30">                 return reportError(&quot;generation too old for for modifyItem&quot;);</span>
<a href="#l17.31"></a><span id="l17.31">             }</span>
<a href="#l17.32"></a><span id="l17.32"> </span>
<a href="#l17.33"></a><span id="l17.33" class="difflineplus">+            // xxx todo: this only modified master item's generation properties</span>
<a href="#l17.34"></a><span id="l17.34" class="difflineplus">+            //           I start asking myself why we need a separate X-MOZ-GENERATION.</span>
<a href="#l17.35"></a><span id="l17.35" class="difflineplus">+            //           Just for the sake of checking inconsistencies of modifyItem calls?</span>
<a href="#l17.36"></a><span id="l17.36">             if (aOldItem.generation == modifiedItem.generation) { // has been cloned and modified</span>
<a href="#l17.37"></a><span id="l17.37">                 // Only take care of incrementing the generation if relaxed mode is</span>
<a href="#l17.38"></a><span id="l17.38">                 // off. Users of relaxed mode need to take care of this themselves.</span>
<a href="#l17.39"></a><span id="l17.39">                 modifiedItem.generation += 1;</span>
<a href="#l17.40"></a><span id="l17.40">             }</span>
<a href="#l17.41"></a><span id="l17.41">         }</span>
<a href="#l17.42"></a><span id="l17.42"> </span>
<a href="#l17.43"></a><span id="l17.43">         modifiedItem.makeImmutable();</span>
<a href="#l17.44"></a><span id="l17.44" class="difflineat">@@ -2453,17 +2460,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l17.45"></a><span id="l17.45">             var exceptions = rec.getExceptionIds ({});</span>
<a href="#l17.46"></a><span id="l17.46">             if (exceptions.length &gt; 0) {</span>
<a href="#l17.47"></a><span id="l17.47">                 flags |= CAL_ITEM_FLAG_HAS_EXCEPTIONS;</span>
<a href="#l17.48"></a><span id="l17.48"> </span>
<a href="#l17.49"></a><span id="l17.49">                 // we need to serialize each exid as a separate</span>
<a href="#l17.50"></a><span id="l17.50">                 // event/todo; setupItemBase will handle</span>
<a href="#l17.51"></a><span id="l17.51">                 // writing the recurrenceId for us</span>
<a href="#l17.52"></a><span id="l17.52">                 for each (exid in exceptions) {</span>
<a href="#l17.53"></a><span id="l17.53" class="difflineminus">-                    var ex = rec.getExceptionFor(exid, false);</span>
<a href="#l17.54"></a><span id="l17.54" class="difflineplus">+                    let ex = rec.getExceptionFor(exid);</span>
<a href="#l17.55"></a><span id="l17.55">                     if (!ex)</span>
<a href="#l17.56"></a><span id="l17.56">                         throw Components.results.NS_ERROR_UNEXPECTED;</span>
<a href="#l17.57"></a><span id="l17.57">                     this.writeItem(ex, null);</span>
<a href="#l17.58"></a><span id="l17.58">                 }</span>
<a href="#l17.59"></a><span id="l17.59">             }</span>
<a href="#l17.60"></a><span id="l17.60">         }</span>
<a href="#l17.61"></a><span id="l17.61"> </span>
<a href="#l17.62"></a><span id="l17.62">         return flags;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/calendar/providers/wcap/calWcapCalendarItems.js</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/calendar/providers/wcap/calWcapCalendarItems.js</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -684,19 +684,16 @@ function calWcapCalendar_adoptItem(item,</span>
<a href="#l18.4"></a><span id="l18.4">                                           err ? err : newItem);</span>
<a href="#l18.5"></a><span id="l18.5">             if (!err) {</span>
<a href="#l18.6"></a><span id="l18.6">                 this_.notifyObservers(&quot;onAddItem&quot;, [newItem]);</span>
<a href="#l18.7"></a><span id="l18.7">             }</span>
<a href="#l18.8"></a><span id="l18.8">         },</span>
<a href="#l18.9"></a><span id="l18.9">         log(&quot;adoptItem() call: &quot; + item.title, this));</span>
<a href="#l18.10"></a><span id="l18.10"> </span>
<a href="#l18.11"></a><span id="l18.11">     try {</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-        if (!isParent(item)) {</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineminus">-            logError(&quot;adoptItem(): unexpected proxy!&quot;, this);</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineminus">-        }</span>
<a href="#l18.15"></a><span id="l18.15">         this.storeItem(true /* bAddItem */, item, null, request);</span>
<a href="#l18.16"></a><span id="l18.16">     } catch (exc) {</span>
<a href="#l18.17"></a><span id="l18.17">         request.execRespFunc(exc);</span>
<a href="#l18.18"></a><span id="l18.18">     }</span>
<a href="#l18.19"></a><span id="l18.19">     return request;</span>
<a href="#l18.20"></a><span id="l18.20"> }</span>
<a href="#l18.21"></a><span id="l18.21"> </span>
<a href="#l18.22"></a><span id="l18.22"> calWcapCalendar.prototype.addItem =</span>
<a href="#l18.23"></a><span id="l18.23" class="difflineat">@@ -770,17 +767,17 @@ function calWcapCalendar_modifyItem(newI</span>
<a href="#l18.24"></a><span id="l18.24">                                                  request.unlockPending();</span>
<a href="#l18.25"></a><span id="l18.25">                                              }</span>
<a href="#l18.26"></a><span id="l18.26">                                          },</span>
<a href="#l18.27"></a><span id="l18.27">                                          stringToXml, isEvent(newItem) ? &quot;deleteevents_by_id&quot; : &quot;deletetodos_by_id&quot;,</span>
<a href="#l18.28"></a><span id="l18.28">                                          params, calIWcapCalendar.AC_COMP_WRITE);</span>
<a href="#l18.29"></a><span id="l18.29">                 return request;</span>
<a href="#l18.30"></a><span id="l18.30">             }</span>
<a href="#l18.31"></a><span id="l18.31"> </span>
<a href="#l18.32"></a><span id="l18.32" class="difflineminus">-        } else if (oldItem &amp;&amp; !oldItem.parentItem.recurrenceInfo.getExceptionFor(newItem.recurrenceId, false)) {</span>
<a href="#l18.33"></a><span id="l18.33" class="difflineplus">+        } else if (oldItem &amp;&amp; !oldItem.parentItem.recurrenceInfo.getExceptionFor(newItem.recurrenceId)) {</span>
<a href="#l18.34"></a><span id="l18.34">             // pass null for oldItem when creating new exceptions, write whole item:</span>
<a href="#l18.35"></a><span id="l18.35">             oldItem_ = null;</span>
<a href="#l18.36"></a><span id="l18.36">         }</span>
<a href="#l18.37"></a><span id="l18.37">         this.storeItem(false /* bAddItem */, newItem, oldItem_, request);</span>
<a href="#l18.38"></a><span id="l18.38">     } catch (exc) {</span>
<a href="#l18.39"></a><span id="l18.39">         request.execRespFunc(exc);</span>
<a href="#l18.40"></a><span id="l18.40">     }</span>
<a href="#l18.41"></a><span id="l18.41">     return request;</span>
<a href="#l18.42"></a><span id="l18.42" class="difflineat">@@ -871,28 +868,29 @@ calWcapCalendar.prototype.patchTimezone </span>
<a href="#l18.43"></a><span id="l18.43"> }</span>
<a href="#l18.44"></a><span id="l18.44"> </span>
<a href="#l18.45"></a><span id="l18.45"> calWcapCalendar.prototype.parseItems = function calWcapCalendar_parseItems(</span>
<a href="#l18.46"></a><span id="l18.46">     icalRootComp, itemFilter, maxResults, rangeStart, rangeEnd, bLeaveMutable) {</span>
<a href="#l18.47"></a><span id="l18.47">     let items = [];</span>
<a href="#l18.48"></a><span id="l18.48">     let unexpandedItems = [];</span>
<a href="#l18.49"></a><span id="l18.49">     let uid2parent = {};</span>
<a href="#l18.50"></a><span id="l18.50">     let excItems = [];</span>
<a href="#l18.51"></a><span id="l18.51" class="difflineplus">+    let fakedParents = {};</span>
<a href="#l18.52"></a><span id="l18.52"> </span>
<a href="#l18.53"></a><span id="l18.53">     let componentType = &quot;ANY&quot;;</span>
<a href="#l18.54"></a><span id="l18.54">     switch (itemFilter &amp; calICalendar.ITEM_FILTER_TYPE_ALL) {</span>
<a href="#l18.55"></a><span id="l18.55">         case calICalendar.ITEM_FILTER_TYPE_TODO:</span>
<a href="#l18.56"></a><span id="l18.56">             componentType = &quot;VTODO&quot;;</span>
<a href="#l18.57"></a><span id="l18.57">             break;</span>
<a href="#l18.58"></a><span id="l18.58">         case calICalendar.ITEM_FILTER_TYPE_EVENT:</span>
<a href="#l18.59"></a><span id="l18.59">             componentType = &quot;VEVENT&quot;;</span>
<a href="#l18.60"></a><span id="l18.60">             break;</span>
<a href="#l18.61"></a><span id="l18.61">     }</span>
<a href="#l18.62"></a><span id="l18.62"> </span>
<a href="#l18.63"></a><span id="l18.63" class="difflineminus">-    var recurrenceBound = this.session.recurrenceBound;</span>
<a href="#l18.64"></a><span id="l18.64" class="difflineplus">+    let recurrenceBound = this.session.recurrenceBound;</span>
<a href="#l18.65"></a><span id="l18.65"> </span>
<a href="#l18.66"></a><span id="l18.66">     let count = 0;</span>
<a href="#l18.67"></a><span id="l18.67">     for (let subComp in cal.ical.calendarComponentIterator(icalRootComp, componentType)) {</span>
<a href="#l18.68"></a><span id="l18.68"> </span>
<a href="#l18.69"></a><span id="l18.69">         let organizer = subComp.getFirstProperty(&quot;ORGANIZER&quot;);</span>
<a href="#l18.70"></a><span id="l18.70">         if (organizer &amp;&amp; organizer.getParameter(&quot;SENT-BY&quot;)) { // has SENT-BY</span>
<a href="#l18.71"></a><span id="l18.71">             // &amp;emailorcalid=1 sets wrong email, workaround setting calid...</span>
<a href="#l18.72"></a><span id="l18.72">             let id = organizer.getParameter(&quot;X-S1CS-CALID&quot;);</span>
<a href="#l18.73"></a><span id="l18.73" class="difflineat">@@ -942,21 +940,20 @@ calWcapCalendar.prototype.parseItems = f</span>
<a href="#l18.74"></a><span id="l18.74">                         break;</span>
<a href="#l18.75"></a><span id="l18.75">                     case &quot;CONFIDENTIAL&quot;:</span>
<a href="#l18.76"></a><span id="l18.76">                         item.title = g_confidentialItemTitle;</span>
<a href="#l18.77"></a><span id="l18.77">                         break;</span>
<a href="#l18.78"></a><span id="l18.78">                 }</span>
<a href="#l18.79"></a><span id="l18.79">             }</span>
<a href="#l18.80"></a><span id="l18.80"> </span>
<a href="#l18.81"></a><span id="l18.81">             item.calendar = this.superCalendar;</span>
<a href="#l18.82"></a><span id="l18.82" class="difflineminus">-            var rid = item.recurrenceId;</span>
<a href="#l18.83"></a><span id="l18.83" class="difflineplus">+            let rid = item.recurrenceId;</span>
<a href="#l18.84"></a><span id="l18.84">             if (rid) {</span>
<a href="#l18.85"></a><span id="l18.85">                 rid = rid.getInTimezone(dtstart.timezone);</span>
<a href="#l18.86"></a><span id="l18.86">                 item.recurrenceId = rid;</span>
<a href="#l18.87"></a><span id="l18.87" class="difflineminus">-                item.recurrenceInfo = null;</span>
<a href="#l18.88"></a><span id="l18.88">                 if (LOG_LEVEL &gt; 1) {</span>
<a href="#l18.89"></a><span id="l18.89">                     log(&quot;exception item: &quot; + item.title +</span>
<a href="#l18.90"></a><span id="l18.90">                         &quot;\nrid=&quot; + getIcalUTC(rid) +</span>
<a href="#l18.91"></a><span id="l18.91">                         &quot;\nitem.id=&quot; + item.id, this);</span>
<a href="#l18.92"></a><span id="l18.92">                 }</span>
<a href="#l18.93"></a><span id="l18.93">                 excItems.push(item);</span>
<a href="#l18.94"></a><span id="l18.94"> </span>
<a href="#l18.95"></a><span id="l18.95">             } else if (item.recurrenceInfo) {</span>
<a href="#l18.96"></a><span id="l18.96" class="difflineat">@@ -971,102 +968,106 @@ calWcapCalendar.prototype.parseItems = f</span>
<a href="#l18.97"></a><span id="l18.97">                     item.makeImmutable();</span>
<a href="#l18.98"></a><span id="l18.98">                 }</span>
<a href="#l18.99"></a><span id="l18.99">                 items.push(item);</span>
<a href="#l18.100"></a><span id="l18.100">             }</span>
<a href="#l18.101"></a><span id="l18.101">         }</span>
<a href="#l18.102"></a><span id="l18.102">     }</span>
<a href="#l18.103"></a><span id="l18.103"> </span>
<a href="#l18.104"></a><span id="l18.104">     // tag &quot;exceptions&quot;, i.e. items with rid:</span>
<a href="#l18.105"></a><span id="l18.105" class="difflineminus">-    for each (var item in excItems) {</span>
<a href="#l18.106"></a><span id="l18.106" class="difflineminus">-        var parent = uid2parent[item.id];</span>
<a href="#l18.107"></a><span id="l18.107" class="difflineminus">-        if (parent) {</span>
<a href="#l18.108"></a><span id="l18.108" class="difflineminus">-            var recStartDate = parent.recurrenceStartDate;</span>
<a href="#l18.109"></a><span id="l18.109" class="difflineminus">-            if (recStartDate &amp;&amp; recStartDate.isDate &amp;&amp; !item.recurrenceId.isDate) {</span>
<a href="#l18.110"></a><span id="l18.110" class="difflineminus">-                // cs ought to return proper all-day RECURRENCE-ID!</span>
<a href="#l18.111"></a><span id="l18.111" class="difflineminus">-                // get into startDate's timezone before cutting:</span>
<a href="#l18.112"></a><span id="l18.112" class="difflineminus">-                var rid = item.recurrenceId.getInTimezone(recStartDate.timezone);</span>
<a href="#l18.113"></a><span id="l18.113" class="difflineminus">-                rid.isDate = true;</span>
<a href="#l18.114"></a><span id="l18.114" class="difflineminus">-                item.recurrenceId = rid;</span>
<a href="#l18.115"></a><span id="l18.115" class="difflineminus">-            }</span>
<a href="#l18.116"></a><span id="l18.116" class="difflineminus">-            parent.recurrenceInfo.modifyException(item, true);</span>
<a href="#l18.117"></a><span id="l18.117" class="difflineminus">-        } else {</span>
<a href="#l18.118"></a><span id="l18.118" class="difflineminus">-            logError(&quot;parseItems(): no parent item for &quot; + item.title +</span>
<a href="#l18.119"></a><span id="l18.119" class="difflineminus">-                     &quot;, rid=&quot; + getIcalUTC(item.recurrenceId) +</span>
<a href="#l18.120"></a><span id="l18.120" class="difflineminus">-                     &quot;, item.id=&quot; + item.id, this);</span>
<a href="#l18.121"></a><span id="l18.121" class="difflineminus">-            // due to a server bug, in some scenarions the returned</span>
<a href="#l18.122"></a><span id="l18.122" class="difflineminus">-            // data is lacking the parent item, leave parentItem open then</span>
<a href="#l18.123"></a><span id="l18.123" class="difflineminus">-            if ((itemFilter &amp; calICalendar.ITEM_FILTER_CLASS_OCCURRENCES) == 0) {</span>
<a href="#l18.124"></a><span id="l18.124" class="difflineminus">-                item.recurrenceId = null;</span>
<a href="#l18.125"></a><span id="l18.125" class="difflineminus">-            }</span>
<a href="#l18.126"></a><span id="l18.126" class="difflineminus">-            if (!bLeaveMutable) {</span>
<a href="#l18.127"></a><span id="l18.127" class="difflineminus">-                item.makeImmutable();</span>
<a href="#l18.128"></a><span id="l18.128" class="difflineminus">-            }</span>
<a href="#l18.129"></a><span id="l18.129" class="difflineminus">-            items.push(item);</span>
<a href="#l18.130"></a><span id="l18.130" class="difflineplus">+    for each (let item in excItems) {</span>
<a href="#l18.131"></a><span id="l18.131" class="difflineplus">+        let parent = uid2parent[item.id];</span>
<a href="#l18.132"></a><span id="l18.132" class="difflineplus">+</span>
<a href="#l18.133"></a><span id="l18.133" class="difflineplus">+        if (!parent) { // a parentless one, fake a master and override it's occurrence</span>
<a href="#l18.134"></a><span id="l18.134" class="difflineplus">+            parent = isEvent(item) ? createEvent() : createTodo();</span>
<a href="#l18.135"></a><span id="l18.135" class="difflineplus">+            parent.id = item.id;</span>
<a href="#l18.136"></a><span id="l18.136" class="difflineplus">+            parent.setProperty(&quot;DTSTART&quot;, item.recurrenceId);</span>
<a href="#l18.137"></a><span id="l18.137" class="difflineplus">+            parent.setProperty(&quot;X-MOZ-FAKED-MASTER&quot;, &quot;1&quot;); // this tag might be useful in the future</span>
<a href="#l18.138"></a><span id="l18.138" class="difflineplus">+            parent.recurrenceInfo = createRecurrenceInfo(parent);</span>
<a href="#l18.139"></a><span id="l18.139" class="difflineplus">+            fakedParents[item.id] = true;</span>
<a href="#l18.140"></a><span id="l18.140" class="difflineplus">+            uid2parent[item.id] = parent;</span>
<a href="#l18.141"></a><span id="l18.141" class="difflineplus">+            items.push(parent);</span>
<a href="#l18.142"></a><span id="l18.142">         }</span>
<a href="#l18.143"></a><span id="l18.143" class="difflineplus">+        if (item.id in fakedParents) { </span>
<a href="#l18.144"></a><span id="l18.144" class="difflineplus">+            let rdate = Components.classes[&quot;@mozilla.org/calendar/recurrence-date;1&quot;]</span>
<a href="#l18.145"></a><span id="l18.145" class="difflineplus">+                                  .createInstance(Components.interfaces.calIRecurrenceDate);</span>
<a href="#l18.146"></a><span id="l18.146" class="difflineplus">+            rdate.date = item.recurrenceId;</span>
<a href="#l18.147"></a><span id="l18.147" class="difflineplus">+            parent.recurrenceInfo.appendRecurrenceItem(rdate);</span>
<a href="#l18.148"></a><span id="l18.148" class="difflineplus">+        }</span>
<a href="#l18.149"></a><span id="l18.149" class="difflineplus">+</span>
<a href="#l18.150"></a><span id="l18.150" class="difflineplus">+        let recStartDate = parent.recurrenceStartDate;</span>
<a href="#l18.151"></a><span id="l18.151" class="difflineplus">+        if (recStartDate &amp;&amp; recStartDate.isDate &amp;&amp; !item.recurrenceId.isDate) {</span>
<a href="#l18.152"></a><span id="l18.152" class="difflineplus">+            // cs ought to return proper all-day RECURRENCE-ID!</span>
<a href="#l18.153"></a><span id="l18.153" class="difflineplus">+            // get into startDate's timezone before cutting:</span>
<a href="#l18.154"></a><span id="l18.154" class="difflineplus">+            let rid = item.recurrenceId.getInTimezone(recStartDate.timezone);</span>
<a href="#l18.155"></a><span id="l18.155" class="difflineplus">+            rid.isDate = true;</span>
<a href="#l18.156"></a><span id="l18.156" class="difflineplus">+            item.recurrenceId = rid;</span>
<a href="#l18.157"></a><span id="l18.157" class="difflineplus">+        }</span>
<a href="#l18.158"></a><span id="l18.158" class="difflineplus">+</span>
<a href="#l18.159"></a><span id="l18.159" class="difflineplus">+        parent.recurrenceInfo.modifyException(item, true);</span>
<a href="#l18.160"></a><span id="l18.160">     }</span>
<a href="#l18.161"></a><span id="l18.161"> </span>
<a href="#l18.162"></a><span id="l18.162">     if (itemFilter &amp; calICalendar.ITEM_FILTER_CLASS_OCCURRENCES) {</span>
<a href="#l18.163"></a><span id="l18.163" class="difflineminus">-        for each (var item in unexpandedItems) {</span>
<a href="#l18.164"></a><span id="l18.164" class="difflineplus">+        for each (let item in unexpandedItems) {</span>
<a href="#l18.165"></a><span id="l18.165">             if (maxResults != 0 &amp;&amp; items.length &gt;= maxResults) {</span>
<a href="#l18.166"></a><span id="l18.166">                 break;</span>
<a href="#l18.167"></a><span id="l18.167">             }</span>
<a href="#l18.168"></a><span id="l18.168"> </span>
<a href="#l18.169"></a><span id="l18.169" class="difflineminus">-            var recStartDate = item.recurrenceStartDate;</span>
<a href="#l18.170"></a><span id="l18.170" class="difflineplus">+            let recStartDate = item.recurrenceStartDate;</span>
<a href="#l18.171"></a><span id="l18.171">             if (recStartDate &amp;&amp; !recStartDate.isDate) {</span>
<a href="#l18.172"></a><span id="l18.172">                 recStartDate = null;</span>
<a href="#l18.173"></a><span id="l18.173">             }</span>
<a href="#l18.174"></a><span id="l18.174" class="difflineminus">-            var recItems = item.recurrenceInfo.getRecurrenceItems({});</span>
<a href="#l18.175"></a><span id="l18.175" class="difflineminus">-            for each (var recItem in recItems) {</span>
<a href="#l18.176"></a><span id="l18.176" class="difflineplus">+            let recItems = item.recurrenceInfo.getRecurrenceItems({});</span>
<a href="#l18.177"></a><span id="l18.177" class="difflineplus">+            for each (let recItem in recItems) {</span>
<a href="#l18.178"></a><span id="l18.178">                 // cs bug: workaround missing COUNT</span>
<a href="#l18.179"></a><span id="l18.179">                 if (calInstanceOf(recItem, Components.interfaces.calIRecurrenceRule)) {</span>
<a href="#l18.180"></a><span id="l18.180">                     if (!recItem.isFinite &amp;&amp; !recItem.isNegative) {</span>
<a href="#l18.181"></a><span id="l18.181">                         recItem.count = recurrenceBound;</span>
<a href="#l18.182"></a><span id="l18.182">                     }</span>
<a href="#l18.183"></a><span id="l18.183">                 } else if (recStartDate &amp;&amp;</span>
<a href="#l18.184"></a><span id="l18.184">                            calInstanceOf(recItem, Components.interfaces.calIRecurrenceDate)) {</span>
<a href="#l18.185"></a><span id="l18.185">                     // cs bug: always uses DATE-TIME even though the master item is all-day DATE:</span>
<a href="#l18.186"></a><span id="l18.186">                     //         get into startDate's timezone before cutting:</span>
<a href="#l18.187"></a><span id="l18.187" class="difflineminus">-                    var date = recItem.date.getInTimezone(recStartDate.timezone);</span>
<a href="#l18.188"></a><span id="l18.188" class="difflineplus">+                    let date = recItem.date.getInTimezone(recStartDate.timezone);</span>
<a href="#l18.189"></a><span id="l18.189">                     date.isDate = true;</span>
<a href="#l18.190"></a><span id="l18.190">                     recItem.date = date;</span>
<a href="#l18.191"></a><span id="l18.191">                 }</span>
<a href="#l18.192"></a><span id="l18.192">             }</span>
<a href="#l18.193"></a><span id="l18.193"> </span>
<a href="#l18.194"></a><span id="l18.194">             if (!bLeaveMutable) {</span>
<a href="#l18.195"></a><span id="l18.195">                 item.makeImmutable();</span>
<a href="#l18.196"></a><span id="l18.196">             }</span>
<a href="#l18.197"></a><span id="l18.197" class="difflineminus">-            var occurrences = item.recurrenceInfo.getOccurrences(rangeStart, rangeEnd,</span>
<a href="#l18.198"></a><span id="l18.198" class="difflineplus">+            let occurrences = item.recurrenceInfo.getOccurrences(rangeStart, rangeEnd,</span>
<a href="#l18.199"></a><span id="l18.199">                                                                  maxResults == 0 ? 0 : maxResults - items.length,</span>
<a href="#l18.200"></a><span id="l18.200">                                                                  {});</span>
<a href="#l18.201"></a><span id="l18.201">             if (LOG_LEVEL &gt; 1) {</span>
<a href="#l18.202"></a><span id="l18.202">                 log(&quot;item: &quot; + item.title + &quot; has &quot; + occurrences.length.toString() + &quot; occurrences.&quot;, this);</span>
<a href="#l18.203"></a><span id="l18.203">                 if (LOG_LEVEL &gt; 2) {</span>
<a href="#l18.204"></a><span id="l18.204">                     log(&quot;master item: &quot; + item.title + &quot;\n&quot; + item.icalString, this);</span>
<a href="#l18.205"></a><span id="l18.205" class="difflineminus">-                    for each (var occ in occurrences) {</span>
<a href="#l18.206"></a><span id="l18.206" class="difflineplus">+                    for each (let occ in occurrences) {</span>
<a href="#l18.207"></a><span id="l18.207">                         log(&quot;item: &quot; + occ.title + &quot;\n&quot; + occ.icalString, this);</span>
<a href="#l18.208"></a><span id="l18.208">                     }</span>
<a href="#l18.209"></a><span id="l18.209">                 }</span>
<a href="#l18.210"></a><span id="l18.210">             }</span>
<a href="#l18.211"></a><span id="l18.211">             // only proxies returned:</span>
<a href="#l18.212"></a><span id="l18.212">             items = items.concat(occurrences);</span>
<a href="#l18.213"></a><span id="l18.213">         }</span>
<a href="#l18.214"></a><span id="l18.214"> </span>
<a href="#l18.215"></a><span id="l18.215">     } else {</span>
<a href="#l18.216"></a><span id="l18.216">         if (maxResults != 0 &amp;&amp;</span>
<a href="#l18.217"></a><span id="l18.217">             (items.length + unexpandedItems.length) &gt; maxResults) {</span>
<a href="#l18.218"></a><span id="l18.218">             unexpandedItems.length = (maxResults - items.length);</span>
<a href="#l18.219"></a><span id="l18.219">         }</span>
<a href="#l18.220"></a><span id="l18.220">         if (!bLeaveMutable) {</span>
<a href="#l18.221"></a><span id="l18.221" class="difflineminus">-            for each (var item in unexpandedItems) {</span>
<a href="#l18.222"></a><span id="l18.222" class="difflineplus">+            for each (let item in unexpandedItems) {</span>
<a href="#l18.223"></a><span id="l18.223">                 item.makeImmutable();</span>
<a href="#l18.224"></a><span id="l18.224">             }</span>
<a href="#l18.225"></a><span id="l18.225">         }</span>
<a href="#l18.226"></a><span id="l18.226">         if (LOG_LEVEL &gt; 2) {</span>
<a href="#l18.227"></a><span id="l18.227" class="difflineminus">-            for each (var item in unexpandedItems) {</span>
<a href="#l18.228"></a><span id="l18.228" class="difflineplus">+            for each (let item in unexpandedItems) {</span>
<a href="#l18.229"></a><span id="l18.229">                 log(&quot;item: &quot; + item.title + &quot;\n&quot; + item.icalString, this);</span>
<a href="#l18.230"></a><span id="l18.230">             }</span>
<a href="#l18.231"></a><span id="l18.231">         }</span>
<a href="#l18.232"></a><span id="l18.232">         items = items.concat(unexpandedItems);</span>
<a href="#l18.233"></a><span id="l18.233">     }</span>
<a href="#l18.234"></a><span id="l18.234"> </span>
<a href="#l18.235"></a><span id="l18.235">     if (LOG_LEVEL &gt; 1) {</span>
<a href="#l18.236"></a><span id="l18.236">         log(&quot;parseItems(): returning &quot; + items.length + &quot; items&quot;, this);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/calendar/test/unit/test_alarm.js</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/calendar/test/unit/test_alarm.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -354,17 +354,17 @@ function test_clone() {</span>
<a href="#l19.4"></a><span id="l19.4">     do_check_true(newAlarm.isMutable);</span>
<a href="#l19.5"></a><span id="l19.5"> </span>
<a href="#l19.6"></a><span id="l19.6">     // Check if item is still the same</span>
<a href="#l19.7"></a><span id="l19.7">     // TODO This is not quite optimal, maybe someone can find a better way to do</span>
<a href="#l19.8"></a><span id="l19.8">     // the comparisons.</span>
<a href="#l19.9"></a><span id="l19.9">     for (var prop in propMap) {</span>
<a href="#l19.10"></a><span id="l19.10">         switch (prop) {</span>
<a href="#l19.11"></a><span id="l19.11">             case &quot;item&quot;:</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-                do_check_eq(alarm.item.getProperty(&quot;CREATED&quot;).icalString, newAlarm.item.getProperty(&quot;CREATED&quot;).icalString)</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+                do_check_eq(alarm.item.icalString, newAlarm.item.icalString)</span>
<a href="#l19.14"></a><span id="l19.14">                 break;</span>
<a href="#l19.15"></a><span id="l19.15">             case &quot;icalString&quot;:</span>
<a href="#l19.16"></a><span id="l19.16">             case &quot;icalComponent&quot;:</span>
<a href="#l19.17"></a><span id="l19.17">                 break;</span>
<a href="#l19.18"></a><span id="l19.18">             default:</span>
<a href="#l19.19"></a><span id="l19.19">                 if ((alarm[prop] instanceof Ci.nsISupports &amp;&amp; alarm[prop].icalString != newAlarm[prop].icalString) ||</span>
<a href="#l19.20"></a><span id="l19.20">                      !(alarm[prop] instanceof Ci.nsISupports) &amp;&amp; alarm[prop] != newAlarm[prop]) {</span>
<a href="#l19.21"></a><span id="l19.21">                     do_throw(prop + &quot; differs, &quot; + alarm[prop] + &quot; == &quot; + newAlarm[prop]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/calendar/test/unit/test_recur.js</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/calendar/test/unit/test_recur.js</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -278,19 +278,19 @@ function test_interface() {</span>
<a href="#l20.4"></a><span id="l20.4">     do_check_false(item.icalString.indexOf(EXDATE) &lt; 0);</span>
<a href="#l20.5"></a><span id="l20.5">     rinfo.restoreOccurrenceAt(occDate)</span>
<a href="#l20.6"></a><span id="l20.6">     do_check_true(item.icalString.indexOf(EXDATE) &lt; 0);</span>
<a href="#l20.7"></a><span id="l20.7"> </span>
<a href="#l20.8"></a><span id="l20.8">     // modifyException / getExceptionFor</span>
<a href="#l20.9"></a><span id="l20.9">     var occ =  rinfo.getOccurrenceFor(occDate);</span>
<a href="#l20.10"></a><span id="l20.10">     occ.startDate = createDate(2002,3,1,true,11,45,0);</span>
<a href="#l20.11"></a><span id="l20.11">     rinfo.modifyException(occ, true);</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-    do_check_true(rinfo.getExceptionFor(occDate, false) != null);</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineplus">+    do_check_true(rinfo.getExceptionFor(occDate) != null);</span>
<a href="#l20.14"></a><span id="l20.14"> </span>
<a href="#l20.15"></a><span id="l20.15">     // getExceptionIds</span>
<a href="#l20.16"></a><span id="l20.16">     var ids = rinfo.getExceptionIds({});</span>
<a href="#l20.17"></a><span id="l20.17">     do_check_eq(ids.length, 1);</span>
<a href="#l20.18"></a><span id="l20.18">     do_check_true(ids[0].compare(occDate) == 0);</span>
<a href="#l20.19"></a><span id="l20.19"> </span>
<a href="#l20.20"></a><span id="l20.20">     // removeExceptionFor</span>
<a href="#l20.21"></a><span id="l20.21">     rinfo.removeExceptionFor(occDate);</span>
<a href="#l20.22"></a><span id="l20.22" class="difflineminus">-    do_check_true(rinfo.getExceptionFor(occDate, false) == null);</span>
<a href="#l20.23"></a><span id="l20.23" class="difflineplus">+    do_check_true(rinfo.getExceptionFor(occDate) == null);</span>
<a href="#l20.24"></a><span id="l20.24"> }</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

