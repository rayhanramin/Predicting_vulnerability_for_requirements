<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 19316:3133a94f3a1bcdbc7e86945e668b4596ca7462d6</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 3133a94f3a1bcdbc7e86945e668b4596ca7462d6" />
<meta property="og:url" content="/comm-central/rev/3133a94f3a1bcdbc7e86945e668b4596ca7462d6" />
<meta property="og:description" content="Bug 684455 - Import from Becky! Internet Mail. r=mkato, rs=rkent" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 3133a94f3a1bcdbc7e86945e668b4596ca7462d6 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/3133a94f3a1bcdbc7e86945e668b4596ca7462d6">shortlog</a> |
<a href="/comm-central/log/3133a94f3a1bcdbc7e86945e668b4596ca7462d6">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/3133a94f3a1bcdbc7e86945e668b4596ca7462d6">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/3133a94f3a1bcdbc7e86945e668b4596ca7462d6">files</a> |
changeset |
<a href="/comm-central/raw-rev/3133a94f3a1bcdbc7e86945e668b4596ca7462d6">raw</a>  | <a href="/comm-central/archive/3133a94f3a1bcdbc7e86945e668b4596ca7462d6.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=684455">Bug 684455</a> - Import from Becky! Internet Mail. r=mkato, rs=rkent
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#72;&#105;&#114;&#111;&#121;&#117;&#107;&#105;&#32;&#73;&#107;&#101;&#122;&#111;&#101;&#32;&#60;&#104;&#105;&#105;&#107;&#101;&#122;&#111;&#101;&#64;&#109;&#111;&#122;&#105;&#108;&#108;&#97;&#45;&#106;&#97;&#112;&#97;&#110;&#46;&#111;&#114;&#103;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 19 Apr 2016 15:35:00 +0200</td></tr>

<tr>
 <td>changeset 19316</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/3133a94f3a1bcdbc7e86945e668b4596ca7462d6">3133a94f3a1bcdbc7e86945e668b4596ca7462d6</a></td>
</tr>



<tr>
<td>parent 19315</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/f1755f28374d980dc4cc053141459b3f6a09397e">f1755f28374d980dc4cc053141459b3f6a09397e</a>
</td>
</tr>

<tr>
<td>child 19317</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/5449a5ce585f8be3810c6a1f16fae19c73ffe3c3">5449a5ce585f8be3810c6a1f16fae19c73ffe3c3</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=3133a94f3a1bcdbc7e86945e668b4596ca7462d6">11876</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Fri, 13 May 2016 12:39:20 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@3133a94f3a1b [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=3133a94f3a1bcdbc7e86945e668b4596ca7462d6">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=3133a94f3a1bcdbc7e86945e668b4596ca7462d6&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=3133a94f3a1bcdbc7e86945e668b4596ca7462d6&newProject=comm-central&newRevision=f1755f28374d980dc4cc053141459b3f6a09397e&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=3133a94f3a1bcdbc7e86945e668b4596ca7462d6&newProject=comm-central&newRevision=f1755f28374d980dc4cc053141459b3f6a09397e&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=3133a94f3a1bcdbc7e86945e668b4596ca7462d6&newProject=comm-central&newRevision=f1755f28374d980dc4cc053141459b3f6a09397e&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mkato%29&revcount=50">mkato</a>, <a href="/comm-central/log?rev=reviewer%28rkent%29&revcount=50">rkent</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=684455">684455</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=684455">Bug 684455</a> - Import from Becky! Internet Mail. r=mkato, rs=rkent</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mail/locales/en-US/chrome/messenger/beckyImportMsgs.properties">mail/locales/en-US/chrome/messenger/beckyImportMsgs.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mail/locales/en-US/chrome/messenger/beckyImportMsgs.properties">file</a> |
<a href="/comm-central/annotate/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mail/locales/en-US/chrome/messenger/beckyImportMsgs.properties">annotate</a> |
<a href="/comm-central/diff/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mail/locales/en-US/chrome/messenger/beckyImportMsgs.properties">diff</a> |
<a href="/comm-central/comparison/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mail/locales/en-US/chrome/messenger/beckyImportMsgs.properties">comparison</a> |
<a href="/comm-central/log/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mail/locales/en-US/chrome/messenger/beckyImportMsgs.properties">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mail/locales/jar.mn">mail/locales/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mail/locales/jar.mn">file</a> |
<a href="/comm-central/annotate/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mail/locales/jar.mn">annotate</a> |
<a href="/comm-central/diff/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mail/locales/jar.mn">diff</a> |
<a href="/comm-central/comparison/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mail/locales/jar.mn">comparison</a> |
<a href="/comm-central/log/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mail/locales/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/moz.build">mailnews/import/becky/src/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/moz.build">file</a> |
<a href="/comm-central/annotate/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/moz.build">annotate</a> |
<a href="/comm-central/diff/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/moz.build">diff</a> |
<a href="/comm-central/comparison/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/moz.build">comparison</a> |
<a href="/comm-central/log/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/moz.build">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckyAddressBooks.cpp">mailnews/import/becky/src/nsBeckyAddressBooks.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckyAddressBooks.cpp">file</a> |
<a href="/comm-central/annotate/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckyAddressBooks.cpp">annotate</a> |
<a href="/comm-central/diff/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckyAddressBooks.cpp">diff</a> |
<a href="/comm-central/comparison/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckyAddressBooks.cpp">comparison</a> |
<a href="/comm-central/log/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckyAddressBooks.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckyAddressBooks.h">mailnews/import/becky/src/nsBeckyAddressBooks.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckyAddressBooks.h">file</a> |
<a href="/comm-central/annotate/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckyAddressBooks.h">annotate</a> |
<a href="/comm-central/diff/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckyAddressBooks.h">diff</a> |
<a href="/comm-central/comparison/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckyAddressBooks.h">comparison</a> |
<a href="/comm-central/log/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckyAddressBooks.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckyFilters.cpp">mailnews/import/becky/src/nsBeckyFilters.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckyFilters.cpp">file</a> |
<a href="/comm-central/annotate/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckyFilters.cpp">annotate</a> |
<a href="/comm-central/diff/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckyFilters.cpp">diff</a> |
<a href="/comm-central/comparison/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckyFilters.cpp">comparison</a> |
<a href="/comm-central/log/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckyFilters.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckyFilters.h">mailnews/import/becky/src/nsBeckyFilters.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckyFilters.h">file</a> |
<a href="/comm-central/annotate/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckyFilters.h">annotate</a> |
<a href="/comm-central/diff/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckyFilters.h">diff</a> |
<a href="/comm-central/comparison/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckyFilters.h">comparison</a> |
<a href="/comm-central/log/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckyFilters.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckyImport.cpp">mailnews/import/becky/src/nsBeckyImport.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckyImport.cpp">file</a> |
<a href="/comm-central/annotate/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckyImport.cpp">annotate</a> |
<a href="/comm-central/diff/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckyImport.cpp">diff</a> |
<a href="/comm-central/comparison/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckyImport.cpp">comparison</a> |
<a href="/comm-central/log/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckyImport.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckyImport.h">mailnews/import/becky/src/nsBeckyImport.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckyImport.h">file</a> |
<a href="/comm-central/annotate/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckyImport.h">annotate</a> |
<a href="/comm-central/diff/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckyImport.h">diff</a> |
<a href="/comm-central/comparison/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckyImport.h">comparison</a> |
<a href="/comm-central/log/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckyImport.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckyMail.cpp">mailnews/import/becky/src/nsBeckyMail.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckyMail.cpp">file</a> |
<a href="/comm-central/annotate/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckyMail.cpp">annotate</a> |
<a href="/comm-central/diff/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckyMail.cpp">diff</a> |
<a href="/comm-central/comparison/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckyMail.cpp">comparison</a> |
<a href="/comm-central/log/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckyMail.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckyMail.h">mailnews/import/becky/src/nsBeckyMail.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckyMail.h">file</a> |
<a href="/comm-central/annotate/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckyMail.h">annotate</a> |
<a href="/comm-central/diff/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckyMail.h">diff</a> |
<a href="/comm-central/comparison/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckyMail.h">comparison</a> |
<a href="/comm-central/log/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckyMail.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckySettings.cpp">mailnews/import/becky/src/nsBeckySettings.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckySettings.cpp">file</a> |
<a href="/comm-central/annotate/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckySettings.cpp">annotate</a> |
<a href="/comm-central/diff/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckySettings.cpp">diff</a> |
<a href="/comm-central/comparison/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckySettings.cpp">comparison</a> |
<a href="/comm-central/log/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckySettings.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckySettings.h">mailnews/import/becky/src/nsBeckySettings.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckySettings.h">file</a> |
<a href="/comm-central/annotate/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckySettings.h">annotate</a> |
<a href="/comm-central/diff/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckySettings.h">diff</a> |
<a href="/comm-central/comparison/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckySettings.h">comparison</a> |
<a href="/comm-central/log/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckySettings.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckyStringBundle.cpp">mailnews/import/becky/src/nsBeckyStringBundle.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckyStringBundle.cpp">file</a> |
<a href="/comm-central/annotate/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckyStringBundle.cpp">annotate</a> |
<a href="/comm-central/diff/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckyStringBundle.cpp">diff</a> |
<a href="/comm-central/comparison/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckyStringBundle.cpp">comparison</a> |
<a href="/comm-central/log/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckyStringBundle.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckyStringBundle.h">mailnews/import/becky/src/nsBeckyStringBundle.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckyStringBundle.h">file</a> |
<a href="/comm-central/annotate/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckyStringBundle.h">annotate</a> |
<a href="/comm-central/diff/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckyStringBundle.h">diff</a> |
<a href="/comm-central/comparison/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckyStringBundle.h">comparison</a> |
<a href="/comm-central/log/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckyStringBundle.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckyUtils.cpp">mailnews/import/becky/src/nsBeckyUtils.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckyUtils.cpp">file</a> |
<a href="/comm-central/annotate/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckyUtils.cpp">annotate</a> |
<a href="/comm-central/diff/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckyUtils.cpp">diff</a> |
<a href="/comm-central/comparison/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckyUtils.cpp">comparison</a> |
<a href="/comm-central/log/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckyUtils.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckyUtils.h">mailnews/import/becky/src/nsBeckyUtils.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckyUtils.h">file</a> |
<a href="/comm-central/annotate/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckyUtils.h">annotate</a> |
<a href="/comm-central/diff/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckyUtils.h">diff</a> |
<a href="/comm-central/comparison/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckyUtils.h">comparison</a> |
<a href="/comm-central/log/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/becky/src/nsBeckyUtils.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/build/moz.build">mailnews/import/build/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/build/moz.build">file</a> |
<a href="/comm-central/annotate/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/build/moz.build">annotate</a> |
<a href="/comm-central/diff/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/build/moz.build">diff</a> |
<a href="/comm-central/comparison/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/build/moz.build">comparison</a> |
<a href="/comm-central/log/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/build/moz.build">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/build/nsImportModule.cpp">mailnews/import/build/nsImportModule.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/build/nsImportModule.cpp">file</a> |
<a href="/comm-central/annotate/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/build/nsImportModule.cpp">annotate</a> |
<a href="/comm-central/diff/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/build/nsImportModule.cpp">diff</a> |
<a href="/comm-central/comparison/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/build/nsImportModule.cpp">comparison</a> |
<a href="/comm-central/log/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/build/nsImportModule.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/vcard/src/moz.build">mailnews/import/vcard/src/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/vcard/src/moz.build">file</a> |
<a href="/comm-central/annotate/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/vcard/src/moz.build">annotate</a> |
<a href="/comm-central/diff/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/vcard/src/moz.build">diff</a> |
<a href="/comm-central/comparison/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/vcard/src/moz.build">comparison</a> |
<a href="/comm-central/log/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/import/vcard/src/moz.build">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/moz.build">mailnews/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/moz.build">file</a> |
<a href="/comm-central/annotate/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/moz.build">annotate</a> |
<a href="/comm-central/diff/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/moz.build">diff</a> |
<a href="/comm-central/comparison/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/moz.build">comparison</a> |
<a href="/comm-central/log/3133a94f3a1bcdbc7e86945e668b4596ca7462d6/mailnews/moz.build">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1">new file mode 100644</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineminus">--- /dev/null</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/beckyImportMsgs.properties</span>
<a href="#l1.4"></a><span id="l1.4" class="difflineat">@@ -0,0 +1,19 @@</span>
<a href="#l1.5"></a><span id="l1.5" class="difflineplus">+# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l1.6"></a><span id="l1.6" class="difflineplus">+# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l1.7"></a><span id="l1.7" class="difflineplus">+# file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l1.8"></a><span id="l1.8" class="difflineplus">+#</span>
<a href="#l1.9"></a><span id="l1.9" class="difflineplus">+# The following are used by the becky import code to display status/error</span>
<a href="#l1.10"></a><span id="l1.10" class="difflineplus">+# and informational messages</span>
<a href="#l1.11"></a><span id="l1.11" class="difflineplus">+</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+# Short name of import module</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+BeckyImportName=Becky! Internet Mail</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+# Description of import module</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+BeckyImportDescription=Import Local Mail from Becky! Internet Mail</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+# Success Message</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+# LOCALIZATION NOTE : Do not translate the word &quot;%S&quot; below.</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+# The variable %S will contain the name of the Mailbox</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+BeckyImportMailboxSuccess=Local messages were successfully imported from %S.</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineplus">+</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineplus">+BeckyImportAddressSuccess=Address book imported</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/locales/jar.mn</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/locales/jar.mn</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -100,16 +100,17 @@</span>
<a href="#l2.4"></a><span id="l2.4">   locale/@AB_CD@/messenger/importDialog.dtd                             (%chrome/messenger/importDialog.dtd)</span>
<a href="#l2.5"></a><span id="l2.5">   locale/@AB_CD@/messenger/fieldMapImport.dtd                           (%chrome/messenger/fieldMapImport.dtd)</span>
<a href="#l2.6"></a><span id="l2.6">   locale/@AB_CD@/messenger/textImportMsgs.properties                    (%chrome/messenger/textImportMsgs.properties)</span>
<a href="#l2.7"></a><span id="l2.7">   locale/@AB_CD@/messenger/vCardImportMsgs.properties                   (%chrome/messenger/vCardImportMsgs.properties)</span>
<a href="#l2.8"></a><span id="l2.8">   locale/@AB_CD@/messenger/appleMailImportMsgs.properties               (%chrome/messenger/appleMailImportMsgs.properties)</span>
<a href="#l2.9"></a><span id="l2.9">   locale/@AB_CD@/messenger/oeImportMsgs.properties                      (%chrome/messenger/oeImportMsgs.properties)</span>
<a href="#l2.10"></a><span id="l2.10">   locale/@AB_CD@/messenger/wmImportMsgs.properties                      (%chrome/messenger/wmImportMsgs.properties)</span>
<a href="#l2.11"></a><span id="l2.11">   locale/@AB_CD@/messenger/outlookImportMsgs.properties                 (%chrome/messenger/outlookImportMsgs.properties)</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+  locale/@AB_CD@/messenger/beckyImportMsgs.properties                   (%chrome/messenger/beckyImportMsgs.properties)</span>
<a href="#l2.13"></a><span id="l2.13">   locale/@AB_CD@/messenger/shutdownWindow.properties                    (%chrome/messenger/shutdownWindow.properties)</span>
<a href="#l2.14"></a><span id="l2.14">   locale/@AB_CD@/messenger/configEditorOverlay.dtd                      (%chrome/messenger/configEditorOverlay.dtd)</span>
<a href="#l2.15"></a><span id="l2.15">   locale/@AB_CD@/messenger/gloda.properties                             (%chrome/messenger/gloda.properties)</span>
<a href="#l2.16"></a><span id="l2.16">   locale/@AB_CD@/messenger/glodaComplete.properties                     (%chrome/messenger/glodaComplete.properties)</span>
<a href="#l2.17"></a><span id="l2.17">   locale/@AB_CD@/messenger/templateUtils.properties                     (%chrome/messenger/templateUtils.properties)</span>
<a href="#l2.18"></a><span id="l2.18">   locale/@AB_CD@/messenger/glodaFacetView.properties                    (%chrome/messenger/glodaFacetView.properties)</span>
<a href="#l2.19"></a><span id="l2.19">   locale/@AB_CD@/messenger/glodaFacetView.dtd                           (%chrome/messenger/glodaFacetView.dtd)</span>
<a href="#l2.20"></a><span id="l2.20">   locale/@AB_CD@/messenger/quickFilterBar.dtd                           (%chrome/messenger/quickFilterBar.dtd)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1">new file mode 100644</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineminus">--- /dev/null</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineplus">+++ b/mailnews/import/becky/src/moz.build</span>
<a href="#l3.4"></a><span id="l3.4" class="difflineat">@@ -0,0 +1,16 @@</span>
<a href="#l3.5"></a><span id="l3.5" class="difflineplus">+# vim: set filetype=python:</span>
<a href="#l3.6"></a><span id="l3.6" class="difflineplus">+# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l3.7"></a><span id="l3.7" class="difflineplus">+# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l3.8"></a><span id="l3.8" class="difflineplus">+# file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l3.9"></a><span id="l3.9" class="difflineplus">+</span>
<a href="#l3.10"></a><span id="l3.10" class="difflineplus">+UNIFIED_SOURCES += [</span>
<a href="#l3.11"></a><span id="l3.11" class="difflineplus">+    'nsBeckyAddressBooks.cpp',</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+    'nsBeckyFilters.cpp',</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+    'nsBeckyImport.cpp',</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+    'nsBeckyMail.cpp',</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+    'nsBeckySettings.cpp',</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+    'nsBeckyStringBundle.cpp',</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+    'nsBeckyUtils.cpp',</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+]</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+FINAL_LIBRARY = 'import'</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1">new file mode 100644</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineminus">--- /dev/null</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineplus">+++ b/mailnews/import/becky/src/nsBeckyAddressBooks.cpp</span>
<a href="#l4.4"></a><span id="l4.4" class="difflineat">@@ -0,0 +1,364 @@</span>
<a href="#l4.5"></a><span id="l4.5" class="difflineplus">+/* vim: set ts=2 et sw=2 tw=80: */</span>
<a href="#l4.6"></a><span id="l4.6" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l4.7"></a><span id="l4.7" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l4.8"></a><span id="l4.8" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l4.9"></a><span id="l4.9" class="difflineplus">+</span>
<a href="#l4.10"></a><span id="l4.10" class="difflineplus">+#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l4.11"></a><span id="l4.11" class="difflineplus">+#include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+#include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+#include &quot;nsIFile.h&quot;</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+#include &quot;nsISimpleEnumerator.h&quot;</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+#include &quot;nsIDirectoryEnumerator.h&quot;</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+#include &quot;nsIMutableArray.h&quot;</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+#include &quot;nsStringGlue.h&quot;</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+#include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+#include &quot;nsIAbManager.h&quot;</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+#include &quot;nsIImportService.h&quot;</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+#include &quot;nsIImportABDescriptor.h&quot;</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+#include &quot;nsMsgUtils.h&quot;</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+#include &quot;nsIStringBundle.h&quot;</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineplus">+#include &quot;nsVCardAddress.h&quot;</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineplus">+</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineplus">+#include &quot;nsBeckyAddressBooks.h&quot;</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineplus">+#include &quot;nsBeckyStringBundle.h&quot;</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+#include &quot;nsBeckyUtils.h&quot;</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineplus">+</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineplus">+NS_IMPL_ISUPPORTS(nsBeckyAddressBooks, nsIImportAddressBooks)</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+nsresult</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+nsBeckyAddressBooks::Create(nsIImportAddressBooks **aImport)</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+{</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aImport);</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+  *aImport = new nsBeckyAddressBooks();</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+  NS_ADDREF(*aImport);</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+  return NS_OK;</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+}</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineplus">+nsBeckyAddressBooks::nsBeckyAddressBooks()</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+: mReadBytes(0)</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+{</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineplus">+}</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineplus">+</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineplus">+nsBeckyAddressBooks::~nsBeckyAddressBooks()</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineplus">+{</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineplus">+}</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineplus">+</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineplus">+nsBeckyAddressBooks::GetSupportsMultiple(bool *_retval)</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineplus">+{</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineplus">+  NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineplus">+  *_retval = false;</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineplus">+  return NS_OK;</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineplus">+}</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineplus">+</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineplus">+nsBeckyAddressBooks::GetAutoFind(char16_t **aDescription,</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineplus">+                                 bool *_retval)</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineplus">+{</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aDescription);</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineplus">+  NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineplus">+</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineplus">+  *aDescription =</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineplus">+    nsBeckyStringBundle::GetStringByName(MOZ_UTF16(&quot;BeckyImportDescription&quot;));</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineplus">+  *_retval = false;</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineplus">+</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineplus">+  return NS_OK;</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineplus">+}</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineplus">+</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineplus">+nsBeckyAddressBooks::GetNeedsFieldMap(nsIFile *aLocation, bool *_retval)</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineplus">+{</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineplus">+  *_retval = false;</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineplus">+  return NS_OK;</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineplus">+}</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineplus">+</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineplus">+nsresult</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineplus">+nsBeckyAddressBooks::FindAddressBookDirectory(nsIFile **aAddressBookDirectory)</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineplus">+{</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; userDirectory;</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineplus">+  nsresult rv = nsBeckyUtils::FindUserDirectory(getter_AddRefs(userDirectory));</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineplus">+</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineplus">+  rv = userDirectory-&gt;Append(NS_LITERAL_STRING(&quot;AddrBook&quot;));</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineplus">+</span>
<a href="#l4.91"></a><span id="l4.91" class="difflineplus">+  bool exists;</span>
<a href="#l4.92"></a><span id="l4.92" class="difflineplus">+  rv = userDirectory-&gt;Exists(&amp;exists);</span>
<a href="#l4.93"></a><span id="l4.93" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.94"></a><span id="l4.94" class="difflineplus">+  if (!exists)</span>
<a href="#l4.95"></a><span id="l4.95" class="difflineplus">+    return NS_ERROR_FILE_NOT_FOUND;</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineplus">+</span>
<a href="#l4.97"></a><span id="l4.97" class="difflineplus">+  userDirectory.forget(aAddressBookDirectory);</span>
<a href="#l4.98"></a><span id="l4.98" class="difflineplus">+  return NS_OK;</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineplus">+}</span>
<a href="#l4.100"></a><span id="l4.100" class="difflineplus">+</span>
<a href="#l4.101"></a><span id="l4.101" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineplus">+nsBeckyAddressBooks::GetDefaultLocation(nsIFile **aLocation,</span>
<a href="#l4.103"></a><span id="l4.103" class="difflineplus">+                                        bool *aFound,</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineplus">+                                        bool *aUserVerify)</span>
<a href="#l4.105"></a><span id="l4.105" class="difflineplus">+{</span>
<a href="#l4.106"></a><span id="l4.106" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aFound);</span>
<a href="#l4.107"></a><span id="l4.107" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aLocation);</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aUserVerify);</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineplus">+</span>
<a href="#l4.110"></a><span id="l4.110" class="difflineplus">+  *aLocation = nullptr;</span>
<a href="#l4.111"></a><span id="l4.111" class="difflineplus">+  *aFound = false;</span>
<a href="#l4.112"></a><span id="l4.112" class="difflineplus">+  *aUserVerify = true;</span>
<a href="#l4.113"></a><span id="l4.113" class="difflineplus">+</span>
<a href="#l4.114"></a><span id="l4.114" class="difflineplus">+  if (NS_SUCCEEDED(nsBeckyAddressBooks::FindAddressBookDirectory(aLocation))) {</span>
<a href="#l4.115"></a><span id="l4.115" class="difflineplus">+    *aFound = true;</span>
<a href="#l4.116"></a><span id="l4.116" class="difflineplus">+    *aUserVerify = false;</span>
<a href="#l4.117"></a><span id="l4.117" class="difflineplus">+  }</span>
<a href="#l4.118"></a><span id="l4.118" class="difflineplus">+</span>
<a href="#l4.119"></a><span id="l4.119" class="difflineplus">+  return NS_OK;</span>
<a href="#l4.120"></a><span id="l4.120" class="difflineplus">+}</span>
<a href="#l4.121"></a><span id="l4.121" class="difflineplus">+</span>
<a href="#l4.122"></a><span id="l4.122" class="difflineplus">+nsresult</span>
<a href="#l4.123"></a><span id="l4.123" class="difflineplus">+nsBeckyAddressBooks::CreateAddressBookDescriptor(nsIImportABDescriptor **aDescriptor)</span>
<a href="#l4.124"></a><span id="l4.124" class="difflineplus">+{</span>
<a href="#l4.125"></a><span id="l4.125" class="difflineplus">+  nsresult rv;</span>
<a href="#l4.126"></a><span id="l4.126" class="difflineplus">+  nsCOMPtr&lt;nsIImportService&gt; importService = do_GetService(NS_IMPORTSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l4.127"></a><span id="l4.127" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.128"></a><span id="l4.128" class="difflineplus">+</span>
<a href="#l4.129"></a><span id="l4.129" class="difflineplus">+  return importService-&gt;CreateNewABDescriptor(aDescriptor);</span>
<a href="#l4.130"></a><span id="l4.130" class="difflineplus">+}</span>
<a href="#l4.131"></a><span id="l4.131" class="difflineplus">+</span>
<a href="#l4.132"></a><span id="l4.132" class="difflineplus">+bool</span>
<a href="#l4.133"></a><span id="l4.133" class="difflineplus">+nsBeckyAddressBooks::IsAddressBookFile(nsIFile *aFile)</span>
<a href="#l4.134"></a><span id="l4.134" class="difflineplus">+{</span>
<a href="#l4.135"></a><span id="l4.135" class="difflineplus">+  nsresult rv;</span>
<a href="#l4.136"></a><span id="l4.136" class="difflineplus">+  bool isDirectory = false;</span>
<a href="#l4.137"></a><span id="l4.137" class="difflineplus">+  rv = aFile-&gt;IsDirectory(&amp;isDirectory);</span>
<a href="#l4.138"></a><span id="l4.138" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; isDirectory)</span>
<a href="#l4.139"></a><span id="l4.139" class="difflineplus">+    return false;</span>
<a href="#l4.140"></a><span id="l4.140" class="difflineplus">+</span>
<a href="#l4.141"></a><span id="l4.141" class="difflineplus">+  nsAutoString name;</span>
<a href="#l4.142"></a><span id="l4.142" class="difflineplus">+  rv = aFile-&gt;GetLeafName(name);</span>
<a href="#l4.143"></a><span id="l4.143" class="difflineplus">+  return StringEndsWith(name, NS_LITERAL_STRING(&quot;.bab&quot;));</span>
<a href="#l4.144"></a><span id="l4.144" class="difflineplus">+}</span>
<a href="#l4.145"></a><span id="l4.145" class="difflineplus">+</span>
<a href="#l4.146"></a><span id="l4.146" class="difflineplus">+bool</span>
<a href="#l4.147"></a><span id="l4.147" class="difflineplus">+nsBeckyAddressBooks::HasAddressBookFile(nsIFile *aDirectory)</span>
<a href="#l4.148"></a><span id="l4.148" class="difflineplus">+{</span>
<a href="#l4.149"></a><span id="l4.149" class="difflineplus">+  nsresult rv;</span>
<a href="#l4.150"></a><span id="l4.150" class="difflineplus">+  bool isDirectory = false;</span>
<a href="#l4.151"></a><span id="l4.151" class="difflineplus">+  rv = aDirectory-&gt;IsDirectory(&amp;isDirectory);</span>
<a href="#l4.152"></a><span id="l4.152" class="difflineplus">+  if (NS_FAILED(rv) || !isDirectory)</span>
<a href="#l4.153"></a><span id="l4.153" class="difflineplus">+    return false;</span>
<a href="#l4.154"></a><span id="l4.154" class="difflineplus">+</span>
<a href="#l4.155"></a><span id="l4.155" class="difflineplus">+  nsCOMPtr&lt;nsISimpleEnumerator&gt; entries;</span>
<a href="#l4.156"></a><span id="l4.156" class="difflineplus">+  rv = aDirectory-&gt;GetDirectoryEntries(getter_AddRefs(entries));</span>
<a href="#l4.157"></a><span id="l4.157" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l4.158"></a><span id="l4.158" class="difflineplus">+</span>
<a href="#l4.159"></a><span id="l4.159" class="difflineplus">+  bool more;</span>
<a href="#l4.160"></a><span id="l4.160" class="difflineplus">+  nsCOMPtr&lt;nsISupports&gt; entry;</span>
<a href="#l4.161"></a><span id="l4.161" class="difflineplus">+  while (NS_SUCCEEDED(entries-&gt;HasMoreElements(&amp;more)) &amp;&amp; more) {</span>
<a href="#l4.162"></a><span id="l4.162" class="difflineplus">+    rv = entries-&gt;GetNext(getter_AddRefs(entry));</span>
<a href="#l4.163"></a><span id="l4.163" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l4.164"></a><span id="l4.164" class="difflineplus">+</span>
<a href="#l4.165"></a><span id="l4.165" class="difflineplus">+    nsCOMPtr&lt;nsIFile&gt; file = do_QueryInterface(entry, &amp;rv);</span>
<a href="#l4.166"></a><span id="l4.166" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l4.167"></a><span id="l4.167" class="difflineplus">+    if (IsAddressBookFile(file))</span>
<a href="#l4.168"></a><span id="l4.168" class="difflineplus">+      return true;</span>
<a href="#l4.169"></a><span id="l4.169" class="difflineplus">+  }</span>
<a href="#l4.170"></a><span id="l4.170" class="difflineplus">+</span>
<a href="#l4.171"></a><span id="l4.171" class="difflineplus">+  return false;</span>
<a href="#l4.172"></a><span id="l4.172" class="difflineplus">+}</span>
<a href="#l4.173"></a><span id="l4.173" class="difflineplus">+</span>
<a href="#l4.174"></a><span id="l4.174" class="difflineplus">+uint32_t</span>
<a href="#l4.175"></a><span id="l4.175" class="difflineplus">+nsBeckyAddressBooks::CountAddressBookSize(nsIFile *aDirectory)</span>
<a href="#l4.176"></a><span id="l4.176" class="difflineplus">+{</span>
<a href="#l4.177"></a><span id="l4.177" class="difflineplus">+  nsresult rv;</span>
<a href="#l4.178"></a><span id="l4.178" class="difflineplus">+  bool isDirectory = false;</span>
<a href="#l4.179"></a><span id="l4.179" class="difflineplus">+  rv = aDirectory-&gt;IsDirectory(&amp;isDirectory);</span>
<a href="#l4.180"></a><span id="l4.180" class="difflineplus">+  if (NS_FAILED(rv) || !isDirectory)</span>
<a href="#l4.181"></a><span id="l4.181" class="difflineplus">+    return 0;</span>
<a href="#l4.182"></a><span id="l4.182" class="difflineplus">+</span>
<a href="#l4.183"></a><span id="l4.183" class="difflineplus">+  nsCOMPtr&lt;nsISimpleEnumerator&gt; entries;</span>
<a href="#l4.184"></a><span id="l4.184" class="difflineplus">+  rv = aDirectory-&gt;GetDirectoryEntries(getter_AddRefs(entries));</span>
<a href="#l4.185"></a><span id="l4.185" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, 0);</span>
<a href="#l4.186"></a><span id="l4.186" class="difflineplus">+</span>
<a href="#l4.187"></a><span id="l4.187" class="difflineplus">+  uint32_t total = 0;</span>
<a href="#l4.188"></a><span id="l4.188" class="difflineplus">+  bool more;</span>
<a href="#l4.189"></a><span id="l4.189" class="difflineplus">+  nsCOMPtr&lt;nsISupports&gt; entry;</span>
<a href="#l4.190"></a><span id="l4.190" class="difflineplus">+  while (NS_SUCCEEDED(entries-&gt;HasMoreElements(&amp;more)) &amp;&amp; more) {</span>
<a href="#l4.191"></a><span id="l4.191" class="difflineplus">+    rv = entries-&gt;GetNext(getter_AddRefs(entry));</span>
<a href="#l4.192"></a><span id="l4.192" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, 0);</span>
<a href="#l4.193"></a><span id="l4.193" class="difflineplus">+</span>
<a href="#l4.194"></a><span id="l4.194" class="difflineplus">+    nsCOMPtr&lt;nsIFile&gt; file = do_QueryInterface(entry, &amp;rv);</span>
<a href="#l4.195"></a><span id="l4.195" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, 0);</span>
<a href="#l4.196"></a><span id="l4.196" class="difflineplus">+</span>
<a href="#l4.197"></a><span id="l4.197" class="difflineplus">+    int64_t size;</span>
<a href="#l4.198"></a><span id="l4.198" class="difflineplus">+    file-&gt;GetFileSize(&amp;size);</span>
<a href="#l4.199"></a><span id="l4.199" class="difflineplus">+    if (total + size &gt; std::numeric_limits&lt;uint32_t&gt;::max())</span>
<a href="#l4.200"></a><span id="l4.200" class="difflineplus">+      return std::numeric_limits&lt;uint32_t&gt;::max();</span>
<a href="#l4.201"></a><span id="l4.201" class="difflineplus">+</span>
<a href="#l4.202"></a><span id="l4.202" class="difflineplus">+    total += static_cast&lt;uint32_t&gt;(size);</span>
<a href="#l4.203"></a><span id="l4.203" class="difflineplus">+  }</span>
<a href="#l4.204"></a><span id="l4.204" class="difflineplus">+</span>
<a href="#l4.205"></a><span id="l4.205" class="difflineplus">+  return total;</span>
<a href="#l4.206"></a><span id="l4.206" class="difflineplus">+}</span>
<a href="#l4.207"></a><span id="l4.207" class="difflineplus">+</span>
<a href="#l4.208"></a><span id="l4.208" class="difflineplus">+nsresult</span>
<a href="#l4.209"></a><span id="l4.209" class="difflineplus">+nsBeckyAddressBooks::AppendAddressBookDescriptor(nsIFile *aEntry,</span>
<a href="#l4.210"></a><span id="l4.210" class="difflineplus">+                                                 nsIMutableArray *aCollected)</span>
<a href="#l4.211"></a><span id="l4.211" class="difflineplus">+{</span>
<a href="#l4.212"></a><span id="l4.212" class="difflineplus">+  if (!HasAddressBookFile(aEntry))</span>
<a href="#l4.213"></a><span id="l4.213" class="difflineplus">+    return NS_OK;</span>
<a href="#l4.214"></a><span id="l4.214" class="difflineplus">+</span>
<a href="#l4.215"></a><span id="l4.215" class="difflineplus">+  nsresult rv;</span>
<a href="#l4.216"></a><span id="l4.216" class="difflineplus">+  nsCOMPtr&lt;nsIImportABDescriptor&gt; descriptor;</span>
<a href="#l4.217"></a><span id="l4.217" class="difflineplus">+  rv = CreateAddressBookDescriptor(getter_AddRefs(descriptor));</span>
<a href="#l4.218"></a><span id="l4.218" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.219"></a><span id="l4.219" class="difflineplus">+</span>
<a href="#l4.220"></a><span id="l4.220" class="difflineplus">+  uint32_t size = CountAddressBookSize(aEntry);</span>
<a href="#l4.221"></a><span id="l4.221" class="difflineplus">+  descriptor-&gt;SetSize(size);</span>
<a href="#l4.222"></a><span id="l4.222" class="difflineplus">+  descriptor-&gt;SetAbFile(aEntry);</span>
<a href="#l4.223"></a><span id="l4.223" class="difflineplus">+</span>
<a href="#l4.224"></a><span id="l4.224" class="difflineplus">+  nsAutoString name;</span>
<a href="#l4.225"></a><span id="l4.225" class="difflineplus">+  aEntry-&gt;GetLeafName(name);</span>
<a href="#l4.226"></a><span id="l4.226" class="difflineplus">+  descriptor-&gt;SetPreferredName(name);</span>
<a href="#l4.227"></a><span id="l4.227" class="difflineplus">+</span>
<a href="#l4.228"></a><span id="l4.228" class="difflineplus">+  return aCollected-&gt;AppendElement(descriptor, false);</span>
<a href="#l4.229"></a><span id="l4.229" class="difflineplus">+}</span>
<a href="#l4.230"></a><span id="l4.230" class="difflineplus">+</span>
<a href="#l4.231"></a><span id="l4.231" class="difflineplus">+nsresult</span>
<a href="#l4.232"></a><span id="l4.232" class="difflineplus">+nsBeckyAddressBooks::CollectAddressBooks(nsIFile *aTarget,</span>
<a href="#l4.233"></a><span id="l4.233" class="difflineplus">+                                         nsIMutableArray *aCollected)</span>
<a href="#l4.234"></a><span id="l4.234" class="difflineplus">+{</span>
<a href="#l4.235"></a><span id="l4.235" class="difflineplus">+  nsresult rv = AppendAddressBookDescriptor(aTarget, aCollected);</span>
<a href="#l4.236"></a><span id="l4.236" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.237"></a><span id="l4.237" class="difflineplus">+</span>
<a href="#l4.238"></a><span id="l4.238" class="difflineplus">+  nsCOMPtr&lt;nsISimpleEnumerator&gt; entries;</span>
<a href="#l4.239"></a><span id="l4.239" class="difflineplus">+  rv = aTarget-&gt;GetDirectoryEntries(getter_AddRefs(entries));</span>
<a href="#l4.240"></a><span id="l4.240" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.241"></a><span id="l4.241" class="difflineplus">+</span>
<a href="#l4.242"></a><span id="l4.242" class="difflineplus">+  bool more;</span>
<a href="#l4.243"></a><span id="l4.243" class="difflineplus">+  nsCOMPtr&lt;nsISupports&gt; entry;</span>
<a href="#l4.244"></a><span id="l4.244" class="difflineplus">+  while (NS_SUCCEEDED(entries-&gt;HasMoreElements(&amp;more)) &amp;&amp; more) {</span>
<a href="#l4.245"></a><span id="l4.245" class="difflineplus">+    rv = entries-&gt;GetNext(getter_AddRefs(entry));</span>
<a href="#l4.246"></a><span id="l4.246" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.247"></a><span id="l4.247" class="difflineplus">+</span>
<a href="#l4.248"></a><span id="l4.248" class="difflineplus">+    nsCOMPtr&lt;nsIFile&gt; file = do_QueryInterface(entry, &amp;rv);</span>
<a href="#l4.249"></a><span id="l4.249" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.250"></a><span id="l4.250" class="difflineplus">+</span>
<a href="#l4.251"></a><span id="l4.251" class="difflineplus">+    bool isDirectory = false;</span>
<a href="#l4.252"></a><span id="l4.252" class="difflineplus">+    rv = file-&gt;IsDirectory(&amp;isDirectory);</span>
<a href="#l4.253"></a><span id="l4.253" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; isDirectory)</span>
<a href="#l4.254"></a><span id="l4.254" class="difflineplus">+      rv = CollectAddressBooks(file, aCollected);</span>
<a href="#l4.255"></a><span id="l4.255" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.256"></a><span id="l4.256" class="difflineplus">+  }</span>
<a href="#l4.257"></a><span id="l4.257" class="difflineplus">+</span>
<a href="#l4.258"></a><span id="l4.258" class="difflineplus">+  return NS_OK;</span>
<a href="#l4.259"></a><span id="l4.259" class="difflineplus">+}</span>
<a href="#l4.260"></a><span id="l4.260" class="difflineplus">+</span>
<a href="#l4.261"></a><span id="l4.261" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l4.262"></a><span id="l4.262" class="difflineplus">+nsBeckyAddressBooks::FindAddressBooks(nsIFile *aLocation,</span>
<a href="#l4.263"></a><span id="l4.263" class="difflineplus">+                                      nsIArray **_retval)</span>
<a href="#l4.264"></a><span id="l4.264" class="difflineplus">+{</span>
<a href="#l4.265"></a><span id="l4.265" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aLocation);</span>
<a href="#l4.266"></a><span id="l4.266" class="difflineplus">+  NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l4.267"></a><span id="l4.267" class="difflineplus">+</span>
<a href="#l4.268"></a><span id="l4.268" class="difflineplus">+  nsresult rv;</span>
<a href="#l4.269"></a><span id="l4.269" class="difflineplus">+  nsCOMPtr&lt;nsIMutableArray&gt; array(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l4.270"></a><span id="l4.270" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.271"></a><span id="l4.271" class="difflineplus">+</span>
<a href="#l4.272"></a><span id="l4.272" class="difflineplus">+  bool isDirectory = false;</span>
<a href="#l4.273"></a><span id="l4.273" class="difflineplus">+  rv = aLocation-&gt;IsDirectory(&amp;isDirectory);</span>
<a href="#l4.274"></a><span id="l4.274" class="difflineplus">+  if (NS_FAILED(rv) || !isDirectory)</span>
<a href="#l4.275"></a><span id="l4.275" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l4.276"></a><span id="l4.276" class="difflineplus">+</span>
<a href="#l4.277"></a><span id="l4.277" class="difflineplus">+  rv = CollectAddressBooks(aLocation, array);</span>
<a href="#l4.278"></a><span id="l4.278" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.279"></a><span id="l4.279" class="difflineplus">+</span>
<a href="#l4.280"></a><span id="l4.280" class="difflineplus">+  array.forget(_retval);</span>
<a href="#l4.281"></a><span id="l4.281" class="difflineplus">+</span>
<a href="#l4.282"></a><span id="l4.282" class="difflineplus">+  return NS_OK;</span>
<a href="#l4.283"></a><span id="l4.283" class="difflineplus">+}</span>
<a href="#l4.284"></a><span id="l4.284" class="difflineplus">+</span>
<a href="#l4.285"></a><span id="l4.285" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l4.286"></a><span id="l4.286" class="difflineplus">+nsBeckyAddressBooks::InitFieldMap(nsIImportFieldMap *aFieldMap)</span>
<a href="#l4.287"></a><span id="l4.287" class="difflineplus">+{</span>
<a href="#l4.288"></a><span id="l4.288" class="difflineplus">+  return NS_ERROR_FAILURE;</span>
<a href="#l4.289"></a><span id="l4.289" class="difflineplus">+}</span>
<a href="#l4.290"></a><span id="l4.290" class="difflineplus">+</span>
<a href="#l4.291"></a><span id="l4.291" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l4.292"></a><span id="l4.292" class="difflineplus">+nsBeckyAddressBooks::ImportAddressBook(nsIImportABDescriptor *aSource,</span>
<a href="#l4.293"></a><span id="l4.293" class="difflineplus">+                                       nsIAddrDatabase *aDestination,</span>
<a href="#l4.294"></a><span id="l4.294" class="difflineplus">+                                       nsIImportFieldMap *aFieldMap,</span>
<a href="#l4.295"></a><span id="l4.295" class="difflineplus">+                                       nsISupports *aSupportService,</span>
<a href="#l4.296"></a><span id="l4.296" class="difflineplus">+                                       char16_t **aErrorLog,</span>
<a href="#l4.297"></a><span id="l4.297" class="difflineplus">+                                       char16_t **aSuccessLog,</span>
<a href="#l4.298"></a><span id="l4.298" class="difflineplus">+                                       bool *aFatalError)</span>
<a href="#l4.299"></a><span id="l4.299" class="difflineplus">+{</span>
<a href="#l4.300"></a><span id="l4.300" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aSource);</span>
<a href="#l4.301"></a><span id="l4.301" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aDestination);</span>
<a href="#l4.302"></a><span id="l4.302" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aErrorLog);</span>
<a href="#l4.303"></a><span id="l4.303" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aSuccessLog);</span>
<a href="#l4.304"></a><span id="l4.304" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aFatalError);</span>
<a href="#l4.305"></a><span id="l4.305" class="difflineplus">+</span>
<a href="#l4.306"></a><span id="l4.306" class="difflineplus">+  mReadBytes = 0;</span>
<a href="#l4.307"></a><span id="l4.307" class="difflineplus">+</span>
<a href="#l4.308"></a><span id="l4.308" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; file;</span>
<a href="#l4.309"></a><span id="l4.309" class="difflineplus">+  nsresult rv = aSource-&gt;GetAbFile(getter_AddRefs(file));</span>
<a href="#l4.310"></a><span id="l4.310" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.311"></a><span id="l4.311" class="difflineplus">+</span>
<a href="#l4.312"></a><span id="l4.312" class="difflineplus">+  nsCOMPtr&lt;nsISimpleEnumerator&gt; entries;</span>
<a href="#l4.313"></a><span id="l4.313" class="difflineplus">+  rv = file-&gt;GetDirectoryEntries(getter_AddRefs(entries));</span>
<a href="#l4.314"></a><span id="l4.314" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.315"></a><span id="l4.315" class="difflineplus">+</span>
<a href="#l4.316"></a><span id="l4.316" class="difflineplus">+  bool more;</span>
<a href="#l4.317"></a><span id="l4.317" class="difflineplus">+  nsCOMPtr&lt;nsISupports&gt; entry;</span>
<a href="#l4.318"></a><span id="l4.318" class="difflineplus">+  nsAutoString error;</span>
<a href="#l4.319"></a><span id="l4.319" class="difflineplus">+  while (NS_SUCCEEDED(entries-&gt;HasMoreElements(&amp;more)) &amp;&amp; more) {</span>
<a href="#l4.320"></a><span id="l4.320" class="difflineplus">+    rv = entries-&gt;GetNext(getter_AddRefs(entry));</span>
<a href="#l4.321"></a><span id="l4.321" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.322"></a><span id="l4.322" class="difflineplus">+</span>
<a href="#l4.323"></a><span id="l4.323" class="difflineplus">+    nsCOMPtr&lt;nsIFile&gt; file = do_QueryInterface(entry, &amp;rv);</span>
<a href="#l4.324"></a><span id="l4.324" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.325"></a><span id="l4.325" class="difflineplus">+</span>
<a href="#l4.326"></a><span id="l4.326" class="difflineplus">+    if (!IsAddressBookFile(file))</span>
<a href="#l4.327"></a><span id="l4.327" class="difflineplus">+      continue;</span>
<a href="#l4.328"></a><span id="l4.328" class="difflineplus">+</span>
<a href="#l4.329"></a><span id="l4.329" class="difflineplus">+    bool aborted = false;</span>
<a href="#l4.330"></a><span id="l4.330" class="difflineplus">+    nsAutoString name;</span>
<a href="#l4.331"></a><span id="l4.331" class="difflineplus">+    aSource-&gt;GetPreferredName(name);</span>
<a href="#l4.332"></a><span id="l4.332" class="difflineplus">+    nsVCardAddress vcard;</span>
<a href="#l4.333"></a><span id="l4.333" class="difflineplus">+    rv = vcard.ImportAddresses(&amp;aborted, name.get(), file, aDestination, error, &amp;mReadBytes);</span>
<a href="#l4.334"></a><span id="l4.334" class="difflineplus">+    if (NS_FAILED(rv)) {</span>
<a href="#l4.335"></a><span id="l4.335" class="difflineplus">+      break;</span>
<a href="#l4.336"></a><span id="l4.336" class="difflineplus">+    }</span>
<a href="#l4.337"></a><span id="l4.337" class="difflineplus">+  }</span>
<a href="#l4.338"></a><span id="l4.338" class="difflineplus">+</span>
<a href="#l4.339"></a><span id="l4.339" class="difflineplus">+  if (!error.IsEmpty())</span>
<a href="#l4.340"></a><span id="l4.340" class="difflineplus">+    *aErrorLog = ToNewUnicode(error);</span>
<a href="#l4.341"></a><span id="l4.341" class="difflineplus">+  else</span>
<a href="#l4.342"></a><span id="l4.342" class="difflineplus">+    *aSuccessLog = nsBeckyStringBundle::GetStringByName(MOZ_UTF16(&quot;BeckyImportAddressSuccess&quot;));</span>
<a href="#l4.343"></a><span id="l4.343" class="difflineplus">+</span>
<a href="#l4.344"></a><span id="l4.344" class="difflineplus">+  return rv;</span>
<a href="#l4.345"></a><span id="l4.345" class="difflineplus">+}</span>
<a href="#l4.346"></a><span id="l4.346" class="difflineplus">+</span>
<a href="#l4.347"></a><span id="l4.347" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l4.348"></a><span id="l4.348" class="difflineplus">+nsBeckyAddressBooks::GetImportProgress(uint32_t *_retval)</span>
<a href="#l4.349"></a><span id="l4.349" class="difflineplus">+{</span>
<a href="#l4.350"></a><span id="l4.350" class="difflineplus">+  NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l4.351"></a><span id="l4.351" class="difflineplus">+  *_retval = mReadBytes;</span>
<a href="#l4.352"></a><span id="l4.352" class="difflineplus">+  return NS_OK;</span>
<a href="#l4.353"></a><span id="l4.353" class="difflineplus">+}</span>
<a href="#l4.354"></a><span id="l4.354" class="difflineplus">+</span>
<a href="#l4.355"></a><span id="l4.355" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l4.356"></a><span id="l4.356" class="difflineplus">+nsBeckyAddressBooks::SetSampleLocation(nsIFile *aLocation)</span>
<a href="#l4.357"></a><span id="l4.357" class="difflineplus">+{</span>
<a href="#l4.358"></a><span id="l4.358" class="difflineplus">+  return NS_OK;</span>
<a href="#l4.359"></a><span id="l4.359" class="difflineplus">+}</span>
<a href="#l4.360"></a><span id="l4.360" class="difflineplus">+</span>
<a href="#l4.361"></a><span id="l4.361" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l4.362"></a><span id="l4.362" class="difflineplus">+nsBeckyAddressBooks::GetSampleData(int32_t aRecordNumber,</span>
<a href="#l4.363"></a><span id="l4.363" class="difflineplus">+                                   bool *aRecordExists,</span>
<a href="#l4.364"></a><span id="l4.364" class="difflineplus">+                                   char16_t **_retval)</span>
<a href="#l4.365"></a><span id="l4.365" class="difflineplus">+{</span>
<a href="#l4.366"></a><span id="l4.366" class="difflineplus">+  return NS_ERROR_FAILURE;</span>
<a href="#l4.367"></a><span id="l4.367" class="difflineplus">+}</span>
<a href="#l4.368"></a><span id="l4.368" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1">new file mode 100644</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineminus">--- /dev/null</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineplus">+++ b/mailnews/import/becky/src/nsBeckyAddressBooks.h</span>
<a href="#l5.4"></a><span id="l5.4" class="difflineat">@@ -0,0 +1,35 @@</span>
<a href="#l5.5"></a><span id="l5.5" class="difflineplus">+/* vim: set ts=2 et sw=2 tw=80: */</span>
<a href="#l5.6"></a><span id="l5.6" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l5.7"></a><span id="l5.7" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l5.8"></a><span id="l5.8" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l5.9"></a><span id="l5.9" class="difflineplus">+</span>
<a href="#l5.10"></a><span id="l5.10" class="difflineplus">+#ifndef nsBeckyAddressBooks_h___</span>
<a href="#l5.11"></a><span id="l5.11" class="difflineplus">+#define nsBeckyAddressBooks_h___</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+#include &quot;nsIImportAddressBooks.h&quot;</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+class nsBeckyAddressBooks final : public nsIImportAddressBooks</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+{</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+public:</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+  nsBeckyAddressBooks();</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+  static nsresult Create(nsIImportAddressBooks **aImport);</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineplus">+  NS_DECL_NSIIMPORTADDRESSBOOKS</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineplus">+</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineplus">+private:</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineplus">+  virtual ~nsBeckyAddressBooks();</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineplus">+</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineplus">+  uint32_t mReadBytes;</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineplus">+</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineplus">+  nsresult CollectAddressBooks(nsIFile *aTarget, nsIMutableArray *aCollected);</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineplus">+  nsresult FindAddressBookDirectory(nsIFile **aAddressBookDirectory);</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+  nsresult AppendAddressBookDescriptor(nsIFile *aEntry,</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+                                       nsIMutableArray *aCollected);</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineplus">+  uint32_t CountAddressBookSize(nsIFile *aDirectory);</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineplus">+  bool HasAddressBookFile(nsIFile *aDirectory);</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineplus">+  bool IsAddressBookFile(nsIFile *aFile);</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineplus">+  nsresult CreateAddressBookDescriptor(nsIImportABDescriptor **aDescriptor);</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineplus">+};</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineplus">+</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineplus">+#endif /* nsBeckyAddressBooks_h___ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1">new file mode 100644</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineminus">--- /dev/null</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineplus">+++ b/mailnews/import/becky/src/nsBeckyFilters.cpp</span>
<a href="#l6.4"></a><span id="l6.4" class="difflineat">@@ -0,0 +1,691 @@</span>
<a href="#l6.5"></a><span id="l6.5" class="difflineplus">+/* vim: set ts=2 et sw=2 tw=80: */</span>
<a href="#l6.6"></a><span id="l6.6" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l6.7"></a><span id="l6.7" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l6.8"></a><span id="l6.8" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l6.9"></a><span id="l6.9" class="difflineplus">+</span>
<a href="#l6.10"></a><span id="l6.10" class="difflineplus">+#include &quot;nsArrayUtils.h&quot;</span>
<a href="#l6.11"></a><span id="l6.11" class="difflineplus">+#include &quot;nsILineInputStream.h&quot;</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+#include &quot;nsIStringBundle.h&quot;</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+#include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+#include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+#include &quot;nsIMsgFilter.h&quot;</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+#include &quot;nsIMsgFilterList.h&quot;</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+#include &quot;nsIMsgAccountManager.h&quot;</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+#include &quot;nsIMsgAccount.h&quot;</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineplus">+#include &quot;nsIMsgSearchTerm.h&quot;</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+#include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineplus">+#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+#include &quot;nsMsgSearchCore.h&quot;</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineplus">+#include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineplus">+#include &quot;nsMsgUtils.h&quot;</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineplus">+#include &quot;msgCore.h&quot;</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineplus">+</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineplus">+#include &quot;nsBeckyFilters.h&quot;</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineplus">+#include &quot;nsBeckyStringBundle.h&quot;</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineplus">+#include &quot;nsBeckyUtils.h&quot;</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineplus">+</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineplus">+NS_IMPL_ISUPPORTS(nsBeckyFilters, nsIImportFilters)</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+nsresult</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+nsBeckyFilters::Create(nsIImportFilters **aImport)</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+{</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aImport);</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineplus">+</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineplus">+  *aImport = new nsBeckyFilters();</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineplus">+</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineplus">+  NS_ADDREF(*aImport);</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineplus">+  return NS_OK;</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineplus">+}</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineplus">+</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineplus">+nsBeckyFilters::nsBeckyFilters()</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineplus">+: mLocation(nullptr),</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineplus">+  mServer(nullptr),</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineplus">+  mConvertedFile(nullptr)</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineplus">+{</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineplus">+}</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineplus">+</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineplus">+nsBeckyFilters::~nsBeckyFilters()</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineplus">+{</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineplus">+}</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineplus">+</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineplus">+nsresult</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineplus">+nsBeckyFilters::GetDefaultFilterFile(nsIFile **aFile)</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineplus">+{</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineplus">+  nsresult rv;</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; filter;</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineplus">+  rv = nsBeckyUtils::GetDefaultMailboxDirectory(getter_AddRefs(filter));</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineplus">+</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineplus">+  rv = filter-&gt;Append(NS_LITERAL_STRING(&quot;IFilter.def&quot;));</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineplus">+</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineplus">+  bool exists;</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineplus">+  rv = filter-&gt;Exists(&amp;exists);</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineplus">+</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineplus">+  if (!exists)</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineplus">+    return NS_ERROR_FILE_NOT_FOUND;</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineplus">+</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineplus">+  filter.forget(aFile);</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineplus">+  return NS_OK;</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineplus">+}</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineplus">+</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l6.78"></a><span id="l6.78" class="difflineplus">+nsBeckyFilters::AutoLocate(char16_t **aDescription,</span>
<a href="#l6.79"></a><span id="l6.79" class="difflineplus">+                           nsIFile **aLocation,</span>
<a href="#l6.80"></a><span id="l6.80" class="difflineplus">+                           bool *_retval)</span>
<a href="#l6.81"></a><span id="l6.81" class="difflineplus">+{</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aDescription);</span>
<a href="#l6.83"></a><span id="l6.83" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aLocation);</span>
<a href="#l6.84"></a><span id="l6.84" class="difflineplus">+  NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l6.85"></a><span id="l6.85" class="difflineplus">+</span>
<a href="#l6.86"></a><span id="l6.86" class="difflineplus">+  *aDescription =</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineplus">+    nsBeckyStringBundle::GetStringByName(MOZ_UTF16(&quot;BeckyImportDescription&quot;));</span>
<a href="#l6.88"></a><span id="l6.88" class="difflineplus">+  *aLocation = nullptr;</span>
<a href="#l6.89"></a><span id="l6.89" class="difflineplus">+  *_retval = false;</span>
<a href="#l6.90"></a><span id="l6.90" class="difflineplus">+</span>
<a href="#l6.91"></a><span id="l6.91" class="difflineplus">+  nsresult rv;</span>
<a href="#l6.92"></a><span id="l6.92" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; location;</span>
<a href="#l6.93"></a><span id="l6.93" class="difflineplus">+  rv = GetDefaultFilterFile(getter_AddRefs(location));</span>
<a href="#l6.94"></a><span id="l6.94" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l6.95"></a><span id="l6.95" class="difflineplus">+    location = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l6.96"></a><span id="l6.96" class="difflineplus">+  else</span>
<a href="#l6.97"></a><span id="l6.97" class="difflineplus">+    *_retval = true;</span>
<a href="#l6.98"></a><span id="l6.98" class="difflineplus">+</span>
<a href="#l6.99"></a><span id="l6.99" class="difflineplus">+  location.forget(aLocation);</span>
<a href="#l6.100"></a><span id="l6.100" class="difflineplus">+  return NS_OK;</span>
<a href="#l6.101"></a><span id="l6.101" class="difflineplus">+}</span>
<a href="#l6.102"></a><span id="l6.102" class="difflineplus">+</span>
<a href="#l6.103"></a><span id="l6.103" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l6.104"></a><span id="l6.104" class="difflineplus">+nsBeckyFilters::SetLocation(nsIFile *aLocation)</span>
<a href="#l6.105"></a><span id="l6.105" class="difflineplus">+{</span>
<a href="#l6.106"></a><span id="l6.106" class="difflineplus">+  mLocation = aLocation;</span>
<a href="#l6.107"></a><span id="l6.107" class="difflineplus">+  return NS_OK;</span>
<a href="#l6.108"></a><span id="l6.108" class="difflineplus">+}</span>
<a href="#l6.109"></a><span id="l6.109" class="difflineplus">+</span>
<a href="#l6.110"></a><span id="l6.110" class="difflineplus">+static nsMsgSearchAttribValue</span>
<a href="#l6.111"></a><span id="l6.111" class="difflineplus">+ConvertSearchKeyToAttrib(const nsACString &amp;aKey)</span>
<a href="#l6.112"></a><span id="l6.112" class="difflineplus">+{</span>
<a href="#l6.113"></a><span id="l6.113" class="difflineplus">+  if (aKey.EqualsLiteral(&quot;From&quot;) ||</span>
<a href="#l6.114"></a><span id="l6.114" class="difflineplus">+      aKey.EqualsLiteral(&quot;Sender&quot;) ||</span>
<a href="#l6.115"></a><span id="l6.115" class="difflineplus">+      aKey.EqualsLiteral(&quot;From, Sender, X-Sender&quot;)) {</span>
<a href="#l6.116"></a><span id="l6.116" class="difflineplus">+    return nsMsgSearchAttrib::Sender;</span>
<a href="#l6.117"></a><span id="l6.117" class="difflineplus">+  } else if (aKey.EqualsLiteral(&quot;Subject&quot;)) {</span>
<a href="#l6.118"></a><span id="l6.118" class="difflineplus">+    return nsMsgSearchAttrib::Subject;</span>
<a href="#l6.119"></a><span id="l6.119" class="difflineplus">+  } else if (aKey.EqualsLiteral(&quot;[body]&quot;)) {</span>
<a href="#l6.120"></a><span id="l6.120" class="difflineplus">+    return nsMsgSearchAttrib::Body;</span>
<a href="#l6.121"></a><span id="l6.121" class="difflineplus">+  } else if (aKey.EqualsLiteral(&quot;Date&quot;)) {</span>
<a href="#l6.122"></a><span id="l6.122" class="difflineplus">+    return nsMsgSearchAttrib::Date;</span>
<a href="#l6.123"></a><span id="l6.123" class="difflineplus">+  } else if (aKey.EqualsLiteral(&quot;To&quot;)) {</span>
<a href="#l6.124"></a><span id="l6.124" class="difflineplus">+    return nsMsgSearchAttrib::To;</span>
<a href="#l6.125"></a><span id="l6.125" class="difflineplus">+  } else if (aKey.EqualsLiteral(&quot;Cc&quot;)) {</span>
<a href="#l6.126"></a><span id="l6.126" class="difflineplus">+    return nsMsgSearchAttrib::CC;</span>
<a href="#l6.127"></a><span id="l6.127" class="difflineplus">+  } else if (aKey.EqualsLiteral(&quot;To,  Cc,  Bcc:&quot;)) {</span>
<a href="#l6.128"></a><span id="l6.128" class="difflineplus">+    return nsMsgSearchAttrib::ToOrCC;</span>
<a href="#l6.129"></a><span id="l6.129" class="difflineplus">+  }</span>
<a href="#l6.130"></a><span id="l6.130" class="difflineplus">+  return -1;</span>
<a href="#l6.131"></a><span id="l6.131" class="difflineplus">+}</span>
<a href="#l6.132"></a><span id="l6.132" class="difflineplus">+</span>
<a href="#l6.133"></a><span id="l6.133" class="difflineplus">+static nsMsgSearchOpValue</span>
<a href="#l6.134"></a><span id="l6.134" class="difflineplus">+ConvertSearchFlagsToOperator(const nsACString &amp;aFlags)</span>
<a href="#l6.135"></a><span id="l6.135" class="difflineplus">+{</span>
<a href="#l6.136"></a><span id="l6.136" class="difflineplus">+  nsCString flags(aFlags);</span>
<a href="#l6.137"></a><span id="l6.137" class="difflineplus">+  int32_t lastTabPosition = flags.RFindChar('\t');</span>
<a href="#l6.138"></a><span id="l6.138" class="difflineplus">+  if ((lastTabPosition == -1) ||</span>
<a href="#l6.139"></a><span id="l6.139" class="difflineplus">+      ((int32_t)aFlags.Length() == lastTabPosition - 1)) {</span>
<a href="#l6.140"></a><span id="l6.140" class="difflineplus">+    return -1;</span>
<a href="#l6.141"></a><span id="l6.141" class="difflineplus">+  }</span>
<a href="#l6.142"></a><span id="l6.142" class="difflineplus">+</span>
<a href="#l6.143"></a><span id="l6.143" class="difflineplus">+  switch (aFlags.CharAt(0)) {</span>
<a href="#l6.144"></a><span id="l6.144" class="difflineplus">+    case 'X':</span>
<a href="#l6.145"></a><span id="l6.145" class="difflineplus">+      return nsMsgSearchOp::DoesntContain;</span>
<a href="#l6.146"></a><span id="l6.146" class="difflineplus">+    case 'O':</span>
<a href="#l6.147"></a><span id="l6.147" class="difflineplus">+      if (aFlags.FindChar('T', lastTabPosition + 1) &gt;= 0)</span>
<a href="#l6.148"></a><span id="l6.148" class="difflineplus">+        return nsMsgSearchOp::BeginsWith;</span>
<a href="#l6.149"></a><span id="l6.149" class="difflineplus">+      return nsMsgSearchOp::Contains;</span>
<a href="#l6.150"></a><span id="l6.150" class="difflineplus">+    default:</span>
<a href="#l6.151"></a><span id="l6.151" class="difflineplus">+      return -1;</span>
<a href="#l6.152"></a><span id="l6.152" class="difflineplus">+  }</span>
<a href="#l6.153"></a><span id="l6.153" class="difflineplus">+}</span>
<a href="#l6.154"></a><span id="l6.154" class="difflineplus">+</span>
<a href="#l6.155"></a><span id="l6.155" class="difflineplus">+nsresult</span>
<a href="#l6.156"></a><span id="l6.156" class="difflineplus">+nsBeckyFilters::ParseRuleLine(const nsCString &amp;aLine,</span>
<a href="#l6.157"></a><span id="l6.157" class="difflineplus">+                              nsMsgSearchAttribValue *aSearchAttribute,</span>
<a href="#l6.158"></a><span id="l6.158" class="difflineplus">+                              nsMsgSearchOpValue *aSearchOperator,</span>
<a href="#l6.159"></a><span id="l6.159" class="difflineplus">+                              nsString &amp;aSearchKeyword)</span>
<a href="#l6.160"></a><span id="l6.160" class="difflineplus">+{</span>
<a href="#l6.161"></a><span id="l6.161" class="difflineplus">+  int32_t firstColonPosition = aLine.FindChar(':');</span>
<a href="#l6.162"></a><span id="l6.162" class="difflineplus">+  if (firstColonPosition == -1 ||</span>
<a href="#l6.163"></a><span id="l6.163" class="difflineplus">+      (int32_t)aLine.Length() == firstColonPosition - 1) {</span>
<a href="#l6.164"></a><span id="l6.164" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l6.165"></a><span id="l6.165" class="difflineplus">+  }</span>
<a href="#l6.166"></a><span id="l6.166" class="difflineplus">+</span>
<a href="#l6.167"></a><span id="l6.167" class="difflineplus">+  int32_t secondColonPosition = aLine.FindChar(':', firstColonPosition + 1);</span>
<a href="#l6.168"></a><span id="l6.168" class="difflineplus">+  if (secondColonPosition == -1 ||</span>
<a href="#l6.169"></a><span id="l6.169" class="difflineplus">+      (int32_t)aLine.Length() == secondColonPosition - 1) {</span>
<a href="#l6.170"></a><span id="l6.170" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l6.171"></a><span id="l6.171" class="difflineplus">+  }</span>
<a href="#l6.172"></a><span id="l6.172" class="difflineplus">+</span>
<a href="#l6.173"></a><span id="l6.173" class="difflineplus">+  int32_t length = secondColonPosition - firstColonPosition - 1;</span>
<a href="#l6.174"></a><span id="l6.174" class="difflineplus">+  nsMsgSearchAttribValue searchAttribute;</span>
<a href="#l6.175"></a><span id="l6.175" class="difflineplus">+  searchAttribute = ConvertSearchKeyToAttrib(Substring(aLine, firstColonPosition + 1, length));</span>
<a href="#l6.176"></a><span id="l6.176" class="difflineplus">+  if (searchAttribute &lt; 0)</span>
<a href="#l6.177"></a><span id="l6.177" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l6.178"></a><span id="l6.178" class="difflineplus">+</span>
<a href="#l6.179"></a><span id="l6.179" class="difflineplus">+  int32_t tabPosition = aLine.FindChar('\t');</span>
<a href="#l6.180"></a><span id="l6.180" class="difflineplus">+  if (tabPosition == -1 ||</span>
<a href="#l6.181"></a><span id="l6.181" class="difflineplus">+      (int32_t)aLine.Length() == tabPosition - 1) {</span>
<a href="#l6.182"></a><span id="l6.182" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l6.183"></a><span id="l6.183" class="difflineplus">+  }</span>
<a href="#l6.184"></a><span id="l6.184" class="difflineplus">+</span>
<a href="#l6.185"></a><span id="l6.185" class="difflineplus">+  nsMsgSearchOpValue searchOperator;</span>
<a href="#l6.186"></a><span id="l6.186" class="difflineplus">+  searchOperator = ConvertSearchFlagsToOperator(Substring(aLine, tabPosition + 1));</span>
<a href="#l6.187"></a><span id="l6.187" class="difflineplus">+  if (searchOperator &lt; 0)</span>
<a href="#l6.188"></a><span id="l6.188" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l6.189"></a><span id="l6.189" class="difflineplus">+</span>
<a href="#l6.190"></a><span id="l6.190" class="difflineplus">+  *aSearchOperator = searchOperator;</span>
<a href="#l6.191"></a><span id="l6.191" class="difflineplus">+  *aSearchAttribute = searchAttribute;</span>
<a href="#l6.192"></a><span id="l6.192" class="difflineplus">+  length = tabPosition - secondColonPosition - 1;</span>
<a href="#l6.193"></a><span id="l6.193" class="difflineplus">+  CopyUTF8toUTF16(Substring(aLine, secondColonPosition + 1, length), aSearchKeyword);</span>
<a href="#l6.194"></a><span id="l6.194" class="difflineplus">+  return NS_OK;</span>
<a href="#l6.195"></a><span id="l6.195" class="difflineplus">+}</span>
<a href="#l6.196"></a><span id="l6.196" class="difflineplus">+</span>
<a href="#l6.197"></a><span id="l6.197" class="difflineplus">+nsresult</span>
<a href="#l6.198"></a><span id="l6.198" class="difflineplus">+nsBeckyFilters::SetSearchTerm(const nsCString &amp;aLine, nsIMsgFilter *aFilter)</span>
<a href="#l6.199"></a><span id="l6.199" class="difflineplus">+{</span>
<a href="#l6.200"></a><span id="l6.200" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aFilter);</span>
<a href="#l6.201"></a><span id="l6.201" class="difflineplus">+</span>
<a href="#l6.202"></a><span id="l6.202" class="difflineplus">+  nsresult rv;</span>
<a href="#l6.203"></a><span id="l6.203" class="difflineplus">+  nsMsgSearchAttribValue searchAttribute = -1;</span>
<a href="#l6.204"></a><span id="l6.204" class="difflineplus">+  nsMsgSearchOpValue searchOperator = -1;</span>
<a href="#l6.205"></a><span id="l6.205" class="difflineplus">+  nsAutoString searchKeyword;</span>
<a href="#l6.206"></a><span id="l6.206" class="difflineplus">+  rv = ParseRuleLine(aLine, &amp;searchAttribute, &amp;searchOperator, searchKeyword);</span>
<a href="#l6.207"></a><span id="l6.207" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.208"></a><span id="l6.208" class="difflineplus">+</span>
<a href="#l6.209"></a><span id="l6.209" class="difflineplus">+  nsCOMPtr&lt;nsIMsgSearchTerm&gt; term;</span>
<a href="#l6.210"></a><span id="l6.210" class="difflineplus">+  rv = aFilter-&gt;CreateTerm(getter_AddRefs(term));</span>
<a href="#l6.211"></a><span id="l6.211" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.212"></a><span id="l6.212" class="difflineplus">+</span>
<a href="#l6.213"></a><span id="l6.213" class="difflineplus">+  rv = term-&gt;SetAttrib(searchAttribute);</span>
<a href="#l6.214"></a><span id="l6.214" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.215"></a><span id="l6.215" class="difflineplus">+  rv = term-&gt;SetOp(searchOperator);</span>
<a href="#l6.216"></a><span id="l6.216" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.217"></a><span id="l6.217" class="difflineplus">+</span>
<a href="#l6.218"></a><span id="l6.218" class="difflineplus">+  nsCOMPtr&lt;nsIMsgSearchValue&gt; value;</span>
<a href="#l6.219"></a><span id="l6.219" class="difflineplus">+  rv = term-&gt;GetValue(getter_AddRefs(value));</span>
<a href="#l6.220"></a><span id="l6.220" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.221"></a><span id="l6.221" class="difflineplus">+</span>
<a href="#l6.222"></a><span id="l6.222" class="difflineplus">+  rv = value-&gt;SetAttrib(searchAttribute);</span>
<a href="#l6.223"></a><span id="l6.223" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.224"></a><span id="l6.224" class="difflineplus">+  rv = value-&gt;SetStr(searchKeyword);</span>
<a href="#l6.225"></a><span id="l6.225" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.226"></a><span id="l6.226" class="difflineplus">+  rv = term-&gt;SetValue(value);</span>
<a href="#l6.227"></a><span id="l6.227" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.228"></a><span id="l6.228" class="difflineplus">+  rv = term-&gt;SetBooleanAnd(false);</span>
<a href="#l6.229"></a><span id="l6.229" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.230"></a><span id="l6.230" class="difflineplus">+</span>
<a href="#l6.231"></a><span id="l6.231" class="difflineplus">+  if (!searchKeyword.IsEmpty())</span>
<a href="#l6.232"></a><span id="l6.232" class="difflineplus">+    rv = aFilter-&gt;SetFilterName(searchKeyword);</span>
<a href="#l6.233"></a><span id="l6.233" class="difflineplus">+  else</span>
<a href="#l6.234"></a><span id="l6.234" class="difflineplus">+    rv = aFilter-&gt;SetFilterName(NS_LITERAL_STRING(&quot;No name&quot;));</span>
<a href="#l6.235"></a><span id="l6.235" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.236"></a><span id="l6.236" class="difflineplus">+</span>
<a href="#l6.237"></a><span id="l6.237" class="difflineplus">+  return aFilter-&gt;AppendTerm(term);</span>
<a href="#l6.238"></a><span id="l6.238" class="difflineplus">+}</span>
<a href="#l6.239"></a><span id="l6.239" class="difflineplus">+</span>
<a href="#l6.240"></a><span id="l6.240" class="difflineplus">+nsresult</span>
<a href="#l6.241"></a><span id="l6.241" class="difflineplus">+nsBeckyFilters::CreateRuleAction(nsIMsgFilter *aFilter,</span>
<a href="#l6.242"></a><span id="l6.242" class="difflineplus">+                                 nsMsgRuleActionType actionType,</span>
<a href="#l6.243"></a><span id="l6.243" class="difflineplus">+                                 nsIMsgRuleAction **_retval)</span>
<a href="#l6.244"></a><span id="l6.244" class="difflineplus">+{</span>
<a href="#l6.245"></a><span id="l6.245" class="difflineplus">+  nsresult rv;</span>
<a href="#l6.246"></a><span id="l6.246" class="difflineplus">+  nsCOMPtr&lt;nsIMsgRuleAction&gt; action;</span>
<a href="#l6.247"></a><span id="l6.247" class="difflineplus">+  rv = aFilter-&gt;CreateAction(getter_AddRefs(action));</span>
<a href="#l6.248"></a><span id="l6.248" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.249"></a><span id="l6.249" class="difflineplus">+  rv = action-&gt;SetType(actionType);</span>
<a href="#l6.250"></a><span id="l6.250" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.251"></a><span id="l6.251" class="difflineplus">+</span>
<a href="#l6.252"></a><span id="l6.252" class="difflineplus">+  action.forget(_retval);</span>
<a href="#l6.253"></a><span id="l6.253" class="difflineplus">+</span>
<a href="#l6.254"></a><span id="l6.254" class="difflineplus">+  return NS_OK;</span>
<a href="#l6.255"></a><span id="l6.255" class="difflineplus">+}</span>
<a href="#l6.256"></a><span id="l6.256" class="difflineplus">+</span>
<a href="#l6.257"></a><span id="l6.257" class="difflineplus">+nsresult</span>
<a href="#l6.258"></a><span id="l6.258" class="difflineplus">+nsBeckyFilters::GetActionTarget(const nsCString &amp;aLine,</span>
<a href="#l6.259"></a><span id="l6.259" class="difflineplus">+                                nsCString &amp;aTarget)</span>
<a href="#l6.260"></a><span id="l6.260" class="difflineplus">+{</span>
<a href="#l6.261"></a><span id="l6.261" class="difflineplus">+  int32_t firstColonPosition = aLine.FindChar(':');</span>
<a href="#l6.262"></a><span id="l6.262" class="difflineplus">+  if (firstColonPosition &lt; -1 ||</span>
<a href="#l6.263"></a><span id="l6.263" class="difflineplus">+      aLine.Length() == static_cast&lt;uint32_t&gt;(firstColonPosition)) {</span>
<a href="#l6.264"></a><span id="l6.264" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l6.265"></a><span id="l6.265" class="difflineplus">+  }</span>
<a href="#l6.266"></a><span id="l6.266" class="difflineplus">+</span>
<a href="#l6.267"></a><span id="l6.267" class="difflineplus">+  aTarget.Assign(Substring(aLine, firstColonPosition + 1));</span>
<a href="#l6.268"></a><span id="l6.268" class="difflineplus">+</span>
<a href="#l6.269"></a><span id="l6.269" class="difflineplus">+  return NS_OK;</span>
<a href="#l6.270"></a><span id="l6.270" class="difflineplus">+}</span>
<a href="#l6.271"></a><span id="l6.271" class="difflineplus">+</span>
<a href="#l6.272"></a><span id="l6.272" class="difflineplus">+nsresult</span>
<a href="#l6.273"></a><span id="l6.273" class="difflineplus">+nsBeckyFilters::GetResendTarget(const nsCString &amp;aLine,</span>
<a href="#l6.274"></a><span id="l6.274" class="difflineplus">+                                nsCString &amp;aTemplate,</span>
<a href="#l6.275"></a><span id="l6.275" class="difflineplus">+                                nsCString &amp;aTargetAddress)</span>
<a href="#l6.276"></a><span id="l6.276" class="difflineplus">+{</span>
<a href="#l6.277"></a><span id="l6.277" class="difflineplus">+  nsresult rv;</span>
<a href="#l6.278"></a><span id="l6.278" class="difflineplus">+  nsAutoCString target;</span>
<a href="#l6.279"></a><span id="l6.279" class="difflineplus">+  rv = GetActionTarget(aLine, target);</span>
<a href="#l6.280"></a><span id="l6.280" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.281"></a><span id="l6.281" class="difflineplus">+</span>
<a href="#l6.282"></a><span id="l6.282" class="difflineplus">+  int32_t asteriskPosition = target.FindChar('*');</span>
<a href="#l6.283"></a><span id="l6.283" class="difflineplus">+  if (asteriskPosition &lt; 0) {</span>
<a href="#l6.284"></a><span id="l6.284" class="difflineplus">+    aTemplate.Assign(target);</span>
<a href="#l6.285"></a><span id="l6.285" class="difflineplus">+    return NS_OK;</span>
<a href="#l6.286"></a><span id="l6.286" class="difflineplus">+  }</span>
<a href="#l6.287"></a><span id="l6.287" class="difflineplus">+</span>
<a href="#l6.288"></a><span id="l6.288" class="difflineplus">+  if (target.Length() == static_cast&lt;uint32_t&gt;(asteriskPosition))</span>
<a href="#l6.289"></a><span id="l6.289" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l6.290"></a><span id="l6.290" class="difflineplus">+</span>
<a href="#l6.291"></a><span id="l6.291" class="difflineplus">+  aTemplate.Assign(StringHead(target, asteriskPosition - 1));</span>
<a href="#l6.292"></a><span id="l6.292" class="difflineplus">+  aTargetAddress.Assign(Substring(target, asteriskPosition + 1));</span>
<a href="#l6.293"></a><span id="l6.293" class="difflineplus">+</span>
<a href="#l6.294"></a><span id="l6.294" class="difflineplus">+  return NS_OK;</span>
<a href="#l6.295"></a><span id="l6.295" class="difflineplus">+}</span>
<a href="#l6.296"></a><span id="l6.296" class="difflineplus">+</span>
<a href="#l6.297"></a><span id="l6.297" class="difflineplus">+nsresult</span>
<a href="#l6.298"></a><span id="l6.298" class="difflineplus">+nsBeckyFilters::CreateResendAction(const nsCString &amp;aLine,</span>
<a href="#l6.299"></a><span id="l6.299" class="difflineplus">+                                   nsIMsgFilter *aFilter,</span>
<a href="#l6.300"></a><span id="l6.300" class="difflineplus">+                                   const nsMsgRuleActionType &amp;aActionType,</span>
<a href="#l6.301"></a><span id="l6.301" class="difflineplus">+                                   nsIMsgRuleAction **_retval)</span>
<a href="#l6.302"></a><span id="l6.302" class="difflineplus">+{</span>
<a href="#l6.303"></a><span id="l6.303" class="difflineplus">+  nsresult rv;</span>
<a href="#l6.304"></a><span id="l6.304" class="difflineplus">+  nsCOMPtr&lt;nsIMsgRuleAction&gt; action;</span>
<a href="#l6.305"></a><span id="l6.305" class="difflineplus">+  rv = CreateRuleAction(aFilter, aActionType, getter_AddRefs(action));</span>
<a href="#l6.306"></a><span id="l6.306" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.307"></a><span id="l6.307" class="difflineplus">+</span>
<a href="#l6.308"></a><span id="l6.308" class="difflineplus">+  nsAutoCString templateString;</span>
<a href="#l6.309"></a><span id="l6.309" class="difflineplus">+  nsAutoCString targetAddress;</span>
<a href="#l6.310"></a><span id="l6.310" class="difflineplus">+  rv = GetResendTarget(aLine, templateString, targetAddress);</span>
<a href="#l6.311"></a><span id="l6.311" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.312"></a><span id="l6.312" class="difflineplus">+</span>
<a href="#l6.313"></a><span id="l6.313" class="difflineplus">+  if (aActionType == nsMsgFilterAction::Forward)</span>
<a href="#l6.314"></a><span id="l6.314" class="difflineplus">+    rv = action-&gt;SetStrValue(targetAddress);</span>
<a href="#l6.315"></a><span id="l6.315" class="difflineplus">+  else</span>
<a href="#l6.316"></a><span id="l6.316" class="difflineplus">+    rv = action-&gt;SetStrValue(templateString);</span>
<a href="#l6.317"></a><span id="l6.317" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.318"></a><span id="l6.318" class="difflineplus">+</span>
<a href="#l6.319"></a><span id="l6.319" class="difflineplus">+  action.forget(_retval);</span>
<a href="#l6.320"></a><span id="l6.320" class="difflineplus">+</span>
<a href="#l6.321"></a><span id="l6.321" class="difflineplus">+  return NS_OK;</span>
<a href="#l6.322"></a><span id="l6.322" class="difflineplus">+}</span>
<a href="#l6.323"></a><span id="l6.323" class="difflineplus">+</span>
<a href="#l6.324"></a><span id="l6.324" class="difflineplus">+nsresult</span>
<a href="#l6.325"></a><span id="l6.325" class="difflineplus">+nsBeckyFilters::GetFolderNameFromTarget(const nsCString &amp;aTarget, nsAString &amp;aName)</span>
<a href="#l6.326"></a><span id="l6.326" class="difflineplus">+{</span>
<a href="#l6.327"></a><span id="l6.327" class="difflineplus">+  int32_t backslashPosition = aTarget.RFindChar('\\');</span>
<a href="#l6.328"></a><span id="l6.328" class="difflineplus">+  if (backslashPosition &gt; 0) {</span>
<a href="#l6.329"></a><span id="l6.329" class="difflineplus">+    NS_ConvertUTF8toUTF16 utf16String(Substring(aTarget, backslashPosition + 1));</span>
<a href="#l6.330"></a><span id="l6.330" class="difflineplus">+    nsBeckyUtils::TranslateFolderName(utf16String, aName);</span>
<a href="#l6.331"></a><span id="l6.331" class="difflineplus">+  }</span>
<a href="#l6.332"></a><span id="l6.332" class="difflineplus">+</span>
<a href="#l6.333"></a><span id="l6.333" class="difflineplus">+  return NS_OK;</span>
<a href="#l6.334"></a><span id="l6.334" class="difflineplus">+}</span>
<a href="#l6.335"></a><span id="l6.335" class="difflineplus">+</span>
<a href="#l6.336"></a><span id="l6.336" class="difflineplus">+nsresult</span>
<a href="#l6.337"></a><span id="l6.337" class="difflineplus">+nsBeckyFilters::GetDistributeTarget(const nsCString &amp;aLine,</span>
<a href="#l6.338"></a><span id="l6.338" class="difflineplus">+                                    nsCString &amp;aTargetFolder)</span>
<a href="#l6.339"></a><span id="l6.339" class="difflineplus">+{</span>
<a href="#l6.340"></a><span id="l6.340" class="difflineplus">+  nsresult rv;</span>
<a href="#l6.341"></a><span id="l6.341" class="difflineplus">+  nsAutoCString target;</span>
<a href="#l6.342"></a><span id="l6.342" class="difflineplus">+  rv = GetActionTarget(aLine, target);</span>
<a href="#l6.343"></a><span id="l6.343" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.344"></a><span id="l6.344" class="difflineplus">+</span>
<a href="#l6.345"></a><span id="l6.345" class="difflineplus">+  target.Trim(&quot;\\&quot;, false, true);</span>
<a href="#l6.346"></a><span id="l6.346" class="difflineplus">+  nsAutoString folderName;</span>
<a href="#l6.347"></a><span id="l6.347" class="difflineplus">+  rv = GetFolderNameFromTarget(target, folderName);</span>
<a href="#l6.348"></a><span id="l6.348" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.349"></a><span id="l6.349" class="difflineplus">+</span>
<a href="#l6.350"></a><span id="l6.350" class="difflineplus">+  nsCOMPtr &lt;nsIMsgFolder&gt; folder;</span>
<a href="#l6.351"></a><span id="l6.351" class="difflineplus">+  rv = GetMessageFolder(folderName, getter_AddRefs(folder));</span>
<a href="#l6.352"></a><span id="l6.352" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.353"></a><span id="l6.353" class="difflineplus">+</span>
<a href="#l6.354"></a><span id="l6.354" class="difflineplus">+  if (!folder) {</span>
<a href="#l6.355"></a><span id="l6.355" class="difflineplus">+    rv = mServer-&gt;GetRootMsgFolder(getter_AddRefs(folder));</span>
<a href="#l6.356"></a><span id="l6.356" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.357"></a><span id="l6.357" class="difflineplus">+  }</span>
<a href="#l6.358"></a><span id="l6.358" class="difflineplus">+  return folder-&gt;GetURI(aTargetFolder);</span>
<a href="#l6.359"></a><span id="l6.359" class="difflineplus">+}</span>
<a href="#l6.360"></a><span id="l6.360" class="difflineplus">+</span>
<a href="#l6.361"></a><span id="l6.361" class="difflineplus">+nsresult</span>
<a href="#l6.362"></a><span id="l6.362" class="difflineplus">+nsBeckyFilters::CreateDistributeAction(const nsCString &amp;aLine,</span>
<a href="#l6.363"></a><span id="l6.363" class="difflineplus">+                                       nsIMsgFilter *aFilter,</span>
<a href="#l6.364"></a><span id="l6.364" class="difflineplus">+                                       const nsMsgRuleActionType &amp;aActionType,</span>
<a href="#l6.365"></a><span id="l6.365" class="difflineplus">+                                       nsIMsgRuleAction **_retval)</span>
<a href="#l6.366"></a><span id="l6.366" class="difflineplus">+{</span>
<a href="#l6.367"></a><span id="l6.367" class="difflineplus">+  nsresult rv;</span>
<a href="#l6.368"></a><span id="l6.368" class="difflineplus">+  nsCOMPtr&lt;nsIMsgRuleAction&gt; action;</span>
<a href="#l6.369"></a><span id="l6.369" class="difflineplus">+  rv = CreateRuleAction(aFilter, aActionType, getter_AddRefs(action));</span>
<a href="#l6.370"></a><span id="l6.370" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.371"></a><span id="l6.371" class="difflineplus">+  nsAutoCString targetFolder;</span>
<a href="#l6.372"></a><span id="l6.372" class="difflineplus">+  rv = GetDistributeTarget(aLine, targetFolder);</span>
<a href="#l6.373"></a><span id="l6.373" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.374"></a><span id="l6.374" class="difflineplus">+  rv = action-&gt;SetTargetFolderUri(targetFolder);</span>
<a href="#l6.375"></a><span id="l6.375" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.376"></a><span id="l6.376" class="difflineplus">+</span>
<a href="#l6.377"></a><span id="l6.377" class="difflineplus">+  action.forget(_retval);</span>
<a href="#l6.378"></a><span id="l6.378" class="difflineplus">+</span>
<a href="#l6.379"></a><span id="l6.379" class="difflineplus">+  return NS_OK;</span>
<a href="#l6.380"></a><span id="l6.380" class="difflineplus">+}</span>
<a href="#l6.381"></a><span id="l6.381" class="difflineplus">+</span>
<a href="#l6.382"></a><span id="l6.382" class="difflineplus">+nsresult</span>
<a href="#l6.383"></a><span id="l6.383" class="difflineplus">+nsBeckyFilters::CreateLeaveOrDeleteAction(const nsCString &amp;aLine,</span>
<a href="#l6.384"></a><span id="l6.384" class="difflineplus">+                                          nsIMsgFilter *aFilter,</span>
<a href="#l6.385"></a><span id="l6.385" class="difflineplus">+                                          nsIMsgRuleAction **_retval)</span>
<a href="#l6.386"></a><span id="l6.386" class="difflineplus">+{</span>
<a href="#l6.387"></a><span id="l6.387" class="difflineplus">+  nsresult rv;</span>
<a href="#l6.388"></a><span id="l6.388" class="difflineplus">+  nsMsgRuleActionType actionType;</span>
<a href="#l6.389"></a><span id="l6.389" class="difflineplus">+  if (aLine.CharAt(3) == '0') {</span>
<a href="#l6.390"></a><span id="l6.390" class="difflineplus">+    actionType = nsMsgFilterAction::LeaveOnPop3Server;</span>
<a href="#l6.391"></a><span id="l6.391" class="difflineplus">+  } else if (aLine.CharAt(3) == '1') {</span>
<a href="#l6.392"></a><span id="l6.392" class="difflineplus">+    if (aLine.CharAt(5) == '1')</span>
<a href="#l6.393"></a><span id="l6.393" class="difflineplus">+      actionType = nsMsgFilterAction::Delete;</span>
<a href="#l6.394"></a><span id="l6.394" class="difflineplus">+    else</span>
<a href="#l6.395"></a><span id="l6.395" class="difflineplus">+      actionType = nsMsgFilterAction::DeleteFromPop3Server;</span>
<a href="#l6.396"></a><span id="l6.396" class="difflineplus">+  } else {</span>
<a href="#l6.397"></a><span id="l6.397" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l6.398"></a><span id="l6.398" class="difflineplus">+  }</span>
<a href="#l6.399"></a><span id="l6.399" class="difflineplus">+  nsCOMPtr&lt;nsIMsgRuleAction&gt; action;</span>
<a href="#l6.400"></a><span id="l6.400" class="difflineplus">+  rv = CreateRuleAction(aFilter, actionType, getter_AddRefs(action));</span>
<a href="#l6.401"></a><span id="l6.401" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.402"></a><span id="l6.402" class="difflineplus">+</span>
<a href="#l6.403"></a><span id="l6.403" class="difflineplus">+  action.forget(_retval);</span>
<a href="#l6.404"></a><span id="l6.404" class="difflineplus">+</span>
<a href="#l6.405"></a><span id="l6.405" class="difflineplus">+  return NS_OK;</span>
<a href="#l6.406"></a><span id="l6.406" class="difflineplus">+}</span>
<a href="#l6.407"></a><span id="l6.407" class="difflineplus">+</span>
<a href="#l6.408"></a><span id="l6.408" class="difflineplus">+nsresult</span>
<a href="#l6.409"></a><span id="l6.409" class="difflineplus">+nsBeckyFilters::SetRuleAction(const nsCString &amp;aLine, nsIMsgFilter *aFilter)</span>
<a href="#l6.410"></a><span id="l6.410" class="difflineplus">+{</span>
<a href="#l6.411"></a><span id="l6.411" class="difflineplus">+  if (!aFilter || aLine.Length() &lt; 4)</span>
<a href="#l6.412"></a><span id="l6.412" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l6.413"></a><span id="l6.413" class="difflineplus">+</span>
<a href="#l6.414"></a><span id="l6.414" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l6.415"></a><span id="l6.415" class="difflineplus">+  nsCOMPtr&lt;nsIMsgRuleAction&gt; action;</span>
<a href="#l6.416"></a><span id="l6.416" class="difflineplus">+  switch (aLine.CharAt(1)) {</span>
<a href="#l6.417"></a><span id="l6.417" class="difflineplus">+    case 'R': // Reply</span>
<a href="#l6.418"></a><span id="l6.418" class="difflineplus">+      rv = CreateResendAction(aLine,</span>
<a href="#l6.419"></a><span id="l6.419" class="difflineplus">+                              aFilter,</span>
<a href="#l6.420"></a><span id="l6.420" class="difflineplus">+                              nsMsgFilterAction::Reply,</span>
<a href="#l6.421"></a><span id="l6.421" class="difflineplus">+                              getter_AddRefs(action));</span>
<a href="#l6.422"></a><span id="l6.422" class="difflineplus">+      break;</span>
<a href="#l6.423"></a><span id="l6.423" class="difflineplus">+    case 'F': // Forward</span>
<a href="#l6.424"></a><span id="l6.424" class="difflineplus">+      rv = CreateResendAction(aLine,</span>
<a href="#l6.425"></a><span id="l6.425" class="difflineplus">+                              aFilter,</span>
<a href="#l6.426"></a><span id="l6.426" class="difflineplus">+                              nsMsgFilterAction::Forward,</span>
<a href="#l6.427"></a><span id="l6.427" class="difflineplus">+                              getter_AddRefs(action));</span>
<a href="#l6.428"></a><span id="l6.428" class="difflineplus">+      break;</span>
<a href="#l6.429"></a><span id="l6.429" class="difflineplus">+    case 'L': // Leave or delete</span>
<a href="#l6.430"></a><span id="l6.430" class="difflineplus">+      rv = CreateLeaveOrDeleteAction(aLine, aFilter, getter_AddRefs(action));</span>
<a href="#l6.431"></a><span id="l6.431" class="difflineplus">+      break;</span>
<a href="#l6.432"></a><span id="l6.432" class="difflineplus">+    case 'Y': // Copy</span>
<a href="#l6.433"></a><span id="l6.433" class="difflineplus">+      rv = CreateDistributeAction(aLine,</span>
<a href="#l6.434"></a><span id="l6.434" class="difflineplus">+                                  aFilter,</span>
<a href="#l6.435"></a><span id="l6.435" class="difflineplus">+                                  nsMsgFilterAction::CopyToFolder,</span>
<a href="#l6.436"></a><span id="l6.436" class="difflineplus">+                                  getter_AddRefs(action));</span>
<a href="#l6.437"></a><span id="l6.437" class="difflineplus">+      break;</span>
<a href="#l6.438"></a><span id="l6.438" class="difflineplus">+    case 'M': // Move</span>
<a href="#l6.439"></a><span id="l6.439" class="difflineplus">+      rv = CreateDistributeAction(aLine,</span>
<a href="#l6.440"></a><span id="l6.440" class="difflineplus">+                                  aFilter,</span>
<a href="#l6.441"></a><span id="l6.441" class="difflineplus">+                                  nsMsgFilterAction::MoveToFolder,</span>
<a href="#l6.442"></a><span id="l6.442" class="difflineplus">+                                  getter_AddRefs(action));</span>
<a href="#l6.443"></a><span id="l6.443" class="difflineplus">+      break;</span>
<a href="#l6.444"></a><span id="l6.444" class="difflineplus">+    case 'G': // Set flag</span>
<a href="#l6.445"></a><span id="l6.445" class="difflineplus">+      if (aLine.CharAt(3) == 'R') // Read</span>
<a href="#l6.446"></a><span id="l6.446" class="difflineplus">+        rv = CreateRuleAction(aFilter, nsMsgFilterAction::MarkRead, getter_AddRefs(action));</span>
<a href="#l6.447"></a><span id="l6.447" class="difflineplus">+      break;</span>
<a href="#l6.448"></a><span id="l6.448" class="difflineplus">+    default:</span>
<a href="#l6.449"></a><span id="l6.449" class="difflineplus">+      return NS_OK;</span>
<a href="#l6.450"></a><span id="l6.450" class="difflineplus">+  }</span>
<a href="#l6.451"></a><span id="l6.451" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.452"></a><span id="l6.452" class="difflineplus">+</span>
<a href="#l6.453"></a><span id="l6.453" class="difflineplus">+  if (action) {</span>
<a href="#l6.454"></a><span id="l6.454" class="difflineplus">+    rv = aFilter-&gt;AppendAction(action);</span>
<a href="#l6.455"></a><span id="l6.455" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.456"></a><span id="l6.456" class="difflineplus">+  }</span>
<a href="#l6.457"></a><span id="l6.457" class="difflineplus">+</span>
<a href="#l6.458"></a><span id="l6.458" class="difflineplus">+  return NS_OK;</span>
<a href="#l6.459"></a><span id="l6.459" class="difflineplus">+}</span>
<a href="#l6.460"></a><span id="l6.460" class="difflineplus">+</span>
<a href="#l6.461"></a><span id="l6.461" class="difflineplus">+nsresult</span>
<a href="#l6.462"></a><span id="l6.462" class="difflineplus">+nsBeckyFilters::CreateFilter(nsIMsgFilter **_retval)</span>
<a href="#l6.463"></a><span id="l6.463" class="difflineplus">+{</span>
<a href="#l6.464"></a><span id="l6.464" class="difflineplus">+  NS_ENSURE_STATE(mServer);</span>
<a href="#l6.465"></a><span id="l6.465" class="difflineplus">+</span>
<a href="#l6.466"></a><span id="l6.466" class="difflineplus">+  nsCOMPtr &lt;nsIMsgFilterList&gt; filterList;</span>
<a href="#l6.467"></a><span id="l6.467" class="difflineplus">+  nsresult rv = mServer-&gt;GetFilterList(nullptr, getter_AddRefs(filterList));</span>
<a href="#l6.468"></a><span id="l6.468" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.469"></a><span id="l6.469" class="difflineplus">+</span>
<a href="#l6.470"></a><span id="l6.470" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFilter&gt; filter;</span>
<a href="#l6.471"></a><span id="l6.471" class="difflineplus">+  rv = filterList-&gt;CreateFilter(EmptyString(), getter_AddRefs(filter));</span>
<a href="#l6.472"></a><span id="l6.472" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.473"></a><span id="l6.473" class="difflineplus">+</span>
<a href="#l6.474"></a><span id="l6.474" class="difflineplus">+  filter-&gt;SetEnabled(true);</span>
<a href="#l6.475"></a><span id="l6.475" class="difflineplus">+  filter.forget(_retval);</span>
<a href="#l6.476"></a><span id="l6.476" class="difflineplus">+</span>
<a href="#l6.477"></a><span id="l6.477" class="difflineplus">+  return NS_OK;</span>
<a href="#l6.478"></a><span id="l6.478" class="difflineplus">+}</span>
<a href="#l6.479"></a><span id="l6.479" class="difflineplus">+</span>
<a href="#l6.480"></a><span id="l6.480" class="difflineplus">+nsresult</span>
<a href="#l6.481"></a><span id="l6.481" class="difflineplus">+nsBeckyFilters::AppendFilter(nsIMsgFilter *aFilter)</span>
<a href="#l6.482"></a><span id="l6.482" class="difflineplus">+{</span>
<a href="#l6.483"></a><span id="l6.483" class="difflineplus">+  NS_ENSURE_STATE(mServer);</span>
<a href="#l6.484"></a><span id="l6.484" class="difflineplus">+</span>
<a href="#l6.485"></a><span id="l6.485" class="difflineplus">+  nsCOMPtr &lt;nsIMsgFilterList&gt; filterList;</span>
<a href="#l6.486"></a><span id="l6.486" class="difflineplus">+  nsresult rv = mServer-&gt;GetFilterList(nullptr, getter_AddRefs(filterList));</span>
<a href="#l6.487"></a><span id="l6.487" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.488"></a><span id="l6.488" class="difflineplus">+</span>
<a href="#l6.489"></a><span id="l6.489" class="difflineplus">+  uint32_t count;</span>
<a href="#l6.490"></a><span id="l6.490" class="difflineplus">+  rv = filterList-&gt;GetFilterCount(&amp;count);</span>
<a href="#l6.491"></a><span id="l6.491" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.492"></a><span id="l6.492" class="difflineplus">+</span>
<a href="#l6.493"></a><span id="l6.493" class="difflineplus">+  return filterList-&gt;InsertFilterAt(count, aFilter);</span>
<a href="#l6.494"></a><span id="l6.494" class="difflineplus">+}</span>
<a href="#l6.495"></a><span id="l6.495" class="difflineplus">+</span>
<a href="#l6.496"></a><span id="l6.496" class="difflineplus">+nsresult</span>
<a href="#l6.497"></a><span id="l6.497" class="difflineplus">+nsBeckyFilters::ParseFilterFile(nsIFile *aFile)</span>
<a href="#l6.498"></a><span id="l6.498" class="difflineplus">+{</span>
<a href="#l6.499"></a><span id="l6.499" class="difflineplus">+  nsresult rv;</span>
<a href="#l6.500"></a><span id="l6.500" class="difflineplus">+  nsCOMPtr&lt;nsILineInputStream&gt; lineStream;</span>
<a href="#l6.501"></a><span id="l6.501" class="difflineplus">+  rv = nsBeckyUtils::CreateLineInputStream(aFile, getter_AddRefs(lineStream));</span>
<a href="#l6.502"></a><span id="l6.502" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.503"></a><span id="l6.503" class="difflineplus">+</span>
<a href="#l6.504"></a><span id="l6.504" class="difflineplus">+  bool more = true;</span>
<a href="#l6.505"></a><span id="l6.505" class="difflineplus">+  nsAutoCString line;</span>
<a href="#l6.506"></a><span id="l6.506" class="difflineplus">+</span>
<a href="#l6.507"></a><span id="l6.507" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFilter&gt; filter;</span>
<a href="#l6.508"></a><span id="l6.508" class="difflineplus">+  while (NS_SUCCEEDED(rv) &amp;&amp; more) {</span>
<a href="#l6.509"></a><span id="l6.509" class="difflineplus">+    rv = lineStream-&gt;ReadLine(line, &amp;more);</span>
<a href="#l6.510"></a><span id="l6.510" class="difflineplus">+</span>
<a href="#l6.511"></a><span id="l6.511" class="difflineplus">+    switch (line.CharAt(0)) {</span>
<a href="#l6.512"></a><span id="l6.512" class="difflineplus">+      case ':':</span>
<a href="#l6.513"></a><span id="l6.513" class="difflineplus">+        if (line.EqualsLiteral(&quot;:Begin \&quot;\&quot;&quot;)) {</span>
<a href="#l6.514"></a><span id="l6.514" class="difflineplus">+          CreateFilter(getter_AddRefs(filter));</span>
<a href="#l6.515"></a><span id="l6.515" class="difflineplus">+        } else if (line.EqualsLiteral(&quot;:End \&quot;\&quot;&quot;)) {</span>
<a href="#l6.516"></a><span id="l6.516" class="difflineplus">+          if (filter)</span>
<a href="#l6.517"></a><span id="l6.517" class="difflineplus">+            AppendFilter(filter);</span>
<a href="#l6.518"></a><span id="l6.518" class="difflineplus">+          filter = nullptr;</span>
<a href="#l6.519"></a><span id="l6.519" class="difflineplus">+        }</span>
<a href="#l6.520"></a><span id="l6.520" class="difflineplus">+        break;</span>
<a href="#l6.521"></a><span id="l6.521" class="difflineplus">+      case '!':</span>
<a href="#l6.522"></a><span id="l6.522" class="difflineplus">+        SetRuleAction(line, filter);</span>
<a href="#l6.523"></a><span id="l6.523" class="difflineplus">+        break;</span>
<a href="#l6.524"></a><span id="l6.524" class="difflineplus">+      case '@':</span>
<a href="#l6.525"></a><span id="l6.525" class="difflineplus">+        SetSearchTerm(line, filter);</span>
<a href="#l6.526"></a><span id="l6.526" class="difflineplus">+        break;</span>
<a href="#l6.527"></a><span id="l6.527" class="difflineplus">+      case '$': // $X: disabled</span>
<a href="#l6.528"></a><span id="l6.528" class="difflineplus">+        if (StringBeginsWith(line, NS_LITERAL_CSTRING(&quot;$X&quot;)) &amp;&amp; filter) {</span>
<a href="#l6.529"></a><span id="l6.529" class="difflineplus">+          filter-&gt;SetEnabled(false);</span>
<a href="#l6.530"></a><span id="l6.530" class="difflineplus">+        }</span>
<a href="#l6.531"></a><span id="l6.531" class="difflineplus">+        break;</span>
<a href="#l6.532"></a><span id="l6.532" class="difflineplus">+      default:</span>
<a href="#l6.533"></a><span id="l6.533" class="difflineplus">+        break;</span>
<a href="#l6.534"></a><span id="l6.534" class="difflineplus">+    }</span>
<a href="#l6.535"></a><span id="l6.535" class="difflineplus">+  }</span>
<a href="#l6.536"></a><span id="l6.536" class="difflineplus">+</span>
<a href="#l6.537"></a><span id="l6.537" class="difflineplus">+  return NS_OK;</span>
<a href="#l6.538"></a><span id="l6.538" class="difflineplus">+}</span>
<a href="#l6.539"></a><span id="l6.539" class="difflineplus">+</span>
<a href="#l6.540"></a><span id="l6.540" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l6.541"></a><span id="l6.541" class="difflineplus">+nsBeckyFilters::Import(char16_t **aError,</span>
<a href="#l6.542"></a><span id="l6.542" class="difflineplus">+                       bool *_retval)</span>
<a href="#l6.543"></a><span id="l6.543" class="difflineplus">+{</span>
<a href="#l6.544"></a><span id="l6.544" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aError);</span>
<a href="#l6.545"></a><span id="l6.545" class="difflineplus">+  NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l6.546"></a><span id="l6.546" class="difflineplus">+</span>
<a href="#l6.547"></a><span id="l6.547" class="difflineplus">+  *_retval = false;</span>
<a href="#l6.548"></a><span id="l6.548" class="difflineplus">+</span>
<a href="#l6.549"></a><span id="l6.549" class="difflineplus">+  nsresult rv;</span>
<a href="#l6.550"></a><span id="l6.550" class="difflineplus">+  if (!mLocation &amp;&amp; NS_FAILED(GetDefaultFilterFile(getter_AddRefs(mLocation))))</span>
<a href="#l6.551"></a><span id="l6.551" class="difflineplus">+    return NS_ERROR_FILE_NOT_FOUND;</span>
<a href="#l6.552"></a><span id="l6.552" class="difflineplus">+</span>
<a href="#l6.553"></a><span id="l6.553" class="difflineplus">+  rv = CollectServers();</span>
<a href="#l6.554"></a><span id="l6.554" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.555"></a><span id="l6.555" class="difflineplus">+</span>
<a href="#l6.556"></a><span id="l6.556" class="difflineplus">+  rv = nsBeckyUtils::ConvertToUTF8File(mLocation, getter_AddRefs(mConvertedFile));</span>
<a href="#l6.557"></a><span id="l6.557" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.558"></a><span id="l6.558" class="difflineplus">+</span>
<a href="#l6.559"></a><span id="l6.559" class="difflineplus">+  rv = ParseFilterFile(mConvertedFile);</span>
<a href="#l6.560"></a><span id="l6.560" class="difflineplus">+  if (NS_SUCCEEDED(rv))</span>
<a href="#l6.561"></a><span id="l6.561" class="difflineplus">+    *_retval = true;</span>
<a href="#l6.562"></a><span id="l6.562" class="difflineplus">+</span>
<a href="#l6.563"></a><span id="l6.563" class="difflineplus">+  RemoveConvertedFile();</span>
<a href="#l6.564"></a><span id="l6.564" class="difflineplus">+</span>
<a href="#l6.565"></a><span id="l6.565" class="difflineplus">+  return rv;</span>
<a href="#l6.566"></a><span id="l6.566" class="difflineplus">+}</span>
<a href="#l6.567"></a><span id="l6.567" class="difflineplus">+</span>
<a href="#l6.568"></a><span id="l6.568" class="difflineplus">+nsresult</span>
<a href="#l6.569"></a><span id="l6.569" class="difflineplus">+nsBeckyFilters::FindMessageFolder(const nsAString &amp;aName,</span>
<a href="#l6.570"></a><span id="l6.570" class="difflineplus">+                                  nsIMsgFolder *aParentFolder,</span>
<a href="#l6.571"></a><span id="l6.571" class="difflineplus">+                                  nsIMsgFolder **_retval)</span>
<a href="#l6.572"></a><span id="l6.572" class="difflineplus">+{</span>
<a href="#l6.573"></a><span id="l6.573" class="difflineplus">+  nsresult rv;</span>
<a href="#l6.574"></a><span id="l6.574" class="difflineplus">+</span>
<a href="#l6.575"></a><span id="l6.575" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; found;</span>
<a href="#l6.576"></a><span id="l6.576" class="difflineplus">+  rv = aParentFolder-&gt;GetChildNamed(aName, getter_AddRefs(found));</span>
<a href="#l6.577"></a><span id="l6.577" class="difflineplus">+  if (found) {</span>
<a href="#l6.578"></a><span id="l6.578" class="difflineplus">+    found.forget(_retval);</span>
<a href="#l6.579"></a><span id="l6.579" class="difflineplus">+    return NS_OK;</span>
<a href="#l6.580"></a><span id="l6.580" class="difflineplus">+  }</span>
<a href="#l6.581"></a><span id="l6.581" class="difflineplus">+</span>
<a href="#l6.582"></a><span id="l6.582" class="difflineplus">+  nsCOMPtr&lt;nsISimpleEnumerator&gt; children;</span>
<a href="#l6.583"></a><span id="l6.583" class="difflineplus">+  rv = aParentFolder-&gt;GetSubFolders(getter_AddRefs(children));</span>
<a href="#l6.584"></a><span id="l6.584" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.585"></a><span id="l6.585" class="difflineplus">+</span>
<a href="#l6.586"></a><span id="l6.586" class="difflineplus">+  bool more;</span>
<a href="#l6.587"></a><span id="l6.587" class="difflineplus">+  nsCOMPtr&lt;nsISupports&gt; entry;</span>
<a href="#l6.588"></a><span id="l6.588" class="difflineplus">+  while (NS_SUCCEEDED(children-&gt;HasMoreElements(&amp;more)) &amp;&amp; more) {</span>
<a href="#l6.589"></a><span id="l6.589" class="difflineplus">+    rv = children-&gt;GetNext(getter_AddRefs(entry));</span>
<a href="#l6.590"></a><span id="l6.590" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.591"></a><span id="l6.591" class="difflineplus">+</span>
<a href="#l6.592"></a><span id="l6.592" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFolder&gt; child = do_QueryInterface(entry, &amp;rv);</span>
<a href="#l6.593"></a><span id="l6.593" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.594"></a><span id="l6.594" class="difflineplus">+</span>
<a href="#l6.595"></a><span id="l6.595" class="difflineplus">+    rv = FindMessageFolder(aName, child, getter_AddRefs(found));</span>
<a href="#l6.596"></a><span id="l6.596" class="difflineplus">+    if (found) {</span>
<a href="#l6.597"></a><span id="l6.597" class="difflineplus">+      found.forget(_retval);</span>
<a href="#l6.598"></a><span id="l6.598" class="difflineplus">+      return NS_OK;</span>
<a href="#l6.599"></a><span id="l6.599" class="difflineplus">+    }</span>
<a href="#l6.600"></a><span id="l6.600" class="difflineplus">+  }</span>
<a href="#l6.601"></a><span id="l6.601" class="difflineplus">+</span>
<a href="#l6.602"></a><span id="l6.602" class="difflineplus">+  return NS_MSG_ERROR_INVALID_FOLDER_NAME;</span>
<a href="#l6.603"></a><span id="l6.603" class="difflineplus">+}</span>
<a href="#l6.604"></a><span id="l6.604" class="difflineplus">+</span>
<a href="#l6.605"></a><span id="l6.605" class="difflineplus">+nsresult</span>
<a href="#l6.606"></a><span id="l6.606" class="difflineplus">+nsBeckyFilters::FindMessageFolderInServer(const nsAString &amp;aName,</span>
<a href="#l6.607"></a><span id="l6.607" class="difflineplus">+                                          nsIMsgIncomingServer *aServer,</span>
<a href="#l6.608"></a><span id="l6.608" class="difflineplus">+                                          nsIMsgFolder **_retval)</span>
<a href="#l6.609"></a><span id="l6.609" class="difflineplus">+{</span>
<a href="#l6.610"></a><span id="l6.610" class="difflineplus">+  nsresult rv;</span>
<a href="#l6.611"></a><span id="l6.611" class="difflineplus">+  nsCOMPtr &lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l6.612"></a><span id="l6.612" class="difflineplus">+  rv = aServer-&gt;GetRootMsgFolder(getter_AddRefs(rootFolder));</span>
<a href="#l6.613"></a><span id="l6.613" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.614"></a><span id="l6.614" class="difflineplus">+</span>
<a href="#l6.615"></a><span id="l6.615" class="difflineplus">+  return FindMessageFolder(aName, rootFolder, _retval);</span>
<a href="#l6.616"></a><span id="l6.616" class="difflineplus">+}</span>
<a href="#l6.617"></a><span id="l6.617" class="difflineplus">+</span>
<a href="#l6.618"></a><span id="l6.618" class="difflineplus">+nsresult</span>
<a href="#l6.619"></a><span id="l6.619" class="difflineplus">+nsBeckyFilters::GetMessageFolder(const nsAString &amp;aName,</span>
<a href="#l6.620"></a><span id="l6.620" class="difflineplus">+                                 nsIMsgFolder **_retval)</span>
<a href="#l6.621"></a><span id="l6.621" class="difflineplus">+{</span>
<a href="#l6.622"></a><span id="l6.622" class="difflineplus">+  nsresult rv;</span>
<a href="#l6.623"></a><span id="l6.623" class="difflineplus">+</span>
<a href="#l6.624"></a><span id="l6.624" class="difflineplus">+  nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager;</span>
<a href="#l6.625"></a><span id="l6.625" class="difflineplus">+  accountManager = do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l6.626"></a><span id="l6.626" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.627"></a><span id="l6.627" class="difflineplus">+</span>
<a href="#l6.628"></a><span id="l6.628" class="difflineplus">+  nsCOMPtr&lt;nsIArray&gt; accounts;</span>
<a href="#l6.629"></a><span id="l6.629" class="difflineplus">+  rv = accountManager-&gt;GetAccounts(getter_AddRefs(accounts));</span>
<a href="#l6.630"></a><span id="l6.630" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.631"></a><span id="l6.631" class="difflineplus">+</span>
<a href="#l6.632"></a><span id="l6.632" class="difflineplus">+  uint32_t accountCount;</span>
<a href="#l6.633"></a><span id="l6.633" class="difflineplus">+  rv = accounts-&gt;GetLength(&amp;accountCount);</span>
<a href="#l6.634"></a><span id="l6.634" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.635"></a><span id="l6.635" class="difflineplus">+</span>
<a href="#l6.636"></a><span id="l6.636" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; found;</span>
<a href="#l6.637"></a><span id="l6.637" class="difflineplus">+  for (uint32_t i = 0; i &lt; accountCount; i++) {</span>
<a href="#l6.638"></a><span id="l6.638" class="difflineplus">+    nsCOMPtr&lt;nsIMsgAccount&gt; account(do_QueryElementAt(accounts, i));</span>
<a href="#l6.639"></a><span id="l6.639" class="difflineplus">+    if (!account)</span>
<a href="#l6.640"></a><span id="l6.640" class="difflineplus">+      continue;</span>
<a href="#l6.641"></a><span id="l6.641" class="difflineplus">+</span>
<a href="#l6.642"></a><span id="l6.642" class="difflineplus">+    nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l6.643"></a><span id="l6.643" class="difflineplus">+    account-&gt;GetIncomingServer(getter_AddRefs(server));</span>
<a href="#l6.644"></a><span id="l6.644" class="difflineplus">+    if (!server)</span>
<a href="#l6.645"></a><span id="l6.645" class="difflineplus">+      continue;</span>
<a href="#l6.646"></a><span id="l6.646" class="difflineplus">+    FindMessageFolderInServer(aName, server, getter_AddRefs(found));</span>
<a href="#l6.647"></a><span id="l6.647" class="difflineplus">+    if (found)</span>
<a href="#l6.648"></a><span id="l6.648" class="difflineplus">+      break;</span>
<a href="#l6.649"></a><span id="l6.649" class="difflineplus">+  }</span>
<a href="#l6.650"></a><span id="l6.650" class="difflineplus">+</span>
<a href="#l6.651"></a><span id="l6.651" class="difflineplus">+  if (!found) {</span>
<a href="#l6.652"></a><span id="l6.652" class="difflineplus">+    nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l6.653"></a><span id="l6.653" class="difflineplus">+    rv = accountManager-&gt;GetLocalFoldersServer(getter_AddRefs(server));</span>
<a href="#l6.654"></a><span id="l6.654" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.655"></a><span id="l6.655" class="difflineplus">+</span>
<a href="#l6.656"></a><span id="l6.656" class="difflineplus">+    FindMessageFolderInServer(aName, server, getter_AddRefs(found));</span>
<a href="#l6.657"></a><span id="l6.657" class="difflineplus">+  }</span>
<a href="#l6.658"></a><span id="l6.658" class="difflineplus">+</span>
<a href="#l6.659"></a><span id="l6.659" class="difflineplus">+  if (!found)</span>
<a href="#l6.660"></a><span id="l6.660" class="difflineplus">+    return NS_MSG_ERROR_INVALID_FOLDER_NAME;</span>
<a href="#l6.661"></a><span id="l6.661" class="difflineplus">+</span>
<a href="#l6.662"></a><span id="l6.662" class="difflineplus">+  found.forget(_retval);</span>
<a href="#l6.663"></a><span id="l6.663" class="difflineplus">+</span>
<a href="#l6.664"></a><span id="l6.664" class="difflineplus">+  return NS_OK;</span>
<a href="#l6.665"></a><span id="l6.665" class="difflineplus">+}</span>
<a href="#l6.666"></a><span id="l6.666" class="difflineplus">+</span>
<a href="#l6.667"></a><span id="l6.667" class="difflineplus">+nsresult</span>
<a href="#l6.668"></a><span id="l6.668" class="difflineplus">+nsBeckyFilters::CollectServers()</span>
<a href="#l6.669"></a><span id="l6.669" class="difflineplus">+{</span>
<a href="#l6.670"></a><span id="l6.670" class="difflineplus">+  nsresult rv;</span>
<a href="#l6.671"></a><span id="l6.671" class="difflineplus">+  nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager;</span>
<a href="#l6.672"></a><span id="l6.672" class="difflineplus">+  accountManager = do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l6.673"></a><span id="l6.673" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.674"></a><span id="l6.674" class="difflineplus">+</span>
<a href="#l6.675"></a><span id="l6.675" class="difflineplus">+  nsCOMPtr&lt;nsIMsgAccount&gt; defaultAccount;</span>
<a href="#l6.676"></a><span id="l6.676" class="difflineplus">+  rv = accountManager-&gt;GetDefaultAccount(getter_AddRefs(defaultAccount));</span>
<a href="#l6.677"></a><span id="l6.677" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.678"></a><span id="l6.678" class="difflineplus">+</span>
<a href="#l6.679"></a><span id="l6.679" class="difflineplus">+  nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l6.680"></a><span id="l6.680" class="difflineplus">+  return defaultAccount-&gt;GetIncomingServer(getter_AddRefs(mServer));</span>
<a href="#l6.681"></a><span id="l6.681" class="difflineplus">+}</span>
<a href="#l6.682"></a><span id="l6.682" class="difflineplus">+</span>
<a href="#l6.683"></a><span id="l6.683" class="difflineplus">+nsresult</span>
<a href="#l6.684"></a><span id="l6.684" class="difflineplus">+nsBeckyFilters::RemoveConvertedFile()</span>
<a href="#l6.685"></a><span id="l6.685" class="difflineplus">+{</span>
<a href="#l6.686"></a><span id="l6.686" class="difflineplus">+  if (mConvertedFile) {</span>
<a href="#l6.687"></a><span id="l6.687" class="difflineplus">+    bool exists;</span>
<a href="#l6.688"></a><span id="l6.688" class="difflineplus">+    mConvertedFile-&gt;Exists(&amp;exists);</span>
<a href="#l6.689"></a><span id="l6.689" class="difflineplus">+    if (exists)</span>
<a href="#l6.690"></a><span id="l6.690" class="difflineplus">+      mConvertedFile-&gt;Remove(false);</span>
<a href="#l6.691"></a><span id="l6.691" class="difflineplus">+    mConvertedFile = nullptr;</span>
<a href="#l6.692"></a><span id="l6.692" class="difflineplus">+  }</span>
<a href="#l6.693"></a><span id="l6.693" class="difflineplus">+  return NS_OK;</span>
<a href="#l6.694"></a><span id="l6.694" class="difflineplus">+}</span>
<a href="#l6.695"></a><span id="l6.695" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1">new file mode 100644</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineminus">--- /dev/null</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineplus">+++ b/mailnews/import/becky/src/nsBeckyFilters.h</span>
<a href="#l7.4"></a><span id="l7.4" class="difflineat">@@ -0,0 +1,76 @@</span>
<a href="#l7.5"></a><span id="l7.5" class="difflineplus">+/* vim: set ts=2 et sw=2 tw=80: */</span>
<a href="#l7.6"></a><span id="l7.6" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l7.7"></a><span id="l7.7" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l7.8"></a><span id="l7.8" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l7.9"></a><span id="l7.9" class="difflineplus">+</span>
<a href="#l7.10"></a><span id="l7.10" class="difflineplus">+#ifndef nsBeckyFilters_h___</span>
<a href="#l7.11"></a><span id="l7.11" class="difflineplus">+#define nsBeckyFilters_h___</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+#include &quot;nsIImportFilters.h&quot;</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+#include &quot;nsIFile.h&quot;</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+#include &quot;nsIMsgIncomingServer.h&quot;</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+#include &quot;nsMsgFilterCore.h&quot;</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+class nsIMsgFilter;</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+class nsIMsgRuleAction;</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+class nsCString;</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineplus">+</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineplus">+class nsBeckyFilters final : public nsIImportFilters</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineplus">+{</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineplus">+public:</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineplus">+  nsBeckyFilters();</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineplus">+  static nsresult Create(nsIImportFilters **aImport);</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineplus">+</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineplus">+  NS_DECL_NSIIMPORTFILTERS</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineplus">+</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineplus">+private:</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+  virtual ~nsBeckyFilters();</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineplus">+</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; mLocation;</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineplus">+  nsCOMPtr&lt;nsIMsgIncomingServer&gt; mServer;</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; mConvertedFile;</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineplus">+  nsresult GetDefaultFilterFile(nsIFile **aFile);</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineplus">+  nsresult ParseFilterFile(nsIFile *aFile);</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineplus">+  nsresult ParseRuleLine(const nsCString &amp;aLine,</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineplus">+                         nsMsgSearchAttribValue *aSearchAttribute,</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineplus">+                         nsMsgSearchOpValue *aSearchOperator,</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineplus">+                         nsString &amp;aSearchKeyword);</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineplus">+  nsresult CollectServers();</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineplus">+  nsresult FindMessageFolder(const nsAString&amp; aName,</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineplus">+                             nsIMsgFolder *aParantFolder,</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineplus">+                             nsIMsgFolder **_retval);</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineplus">+  nsresult FindMessageFolderInServer(const nsAString&amp; aName,</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineplus">+                                     nsIMsgIncomingServer *aServer,</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineplus">+                                     nsIMsgFolder **_retval);</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineplus">+  nsresult GetMessageFolder(const nsAString&amp; aName, nsIMsgFolder **_retval);</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineplus">+  nsresult GetActionTarget(const nsCString &amp;aLine, nsCString &amp;aTarget);</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineplus">+  nsresult GetFolderNameFromTarget(const nsCString &amp;aTarget, nsAString &amp;aName);</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineplus">+  nsresult GetDistributeTarget(const nsCString &amp;aLine,</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineplus">+                               nsCString &amp;aTargetFolder);</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineplus">+  nsresult GetResendTarget(const nsCString &amp;aLine,</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineplus">+                           nsCString &amp;aTemplate,</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineplus">+                           nsCString &amp;aTargetAddress);</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineplus">+  nsresult CreateRuleAction(nsIMsgFilter *aFilter,</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineplus">+                            nsMsgRuleActionType actionType,</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineplus">+                            nsIMsgRuleAction **_retval);</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineplus">+  nsresult CreateDistributeAction(const nsCString &amp;aLine,</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineplus">+                                  nsIMsgFilter *aFilter,</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineplus">+                                  const nsMsgRuleActionType &amp;aActionType,</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineplus">+                                  nsIMsgRuleAction **_retval);</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineplus">+  nsresult CreateLeaveOrDeleteAction(const nsCString &amp;aLine,</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineplus">+                                     nsIMsgFilter *aFilter,</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineplus">+                                     nsIMsgRuleAction **_retval);</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineplus">+  nsresult CreateResendAction(const nsCString &amp;aLine,</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineplus">+                              nsIMsgFilter *aFilter,</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineplus">+                              const nsMsgRuleActionType &amp;aActionType,</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineplus">+                              nsIMsgRuleAction **_retval);</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineplus">+  nsresult CreateFilter(nsIMsgFilter **_retval);</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineplus">+  nsresult AppendFilter(nsIMsgFilter *aFilter);</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineplus">+  nsresult SetRuleAction(const nsCString &amp;aLine, nsIMsgFilter *aFilter);</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineplus">+  nsresult SetSearchTerm(const nsCString &amp;aLine, nsIMsgFilter *aFilter);</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineplus">+  nsresult RemoveConvertedFile();</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineplus">+};</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineplus">+</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineplus">+#endif /* nsBeckyFilters_h___ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1">new file mode 100644</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineminus">--- /dev/null</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineplus">+++ b/mailnews/import/becky/src/nsBeckyImport.cpp</span>
<a href="#l8.4"></a><span id="l8.4" class="difflineat">@@ -0,0 +1,169 @@</span>
<a href="#l8.5"></a><span id="l8.5" class="difflineplus">+/* vim: set ts=2 et sw=2 tw=80: */</span>
<a href="#l8.6"></a><span id="l8.6" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l8.7"></a><span id="l8.7" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l8.8"></a><span id="l8.8" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l8.9"></a><span id="l8.9" class="difflineplus">+</span>
<a href="#l8.10"></a><span id="l8.10" class="difflineplus">+#include &quot;nscore.h&quot;</span>
<a href="#l8.11"></a><span id="l8.11" class="difflineplus">+#include &quot;nsIServiceManager.h&quot;</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+#include &quot;nsIImportService.h&quot;</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+#include &quot;nsIComponentManager.h&quot;</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+#include &quot;nsIMemory.h&quot;</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+#include &quot;nsIImportService.h&quot;</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+#include &quot;nsIImportMail.h&quot;</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+#include &quot;nsIImportMailboxDescriptor.h&quot;</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+#include &quot;nsIImportGeneric.h&quot;</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+#include &quot;nsIImportAddressBooks.h&quot;</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineplus">+#include &quot;nsIImportABDescriptor.h&quot;</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineplus">+#include &quot;nsIImportSettings.h&quot;</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineplus">+#include &quot;nsIImportFilters.h&quot;</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineplus">+#include &quot;nsIImportFieldMap.h&quot;</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+#include &quot;nsXPCOM.h&quot;</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineplus">+#include &quot;nsISupportsPrimitives.h&quot;</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineplus">+#include &quot;nsIOutputStream.h&quot;</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineplus">+#include &quot;nsIAddrDatabase.h&quot;</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineplus">+#include &quot;nsTextFormatter.h&quot;</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineplus">+#include &quot;nsIStringBundle.h&quot;</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineplus">+#include &quot;nsUnicharUtils.h&quot;</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineplus">+#include &quot;nsIMsgTagService.h&quot;</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+#include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineplus">+#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+#include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineplus">+#include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineplus">+</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineplus">+#include &quot;nsBeckyImport.h&quot;</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineplus">+#include &quot;nsBeckyMail.h&quot;</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineplus">+#include &quot;nsBeckyAddressBooks.h&quot;</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineplus">+#include &quot;nsBeckySettings.h&quot;</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineplus">+#include &quot;nsBeckyFilters.h&quot;</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineplus">+#include &quot;nsBeckyStringBundle.h&quot;</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineplus">+</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineplus">+nsBeckyImport::nsBeckyImport()</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineplus">+{</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineplus">+}</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineplus">+</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineplus">+nsBeckyImport::~nsBeckyImport()</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineplus">+{</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineplus">+}</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineplus">+NS_IMPL_ISUPPORTS(nsBeckyImport, nsIImportModule)</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineplus">+</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineplus">+nsBeckyImport::GetName(char16_t **aName)</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineplus">+{</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aName);</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineplus">+  *aName =</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineplus">+    nsBeckyStringBundle::GetStringByName(MOZ_UTF16(&quot;BeckyImportName&quot;));</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineplus">+  return NS_OK;</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineplus">+}</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineplus">+</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineplus">+nsBeckyImport::GetDescription(char16_t **aDescription)</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineplus">+{</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aDescription);</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineplus">+  *aDescription =</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineplus">+    nsBeckyStringBundle::GetStringByName(MOZ_UTF16(&quot;BeckyImportDescription&quot;));</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineplus">+  return NS_OK;</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineplus">+}</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineplus">+</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineplus">+nsBeckyImport::GetSupports(char **aSupports)</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineplus">+{</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aSupports);</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineplus">+  *aSupports = strdup(kBeckySupportsString);</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineplus">+  return NS_OK;</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineplus">+}</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineplus">+</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineplus">+nsBeckyImport::GetSupportsUpgrade(bool *aUpgrade)</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineplus">+{</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aUpgrade);</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineplus">+  *aUpgrade = true;</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineplus">+  return NS_OK;</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineplus">+}</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineplus">+</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineplus">+nsresult</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineplus">+nsBeckyImport::GetMailImportInterface(nsISupports **aInterface)</span>
<a href="#l8.90"></a><span id="l8.90" class="difflineplus">+{</span>
<a href="#l8.91"></a><span id="l8.91" class="difflineplus">+  nsCOMPtr&lt;nsIImportMail&gt; importer;</span>
<a href="#l8.92"></a><span id="l8.92" class="difflineplus">+  nsresult rv = nsBeckyMail::Create(getter_AddRefs(importer));</span>
<a href="#l8.93"></a><span id="l8.93" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.94"></a><span id="l8.94" class="difflineplus">+</span>
<a href="#l8.95"></a><span id="l8.95" class="difflineplus">+  nsCOMPtr&lt;nsIImportService&gt; importService(do_GetService(NS_IMPORTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l8.96"></a><span id="l8.96" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineplus">+  nsCOMPtr&lt;nsIImportGeneric&gt; generic;</span>
<a href="#l8.98"></a><span id="l8.98" class="difflineplus">+  rv = importService-&gt;CreateNewGenericMail(getter_AddRefs(generic));</span>
<a href="#l8.99"></a><span id="l8.99" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.100"></a><span id="l8.100" class="difflineplus">+</span>
<a href="#l8.101"></a><span id="l8.101" class="difflineplus">+  generic-&gt;SetData(&quot;mailInterface&quot;, importer);</span>
<a href="#l8.102"></a><span id="l8.102" class="difflineplus">+</span>
<a href="#l8.103"></a><span id="l8.103" class="difflineplus">+  nsString name;</span>
<a href="#l8.104"></a><span id="l8.104" class="difflineplus">+  name.Adopt(nsBeckyStringBundle::GetStringByName(MOZ_UTF16(&quot;BeckyImportName&quot;)));</span>
<a href="#l8.105"></a><span id="l8.105" class="difflineplus">+</span>
<a href="#l8.106"></a><span id="l8.106" class="difflineplus">+  nsCOMPtr&lt;nsISupportsString&gt; nameString(do_CreateInstance(NS_SUPPORTS_STRING_CONTRACTID, &amp;rv));</span>
<a href="#l8.107"></a><span id="l8.107" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.108"></a><span id="l8.108" class="difflineplus">+</span>
<a href="#l8.109"></a><span id="l8.109" class="difflineplus">+  nameString-&gt;SetData(name);</span>
<a href="#l8.110"></a><span id="l8.110" class="difflineplus">+  generic-&gt;SetData(&quot;name&quot;, nameString);</span>
<a href="#l8.111"></a><span id="l8.111" class="difflineplus">+</span>
<a href="#l8.112"></a><span id="l8.112" class="difflineplus">+  return CallQueryInterface(generic, aInterface);</span>
<a href="#l8.113"></a><span id="l8.113" class="difflineplus">+}</span>
<a href="#l8.114"></a><span id="l8.114" class="difflineplus">+</span>
<a href="#l8.115"></a><span id="l8.115" class="difflineplus">+nsresult</span>
<a href="#l8.116"></a><span id="l8.116" class="difflineplus">+nsBeckyImport::GetAddressBookImportInterface(nsISupports **aInterface)</span>
<a href="#l8.117"></a><span id="l8.117" class="difflineplus">+{</span>
<a href="#l8.118"></a><span id="l8.118" class="difflineplus">+  nsresult rv;</span>
<a href="#l8.119"></a><span id="l8.119" class="difflineplus">+  nsCOMPtr&lt;nsIImportAddressBooks&gt; importer;</span>
<a href="#l8.120"></a><span id="l8.120" class="difflineplus">+  rv = nsBeckyAddressBooks::Create(getter_AddRefs(importer));</span>
<a href="#l8.121"></a><span id="l8.121" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.122"></a><span id="l8.122" class="difflineplus">+</span>
<a href="#l8.123"></a><span id="l8.123" class="difflineplus">+  nsCOMPtr&lt;nsIImportService&gt; importService(do_GetService(NS_IMPORTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l8.124"></a><span id="l8.124" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.125"></a><span id="l8.125" class="difflineplus">+</span>
<a href="#l8.126"></a><span id="l8.126" class="difflineplus">+  nsCOMPtr&lt;nsIImportGeneric&gt; generic;</span>
<a href="#l8.127"></a><span id="l8.127" class="difflineplus">+  rv = importService-&gt;CreateNewGenericAddressBooks(getter_AddRefs(generic));</span>
<a href="#l8.128"></a><span id="l8.128" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.129"></a><span id="l8.129" class="difflineplus">+</span>
<a href="#l8.130"></a><span id="l8.130" class="difflineplus">+  generic-&gt;SetData(&quot;addressInterface&quot;, importer);</span>
<a href="#l8.131"></a><span id="l8.131" class="difflineplus">+  return CallQueryInterface(generic, aInterface);</span>
<a href="#l8.132"></a><span id="l8.132" class="difflineplus">+}</span>
<a href="#l8.133"></a><span id="l8.133" class="difflineplus">+</span>
<a href="#l8.134"></a><span id="l8.134" class="difflineplus">+nsresult</span>
<a href="#l8.135"></a><span id="l8.135" class="difflineplus">+nsBeckyImport::GetSettingsImportInterface(nsISupports **aInterface)</span>
<a href="#l8.136"></a><span id="l8.136" class="difflineplus">+{</span>
<a href="#l8.137"></a><span id="l8.137" class="difflineplus">+  nsresult rv;</span>
<a href="#l8.138"></a><span id="l8.138" class="difflineplus">+  nsCOMPtr&lt;nsIImportSettings&gt; importer;</span>
<a href="#l8.139"></a><span id="l8.139" class="difflineplus">+  rv = nsBeckySettings::Create(getter_AddRefs(importer));</span>
<a href="#l8.140"></a><span id="l8.140" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.141"></a><span id="l8.141" class="difflineplus">+</span>
<a href="#l8.142"></a><span id="l8.142" class="difflineplus">+  return CallQueryInterface(importer, aInterface);</span>
<a href="#l8.143"></a><span id="l8.143" class="difflineplus">+}</span>
<a href="#l8.144"></a><span id="l8.144" class="difflineplus">+</span>
<a href="#l8.145"></a><span id="l8.145" class="difflineplus">+nsresult</span>
<a href="#l8.146"></a><span id="l8.146" class="difflineplus">+nsBeckyImport::GetFiltersImportInterface(nsISupports **aInterface)</span>
<a href="#l8.147"></a><span id="l8.147" class="difflineplus">+{</span>
<a href="#l8.148"></a><span id="l8.148" class="difflineplus">+  nsresult rv;</span>
<a href="#l8.149"></a><span id="l8.149" class="difflineplus">+  nsCOMPtr&lt;nsIImportFilters&gt; importer;</span>
<a href="#l8.150"></a><span id="l8.150" class="difflineplus">+  rv = nsBeckyFilters::Create(getter_AddRefs(importer));</span>
<a href="#l8.151"></a><span id="l8.151" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.152"></a><span id="l8.152" class="difflineplus">+</span>
<a href="#l8.153"></a><span id="l8.153" class="difflineplus">+  return CallQueryInterface(importer, aInterface);</span>
<a href="#l8.154"></a><span id="l8.154" class="difflineplus">+}</span>
<a href="#l8.155"></a><span id="l8.155" class="difflineplus">+</span>
<a href="#l8.156"></a><span id="l8.156" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l8.157"></a><span id="l8.157" class="difflineplus">+nsBeckyImport::GetImportInterface(const char *aImportType, nsISupports **aInterface)</span>
<a href="#l8.158"></a><span id="l8.158" class="difflineplus">+{</span>
<a href="#l8.159"></a><span id="l8.159" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aImportType);</span>
<a href="#l8.160"></a><span id="l8.160" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aInterface);</span>
<a href="#l8.161"></a><span id="l8.161" class="difflineplus">+</span>
<a href="#l8.162"></a><span id="l8.162" class="difflineplus">+  *aInterface = nullptr;</span>
<a href="#l8.163"></a><span id="l8.163" class="difflineplus">+  if (!strcmp(aImportType, &quot;mail&quot;))</span>
<a href="#l8.164"></a><span id="l8.164" class="difflineplus">+    return GetMailImportInterface(aInterface);</span>
<a href="#l8.165"></a><span id="l8.165" class="difflineplus">+  if (!strcmp(aImportType, &quot;addressbook&quot;))</span>
<a href="#l8.166"></a><span id="l8.166" class="difflineplus">+    return GetAddressBookImportInterface(aInterface);</span>
<a href="#l8.167"></a><span id="l8.167" class="difflineplus">+  if (!strcmp(aImportType, &quot;settings&quot;))</span>
<a href="#l8.168"></a><span id="l8.168" class="difflineplus">+    return GetSettingsImportInterface(aInterface);</span>
<a href="#l8.169"></a><span id="l8.169" class="difflineplus">+  if (!strcmp(aImportType, &quot;filters&quot;))</span>
<a href="#l8.170"></a><span id="l8.170" class="difflineplus">+    return GetFiltersImportInterface(aInterface);</span>
<a href="#l8.171"></a><span id="l8.171" class="difflineplus">+</span>
<a href="#l8.172"></a><span id="l8.172" class="difflineplus">+  return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l8.173"></a><span id="l8.173" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1">new file mode 100644</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineminus">--- /dev/null</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineplus">+++ b/mailnews/import/becky/src/nsBeckyImport.h</span>
<a href="#l9.4"></a><span id="l9.4" class="difflineat">@@ -0,0 +1,36 @@</span>
<a href="#l9.5"></a><span id="l9.5" class="difflineplus">+/* vim: set ts=2 et sw=2 tw=80: */</span>
<a href="#l9.6"></a><span id="l9.6" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l9.7"></a><span id="l9.7" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l9.8"></a><span id="l9.8" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l9.9"></a><span id="l9.9" class="difflineplus">+</span>
<a href="#l9.10"></a><span id="l9.10" class="difflineplus">+#ifndef nsBeckyImport_h___</span>
<a href="#l9.11"></a><span id="l9.11" class="difflineplus">+#define nsBeckyImport_h___</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+#include &quot;nsIImportModule.h&quot;</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+#define NS_BECKYIMPORT_CID          \</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+{                                   \</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+  0x7952a6cf, 0x2442,0x4c04,        \</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+  {0x9f, 0x02, 0x15, 0x0b, 0x15, 0xa0, 0xa8, 0x41}}</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineplus">+</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineplus">+#define kBeckySupportsString NS_IMPORT_MAIL_STR &quot;,&quot; NS_IMPORT_ADDRESS_STR &quot;,&quot; NS_IMPORT_SETTINGS_STR &quot;,&quot; NS_IMPORT_FILTERS_STR</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineplus">+</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineplus">+class nsBeckyImport final : public nsIImportModule</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineplus">+{</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineplus">+public:</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineplus">+  nsBeckyImport();</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineplus">+</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineplus">+  NS_DECL_NSIIMPORTMODULE</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineplus">+</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineplus">+private:</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineplus">+  virtual ~nsBeckyImport();</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineplus">+</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineplus">+  nsresult GetMailImportInterface(nsISupports **aInterface);</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineplus">+  nsresult GetAddressBookImportInterface(nsISupports **aInterface);</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineplus">+  nsresult GetSettingsImportInterface(nsISupports **aInterface);</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineplus">+  nsresult GetFiltersImportInterface(nsISupports **aInterface);</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineplus">+</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineplus">+};</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineplus">+</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineplus">+#endif /* nsBeckyImport_h___ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1">new file mode 100644</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineminus">--- /dev/null</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineplus">+++ b/mailnews/import/becky/src/nsBeckyMail.cpp</span>
<a href="#l10.4"></a><span id="l10.4" class="difflineat">@@ -0,0 +1,642 @@</span>
<a href="#l10.5"></a><span id="l10.5" class="difflineplus">+/* vim: set ts=2 et sw=2 tw=80: */</span>
<a href="#l10.6"></a><span id="l10.6" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l10.7"></a><span id="l10.7" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l10.8"></a><span id="l10.8" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l10.9"></a><span id="l10.9" class="difflineplus">+</span>
<a href="#l10.10"></a><span id="l10.10" class="difflineplus">+#include &quot;nsString.h&quot;</span>
<a href="#l10.11"></a><span id="l10.11" class="difflineplus">+#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+#include &quot;nsIFile.h&quot;</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+#include &quot;nsIInputStream.h&quot;</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+#include &quot;nsIOutputStream.h&quot;</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+#include &quot;nsILineInputStream.h&quot;</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+#include &quot;nsNetUtil.h&quot;</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineplus">+#include &quot;nsIArray.h&quot;</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineplus">+#include &quot;nsIImportService.h&quot;</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineplus">+#include &quot;nsIImportMailboxDescriptor.h&quot;</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineplus">+#include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineplus">+#include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineplus">+#include &quot;nsIMsgPluggableStore.h&quot;</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineplus">+#include &quot;nsIMutableArray.h&quot;</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineplus">+#include &quot;nsMsgUtils.h&quot;</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineplus">+#include &quot;nsMsgLocalFolderHdrs.h&quot;</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineplus">+#include &quot;nsMsgMessageFlags.h&quot;</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineplus">+#include &quot;nsTArray.h&quot;</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineplus">+#include &quot;nspr.h&quot;</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineplus">+#include &quot;nsIStringBundle.h&quot;</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineplus">+#include &quot;nsIEnumerator.h&quot;</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineplus">+#include &quot;nsThreadUtils.h&quot;</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineplus">+</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineplus">+#include &quot;nsBeckyMail.h&quot;</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineplus">+#include &quot;nsBeckyUtils.h&quot;</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineplus">+#include &quot;nsBeckyStringBundle.h&quot;</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineplus">+</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineplus">+#define FROM_LINE &quot;From - Mon Jan 1 00:00:00 1965&quot; MSG_LINEBREAK</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineplus">+#define X_BECKY_STATUS_HEADER &quot;X-Becky-Status&quot;</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineplus">+#define X_BECKY_INCLUDE_HEADER &quot;X-Becky-Include&quot;</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineplus">+</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineplus">+enum {</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineplus">+  BECKY_STATUS_READ      = 1 &lt;&lt; 0,</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineplus">+  BECKY_STATUS_FORWARDED = 1 &lt;&lt; 1,</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineplus">+  BECKY_STATUS_REPLIED   = 1 &lt;&lt; 2</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineplus">+};</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineplus">+</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineplus">+NS_IMPL_ISUPPORTS(nsBeckyMail, nsIImportMail)</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineplus">+</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineplus">+nsresult</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineplus">+nsBeckyMail::Create(nsIImportMail **aImport)</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineplus">+{</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aImport);</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineplus">+</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineplus">+  *aImport = new nsBeckyMail();</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineplus">+</span>
<a href="#l10.56"></a><span id="l10.56" class="difflineplus">+  NS_ADDREF(*aImport);</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineplus">+  return NS_OK;</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineplus">+}</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineplus">+</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineplus">+nsBeckyMail::nsBeckyMail()</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineplus">+: mReadBytes(0)</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineplus">+{</span>
<a href="#l10.63"></a><span id="l10.63" class="difflineplus">+}</span>
<a href="#l10.64"></a><span id="l10.64" class="difflineplus">+</span>
<a href="#l10.65"></a><span id="l10.65" class="difflineplus">+nsBeckyMail::~nsBeckyMail()</span>
<a href="#l10.66"></a><span id="l10.66" class="difflineplus">+{</span>
<a href="#l10.67"></a><span id="l10.67" class="difflineplus">+}</span>
<a href="#l10.68"></a><span id="l10.68" class="difflineplus">+</span>
<a href="#l10.69"></a><span id="l10.69" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l10.70"></a><span id="l10.70" class="difflineplus">+nsBeckyMail::GetDefaultLocation(nsIFile **aLocation,</span>
<a href="#l10.71"></a><span id="l10.71" class="difflineplus">+                                bool *aFound,</span>
<a href="#l10.72"></a><span id="l10.72" class="difflineplus">+                                bool *aUserVerify)</span>
<a href="#l10.73"></a><span id="l10.73" class="difflineplus">+{</span>
<a href="#l10.74"></a><span id="l10.74" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aFound);</span>
<a href="#l10.75"></a><span id="l10.75" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aLocation);</span>
<a href="#l10.76"></a><span id="l10.76" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aUserVerify);</span>
<a href="#l10.77"></a><span id="l10.77" class="difflineplus">+</span>
<a href="#l10.78"></a><span id="l10.78" class="difflineplus">+  *aLocation = nullptr;</span>
<a href="#l10.79"></a><span id="l10.79" class="difflineplus">+  *aUserVerify = true;</span>
<a href="#l10.80"></a><span id="l10.80" class="difflineplus">+  *aFound = false;</span>
<a href="#l10.81"></a><span id="l10.81" class="difflineplus">+  if (NS_SUCCEEDED(nsBeckyUtils::GetDefaultMailboxDirectory(aLocation)))</span>
<a href="#l10.82"></a><span id="l10.82" class="difflineplus">+    *aFound = true;</span>
<a href="#l10.83"></a><span id="l10.83" class="difflineplus">+</span>
<a href="#l10.84"></a><span id="l10.84" class="difflineplus">+  return NS_OK;</span>
<a href="#l10.85"></a><span id="l10.85" class="difflineplus">+}</span>
<a href="#l10.86"></a><span id="l10.86" class="difflineplus">+</span>
<a href="#l10.87"></a><span id="l10.87" class="difflineplus">+nsresult</span>
<a href="#l10.88"></a><span id="l10.88" class="difflineplus">+nsBeckyMail::CreateMailboxDescriptor(nsIImportMailboxDescriptor **aDescriptor)</span>
<a href="#l10.89"></a><span id="l10.89" class="difflineplus">+{</span>
<a href="#l10.90"></a><span id="l10.90" class="difflineplus">+  nsresult rv;</span>
<a href="#l10.91"></a><span id="l10.91" class="difflineplus">+  nsCOMPtr&lt;nsIImportService&gt; importService;</span>
<a href="#l10.92"></a><span id="l10.92" class="difflineplus">+  importService = do_GetService(NS_IMPORTSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l10.93"></a><span id="l10.93" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.94"></a><span id="l10.94" class="difflineplus">+</span>
<a href="#l10.95"></a><span id="l10.95" class="difflineplus">+  return importService-&gt;CreateNewMailboxDescriptor(aDescriptor);</span>
<a href="#l10.96"></a><span id="l10.96" class="difflineplus">+}</span>
<a href="#l10.97"></a><span id="l10.97" class="difflineplus">+</span>
<a href="#l10.98"></a><span id="l10.98" class="difflineplus">+nsresult</span>
<a href="#l10.99"></a><span id="l10.99" class="difflineplus">+nsBeckyMail::GetMailboxName(nsIFile *aMailbox, nsAString &amp;aName)</span>
<a href="#l10.100"></a><span id="l10.100" class="difflineplus">+{</span>
<a href="#l10.101"></a><span id="l10.101" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; iniFile;</span>
<a href="#l10.102"></a><span id="l10.102" class="difflineplus">+  nsBeckyUtils::GetMailboxINIFile(aMailbox, getter_AddRefs(iniFile));</span>
<a href="#l10.103"></a><span id="l10.103" class="difflineplus">+  if (iniFile) {</span>
<a href="#l10.104"></a><span id="l10.104" class="difflineplus">+    nsCOMPtr&lt;nsIFile&gt; convertedFile;</span>
<a href="#l10.105"></a><span id="l10.105" class="difflineplus">+    nsBeckyUtils::ConvertToUTF8File(iniFile, getter_AddRefs(convertedFile));</span>
<a href="#l10.106"></a><span id="l10.106" class="difflineplus">+    if (convertedFile) {</span>
<a href="#l10.107"></a><span id="l10.107" class="difflineplus">+      nsAutoCString utf8Name;</span>
<a href="#l10.108"></a><span id="l10.108" class="difflineplus">+      nsBeckyUtils::GetMailboxNameFromINIFile(convertedFile, utf8Name);</span>
<a href="#l10.109"></a><span id="l10.109" class="difflineplus">+      convertedFile-&gt;Remove(false);</span>
<a href="#l10.110"></a><span id="l10.110" class="difflineplus">+      CopyUTF8toUTF16(utf8Name, aName);</span>
<a href="#l10.111"></a><span id="l10.111" class="difflineplus">+    }</span>
<a href="#l10.112"></a><span id="l10.112" class="difflineplus">+  }</span>
<a href="#l10.113"></a><span id="l10.113" class="difflineplus">+</span>
<a href="#l10.114"></a><span id="l10.114" class="difflineplus">+  if (aName.IsEmpty()) {</span>
<a href="#l10.115"></a><span id="l10.115" class="difflineplus">+    nsAutoString name;</span>
<a href="#l10.116"></a><span id="l10.116" class="difflineplus">+    aMailbox-&gt;GetLeafName(name);</span>
<a href="#l10.117"></a><span id="l10.117" class="difflineplus">+    name.Trim(&quot;!&quot;, true, false);</span>
<a href="#l10.118"></a><span id="l10.118" class="difflineplus">+    aName.Assign(name);</span>
<a href="#l10.119"></a><span id="l10.119" class="difflineplus">+  }</span>
<a href="#l10.120"></a><span id="l10.120" class="difflineplus">+</span>
<a href="#l10.121"></a><span id="l10.121" class="difflineplus">+  return NS_OK;</span>
<a href="#l10.122"></a><span id="l10.122" class="difflineplus">+}</span>
<a href="#l10.123"></a><span id="l10.123" class="difflineplus">+</span>
<a href="#l10.124"></a><span id="l10.124" class="difflineplus">+nsresult</span>
<a href="#l10.125"></a><span id="l10.125" class="difflineplus">+nsBeckyMail::AppendMailboxDescriptor(nsIFile *aEntry,</span>
<a href="#l10.126"></a><span id="l10.126" class="difflineplus">+                                     const nsString &amp;aName,</span>
<a href="#l10.127"></a><span id="l10.127" class="difflineplus">+                                     uint32_t aDepth,</span>
<a href="#l10.128"></a><span id="l10.128" class="difflineplus">+                                     nsIMutableArray *aCollected)</span>
<a href="#l10.129"></a><span id="l10.129" class="difflineplus">+{</span>
<a href="#l10.130"></a><span id="l10.130" class="difflineplus">+  nsresult rv;</span>
<a href="#l10.131"></a><span id="l10.131" class="difflineplus">+  nsCOMPtr&lt;nsIImportMailboxDescriptor&gt; descriptor;</span>
<a href="#l10.132"></a><span id="l10.132" class="difflineplus">+  rv = CreateMailboxDescriptor(getter_AddRefs(descriptor));</span>
<a href="#l10.133"></a><span id="l10.133" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.134"></a><span id="l10.134" class="difflineplus">+</span>
<a href="#l10.135"></a><span id="l10.135" class="difflineplus">+  int64_t size;</span>
<a href="#l10.136"></a><span id="l10.136" class="difflineplus">+  rv = aEntry-&gt;GetFileSize(&amp;size);</span>
<a href="#l10.137"></a><span id="l10.137" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.138"></a><span id="l10.138" class="difflineplus">+</span>
<a href="#l10.139"></a><span id="l10.139" class="difflineplus">+  rv = descriptor-&gt;SetSize(size);</span>
<a href="#l10.140"></a><span id="l10.140" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.141"></a><span id="l10.141" class="difflineplus">+</span>
<a href="#l10.142"></a><span id="l10.142" class="difflineplus">+  rv = descriptor-&gt;SetDisplayName(aName.get());</span>
<a href="#l10.143"></a><span id="l10.143" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.144"></a><span id="l10.144" class="difflineplus">+</span>
<a href="#l10.145"></a><span id="l10.145" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; mailboxFile;</span>
<a href="#l10.146"></a><span id="l10.146" class="difflineplus">+  rv = descriptor-&gt;GetFile(getter_AddRefs(mailboxFile));</span>
<a href="#l10.147"></a><span id="l10.147" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.148"></a><span id="l10.148" class="difflineplus">+</span>
<a href="#l10.149"></a><span id="l10.149" class="difflineplus">+  descriptor-&gt;SetDepth(aDepth);</span>
<a href="#l10.150"></a><span id="l10.150" class="difflineplus">+</span>
<a href="#l10.151"></a><span id="l10.151" class="difflineplus">+  mailboxFile-&gt;InitWithFile(aEntry);</span>
<a href="#l10.152"></a><span id="l10.152" class="difflineplus">+  aCollected-&gt;AppendElement(descriptor, false);</span>
<a href="#l10.153"></a><span id="l10.153" class="difflineplus">+</span>
<a href="#l10.154"></a><span id="l10.154" class="difflineplus">+  return NS_OK;</span>
<a href="#l10.155"></a><span id="l10.155" class="difflineplus">+}</span>
<a href="#l10.156"></a><span id="l10.156" class="difflineplus">+</span>
<a href="#l10.157"></a><span id="l10.157" class="difflineplus">+nsresult</span>
<a href="#l10.158"></a><span id="l10.158" class="difflineplus">+nsBeckyMail::CollectMailboxesInFolderListFile(nsIFile *aListFile,</span>
<a href="#l10.159"></a><span id="l10.159" class="difflineplus">+                                              uint32_t aDepth,</span>
<a href="#l10.160"></a><span id="l10.160" class="difflineplus">+                                              nsIMutableArray *aCollected)</span>
<a href="#l10.161"></a><span id="l10.161" class="difflineplus">+{</span>
<a href="#l10.162"></a><span id="l10.162" class="difflineplus">+  nsresult rv;</span>
<a href="#l10.163"></a><span id="l10.163" class="difflineplus">+  nsCOMPtr&lt;nsILineInputStream&gt; lineStream;</span>
<a href="#l10.164"></a><span id="l10.164" class="difflineplus">+  rv = nsBeckyUtils::CreateLineInputStream(aListFile,</span>
<a href="#l10.165"></a><span id="l10.165" class="difflineplus">+                                           getter_AddRefs(lineStream));</span>
<a href="#l10.166"></a><span id="l10.166" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.167"></a><span id="l10.167" class="difflineplus">+</span>
<a href="#l10.168"></a><span id="l10.168" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; parent;</span>
<a href="#l10.169"></a><span id="l10.169" class="difflineplus">+  rv = aListFile-&gt;GetParent(getter_AddRefs(parent));</span>
<a href="#l10.170"></a><span id="l10.170" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.171"></a><span id="l10.171" class="difflineplus">+</span>
<a href="#l10.172"></a><span id="l10.172" class="difflineplus">+  bool more = true;</span>
<a href="#l10.173"></a><span id="l10.173" class="difflineplus">+  nsAutoCString folderName;</span>
<a href="#l10.174"></a><span id="l10.174" class="difflineplus">+  bool isEmpty = true;</span>
<a href="#l10.175"></a><span id="l10.175" class="difflineplus">+  while (more &amp;&amp; NS_SUCCEEDED(rv)) {</span>
<a href="#l10.176"></a><span id="l10.176" class="difflineplus">+    rv = lineStream-&gt;ReadLine(folderName, &amp;more);</span>
<a href="#l10.177"></a><span id="l10.177" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.178"></a><span id="l10.178" class="difflineplus">+</span>
<a href="#l10.179"></a><span id="l10.179" class="difflineplus">+    if (folderName.IsEmpty())</span>
<a href="#l10.180"></a><span id="l10.180" class="difflineplus">+      continue;</span>
<a href="#l10.181"></a><span id="l10.181" class="difflineplus">+</span>
<a href="#l10.182"></a><span id="l10.182" class="difflineplus">+    nsCOMPtr&lt;nsIFile&gt; folder;</span>
<a href="#l10.183"></a><span id="l10.183" class="difflineplus">+    rv = parent-&gt;Clone(getter_AddRefs(folder));</span>
<a href="#l10.184"></a><span id="l10.184" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.185"></a><span id="l10.185" class="difflineplus">+</span>
<a href="#l10.186"></a><span id="l10.186" class="difflineplus">+    rv = folder-&gt;AppendNative(folderName);</span>
<a href="#l10.187"></a><span id="l10.187" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.188"></a><span id="l10.188" class="difflineplus">+</span>
<a href="#l10.189"></a><span id="l10.189" class="difflineplus">+    isEmpty = false;</span>
<a href="#l10.190"></a><span id="l10.190" class="difflineplus">+    rv = CollectMailboxesInDirectory(folder, aDepth + 1, aCollected);</span>
<a href="#l10.191"></a><span id="l10.191" class="difflineplus">+  }</span>
<a href="#l10.192"></a><span id="l10.192" class="difflineplus">+</span>
<a href="#l10.193"></a><span id="l10.193" class="difflineplus">+  return isEmpty ? NS_ERROR_FILE_NOT_FOUND : NS_OK;</span>
<a href="#l10.194"></a><span id="l10.194" class="difflineplus">+}</span>
<a href="#l10.195"></a><span id="l10.195" class="difflineplus">+</span>
<a href="#l10.196"></a><span id="l10.196" class="difflineplus">+nsresult</span>
<a href="#l10.197"></a><span id="l10.197" class="difflineplus">+nsBeckyMail::CollectMailboxesInDirectory(nsIFile *aDirectory,</span>
<a href="#l10.198"></a><span id="l10.198" class="difflineplus">+                                         uint32_t aDepth,</span>
<a href="#l10.199"></a><span id="l10.199" class="difflineplus">+                                         nsIMutableArray *aCollected)</span>
<a href="#l10.200"></a><span id="l10.200" class="difflineplus">+{</span>
<a href="#l10.201"></a><span id="l10.201" class="difflineplus">+  nsAutoString mailboxName;</span>
<a href="#l10.202"></a><span id="l10.202" class="difflineplus">+  nsresult rv = GetMailboxName(aDirectory, mailboxName);</span>
<a href="#l10.203"></a><span id="l10.203" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.204"></a><span id="l10.204" class="difflineplus">+</span>
<a href="#l10.205"></a><span id="l10.205" class="difflineplus">+  if (aDepth != 0)</span>
<a href="#l10.206"></a><span id="l10.206" class="difflineplus">+    AppendMailboxDescriptor(aDirectory, mailboxName, aDepth, aCollected);</span>
<a href="#l10.207"></a><span id="l10.207" class="difflineplus">+</span>
<a href="#l10.208"></a><span id="l10.208" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; folderListFile;</span>
<a href="#l10.209"></a><span id="l10.209" class="difflineplus">+  rv = nsBeckyUtils::GetFolderListFile(aDirectory, getter_AddRefs(folderListFile));</span>
<a href="#l10.210"></a><span id="l10.210" class="difflineplus">+  bool folderListExists = false;</span>
<a href="#l10.211"></a><span id="l10.211" class="difflineplus">+</span>
<a href="#l10.212"></a><span id="l10.212" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l10.213"></a><span id="l10.213" class="difflineplus">+    rv = CollectMailboxesInFolderListFile(folderListFile, aDepth, aCollected);</span>
<a href="#l10.214"></a><span id="l10.214" class="difflineplus">+    folderListExists = true;</span>
<a href="#l10.215"></a><span id="l10.215" class="difflineplus">+  }</span>
<a href="#l10.216"></a><span id="l10.216" class="difflineplus">+</span>
<a href="#l10.217"></a><span id="l10.217" class="difflineplus">+  nsCOMPtr&lt;nsISimpleEnumerator&gt; entries;</span>
<a href="#l10.218"></a><span id="l10.218" class="difflineplus">+  rv = aDirectory-&gt;GetDirectoryEntries(getter_AddRefs(entries));</span>
<a href="#l10.219"></a><span id="l10.219" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.220"></a><span id="l10.220" class="difflineplus">+</span>
<a href="#l10.221"></a><span id="l10.221" class="difflineplus">+  bool more;</span>
<a href="#l10.222"></a><span id="l10.222" class="difflineplus">+  while (NS_SUCCEEDED(entries-&gt;HasMoreElements(&amp;more)) &amp;&amp; more) {</span>
<a href="#l10.223"></a><span id="l10.223" class="difflineplus">+    nsCOMPtr&lt;nsISupports&gt; entry;</span>
<a href="#l10.224"></a><span id="l10.224" class="difflineplus">+    rv = entries-&gt;GetNext(getter_AddRefs(entry));</span>
<a href="#l10.225"></a><span id="l10.225" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.226"></a><span id="l10.226" class="difflineplus">+</span>
<a href="#l10.227"></a><span id="l10.227" class="difflineplus">+    nsCOMPtr&lt;nsIFile&gt; file = do_QueryInterface(entry, &amp;rv);</span>
<a href="#l10.228"></a><span id="l10.228" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.229"></a><span id="l10.229" class="difflineplus">+</span>
<a href="#l10.230"></a><span id="l10.230" class="difflineplus">+    nsAutoString name;</span>
<a href="#l10.231"></a><span id="l10.231" class="difflineplus">+    rv = file-&gt;GetLeafName(name);</span>
<a href="#l10.232"></a><span id="l10.232" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.233"></a><span id="l10.233" class="difflineplus">+</span>
<a href="#l10.234"></a><span id="l10.234" class="difflineplus">+    if (StringEndsWith(name, NS_LITERAL_STRING(&quot;.bmf&quot;))) {</span>
<a href="#l10.235"></a><span id="l10.235" class="difflineplus">+      AppendMailboxDescriptor(file, mailboxName, aDepth, aCollected);</span>
<a href="#l10.236"></a><span id="l10.236" class="difflineplus">+    }</span>
<a href="#l10.237"></a><span id="l10.237" class="difflineplus">+</span>
<a href="#l10.238"></a><span id="l10.238" class="difflineplus">+    // The Folder.lst file is not created if there is only one sub folder,</span>
<a href="#l10.239"></a><span id="l10.239" class="difflineplus">+    // so we need to find the sub folder by our hands.</span>
<a href="#l10.240"></a><span id="l10.240" class="difflineplus">+    // The folder name does not begin with # or ! maybe. Yes, maybe...</span>
<a href="#l10.241"></a><span id="l10.241" class="difflineplus">+    if (!folderListExists) {</span>
<a href="#l10.242"></a><span id="l10.242" class="difflineplus">+      if (StringBeginsWith(name, NS_LITERAL_STRING(&quot;#&quot;)) ||</span>
<a href="#l10.243"></a><span id="l10.243" class="difflineplus">+          StringBeginsWith(name, NS_LITERAL_STRING(&quot;!&quot;)))</span>
<a href="#l10.244"></a><span id="l10.244" class="difflineplus">+        continue;</span>
<a href="#l10.245"></a><span id="l10.245" class="difflineplus">+</span>
<a href="#l10.246"></a><span id="l10.246" class="difflineplus">+      bool isDirectory = false;</span>
<a href="#l10.247"></a><span id="l10.247" class="difflineplus">+      rv = file-&gt;IsDirectory(&amp;isDirectory);</span>
<a href="#l10.248"></a><span id="l10.248" class="difflineplus">+      if (isDirectory) {</span>
<a href="#l10.249"></a><span id="l10.249" class="difflineplus">+        CollectMailboxesInDirectory(file, aDepth + 1, aCollected);</span>
<a href="#l10.250"></a><span id="l10.250" class="difflineplus">+        continue;</span>
<a href="#l10.251"></a><span id="l10.251" class="difflineplus">+      }</span>
<a href="#l10.252"></a><span id="l10.252" class="difflineplus">+    }</span>
<a href="#l10.253"></a><span id="l10.253" class="difflineplus">+  }</span>
<a href="#l10.254"></a><span id="l10.254" class="difflineplus">+</span>
<a href="#l10.255"></a><span id="l10.255" class="difflineplus">+  return NS_OK;</span>
<a href="#l10.256"></a><span id="l10.256" class="difflineplus">+}</span>
<a href="#l10.257"></a><span id="l10.257" class="difflineplus">+</span>
<a href="#l10.258"></a><span id="l10.258" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l10.259"></a><span id="l10.259" class="difflineplus">+nsBeckyMail::FindMailboxes(nsIFile *aLocation, nsIArray **_retval)</span>
<a href="#l10.260"></a><span id="l10.260" class="difflineplus">+{</span>
<a href="#l10.261"></a><span id="l10.261" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aLocation);</span>
<a href="#l10.262"></a><span id="l10.262" class="difflineplus">+  NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l10.263"></a><span id="l10.263" class="difflineplus">+</span>
<a href="#l10.264"></a><span id="l10.264" class="difflineplus">+  nsresult rv;</span>
<a href="#l10.265"></a><span id="l10.265" class="difflineplus">+  nsCOMPtr&lt;nsIMutableArray&gt; array(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l10.266"></a><span id="l10.266" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.267"></a><span id="l10.267" class="difflineplus">+</span>
<a href="#l10.268"></a><span id="l10.268" class="difflineplus">+  rv = CollectMailboxesInDirectory(aLocation, 0, array);</span>
<a href="#l10.269"></a><span id="l10.269" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.270"></a><span id="l10.270" class="difflineplus">+</span>
<a href="#l10.271"></a><span id="l10.271" class="difflineplus">+  array.forget(_retval);</span>
<a href="#l10.272"></a><span id="l10.272" class="difflineplus">+</span>
<a href="#l10.273"></a><span id="l10.273" class="difflineplus">+  return NS_OK;</span>
<a href="#l10.274"></a><span id="l10.274" class="difflineplus">+}</span>
<a href="#l10.275"></a><span id="l10.275" class="difflineplus">+</span>
<a href="#l10.276"></a><span id="l10.276" class="difflineplus">+static nsresult</span>
<a href="#l10.277"></a><span id="l10.277" class="difflineplus">+GetBeckyStatusValue(const nsCString &amp;aHeader, nsACString &amp;aValue)</span>
<a href="#l10.278"></a><span id="l10.278" class="difflineplus">+{</span>
<a href="#l10.279"></a><span id="l10.279" class="difflineplus">+  int32_t valueStartPosition;</span>
<a href="#l10.280"></a><span id="l10.280" class="difflineplus">+</span>
<a href="#l10.281"></a><span id="l10.281" class="difflineplus">+  valueStartPosition = aHeader.FindChar(':');</span>
<a href="#l10.282"></a><span id="l10.282" class="difflineplus">+  if (valueStartPosition &lt; 0)</span>
<a href="#l10.283"></a><span id="l10.283" class="difflineplus">+    return NS_ERROR_UNEXPECTED;</span>
<a href="#l10.284"></a><span id="l10.284" class="difflineplus">+</span>
<a href="#l10.285"></a><span id="l10.285" class="difflineplus">+  valueStartPosition++;</span>
<a href="#l10.286"></a><span id="l10.286" class="difflineplus">+</span>
<a href="#l10.287"></a><span id="l10.287" class="difflineplus">+  int32_t commaPosition = aHeader.FindChar(',', valueStartPosition);</span>
<a href="#l10.288"></a><span id="l10.288" class="difflineplus">+  if (commaPosition &lt; 0)</span>
<a href="#l10.289"></a><span id="l10.289" class="difflineplus">+    return NS_ERROR_UNEXPECTED;</span>
<a href="#l10.290"></a><span id="l10.290" class="difflineplus">+</span>
<a href="#l10.291"></a><span id="l10.291" class="difflineplus">+  nsAutoCString value(Substring(aHeader,</span>
<a href="#l10.292"></a><span id="l10.292" class="difflineplus">+                                valueStartPosition,</span>
<a href="#l10.293"></a><span id="l10.293" class="difflineplus">+                                commaPosition - valueStartPosition));</span>
<a href="#l10.294"></a><span id="l10.294" class="difflineplus">+  value.Trim(&quot; \t&quot;);</span>
<a href="#l10.295"></a><span id="l10.295" class="difflineplus">+</span>
<a href="#l10.296"></a><span id="l10.296" class="difflineplus">+  aValue.Assign(value);</span>
<a href="#l10.297"></a><span id="l10.297" class="difflineplus">+</span>
<a href="#l10.298"></a><span id="l10.298" class="difflineplus">+  return NS_OK;</span>
<a href="#l10.299"></a><span id="l10.299" class="difflineplus">+}</span>
<a href="#l10.300"></a><span id="l10.300" class="difflineplus">+</span>
<a href="#l10.301"></a><span id="l10.301" class="difflineplus">+static nsresult</span>
<a href="#l10.302"></a><span id="l10.302" class="difflineplus">+GetBeckyIncludeValue(const nsCString &amp;aHeader, nsACString &amp;aValue)</span>
<a href="#l10.303"></a><span id="l10.303" class="difflineplus">+{</span>
<a href="#l10.304"></a><span id="l10.304" class="difflineplus">+  int32_t valueStartPosition;</span>
<a href="#l10.305"></a><span id="l10.305" class="difflineplus">+</span>
<a href="#l10.306"></a><span id="l10.306" class="difflineplus">+  valueStartPosition = aHeader.FindChar(':');</span>
<a href="#l10.307"></a><span id="l10.307" class="difflineplus">+  if (valueStartPosition &lt; 0)</span>
<a href="#l10.308"></a><span id="l10.308" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l10.309"></a><span id="l10.309" class="difflineplus">+</span>
<a href="#l10.310"></a><span id="l10.310" class="difflineplus">+  valueStartPosition++;</span>
<a href="#l10.311"></a><span id="l10.311" class="difflineplus">+  nsAutoCString value(Substring(aHeader, valueStartPosition));</span>
<a href="#l10.312"></a><span id="l10.312" class="difflineplus">+  value.Trim(&quot; \t&quot;);</span>
<a href="#l10.313"></a><span id="l10.313" class="difflineplus">+</span>
<a href="#l10.314"></a><span id="l10.314" class="difflineplus">+  aValue.Assign(value);</span>
<a href="#l10.315"></a><span id="l10.315" class="difflineplus">+</span>
<a href="#l10.316"></a><span id="l10.316" class="difflineplus">+  return NS_OK;</span>
<a href="#l10.317"></a><span id="l10.317" class="difflineplus">+}</span>
<a href="#l10.318"></a><span id="l10.318" class="difflineplus">+</span>
<a href="#l10.319"></a><span id="l10.319" class="difflineplus">+static bool</span>
<a href="#l10.320"></a><span id="l10.320" class="difflineplus">+ConvertBeckyStatusToMozillaStatus(const nsCString &amp;aHeader,</span>
<a href="#l10.321"></a><span id="l10.321" class="difflineplus">+                                  nsMsgMessageFlagType *aMozillaStatusFlag)</span>
<a href="#l10.322"></a><span id="l10.322" class="difflineplus">+{</span>
<a href="#l10.323"></a><span id="l10.323" class="difflineplus">+  nsresult rv;</span>
<a href="#l10.324"></a><span id="l10.324" class="difflineplus">+  nsAutoCString statusString;</span>
<a href="#l10.325"></a><span id="l10.325" class="difflineplus">+  rv = GetBeckyStatusValue(aHeader, statusString);</span>
<a href="#l10.326"></a><span id="l10.326" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l10.327"></a><span id="l10.327" class="difflineplus">+</span>
<a href="#l10.328"></a><span id="l10.328" class="difflineplus">+  nsresult errorCode;</span>
<a href="#l10.329"></a><span id="l10.329" class="difflineplus">+  uint32_t beckyStatusFlag = static_cast&lt;uint32_t&gt;(statusString.ToInteger(&amp;errorCode, 16));</span>
<a href="#l10.330"></a><span id="l10.330" class="difflineplus">+  if (NS_FAILED(errorCode))</span>
<a href="#l10.331"></a><span id="l10.331" class="difflineplus">+    return false;</span>
<a href="#l10.332"></a><span id="l10.332" class="difflineplus">+</span>
<a href="#l10.333"></a><span id="l10.333" class="difflineplus">+  if (beckyStatusFlag &amp; BECKY_STATUS_READ)</span>
<a href="#l10.334"></a><span id="l10.334" class="difflineplus">+    *aMozillaStatusFlag |= nsMsgMessageFlags::Read;</span>
<a href="#l10.335"></a><span id="l10.335" class="difflineplus">+  if (beckyStatusFlag &amp; BECKY_STATUS_FORWARDED)</span>
<a href="#l10.336"></a><span id="l10.336" class="difflineplus">+    *aMozillaStatusFlag |= nsMsgMessageFlags::Forwarded;</span>
<a href="#l10.337"></a><span id="l10.337" class="difflineplus">+  if (beckyStatusFlag &amp; BECKY_STATUS_REPLIED)</span>
<a href="#l10.338"></a><span id="l10.338" class="difflineplus">+    *aMozillaStatusFlag |= nsMsgMessageFlags::Replied;</span>
<a href="#l10.339"></a><span id="l10.339" class="difflineplus">+</span>
<a href="#l10.340"></a><span id="l10.340" class="difflineplus">+  return true;</span>
<a href="#l10.341"></a><span id="l10.341" class="difflineplus">+}</span>
<a href="#l10.342"></a><span id="l10.342" class="difflineplus">+</span>
<a href="#l10.343"></a><span id="l10.343" class="difflineplus">+static inline bool</span>
<a href="#l10.344"></a><span id="l10.344" class="difflineplus">+CheckHeaderKey(const nsCString &amp;aHeader, const char *aKeyString)</span>
<a href="#l10.345"></a><span id="l10.345" class="difflineplus">+{</span>
<a href="#l10.346"></a><span id="l10.346" class="difflineplus">+  nsAutoCString key(StringHead(aHeader, aHeader.FindChar(':')));</span>
<a href="#l10.347"></a><span id="l10.347" class="difflineplus">+  key.Trim(&quot; \t&quot;);</span>
<a href="#l10.348"></a><span id="l10.348" class="difflineplus">+  return key.Equals(aKeyString);</span>
<a href="#l10.349"></a><span id="l10.349" class="difflineplus">+}</span>
<a href="#l10.350"></a><span id="l10.350" class="difflineplus">+</span>
<a href="#l10.351"></a><span id="l10.351" class="difflineplus">+static inline bool</span>
<a href="#l10.352"></a><span id="l10.352" class="difflineplus">+IsBeckyStatusHeader(const nsCString &amp;aHeader)</span>
<a href="#l10.353"></a><span id="l10.353" class="difflineplus">+{</span>
<a href="#l10.354"></a><span id="l10.354" class="difflineplus">+  return CheckHeaderKey(aHeader, X_BECKY_STATUS_HEADER);</span>
<a href="#l10.355"></a><span id="l10.355" class="difflineplus">+}</span>
<a href="#l10.356"></a><span id="l10.356" class="difflineplus">+</span>
<a href="#l10.357"></a><span id="l10.357" class="difflineplus">+static inline bool</span>
<a href="#l10.358"></a><span id="l10.358" class="difflineplus">+IsBeckyIncludeLine(const nsCString &amp;aLine)</span>
<a href="#l10.359"></a><span id="l10.359" class="difflineplus">+{</span>
<a href="#l10.360"></a><span id="l10.360" class="difflineplus">+  return CheckHeaderKey(aLine, X_BECKY_INCLUDE_HEADER);</span>
<a href="#l10.361"></a><span id="l10.361" class="difflineplus">+}</span>
<a href="#l10.362"></a><span id="l10.362" class="difflineplus">+</span>
<a href="#l10.363"></a><span id="l10.363" class="difflineplus">+static inline bool</span>
<a href="#l10.364"></a><span id="l10.364" class="difflineplus">+IsEndOfHeaders(const nsCString &amp;aLine)</span>
<a href="#l10.365"></a><span id="l10.365" class="difflineplus">+{</span>
<a href="#l10.366"></a><span id="l10.366" class="difflineplus">+  return aLine.IsEmpty();</span>
<a href="#l10.367"></a><span id="l10.367" class="difflineplus">+}</span>
<a href="#l10.368"></a><span id="l10.368" class="difflineplus">+</span>
<a href="#l10.369"></a><span id="l10.369" class="difflineplus">+static inline bool</span>
<a href="#l10.370"></a><span id="l10.370" class="difflineplus">+IsEndOfMessage(const nsCString &amp;aLine)</span>
<a href="#l10.371"></a><span id="l10.371" class="difflineplus">+{</span>
<a href="#l10.372"></a><span id="l10.372" class="difflineplus">+  return aLine.Equals(&quot;.&quot;);</span>
<a href="#l10.373"></a><span id="l10.373" class="difflineplus">+}</span>
<a href="#l10.374"></a><span id="l10.374" class="difflineplus">+</span>
<a href="#l10.375"></a><span id="l10.375" class="difflineplus">+class ImportMessageRunnable: public mozilla::Runnable</span>
<a href="#l10.376"></a><span id="l10.376" class="difflineplus">+{</span>
<a href="#l10.377"></a><span id="l10.377" class="difflineplus">+public:</span>
<a href="#l10.378"></a><span id="l10.378" class="difflineplus">+  ImportMessageRunnable(nsIFile *aMessageFile,</span>
<a href="#l10.379"></a><span id="l10.379" class="difflineplus">+                        nsIMsgFolder *aFolder);</span>
<a href="#l10.380"></a><span id="l10.380" class="difflineplus">+  NS_DECL_NSIRUNNABLE</span>
<a href="#l10.381"></a><span id="l10.381" class="difflineplus">+private:</span>
<a href="#l10.382"></a><span id="l10.382" class="difflineplus">+  nsresult WriteHeaders(nsCString &amp;aHeaders, nsIOutputStream *aOutputStream);</span>
<a href="#l10.383"></a><span id="l10.383" class="difflineplus">+  nsresult HandleHeaderLine(const nsCString &amp;aHeaderLine, nsACString &amp;aHeaders);</span>
<a href="#l10.384"></a><span id="l10.384" class="difflineplus">+  nsresult GetAttachmentFile(nsIFile *aMailboxFile,</span>
<a href="#l10.385"></a><span id="l10.385" class="difflineplus">+                             const nsCString &amp;aHeader,</span>
<a href="#l10.386"></a><span id="l10.386" class="difflineplus">+                             nsIFile **_retval);</span>
<a href="#l10.387"></a><span id="l10.387" class="difflineplus">+  nsresult WriteAttachmentFile(nsIFile *aMailboxFile,</span>
<a href="#l10.388"></a><span id="l10.388" class="difflineplus">+                               const nsCString &amp;aHeader,</span>
<a href="#l10.389"></a><span id="l10.389" class="difflineplus">+                               nsIOutputStream *aOutputStream);</span>
<a href="#l10.390"></a><span id="l10.390" class="difflineplus">+</span>
<a href="#l10.391"></a><span id="l10.391" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; mMessageFile;</span>
<a href="#l10.392"></a><span id="l10.392" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; mFolder;</span>
<a href="#l10.393"></a><span id="l10.393" class="difflineplus">+};</span>
<a href="#l10.394"></a><span id="l10.394" class="difflineplus">+</span>
<a href="#l10.395"></a><span id="l10.395" class="difflineplus">+ImportMessageRunnable::ImportMessageRunnable(nsIFile *aMessageFile,</span>
<a href="#l10.396"></a><span id="l10.396" class="difflineplus">+                                             nsIMsgFolder *aFolder) :</span>
<a href="#l10.397"></a><span id="l10.397" class="difflineplus">+  mMessageFile(aMessageFile), mFolder(aFolder)</span>
<a href="#l10.398"></a><span id="l10.398" class="difflineplus">+{</span>
<a href="#l10.399"></a><span id="l10.399" class="difflineplus">+}</span>
<a href="#l10.400"></a><span id="l10.400" class="difflineplus">+</span>
<a href="#l10.401"></a><span id="l10.401" class="difflineplus">+nsresult</span>
<a href="#l10.402"></a><span id="l10.402" class="difflineplus">+ImportMessageRunnable::WriteHeaders(nsCString &amp;aHeaders,</span>
<a href="#l10.403"></a><span id="l10.403" class="difflineplus">+                                    nsIOutputStream *aOutputStream)</span>
<a href="#l10.404"></a><span id="l10.404" class="difflineplus">+{</span>
<a href="#l10.405"></a><span id="l10.405" class="difflineplus">+  nsresult rv;</span>
<a href="#l10.406"></a><span id="l10.406" class="difflineplus">+  uint32_t writtenBytes = 0;</span>
<a href="#l10.407"></a><span id="l10.407" class="difflineplus">+</span>
<a href="#l10.408"></a><span id="l10.408" class="difflineplus">+  rv = aOutputStream-&gt;Write(FROM_LINE, strlen(FROM_LINE), &amp;writtenBytes);</span>
<a href="#l10.409"></a><span id="l10.409" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.410"></a><span id="l10.410" class="difflineplus">+  rv = aOutputStream-&gt;Write(aHeaders.get(), aHeaders.Length(), &amp;writtenBytes);</span>
<a href="#l10.411"></a><span id="l10.411" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.412"></a><span id="l10.412" class="difflineplus">+  rv = aOutputStream-&gt;Write(MSG_LINEBREAK, strlen(MSG_LINEBREAK), &amp;writtenBytes);</span>
<a href="#l10.413"></a><span id="l10.413" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.414"></a><span id="l10.414" class="difflineplus">+  aHeaders.Truncate();</span>
<a href="#l10.415"></a><span id="l10.415" class="difflineplus">+</span>
<a href="#l10.416"></a><span id="l10.416" class="difflineplus">+  return NS_OK;</span>
<a href="#l10.417"></a><span id="l10.417" class="difflineplus">+}</span>
<a href="#l10.418"></a><span id="l10.418" class="difflineplus">+</span>
<a href="#l10.419"></a><span id="l10.419" class="difflineplus">+nsresult</span>
<a href="#l10.420"></a><span id="l10.420" class="difflineplus">+ImportMessageRunnable::HandleHeaderLine(const nsCString &amp;aHeaderLine,</span>
<a href="#l10.421"></a><span id="l10.421" class="difflineplus">+                                        nsACString &amp;aHeaders)</span>
<a href="#l10.422"></a><span id="l10.422" class="difflineplus">+{</span>
<a href="#l10.423"></a><span id="l10.423" class="difflineplus">+  aHeaders.Append(aHeaderLine);</span>
<a href="#l10.424"></a><span id="l10.424" class="difflineplus">+  aHeaders.AppendLiteral(MSG_LINEBREAK);</span>
<a href="#l10.425"></a><span id="l10.425" class="difflineplus">+</span>
<a href="#l10.426"></a><span id="l10.426" class="difflineplus">+  nsMsgMessageFlagType flag = 0;</span>
<a href="#l10.427"></a><span id="l10.427" class="difflineplus">+  if (IsBeckyStatusHeader(aHeaderLine) &amp;&amp;</span>
<a href="#l10.428"></a><span id="l10.428" class="difflineplus">+      ConvertBeckyStatusToMozillaStatus(aHeaderLine, &amp;flag)) {</span>
<a href="#l10.429"></a><span id="l10.429" class="difflineplus">+    char *statusLine;</span>
<a href="#l10.430"></a><span id="l10.430" class="difflineplus">+    statusLine = PR_smprintf(X_MOZILLA_STATUS_FORMAT MSG_LINEBREAK, flag);</span>
<a href="#l10.431"></a><span id="l10.431" class="difflineplus">+    aHeaders.Append(statusLine);</span>
<a href="#l10.432"></a><span id="l10.432" class="difflineplus">+    PR_smprintf_free(statusLine);</span>
<a href="#l10.433"></a><span id="l10.433" class="difflineplus">+    aHeaders.AppendLiteral(X_MOZILLA_KEYWORDS);</span>
<a href="#l10.434"></a><span id="l10.434" class="difflineplus">+  }</span>
<a href="#l10.435"></a><span id="l10.435" class="difflineplus">+</span>
<a href="#l10.436"></a><span id="l10.436" class="difflineplus">+  return NS_OK;</span>
<a href="#l10.437"></a><span id="l10.437" class="difflineplus">+}</span>
<a href="#l10.438"></a><span id="l10.438" class="difflineplus">+</span>
<a href="#l10.439"></a><span id="l10.439" class="difflineplus">+nsresult</span>
<a href="#l10.440"></a><span id="l10.440" class="difflineplus">+ImportMessageRunnable::GetAttachmentFile(nsIFile *aMailboxFile,</span>
<a href="#l10.441"></a><span id="l10.441" class="difflineplus">+                                         const nsCString &amp;aHeader,</span>
<a href="#l10.442"></a><span id="l10.442" class="difflineplus">+                                         nsIFile **_retval)</span>
<a href="#l10.443"></a><span id="l10.443" class="difflineplus">+{</span>
<a href="#l10.444"></a><span id="l10.444" class="difflineplus">+  nsresult rv;</span>
<a href="#l10.445"></a><span id="l10.445" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; attachmentFile;</span>
<a href="#l10.446"></a><span id="l10.446" class="difflineplus">+</span>
<a href="#l10.447"></a><span id="l10.447" class="difflineplus">+  rv = aMailboxFile-&gt;Clone(getter_AddRefs(attachmentFile));</span>
<a href="#l10.448"></a><span id="l10.448" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.449"></a><span id="l10.449" class="difflineplus">+</span>
<a href="#l10.450"></a><span id="l10.450" class="difflineplus">+  rv = attachmentFile-&gt;Append(NS_LITERAL_STRING(&quot;#Attach&quot;));</span>
<a href="#l10.451"></a><span id="l10.451" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.452"></a><span id="l10.452" class="difflineplus">+</span>
<a href="#l10.453"></a><span id="l10.453" class="difflineplus">+  nsAutoCString nativeAttachmentPath;</span>
<a href="#l10.454"></a><span id="l10.454" class="difflineplus">+  rv = GetBeckyIncludeValue(aHeader, nativeAttachmentPath);</span>
<a href="#l10.455"></a><span id="l10.455" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.456"></a><span id="l10.456" class="difflineplus">+</span>
<a href="#l10.457"></a><span id="l10.457" class="difflineplus">+  rv = attachmentFile-&gt;AppendRelativeNativePath(nativeAttachmentPath);</span>
<a href="#l10.458"></a><span id="l10.458" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.459"></a><span id="l10.459" class="difflineplus">+</span>
<a href="#l10.460"></a><span id="l10.460" class="difflineplus">+  bool exists = false;</span>
<a href="#l10.461"></a><span id="l10.461" class="difflineplus">+  attachmentFile-&gt;Exists(&amp;exists);</span>
<a href="#l10.462"></a><span id="l10.462" class="difflineplus">+  if (!exists)</span>
<a href="#l10.463"></a><span id="l10.463" class="difflineplus">+    return NS_ERROR_FILE_NOT_FOUND;</span>
<a href="#l10.464"></a><span id="l10.464" class="difflineplus">+</span>
<a href="#l10.465"></a><span id="l10.465" class="difflineplus">+  attachmentFile.forget(_retval);</span>
<a href="#l10.466"></a><span id="l10.466" class="difflineplus">+  return NS_OK;</span>
<a href="#l10.467"></a><span id="l10.467" class="difflineplus">+}</span>
<a href="#l10.468"></a><span id="l10.468" class="difflineplus">+</span>
<a href="#l10.469"></a><span id="l10.469" class="difflineplus">+nsresult</span>
<a href="#l10.470"></a><span id="l10.470" class="difflineplus">+ImportMessageRunnable::WriteAttachmentFile(nsIFile *aMailboxFile,</span>
<a href="#l10.471"></a><span id="l10.471" class="difflineplus">+                                           const nsCString &amp;aHeader,</span>
<a href="#l10.472"></a><span id="l10.472" class="difflineplus">+                                           nsIOutputStream *aOutputStream)</span>
<a href="#l10.473"></a><span id="l10.473" class="difflineplus">+{</span>
<a href="#l10.474"></a><span id="l10.474" class="difflineplus">+  nsresult rv;</span>
<a href="#l10.475"></a><span id="l10.475" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; parentDirectory;</span>
<a href="#l10.476"></a><span id="l10.476" class="difflineplus">+  rv = aMailboxFile-&gt;GetParent(getter_AddRefs(parentDirectory));</span>
<a href="#l10.477"></a><span id="l10.477" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.478"></a><span id="l10.478" class="difflineplus">+</span>
<a href="#l10.479"></a><span id="l10.479" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; attachmentFile;</span>
<a href="#l10.480"></a><span id="l10.480" class="difflineplus">+  rv = GetAttachmentFile(parentDirectory,</span>
<a href="#l10.481"></a><span id="l10.481" class="difflineplus">+                         aHeader,</span>
<a href="#l10.482"></a><span id="l10.482" class="difflineplus">+                         getter_AddRefs(attachmentFile));</span>
<a href="#l10.483"></a><span id="l10.483" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.484"></a><span id="l10.484" class="difflineplus">+</span>
<a href="#l10.485"></a><span id="l10.485" class="difflineplus">+  nsCOMPtr&lt;nsIInputStream&gt; inputStream;</span>
<a href="#l10.486"></a><span id="l10.486" class="difflineplus">+  rv = NS_NewLocalFileInputStream(getter_AddRefs(inputStream),</span>
<a href="#l10.487"></a><span id="l10.487" class="difflineplus">+                                  attachmentFile);</span>
<a href="#l10.488"></a><span id="l10.488" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.489"></a><span id="l10.489" class="difflineplus">+</span>
<a href="#l10.490"></a><span id="l10.490" class="difflineplus">+  char buffer[4096];</span>
<a href="#l10.491"></a><span id="l10.491" class="difflineplus">+  uint32_t readBytes = 0;</span>
<a href="#l10.492"></a><span id="l10.492" class="difflineplus">+  uint32_t writtenBytes = 0;</span>
<a href="#l10.493"></a><span id="l10.493" class="difflineplus">+  rv = aOutputStream-&gt;Write(MSG_LINEBREAK, strlen(MSG_LINEBREAK), &amp;writtenBytes);</span>
<a href="#l10.494"></a><span id="l10.494" class="difflineplus">+  while (NS_SUCCEEDED(inputStream-&gt;Read(buffer, sizeof(buffer), &amp;readBytes)) &amp;&amp;</span>
<a href="#l10.495"></a><span id="l10.495" class="difflineplus">+         readBytes &gt; 0) {</span>
<a href="#l10.496"></a><span id="l10.496" class="difflineplus">+    rv = aOutputStream-&gt;Write(buffer, readBytes, &amp;writtenBytes);</span>
<a href="#l10.497"></a><span id="l10.497" class="difflineplus">+    if (NS_FAILED(rv))</span>
<a href="#l10.498"></a><span id="l10.498" class="difflineplus">+      break;</span>
<a href="#l10.499"></a><span id="l10.499" class="difflineplus">+  }</span>
<a href="#l10.500"></a><span id="l10.500" class="difflineplus">+</span>
<a href="#l10.501"></a><span id="l10.501" class="difflineplus">+  return rv;</span>
<a href="#l10.502"></a><span id="l10.502" class="difflineplus">+}</span>
<a href="#l10.503"></a><span id="l10.503" class="difflineplus">+</span>
<a href="#l10.504"></a><span id="l10.504" class="difflineplus">+NS_IMETHODIMP ImportMessageRunnable::Run()</span>
<a href="#l10.505"></a><span id="l10.505" class="difflineplus">+{</span>
<a href="#l10.506"></a><span id="l10.506" class="difflineplus">+  nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l10.507"></a><span id="l10.507" class="difflineplus">+  nsresult rv = mFolder-&gt;GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l10.508"></a><span id="l10.508" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.509"></a><span id="l10.509" class="difflineplus">+</span>
<a href="#l10.510"></a><span id="l10.510" class="difflineplus">+  nsCOMPtr&lt;nsILineInputStream&gt; lineStream;</span>
<a href="#l10.511"></a><span id="l10.511" class="difflineplus">+  rv = nsBeckyUtils::CreateLineInputStream(mMessageFile,</span>
<a href="#l10.512"></a><span id="l10.512" class="difflineplus">+                                           getter_AddRefs(lineStream));</span>
<a href="#l10.513"></a><span id="l10.513" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.514"></a><span id="l10.514" class="difflineplus">+</span>
<a href="#l10.515"></a><span id="l10.515" class="difflineplus">+  bool reusable;</span>
<a href="#l10.516"></a><span id="l10.516" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l10.517"></a><span id="l10.517" class="difflineplus">+  nsCOMPtr&lt;nsIOutputStream&gt; outputStream;</span>
<a href="#l10.518"></a><span id="l10.518" class="difflineplus">+  rv = msgStore-&gt;GetNewMsgOutputStream(mFolder, getter_AddRefs(msgHdr), &amp;reusable,</span>
<a href="#l10.519"></a><span id="l10.519" class="difflineplus">+                                       getter_AddRefs(outputStream));</span>
<a href="#l10.520"></a><span id="l10.520" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.521"></a><span id="l10.521" class="difflineplus">+</span>
<a href="#l10.522"></a><span id="l10.522" class="difflineplus">+  bool inHeader = true;</span>
<a href="#l10.523"></a><span id="l10.523" class="difflineplus">+  bool more = true;</span>
<a href="#l10.524"></a><span id="l10.524" class="difflineplus">+  nsAutoCString headers;</span>
<a href="#l10.525"></a><span id="l10.525" class="difflineplus">+  while (NS_SUCCEEDED(rv) &amp;&amp; more) {</span>
<a href="#l10.526"></a><span id="l10.526" class="difflineplus">+    nsAutoCString line;</span>
<a href="#l10.527"></a><span id="l10.527" class="difflineplus">+    rv = lineStream-&gt;ReadLine(line, &amp;more);</span>
<a href="#l10.528"></a><span id="l10.528" class="difflineplus">+    if (NS_FAILED(rv))</span>
<a href="#l10.529"></a><span id="l10.529" class="difflineplus">+      break;</span>
<a href="#l10.530"></a><span id="l10.530" class="difflineplus">+</span>
<a href="#l10.531"></a><span id="l10.531" class="difflineplus">+    if (inHeader) {</span>
<a href="#l10.532"></a><span id="l10.532" class="difflineplus">+      if (IsEndOfHeaders(line)) {</span>
<a href="#l10.533"></a><span id="l10.533" class="difflineplus">+        inHeader = false;</span>
<a href="#l10.534"></a><span id="l10.534" class="difflineplus">+        rv = WriteHeaders(headers, outputStream);</span>
<a href="#l10.535"></a><span id="l10.535" class="difflineplus">+      } else {</span>
<a href="#l10.536"></a><span id="l10.536" class="difflineplus">+        rv = HandleHeaderLine(line, headers);</span>
<a href="#l10.537"></a><span id="l10.537" class="difflineplus">+      }</span>
<a href="#l10.538"></a><span id="l10.538" class="difflineplus">+    } else if (IsEndOfMessage(line)) {</span>
<a href="#l10.539"></a><span id="l10.539" class="difflineplus">+      inHeader = true;</span>
<a href="#l10.540"></a><span id="l10.540" class="difflineplus">+      rv = msgStore-&gt;FinishNewMessage(outputStream, msgHdr);</span>
<a href="#l10.541"></a><span id="l10.541" class="difflineplus">+      if (!reusable)</span>
<a href="#l10.542"></a><span id="l10.542" class="difflineplus">+        outputStream-&gt;Close();</span>
<a href="#l10.543"></a><span id="l10.543" class="difflineplus">+      rv = msgStore-&gt;GetNewMsgOutputStream(mFolder, getter_AddRefs(msgHdr), &amp;reusable,</span>
<a href="#l10.544"></a><span id="l10.544" class="difflineplus">+                                           getter_AddRefs(outputStream));</span>
<a href="#l10.545"></a><span id="l10.545" class="difflineplus">+    } else if (IsBeckyIncludeLine(line)) {</span>
<a href="#l10.546"></a><span id="l10.546" class="difflineplus">+      rv = WriteAttachmentFile(mMessageFile, line, outputStream);</span>
<a href="#l10.547"></a><span id="l10.547" class="difflineplus">+    } else {</span>
<a href="#l10.548"></a><span id="l10.548" class="difflineplus">+      uint32_t writtenBytes = 0;</span>
<a href="#l10.549"></a><span id="l10.549" class="difflineplus">+      if (StringBeginsWith(line, NS_LITERAL_CSTRING(&quot;..&quot;)))</span>
<a href="#l10.550"></a><span id="l10.550" class="difflineplus">+        line.Cut(0, 1);</span>
<a href="#l10.551"></a><span id="l10.551" class="difflineplus">+      else if (CheckHeaderKey(line, &quot;From&quot;))</span>
<a href="#l10.552"></a><span id="l10.552" class="difflineplus">+        line.Insert('&gt;', 0);</span>
<a href="#l10.553"></a><span id="l10.553" class="difflineplus">+</span>
<a href="#l10.554"></a><span id="l10.554" class="difflineplus">+      line.AppendLiteral(MSG_LINEBREAK);</span>
<a href="#l10.555"></a><span id="l10.555" class="difflineplus">+      rv = outputStream-&gt;Write(line.get(), line.Length(), &amp;writtenBytes);</span>
<a href="#l10.556"></a><span id="l10.556" class="difflineplus">+    }</span>
<a href="#l10.557"></a><span id="l10.557" class="difflineplus">+  }</span>
<a href="#l10.558"></a><span id="l10.558" class="difflineplus">+</span>
<a href="#l10.559"></a><span id="l10.559" class="difflineplus">+  if (outputStream) {</span>
<a href="#l10.560"></a><span id="l10.560" class="difflineplus">+    if (NS_FAILED(rv))</span>
<a href="#l10.561"></a><span id="l10.561" class="difflineplus">+      msgStore-&gt;DiscardNewMessage(outputStream, msgHdr);</span>
<a href="#l10.562"></a><span id="l10.562" class="difflineplus">+    outputStream-&gt;Close();</span>
<a href="#l10.563"></a><span id="l10.563" class="difflineplus">+  }</span>
<a href="#l10.564"></a><span id="l10.564" class="difflineplus">+</span>
<a href="#l10.565"></a><span id="l10.565" class="difflineplus">+  return rv;</span>
<a href="#l10.566"></a><span id="l10.566" class="difflineplus">+}</span>
<a href="#l10.567"></a><span id="l10.567" class="difflineplus">+</span>
<a href="#l10.568"></a><span id="l10.568" class="difflineplus">+static</span>
<a href="#l10.569"></a><span id="l10.569" class="difflineplus">+nsresult ProxyImportMessage(nsIFile *aMessageFile,</span>
<a href="#l10.570"></a><span id="l10.570" class="difflineplus">+                            nsIMsgFolder *aFolder)</span>
<a href="#l10.571"></a><span id="l10.571" class="difflineplus">+{</span>
<a href="#l10.572"></a><span id="l10.572" class="difflineplus">+  RefPtr&lt;ImportMessageRunnable&gt; importMessage =</span>
<a href="#l10.573"></a><span id="l10.573" class="difflineplus">+    new ImportMessageRunnable(aMessageFile, aFolder);</span>
<a href="#l10.574"></a><span id="l10.574" class="difflineplus">+  return NS_DispatchToMainThread(importMessage, NS_DISPATCH_SYNC);</span>
<a href="#l10.575"></a><span id="l10.575" class="difflineplus">+}</span>
<a href="#l10.576"></a><span id="l10.576" class="difflineplus">+</span>
<a href="#l10.577"></a><span id="l10.577" class="difflineplus">+nsresult</span>
<a href="#l10.578"></a><span id="l10.578" class="difflineplus">+nsBeckyMail::ImportMailFile(nsIFile *aMailFile,</span>
<a href="#l10.579"></a><span id="l10.579" class="difflineplus">+                            nsIMsgFolder *aDestination)</span>
<a href="#l10.580"></a><span id="l10.580" class="difflineplus">+{</span>
<a href="#l10.581"></a><span id="l10.581" class="difflineplus">+  int64_t size;</span>
<a href="#l10.582"></a><span id="l10.582" class="difflineplus">+  aMailFile-&gt;GetFileSize(&amp;size);</span>
<a href="#l10.583"></a><span id="l10.583" class="difflineplus">+  if (size == 0)</span>
<a href="#l10.584"></a><span id="l10.584" class="difflineplus">+    return NS_OK;</span>
<a href="#l10.585"></a><span id="l10.585" class="difflineplus">+</span>
<a href="#l10.586"></a><span id="l10.586" class="difflineplus">+  return ProxyImportMessage(aMailFile, aDestination);</span>
<a href="#l10.587"></a><span id="l10.587" class="difflineplus">+}</span>
<a href="#l10.588"></a><span id="l10.588" class="difflineplus">+</span>
<a href="#l10.589"></a><span id="l10.589" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l10.590"></a><span id="l10.590" class="difflineplus">+nsBeckyMail::ImportMailbox(nsIImportMailboxDescriptor *aSource,</span>
<a href="#l10.591"></a><span id="l10.591" class="difflineplus">+                           nsIMsgFolder *aDestination,</span>
<a href="#l10.592"></a><span id="l10.592" class="difflineplus">+                           char16_t **aErrorLog,</span>
<a href="#l10.593"></a><span id="l10.593" class="difflineplus">+                           char16_t **aSuccessLog,</span>
<a href="#l10.594"></a><span id="l10.594" class="difflineplus">+                           bool *aFatalError)</span>
<a href="#l10.595"></a><span id="l10.595" class="difflineplus">+{</span>
<a href="#l10.596"></a><span id="l10.596" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aSource);</span>
<a href="#l10.597"></a><span id="l10.597" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aDestination);</span>
<a href="#l10.598"></a><span id="l10.598" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aErrorLog);</span>
<a href="#l10.599"></a><span id="l10.599" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aSuccessLog);</span>
<a href="#l10.600"></a><span id="l10.600" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aFatalError);</span>
<a href="#l10.601"></a><span id="l10.601" class="difflineplus">+</span>
<a href="#l10.602"></a><span id="l10.602" class="difflineplus">+  mReadBytes = 0;</span>
<a href="#l10.603"></a><span id="l10.603" class="difflineplus">+</span>
<a href="#l10.604"></a><span id="l10.604" class="difflineplus">+  nsresult rv;</span>
<a href="#l10.605"></a><span id="l10.605" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; mailboxFolder;</span>
<a href="#l10.606"></a><span id="l10.606" class="difflineplus">+  rv = aSource-&gt;GetFile(getter_AddRefs(mailboxFolder));</span>
<a href="#l10.607"></a><span id="l10.607" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.608"></a><span id="l10.608" class="difflineplus">+</span>
<a href="#l10.609"></a><span id="l10.609" class="difflineplus">+  rv = ImportMailFile(mailboxFolder, aDestination);</span>
<a href="#l10.610"></a><span id="l10.610" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.611"></a><span id="l10.611" class="difflineplus">+</span>
<a href="#l10.612"></a><span id="l10.612" class="difflineplus">+  uint32_t finalSize;</span>
<a href="#l10.613"></a><span id="l10.613" class="difflineplus">+  aSource-&gt;GetSize(&amp;finalSize);</span>
<a href="#l10.614"></a><span id="l10.614" class="difflineplus">+  mReadBytes = finalSize;</span>
<a href="#l10.615"></a><span id="l10.615" class="difflineplus">+</span>
<a href="#l10.616"></a><span id="l10.616" class="difflineplus">+  nsAutoString name;</span>
<a href="#l10.617"></a><span id="l10.617" class="difflineplus">+  aSource-&gt;GetDisplayName(getter_Copies(name));</span>
<a href="#l10.618"></a><span id="l10.618" class="difflineplus">+</span>
<a href="#l10.619"></a><span id="l10.619" class="difflineplus">+  nsAutoString successMessage;</span>
<a href="#l10.620"></a><span id="l10.620" class="difflineplus">+  const char16_t *format = { name.get() };</span>
<a href="#l10.621"></a><span id="l10.621" class="difflineplus">+  rv =</span>
<a href="#l10.622"></a><span id="l10.622" class="difflineplus">+      nsBeckyStringBundle::FormatStringFromName(MOZ_UTF16(&quot;BeckyImportMailboxSuccess&quot;),</span>
<a href="#l10.623"></a><span id="l10.623" class="difflineplus">+                                                &amp;format,</span>
<a href="#l10.624"></a><span id="l10.624" class="difflineplus">+                                                1,</span>
<a href="#l10.625"></a><span id="l10.625" class="difflineplus">+                                                getter_Copies(successMessage));</span>
<a href="#l10.626"></a><span id="l10.626" class="difflineplus">+  successMessage.AppendLiteral(&quot;\n&quot;);</span>
<a href="#l10.627"></a><span id="l10.627" class="difflineplus">+  *aSuccessLog = ToNewUnicode(successMessage);</span>
<a href="#l10.628"></a><span id="l10.628" class="difflineplus">+</span>
<a href="#l10.629"></a><span id="l10.629" class="difflineplus">+  return rv;</span>
<a href="#l10.630"></a><span id="l10.630" class="difflineplus">+}</span>
<a href="#l10.631"></a><span id="l10.631" class="difflineplus">+</span>
<a href="#l10.632"></a><span id="l10.632" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l10.633"></a><span id="l10.633" class="difflineplus">+nsBeckyMail::GetImportProgress(uint32_t *_retval)</span>
<a href="#l10.634"></a><span id="l10.634" class="difflineplus">+{</span>
<a href="#l10.635"></a><span id="l10.635" class="difflineplus">+  NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l10.636"></a><span id="l10.636" class="difflineplus">+  *_retval = mReadBytes;</span>
<a href="#l10.637"></a><span id="l10.637" class="difflineplus">+  return NS_OK;</span>
<a href="#l10.638"></a><span id="l10.638" class="difflineplus">+}</span>
<a href="#l10.639"></a><span id="l10.639" class="difflineplus">+</span>
<a href="#l10.640"></a><span id="l10.640" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l10.641"></a><span id="l10.641" class="difflineplus">+nsBeckyMail::TranslateFolderName(const nsAString &amp; aFolderName,</span>
<a href="#l10.642"></a><span id="l10.642" class="difflineplus">+                                 nsAString &amp; _retval)</span>
<a href="#l10.643"></a><span id="l10.643" class="difflineplus">+{</span>
<a href="#l10.644"></a><span id="l10.644" class="difflineplus">+  return nsBeckyUtils::TranslateFolderName(aFolderName, _retval);</span>
<a href="#l10.645"></a><span id="l10.645" class="difflineplus">+}</span>
<a href="#l10.646"></a><span id="l10.646" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1">new file mode 100644</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineminus">--- /dev/null</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineplus">+++ b/mailnews/import/becky/src/nsBeckyMail.h</span>
<a href="#l11.4"></a><span id="l11.4" class="difflineat">@@ -0,0 +1,45 @@</span>
<a href="#l11.5"></a><span id="l11.5" class="difflineplus">+/* vim: set ts=2 et sw=2 tw=80: */</span>
<a href="#l11.6"></a><span id="l11.6" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l11.7"></a><span id="l11.7" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l11.8"></a><span id="l11.8" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l11.9"></a><span id="l11.9" class="difflineplus">+</span>
<a href="#l11.10"></a><span id="l11.10" class="difflineplus">+#ifndef nsBeckyMail_h___</span>
<a href="#l11.11"></a><span id="l11.11" class="difflineplus">+#define nsBeckyMail_h___</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+#include &quot;nsIImportMail.h&quot;</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+class nsIFile;</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineplus">+class nsIMutableArray;</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineplus">+class nsIMsgFolder;</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineplus">+</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineplus">+class nsBeckyMail final : public nsIImportMail</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineplus">+{</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineplus">+public:</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineplus">+  nsBeckyMail();</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineplus">+  static nsresult Create(nsIImportMail **aImport);</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineplus">+</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineplus">+  NS_DECL_NSIIMPORTMAIL</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineplus">+</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineplus">+private:</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineplus">+  virtual ~nsBeckyMail();</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineplus">+</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineplus">+  uint32_t mReadBytes;</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineplus">+</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineplus">+  nsresult CollectMailboxesInDirectory(nsIFile *aDirectory,</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineplus">+                                       uint32_t aDepth,</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineplus">+                                       nsIMutableArray *aCollected);</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineplus">+  nsresult CollectMailboxesInFolderListFile(nsIFile *aListFile,</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineplus">+                                            uint32_t aDepth,</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineplus">+                                            nsIMutableArray *aCollected);</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineplus">+  nsresult AppendMailboxDescriptor(nsIFile *aEntry,</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineplus">+                                   const nsString &amp;aName,</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineplus">+                                   uint32_t aDepth,</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineplus">+                                   nsIMutableArray *aCollected);</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineplus">+  nsresult ImportMailFile(nsIFile *aMailFile,</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineplus">+                          nsIMsgFolder *aDestination);</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineplus">+  nsresult CreateMailboxDescriptor(nsIImportMailboxDescriptor **aDescriptor);</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineplus">+  nsresult GetMailboxName(nsIFile *aMailbox, nsAString &amp;aName);</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineplus">+};</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineplus">+</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineplus">+#endif /* nsBeckyMail_h___ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1">new file mode 100644</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineminus">--- /dev/null</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineplus">+++ b/mailnews/import/becky/src/nsBeckySettings.cpp</span>
<a href="#l12.4"></a><span id="l12.4" class="difflineat">@@ -0,0 +1,471 @@</span>
<a href="#l12.5"></a><span id="l12.5" class="difflineplus">+/* vim: set ts=2 et sw=2 tw=80: */</span>
<a href="#l12.6"></a><span id="l12.6" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l12.7"></a><span id="l12.7" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l12.8"></a><span id="l12.8" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l12.9"></a><span id="l12.9" class="difflineplus">+</span>
<a href="#l12.10"></a><span id="l12.10" class="difflineplus">+#include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l12.11"></a><span id="l12.11" class="difflineplus">+#include &quot;nsMsgCompCID.h&quot;</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+#include &quot;nsIMsgAccountManager.h&quot;</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+#include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+#include &quot;nsIINIParser.h&quot;</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+#include &quot;nsISmtpService.h&quot;</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineplus">+#include &quot;nsISmtpServer.h&quot;</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineplus">+#include &quot;nsIPop3IncomingServer.h&quot;</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineplus">+#include &quot;nsIStringEnumerator.h&quot;</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineplus">+#include &quot;nsIInputStream.h&quot;</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineplus">+#include &quot;nsIOutputStream.h&quot;</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineplus">+#include &quot;nsILineInputStream.h&quot;</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineplus">+#include &quot;nsNetUtil.h&quot;</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineplus">+#include &quot;nsString.h&quot;</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineplus">+#include &quot;msgCore.h&quot;</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineplus">+#include &quot;nsIStringBundle.h&quot;</span>
<a href="#l12.26"></a><span id="l12.26" class="difflineplus">+</span>
<a href="#l12.27"></a><span id="l12.27" class="difflineplus">+#include &quot;nsBeckySettings.h&quot;</span>
<a href="#l12.28"></a><span id="l12.28" class="difflineplus">+#include &quot;nsBeckyStringBundle.h&quot;</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineplus">+#include &quot;nsBeckyUtils.h&quot;</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineplus">+</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineplus">+NS_IMPL_ISUPPORTS(nsBeckySettings, nsIImportSettings)</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineplus">+</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineplus">+nsresult</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineplus">+nsBeckySettings::Create(nsIImportSettings **aImport)</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineplus">+{</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aImport);</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineplus">+</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineplus">+  *aImport = new nsBeckySettings();</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineplus">+</span>
<a href="#l12.40"></a><span id="l12.40" class="difflineplus">+  NS_ADDREF(*aImport);</span>
<a href="#l12.41"></a><span id="l12.41" class="difflineplus">+  return NS_OK;</span>
<a href="#l12.42"></a><span id="l12.42" class="difflineplus">+}</span>
<a href="#l12.43"></a><span id="l12.43" class="difflineplus">+</span>
<a href="#l12.44"></a><span id="l12.44" class="difflineplus">+nsBeckySettings::nsBeckySettings()</span>
<a href="#l12.45"></a><span id="l12.45" class="difflineplus">+{</span>
<a href="#l12.46"></a><span id="l12.46" class="difflineplus">+}</span>
<a href="#l12.47"></a><span id="l12.47" class="difflineplus">+</span>
<a href="#l12.48"></a><span id="l12.48" class="difflineplus">+nsBeckySettings::~nsBeckySettings()</span>
<a href="#l12.49"></a><span id="l12.49" class="difflineplus">+{</span>
<a href="#l12.50"></a><span id="l12.50" class="difflineplus">+}</span>
<a href="#l12.51"></a><span id="l12.51" class="difflineplus">+</span>
<a href="#l12.52"></a><span id="l12.52" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l12.53"></a><span id="l12.53" class="difflineplus">+nsBeckySettings::AutoLocate(char16_t **aDescription,</span>
<a href="#l12.54"></a><span id="l12.54" class="difflineplus">+                            nsIFile **aLocation,</span>
<a href="#l12.55"></a><span id="l12.55" class="difflineplus">+                            bool *_retval)</span>
<a href="#l12.56"></a><span id="l12.56" class="difflineplus">+{</span>
<a href="#l12.57"></a><span id="l12.57" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aDescription);</span>
<a href="#l12.58"></a><span id="l12.58" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aLocation);</span>
<a href="#l12.59"></a><span id="l12.59" class="difflineplus">+  NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l12.60"></a><span id="l12.60" class="difflineplus">+</span>
<a href="#l12.61"></a><span id="l12.61" class="difflineplus">+  *aDescription =</span>
<a href="#l12.62"></a><span id="l12.62" class="difflineplus">+    nsBeckyStringBundle::GetStringByName(MOZ_UTF16(&quot;BeckyImportName&quot;));</span>
<a href="#l12.63"></a><span id="l12.63" class="difflineplus">+  *aLocation = nullptr;</span>
<a href="#l12.64"></a><span id="l12.64" class="difflineplus">+  *_retval = false;</span>
<a href="#l12.65"></a><span id="l12.65" class="difflineplus">+</span>
<a href="#l12.66"></a><span id="l12.66" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; location;</span>
<a href="#l12.67"></a><span id="l12.67" class="difflineplus">+  nsresult rv = nsBeckyUtils::GetDefaultMailboxINIFile(getter_AddRefs(location));</span>
<a href="#l12.68"></a><span id="l12.68" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l12.69"></a><span id="l12.69" class="difflineplus">+    location = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l12.70"></a><span id="l12.70" class="difflineplus">+  else</span>
<a href="#l12.71"></a><span id="l12.71" class="difflineplus">+    *_retval = true;</span>
<a href="#l12.72"></a><span id="l12.72" class="difflineplus">+</span>
<a href="#l12.73"></a><span id="l12.73" class="difflineplus">+  location.forget(aLocation);</span>
<a href="#l12.74"></a><span id="l12.74" class="difflineplus">+  return NS_OK;</span>
<a href="#l12.75"></a><span id="l12.75" class="difflineplus">+}</span>
<a href="#l12.76"></a><span id="l12.76" class="difflineplus">+</span>
<a href="#l12.77"></a><span id="l12.77" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l12.78"></a><span id="l12.78" class="difflineplus">+nsBeckySettings::SetLocation(nsIFile *aLocation)</span>
<a href="#l12.79"></a><span id="l12.79" class="difflineplus">+{</span>
<a href="#l12.80"></a><span id="l12.80" class="difflineplus">+  mLocation = aLocation;</span>
<a href="#l12.81"></a><span id="l12.81" class="difflineplus">+  return NS_OK;</span>
<a href="#l12.82"></a><span id="l12.82" class="difflineplus">+}</span>
<a href="#l12.83"></a><span id="l12.83" class="difflineplus">+</span>
<a href="#l12.84"></a><span id="l12.84" class="difflineplus">+nsresult</span>
<a href="#l12.85"></a><span id="l12.85" class="difflineplus">+nsBeckySettings::CreateParser()</span>
<a href="#l12.86"></a><span id="l12.86" class="difflineplus">+{</span>
<a href="#l12.87"></a><span id="l12.87" class="difflineplus">+  if (!mLocation) {</span>
<a href="#l12.88"></a><span id="l12.88" class="difflineplus">+    nsresult rv = nsBeckyUtils::GetDefaultMailboxINIFile(getter_AddRefs(mLocation));</span>
<a href="#l12.89"></a><span id="l12.89" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.90"></a><span id="l12.90" class="difflineplus">+  }</span>
<a href="#l12.91"></a><span id="l12.91" class="difflineplus">+</span>
<a href="#l12.92"></a><span id="l12.92" class="difflineplus">+  // nsIINIParser accepts only UTF-8 encoding, so we need to convert the file</span>
<a href="#l12.93"></a><span id="l12.93" class="difflineplus">+  // first.</span>
<a href="#l12.94"></a><span id="l12.94" class="difflineplus">+  nsresult rv;</span>
<a href="#l12.95"></a><span id="l12.95" class="difflineplus">+  rv = nsBeckyUtils::ConvertToUTF8File(mLocation, getter_AddRefs(mConvertedFile));</span>
<a href="#l12.96"></a><span id="l12.96" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.97"></a><span id="l12.97" class="difflineplus">+</span>
<a href="#l12.98"></a><span id="l12.98" class="difflineplus">+  return nsBeckyUtils::CreateINIParserForFile(mConvertedFile,</span>
<a href="#l12.99"></a><span id="l12.99" class="difflineplus">+                                              getter_AddRefs(mParser));</span>
<a href="#l12.100"></a><span id="l12.100" class="difflineplus">+}</span>
<a href="#l12.101"></a><span id="l12.101" class="difflineplus">+</span>
<a href="#l12.102"></a><span id="l12.102" class="difflineplus">+nsresult</span>
<a href="#l12.103"></a><span id="l12.103" class="difflineplus">+nsBeckySettings::CreateSmtpServer(const nsCString &amp;aUserName,</span>
<a href="#l12.104"></a><span id="l12.104" class="difflineplus">+                                  const nsCString &amp;aServerName,</span>
<a href="#l12.105"></a><span id="l12.105" class="difflineplus">+                                  nsISmtpServer **aServer,</span>
<a href="#l12.106"></a><span id="l12.106" class="difflineplus">+                                  bool *existing)</span>
<a href="#l12.107"></a><span id="l12.107" class="difflineplus">+{</span>
<a href="#l12.108"></a><span id="l12.108" class="difflineplus">+  nsresult rv;</span>
<a href="#l12.109"></a><span id="l12.109" class="difflineplus">+</span>
<a href="#l12.110"></a><span id="l12.110" class="difflineplus">+  nsCOMPtr&lt;nsISmtpService&gt; smtpService = do_GetService(NS_SMTPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l12.111"></a><span id="l12.111" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.112"></a><span id="l12.112" class="difflineplus">+</span>
<a href="#l12.113"></a><span id="l12.113" class="difflineplus">+  nsCOMPtr&lt;nsISmtpServer&gt; server;</span>
<a href="#l12.114"></a><span id="l12.114" class="difflineplus">+  rv = smtpService-&gt;FindServer(aUserName.get(),</span>
<a href="#l12.115"></a><span id="l12.115" class="difflineplus">+                               aServerName.get(),</span>
<a href="#l12.116"></a><span id="l12.116" class="difflineplus">+                               getter_AddRefs(server));</span>
<a href="#l12.117"></a><span id="l12.117" class="difflineplus">+</span>
<a href="#l12.118"></a><span id="l12.118" class="difflineplus">+  if (NS_FAILED(rv) || !server) {</span>
<a href="#l12.119"></a><span id="l12.119" class="difflineplus">+    rv = smtpService-&gt;CreateServer(getter_AddRefs(server));</span>
<a href="#l12.120"></a><span id="l12.120" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.121"></a><span id="l12.121" class="difflineplus">+</span>
<a href="#l12.122"></a><span id="l12.122" class="difflineplus">+    server-&gt;SetHostname(aServerName);</span>
<a href="#l12.123"></a><span id="l12.123" class="difflineplus">+    server-&gt;SetUsername(aUserName);</span>
<a href="#l12.124"></a><span id="l12.124" class="difflineplus">+    *existing = false;</span>
<a href="#l12.125"></a><span id="l12.125" class="difflineplus">+  } else {</span>
<a href="#l12.126"></a><span id="l12.126" class="difflineplus">+    *existing = true;</span>
<a href="#l12.127"></a><span id="l12.127" class="difflineplus">+  }</span>
<a href="#l12.128"></a><span id="l12.128" class="difflineplus">+</span>
<a href="#l12.129"></a><span id="l12.129" class="difflineplus">+  server.forget(aServer);</span>
<a href="#l12.130"></a><span id="l12.130" class="difflineplus">+</span>
<a href="#l12.131"></a><span id="l12.131" class="difflineplus">+  return NS_OK;</span>
<a href="#l12.132"></a><span id="l12.132" class="difflineplus">+}</span>
<a href="#l12.133"></a><span id="l12.133" class="difflineplus">+</span>
<a href="#l12.134"></a><span id="l12.134" class="difflineplus">+nsresult</span>
<a href="#l12.135"></a><span id="l12.135" class="difflineplus">+nsBeckySettings::CreateIncomingServer(const nsCString &amp;aUserName,</span>
<a href="#l12.136"></a><span id="l12.136" class="difflineplus">+                                      const nsCString &amp;aServerName,</span>
<a href="#l12.137"></a><span id="l12.137" class="difflineplus">+                                      const nsCString &amp;aProtocol,</span>
<a href="#l12.138"></a><span id="l12.138" class="difflineplus">+                                      nsIMsgIncomingServer **aServer)</span>
<a href="#l12.139"></a><span id="l12.139" class="difflineplus">+{</span>
<a href="#l12.140"></a><span id="l12.140" class="difflineplus">+  nsresult rv;</span>
<a href="#l12.141"></a><span id="l12.141" class="difflineplus">+  nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager = do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l12.142"></a><span id="l12.142" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.143"></a><span id="l12.143" class="difflineplus">+</span>
<a href="#l12.144"></a><span id="l12.144" class="difflineplus">+  nsCOMPtr&lt;nsIMsgIncomingServer&gt; incomingServer;</span>
<a href="#l12.145"></a><span id="l12.145" class="difflineplus">+  rv = accountManager-&gt;FindServer(aUserName,</span>
<a href="#l12.146"></a><span id="l12.146" class="difflineplus">+                                  aServerName,</span>
<a href="#l12.147"></a><span id="l12.147" class="difflineplus">+                                  aProtocol,</span>
<a href="#l12.148"></a><span id="l12.148" class="difflineplus">+                                  getter_AddRefs(incomingServer));</span>
<a href="#l12.149"></a><span id="l12.149" class="difflineplus">+</span>
<a href="#l12.150"></a><span id="l12.150" class="difflineplus">+  if (NS_FAILED(rv) || !incomingServer) {</span>
<a href="#l12.151"></a><span id="l12.151" class="difflineplus">+    rv = accountManager-&gt;CreateIncomingServer(aUserName,</span>
<a href="#l12.152"></a><span id="l12.152" class="difflineplus">+                                              aServerName,</span>
<a href="#l12.153"></a><span id="l12.153" class="difflineplus">+                                              aProtocol,</span>
<a href="#l12.154"></a><span id="l12.154" class="difflineplus">+                                              getter_AddRefs(incomingServer));</span>
<a href="#l12.155"></a><span id="l12.155" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.156"></a><span id="l12.156" class="difflineplus">+  }</span>
<a href="#l12.157"></a><span id="l12.157" class="difflineplus">+  incomingServer.forget(aServer);</span>
<a href="#l12.158"></a><span id="l12.158" class="difflineplus">+</span>
<a href="#l12.159"></a><span id="l12.159" class="difflineplus">+  return NS_OK;</span>
<a href="#l12.160"></a><span id="l12.160" class="difflineplus">+}</span>
<a href="#l12.161"></a><span id="l12.161" class="difflineplus">+</span>
<a href="#l12.162"></a><span id="l12.162" class="difflineplus">+nsresult</span>
<a href="#l12.163"></a><span id="l12.163" class="difflineplus">+nsBeckySettings::SetupSmtpServer(nsISmtpServer **aServer)</span>
<a href="#l12.164"></a><span id="l12.164" class="difflineplus">+{</span>
<a href="#l12.165"></a><span id="l12.165" class="difflineplus">+  nsresult rv;</span>
<a href="#l12.166"></a><span id="l12.166" class="difflineplus">+  nsAutoCString userName, serverName;</span>
<a href="#l12.167"></a><span id="l12.167" class="difflineplus">+</span>
<a href="#l12.168"></a><span id="l12.168" class="difflineplus">+  mParser-&gt;GetString(NS_LITERAL_CSTRING(&quot;Account&quot;),</span>
<a href="#l12.169"></a><span id="l12.169" class="difflineplus">+                     NS_LITERAL_CSTRING(&quot;SMTPServer&quot;),</span>
<a href="#l12.170"></a><span id="l12.170" class="difflineplus">+                     serverName);</span>
<a href="#l12.171"></a><span id="l12.171" class="difflineplus">+  mParser-&gt;GetString(NS_LITERAL_CSTRING(&quot;Account&quot;),</span>
<a href="#l12.172"></a><span id="l12.172" class="difflineplus">+                     NS_LITERAL_CSTRING(&quot;UserID&quot;),</span>
<a href="#l12.173"></a><span id="l12.173" class="difflineplus">+                     userName);</span>
<a href="#l12.174"></a><span id="l12.174" class="difflineplus">+</span>
<a href="#l12.175"></a><span id="l12.175" class="difflineplus">+  nsCOMPtr&lt;nsISmtpServer&gt; server;</span>
<a href="#l12.176"></a><span id="l12.176" class="difflineplus">+  bool existing = false;</span>
<a href="#l12.177"></a><span id="l12.177" class="difflineplus">+  rv = CreateSmtpServer(userName, serverName, getter_AddRefs(server), &amp;existing);</span>
<a href="#l12.178"></a><span id="l12.178" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.179"></a><span id="l12.179" class="difflineplus">+</span>
<a href="#l12.180"></a><span id="l12.180" class="difflineplus">+  // If we already have an existing server, do not touch it's settings.</span>
<a href="#l12.181"></a><span id="l12.181" class="difflineplus">+  if (existing) {</span>
<a href="#l12.182"></a><span id="l12.182" class="difflineplus">+    server.forget(aServer);</span>
<a href="#l12.183"></a><span id="l12.183" class="difflineplus">+    return NS_OK;</span>
<a href="#l12.184"></a><span id="l12.184" class="difflineplus">+  }</span>
<a href="#l12.185"></a><span id="l12.185" class="difflineplus">+</span>
<a href="#l12.186"></a><span id="l12.186" class="difflineplus">+  nsAutoCString value;</span>
<a href="#l12.187"></a><span id="l12.187" class="difflineplus">+  rv = mParser-&gt;GetString(NS_LITERAL_CSTRING(&quot;Account&quot;),</span>
<a href="#l12.188"></a><span id="l12.188" class="difflineplus">+                          NS_LITERAL_CSTRING(&quot;SMTPPort&quot;),</span>
<a href="#l12.189"></a><span id="l12.189" class="difflineplus">+                          value);</span>
<a href="#l12.190"></a><span id="l12.190" class="difflineplus">+  int32_t port = 25;</span>
<a href="#l12.191"></a><span id="l12.191" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l12.192"></a><span id="l12.192" class="difflineplus">+    nsresult errorCode;</span>
<a href="#l12.193"></a><span id="l12.193" class="difflineplus">+    port = value.ToInteger(&amp;errorCode, 10);</span>
<a href="#l12.194"></a><span id="l12.194" class="difflineplus">+  }</span>
<a href="#l12.195"></a><span id="l12.195" class="difflineplus">+  server-&gt;SetPort(port);</span>
<a href="#l12.196"></a><span id="l12.196" class="difflineplus">+</span>
<a href="#l12.197"></a><span id="l12.197" class="difflineplus">+  mParser-&gt;GetString(NS_LITERAL_CSTRING(&quot;Account&quot;),</span>
<a href="#l12.198"></a><span id="l12.198" class="difflineplus">+                     NS_LITERAL_CSTRING(&quot;SSLSMTP&quot;),</span>
<a href="#l12.199"></a><span id="l12.199" class="difflineplus">+                     value);</span>
<a href="#l12.200"></a><span id="l12.200" class="difflineplus">+  if (value.Equals(&quot;1&quot;))</span>
<a href="#l12.201"></a><span id="l12.201" class="difflineplus">+    server-&gt;SetSocketType(nsMsgSocketType::SSL);</span>
<a href="#l12.202"></a><span id="l12.202" class="difflineplus">+</span>
<a href="#l12.203"></a><span id="l12.203" class="difflineplus">+  mParser-&gt;GetString(NS_LITERAL_CSTRING(&quot;Account&quot;),</span>
<a href="#l12.204"></a><span id="l12.204" class="difflineplus">+                     NS_LITERAL_CSTRING(&quot;SMTPAUTH&quot;),</span>
<a href="#l12.205"></a><span id="l12.205" class="difflineplus">+                     value);</span>
<a href="#l12.206"></a><span id="l12.206" class="difflineplus">+  if (value.Equals(&quot;1&quot;)) {</span>
<a href="#l12.207"></a><span id="l12.207" class="difflineplus">+    mParser-&gt;GetString(NS_LITERAL_CSTRING(&quot;Account&quot;),</span>
<a href="#l12.208"></a><span id="l12.208" class="difflineplus">+                       NS_LITERAL_CSTRING(&quot;SMTPAUTHMODE&quot;),</span>
<a href="#l12.209"></a><span id="l12.209" class="difflineplus">+                       value);</span>
<a href="#l12.210"></a><span id="l12.210" class="difflineplus">+    nsMsgAuthMethodValue authMethod = nsMsgAuthMethod::none;</span>
<a href="#l12.211"></a><span id="l12.211" class="difflineplus">+    if (value.Equals(&quot;1&quot;)) {</span>
<a href="#l12.212"></a><span id="l12.212" class="difflineplus">+      authMethod = nsMsgAuthMethod::passwordEncrypted;</span>
<a href="#l12.213"></a><span id="l12.213" class="difflineplus">+    } else if (value.Equals(&quot;2&quot;) ||</span>
<a href="#l12.214"></a><span id="l12.214" class="difflineplus">+               value.Equals(&quot;4&quot;) ||</span>
<a href="#l12.215"></a><span id="l12.215" class="difflineplus">+               value.Equals(&quot;6&quot;)) {</span>
<a href="#l12.216"></a><span id="l12.216" class="difflineplus">+      authMethod = nsMsgAuthMethod::passwordCleartext;</span>
<a href="#l12.217"></a><span id="l12.217" class="difflineplus">+    } else {</span>
<a href="#l12.218"></a><span id="l12.218" class="difflineplus">+      authMethod = nsMsgAuthMethod::anything;</span>
<a href="#l12.219"></a><span id="l12.219" class="difflineplus">+    }</span>
<a href="#l12.220"></a><span id="l12.220" class="difflineplus">+    server-&gt;SetAuthMethod(authMethod);</span>
<a href="#l12.221"></a><span id="l12.221" class="difflineplus">+  }</span>
<a href="#l12.222"></a><span id="l12.222" class="difflineplus">+</span>
<a href="#l12.223"></a><span id="l12.223" class="difflineplus">+  server.forget(aServer);</span>
<a href="#l12.224"></a><span id="l12.224" class="difflineplus">+</span>
<a href="#l12.225"></a><span id="l12.225" class="difflineplus">+  return NS_OK;</span>
<a href="#l12.226"></a><span id="l12.226" class="difflineplus">+}</span>
<a href="#l12.227"></a><span id="l12.227" class="difflineplus">+</span>
<a href="#l12.228"></a><span id="l12.228" class="difflineplus">+nsresult</span>
<a href="#l12.229"></a><span id="l12.229" class="difflineplus">+nsBeckySettings::SetPop3ServerProperties(nsIMsgIncomingServer *aServer)</span>
<a href="#l12.230"></a><span id="l12.230" class="difflineplus">+{</span>
<a href="#l12.231"></a><span id="l12.231" class="difflineplus">+  nsCOMPtr&lt;nsIPop3IncomingServer&gt; pop3Server = do_QueryInterface(aServer);</span>
<a href="#l12.232"></a><span id="l12.232" class="difflineplus">+</span>
<a href="#l12.233"></a><span id="l12.233" class="difflineplus">+  nsAutoCString value;</span>
<a href="#l12.234"></a><span id="l12.234" class="difflineplus">+  mParser-&gt;GetString(NS_LITERAL_CSTRING(&quot;Account&quot;),</span>
<a href="#l12.235"></a><span id="l12.235" class="difflineplus">+                     NS_LITERAL_CSTRING(&quot;POP3Auth&quot;),</span>
<a href="#l12.236"></a><span id="l12.236" class="difflineplus">+                     value); // 0: plain, 1: APOP, 2: CRAM-MD5, 3: NTLM</span>
<a href="#l12.237"></a><span id="l12.237" class="difflineplus">+  nsMsgAuthMethodValue authMethod;</span>
<a href="#l12.238"></a><span id="l12.238" class="difflineplus">+  if (value.IsEmpty() || value.Equals(&quot;0&quot;)) {</span>
<a href="#l12.239"></a><span id="l12.239" class="difflineplus">+    authMethod = nsMsgAuthMethod::passwordCleartext;</span>
<a href="#l12.240"></a><span id="l12.240" class="difflineplus">+  } else if (value.Equals(&quot;1&quot;)) {</span>
<a href="#l12.241"></a><span id="l12.241" class="difflineplus">+    authMethod = nsMsgAuthMethod::old;</span>
<a href="#l12.242"></a><span id="l12.242" class="difflineplus">+  } else if (value.Equals(&quot;2&quot;)) {</span>
<a href="#l12.243"></a><span id="l12.243" class="difflineplus">+    authMethod = nsMsgAuthMethod::passwordEncrypted;</span>
<a href="#l12.244"></a><span id="l12.244" class="difflineplus">+  } else if (value.Equals(&quot;3&quot;)) {</span>
<a href="#l12.245"></a><span id="l12.245" class="difflineplus">+    authMethod = nsMsgAuthMethod::NTLM;</span>
<a href="#l12.246"></a><span id="l12.246" class="difflineplus">+  } else {</span>
<a href="#l12.247"></a><span id="l12.247" class="difflineplus">+    authMethod = nsMsgAuthMethod::none;</span>
<a href="#l12.248"></a><span id="l12.248" class="difflineplus">+  }</span>
<a href="#l12.249"></a><span id="l12.249" class="difflineplus">+  aServer-&gt;SetAuthMethod(authMethod);</span>
<a href="#l12.250"></a><span id="l12.250" class="difflineplus">+</span>
<a href="#l12.251"></a><span id="l12.251" class="difflineplus">+  mParser-&gt;GetString(NS_LITERAL_CSTRING(&quot;Account&quot;),</span>
<a href="#l12.252"></a><span id="l12.252" class="difflineplus">+                     NS_LITERAL_CSTRING(&quot;LeaveServer&quot;),</span>
<a href="#l12.253"></a><span id="l12.253" class="difflineplus">+                     value);</span>
<a href="#l12.254"></a><span id="l12.254" class="difflineplus">+  if (value.Equals(&quot;1&quot;)) {</span>
<a href="#l12.255"></a><span id="l12.255" class="difflineplus">+    pop3Server-&gt;SetLeaveMessagesOnServer(true);</span>
<a href="#l12.256"></a><span id="l12.256" class="difflineplus">+    nsresult rv = mParser-&gt;GetString(NS_LITERAL_CSTRING(&quot;Account&quot;),</span>
<a href="#l12.257"></a><span id="l12.257" class="difflineplus">+                                     NS_LITERAL_CSTRING(&quot;KeepDays&quot;),</span>
<a href="#l12.258"></a><span id="l12.258" class="difflineplus">+                                     value);</span>
<a href="#l12.259"></a><span id="l12.259" class="difflineplus">+    if (NS_FAILED(rv))</span>
<a href="#l12.260"></a><span id="l12.260" class="difflineplus">+      return NS_OK;</span>
<a href="#l12.261"></a><span id="l12.261" class="difflineplus">+</span>
<a href="#l12.262"></a><span id="l12.262" class="difflineplus">+    nsresult errorCode;</span>
<a href="#l12.263"></a><span id="l12.263" class="difflineplus">+    int32_t leftDays = value.ToInteger(&amp;errorCode, 10);</span>
<a href="#l12.264"></a><span id="l12.264" class="difflineplus">+    if (NS_SUCCEEDED(errorCode)) {</span>
<a href="#l12.265"></a><span id="l12.265" class="difflineplus">+      pop3Server-&gt;SetNumDaysToLeaveOnServer(leftDays);</span>
<a href="#l12.266"></a><span id="l12.266" class="difflineplus">+      pop3Server-&gt;SetDeleteByAgeFromServer(true);</span>
<a href="#l12.267"></a><span id="l12.267" class="difflineplus">+    }</span>
<a href="#l12.268"></a><span id="l12.268" class="difflineplus">+  }</span>
<a href="#l12.269"></a><span id="l12.269" class="difflineplus">+</span>
<a href="#l12.270"></a><span id="l12.270" class="difflineplus">+  return NS_OK;</span>
<a href="#l12.271"></a><span id="l12.271" class="difflineplus">+}</span>
<a href="#l12.272"></a><span id="l12.272" class="difflineplus">+</span>
<a href="#l12.273"></a><span id="l12.273" class="difflineplus">+nsresult</span>
<a href="#l12.274"></a><span id="l12.274" class="difflineplus">+nsBeckySettings::SetupIncomingServer(nsIMsgIncomingServer **aServer)</span>
<a href="#l12.275"></a><span id="l12.275" class="difflineplus">+{</span>
<a href="#l12.276"></a><span id="l12.276" class="difflineplus">+  nsAutoCString value;</span>
<a href="#l12.277"></a><span id="l12.277" class="difflineplus">+  mParser-&gt;GetString(NS_LITERAL_CSTRING(&quot;Account&quot;),</span>
<a href="#l12.278"></a><span id="l12.278" class="difflineplus">+                     NS_LITERAL_CSTRING(&quot;Protocol&quot;),</span>
<a href="#l12.279"></a><span id="l12.279" class="difflineplus">+                     value);</span>
<a href="#l12.280"></a><span id="l12.280" class="difflineplus">+  nsCString protocol;</span>
<a href="#l12.281"></a><span id="l12.281" class="difflineplus">+  if (value.Equals(&quot;1&quot;)) {</span>
<a href="#l12.282"></a><span id="l12.282" class="difflineplus">+    protocol = NS_LITERAL_CSTRING(&quot;imap&quot;);</span>
<a href="#l12.283"></a><span id="l12.283" class="difflineplus">+  } else {</span>
<a href="#l12.284"></a><span id="l12.284" class="difflineplus">+    protocol = NS_LITERAL_CSTRING(&quot;pop3&quot;);</span>
<a href="#l12.285"></a><span id="l12.285" class="difflineplus">+  }</span>
<a href="#l12.286"></a><span id="l12.286" class="difflineplus">+</span>
<a href="#l12.287"></a><span id="l12.287" class="difflineplus">+  nsAutoCString userName, serverName;</span>
<a href="#l12.288"></a><span id="l12.288" class="difflineplus">+  mParser-&gt;GetString(NS_LITERAL_CSTRING(&quot;Account&quot;),</span>
<a href="#l12.289"></a><span id="l12.289" class="difflineplus">+                     NS_LITERAL_CSTRING(&quot;MailServer&quot;),</span>
<a href="#l12.290"></a><span id="l12.290" class="difflineplus">+                     serverName);</span>
<a href="#l12.291"></a><span id="l12.291" class="difflineplus">+  mParser-&gt;GetString(NS_LITERAL_CSTRING(&quot;Account&quot;),</span>
<a href="#l12.292"></a><span id="l12.292" class="difflineplus">+                     NS_LITERAL_CSTRING(&quot;UserID&quot;),</span>
<a href="#l12.293"></a><span id="l12.293" class="difflineplus">+                     userName);</span>
<a href="#l12.294"></a><span id="l12.294" class="difflineplus">+</span>
<a href="#l12.295"></a><span id="l12.295" class="difflineplus">+  nsresult rv;</span>
<a href="#l12.296"></a><span id="l12.296" class="difflineplus">+  nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l12.297"></a><span id="l12.297" class="difflineplus">+  rv = CreateIncomingServer(userName, serverName, protocol, getter_AddRefs(server));</span>
<a href="#l12.298"></a><span id="l12.298" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.299"></a><span id="l12.299" class="difflineplus">+</span>
<a href="#l12.300"></a><span id="l12.300" class="difflineplus">+  bool isSecure = false;</span>
<a href="#l12.301"></a><span id="l12.301" class="difflineplus">+  int32_t port = 0;</span>
<a href="#l12.302"></a><span id="l12.302" class="difflineplus">+  nsresult errorCode;</span>
<a href="#l12.303"></a><span id="l12.303" class="difflineplus">+  if (protocol.EqualsLiteral(&quot;pop3&quot;)) {</span>
<a href="#l12.304"></a><span id="l12.304" class="difflineplus">+    SetPop3ServerProperties(server);</span>
<a href="#l12.305"></a><span id="l12.305" class="difflineplus">+    rv = mParser-&gt;GetString(NS_LITERAL_CSTRING(&quot;Account&quot;),</span>
<a href="#l12.306"></a><span id="l12.306" class="difflineplus">+                            NS_LITERAL_CSTRING(&quot;POP3Port&quot;),</span>
<a href="#l12.307"></a><span id="l12.307" class="difflineplus">+                            value);</span>
<a href="#l12.308"></a><span id="l12.308" class="difflineplus">+    if (NS_SUCCEEDED(rv))</span>
<a href="#l12.309"></a><span id="l12.309" class="difflineplus">+      port = value.ToInteger(&amp;errorCode, 10);</span>
<a href="#l12.310"></a><span id="l12.310" class="difflineplus">+    else</span>
<a href="#l12.311"></a><span id="l12.311" class="difflineplus">+      port = 110;</span>
<a href="#l12.312"></a><span id="l12.312" class="difflineplus">+    mParser-&gt;GetString(NS_LITERAL_CSTRING(&quot;Account&quot;),</span>
<a href="#l12.313"></a><span id="l12.313" class="difflineplus">+                       NS_LITERAL_CSTRING(&quot;SSLPOP&quot;),</span>
<a href="#l12.314"></a><span id="l12.314" class="difflineplus">+                       value);</span>
<a href="#l12.315"></a><span id="l12.315" class="difflineplus">+    if (value.Equals(&quot;1&quot;))</span>
<a href="#l12.316"></a><span id="l12.316" class="difflineplus">+      isSecure = true;</span>
<a href="#l12.317"></a><span id="l12.317" class="difflineplus">+  } else if (protocol.EqualsLiteral(&quot;imap&quot;)) {</span>
<a href="#l12.318"></a><span id="l12.318" class="difflineplus">+    rv = mParser-&gt;GetString(NS_LITERAL_CSTRING(&quot;Account&quot;),</span>
<a href="#l12.319"></a><span id="l12.319" class="difflineplus">+                            NS_LITERAL_CSTRING(&quot;IMAP4Port&quot;),</span>
<a href="#l12.320"></a><span id="l12.320" class="difflineplus">+                            value);</span>
<a href="#l12.321"></a><span id="l12.321" class="difflineplus">+    if (NS_SUCCEEDED(rv))</span>
<a href="#l12.322"></a><span id="l12.322" class="difflineplus">+      port = value.ToInteger(&amp;errorCode, 10);</span>
<a href="#l12.323"></a><span id="l12.323" class="difflineplus">+    else</span>
<a href="#l12.324"></a><span id="l12.324" class="difflineplus">+      port = 143;</span>
<a href="#l12.325"></a><span id="l12.325" class="difflineplus">+    mParser-&gt;GetString(NS_LITERAL_CSTRING(&quot;Account&quot;),</span>
<a href="#l12.326"></a><span id="l12.326" class="difflineplus">+                       NS_LITERAL_CSTRING(&quot;SSLIMAP&quot;),</span>
<a href="#l12.327"></a><span id="l12.327" class="difflineplus">+                       value);</span>
<a href="#l12.328"></a><span id="l12.328" class="difflineplus">+    if (value.Equals(&quot;1&quot;))</span>
<a href="#l12.329"></a><span id="l12.329" class="difflineplus">+      isSecure = true;</span>
<a href="#l12.330"></a><span id="l12.330" class="difflineplus">+  }</span>
<a href="#l12.331"></a><span id="l12.331" class="difflineplus">+</span>
<a href="#l12.332"></a><span id="l12.332" class="difflineplus">+  server-&gt;SetPort(port);</span>
<a href="#l12.333"></a><span id="l12.333" class="difflineplus">+  if (isSecure)</span>
<a href="#l12.334"></a><span id="l12.334" class="difflineplus">+    server-&gt;SetSocketType(nsMsgSocketType::SSL);</span>
<a href="#l12.335"></a><span id="l12.335" class="difflineplus">+</span>
<a href="#l12.336"></a><span id="l12.336" class="difflineplus">+  mParser-&gt;GetString(NS_LITERAL_CSTRING(&quot;Account&quot;),</span>
<a href="#l12.337"></a><span id="l12.337" class="difflineplus">+                     NS_LITERAL_CSTRING(&quot;CheckInt&quot;),</span>
<a href="#l12.338"></a><span id="l12.338" class="difflineplus">+                     value);</span>
<a href="#l12.339"></a><span id="l12.339" class="difflineplus">+  if (value.Equals(&quot;1&quot;))</span>
<a href="#l12.340"></a><span id="l12.340" class="difflineplus">+    server-&gt;SetDoBiff(true);</span>
<a href="#l12.341"></a><span id="l12.341" class="difflineplus">+  rv = mParser-&gt;GetString(NS_LITERAL_CSTRING(&quot;Account&quot;),</span>
<a href="#l12.342"></a><span id="l12.342" class="difflineplus">+                          NS_LITERAL_CSTRING(&quot;CheckEvery&quot;),</span>
<a href="#l12.343"></a><span id="l12.343" class="difflineplus">+                          value);</span>
<a href="#l12.344"></a><span id="l12.344" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l12.345"></a><span id="l12.345" class="difflineplus">+    int32_t minutes = value.ToInteger(&amp;errorCode, 10);</span>
<a href="#l12.346"></a><span id="l12.346" class="difflineplus">+    if (NS_SUCCEEDED(errorCode))</span>
<a href="#l12.347"></a><span id="l12.347" class="difflineplus">+      server-&gt;SetBiffMinutes(minutes);</span>
<a href="#l12.348"></a><span id="l12.348" class="difflineplus">+  }</span>
<a href="#l12.349"></a><span id="l12.349" class="difflineplus">+</span>
<a href="#l12.350"></a><span id="l12.350" class="difflineplus">+  server.forget(aServer);</span>
<a href="#l12.351"></a><span id="l12.351" class="difflineplus">+</span>
<a href="#l12.352"></a><span id="l12.352" class="difflineplus">+  return NS_OK;</span>
<a href="#l12.353"></a><span id="l12.353" class="difflineplus">+}</span>
<a href="#l12.354"></a><span id="l12.354" class="difflineplus">+</span>
<a href="#l12.355"></a><span id="l12.355" class="difflineplus">+nsresult</span>
<a href="#l12.356"></a><span id="l12.356" class="difflineplus">+nsBeckySettings::CreateIdentity(nsIMsgIdentity **aIdentity)</span>
<a href="#l12.357"></a><span id="l12.357" class="difflineplus">+{</span>
<a href="#l12.358"></a><span id="l12.358" class="difflineplus">+  nsAutoCString email, fullName, identityName, bccAddress;</span>
<a href="#l12.359"></a><span id="l12.359" class="difflineplus">+</span>
<a href="#l12.360"></a><span id="l12.360" class="difflineplus">+  mParser-&gt;GetString(NS_LITERAL_CSTRING(&quot;Account&quot;),</span>
<a href="#l12.361"></a><span id="l12.361" class="difflineplus">+                     NS_LITERAL_CSTRING(&quot;Name&quot;),</span>
<a href="#l12.362"></a><span id="l12.362" class="difflineplus">+                     identityName);</span>
<a href="#l12.363"></a><span id="l12.363" class="difflineplus">+  mParser-&gt;GetString(NS_LITERAL_CSTRING(&quot;Account&quot;),</span>
<a href="#l12.364"></a><span id="l12.364" class="difflineplus">+                     NS_LITERAL_CSTRING(&quot;YourName&quot;),</span>
<a href="#l12.365"></a><span id="l12.365" class="difflineplus">+                     fullName);</span>
<a href="#l12.366"></a><span id="l12.366" class="difflineplus">+  mParser-&gt;GetString(NS_LITERAL_CSTRING(&quot;Account&quot;),</span>
<a href="#l12.367"></a><span id="l12.367" class="difflineplus">+                     NS_LITERAL_CSTRING(&quot;MailAddress&quot;),</span>
<a href="#l12.368"></a><span id="l12.368" class="difflineplus">+                     email);</span>
<a href="#l12.369"></a><span id="l12.369" class="difflineplus">+  mParser-&gt;GetString(NS_LITERAL_CSTRING(&quot;Account&quot;),</span>
<a href="#l12.370"></a><span id="l12.370" class="difflineplus">+                     NS_LITERAL_CSTRING(&quot;PermBcc&quot;),</span>
<a href="#l12.371"></a><span id="l12.371" class="difflineplus">+                     bccAddress);</span>
<a href="#l12.372"></a><span id="l12.372" class="difflineplus">+</span>
<a href="#l12.373"></a><span id="l12.373" class="difflineplus">+  nsresult rv;</span>
<a href="#l12.374"></a><span id="l12.374" class="difflineplus">+  nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l12.375"></a><span id="l12.375" class="difflineplus">+    do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l12.376"></a><span id="l12.376" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.377"></a><span id="l12.377" class="difflineplus">+</span>
<a href="#l12.378"></a><span id="l12.378" class="difflineplus">+  nsCOMPtr&lt;nsIMsgIdentity&gt; identity;</span>
<a href="#l12.379"></a><span id="l12.379" class="difflineplus">+  rv = accountManager-&gt;CreateIdentity(getter_AddRefs(identity));</span>
<a href="#l12.380"></a><span id="l12.380" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.381"></a><span id="l12.381" class="difflineplus">+</span>
<a href="#l12.382"></a><span id="l12.382" class="difflineplus">+  identity-&gt;SetIdentityName(NS_ConvertUTF8toUTF16(identityName));</span>
<a href="#l12.383"></a><span id="l12.383" class="difflineplus">+  identity-&gt;SetFullName(NS_ConvertUTF8toUTF16(fullName));</span>
<a href="#l12.384"></a><span id="l12.384" class="difflineplus">+  identity-&gt;SetEmail(email);</span>
<a href="#l12.385"></a><span id="l12.385" class="difflineplus">+  if (!bccAddress.IsEmpty()) {</span>
<a href="#l12.386"></a><span id="l12.386" class="difflineplus">+    identity-&gt;SetDoBcc(true);</span>
<a href="#l12.387"></a><span id="l12.387" class="difflineplus">+    identity-&gt;SetDoBccList(bccAddress);</span>
<a href="#l12.388"></a><span id="l12.388" class="difflineplus">+  }</span>
<a href="#l12.389"></a><span id="l12.389" class="difflineplus">+</span>
<a href="#l12.390"></a><span id="l12.390" class="difflineplus">+  identity.forget(aIdentity);</span>
<a href="#l12.391"></a><span id="l12.391" class="difflineplus">+</span>
<a href="#l12.392"></a><span id="l12.392" class="difflineplus">+  return NS_OK;</span>
<a href="#l12.393"></a><span id="l12.393" class="difflineplus">+}</span>
<a href="#l12.394"></a><span id="l12.394" class="difflineplus">+</span>
<a href="#l12.395"></a><span id="l12.395" class="difflineplus">+nsresult</span>
<a href="#l12.396"></a><span id="l12.396" class="difflineplus">+nsBeckySettings::CreateAccount(nsIMsgIdentity *aIdentity,</span>
<a href="#l12.397"></a><span id="l12.397" class="difflineplus">+                               nsIMsgIncomingServer *aIncomingServer,</span>
<a href="#l12.398"></a><span id="l12.398" class="difflineplus">+                               nsIMsgAccount **aAccount)</span>
<a href="#l12.399"></a><span id="l12.399" class="difflineplus">+{</span>
<a href="#l12.400"></a><span id="l12.400" class="difflineplus">+  nsresult rv;</span>
<a href="#l12.401"></a><span id="l12.401" class="difflineplus">+  nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l12.402"></a><span id="l12.402" class="difflineplus">+    do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l12.403"></a><span id="l12.403" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.404"></a><span id="l12.404" class="difflineplus">+</span>
<a href="#l12.405"></a><span id="l12.405" class="difflineplus">+  nsCOMPtr&lt;nsIMsgAccount&gt; account;</span>
<a href="#l12.406"></a><span id="l12.406" class="difflineplus">+  rv = accountManager-&gt;CreateAccount(getter_AddRefs(account));</span>
<a href="#l12.407"></a><span id="l12.407" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.408"></a><span id="l12.408" class="difflineplus">+</span>
<a href="#l12.409"></a><span id="l12.409" class="difflineplus">+  rv = account-&gt;AddIdentity(aIdentity);</span>
<a href="#l12.410"></a><span id="l12.410" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.411"></a><span id="l12.411" class="difflineplus">+</span>
<a href="#l12.412"></a><span id="l12.412" class="difflineplus">+  rv = account-&gt;SetIncomingServer(aIncomingServer);</span>
<a href="#l12.413"></a><span id="l12.413" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.414"></a><span id="l12.414" class="difflineplus">+</span>
<a href="#l12.415"></a><span id="l12.415" class="difflineplus">+  account.forget(aAccount);</span>
<a href="#l12.416"></a><span id="l12.416" class="difflineplus">+</span>
<a href="#l12.417"></a><span id="l12.417" class="difflineplus">+  return NS_OK;</span>
<a href="#l12.418"></a><span id="l12.418" class="difflineplus">+}</span>
<a href="#l12.419"></a><span id="l12.419" class="difflineplus">+</span>
<a href="#l12.420"></a><span id="l12.420" class="difflineplus">+nsresult</span>
<a href="#l12.421"></a><span id="l12.421" class="difflineplus">+nsBeckySettings::RemoveConvertedFile()</span>
<a href="#l12.422"></a><span id="l12.422" class="difflineplus">+{</span>
<a href="#l12.423"></a><span id="l12.423" class="difflineplus">+  if (mConvertedFile) {</span>
<a href="#l12.424"></a><span id="l12.424" class="difflineplus">+    bool exists;</span>
<a href="#l12.425"></a><span id="l12.425" class="difflineplus">+    mConvertedFile-&gt;Exists(&amp;exists);</span>
<a href="#l12.426"></a><span id="l12.426" class="difflineplus">+    if (exists)</span>
<a href="#l12.427"></a><span id="l12.427" class="difflineplus">+      mConvertedFile-&gt;Remove(false);</span>
<a href="#l12.428"></a><span id="l12.428" class="difflineplus">+    mConvertedFile = nullptr;</span>
<a href="#l12.429"></a><span id="l12.429" class="difflineplus">+  }</span>
<a href="#l12.430"></a><span id="l12.430" class="difflineplus">+  return NS_OK;</span>
<a href="#l12.431"></a><span id="l12.431" class="difflineplus">+}</span>
<a href="#l12.432"></a><span id="l12.432" class="difflineplus">+</span>
<a href="#l12.433"></a><span id="l12.433" class="difflineplus">+#define NS_RETURN_IF_FAILED_WITH_REMOVE_CONVERTED_FILE(expr, rv) \</span>
<a href="#l12.434"></a><span id="l12.434" class="difflineplus">+  if (NS_FAILED(expr)) {                                         \</span>
<a href="#l12.435"></a><span id="l12.435" class="difflineplus">+    RemoveConvertedFile();                                       \</span>
<a href="#l12.436"></a><span id="l12.436" class="difflineplus">+    return rv;                                                   \</span>
<a href="#l12.437"></a><span id="l12.437" class="difflineplus">+  }</span>
<a href="#l12.438"></a><span id="l12.438" class="difflineplus">+</span>
<a href="#l12.439"></a><span id="l12.439" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l12.440"></a><span id="l12.440" class="difflineplus">+nsBeckySettings::Import(nsIMsgAccount **aLocalMailAccount,</span>
<a href="#l12.441"></a><span id="l12.441" class="difflineplus">+                        bool *_retval)</span>
<a href="#l12.442"></a><span id="l12.442" class="difflineplus">+{</span>
<a href="#l12.443"></a><span id="l12.443" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aLocalMailAccount);</span>
<a href="#l12.444"></a><span id="l12.444" class="difflineplus">+  NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l12.445"></a><span id="l12.445" class="difflineplus">+</span>
<a href="#l12.446"></a><span id="l12.446" class="difflineplus">+  nsresult rv = CreateParser();</span>
<a href="#l12.447"></a><span id="l12.447" class="difflineplus">+  NS_RETURN_IF_FAILED_WITH_REMOVE_CONVERTED_FILE(rv, rv);</span>
<a href="#l12.448"></a><span id="l12.448" class="difflineplus">+</span>
<a href="#l12.449"></a><span id="l12.449" class="difflineplus">+  nsCOMPtr&lt;nsIMsgIncomingServer&gt; incomingServer;</span>
<a href="#l12.450"></a><span id="l12.450" class="difflineplus">+  rv = SetupIncomingServer(getter_AddRefs(incomingServer));</span>
<a href="#l12.451"></a><span id="l12.451" class="difflineplus">+  NS_RETURN_IF_FAILED_WITH_REMOVE_CONVERTED_FILE(rv, rv);</span>
<a href="#l12.452"></a><span id="l12.452" class="difflineplus">+</span>
<a href="#l12.453"></a><span id="l12.453" class="difflineplus">+  nsCOMPtr&lt;nsISmtpServer&gt; smtpServer;</span>
<a href="#l12.454"></a><span id="l12.454" class="difflineplus">+  rv = SetupSmtpServer(getter_AddRefs(smtpServer));</span>
<a href="#l12.455"></a><span id="l12.455" class="difflineplus">+  NS_RETURN_IF_FAILED_WITH_REMOVE_CONVERTED_FILE(rv, rv);</span>
<a href="#l12.456"></a><span id="l12.456" class="difflineplus">+</span>
<a href="#l12.457"></a><span id="l12.457" class="difflineplus">+  nsCOMPtr&lt;nsIMsgIdentity&gt; identity;</span>
<a href="#l12.458"></a><span id="l12.458" class="difflineplus">+  rv = CreateIdentity(getter_AddRefs(identity));</span>
<a href="#l12.459"></a><span id="l12.459" class="difflineplus">+  NS_RETURN_IF_FAILED_WITH_REMOVE_CONVERTED_FILE(rv, rv);</span>
<a href="#l12.460"></a><span id="l12.460" class="difflineplus">+</span>
<a href="#l12.461"></a><span id="l12.461" class="difflineplus">+  nsAutoCString smtpKey;</span>
<a href="#l12.462"></a><span id="l12.462" class="difflineplus">+  smtpServer-&gt;GetKey(getter_Copies(smtpKey));</span>
<a href="#l12.463"></a><span id="l12.463" class="difflineplus">+  identity-&gt;SetSmtpServerKey(smtpKey);</span>
<a href="#l12.464"></a><span id="l12.464" class="difflineplus">+</span>
<a href="#l12.465"></a><span id="l12.465" class="difflineplus">+  nsCOMPtr&lt;nsIMsgAccount&gt; account;</span>
<a href="#l12.466"></a><span id="l12.466" class="difflineplus">+  rv = CreateAccount(identity, incomingServer, getter_AddRefs(account));</span>
<a href="#l12.467"></a><span id="l12.467" class="difflineplus">+  NS_RETURN_IF_FAILED_WITH_REMOVE_CONVERTED_FILE(rv, rv);</span>
<a href="#l12.468"></a><span id="l12.468" class="difflineplus">+</span>
<a href="#l12.469"></a><span id="l12.469" class="difflineplus">+  RemoveConvertedFile();</span>
<a href="#l12.470"></a><span id="l12.470" class="difflineplus">+  if (aLocalMailAccount)</span>
<a href="#l12.471"></a><span id="l12.471" class="difflineplus">+    account.forget(aLocalMailAccount);</span>
<a href="#l12.472"></a><span id="l12.472" class="difflineplus">+  *_retval = true;</span>
<a href="#l12.473"></a><span id="l12.473" class="difflineplus">+  return NS_OK;</span>
<a href="#l12.474"></a><span id="l12.474" class="difflineplus">+}</span>
<a href="#l12.475"></a><span id="l12.475" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1">new file mode 100644</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineminus">--- /dev/null</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineplus">+++ b/mailnews/import/becky/src/nsBeckySettings.h</span>
<a href="#l13.4"></a><span id="l13.4" class="difflineat">@@ -0,0 +1,52 @@</span>
<a href="#l13.5"></a><span id="l13.5" class="difflineplus">+/* vim: set ts=2 et sw=2 tw=80: */</span>
<a href="#l13.6"></a><span id="l13.6" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l13.7"></a><span id="l13.7" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l13.8"></a><span id="l13.8" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l13.9"></a><span id="l13.9" class="difflineplus">+</span>
<a href="#l13.10"></a><span id="l13.10" class="difflineplus">+#ifndef nsBeckySettings_h___</span>
<a href="#l13.11"></a><span id="l13.11" class="difflineplus">+#define nsBeckySettings_h___</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+#include &quot;nsIImportSettings.h&quot;</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+#include &quot;nsIFile.h&quot;</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+#include &quot;nsIINIParser.h&quot;</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineplus">+</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineplus">+class nsIMsgIncomingServer;</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineplus">+class nsIMsgIdentity;</span>
<a href="#l13.19"></a><span id="l13.19" class="difflineplus">+class nsISmtpServer;</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineplus">+</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineplus">+class nsBeckySettings final : public nsIImportSettings</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineplus">+{</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineplus">+public:</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineplus">+  nsBeckySettings();</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineplus">+  static nsresult Create(nsIImportSettings **aImport);</span>
<a href="#l13.26"></a><span id="l13.26" class="difflineplus">+</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineplus">+  NS_DECL_NSIIMPORTSETTINGS</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineplus">+</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineplus">+private:</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineplus">+  virtual ~nsBeckySettings();</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineplus">+</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; mLocation;</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; mConvertedFile;</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineplus">+  nsCOMPtr&lt;nsIINIParser&gt; mParser;</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineplus">+</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineplus">+  nsresult CreateParser();</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineplus">+  nsresult CreateIdentity(nsIMsgIdentity **aIdentity);</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineplus">+  nsresult CreateAccount(nsIMsgIdentity *aIdentity,</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineplus">+                         nsIMsgIncomingServer *aIncomingServer,</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineplus">+                         nsIMsgAccount **aAccount);</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineplus">+  nsresult CreateSmtpServer(const nsCString &amp;aUserName,</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineplus">+                            const nsCString &amp;aServerName,</span>
<a href="#l13.44"></a><span id="l13.44" class="difflineplus">+                            nsISmtpServer **aServer,</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineplus">+                            bool *existing);</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineplus">+  nsresult CreateIncomingServer(const nsCString &amp;aUserName,</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineplus">+                                const nsCString &amp;aServerName,</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineplus">+                                const nsCString &amp;aProtocol,</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineplus">+                                nsIMsgIncomingServer **aServer);</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineplus">+  nsresult SetupIncomingServer(nsIMsgIncomingServer **aServer);</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineplus">+  nsresult SetupSmtpServer(nsISmtpServer **aServer);</span>
<a href="#l13.52"></a><span id="l13.52" class="difflineplus">+  nsresult SetPop3ServerProperties(nsIMsgIncomingServer *aServer);</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineplus">+  nsresult RemoveConvertedFile();</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineplus">+};</span>
<a href="#l13.55"></a><span id="l13.55" class="difflineplus">+</span>
<a href="#l13.56"></a><span id="l13.56" class="difflineplus">+#endif /* nsBeckySettings_h___ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1">new file mode 100644</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineminus">--- /dev/null</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineplus">+++ b/mailnews/import/becky/src/nsBeckyStringBundle.cpp</span>
<a href="#l14.4"></a><span id="l14.4" class="difflineat">@@ -0,0 +1,74 @@</span>
<a href="#l14.5"></a><span id="l14.5" class="difflineplus">+/* vim: set ts=2 et sw=2 tw=80: */</span>
<a href="#l14.6"></a><span id="l14.6" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l14.7"></a><span id="l14.7" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l14.8"></a><span id="l14.8" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l14.9"></a><span id="l14.9" class="difflineplus">+</span>
<a href="#l14.10"></a><span id="l14.10" class="difflineplus">+#include &quot;prprf.h&quot;</span>
<a href="#l14.11"></a><span id="l14.11" class="difflineplus">+#include &quot;prmem.h&quot;</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineplus">+#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+#include &quot;nsIStringBundle.h&quot;</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+#include &quot;nsIServiceManager.h&quot;</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineplus">+#include &quot;nsIURI.h&quot;</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineplus">+#include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineplus">+#include &quot;nsXPCOMCIDInternal.h&quot;</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineplus">+</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineplus">+#include &quot;nsBeckyStringBundle.h&quot;</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineplus">+</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineplus">+#define BECKY_MESSAGES_URL &quot;chrome://messenger/locale/beckyImportMsgs.properties&quot;</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineplus">+</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineplus">+nsIStringBundle *nsBeckyStringBundle::mBundle = nullptr;</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineplus">+</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineplus">+nsIStringBundle *</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineplus">+nsBeckyStringBundle::GetStringBundle(void)</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineplus">+{</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineplus">+  if (mBundle)</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineplus">+    return mBundle;</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineplus">+</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineplus">+  nsresult rv;</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineplus">+  nsCOMPtr&lt;nsIStringBundleService&gt; bundleService = do_GetService(NS_STRINGBUNDLE_CONTRACTID, &amp;rv);</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; bundleService)</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineplus">+    rv = bundleService-&gt;CreateBundle(BECKY_MESSAGES_URL, &amp;mBundle);</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineplus">+</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineplus">+  return mBundle;</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineplus">+}</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineplus">+</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineplus">+void</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineplus">+nsBeckyStringBundle::EnsureStringBundle(void)</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineplus">+{</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineplus">+  if (!mBundle)</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineplus">+    (void) GetStringBundle();</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineplus">+}</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineplus">+</span>
<a href="#l14.46"></a><span id="l14.46" class="difflineplus">+char16_t *</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineplus">+nsBeckyStringBundle::GetStringByName(const char16_t *aName)</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineplus">+{</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineplus">+  EnsureStringBundle();</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineplus">+</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineplus">+  char16_t *string = nullptr;</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineplus">+  if (mBundle)</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineplus">+    mBundle-&gt;GetStringFromName(aName, &amp;string);</span>
<a href="#l14.54"></a><span id="l14.54" class="difflineplus">+</span>
<a href="#l14.55"></a><span id="l14.55" class="difflineplus">+  return string;</span>
<a href="#l14.56"></a><span id="l14.56" class="difflineplus">+}</span>
<a href="#l14.57"></a><span id="l14.57" class="difflineplus">+</span>
<a href="#l14.58"></a><span id="l14.58" class="difflineplus">+nsresult</span>
<a href="#l14.59"></a><span id="l14.59" class="difflineplus">+nsBeckyStringBundle::FormatStringFromName(const char16_t *name,</span>
<a href="#l14.60"></a><span id="l14.60" class="difflineplus">+                                          const char16_t **params,</span>
<a href="#l14.61"></a><span id="l14.61" class="difflineplus">+                                          uint32_t length,</span>
<a href="#l14.62"></a><span id="l14.62" class="difflineplus">+                                          char16_t **_retval)</span>
<a href="#l14.63"></a><span id="l14.63" class="difflineplus">+{</span>
<a href="#l14.64"></a><span id="l14.64" class="difflineplus">+  EnsureStringBundle();</span>
<a href="#l14.65"></a><span id="l14.65" class="difflineplus">+</span>
<a href="#l14.66"></a><span id="l14.66" class="difflineplus">+  return mBundle-&gt;FormatStringFromName(name,</span>
<a href="#l14.67"></a><span id="l14.67" class="difflineplus">+                                       params,</span>
<a href="#l14.68"></a><span id="l14.68" class="difflineplus">+                                       length,</span>
<a href="#l14.69"></a><span id="l14.69" class="difflineplus">+                                       _retval);</span>
<a href="#l14.70"></a><span id="l14.70" class="difflineplus">+}</span>
<a href="#l14.71"></a><span id="l14.71" class="difflineplus">+</span>
<a href="#l14.72"></a><span id="l14.72" class="difflineplus">+void</span>
<a href="#l14.73"></a><span id="l14.73" class="difflineplus">+nsBeckyStringBundle::Cleanup(void)</span>
<a href="#l14.74"></a><span id="l14.74" class="difflineplus">+{</span>
<a href="#l14.75"></a><span id="l14.75" class="difflineplus">+  if (mBundle)</span>
<a href="#l14.76"></a><span id="l14.76" class="difflineplus">+    mBundle-&gt;Release();</span>
<a href="#l14.77"></a><span id="l14.77" class="difflineplus">+  mBundle = nullptr;</span>
<a href="#l14.78"></a><span id="l14.78" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1">new file mode 100644</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineminus">--- /dev/null</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineplus">+++ b/mailnews/import/becky/src/nsBeckyStringBundle.h</span>
<a href="#l15.4"></a><span id="l15.4" class="difflineat">@@ -0,0 +1,33 @@</span>
<a href="#l15.5"></a><span id="l15.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l15.6"></a><span id="l15.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l15.7"></a><span id="l15.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l15.8"></a><span id="l15.8" class="difflineplus">+#ifndef _nsBeckyStringBundle_H__</span>
<a href="#l15.9"></a><span id="l15.9" class="difflineplus">+#define _nsBeckyStringBundle_H__</span>
<a href="#l15.10"></a><span id="l15.10" class="difflineplus">+</span>
<a href="#l15.11"></a><span id="l15.11" class="difflineplus">+#include &quot;nsString.h&quot;</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineplus">+</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+class nsIStringBundle;</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineplus">+</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineplus">+class nsBeckyStringBundle final {</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineplus">+public:</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineplus">+  static char16_t *GetStringByName(const char16_t *name);</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineplus">+  static nsresult FormatStringFromName(const char16_t *name,</span>
<a href="#l15.19"></a><span id="l15.19" class="difflineplus">+                                       const char16_t **params,</span>
<a href="#l15.20"></a><span id="l15.20" class="difflineplus">+                                       uint32_t length,</span>
<a href="#l15.21"></a><span id="l15.21" class="difflineplus">+                                       char16_t **_retval);</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineplus">+  static nsIStringBundle * GetStringBundle(void); // don't release</span>
<a href="#l15.23"></a><span id="l15.23" class="difflineplus">+  static void EnsureStringBundle(void);</span>
<a href="#l15.24"></a><span id="l15.24" class="difflineplus">+  static void Cleanup(void);</span>
<a href="#l15.25"></a><span id="l15.25" class="difflineplus">+private:</span>
<a href="#l15.26"></a><span id="l15.26" class="difflineplus">+  static nsIStringBundle *mBundle;</span>
<a href="#l15.27"></a><span id="l15.27" class="difflineplus">+};</span>
<a href="#l15.28"></a><span id="l15.28" class="difflineplus">+</span>
<a href="#l15.29"></a><span id="l15.29" class="difflineplus">+#define BECKYIMPORT_NAME                     2000</span>
<a href="#l15.30"></a><span id="l15.30" class="difflineplus">+#define BECKYIMPORT_DESCRIPTION              2001</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineplus">+#define BECKYIMPORT_MAILBOX_SUCCESS          2002</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineplus">+#define BECKYIMPORT_MAILBOX_BADPARAM         2003</span>
<a href="#l15.33"></a><span id="l15.33" class="difflineplus">+#define BECKYIMPORT_MAILBOX_CONVERTERROR     2004</span>
<a href="#l15.34"></a><span id="l15.34" class="difflineplus">+#define BECKYIMPORT_ADDRESS_SUCCESS          2005</span>
<a href="#l15.35"></a><span id="l15.35" class="difflineplus">+</span>
<a href="#l15.36"></a><span id="l15.36" class="difflineplus">+</span>
<a href="#l15.37"></a><span id="l15.37" class="difflineplus">+#endif /* _nsBeckyStringBundle_H__ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1">new file mode 100644</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineminus">--- /dev/null</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineplus">+++ b/mailnews/import/becky/src/nsBeckyUtils.cpp</span>
<a href="#l16.4"></a><span id="l16.4" class="difflineat">@@ -0,0 +1,315 @@</span>
<a href="#l16.5"></a><span id="l16.5" class="difflineplus">+/* vim: set ts=2 et sw=2 tw=80: */</span>
<a href="#l16.6"></a><span id="l16.6" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l16.7"></a><span id="l16.7" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l16.8"></a><span id="l16.8" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l16.9"></a><span id="l16.9" class="difflineplus">+</span>
<a href="#l16.10"></a><span id="l16.10" class="difflineplus">+#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l16.11"></a><span id="l16.11" class="difflineplus">+#include &quot;nsIFile.h&quot;</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineplus">+#include &quot;nsISimpleEnumerator.h&quot;</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+#include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineplus">+#include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineplus">+#include &quot;nsString.h&quot;</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineplus">+#include &quot;nsIUTF8ConverterService.h&quot;</span>
<a href="#l16.17"></a><span id="l16.17" class="difflineplus">+#include &quot;nsUConvCID.h&quot;</span>
<a href="#l16.18"></a><span id="l16.18" class="difflineplus">+#include &quot;nsNativeCharsetUtils.h&quot;</span>
<a href="#l16.19"></a><span id="l16.19" class="difflineplus">+#include &quot;nsIInputStream.h&quot;</span>
<a href="#l16.20"></a><span id="l16.20" class="difflineplus">+#include &quot;nsIOutputStream.h&quot;</span>
<a href="#l16.21"></a><span id="l16.21" class="difflineplus">+#include &quot;nsILineInputStream.h&quot;</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineplus">+#include &quot;nsIConverterInputStream.h&quot;</span>
<a href="#l16.23"></a><span id="l16.23" class="difflineplus">+#include &quot;nsIConverterOutputStream.h&quot;</span>
<a href="#l16.24"></a><span id="l16.24" class="difflineplus">+#include &quot;nsMsgI18N.h&quot;</span>
<a href="#l16.25"></a><span id="l16.25" class="difflineplus">+#include &quot;nsNetUtil.h&quot;</span>
<a href="#l16.26"></a><span id="l16.26" class="difflineplus">+#include &quot;nsIINIParser.h&quot;</span>
<a href="#l16.27"></a><span id="l16.27" class="difflineplus">+#include &quot;nsDirectoryServiceDefs.h&quot;</span>
<a href="#l16.28"></a><span id="l16.28" class="difflineplus">+#include &quot;nsDirectoryServiceUtils.h&quot;</span>
<a href="#l16.29"></a><span id="l16.29" class="difflineplus">+#include &quot;nsMsgUtils.h&quot;</span>
<a href="#l16.30"></a><span id="l16.30" class="difflineplus">+#include &quot;msgCore.h&quot;</span>
<a href="#l16.31"></a><span id="l16.31" class="difflineplus">+#include &quot;nsIImportMail.h&quot;</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineplus">+#include &quot;nsThreadUtils.h&quot;</span>
<a href="#l16.33"></a><span id="l16.33" class="difflineplus">+</span>
<a href="#l16.34"></a><span id="l16.34" class="difflineplus">+#include &quot;nsBeckyUtils.h&quot;</span>
<a href="#l16.35"></a><span id="l16.35" class="difflineplus">+#include &lt;windows.h&gt;</span>
<a href="#l16.36"></a><span id="l16.36" class="difflineplus">+</span>
<a href="#l16.37"></a><span id="l16.37" class="difflineplus">+nsresult</span>
<a href="#l16.38"></a><span id="l16.38" class="difflineplus">+nsBeckyUtils::FindUserDirectoryOnWindows7(nsIFile **aLocation)</span>
<a href="#l16.39"></a><span id="l16.39" class="difflineplus">+{</span>
<a href="#l16.40"></a><span id="l16.40" class="difflineplus">+  nsresult rv;</span>
<a href="#l16.41"></a><span id="l16.41" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; directory;</span>
<a href="#l16.42"></a><span id="l16.42" class="difflineplus">+  rv = GetSpecialDirectoryWithFileName(NS_WIN_DOCUMENTS_DIR,</span>
<a href="#l16.43"></a><span id="l16.43" class="difflineplus">+                                       &quot;Becky&quot;,</span>
<a href="#l16.44"></a><span id="l16.44" class="difflineplus">+                                       getter_AddRefs(directory));</span>
<a href="#l16.45"></a><span id="l16.45" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.46"></a><span id="l16.46" class="difflineplus">+</span>
<a href="#l16.47"></a><span id="l16.47" class="difflineplus">+  bool exists = false;</span>
<a href="#l16.48"></a><span id="l16.48" class="difflineplus">+  rv = directory-&gt;Exists(&amp;exists);</span>
<a href="#l16.49"></a><span id="l16.49" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.50"></a><span id="l16.50" class="difflineplus">+</span>
<a href="#l16.51"></a><span id="l16.51" class="difflineplus">+  if (!exists)</span>
<a href="#l16.52"></a><span id="l16.52" class="difflineplus">+    return NS_ERROR_FILE_NOT_FOUND;</span>
<a href="#l16.53"></a><span id="l16.53" class="difflineplus">+</span>
<a href="#l16.54"></a><span id="l16.54" class="difflineplus">+  directory.forget(aLocation);</span>
<a href="#l16.55"></a><span id="l16.55" class="difflineplus">+  return NS_OK;</span>
<a href="#l16.56"></a><span id="l16.56" class="difflineplus">+}</span>
<a href="#l16.57"></a><span id="l16.57" class="difflineplus">+</span>
<a href="#l16.58"></a><span id="l16.58" class="difflineplus">+nsresult</span>
<a href="#l16.59"></a><span id="l16.59" class="difflineplus">+nsBeckyUtils::FindUserDirectoryOnWindowsXP(nsIFile **aLocation)</span>
<a href="#l16.60"></a><span id="l16.60" class="difflineplus">+{</span>
<a href="#l16.61"></a><span id="l16.61" class="difflineplus">+  nsresult rv;</span>
<a href="#l16.62"></a><span id="l16.62" class="difflineplus">+</span>
<a href="#l16.63"></a><span id="l16.63" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; directory = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l16.64"></a><span id="l16.64" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.65"></a><span id="l16.65" class="difflineplus">+</span>
<a href="#l16.66"></a><span id="l16.66" class="difflineplus">+  rv = directory-&gt;InitWithPath(NS_LITERAL_STRING(&quot;C:\\Becky!&quot;));</span>
<a href="#l16.67"></a><span id="l16.67" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.68"></a><span id="l16.68" class="difflineplus">+</span>
<a href="#l16.69"></a><span id="l16.69" class="difflineplus">+  bool exists = false;</span>
<a href="#l16.70"></a><span id="l16.70" class="difflineplus">+  rv = directory-&gt;Exists(&amp;exists);</span>
<a href="#l16.71"></a><span id="l16.71" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.72"></a><span id="l16.72" class="difflineplus">+</span>
<a href="#l16.73"></a><span id="l16.73" class="difflineplus">+  if (!exists)</span>
<a href="#l16.74"></a><span id="l16.74" class="difflineplus">+    return NS_ERROR_FILE_NOT_FOUND;</span>
<a href="#l16.75"></a><span id="l16.75" class="difflineplus">+</span>
<a href="#l16.76"></a><span id="l16.76" class="difflineplus">+  nsCOMPtr&lt;nsISimpleEnumerator&gt; entries;</span>
<a href="#l16.77"></a><span id="l16.77" class="difflineplus">+  rv = directory-&gt;GetDirectoryEntries(getter_AddRefs(entries));</span>
<a href="#l16.78"></a><span id="l16.78" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.79"></a><span id="l16.79" class="difflineplus">+</span>
<a href="#l16.80"></a><span id="l16.80" class="difflineplus">+  bool more;</span>
<a href="#l16.81"></a><span id="l16.81" class="difflineplus">+  nsCOMPtr&lt;nsISupports&gt; entry;</span>
<a href="#l16.82"></a><span id="l16.82" class="difflineplus">+  while (NS_SUCCEEDED(entries-&gt;HasMoreElements(&amp;more)) &amp;&amp; more) {</span>
<a href="#l16.83"></a><span id="l16.83" class="difflineplus">+    rv = entries-&gt;GetNext(getter_AddRefs(entry));</span>
<a href="#l16.84"></a><span id="l16.84" class="difflineplus">+</span>
<a href="#l16.85"></a><span id="l16.85" class="difflineplus">+    nsCOMPtr&lt;nsIFile&gt; file = do_QueryInterface(entry, &amp;rv);</span>
<a href="#l16.86"></a><span id="l16.86" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.87"></a><span id="l16.87" class="difflineplus">+</span>
<a href="#l16.88"></a><span id="l16.88" class="difflineplus">+    bool isDirectory = false;</span>
<a href="#l16.89"></a><span id="l16.89" class="difflineplus">+    rv = file-&gt;IsDirectory(&amp;isDirectory);</span>
<a href="#l16.90"></a><span id="l16.90" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.91"></a><span id="l16.91" class="difflineplus">+</span>
<a href="#l16.92"></a><span id="l16.92" class="difflineplus">+    if (isDirectory) {</span>
<a href="#l16.93"></a><span id="l16.93" class="difflineplus">+      file.forget(aLocation);</span>
<a href="#l16.94"></a><span id="l16.94" class="difflineplus">+      return NS_OK;</span>
<a href="#l16.95"></a><span id="l16.95" class="difflineplus">+    }</span>
<a href="#l16.96"></a><span id="l16.96" class="difflineplus">+  }</span>
<a href="#l16.97"></a><span id="l16.97" class="difflineplus">+</span>
<a href="#l16.98"></a><span id="l16.98" class="difflineplus">+  directory.forget(aLocation);</span>
<a href="#l16.99"></a><span id="l16.99" class="difflineplus">+  return NS_OK;</span>
<a href="#l16.100"></a><span id="l16.100" class="difflineplus">+}</span>
<a href="#l16.101"></a><span id="l16.101" class="difflineplus">+</span>
<a href="#l16.102"></a><span id="l16.102" class="difflineplus">+nsresult</span>
<a href="#l16.103"></a><span id="l16.103" class="difflineplus">+nsBeckyUtils::FindUserDirectory(nsIFile **aLocation)</span>
<a href="#l16.104"></a><span id="l16.104" class="difflineplus">+{</span>
<a href="#l16.105"></a><span id="l16.105" class="difflineplus">+  nsresult rv = FindUserDirectoryOnWindows7(aLocation);</span>
<a href="#l16.106"></a><span id="l16.106" class="difflineplus">+  if (rv == NS_ERROR_FILE_NOT_FOUND) {</span>
<a href="#l16.107"></a><span id="l16.107" class="difflineplus">+    rv = FindUserDirectoryOnWindowsXP(aLocation);</span>
<a href="#l16.108"></a><span id="l16.108" class="difflineplus">+  }</span>
<a href="#l16.109"></a><span id="l16.109" class="difflineplus">+  return rv;</span>
<a href="#l16.110"></a><span id="l16.110" class="difflineplus">+}</span>
<a href="#l16.111"></a><span id="l16.111" class="difflineplus">+</span>
<a href="#l16.112"></a><span id="l16.112" class="difflineplus">+nsresult</span>
<a href="#l16.113"></a><span id="l16.113" class="difflineplus">+nsBeckyUtils::ConvertNativeStringToUTF8(const nsACString&amp; aOriginal,</span>
<a href="#l16.114"></a><span id="l16.114" class="difflineplus">+                                        nsACString&amp; _retval)</span>
<a href="#l16.115"></a><span id="l16.115" class="difflineplus">+{</span>
<a href="#l16.116"></a><span id="l16.116" class="difflineplus">+  nsresult rv;</span>
<a href="#l16.117"></a><span id="l16.117" class="difflineplus">+  nsAutoString unicodeString;</span>
<a href="#l16.118"></a><span id="l16.118" class="difflineplus">+  rv = NS_CopyNativeToUnicode(aOriginal, unicodeString);</span>
<a href="#l16.119"></a><span id="l16.119" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.120"></a><span id="l16.120" class="difflineplus">+</span>
<a href="#l16.121"></a><span id="l16.121" class="difflineplus">+  CopyUTF16toUTF8(unicodeString, _retval);</span>
<a href="#l16.122"></a><span id="l16.122" class="difflineplus">+  return NS_OK;</span>
<a href="#l16.123"></a><span id="l16.123" class="difflineplus">+}</span>
<a href="#l16.124"></a><span id="l16.124" class="difflineplus">+</span>
<a href="#l16.125"></a><span id="l16.125" class="difflineplus">+nsresult</span>
<a href="#l16.126"></a><span id="l16.126" class="difflineplus">+nsBeckyUtils::CreateLineInputStream(nsIFile *aFile,</span>
<a href="#l16.127"></a><span id="l16.127" class="difflineplus">+                                    nsILineInputStream **_retval)</span>
<a href="#l16.128"></a><span id="l16.128" class="difflineplus">+{</span>
<a href="#l16.129"></a><span id="l16.129" class="difflineplus">+  NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l16.130"></a><span id="l16.130" class="difflineplus">+</span>
<a href="#l16.131"></a><span id="l16.131" class="difflineplus">+  nsCOMPtr&lt;nsIInputStream&gt; inputStream;</span>
<a href="#l16.132"></a><span id="l16.132" class="difflineplus">+  nsresult rv = NS_NewLocalFileInputStream(getter_AddRefs(inputStream), aFile);</span>
<a href="#l16.133"></a><span id="l16.133" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.134"></a><span id="l16.134" class="difflineplus">+</span>
<a href="#l16.135"></a><span id="l16.135" class="difflineplus">+  return CallQueryInterface(inputStream, _retval);</span>
<a href="#l16.136"></a><span id="l16.136" class="difflineplus">+}</span>
<a href="#l16.137"></a><span id="l16.137" class="difflineplus">+</span>
<a href="#l16.138"></a><span id="l16.138" class="difflineplus">+nsresult</span>
<a href="#l16.139"></a><span id="l16.139" class="difflineplus">+nsBeckyUtils::GetFolderListFile(nsIFile *aLocation, nsIFile **_retval)</span>
<a href="#l16.140"></a><span id="l16.140" class="difflineplus">+{</span>
<a href="#l16.141"></a><span id="l16.141" class="difflineplus">+  nsresult rv;</span>
<a href="#l16.142"></a><span id="l16.142" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; folderListFile;</span>
<a href="#l16.143"></a><span id="l16.143" class="difflineplus">+  rv = aLocation-&gt;Clone(getter_AddRefs(folderListFile));</span>
<a href="#l16.144"></a><span id="l16.144" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.145"></a><span id="l16.145" class="difflineplus">+</span>
<a href="#l16.146"></a><span id="l16.146" class="difflineplus">+  rv = folderListFile-&gt;Append(NS_LITERAL_STRING(&quot;Folder.lst&quot;));</span>
<a href="#l16.147"></a><span id="l16.147" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.148"></a><span id="l16.148" class="difflineplus">+</span>
<a href="#l16.149"></a><span id="l16.149" class="difflineplus">+  bool exists;</span>
<a href="#l16.150"></a><span id="l16.150" class="difflineplus">+  rv = folderListFile-&gt;Exists(&amp;exists);</span>
<a href="#l16.151"></a><span id="l16.151" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.152"></a><span id="l16.152" class="difflineplus">+</span>
<a href="#l16.153"></a><span id="l16.153" class="difflineplus">+  if (!exists)</span>
<a href="#l16.154"></a><span id="l16.154" class="difflineplus">+    return NS_ERROR_FILE_NOT_FOUND;</span>
<a href="#l16.155"></a><span id="l16.155" class="difflineplus">+</span>
<a href="#l16.156"></a><span id="l16.156" class="difflineplus">+  folderListFile.forget(_retval);</span>
<a href="#l16.157"></a><span id="l16.157" class="difflineplus">+  return NS_OK;</span>
<a href="#l16.158"></a><span id="l16.158" class="difflineplus">+}</span>
<a href="#l16.159"></a><span id="l16.159" class="difflineplus">+</span>
<a href="#l16.160"></a><span id="l16.160" class="difflineplus">+nsresult</span>
<a href="#l16.161"></a><span id="l16.161" class="difflineplus">+nsBeckyUtils::GetDefaultFolderName(nsIFile *aFolderListFile, nsACString&amp; name)</span>
<a href="#l16.162"></a><span id="l16.162" class="difflineplus">+{</span>
<a href="#l16.163"></a><span id="l16.163" class="difflineplus">+  nsresult rv;</span>
<a href="#l16.164"></a><span id="l16.164" class="difflineplus">+  nsCOMPtr&lt;nsILineInputStream&gt; lineStream;</span>
<a href="#l16.165"></a><span id="l16.165" class="difflineplus">+  rv = CreateLineInputStream(aFolderListFile, getter_AddRefs(lineStream));</span>
<a href="#l16.166"></a><span id="l16.166" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.167"></a><span id="l16.167" class="difflineplus">+</span>
<a href="#l16.168"></a><span id="l16.168" class="difflineplus">+  bool more = true;</span>
<a href="#l16.169"></a><span id="l16.169" class="difflineplus">+  rv = lineStream-&gt;ReadLine(name, &amp;more);</span>
<a href="#l16.170"></a><span id="l16.170" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.171"></a><span id="l16.171" class="difflineplus">+</span>
<a href="#l16.172"></a><span id="l16.172" class="difflineplus">+  return NS_OK;</span>
<a href="#l16.173"></a><span id="l16.173" class="difflineplus">+}</span>
<a href="#l16.174"></a><span id="l16.174" class="difflineplus">+</span>
<a href="#l16.175"></a><span id="l16.175" class="difflineplus">+nsresult</span>
<a href="#l16.176"></a><span id="l16.176" class="difflineplus">+nsBeckyUtils::GetDefaultMailboxDirectory(nsIFile **_retval)</span>
<a href="#l16.177"></a><span id="l16.177" class="difflineplus">+{</span>
<a href="#l16.178"></a><span id="l16.178" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; userDirectory;</span>
<a href="#l16.179"></a><span id="l16.179" class="difflineplus">+  nsresult rv = FindUserDirectory(getter_AddRefs(userDirectory));</span>
<a href="#l16.180"></a><span id="l16.180" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.181"></a><span id="l16.181" class="difflineplus">+</span>
<a href="#l16.182"></a><span id="l16.182" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; folderListFile;</span>
<a href="#l16.183"></a><span id="l16.183" class="difflineplus">+  rv = GetFolderListFile(userDirectory, getter_AddRefs(folderListFile));</span>
<a href="#l16.184"></a><span id="l16.184" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.185"></a><span id="l16.185" class="difflineplus">+</span>
<a href="#l16.186"></a><span id="l16.186" class="difflineplus">+  nsAutoCString defaultFolderName;</span>
<a href="#l16.187"></a><span id="l16.187" class="difflineplus">+  rv = GetDefaultFolderName(folderListFile, defaultFolderName);</span>
<a href="#l16.188"></a><span id="l16.188" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.189"></a><span id="l16.189" class="difflineplus">+</span>
<a href="#l16.190"></a><span id="l16.190" class="difflineplus">+  rv = userDirectory-&gt;AppendNative(defaultFolderName);</span>
<a href="#l16.191"></a><span id="l16.191" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.192"></a><span id="l16.192" class="difflineplus">+</span>
<a href="#l16.193"></a><span id="l16.193" class="difflineplus">+  bool exists;</span>
<a href="#l16.194"></a><span id="l16.194" class="difflineplus">+  rv = userDirectory-&gt;Exists(&amp;exists);</span>
<a href="#l16.195"></a><span id="l16.195" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.196"></a><span id="l16.196" class="difflineplus">+</span>
<a href="#l16.197"></a><span id="l16.197" class="difflineplus">+  if (!exists)</span>
<a href="#l16.198"></a><span id="l16.198" class="difflineplus">+    return NS_ERROR_FILE_NOT_FOUND;</span>
<a href="#l16.199"></a><span id="l16.199" class="difflineplus">+</span>
<a href="#l16.200"></a><span id="l16.200" class="difflineplus">+  userDirectory.forget(_retval);</span>
<a href="#l16.201"></a><span id="l16.201" class="difflineplus">+  return NS_OK;</span>
<a href="#l16.202"></a><span id="l16.202" class="difflineplus">+}</span>
<a href="#l16.203"></a><span id="l16.203" class="difflineplus">+</span>
<a href="#l16.204"></a><span id="l16.204" class="difflineplus">+nsresult</span>
<a href="#l16.205"></a><span id="l16.205" class="difflineplus">+nsBeckyUtils::GetDefaultMailboxINIFile(nsIFile **_retval)</span>
<a href="#l16.206"></a><span id="l16.206" class="difflineplus">+{</span>
<a href="#l16.207"></a><span id="l16.207" class="difflineplus">+  nsresult rv;</span>
<a href="#l16.208"></a><span id="l16.208" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; mailboxDirectory;</span>
<a href="#l16.209"></a><span id="l16.209" class="difflineplus">+  rv = GetDefaultMailboxDirectory(getter_AddRefs(mailboxDirectory));</span>
<a href="#l16.210"></a><span id="l16.210" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.211"></a><span id="l16.211" class="difflineplus">+</span>
<a href="#l16.212"></a><span id="l16.212" class="difflineplus">+  return GetMailboxINIFile(mailboxDirectory, _retval);</span>
<a href="#l16.213"></a><span id="l16.213" class="difflineplus">+}</span>
<a href="#l16.214"></a><span id="l16.214" class="difflineplus">+</span>
<a href="#l16.215"></a><span id="l16.215" class="difflineplus">+nsresult</span>
<a href="#l16.216"></a><span id="l16.216" class="difflineplus">+nsBeckyUtils::GetMailboxINIFile(nsIFile *aDirectory, nsIFile **_retval)</span>
<a href="#l16.217"></a><span id="l16.217" class="difflineplus">+{</span>
<a href="#l16.218"></a><span id="l16.218" class="difflineplus">+  nsresult rv;</span>
<a href="#l16.219"></a><span id="l16.219" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; target;</span>
<a href="#l16.220"></a><span id="l16.220" class="difflineplus">+  rv = aDirectory-&gt;Clone(getter_AddRefs(target));</span>
<a href="#l16.221"></a><span id="l16.221" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.222"></a><span id="l16.222" class="difflineplus">+</span>
<a href="#l16.223"></a><span id="l16.223" class="difflineplus">+  rv = target-&gt;Append(NS_LITERAL_STRING(&quot;Mailbox.ini&quot;));</span>
<a href="#l16.224"></a><span id="l16.224" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.225"></a><span id="l16.225" class="difflineplus">+  bool exists;</span>
<a href="#l16.226"></a><span id="l16.226" class="difflineplus">+  rv = target-&gt;Exists(&amp;exists);</span>
<a href="#l16.227"></a><span id="l16.227" class="difflineplus">+  if (!exists)</span>
<a href="#l16.228"></a><span id="l16.228" class="difflineplus">+    return NS_ERROR_FILE_NOT_FOUND;</span>
<a href="#l16.229"></a><span id="l16.229" class="difflineplus">+</span>
<a href="#l16.230"></a><span id="l16.230" class="difflineplus">+  target.forget(_retval);</span>
<a href="#l16.231"></a><span id="l16.231" class="difflineplus">+  return NS_OK;</span>
<a href="#l16.232"></a><span id="l16.232" class="difflineplus">+}</span>
<a href="#l16.233"></a><span id="l16.233" class="difflineplus">+</span>
<a href="#l16.234"></a><span id="l16.234" class="difflineplus">+nsresult</span>
<a href="#l16.235"></a><span id="l16.235" class="difflineplus">+nsBeckyUtils::CreateINIParserForFile(nsIFile *aFile,</span>
<a href="#l16.236"></a><span id="l16.236" class="difflineplus">+                                     nsIINIParser **aParser)</span>
<a href="#l16.237"></a><span id="l16.237" class="difflineplus">+{</span>
<a href="#l16.238"></a><span id="l16.238" class="difflineplus">+  nsresult rv;</span>
<a href="#l16.239"></a><span id="l16.239" class="difflineplus">+  nsCOMPtr&lt;nsIINIParserFactory&gt; factory =</span>
<a href="#l16.240"></a><span id="l16.240" class="difflineplus">+    do_GetService(&quot;@mozilla.org/xpcom/ini-processor-factory;1&quot;, &amp;rv);</span>
<a href="#l16.241"></a><span id="l16.241" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.242"></a><span id="l16.242" class="difflineplus">+</span>
<a href="#l16.243"></a><span id="l16.243" class="difflineplus">+  return factory-&gt;CreateINIParser(aFile, aParser);</span>
<a href="#l16.244"></a><span id="l16.244" class="difflineplus">+}</span>
<a href="#l16.245"></a><span id="l16.245" class="difflineplus">+</span>
<a href="#l16.246"></a><span id="l16.246" class="difflineplus">+nsresult</span>
<a href="#l16.247"></a><span id="l16.247" class="difflineplus">+nsBeckyUtils::GetMailboxNameFromINIFile(nsIFile *aFile, nsCString &amp;aName)</span>
<a href="#l16.248"></a><span id="l16.248" class="difflineplus">+{</span>
<a href="#l16.249"></a><span id="l16.249" class="difflineplus">+  nsresult rv;</span>
<a href="#l16.250"></a><span id="l16.250" class="difflineplus">+  nsCOMPtr&lt;nsIINIParser&gt; parser;</span>
<a href="#l16.251"></a><span id="l16.251" class="difflineplus">+  rv = CreateINIParserForFile(aFile, getter_AddRefs(parser));</span>
<a href="#l16.252"></a><span id="l16.252" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.253"></a><span id="l16.253" class="difflineplus">+</span>
<a href="#l16.254"></a><span id="l16.254" class="difflineplus">+  return parser-&gt;GetString(NS_LITERAL_CSTRING(&quot;Account&quot;),</span>
<a href="#l16.255"></a><span id="l16.255" class="difflineplus">+                           NS_LITERAL_CSTRING(&quot;Name&quot;),</span>
<a href="#l16.256"></a><span id="l16.256" class="difflineplus">+                           aName);</span>
<a href="#l16.257"></a><span id="l16.257" class="difflineplus">+}</span>
<a href="#l16.258"></a><span id="l16.258" class="difflineplus">+</span>
<a href="#l16.259"></a><span id="l16.259" class="difflineplus">+nsresult</span>
<a href="#l16.260"></a><span id="l16.260" class="difflineplus">+nsBeckyUtils::ConvertToUTF8File(nsIFile *aSourceFile,</span>
<a href="#l16.261"></a><span id="l16.261" class="difflineplus">+                                nsIFile **_retval)</span>
<a href="#l16.262"></a><span id="l16.262" class="difflineplus">+{</span>
<a href="#l16.263"></a><span id="l16.263" class="difflineplus">+  nsresult rv;</span>
<a href="#l16.264"></a><span id="l16.264" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; convertedFile;</span>
<a href="#l16.265"></a><span id="l16.265" class="difflineplus">+  rv = GetSpecialDirectoryWithFileName(NS_OS_TEMP_DIR,</span>
<a href="#l16.266"></a><span id="l16.266" class="difflineplus">+                                       &quot;thunderbird-becky-import&quot;,</span>
<a href="#l16.267"></a><span id="l16.267" class="difflineplus">+                                       getter_AddRefs(convertedFile));</span>
<a href="#l16.268"></a><span id="l16.268" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.269"></a><span id="l16.269" class="difflineplus">+  rv = convertedFile-&gt;CreateUnique(nsIFile::NORMAL_FILE_TYPE, 0600);</span>
<a href="#l16.270"></a><span id="l16.270" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.271"></a><span id="l16.271" class="difflineplus">+</span>
<a href="#l16.272"></a><span id="l16.272" class="difflineplus">+  nsCOMPtr&lt;nsIInputStream&gt; source;</span>
<a href="#l16.273"></a><span id="l16.273" class="difflineplus">+  rv = NS_NewLocalFileInputStream(getter_AddRefs(source), aSourceFile);</span>
<a href="#l16.274"></a><span id="l16.274" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.275"></a><span id="l16.275" class="difflineplus">+</span>
<a href="#l16.276"></a><span id="l16.276" class="difflineplus">+  nsCOMPtr&lt;nsIOutputStream&gt; destination;</span>
<a href="#l16.277"></a><span id="l16.277" class="difflineplus">+  rv = NS_NewLocalFileOutputStream(getter_AddRefs(destination),</span>
<a href="#l16.278"></a><span id="l16.278" class="difflineplus">+                                   convertedFile);</span>
<a href="#l16.279"></a><span id="l16.279" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.280"></a><span id="l16.280" class="difflineplus">+</span>
<a href="#l16.281"></a><span id="l16.281" class="difflineplus">+  const uint32_t kBlock = 8192;</span>
<a href="#l16.282"></a><span id="l16.282" class="difflineplus">+</span>
<a href="#l16.283"></a><span id="l16.283" class="difflineplus">+  nsCOMPtr&lt;nsIConverterInputStream&gt; convertedInput;</span>
<a href="#l16.284"></a><span id="l16.284" class="difflineplus">+  convertedInput-&gt;Init(source, nsMsgI18NFileSystemCharset(), kBlock, 0x0000);</span>
<a href="#l16.285"></a><span id="l16.285" class="difflineplus">+</span>
<a href="#l16.286"></a><span id="l16.286" class="difflineplus">+  nsCOMPtr&lt;nsIConverterOutputStream&gt; convertedOutput;</span>
<a href="#l16.287"></a><span id="l16.287" class="difflineplus">+  convertedOutput-&gt;Init(destination, &quot;UTF-8&quot;, kBlock, 0x0000);</span>
<a href="#l16.288"></a><span id="l16.288" class="difflineplus">+</span>
<a href="#l16.289"></a><span id="l16.289" class="difflineplus">+  char16_t *line = (char16_t *)moz_xmalloc(kBlock);</span>
<a href="#l16.290"></a><span id="l16.290" class="difflineplus">+  uint32_t readBytes = kBlock;</span>
<a href="#l16.291"></a><span id="l16.291" class="difflineplus">+  bool writtenBytes;</span>
<a href="#l16.292"></a><span id="l16.292" class="difflineplus">+  while (readBytes == kBlock) {</span>
<a href="#l16.293"></a><span id="l16.293" class="difflineplus">+    rv = convertedInput-&gt;Read(line, kBlock, &amp;readBytes);</span>
<a href="#l16.294"></a><span id="l16.294" class="difflineplus">+    rv = convertedOutput-&gt;Write(readBytes, line, &amp;writtenBytes);</span>
<a href="#l16.295"></a><span id="l16.295" class="difflineplus">+  }</span>
<a href="#l16.296"></a><span id="l16.296" class="difflineplus">+  convertedOutput-&gt;Close();</span>
<a href="#l16.297"></a><span id="l16.297" class="difflineplus">+  convertedInput-&gt;Close();</span>
<a href="#l16.298"></a><span id="l16.298" class="difflineplus">+</span>
<a href="#l16.299"></a><span id="l16.299" class="difflineplus">+  convertedFile.forget(_retval);</span>
<a href="#l16.300"></a><span id="l16.300" class="difflineplus">+  return NS_OK;</span>
<a href="#l16.301"></a><span id="l16.301" class="difflineplus">+}</span>
<a href="#l16.302"></a><span id="l16.302" class="difflineplus">+</span>
<a href="#l16.303"></a><span id="l16.303" class="difflineplus">+nsresult</span>
<a href="#l16.304"></a><span id="l16.304" class="difflineplus">+nsBeckyUtils::TranslateFolderName(const nsAString &amp; aFolderName,</span>
<a href="#l16.305"></a><span id="l16.305" class="difflineplus">+                                  nsAString &amp; _retval)</span>
<a href="#l16.306"></a><span id="l16.306" class="difflineplus">+{</span>
<a href="#l16.307"></a><span id="l16.307" class="difflineplus">+  if (aFolderName.LowerCaseEqualsLiteral(&quot;!trash&quot;))</span>
<a href="#l16.308"></a><span id="l16.308" class="difflineplus">+    _retval = NS_LITERAL_STRING(kDestTrashFolderName);</span>
<a href="#l16.309"></a><span id="l16.309" class="difflineplus">+  else if (aFolderName.LowerCaseEqualsLiteral(&quot;!!!!inbox&quot;))</span>
<a href="#l16.310"></a><span id="l16.310" class="difflineplus">+    _retval = NS_LITERAL_STRING(kDestInboxFolderName);</span>
<a href="#l16.311"></a><span id="l16.311" class="difflineplus">+  else if (aFolderName.LowerCaseEqualsLiteral(&quot;!!!!outbox&quot;))</span>
<a href="#l16.312"></a><span id="l16.312" class="difflineplus">+    _retval = NS_LITERAL_STRING(kDestSentFolderName);</span>
<a href="#l16.313"></a><span id="l16.313" class="difflineplus">+  else if (aFolderName.LowerCaseEqualsLiteral(&quot;!!!!unsent&quot;))</span>
<a href="#l16.314"></a><span id="l16.314" class="difflineplus">+    _retval = NS_LITERAL_STRING(kDestUnsentMessagesFolderName);</span>
<a href="#l16.315"></a><span id="l16.315" class="difflineplus">+  else</span>
<a href="#l16.316"></a><span id="l16.316" class="difflineplus">+    _retval = aFolderName;</span>
<a href="#l16.317"></a><span id="l16.317" class="difflineplus">+</span>
<a href="#l16.318"></a><span id="l16.318" class="difflineplus">+  return NS_OK;</span>
<a href="#l16.319"></a><span id="l16.319" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1">new file mode 100644</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineminus">--- /dev/null</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineplus">+++ b/mailnews/import/becky/src/nsBeckyUtils.h</span>
<a href="#l17.4"></a><span id="l17.4" class="difflineat">@@ -0,0 +1,37 @@</span>
<a href="#l17.5"></a><span id="l17.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l17.6"></a><span id="l17.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l17.7"></a><span id="l17.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l17.8"></a><span id="l17.8" class="difflineplus">+#ifndef _nsBeckyUtils_H__</span>
<a href="#l17.9"></a><span id="l17.9" class="difflineplus">+#define _nsBeckyUtils_H__</span>
<a href="#l17.10"></a><span id="l17.10" class="difflineplus">+</span>
<a href="#l17.11"></a><span id="l17.11" class="difflineplus">+class nsIFile;</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineplus">+class nsILineInputStream;</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+class nsIINIParser;</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineplus">+</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineplus">+class nsBeckyUtils final {</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineplus">+public:</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineplus">+  static nsresult FindUserDirectoryOnWindows7(nsIFile **aLocation);</span>
<a href="#l17.18"></a><span id="l17.18" class="difflineplus">+  static nsresult FindUserDirectoryOnWindowsXP(nsIFile **aLocation);</span>
<a href="#l17.19"></a><span id="l17.19" class="difflineplus">+  static nsresult FindUserDirectory(nsIFile **aFile);</span>
<a href="#l17.20"></a><span id="l17.20" class="difflineplus">+  static nsresult ConvertNativeStringToUTF8(const nsACString&amp; aOriginal,</span>
<a href="#l17.21"></a><span id="l17.21" class="difflineplus">+                                            nsACString&amp; _retval);</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineplus">+  static nsresult CreateLineInputStream(nsIFile *aFile,</span>
<a href="#l17.23"></a><span id="l17.23" class="difflineplus">+                                        nsILineInputStream **_retval);</span>
<a href="#l17.24"></a><span id="l17.24" class="difflineplus">+  static nsresult GetDefaultMailboxDirectory(nsIFile **_retval);</span>
<a href="#l17.25"></a><span id="l17.25" class="difflineplus">+  static nsresult GetFolderListFile(nsIFile *aLocation,</span>
<a href="#l17.26"></a><span id="l17.26" class="difflineplus">+                                    nsIFile **_retval);</span>
<a href="#l17.27"></a><span id="l17.27" class="difflineplus">+  static nsresult GetDefaultFolderName(nsIFile *aFolderListFile,</span>
<a href="#l17.28"></a><span id="l17.28" class="difflineplus">+                                       nsACString&amp; name);</span>
<a href="#l17.29"></a><span id="l17.29" class="difflineplus">+  static nsresult GetDefaultMailboxINIFile(nsIFile **_retval);</span>
<a href="#l17.30"></a><span id="l17.30" class="difflineplus">+  static nsresult GetMailboxINIFile(nsIFile *aDirectory, nsIFile **_retval);</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineplus">+  static nsresult CreateINIParserForFile(nsIFile *aFile,</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineplus">+                                         nsIINIParser **aParser);</span>
<a href="#l17.33"></a><span id="l17.33" class="difflineplus">+  static nsresult GetMailboxNameFromINIFile(nsIFile *aFile, nsCString &amp;aName);</span>
<a href="#l17.34"></a><span id="l17.34" class="difflineplus">+  static nsresult ConvertToUTF8File(nsIFile *aSourceFile,</span>
<a href="#l17.35"></a><span id="l17.35" class="difflineplus">+                                    nsIFile **_retval);</span>
<a href="#l17.36"></a><span id="l17.36" class="difflineplus">+  static nsresult TranslateFolderName(const nsAString &amp; aFolderName,</span>
<a href="#l17.37"></a><span id="l17.37" class="difflineplus">+                                      nsAString &amp; _retval);</span>
<a href="#l17.38"></a><span id="l17.38" class="difflineplus">+};</span>
<a href="#l17.39"></a><span id="l17.39" class="difflineplus">+</span>
<a href="#l17.40"></a><span id="l17.40" class="difflineplus">+</span>
<a href="#l17.41"></a><span id="l17.41" class="difflineplus">+#endif /* _nsBeckyUtils_H__ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/import/build/moz.build</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/import/build/moz.build</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -43,16 +43,17 @@ if CONFIG['MOZ_WIDGET_TOOLKIT'] == 'coco</span>
<a href="#l18.4"></a><span id="l18.4">     OS_LIBS += CONFIG['TK_LIBS']</span>
<a href="#l18.5"></a><span id="l18.5">     OS_LIBS += ['-framework Cocoa']</span>
<a href="#l18.6"></a><span id="l18.6"> </span>
<a href="#l18.7"></a><span id="l18.7"> if CONFIG['OS_ARCH'] == 'WINNT':</span>
<a href="#l18.8"></a><span id="l18.8">     LOCAL_INCLUDES += [</span>
<a href="#l18.9"></a><span id="l18.9">     ]</span>
<a href="#l18.10"></a><span id="l18.10">     if not CONFIG['GNU_CC']:</span>
<a href="#l18.11"></a><span id="l18.11">         LOCAL_INCLUDES += [</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineplus">+            '../becky/src',</span>
<a href="#l18.13"></a><span id="l18.13">             '../oexpress',</span>
<a href="#l18.14"></a><span id="l18.14">             '../outlook/src',</span>
<a href="#l18.15"></a><span id="l18.15">             '../winlivemail',</span>
<a href="#l18.16"></a><span id="l18.16">         ]</span>
<a href="#l18.17"></a><span id="l18.17">     if CONFIG['MOZ_MAPI_SUPPORT']:</span>
<a href="#l18.18"></a><span id="l18.18">         LOCAL_INCLUDES += [</span>
<a href="#l18.19"></a><span id="l18.19">             '../outlook/src',</span>
<a href="#l18.20"></a><span id="l18.20">         ]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/import/build/nsImportModule.cpp</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/import/build/nsImportModule.cpp</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -58,16 +58,26 @@ NS_DEFINE_NAMED_CID(NS_APPLEMAILIMPL_CID</span>
<a href="#l19.4"></a><span id="l19.4"> NS_DEFINE_NAMED_CID(NS_OEIMPORT_CID);</span>
<a href="#l19.5"></a><span id="l19.5"> NS_DEFINE_NAMED_CID(NS_WMIMPORT_CID);</span>
<a href="#l19.6"></a><span id="l19.6"> #ifdef MOZ_MAPI_SUPPORT</span>
<a href="#l19.7"></a><span id="l19.7"> NS_DEFINE_NAMED_CID(NS_OUTLOOKIMPORT_CID);</span>
<a href="#l19.8"></a><span id="l19.8"> #endif</span>
<a href="#l19.9"></a><span id="l19.9"> #endif // XP_WIN</span>
<a href="#l19.10"></a><span id="l19.10"> </span>
<a href="#l19.11"></a><span id="l19.11"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineplus">+// becky import Include Files</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineplus">+#ifdef XP_WIN</span>
<a href="#l19.15"></a><span id="l19.15" class="difflineplus">+#include &quot;nsBeckyImport.h&quot;</span>
<a href="#l19.16"></a><span id="l19.16" class="difflineplus">+#include &quot;nsBeckyStringBundle.h&quot;</span>
<a href="#l19.17"></a><span id="l19.17" class="difflineplus">+</span>
<a href="#l19.18"></a><span id="l19.18" class="difflineplus">+NS_DEFINE_NAMED_CID(NS_BECKYIMPORT_CID);</span>
<a href="#l19.19"></a><span id="l19.19" class="difflineplus">+#endif // XP_WIN</span>
<a href="#l19.20"></a><span id="l19.20" class="difflineplus">+</span>
<a href="#l19.21"></a><span id="l19.21" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l19.22"></a><span id="l19.22"> // core import factories</span>
<a href="#l19.23"></a><span id="l19.23"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l19.24"></a><span id="l19.24"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsImportService)</span>
<a href="#l19.25"></a><span id="l19.25"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsIImportMimeEncodeImpl)</span>
<a href="#l19.26"></a><span id="l19.26"> </span>
<a href="#l19.27"></a><span id="l19.27"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l19.28"></a><span id="l19.28"> // text import factories</span>
<a href="#l19.29"></a><span id="l19.29"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l19.30"></a><span id="l19.30" class="difflineat">@@ -91,25 +101,32 @@ NS_GENERIC_FACTORY_CONSTRUCTOR_INIT(nsAp</span>
<a href="#l19.31"></a><span id="l19.31"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l19.32"></a><span id="l19.32"> #ifdef XP_WIN</span>
<a href="#l19.33"></a><span id="l19.33"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsOEImport)</span>
<a href="#l19.34"></a><span id="l19.34"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsWMImport)</span>
<a href="#l19.35"></a><span id="l19.35"> #ifdef MOZ_MAPI_SUPPORT</span>
<a href="#l19.36"></a><span id="l19.36"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsOutlookImport)</span>
<a href="#l19.37"></a><span id="l19.37"> #endif</span>
<a href="#l19.38"></a><span id="l19.38"> #endif // XP_WIN</span>
<a href="#l19.39"></a><span id="l19.39" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l19.40"></a><span id="l19.40" class="difflineplus">+// becky import factory</span>
<a href="#l19.41"></a><span id="l19.41" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l19.42"></a><span id="l19.42" class="difflineplus">+#ifdef XP_WIN</span>
<a href="#l19.43"></a><span id="l19.43" class="difflineplus">+NS_GENERIC_FACTORY_CONSTRUCTOR(nsBeckyImport)</span>
<a href="#l19.44"></a><span id="l19.44" class="difflineplus">+#endif // XP_WIN</span>
<a href="#l19.45"></a><span id="l19.45"> </span>
<a href="#l19.46"></a><span id="l19.46"> static const mozilla::Module::CategoryEntry kMailNewsImportCategories[] = {</span>
<a href="#l19.47"></a><span id="l19.47">   // XXX These CIDs should match the explicit CIDs defined in the header files,</span>
<a href="#l19.48"></a><span id="l19.48">   // or be changed so that they are contract IDs (with appropriate code updates)</span>
<a href="#l19.49"></a><span id="l19.49">   { &quot;mailnewsimport&quot;, &quot;{A5991D01-ADA7-11d3-A9C2-00A0CC26DA63}&quot;, NS_IMPORT_ADDRESS_STR },</span>
<a href="#l19.50"></a><span id="l19.50">   { &quot;mailnewsimport&quot;, &quot;{0eb034a3-964a-4e2f-92eb-cc55d9ae9dd2}&quot;, NS_IMPORT_ADDRESS_STR },</span>
<a href="#l19.51"></a><span id="l19.51"> #ifdef XP_WIN</span>
<a href="#l19.52"></a><span id="l19.52">   { &quot;mailnewsimport&quot;, &quot;{42bc82bc-8e9f-4597-8b6e-e529daaf3af1}&quot;, kWMSupportsString },</span>
<a href="#l19.53"></a><span id="l19.53">   { &quot;mailnewsimport&quot;, &quot;{be0bc880-1742-11d3-a206-00a0cc26da63}&quot;, kOESupportsString },</span>
<a href="#l19.54"></a><span id="l19.54" class="difflineplus">+  { &quot;mailnewsimport&quot;, &quot;{7952a6cf-2442-4c04-9f02-150b15a0a841}&quot;, kBeckySupportsString },</span>
<a href="#l19.55"></a><span id="l19.55"> #ifdef MOZ_MAPI_SUPPORT</span>
<a href="#l19.56"></a><span id="l19.56">   { &quot;mailnewsimport&quot;, &quot;{1DB469A0-8B00-11d3-A206-00A0CC26DA63}&quot;, kOutlookSupportsString },</span>
<a href="#l19.57"></a><span id="l19.57"> #endif</span>
<a href="#l19.58"></a><span id="l19.58"> #endif</span>
<a href="#l19.59"></a><span id="l19.59"> #if defined(XP_MACOSX)</span>
<a href="#l19.60"></a><span id="l19.60">   { &quot;mailnewsimport&quot;, &quot;{6d3f101c-70ec-4e04-b68d-9908d1aeddf3}&quot;, kAppleMailSupportsString },</span>
<a href="#l19.61"></a><span id="l19.61"> #endif</span>
<a href="#l19.62"></a><span id="l19.62">   { NULL }</span>
<a href="#l19.63"></a><span id="l19.63" class="difflineat">@@ -123,16 +140,17 @@ const mozilla::Module::CIDEntry kMailNew</span>
<a href="#l19.64"></a><span id="l19.64"> #if defined(XP_MACOSX)</span>
<a href="#l19.65"></a><span id="l19.65">   { &amp;kNS_APPLEMAILIMPORT_CID, false, NULL, nsAppleMailImportModuleConstructor },</span>
<a href="#l19.66"></a><span id="l19.66">   { &amp;kNS_APPLEMAILIMPL_CID, false, NULL, nsAppleMailImportMailConstructor },</span>
<a href="#l19.67"></a><span id="l19.67"> #endif</span>
<a href="#l19.68"></a><span id="l19.68"> </span>
<a href="#l19.69"></a><span id="l19.69"> #ifdef XP_WIN</span>
<a href="#l19.70"></a><span id="l19.70">   { &amp;kNS_OEIMPORT_CID, false, NULL, nsOEImportConstructor },</span>
<a href="#l19.71"></a><span id="l19.71">   { &amp;kNS_WMIMPORT_CID, false, NULL, nsWMImportConstructor },</span>
<a href="#l19.72"></a><span id="l19.72" class="difflineplus">+  { &amp;kNS_BECKYIMPORT_CID, false, NULL, nsBeckyImportConstructor },</span>
<a href="#l19.73"></a><span id="l19.73"> #ifdef MOZ_MAPI_SUPPORT</span>
<a href="#l19.74"></a><span id="l19.74">   { &amp;kNS_OUTLOOKIMPORT_CID, false, NULL, nsOutlookImportConstructor },</span>
<a href="#l19.75"></a><span id="l19.75"> #endif</span>
<a href="#l19.76"></a><span id="l19.76"> #endif</span>
<a href="#l19.77"></a><span id="l19.77">   { NULL }</span>
<a href="#l19.78"></a><span id="l19.78"> };</span>
<a href="#l19.79"></a><span id="l19.79"> </span>
<a href="#l19.80"></a><span id="l19.80"> const mozilla::Module::ContractIDEntry kMailNewsImportContracts[] = {</span>
<a href="#l19.81"></a><span id="l19.81" class="difflineat">@@ -143,30 +161,32 @@ const mozilla::Module::ContractIDEntry k</span>
<a href="#l19.82"></a><span id="l19.82"> #if defined(XP_MACOSX)</span>
<a href="#l19.83"></a><span id="l19.83">   { &quot;@mozilla.org/import/import-applemail;1&quot;, &amp;kNS_APPLEMAILIMPORT_CID },</span>
<a href="#l19.84"></a><span id="l19.84">   { NS_APPLEMAILIMPL_CONTRACTID, &amp;kNS_APPLEMAILIMPL_CID },</span>
<a href="#l19.85"></a><span id="l19.85"> #endif</span>
<a href="#l19.86"></a><span id="l19.86"> </span>
<a href="#l19.87"></a><span id="l19.87"> #ifdef XP_WIN</span>
<a href="#l19.88"></a><span id="l19.88">   { &quot;@mozilla.org/import/import-oe;1&quot;, &amp;kNS_OEIMPORT_CID },</span>
<a href="#l19.89"></a><span id="l19.89">   { &quot;@mozilla.org/import/import-wm;1&quot;, &amp;kNS_WMIMPORT_CID },</span>
<a href="#l19.90"></a><span id="l19.90" class="difflineplus">+  { &quot;@mozilla.org/import/import-becky;1&quot;, &amp;kNS_BECKYIMPORT_CID },</span>
<a href="#l19.91"></a><span id="l19.91"> #ifdef MOZ_MAPI_SUPPORT</span>
<a href="#l19.92"></a><span id="l19.92">   { &quot;@mozilla.org/import/import-outlook;1&quot;, &amp;kNS_OUTLOOKIMPORT_CID },</span>
<a href="#l19.93"></a><span id="l19.93"> #endif</span>
<a href="#l19.94"></a><span id="l19.94"> #endif</span>
<a href="#l19.95"></a><span id="l19.95">   { NULL }</span>
<a href="#l19.96"></a><span id="l19.96"> };</span>
<a href="#l19.97"></a><span id="l19.97"> </span>
<a href="#l19.98"></a><span id="l19.98"> </span>
<a href="#l19.99"></a><span id="l19.99"> static void importModuleDtor()</span>
<a href="#l19.100"></a><span id="l19.100"> {</span>
<a href="#l19.101"></a><span id="l19.101"> #ifdef XP_WIN</span>
<a href="#l19.102"></a><span id="l19.102"> </span>
<a href="#l19.103"></a><span id="l19.103">     nsOEStringBundle::Cleanup();</span>
<a href="#l19.104"></a><span id="l19.104">     nsWMStringBundle::Cleanup();</span>
<a href="#l19.105"></a><span id="l19.105" class="difflineplus">+    nsBeckyStringBundle::Cleanup();</span>
<a href="#l19.106"></a><span id="l19.106"> #ifdef MOZ_MAPI_SUPPORT</span>
<a href="#l19.107"></a><span id="l19.107">     nsOutlookStringBundle::Cleanup();</span>
<a href="#l19.108"></a><span id="l19.108"> #endif</span>
<a href="#l19.109"></a><span id="l19.109"> #endif</span>
<a href="#l19.110"></a><span id="l19.110"> }</span>
<a href="#l19.111"></a><span id="l19.111"> </span>
<a href="#l19.112"></a><span id="l19.112"> static const mozilla::Module kMailNewsImportModule = {</span>
<a href="#l19.113"></a><span id="l19.113">   mozilla::Module::kVersion,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/import/vcard/src/moz.build</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/import/vcard/src/moz.build</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -3,14 +3,18 @@</span>
<a href="#l20.4"></a><span id="l20.4"> # License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l20.5"></a><span id="l20.5"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l20.6"></a><span id="l20.6"> </span>
<a href="#l20.7"></a><span id="l20.7"> SOURCES += [</span>
<a href="#l20.8"></a><span id="l20.8">     'nsVCardAddress.cpp',</span>
<a href="#l20.9"></a><span id="l20.9">     'nsVCardImport.cpp',</span>
<a href="#l20.10"></a><span id="l20.10"> ]</span>
<a href="#l20.11"></a><span id="l20.11"> </span>
<a href="#l20.12"></a><span id="l20.12" class="difflineplus">+EXPORTS += [</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineplus">+    'nsVCardAddress.h',</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineplus">+]</span>
<a href="#l20.15"></a><span id="l20.15" class="difflineplus">+</span>
<a href="#l20.16"></a><span id="l20.16"> FINAL_LIBRARY = 'import'</span>
<a href="#l20.17"></a><span id="l20.17"> </span>
<a href="#l20.18"></a><span id="l20.18"> LOCAL_INCLUDES += [</span>
<a href="#l20.19"></a><span id="l20.19">     '../../src'</span>
<a href="#l20.20"></a><span id="l20.20"> ]</span>
<a href="#l20.21"></a><span id="l20.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mailnews/moz.build</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mailnews/moz.build</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -24,16 +24,18 @@ DIRS += [</span>
<a href="#l21.4"></a><span id="l21.4"> ]</span>
<a href="#l21.5"></a><span id="l21.5"> </span>
<a href="#l21.6"></a><span id="l21.6"> if CONFIG['MOZ_WIDGET_TOOLKIT'] == 'cocoa':</span>
<a href="#l21.7"></a><span id="l21.7">     DIRS += [</span>
<a href="#l21.8"></a><span id="l21.8">         'import/applemail/src',</span>
<a href="#l21.9"></a><span id="l21.9">     ]</span>
<a href="#l21.10"></a><span id="l21.10"> </span>
<a href="#l21.11"></a><span id="l21.11"> if CONFIG['OS_ARCH'] == 'WINNT':</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineplus">+    DIRS += [ 'import/becky/src' ]</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+</span>
<a href="#l21.14"></a><span id="l21.14">     if CONFIG['MOZ_MAPI_SUPPORT']:</span>
<a href="#l21.15"></a><span id="l21.15">         DIRS += ['import/outlook/src']</span>
<a href="#l21.16"></a><span id="l21.16"> </span>
<a href="#l21.17"></a><span id="l21.17">     if not CONFIG['GNU_CC']:</span>
<a href="#l21.18"></a><span id="l21.18">         DIRS += [</span>
<a href="#l21.19"></a><span id="l21.19">             'import/oexpress',</span>
<a href="#l21.20"></a><span id="l21.20">             'import/winlivemail',</span>
<a href="#l21.21"></a><span id="l21.21">         ]</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

