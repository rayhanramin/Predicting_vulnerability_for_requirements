<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 3822:1a3bf84eaa7dc39a8dfbc6a345762a6d75bb0f7f</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 1a3bf84eaa7dc39a8dfbc6a345762a6d75bb0f7f" />
<meta property="og:url" content="/comm-central/rev/1a3bf84eaa7dc39a8dfbc6a345762a6d75bb0f7f" />
<meta property="og:description" content="Bug 512916 Split out mailTabType into its own file. r=asuth,a=Standard8" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 1a3bf84eaa7dc39a8dfbc6a345762a6d75bb0f7f 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/1a3bf84eaa7dc39a8dfbc6a345762a6d75bb0f7f">shortlog</a> |
<a href="/comm-central/log/1a3bf84eaa7dc39a8dfbc6a345762a6d75bb0f7f">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/1a3bf84eaa7dc39a8dfbc6a345762a6d75bb0f7f">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/1a3bf84eaa7dc39a8dfbc6a345762a6d75bb0f7f">files</a> |
changeset |
<a href="/comm-central/raw-rev/1a3bf84eaa7dc39a8dfbc6a345762a6d75bb0f7f">raw</a>  | <a href="/comm-central/archive/1a3bf84eaa7dc39a8dfbc6a345762a6d75bb0f7f.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=512916">Bug 512916</a> Split out mailTabType into its own file. r=asuth,a=Standard8
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#77;&#97;&#114;&#107;&#32;&#66;&#97;&#110;&#110;&#101;&#114;&#32;&#60;&#98;&#117;&#103;&#122;&#105;&#108;&#108;&#97;&#64;&#115;&#116;&#97;&#110;&#100;&#97;&#114;&#100;&#56;&#46;&#112;&#108;&#117;&#115;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 17 Sep 2009 07:49:43 +0100</td></tr>

<tr>
 <td>changeset 3822</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/1a3bf84eaa7dc39a8dfbc6a345762a6d75bb0f7f">1a3bf84eaa7dc39a8dfbc6a345762a6d75bb0f7f</a></td>
</tr>



<tr>
<td>parent 3821</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/cc4c93a723de8a8ba54b7858d4a1cc15d2765847">cc4c93a723de8a8ba54b7858d4a1cc15d2765847</a>
</td>
</tr>

<tr>
<td>child 3823</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/473fdca7dbd3c4f2fc09487e95d5318af0d7ee8e">473fdca7dbd3c4f2fc09487e95d5318af0d7ee8e</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=1a3bf84eaa7dc39a8dfbc6a345762a6d75bb0f7f">2993</a></td></tr>
<tr><td>push user</td><td>bugzilla@standard8.plus.com</td></tr>
<tr><td>push date</td><td class="date age">Thu, 17 Sep 2009 06:59:50 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@473fdca7dbd3 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=473fdca7dbd3c4f2fc09487e95d5318af0d7ee8e">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=473fdca7dbd3c4f2fc09487e95d5318af0d7ee8e&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=473fdca7dbd3c4f2fc09487e95d5318af0d7ee8e&newProject=comm-central&newRevision=1a3bf84eaa7dc39a8dfbc6a345762a6d75bb0f7f&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=473fdca7dbd3c4f2fc09487e95d5318af0d7ee8e&newProject=comm-central&newRevision=1a3bf84eaa7dc39a8dfbc6a345762a6d75bb0f7f&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=473fdca7dbd3c4f2fc09487e95d5318af0d7ee8e&newProject=comm-central&newRevision=1a3bf84eaa7dc39a8dfbc6a345762a6d75bb0f7f&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28asuth%29&revcount=50">asuth</a>, <a href="/comm-central/log?rev=reviewer%28Standard8%29&revcount=50">Standard8</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=512916">512916</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=512916">Bug 512916</a> Split out mailTabType into its own file. r=asuth,a=Standard8</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1a3bf84eaa7dc39a8dfbc6a345762a6d75bb0f7f/mail/base/content/mailTabs.js">mail/base/content/mailTabs.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1a3bf84eaa7dc39a8dfbc6a345762a6d75bb0f7f/mail/base/content/mailTabs.js">file</a> |
<a href="/comm-central/annotate/1a3bf84eaa7dc39a8dfbc6a345762a6d75bb0f7f/mail/base/content/mailTabs.js">annotate</a> |
<a href="/comm-central/diff/1a3bf84eaa7dc39a8dfbc6a345762a6d75bb0f7f/mail/base/content/mailTabs.js">diff</a> |
<a href="/comm-central/comparison/1a3bf84eaa7dc39a8dfbc6a345762a6d75bb0f7f/mail/base/content/mailTabs.js">comparison</a> |
<a href="/comm-central/log/1a3bf84eaa7dc39a8dfbc6a345762a6d75bb0f7f/mail/base/content/mailTabs.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1a3bf84eaa7dc39a8dfbc6a345762a6d75bb0f7f/mail/base/content/mailWindowOverlay.js">mail/base/content/mailWindowOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1a3bf84eaa7dc39a8dfbc6a345762a6d75bb0f7f/mail/base/content/mailWindowOverlay.js">file</a> |
<a href="/comm-central/annotate/1a3bf84eaa7dc39a8dfbc6a345762a6d75bb0f7f/mail/base/content/mailWindowOverlay.js">annotate</a> |
<a href="/comm-central/diff/1a3bf84eaa7dc39a8dfbc6a345762a6d75bb0f7f/mail/base/content/mailWindowOverlay.js">diff</a> |
<a href="/comm-central/comparison/1a3bf84eaa7dc39a8dfbc6a345762a6d75bb0f7f/mail/base/content/mailWindowOverlay.js">comparison</a> |
<a href="/comm-central/log/1a3bf84eaa7dc39a8dfbc6a345762a6d75bb0f7f/mail/base/content/mailWindowOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1a3bf84eaa7dc39a8dfbc6a345762a6d75bb0f7f/mail/base/content/mailWindowOverlay.xul">mail/base/content/mailWindowOverlay.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1a3bf84eaa7dc39a8dfbc6a345762a6d75bb0f7f/mail/base/content/mailWindowOverlay.xul">file</a> |
<a href="/comm-central/annotate/1a3bf84eaa7dc39a8dfbc6a345762a6d75bb0f7f/mail/base/content/mailWindowOverlay.xul">annotate</a> |
<a href="/comm-central/diff/1a3bf84eaa7dc39a8dfbc6a345762a6d75bb0f7f/mail/base/content/mailWindowOverlay.xul">diff</a> |
<a href="/comm-central/comparison/1a3bf84eaa7dc39a8dfbc6a345762a6d75bb0f7f/mail/base/content/mailWindowOverlay.xul">comparison</a> |
<a href="/comm-central/log/1a3bf84eaa7dc39a8dfbc6a345762a6d75bb0f7f/mail/base/content/mailWindowOverlay.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1a3bf84eaa7dc39a8dfbc6a345762a6d75bb0f7f/mail/base/jar.mn">mail/base/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1a3bf84eaa7dc39a8dfbc6a345762a6d75bb0f7f/mail/base/jar.mn">file</a> |
<a href="/comm-central/annotate/1a3bf84eaa7dc39a8dfbc6a345762a6d75bb0f7f/mail/base/jar.mn">annotate</a> |
<a href="/comm-central/diff/1a3bf84eaa7dc39a8dfbc6a345762a6d75bb0f7f/mail/base/jar.mn">diff</a> |
<a href="/comm-central/comparison/1a3bf84eaa7dc39a8dfbc6a345762a6d75bb0f7f/mail/base/jar.mn">comparison</a> |
<a href="/comm-central/log/1a3bf84eaa7dc39a8dfbc6a345762a6d75bb0f7f/mail/base/jar.mn">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1">copy from mail/base/content/mailWindowOverlay.js</span>
<a href="#l1.2"></a><span id="l1.2">copy to mail/base/content/mailTabs.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineminus">--- a/mail/base/content/mailWindowOverlay.js</span>
<a href="#l1.4"></a><span id="l1.4" class="difflineplus">+++ b/mail/base/content/mailTabs.js</span>
<a href="#l1.5"></a><span id="l1.5" class="difflineat">@@ -41,1640 +41,16 @@</span>
<a href="#l1.6"></a><span id="l1.6">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l1.7"></a><span id="l1.7">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l1.8"></a><span id="l1.8">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l1.9"></a><span id="l1.9">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l1.10"></a><span id="l1.10">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l1.11"></a><span id="l1.11">  *</span>
<a href="#l1.12"></a><span id="l1.12">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l1.13"></a><span id="l1.13"> </span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-Components.utils.import(&quot;resource://app/modules/gloda/dbview.js&quot;);</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineminus">-</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineminus">-const ADDR_DB_LARGE_COMMIT       = 1;</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineminus">-</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineminus">-const kClassicMailLayout = 0;</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineminus">-const kWideMailLayout = 1;</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineminus">-const kVerticalMailLayout = 2;</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineminus">-</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineminus">-// Per message header flags to keep track of whether the user is allowing remote</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineminus">-// content for a particular message.</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineminus">-// if you change or add more values to these constants, be sure to modify</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineminus">-// the corresponding definitions in nsMsgContentPolicy.cpp</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineminus">-const kNoRemoteContentPolicy = 0;</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineminus">-const kBlockRemoteContent = 1;</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineminus">-const kAllowRemoteContent = 2;</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineminus">-</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineminus">-const kMsgNotificationPhishingBar = 1;</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-const kMsgNotificationJunkBar = 2;</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineminus">-const kMsgNotificationRemoteImages = 3;</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineminus">-</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineminus">-Components.utils.import(&quot;resource://app/modules/MailUtils.js&quot;);</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineminus">-Components.utils.import(&quot;resource://app/modules/MailConsts.js&quot;);</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineminus">-</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineminus">-var gMessengerBundle;</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineminus">-var gPrefBranch = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineminus">-                            .getService(Components.interfaces.nsIPrefService)</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineminus">-                            .getBranch(null);</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineminus">-var gCopyService = Components.classes[&quot;@mozilla.org/messenger/messagecopyservice;1&quot;]</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineminus">-                     .getService(Components.interfaces.nsIMsgCopyService);</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineminus">-</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineminus">-// Timer to mark read, if the user has configured the app to mark a message as</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineminus">-// read if it is viewed for more than n seconds.</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineminus">-var gMarkViewedMessageAsReadTimer = null;</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineminus">-</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineminus">-// the user preference,</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineminus">-// if HTML is not allowed. I assume, that the user could have set this to a</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineminus">-// value &gt; 1 in his prefs.js or user.js, but that the value will not</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineminus">-// change during runtime other than through the MsgBody*() functions below.</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineminus">-var gDisallow_classes_no_html = 1;</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineminus">-</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineminus">-// Disable the new account menu item if the account preference is locked.</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineminus">-// Two other affected areas are the account central and the account manager</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineminus">-// dialog.</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineminus">-function menu_new_init()</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineminus">-{</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineminus">-  // If we don't have a gFolderDisplay, just get out of here and leave the menu</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineminus">-  // as it is.</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineminus">-  if (!gFolderDisplay)</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineminus">-    return;</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineminus">-</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineminus">-  let folder = gFolderDisplay.displayedFolder;</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineminus">-  if (!folder)</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineminus">-    return;</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineminus">-</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineminus">-  if (!gMessengerBundle)</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineminus">-    gMessengerBundle = document.getElementById(&quot;bundle_messenger&quot;);</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineminus">-</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineminus">-  if (gPrefBranch.prefIsLocked(&quot;mail.disable_new_account_addition&quot;))</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineminus">-    document.getElementById(&quot;newAccountMenuItem&quot;).setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l1.73"></a><span id="l1.73" class="difflineminus">-</span>
<a href="#l1.74"></a><span id="l1.74" class="difflineminus">-  const nsMsgFolderFlags = Components.interfaces.nsMsgFolderFlags;</span>
<a href="#l1.75"></a><span id="l1.75" class="difflineminus">-  var isInbox = folder.isSpecialFolder(nsMsgFolderFlags.Inbox);</span>
<a href="#l1.76"></a><span id="l1.76" class="difflineminus">-  var showNew = folder.canCreateSubfolders ||</span>
<a href="#l1.77"></a><span id="l1.77" class="difflineminus">-                (isInbox &amp;&amp; !(folder.flags &amp; nsMsgFolderFlags.Virtual));</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineminus">-  ShowMenuItem(&quot;menu_newFolder&quot;, showNew);</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineminus">-  ShowMenuItem(&quot;menu_newVirtualFolder&quot;, showNew);</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineminus">-</span>
<a href="#l1.81"></a><span id="l1.81" class="difflineminus">-  EnableMenuItem(&quot;menu_newFolder&quot;, folder.server.type != &quot;imap&quot; || MailOfflineMgr.isOnline());</span>
<a href="#l1.82"></a><span id="l1.82" class="difflineminus">-  if (showNew)</span>
<a href="#l1.83"></a><span id="l1.83" class="difflineminus">-    // Change &quot;New Folder...&quot; menu according to the context.</span>
<a href="#l1.84"></a><span id="l1.84" class="difflineminus">-    SetMenuItemLabel(&quot;menu_newFolder&quot;, gMessengerBundle.getString(</span>
<a href="#l1.85"></a><span id="l1.85" class="difflineminus">-      (folder.isServer || isInbox) ? &quot;newFolderMenuItem&quot; : &quot;newSubfolderMenuItem&quot;));</span>
<a href="#l1.86"></a><span id="l1.86" class="difflineminus">-}</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineminus">-</span>
<a href="#l1.88"></a><span id="l1.88" class="difflineminus">-function goUpdateMailMenuItems(commandset)</span>
<a href="#l1.89"></a><span id="l1.89" class="difflineminus">-{</span>
<a href="#l1.90"></a><span id="l1.90" class="difflineminus">-  for (var i = 0; i &lt; commandset.childNodes.length; i++)</span>
<a href="#l1.91"></a><span id="l1.91" class="difflineminus">-  {</span>
<a href="#l1.92"></a><span id="l1.92" class="difflineminus">-    var commandID = commandset.childNodes[i].getAttribute(&quot;id&quot;);</span>
<a href="#l1.93"></a><span id="l1.93" class="difflineminus">-    if (commandID)</span>
<a href="#l1.94"></a><span id="l1.94" class="difflineminus">-      goUpdateCommand(commandID);</span>
<a href="#l1.95"></a><span id="l1.95" class="difflineminus">-  }</span>
<a href="#l1.96"></a><span id="l1.96" class="difflineminus">-}</span>
<a href="#l1.97"></a><span id="l1.97" class="difflineminus">-</span>
<a href="#l1.98"></a><span id="l1.98" class="difflineminus">-function file_init()</span>
<a href="#l1.99"></a><span id="l1.99" class="difflineminus">-{</span>
<a href="#l1.100"></a><span id="l1.100" class="difflineminus">-  document.commandDispatcher.updateCommands('create-menu-file');</span>
<a href="#l1.101"></a><span id="l1.101" class="difflineminus">-}</span>
<a href="#l1.102"></a><span id="l1.102" class="difflineminus">-</span>
<a href="#l1.103"></a><span id="l1.103" class="difflineminus">-function InitEditMessagesMenu()</span>
<a href="#l1.104"></a><span id="l1.104" class="difflineminus">-{</span>
<a href="#l1.105"></a><span id="l1.105" class="difflineminus">-  goSetMenuValue('cmd_delete', 'valueDefault');</span>
<a href="#l1.106"></a><span id="l1.106" class="difflineminus">-  goSetAccessKey('cmd_delete', 'valueDefaultAccessKey');</span>
<a href="#l1.107"></a><span id="l1.107" class="difflineminus">-  document.commandDispatcher.updateCommands('create-menu-edit');</span>
<a href="#l1.108"></a><span id="l1.108" class="difflineminus">-</span>
<a href="#l1.109"></a><span id="l1.109" class="difflineminus">-  // initialize the favorite Folder checkbox in the edit menu</span>
<a href="#l1.110"></a><span id="l1.110" class="difflineminus">-  var favoriteFolderMenu = document.getElementById('menu_favoriteFolder');</span>
<a href="#l1.111"></a><span id="l1.111" class="difflineminus">-  if (!favoriteFolderMenu.disabled)</span>
<a href="#l1.112"></a><span id="l1.112" class="difflineminus">-  {</span>
<a href="#l1.113"></a><span id="l1.113" class="difflineminus">-    var folders = gFolderTreeView.getSelectedFolders();</span>
<a href="#l1.114"></a><span id="l1.114" class="difflineminus">-    if (folders.length == 1 &amp;&amp; !folders[0].isServer)</span>
<a href="#l1.115"></a><span id="l1.115" class="difflineminus">-    {</span>
<a href="#l1.116"></a><span id="l1.116" class="difflineminus">-      const kFavoriteFlag = Components.interfaces.nsMsgFolderFlags.Favorite;</span>
<a href="#l1.117"></a><span id="l1.117" class="difflineminus">-      // Adjust the checked state on the menu item.</span>
<a href="#l1.118"></a><span id="l1.118" class="difflineminus">-      favoriteFolderMenu.setAttribute(&quot;checked&quot;, folders[0].getFlag(kFavoriteFlag));</span>
<a href="#l1.119"></a><span id="l1.119" class="difflineminus">-      favoriteFolderMenu.hidden = false;</span>
<a href="#l1.120"></a><span id="l1.120" class="difflineminus">-    }</span>
<a href="#l1.121"></a><span id="l1.121" class="difflineminus">-    else</span>
<a href="#l1.122"></a><span id="l1.122" class="difflineminus">-    {</span>
<a href="#l1.123"></a><span id="l1.123" class="difflineminus">-      favoriteFolderMenu.hidden = true;</span>
<a href="#l1.124"></a><span id="l1.124" class="difflineminus">-    }</span>
<a href="#l1.125"></a><span id="l1.125" class="difflineminus">-  }</span>
<a href="#l1.126"></a><span id="l1.126" class="difflineminus">-}</span>
<a href="#l1.127"></a><span id="l1.127" class="difflineminus">-</span>
<a href="#l1.128"></a><span id="l1.128" class="difflineminus">-function InitGoMessagesMenu()</span>
<a href="#l1.129"></a><span id="l1.129" class="difflineminus">-{</span>
<a href="#l1.130"></a><span id="l1.130" class="difflineminus">-  document.commandDispatcher.updateCommands('create-menu-go');</span>
<a href="#l1.131"></a><span id="l1.131" class="difflineminus">-}</span>
<a href="#l1.132"></a><span id="l1.132" class="difflineminus">-</span>
<a href="#l1.133"></a><span id="l1.133" class="difflineminus">-/**</span>
<a href="#l1.134"></a><span id="l1.134" class="difflineminus">- * This is called every time the view menu popup is displayed.  It is</span>
<a href="#l1.135"></a><span id="l1.135" class="difflineminus">- *  responsible for updating the menu items' state to reflect reality.</span>
<a href="#l1.136"></a><span id="l1.136" class="difflineminus">- */</span>
<a href="#l1.137"></a><span id="l1.137" class="difflineminus">-function view_init()</span>
<a href="#l1.138"></a><span id="l1.138" class="difflineminus">-{</span>
<a href="#l1.139"></a><span id="l1.139" class="difflineminus">-  var isFeed = gFolderDisplay.selectedMessageIsFeed;</span>
<a href="#l1.140"></a><span id="l1.140" class="difflineminus">-</span>
<a href="#l1.141"></a><span id="l1.141" class="difflineminus">-  if (!gMessengerBundle)</span>
<a href="#l1.142"></a><span id="l1.142" class="difflineminus">-    gMessengerBundle = document.getElementById(&quot;bundle_messenger&quot;);</span>
<a href="#l1.143"></a><span id="l1.143" class="difflineminus">-</span>
<a href="#l1.144"></a><span id="l1.144" class="difflineminus">-  let accountCentralDisplayed = gFolderDisplay.isAccountCentralDisplayed;</span>
<a href="#l1.145"></a><span id="l1.145" class="difflineminus">-  var messagePaneMenuItem = document.getElementById(&quot;menu_showMessage&quot;);</span>
<a href="#l1.146"></a><span id="l1.146" class="difflineminus">-  if (!messagePaneMenuItem.hidden) { // Hidden in the standalone msg window.</span>
<a href="#l1.147"></a><span id="l1.147" class="difflineminus">-    messagePaneMenuItem.setAttribute(&quot;checked&quot;,</span>
<a href="#l1.148"></a><span id="l1.148" class="difflineminus">-      accountCentralDisplayed ? false : gMessageDisplay.visible);</span>
<a href="#l1.149"></a><span id="l1.149" class="difflineminus">-    messagePaneMenuItem.disabled = accountCentralDisplayed;</span>
<a href="#l1.150"></a><span id="l1.150" class="difflineminus">-  }</span>
<a href="#l1.151"></a><span id="l1.151" class="difflineminus">-</span>
<a href="#l1.152"></a><span id="l1.152" class="difflineminus">-  // Disable some menus if account manager is showing</span>
<a href="#l1.153"></a><span id="l1.153" class="difflineminus">-  document.getElementById(&quot;viewSortMenu&quot;).disabled = accountCentralDisplayed;</span>
<a href="#l1.154"></a><span id="l1.154" class="difflineminus">-  document.getElementById(&quot;viewMessageViewMenu&quot;).disabled = accountCentralDisplayed;</span>
<a href="#l1.155"></a><span id="l1.155" class="difflineminus">-  document.getElementById(&quot;viewMessagesMenu&quot;).disabled = accountCentralDisplayed;</span>
<a href="#l1.156"></a><span id="l1.156" class="difflineminus">-</span>
<a href="#l1.157"></a><span id="l1.157" class="difflineminus">-  // Hide the views menu item if the user doesn't have the views toolbar button</span>
<a href="#l1.158"></a><span id="l1.158" class="difflineminus">-  // visible.</span>
<a href="#l1.159"></a><span id="l1.159" class="difflineminus">-  var viewsToolbarButton = document.getElementById(&quot;mailviews-container&quot;);</span>
<a href="#l1.160"></a><span id="l1.160" class="difflineminus">-  document.getElementById('viewMessageViewMenu').hidden = !viewsToolbarButton;</span>
<a href="#l1.161"></a><span id="l1.161" class="difflineminus">-</span>
<a href="#l1.162"></a><span id="l1.162" class="difflineminus">-  // ... and also the separator.</span>
<a href="#l1.163"></a><span id="l1.163" class="difflineminus">-  document.getElementById(&quot;viewMenuAfterTaskbarSeparator&quot;).hidden = !viewsToolbarButton;</span>
<a href="#l1.164"></a><span id="l1.164" class="difflineminus">-</span>
<a href="#l1.165"></a><span id="l1.165" class="difflineminus">-  // Initialize the Message Body menuitem</span>
<a href="#l1.166"></a><span id="l1.166" class="difflineminus">-  document.getElementById('viewBodyMenu').hidden = isFeed;</span>
<a href="#l1.167"></a><span id="l1.167" class="difflineminus">-</span>
<a href="#l1.168"></a><span id="l1.168" class="difflineminus">-  // Initialize the Show Feed Summary menu</span>
<a href="#l1.169"></a><span id="l1.169" class="difflineminus">-  var viewFeedSummary = document.getElementById('viewFeedSummary');</span>
<a href="#l1.170"></a><span id="l1.170" class="difflineminus">-  var winType = document.documentElement.getAttribute('windowtype');</span>
<a href="#l1.171"></a><span id="l1.171" class="difflineminus">-  if (winType != &quot;mail:3pane&quot;)</span>
<a href="#l1.172"></a><span id="l1.172" class="difflineminus">-    viewFeedSummary.hidden = !gShowFeedSummary;</span>
<a href="#l1.173"></a><span id="l1.173" class="difflineminus">-  else</span>
<a href="#l1.174"></a><span id="l1.174" class="difflineminus">-    viewFeedSummary.hidden = !isFeed;</span>
<a href="#l1.175"></a><span id="l1.175" class="difflineminus">-</span>
<a href="#l1.176"></a><span id="l1.176" class="difflineminus">-  var viewRssMenuItemIds = [&quot;bodyFeedGlobalWebPage&quot;,</span>
<a href="#l1.177"></a><span id="l1.177" class="difflineminus">-                            &quot;bodyFeedGlobalSummary&quot;,</span>
<a href="#l1.178"></a><span id="l1.178" class="difflineminus">-                            &quot;bodyFeedPerFolderPref&quot;];</span>
<a href="#l1.179"></a><span id="l1.179" class="difflineminus">-  var checked = gPrefBranch.getIntPref(&quot;rss.show.summary&quot;);</span>
<a href="#l1.180"></a><span id="l1.180" class="difflineminus">-  document.getElementById(viewRssMenuItemIds[checked])</span>
<a href="#l1.181"></a><span id="l1.181" class="difflineminus">-          .setAttribute(&quot;checked&quot;, true);</span>
<a href="#l1.182"></a><span id="l1.182" class="difflineminus">-</span>
<a href="#l1.183"></a><span id="l1.183" class="difflineminus">-  if (winType != &quot;mail:3pane&quot;) {</span>
<a href="#l1.184"></a><span id="l1.184" class="difflineminus">-    document.getElementById(&quot;viewFeedSummarySeparator&quot;).hidden = true;</span>
<a href="#l1.185"></a><span id="l1.185" class="difflineminus">-    document.getElementById(&quot;bodyFeedGlobalWebPage&quot;).hidden = true;</span>
<a href="#l1.186"></a><span id="l1.186" class="difflineminus">-    document.getElementById(&quot;bodyFeedGlobalSummary&quot;).hidden = true;</span>
<a href="#l1.187"></a><span id="l1.187" class="difflineminus">-    document.getElementById(&quot;bodyFeedPerFolderPref&quot;).hidden = true;</span>
<a href="#l1.188"></a><span id="l1.188" class="difflineminus">-  }</span>
<a href="#l1.189"></a><span id="l1.189" class="difflineminus">-</span>
<a href="#l1.190"></a><span id="l1.190" class="difflineminus">-  // Initialize the View Attachment Inline menu</span>
<a href="#l1.191"></a><span id="l1.191" class="difflineminus">-  var viewAttachmentInline = pref.getBoolPref(&quot;mail.inline_attachments&quot;);</span>
<a href="#l1.192"></a><span id="l1.192" class="difflineminus">-  document.getElementById(&quot;viewAttachmentsInlineMenuitem&quot;)</span>
<a href="#l1.193"></a><span id="l1.193" class="difflineminus">-          .setAttribute(&quot;checked&quot;, viewAttachmentInline);</span>
<a href="#l1.194"></a><span id="l1.194" class="difflineminus">-</span>
<a href="#l1.195"></a><span id="l1.195" class="difflineminus">-  document.commandDispatcher.updateCommands('create-menu-view');</span>
<a href="#l1.196"></a><span id="l1.196" class="difflineminus">-}</span>
<a href="#l1.197"></a><span id="l1.197" class="difflineminus">-</span>
<a href="#l1.198"></a><span id="l1.198" class="difflineminus">-function InitViewLayoutStyleMenu(event)</span>
<a href="#l1.199"></a><span id="l1.199" class="difflineminus">-{</span>
<a href="#l1.200"></a><span id="l1.200" class="difflineminus">-  var paneConfig = pref.getIntPref(&quot;mail.pane_config.dynamic&quot;);</span>
<a href="#l1.201"></a><span id="l1.201" class="difflineminus">-  var layoutStyleMenuitem = event.target.childNodes[paneConfig];</span>
<a href="#l1.202"></a><span id="l1.202" class="difflineminus">-  if (layoutStyleMenuitem)</span>
<a href="#l1.203"></a><span id="l1.203" class="difflineminus">-    layoutStyleMenuitem.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l1.204"></a><span id="l1.204" class="difflineminus">-}</span>
<a href="#l1.205"></a><span id="l1.205" class="difflineminus">-</span>
<a href="#l1.206"></a><span id="l1.206" class="difflineminus">-/**</span>
<a href="#l1.207"></a><span id="l1.207" class="difflineminus">- * Initialize (check) appropriate folder mode under the View |Â Folder menu.</span>
<a href="#l1.208"></a><span id="l1.208" class="difflineminus">- */</span>
<a href="#l1.209"></a><span id="l1.209" class="difflineminus">-function InitViewFolderViewsMenu(event)</span>
<a href="#l1.210"></a><span id="l1.210" class="difflineminus">-{</span>
<a href="#l1.211"></a><span id="l1.211" class="difflineminus">-  for (let i = 0; i &lt; event.target.childNodes.length; i++) {</span>
<a href="#l1.212"></a><span id="l1.212" class="difflineminus">-    if (event.target.childNodes[i].value == gFolderTreeView.mode) {</span>
<a href="#l1.213"></a><span id="l1.213" class="difflineminus">-      event.target.childNodes[i].setAttribute(&quot;checked&quot;, true);</span>
<a href="#l1.214"></a><span id="l1.214" class="difflineminus">-      break;</span>
<a href="#l1.215"></a><span id="l1.215" class="difflineminus">-    }</span>
<a href="#l1.216"></a><span id="l1.216" class="difflineminus">-  }</span>
<a href="#l1.217"></a><span id="l1.217" class="difflineminus">-}</span>
<a href="#l1.218"></a><span id="l1.218" class="difflineminus">-</span>
<a href="#l1.219"></a><span id="l1.219" class="difflineminus">-function setSortByMenuItemCheckState(id, value)</span>
<a href="#l1.220"></a><span id="l1.220" class="difflineminus">-{</span>
<a href="#l1.221"></a><span id="l1.221" class="difflineminus">-  var menuitem = document.getElementById(id);</span>
<a href="#l1.222"></a><span id="l1.222" class="difflineminus">-  if (menuitem)</span>
<a href="#l1.223"></a><span id="l1.223" class="difflineminus">-    menuitem.setAttribute(&quot;checked&quot;, value);</span>
<a href="#l1.224"></a><span id="l1.224" class="difflineminus">-}</span>
<a href="#l1.225"></a><span id="l1.225" class="difflineminus">-</span>
<a href="#l1.226"></a><span id="l1.226" class="difflineminus">-/**</span>
<a href="#l1.227"></a><span id="l1.227" class="difflineminus">- * Called when showing the menu_viewSortPopup menupopup, so it should always</span>
<a href="#l1.228"></a><span id="l1.228" class="difflineminus">- * be up-to-date.</span>
<a href="#l1.229"></a><span id="l1.229" class="difflineminus">- */</span>
<a href="#l1.230"></a><span id="l1.230" class="difflineminus">-function InitViewSortByMenu()</span>
<a href="#l1.231"></a><span id="l1.231" class="difflineminus">-{</span>
<a href="#l1.232"></a><span id="l1.232" class="difflineminus">-  var sortType = gFolderDisplay.view.primarySortType;</span>
<a href="#l1.233"></a><span id="l1.233" class="difflineminus">-</span>
<a href="#l1.234"></a><span id="l1.234" class="difflineminus">-  setSortByMenuItemCheckState(&quot;sortByDateMenuitem&quot;, (sortType == nsMsgViewSortType.byDate));</span>
<a href="#l1.235"></a><span id="l1.235" class="difflineminus">-  setSortByMenuItemCheckState(&quot;sortByReceivedMenuitem&quot;, (sortType == nsMsgViewSortType.byReceived));</span>
<a href="#l1.236"></a><span id="l1.236" class="difflineminus">-  setSortByMenuItemCheckState(&quot;sortByFlagMenuitem&quot;, (sortType == nsMsgViewSortType.byFlagged));</span>
<a href="#l1.237"></a><span id="l1.237" class="difflineminus">-  setSortByMenuItemCheckState(&quot;sortByOrderReceivedMenuitem&quot;, (sortType == nsMsgViewSortType.byId));</span>
<a href="#l1.238"></a><span id="l1.238" class="difflineminus">-  setSortByMenuItemCheckState(&quot;sortByPriorityMenuitem&quot;, (sortType == nsMsgViewSortType.byPriority));</span>
<a href="#l1.239"></a><span id="l1.239" class="difflineminus">-  setSortByMenuItemCheckState(&quot;sortBySizeMenuitem&quot;, (sortType == nsMsgViewSortType.bySize));</span>
<a href="#l1.240"></a><span id="l1.240" class="difflineminus">-  setSortByMenuItemCheckState(&quot;sortByStatusMenuitem&quot;, (sortType == nsMsgViewSortType.byStatus));</span>
<a href="#l1.241"></a><span id="l1.241" class="difflineminus">-  setSortByMenuItemCheckState(&quot;sortBySubjectMenuitem&quot;, (sortType == nsMsgViewSortType.bySubject));</span>
<a href="#l1.242"></a><span id="l1.242" class="difflineminus">-  setSortByMenuItemCheckState(&quot;sortByUnreadMenuitem&quot;, (sortType == nsMsgViewSortType.byUnread));</span>
<a href="#l1.243"></a><span id="l1.243" class="difflineminus">-  setSortByMenuItemCheckState(&quot;sortByTagsMenuitem&quot;, (sortType == nsMsgViewSortType.byTags));</span>
<a href="#l1.244"></a><span id="l1.244" class="difflineminus">-  setSortByMenuItemCheckState(&quot;sortByJunkStatusMenuitem&quot;, (sortType == nsMsgViewSortType.byJunkStatus));</span>
<a href="#l1.245"></a><span id="l1.245" class="difflineminus">-  setSortByMenuItemCheckState(&quot;sortByFromMenuitem&quot;, (sortType == nsMsgViewSortType.byAuthor));</span>
<a href="#l1.246"></a><span id="l1.246" class="difflineminus">-  setSortByMenuItemCheckState(&quot;sortByRecipientMenuitem&quot;, (sortType == nsMsgViewSortType.byRecipient));</span>
<a href="#l1.247"></a><span id="l1.247" class="difflineminus">-  setSortByMenuItemCheckState(&quot;sortByAttachmentsMenuitem&quot;, (sortType == nsMsgViewSortType.byAttachments));</span>
<a href="#l1.248"></a><span id="l1.248" class="difflineminus">-</span>
<a href="#l1.249"></a><span id="l1.249" class="difflineminus">-  var sortOrder = gFolderDisplay.view.primarySortOrder;</span>
<a href="#l1.250"></a><span id="l1.250" class="difflineminus">-  var sortTypeSupportsGrouping = (sortType == nsMsgViewSortType.byAuthor ||</span>
<a href="#l1.251"></a><span id="l1.251" class="difflineminus">-      sortType == nsMsgViewSortType.byDate || sortType == nsMsgViewSortType.byReceived ||</span>
<a href="#l1.252"></a><span id="l1.252" class="difflineminus">-      sortType == nsMsgViewSortType.byPriority ||</span>
<a href="#l1.253"></a><span id="l1.253" class="difflineminus">-      sortType == nsMsgViewSortType.bySubject || sortType == nsMsgViewSortType.byTags ||</span>
<a href="#l1.254"></a><span id="l1.254" class="difflineminus">-      sortType == nsMsgViewSortType.byRecipient || sortType == nsMsgViewSortType.byAccount ||</span>
<a href="#l1.255"></a><span id="l1.255" class="difflineminus">-      sortType == nsMsgViewSortType.byStatus || sortType == nsMsgViewSortType.byFlagged ||</span>
<a href="#l1.256"></a><span id="l1.256" class="difflineminus">-      sortType == nsMsgViewSortType.byAttachments);</span>
<a href="#l1.257"></a><span id="l1.257" class="difflineminus">-</span>
<a href="#l1.258"></a><span id="l1.258" class="difflineminus">-  setSortByMenuItemCheckState(&quot;sortAscending&quot;, (sortOrder == nsMsgViewSortOrder.ascending));</span>
<a href="#l1.259"></a><span id="l1.259" class="difflineminus">-  setSortByMenuItemCheckState(&quot;sortDescending&quot;, (sortOrder == nsMsgViewSortOrder.descending));</span>
<a href="#l1.260"></a><span id="l1.260" class="difflineminus">-</span>
<a href="#l1.261"></a><span id="l1.261" class="difflineminus">-  var grouped = gFolderDisplay.view.showGroupedBySort;</span>
<a href="#l1.262"></a><span id="l1.262" class="difflineminus">-  var threaded = gFolderDisplay.view.showThreaded;</span>
<a href="#l1.263"></a><span id="l1.263" class="difflineminus">-  var sortThreadedMenuItem = document.getElementById(&quot;sortThreaded&quot;);</span>
<a href="#l1.264"></a><span id="l1.264" class="difflineminus">-  var sortUnthreadedMenuItem = document.getElementById(&quot;sortUnthreaded&quot;);</span>
<a href="#l1.265"></a><span id="l1.265" class="difflineminus">-</span>
<a href="#l1.266"></a><span id="l1.266" class="difflineminus">-  sortThreadedMenuItem.setAttribute(&quot;checked&quot;, threaded);</span>
<a href="#l1.267"></a><span id="l1.267" class="difflineminus">-  sortUnthreadedMenuItem.setAttribute(&quot;checked&quot;, !threaded &amp;&amp; !grouped);</span>
<a href="#l1.268"></a><span id="l1.268" class="difflineminus">-</span>
<a href="#l1.269"></a><span id="l1.269" class="difflineminus">-  var groupBySortOrderMenuItem = document.getElementById(&quot;groupBySort&quot;);</span>
<a href="#l1.270"></a><span id="l1.270" class="difflineminus">-</span>
<a href="#l1.271"></a><span id="l1.271" class="difflineminus">-  groupBySortOrderMenuItem.setAttribute(&quot;disabled&quot;, !sortTypeSupportsGrouping);</span>
<a href="#l1.272"></a><span id="l1.272" class="difflineminus">-  groupBySortOrderMenuItem.setAttribute(&quot;checked&quot;, grouped);</span>
<a href="#l1.273"></a><span id="l1.273" class="difflineminus">-}</span>
<a href="#l1.274"></a><span id="l1.274" class="difflineminus">-</span>
<a href="#l1.275"></a><span id="l1.275" class="difflineminus">-function InitViewMessagesMenu()</span>
<a href="#l1.276"></a><span id="l1.276" class="difflineminus">-{</span>
<a href="#l1.277"></a><span id="l1.277" class="difflineminus">-  document.getElementById(&quot;viewAllMessagesMenuItem&quot;).setAttribute(&quot;checked&quot;,</span>
<a href="#l1.278"></a><span id="l1.278" class="difflineminus">-    !gFolderDisplay.view.showUnreadOnly &amp;&amp;</span>
<a href="#l1.279"></a><span id="l1.279" class="difflineminus">-    !gFolderDisplay.view.specialView);</span>
<a href="#l1.280"></a><span id="l1.280" class="difflineminus">-</span>
<a href="#l1.281"></a><span id="l1.281" class="difflineminus">-  document.getElementById(&quot;viewUnreadMessagesMenuItem&quot;).setAttribute(&quot;checked&quot;,</span>
<a href="#l1.282"></a><span id="l1.282" class="difflineminus">-    gFolderDisplay.view.showUnreadOnly);</span>
<a href="#l1.283"></a><span id="l1.283" class="difflineminus">-</span>
<a href="#l1.284"></a><span id="l1.284" class="difflineminus">-  document.getElementById(&quot;viewThreadsWithUnreadMenuItem&quot;).setAttribute(&quot;checked&quot;,</span>
<a href="#l1.285"></a><span id="l1.285" class="difflineminus">-    gFolderDisplay.view.specialViewThreadsWithUnread);</span>
<a href="#l1.286"></a><span id="l1.286" class="difflineminus">-</span>
<a href="#l1.287"></a><span id="l1.287" class="difflineminus">-  document.getElementById(&quot;viewWatchedThreadsWithUnreadMenuItem&quot;).setAttribute(&quot;checked&quot;,</span>
<a href="#l1.288"></a><span id="l1.288" class="difflineminus">-    gFolderDisplay.view.specialViewWatchedThreadsWithUnread);</span>
<a href="#l1.289"></a><span id="l1.289" class="difflineminus">-</span>
<a href="#l1.290"></a><span id="l1.290" class="difflineminus">-  document.getElementById(&quot;viewIgnoredThreadsMenuItem&quot;).setAttribute(&quot;checked&quot;,</span>
<a href="#l1.291"></a><span id="l1.291" class="difflineminus">-    gFolderDisplay.view.showIgnored);</span>
<a href="#l1.292"></a><span id="l1.292" class="difflineminus">-}</span>
<a href="#l1.293"></a><span id="l1.293" class="difflineminus">-</span>
<a href="#l1.294"></a><span id="l1.294" class="difflineminus">-function InitMessageMenu()</span>
<a href="#l1.295"></a><span id="l1.295" class="difflineminus">-{</span>
<a href="#l1.296"></a><span id="l1.296" class="difflineminus">-  var selectedMsg = gFolderDisplay.selectedMessage;</span>
<a href="#l1.297"></a><span id="l1.297" class="difflineminus">-  var isNews = gFolderDisplay.selectedMessageIsNews;</span>
<a href="#l1.298"></a><span id="l1.298" class="difflineminus">-  var isFeed = gFolderDisplay.selectedMessageIsFeed;</span>
<a href="#l1.299"></a><span id="l1.299" class="difflineminus">-</span>
<a href="#l1.300"></a><span id="l1.300" class="difflineminus">-  // We show reply to Newsgroups only for news messages.</span>
<a href="#l1.301"></a><span id="l1.301" class="difflineminus">-  document.getElementById(&quot;replyNewsgroupMainMenu&quot;).hidden = !isNews;</span>
<a href="#l1.302"></a><span id="l1.302" class="difflineminus">-</span>
<a href="#l1.303"></a><span id="l1.303" class="difflineminus">-  // For mail messages we say reply. For news we say ReplyToSender.</span>
<a href="#l1.304"></a><span id="l1.304" class="difflineminus">-  document.getElementById(&quot;replyMainMenu&quot;).hidden = isNews;</span>
<a href="#l1.305"></a><span id="l1.305" class="difflineminus">-  document.getElementById(&quot;replySenderMainMenu&quot;).hidden = !isNews;</span>
<a href="#l1.306"></a><span id="l1.306" class="difflineminus">-</span>
<a href="#l1.307"></a><span id="l1.307" class="difflineminus">-  // We only kill and watch threads for news.</span>
<a href="#l1.308"></a><span id="l1.308" class="difflineminus">-  document.getElementById(&quot;threadItemsSeparator&quot;).hidden = !isNews;</span>
<a href="#l1.309"></a><span id="l1.309" class="difflineminus">-  document.getElementById(&quot;killThread&quot;).hidden = !isNews;</span>
<a href="#l1.310"></a><span id="l1.310" class="difflineminus">-  document.getElementById(&quot;killSubthread&quot;).hidden = !isNews;</span>
<a href="#l1.311"></a><span id="l1.311" class="difflineminus">-  document.getElementById(&quot;watchThread&quot;).hidden = !isNews;</span>
<a href="#l1.312"></a><span id="l1.312" class="difflineminus">-</span>
<a href="#l1.313"></a><span id="l1.313" class="difflineminus">-  // Disable the move and copy menus if there are no messages selected.</span>
<a href="#l1.314"></a><span id="l1.314" class="difflineminus">-  // Disable the move menu if we can't delete msgs from the folder.</span>
<a href="#l1.315"></a><span id="l1.315" class="difflineminus">-  var msgFolder = gFolderDisplay.displayedFolder;</span>
<a href="#l1.316"></a><span id="l1.316" class="difflineminus">-  var enableMenuItem = selectedMsg &amp;&amp; msgFolder &amp;&amp; msgFolder.canDeleteMessages;</span>
<a href="#l1.317"></a><span id="l1.317" class="difflineminus">-  document.getElementById(&quot;moveMenu&quot;).disabled = !enableMenuItem;</span>
<a href="#l1.318"></a><span id="l1.318" class="difflineminus">-</span>
<a href="#l1.319"></a><span id="l1.319" class="difflineminus">-  // Also disable copy when no folder is loaded (like for .eml files).</span>
<a href="#l1.320"></a><span id="l1.320" class="difflineminus">-  document.getElementById(&quot;copyMenu&quot;).disabled = !(selectedMsg &amp;&amp; msgFolder);</span>
<a href="#l1.321"></a><span id="l1.321" class="difflineminus">-</span>
<a href="#l1.322"></a><span id="l1.322" class="difflineminus">-  initMoveToFolderAgainMenu(document.getElementById(&quot;moveToFolderAgain&quot;));</span>
<a href="#l1.323"></a><span id="l1.323" class="difflineminus">-</span>
<a href="#l1.324"></a><span id="l1.324" class="difflineminus">-  // Disable the Forward As menu item if no message is selected.</span>
<a href="#l1.325"></a><span id="l1.325" class="difflineminus">-  document.getElementById(&quot;forwardAsMenu&quot;).disabled = !selectedMsg;</span>
<a href="#l1.326"></a><span id="l1.326" class="difflineminus">-</span>
<a href="#l1.327"></a><span id="l1.327" class="difflineminus">-  // Disable the Tag menu item if no message is selected or when we're</span>
<a href="#l1.328"></a><span id="l1.328" class="difflineminus">-  // not in a folder.</span>
<a href="#l1.329"></a><span id="l1.329" class="difflineminus">-  document.getElementById(&quot;tagMenu&quot;).disabled = !(selectedMsg &amp;&amp; msgFolder);</span>
<a href="#l1.330"></a><span id="l1.330" class="difflineminus">-</span>
<a href="#l1.331"></a><span id="l1.331" class="difflineminus">-  // Initialize the Open Message menuitem</span>
<a href="#l1.332"></a><span id="l1.332" class="difflineminus">-  var winType = document.documentElement.getAttribute('windowtype');</span>
<a href="#l1.333"></a><span id="l1.333" class="difflineminus">-  if (winType == &quot;mail:3pane&quot;)</span>
<a href="#l1.334"></a><span id="l1.334" class="difflineminus">-    document.getElementById('openMessageWindowMenuitem').hidden = isFeed;</span>
<a href="#l1.335"></a><span id="l1.335" class="difflineminus">-</span>
<a href="#l1.336"></a><span id="l1.336" class="difflineminus">-  // Initialize the Open Feed Message handler menu</span>
<a href="#l1.337"></a><span id="l1.337" class="difflineminus">-  var index = GetFeedOpenHandler();</span>
<a href="#l1.338"></a><span id="l1.338" class="difflineminus">-  document.getElementById(&quot;menu_openFeedMessage&quot;)</span>
<a href="#l1.339"></a><span id="l1.339" class="difflineminus">-          .childNodes[index].setAttribute(&quot;checked&quot;, true);</span>
<a href="#l1.340"></a><span id="l1.340" class="difflineminus">-  var openRssMenu = document.getElementById(&quot;openFeedMessage&quot;);</span>
<a href="#l1.341"></a><span id="l1.341" class="difflineminus">-  openRssMenu.hidden = !isFeed;</span>
<a href="#l1.342"></a><span id="l1.342" class="difflineminus">-  if (winType != &quot;mail:3pane&quot;)</span>
<a href="#l1.343"></a><span id="l1.343" class="difflineminus">-    openRssMenu.hidden = true;</span>
<a href="#l1.344"></a><span id="l1.344" class="difflineminus">-</span>
<a href="#l1.345"></a><span id="l1.345" class="difflineminus">-  // Disable mark menu when we're not in a folder.</span>
<a href="#l1.346"></a><span id="l1.346" class="difflineminus">-  document.getElementById(&quot;markMenu&quot;).disabled = !msgFolder;</span>
<a href="#l1.347"></a><span id="l1.347" class="difflineminus">-</span>
<a href="#l1.348"></a><span id="l1.348" class="difflineminus">-  document.commandDispatcher.updateCommands('create-menu-message');</span>
<a href="#l1.349"></a><span id="l1.349" class="difflineminus">-}</span>
<a href="#l1.350"></a><span id="l1.350" class="difflineminus">-</span>
<a href="#l1.351"></a><span id="l1.351" class="difflineminus">-/**</span>
<a href="#l1.352"></a><span id="l1.352" class="difflineminus">- * Initializes the menu item aMenuItem to show either &quot;Move&quot; or &quot;Copy&quot; to</span>
<a href="#l1.353"></a><span id="l1.353" class="difflineminus">- * folder again, based on the value of mail.last_msg_movecopy_target_uri.</span>
<a href="#l1.354"></a><span id="l1.354" class="difflineminus">- * The menu item label and accesskey are adjusted to include the folder name.</span>
<a href="#l1.355"></a><span id="l1.355" class="difflineminus">- *</span>
<a href="#l1.356"></a><span id="l1.356" class="difflineminus">- * @param aMenuItem the menu item to adjust</span>
<a href="#l1.357"></a><span id="l1.357" class="difflineminus">- */</span>
<a href="#l1.358"></a><span id="l1.358" class="difflineminus">-function initMoveToFolderAgainMenu(aMenuItem)</span>
<a href="#l1.359"></a><span id="l1.359" class="difflineminus">-{</span>
<a href="#l1.360"></a><span id="l1.360" class="difflineminus">-  var lastFolderURI = pref.getCharPref(&quot;mail.last_msg_movecopy_target_uri&quot;);</span>
<a href="#l1.361"></a><span id="l1.361" class="difflineminus">-  var isMove = pref.getBoolPref(&quot;mail.last_msg_movecopy_was_move&quot;);</span>
<a href="#l1.362"></a><span id="l1.362" class="difflineminus">-  if (lastFolderURI)</span>
<a href="#l1.363"></a><span id="l1.363" class="difflineminus">-  {</span>
<a href="#l1.364"></a><span id="l1.364" class="difflineminus">-    var destMsgFolder = GetMsgFolderFromUri(lastFolderURI);</span>
<a href="#l1.365"></a><span id="l1.365" class="difflineminus">-    aMenuItem.label = gMessengerBundle.getFormattedString(isMove ?</span>
<a href="#l1.366"></a><span id="l1.366" class="difflineminus">-      &quot;moveToFolderAgain&quot; : &quot;copyToFolderAgain&quot;, [destMsgFolder.prettyName], 1);</span>
<a href="#l1.367"></a><span id="l1.367" class="difflineminus">-    aMenuItem.accesskey = gMessengerBundle.getString(isMove ?</span>
<a href="#l1.368"></a><span id="l1.368" class="difflineminus">-      &quot;moveToFolderAgainAccessKey&quot; : &quot;copyToFolderAgainAccessKey&quot;);</span>
<a href="#l1.369"></a><span id="l1.369" class="difflineminus">-  }</span>
<a href="#l1.370"></a><span id="l1.370" class="difflineminus">-}</span>
<a href="#l1.371"></a><span id="l1.371" class="difflineminus">-</span>
<a href="#l1.372"></a><span id="l1.372" class="difflineminus">-function InitViewHeadersMenu()</span>
<a href="#l1.373"></a><span id="l1.373" class="difflineminus">-{</span>
<a href="#l1.374"></a><span id="l1.374" class="difflineminus">-  const nsMimeHeaderDisplayTypes = Components.interfaces.nsMimeHeaderDisplayTypes;</span>
<a href="#l1.375"></a><span id="l1.375" class="difflineminus">-  var headerchoice = pref.getIntPref(&quot;mail.show_headers&quot;);</span>
<a href="#l1.376"></a><span id="l1.376" class="difflineminus">-  document.getElementById(&quot;cmd_viewAllHeader&quot;)</span>
<a href="#l1.377"></a><span id="l1.377" class="difflineminus">-          .setAttribute(&quot;checked&quot;, headerchoice == nsMimeHeaderDisplayTypes.AllHeaders);</span>
<a href="#l1.378"></a><span id="l1.378" class="difflineminus">-  document.getElementById(&quot;cmd_viewNormalHeader&quot;)</span>
<a href="#l1.379"></a><span id="l1.379" class="difflineminus">-          .setAttribute(&quot;checked&quot;, headerchoice == nsMimeHeaderDisplayTypes.NormalHeaders);</span>
<a href="#l1.380"></a><span id="l1.380" class="difflineminus">-  document.commandDispatcher.updateCommands(&quot;create-menu-mark&quot;);</span>
<a href="#l1.381"></a><span id="l1.381" class="difflineminus">-}</span>
<a href="#l1.382"></a><span id="l1.382" class="difflineminus">-</span>
<a href="#l1.383"></a><span id="l1.383" class="difflineminus">-function InitViewBodyMenu()</span>
<a href="#l1.384"></a><span id="l1.384" class="difflineminus">-{</span>
<a href="#l1.385"></a><span id="l1.385" class="difflineminus">-  var html_as = 0;</span>
<a href="#l1.386"></a><span id="l1.386" class="difflineminus">-  var prefer_plaintext = false;</span>
<a href="#l1.387"></a><span id="l1.387" class="difflineminus">-  var disallow_classes = 0;</span>
<a href="#l1.388"></a><span id="l1.388" class="difflineminus">-  var isFeed = gFolderDisplay.selectedMessageIsFeed;</span>
<a href="#l1.389"></a><span id="l1.389" class="difflineminus">-  const defaultIDs = [&quot;bodyAllowHTML&quot;,</span>
<a href="#l1.390"></a><span id="l1.390" class="difflineminus">-                      &quot;bodySanitized&quot;,</span>
<a href="#l1.391"></a><span id="l1.391" class="difflineminus">-                      &quot;bodyAsPlaintext&quot;];</span>
<a href="#l1.392"></a><span id="l1.392" class="difflineminus">-  const rssIDs = [&quot;bodyFeedSummaryAllowHTML&quot;,</span>
<a href="#l1.393"></a><span id="l1.393" class="difflineminus">-                  &quot;bodyFeedSummarySanitized&quot;,</span>
<a href="#l1.394"></a><span id="l1.394" class="difflineminus">-                  &quot;bodyFeedSummaryAsPlaintext&quot;];</span>
<a href="#l1.395"></a><span id="l1.395" class="difflineminus">-  var menuIDs = isFeed ? rssIDs : defaultIDs;</span>
<a href="#l1.396"></a><span id="l1.396" class="difflineminus">-  try</span>
<a href="#l1.397"></a><span id="l1.397" class="difflineminus">-  {</span>
<a href="#l1.398"></a><span id="l1.398" class="difflineminus">-    // Get prefs</span>
<a href="#l1.399"></a><span id="l1.399" class="difflineminus">-    if (isFeed) {</span>
<a href="#l1.400"></a><span id="l1.400" class="difflineminus">-      prefer_plaintext = pref.getBoolPref(&quot;rss.display.prefer_plaintext&quot;);</span>
<a href="#l1.401"></a><span id="l1.401" class="difflineminus">-      html_as = pref.getIntPref(&quot;rss.display.html_as&quot;);</span>
<a href="#l1.402"></a><span id="l1.402" class="difflineminus">-      disallow_classes = pref.getIntPref(&quot;rss.display.disallow_mime_handlers&quot;);</span>
<a href="#l1.403"></a><span id="l1.403" class="difflineminus">-    }</span>
<a href="#l1.404"></a><span id="l1.404" class="difflineminus">-    else {</span>
<a href="#l1.405"></a><span id="l1.405" class="difflineminus">-      prefer_plaintext = pref.getBoolPref(&quot;mailnews.display.prefer_plaintext&quot;);</span>
<a href="#l1.406"></a><span id="l1.406" class="difflineminus">-      html_as = pref.getIntPref(&quot;mailnews.display.html_as&quot;);</span>
<a href="#l1.407"></a><span id="l1.407" class="difflineminus">-      disallow_classes = pref.getIntPref(&quot;mailnews.display.disallow_mime_handlers&quot;);</span>
<a href="#l1.408"></a><span id="l1.408" class="difflineminus">-    }</span>
<a href="#l1.409"></a><span id="l1.409" class="difflineminus">-</span>
<a href="#l1.410"></a><span id="l1.410" class="difflineminus">-    if (disallow_classes &gt; 0)</span>
<a href="#l1.411"></a><span id="l1.411" class="difflineminus">-      gDisallow_classes_no_html = disallow_classes;</span>
<a href="#l1.412"></a><span id="l1.412" class="difflineminus">-    // else gDisallow_classes_no_html keeps its inital value (see top)</span>
<a href="#l1.413"></a><span id="l1.413" class="difflineminus">-  }</span>
<a href="#l1.414"></a><span id="l1.414" class="difflineminus">-  catch (ex)</span>
<a href="#l1.415"></a><span id="l1.415" class="difflineminus">-  {</span>
<a href="#l1.416"></a><span id="l1.416" class="difflineminus">-    dump(&quot;failed to get the body plaintext vs. HTML prefs\n&quot;);</span>
<a href="#l1.417"></a><span id="l1.417" class="difflineminus">-  }</span>
<a href="#l1.418"></a><span id="l1.418" class="difflineminus">-</span>
<a href="#l1.419"></a><span id="l1.419" class="difflineminus">-  var AllowHTML_menuitem = document.getElementById(menuIDs[0]);</span>
<a href="#l1.420"></a><span id="l1.420" class="difflineminus">-  var Sanitized_menuitem = document.getElementById(menuIDs[1]);</span>
<a href="#l1.421"></a><span id="l1.421" class="difflineminus">-  var AsPlaintext_menuitem = document.getElementById(menuIDs[2]);</span>
<a href="#l1.422"></a><span id="l1.422" class="difflineminus">-</span>
<a href="#l1.423"></a><span id="l1.423" class="difflineminus">-  if (!prefer_plaintext &amp;&amp; !html_as &amp;&amp; !disallow_classes &amp;&amp;</span>
<a href="#l1.424"></a><span id="l1.424" class="difflineminus">-      AllowHTML_menuitem)</span>
<a href="#l1.425"></a><span id="l1.425" class="difflineminus">-    AllowHTML_menuitem.setAttribute(&quot;checked&quot;, true);</span>
<a href="#l1.426"></a><span id="l1.426" class="difflineminus">-  else if (!prefer_plaintext &amp;&amp; html_as == 3 &amp;&amp; disallow_classes &gt; 0 &amp;&amp;</span>
<a href="#l1.427"></a><span id="l1.427" class="difflineminus">-      Sanitized_menuitem)</span>
<a href="#l1.428"></a><span id="l1.428" class="difflineminus">-    Sanitized_menuitem.setAttribute(&quot;checked&quot;, true);</span>
<a href="#l1.429"></a><span id="l1.429" class="difflineminus">-  else if (prefer_plaintext &amp;&amp; html_as == 1 &amp;&amp; disallow_classes &gt; 0 &amp;&amp;</span>
<a href="#l1.430"></a><span id="l1.430" class="difflineminus">-      AsPlaintext_menuitem)</span>
<a href="#l1.431"></a><span id="l1.431" class="difflineminus">-    AsPlaintext_menuitem.setAttribute(&quot;checked&quot;, true);</span>
<a href="#l1.432"></a><span id="l1.432" class="difflineminus">-  // else (the user edited prefs/user.js) check none of the radio menu items</span>
<a href="#l1.433"></a><span id="l1.433" class="difflineminus">-</span>
<a href="#l1.434"></a><span id="l1.434" class="difflineminus">-  if (isFeed) {</span>
<a href="#l1.435"></a><span id="l1.435" class="difflineminus">-    AllowHTML_menuitem.hidden = !gShowFeedSummary;</span>
<a href="#l1.436"></a><span id="l1.436" class="difflineminus">-    Sanitized_menuitem.hidden = !gShowFeedSummary;</span>
<a href="#l1.437"></a><span id="l1.437" class="difflineminus">-    AsPlaintext_menuitem.hidden = !gShowFeedSummary;</span>
<a href="#l1.438"></a><span id="l1.438" class="difflineminus">-    document.getElementById(&quot;viewFeedSummarySeparator&quot;).hidden = !gShowFeedSummary;</span>
<a href="#l1.439"></a><span id="l1.439" class="difflineminus">-  }</span>
<a href="#l1.440"></a><span id="l1.440" class="difflineminus">-}</span>
<a href="#l1.441"></a><span id="l1.441" class="difflineminus">-</span>
<a href="#l1.442"></a><span id="l1.442" class="difflineminus">-function SetMenuItemLabel(menuItemId, customLabel)</span>
<a href="#l1.443"></a><span id="l1.443" class="difflineminus">-{</span>
<a href="#l1.444"></a><span id="l1.444" class="difflineminus">-  var menuItem = document.getElementById(menuItemId);</span>
<a href="#l1.445"></a><span id="l1.445" class="difflineminus">-  if (menuItem)</span>
<a href="#l1.446"></a><span id="l1.446" class="difflineminus">-    menuItem.setAttribute('label', customLabel);</span>
<a href="#l1.447"></a><span id="l1.447" class="difflineminus">-}</span>
<a href="#l1.448"></a><span id="l1.448" class="difflineminus">-</span>
<a href="#l1.449"></a><span id="l1.449" class="difflineminus">-function RemoveAllMessageTags()</span>
<a href="#l1.450"></a><span id="l1.450" class="difflineminus">-{</span>
<a href="#l1.451"></a><span id="l1.451" class="difflineminus">-  var selectedMessages = gFolderDisplay.selectedMessages;</span>
<a href="#l1.452"></a><span id="l1.452" class="difflineminus">-  if (!selectedMessages.length)</span>
<a href="#l1.453"></a><span id="l1.453" class="difflineminus">-    return;</span>
<a href="#l1.454"></a><span id="l1.454" class="difflineminus">-</span>
<a href="#l1.455"></a><span id="l1.455" class="difflineminus">-  var messages = Components.classes[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l1.456"></a><span id="l1.456" class="difflineminus">-                           .createInstance(Components.interfaces.nsIMutableArray);</span>
<a href="#l1.457"></a><span id="l1.457" class="difflineminus">-  var tagService = Components.classes[&quot;@mozilla.org/messenger/tagservice;1&quot;]</span>
<a href="#l1.458"></a><span id="l1.458" class="difflineminus">-                             .getService(Components.interfaces.nsIMsgTagService);</span>
<a href="#l1.459"></a><span id="l1.459" class="difflineminus">-  var tagArray = tagService.getAllTags({});</span>
<a href="#l1.460"></a><span id="l1.460" class="difflineminus">-</span>
<a href="#l1.461"></a><span id="l1.461" class="difflineminus">-  var allKeys = &quot;&quot;;</span>
<a href="#l1.462"></a><span id="l1.462" class="difflineminus">-  for (var j = 0; j &lt; tagArray.length; ++j)</span>
<a href="#l1.463"></a><span id="l1.463" class="difflineminus">-  {</span>
<a href="#l1.464"></a><span id="l1.464" class="difflineminus">-    if (j)</span>
<a href="#l1.465"></a><span id="l1.465" class="difflineminus">-      allKeys += &quot; &quot;;</span>
<a href="#l1.466"></a><span id="l1.466" class="difflineminus">-    allKeys += tagArray[j].key;</span>
<a href="#l1.467"></a><span id="l1.467" class="difflineminus">-  }</span>
<a href="#l1.468"></a><span id="l1.468" class="difflineminus">-</span>
<a href="#l1.469"></a><span id="l1.469" class="difflineminus">-  var prevHdrFolder = null;</span>
<a href="#l1.470"></a><span id="l1.470" class="difflineminus">-  // this crudely handles cross-folder virtual folders with selected messages</span>
<a href="#l1.471"></a><span id="l1.471" class="difflineminus">-  // that spans folders, by coalescing consecutive messages in the selection</span>
<a href="#l1.472"></a><span id="l1.472" class="difflineminus">-  // that happen to be in the same folder. nsMsgSearchDBView does this better,</span>
<a href="#l1.473"></a><span id="l1.473" class="difflineminus">-  // but nsIMsgDBView doesn't handle commands with arguments, and untag takes a</span>
<a href="#l1.474"></a><span id="l1.474" class="difflineminus">-  // key argument. Furthermore, we only delete legacy labels and known tags,</span>
<a href="#l1.475"></a><span id="l1.475" class="difflineminus">-  // keeping other keywords like (non)junk intact.</span>
<a href="#l1.476"></a><span id="l1.476" class="difflineminus">-</span>
<a href="#l1.477"></a><span id="l1.477" class="difflineminus">-  for (var i = 0; i &lt; selectedMessages.length; ++i)</span>
<a href="#l1.478"></a><span id="l1.478" class="difflineminus">-  {</span>
<a href="#l1.479"></a><span id="l1.479" class="difflineminus">-    var msgHdr = selectedMessages[i];</span>
<a href="#l1.480"></a><span id="l1.480" class="difflineminus">-    msgHdr.label = 0; // remove legacy label</span>
<a href="#l1.481"></a><span id="l1.481" class="difflineminus">-    if (prevHdrFolder != msgHdr.folder)</span>
<a href="#l1.482"></a><span id="l1.482" class="difflineminus">-    {</span>
<a href="#l1.483"></a><span id="l1.483" class="difflineminus">-      if (prevHdrFolder)</span>
<a href="#l1.484"></a><span id="l1.484" class="difflineminus">-        prevHdrFolder.removeKeywordsFromMessages(messages, allKeys);</span>
<a href="#l1.485"></a><span id="l1.485" class="difflineminus">-      messages.clear();</span>
<a href="#l1.486"></a><span id="l1.486" class="difflineminus">-      prevHdrFolder = msgHdr.folder;</span>
<a href="#l1.487"></a><span id="l1.487" class="difflineminus">-    }</span>
<a href="#l1.488"></a><span id="l1.488" class="difflineminus">-    messages.appendElement(msgHdr, false);</span>
<a href="#l1.489"></a><span id="l1.489" class="difflineminus">-  }</span>
<a href="#l1.490"></a><span id="l1.490" class="difflineminus">-  if (prevHdrFolder)</span>
<a href="#l1.491"></a><span id="l1.491" class="difflineminus">-    prevHdrFolder.removeKeywordsFromMessages(messages, allKeys);</span>
<a href="#l1.492"></a><span id="l1.492" class="difflineminus">-  OnTagsChange();</span>
<a href="#l1.493"></a><span id="l1.493" class="difflineminus">-}</span>
<a href="#l1.494"></a><span id="l1.494" class="difflineminus">-</span>
<a href="#l1.495"></a><span id="l1.495" class="difflineminus">-function ToggleMessageTagKey(index)</span>
<a href="#l1.496"></a><span id="l1.496" class="difflineminus">-{</span>
<a href="#l1.497"></a><span id="l1.497" class="difflineminus">-  if (GetNumSelectedMessages() &lt; 1)</span>
<a href="#l1.498"></a><span id="l1.498" class="difflineminus">-    return;</span>
<a href="#l1.499"></a><span id="l1.499" class="difflineminus">-  // set the tag state based upon that of the first selected message,</span>
<a href="#l1.500"></a><span id="l1.500" class="difflineminus">-  // just like we do for markAsRead etc.</span>
<a href="#l1.501"></a><span id="l1.501" class="difflineminus">-  var msgHdr = gFolderDisplay.selectedMessage;</span>
<a href="#l1.502"></a><span id="l1.502" class="difflineminus">-  var tagService = Components.classes[&quot;@mozilla.org/messenger/tagservice;1&quot;]</span>
<a href="#l1.503"></a><span id="l1.503" class="difflineminus">-                             .getService(Components.interfaces.nsIMsgTagService);</span>
<a href="#l1.504"></a><span id="l1.504" class="difflineminus">-  var tagArray = tagService.getAllTags({});</span>
<a href="#l1.505"></a><span id="l1.505" class="difflineminus">-  for (var i = 0; i &lt; tagArray.length; ++i)</span>
<a href="#l1.506"></a><span id="l1.506" class="difflineminus">-  {</span>
<a href="#l1.507"></a><span id="l1.507" class="difflineminus">-    var key = tagArray[i].key;</span>
<a href="#l1.508"></a><span id="l1.508" class="difflineminus">-    if (!--index)</span>
<a href="#l1.509"></a><span id="l1.509" class="difflineminus">-    {</span>
<a href="#l1.510"></a><span id="l1.510" class="difflineminus">-      // found the key, now toggle its state</span>
<a href="#l1.511"></a><span id="l1.511" class="difflineminus">-      var curKeys = msgHdr.getStringProperty(&quot;keywords&quot;);</span>
<a href="#l1.512"></a><span id="l1.512" class="difflineminus">-      if (msgHdr.label)</span>
<a href="#l1.513"></a><span id="l1.513" class="difflineminus">-        curKeys += &quot; $label&quot; + msgHdr.label;</span>
<a href="#l1.514"></a><span id="l1.514" class="difflineminus">-      var addKey  = (&quot; &quot; + curKeys + &quot; &quot;).indexOf(&quot; &quot; + key + &quot; &quot;) &lt; 0;</span>
<a href="#l1.515"></a><span id="l1.515" class="difflineminus">-      ToggleMessageTag(key, addKey);</span>
<a href="#l1.516"></a><span id="l1.516" class="difflineminus">-      return;</span>
<a href="#l1.517"></a><span id="l1.517" class="difflineminus">-    }</span>
<a href="#l1.518"></a><span id="l1.518" class="difflineminus">-  }</span>
<a href="#l1.519"></a><span id="l1.519" class="difflineminus">-}</span>
<a href="#l1.520"></a><span id="l1.520" class="difflineminus">-</span>
<a href="#l1.521"></a><span id="l1.521" class="difflineminus">-function ToggleMessageTagMenu(target)</span>
<a href="#l1.522"></a><span id="l1.522" class="difflineminus">-{</span>
<a href="#l1.523"></a><span id="l1.523" class="difflineminus">-  var key    = target.getAttribute(&quot;value&quot;);</span>
<a href="#l1.524"></a><span id="l1.524" class="difflineminus">-  var addKey = target.getAttribute(&quot;checked&quot;) == &quot;true&quot;;</span>
<a href="#l1.525"></a><span id="l1.525" class="difflineminus">-  ToggleMessageTag(key, addKey);</span>
<a href="#l1.526"></a><span id="l1.526" class="difflineminus">-}</span>
<a href="#l1.527"></a><span id="l1.527" class="difflineminus">-</span>
<a href="#l1.528"></a><span id="l1.528" class="difflineminus">-function ToggleMessageTag(key, addKey)</span>
<a href="#l1.529"></a><span id="l1.529" class="difflineminus">-{</span>
<a href="#l1.530"></a><span id="l1.530" class="difflineminus">-  var messages = Components.classes[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l1.531"></a><span id="l1.531" class="difflineminus">-                           .createInstance(Components.interfaces.nsIMutableArray);</span>
<a href="#l1.532"></a><span id="l1.532" class="difflineminus">-  var msg = Components.classes[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l1.533"></a><span id="l1.533" class="difflineminus">-                      .createInstance(Components.interfaces.nsIMutableArray);</span>
<a href="#l1.534"></a><span id="l1.534" class="difflineminus">-  var selectedMessages = gFolderDisplay.selectedMessages;</span>
<a href="#l1.535"></a><span id="l1.535" class="difflineminus">-  var toggler = addKey ? &quot;addKeywordsToMessages&quot; : &quot;removeKeywordsFromMessages&quot;;</span>
<a href="#l1.536"></a><span id="l1.536" class="difflineminus">-  var prevHdrFolder = null;</span>
<a href="#l1.537"></a><span id="l1.537" class="difflineminus">-  // this crudely handles cross-folder virtual folders with selected messages</span>
<a href="#l1.538"></a><span id="l1.538" class="difflineminus">-  // that spans folders, by coalescing consecutive msgs in the selection</span>
<a href="#l1.539"></a><span id="l1.539" class="difflineminus">-  // that happen to be in the same folder. nsMsgSearchDBView does this</span>
<a href="#l1.540"></a><span id="l1.540" class="difflineminus">-  // better, but nsIMsgDBView doesn't handle commands with arguments,</span>
<a href="#l1.541"></a><span id="l1.541" class="difflineminus">-  // and (un)tag takes a key argument.</span>
<a href="#l1.542"></a><span id="l1.542" class="difflineminus">-  for (var i = 0; i &lt; selectedMessages.length; ++i)</span>
<a href="#l1.543"></a><span id="l1.543" class="difflineminus">-  {</span>
<a href="#l1.544"></a><span id="l1.544" class="difflineminus">-    var msgHdr = selectedMessages[i];</span>
<a href="#l1.545"></a><span id="l1.545" class="difflineminus">-    if (msgHdr.label)</span>
<a href="#l1.546"></a><span id="l1.546" class="difflineminus">-    {</span>
<a href="#l1.547"></a><span id="l1.547" class="difflineminus">-      // Since we touch all these messages anyway, migrate the label now.</span>
<a href="#l1.548"></a><span id="l1.548" class="difflineminus">-      // If we don't, the thread tree won't always show the correct tag state,</span>
<a href="#l1.549"></a><span id="l1.549" class="difflineminus">-      // because resetting a label doesn't update the tree anymore...</span>
<a href="#l1.550"></a><span id="l1.550" class="difflineminus">-      msg.clear();</span>
<a href="#l1.551"></a><span id="l1.551" class="difflineminus">-      msg.appendElement(msgHdr, false);</span>
<a href="#l1.552"></a><span id="l1.552" class="difflineminus">-      msgHdr.folder.addKeywordsToMessages(msg, &quot;$label&quot; + msgHdr.label);</span>
<a href="#l1.553"></a><span id="l1.553" class="difflineminus">-      msgHdr.label = 0; // remove legacy label</span>
<a href="#l1.554"></a><span id="l1.554" class="difflineminus">-    }</span>
<a href="#l1.555"></a><span id="l1.555" class="difflineminus">-    if (prevHdrFolder != msgHdr.folder)</span>
<a href="#l1.556"></a><span id="l1.556" class="difflineminus">-    {</span>
<a href="#l1.557"></a><span id="l1.557" class="difflineminus">-      if (prevHdrFolder)</span>
<a href="#l1.558"></a><span id="l1.558" class="difflineminus">-        prevHdrFolder[toggler](messages, key);</span>
<a href="#l1.559"></a><span id="l1.559" class="difflineminus">-      messages.clear();</span>
<a href="#l1.560"></a><span id="l1.560" class="difflineminus">-      prevHdrFolder = msgHdr.folder;</span>
<a href="#l1.561"></a><span id="l1.561" class="difflineminus">-    }</span>
<a href="#l1.562"></a><span id="l1.562" class="difflineminus">-    messages.appendElement(msgHdr, false);</span>
<a href="#l1.563"></a><span id="l1.563" class="difflineminus">-  }</span>
<a href="#l1.564"></a><span id="l1.564" class="difflineminus">-  if (prevHdrFolder)</span>
<a href="#l1.565"></a><span id="l1.565" class="difflineminus">-    prevHdrFolder[toggler](messages, key);</span>
<a href="#l1.566"></a><span id="l1.566" class="difflineminus">-  OnTagsChange();</span>
<a href="#l1.567"></a><span id="l1.567" class="difflineminus">-}</span>
<a href="#l1.568"></a><span id="l1.568" class="difflineminus">-</span>
<a href="#l1.569"></a><span id="l1.569" class="difflineminus">-function AddTag()</span>
<a href="#l1.570"></a><span id="l1.570" class="difflineminus">-{</span>
<a href="#l1.571"></a><span id="l1.571" class="difflineminus">-  var args = {result: &quot;&quot;, okCallback: AddTagCallback};</span>
<a href="#l1.572"></a><span id="l1.572" class="difflineminus">-  var dialog = window.openDialog(&quot;chrome://messenger/content/newTagDialog.xul&quot;,</span>
<a href="#l1.573"></a><span id="l1.573" class="difflineminus">-                                 &quot;&quot;,</span>
<a href="#l1.574"></a><span id="l1.574" class="difflineminus">-                                 &quot;chrome,titlebar,modal&quot;,</span>
<a href="#l1.575"></a><span id="l1.575" class="difflineminus">-                                 args);</span>
<a href="#l1.576"></a><span id="l1.576" class="difflineminus">-}</span>
<a href="#l1.577"></a><span id="l1.577" class="difflineminus">-</span>
<a href="#l1.578"></a><span id="l1.578" class="difflineminus">-function AddTagCallback(name, color)</span>
<a href="#l1.579"></a><span id="l1.579" class="difflineminus">-{</span>
<a href="#l1.580"></a><span id="l1.580" class="difflineminus">-  var tagService = Components.classes[&quot;@mozilla.org/messenger/tagservice;1&quot;]</span>
<a href="#l1.581"></a><span id="l1.581" class="difflineminus">-                             .getService(Components.interfaces.nsIMsgTagService);</span>
<a href="#l1.582"></a><span id="l1.582" class="difflineminus">-  tagService.addTag(name, color, '');</span>
<a href="#l1.583"></a><span id="l1.583" class="difflineminus">-  try</span>
<a href="#l1.584"></a><span id="l1.584" class="difflineminus">-  {</span>
<a href="#l1.585"></a><span id="l1.585" class="difflineminus">-    ToggleMessageTag(tagService.getKeyForTag(name), true);</span>
<a href="#l1.586"></a><span id="l1.586" class="difflineminus">-  }</span>
<a href="#l1.587"></a><span id="l1.587" class="difflineminus">-  catch(ex)</span>
<a href="#l1.588"></a><span id="l1.588" class="difflineminus">-  {</span>
<a href="#l1.589"></a><span id="l1.589" class="difflineminus">-    return false;</span>
<a href="#l1.590"></a><span id="l1.590" class="difflineminus">-  }</span>
<a href="#l1.591"></a><span id="l1.591" class="difflineminus">-  return true;</span>
<a href="#l1.592"></a><span id="l1.592" class="difflineminus">-}</span>
<a href="#l1.593"></a><span id="l1.593" class="difflineminus">-</span>
<a href="#l1.594"></a><span id="l1.594" class="difflineminus">-function SetMessageTagLabel(menuitem, index, name)</span>
<a href="#l1.595"></a><span id="l1.595" class="difflineminus">-{</span>
<a href="#l1.596"></a><span id="l1.596" class="difflineminus">-  // if a &lt;key&gt; is defined for this tag, use its key as the accesskey</span>
<a href="#l1.597"></a><span id="l1.597" class="difflineminus">-  // (the key for the tag at index n needs to have the id key_tag&lt;n&gt;)</span>
<a href="#l1.598"></a><span id="l1.598" class="difflineminus">-  var shortcutkey = document.getElementById(&quot;key_tag&quot; + index);</span>
<a href="#l1.599"></a><span id="l1.599" class="difflineminus">-  var accesskey = shortcutkey ? shortcutkey.getAttribute(&quot;key&quot;) : &quot;&quot;;</span>
<a href="#l1.600"></a><span id="l1.600" class="difflineminus">-  if (accesskey)</span>
<a href="#l1.601"></a><span id="l1.601" class="difflineminus">-    menuitem.setAttribute(&quot;accesskey&quot;, accesskey);</span>
<a href="#l1.602"></a><span id="l1.602" class="difflineminus">-  var label = gMessengerBundle.getFormattedString(&quot;mailnews.tags.format&quot;,</span>
<a href="#l1.603"></a><span id="l1.603" class="difflineminus">-                                                  [accesskey, name]);</span>
<a href="#l1.604"></a><span id="l1.604" class="difflineminus">-  menuitem.setAttribute(&quot;label&quot;, label);</span>
<a href="#l1.605"></a><span id="l1.605" class="difflineminus">-}</span>
<a href="#l1.606"></a><span id="l1.606" class="difflineminus">-</span>
<a href="#l1.607"></a><span id="l1.607" class="difflineminus">-function InitMessageTags(menuPopup)</span>
<a href="#l1.608"></a><span id="l1.608" class="difflineminus">-{</span>
<a href="#l1.609"></a><span id="l1.609" class="difflineminus">-  var tagService = Components.classes[&quot;@mozilla.org/messenger/tagservice;1&quot;]</span>
<a href="#l1.610"></a><span id="l1.610" class="difflineminus">-                             .getService(Components.interfaces.nsIMsgTagService);</span>
<a href="#l1.611"></a><span id="l1.611" class="difflineminus">-  var tagArray = tagService.getAllTags({});</span>
<a href="#l1.612"></a><span id="l1.612" class="difflineminus">-  var tagCount = tagArray.length;</span>
<a href="#l1.613"></a><span id="l1.613" class="difflineminus">-</span>
<a href="#l1.614"></a><span id="l1.614" class="difflineminus">-  // remove any existing non-static entries...</span>
<a href="#l1.615"></a><span id="l1.615" class="difflineminus">-  var menuseparator = menuPopup.lastChild.previousSibling;</span>
<a href="#l1.616"></a><span id="l1.616" class="difflineminus">-  for (var i = menuPopup.childNodes.length; i &gt; 4; --i)</span>
<a href="#l1.617"></a><span id="l1.617" class="difflineminus">-    menuPopup.removeChild(menuseparator.previousSibling);</span>
<a href="#l1.618"></a><span id="l1.618" class="difflineminus">-</span>
<a href="#l1.619"></a><span id="l1.619" class="difflineminus">-  // hide double menuseparator</span>
<a href="#l1.620"></a><span id="l1.620" class="difflineminus">-  menuseparator.previousSibling.hidden = !tagCount;</span>
<a href="#l1.621"></a><span id="l1.621" class="difflineminus">-</span>
<a href="#l1.622"></a><span id="l1.622" class="difflineminus">-  // create label and accesskey for the static remove item</span>
<a href="#l1.623"></a><span id="l1.623" class="difflineminus">-  var tagRemoveLabel = gMessengerBundle.getString(&quot;mailnews.tags.remove&quot;);</span>
<a href="#l1.624"></a><span id="l1.624" class="difflineminus">-  SetMessageTagLabel(menuPopup.firstChild, 0, tagRemoveLabel);</span>
<a href="#l1.625"></a><span id="l1.625" class="difflineminus">-</span>
<a href="#l1.626"></a><span id="l1.626" class="difflineminus">-  // now rebuild the list</span>
<a href="#l1.627"></a><span id="l1.627" class="difflineminus">-  var msgHdr = gFolderDisplay.selectedMessage;</span>
<a href="#l1.628"></a><span id="l1.628" class="difflineminus">-  var curKeys = msgHdr.getStringProperty(&quot;keywords&quot;);</span>
<a href="#l1.629"></a><span id="l1.629" class="difflineminus">-  if (msgHdr.label)</span>
<a href="#l1.630"></a><span id="l1.630" class="difflineminus">-    curKeys += &quot; $label&quot; + msgHdr.label;</span>
<a href="#l1.631"></a><span id="l1.631" class="difflineminus">-</span>
<a href="#l1.632"></a><span id="l1.632" class="difflineminus">-  for (var i = 0; i &lt; tagCount; ++i)</span>
<a href="#l1.633"></a><span id="l1.633" class="difflineminus">-  {</span>
<a href="#l1.634"></a><span id="l1.634" class="difflineminus">-    var taginfo = tagArray[i];</span>
<a href="#l1.635"></a><span id="l1.635" class="difflineminus">-    // TODO we want to either remove or &quot;check&quot; the tags that already exist</span>
<a href="#l1.636"></a><span id="l1.636" class="difflineminus">-    var newMenuItem = document.createElement(&quot;menuitem&quot;);</span>
<a href="#l1.637"></a><span id="l1.637" class="difflineminus">-    SetMessageTagLabel(newMenuItem, i + 1, taginfo.tag);</span>
<a href="#l1.638"></a><span id="l1.638" class="difflineminus">-    newMenuItem.setAttribute(&quot;value&quot;, taginfo.key);</span>
<a href="#l1.639"></a><span id="l1.639" class="difflineminus">-    newMenuItem.setAttribute(&quot;type&quot;, &quot;checkbox&quot;);</span>
<a href="#l1.640"></a><span id="l1.640" class="difflineminus">-    var removeKey = (&quot; &quot; + curKeys + &quot; &quot;).indexOf(&quot; &quot; + taginfo.key + &quot; &quot;) &gt; -1;</span>
<a href="#l1.641"></a><span id="l1.641" class="difflineminus">-    newMenuItem.setAttribute('checked', removeKey);</span>
<a href="#l1.642"></a><span id="l1.642" class="difflineminus">-    newMenuItem.setAttribute('oncommand', 'ToggleMessageTagMenu(event.target);');</span>
<a href="#l1.643"></a><span id="l1.643" class="difflineminus">-    var color = taginfo.color;</span>
<a href="#l1.644"></a><span id="l1.644" class="difflineminus">-    if (color)</span>
<a href="#l1.645"></a><span id="l1.645" class="difflineminus">-      newMenuItem.setAttribute(&quot;class&quot;, &quot;lc-&quot; + color.substr(1));</span>
<a href="#l1.646"></a><span id="l1.646" class="difflineminus">-    menuPopup.insertBefore(newMenuItem, menuseparator);</span>
<a href="#l1.647"></a><span id="l1.647" class="difflineminus">-  }</span>
<a href="#l1.648"></a><span id="l1.648" class="difflineminus">-}</span>
<a href="#l1.649"></a><span id="l1.649" class="difflineminus">-</span>
<a href="#l1.650"></a><span id="l1.650" class="difflineminus">-function backToolbarMenu_init(menuPopup)</span>
<a href="#l1.651"></a><span id="l1.651" class="difflineminus">-{</span>
<a href="#l1.652"></a><span id="l1.652" class="difflineminus">-  populateHistoryMenu(menuPopup, true);</span>
<a href="#l1.653"></a><span id="l1.653" class="difflineminus">-}</span>
<a href="#l1.654"></a><span id="l1.654" class="difflineminus">-</span>
<a href="#l1.655"></a><span id="l1.655" class="difflineminus">-function getMsgToolbarMenu_init()</span>
<a href="#l1.656"></a><span id="l1.656" class="difflineminus">-{</span>
<a href="#l1.657"></a><span id="l1.657" class="difflineminus">-  document.commandDispatcher.updateCommands('create-menu-getMsgToolbar');</span>
<a href="#l1.658"></a><span id="l1.658" class="difflineminus">-}</span>
<a href="#l1.659"></a><span id="l1.659" class="difflineminus">-</span>
<a href="#l1.660"></a><span id="l1.660" class="difflineminus">-var gNavDebug = false;</span>
<a href="#l1.661"></a><span id="l1.661" class="difflineminus">-function navDebug(str)</span>
<a href="#l1.662"></a><span id="l1.662" class="difflineminus">-{</span>
<a href="#l1.663"></a><span id="l1.663" class="difflineminus">-  if (gNavDebug)</span>
<a href="#l1.664"></a><span id="l1.664" class="difflineminus">-    dump(str);</span>
<a href="#l1.665"></a><span id="l1.665" class="difflineminus">-}</span>
<a href="#l1.666"></a><span id="l1.666" class="difflineminus">-</span>
<a href="#l1.667"></a><span id="l1.667" class="difflineminus">-function populateHistoryMenu(menuPopup, isBackMenu)</span>
<a href="#l1.668"></a><span id="l1.668" class="difflineminus">-{</span>
<a href="#l1.669"></a><span id="l1.669" class="difflineminus">-  // remove existing entries</span>
<a href="#l1.670"></a><span id="l1.670" class="difflineminus">-  while (menuPopup.firstChild)</span>
<a href="#l1.671"></a><span id="l1.671" class="difflineminus">-    menuPopup.removeChild(menuPopup.firstChild);</span>
<a href="#l1.672"></a><span id="l1.672" class="difflineminus">-  var curPos = new Object;</span>
<a href="#l1.673"></a><span id="l1.673" class="difflineminus">-  var numEntries = new Object;</span>
<a href="#l1.674"></a><span id="l1.674" class="difflineminus">-  var historyEntries = new Object;</span>
<a href="#l1.675"></a><span id="l1.675" class="difflineminus">-  messenger.getNavigateHistory(curPos, numEntries, historyEntries);</span>
<a href="#l1.676"></a><span id="l1.676" class="difflineminus">-  curPos.value = curPos.value * 2;</span>
<a href="#l1.677"></a><span id="l1.677" class="difflineminus">-  navDebug(&quot;curPos = &quot; + curPos.value + &quot; numEntries = &quot; + numEntries.value + &quot;\n&quot;);</span>
<a href="#l1.678"></a><span id="l1.678" class="difflineminus">-  var historyArray = historyEntries.value;</span>
<a href="#l1.679"></a><span id="l1.679" class="difflineminus">-  var folder;</span>
<a href="#l1.680"></a><span id="l1.680" class="difflineminus">-  var newMenuItem;</span>
<a href="#l1.681"></a><span id="l1.681" class="difflineminus">-  if (gFolderDisplay.selectedMessage)</span>
<a href="#l1.682"></a><span id="l1.682" class="difflineminus">-  {</span>
<a href="#l1.683"></a><span id="l1.683" class="difflineminus">-    if (!isBackMenu)</span>
<a href="#l1.684"></a><span id="l1.684" class="difflineminus">-      curPos.value += 2;</span>
<a href="#l1.685"></a><span id="l1.685" class="difflineminus">-    else</span>
<a href="#l1.686"></a><span id="l1.686" class="difflineminus">-      curPos.value -= 2;</span>
<a href="#l1.687"></a><span id="l1.687" class="difflineminus">-  }</span>
<a href="#l1.688"></a><span id="l1.688" class="difflineminus">-  // For populating the back menu, we want the most recently visited</span>
<a href="#l1.689"></a><span id="l1.689" class="difflineminus">-  // messages first in the menu. So we go backward from curPos to 0.</span>
<a href="#l1.690"></a><span id="l1.690" class="difflineminus">-  // For the forward menu, we want to go forward from curPos to the end.</span>
<a href="#l1.691"></a><span id="l1.691" class="difflineminus">-  var relPos = 0;</span>
<a href="#l1.692"></a><span id="l1.692" class="difflineminus">-  for (var i = curPos.value; (isBackMenu) ? i &gt;= 0 : i &lt; historyArray.length; i += ((isBackMenu) ? -2 : 2))</span>
<a href="#l1.693"></a><span id="l1.693" class="difflineminus">-  {</span>
<a href="#l1.694"></a><span id="l1.694" class="difflineminus">-    navDebug(&quot;history[&quot; + i + &quot;] = &quot; + historyArray[i] + &quot;\n&quot;);</span>
<a href="#l1.695"></a><span id="l1.695" class="difflineminus">-    navDebug(&quot;history[&quot; + i + &quot;] = &quot; + historyArray[i + 1] + &quot;\n&quot;);</span>
<a href="#l1.696"></a><span id="l1.696" class="difflineminus">-    folder = GetMsgFolderFromUri(historyArray[i + 1]);</span>
<a href="#l1.697"></a><span id="l1.697" class="difflineminus">-    navDebug(&quot;folder URI = &quot; + folder.URI + &quot;pretty name &quot; + folder.prettyName + &quot;\n&quot;);</span>
<a href="#l1.698"></a><span id="l1.698" class="difflineminus">-    var menuText = &quot;&quot;;</span>
<a href="#l1.699"></a><span id="l1.699" class="difflineminus">-</span>
<a href="#l1.700"></a><span id="l1.700" class="difflineminus">-    // If the message was not being displayed via the current folder, prepend</span>
<a href="#l1.701"></a><span id="l1.701" class="difflineminus">-    //  the folder name.  We do not need to check underlying folders for</span>
<a href="#l1.702"></a><span id="l1.702" class="difflineminus">-    //  virtual folders because 'folder' is the display folder, not the</span>
<a href="#l1.703"></a><span id="l1.703" class="difflineminus">-    //  underlying one.</span>
<a href="#l1.704"></a><span id="l1.704" class="difflineminus">-    if (folder != gFolderDisplay.displayedFolder)</span>
<a href="#l1.705"></a><span id="l1.705" class="difflineminus">-      menuText = folder.prettyName + &quot; - &quot;;</span>
<a href="#l1.706"></a><span id="l1.706" class="difflineminus">-</span>
<a href="#l1.707"></a><span id="l1.707" class="difflineminus">-    var msgHdr = messenger.msgHdrFromURI(historyArray[i]);</span>
<a href="#l1.708"></a><span id="l1.708" class="difflineminus">-</span>
<a href="#l1.709"></a><span id="l1.709" class="difflineminus">-    var subject = &quot;&quot;;</span>
<a href="#l1.710"></a><span id="l1.710" class="difflineminus">-    if (msgHdr.flags &amp; Components.interfaces.nsMsgMessageFlags.HasRe)</span>
<a href="#l1.711"></a><span id="l1.711" class="difflineminus">-      subject = &quot;Re: &quot;;</span>
<a href="#l1.712"></a><span id="l1.712" class="difflineminus">-    if (msgHdr.mime2DecodedSubject)</span>
<a href="#l1.713"></a><span id="l1.713" class="difflineminus">-      subject += msgHdr.mime2DecodedSubject;</span>
<a href="#l1.714"></a><span id="l1.714" class="difflineminus">-    if (subject)</span>
<a href="#l1.715"></a><span id="l1.715" class="difflineminus">-      menuText += subject + &quot; - &quot;;</span>
<a href="#l1.716"></a><span id="l1.716" class="difflineminus">-</span>
<a href="#l1.717"></a><span id="l1.717" class="difflineminus">-    menuText += msgHdr.mime2DecodedAuthor;</span>
<a href="#l1.718"></a><span id="l1.718" class="difflineminus">-    newMenuItem = document.createElement('menuitem');</span>
<a href="#l1.719"></a><span id="l1.719" class="difflineminus">-    newMenuItem.setAttribute('label', menuText);</span>
<a href="#l1.720"></a><span id="l1.720" class="difflineminus">-    relPos += isBackMenu ? -1 : 1;</span>
<a href="#l1.721"></a><span id="l1.721" class="difflineminus">-    newMenuItem.setAttribute('value',  relPos);</span>
<a href="#l1.722"></a><span id="l1.722" class="difflineminus">-    newMenuItem.folder = folder;</span>
<a href="#l1.723"></a><span id="l1.723" class="difflineminus">-    newMenuItem.setAttribute('oncommand', 'NavigateToUri(event.target); event.stopPropagation();');</span>
<a href="#l1.724"></a><span id="l1.724" class="difflineminus">-    menuPopup.appendChild(newMenuItem);</span>
<a href="#l1.725"></a><span id="l1.725" class="difflineminus">-    if (! (relPos % 20))</span>
<a href="#l1.726"></a><span id="l1.726" class="difflineminus">-      break;</span>
<a href="#l1.727"></a><span id="l1.727" class="difflineminus">-  }</span>
<a href="#l1.728"></a><span id="l1.728" class="difflineminus">-}</span>
<a href="#l1.729"></a><span id="l1.729" class="difflineminus">-</span>
<a href="#l1.730"></a><span id="l1.730" class="difflineminus">-/**</span>
<a href="#l1.731"></a><span id="l1.731" class="difflineminus">- * This is triggered by the history navigation menu options, as created by</span>
<a href="#l1.732"></a><span id="l1.732" class="difflineminus">- *  populateHistoryMenu above.</span>
<a href="#l1.733"></a><span id="l1.733" class="difflineminus">- */</span>
<a href="#l1.734"></a><span id="l1.734" class="difflineminus">-function NavigateToUri(target)</span>
<a href="#l1.735"></a><span id="l1.735" class="difflineminus">-{</span>
<a href="#l1.736"></a><span id="l1.736" class="difflineminus">-  var historyIndex = target.getAttribute('value');</span>
<a href="#l1.737"></a><span id="l1.737" class="difflineminus">-  var msgUri = messenger.getMsgUriAtNavigatePos(historyIndex);</span>
<a href="#l1.738"></a><span id="l1.738" class="difflineminus">-  var folder = target.folder;</span>
<a href="#l1.739"></a><span id="l1.739" class="difflineminus">-  var msgHdr = messenger.msgHdrFromURI(msgUri);</span>
<a href="#l1.740"></a><span id="l1.740" class="difflineminus">-  navDebug(&quot;navigating from &quot; + messenger.navigatePos + &quot; by &quot; + historyIndex + &quot; to &quot; + msgUri + &quot;\n&quot;);</span>
<a href="#l1.741"></a><span id="l1.741" class="difflineminus">-</span>
<a href="#l1.742"></a><span id="l1.742" class="difflineminus">-  // this &quot;- 0&quot; seems to ensure that historyIndex is treated as an int, not a string.</span>
<a href="#l1.743"></a><span id="l1.743" class="difflineminus">-  messenger.navigatePos += (historyIndex - 0);</span>
<a href="#l1.744"></a><span id="l1.744" class="difflineminus">-</span>
<a href="#l1.745"></a><span id="l1.745" class="difflineminus">-  if (gFolderDisplay.displayedFolder != folder) {</span>
<a href="#l1.746"></a><span id="l1.746" class="difflineminus">-    if (gFolderTreeView)</span>
<a href="#l1.747"></a><span id="l1.747" class="difflineminus">-      gFolderTreeView.selectFolder(folder);</span>
<a href="#l1.748"></a><span id="l1.748" class="difflineminus">-    else</span>
<a href="#l1.749"></a><span id="l1.749" class="difflineminus">-      gFolderDisplay.show(folder);</span>
<a href="#l1.750"></a><span id="l1.750" class="difflineminus">-  }</span>
<a href="#l1.751"></a><span id="l1.751" class="difflineminus">-  gFolderDisplay.selectMessage(msgHdr);</span>
<a href="#l1.752"></a><span id="l1.752" class="difflineminus">-}</span>
<a href="#l1.753"></a><span id="l1.753" class="difflineminus">-</span>
<a href="#l1.754"></a><span id="l1.754" class="difflineminus">-function forwardToolbarMenu_init(menuPopup)</span>
<a href="#l1.755"></a><span id="l1.755" class="difflineminus">-{</span>
<a href="#l1.756"></a><span id="l1.756" class="difflineminus">-  populateHistoryMenu(menuPopup, false);</span>
<a href="#l1.757"></a><span id="l1.757" class="difflineminus">-}</span>
<a href="#l1.758"></a><span id="l1.758" class="difflineminus">-</span>
<a href="#l1.759"></a><span id="l1.759" class="difflineminus">-function InitMessageMark()</span>
<a href="#l1.760"></a><span id="l1.760" class="difflineminus">-{</span>
<a href="#l1.761"></a><span id="l1.761" class="difflineminus">-  document.getElementById(&quot;cmd_markAsRead&quot;)</span>
<a href="#l1.762"></a><span id="l1.762" class="difflineminus">-          .setAttribute(&quot;checked&quot;, SelectedMessagesAreRead());</span>
<a href="#l1.763"></a><span id="l1.763" class="difflineminus">-</span>
<a href="#l1.764"></a><span id="l1.764" class="difflineminus">-  document.getElementById(&quot;cmd_markAsFlagged&quot;)</span>
<a href="#l1.765"></a><span id="l1.765" class="difflineminus">-          .setAttribute(&quot;checked&quot;, SelectedMessagesAreFlagged());</span>
<a href="#l1.766"></a><span id="l1.766" class="difflineminus">-</span>
<a href="#l1.767"></a><span id="l1.767" class="difflineminus">-  document.commandDispatcher.updateCommands('create-menu-mark');</span>
<a href="#l1.768"></a><span id="l1.768" class="difflineminus">-}</span>
<a href="#l1.769"></a><span id="l1.769" class="difflineminus">-</span>
<a href="#l1.770"></a><span id="l1.770" class="difflineminus">-function UpdateJunkToolbarButton()</span>
<a href="#l1.771"></a><span id="l1.771" class="difflineminus">-{</span>
<a href="#l1.772"></a><span id="l1.772" class="difflineminus">-  var junkButtonDeck = document.getElementById(&quot;junk-deck&quot;);</span>
<a href="#l1.773"></a><span id="l1.773" class="difflineminus">-  if (junkButtonDeck)</span>
<a href="#l1.774"></a><span id="l1.774" class="difflineminus">-    junkButtonDeck.selectedIndex = SelectedMessagesAreJunk() ? 1 : 0;</span>
<a href="#l1.775"></a><span id="l1.775" class="difflineminus">-}</span>
<a href="#l1.776"></a><span id="l1.776" class="difflineminus">-</span>
<a href="#l1.777"></a><span id="l1.777" class="difflineminus">-/**</span>
<a href="#l1.778"></a><span id="l1.778" class="difflineminus">- * Should the reply command/button be enabled?</span>
<a href="#l1.779"></a><span id="l1.779" class="difflineminus">- *</span>
<a href="#l1.780"></a><span id="l1.780" class="difflineminus">- * @return whether the reply command/button should be enabled.</span>
<a href="#l1.781"></a><span id="l1.781" class="difflineminus">- */</span>
<a href="#l1.782"></a><span id="l1.782" class="difflineminus">-function IsReplyEnabled()</span>
<a href="#l1.783"></a><span id="l1.783" class="difflineminus">-{</span>
<a href="#l1.784"></a><span id="l1.784" class="difflineminus">-  // If we're in an rss item, we never want to Reply, because there's</span>
<a href="#l1.785"></a><span id="l1.785" class="difflineminus">-  // usually no-one useful to reply to.</span>
<a href="#l1.786"></a><span id="l1.786" class="difflineminus">-  return !gFolderDisplay.selectedMessageIsFeed;</span>
<a href="#l1.787"></a><span id="l1.787" class="difflineminus">-}</span>
<a href="#l1.788"></a><span id="l1.788" class="difflineminus">-</span>
<a href="#l1.789"></a><span id="l1.789" class="difflineminus">-/**</span>
<a href="#l1.790"></a><span id="l1.790" class="difflineminus">- * Should the reply-all command/button be enabled?</span>
<a href="#l1.791"></a><span id="l1.791" class="difflineminus">- *</span>
<a href="#l1.792"></a><span id="l1.792" class="difflineminus">- * @return whether the reply-all command/button should be enabled.</span>
<a href="#l1.793"></a><span id="l1.793" class="difflineminus">- */</span>
<a href="#l1.794"></a><span id="l1.794" class="difflineminus">-function IsReplyAllEnabled()</span>
<a href="#l1.795"></a><span id="l1.795" class="difflineminus">-{</span>
<a href="#l1.796"></a><span id="l1.796" class="difflineminus">-  if (gFolderDisplay.selectedMessageIsNews)</span>
<a href="#l1.797"></a><span id="l1.797" class="difflineminus">-    // If we're in a news item, we always want ReplyAll, because we can</span>
<a href="#l1.798"></a><span id="l1.798" class="difflineminus">-    // reply to the sender and the newsgroup.</span>
<a href="#l1.799"></a><span id="l1.799" class="difflineminus">-    return true;</span>
<a href="#l1.800"></a><span id="l1.800" class="difflineminus">-  if (gFolderDisplay.selectedMessageIsFeed)</span>
<a href="#l1.801"></a><span id="l1.801" class="difflineminus">-    // If we're in an rss item, we never want to ReplyAll, because there's</span>
<a href="#l1.802"></a><span id="l1.802" class="difflineminus">-    // usually no-one useful to reply to.</span>
<a href="#l1.803"></a><span id="l1.803" class="difflineminus">-    return false;</span>
<a href="#l1.804"></a><span id="l1.804" class="difflineminus">-</span>
<a href="#l1.805"></a><span id="l1.805" class="difflineminus">-  let msgHdr = gFolderDisplay.selectedMessage;</span>
<a href="#l1.806"></a><span id="l1.806" class="difflineminus">-</span>
<a href="#l1.807"></a><span id="l1.807" class="difflineminus">-  let myEmail = getIdentityForHeader(msgHdr).email;</span>
<a href="#l1.808"></a><span id="l1.808" class="difflineminus">-  let addresses = msgHdr.author + &quot;,&quot; + msgHdr.recipients + &quot;,&quot; + msgHdr.ccList;</span>
<a href="#l1.809"></a><span id="l1.809" class="difflineminus">-</span>
<a href="#l1.810"></a><span id="l1.810" class="difflineminus">-  // If we've got any BCCed addresses (because we sent the message), add</span>
<a href="#l1.811"></a><span id="l1.811" class="difflineminus">-  // them as well.</span>
<a href="#l1.812"></a><span id="l1.812" class="difflineminus">-  if (&quot;bcc&quot; in currentHeaderData)</span>
<a href="#l1.813"></a><span id="l1.813" class="difflineminus">-    addresses += currentHeaderData.bcc.headerValue;</span>
<a href="#l1.814"></a><span id="l1.814" class="difflineminus">-</span>
<a href="#l1.815"></a><span id="l1.815" class="difflineminus">-  // Check to see if my email address is in the list of addresses.</span>
<a href="#l1.816"></a><span id="l1.816" class="difflineminus">-  let imInAddresses = addresses.indexOf(myEmail) != -1;</span>
<a href="#l1.817"></a><span id="l1.817" class="difflineminus">-</span>
<a href="#l1.818"></a><span id="l1.818" class="difflineminus">-  // Now, let's get the number of unique addresses.</span>
<a href="#l1.819"></a><span id="l1.819" class="difflineminus">-  let hdrParser = Components.classes[&quot;@mozilla.org/messenger/headerparser;1&quot;]</span>
<a href="#l1.820"></a><span id="l1.820" class="difflineminus">-                            .getService(Components.interfaces.nsIMsgHeaderParser);</span>
<a href="#l1.821"></a><span id="l1.821" class="difflineminus">-  let uniqueAddresses = hdrParser.removeDuplicateAddresses(addresses, &quot;&quot;);</span>
<a href="#l1.822"></a><span id="l1.822" class="difflineminus">-  let emailAddresses = {};</span>
<a href="#l1.823"></a><span id="l1.823" class="difflineminus">-  let numAddresses = hdrParser.parseHeadersWithArray(uniqueAddresses,</span>
<a href="#l1.824"></a><span id="l1.824" class="difflineminus">-                                                     emailAddresses, {}, {});</span>
<a href="#l1.825"></a><span id="l1.825" class="difflineminus">-</span>
<a href="#l1.826"></a><span id="l1.826" class="difflineminus">-  // XXX: This should be handled by the nsIMsgHeaderParser.  See Bug 498480.</span>
<a href="#l1.827"></a><span id="l1.827" class="difflineminus">-  // Remove addresses that look like email groups, because we don't support</span>
<a href="#l1.828"></a><span id="l1.828" class="difflineminus">-  // those yet.  (Any address with a : in it will be an empty email group,</span>
<a href="#l1.829"></a><span id="l1.829" class="difflineminus">-  // or the colon and the groupname would be set as the first name, and not</span>
<a href="#l1.830"></a><span id="l1.830" class="difflineminus">-  // show up in the address at all.)</span>
<a href="#l1.831"></a><span id="l1.831" class="difflineminus">-  for (var i in emailAddresses.value)</span>
<a href="#l1.832"></a><span id="l1.832" class="difflineminus">-  {</span>
<a href="#l1.833"></a><span id="l1.833" class="difflineminus">-    if (/:/.test(emailAddresses.value[i]))</span>
<a href="#l1.834"></a><span id="l1.834" class="difflineminus">-      numAddresses--;</span>
<a href="#l1.835"></a><span id="l1.835" class="difflineminus">-  }</span>
<a href="#l1.836"></a><span id="l1.836" class="difflineminus">-</span>
<a href="#l1.837"></a><span id="l1.837" class="difflineminus">-  // I don't want to count my address in the number of addresses to reply</span>
<a href="#l1.838"></a><span id="l1.838" class="difflineminus">-  // to, since I won't be emailing myself.</span>
<a href="#l1.839"></a><span id="l1.839" class="difflineminus">-  if (imInAddresses)</span>
<a href="#l1.840"></a><span id="l1.840" class="difflineminus">-    numAddresses--;</span>
<a href="#l1.841"></a><span id="l1.841" class="difflineminus">-</span>
<a href="#l1.842"></a><span id="l1.842" class="difflineminus">-  // ReplyAll is enabled if there is more than 1 person to reply to.</span>
<a href="#l1.843"></a><span id="l1.843" class="difflineminus">-  return numAddresses &gt; 1;</span>
<a href="#l1.844"></a><span id="l1.844" class="difflineminus">-}</span>
<a href="#l1.845"></a><span id="l1.845" class="difflineminus">-</span>
<a href="#l1.846"></a><span id="l1.846" class="difflineminus">-/**</span>
<a href="#l1.847"></a><span id="l1.847" class="difflineminus">- * Should the reply-list command/button be enabled?</span>
<a href="#l1.848"></a><span id="l1.848" class="difflineminus">- *</span>
<a href="#l1.849"></a><span id="l1.849" class="difflineminus">- * @return whether the reply-list command/button should be enabled.</span>
<a href="#l1.850"></a><span id="l1.850" class="difflineminus">- */</span>
<a href="#l1.851"></a><span id="l1.851" class="difflineminus">-function IsReplyListEnabled()</span>
<a href="#l1.852"></a><span id="l1.852" class="difflineminus">-{</span>
<a href="#l1.853"></a><span id="l1.853" class="difflineminus">-  // ReplyToList is enabled if there is a List-Post header</span>
<a href="#l1.854"></a><span id="l1.854" class="difflineminus">-  // with the correct format.</span>
<a href="#l1.855"></a><span id="l1.855" class="difflineminus">-  let listPost = currentHeaderData[&quot;list-post&quot;];</span>
<a href="#l1.856"></a><span id="l1.856" class="difflineminus">-  if (!listPost)</span>
<a href="#l1.857"></a><span id="l1.857" class="difflineminus">-    return false;</span>
<a href="#l1.858"></a><span id="l1.858" class="difflineminus">-</span>
<a href="#l1.859"></a><span id="l1.859" class="difflineminus">-  // XXX: Once Bug 496914 provides a parser, we should use that instead.</span>
<a href="#l1.860"></a><span id="l1.860" class="difflineminus">-  // Until then, we need to keep the following regex in sync with the</span>
<a href="#l1.861"></a><span id="l1.861" class="difflineminus">-  // listPost parsing in nsMsgCompose.cpp's</span>
<a href="#l1.862"></a><span id="l1.862" class="difflineminus">-  // QuotingOutputStreamListener::OnStopRequest.</span>
<a href="#l1.863"></a><span id="l1.863" class="difflineminus">-  return /&lt;mailto:.+&gt;/.test(listPost[&quot;headerValue&quot;]);</span>
<a href="#l1.864"></a><span id="l1.864" class="difflineminus">-}</span>
<a href="#l1.865"></a><span id="l1.865" class="difflineminus">-</span>
<a href="#l1.866"></a><span id="l1.866" class="difflineminus">-/**</span>
<a href="#l1.867"></a><span id="l1.867" class="difflineminus">- * Update the enabled/disabled states of the Reply, Reply-All, and</span>
<a href="#l1.868"></a><span id="l1.868" class="difflineminus">- * Reply-List buttons.  (After this function runs, one of the buttons</span>
<a href="#l1.869"></a><span id="l1.869" class="difflineminus">- * should be shown, and the others should be hidden.)</span>
<a href="#l1.870"></a><span id="l1.870" class="difflineminus">- */</span>
<a href="#l1.871"></a><span id="l1.871" class="difflineminus">-function UpdateReplyButtons()</span>
<a href="#l1.872"></a><span id="l1.872" class="difflineminus">-{</span>
<a href="#l1.873"></a><span id="l1.873" class="difflineminus">-  let showReplyAll = IsReplyAllEnabled();</span>
<a href="#l1.874"></a><span id="l1.874" class="difflineminus">-  let showReplyList = IsReplyListEnabled();</span>
<a href="#l1.875"></a><span id="l1.875" class="difflineminus">-</span>
<a href="#l1.876"></a><span id="l1.876" class="difflineminus">-  // If we're in a news item, we should default to Reply.</span>
<a href="#l1.877"></a><span id="l1.877" class="difflineminus">-  if (gFolderDisplay.selectedMessageIsNews)</span>
<a href="#l1.878"></a><span id="l1.878" class="difflineminus">-  {</span>
<a href="#l1.879"></a><span id="l1.879" class="difflineminus">-    showReplyAll = false;</span>
<a href="#l1.880"></a><span id="l1.880" class="difflineminus">-    showReplyList = false;</span>
<a href="#l1.881"></a><span id="l1.881" class="difflineminus">-  }</span>
<a href="#l1.882"></a><span id="l1.882" class="difflineminus">-</span>
<a href="#l1.883"></a><span id="l1.883" class="difflineminus">-  let buttonToShow = &quot;reply&quot;;</span>
<a href="#l1.884"></a><span id="l1.884" class="difflineminus">-  if (showReplyList)</span>
<a href="#l1.885"></a><span id="l1.885" class="difflineminus">-    buttonToShow = &quot;replyList&quot;;</span>
<a href="#l1.886"></a><span id="l1.886" class="difflineminus">-  else if (showReplyAll)</span>
<a href="#l1.887"></a><span id="l1.887" class="difflineminus">-    buttonToShow = &quot;replyAll&quot;;</span>
<a href="#l1.888"></a><span id="l1.888" class="difflineminus">-</span>
<a href="#l1.889"></a><span id="l1.889" class="difflineminus">-  let buttonBox = getCurrentMsgHdrButtonBox();</span>
<a href="#l1.890"></a><span id="l1.890" class="difflineminus">-</span>
<a href="#l1.891"></a><span id="l1.891" class="difflineminus">-  let replyButton = buttonBox.getButton(&quot;hdrReplyButton&quot;);</span>
<a href="#l1.892"></a><span id="l1.892" class="difflineminus">-  let replyAllButton = buttonBox.getButton(&quot;hdrReplyAllButton&quot;);</span>
<a href="#l1.893"></a><span id="l1.893" class="difflineminus">-  let replyAllSubButton = buttonBox.getButton(&quot;hdrReplyAllSubButton&quot;);</span>
<a href="#l1.894"></a><span id="l1.894" class="difflineminus">-  let replyAllSubButtonSep = buttonBox.getButton(&quot;hdrReplyAllSubButtonSep&quot;);</span>
<a href="#l1.895"></a><span id="l1.895" class="difflineminus">-  let replyListButton = buttonBox.getButton(&quot;hdrReplyListButton&quot;);</span>
<a href="#l1.896"></a><span id="l1.896" class="difflineminus">-</span>
<a href="#l1.897"></a><span id="l1.897" class="difflineminus">-  replyButton.hidden = (buttonToShow != &quot;reply&quot;);</span>
<a href="#l1.898"></a><span id="l1.898" class="difflineminus">-  replyAllButton.hidden = (buttonToShow != &quot;replyAll&quot;);</span>
<a href="#l1.899"></a><span id="l1.899" class="difflineminus">-  replyListButton.hidden = (buttonToShow != &quot;replyList&quot;);</span>
<a href="#l1.900"></a><span id="l1.900" class="difflineminus">-</span>
<a href="#l1.901"></a><span id="l1.901" class="difflineminus">-  if (gFolderDisplay.selectedMessageIsNews)</span>
<a href="#l1.902"></a><span id="l1.902" class="difflineminus">-  {</span>
<a href="#l1.903"></a><span id="l1.903" class="difflineminus">-    // If it's a news item, show the ReplyAll sub-button and separator.</span>
<a href="#l1.904"></a><span id="l1.904" class="difflineminus">-    replyAllSubButton.hidden = false;</span>
<a href="#l1.905"></a><span id="l1.905" class="difflineminus">-    replyAllSubButtonSep.hidden = false;</span>
<a href="#l1.906"></a><span id="l1.906" class="difflineminus">-  }</span>
<a href="#l1.907"></a><span id="l1.907" class="difflineminus">-  else if (gFolderDisplay.selectedMessageIsFeed)</span>
<a href="#l1.908"></a><span id="l1.908" class="difflineminus">-  {</span>
<a href="#l1.909"></a><span id="l1.909" class="difflineminus">-    // otherwise, if it's an rss item, hide all the Reply buttons.</span>
<a href="#l1.910"></a><span id="l1.910" class="difflineminus">-    replyButton.hidden = true;</span>
<a href="#l1.911"></a><span id="l1.911" class="difflineminus">-    replyAllButton.hidden = true;</span>
<a href="#l1.912"></a><span id="l1.912" class="difflineminus">-    replyListButton.hidden = true;</span>
<a href="#l1.913"></a><span id="l1.913" class="difflineminus">-    replyAllSubButton.hidden = true;</span>
<a href="#l1.914"></a><span id="l1.914" class="difflineminus">-    replyAllSubButtonSep.hidden = true;</span>
<a href="#l1.915"></a><span id="l1.915" class="difflineminus">-  }</span>
<a href="#l1.916"></a><span id="l1.916" class="difflineminus">-  else</span>
<a href="#l1.917"></a><span id="l1.917" class="difflineminus">-  {</span>
<a href="#l1.918"></a><span id="l1.918" class="difflineminus">-    // otherwise, hide the ReplyAll sub-buttons.</span>
<a href="#l1.919"></a><span id="l1.919" class="difflineminus">-    replyAllSubButton.hidden = true;</span>
<a href="#l1.920"></a><span id="l1.920" class="difflineminus">-    replyAllSubButtonSep.hidden = true;</span>
<a href="#l1.921"></a><span id="l1.921" class="difflineminus">-  }</span>
<a href="#l1.922"></a><span id="l1.922" class="difflineminus">-</span>
<a href="#l1.923"></a><span id="l1.923" class="difflineminus">-  goUpdateCommand(&quot;button_reply&quot;);</span>
<a href="#l1.924"></a><span id="l1.924" class="difflineminus">-  goUpdateCommand(&quot;button_replyall&quot;);</span>
<a href="#l1.925"></a><span id="l1.925" class="difflineminus">-  goUpdateCommand(&quot;button_replylist&quot;);</span>
<a href="#l1.926"></a><span id="l1.926" class="difflineminus">-}</span>
<a href="#l1.927"></a><span id="l1.927" class="difflineminus">-</span>
<a href="#l1.928"></a><span id="l1.928" class="difflineminus">-function UpdateDeleteToolbarButton()</span>
<a href="#l1.929"></a><span id="l1.929" class="difflineminus">-{</span>
<a href="#l1.930"></a><span id="l1.930" class="difflineminus">-  var deleteButtonDeck = document.getElementById(&quot;delete-deck&quot;);</span>
<a href="#l1.931"></a><span id="l1.931" class="difflineminus">-  if (!deleteButtonDeck)</span>
<a href="#l1.932"></a><span id="l1.932" class="difflineminus">-    return;</span>
<a href="#l1.933"></a><span id="l1.933" class="difflineminus">-</span>
<a href="#l1.934"></a><span id="l1.934" class="difflineminus">-  // Never show &quot;Undelete&quot; in the 3-pane for folders, when delete would</span>
<a href="#l1.935"></a><span id="l1.935" class="difflineminus">-  // apply to the selected folder.</span>
<a href="#l1.936"></a><span id="l1.936" class="difflineminus">-  if (this.WhichPaneHasFocus &amp;&amp;</span>
<a href="#l1.937"></a><span id="l1.937" class="difflineminus">-      WhichPaneHasFocus() == document.getElementById(&quot;folderTree&quot;) &amp;&amp;</span>
<a href="#l1.938"></a><span id="l1.938" class="difflineminus">-      GetNumSelectedMessages() == 0)</span>
<a href="#l1.939"></a><span id="l1.939" class="difflineminus">-    deleteButtonDeck.selectedIndex = 0;</span>
<a href="#l1.940"></a><span id="l1.940" class="difflineminus">-  else</span>
<a href="#l1.941"></a><span id="l1.941" class="difflineminus">-    deleteButtonDeck.selectedIndex = SelectedMessagesAreDeleted() ? 1 : 0;</span>
<a href="#l1.942"></a><span id="l1.942" class="difflineminus">-}</span>
<a href="#l1.943"></a><span id="l1.943" class="difflineminus">-function UpdateDeleteCommand()</span>
<a href="#l1.944"></a><span id="l1.944" class="difflineminus">-{</span>
<a href="#l1.945"></a><span id="l1.945" class="difflineminus">-  var value = &quot;value&quot;;</span>
<a href="#l1.946"></a><span id="l1.946" class="difflineminus">-  if (gFolderDisplay.selectedMessageIsNews)</span>
<a href="#l1.947"></a><span id="l1.947" class="difflineminus">-    value += &quot;News&quot;;</span>
<a href="#l1.948"></a><span id="l1.948" class="difflineminus">-  else if (SelectedMessagesAreDeleted())</span>
<a href="#l1.949"></a><span id="l1.949" class="difflineminus">-    value += &quot;IMAPDeleted&quot;;</span>
<a href="#l1.950"></a><span id="l1.950" class="difflineminus">-  if (GetNumSelectedMessages() &lt; 2)</span>
<a href="#l1.951"></a><span id="l1.951" class="difflineminus">-    value += &quot;Message&quot;;</span>
<a href="#l1.952"></a><span id="l1.952" class="difflineminus">-  else</span>
<a href="#l1.953"></a><span id="l1.953" class="difflineminus">-    value += &quot;Messages&quot;;</span>
<a href="#l1.954"></a><span id="l1.954" class="difflineminus">-  goSetMenuValue(&quot;cmd_delete&quot;, value);</span>
<a href="#l1.955"></a><span id="l1.955" class="difflineminus">-  goSetAccessKey(&quot;cmd_delete&quot;, value + &quot;AccessKey&quot;);</span>
<a href="#l1.956"></a><span id="l1.956" class="difflineminus">-}</span>
<a href="#l1.957"></a><span id="l1.957" class="difflineminus">-</span>
<a href="#l1.958"></a><span id="l1.958" class="difflineminus">-function SelectedMessagesAreDeleted()</span>
<a href="#l1.959"></a><span id="l1.959" class="difflineminus">-{</span>
<a href="#l1.960"></a><span id="l1.960" class="difflineminus">-  let firstSelectedMessage = gFolderDisplay.selectedMessage;</span>
<a href="#l1.961"></a><span id="l1.961" class="difflineminus">-  return firstSelectedMessage &amp;&amp;</span>
<a href="#l1.962"></a><span id="l1.962" class="difflineminus">-         (firstSelectedMessage.flags &amp;</span>
<a href="#l1.963"></a><span id="l1.963" class="difflineminus">-          Components.interfaces.nsMsgMessageFlags.IMAPDeleted);</span>
<a href="#l1.964"></a><span id="l1.964" class="difflineminus">-}</span>
<a href="#l1.965"></a><span id="l1.965" class="difflineminus">-</span>
<a href="#l1.966"></a><span id="l1.966" class="difflineminus">-function SelectedMessagesAreJunk()</span>
<a href="#l1.967"></a><span id="l1.967" class="difflineminus">-{</span>
<a href="#l1.968"></a><span id="l1.968" class="difflineminus">-  try {</span>
<a href="#l1.969"></a><span id="l1.969" class="difflineminus">-    var junkScore = gFolderDisplay.selectedMessage.getStringProperty(&quot;junkscore&quot;);</span>
<a href="#l1.970"></a><span id="l1.970" class="difflineminus">-    return (junkScore != &quot;&quot;) &amp;&amp; (junkScore != &quot;0&quot;);</span>
<a href="#l1.971"></a><span id="l1.971" class="difflineminus">-  }</span>
<a href="#l1.972"></a><span id="l1.972" class="difflineminus">-  catch (ex) {</span>
<a href="#l1.973"></a><span id="l1.973" class="difflineminus">-    return false;</span>
<a href="#l1.974"></a><span id="l1.974" class="difflineminus">-  }</span>
<a href="#l1.975"></a><span id="l1.975" class="difflineminus">-}</span>
<a href="#l1.976"></a><span id="l1.976" class="difflineminus">-</span>
<a href="#l1.977"></a><span id="l1.977" class="difflineminus">-function SelectedMessagesAreRead()</span>
<a href="#l1.978"></a><span id="l1.978" class="difflineminus">-{</span>
<a href="#l1.979"></a><span id="l1.979" class="difflineminus">-  let firstSelectedMessage = gFolderDisplay.selectedMessage;</span>
<a href="#l1.980"></a><span id="l1.980" class="difflineminus">-  return firstSelectedMessage &amp;&amp; firstSelectedMessage.isRead;</span>
<a href="#l1.981"></a><span id="l1.981" class="difflineminus">-}</span>
<a href="#l1.982"></a><span id="l1.982" class="difflineminus">-</span>
<a href="#l1.983"></a><span id="l1.983" class="difflineminus">-function SelectedMessagesAreFlagged()</span>
<a href="#l1.984"></a><span id="l1.984" class="difflineminus">-{</span>
<a href="#l1.985"></a><span id="l1.985" class="difflineminus">-  let firstSelectedMessage = gFolderDisplay.selectedMessage;</span>
<a href="#l1.986"></a><span id="l1.986" class="difflineminus">-  return firstSelectedMessage &amp;&amp; firstSelectedMessage.isFlagged;</span>
<a href="#l1.987"></a><span id="l1.987" class="difflineminus">-}</span>
<a href="#l1.988"></a><span id="l1.988" class="difflineminus">-</span>
<a href="#l1.989"></a><span id="l1.989" class="difflineminus">-function GetFirstSelectedMsgFolder()</span>
<a href="#l1.990"></a><span id="l1.990" class="difflineminus">-{</span>
<a href="#l1.991"></a><span id="l1.991" class="difflineminus">-  try {</span>
<a href="#l1.992"></a><span id="l1.992" class="difflineminus">-    var selectedFolders = GetSelectedMsgFolders();</span>
<a href="#l1.993"></a><span id="l1.993" class="difflineminus">-  } catch (e) {</span>
<a href="#l1.994"></a><span id="l1.994" class="difflineminus">-    logException(e);</span>
<a href="#l1.995"></a><span id="l1.995" class="difflineminus">-  }</span>
<a href="#l1.996"></a><span id="l1.996" class="difflineminus">-  return (selectedFolders.length &gt; 0) ? selectedFolders[0] : null;</span>
<a href="#l1.997"></a><span id="l1.997" class="difflineminus">-}</span>
<a href="#l1.998"></a><span id="l1.998" class="difflineminus">-</span>
<a href="#l1.999"></a><span id="l1.999" class="difflineminus">-function GetInboxFolder(server)</span>
<a href="#l1.1000"></a><span id="l1.1000" class="difflineminus">-{</span>
<a href="#l1.1001"></a><span id="l1.1001" class="difflineminus">-  try {</span>
<a href="#l1.1002"></a><span id="l1.1002" class="difflineminus">-    var rootMsgFolder = server.rootMsgFolder;</span>
<a href="#l1.1003"></a><span id="l1.1003" class="difflineminus">-</span>
<a href="#l1.1004"></a><span id="l1.1004" class="difflineminus">-    // Now find the Inbox.</span>
<a href="#l1.1005"></a><span id="l1.1005" class="difflineminus">-    const nsMsgFolderFlags = Components.interfaces.nsMsgFolderFlags;</span>
<a href="#l1.1006"></a><span id="l1.1006" class="difflineminus">-    return rootMsgFolder.getFolderWithFlags(nsMsgFolderFlags.Inbox);</span>
<a href="#l1.1007"></a><span id="l1.1007" class="difflineminus">-  }</span>
<a href="#l1.1008"></a><span id="l1.1008" class="difflineminus">-  catch (ex) {</span>
<a href="#l1.1009"></a><span id="l1.1009" class="difflineminus">-    dump(ex + &quot;\n&quot;);</span>
<a href="#l1.1010"></a><span id="l1.1010" class="difflineminus">-  }</span>
<a href="#l1.1011"></a><span id="l1.1011" class="difflineminus">-  return null;</span>
<a href="#l1.1012"></a><span id="l1.1012" class="difflineminus">-}</span>
<a href="#l1.1013"></a><span id="l1.1013" class="difflineminus">-</span>
<a href="#l1.1014"></a><span id="l1.1014" class="difflineminus">-function GetMessagesForInboxOnServer(server)</span>
<a href="#l1.1015"></a><span id="l1.1015" class="difflineminus">-{</span>
<a href="#l1.1016"></a><span id="l1.1016" class="difflineminus">-  var inboxFolder = GetInboxFolder(server);</span>
<a href="#l1.1017"></a><span id="l1.1017" class="difflineminus">-</span>
<a href="#l1.1018"></a><span id="l1.1018" class="difflineminus">-  // If the server doesn't support an inbox it could be an RSS server or some</span>
<a href="#l1.1019"></a><span id="l1.1019" class="difflineminus">-  // other server type. Just use the root folder and the server implementation</span>
<a href="#l1.1020"></a><span id="l1.1020" class="difflineminus">-  // can figure out what to do.</span>
<a href="#l1.1021"></a><span id="l1.1021" class="difflineminus">-  if (!inboxFolder)</span>
<a href="#l1.1022"></a><span id="l1.1022" class="difflineminus">-    inboxFolder = server.rootFolder;</span>
<a href="#l1.1023"></a><span id="l1.1023" class="difflineminus">-</span>
<a href="#l1.1024"></a><span id="l1.1024" class="difflineminus">-  GetNewMsgs(server, inboxFolder);</span>
<a href="#l1.1025"></a><span id="l1.1025" class="difflineminus">-}</span>
<a href="#l1.1026"></a><span id="l1.1026" class="difflineminus">-</span>
<a href="#l1.1027"></a><span id="l1.1027" class="difflineminus">-function MsgGetMessage()</span>
<a href="#l1.1028"></a><span id="l1.1028" class="difflineminus">-{</span>
<a href="#l1.1029"></a><span id="l1.1029" class="difflineminus">-  // if offline, prompt for getting messages</span>
<a href="#l1.1030"></a><span id="l1.1030" class="difflineminus">-  if (MailOfflineMgr.isOnline() || MailOfflineMgr.getNewMail())</span>
<a href="#l1.1031"></a><span id="l1.1031" class="difflineminus">-    GetFolderMessages();</span>
<a href="#l1.1032"></a><span id="l1.1032" class="difflineminus">-}</span>
<a href="#l1.1033"></a><span id="l1.1033" class="difflineminus">-</span>
<a href="#l1.1034"></a><span id="l1.1034" class="difflineminus">-function MsgGetMessagesForAllServers(defaultServer)</span>
<a href="#l1.1035"></a><span id="l1.1035" class="difflineminus">-{</span>
<a href="#l1.1036"></a><span id="l1.1036" class="difflineminus">-  // now log into any server</span>
<a href="#l1.1037"></a><span id="l1.1037" class="difflineminus">-  try</span>
<a href="#l1.1038"></a><span id="l1.1038" class="difflineminus">-  {</span>
<a href="#l1.1039"></a><span id="l1.1039" class="difflineminus">-    var allServers = accountManager.allServers;</span>
<a href="#l1.1040"></a><span id="l1.1040" class="difflineminus">-    // Array of isupportsarrays of servers for a particular folder.</span>
<a href="#l1.1041"></a><span id="l1.1041" class="difflineminus">-    var pop3DownloadServersArray = new Array();</span>
<a href="#l1.1042"></a><span id="l1.1042" class="difflineminus">-    // Parallel isupports array of folders to download to...</span>
<a href="#l1.1043"></a><span id="l1.1043" class="difflineminus">-    var localFoldersToDownloadTo = Components.classes[&quot;@mozilla.org/supports-array;1&quot;]</span>
<a href="#l1.1044"></a><span id="l1.1044" class="difflineminus">-                                             .createInstance(Components.interfaces.nsISupportsArray);</span>
<a href="#l1.1045"></a><span id="l1.1045" class="difflineminus">-    var pop3Server;</span>
<a href="#l1.1046"></a><span id="l1.1046" class="difflineminus">-    for (var i = 0; i &lt; allServers.Count(); ++i)</span>
<a href="#l1.1047"></a><span id="l1.1047" class="difflineminus">-    {</span>
<a href="#l1.1048"></a><span id="l1.1048" class="difflineminus">-      var currentServer = allServers.QueryElementAt(i, Components.interfaces.nsIMsgIncomingServer);</span>
<a href="#l1.1049"></a><span id="l1.1049" class="difflineminus">-      var protocolinfo = Components.classes[&quot;@mozilla.org/messenger/protocol/info;1?type=&quot; + currentServer.type]</span>
<a href="#l1.1050"></a><span id="l1.1050" class="difflineminus">-                                   .getService(Components.interfaces.nsIMsgProtocolInfo);</span>
<a href="#l1.1051"></a><span id="l1.1051" class="difflineminus">-      if (protocolinfo.canLoginAtStartUp &amp;&amp; currentServer.loginAtStartUp)</span>
<a href="#l1.1052"></a><span id="l1.1052" class="difflineminus">-      {</span>
<a href="#l1.1053"></a><span id="l1.1053" class="difflineminus">-        if (defaultServer &amp;&amp; defaultServer.equals(currentServer) &amp;&amp;</span>
<a href="#l1.1054"></a><span id="l1.1054" class="difflineminus">-            !defaultServer.isDeferredTo &amp;&amp;</span>
<a href="#l1.1055"></a><span id="l1.1055" class="difflineminus">-            defaultServer.rootFolder == defaultServer.rootMsgFolder)</span>
<a href="#l1.1056"></a><span id="l1.1056" class="difflineminus">-        {</span>
<a href="#l1.1057"></a><span id="l1.1057" class="difflineminus">-          // skip, already opened</span>
<a href="#l1.1058"></a><span id="l1.1058" class="difflineminus">-        }</span>
<a href="#l1.1059"></a><span id="l1.1059" class="difflineminus">-        else if (currentServer.type == &quot;pop3&quot; &amp;&amp; currentServer.downloadOnBiff)</span>
<a href="#l1.1060"></a><span id="l1.1060" class="difflineminus">-        {</span>
<a href="#l1.1061"></a><span id="l1.1061" class="difflineminus">-          CoalesceGetMsgsForPop3ServersByDestFolder(currentServer,</span>
<a href="#l1.1062"></a><span id="l1.1062" class="difflineminus">-            pop3DownloadServersArray, localFoldersToDownloadTo);</span>
<a href="#l1.1063"></a><span id="l1.1063" class="difflineminus">-          pop3Server = currentServer.QueryInterface(Components.interfaces.nsIPop3IncomingServer);</span>
<a href="#l1.1064"></a><span id="l1.1064" class="difflineminus">-        }</span>
<a href="#l1.1065"></a><span id="l1.1065" class="difflineminus">-        else</span>
<a href="#l1.1066"></a><span id="l1.1066" class="difflineminus">-        {</span>
<a href="#l1.1067"></a><span id="l1.1067" class="difflineminus">-          // Check to see if there are new messages on the server</span>
<a href="#l1.1068"></a><span id="l1.1068" class="difflineminus">-          currentServer.performBiff(msgWindow);</span>
<a href="#l1.1069"></a><span id="l1.1069" class="difflineminus">-        }</span>
<a href="#l1.1070"></a><span id="l1.1070" class="difflineminus">-      }</span>
<a href="#l1.1071"></a><span id="l1.1071" class="difflineminus">-    }</span>
<a href="#l1.1072"></a><span id="l1.1072" class="difflineminus">-    for (var i = 0; i &lt; pop3DownloadServersArray.length; ++i)</span>
<a href="#l1.1073"></a><span id="l1.1073" class="difflineminus">-    {</span>
<a href="#l1.1074"></a><span id="l1.1074" class="difflineminus">-      // Any ol' pop3Server will do - the serversArray specifies which servers</span>
<a href="#l1.1075"></a><span id="l1.1075" class="difflineminus">-      // to download from.</span>
<a href="#l1.1076"></a><span id="l1.1076" class="difflineminus">-      pop3Server.downloadMailFromServers(pop3DownloadServersArray[i], msgWindow,</span>
<a href="#l1.1077"></a><span id="l1.1077" class="difflineminus">-                                         localFoldersToDownloadTo.GetElementAt(i), null);</span>
<a href="#l1.1078"></a><span id="l1.1078" class="difflineminus">-    }</span>
<a href="#l1.1079"></a><span id="l1.1079" class="difflineminus">-  }</span>
<a href="#l1.1080"></a><span id="l1.1080" class="difflineminus">-  catch(ex)</span>
<a href="#l1.1081"></a><span id="l1.1081" class="difflineminus">-  {</span>
<a href="#l1.1082"></a><span id="l1.1082" class="difflineminus">-    dump(ex + &quot;\n&quot;);</span>
<a href="#l1.1083"></a><span id="l1.1083" class="difflineminus">-  }</span>
<a href="#l1.1084"></a><span id="l1.1084" class="difflineminus">-}</span>
<a href="#l1.1085"></a><span id="l1.1085" class="difflineminus">-</span>
<a href="#l1.1086"></a><span id="l1.1086" class="difflineminus">-/**</span>
<a href="#l1.1087"></a><span id="l1.1087" class="difflineminus">-  * Get messages for all those accounts which have the capability</span>
<a href="#l1.1088"></a><span id="l1.1088" class="difflineminus">-  * of getting messages and have session password available i.e.,</span>
<a href="#l1.1089"></a><span id="l1.1089" class="difflineminus">-  * curretnly logged in accounts.</span>
<a href="#l1.1090"></a><span id="l1.1090" class="difflineminus">-  * if offline, prompt for getting messages.</span>
<a href="#l1.1091"></a><span id="l1.1091" class="difflineminus">-  */</span>
<a href="#l1.1092"></a><span id="l1.1092" class="difflineminus">-function MsgGetMessagesForAllAuthenticatedAccounts()</span>
<a href="#l1.1093"></a><span id="l1.1093" class="difflineminus">-{</span>
<a href="#l1.1094"></a><span id="l1.1094" class="difflineminus">-  if (MailOfflineMgr.isOnline() || MailOfflineMgr.getNewMail())</span>
<a href="#l1.1095"></a><span id="l1.1095" class="difflineminus">-    GetMessagesForAllAuthenticatedAccounts();</span>
<a href="#l1.1096"></a><span id="l1.1096" class="difflineminus">-}</span>
<a href="#l1.1097"></a><span id="l1.1097" class="difflineminus">-</span>
<a href="#l1.1098"></a><span id="l1.1098" class="difflineminus">-/**</span>
<a href="#l1.1099"></a><span id="l1.1099" class="difflineminus">-  * Get messages for the account selected from Menu dropdowns.</span>
<a href="#l1.1100"></a><span id="l1.1100" class="difflineminus">-  * if offline, prompt for getting messages.</span>
<a href="#l1.1101"></a><span id="l1.1101" class="difflineminus">-  *</span>
<a href="#l1.1102"></a><span id="l1.1102" class="difflineminus">-  * @param aFolder (optional) a folder in the account for which messages should</span>
<a href="#l1.1103"></a><span id="l1.1103" class="difflineminus">-  *                           be retrieved.  If null, all accounts will be used.</span>
<a href="#l1.1104"></a><span id="l1.1104" class="difflineminus">-  */</span>
<a href="#l1.1105"></a><span id="l1.1105" class="difflineminus">-function MsgGetMessagesForAccount(aFolder)</span>
<a href="#l1.1106"></a><span id="l1.1106" class="difflineminus">-{</span>
<a href="#l1.1107"></a><span id="l1.1107" class="difflineminus">-  if (!aFolder) {</span>
<a href="#l1.1108"></a><span id="l1.1108" class="difflineminus">-    goDoCommand('cmd_getNewMessages');</span>
<a href="#l1.1109"></a><span id="l1.1109" class="difflineminus">-    return;</span>
<a href="#l1.1110"></a><span id="l1.1110" class="difflineminus">-  }</span>
<a href="#l1.1111"></a><span id="l1.1111" class="difflineminus">-</span>
<a href="#l1.1112"></a><span id="l1.1112" class="difflineminus">-  if (MailOfflineMgr.isOnline() || MailOfflineMgr.getNewMail()) {</span>
<a href="#l1.1113"></a><span id="l1.1113" class="difflineminus">-    var server = aFolder.server;</span>
<a href="#l1.1114"></a><span id="l1.1114" class="difflineminus">-    GetMessagesForInboxOnServer(server);</span>
<a href="#l1.1115"></a><span id="l1.1115" class="difflineminus">-  }</span>
<a href="#l1.1116"></a><span id="l1.1116" class="difflineminus">-}</span>
<a href="#l1.1117"></a><span id="l1.1117" class="difflineminus">-</span>
<a href="#l1.1118"></a><span id="l1.1118" class="difflineminus">-// if offline, prompt for getNextNMessages</span>
<a href="#l1.1119"></a><span id="l1.1119" class="difflineminus">-function MsgGetNextNMessages()</span>
<a href="#l1.1120"></a><span id="l1.1120" class="difflineminus">-{</span>
<a href="#l1.1121"></a><span id="l1.1121" class="difflineminus">-  if (MailOfflineMgr.isOnline() || MailOfflineMgr.getNewMail())</span>
<a href="#l1.1122"></a><span id="l1.1122" class="difflineminus">-    GetNextNMessages(GetFirstSelectedMsgFolder());</span>
<a href="#l1.1123"></a><span id="l1.1123" class="difflineminus">-}</span>
<a href="#l1.1124"></a><span id="l1.1124" class="difflineminus">-</span>
<a href="#l1.1125"></a><span id="l1.1125" class="difflineminus">-function MsgDeleteMessage(reallyDelete, fromToolbar)</span>
<a href="#l1.1126"></a><span id="l1.1126" class="difflineminus">-{</span>
<a href="#l1.1127"></a><span id="l1.1127" class="difflineminus">-  // If from the toolbar, return right away if this is a news message</span>
<a href="#l1.1128"></a><span id="l1.1128" class="difflineminus">-  // only allow cancel from the menu:  &quot;Edit | Cancel / Delete Message&quot;.</span>
<a href="#l1.1129"></a><span id="l1.1129" class="difflineminus">-  if (fromToolbar &amp;&amp; gFolderDisplay.view.isNewsFolder)</span>
<a href="#l1.1130"></a><span id="l1.1130" class="difflineminus">-    return;</span>
<a href="#l1.1131"></a><span id="l1.1131" class="difflineminus">-</span>
<a href="#l1.1132"></a><span id="l1.1132" class="difflineminus">-  gFolderDisplay.hintAboutToDeleteMessages();</span>
<a href="#l1.1133"></a><span id="l1.1133" class="difflineminus">-  if (reallyDelete)</span>
<a href="#l1.1134"></a><span id="l1.1134" class="difflineminus">-    gDBView.doCommand(nsMsgViewCommandType.deleteNoTrash);</span>
<a href="#l1.1135"></a><span id="l1.1135" class="difflineminus">-  else</span>
<a href="#l1.1136"></a><span id="l1.1136" class="difflineminus">-    gDBView.doCommand(nsMsgViewCommandType.deleteMsg);</span>
<a href="#l1.1137"></a><span id="l1.1137" class="difflineminus">-}</span>
<a href="#l1.1138"></a><span id="l1.1138" class="difflineminus">-</span>
<a href="#l1.1139"></a><span id="l1.1139" class="difflineminus">-/**</span>
<a href="#l1.1140"></a><span id="l1.1140" class="difflineminus">- * Copies the selected messages to the destination folder</span>
<a href="#l1.1141"></a><span id="l1.1141" class="difflineminus">- * @param aDestFolder  the destination folder</span>
<a href="#l1.1142"></a><span id="l1.1142" class="difflineminus">- */</span>
<a href="#l1.1143"></a><span id="l1.1143" class="difflineminus">-function MsgCopyMessage(aDestFolder)</span>
<a href="#l1.1144"></a><span id="l1.1144" class="difflineminus">-{</span>
<a href="#l1.1145"></a><span id="l1.1145" class="difflineminus">-  gDBView.doCommandWithFolder(nsMsgViewCommandType.copyMessages, aDestFolder);</span>
<a href="#l1.1146"></a><span id="l1.1146" class="difflineminus">-  pref.setCharPref(&quot;mail.last_msg_movecopy_target_uri&quot;, aDestFolder.URI);</span>
<a href="#l1.1147"></a><span id="l1.1147" class="difflineminus">-  pref.setBoolPref(&quot;mail.last_msg_movecopy_was_move&quot;, false);</span>
<a href="#l1.1148"></a><span id="l1.1148" class="difflineminus">-}</span>
<a href="#l1.1149"></a><span id="l1.1149" class="difflineminus">-</span>
<a href="#l1.1150"></a><span id="l1.1150" class="difflineminus">-/**</span>
<a href="#l1.1151"></a><span id="l1.1151" class="difflineminus">- * Moves the selected messages to the destination folder</span>
<a href="#l1.1152"></a><span id="l1.1152" class="difflineminus">- * @param aDestFolder  the destination folder</span>
<a href="#l1.1153"></a><span id="l1.1153" class="difflineminus">- */</span>
<a href="#l1.1154"></a><span id="l1.1154" class="difflineminus">-function MsgMoveMessage(aDestFolder)</span>
<a href="#l1.1155"></a><span id="l1.1155" class="difflineminus">-{</span>
<a href="#l1.1156"></a><span id="l1.1156" class="difflineminus">-  // We don't move news messages, we copy them.</span>
<a href="#l1.1157"></a><span id="l1.1157" class="difflineminus">-  if (isNewsURI(gDBView.msgFolder.URI))</span>
<a href="#l1.1158"></a><span id="l1.1158" class="difflineminus">-    gDBView.doCommandWithFolder(nsMsgViewCommandType.copyMessages, aDestFolder);</span>
<a href="#l1.1159"></a><span id="l1.1159" class="difflineminus">-  else</span>
<a href="#l1.1160"></a><span id="l1.1160" class="difflineminus">-  {</span>
<a href="#l1.1161"></a><span id="l1.1161" class="difflineminus">-    gFolderDisplay.hintAboutToDeleteMessages();</span>
<a href="#l1.1162"></a><span id="l1.1162" class="difflineminus">-    gDBView.doCommandWithFolder(nsMsgViewCommandType.moveMessages, aDestFolder);</span>
<a href="#l1.1163"></a><span id="l1.1163" class="difflineminus">-  }</span>
<a href="#l1.1164"></a><span id="l1.1164" class="difflineminus">-  pref.setCharPref(&quot;mail.last_msg_movecopy_target_uri&quot;, aDestFolder.URI);</span>
<a href="#l1.1165"></a><span id="l1.1165" class="difflineminus">-  pref.setBoolPref(&quot;mail.last_msg_movecopy_was_move&quot;, true);</span>
<a href="#l1.1166"></a><span id="l1.1166" class="difflineminus">-}</span>
<a href="#l1.1167"></a><span id="l1.1167" class="difflineminus">-</span>
<a href="#l1.1168"></a><span id="l1.1168" class="difflineminus">-/**</span>
<a href="#l1.1169"></a><span id="l1.1169" class="difflineminus">- * Calls the ComposeMessage function with the desired type, and proper default</span>
<a href="#l1.1170"></a><span id="l1.1170" class="difflineminus">- * based on the event that fired it.</span>
<a href="#l1.1171"></a><span id="l1.1171" class="difflineminus">- *</span>
<a href="#l1.1172"></a><span id="l1.1172" class="difflineminus">- * @param aCompType  the nsIMsgCompType to pass to the function</span>
<a href="#l1.1173"></a><span id="l1.1173" class="difflineminus">- * @param aEvent (optional) the event that triggered the call</span>
<a href="#l1.1174"></a><span id="l1.1174" class="difflineminus">- */</span>
<a href="#l1.1175"></a><span id="l1.1175" class="difflineminus">-function composeMsgByType(aCompType, aEvent) {</span>
<a href="#l1.1176"></a><span id="l1.1176" class="difflineminus">-  // If we're the hidden window, then we're not going to have a gFolderDisplay</span>
<a href="#l1.1177"></a><span id="l1.1177" class="difflineminus">-  // to work out existing folders, so just use null.</span>
<a href="#l1.1178"></a><span id="l1.1178" class="difflineminus">-  let msgFolder = gFolderDisplay ? GetFirstSelectedMsgFolder() : null;</span>
<a href="#l1.1179"></a><span id="l1.1179" class="difflineminus">-  let msgUris = gFolderDisplay ? gFolderDisplay.selectedMessageUris : null;</span>
<a href="#l1.1180"></a><span id="l1.1180" class="difflineminus">-</span>
<a href="#l1.1181"></a><span id="l1.1181" class="difflineminus">-  if (aEvent &amp;&amp; aEvent.shiftKey) {</span>
<a href="#l1.1182"></a><span id="l1.1182" class="difflineminus">-    ComposeMessage(aCompType,</span>
<a href="#l1.1183"></a><span id="l1.1183" class="difflineminus">-                   Components.interfaces.nsIMsgCompFormat.OppositeOfDefault,</span>
<a href="#l1.1184"></a><span id="l1.1184" class="difflineminus">-                   msgFolder, msgUris);</span>
<a href="#l1.1185"></a><span id="l1.1185" class="difflineminus">-  }</span>
<a href="#l1.1186"></a><span id="l1.1186" class="difflineminus">-  else {</span>
<a href="#l1.1187"></a><span id="l1.1187" class="difflineminus">-    ComposeMessage(aCompType, Components.interfaces.nsIMsgCompFormat.Default,</span>
<a href="#l1.1188"></a><span id="l1.1188" class="difflineminus">-                   msgFolder, msgUris);</span>
<a href="#l1.1189"></a><span id="l1.1189" class="difflineminus">-  }</span>
<a href="#l1.1190"></a><span id="l1.1190" class="difflineminus">-}</span>
<a href="#l1.1191"></a><span id="l1.1191" class="difflineminus">-</span>
<a href="#l1.1192"></a><span id="l1.1192" class="difflineminus">-function MsgNewMessage(event)</span>
<a href="#l1.1193"></a><span id="l1.1193" class="difflineminus">-{</span>
<a href="#l1.1194"></a><span id="l1.1194" class="difflineminus">-  composeMsgByType(Components.interfaces.nsIMsgCompType.New, event);</span>
<a href="#l1.1195"></a><span id="l1.1195" class="difflineminus">-}</span>
<a href="#l1.1196"></a><span id="l1.1196" class="difflineminus">-</span>
<a href="#l1.1197"></a><span id="l1.1197" class="difflineminus">-function MsgReplyMessage(event)</span>
<a href="#l1.1198"></a><span id="l1.1198" class="difflineminus">-{</span>
<a href="#l1.1199"></a><span id="l1.1199" class="difflineminus">-  var loadedFolder = gFolderDisplay.displayedFolder;</span>
<a href="#l1.1200"></a><span id="l1.1200" class="difflineminus">-  if (loadedFolder)</span>
<a href="#l1.1201"></a><span id="l1.1201" class="difflineminus">-  {</span>
<a href="#l1.1202"></a><span id="l1.1202" class="difflineminus">-    var server = loadedFolder.server;</span>
<a href="#l1.1203"></a><span id="l1.1203" class="difflineminus">-    if(server &amp;&amp; server.type == &quot;nntp&quot;)</span>
<a href="#l1.1204"></a><span id="l1.1204" class="difflineminus">-    {</span>
<a href="#l1.1205"></a><span id="l1.1205" class="difflineminus">-      MsgReplyGroup(event);</span>
<a href="#l1.1206"></a><span id="l1.1206" class="difflineminus">-      return;</span>
<a href="#l1.1207"></a><span id="l1.1207" class="difflineminus">-    }</span>
<a href="#l1.1208"></a><span id="l1.1208" class="difflineminus">-  }</span>
<a href="#l1.1209"></a><span id="l1.1209" class="difflineminus">-  MsgReplySender(event);</span>
<a href="#l1.1210"></a><span id="l1.1210" class="difflineminus">-}</span>
<a href="#l1.1211"></a><span id="l1.1211" class="difflineminus">-</span>
<a href="#l1.1212"></a><span id="l1.1212" class="difflineminus">-function MsgReplySender(event)</span>
<a href="#l1.1213"></a><span id="l1.1213" class="difflineminus">-{</span>
<a href="#l1.1214"></a><span id="l1.1214" class="difflineminus">-  composeMsgByType(Components.interfaces.nsIMsgCompType.ReplyToSender, event);</span>
<a href="#l1.1215"></a><span id="l1.1215" class="difflineminus">-}</span>
<a href="#l1.1216"></a><span id="l1.1216" class="difflineminus">-</span>
<a href="#l1.1217"></a><span id="l1.1217" class="difflineminus">-function MsgReplyGroup(event)</span>
<a href="#l1.1218"></a><span id="l1.1218" class="difflineminus">-{</span>
<a href="#l1.1219"></a><span id="l1.1219" class="difflineminus">-  composeMsgByType(Components.interfaces.nsIMsgCompType.ReplyToGroup, event);</span>
<a href="#l1.1220"></a><span id="l1.1220" class="difflineminus">-}</span>
<a href="#l1.1221"></a><span id="l1.1221" class="difflineminus">-</span>
<a href="#l1.1222"></a><span id="l1.1222" class="difflineminus">-function MsgReplyToAllMessage(event)</span>
<a href="#l1.1223"></a><span id="l1.1223" class="difflineminus">-{</span>
<a href="#l1.1224"></a><span id="l1.1224" class="difflineminus">-  composeMsgByType(Components.interfaces.nsIMsgCompType.ReplyAll, event);</span>
<a href="#l1.1225"></a><span id="l1.1225" class="difflineminus">-}</span>
<a href="#l1.1226"></a><span id="l1.1226" class="difflineminus">-</span>
<a href="#l1.1227"></a><span id="l1.1227" class="difflineminus">-function MsgReplyToListMessage(event)</span>
<a href="#l1.1228"></a><span id="l1.1228" class="difflineminus">-{</span>
<a href="#l1.1229"></a><span id="l1.1229" class="difflineminus">-  composeMsgByType(Components.interfaces.nsIMsgCompType.ReplyToList, event);</span>
<a href="#l1.1230"></a><span id="l1.1230" class="difflineminus">-}</span>
<a href="#l1.1231"></a><span id="l1.1231" class="difflineminus">-</span>
<a href="#l1.1232"></a><span id="l1.1232" class="difflineminus">-// Message Archive function</span>
<a href="#l1.1233"></a><span id="l1.1233" class="difflineminus">-</span>
<a href="#l1.1234"></a><span id="l1.1234" class="difflineminus">-function BatchMessageMover()</span>
<a href="#l1.1235"></a><span id="l1.1235" class="difflineminus">-{</span>
<a href="#l1.1236"></a><span id="l1.1236" class="difflineminus">-  this._batches = {};</span>
<a href="#l1.1237"></a><span id="l1.1237" class="difflineminus">-  this._currentKey = null;</span>
<a href="#l1.1238"></a><span id="l1.1238" class="difflineminus">-}</span>
<a href="#l1.1239"></a><span id="l1.1239" class="difflineminus">-</span>
<a href="#l1.1240"></a><span id="l1.1240" class="difflineminus">-BatchMessageMover.prototype = {</span>
<a href="#l1.1241"></a><span id="l1.1241" class="difflineminus">-</span>
<a href="#l1.1242"></a><span id="l1.1242" class="difflineminus">-  archiveSelectedMessages: function()</span>
<a href="#l1.1243"></a><span id="l1.1243" class="difflineminus">-  {</span>
<a href="#l1.1244"></a><span id="l1.1244" class="difflineminus">-    gFolderDisplay.hintMassMoveStarting();</span>
<a href="#l1.1245"></a><span id="l1.1245" class="difflineminus">-</span>
<a href="#l1.1246"></a><span id="l1.1246" class="difflineminus">-    let selectedMessages = gFolderDisplay.selectedMessages;</span>
<a href="#l1.1247"></a><span id="l1.1247" class="difflineminus">-    if (!selectedMessages.length)</span>
<a href="#l1.1248"></a><span id="l1.1248" class="difflineminus">-      return;</span>
<a href="#l1.1249"></a><span id="l1.1249" class="difflineminus">-</span>
<a href="#l1.1250"></a><span id="l1.1250" class="difflineminus">-    let messages = Components.classes[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l1.1251"></a><span id="l1.1251" class="difflineminus">-                             .createInstance(Components.interfaces.nsIMutableArray);</span>
<a href="#l1.1252"></a><span id="l1.1252" class="difflineminus">-</span>
<a href="#l1.1253"></a><span id="l1.1253" class="difflineminus">-    for (let i = 0; i &lt; selectedMessages.length; ++i)</span>
<a href="#l1.1254"></a><span id="l1.1254" class="difflineminus">-    {</span>
<a href="#l1.1255"></a><span id="l1.1255" class="difflineminus">-      let msgHdr = selectedMessages[i];</span>
<a href="#l1.1256"></a><span id="l1.1256" class="difflineminus">-</span>
<a href="#l1.1257"></a><span id="l1.1257" class="difflineminus">-      let rootFolder = msgHdr.folder.server.rootFolder;</span>
<a href="#l1.1258"></a><span id="l1.1258" class="difflineminus">-</span>
<a href="#l1.1259"></a><span id="l1.1259" class="difflineminus">-      let msgDate = new Date(msgHdr.date / 1000);  // convert date to JS date object</span>
<a href="#l1.1260"></a><span id="l1.1260" class="difflineminus">-      let msgYear = msgDate.getFullYear().toString();</span>
<a href="#l1.1261"></a><span id="l1.1261" class="difflineminus">-      let monthFolderName = msgDate.toLocaleFormat(&quot;%Y-%m&quot;)</span>
<a href="#l1.1262"></a><span id="l1.1262" class="difflineminus">-      let dstFolderName = monthFolderName;</span>
<a href="#l1.1263"></a><span id="l1.1263" class="difflineminus">-</span>
<a href="#l1.1264"></a><span id="l1.1264" class="difflineminus">-      let copyBatchKey = msgHdr.folder.URI + '\000' + dstFolderName;</span>
<a href="#l1.1265"></a><span id="l1.1265" class="difflineminus">-      if (! (copyBatchKey in this._batches)) {</span>
<a href="#l1.1266"></a><span id="l1.1266" class="difflineminus">-        this._batches[copyBatchKey] = [msgHdr.folder, msgYear, dstFolderName];</span>
<a href="#l1.1267"></a><span id="l1.1267" class="difflineminus">-      }</span>
<a href="#l1.1268"></a><span id="l1.1268" class="difflineminus">-      this._batches[copyBatchKey].push(msgHdr);</span>
<a href="#l1.1269"></a><span id="l1.1269" class="difflineminus">-    }</span>
<a href="#l1.1270"></a><span id="l1.1270" class="difflineminus">-    // Now we launch the code that will iterate over all of the message copies</span>
<a href="#l1.1271"></a><span id="l1.1271" class="difflineminus">-    // one in turn</span>
<a href="#l1.1272"></a><span id="l1.1272" class="difflineminus">-    this.processNextBatch();</span>
<a href="#l1.1273"></a><span id="l1.1273" class="difflineminus">-  },</span>
<a href="#l1.1274"></a><span id="l1.1274" class="difflineminus">-</span>
<a href="#l1.1275"></a><span id="l1.1275" class="difflineminus">-  processNextBatch: function()</span>
<a href="#l1.1276"></a><span id="l1.1276" class="difflineminus">-  {</span>
<a href="#l1.1277"></a><span id="l1.1277" class="difflineminus">-    for (let key in this._batches)</span>
<a href="#l1.1278"></a><span id="l1.1278" class="difflineminus">-    {</span>
<a href="#l1.1279"></a><span id="l1.1279" class="difflineminus">-      this._currentKey = key;</span>
<a href="#l1.1280"></a><span id="l1.1280" class="difflineminus">-      let batch = this._batches[key];</span>
<a href="#l1.1281"></a><span id="l1.1281" class="difflineminus">-      let srcFolder = batch[0];</span>
<a href="#l1.1282"></a><span id="l1.1282" class="difflineminus">-      let msgYear = batch[1];</span>
<a href="#l1.1283"></a><span id="l1.1283" class="difflineminus">-      let msgMonth = batch[2];</span>
<a href="#l1.1284"></a><span id="l1.1284" class="difflineminus">-      let msgs = batch.slice(3,batch.length);</span>
<a href="#l1.1285"></a><span id="l1.1285" class="difflineminus">-      let subFolder, dstFolder;</span>
<a href="#l1.1286"></a><span id="l1.1286" class="difflineminus">-      let Ci = Components.interfaces;</span>
<a href="#l1.1287"></a><span id="l1.1287" class="difflineminus">-      let identity;</span>
<a href="#l1.1288"></a><span id="l1.1288" class="difflineminus">-      let archiveFolderUri;</span>
<a href="#l1.1289"></a><span id="l1.1289" class="difflineminus">-      if (srcFolder.server.type == 'rss') {</span>
<a href="#l1.1290"></a><span id="l1.1290" class="difflineminus">-        // RSS servers don't have an identity so we special case the archives URI.</span>
<a href="#l1.1291"></a><span id="l1.1291" class="difflineminus">-        archiveFolderUri =  srcFolder.server.serverURI + &quot;/Archives&quot;;</span>
<a href="#l1.1292"></a><span id="l1.1292" class="difflineminus">-      }</span>
<a href="#l1.1293"></a><span id="l1.1293" class="difflineminus">-      else {</span>
<a href="#l1.1294"></a><span id="l1.1294" class="difflineminus">-        identity = getIdentityForHeader(msgs[0]);</span>
<a href="#l1.1295"></a><span id="l1.1295" class="difflineminus">-        archiveFolderUri = identity.archiveFolder;</span>
<a href="#l1.1296"></a><span id="l1.1296" class="difflineminus">-      }</span>
<a href="#l1.1297"></a><span id="l1.1297" class="difflineminus">-      let archiveFolder = GetMsgFolderFromUri(archiveFolderUri, false);</span>
<a href="#l1.1298"></a><span id="l1.1298" class="difflineminus">-      let granularity = archiveFolder.server.archiveGranularity;</span>
<a href="#l1.1299"></a><span id="l1.1299" class="difflineminus">-      let isImap = archiveFolder.server.type == &quot;imap&quot;;</span>
<a href="#l1.1300"></a><span id="l1.1300" class="difflineminus">-      if (!archiveFolder.parent) {</span>
<a href="#l1.1301"></a><span id="l1.1301" class="difflineminus">-        // make sure there's not an other archive folder with</span>
<a href="#l1.1302"></a><span id="l1.1302" class="difflineminus">-        // a case-insensitive (ci) matching name. If so, we're going</span>
<a href="#l1.1303"></a><span id="l1.1303" class="difflineminus">-        // to use that folder instead.</span>
<a href="#l1.1304"></a><span id="l1.1304" class="difflineminus">-        let ciArchive = null;</span>
<a href="#l1.1305"></a><span id="l1.1305" class="difflineminus">-        ciArchive = archiveFolder.server.rootFolder</span>
<a href="#l1.1306"></a><span id="l1.1306" class="difflineminus">-                     .getChildWithURI(archiveFolderUri, true, true);</span>
<a href="#l1.1307"></a><span id="l1.1307" class="difflineminus">-        if (ciArchive)</span>
<a href="#l1.1308"></a><span id="l1.1308" class="difflineminus">-        {</span>
<a href="#l1.1309"></a><span id="l1.1309" class="difflineminus">-          // Found an archive folder with a different case. Switch</span>
<a href="#l1.1310"></a><span id="l1.1310" class="difflineminus">-          // our variables to use the new folder, and if we have an identity,</span>
<a href="#l1.1311"></a><span id="l1.1311" class="difflineminus">-          // make it point to the new folder.</span>
<a href="#l1.1312"></a><span id="l1.1312" class="difflineminus">-          archiveFolder = ciArchive;</span>
<a href="#l1.1313"></a><span id="l1.1313" class="difflineminus">-          archiveFolderUri = ciArchive.URI;</span>
<a href="#l1.1314"></a><span id="l1.1314" class="difflineminus">-          if (identity)</span>
<a href="#l1.1315"></a><span id="l1.1315" class="difflineminus">-            identity.archiveFolder = archiveFolderUri;</span>
<a href="#l1.1316"></a><span id="l1.1316" class="difflineminus">-        }</span>
<a href="#l1.1317"></a><span id="l1.1317" class="difflineminus">-        archiveFolder.setFlag(Ci.nsMsgFolderFlags.Archive);</span>
<a href="#l1.1318"></a><span id="l1.1318" class="difflineminus">-        if (!ciArchive) {</span>
<a href="#l1.1319"></a><span id="l1.1319" class="difflineminus">-          archiveFolder.createStorageIfMissing(this);</span>
<a href="#l1.1320"></a><span id="l1.1320" class="difflineminus">-          // For imap folders, we need to create the sub-folders asynchronously,</span>
<a href="#l1.1321"></a><span id="l1.1321" class="difflineminus">-          // so we return and chain the urls using the listener called back from</span>
<a href="#l1.1322"></a><span id="l1.1322" class="difflineminus">-          // createStorageIfMissing. For local, createStorageIfMissing is</span>
<a href="#l1.1323"></a><span id="l1.1323" class="difflineminus">-          // synchronous.</span>
<a href="#l1.1324"></a><span id="l1.1324" class="difflineminus">-          if (isImap)</span>
<a href="#l1.1325"></a><span id="l1.1325" class="difflineminus">-            return;</span>
<a href="#l1.1326"></a><span id="l1.1326" class="difflineminus">-        }</span>
<a href="#l1.1327"></a><span id="l1.1327" class="difflineminus">-      }</span>
<a href="#l1.1328"></a><span id="l1.1328" class="difflineminus">-      let forceSingle = !archiveFolder.canCreateSubfolders;</span>
<a href="#l1.1329"></a><span id="l1.1329" class="difflineminus">-      if (!forceSingle &amp;&amp; isImap)</span>
<a href="#l1.1330"></a><span id="l1.1330" class="difflineminus">-        forceSingle = archiveFolder.server</span>
<a href="#l1.1331"></a><span id="l1.1331" class="difflineminus">-                       .QueryInterface(Ci.nsIImapIncomingServer).isGMailServer;</span>
<a href="#l1.1332"></a><span id="l1.1332" class="difflineminus">-      if (forceSingle)</span>
<a href="#l1.1333"></a><span id="l1.1333" class="difflineminus">-        granularity = Ci.nsIMsgIncomingServer.singleArchiveFolder;</span>
<a href="#l1.1334"></a><span id="l1.1334" class="difflineminus">-</span>
<a href="#l1.1335"></a><span id="l1.1335" class="difflineminus">-      if (granularity &gt;= Ci.nsIMsgIncomingServer.perYearArchiveFolders) {</span>
<a href="#l1.1336"></a><span id="l1.1336" class="difflineminus">-        archiveFolderUri += &quot;/&quot; + msgYear;</span>
<a href="#l1.1337"></a><span id="l1.1337" class="difflineminus">-        subFolder = GetMsgFolderFromUri(archiveFolderUri, false);</span>
<a href="#l1.1338"></a><span id="l1.1338" class="difflineminus">-        if (!subFolder.parent) {</span>
<a href="#l1.1339"></a><span id="l1.1339" class="difflineminus">-          subFolder.createStorageIfMissing(this);</span>
<a href="#l1.1340"></a><span id="l1.1340" class="difflineminus">-          if (isImap)</span>
<a href="#l1.1341"></a><span id="l1.1341" class="difflineminus">-            return;</span>
<a href="#l1.1342"></a><span id="l1.1342" class="difflineminus">-        }</span>
<a href="#l1.1343"></a><span id="l1.1343" class="difflineminus">-        if (granularity &gt;=  Ci.nsIMsgIncomingServer.perMonthArchiveFolders) {</span>
<a href="#l1.1344"></a><span id="l1.1344" class="difflineminus">-          archiveFolderUri += &quot;/&quot; + msgMonth;</span>
<a href="#l1.1345"></a><span id="l1.1345" class="difflineminus">-          dstFolder = GetMsgFolderFromUri(archiveFolderUri, false);</span>
<a href="#l1.1346"></a><span id="l1.1346" class="difflineminus">-          if (!dstFolder.parent) {</span>
<a href="#l1.1347"></a><span id="l1.1347" class="difflineminus">-            dstFolder.createStorageIfMissing(this);</span>
<a href="#l1.1348"></a><span id="l1.1348" class="difflineminus">-            if (isImap)</span>
<a href="#l1.1349"></a><span id="l1.1349" class="difflineminus">-              return;</span>
<a href="#l1.1350"></a><span id="l1.1350" class="difflineminus">-          }</span>
<a href="#l1.1351"></a><span id="l1.1351" class="difflineminus">-        }</span>
<a href="#l1.1352"></a><span id="l1.1352" class="difflineminus">-        else {</span>
<a href="#l1.1353"></a><span id="l1.1353" class="difflineminus">-          dstFolder = subFolder;</span>
<a href="#l1.1354"></a><span id="l1.1354" class="difflineminus">-        }</span>
<a href="#l1.1355"></a><span id="l1.1355" class="difflineminus">-      }</span>
<a href="#l1.1356"></a><span id="l1.1356" class="difflineminus">-      else {</span>
<a href="#l1.1357"></a><span id="l1.1357" class="difflineminus">-        dstFolder = archiveFolder;</span>
<a href="#l1.1358"></a><span id="l1.1358" class="difflineminus">-      }</span>
<a href="#l1.1359"></a><span id="l1.1359" class="difflineminus">-      if (dstFolder != srcFolder) {</span>
<a href="#l1.1360"></a><span id="l1.1360" class="difflineminus">-        var mutablearray = Components.classes[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l1.1361"></a><span id="l1.1361" class="difflineminus">-                            .createInstance(Components.interfaces.nsIMutableArray);</span>
<a href="#l1.1362"></a><span id="l1.1362" class="difflineminus">-        msgs.forEach(function (item) {</span>
<a href="#l1.1363"></a><span id="l1.1363" class="difflineminus">-          mutablearray.appendElement(item, false);</span>
<a href="#l1.1364"></a><span id="l1.1364" class="difflineminus">-        });</span>
<a href="#l1.1365"></a><span id="l1.1365" class="difflineminus">-        gCopyService.CopyMessages(srcFolder, mutablearray,</span>
<a href="#l1.1366"></a><span id="l1.1366" class="difflineminus">-                                  dstFolder, true, this, msgWindow, true);</span>
<a href="#l1.1367"></a><span id="l1.1367" class="difflineminus">-        this._currentKey = key;</span>
<a href="#l1.1368"></a><span id="l1.1368" class="difflineminus">-        break; // only do one.</span>
<a href="#l1.1369"></a><span id="l1.1369" class="difflineminus">-      }</span>
<a href="#l1.1370"></a><span id="l1.1370" class="difflineminus">-      else {</span>
<a href="#l1.1371"></a><span id="l1.1371" class="difflineminus">-       delete this._batches[key];</span>
<a href="#l1.1372"></a><span id="l1.1372" class="difflineminus">-      }</span>
<a href="#l1.1373"></a><span id="l1.1373" class="difflineminus">-    }</span>
<a href="#l1.1374"></a><span id="l1.1374" class="difflineminus">-  },</span>
<a href="#l1.1375"></a><span id="l1.1375" class="difflineminus">-</span>
<a href="#l1.1376"></a><span id="l1.1376" class="difflineminus">-  OnStartRunningUrl: function(url) {</span>
<a href="#l1.1377"></a><span id="l1.1377" class="difflineminus">-  },</span>
<a href="#l1.1378"></a><span id="l1.1378" class="difflineminus">-</span>
<a href="#l1.1379"></a><span id="l1.1379" class="difflineminus">-  OnStopRunningUrl: function(url, exitCode)</span>
<a href="#l1.1380"></a><span id="l1.1380" class="difflineminus">-  {</span>
<a href="#l1.1381"></a><span id="l1.1381" class="difflineminus">-    // this will always be a create folder url, afaik.</span>
<a href="#l1.1382"></a><span id="l1.1382" class="difflineminus">-    if (Components.isSuccessCode(exitCode))</span>
<a href="#l1.1383"></a><span id="l1.1383" class="difflineminus">-      this.processNextBatch();</span>
<a href="#l1.1384"></a><span id="l1.1384" class="difflineminus">-    else</span>
<a href="#l1.1385"></a><span id="l1.1385" class="difflineminus">-      this._batches = null;</span>
<a href="#l1.1386"></a><span id="l1.1386" class="difflineminus">-  },</span>
<a href="#l1.1387"></a><span id="l1.1387" class="difflineminus">-</span>
<a href="#l1.1388"></a><span id="l1.1388" class="difflineminus">-  // also implements nsIMsgCopyServiceListener, but we only care</span>
<a href="#l1.1389"></a><span id="l1.1389" class="difflineminus">-  // about the OnStopCopy</span>
<a href="#l1.1390"></a><span id="l1.1390" class="difflineminus">-  OnStartCopy: function() {</span>
<a href="#l1.1391"></a><span id="l1.1391" class="difflineminus">-  },</span>
<a href="#l1.1392"></a><span id="l1.1392" class="difflineminus">-  OnProgress: function(aProgress, aProgressMax) {</span>
<a href="#l1.1393"></a><span id="l1.1393" class="difflineminus">-  },</span>
<a href="#l1.1394"></a><span id="l1.1394" class="difflineminus">-  SetMessageKey: function(aKey) {</span>
<a href="#l1.1395"></a><span id="l1.1395" class="difflineminus">-  },</span>
<a href="#l1.1396"></a><span id="l1.1396" class="difflineminus">-  GetMessageId: function() {</span>
<a href="#l1.1397"></a><span id="l1.1397" class="difflineminus">-  },</span>
<a href="#l1.1398"></a><span id="l1.1398" class="difflineminus">-  OnStopCopy: function(aStatus)</span>
<a href="#l1.1399"></a><span id="l1.1399" class="difflineminus">-  {</span>
<a href="#l1.1400"></a><span id="l1.1400" class="difflineminus">-    if (Components.isSuccessCode(aStatus)) {</span>
<a href="#l1.1401"></a><span id="l1.1401" class="difflineminus">-      // remove batch we just finished</span>
<a href="#l1.1402"></a><span id="l1.1402" class="difflineminus">-      delete this._batches[this._currentKey];</span>
<a href="#l1.1403"></a><span id="l1.1403" class="difflineminus">-      this._currentKey = null;</span>
<a href="#l1.1404"></a><span id="l1.1404" class="difflineminus">-</span>
<a href="#l1.1405"></a><span id="l1.1405" class="difflineminus">-      // is there a safe way to test whether this._batches is empty?</span>
<a href="#l1.1406"></a><span id="l1.1406" class="difflineminus">-      let empty = true;</span>
<a href="#l1.1407"></a><span id="l1.1407" class="difflineminus">-      for (let key in this._batches) {</span>
<a href="#l1.1408"></a><span id="l1.1408" class="difflineminus">-        empty = false;</span>
<a href="#l1.1409"></a><span id="l1.1409" class="difflineminus">-      }</span>
<a href="#l1.1410"></a><span id="l1.1410" class="difflineminus">-</span>
<a href="#l1.1411"></a><span id="l1.1411" class="difflineminus">-      if (!empty)</span>
<a href="#l1.1412"></a><span id="l1.1412" class="difflineminus">-        this.processNextBatch();</span>
<a href="#l1.1413"></a><span id="l1.1413" class="difflineminus">-      else // this will select the appropriate next message</span>
<a href="#l1.1414"></a><span id="l1.1414" class="difflineminus">-        gFolderDisplay.hintMassMoveCompleted();</span>
<a href="#l1.1415"></a><span id="l1.1415" class="difflineminus">-    }</span>
<a href="#l1.1416"></a><span id="l1.1416" class="difflineminus">-  },</span>
<a href="#l1.1417"></a><span id="l1.1417" class="difflineminus">-  QueryInterface: function(iid) {</span>
<a href="#l1.1418"></a><span id="l1.1418" class="difflineminus">-    if (!iid.equals(Components.interfaces.nsIUrlListener) &amp;&amp;</span>
<a href="#l1.1419"></a><span id="l1.1419" class="difflineminus">-      !iid.equals(Components.interfaces.nsIMsgCopyServiceListener) &amp;&amp;</span>
<a href="#l1.1420"></a><span id="l1.1420" class="difflineminus">-      !iid.equals(Components.interfaces.nsISupports))</span>
<a href="#l1.1421"></a><span id="l1.1421" class="difflineminus">-      throw Components.results.NS_ERROR_NO_INTERFACE;</span>
<a href="#l1.1422"></a><span id="l1.1422" class="difflineminus">-    return this;</span>
<a href="#l1.1423"></a><span id="l1.1423" class="difflineminus">-  }</span>
<a href="#l1.1424"></a><span id="l1.1424" class="difflineminus">-}</span>
<a href="#l1.1425"></a><span id="l1.1425" class="difflineminus">-</span>
<a href="#l1.1426"></a><span id="l1.1426" class="difflineminus">-function MsgArchiveSelectedMessages(event)</span>
<a href="#l1.1427"></a><span id="l1.1427" class="difflineminus">-{</span>
<a href="#l1.1428"></a><span id="l1.1428" class="difflineminus">-  let batchMover = new BatchMessageMover();</span>
<a href="#l1.1429"></a><span id="l1.1429" class="difflineminus">-  batchMover.archiveSelectedMessages();</span>
<a href="#l1.1430"></a><span id="l1.1430" class="difflineminus">-}</span>
<a href="#l1.1431"></a><span id="l1.1431" class="difflineminus">-</span>
<a href="#l1.1432"></a><span id="l1.1432" class="difflineminus">-function MsgForwardMessage(event)</span>
<a href="#l1.1433"></a><span id="l1.1433" class="difflineminus">-{</span>
<a href="#l1.1434"></a><span id="l1.1434" class="difflineminus">-  var forwardType = 0;</span>
<a href="#l1.1435"></a><span id="l1.1435" class="difflineminus">-  try {</span>
<a href="#l1.1436"></a><span id="l1.1436" class="difflineminus">-    forwardType = gPrefBranch.getIntPref(&quot;mail.forward_message_mode&quot;);</span>
<a href="#l1.1437"></a><span id="l1.1437" class="difflineminus">-  }</span>
<a href="#l1.1438"></a><span id="l1.1438" class="difflineminus">-  catch (ex) {</span>
<a href="#l1.1439"></a><span id="l1.1439" class="difflineminus">-    dump(&quot;failed to retrieve pref mail.forward_message_mode&quot;);</span>
<a href="#l1.1440"></a><span id="l1.1440" class="difflineminus">-  }</span>
<a href="#l1.1441"></a><span id="l1.1441" class="difflineminus">-</span>
<a href="#l1.1442"></a><span id="l1.1442" class="difflineminus">-  // mail.forward_message_mode could be 1, if the user migrated from 4.x</span>
<a href="#l1.1443"></a><span id="l1.1443" class="difflineminus">-  // 1 (forward as quoted) is obsolete, so we treat is as forward inline</span>
<a href="#l1.1444"></a><span id="l1.1444" class="difflineminus">-  // since that is more like forward as quoted then forward as attachment</span>
<a href="#l1.1445"></a><span id="l1.1445" class="difflineminus">-  if (forwardType == 0)</span>
<a href="#l1.1446"></a><span id="l1.1446" class="difflineminus">-    MsgForwardAsAttachment(event);</span>
<a href="#l1.1447"></a><span id="l1.1447" class="difflineminus">-  else</span>
<a href="#l1.1448"></a><span id="l1.1448" class="difflineminus">-    MsgForwardAsInline(event);</span>
<a href="#l1.1449"></a><span id="l1.1449" class="difflineminus">-}</span>
<a href="#l1.1450"></a><span id="l1.1450" class="difflineminus">-</span>
<a href="#l1.1451"></a><span id="l1.1451" class="difflineminus">-function MsgForwardAsAttachment(event)</span>
<a href="#l1.1452"></a><span id="l1.1452" class="difflineminus">-{</span>
<a href="#l1.1453"></a><span id="l1.1453" class="difflineminus">-  composeMsgByType(Components.interfaces.nsIMsgCompType.ForwardAsAttachment, event);</span>
<a href="#l1.1454"></a><span id="l1.1454" class="difflineminus">-}</span>
<a href="#l1.1455"></a><span id="l1.1455" class="difflineminus">-</span>
<a href="#l1.1456"></a><span id="l1.1456" class="difflineminus">-function MsgForwardAsInline(event)</span>
<a href="#l1.1457"></a><span id="l1.1457" class="difflineminus">-{</span>
<a href="#l1.1458"></a><span id="l1.1458" class="difflineminus">-  composeMsgByType(Components.interfaces.nsIMsgCompType.ForwardInline, event);</span>
<a href="#l1.1459"></a><span id="l1.1459" class="difflineminus">-}</span>
<a href="#l1.1460"></a><span id="l1.1460" class="difflineminus">-</span>
<a href="#l1.1461"></a><span id="l1.1461" class="difflineminus">-function MsgEditMessageAsNew()</span>
<a href="#l1.1462"></a><span id="l1.1462" class="difflineminus">-{</span>
<a href="#l1.1463"></a><span id="l1.1463" class="difflineminus">-  composeMsgByType(Components.interfaces.nsIMsgCompType.Template);</span>
<a href="#l1.1464"></a><span id="l1.1464" class="difflineminus">-}</span>
<a href="#l1.1465"></a><span id="l1.1465" class="difflineminus">-</span>
<a href="#l1.1466"></a><span id="l1.1466" class="difflineminus">-function MsgComposeDraftMessage()</span>
<a href="#l1.1467"></a><span id="l1.1467" class="difflineminus">-{</span>
<a href="#l1.1468"></a><span id="l1.1468" class="difflineminus">-  ComposeMessage(Components.interfaces.nsIMsgCompType.Draft,</span>
<a href="#l1.1469"></a><span id="l1.1469" class="difflineminus">-                 Components.interfaces.nsIMsgCompFormat.Default,</span>
<a href="#l1.1470"></a><span id="l1.1470" class="difflineminus">-                 gFolderDisplay.displayedFolder,</span>
<a href="#l1.1471"></a><span id="l1.1471" class="difflineminus">-                 gFolderDisplay.selectedMessageUris);</span>
<a href="#l1.1472"></a><span id="l1.1472" class="difflineminus">-}</span>
<a href="#l1.1473"></a><span id="l1.1473" class="difflineminus">-</span>
<a href="#l1.1474"></a><span id="l1.1474" class="difflineminus">-function MsgCreateFilter()</span>
<a href="#l1.1475"></a><span id="l1.1475" class="difflineminus">-{</span>
<a href="#l1.1476"></a><span id="l1.1476" class="difflineminus">-  // retrieve Sender direct from selected message's headers</span>
<a href="#l1.1477"></a><span id="l1.1477" class="difflineminus">-  var msgHdr = gFolderDisplay.selectedMessage;</span>
<a href="#l1.1478"></a><span id="l1.1478" class="difflineminus">-  var headerParser = Components.classes[&quot;@mozilla.org/messenger/headerparser;1&quot;]</span>
<a href="#l1.1479"></a><span id="l1.1479" class="difflineminus">-                               .getService(Components.interfaces.nsIMsgHeaderParser);</span>
<a href="#l1.1480"></a><span id="l1.1480" class="difflineminus">-  var emailAddress = headerParser.extractHeaderAddressMailboxes(msgHdr.author);</span>
<a href="#l1.1481"></a><span id="l1.1481" class="difflineminus">-  if (emailAddress)</span>
<a href="#l1.1482"></a><span id="l1.1482" class="difflineminus">-    top.MsgFilters(emailAddress, null);</span>
<a href="#l1.1483"></a><span id="l1.1483" class="difflineminus">-}</span>
<a href="#l1.1484"></a><span id="l1.1484" class="difflineminus">-</span>
<a href="#l1.1485"></a><span id="l1.1485" class="difflineminus">-function MsgNewFolder(callBackFunctionName)</span>
<a href="#l1.1486"></a><span id="l1.1486" class="difflineminus">-{</span>
<a href="#l1.1487"></a><span id="l1.1487" class="difflineminus">-  var preselectedFolder = GetFirstSelectedMsgFolder();</span>
<a href="#l1.1488"></a><span id="l1.1488" class="difflineminus">-  var dualUseFolders = true;</span>
<a href="#l1.1489"></a><span id="l1.1489" class="difflineminus">-  var server = null;</span>
<a href="#l1.1490"></a><span id="l1.1490" class="difflineminus">-  var destinationFolder = null;</span>
<a href="#l1.1491"></a><span id="l1.1491" class="difflineminus">-</span>
<a href="#l1.1492"></a><span id="l1.1492" class="difflineminus">-  if (preselectedFolder)</span>
<a href="#l1.1493"></a><span id="l1.1493" class="difflineminus">-  {</span>
<a href="#l1.1494"></a><span id="l1.1494" class="difflineminus">-    try {</span>
<a href="#l1.1495"></a><span id="l1.1495" class="difflineminus">-      server = preselectedFolder.server;</span>
<a href="#l1.1496"></a><span id="l1.1496" class="difflineminus">-      if (server)</span>
<a href="#l1.1497"></a><span id="l1.1497" class="difflineminus">-      {</span>
<a href="#l1.1498"></a><span id="l1.1498" class="difflineminus">-        destinationFolder = getDestinationFolder(preselectedFolder, server);</span>
<a href="#l1.1499"></a><span id="l1.1499" class="difflineminus">-</span>
<a href="#l1.1500"></a><span id="l1.1500" class="difflineminus">-        var imapServer =</span>
<a href="#l1.1501"></a><span id="l1.1501" class="difflineminus">-            server.QueryInterface(Components.interfaces.nsIImapIncomingServer);</span>
<a href="#l1.1502"></a><span id="l1.1502" class="difflineminus">-        if (imapServer)</span>
<a href="#l1.1503"></a><span id="l1.1503" class="difflineminus">-          dualUseFolders = imapServer.dualUseFolders;</span>
<a href="#l1.1504"></a><span id="l1.1504" class="difflineminus">-      }</span>
<a href="#l1.1505"></a><span id="l1.1505" class="difflineminus">-    } catch (e) {</span>
<a href="#l1.1506"></a><span id="l1.1506" class="difflineminus">-        dump (&quot;Exception: dualUseFolders = true\n&quot;);</span>
<a href="#l1.1507"></a><span id="l1.1507" class="difflineminus">-    }</span>
<a href="#l1.1508"></a><span id="l1.1508" class="difflineminus">-  }</span>
<a href="#l1.1509"></a><span id="l1.1509" class="difflineminus">-  window.openDialog(&quot;chrome://messenger/content/newFolderDialog.xul&quot;, &quot;&quot;,</span>
<a href="#l1.1510"></a><span id="l1.1510" class="difflineminus">-                    &quot;chrome,titlebar,modal&quot;,</span>
<a href="#l1.1511"></a><span id="l1.1511" class="difflineminus">-                    {folder: destinationFolder, dualUseFolders: dualUseFolders,</span>
<a href="#l1.1512"></a><span id="l1.1512" class="difflineminus">-                     okCallback:callBackFunctionName});</span>
<a href="#l1.1513"></a><span id="l1.1513" class="difflineminus">-}</span>
<a href="#l1.1514"></a><span id="l1.1514" class="difflineminus">-</span>
<a href="#l1.1515"></a><span id="l1.1515" class="difflineminus">-function getDestinationFolder(preselectedFolder, server)</span>
<a href="#l1.1516"></a><span id="l1.1516" class="difflineminus">-{</span>
<a href="#l1.1517"></a><span id="l1.1517" class="difflineminus">-  var destinationFolder = null;</span>
<a href="#l1.1518"></a><span id="l1.1518" class="difflineminus">-</span>
<a href="#l1.1519"></a><span id="l1.1519" class="difflineminus">-  if (!preselectedFolder.canCreateSubfolders)</span>
<a href="#l1.1520"></a><span id="l1.1520" class="difflineminus">-  {</span>
<a href="#l1.1521"></a><span id="l1.1521" class="difflineminus">-    destinationFolder = server.rootMsgFolder;</span>
<a href="#l1.1522"></a><span id="l1.1522" class="difflineminus">-</span>
<a href="#l1.1523"></a><span id="l1.1523" class="difflineminus">-    var verifyCreateSubfolders = null;</span>
<a href="#l1.1524"></a><span id="l1.1524" class="difflineminus">-    if (destinationFolder)</span>
<a href="#l1.1525"></a><span id="l1.1525" class="difflineminus">-      verifyCreateSubfolders = destinationFolder.canCreateSubfolders;</span>
<a href="#l1.1526"></a><span id="l1.1526" class="difflineminus">-</span>
<a href="#l1.1527"></a><span id="l1.1527" class="difflineminus">-    // In case the server cannot have subfolders, get default account and set</span>
<a href="#l1.1528"></a><span id="l1.1528" class="difflineminus">-    // its incoming server as parent folder.</span>
<a href="#l1.1529"></a><span id="l1.1529" class="difflineminus">-    if (!verifyCreateSubfolders)</span>
<a href="#l1.1530"></a><span id="l1.1530" class="difflineminus">-    {</span>
<a href="#l1.1531"></a><span id="l1.1531" class="difflineminus">-      try {</span>
<a href="#l1.1532"></a><span id="l1.1532" class="difflineminus">-        var defaultFolder = GetDefaultAccountRootFolder();</span>
<a href="#l1.1533"></a><span id="l1.1533" class="difflineminus">-        var checkCreateSubfolders = null;</span>
<a href="#l1.1534"></a><span id="l1.1534" class="difflineminus">-        if (defaultFolder)</span>
<a href="#l1.1535"></a><span id="l1.1535" class="difflineminus">-          checkCreateSubfolders = defaultFolder.canCreateSubfolders;</span>
<a href="#l1.1536"></a><span id="l1.1536" class="difflineminus">-</span>
<a href="#l1.1537"></a><span id="l1.1537" class="difflineminus">-        if (checkCreateSubfolders)</span>
<a href="#l1.1538"></a><span id="l1.1538" class="difflineminus">-          destinationFolder = defaultFolder;</span>
<a href="#l1.1539"></a><span id="l1.1539" class="difflineminus">-</span>
<a href="#l1.1540"></a><span id="l1.1540" class="difflineminus">-      } catch (e) {</span>
<a href="#l1.1541"></a><span id="l1.1541" class="difflineminus">-          dump (&quot;Exception: defaultAccount Not Available\n&quot;);</span>
<a href="#l1.1542"></a><span id="l1.1542" class="difflineminus">-      }</span>
<a href="#l1.1543"></a><span id="l1.1543" class="difflineminus">-    }</span>
<a href="#l1.1544"></a><span id="l1.1544" class="difflineminus">-  }</span>
<a href="#l1.1545"></a><span id="l1.1545" class="difflineminus">-  else</span>
<a href="#l1.1546"></a><span id="l1.1546" class="difflineminus">-    destinationFolder = preselectedFolder;</span>
<a href="#l1.1547"></a><span id="l1.1547" class="difflineminus">-</span>
<a href="#l1.1548"></a><span id="l1.1548" class="difflineminus">-  return destinationFolder;</span>
<a href="#l1.1549"></a><span id="l1.1549" class="difflineminus">-}</span>
<a href="#l1.1550"></a><span id="l1.1550" class="difflineminus">-</span>
<a href="#l1.1551"></a><span id="l1.1551" class="difflineminus">-/** Open subscribe window. */</span>
<a href="#l1.1552"></a><span id="l1.1552" class="difflineminus">-function MsgSubscribe()</span>
<a href="#l1.1553"></a><span id="l1.1553" class="difflineminus">-{</span>
<a href="#l1.1554"></a><span id="l1.1554" class="difflineminus">-  var preselectedFolder = GetFirstSelectedMsgFolder();</span>
<a href="#l1.1555"></a><span id="l1.1555" class="difflineminus">-</span>
<a href="#l1.1556"></a><span id="l1.1556" class="difflineminus">-  if (preselectedFolder &amp;&amp; preselectedFolder.server.type == &quot;rss&quot;)</span>
<a href="#l1.1557"></a><span id="l1.1557" class="difflineminus">-    openSubscriptionsDialog(preselectedFolder); // open feed subscription dialog</span>
<a href="#l1.1558"></a><span id="l1.1558" class="difflineminus">-  else</span>
<a href="#l1.1559"></a><span id="l1.1559" class="difflineminus">-    Subscribe(preselectedFolder); // open imap/nntp subscription dialog</span>
<a href="#l1.1560"></a><span id="l1.1560" class="difflineminus">-}</span>
<a href="#l1.1561"></a><span id="l1.1561" class="difflineminus">-</span>
<a href="#l1.1562"></a><span id="l1.1562" class="difflineminus">-/**</span>
<a href="#l1.1563"></a><span id="l1.1563" class="difflineminus">- * Show a confirmation dialog - check if the user really want to unsubscribe</span>
<a href="#l1.1564"></a><span id="l1.1564" class="difflineminus">- * from the given newsgroup/s.</span>
<a href="#l1.1565"></a><span id="l1.1565" class="difflineminus">- * @folders an array of newsgroup folders to unsubscribe from</span>
<a href="#l1.1566"></a><span id="l1.1566" class="difflineminus">- * @return true if the user said it's ok to unsubscribe</span>
<a href="#l1.1567"></a><span id="l1.1567" class="difflineminus">- */</span>
<a href="#l1.1568"></a><span id="l1.1568" class="difflineminus">-function ConfirmUnsubscribe(folders)</span>
<a href="#l1.1569"></a><span id="l1.1569" class="difflineminus">-{</span>
<a href="#l1.1570"></a><span id="l1.1570" class="difflineminus">-  if (!gMessengerBundle)</span>
<a href="#l1.1571"></a><span id="l1.1571" class="difflineminus">-    gMessengerBundle = document.getElementById(&quot;bundle_messenger&quot;);</span>
<a href="#l1.1572"></a><span id="l1.1572" class="difflineminus">-</span>
<a href="#l1.1573"></a><span id="l1.1573" class="difflineminus">-  var titleMsg = gMessengerBundle.getString(&quot;confirmUnsubscribeTitle&quot;);</span>
<a href="#l1.1574"></a><span id="l1.1574" class="difflineminus">-  var dialogMsg = (folders.length == 1) ?</span>
<a href="#l1.1575"></a><span id="l1.1575" class="difflineminus">-    gMessengerBundle.getFormattedString(&quot;confirmUnsubscribeText&quot;,</span>
<a href="#l1.1576"></a><span id="l1.1576" class="difflineminus">-                                        [folders[0].name], 1) :</span>
<a href="#l1.1577"></a><span id="l1.1577" class="difflineminus">-    gMessengerBundle.getString(&quot;confirmUnsubscribeManyText&quot;);</span>
<a href="#l1.1578"></a><span id="l1.1578" class="difflineminus">-</span>
<a href="#l1.1579"></a><span id="l1.1579" class="difflineminus">-  var promptService = Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l1.1580"></a><span id="l1.1580" class="difflineminus">-                                .getService(Components.interfaces.nsIPromptService);</span>
<a href="#l1.1581"></a><span id="l1.1581" class="difflineminus">-  return promptService.confirm(window, titleMsg, dialogMsg);</span>
<a href="#l1.1582"></a><span id="l1.1582" class="difflineminus">-}</span>
<a href="#l1.1583"></a><span id="l1.1583" class="difflineminus">-</span>
<a href="#l1.1584"></a><span id="l1.1584" class="difflineminus">-/**</span>
<a href="#l1.1585"></a><span id="l1.1585" class="difflineminus">- * Unsubscribe from selected or passed in newsgroup/s.</span>
<a href="#l1.1586"></a><span id="l1.1586" class="difflineminus">- * @param newsgroups (optional param) the newsgroup folders to unsubscribe from</span>
<a href="#l1.1587"></a><span id="l1.1587" class="difflineminus">- */</span>
<a href="#l1.1588"></a><span id="l1.1588" class="difflineminus">-function MsgUnsubscribe(newsgroups)</span>
<a href="#l1.1589"></a><span id="l1.1589" class="difflineminus">-{</span>
<a href="#l1.1590"></a><span id="l1.1590" class="difflineminus">-  var folders = newsgroups || gFolderTreeView.getSelectedFolders();</span>
<a href="#l1.1591"></a><span id="l1.1591" class="difflineminus">-  if (!ConfirmUnsubscribe(folders))</span>
<a href="#l1.1592"></a><span id="l1.1592" class="difflineminus">-    return;</span>
<a href="#l1.1593"></a><span id="l1.1593" class="difflineminus">-</span>
<a href="#l1.1594"></a><span id="l1.1594" class="difflineminus">-  for (let i = 0; i &lt; folders.length; i++) {</span>
<a href="#l1.1595"></a><span id="l1.1595" class="difflineminus">-    let subscribableServer = folders[i].server.QueryInterface(</span>
<a href="#l1.1596"></a><span id="l1.1596" class="difflineminus">-      Components.interfaces.nsISubscribableServer);</span>
<a href="#l1.1597"></a><span id="l1.1597" class="difflineminus">-    subscribableServer.unsubscribe(folders[i].name);</span>
<a href="#l1.1598"></a><span id="l1.1598" class="difflineminus">-    subscribableServer.commitSubscribeChanges();</span>
<a href="#l1.1599"></a><span id="l1.1599" class="difflineminus">-  }</span>
<a href="#l1.1600"></a><span id="l1.1600" class="difflineminus">-}</span>
<a href="#l1.1601"></a><span id="l1.1601" class="difflineminus">-</span>
<a href="#l1.1602"></a><span id="l1.1602" class="difflineminus">-function ToggleFavoriteFolderFlag()</span>
<a href="#l1.1603"></a><span id="l1.1603" class="difflineminus">-{</span>
<a href="#l1.1604"></a><span id="l1.1604" class="difflineminus">-  var folder = GetFirstSelectedMsgFolder();</span>
<a href="#l1.1605"></a><span id="l1.1605" class="difflineminus">-  folder.toggleFlag(Components.interfaces.nsMsgFolderFlags.Favorite);</span>
<a href="#l1.1606"></a><span id="l1.1606" class="difflineminus">-}</span>
<a href="#l1.1607"></a><span id="l1.1607" class="difflineminus">-</span>
<a href="#l1.1608"></a><span id="l1.1608" class="difflineminus">-function MsgSaveAsFile()</span>
<a href="#l1.1609"></a><span id="l1.1609" class="difflineminus">-{</span>
<a href="#l1.1610"></a><span id="l1.1610" class="difflineminus">-  if (GetNumSelectedMessages() == 1)</span>
<a href="#l1.1611"></a><span id="l1.1611" class="difflineminus">-    SaveAsFile(gFolderDisplay.selectedMessageUris[0]);</span>
<a href="#l1.1612"></a><span id="l1.1612" class="difflineminus">-}</span>
<a href="#l1.1613"></a><span id="l1.1613" class="difflineminus">-</span>
<a href="#l1.1614"></a><span id="l1.1614" class="difflineminus">-function MsgSaveAsTemplate()</span>
<a href="#l1.1615"></a><span id="l1.1615" class="difflineminus">-{</span>
<a href="#l1.1616"></a><span id="l1.1616" class="difflineminus">-  if (GetNumSelectedMessages() == 1)</span>
<a href="#l1.1617"></a><span id="l1.1617" class="difflineminus">-    SaveAsTemplate(gFolderDisplay.selectedMessageUris[0],</span>
<a href="#l1.1618"></a><span id="l1.1618" class="difflineminus">-                   gFolderDisplay.displayedFolder);</span>
<a href="#l1.1619"></a><span id="l1.1619" class="difflineminus">-}</span>
<a href="#l1.1620"></a><span id="l1.1620" class="difflineminus">-</span>
<a href="#l1.1621"></a><span id="l1.1621" class="difflineminus">-function CreateToolbarTooltip(document, event)</span>
<a href="#l1.1622"></a><span id="l1.1622" class="difflineminus">-{</span>
<a href="#l1.1623"></a><span id="l1.1623" class="difflineminus">-  event.stopPropagation();</span>
<a href="#l1.1624"></a><span id="l1.1624" class="difflineminus">-  var tn = document.tooltipNode;</span>
<a href="#l1.1625"></a><span id="l1.1625" class="difflineminus">-  if (tn.localName != &quot;tab&quot;)</span>
<a href="#l1.1626"></a><span id="l1.1626" class="difflineminus">-    return false; // Not a tab, so cancel the tooltip.</span>
<a href="#l1.1627"></a><span id="l1.1627" class="difflineminus">-  if (&quot;mOverCloseButton&quot; in tn &amp;&amp; tn.mOverCloseButton) {</span>
<a href="#l1.1628"></a><span id="l1.1628" class="difflineminus">-     event.target.setAttribute(&quot;label&quot;, tn.getAttribute(&quot;closetabtext&quot;));</span>
<a href="#l1.1629"></a><span id="l1.1629" class="difflineminus">-     return true;</span>
<a href="#l1.1630"></a><span id="l1.1630" class="difflineminus">-  }</span>
<a href="#l1.1631"></a><span id="l1.1631" class="difflineminus">-  if (tn.hasAttribute(&quot;label&quot;)) {</span>
<a href="#l1.1632"></a><span id="l1.1632" class="difflineminus">-    event.target.setAttribute(&quot;label&quot;, tn.getAttribute(&quot;label&quot;));</span>
<a href="#l1.1633"></a><span id="l1.1633" class="difflineminus">-    return true;</span>
<a href="#l1.1634"></a><span id="l1.1634" class="difflineminus">-  }</span>
<a href="#l1.1635"></a><span id="l1.1635" class="difflineminus">-  return false;</span>
<a href="#l1.1636"></a><span id="l1.1636" class="difflineminus">-}</span>
<a href="#l1.1637"></a><span id="l1.1637" class="difflineminus">-</span>
<a href="#l1.1638"></a><span id="l1.1638"> /**</span>
<a href="#l1.1639"></a><span id="l1.1639">  * Displays message &quot;folder&quot;s, mail &quot;message&quot;s, and &quot;glodaList&quot; results.  The</span>
<a href="#l1.1640"></a><span id="l1.1640">  *  commonality is that they all use the &quot;mailContent&quot; panel's folder tree,</span>
<a href="#l1.1641"></a><span id="l1.1641">  *  thread tree, and message pane objects.  This happens for historical reasons,</span>
<a href="#l1.1642"></a><span id="l1.1642">  *  likely involving the fact that prior to the introduction of this</span>
<a href="#l1.1643"></a><span id="l1.1643">  *  abstraction, everything was always stored in global objects.  For the 3.0</span>
<a href="#l1.1644"></a><span id="l1.1644">  *  release cycle we considered avoiding this 'multiplexed' style of operation</span>
<a href="#l1.1645"></a><span id="l1.1645">  *  but decided against moving to making each tab be indepdendent because of</span>
<a href="#l1.1646"></a><span id="l1.1646" class="difflineat">@@ -2304,1366 +680,12 @@ let mailTabType = {</span>
<a href="#l1.1647"></a><span id="l1.1647">     // restore focus</span>
<a href="#l1.1648"></a><span id="l1.1648">     this.restoreFocus(aTab);</span>
<a href="#l1.1649"></a><span id="l1.1649">   },</span>
<a href="#l1.1650"></a><span id="l1.1650"> </span>
<a href="#l1.1651"></a><span id="l1.1651">   //</span>
<a href="#l1.1652"></a><span id="l1.1652">   // nsIController implementation</span>
<a href="#l1.1653"></a><span id="l1.1653">   //</span>
<a href="#l1.1654"></a><span id="l1.1654">   // We ignore the aTab parameter sent by tabmail when calling nsIController</span>
<a href="#l1.1655"></a><span id="l1.1655" class="difflineminus">-  // stuff and just delegate the call to a default controller by using it as</span>
<a href="#l1.1656"></a><span id="l1.1656" class="difflineminus">-  // our proto chain:</span>
<a href="#l1.1657"></a><span id="l1.1657" class="difflineminus">-  // - &quot;DefaultController&quot; is the default controller of messenger.xul</span>
<a href="#l1.1658"></a><span id="l1.1658" class="difflineminus">-  // - &quot;MessageWindowController&quot; is the default controller of messageWindow.xul</span>
<a href="#l1.1659"></a><span id="l1.1659" class="difflineminus">-  __proto__: &quot;DefaultController&quot; in window &amp;&amp; window.DefaultController ||</span>
<a href="#l1.1660"></a><span id="l1.1660" class="difflineminus">-             &quot;MessageWindowController&quot; in window &amp;&amp; window.MessageWindowController</span>
<a href="#l1.1661"></a><span id="l1.1661" class="difflineplus">+  // stuff and just delegate the call to the default controller by using it as</span>
<a href="#l1.1662"></a><span id="l1.1662" class="difflineplus">+  // our proto chain.</span>
<a href="#l1.1663"></a><span id="l1.1663" class="difflineplus">+  __proto__: window.DefaultController</span>
<a href="#l1.1664"></a><span id="l1.1664"> };</span>
<a href="#l1.1665"></a><span id="l1.1665" class="difflineminus">-</span>
<a href="#l1.1666"></a><span id="l1.1666" class="difflineminus">-</span>
<a href="#l1.1667"></a><span id="l1.1667" class="difflineminus">-function MsgOpenNewWindowForFolder(folderURI, msgKeyToSelect)</span>
<a href="#l1.1668"></a><span id="l1.1668" class="difflineminus">-{</span>
<a href="#l1.1669"></a><span id="l1.1669" class="difflineminus">-  if (folderURI) {</span>
<a href="#l1.1670"></a><span id="l1.1670" class="difflineminus">-    window.openDialog(&quot;chrome://messenger/content/&quot;, &quot;_blank&quot;,</span>
<a href="#l1.1671"></a><span id="l1.1671" class="difflineminus">-                      &quot;chrome,all,dialog=no&quot;, folderURI, msgKeyToSelect);</span>
<a href="#l1.1672"></a><span id="l1.1672" class="difflineminus">-    return;</span>
<a href="#l1.1673"></a><span id="l1.1673" class="difflineminus">-  }</span>
<a href="#l1.1674"></a><span id="l1.1674" class="difflineminus">-</span>
<a href="#l1.1675"></a><span id="l1.1675" class="difflineminus">-  // If there is a right-click happening, gFolderTreeView.getSelectedFolders()</span>
<a href="#l1.1676"></a><span id="l1.1676" class="difflineminus">-  // will tell us about it (while the selection's currentIndex would reflect</span>
<a href="#l1.1677"></a><span id="l1.1677" class="difflineminus">-  // the node that was selected/displayed before the right-click.)</span>
<a href="#l1.1678"></a><span id="l1.1678" class="difflineminus">-  let selectedFolders = gFolderTreeView.getSelectedFolders();</span>
<a href="#l1.1679"></a><span id="l1.1679" class="difflineminus">-  for (let i = 0; i &lt; selectedFolders.length; i++) {</span>
<a href="#l1.1680"></a><span id="l1.1680" class="difflineminus">-    window.openDialog(&quot;chrome://messenger/content/&quot;, &quot;_blank&quot;,</span>
<a href="#l1.1681"></a><span id="l1.1681" class="difflineminus">-                      &quot;chrome,all,dialog=no&quot;,</span>
<a href="#l1.1682"></a><span id="l1.1682" class="difflineminus">-                      selectedFolders[i].URI, msgKeyToSelect);</span>
<a href="#l1.1683"></a><span id="l1.1683" class="difflineminus">-  }</span>
<a href="#l1.1684"></a><span id="l1.1684" class="difflineminus">-}</span>
<a href="#l1.1685"></a><span id="l1.1685" class="difflineminus">-</span>
<a href="#l1.1686"></a><span id="l1.1686" class="difflineminus">-/**</span>
<a href="#l1.1687"></a><span id="l1.1687" class="difflineminus">- * UI-triggered command to open the currently selected folder(s) in new tabs.</span>
<a href="#l1.1688"></a><span id="l1.1688" class="difflineminus">- * @param aBackground [optional] if true, then the folder tab is opened in the</span>
<a href="#l1.1689"></a><span id="l1.1689" class="difflineminus">- *                    background. If false or not given, then the folder tab is</span>
<a href="#l1.1690"></a><span id="l1.1690" class="difflineminus">- *                    opened in the foreground.</span>
<a href="#l1.1691"></a><span id="l1.1691" class="difflineminus">- */</span>
<a href="#l1.1692"></a><span id="l1.1692" class="difflineminus">-function MsgOpenNewTabForFolder(aBackground)</span>
<a href="#l1.1693"></a><span id="l1.1693" class="difflineminus">-{</span>
<a href="#l1.1694"></a><span id="l1.1694" class="difflineminus">-  // If there is a right-click happening, gFolderTreeView.getSelectedFolders()</span>
<a href="#l1.1695"></a><span id="l1.1695" class="difflineminus">-  // will tell us about it (while the selection's currentIndex would reflect</span>
<a href="#l1.1696"></a><span id="l1.1696" class="difflineminus">-  // the node that was selected/displayed before the right-click.)</span>
<a href="#l1.1697"></a><span id="l1.1697" class="difflineminus">-  let selectedFolders = gFolderTreeView.getSelectedFolders();</span>
<a href="#l1.1698"></a><span id="l1.1698" class="difflineminus">-  for (let i = 0; i &lt; selectedFolders.length; i++) {</span>
<a href="#l1.1699"></a><span id="l1.1699" class="difflineminus">-    document.getElementById(&quot;tabmail&quot;).openTab(&quot;folder&quot;,</span>
<a href="#l1.1700"></a><span id="l1.1700" class="difflineminus">-      {folder: selectedFolders[i], background: aBackground});</span>
<a href="#l1.1701"></a><span id="l1.1701" class="difflineminus">-  }</span>
<a href="#l1.1702"></a><span id="l1.1702" class="difflineminus">-}</span>
<a href="#l1.1703"></a><span id="l1.1703" class="difflineminus">-</span>
<a href="#l1.1704"></a><span id="l1.1704" class="difflineminus">-function MsgOpenSelectedMessages()</span>
<a href="#l1.1705"></a><span id="l1.1705" class="difflineminus">-{</span>
<a href="#l1.1706"></a><span id="l1.1706" class="difflineminus">-  // Toggle message body (rss summary) and content-base url in message</span>
<a href="#l1.1707"></a><span id="l1.1707" class="difflineminus">-  // pane per pref, otherwise open summary or web page in new window.</span>
<a href="#l1.1708"></a><span id="l1.1708" class="difflineminus">-  if (gFolderDisplay.selectedMessageIsFeed &amp;&amp; GetFeedOpenHandler() == 2) {</span>
<a href="#l1.1709"></a><span id="l1.1709" class="difflineminus">-    FeedSetContentViewToggle();</span>
<a href="#l1.1710"></a><span id="l1.1710" class="difflineminus">-    return;</span>
<a href="#l1.1711"></a><span id="l1.1711" class="difflineminus">-  }</span>
<a href="#l1.1712"></a><span id="l1.1712" class="difflineminus">-</span>
<a href="#l1.1713"></a><span id="l1.1713" class="difflineminus">-  // This is somewhat evil. If we're in a 3pane window, we'd have a tabmail</span>
<a href="#l1.1714"></a><span id="l1.1714" class="difflineminus">-  // element and would pass it in here, ensuring that if we open tabs, we use</span>
<a href="#l1.1715"></a><span id="l1.1715" class="difflineminus">-  // this tabmail to open them. If we aren't, then we wouldn't, so</span>
<a href="#l1.1716"></a><span id="l1.1716" class="difflineminus">-  // displayMessages would look for a 3pane window and open tabs there.</span>
<a href="#l1.1717"></a><span id="l1.1717" class="difflineminus">-  MailUtils.displayMessages(gFolderDisplay.selectedMessages,</span>
<a href="#l1.1718"></a><span id="l1.1718" class="difflineminus">-                            gFolderDisplay.view,</span>
<a href="#l1.1719"></a><span id="l1.1719" class="difflineminus">-                            document.getElementById(&quot;tabmail&quot;));</span>
<a href="#l1.1720"></a><span id="l1.1720" class="difflineminus">-}</span>
<a href="#l1.1721"></a><span id="l1.1721" class="difflineminus">-</span>
<a href="#l1.1722"></a><span id="l1.1722" class="difflineminus">-function MsgOpenFromFile()</span>
<a href="#l1.1723"></a><span id="l1.1723" class="difflineminus">-{</span>
<a href="#l1.1724"></a><span id="l1.1724" class="difflineminus">-  const nsIFilePicker = Components.interfaces.nsIFilePicker;</span>
<a href="#l1.1725"></a><span id="l1.1725" class="difflineminus">-  var fp = Components.classes[&quot;@mozilla.org/filepicker;1&quot;]</span>
<a href="#l1.1726"></a><span id="l1.1726" class="difflineminus">-                     .createInstance(nsIFilePicker);</span>
<a href="#l1.1727"></a><span id="l1.1727" class="difflineminus">-</span>
<a href="#l1.1728"></a><span id="l1.1728" class="difflineminus">-  var strBundleService = Components.classes[&quot;@mozilla.org/intl/stringbundle;1&quot;].getService();</span>
<a href="#l1.1729"></a><span id="l1.1729" class="difflineminus">-  strBundleService = strBundleService.QueryInterface(Components.interfaces.nsIStringBundleService);</span>
<a href="#l1.1730"></a><span id="l1.1730" class="difflineminus">-  var extbundle = strBundleService.createBundle(&quot;chrome://messenger/locale/messenger.properties&quot;);</span>
<a href="#l1.1731"></a><span id="l1.1731" class="difflineminus">-  var filterLabel = extbundle.GetStringFromName(&quot;EMLFiles&quot;);</span>
<a href="#l1.1732"></a><span id="l1.1732" class="difflineminus">-  var windowTitle = extbundle.GetStringFromName(&quot;OpenEMLFiles&quot;);</span>
<a href="#l1.1733"></a><span id="l1.1733" class="difflineminus">-</span>
<a href="#l1.1734"></a><span id="l1.1734" class="difflineminus">-  fp.init(window, windowTitle, nsIFilePicker.modeOpen);</span>
<a href="#l1.1735"></a><span id="l1.1735" class="difflineminus">-  fp.appendFilter(filterLabel, &quot;*.eml&quot;);</span>
<a href="#l1.1736"></a><span id="l1.1736" class="difflineminus">-</span>
<a href="#l1.1737"></a><span id="l1.1737" class="difflineminus">-  // Default or last filter is &quot;All Files&quot;.</span>
<a href="#l1.1738"></a><span id="l1.1738" class="difflineminus">-  fp.appendFilters(nsIFilePicker.filterAll);</span>
<a href="#l1.1739"></a><span id="l1.1739" class="difflineminus">-</span>
<a href="#l1.1740"></a><span id="l1.1740" class="difflineminus">-  try {</span>
<a href="#l1.1741"></a><span id="l1.1741" class="difflineminus">-    var ret = fp.show();</span>
<a href="#l1.1742"></a><span id="l1.1742" class="difflineminus">-    if (ret == nsIFilePicker.returnCancel)</span>
<a href="#l1.1743"></a><span id="l1.1743" class="difflineminus">-      return;</span>
<a href="#l1.1744"></a><span id="l1.1744" class="difflineminus">-  }</span>
<a href="#l1.1745"></a><span id="l1.1745" class="difflineminus">-  catch (ex) {</span>
<a href="#l1.1746"></a><span id="l1.1746" class="difflineminus">-    dump(&quot;filePicker.chooseInputFile threw an exception\n&quot;);</span>
<a href="#l1.1747"></a><span id="l1.1747" class="difflineminus">-    return;</span>
<a href="#l1.1748"></a><span id="l1.1748" class="difflineminus">-  }</span>
<a href="#l1.1749"></a><span id="l1.1749" class="difflineminus">-</span>
<a href="#l1.1750"></a><span id="l1.1750" class="difflineminus">-  var uri = fp.fileURL.QueryInterface(Components.interfaces.nsIURL);</span>
<a href="#l1.1751"></a><span id="l1.1751" class="difflineminus">-  uri.query = &quot;type=application/x-message-display&quot;;</span>
<a href="#l1.1752"></a><span id="l1.1752" class="difflineminus">-</span>
<a href="#l1.1753"></a><span id="l1.1753" class="difflineminus">-  window.openDialog(&quot;chrome://messenger/content/messageWindow.xul&quot;, &quot;_blank&quot;,</span>
<a href="#l1.1754"></a><span id="l1.1754" class="difflineminus">-                    &quot;all,chrome,dialog=no,status,toolbar&quot;, uri);</span>
<a href="#l1.1755"></a><span id="l1.1755" class="difflineminus">-}</span>
<a href="#l1.1756"></a><span id="l1.1756" class="difflineminus">-</span>
<a href="#l1.1757"></a><span id="l1.1757" class="difflineminus">-function MsgOpenNewWindowForMessage(aMsgHdr)</span>
<a href="#l1.1758"></a><span id="l1.1758" class="difflineminus">-{</span>
<a href="#l1.1759"></a><span id="l1.1759" class="difflineminus">-  // no message header provided?  get the selected message (this will give us</span>
<a href="#l1.1760"></a><span id="l1.1760" class="difflineminus">-  //  the right-click selected message if that's what is going down.)</span>
<a href="#l1.1761"></a><span id="l1.1761" class="difflineminus">-  if (!aMsgHdr)</span>
<a href="#l1.1762"></a><span id="l1.1762" class="difflineminus">-    aMsgHdr = gFolderDisplay.selectedMessage;</span>
<a href="#l1.1763"></a><span id="l1.1763" class="difflineminus">-</span>
<a href="#l1.1764"></a><span id="l1.1764" class="difflineminus">-  // (there might not have been a selected message, so check...)</span>
<a href="#l1.1765"></a><span id="l1.1765" class="difflineminus">-  if (aMsgHdr)</span>
<a href="#l1.1766"></a><span id="l1.1766" class="difflineminus">-    // we also need to tell the window about our current view so that it can</span>
<a href="#l1.1767"></a><span id="l1.1767" class="difflineminus">-    //  clone it.  This enables advancing through the messages, etc.</span>
<a href="#l1.1768"></a><span id="l1.1768" class="difflineminus">-    window.openDialog(&quot;chrome://messenger/content/messageWindow.xul&quot;, &quot;_blank&quot;,</span>
<a href="#l1.1769"></a><span id="l1.1769" class="difflineminus">-                      &quot;all,chrome,dialog=no,status,toolbar&quot;,</span>
<a href="#l1.1770"></a><span id="l1.1770" class="difflineminus">-                      aMsgHdr, gFolderDisplay.view);</span>
<a href="#l1.1771"></a><span id="l1.1771" class="difflineminus">-}</span>
<a href="#l1.1772"></a><span id="l1.1772" class="difflineminus">-</span>
<a href="#l1.1773"></a><span id="l1.1773" class="difflineminus">-function MsgJunk()</span>
<a href="#l1.1774"></a><span id="l1.1774" class="difflineminus">-{</span>
<a href="#l1.1775"></a><span id="l1.1775" class="difflineminus">-  MsgJunkMailInfo(true);</span>
<a href="#l1.1776"></a><span id="l1.1776" class="difflineminus">-  JunkSelectedMessages(!SelectedMessagesAreJunk());</span>
<a href="#l1.1777"></a><span id="l1.1777" class="difflineminus">-}</span>
<a href="#l1.1778"></a><span id="l1.1778" class="difflineminus">-</span>
<a href="#l1.1779"></a><span id="l1.1779" class="difflineminus">-/**</span>
<a href="#l1.1780"></a><span id="l1.1780" class="difflineminus">- * Update the &quot;mark as junk&quot; button in the message header area.</span>
<a href="#l1.1781"></a><span id="l1.1781" class="difflineminus">- */</span>
<a href="#l1.1782"></a><span id="l1.1782" class="difflineminus">-function UpdateJunkButton()</span>
<a href="#l1.1783"></a><span id="l1.1783" class="difflineminus">-{</span>
<a href="#l1.1784"></a><span id="l1.1784" class="difflineminus">-  // The junk message should slave off the selected message, as the preview pane</span>
<a href="#l1.1785"></a><span id="l1.1785" class="difflineminus">-  //  may not be visible</span>
<a href="#l1.1786"></a><span id="l1.1786" class="difflineminus">-  let hdr = gFolderDisplay.selectedMessage;</span>
<a href="#l1.1787"></a><span id="l1.1787" class="difflineminus">-  // But only the message display knows if we are dealing with a dummy.</span>
<a href="#l1.1788"></a><span id="l1.1788" class="difflineminus">-  if (!hdr || gMessageDisplay.isDummy) // .eml file</span>
<a href="#l1.1789"></a><span id="l1.1789" class="difflineminus">-    return;</span>
<a href="#l1.1790"></a><span id="l1.1790" class="difflineminus">-  let junkScore = hdr.getStringProperty(&quot;junkscore&quot;);</span>
<a href="#l1.1791"></a><span id="l1.1791" class="difflineminus">-  let hideJunk = (junkScore == Components.interfaces.nsIJunkMailPlugin.IS_SPAM_SCORE);</span>
<a href="#l1.1792"></a><span id="l1.1792" class="difflineminus">-  if (!gFolderDisplay.getCommandStatus(nsMsgViewCommandType.junk))</span>
<a href="#l1.1793"></a><span id="l1.1793" class="difflineminus">-    hideJunk = true;</span>
<a href="#l1.1794"></a><span id="l1.1794" class="difflineminus">-</span>
<a href="#l1.1795"></a><span id="l1.1795" class="difflineminus">-  getCurrentMsgHdrButtonBox().getButton('hdrJunkButton').disabled = hideJunk;</span>
<a href="#l1.1796"></a><span id="l1.1796" class="difflineminus">-}</span>
<a href="#l1.1797"></a><span id="l1.1797" class="difflineminus">-</span>
<a href="#l1.1798"></a><span id="l1.1798" class="difflineminus">-function MsgMarkMsgAsRead()</span>
<a href="#l1.1799"></a><span id="l1.1799" class="difflineminus">-{</span>
<a href="#l1.1800"></a><span id="l1.1800" class="difflineminus">-  MarkSelectedMessagesRead(!SelectedMessagesAreRead());</span>
<a href="#l1.1801"></a><span id="l1.1801" class="difflineminus">-}</span>
<a href="#l1.1802"></a><span id="l1.1802" class="difflineminus">-</span>
<a href="#l1.1803"></a><span id="l1.1803" class="difflineminus">-function MsgMarkAsFlagged()</span>
<a href="#l1.1804"></a><span id="l1.1804" class="difflineminus">-{</span>
<a href="#l1.1805"></a><span id="l1.1805" class="difflineminus">-  MarkSelectedMessagesFlagged(!SelectedMessagesAreFlagged());</span>
<a href="#l1.1806"></a><span id="l1.1806" class="difflineminus">-}</span>
<a href="#l1.1807"></a><span id="l1.1807" class="difflineminus">-</span>
<a href="#l1.1808"></a><span id="l1.1808" class="difflineminus">-function MsgMarkReadByDate()</span>
<a href="#l1.1809"></a><span id="l1.1809" class="difflineminus">-{</span>
<a href="#l1.1810"></a><span id="l1.1810" class="difflineminus">-  window.openDialog(&quot;chrome://messenger/content/markByDate.xul&quot;,&quot;&quot;,</span>
<a href="#l1.1811"></a><span id="l1.1811" class="difflineminus">-                    &quot;chrome,modal,titlebar,centerscreen&quot;,</span>
<a href="#l1.1812"></a><span id="l1.1812" class="difflineminus">-                    gFolderDisplay.displayedFolder);</span>
<a href="#l1.1813"></a><span id="l1.1813" class="difflineminus">-}</span>
<a href="#l1.1814"></a><span id="l1.1814" class="difflineminus">-</span>
<a href="#l1.1815"></a><span id="l1.1815" class="difflineminus">-function MsgMarkAllRead()</span>
<a href="#l1.1816"></a><span id="l1.1816" class="difflineminus">-{</span>
<a href="#l1.1817"></a><span id="l1.1817" class="difflineminus">-  let folders = gFolderTreeView.getSelectedFolders();</span>
<a href="#l1.1818"></a><span id="l1.1818" class="difflineminus">-  for (let i = 0; i &lt; folders.length; i++)</span>
<a href="#l1.1819"></a><span id="l1.1819" class="difflineminus">-    folders[i].markAllMessagesRead(msgWindow);</span>
<a href="#l1.1820"></a><span id="l1.1820" class="difflineminus">-}</span>
<a href="#l1.1821"></a><span id="l1.1821" class="difflineminus">-</span>
<a href="#l1.1822"></a><span id="l1.1822" class="difflineminus">-function MsgFilters(emailAddress, folder)</span>
<a href="#l1.1823"></a><span id="l1.1823" class="difflineminus">-{</span>
<a href="#l1.1824"></a><span id="l1.1824" class="difflineminus">-  if (!folder)</span>
<a href="#l1.1825"></a><span id="l1.1825" class="difflineminus">-  {</span>
<a href="#l1.1826"></a><span id="l1.1826" class="difflineminus">-    // Try to determine the folder from the selected message.</span>
<a href="#l1.1827"></a><span id="l1.1827" class="difflineminus">-    if (gDBView)</span>
<a href="#l1.1828"></a><span id="l1.1828" class="difflineminus">-    {</span>
<a href="#l1.1829"></a><span id="l1.1829" class="difflineminus">-      try</span>
<a href="#l1.1830"></a><span id="l1.1830" class="difflineminus">-      {</span>
<a href="#l1.1831"></a><span id="l1.1831" class="difflineminus">-        var msgHdr = gFolderDisplay.selectedMessage;</span>
<a href="#l1.1832"></a><span id="l1.1832" class="difflineminus">-        var accountKey = msgHdr.accountKey;</span>
<a href="#l1.1833"></a><span id="l1.1833" class="difflineminus">-        if (accountKey.length &gt; 0)</span>
<a href="#l1.1834"></a><span id="l1.1834" class="difflineminus">-        {</span>
<a href="#l1.1835"></a><span id="l1.1835" class="difflineminus">-          var account = accountManager.getAccount(accountKey);</span>
<a href="#l1.1836"></a><span id="l1.1836" class="difflineminus">-          if (account)</span>
<a href="#l1.1837"></a><span id="l1.1837" class="difflineminus">-          {</span>
<a href="#l1.1838"></a><span id="l1.1838" class="difflineminus">-            var server = account.incomingServer;</span>
<a href="#l1.1839"></a><span id="l1.1839" class="difflineminus">-            if (server)</span>
<a href="#l1.1840"></a><span id="l1.1840" class="difflineminus">-              folder = server.rootFolder;</span>
<a href="#l1.1841"></a><span id="l1.1841" class="difflineminus">-          }</span>
<a href="#l1.1842"></a><span id="l1.1842" class="difflineminus">-        }</span>
<a href="#l1.1843"></a><span id="l1.1843" class="difflineminus">-      }</span>
<a href="#l1.1844"></a><span id="l1.1844" class="difflineminus">-      catch (ex) {}</span>
<a href="#l1.1845"></a><span id="l1.1845" class="difflineminus">-    }</span>
<a href="#l1.1846"></a><span id="l1.1846" class="difflineminus">-    if (!folder)</span>
<a href="#l1.1847"></a><span id="l1.1847" class="difflineminus">-    {</span>
<a href="#l1.1848"></a><span id="l1.1848" class="difflineminus">-      folder = GetFirstSelectedMsgFolder();</span>
<a href="#l1.1849"></a><span id="l1.1849" class="difflineminus">-      // If this is the local folders account, check if the default account</span>
<a href="#l1.1850"></a><span id="l1.1850" class="difflineminus">-      // defers to it; if so, we'll use the default account so the simple case</span>
<a href="#l1.1851"></a><span id="l1.1851" class="difflineminus">-      // of one pop3 account with the global inbox creates filters for the right server.</span>
<a href="#l1.1852"></a><span id="l1.1852" class="difflineminus">-      if (folder &amp;&amp; folder.server.type == &quot;none&quot; &amp;&amp; folder.server.isDeferredTo)</span>
<a href="#l1.1853"></a><span id="l1.1853" class="difflineminus">-      {</span>
<a href="#l1.1854"></a><span id="l1.1854" class="difflineminus">-        var defaultServer = accountManager.defaultAccount.incomingServer;</span>
<a href="#l1.1855"></a><span id="l1.1855" class="difflineminus">-        if (defaultServer.rootMsgFolder == folder.server.rootFolder)</span>
<a href="#l1.1856"></a><span id="l1.1856" class="difflineminus">-          folder = defaultServer.rootFolder;</span>
<a href="#l1.1857"></a><span id="l1.1857" class="difflineminus">-      }</span>
<a href="#l1.1858"></a><span id="l1.1858" class="difflineminus">-    }</span>
<a href="#l1.1859"></a><span id="l1.1859" class="difflineminus">-  }</span>
<a href="#l1.1860"></a><span id="l1.1860" class="difflineminus">-  var args;</span>
<a href="#l1.1861"></a><span id="l1.1861" class="difflineminus">-  if (emailAddress)</span>
<a href="#l1.1862"></a><span id="l1.1862" class="difflineminus">-  {</span>
<a href="#l1.1863"></a><span id="l1.1863" class="difflineminus">-    // We have to do prefill filter so we are going to launch the</span>
<a href="#l1.1864"></a><span id="l1.1864" class="difflineminus">-    // filterEditor dialog and prefill that with the emailAddress.</span>
<a href="#l1.1865"></a><span id="l1.1865" class="difflineminus">-    args = { filterList: folder.getEditableFilterList(msgWindow) };</span>
<a href="#l1.1866"></a><span id="l1.1866" class="difflineminus">-    args.filterName = emailAddress;</span>
<a href="#l1.1867"></a><span id="l1.1867" class="difflineminus">-    window.openDialog(&quot;chrome://messenger/content/FilterEditor.xul&quot;, &quot;&quot;,</span>
<a href="#l1.1868"></a><span id="l1.1868" class="difflineminus">-                      &quot;chrome, modal, resizable,centerscreen,dialog=yes&quot;, args);</span>
<a href="#l1.1869"></a><span id="l1.1869" class="difflineminus">-</span>
<a href="#l1.1870"></a><span id="l1.1870" class="difflineminus">-    // If the user hits ok in the filterEditor dialog we set args.refresh=true</span>
<a href="#l1.1871"></a><span id="l1.1871" class="difflineminus">-    // there we check this here in args to show filterList dialog.</span>
<a href="#l1.1872"></a><span id="l1.1872" class="difflineminus">-    if (&quot;refresh&quot; in args &amp;&amp; args.refresh)</span>
<a href="#l1.1873"></a><span id="l1.1873" class="difflineminus">-    {</span>
<a href="#l1.1874"></a><span id="l1.1874" class="difflineminus">-      args = { refresh: true, folder: folder };</span>
<a href="#l1.1875"></a><span id="l1.1875" class="difflineminus">-      MsgFilterList(args);</span>
<a href="#l1.1876"></a><span id="l1.1876" class="difflineminus">-    }</span>
<a href="#l1.1877"></a><span id="l1.1877" class="difflineminus">-  }</span>
<a href="#l1.1878"></a><span id="l1.1878" class="difflineminus">-  else  // just launch filterList dialog</span>
<a href="#l1.1879"></a><span id="l1.1879" class="difflineminus">-  {</span>
<a href="#l1.1880"></a><span id="l1.1880" class="difflineminus">-    args = { refresh: false, folder: folder };</span>
<a href="#l1.1881"></a><span id="l1.1881" class="difflineminus">-    MsgFilterList(args);</span>
<a href="#l1.1882"></a><span id="l1.1882" class="difflineminus">-  }</span>
<a href="#l1.1883"></a><span id="l1.1883" class="difflineminus">-}</span>
<a href="#l1.1884"></a><span id="l1.1884" class="difflineminus">-</span>
<a href="#l1.1885"></a><span id="l1.1885" class="difflineminus">-function MsgApplyFilters()</span>
<a href="#l1.1886"></a><span id="l1.1886" class="difflineminus">-{</span>
<a href="#l1.1887"></a><span id="l1.1887" class="difflineminus">-  var filterService = Components.classes[&quot;@mozilla.org/messenger/services/filters;1&quot;]</span>
<a href="#l1.1888"></a><span id="l1.1888" class="difflineminus">-                                .getService(Components.interfaces.nsIMsgFilterService);</span>
<a href="#l1.1889"></a><span id="l1.1889" class="difflineminus">-</span>
<a href="#l1.1890"></a><span id="l1.1890" class="difflineminus">-  var preselectedFolder = GetFirstSelectedMsgFolder();</span>
<a href="#l1.1891"></a><span id="l1.1891" class="difflineminus">-  var selectedFolders = Components.classes[&quot;@mozilla.org/supports-array;1&quot;]</span>
<a href="#l1.1892"></a><span id="l1.1892" class="difflineminus">-                                  .createInstance(Components.interfaces.nsISupportsArray);</span>
<a href="#l1.1893"></a><span id="l1.1893" class="difflineminus">-  selectedFolders.AppendElement(preselectedFolder);</span>
<a href="#l1.1894"></a><span id="l1.1894" class="difflineminus">-</span>
<a href="#l1.1895"></a><span id="l1.1895" class="difflineminus">-  var curFilterList = preselectedFolder.getFilterList(msgWindow);</span>
<a href="#l1.1896"></a><span id="l1.1896" class="difflineminus">-  // create a new filter list and copy over the enabled filters to it.</span>
<a href="#l1.1897"></a><span id="l1.1897" class="difflineminus">-  // We do this instead of having the filter after the fact code ignore</span>
<a href="#l1.1898"></a><span id="l1.1898" class="difflineminus">-  // disabled filters because the Filter Dialog filter after the fact</span>
<a href="#l1.1899"></a><span id="l1.1899" class="difflineminus">-  // code would have to clone filters to allow disabled filters to run,</span>
<a href="#l1.1900"></a><span id="l1.1900" class="difflineminus">-  // and we don't support cloning filters currently.</span>
<a href="#l1.1901"></a><span id="l1.1901" class="difflineminus">-  var tempFilterList = filterService.getTempFilterList(preselectedFolder);</span>
<a href="#l1.1902"></a><span id="l1.1902" class="difflineminus">-  var numFilters = curFilterList.filterCount;</span>
<a href="#l1.1903"></a><span id="l1.1903" class="difflineminus">-  // make sure the temp filter list uses the same log stream</span>
<a href="#l1.1904"></a><span id="l1.1904" class="difflineminus">-  tempFilterList.logStream = curFilterList.logStream;</span>
<a href="#l1.1905"></a><span id="l1.1905" class="difflineminus">-  tempFilterList.loggingEnabled = curFilterList.loggingEnabled;</span>
<a href="#l1.1906"></a><span id="l1.1906" class="difflineminus">-  var newFilterIndex = 0;</span>
<a href="#l1.1907"></a><span id="l1.1907" class="difflineminus">-  for (var i = 0; i &lt; numFilters; i++)</span>
<a href="#l1.1908"></a><span id="l1.1908" class="difflineminus">-  {</span>
<a href="#l1.1909"></a><span id="l1.1909" class="difflineminus">-    var curFilter = curFilterList.getFilterAt(i);</span>
<a href="#l1.1910"></a><span id="l1.1910" class="difflineminus">-    // only add enabled, UI visibile filters that are in the manual context</span>
<a href="#l1.1911"></a><span id="l1.1911" class="difflineminus">-    if (curFilter.enabled &amp;&amp; !curFilter.temporary &amp;&amp;</span>
<a href="#l1.1912"></a><span id="l1.1912" class="difflineminus">-        (curFilter.filterType &amp; Components.interfaces.nsMsgFilterType.Manual))</span>
<a href="#l1.1913"></a><span id="l1.1913" class="difflineminus">-    {</span>
<a href="#l1.1914"></a><span id="l1.1914" class="difflineminus">-      tempFilterList.insertFilterAt(newFilterIndex, curFilter);</span>
<a href="#l1.1915"></a><span id="l1.1915" class="difflineminus">-      newFilterIndex++;</span>
<a href="#l1.1916"></a><span id="l1.1916" class="difflineminus">-    }</span>
<a href="#l1.1917"></a><span id="l1.1917" class="difflineminus">-  }</span>
<a href="#l1.1918"></a><span id="l1.1918" class="difflineminus">-  filterService.applyFiltersToFolders(tempFilterList, selectedFolders, msgWindow);</span>
<a href="#l1.1919"></a><span id="l1.1919" class="difflineminus">-}</span>
<a href="#l1.1920"></a><span id="l1.1920" class="difflineminus">-</span>
<a href="#l1.1921"></a><span id="l1.1921" class="difflineminus">-function MsgApplyFiltersToSelection()</span>
<a href="#l1.1922"></a><span id="l1.1922" class="difflineminus">-{</span>
<a href="#l1.1923"></a><span id="l1.1923" class="difflineminus">-  // bail if we're dealing with a dummy header</span>
<a href="#l1.1924"></a><span id="l1.1924" class="difflineminus">-  if (gMessageDisplay.isDummy)</span>
<a href="#l1.1925"></a><span id="l1.1925" class="difflineminus">-    return;</span>
<a href="#l1.1926"></a><span id="l1.1926" class="difflineminus">-</span>
<a href="#l1.1927"></a><span id="l1.1927" class="difflineminus">-  var selectedMessages = gFolderDisplay.selectedMessages;</span>
<a href="#l1.1928"></a><span id="l1.1928" class="difflineminus">-  if (selectedMessages.length) {</span>
<a href="#l1.1929"></a><span id="l1.1929" class="difflineminus">-    var filterService =</span>
<a href="#l1.1930"></a><span id="l1.1930" class="difflineminus">-      Components.classes[&quot;@mozilla.org/messenger/services/filters;1&quot;]</span>
<a href="#l1.1931"></a><span id="l1.1931" class="difflineminus">-                .getService(Components.interfaces.nsIMsgFilterService);</span>
<a href="#l1.1932"></a><span id="l1.1932" class="difflineminus">-</span>
<a href="#l1.1933"></a><span id="l1.1933" class="difflineminus">-    filterService.applyFilters(Components.interfaces.nsMsgFilterType.Manual,</span>
<a href="#l1.1934"></a><span id="l1.1934" class="difflineminus">-                               toXPCOMArray(selectedMessages,</span>
<a href="#l1.1935"></a><span id="l1.1935" class="difflineminus">-                                            Components.interfaces.nsIMutableArray),</span>
<a href="#l1.1936"></a><span id="l1.1936" class="difflineminus">-                               gFolderDisplay.displayedFolder,</span>
<a href="#l1.1937"></a><span id="l1.1937" class="difflineminus">-                               msgWindow);</span>
<a href="#l1.1938"></a><span id="l1.1938" class="difflineminus">-  }</span>
<a href="#l1.1939"></a><span id="l1.1939" class="difflineminus">-}</span>
<a href="#l1.1940"></a><span id="l1.1940" class="difflineminus">-</span>
<a href="#l1.1941"></a><span id="l1.1941" class="difflineminus">-function ChangeMailLayout(newLayout)</span>
<a href="#l1.1942"></a><span id="l1.1942" class="difflineminus">-{</span>
<a href="#l1.1943"></a><span id="l1.1943" class="difflineminus">-  gPrefBranch.setIntPref(&quot;mail.pane_config.dynamic&quot;, newLayout);</span>
<a href="#l1.1944"></a><span id="l1.1944" class="difflineminus">-}</span>
<a href="#l1.1945"></a><span id="l1.1945" class="difflineminus">-</span>
<a href="#l1.1946"></a><span id="l1.1946" class="difflineminus">-function MsgViewAllHeaders()</span>
<a href="#l1.1947"></a><span id="l1.1947" class="difflineminus">-{</span>
<a href="#l1.1948"></a><span id="l1.1948" class="difflineminus">-  gPrefBranch.setIntPref(&quot;mail.show_headers&quot;, 2);</span>
<a href="#l1.1949"></a><span id="l1.1949" class="difflineminus">-  ReloadMessage();</span>
<a href="#l1.1950"></a><span id="l1.1950" class="difflineminus">-}</span>
<a href="#l1.1951"></a><span id="l1.1951" class="difflineminus">-</span>
<a href="#l1.1952"></a><span id="l1.1952" class="difflineminus">-function MsgViewNormalHeaders()</span>
<a href="#l1.1953"></a><span id="l1.1953" class="difflineminus">-{</span>
<a href="#l1.1954"></a><span id="l1.1954" class="difflineminus">-  gPrefBranch.setIntPref(&quot;mail.show_headers&quot;, 1);</span>
<a href="#l1.1955"></a><span id="l1.1955" class="difflineminus">-  ReloadMessage();</span>
<a href="#l1.1956"></a><span id="l1.1956" class="difflineminus">-}</span>
<a href="#l1.1957"></a><span id="l1.1957" class="difflineminus">-</span>
<a href="#l1.1958"></a><span id="l1.1958" class="difflineminus">-function MsgBodyAllowHTML()</span>
<a href="#l1.1959"></a><span id="l1.1959" class="difflineminus">-{</span>
<a href="#l1.1960"></a><span id="l1.1960" class="difflineminus">-  gPrefBranch.setBoolPref(&quot;mailnews.display.prefer_plaintext&quot;, false);</span>
<a href="#l1.1961"></a><span id="l1.1961" class="difflineminus">-  gPrefBranch.setIntPref(&quot;mailnews.display.html_as&quot;, 0);</span>
<a href="#l1.1962"></a><span id="l1.1962" class="difflineminus">-  gPrefBranch.setIntPref(&quot;mailnews.display.disallow_mime_handlers&quot;, 0);</span>
<a href="#l1.1963"></a><span id="l1.1963" class="difflineminus">-  ReloadMessage();</span>
<a href="#l1.1964"></a><span id="l1.1964" class="difflineminus">-}</span>
<a href="#l1.1965"></a><span id="l1.1965" class="difflineminus">-</span>
<a href="#l1.1966"></a><span id="l1.1966" class="difflineminus">-function MsgBodySanitized()</span>
<a href="#l1.1967"></a><span id="l1.1967" class="difflineminus">-{</span>
<a href="#l1.1968"></a><span id="l1.1968" class="difflineminus">-  gPrefBranch.setBoolPref(&quot;mailnews.display.prefer_plaintext&quot;, false);</span>
<a href="#l1.1969"></a><span id="l1.1969" class="difflineminus">-  gPrefBranch.setIntPref(&quot;mailnews.display.html_as&quot;, 3);</span>
<a href="#l1.1970"></a><span id="l1.1970" class="difflineminus">-  gPrefBranch.setIntPref(&quot;mailnews.display.disallow_mime_handlers&quot;,</span>
<a href="#l1.1971"></a><span id="l1.1971" class="difflineminus">-                         gDisallow_classes_no_html);</span>
<a href="#l1.1972"></a><span id="l1.1972" class="difflineminus">-  ReloadMessage();</span>
<a href="#l1.1973"></a><span id="l1.1973" class="difflineminus">-}</span>
<a href="#l1.1974"></a><span id="l1.1974" class="difflineminus">-</span>
<a href="#l1.1975"></a><span id="l1.1975" class="difflineminus">-function MsgBodyAsPlaintext()</span>
<a href="#l1.1976"></a><span id="l1.1976" class="difflineminus">-{</span>
<a href="#l1.1977"></a><span id="l1.1977" class="difflineminus">-  gPrefBranch.setBoolPref(&quot;mailnews.display.prefer_plaintext&quot;, true);</span>
<a href="#l1.1978"></a><span id="l1.1978" class="difflineminus">-  gPrefBranch.setIntPref(&quot;mailnews.display.html_as&quot;, 1);</span>
<a href="#l1.1979"></a><span id="l1.1979" class="difflineminus">-  gPrefBranch.setIntPref(&quot;mailnews.display.disallow_mime_handlers&quot;,</span>
<a href="#l1.1980"></a><span id="l1.1980" class="difflineminus">-                         gDisallow_classes_no_html);</span>
<a href="#l1.1981"></a><span id="l1.1981" class="difflineminus">-  ReloadMessage();</span>
<a href="#l1.1982"></a><span id="l1.1982" class="difflineminus">-}</span>
<a href="#l1.1983"></a><span id="l1.1983" class="difflineminus">-</span>
<a href="#l1.1984"></a><span id="l1.1984" class="difflineminus">-function MsgFeedBodyRenderPrefs(plaintext, html, mime)</span>
<a href="#l1.1985"></a><span id="l1.1985" class="difflineminus">-{</span>
<a href="#l1.1986"></a><span id="l1.1986" class="difflineminus">-  gPrefBranch.setBoolPref(&quot;rss.display.prefer_plaintext&quot;, plaintext);</span>
<a href="#l1.1987"></a><span id="l1.1987" class="difflineminus">-  gPrefBranch.setIntPref(&quot;rss.display.html_as&quot;, html);</span>
<a href="#l1.1988"></a><span id="l1.1988" class="difflineminus">-  gPrefBranch.setIntPref(&quot;rss.display.disallow_mime_handlers&quot;, mime);</span>
<a href="#l1.1989"></a><span id="l1.1989" class="difflineminus">-  // Reload only if showing rss summary; menuitem hidden if web page..</span>
<a href="#l1.1990"></a><span id="l1.1990" class="difflineminus">-  ReloadMessage();</span>
<a href="#l1.1991"></a><span id="l1.1991" class="difflineminus">-}</span>
<a href="#l1.1992"></a><span id="l1.1992" class="difflineminus">-</span>
<a href="#l1.1993"></a><span id="l1.1993" class="difflineminus">-//How to load message with content-base url on enter in threadpane</span>
<a href="#l1.1994"></a><span id="l1.1994" class="difflineminus">-function GetFeedOpenHandler()</span>
<a href="#l1.1995"></a><span id="l1.1995" class="difflineminus">-{</span>
<a href="#l1.1996"></a><span id="l1.1996" class="difflineminus">-  return gPrefBranch.getIntPref(&quot;rss.show.content-base&quot;);</span>
<a href="#l1.1997"></a><span id="l1.1997" class="difflineminus">-}</span>
<a href="#l1.1998"></a><span id="l1.1998" class="difflineminus">-</span>
<a href="#l1.1999"></a><span id="l1.1999" class="difflineminus">-function ChangeFeedOpenHandler(val)</span>
<a href="#l1.2000"></a><span id="l1.2000" class="difflineminus">-{</span>
<a href="#l1.2001"></a><span id="l1.2001" class="difflineminus">-  gPrefBranch.setIntPref(&quot;rss.show.content-base&quot;, val);</span>
<a href="#l1.2002"></a><span id="l1.2002" class="difflineminus">-}</span>
<a href="#l1.2003"></a><span id="l1.2003" class="difflineminus">-</span>
<a href="#l1.2004"></a><span id="l1.2004" class="difflineminus">-//Current state: load web page if 0, show summary if 1</span>
<a href="#l1.2005"></a><span id="l1.2005" class="difflineminus">-var gShowFeedSummary;</span>
<a href="#l1.2006"></a><span id="l1.2006" class="difflineminus">-var gShowFeedSummaryToggle = false;</span>
<a href="#l1.2007"></a><span id="l1.2007" class="difflineminus">-</span>
<a href="#l1.2008"></a><span id="l1.2008" class="difflineminus">-function ChangeFeedShowSummaryPref(val)</span>
<a href="#l1.2009"></a><span id="l1.2009" class="difflineminus">-{</span>
<a href="#l1.2010"></a><span id="l1.2010" class="difflineminus">-  pref.setIntPref(&quot;rss.show.summary&quot;, val);</span>
<a href="#l1.2011"></a><span id="l1.2011" class="difflineminus">-  ReloadMessage();</span>
<a href="#l1.2012"></a><span id="l1.2012" class="difflineminus">-}</span>
<a href="#l1.2013"></a><span id="l1.2013" class="difflineminus">-</span>
<a href="#l1.2014"></a><span id="l1.2014" class="difflineminus">-function ToggleInlineAttachment(target)</span>
<a href="#l1.2015"></a><span id="l1.2015" class="difflineminus">-{</span>
<a href="#l1.2016"></a><span id="l1.2016" class="difflineminus">-  var viewAttachmentInline = !pref.getBoolPref(&quot;mail.inline_attachments&quot;);</span>
<a href="#l1.2017"></a><span id="l1.2017" class="difflineminus">-  pref.setBoolPref(&quot;mail.inline_attachments&quot;, viewAttachmentInline)</span>
<a href="#l1.2018"></a><span id="l1.2018" class="difflineminus">-  target.setAttribute(&quot;checked&quot;, viewAttachmentInline ? &quot;true&quot; : &quot;false&quot;);</span>
<a href="#l1.2019"></a><span id="l1.2019" class="difflineminus">-  ReloadMessage();</span>
<a href="#l1.2020"></a><span id="l1.2020" class="difflineminus">-}</span>
<a href="#l1.2021"></a><span id="l1.2021" class="difflineminus">-</span>
<a href="#l1.2022"></a><span id="l1.2022" class="difflineminus">-function PrintEnginePrintInternal(doPrintPreview, msgType)</span>
<a href="#l1.2023"></a><span id="l1.2023" class="difflineminus">-{</span>
<a href="#l1.2024"></a><span id="l1.2024" class="difflineminus">-  var messageList = gFolderDisplay.selectedMessageUris;</span>
<a href="#l1.2025"></a><span id="l1.2025" class="difflineminus">-  if (!messageList) {</span>
<a href="#l1.2026"></a><span id="l1.2026" class="difflineminus">-    dump(&quot;PrintEnginePrintInternal(): No messages selected.\n&quot;);</span>
<a href="#l1.2027"></a><span id="l1.2027" class="difflineminus">-    return;</span>
<a href="#l1.2028"></a><span id="l1.2028" class="difflineminus">-  }</span>
<a href="#l1.2029"></a><span id="l1.2029" class="difflineminus">-</span>
<a href="#l1.2030"></a><span id="l1.2030" class="difflineminus">-  window.openDialog(&quot;chrome://messenger/content/msgPrintEngine.xul&quot;, &quot;&quot;,</span>
<a href="#l1.2031"></a><span id="l1.2031" class="difflineminus">-                    &quot;chrome,dialog=no,all,centerscreen&quot;,</span>
<a href="#l1.2032"></a><span id="l1.2032" class="difflineminus">-                    messageList.length, messageList, statusFeedback,</span>
<a href="#l1.2033"></a><span id="l1.2033" class="difflineminus">-                    doPrintPreview, msgType, window);</span>
<a href="#l1.2034"></a><span id="l1.2034" class="difflineminus">-}</span>
<a href="#l1.2035"></a><span id="l1.2035" class="difflineminus">-</span>
<a href="#l1.2036"></a><span id="l1.2036" class="difflineminus">-function PrintEnginePrint()</span>
<a href="#l1.2037"></a><span id="l1.2037" class="difflineminus">-{</span>
<a href="#l1.2038"></a><span id="l1.2038" class="difflineminus">-  return PrintEnginePrintInternal(false,</span>
<a href="#l1.2039"></a><span id="l1.2039" class="difflineminus">-    Components.interfaces.nsIMsgPrintEngine.MNAB_PRINT_MSG);</span>
<a href="#l1.2040"></a><span id="l1.2040" class="difflineminus">-}</span>
<a href="#l1.2041"></a><span id="l1.2041" class="difflineminus">-</span>
<a href="#l1.2042"></a><span id="l1.2042" class="difflineminus">-function PrintEnginePrintPreview()</span>
<a href="#l1.2043"></a><span id="l1.2043" class="difflineminus">-{</span>
<a href="#l1.2044"></a><span id="l1.2044" class="difflineminus">-  return PrintEnginePrintInternal(true,</span>
<a href="#l1.2045"></a><span id="l1.2045" class="difflineminus">-    Components.interfaces.nsIMsgPrintEngine.MNAB_PRINTPREVIEW_MSG);</span>
<a href="#l1.2046"></a><span id="l1.2046" class="difflineminus">-}</span>
<a href="#l1.2047"></a><span id="l1.2047" class="difflineminus">-</span>
<a href="#l1.2048"></a><span id="l1.2048" class="difflineminus">-function IsMailFolderSelected()</span>
<a href="#l1.2049"></a><span id="l1.2049" class="difflineminus">-{</span>
<a href="#l1.2050"></a><span id="l1.2050" class="difflineminus">-  var selectedFolders = GetSelectedMsgFolders();</span>
<a href="#l1.2051"></a><span id="l1.2051" class="difflineminus">-  var folder = selectedFolders.length ? selectedFolders[0] : null;</span>
<a href="#l1.2052"></a><span id="l1.2052" class="difflineminus">-  return folder &amp;&amp; folder.server.type != &quot;nntp&quot;;</span>
<a href="#l1.2053"></a><span id="l1.2053" class="difflineminus">-}</span>
<a href="#l1.2054"></a><span id="l1.2054" class="difflineminus">-</span>
<a href="#l1.2055"></a><span id="l1.2055" class="difflineminus">-function IsGetNextNMessagesEnabled()</span>
<a href="#l1.2056"></a><span id="l1.2056" class="difflineminus">-{</span>
<a href="#l1.2057"></a><span id="l1.2057" class="difflineminus">-  var selectedFolders = GetSelectedMsgFolders();</span>
<a href="#l1.2058"></a><span id="l1.2058" class="difflineminus">-  var folder = selectedFolders.length ? selectedFolders[0] : null;</span>
<a href="#l1.2059"></a><span id="l1.2059" class="difflineminus">-</span>
<a href="#l1.2060"></a><span id="l1.2060" class="difflineminus">-  var menuItem = document.getElementById(&quot;menu_getnextnmsg&quot;);</span>
<a href="#l1.2061"></a><span id="l1.2061" class="difflineminus">-  if (folder &amp;&amp; !folder.isServer &amp;&amp;</span>
<a href="#l1.2062"></a><span id="l1.2062" class="difflineminus">-      folder.server instanceof Components.interfaces.nsINntpIncomingServer) {</span>
<a href="#l1.2063"></a><span id="l1.2063" class="difflineminus">-    var menuLabel = gMessengerBundle.getFormattedString(&quot;getNextNMessages&quot;,</span>
<a href="#l1.2064"></a><span id="l1.2064" class="difflineminus">-                                                        [folder.server.maxArticles]);</span>
<a href="#l1.2065"></a><span id="l1.2065" class="difflineminus">-    menuItem.setAttribute(&quot;label&quot;, menuLabel);</span>
<a href="#l1.2066"></a><span id="l1.2066" class="difflineminus">-    menuItem.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l1.2067"></a><span id="l1.2067" class="difflineminus">-    return true;</span>
<a href="#l1.2068"></a><span id="l1.2068" class="difflineminus">-  }</span>
<a href="#l1.2069"></a><span id="l1.2069" class="difflineminus">-</span>
<a href="#l1.2070"></a><span id="l1.2070" class="difflineminus">-  menuItem.setAttribute(&quot;hidden&quot;,&quot;true&quot;);</span>
<a href="#l1.2071"></a><span id="l1.2071" class="difflineminus">-  return false;</span>
<a href="#l1.2072"></a><span id="l1.2072" class="difflineminus">-}</span>
<a href="#l1.2073"></a><span id="l1.2073" class="difflineminus">-</span>
<a href="#l1.2074"></a><span id="l1.2074" class="difflineminus">-function SetUpToolbarButtons(uri)</span>
<a href="#l1.2075"></a><span id="l1.2075" class="difflineminus">-{</span>
<a href="#l1.2076"></a><span id="l1.2076" class="difflineminus">-  var deleteButton = document.getElementById(&quot;button-delete&quot;);</span>
<a href="#l1.2077"></a><span id="l1.2077" class="difflineminus">-  if (!deleteButton)</span>
<a href="#l1.2078"></a><span id="l1.2078" class="difflineminus">-    return;</span>
<a href="#l1.2079"></a><span id="l1.2079" class="difflineminus">-</span>
<a href="#l1.2080"></a><span id="l1.2080" class="difflineminus">-  // Eventually, we might want to set up the toolbar differently for imap,</span>
<a href="#l1.2081"></a><span id="l1.2081" class="difflineminus">-  // pop, and news.  For now, just tweak it based on if it is news or not.</span>
<a href="#l1.2082"></a><span id="l1.2082" class="difflineminus">-  if (isNewsURI(uri))</span>
<a href="#l1.2083"></a><span id="l1.2083" class="difflineminus">-    deleteButton.setAttribute('hidden', true);</span>
<a href="#l1.2084"></a><span id="l1.2084" class="difflineminus">-  else</span>
<a href="#l1.2085"></a><span id="l1.2085" class="difflineminus">-    deleteButton.removeAttribute('hidden');</span>
<a href="#l1.2086"></a><span id="l1.2086" class="difflineminus">-}</span>
<a href="#l1.2087"></a><span id="l1.2087" class="difflineminus">-</span>
<a href="#l1.2088"></a><span id="l1.2088" class="difflineminus">-function MsgSynchronizeOffline()</span>
<a href="#l1.2089"></a><span id="l1.2089" class="difflineminus">-{</span>
<a href="#l1.2090"></a><span id="l1.2090" class="difflineminus">-  window.openDialog(&quot;chrome://messenger/content/msgSynchronize.xul&quot;, &quot;&quot;,</span>
<a href="#l1.2091"></a><span id="l1.2091" class="difflineminus">-                    &quot;centerscreen,chrome,modal,titlebar,resizable=yes&quot;,</span>
<a href="#l1.2092"></a><span id="l1.2092" class="difflineminus">-                    {msgWindow:msgWindow});</span>
<a href="#l1.2093"></a><span id="l1.2093" class="difflineminus">-}</span>
<a href="#l1.2094"></a><span id="l1.2094" class="difflineminus">-</span>
<a href="#l1.2095"></a><span id="l1.2095" class="difflineminus">-function SpaceHit(event)</span>
<a href="#l1.2096"></a><span id="l1.2096" class="difflineminus">-{</span>
<a href="#l1.2097"></a><span id="l1.2097" class="difflineminus">-  var contentWindow = document.commandDispatcher.focusedWindow;</span>
<a href="#l1.2098"></a><span id="l1.2098" class="difflineminus">-  // If focus is in chrome, we want to scroll the content window; if focus is</span>
<a href="#l1.2099"></a><span id="l1.2099" class="difflineminus">-  // on a non-link content element like a button, bail so we don't scroll when</span>
<a href="#l1.2100"></a><span id="l1.2100" class="difflineminus">-  // the element is going to do something else.</span>
<a href="#l1.2101"></a><span id="l1.2101" class="difflineminus">-  if (contentWindow.top == window)</span>
<a href="#l1.2102"></a><span id="l1.2102" class="difflineminus">-    contentWindow = content;</span>
<a href="#l1.2103"></a><span id="l1.2103" class="difflineminus">-  else if (document.commandDispatcher.focusedElement &amp;&amp;</span>
<a href="#l1.2104"></a><span id="l1.2104" class="difflineminus">-           !hRefForClickEvent(event))</span>
<a href="#l1.2105"></a><span id="l1.2105" class="difflineminus">-    return;</span>
<a href="#l1.2106"></a><span id="l1.2106" class="difflineminus">-</span>
<a href="#l1.2107"></a><span id="l1.2107" class="difflineminus">-  var rssiframe = contentWindow.document.getElementById('_mailrssiframe');</span>
<a href="#l1.2108"></a><span id="l1.2108" class="difflineminus">-  // If we are displaying an RSS article, we really want to scroll</span>
<a href="#l1.2109"></a><span id="l1.2109" class="difflineminus">-  // the nested iframe.</span>
<a href="#l1.2110"></a><span id="l1.2110" class="difflineminus">-  if (contentWindow == content &amp;&amp; rssiframe)</span>
<a href="#l1.2111"></a><span id="l1.2111" class="difflineminus">-    contentWindow = rssiframe.contentWindow;</span>
<a href="#l1.2112"></a><span id="l1.2112" class="difflineminus">-</span>
<a href="#l1.2113"></a><span id="l1.2113" class="difflineminus">-  if (event &amp;&amp; event.shiftKey) {</span>
<a href="#l1.2114"></a><span id="l1.2114" class="difflineminus">-    // if at the start of the message, go to the previous one</span>
<a href="#l1.2115"></a><span id="l1.2115" class="difflineminus">-    if (contentWindow.scrollY &gt; 0)</span>
<a href="#l1.2116"></a><span id="l1.2116" class="difflineminus">-      contentWindow.scrollByPages(-1);</span>
<a href="#l1.2117"></a><span id="l1.2117" class="difflineminus">-    else</span>
<a href="#l1.2118"></a><span id="l1.2118" class="difflineminus">-      goDoCommand(&quot;cmd_previousUnreadMsg&quot;);</span>
<a href="#l1.2119"></a><span id="l1.2119" class="difflineminus">-  }</span>
<a href="#l1.2120"></a><span id="l1.2120" class="difflineminus">-  else {</span>
<a href="#l1.2121"></a><span id="l1.2121" class="difflineminus">-    // if at the end of the message, go to the next one</span>
<a href="#l1.2122"></a><span id="l1.2122" class="difflineminus">-    if (contentWindow.scrollY &lt; contentWindow.scrollMaxY)</span>
<a href="#l1.2123"></a><span id="l1.2123" class="difflineminus">-      contentWindow.scrollByPages(1);</span>
<a href="#l1.2124"></a><span id="l1.2124" class="difflineminus">-    else</span>
<a href="#l1.2125"></a><span id="l1.2125" class="difflineminus">-      goDoCommand(&quot;cmd_nextUnreadMsg&quot;);</span>
<a href="#l1.2126"></a><span id="l1.2126" class="difflineminus">-  }</span>
<a href="#l1.2127"></a><span id="l1.2127" class="difflineminus">-}</span>
<a href="#l1.2128"></a><span id="l1.2128" class="difflineminus">-</span>
<a href="#l1.2129"></a><span id="l1.2129" class="difflineminus">-function IsAccountOfflineEnabled()</span>
<a href="#l1.2130"></a><span id="l1.2130" class="difflineminus">-{</span>
<a href="#l1.2131"></a><span id="l1.2131" class="difflineminus">-  var selectedFolders = GetSelectedMsgFolders();</span>
<a href="#l1.2132"></a><span id="l1.2132" class="difflineminus">-</span>
<a href="#l1.2133"></a><span id="l1.2133" class="difflineminus">-  if (selectedFolders &amp;&amp; (selectedFolders.length == 1))</span>
<a href="#l1.2134"></a><span id="l1.2134" class="difflineminus">-      return selectedFolders[0].supportsOffline;</span>
<a href="#l1.2135"></a><span id="l1.2135" class="difflineminus">-  return false;</span>
<a href="#l1.2136"></a><span id="l1.2136" class="difflineminus">-}</span>
<a href="#l1.2137"></a><span id="l1.2137" class="difflineminus">-</span>
<a href="#l1.2138"></a><span id="l1.2138" class="difflineminus">-function GetDefaultAccountRootFolder()</span>
<a href="#l1.2139"></a><span id="l1.2139" class="difflineminus">-{</span>
<a href="#l1.2140"></a><span id="l1.2140" class="difflineminus">-  try {</span>
<a href="#l1.2141"></a><span id="l1.2141" class="difflineminus">-    var account = accountManager.defaultAccount;</span>
<a href="#l1.2142"></a><span id="l1.2142" class="difflineminus">-    var defaultServer = account.incomingServer;</span>
<a href="#l1.2143"></a><span id="l1.2143" class="difflineminus">-    var defaultFolder = defaultServer.rootMsgFolder;</span>
<a href="#l1.2144"></a><span id="l1.2144" class="difflineminus">-    return defaultFolder;</span>
<a href="#l1.2145"></a><span id="l1.2145" class="difflineminus">-  }</span>
<a href="#l1.2146"></a><span id="l1.2146" class="difflineminus">-  catch (ex) {</span>
<a href="#l1.2147"></a><span id="l1.2147" class="difflineminus">-  }</span>
<a href="#l1.2148"></a><span id="l1.2148" class="difflineminus">-  return null;</span>
<a href="#l1.2149"></a><span id="l1.2149" class="difflineminus">-}</span>
<a href="#l1.2150"></a><span id="l1.2150" class="difflineminus">-</span>
<a href="#l1.2151"></a><span id="l1.2151" class="difflineminus">-/**</span>
<a href="#l1.2152"></a><span id="l1.2152" class="difflineminus">- * Check for new messages for all selected folders, or for the default account</span>
<a href="#l1.2153"></a><span id="l1.2153" class="difflineminus">- * in case no folders are selected.</span>
<a href="#l1.2154"></a><span id="l1.2154" class="difflineminus">- */</span>
<a href="#l1.2155"></a><span id="l1.2155" class="difflineminus">-function GetFolderMessages()</span>
<a href="#l1.2156"></a><span id="l1.2156" class="difflineminus">-{</span>
<a href="#l1.2157"></a><span id="l1.2157" class="difflineminus">-  var selectedFolders = GetSelectedMsgFolders();</span>
<a href="#l1.2158"></a><span id="l1.2158" class="difflineminus">-  var defaultAccountRootFolder = GetDefaultAccountRootFolder();</span>
<a href="#l1.2159"></a><span id="l1.2159" class="difflineminus">-</span>
<a href="#l1.2160"></a><span id="l1.2160" class="difflineminus">-  // if no default account, get msg isn't going do anything anyways</span>
<a href="#l1.2161"></a><span id="l1.2161" class="difflineminus">-  // so bail out</span>
<a href="#l1.2162"></a><span id="l1.2162" class="difflineminus">-  if (!defaultAccountRootFolder)</span>
<a href="#l1.2163"></a><span id="l1.2163" class="difflineminus">-    return;</span>
<a href="#l1.2164"></a><span id="l1.2164" class="difflineminus">-</span>
<a href="#l1.2165"></a><span id="l1.2165" class="difflineminus">-  // if nothing selected, use the default</span>
<a href="#l1.2166"></a><span id="l1.2166" class="difflineminus">-  var folders = (selectedFolders.length) ? selectedFolders : [defaultAccountRootFolder];</span>
<a href="#l1.2167"></a><span id="l1.2167" class="difflineminus">-  for (var i = 0; i &lt; folders.length; i++) {</span>
<a href="#l1.2168"></a><span id="l1.2168" class="difflineminus">-    var serverType = folders[i].server.type;</span>
<a href="#l1.2169"></a><span id="l1.2169" class="difflineminus">-    if (folders[i].isServer &amp;&amp; (serverType == &quot;nntp&quot;)) {</span>
<a href="#l1.2170"></a><span id="l1.2170" class="difflineminus">-      // If we're doing &quot;get msgs&quot; on a news server,</span>
<a href="#l1.2171"></a><span id="l1.2171" class="difflineminus">-      // update unread counts on this server.</span>
<a href="#l1.2172"></a><span id="l1.2172" class="difflineminus">-      folders[i].server.performExpand(msgWindow);</span>
<a href="#l1.2173"></a><span id="l1.2173" class="difflineminus">-    }</span>
<a href="#l1.2174"></a><span id="l1.2174" class="difflineminus">-    else if (serverType == &quot;none&quot;) {</span>
<a href="#l1.2175"></a><span id="l1.2175" class="difflineminus">-      // If &quot;Local Folders&quot; is selected and the user does &quot;Get Msgs&quot; and</span>
<a href="#l1.2176"></a><span id="l1.2176" class="difflineminus">-      // LocalFolders is not deferred to, get new mail for the default account</span>
<a href="#l1.2177"></a><span id="l1.2177" class="difflineminus">-      //</span>
<a href="#l1.2178"></a><span id="l1.2178" class="difflineminus">-      // XXX TODO</span>
<a href="#l1.2179"></a><span id="l1.2179" class="difflineminus">-      // Should shift click get mail for all (authenticated) accounts?</span>
<a href="#l1.2180"></a><span id="l1.2180" class="difflineminus">-      // see bug #125885.</span>
<a href="#l1.2181"></a><span id="l1.2181" class="difflineminus">-      if (!folders[i].server.isDeferredTo)</span>
<a href="#l1.2182"></a><span id="l1.2182" class="difflineminus">-        GetNewMsgs(defaultAccountRootFolder.server, defaultAccountRootFolder);</span>
<a href="#l1.2183"></a><span id="l1.2183" class="difflineminus">-      else</span>
<a href="#l1.2184"></a><span id="l1.2184" class="difflineminus">-        GetNewMsgs(folders[i].server, folders[i]);</span>
<a href="#l1.2185"></a><span id="l1.2185" class="difflineminus">-    }</span>
<a href="#l1.2186"></a><span id="l1.2186" class="difflineminus">-    else {</span>
<a href="#l1.2187"></a><span id="l1.2187" class="difflineminus">-      GetNewMsgs(folders[i].server, folders[i]);</span>
<a href="#l1.2188"></a><span id="l1.2188" class="difflineminus">-    }</span>
<a href="#l1.2189"></a><span id="l1.2189" class="difflineminus">-  }</span>
<a href="#l1.2190"></a><span id="l1.2190" class="difflineminus">-}</span>
<a href="#l1.2191"></a><span id="l1.2191" class="difflineminus">-</span>
<a href="#l1.2192"></a><span id="l1.2192" class="difflineminus">-/**</span>
<a href="#l1.2193"></a><span id="l1.2193" class="difflineminus">- * Gets new messages for the given server, for the given folder.</span>
<a href="#l1.2194"></a><span id="l1.2194" class="difflineminus">- * @param server which nsIMsgIncomingServer to check for new messages</span>
<a href="#l1.2195"></a><span id="l1.2195" class="difflineminus">- * @param folder which nsIMsgFolder folder to check for new messages</span>
<a href="#l1.2196"></a><span id="l1.2196" class="difflineminus">- */</span>
<a href="#l1.2197"></a><span id="l1.2197" class="difflineminus">-function GetNewMsgs(server, folder)</span>
<a href="#l1.2198"></a><span id="l1.2198" class="difflineminus">-{</span>
<a href="#l1.2199"></a><span id="l1.2199" class="difflineminus">-  // Note that for Global Inbox folder.server != server when we want to get</span>
<a href="#l1.2200"></a><span id="l1.2200" class="difflineminus">-  // messages for a specific account.</span>
<a href="#l1.2201"></a><span id="l1.2201" class="difflineminus">-</span>
<a href="#l1.2202"></a><span id="l1.2202" class="difflineminus">-  const nsIMsgFolder = Components.interfaces.nsIMsgFolder;</span>
<a href="#l1.2203"></a><span id="l1.2203" class="difflineminus">-  // Whenever we do get new messages, clear the old new messages.</span>
<a href="#l1.2204"></a><span id="l1.2204" class="difflineminus">-  folder.biffState = nsIMsgFolder.nsMsgBiffState_NoMail;</span>
<a href="#l1.2205"></a><span id="l1.2205" class="difflineminus">-  folder.clearNewMessages();</span>
<a href="#l1.2206"></a><span id="l1.2206" class="difflineminus">-  server.getNewMessages(folder, msgWindow, null);</span>
<a href="#l1.2207"></a><span id="l1.2207" class="difflineminus">-}</span>
<a href="#l1.2208"></a><span id="l1.2208" class="difflineminus">-</span>
<a href="#l1.2209"></a><span id="l1.2209" class="difflineminus">-function SendUnsentMessages()</span>
<a href="#l1.2210"></a><span id="l1.2210" class="difflineminus">-{</span>
<a href="#l1.2211"></a><span id="l1.2211" class="difflineminus">-  var msgSendlater = Components.classes[&quot;@mozilla.org/messengercompose/sendlater;1&quot;]</span>
<a href="#l1.2212"></a><span id="l1.2212" class="difflineminus">-                               .getService(Components.interfaces.nsIMsgSendLater);</span>
<a href="#l1.2213"></a><span id="l1.2213" class="difflineminus">-</span>
<a href="#l1.2214"></a><span id="l1.2214" class="difflineminus">-  var accountManager = Components.classes[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l1.2215"></a><span id="l1.2215" class="difflineminus">-                                 .getService(Components.interfaces.nsIMsgAccountManager);</span>
<a href="#l1.2216"></a><span id="l1.2216" class="difflineminus">-  var allIdentities = accountManager.allIdentities;</span>
<a href="#l1.2217"></a><span id="l1.2217" class="difflineminus">-  var identitiesCount = allIdentities.Count();</span>
<a href="#l1.2218"></a><span id="l1.2218" class="difflineminus">-  for (var i = 0; i &lt; identitiesCount; i++) {</span>
<a href="#l1.2219"></a><span id="l1.2219" class="difflineminus">-    var currentIdentity = allIdentities.QueryElementAt(i, Components.interfaces.nsIMsgIdentity);</span>
<a href="#l1.2220"></a><span id="l1.2220" class="difflineminus">-    var msgFolder = msgSendlater.getUnsentMessagesFolder(currentIdentity);</span>
<a href="#l1.2221"></a><span id="l1.2221" class="difflineminus">-    if (msgFolder) {</span>
<a href="#l1.2222"></a><span id="l1.2222" class="difflineminus">-      var numMessages = msgFolder.getTotalMessages(false /* include subfolders */);</span>
<a href="#l1.2223"></a><span id="l1.2223" class="difflineminus">-      if(numMessages &gt; 0) {</span>
<a href="#l1.2224"></a><span id="l1.2224" class="difflineminus">-        msgSendlater.sendUnsentMessages(currentIdentity);</span>
<a href="#l1.2225"></a><span id="l1.2225" class="difflineminus">-        // Right now, all identities point to the same unsent messages</span>
<a href="#l1.2226"></a><span id="l1.2226" class="difflineminus">-        // folder, so to avoid sending multiple copies of the</span>
<a href="#l1.2227"></a><span id="l1.2227" class="difflineminus">-        // unsent messages, we only call messenger.SendUnsentMessages() once.</span>
<a href="#l1.2228"></a><span id="l1.2228" class="difflineminus">-        // See bug #89150 for details.</span>
<a href="#l1.2229"></a><span id="l1.2229" class="difflineminus">-        break;</span>
<a href="#l1.2230"></a><span id="l1.2230" class="difflineminus">-      }</span>
<a href="#l1.2231"></a><span id="l1.2231" class="difflineminus">-    }</span>
<a href="#l1.2232"></a><span id="l1.2232" class="difflineminus">-  }</span>
<a href="#l1.2233"></a><span id="l1.2233" class="difflineminus">-}</span>
<a href="#l1.2234"></a><span id="l1.2234" class="difflineminus">-</span>
<a href="#l1.2235"></a><span id="l1.2235" class="difflineminus">-function CoalesceGetMsgsForPop3ServersByDestFolder(currentServer,</span>
<a href="#l1.2236"></a><span id="l1.2236" class="difflineminus">-                                                   pop3DownloadServersArray,</span>
<a href="#l1.2237"></a><span id="l1.2237" class="difflineminus">-                                                   localFoldersToDownloadTo)</span>
<a href="#l1.2238"></a><span id="l1.2238" class="difflineminus">-{</span>
<a href="#l1.2239"></a><span id="l1.2239" class="difflineminus">-  var outNumFolders = new Object();</span>
<a href="#l1.2240"></a><span id="l1.2240" class="difflineminus">-  const kInboxFlag = Components.interfaces.nsMsgFolderFlags.Inbox;</span>
<a href="#l1.2241"></a><span id="l1.2241" class="difflineminus">-  var inboxFolder = currentServer.rootMsgFolder.getFolderWithFlags(kInboxFlag);</span>
<a href="#l1.2242"></a><span id="l1.2242" class="difflineminus">-  // coalesce the servers that download into the same folder...</span>
<a href="#l1.2243"></a><span id="l1.2243" class="difflineminus">-  var index = localFoldersToDownloadTo.GetIndexOf(inboxFolder);</span>
<a href="#l1.2244"></a><span id="l1.2244" class="difflineminus">-  if (index == -1)</span>
<a href="#l1.2245"></a><span id="l1.2245" class="difflineminus">-  {</span>
<a href="#l1.2246"></a><span id="l1.2246" class="difflineminus">-    if (inboxFolder)</span>
<a href="#l1.2247"></a><span id="l1.2247" class="difflineminus">-    {</span>
<a href="#l1.2248"></a><span id="l1.2248" class="difflineminus">-      inboxFolder.biffState =  Components.interfaces.nsIMsgFolder.nsMsgBiffState_NoMail;</span>
<a href="#l1.2249"></a><span id="l1.2249" class="difflineminus">-      inboxFolder.clearNewMessages();</span>
<a href="#l1.2250"></a><span id="l1.2250" class="difflineminus">-    }</span>
<a href="#l1.2251"></a><span id="l1.2251" class="difflineminus">-    localFoldersToDownloadTo.AppendElement(inboxFolder);</span>
<a href="#l1.2252"></a><span id="l1.2252" class="difflineminus">-    index = pop3DownloadServersArray.length</span>
<a href="#l1.2253"></a><span id="l1.2253" class="difflineminus">-    pop3DownloadServersArray[index] = Components.classes[&quot;@mozilla.org/supports-array;1&quot;]</span>
<a href="#l1.2254"></a><span id="l1.2254" class="difflineminus">-                                                .createInstance(Components.interfaces.nsISupportsArray);</span>
<a href="#l1.2255"></a><span id="l1.2255" class="difflineminus">-  }</span>
<a href="#l1.2256"></a><span id="l1.2256" class="difflineminus">-  pop3DownloadServersArray[index].AppendElement(currentServer);</span>
<a href="#l1.2257"></a><span id="l1.2257" class="difflineminus">-}</span>
<a href="#l1.2258"></a><span id="l1.2258" class="difflineminus">-</span>
<a href="#l1.2259"></a><span id="l1.2259" class="difflineminus">-function GetMessagesForAllAuthenticatedAccounts()</span>
<a href="#l1.2260"></a><span id="l1.2260" class="difflineminus">-{</span>
<a href="#l1.2261"></a><span id="l1.2261" class="difflineminus">-  // now log into any server</span>
<a href="#l1.2262"></a><span id="l1.2262" class="difflineminus">-  try</span>
<a href="#l1.2263"></a><span id="l1.2263" class="difflineminus">-  {</span>
<a href="#l1.2264"></a><span id="l1.2264" class="difflineminus">-    var allServers = accountManager.allServers;</span>
<a href="#l1.2265"></a><span id="l1.2265" class="difflineminus">-    // array of isupportsarrays of servers for a particular folder</span>
<a href="#l1.2266"></a><span id="l1.2266" class="difflineminus">-    var pop3DownloadServersArray = new Array();</span>
<a href="#l1.2267"></a><span id="l1.2267" class="difflineminus">-    // parallel isupports array of folders to download to...</span>
<a href="#l1.2268"></a><span id="l1.2268" class="difflineminus">-    var localFoldersToDownloadTo = Components.classes[&quot;@mozilla.org/supports-array;1&quot;]</span>
<a href="#l1.2269"></a><span id="l1.2269" class="difflineminus">-                                             .createInstance(Components.interfaces.nsISupportsArray);</span>
<a href="#l1.2270"></a><span id="l1.2270" class="difflineminus">-    var pop3Server;</span>
<a href="#l1.2271"></a><span id="l1.2271" class="difflineminus">-</span>
<a href="#l1.2272"></a><span id="l1.2272" class="difflineminus">-    for (var i = 0; i &lt; allServers.Count(); ++i)</span>
<a href="#l1.2273"></a><span id="l1.2273" class="difflineminus">-    {</span>
<a href="#l1.2274"></a><span id="l1.2274" class="difflineminus">-      var currentServer = allServers.GetElementAt(i).QueryInterface(Components.interfaces.nsIMsgIncomingServer);</span>
<a href="#l1.2275"></a><span id="l1.2275" class="difflineminus">-      var protocolinfo = Components.classes[&quot;@mozilla.org/messenger/protocol/info;1?type=&quot; + currentServer.type]</span>
<a href="#l1.2276"></a><span id="l1.2276" class="difflineminus">-                                   .getService(Components.interfaces.nsIMsgProtocolInfo);</span>
<a href="#l1.2277"></a><span id="l1.2277" class="difflineminus">-      if (protocolinfo.canGetMessages &amp;&amp; !currentServer.passwordPromptRequired)</span>
<a href="#l1.2278"></a><span id="l1.2278" class="difflineminus">-      {</span>
<a href="#l1.2279"></a><span id="l1.2279" class="difflineminus">-        if (currentServer.type == &quot;pop3&quot;)</span>
<a href="#l1.2280"></a><span id="l1.2280" class="difflineminus">-        {</span>
<a href="#l1.2281"></a><span id="l1.2281" class="difflineminus">-          CoalesceGetMsgsForPop3ServersByDestFolder(currentServer,</span>
<a href="#l1.2282"></a><span id="l1.2282" class="difflineminus">-            pop3DownloadServersArray, localFoldersToDownloadTo);</span>
<a href="#l1.2283"></a><span id="l1.2283" class="difflineminus">-          pop3Server = currentServer.QueryInterface(Components.interfaces.nsIPop3IncomingServer);</span>
<a href="#l1.2284"></a><span id="l1.2284" class="difflineminus">-        }</span>
<a href="#l1.2285"></a><span id="l1.2285" class="difflineminus">-        else</span>
<a href="#l1.2286"></a><span id="l1.2286" class="difflineminus">-        // get new messages on the server for imap or rss</span>
<a href="#l1.2287"></a><span id="l1.2287" class="difflineminus">-          GetMessagesForInboxOnServer(currentServer);</span>
<a href="#l1.2288"></a><span id="l1.2288" class="difflineminus">-      }</span>
<a href="#l1.2289"></a><span id="l1.2289" class="difflineminus">-    }</span>
<a href="#l1.2290"></a><span id="l1.2290" class="difflineminus">-    for (var i = 0; i &lt; pop3DownloadServersArray.length; ++i)</span>
<a href="#l1.2291"></a><span id="l1.2291" class="difflineminus">-    {</span>
<a href="#l1.2292"></a><span id="l1.2292" class="difflineminus">-      // any ol' pop3Server will do - the serversArray specifies which servers to download from</span>
<a href="#l1.2293"></a><span id="l1.2293" class="difflineminus">-      pop3Server.downloadMailFromServers(pop3DownloadServersArray[i], msgWindow,</span>
<a href="#l1.2294"></a><span id="l1.2294" class="difflineminus">-                                         localFoldersToDownloadTo.GetElementAt(i), null);</span>
<a href="#l1.2295"></a><span id="l1.2295" class="difflineminus">-    }</span>
<a href="#l1.2296"></a><span id="l1.2296" class="difflineminus">-  }</span>
<a href="#l1.2297"></a><span id="l1.2297" class="difflineminus">-  catch(ex)</span>
<a href="#l1.2298"></a><span id="l1.2298" class="difflineminus">-  {</span>
<a href="#l1.2299"></a><span id="l1.2299" class="difflineminus">-      dump(ex + &quot;\n&quot;);</span>
<a href="#l1.2300"></a><span id="l1.2300" class="difflineminus">-  }</span>
<a href="#l1.2301"></a><span id="l1.2301" class="difflineminus">-}</span>
<a href="#l1.2302"></a><span id="l1.2302" class="difflineminus">-</span>
<a href="#l1.2303"></a><span id="l1.2303" class="difflineminus">-function CommandUpdate_UndoRedo()</span>
<a href="#l1.2304"></a><span id="l1.2304" class="difflineminus">-{</span>
<a href="#l1.2305"></a><span id="l1.2305" class="difflineminus">-  EnableMenuItem(&quot;menu_undo&quot;, SetupUndoRedoCommand(&quot;cmd_undo&quot;));</span>
<a href="#l1.2306"></a><span id="l1.2306" class="difflineminus">-  EnableMenuItem(&quot;menu_redo&quot;, SetupUndoRedoCommand(&quot;cmd_redo&quot;));</span>
<a href="#l1.2307"></a><span id="l1.2307" class="difflineminus">-}</span>
<a href="#l1.2308"></a><span id="l1.2308" class="difflineminus">-</span>
<a href="#l1.2309"></a><span id="l1.2309" class="difflineminus">-function SetupUndoRedoCommand(command)</span>
<a href="#l1.2310"></a><span id="l1.2310" class="difflineminus">-{</span>
<a href="#l1.2311"></a><span id="l1.2311" class="difflineminus">-  // If we have selected a server, and are viewing account central</span>
<a href="#l1.2312"></a><span id="l1.2312" class="difflineminus">-  // there is no loaded folder.</span>
<a href="#l1.2313"></a><span id="l1.2313" class="difflineminus">-  var loadedFolder = gFolderDisplay.displayedFolder;</span>
<a href="#l1.2314"></a><span id="l1.2314" class="difflineminus">-  if (!loadedFolder || !loadedFolder.server.canUndoDeleteOnServer)</span>
<a href="#l1.2315"></a><span id="l1.2315" class="difflineminus">-    return false;</span>
<a href="#l1.2316"></a><span id="l1.2316" class="difflineminus">-</span>
<a href="#l1.2317"></a><span id="l1.2317" class="difflineminus">-  var canUndoOrRedo;</span>
<a href="#l1.2318"></a><span id="l1.2318" class="difflineminus">-  var txnType;</span>
<a href="#l1.2319"></a><span id="l1.2319" class="difflineminus">-  if (command == &quot;cmd_undo&quot;)</span>
<a href="#l1.2320"></a><span id="l1.2320" class="difflineminus">-  {</span>
<a href="#l1.2321"></a><span id="l1.2321" class="difflineminus">-    canUndoOrRedo = messenger.canUndo();</span>
<a href="#l1.2322"></a><span id="l1.2322" class="difflineminus">-    txnType = messenger.getUndoTransactionType();</span>
<a href="#l1.2323"></a><span id="l1.2323" class="difflineminus">-  }</span>
<a href="#l1.2324"></a><span id="l1.2324" class="difflineminus">-  else</span>
<a href="#l1.2325"></a><span id="l1.2325" class="difflineminus">-  {</span>
<a href="#l1.2326"></a><span id="l1.2326" class="difflineminus">-    canUndoOrRedo = messenger.canRedo();</span>
<a href="#l1.2327"></a><span id="l1.2327" class="difflineminus">-    txnType = messenger.getRedoTransactionType();</span>
<a href="#l1.2328"></a><span id="l1.2328" class="difflineminus">-  }</span>
<a href="#l1.2329"></a><span id="l1.2329" class="difflineminus">-</span>
<a href="#l1.2330"></a><span id="l1.2330" class="difflineminus">-  if (canUndoOrRedo)</span>
<a href="#l1.2331"></a><span id="l1.2331" class="difflineminus">-  {</span>
<a href="#l1.2332"></a><span id="l1.2332" class="difflineminus">-    var commands =</span>
<a href="#l1.2333"></a><span id="l1.2333" class="difflineminus">-      ['valueDefault', 'valueDeleteMsg', 'valueMoveMsg', 'valueCopyMsg', 'valueUnmarkAllMsgs'];</span>
<a href="#l1.2334"></a><span id="l1.2334" class="difflineminus">-    goSetMenuValue(command, commands[txnType]);</span>
<a href="#l1.2335"></a><span id="l1.2335" class="difflineminus">-  }</span>
<a href="#l1.2336"></a><span id="l1.2336" class="difflineminus">-  else</span>
<a href="#l1.2337"></a><span id="l1.2337" class="difflineminus">-  {</span>
<a href="#l1.2338"></a><span id="l1.2338" class="difflineminus">-    goSetMenuValue(command, 'valueDefault');</span>
<a href="#l1.2339"></a><span id="l1.2339" class="difflineminus">-  }</span>
<a href="#l1.2340"></a><span id="l1.2340" class="difflineminus">-  return canUndoOrRedo;</span>
<a href="#l1.2341"></a><span id="l1.2341" class="difflineminus">-}</span>
<a href="#l1.2342"></a><span id="l1.2342" class="difflineminus">-</span>
<a href="#l1.2343"></a><span id="l1.2343" class="difflineminus">-/**</span>
<a href="#l1.2344"></a><span id="l1.2344" class="difflineminus">- * Triggered by the global JunkStatusChanged notification, we handle updating</span>
<a href="#l1.2345"></a><span id="l1.2345" class="difflineminus">- *  the message display if our displayed message might have had its junk status</span>
<a href="#l1.2346"></a><span id="l1.2346" class="difflineminus">- *  change.  This primarily entails updating the notification bar (that thing</span>
<a href="#l1.2347"></a><span id="l1.2347" class="difflineminus">- *  that appears above the message and says &quot;this message might be junk&quot;) and</span>
<a href="#l1.2348"></a><span id="l1.2348" class="difflineminus">- *  (potentially) reloading the message because junk status affects the form of</span>
<a href="#l1.2349"></a><span id="l1.2349" class="difflineminus">- *  HTML display used (sanitized vs not).</span>
<a href="#l1.2350"></a><span id="l1.2350" class="difflineminus">- * When our tab implementation is no longer multiplexed (reusing the same</span>
<a href="#l1.2351"></a><span id="l1.2351" class="difflineminus">- *  display widget), this must be moved into the MessageDisplayWidget or</span>
<a href="#l1.2352"></a><span id="l1.2352" class="difflineminus">- *  otherwise be scoped to the tab.</span>
<a href="#l1.2353"></a><span id="l1.2353" class="difflineminus">- */</span>
<a href="#l1.2354"></a><span id="l1.2354" class="difflineminus">-function HandleJunkStatusChanged(folder)</span>
<a href="#l1.2355"></a><span id="l1.2355" class="difflineminus">-{</span>
<a href="#l1.2356"></a><span id="l1.2356" class="difflineminus">-  // We have nothing to do (and should bail) if:</span>
<a href="#l1.2357"></a><span id="l1.2357" class="difflineminus">-  // - There is no currently displayed message.</span>
<a href="#l1.2358"></a><span id="l1.2358" class="difflineminus">-  // - The displayed message is an .eml file from disk or an attachment.</span>
<a href="#l1.2359"></a><span id="l1.2359" class="difflineminus">-  // - The folder that has had a junk change is not backing the display folder.</span>
<a href="#l1.2360"></a><span id="l1.2360" class="difflineminus">-</span>
<a href="#l1.2361"></a><span id="l1.2361" class="difflineminus">-  // This might be the stand alone window, open to a message that was</span>
<a href="#l1.2362"></a><span id="l1.2362" class="difflineminus">-  // and attachment (or on disk), in which case, we want to ignore it.</span>
<a href="#l1.2363"></a><span id="l1.2363" class="difflineminus">-  if (!gMessageDisplay.displayedMessage ||</span>
<a href="#l1.2364"></a><span id="l1.2364" class="difflineminus">-      gMessageDisplay.isDummy ||</span>
<a href="#l1.2365"></a><span id="l1.2365" class="difflineminus">-      gFolderDisplay.displayedFolder != folder)</span>
<a href="#l1.2366"></a><span id="l1.2366" class="difflineminus">-    return;</span>
<a href="#l1.2367"></a><span id="l1.2367" class="difflineminus">-</span>
<a href="#l1.2368"></a><span id="l1.2368" class="difflineminus">-  // If multiple message are selected and we change the junk status</span>
<a href="#l1.2369"></a><span id="l1.2369" class="difflineminus">-  // we don't want to show the junk bar (since the message pane is blank).</span>
<a href="#l1.2370"></a><span id="l1.2370" class="difflineminus">-  var msgHdr = null;</span>
<a href="#l1.2371"></a><span id="l1.2371" class="difflineminus">-  if (GetNumSelectedMessages() == 1)</span>
<a href="#l1.2372"></a><span id="l1.2372" class="difflineminus">-    msgHdr = gMessageDisplay.displayedMessage;</span>
<a href="#l1.2373"></a><span id="l1.2373" class="difflineminus">-  var junkBarWasDisplayed = gMessageNotificationBar.isFlagSet(kMsgNotificationJunkBar);</span>
<a href="#l1.2374"></a><span id="l1.2374" class="difflineminus">-  gMessageNotificationBar.setJunkMsg(msgHdr);</span>
<a href="#l1.2375"></a><span id="l1.2375" class="difflineminus">-</span>
<a href="#l1.2376"></a><span id="l1.2376" class="difflineminus">-  // Only reload message if junk bar display state has changed.</span>
<a href="#l1.2377"></a><span id="l1.2377" class="difflineminus">-  if (msgHdr &amp;&amp; junkBarWasDisplayed != gMessageNotificationBar.isFlagSet(kMsgNotificationJunkBar))</span>
<a href="#l1.2378"></a><span id="l1.2378" class="difflineminus">-  {</span>
<a href="#l1.2379"></a><span id="l1.2379" class="difflineminus">-    // We may be forcing junk mail to be rendered with sanitized html.</span>
<a href="#l1.2380"></a><span id="l1.2380" class="difflineminus">-    // In that scenario, we want to reload the message if the status has just</span>
<a href="#l1.2381"></a><span id="l1.2381" class="difflineminus">-    // changed to not junk.</span>
<a href="#l1.2382"></a><span id="l1.2382" class="difflineminus">-    var sanitizeJunkMail = gPrefBranch.getBoolPref(&quot;mail.spam.display.sanitize&quot;);</span>
<a href="#l1.2383"></a><span id="l1.2383" class="difflineminus">-</span>
<a href="#l1.2384"></a><span id="l1.2384" class="difflineminus">-    // Only bother doing this if we are modifying the html for junk mail....</span>
<a href="#l1.2385"></a><span id="l1.2385" class="difflineminus">-    if (sanitizeJunkMail)</span>
<a href="#l1.2386"></a><span id="l1.2386" class="difflineminus">-    {</span>
<a href="#l1.2387"></a><span id="l1.2387" class="difflineminus">-      let junkScore = msgHdr.getStringProperty(&quot;junkscore&quot;);</span>
<a href="#l1.2388"></a><span id="l1.2388" class="difflineminus">-      let isJunk = (junkScore == Components.interfaces.nsIJunkMailPlugin.IS_SPAM_SCORE);</span>
<a href="#l1.2389"></a><span id="l1.2389" class="difflineminus">-</span>
<a href="#l1.2390"></a><span id="l1.2390" class="difflineminus">-      // If the current row  isn't going to change, reload to show sanitized or</span>
<a href="#l1.2391"></a><span id="l1.2391" class="difflineminus">-      // unsanitized. Otherwise we wouldn't see the reloaded version anyway.</span>
<a href="#l1.2392"></a><span id="l1.2392" class="difflineminus">-</span>
<a href="#l1.2393"></a><span id="l1.2393" class="difflineminus">-      // 1) When marking as non-junk, the msg would move back to the inbox.</span>
<a href="#l1.2394"></a><span id="l1.2394" class="difflineminus">-      // 2) When marking as junk, the msg will move or delete, if manualMark is set.</span>
<a href="#l1.2395"></a><span id="l1.2395" class="difflineminus">-      // 3) Marking as junk in the junk folder just changes the junk status.</span>
<a href="#l1.2396"></a><span id="l1.2396" class="difflineminus">-      if ((!isJunk &amp;&amp; folder.isSpecialFolder(Components.interfaces.nsMsgFolderFlags.Inbox)) ||</span>
<a href="#l1.2397"></a><span id="l1.2397" class="difflineminus">-          (isJunk &amp;&amp; !folder.server.spamSettings.manualMark) ||</span>
<a href="#l1.2398"></a><span id="l1.2398" class="difflineminus">-          (isJunk &amp;&amp; folder.isSpecialFolder(Components.interfaces.nsMsgFolderFlags.Junk)))</span>
<a href="#l1.2399"></a><span id="l1.2399" class="difflineminus">-        ReloadMessage();</span>
<a href="#l1.2400"></a><span id="l1.2400" class="difflineminus">-    }</span>
<a href="#l1.2401"></a><span id="l1.2401" class="difflineminus">-  }</span>
<a href="#l1.2402"></a><span id="l1.2402" class="difflineminus">-}</span>
<a href="#l1.2403"></a><span id="l1.2403" class="difflineminus">-</span>
<a href="#l1.2404"></a><span id="l1.2404" class="difflineminus">-var gMessageNotificationBar =</span>
<a href="#l1.2405"></a><span id="l1.2405" class="difflineminus">-{</span>
<a href="#l1.2406"></a><span id="l1.2406" class="difflineminus">-  mBarStatus: 0,</span>
<a href="#l1.2407"></a><span id="l1.2407" class="difflineminus">-  // flag bit values for mBarStatus, indexed by kMsgNotificationXXX</span>
<a href="#l1.2408"></a><span id="l1.2408" class="difflineminus">-  mBarFlagValues: [</span>
<a href="#l1.2409"></a><span id="l1.2409" class="difflineminus">-                    0, // for no msgNotificationBar</span>
<a href="#l1.2410"></a><span id="l1.2410" class="difflineminus">-                    1, // 1 &lt;&lt; (kMsgNotificationPhishingBar - 1)</span>
<a href="#l1.2411"></a><span id="l1.2411" class="difflineminus">-                    2, // 1 &lt;&lt; (kMsgNotificationJunkBar - 1)</span>
<a href="#l1.2412"></a><span id="l1.2412" class="difflineminus">-                    4  // 1 &lt;&lt; (kMsgNotificationRemoteImages - 1)</span>
<a href="#l1.2413"></a><span id="l1.2413" class="difflineminus">-                  ],</span>
<a href="#l1.2414"></a><span id="l1.2414" class="difflineminus">-</span>
<a href="#l1.2415"></a><span id="l1.2415" class="difflineminus">-  mMsgNotificationBar: document.getElementById('msgNotificationBar'),</span>
<a href="#l1.2416"></a><span id="l1.2416" class="difflineminus">-</span>
<a href="#l1.2417"></a><span id="l1.2417" class="difflineminus">-  setJunkMsg: function(aMsgHdr)</span>
<a href="#l1.2418"></a><span id="l1.2418" class="difflineminus">-  {</span>
<a href="#l1.2419"></a><span id="l1.2419" class="difflineminus">-    var isJunk = false;</span>
<a href="#l1.2420"></a><span id="l1.2420" class="difflineminus">-</span>
<a href="#l1.2421"></a><span id="l1.2421" class="difflineminus">-    if (aMsgHdr)</span>
<a href="#l1.2422"></a><span id="l1.2422" class="difflineminus">-    {</span>
<a href="#l1.2423"></a><span id="l1.2423" class="difflineminus">-      var junkScore = aMsgHdr.getStringProperty(&quot;junkscore&quot;);</span>
<a href="#l1.2424"></a><span id="l1.2424" class="difflineminus">-      isJunk = ((junkScore != &quot;&quot;) &amp;&amp; (junkScore != &quot;0&quot;));</span>
<a href="#l1.2425"></a><span id="l1.2425" class="difflineminus">-    }</span>
<a href="#l1.2426"></a><span id="l1.2426" class="difflineminus">-</span>
<a href="#l1.2427"></a><span id="l1.2427" class="difflineminus">-    this.updateMsgNotificationBar(kMsgNotificationJunkBar, isJunk);</span>
<a href="#l1.2428"></a><span id="l1.2428" class="difflineminus">-</span>
<a href="#l1.2429"></a><span id="l1.2429" class="difflineminus">-    goUpdateCommand('button_junk');</span>
<a href="#l1.2430"></a><span id="l1.2430" class="difflineminus">-  },</span>
<a href="#l1.2431"></a><span id="l1.2431" class="difflineminus">-</span>
<a href="#l1.2432"></a><span id="l1.2432" class="difflineminus">-  setRemoteContentMsg: function(aMsgHdr)</span>
<a href="#l1.2433"></a><span id="l1.2433" class="difflineminus">-  {</span>
<a href="#l1.2434"></a><span id="l1.2434" class="difflineminus">-    // update the allow remote content for sender string</span>
<a href="#l1.2435"></a><span id="l1.2435" class="difflineminus">-    var headerParser = Components.classes[&quot;@mozilla.org/messenger/headerparser;1&quot;]</span>
<a href="#l1.2436"></a><span id="l1.2436" class="difflineminus">-                                 .getService(Components.interfaces.nsIMsgHeaderParser);</span>
<a href="#l1.2437"></a><span id="l1.2437" class="difflineminus">-    var emailAddress = headerParser.extractHeaderAddressMailboxes(aMsgHdr.author);</span>
<a href="#l1.2438"></a><span id="l1.2438" class="difflineminus">-    document.getElementById('allowRemoteContentForAuthorDesc').value =</span>
<a href="#l1.2439"></a><span id="l1.2439" class="difflineminus">-      gMessengerBundle.getFormattedString('alwaysLoadRemoteContentForSender2',</span>
<a href="#l1.2440"></a><span id="l1.2440" class="difflineminus">-                         [emailAddress ? emailAddress : aMsgHdr.author]);</span>
<a href="#l1.2441"></a><span id="l1.2441" class="difflineminus">-    this.updateMsgNotificationBar(kMsgNotificationRemoteImages, true);</span>
<a href="#l1.2442"></a><span id="l1.2442" class="difflineminus">-  },</span>
<a href="#l1.2443"></a><span id="l1.2443" class="difflineminus">-</span>
<a href="#l1.2444"></a><span id="l1.2444" class="difflineminus">-  setPhishingMsg: function()</span>
<a href="#l1.2445"></a><span id="l1.2445" class="difflineminus">-  {</span>
<a href="#l1.2446"></a><span id="l1.2446" class="difflineminus">-    this.updateMsgNotificationBar(kMsgNotificationPhishingBar, true);</span>
<a href="#l1.2447"></a><span id="l1.2447" class="difflineminus">-  },</span>
<a href="#l1.2448"></a><span id="l1.2448" class="difflineminus">-</span>
<a href="#l1.2449"></a><span id="l1.2449" class="difflineminus">-  clearMsgNotifications: function()</span>
<a href="#l1.2450"></a><span id="l1.2450" class="difflineminus">-  {</span>
<a href="#l1.2451"></a><span id="l1.2451" class="difflineminus">-    this.mBarStatus = 0;</span>
<a href="#l1.2452"></a><span id="l1.2452" class="difflineminus">-    this.mMsgNotificationBar.selectedIndex = 0;</span>
<a href="#l1.2453"></a><span id="l1.2453" class="difflineminus">-    this.mMsgNotificationBar.collapsed = true;</span>
<a href="#l1.2454"></a><span id="l1.2454" class="difflineminus">-  },</span>
<a href="#l1.2455"></a><span id="l1.2455" class="difflineminus">-</span>
<a href="#l1.2456"></a><span id="l1.2456" class="difflineminus">-  updateMsgNotificationBar: function(aIndex, aSet)</span>
<a href="#l1.2457"></a><span id="l1.2457" class="difflineminus">-  {</span>
<a href="#l1.2458"></a><span id="l1.2458" class="difflineminus">-    var chunk = this.mBarFlagValues[aIndex];</span>
<a href="#l1.2459"></a><span id="l1.2459" class="difflineminus">-    var status = aSet ? this.mBarStatus | chunk : this.mBarStatus &amp; ~chunk;</span>
<a href="#l1.2460"></a><span id="l1.2460" class="difflineminus">-    this.mBarStatus = status;</span>
<a href="#l1.2461"></a><span id="l1.2461" class="difflineminus">-</span>
<a href="#l1.2462"></a><span id="l1.2462" class="difflineminus">-    // the phishing message takes precedence over the junk message</span>
<a href="#l1.2463"></a><span id="l1.2463" class="difflineminus">-    // which takes precedence over the remote content message</span>
<a href="#l1.2464"></a><span id="l1.2464" class="difflineminus">-    this.mMsgNotificationBar.selectedIndex = this.mBarFlagValues.indexOf(status &amp; -status);</span>
<a href="#l1.2465"></a><span id="l1.2465" class="difflineminus">-    this.mMsgNotificationBar.collapsed = !status;</span>
<a href="#l1.2466"></a><span id="l1.2466" class="difflineminus">-  },</span>
<a href="#l1.2467"></a><span id="l1.2467" class="difflineminus">-</span>
<a href="#l1.2468"></a><span id="l1.2468" class="difflineminus">-  /**</span>
<a href="#l1.2469"></a><span id="l1.2469" class="difflineminus">-   * @param aFlag (kMsgNotificationPhishingBar, kMsgNotificationJunkBar, kMsgNotificationRemoteImages</span>
<a href="#l1.2470"></a><span id="l1.2470" class="difflineminus">-   * @return true if aFlag is currently set for the loaded message</span>
<a href="#l1.2471"></a><span id="l1.2471" class="difflineminus">-   */</span>
<a href="#l1.2472"></a><span id="l1.2472" class="difflineminus">-  isFlagSet: function(aFlag)</span>
<a href="#l1.2473"></a><span id="l1.2473" class="difflineminus">-  {</span>
<a href="#l1.2474"></a><span id="l1.2474" class="difflineminus">-    var chunk = this.mBarFlagValues[aFlag];</span>
<a href="#l1.2475"></a><span id="l1.2475" class="difflineminus">-    return this.mBarStatus &amp; chunk;</span>
<a href="#l1.2476"></a><span id="l1.2476" class="difflineminus">-  }</span>
<a href="#l1.2477"></a><span id="l1.2477" class="difflineminus">-};</span>
<a href="#l1.2478"></a><span id="l1.2478" class="difflineminus">-</span>
<a href="#l1.2479"></a><span id="l1.2479" class="difflineminus">-/**</span>
<a href="#l1.2480"></a><span id="l1.2480" class="difflineminus">- * LoadMsgWithRemoteContent</span>
<a href="#l1.2481"></a><span id="l1.2481" class="difflineminus">- *   Reload the current message, allowing remote content</span>
<a href="#l1.2482"></a><span id="l1.2482" class="difflineminus">- */</span>
<a href="#l1.2483"></a><span id="l1.2483" class="difflineminus">-function LoadMsgWithRemoteContent()</span>
<a href="#l1.2484"></a><span id="l1.2484" class="difflineminus">-{</span>
<a href="#l1.2485"></a><span id="l1.2485" class="difflineminus">-  // we want to get the msg hdr for the currently selected message</span>
<a href="#l1.2486"></a><span id="l1.2486" class="difflineminus">-  // change the &quot;remoteContentBar&quot; property on it</span>
<a href="#l1.2487"></a><span id="l1.2487" class="difflineminus">-  // then reload the message</span>
<a href="#l1.2488"></a><span id="l1.2488" class="difflineminus">-</span>
<a href="#l1.2489"></a><span id="l1.2489" class="difflineminus">-  setMsgHdrPropertyAndReload(&quot;remoteContentPolicy&quot;, kAllowRemoteContent);</span>
<a href="#l1.2490"></a><span id="l1.2490" class="difflineminus">-}</span>
<a href="#l1.2491"></a><span id="l1.2491" class="difflineminus">-</span>
<a href="#l1.2492"></a><span id="l1.2492" class="difflineminus">-/**</span>
<a href="#l1.2493"></a><span id="l1.2493" class="difflineminus">- *  Reloads the message after adjusting the remote content policy for the sender.</span>
<a href="#l1.2494"></a><span id="l1.2494" class="difflineminus">- *  Iterate through the local address books looking for a card with the same e-mail address as the</span>
<a href="#l1.2495"></a><span id="l1.2495" class="difflineminus">- *  sender of the current loaded message. If we find a card, update the allow remote content field.</span>
<a href="#l1.2496"></a><span id="l1.2496" class="difflineminus">- *  If we can't find a card, prompt the user with a new AB card dialog, pre-selecting the remote content field.</span>
<a href="#l1.2497"></a><span id="l1.2497" class="difflineminus">- */</span>
<a href="#l1.2498"></a><span id="l1.2498" class="difflineminus">-function allowRemoteContentForSender()</span>
<a href="#l1.2499"></a><span id="l1.2499" class="difflineminus">-{</span>
<a href="#l1.2500"></a><span id="l1.2500" class="difflineminus">-  // get the sender of the msg hdr</span>
<a href="#l1.2501"></a><span id="l1.2501" class="difflineminus">-  var msgHdr = gMessageDisplay.displayedMessage;</span>
<a href="#l1.2502"></a><span id="l1.2502" class="difflineminus">-  if (!msgHdr)</span>
<a href="#l1.2503"></a><span id="l1.2503" class="difflineminus">-    return;</span>
<a href="#l1.2504"></a><span id="l1.2504" class="difflineminus">-</span>
<a href="#l1.2505"></a><span id="l1.2505" class="difflineminus">-  var headerParser = Components.classes[&quot;@mozilla.org/messenger/headerparser;1&quot;]</span>
<a href="#l1.2506"></a><span id="l1.2506" class="difflineminus">-                               .getService(Components.interfaces.nsIMsgHeaderParser);</span>
<a href="#l1.2507"></a><span id="l1.2507" class="difflineminus">-  var names = {};</span>
<a href="#l1.2508"></a><span id="l1.2508" class="difflineminus">-  var addresses = {};</span>
<a href="#l1.2509"></a><span id="l1.2509" class="difflineminus">-  var fullNames = {};</span>
<a href="#l1.2510"></a><span id="l1.2510" class="difflineminus">-  var numAddresses;</span>
<a href="#l1.2511"></a><span id="l1.2511" class="difflineminus">-</span>
<a href="#l1.2512"></a><span id="l1.2512" class="difflineminus">-  numAddresses = headerParser.parseHeadersWithArray(msgHdr.author, addresses, names, fullNames);</span>
<a href="#l1.2513"></a><span id="l1.2513" class="difflineminus">-  var authorEmailAddress = addresses.value[0];</span>
<a href="#l1.2514"></a><span id="l1.2514" class="difflineminus">-  if (!authorEmailAddress)</span>
<a href="#l1.2515"></a><span id="l1.2515" class="difflineminus">-    return;</span>
<a href="#l1.2516"></a><span id="l1.2516" class="difflineminus">-</span>
<a href="#l1.2517"></a><span id="l1.2517" class="difflineminus">-  // search through all of our local address books looking for a match.</span>
<a href="#l1.2518"></a><span id="l1.2518" class="difflineminus">-  var enumerator = Components.classes[&quot;@mozilla.org/abmanager;1&quot;]</span>
<a href="#l1.2519"></a><span id="l1.2519" class="difflineminus">-                             .getService(Components.interfaces.nsIAbManager)</span>
<a href="#l1.2520"></a><span id="l1.2520" class="difflineminus">-                             .directories;</span>
<a href="#l1.2521"></a><span id="l1.2521" class="difflineminus">-  var cardForEmailAddress;</span>
<a href="#l1.2522"></a><span id="l1.2522" class="difflineminus">-  var addrbook;</span>
<a href="#l1.2523"></a><span id="l1.2523" class="difflineminus">-  while (!cardForEmailAddress &amp;&amp; enumerator.hasMoreElements())</span>
<a href="#l1.2524"></a><span id="l1.2524" class="difflineminus">-  {</span>
<a href="#l1.2525"></a><span id="l1.2525" class="difflineminus">-    addrbook = enumerator.getNext()</span>
<a href="#l1.2526"></a><span id="l1.2526" class="difflineminus">-                         .QueryInterface(Components.interfaces.nsIAbDirectory);</span>
<a href="#l1.2527"></a><span id="l1.2527" class="difflineminus">-    // Try/catch because some cardForEmailAddress functions may not be</span>
<a href="#l1.2528"></a><span id="l1.2528" class="difflineminus">-    // implemented.</span>
<a href="#l1.2529"></a><span id="l1.2529" class="difflineminus">-    try {</span>
<a href="#l1.2530"></a><span id="l1.2530" class="difflineminus">-      // If its a read-only book, don't find a card as we won't be able</span>
<a href="#l1.2531"></a><span id="l1.2531" class="difflineminus">-      // to modify the card.</span>
<a href="#l1.2532"></a><span id="l1.2532" class="difflineminus">-      if (!addrbook.readOnly)</span>
<a href="#l1.2533"></a><span id="l1.2533" class="difflineminus">-        cardForEmailAddress = addrbook.cardForEmailAddress(authorEmailAddress);</span>
<a href="#l1.2534"></a><span id="l1.2534" class="difflineminus">-    } catch (e) {}</span>
<a href="#l1.2535"></a><span id="l1.2535" class="difflineminus">-  }</span>
<a href="#l1.2536"></a><span id="l1.2536" class="difflineminus">-</span>
<a href="#l1.2537"></a><span id="l1.2537" class="difflineminus">-  var allowRemoteContent = false;</span>
<a href="#l1.2538"></a><span id="l1.2538" class="difflineminus">-  if (cardForEmailAddress)</span>
<a href="#l1.2539"></a><span id="l1.2539" class="difflineminus">-  {</span>
<a href="#l1.2540"></a><span id="l1.2540" class="difflineminus">-    // set the property for remote content</span>
<a href="#l1.2541"></a><span id="l1.2541" class="difflineminus">-    cardForEmailAddress.setProperty(&quot;AllowRemoteContent&quot;, true);</span>
<a href="#l1.2542"></a><span id="l1.2542" class="difflineminus">-    addrbook.modifyCard(cardForEmailAddress);</span>
<a href="#l1.2543"></a><span id="l1.2543" class="difflineminus">-    allowRemoteContent = true;</span>
<a href="#l1.2544"></a><span id="l1.2544" class="difflineminus">-  }</span>
<a href="#l1.2545"></a><span id="l1.2545" class="difflineminus">-  else</span>
<a href="#l1.2546"></a><span id="l1.2546" class="difflineminus">-  {</span>
<a href="#l1.2547"></a><span id="l1.2547" class="difflineminus">-    var args = {primaryEmail:authorEmailAddress, displayName:names.value[0],</span>
<a href="#l1.2548"></a><span id="l1.2548" class="difflineminus">-                allowRemoteContent:true};</span>
<a href="#l1.2549"></a><span id="l1.2549" class="difflineminus">-    // create a new card and set the property</span>
<a href="#l1.2550"></a><span id="l1.2550" class="difflineminus">-    window.openDialog(&quot;chrome://messenger/content/addressbook/abNewCardDialog.xul&quot;,</span>
<a href="#l1.2551"></a><span id="l1.2551" class="difflineminus">-                      &quot;&quot;, &quot;chrome,resizable=no,titlebar,modal,centerscreen&quot;, args);</span>
<a href="#l1.2552"></a><span id="l1.2552" class="difflineminus">-    allowRemoteContent = args.allowRemoteContent;</span>
<a href="#l1.2553"></a><span id="l1.2553" class="difflineminus">-  }</span>
<a href="#l1.2554"></a><span id="l1.2554" class="difflineminus">-</span>
<a href="#l1.2555"></a><span id="l1.2555" class="difflineminus">-  // Reload the message if we've updated the remote content policy for the sender.</span>
<a href="#l1.2556"></a><span id="l1.2556" class="difflineminus">-  if (allowRemoteContent)</span>
<a href="#l1.2557"></a><span id="l1.2557" class="difflineminus">-    ReloadMessage();</span>
<a href="#l1.2558"></a><span id="l1.2558" class="difflineminus">-}</span>
<a href="#l1.2559"></a><span id="l1.2559" class="difflineminus">-</span>
<a href="#l1.2560"></a><span id="l1.2560" class="difflineminus">-/**</span>
<a href="#l1.2561"></a><span id="l1.2561" class="difflineminus">- *  Set the msg hdr flag to ignore the phishing warning and reload the message.</span>
<a href="#l1.2562"></a><span id="l1.2562" class="difflineminus">- */</span>
<a href="#l1.2563"></a><span id="l1.2563" class="difflineminus">-function IgnorePhishingWarning()</span>
<a href="#l1.2564"></a><span id="l1.2564" class="difflineminus">-{</span>
<a href="#l1.2565"></a><span id="l1.2565" class="difflineminus">-  // This property should really be called skipPhishingWarning or something</span>
<a href="#l1.2566"></a><span id="l1.2566" class="difflineminus">-  // like that, but it's too late to change that now.</span>
<a href="#l1.2567"></a><span id="l1.2567" class="difflineminus">-  // This property is used to supress the phishing bar for the message.</span>
<a href="#l1.2568"></a><span id="l1.2568" class="difflineminus">-  setMsgHdrPropertyAndReload(&quot;notAPhishMessage&quot;, 1);</span>
<a href="#l1.2569"></a><span id="l1.2569" class="difflineminus">-}</span>
<a href="#l1.2570"></a><span id="l1.2570" class="difflineminus">-</span>
<a href="#l1.2571"></a><span id="l1.2571" class="difflineminus">-function setMsgHdrPropertyAndReload(aProperty, aValue)</span>
<a href="#l1.2572"></a><span id="l1.2572" class="difflineminus">-{</span>
<a href="#l1.2573"></a><span id="l1.2573" class="difflineminus">-  // we want to get the msg hdr for the currently selected message</span>
<a href="#l1.2574"></a><span id="l1.2574" class="difflineminus">-  // change the appropiate property on it then reload the message</span>
<a href="#l1.2575"></a><span id="l1.2575" class="difflineminus">-  var msgHdr = gMessageDisplay.displayedMessage;</span>
<a href="#l1.2576"></a><span id="l1.2576" class="difflineminus">-  if (msgHdr)</span>
<a href="#l1.2577"></a><span id="l1.2577" class="difflineminus">-  {</span>
<a href="#l1.2578"></a><span id="l1.2578" class="difflineminus">-    msgHdr.setUint32Property(aProperty, aValue);</span>
<a href="#l1.2579"></a><span id="l1.2579" class="difflineminus">-    ReloadMessage();</span>
<a href="#l1.2580"></a><span id="l1.2580" class="difflineminus">-  }</span>
<a href="#l1.2581"></a><span id="l1.2581" class="difflineminus">-}</span>
<a href="#l1.2582"></a><span id="l1.2582" class="difflineminus">-</span>
<a href="#l1.2583"></a><span id="l1.2583" class="difflineminus">-/**</span>
<a href="#l1.2584"></a><span id="l1.2584" class="difflineminus">- * Mark a specified message as read.</span>
<a href="#l1.2585"></a><span id="l1.2585" class="difflineminus">- * @param msgHdr header (nsIMsgDBHdr) of the message to mark as read</span>
<a href="#l1.2586"></a><span id="l1.2586" class="difflineminus">- */</span>
<a href="#l1.2587"></a><span id="l1.2587" class="difflineminus">-function MarkMessageAsRead(msgHdr)</span>
<a href="#l1.2588"></a><span id="l1.2588" class="difflineminus">-{</span>
<a href="#l1.2589"></a><span id="l1.2589" class="difflineminus">-  ClearPendingReadTimer();</span>
<a href="#l1.2590"></a><span id="l1.2590" class="difflineminus">-  var headers = Components.classes[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l1.2591"></a><span id="l1.2591" class="difflineminus">-                          .createInstance(Components.interfaces.nsIMutableArray);</span>
<a href="#l1.2592"></a><span id="l1.2592" class="difflineminus">-  headers.appendElement(msgHdr, false);</span>
<a href="#l1.2593"></a><span id="l1.2593" class="difflineminus">-  msgHdr.folder.markMessagesRead(headers, true);</span>
<a href="#l1.2594"></a><span id="l1.2594" class="difflineminus">-}</span>
<a href="#l1.2595"></a><span id="l1.2595" class="difflineminus">-</span>
<a href="#l1.2596"></a><span id="l1.2596" class="difflineminus">-function ClearPendingReadTimer()</span>
<a href="#l1.2597"></a><span id="l1.2597" class="difflineminus">-{</span>
<a href="#l1.2598"></a><span id="l1.2598" class="difflineminus">-  if (gMarkViewedMessageAsReadTimer)</span>
<a href="#l1.2599"></a><span id="l1.2599" class="difflineminus">-  {</span>
<a href="#l1.2600"></a><span id="l1.2600" class="difflineminus">-    clearTimeout(gMarkViewedMessageAsReadTimer);</span>
<a href="#l1.2601"></a><span id="l1.2601" class="difflineminus">-    gMarkViewedMessageAsReadTimer = null;</span>
<a href="#l1.2602"></a><span id="l1.2602" class="difflineminus">-  }</span>
<a href="#l1.2603"></a><span id="l1.2603" class="difflineminus">-}</span>
<a href="#l1.2604"></a><span id="l1.2604" class="difflineminus">-</span>
<a href="#l1.2605"></a><span id="l1.2605" class="difflineminus">-// this is called when layout is actually finished rendering a</span>
<a href="#l1.2606"></a><span id="l1.2606" class="difflineminus">-// mail message. OnMsgLoaded is called when libmime is done parsing the message</span>
<a href="#l1.2607"></a><span id="l1.2607" class="difflineminus">-function OnMsgParsed(aUrl)</span>
<a href="#l1.2608"></a><span id="l1.2608" class="difflineminus">-{</span>
<a href="#l1.2609"></a><span id="l1.2609" class="difflineminus">-  // If rss feed (has 'content-base' header), show summary or load web</span>
<a href="#l1.2610"></a><span id="l1.2610" class="difflineminus">-  // page per pref; earliest we have content DOM is here (onMsgParsed).</span>
<a href="#l1.2611"></a><span id="l1.2611" class="difflineminus">-  FeedSetContentView();</span>
<a href="#l1.2612"></a><span id="l1.2612" class="difflineminus">-</span>
<a href="#l1.2613"></a><span id="l1.2613" class="difflineminus">-  // browser doesn't do this, but I thought it could be a useful thing to test out...</span>
<a href="#l1.2614"></a><span id="l1.2614" class="difflineminus">-  // If the find bar is visible and we just loaded a new message, re-run</span>
<a href="#l1.2615"></a><span id="l1.2615" class="difflineminus">-  // the find command. This means the new message will get highlighted and</span>
<a href="#l1.2616"></a><span id="l1.2616" class="difflineminus">-  // we'll scroll to the first word in the message that matches the find text.</span>
<a href="#l1.2617"></a><span id="l1.2617" class="difflineminus">-  var findBar = document.getElementById(&quot;FindToolbar&quot;);</span>
<a href="#l1.2618"></a><span id="l1.2618" class="difflineminus">-  if (!findBar.hidden)</span>
<a href="#l1.2619"></a><span id="l1.2619" class="difflineminus">-    findBar.onFindAgainCommand(false);</span>
<a href="#l1.2620"></a><span id="l1.2620" class="difflineminus">-</span>
<a href="#l1.2621"></a><span id="l1.2621" class="difflineminus">-  // Run the phishing detector on the message if it hasn't been marked as not</span>
<a href="#l1.2622"></a><span id="l1.2622" class="difflineminus">-  // a scam already.</span>
<a href="#l1.2623"></a><span id="l1.2623" class="difflineminus">-  var msgHdr = gMessageDisplay.displayedMessage;</span>
<a href="#l1.2624"></a><span id="l1.2624" class="difflineminus">-  if (msgHdr &amp;&amp; !msgHdr.getUint32Property(&quot;notAPhishMessage&quot;))</span>
<a href="#l1.2625"></a><span id="l1.2625" class="difflineminus">-    gPhishingDetector.analyzeMsgForPhishingURLs(aUrl);</span>
<a href="#l1.2626"></a><span id="l1.2626" class="difflineminus">-</span>
<a href="#l1.2627"></a><span id="l1.2627" class="difflineminus">-  // notify anyone (e.g., extensions) who's interested in when a message is loaded.</span>
<a href="#l1.2628"></a><span id="l1.2628" class="difflineminus">-  var msgURI = gFolderDisplay.selectedMessageUris[0];</span>
<a href="#l1.2629"></a><span id="l1.2629" class="difflineminus">-  var observerService = Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l1.2630"></a><span id="l1.2630" class="difflineminus">-                                  .getService(Components.interfaces.nsIObserverService);</span>
<a href="#l1.2631"></a><span id="l1.2631" class="difflineminus">-  observerService.notifyObservers(msgWindow.msgHeaderSink, &quot;MsgMsgDisplayed&quot;, msgURI);</span>
<a href="#l1.2632"></a><span id="l1.2632" class="difflineminus">-</span>
<a href="#l1.2633"></a><span id="l1.2633" class="difflineminus">-  // scale any overflowing images</span>
<a href="#l1.2634"></a><span id="l1.2634" class="difflineminus">-  var doc = document.getElementById(&quot;messagepane&quot;).contentDocument;</span>
<a href="#l1.2635"></a><span id="l1.2635" class="difflineminus">-  var imgs = doc.getElementsByTagName(&quot;img&quot;);</span>
<a href="#l1.2636"></a><span id="l1.2636" class="difflineminus">-  for each (var img in imgs)</span>
<a href="#l1.2637"></a><span id="l1.2637" class="difflineminus">-  {</span>
<a href="#l1.2638"></a><span id="l1.2638" class="difflineminus">-    if (img.className == &quot;moz-attached-image&quot; &amp;&amp; img.naturalWidth &gt; doc.width)</span>
<a href="#l1.2639"></a><span id="l1.2639" class="difflineminus">-    {</span>
<a href="#l1.2640"></a><span id="l1.2640" class="difflineminus">-      if (img.hasAttribute(&quot;shrinktofit&quot;))</span>
<a href="#l1.2641"></a><span id="l1.2641" class="difflineminus">-        img.setAttribute(&quot;isshrunk&quot;, &quot;true&quot;);</span>
<a href="#l1.2642"></a><span id="l1.2642" class="difflineminus">-      else</span>
<a href="#l1.2643"></a><span id="l1.2643" class="difflineminus">-        img.setAttribute(&quot;overflowing&quot;, &quot;true&quot;);</span>
<a href="#l1.2644"></a><span id="l1.2644" class="difflineminus">-    }</span>
<a href="#l1.2645"></a><span id="l1.2645" class="difflineminus">-  }</span>
<a href="#l1.2646"></a><span id="l1.2646" class="difflineminus">-}</span>
<a href="#l1.2647"></a><span id="l1.2647" class="difflineminus">-</span>
<a href="#l1.2648"></a><span id="l1.2648" class="difflineminus">-function OnMsgLoaded(aUrl)</span>
<a href="#l1.2649"></a><span id="l1.2649" class="difflineminus">-{</span>
<a href="#l1.2650"></a><span id="l1.2650" class="difflineminus">-  if (!aUrl)</span>
<a href="#l1.2651"></a><span id="l1.2651" class="difflineminus">-    return;</span>
<a href="#l1.2652"></a><span id="l1.2652" class="difflineminus">-</span>
<a href="#l1.2653"></a><span id="l1.2653" class="difflineminus">-  // nsIMsgMailNewsUrl.folder throws an error when opening .eml files.</span>
<a href="#l1.2654"></a><span id="l1.2654" class="difflineminus">-  var folder;</span>
<a href="#l1.2655"></a><span id="l1.2655" class="difflineminus">-  try {</span>
<a href="#l1.2656"></a><span id="l1.2656" class="difflineminus">-    folder = aUrl.folder;</span>
<a href="#l1.2657"></a><span id="l1.2657" class="difflineminus">-  }</span>
<a href="#l1.2658"></a><span id="l1.2658" class="difflineminus">-  catch (ex) {}</span>
<a href="#l1.2659"></a><span id="l1.2659" class="difflineminus">-</span>
<a href="#l1.2660"></a><span id="l1.2660" class="difflineminus">-  var msgHdr = gMessageDisplay.displayedMessage;</span>
<a href="#l1.2661"></a><span id="l1.2661" class="difflineminus">-  if (!folder || !msgHdr)</span>
<a href="#l1.2662"></a><span id="l1.2662" class="difflineminus">-    return;</span>
<a href="#l1.2663"></a><span id="l1.2663" class="difflineminus">-</span>
<a href="#l1.2664"></a><span id="l1.2664" class="difflineminus">-  var wintype = document.documentElement.getAttribute('windowtype');</span>
<a href="#l1.2665"></a><span id="l1.2665" class="difflineminus">-</span>
<a href="#l1.2666"></a><span id="l1.2666" class="difflineminus">-  gMessageNotificationBar.setJunkMsg(msgHdr);</span>
<a href="#l1.2667"></a><span id="l1.2667" class="difflineminus">-</span>
<a href="#l1.2668"></a><span id="l1.2668" class="difflineminus">-  goUpdateCommand('button_delete');</span>
<a href="#l1.2669"></a><span id="l1.2669" class="difflineminus">-</span>
<a href="#l1.2670"></a><span id="l1.2670" class="difflineminus">-  var markReadAutoMode = gPrefBranch.getBoolPref(&quot;mailnews.mark_message_read.auto&quot;);</span>
<a href="#l1.2671"></a><span id="l1.2671" class="difflineminus">-</span>
<a href="#l1.2672"></a><span id="l1.2672" class="difflineminus">-  // We just finished loading a message. If messages are to be marked as read</span>
<a href="#l1.2673"></a><span id="l1.2673" class="difflineminus">-  // automatically, set a timer to mark the message is read after n seconds</span>
<a href="#l1.2674"></a><span id="l1.2674" class="difflineminus">-  // where n can be configured by the user.</span>
<a href="#l1.2675"></a><span id="l1.2675" class="difflineminus">-  if (msgHdr &amp;&amp; !msgHdr.isRead &amp;&amp; markReadAutoMode)</span>
<a href="#l1.2676"></a><span id="l1.2676" class="difflineminus">-  {</span>
<a href="#l1.2677"></a><span id="l1.2677" class="difflineminus">-    let markReadOnADelay = gPrefBranch.getBoolPref(&quot;mailnews.mark_message_read.delay&quot;);</span>
<a href="#l1.2678"></a><span id="l1.2678" class="difflineminus">-</span>
<a href="#l1.2679"></a><span id="l1.2679" class="difflineminus">-    // Only use the timer if viewing using the 3-pane preview pane and the</span>
<a href="#l1.2680"></a><span id="l1.2680" class="difflineminus">-    // user has set the pref.</span>
<a href="#l1.2681"></a><span id="l1.2681" class="difflineminus">-    if (markReadOnADelay &amp;&amp; wintype == &quot;mail:3pane&quot;) // 3-pane window</span>
<a href="#l1.2682"></a><span id="l1.2682" class="difflineminus">-    {</span>
<a href="#l1.2683"></a><span id="l1.2683" class="difflineminus">-      ClearPendingReadTimer();</span>
<a href="#l1.2684"></a><span id="l1.2684" class="difflineminus">-      let markReadDelayTime = gPrefBranch.getIntPref(&quot;mailnews.mark_message_read.delay.interval&quot;);</span>
<a href="#l1.2685"></a><span id="l1.2685" class="difflineminus">-      if (markReadDelayTime == 0)</span>
<a href="#l1.2686"></a><span id="l1.2686" class="difflineminus">-        MarkMessageAsRead(msgHdr);</span>
<a href="#l1.2687"></a><span id="l1.2687" class="difflineminus">-      else</span>
<a href="#l1.2688"></a><span id="l1.2688" class="difflineminus">-        gMarkViewedMessageAsReadTimer = setTimeout(MarkMessageAsRead,</span>
<a href="#l1.2689"></a><span id="l1.2689" class="difflineminus">-                                                   markReadDelayTime * 1000,</span>
<a href="#l1.2690"></a><span id="l1.2690" class="difflineminus">-                                                   msgHdr);</span>
<a href="#l1.2691"></a><span id="l1.2691" class="difflineminus">-    }</span>
<a href="#l1.2692"></a><span id="l1.2692" class="difflineminus">-    else // standalone msg window</span>
<a href="#l1.2693"></a><span id="l1.2693" class="difflineminus">-    {</span>
<a href="#l1.2694"></a><span id="l1.2694" class="difflineminus">-      MarkMessageAsRead(msgHdr);</span>
<a href="#l1.2695"></a><span id="l1.2695" class="difflineminus">-    }</span>
<a href="#l1.2696"></a><span id="l1.2696" class="difflineminus">-  }</span>
<a href="#l1.2697"></a><span id="l1.2697" class="difflineminus">-</span>
<a href="#l1.2698"></a><span id="l1.2698" class="difflineminus">-  // See if MDN was requested but has not been sent.</span>
<a href="#l1.2699"></a><span id="l1.2699" class="difflineminus">-  HandleMDNResponse(aUrl);</span>
<a href="#l1.2700"></a><span id="l1.2700" class="difflineminus">-</span>
<a href="#l1.2701"></a><span id="l1.2701" class="difflineminus">-  if (!gFolderDisplay.selectedMessageIsImap)</span>
<a href="#l1.2702"></a><span id="l1.2702" class="difflineminus">-    return;</span>
<a href="#l1.2703"></a><span id="l1.2703" class="difflineminus">-</span>
<a href="#l1.2704"></a><span id="l1.2704" class="difflineminus">-  var imapServer = folder.server.QueryInterface(Components.interfaces.nsIImapIncomingServer);</span>
<a href="#l1.2705"></a><span id="l1.2705" class="difflineminus">-  if (imapServer.storeReadMailInPFC)</span>
<a href="#l1.2706"></a><span id="l1.2706" class="difflineminus">-  {</span>
<a href="#l1.2707"></a><span id="l1.2707" class="difflineminus">-    // Look in read mail PFC for msg with same msg id - if we find one,</span>
<a href="#l1.2708"></a><span id="l1.2708" class="difflineminus">-    // don't put this message in the read mail pfc.</span>
<a href="#l1.2709"></a><span id="l1.2709" class="difflineminus">-    var outputPFC = imapServer.GetReadMailPFC(true);</span>
<a href="#l1.2710"></a><span id="l1.2710" class="difflineminus">-</span>
<a href="#l1.2711"></a><span id="l1.2711" class="difflineminus">-    if (msgHdr &amp;&amp; msgHdr.messageId.length &gt; 0)</span>
<a href="#l1.2712"></a><span id="l1.2712" class="difflineminus">-    {</span>
<a href="#l1.2713"></a><span id="l1.2713" class="difflineminus">-      var readMailDB = outputPFC.msgDatabase;</span>
<a href="#l1.2714"></a><span id="l1.2714" class="difflineminus">-      if (readMailDB &amp;&amp; readMailDB.getMsgHdrForMessageID(msgHdr.messageId))</span>
<a href="#l1.2715"></a><span id="l1.2715" class="difflineminus">-        return; // Don't copy to offline folder.</span>
<a href="#l1.2716"></a><span id="l1.2716" class="difflineminus">-    }</span>
<a href="#l1.2717"></a><span id="l1.2717" class="difflineminus">-</span>
<a href="#l1.2718"></a><span id="l1.2718" class="difflineminus">-    var messages = Components.classes[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l1.2719"></a><span id="l1.2719" class="difflineminus">-                              .createInstance(Components.interfaces.nsIMutableArray);</span>
<a href="#l1.2720"></a><span id="l1.2720" class="difflineminus">-    messages.appendElement(msgHdr, false);</span>
<a href="#l1.2721"></a><span id="l1.2721" class="difflineminus">-    outputPFC.copyMessages(folder, messages, false /*isMove*/,</span>
<a href="#l1.2722"></a><span id="l1.2722" class="difflineminus">-                            msgWindow /*nsIMsgWindow*/, null /*listener*/,</span>
<a href="#l1.2723"></a><span id="l1.2723" class="difflineminus">-                            false /*isFolder*/, false /*allowUndo*/);</span>
<a href="#l1.2724"></a><span id="l1.2724" class="difflineminus">-  }</span>
<a href="#l1.2725"></a><span id="l1.2725" class="difflineminus">-}</span>
<a href="#l1.2726"></a><span id="l1.2726" class="difflineminus">-</span>
<a href="#l1.2727"></a><span id="l1.2727" class="difflineminus">-/**</span>
<a href="#l1.2728"></a><span id="l1.2728" class="difflineminus">- * This function handles all mdn response generation (ie, imap and pop).</span>
<a href="#l1.2729"></a><span id="l1.2729" class="difflineminus">- * For pop the msg uid can be 0 (ie, 1st msg in a local folder) so no</span>
<a href="#l1.2730"></a><span id="l1.2730" class="difflineminus">- * need to check uid here. No one seems to set mimeHeaders to null so</span>
<a href="#l1.2731"></a><span id="l1.2731" class="difflineminus">- * no need to check it either.</span>
<a href="#l1.2732"></a><span id="l1.2732" class="difflineminus">- */</span>
<a href="#l1.2733"></a><span id="l1.2733" class="difflineminus">-function HandleMDNResponse(aUrl)</span>
<a href="#l1.2734"></a><span id="l1.2734" class="difflineminus">-{</span>
<a href="#l1.2735"></a><span id="l1.2735" class="difflineminus">-  if (!aUrl)</span>
<a href="#l1.2736"></a><span id="l1.2736" class="difflineminus">-    return;</span>
<a href="#l1.2737"></a><span id="l1.2737" class="difflineminus">-</span>
<a href="#l1.2738"></a><span id="l1.2738" class="difflineminus">-  var msgFolder = aUrl.folder;</span>
<a href="#l1.2739"></a><span id="l1.2739" class="difflineminus">-  var msgHdr = gFolderDisplay.selectedMessage;</span>
<a href="#l1.2740"></a><span id="l1.2740" class="difflineminus">-  if (!msgFolder || !msgHdr || gFolderDisplay.selectedMessageIsNews)</span>
<a href="#l1.2741"></a><span id="l1.2741" class="difflineminus">-    return;</span>
<a href="#l1.2742"></a><span id="l1.2742" class="difflineminus">-</span>
<a href="#l1.2743"></a><span id="l1.2743" class="difflineminus">-  // if the message is marked as junk, do NOT attempt to process a return receipt</span>
<a href="#l1.2744"></a><span id="l1.2744" class="difflineminus">-  // in order to better protect the user</span>
<a href="#l1.2745"></a><span id="l1.2745" class="difflineminus">-  if (SelectedMessagesAreJunk())</span>
<a href="#l1.2746"></a><span id="l1.2746" class="difflineminus">-    return;</span>
<a href="#l1.2747"></a><span id="l1.2747" class="difflineminus">-</span>
<a href="#l1.2748"></a><span id="l1.2748" class="difflineminus">-  var mimeHdr;</span>
<a href="#l1.2749"></a><span id="l1.2749" class="difflineminus">-</span>
<a href="#l1.2750"></a><span id="l1.2750" class="difflineminus">-  try {</span>
<a href="#l1.2751"></a><span id="l1.2751" class="difflineminus">-    mimeHdr = aUrl.mimeHeaders;</span>
<a href="#l1.2752"></a><span id="l1.2752" class="difflineminus">-  } catch (ex) {</span>
<a href="#l1.2753"></a><span id="l1.2753" class="difflineminus">-    return;</span>
<a href="#l1.2754"></a><span id="l1.2754" class="difflineminus">-  }</span>
<a href="#l1.2755"></a><span id="l1.2755" class="difflineminus">-</span>
<a href="#l1.2756"></a><span id="l1.2756" class="difflineminus">-  // If we didn't get the message id when we downloaded the message header,</span>
<a href="#l1.2757"></a><span id="l1.2757" class="difflineminus">-  // we cons up an md5: message id. If we've done that, we'll try to extract</span>
<a href="#l1.2758"></a><span id="l1.2758" class="difflineminus">-  // the message id out of the mime headers for the whole message.</span>
<a href="#l1.2759"></a><span id="l1.2759" class="difflineminus">-  var msgId = msgHdr.messageId;</span>
<a href="#l1.2760"></a><span id="l1.2760" class="difflineminus">-  if (msgId.split(&quot;:&quot;)[0] == &quot;md5&quot;)</span>
<a href="#l1.2761"></a><span id="l1.2761" class="difflineminus">-  {</span>
<a href="#l1.2762"></a><span id="l1.2762" class="difflineminus">-    var mimeMsgId = mimeHdr.extractHeader(&quot;Message-Id&quot;, false);</span>
<a href="#l1.2763"></a><span id="l1.2763" class="difflineminus">-    if (mimeMsgId)</span>
<a href="#l1.2764"></a><span id="l1.2764" class="difflineminus">-      msgHdr.messageId = mimeMsgId;</span>
<a href="#l1.2765"></a><span id="l1.2765" class="difflineminus">-  }</span>
<a href="#l1.2766"></a><span id="l1.2766" class="difflineminus">-</span>
<a href="#l1.2767"></a><span id="l1.2767" class="difflineminus">-  // After a msg is downloaded it's already marked READ at this point so we must check if</span>
<a href="#l1.2768"></a><span id="l1.2768" class="difflineminus">-  // the msg has a &quot;Disposition-Notification-To&quot; header and no MDN report has been sent yet.</span>
<a href="#l1.2769"></a><span id="l1.2769" class="difflineminus">-  var msgFlags = msgHdr.flags;</span>
<a href="#l1.2770"></a><span id="l1.2770" class="difflineminus">-  if ((msgFlags &amp; Components.interfaces.nsMsgMessageFlags.IMAPDeleted) ||</span>
<a href="#l1.2771"></a><span id="l1.2771" class="difflineminus">-      (msgFlags &amp; Components.interfaces.nsMsgMessageFlags.MDNReportSent))</span>
<a href="#l1.2772"></a><span id="l1.2772" class="difflineminus">-    return;</span>
<a href="#l1.2773"></a><span id="l1.2773" class="difflineminus">-</span>
<a href="#l1.2774"></a><span id="l1.2774" class="difflineminus">-  var DNTHeader = mimeHdr.extractHeader(&quot;Disposition-Notification-To&quot;, false);</span>
<a href="#l1.2775"></a><span id="l1.2775" class="difflineminus">-  var oldDNTHeader = mimeHdr.extractHeader(&quot;Return-Receipt-To&quot;, false);</span>
<a href="#l1.2776"></a><span id="l1.2776" class="difflineminus">-  if (!DNTHeader &amp;&amp; !oldDNTHeader)</span>
<a href="#l1.2777"></a><span id="l1.2777" class="difflineminus">-    return;</span>
<a href="#l1.2778"></a><span id="l1.2778" class="difflineminus">-</span>
<a href="#l1.2779"></a><span id="l1.2779" class="difflineminus">-  // Everything looks good so far, let's generate the MDN response.</span>
<a href="#l1.2780"></a><span id="l1.2780" class="difflineminus">-  var mdnGenerator = Components.classes[&quot;@mozilla.org/messenger-mdn/generator;1&quot;]</span>
<a href="#l1.2781"></a><span id="l1.2781" class="difflineminus">-                               .createInstance(Components.interfaces.nsIMsgMdnGenerator);</span>
<a href="#l1.2782"></a><span id="l1.2782" class="difflineminus">-  const MDN_DISPOSE_TYPE_DISPLAYED = 0;</span>
<a href="#l1.2783"></a><span id="l1.2783" class="difflineminus">-  mdnGenerator.process(MDN_DISPOSE_TYPE_DISPLAYED, msgWindow, msgFolder,</span>
<a href="#l1.2784"></a><span id="l1.2784" class="difflineminus">-                       msgHdr.messageKey, mimeHdr, false);</span>
<a href="#l1.2785"></a><span id="l1.2785" class="difflineminus">-</span>
<a href="#l1.2786"></a><span id="l1.2786" class="difflineminus">-  // Reset mark msg MDN &quot;Sent&quot; and &quot;Not Needed&quot;.</span>
<a href="#l1.2787"></a><span id="l1.2787" class="difflineminus">-  msgHdr.flags = (msgFlags &amp;</span>
<a href="#l1.2788"></a><span id="l1.2788" class="difflineminus">-                  ~Components.interfaces.nsMsgMessageFlags.MDNReportNeeded);</span>
<a href="#l1.2789"></a><span id="l1.2789" class="difflineminus">-  msgHdr.OrFlags(Components.interfaces.nsMsgMessageFlags.MDNReportSent);</span>
<a href="#l1.2790"></a><span id="l1.2790" class="difflineminus">-</span>
<a href="#l1.2791"></a><span id="l1.2791" class="difflineminus">-  // Commit db changes.</span>
<a href="#l1.2792"></a><span id="l1.2792" class="difflineminus">-  var msgdb = msgFolder.msgDatabase;</span>
<a href="#l1.2793"></a><span id="l1.2793" class="difflineminus">-  if (msgdb)</span>
<a href="#l1.2794"></a><span id="l1.2794" class="difflineminus">-    msgdb.Commit(ADDR_DB_LARGE_COMMIT);</span>
<a href="#l1.2795"></a><span id="l1.2795" class="difflineminus">-}</span>
<a href="#l1.2796"></a><span id="l1.2796" class="difflineminus">-</span>
<a href="#l1.2797"></a><span id="l1.2797" class="difflineminus">-function QuickSearchFocus()</span>
<a href="#l1.2798"></a><span id="l1.2798" class="difflineminus">-{</span>
<a href="#l1.2799"></a><span id="l1.2799" class="difflineminus">-  var quickSearchTextBox = document.getElementById('searchInput');</span>
<a href="#l1.2800"></a><span id="l1.2800" class="difflineminus">-  if (quickSearchTextBox)</span>
<a href="#l1.2801"></a><span id="l1.2801" class="difflineminus">-    quickSearchTextBox.focus();</span>
<a href="#l1.2802"></a><span id="l1.2802" class="difflineminus">-}</span>
<a href="#l1.2803"></a><span id="l1.2803" class="difflineminus">-</span>
<a href="#l1.2804"></a><span id="l1.2804" class="difflineminus">-/**</span>
<a href="#l1.2805"></a><span id="l1.2805" class="difflineminus">- * Opens a search window with the given folder, or the displayed one if none is</span>
<a href="#l1.2806"></a><span id="l1.2806" class="difflineminus">- * chosen.</span>
<a href="#l1.2807"></a><span id="l1.2807" class="difflineminus">- *</span>
<a href="#l1.2808"></a><span id="l1.2808" class="difflineminus">- * @param [aFolder] the folder to open the search window for, if different from</span>
<a href="#l1.2809"></a><span id="l1.2809" class="difflineminus">- *                  the displayed one</span>
<a href="#l1.2810"></a><span id="l1.2810" class="difflineminus">- */</span>
<a href="#l1.2811"></a><span id="l1.2811" class="difflineminus">-function MsgSearchMessages(aFolder)</span>
<a href="#l1.2812"></a><span id="l1.2812" class="difflineminus">-{</span>
<a href="#l1.2813"></a><span id="l1.2813" class="difflineminus">-  // We always open a new search dialog for each search command</span>
<a href="#l1.2814"></a><span id="l1.2814" class="difflineminus">-  window.openDialog(&quot;chrome://messenger/content/SearchDialog.xul&quot;, &quot;_blank&quot;,</span>
<a href="#l1.2815"></a><span id="l1.2815" class="difflineminus">-                    &quot;chrome,resizable,status,centerscreen,dialog=no&quot;,</span>
<a href="#l1.2816"></a><span id="l1.2816" class="difflineminus">-                    { folder: aFolder || gFolderDisplay.displayedFolder });</span>
<a href="#l1.2817"></a><span id="l1.2817" class="difflineminus">-}</span>
<a href="#l1.2818"></a><span id="l1.2818" class="difflineminus">-</span>
<a href="#l1.2819"></a><span id="l1.2819" class="difflineminus">-function MsgJunkMailInfo(aCheckFirstUse)</span>
<a href="#l1.2820"></a><span id="l1.2820" class="difflineminus">-{</span>
<a href="#l1.2821"></a><span id="l1.2821" class="difflineminus">-  if (aCheckFirstUse) {</span>
<a href="#l1.2822"></a><span id="l1.2822" class="difflineminus">-    if (!pref.getBoolPref(&quot;mailnews.ui.junk.firstuse&quot;))</span>
<a href="#l1.2823"></a><span id="l1.2823" class="difflineminus">-      return;</span>
<a href="#l1.2824"></a><span id="l1.2824" class="difflineminus">-    pref.setBoolPref(&quot;mailnews.ui.junk.firstuse&quot;, false);</span>
<a href="#l1.2825"></a><span id="l1.2825" class="difflineminus">-</span>
<a href="#l1.2826"></a><span id="l1.2826" class="difflineminus">-    // check to see if this is an existing profile where the user has started using</span>
<a href="#l1.2827"></a><span id="l1.2827" class="difflineminus">-    // the junk mail feature already</span>
<a href="#l1.2828"></a><span id="l1.2828" class="difflineminus">-    var junkmailPlugin = Components.classes[&quot;@mozilla.org/messenger/filter-plugin;1?name=bayesianfilter&quot;]</span>
<a href="#l1.2829"></a><span id="l1.2829" class="difflineminus">-                                   .getService(Components.interfaces.nsIJunkMailPlugin);</span>
<a href="#l1.2830"></a><span id="l1.2830" class="difflineminus">-    if (junkmailPlugin.userHasClassified)</span>
<a href="#l1.2831"></a><span id="l1.2831" class="difflineminus">-      return;</span>
<a href="#l1.2832"></a><span id="l1.2832" class="difflineminus">-  }</span>
<a href="#l1.2833"></a><span id="l1.2833" class="difflineminus">-</span>
<a href="#l1.2834"></a><span id="l1.2834" class="difflineminus">-  var desiredWindow = GetWindowByWindowType(&quot;mailnews:junkmailinfo&quot;);</span>
<a href="#l1.2835"></a><span id="l1.2835" class="difflineminus">-</span>
<a href="#l1.2836"></a><span id="l1.2836" class="difflineminus">-  if (desiredWindow)</span>
<a href="#l1.2837"></a><span id="l1.2837" class="difflineminus">-    desiredWindow.focus();</span>
<a href="#l1.2838"></a><span id="l1.2838" class="difflineminus">-  else</span>
<a href="#l1.2839"></a><span id="l1.2839" class="difflineminus">-    window.openDialog(&quot;chrome://messenger/content/junkMailInfo.xul&quot;,</span>
<a href="#l1.2840"></a><span id="l1.2840" class="difflineminus">-                      &quot;mailnews:junkmailinfo&quot;,</span>
<a href="#l1.2841"></a><span id="l1.2841" class="difflineminus">-                      &quot;centerscreen,resizeable=no,titlebar,chrome,modal&quot;, null);</span>
<a href="#l1.2842"></a><span id="l1.2842" class="difflineminus">-}</span>
<a href="#l1.2843"></a><span id="l1.2843" class="difflineminus">-</span>
<a href="#l1.2844"></a><span id="l1.2844" class="difflineminus">-function MsgSearchAddresses()</span>
<a href="#l1.2845"></a><span id="l1.2845" class="difflineminus">-{</span>
<a href="#l1.2846"></a><span id="l1.2846" class="difflineminus">-  var args = { directory: null };</span>
<a href="#l1.2847"></a><span id="l1.2847" class="difflineminus">-  OpenOrFocusWindow(args, &quot;mailnews:absearch&quot;, &quot;chrome://messenger/content/ABSearchDialog.xul&quot;);</span>
<a href="#l1.2848"></a><span id="l1.2848" class="difflineminus">-}</span>
<a href="#l1.2849"></a><span id="l1.2849" class="difflineminus">-</span>
<a href="#l1.2850"></a><span id="l1.2850" class="difflineminus">-function MsgFilterList(args)</span>
<a href="#l1.2851"></a><span id="l1.2851" class="difflineminus">-{</span>
<a href="#l1.2852"></a><span id="l1.2852" class="difflineminus">-  OpenOrFocusWindow(args, &quot;mailnews:filterlist&quot;, &quot;chrome://messenger/content/FilterListDialog.xul&quot;);</span>
<a href="#l1.2853"></a><span id="l1.2853" class="difflineminus">-}</span>
<a href="#l1.2854"></a><span id="l1.2854" class="difflineminus">-</span>
<a href="#l1.2855"></a><span id="l1.2855" class="difflineminus">-function GetWindowByWindowType(windowType)</span>
<a href="#l1.2856"></a><span id="l1.2856" class="difflineminus">-{</span>
<a href="#l1.2857"></a><span id="l1.2857" class="difflineminus">-  var windowManager = Components.classes['@mozilla.org/appshell/window-mediator;1']</span>
<a href="#l1.2858"></a><span id="l1.2858" class="difflineminus">-                                .getService(Components.interfaces.nsIWindowMediator);</span>
<a href="#l1.2859"></a><span id="l1.2859" class="difflineminus">-  return windowManager.getMostRecentWindow(windowType);</span>
<a href="#l1.2860"></a><span id="l1.2860" class="difflineminus">-}</span>
<a href="#l1.2861"></a><span id="l1.2861" class="difflineminus">-</span>
<a href="#l1.2862"></a><span id="l1.2862" class="difflineminus">-function OpenOrFocusWindow(args, windowType, chromeURL)</span>
<a href="#l1.2863"></a><span id="l1.2863" class="difflineminus">-{</span>
<a href="#l1.2864"></a><span id="l1.2864" class="difflineminus">-  var desiredWindow = GetWindowByWindowType(windowType);</span>
<a href="#l1.2865"></a><span id="l1.2865" class="difflineminus">-</span>
<a href="#l1.2866"></a><span id="l1.2866" class="difflineminus">-  if (desiredWindow) {</span>
<a href="#l1.2867"></a><span id="l1.2867" class="difflineminus">-    desiredWindow.focus();</span>
<a href="#l1.2868"></a><span id="l1.2868" class="difflineminus">-    if (&quot;refresh&quot; in args &amp;&amp; args.refresh)</span>
<a href="#l1.2869"></a><span id="l1.2869" class="difflineminus">-      desiredWindow.refresh();</span>
<a href="#l1.2870"></a><span id="l1.2870" class="difflineminus">-  }</span>
<a href="#l1.2871"></a><span id="l1.2871" class="difflineminus">-  else</span>
<a href="#l1.2872"></a><span id="l1.2872" class="difflineminus">-    window.openDialog(chromeURL, &quot;&quot;, &quot;chrome,resizable,status,centerscreen,dialog=no&quot;, args);</span>
<a href="#l1.2873"></a><span id="l1.2873" class="difflineminus">-}</span>
<a href="#l1.2874"></a><span id="l1.2874" class="difflineminus">-</span>
<a href="#l1.2875"></a><span id="l1.2875" class="difflineminus">-// Switch between message body (feed summary) and content-base url in</span>
<a href="#l1.2876"></a><span id="l1.2876" class="difflineminus">-// the Message Pane, called in MsgOpenSelectedMessages</span>
<a href="#l1.2877"></a><span id="l1.2877" class="difflineminus">-function FeedSetContentViewToggle()</span>
<a href="#l1.2878"></a><span id="l1.2878" class="difflineminus">-{</span>
<a href="#l1.2879"></a><span id="l1.2879" class="difflineminus">-  gShowFeedSummaryToggle = true;</span>
<a href="#l1.2880"></a><span id="l1.2880" class="difflineminus">-  FeedSetContentView(gShowFeedSummary ? 0 : 1);</span>
<a href="#l1.2881"></a><span id="l1.2881" class="difflineminus">-}</span>
<a href="#l1.2882"></a><span id="l1.2882" class="difflineminus">-</span>
<a href="#l1.2883"></a><span id="l1.2883" class="difflineminus">-// Check message format</span>
<a href="#l1.2884"></a><span id="l1.2884" class="difflineminus">-function FeedCheckContentFormat()</span>
<a href="#l1.2885"></a><span id="l1.2885" class="difflineminus">-{</span>
<a href="#l1.2886"></a><span id="l1.2886" class="difflineminus">-  // Not an rss message</span>
<a href="#l1.2887"></a><span id="l1.2887" class="difflineminus">-  if (!gFolderDisplay.selectedMessageIsFeed)</span>
<a href="#l1.2888"></a><span id="l1.2888" class="difflineminus">-    return false;</span>
<a href="#l1.2889"></a><span id="l1.2889" class="difflineminus">-</span>
<a href="#l1.2890"></a><span id="l1.2890" class="difflineminus">-  var contentWindowDoc = window.top.content.document;</span>
<a href="#l1.2891"></a><span id="l1.2891" class="difflineminus">-</span>
<a href="#l1.2892"></a><span id="l1.2892" class="difflineminus">-  // Thunderbird 2 rss messages with 'Show article summary' not selected,</span>
<a href="#l1.2893"></a><span id="l1.2893" class="difflineminus">-  // ie message body constructed to show web page in an iframe, can't show</span>
<a href="#l1.2894"></a><span id="l1.2894" class="difflineminus">-  // a summary - notify user.</span>
<a href="#l1.2895"></a><span id="l1.2895" class="difflineminus">-  var rssIframe = contentWindowDoc.getElementById('_mailrssiframe');</span>
<a href="#l1.2896"></a><span id="l1.2896" class="difflineminus">-  if (rssIframe) {</span>
<a href="#l1.2897"></a><span id="l1.2897" class="difflineminus">-    if (gShowFeedSummaryToggle ||</span>
<a href="#l1.2898"></a><span id="l1.2898" class="difflineminus">-        pref.getIntPref(&quot;rss.show.summary&quot;) == 1) {</span>
<a href="#l1.2899"></a><span id="l1.2899" class="difflineminus">-      var titleMsg = gMessengerBundle.getString(&quot;feedNoSummaryTitle&quot;);</span>
<a href="#l1.2900"></a><span id="l1.2900" class="difflineminus">-      var dialogMsg = gMessengerBundle.getString(&quot;feedNoSummaryAlert&quot;);</span>
<a href="#l1.2901"></a><span id="l1.2901" class="difflineminus">-      var promptService = Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l1.2902"></a><span id="l1.2902" class="difflineminus">-                                    .getService(Components.interfaces.nsIPromptService);</span>
<a href="#l1.2903"></a><span id="l1.2903" class="difflineminus">-      promptService.alert(window, titleMsg, dialogMsg);</span>
<a href="#l1.2904"></a><span id="l1.2904" class="difflineminus">-      gShowFeedSummaryToggle = false;</span>
<a href="#l1.2905"></a><span id="l1.2905" class="difflineminus">-    }</span>
<a href="#l1.2906"></a><span id="l1.2906" class="difflineminus">-    return false;</span>
<a href="#l1.2907"></a><span id="l1.2907" class="difflineminus">-  }</span>
<a href="#l1.2908"></a><span id="l1.2908" class="difflineminus">-</span>
<a href="#l1.2909"></a><span id="l1.2909" class="difflineminus">-  return true;</span>
<a href="#l1.2910"></a><span id="l1.2910" class="difflineminus">-}</span>
<a href="#l1.2911"></a><span id="l1.2911" class="difflineminus">-</span>
<a href="#l1.2912"></a><span id="l1.2912" class="difflineminus">-// View summary or load web page for feeds</span>
<a href="#l1.2913"></a><span id="l1.2913" class="difflineminus">-function FeedSetContentView(val)</span>
<a href="#l1.2914"></a><span id="l1.2914" class="difflineminus">-{</span>
<a href="#l1.2915"></a><span id="l1.2915" class="difflineminus">-  // Check it..</span>
<a href="#l1.2916"></a><span id="l1.2916" class="difflineminus">-  if (!FeedCheckContentFormat())</span>
<a href="#l1.2917"></a><span id="l1.2917" class="difflineminus">-    return;</span>
<a href="#l1.2918"></a><span id="l1.2918" class="difflineminus">-</span>
<a href="#l1.2919"></a><span id="l1.2919" class="difflineminus">-  var showSummary;</span>
<a href="#l1.2920"></a><span id="l1.2920" class="difflineminus">-  var wintype = document.documentElement.getAttribute('windowtype');</span>
<a href="#l1.2921"></a><span id="l1.2921" class="difflineminus">-  var contentBase = currentHeaderData[&quot;content-base&quot;];</span>
<a href="#l1.2922"></a><span id="l1.2922" class="difflineminus">-  var contentWindowDoc = window.top.content.document;</span>
<a href="#l1.2923"></a><span id="l1.2923" class="difflineminus">-  var divHTML = new XPCNativeWrapper(contentWindowDoc,</span>
<a href="#l1.2924"></a><span id="l1.2924" class="difflineminus">-                      &quot;getElementsByClassName()&quot;)</span>
<a href="#l1.2925"></a><span id="l1.2925" class="difflineminus">-                      .getElementsByClassName(&quot;moz-text-html&quot;)[0];</span>
<a href="#l1.2926"></a><span id="l1.2926" class="difflineminus">-  var divPLAIN = new XPCNativeWrapper(contentWindowDoc,</span>
<a href="#l1.2927"></a><span id="l1.2927" class="difflineminus">-                      &quot;getElementsByClassName()&quot;)</span>
<a href="#l1.2928"></a><span id="l1.2928" class="difflineminus">-                      .getElementsByClassName(&quot;moz-text-plain&quot;)[0];</span>
<a href="#l1.2929"></a><span id="l1.2929" class="difflineminus">-</span>
<a href="#l1.2930"></a><span id="l1.2930" class="difflineminus">-  if (val == null)</span>
<a href="#l1.2931"></a><span id="l1.2931" class="difflineminus">-    // Not passed a value, so generic select unless in toggle mode</span>
<a href="#l1.2932"></a><span id="l1.2932" class="difflineminus">-    if (!gShowFeedSummaryToggle)</span>
<a href="#l1.2933"></a><span id="l1.2933" class="difflineminus">-      // Not in toggle mode, get prefs</span>
<a href="#l1.2934"></a><span id="l1.2934" class="difflineminus">-      val = pref.getIntPref(&quot;rss.show.summary&quot;);</span>
<a href="#l1.2935"></a><span id="l1.2935" class="difflineminus">-    else {</span>
<a href="#l1.2936"></a><span id="l1.2936" class="difflineminus">-      // Coming in again from toggle, summary already 'reloadMessage'ed,</span>
<a href="#l1.2937"></a><span id="l1.2937" class="difflineminus">-      // just need to set display for summary on.</span>
<a href="#l1.2938"></a><span id="l1.2938" class="difflineminus">-      gShowFeedSummaryToggle = false;</span>
<a href="#l1.2939"></a><span id="l1.2939" class="difflineminus">-      if (divHTML)</span>
<a href="#l1.2940"></a><span id="l1.2940" class="difflineminus">-        divHTML.parentNode.setAttribute(&quot;selected&quot;, gShowFeedSummary);</span>
<a href="#l1.2941"></a><span id="l1.2941" class="difflineminus">-      if (divPLAIN)</span>
<a href="#l1.2942"></a><span id="l1.2942" class="difflineminus">-        divPLAIN.parentNode.setAttribute(&quot;selected&quot;, gShowFeedSummary);</span>
<a href="#l1.2943"></a><span id="l1.2943" class="difflineminus">-      return;</span>
<a href="#l1.2944"></a><span id="l1.2944" class="difflineminus">-    }</span>
<a href="#l1.2945"></a><span id="l1.2945" class="difflineminus">-</span>
<a href="#l1.2946"></a><span id="l1.2946" class="difflineminus">-  switch (val) {</span>
<a href="#l1.2947"></a><span id="l1.2947" class="difflineminus">-    case 0:</span>
<a href="#l1.2948"></a><span id="l1.2948" class="difflineminus">-      showSummary = false;</span>
<a href="#l1.2949"></a><span id="l1.2949" class="difflineminus">-      break;</span>
<a href="#l1.2950"></a><span id="l1.2950" class="difflineminus">-    case 1:</span>
<a href="#l1.2951"></a><span id="l1.2951" class="difflineminus">-      showSummary = true</span>
<a href="#l1.2952"></a><span id="l1.2952" class="difflineminus">-      break;</span>
<a href="#l1.2953"></a><span id="l1.2953" class="difflineminus">-    case 2:</span>
<a href="#l1.2954"></a><span id="l1.2954" class="difflineminus">-      if (wintype == &quot;mail:3pane&quot;) {</span>
<a href="#l1.2955"></a><span id="l1.2955" class="difflineminus">-        // Get quickmode per feed pref from feeds.rdf</span>
<a href="#l1.2956"></a><span id="l1.2956" class="difflineminus">-        var quickMode, targetRes;</span>
<a href="#l1.2957"></a><span id="l1.2957" class="difflineminus">-        var scriptLoader = Components.classes[&quot;@mozilla.org/moz/jssubscript-loader;1&quot;]</span>
<a href="#l1.2958"></a><span id="l1.2958" class="difflineminus">-                           .getService(Components.interfaces.mozIJSSubScriptLoader);</span>
<a href="#l1.2959"></a><span id="l1.2959" class="difflineminus">-        if (scriptLoader &amp;&amp; typeof FZ_NS == 'undefined')</span>
<a href="#l1.2960"></a><span id="l1.2960" class="difflineminus">-          scriptLoader.loadSubScript(&quot;chrome://messenger-newsblog/content/utils.js&quot;);</span>
<a href="#l1.2961"></a><span id="l1.2961" class="difflineminus">-        try</span>
<a href="#l1.2962"></a><span id="l1.2962" class="difflineminus">-        {</span>
<a href="#l1.2963"></a><span id="l1.2963" class="difflineminus">-          var targetRes = getParentTargetForChildResource(</span>
<a href="#l1.2964"></a><span id="l1.2964" class="difflineminus">-                          gFolderDisplay.displayedFolder.URI,</span>
<a href="#l1.2965"></a><span id="l1.2965" class="difflineminus">-                          FZ_QUICKMODE,</span>
<a href="#l1.2966"></a><span id="l1.2966" class="difflineminus">-                          gFolderDisplay.displayedFolder.server);</span>
<a href="#l1.2967"></a><span id="l1.2967" class="difflineminus">-        }</span>
<a href="#l1.2968"></a><span id="l1.2968" class="difflineminus">-        catch (ex) {};</span>
<a href="#l1.2969"></a><span id="l1.2969" class="difflineminus">-</span>
<a href="#l1.2970"></a><span id="l1.2970" class="difflineminus">-        if (targetRes)</span>
<a href="#l1.2971"></a><span id="l1.2971" class="difflineminus">-        {</span>
<a href="#l1.2972"></a><span id="l1.2972" class="difflineminus">-          quickMode = targetRes.QueryInterface(Components.interfaces</span>
<a href="#l1.2973"></a><span id="l1.2973" class="difflineminus">-                               .nsIRDFLiteral);</span>
<a href="#l1.2974"></a><span id="l1.2974" class="difflineminus">-          quickMode = quickMode.Value;</span>
<a href="#l1.2975"></a><span id="l1.2975" class="difflineminus">-          quickMode = eval(quickMode);</span>
<a href="#l1.2976"></a><span id="l1.2976" class="difflineminus">-        }</span>
<a href="#l1.2977"></a><span id="l1.2977" class="difflineminus">-        else</span>
<a href="#l1.2978"></a><span id="l1.2978" class="difflineminus">-          // Do not have this item's feed anymore in feeds.rdf though its</span>
<a href="#l1.2979"></a><span id="l1.2979" class="difflineminus">-          // message folder remains and its items exist in feeditems.rdf</span>
<a href="#l1.2980"></a><span id="l1.2980" class="difflineminus">-          // (Bug 309449), or the item has been moved to another folder,</span>
<a href="#l1.2981"></a><span id="l1.2981" class="difflineminus">-          // or some error on the file. Default to show summary.</span>
<a href="#l1.2982"></a><span id="l1.2982" class="difflineminus">-          quickMode = true;</span>
<a href="#l1.2983"></a><span id="l1.2983" class="difflineminus">-      }</span>
<a href="#l1.2984"></a><span id="l1.2984" class="difflineminus">-      showSummary = quickMode;</span>
<a href="#l1.2985"></a><span id="l1.2985" class="difflineminus">-      break;</span>
<a href="#l1.2986"></a><span id="l1.2986" class="difflineminus">-  }</span>
<a href="#l1.2987"></a><span id="l1.2987" class="difflineminus">-</span>
<a href="#l1.2988"></a><span id="l1.2988" class="difflineminus">-  gShowFeedSummary = showSummary;</span>
<a href="#l1.2989"></a><span id="l1.2989" class="difflineminus">-</span>
<a href="#l1.2990"></a><span id="l1.2990" class="difflineminus">-  // Message window - here only if GetFeedOpenHandler() = 0 or 1</span>
<a href="#l1.2991"></a><span id="l1.2991" class="difflineminus">-  if (wintype == &quot;mail:messageWindow&quot;) {</span>
<a href="#l1.2992"></a><span id="l1.2992" class="difflineminus">-    // Set global var for message window</span>
<a href="#l1.2993"></a><span id="l1.2993" class="difflineminus">-    gShowFeedSummary = GetFeedOpenHandler();</span>
<a href="#l1.2994"></a><span id="l1.2994" class="difflineminus">-    // Get pref since may be reusable message window and changed in 3pane</span>
<a href="#l1.2995"></a><span id="l1.2995" class="difflineminus">-    showSummary = gShowFeedSummary == 0 ? false : true;</span>
<a href="#l1.2996"></a><span id="l1.2996" class="difflineminus">-  }</span>
<a href="#l1.2997"></a><span id="l1.2997" class="difflineminus">-</span>
<a href="#l1.2998"></a><span id="l1.2998" class="difflineminus">-  if (divHTML)</span>
<a href="#l1.2999"></a><span id="l1.2999" class="difflineminus">-    divHTML.parentNode.setAttribute(&quot;selected&quot;, showSummary);</span>
<a href="#l1.3000"></a><span id="l1.3000" class="difflineminus">-  if (divPLAIN)</span>
<a href="#l1.3001"></a><span id="l1.3001" class="difflineminus">-    divPLAIN.parentNode.setAttribute(&quot;selected&quot;, showSummary);</span>
<a href="#l1.3002"></a><span id="l1.3002" class="difflineminus">-</span>
<a href="#l1.3003"></a><span id="l1.3003" class="difflineminus">-  if (showSummary) {</span>
<a href="#l1.3004"></a><span id="l1.3004" class="difflineminus">-    if (gShowFeedSummaryToggle) {</span>
<a href="#l1.3005"></a><span id="l1.3005" class="difflineminus">-      if (gDBView &amp;&amp; GetNumSelectedMessages() == 1) {</span>
<a href="#l1.3006"></a><span id="l1.3006" class="difflineminus">-        ReloadMessage();</span>
<a href="#l1.3007"></a><span id="l1.3007" class="difflineminus">-      }</span>
<a href="#l1.3008"></a><span id="l1.3008" class="difflineminus">-    }</span>
<a href="#l1.3009"></a><span id="l1.3009" class="difflineminus">-  }</span>
<a href="#l1.3010"></a><span id="l1.3010" class="difflineminus">-  else if(contentBase.headerValue) {</span>
<a href="#l1.3011"></a><span id="l1.3011" class="difflineminus">-    document.getElementById(&quot;messagepane&quot;)</span>
<a href="#l1.3012"></a><span id="l1.3012" class="difflineminus">-            .loadURI(contentBase.headerValue, null, null);</span>
<a href="#l1.3013"></a><span id="l1.3013" class="difflineminus">-    gShowFeedSummaryToggle = false;</span>
<a href="#l1.3014"></a><span id="l1.3014" class="difflineminus">-  }</span>
<a href="#l1.3015"></a><span id="l1.3015" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/base/content/mailWindowOverlay.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/base/content/mailWindowOverlay.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -1665,664 +1665,16 @@ function CreateToolbarTooltip(document, </span>
<a href="#l2.4"></a><span id="l2.4">   }</span>
<a href="#l2.5"></a><span id="l2.5">   if (tn.hasAttribute(&quot;label&quot;)) {</span>
<a href="#l2.6"></a><span id="l2.6">     event.target.setAttribute(&quot;label&quot;, tn.getAttribute(&quot;label&quot;));</span>
<a href="#l2.7"></a><span id="l2.7">     return true;</span>
<a href="#l2.8"></a><span id="l2.8">   }</span>
<a href="#l2.9"></a><span id="l2.9">   return false;</span>
<a href="#l2.10"></a><span id="l2.10"> }</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-/**</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">- * Displays message &quot;folder&quot;s, mail &quot;message&quot;s, and &quot;glodaList&quot; results.  The</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">- *  commonality is that they all use the &quot;mailContent&quot; panel's folder tree,</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineminus">- *  thread tree, and message pane objects.  This happens for historical reasons,</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineminus">- *  likely involving the fact that prior to the introduction of this</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineminus">- *  abstraction, everything was always stored in global objects.  For the 3.0</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineminus">- *  release cycle we considered avoiding this 'multiplexed' style of operation</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineminus">- *  but decided against moving to making each tab be indepdendent because of</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineminus">- *  presumed complexity.</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineminus">- *</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineminus">- * The tab info objects (as tabmail's currentTabInfo/tabInfo fields contain)</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineminus">- *  have the following attributes specific to our implementation:</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineminus">- *</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineminus">- * @property {string} uriToOpen</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineminus">- * @property {nsIMsgDBView} dbView The database view to use with the thread tree</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineminus">- *     when this tab is displayed.  The value will be assigned to the global</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineminus">- *     gDBView in the process.</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineminus">- * @property {nsIMessenger} messenger Used to preserve &quot;messenger&quot; global value.</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineminus">- *     The messenger object is the keeper of the 'undo' state and navigation</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">- *     history, which is why we do this.</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineminus">- *</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineminus">- * @property {nsIMsgDBHdr} hdr In &quot;message&quot; mode, the header of the message</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineminus">- *     being displayed.</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineminus">- * @property {nsIMsgSearchSession} searchSession Used to preserve gSearchSession</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineminus">- *     global value.</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineminus">- *</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineminus">- */</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineminus">-let mailTabType = {</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineminus">-  name: &quot;mail&quot;,</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineminus">-  panelId: &quot;mailContent&quot;,</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineminus">-  modes: {</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineminus">-    /**</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineminus">-     * The folder view displays the contents of an nsIMsgDBFolder, with the</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineminus">-     *  folder pane (potentially), thread pane (always), and message pane</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineminus">-     *  (potentially) displayed.</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineminus">-     *</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineminus">-     * The actual nsMsgDBView can be any of the following types of things:</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineminus">-     *  - A single folder.</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineminus">-     *    - A quicksearch on a single folder.</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineminus">-     *  - A virtual folder potentially containing messages from multiple</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineminus">-     *    folders. (eShowVirtualFolderResults)</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineminus">-     */</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineminus">-    folder: {</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineminus">-      isDefault: true,</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineminus">-      type: &quot;folder&quot;,</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineminus">-      /// The set of panes that are legal to be displayed in this mode</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineminus">-      legalPanes: {</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineminus">-        folder: true,</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineminus">-        thread: true,</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineminus">-        message: true</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineminus">-      },</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineminus">-      /// The set of panes that are legal when we are showing account central</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineminus">-      accountCentralLegalPanes: {</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineminus">-        folder: true,</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineminus">-        accountCentral: true,</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineminus">-        message: false</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineminus">-      },</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineminus">-      openFirstTab: function(aTab) {</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineminus">-        this.openTab(aTab, true, new MessagePaneDisplayWidget());</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineminus">-        // persistence and restoreTab wants to know if we are the magic first tab</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineminus">-        aTab.firstTab = true;</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineminus">-        aTab.folderDisplay.makeActive();</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineminus">-      },</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineminus">-      /**</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineminus">-       * @param aFolder The nsIMsgFolder to display.</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineminus">-       * @param aMsgHdr Optional message header to display.</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineminus">-       */</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineminus">-      openTab: function(aTab, aArgs) {</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineminus">-        // persistence and restoreTab wants to know if we are the magic first tab</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineminus">-        aTab.firstTab = false;</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineminus">-</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineminus">-        // Get a tab that we can initialize our user preferences from.</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineminus">-        // (We don't want to assume that our immediate predecessor was a</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineminus">-        //  &quot;folder&quot; tab.)</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineminus">-        let modelTab = document.getElementById(&quot;tabmail&quot;)</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineminus">-                         .getTabInfoForCurrentOrFirstModeInstance(aTab.mode);</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineminus">-</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineminus">-        if (modelTab)</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineminus">-          aTab.folderPaneCollapsed = modelTab.folderPaneCollapsed;</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineminus">-</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineminus">-        if (&quot;searchMode&quot; in aArgs)</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineminus">-          aTab.searchState = {'mode': aArgs.searchMode, 'string': ''};</span>
<a href="#l2.94"></a><span id="l2.94" class="difflineminus">-        else if (modelTab)</span>
<a href="#l2.95"></a><span id="l2.95" class="difflineminus">-          aTab.searchState = {'mode': modelTab.searchMode, 'string': ''};</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineminus">-</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineminus">-        // - figure out whether to show the message pane</span>
<a href="#l2.98"></a><span id="l2.98" class="difflineminus">-        let messagePaneShouldBeVisible;</span>
<a href="#l2.99"></a><span id="l2.99" class="difflineminus">-        // explicitly told to us?</span>
<a href="#l2.100"></a><span id="l2.100" class="difflineminus">-        if (&quot;messagePaneVisible&quot; in aArgs)</span>
<a href="#l2.101"></a><span id="l2.101" class="difflineminus">-          messagePaneShouldBeVisible = aArgs.messagePaneVisible;</span>
<a href="#l2.102"></a><span id="l2.102" class="difflineminus">-        // inherit from the previous tab (if we've got one)</span>
<a href="#l2.103"></a><span id="l2.103" class="difflineminus">-        else if (modelTab)</span>
<a href="#l2.104"></a><span id="l2.104" class="difflineminus">-          messagePaneShouldBeVisible = modelTab.messageDisplay.visible;</span>
<a href="#l2.105"></a><span id="l2.105" class="difflineminus">-        // who does't love a message pane?</span>
<a href="#l2.106"></a><span id="l2.106" class="difflineminus">-        else</span>
<a href="#l2.107"></a><span id="l2.107" class="difflineminus">-          messagePaneShouldBeVisible = true;</span>
<a href="#l2.108"></a><span id="l2.108" class="difflineminus">-</span>
<a href="#l2.109"></a><span id="l2.109" class="difflineminus">-        this.openTab(aTab, false,</span>
<a href="#l2.110"></a><span id="l2.110" class="difflineminus">-                     new MessagePaneDisplayWidget(messagePaneShouldBeVisible));</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineminus">-</span>
<a href="#l2.112"></a><span id="l2.112" class="difflineminus">-        let background = (&quot;background&quot; in aArgs) &amp;&amp; aArgs.background;</span>
<a href="#l2.113"></a><span id="l2.113" class="difflineminus">-        let msgHdr = (&quot;msgHdr&quot; in aArgs) &amp;&amp; aArgs.msgHdr;</span>
<a href="#l2.114"></a><span id="l2.114" class="difflineminus">-</span>
<a href="#l2.115"></a><span id="l2.115" class="difflineminus">-        if (!background) {</span>
<a href="#l2.116"></a><span id="l2.116" class="difflineminus">-          aTab.folderDisplay.makeActive();</span>
<a href="#l2.117"></a><span id="l2.117" class="difflineminus">-          // HACK: Since we've switched away from the tab, we need to bring</span>
<a href="#l2.118"></a><span id="l2.118" class="difflineminus">-          // back the real selection before selecting the folder, so do that</span>
<a href="#l2.119"></a><span id="l2.119" class="difflineminus">-          RestoreSelectionWithoutContentLoad(document.getElementById(</span>
<a href="#l2.120"></a><span id="l2.120" class="difflineminus">-                                                 &quot;folderTree&quot;));</span>
<a href="#l2.121"></a><span id="l2.121" class="difflineminus">-</span>
<a href="#l2.122"></a><span id="l2.122" class="difflineminus">-          // Clear selection, because context clicking on a folder and opening in a</span>
<a href="#l2.123"></a><span id="l2.123" class="difflineminus">-          // new tab needs to have selectFolder think the selection has changed.</span>
<a href="#l2.124"></a><span id="l2.124" class="difflineminus">-          gFolderTreeView.selection.clearSelection();</span>
<a href="#l2.125"></a><span id="l2.125" class="difflineminus">-          gFolderTreeView.selection.currentIndex = -1;</span>
<a href="#l2.126"></a><span id="l2.126" class="difflineminus">-</span>
<a href="#l2.127"></a><span id="l2.127" class="difflineminus">-          // This will call aTab.folderDisplay.show(aArgs.folder), which takes</span>
<a href="#l2.128"></a><span id="l2.128" class="difflineminus">-          // care of the tab title and other stuff</span>
<a href="#l2.129"></a><span id="l2.129" class="difflineminus">-          gFolderTreeView.selectFolder(aArgs.folder);</span>
<a href="#l2.130"></a><span id="l2.130" class="difflineminus">-          if (msgHdr)</span>
<a href="#l2.131"></a><span id="l2.131" class="difflineminus">-            aTab.folderDisplay.selectMessage(msgHdr);</span>
<a href="#l2.132"></a><span id="l2.132" class="difflineminus">-        }</span>
<a href="#l2.133"></a><span id="l2.133" class="difflineminus">-        else {</span>
<a href="#l2.134"></a><span id="l2.134" class="difflineminus">-          // Since we can't call gFolderTreeView.selectFolder, we need to make the folder</span>
<a href="#l2.135"></a><span id="l2.135" class="difflineminus">-          // display believe it's showing this folder</span>
<a href="#l2.136"></a><span id="l2.136" class="difflineminus">-          aTab.folderDisplay.show(aArgs.folder);</span>
<a href="#l2.137"></a><span id="l2.137" class="difflineminus">-        }</span>
<a href="#l2.138"></a><span id="l2.138" class="difflineminus">-</span>
<a href="#l2.139"></a><span id="l2.139" class="difflineminus">-        aTab.mode.onTitleChanged.call(this, aTab, aTab.tabNode);</span>
<a href="#l2.140"></a><span id="l2.140" class="difflineminus">-      },</span>
<a href="#l2.141"></a><span id="l2.141" class="difflineminus">-      persistTab: function(aTab) {</span>
<a href="#l2.142"></a><span id="l2.142" class="difflineminus">-        if (!aTab.folderDisplay.displayedFolder)</span>
<a href="#l2.143"></a><span id="l2.143" class="difflineminus">-          return null;</span>
<a href="#l2.144"></a><span id="l2.144" class="difflineminus">-        return {</span>
<a href="#l2.145"></a><span id="l2.145" class="difflineminus">-          folderURI: aTab.folderDisplay.displayedFolder.URI,</span>
<a href="#l2.146"></a><span id="l2.146" class="difflineminus">-          messagePaneVisible: aTab.messageDisplay.visible,</span>
<a href="#l2.147"></a><span id="l2.147" class="difflineminus">-          firstTab: aTab.firstTab,</span>
<a href="#l2.148"></a><span id="l2.148" class="difflineminus">-          searchMode: aTab.searchState['mode']</span>
<a href="#l2.149"></a><span id="l2.149" class="difflineminus">-        };</span>
<a href="#l2.150"></a><span id="l2.150" class="difflineminus">-      },</span>
<a href="#l2.151"></a><span id="l2.151" class="difflineminus">-      restoreTab: function(aTabmail, aPersistedState) {</span>
<a href="#l2.152"></a><span id="l2.152" class="difflineminus">-      try {</span>
<a href="#l2.153"></a><span id="l2.153" class="difflineminus">-        let rdfService = Components.classes['@mozilla.org/rdf/rdf-service;1']</span>
<a href="#l2.154"></a><span id="l2.154" class="difflineminus">-                           .getService(Components.interfaces.nsIRDFService);</span>
<a href="#l2.155"></a><span id="l2.155" class="difflineminus">-        let folder = rdfService.GetResource(aPersistedState.folderURI)</span>
<a href="#l2.156"></a><span id="l2.156" class="difflineminus">-                       .QueryInterface(Components.interfaces.nsIMsgFolder);</span>
<a href="#l2.157"></a><span id="l2.157" class="difflineminus">-        // if the folder no longer exists, we can't restore the tab</span>
<a href="#l2.158"></a><span id="l2.158" class="difflineminus">-        if (folder) {</span>
<a href="#l2.159"></a><span id="l2.159" class="difflineminus">-          // If we are talking about the first tab, it already exists and we</span>
<a href="#l2.160"></a><span id="l2.160" class="difflineminus">-          //  should poke it.  We are assuming it is the currently displayed</span>
<a href="#l2.161"></a><span id="l2.161" class="difflineminus">-          //  tab because we are privvy to the implementation details and know</span>
<a href="#l2.162"></a><span id="l2.162" class="difflineminus">-          //  it to be true.</span>
<a href="#l2.163"></a><span id="l2.163" class="difflineminus">-          if (aPersistedState.firstTab) {</span>
<a href="#l2.164"></a><span id="l2.164" class="difflineminus">-            if (gMessageDisplay.visible != aPersistedState.messagePaneVisible) {</span>
<a href="#l2.165"></a><span id="l2.165" class="difflineminus">-              MsgToggleMessagePane();</span>
<a href="#l2.166"></a><span id="l2.166" class="difflineminus">-              // For reasons that are not immediately obvious, sometimes the</span>
<a href="#l2.167"></a><span id="l2.167" class="difflineminus">-              //  message display is not active at this time.  In that case, we</span>
<a href="#l2.168"></a><span id="l2.168" class="difflineminus">-              //  need to explicitly set the _visible value because otherwise it</span>
<a href="#l2.169"></a><span id="l2.169" class="difflineminus">-              //  misses out on the toggle event.</span>
<a href="#l2.170"></a><span id="l2.170" class="difflineminus">-              if (!gMessageDisplay._active)</span>
<a href="#l2.171"></a><span id="l2.171" class="difflineminus">-                gMessageDisplay._visible = aPersistedState.messagePaneVisible;</span>
<a href="#l2.172"></a><span id="l2.172" class="difflineminus">-            }</span>
<a href="#l2.173"></a><span id="l2.173" class="difflineminus">-            if (&quot;searchMode&quot; in aPersistedState)</span>
<a href="#l2.174"></a><span id="l2.174" class="difflineminus">-              document.getElementById('searchInput').searchMode =</span>
<a href="#l2.175"></a><span id="l2.175" class="difflineminus">-                aPersistedState.searchMode;</span>
<a href="#l2.176"></a><span id="l2.176" class="difflineminus">-            gFolderTreeView.selectFolder(folder);</span>
<a href="#l2.177"></a><span id="l2.177" class="difflineminus">-          }</span>
<a href="#l2.178"></a><span id="l2.178" class="difflineminus">-          else {</span>
<a href="#l2.179"></a><span id="l2.179" class="difflineminus">-            let tabArgs = {</span>
<a href="#l2.180"></a><span id="l2.180" class="difflineminus">-              folder: folder,</span>
<a href="#l2.181"></a><span id="l2.181" class="difflineminus">-              messagePaneVisible: aPersistedState.messagePaneVisible,</span>
<a href="#l2.182"></a><span id="l2.182" class="difflineminus">-              background: true</span>
<a href="#l2.183"></a><span id="l2.183" class="difflineminus">-            };</span>
<a href="#l2.184"></a><span id="l2.184" class="difflineminus">-            if (&quot;searchMode&quot; in aPersistedState)</span>
<a href="#l2.185"></a><span id="l2.185" class="difflineminus">-              tabArgs.searchMode = aPersistedState.searchMode;</span>
<a href="#l2.186"></a><span id="l2.186" class="difflineminus">-            aTabmail.openTab(&quot;folder&quot;, tabArgs);</span>
<a href="#l2.187"></a><span id="l2.187" class="difflineminus">-          }</span>
<a href="#l2.188"></a><span id="l2.188" class="difflineminus">-        }</span>
<a href="#l2.189"></a><span id="l2.189" class="difflineminus">-      } catch (e) {</span>
<a href="#l2.190"></a><span id="l2.190" class="difflineminus">-        logException(e);</span>
<a href="#l2.191"></a><span id="l2.191" class="difflineminus">-      }</span>
<a href="#l2.192"></a><span id="l2.192" class="difflineminus">-      },</span>
<a href="#l2.193"></a><span id="l2.193" class="difflineminus">-      onTitleChanged: function(aTab, aTabNode) {</span>
<a href="#l2.194"></a><span id="l2.194" class="difflineminus">-        if (!aTab.folderDisplay || !aTab.folderDisplay.displayedFolder) {</span>
<a href="#l2.195"></a><span id="l2.195" class="difflineminus">-          // Don't show &quot;undefined&quot; as title when there is no account.</span>
<a href="#l2.196"></a><span id="l2.196" class="difflineminus">-          aTab.title = &quot; &quot;;</span>
<a href="#l2.197"></a><span id="l2.197" class="difflineminus">-          return;</span>
<a href="#l2.198"></a><span id="l2.198" class="difflineminus">-        }</span>
<a href="#l2.199"></a><span id="l2.199" class="difflineminus">-        // The user may have changed folders, triggering our onTitleChanged</span>
<a href="#l2.200"></a><span id="l2.200" class="difflineminus">-        // callback.</span>
<a href="#l2.201"></a><span id="l2.201" class="difflineminus">-        let folder = aTab.folderDisplay.displayedFolder;</span>
<a href="#l2.202"></a><span id="l2.202" class="difflineminus">-        aTab.title = folder.prettyName;</span>
<a href="#l2.203"></a><span id="l2.203" class="difflineminus">-        if (!folder.isServer &amp;&amp; this._getNumberOfRealAccounts() &gt; 1)</span>
<a href="#l2.204"></a><span id="l2.204" class="difflineminus">-          aTab.title += &quot; - &quot; + folder.server.prettyName;</span>
<a href="#l2.205"></a><span id="l2.205" class="difflineminus">-</span>
<a href="#l2.206"></a><span id="l2.206" class="difflineminus">-        // Update the appropriate attributes on the tab</span>
<a href="#l2.207"></a><span id="l2.207" class="difflineminus">-        aTabNode.setAttribute('SpecialFolder',</span>
<a href="#l2.208"></a><span id="l2.208" class="difflineminus">-                              getSpecialFolderString(folder));</span>
<a href="#l2.209"></a><span id="l2.209" class="difflineminus">-        aTabNode.setAttribute('ServerType', folder.server.type);</span>
<a href="#l2.210"></a><span id="l2.210" class="difflineminus">-        aTabNode.setAttribute('IsServer', folder.isServer);</span>
<a href="#l2.211"></a><span id="l2.211" class="difflineminus">-        aTabNode.setAttribute('IsSecure', folder.server.isSecure);</span>
<a href="#l2.212"></a><span id="l2.212" class="difflineminus">-      },</span>
<a href="#l2.213"></a><span id="l2.213" class="difflineminus">-      getBrowser: function(aTab) {</span>
<a href="#l2.214"></a><span id="l2.214" class="difflineminus">-        // If we are currently a thread summary, we want to select the multi</span>
<a href="#l2.215"></a><span id="l2.215" class="difflineminus">-        // message browser rather than the message pane.</span>
<a href="#l2.216"></a><span id="l2.216" class="difflineminus">-        return gMessageDisplay.singleMessageDisplay ?</span>
<a href="#l2.217"></a><span id="l2.217" class="difflineminus">-               document.getElementById(&quot;messagepane&quot;) :</span>
<a href="#l2.218"></a><span id="l2.218" class="difflineminus">-               document.getElementById(&quot;multimessage&quot;);</span>
<a href="#l2.219"></a><span id="l2.219" class="difflineminus">-      }</span>
<a href="#l2.220"></a><span id="l2.220" class="difflineminus">-    },</span>
<a href="#l2.221"></a><span id="l2.221" class="difflineminus">-    /**</span>
<a href="#l2.222"></a><span id="l2.222" class="difflineminus">-     * The message view displays a single message.  In this view, the folder</span>
<a href="#l2.223"></a><span id="l2.223" class="difflineminus">-     *  pane and thread pane are forced hidden and only the message pane is</span>
<a href="#l2.224"></a><span id="l2.224" class="difflineminus">-     *  displayed.</span>
<a href="#l2.225"></a><span id="l2.225" class="difflineminus">-     */</span>
<a href="#l2.226"></a><span id="l2.226" class="difflineminus">-    message: {</span>
<a href="#l2.227"></a><span id="l2.227" class="difflineminus">-      type: &quot;message&quot;,</span>
<a href="#l2.228"></a><span id="l2.228" class="difflineminus">-      /// The set of panes that are legal to be displayed in this mode</span>
<a href="#l2.229"></a><span id="l2.229" class="difflineminus">-      legalPanes: {</span>
<a href="#l2.230"></a><span id="l2.230" class="difflineminus">-        folder: false,</span>
<a href="#l2.231"></a><span id="l2.231" class="difflineminus">-        thread: false,</span>
<a href="#l2.232"></a><span id="l2.232" class="difflineminus">-        message: true</span>
<a href="#l2.233"></a><span id="l2.233" class="difflineminus">-      },</span>
<a href="#l2.234"></a><span id="l2.234" class="difflineminus">-      openTab: function(aTab, aArgs) {</span>
<a href="#l2.235"></a><span id="l2.235" class="difflineminus">-        this.openTab(aTab, false, new MessageTabDisplayWidget());</span>
<a href="#l2.236"></a><span id="l2.236" class="difflineminus">-</span>
<a href="#l2.237"></a><span id="l2.237" class="difflineminus">-        let viewWrapperToClone = (&quot;viewWrapperToClone&quot; in aArgs) &amp;&amp;</span>
<a href="#l2.238"></a><span id="l2.238" class="difflineminus">-                                 aArgs.viewWrapperToClone;</span>
<a href="#l2.239"></a><span id="l2.239" class="difflineminus">-        let background = (&quot;background&quot; in aArgs) &amp;&amp; aArgs.background;</span>
<a href="#l2.240"></a><span id="l2.240" class="difflineminus">-</span>
<a href="#l2.241"></a><span id="l2.241" class="difflineminus">-        if (viewWrapperToClone)</span>
<a href="#l2.242"></a><span id="l2.242" class="difflineminus">-          aTab.folderDisplay.cloneView(viewWrapperToClone);</span>
<a href="#l2.243"></a><span id="l2.243" class="difflineminus">-        else</span>
<a href="#l2.244"></a><span id="l2.244" class="difflineminus">-          aTab.folderDisplay.show(aArgs.msgHdr.folder);</span>
<a href="#l2.245"></a><span id="l2.245" class="difflineminus">-</span>
<a href="#l2.246"></a><span id="l2.246" class="difflineminus">-        // folderDisplay.show is going to try to set the title itself, but we</span>
<a href="#l2.247"></a><span id="l2.247" class="difflineminus">-        // wouldn't have selected a message at that point, so set the title</span>
<a href="#l2.248"></a><span id="l2.248" class="difflineminus">-        // here</span>
<a href="#l2.249"></a><span id="l2.249" class="difflineminus">-        aTab.mode.onTitleChanged.call(this, aTab, null, aArgs.msgHdr);</span>
<a href="#l2.250"></a><span id="l2.250" class="difflineminus">-</span>
<a href="#l2.251"></a><span id="l2.251" class="difflineminus">-        aTab.folderDisplay.selectMessage(aArgs.msgHdr);</span>
<a href="#l2.252"></a><span id="l2.252" class="difflineminus">-</span>
<a href="#l2.253"></a><span id="l2.253" class="difflineminus">-        // Once we're brought into the foreground, the message pane should</span>
<a href="#l2.254"></a><span id="l2.254" class="difflineminus">-        // get focus</span>
<a href="#l2.255"></a><span id="l2.255" class="difflineminus">-        aTab._focusedWindow = GetMessagePaneFrame();</span>
<a href="#l2.256"></a><span id="l2.256" class="difflineminus">-        aTab._focusedElement = null;</span>
<a href="#l2.257"></a><span id="l2.257" class="difflineminus">-</span>
<a href="#l2.258"></a><span id="l2.258" class="difflineminus">-        // we only want to make it active after setting up the view and the message</span>
<a href="#l2.259"></a><span id="l2.259" class="difflineminus">-        //  to avoid generating bogus summarization events.</span>
<a href="#l2.260"></a><span id="l2.260" class="difflineminus">-        if (!background) {</span>
<a href="#l2.261"></a><span id="l2.261" class="difflineminus">-          aTab.folderDisplay.makeActive();</span>
<a href="#l2.262"></a><span id="l2.262" class="difflineminus">-          this.restoreFocus(aTab);</span>
<a href="#l2.263"></a><span id="l2.263" class="difflineminus">-        }</span>
<a href="#l2.264"></a><span id="l2.264" class="difflineminus">-        else {</span>
<a href="#l2.265"></a><span id="l2.265" class="difflineminus">-          // We don't want to null out the real tree box view, as that</span>
<a href="#l2.266"></a><span id="l2.266" class="difflineminus">-          // corresponds to the _current_ tab, not the new one</span>
<a href="#l2.267"></a><span id="l2.267" class="difflineminus">-          aTab.folderDisplay.hookUpFakeTreeBox(false);</span>
<a href="#l2.268"></a><span id="l2.268" class="difflineminus">-        }</span>
<a href="#l2.269"></a><span id="l2.269" class="difflineminus">-      },</span>
<a href="#l2.270"></a><span id="l2.270" class="difflineminus">-      persistTab: function(aTab) {</span>
<a href="#l2.271"></a><span id="l2.271" class="difflineminus">-        let msgHdr = aTab.folderDisplay.selectedMessage;</span>
<a href="#l2.272"></a><span id="l2.272" class="difflineminus">-        return {</span>
<a href="#l2.273"></a><span id="l2.273" class="difflineminus">-          messageURI: msgHdr.folder.getUriForMsg(msgHdr)</span>
<a href="#l2.274"></a><span id="l2.274" class="difflineminus">-        };</span>
<a href="#l2.275"></a><span id="l2.275" class="difflineminus">-      },</span>
<a href="#l2.276"></a><span id="l2.276" class="difflineminus">-      restoreTab: function(aTabmail, aPersistedState) {</span>
<a href="#l2.277"></a><span id="l2.277" class="difflineminus">-        let msgHdr = messenger.msgHdrFromURI(aPersistedState.messageURI);</span>
<a href="#l2.278"></a><span id="l2.278" class="difflineminus">-        // if the message no longer exists, we can't restore the tab</span>
<a href="#l2.279"></a><span id="l2.279" class="difflineminus">-        if (msgHdr)</span>
<a href="#l2.280"></a><span id="l2.280" class="difflineminus">-          aTabmail.openTab(&quot;message&quot;, {msgHdr: msgHdr, background: true});</span>
<a href="#l2.281"></a><span id="l2.281" class="difflineminus">-      },</span>
<a href="#l2.282"></a><span id="l2.282" class="difflineminus">-      onTitleChanged: function(aTab, aTabNode, aMsgHdr) {</span>
<a href="#l2.283"></a><span id="l2.283" class="difflineminus">-        // Try and figure out the selected message if one was not provided.</span>
<a href="#l2.284"></a><span id="l2.284" class="difflineminus">-        // It is possible that the folder has yet to load, so it may still be</span>
<a href="#l2.285"></a><span id="l2.285" class="difflineminus">-        //  null.</span>
<a href="#l2.286"></a><span id="l2.286" class="difflineminus">-        if (aMsgHdr == null)</span>
<a href="#l2.287"></a><span id="l2.287" class="difflineminus">-          aMsgHdr = aTab.folderDisplay.selectedMessage;</span>
<a href="#l2.288"></a><span id="l2.288" class="difflineminus">-        aTab.title = &quot;&quot;;</span>
<a href="#l2.289"></a><span id="l2.289" class="difflineminus">-        if (aMsgHdr == null)</span>
<a href="#l2.290"></a><span id="l2.290" class="difflineminus">-          return;</span>
<a href="#l2.291"></a><span id="l2.291" class="difflineminus">-        if (aMsgHdr.flags &amp; Components.interfaces.nsMsgMessageFlags.HasRe)</span>
<a href="#l2.292"></a><span id="l2.292" class="difflineminus">-          aTab.title = &quot;Re: &quot;;</span>
<a href="#l2.293"></a><span id="l2.293" class="difflineminus">-        if (aMsgHdr.mime2DecodedSubject)</span>
<a href="#l2.294"></a><span id="l2.294" class="difflineminus">-          aTab.title += aMsgHdr.mime2DecodedSubject;</span>
<a href="#l2.295"></a><span id="l2.295" class="difflineminus">-</span>
<a href="#l2.296"></a><span id="l2.296" class="difflineminus">-        aTab.title += &quot; - &quot; + aMsgHdr.folder.prettyName;</span>
<a href="#l2.297"></a><span id="l2.297" class="difflineminus">-        if (this._getNumberOfRealAccounts() &gt; 1)</span>
<a href="#l2.298"></a><span id="l2.298" class="difflineminus">-          aTab.title += &quot; - &quot; + aMsgHdr.folder.server.prettyName;</span>
<a href="#l2.299"></a><span id="l2.299" class="difflineminus">-      },</span>
<a href="#l2.300"></a><span id="l2.300" class="difflineminus">-      getBrowser: function(aTab) {</span>
<a href="#l2.301"></a><span id="l2.301" class="difflineminus">-        // Message tabs always use the messagepane browser.</span>
<a href="#l2.302"></a><span id="l2.302" class="difflineminus">-        return document.getElementById(&quot;messagepane&quot;);</span>
<a href="#l2.303"></a><span id="l2.303" class="difflineminus">-      }</span>
<a href="#l2.304"></a><span id="l2.304" class="difflineminus">-    },</span>
<a href="#l2.305"></a><span id="l2.305" class="difflineminus">-    /**</span>
<a href="#l2.306"></a><span id="l2.306" class="difflineminus">-     * The glodaList view displays a gloda-backed nsMsgDBView with only the</span>
<a href="#l2.307"></a><span id="l2.307" class="difflineminus">-     *  thread pane and (potentially) the message pane displayed; the folder</span>
<a href="#l2.308"></a><span id="l2.308" class="difflineminus">-     *  pane is forced hidden.</span>
<a href="#l2.309"></a><span id="l2.309" class="difflineminus">-     */</span>
<a href="#l2.310"></a><span id="l2.310" class="difflineminus">-    glodaList: {</span>
<a href="#l2.311"></a><span id="l2.311" class="difflineminus">-      type: &quot;glodaSearch&quot;,</span>
<a href="#l2.312"></a><span id="l2.312" class="difflineminus">-      /// The set of panes that are legal to be displayed in this mode</span>
<a href="#l2.313"></a><span id="l2.313" class="difflineminus">-      legalPanes: {</span>
<a href="#l2.314"></a><span id="l2.314" class="difflineminus">-        folder: false,</span>
<a href="#l2.315"></a><span id="l2.315" class="difflineminus">-        thread: true,</span>
<a href="#l2.316"></a><span id="l2.316" class="difflineminus">-        message: true,</span>
<a href="#l2.317"></a><span id="l2.317" class="difflineminus">-      },</span>
<a href="#l2.318"></a><span id="l2.318" class="difflineminus">-      /**</span>
<a href="#l2.319"></a><span id="l2.319" class="difflineminus">-       * The default set of columns to show.  This really should just be for</span>
<a href="#l2.320"></a><span id="l2.320" class="difflineminus">-       *  boot-strapping and should be persisted after that...</span>
<a href="#l2.321"></a><span id="l2.321" class="difflineminus">-       */</span>
<a href="#l2.322"></a><span id="l2.322" class="difflineminus">-      desiredColumnStates: {</span>
<a href="#l2.323"></a><span id="l2.323" class="difflineminus">-        threadCol: {</span>
<a href="#l2.324"></a><span id="l2.324" class="difflineminus">-          visible: true,</span>
<a href="#l2.325"></a><span id="l2.325" class="difflineminus">-        },</span>
<a href="#l2.326"></a><span id="l2.326" class="difflineminus">-        flaggedCol: {</span>
<a href="#l2.327"></a><span id="l2.327" class="difflineminus">-          visible: true,</span>
<a href="#l2.328"></a><span id="l2.328" class="difflineminus">-        },</span>
<a href="#l2.329"></a><span id="l2.329" class="difflineminus">-        subjectCol: {</span>
<a href="#l2.330"></a><span id="l2.330" class="difflineminus">-          visible: true,</span>
<a href="#l2.331"></a><span id="l2.331" class="difflineminus">-        },</span>
<a href="#l2.332"></a><span id="l2.332" class="difflineminus">-        senderCol: {</span>
<a href="#l2.333"></a><span id="l2.333" class="difflineminus">-          visible: true,</span>
<a href="#l2.334"></a><span id="l2.334" class="difflineminus">-        },</span>
<a href="#l2.335"></a><span id="l2.335" class="difflineminus">-        dateCol: {</span>
<a href="#l2.336"></a><span id="l2.336" class="difflineminus">-          visible: true,</span>
<a href="#l2.337"></a><span id="l2.337" class="difflineminus">-        },</span>
<a href="#l2.338"></a><span id="l2.338" class="difflineminus">-      },</span>
<a href="#l2.339"></a><span id="l2.339" class="difflineminus">-      /**</span>
<a href="#l2.340"></a><span id="l2.340" class="difflineminus">-       * Open a new folder-display-style tab showing the contents of a gloda</span>
<a href="#l2.341"></a><span id="l2.341" class="difflineminus">-       *  query/collection.  You must pass one of 'query'/'collection'/</span>
<a href="#l2.342"></a><span id="l2.342" class="difflineminus">-       *  'conversation'</span>
<a href="#l2.343"></a><span id="l2.343" class="difflineminus">-       *</span>
<a href="#l2.344"></a><span id="l2.344" class="difflineminus">-       * @param {GlodaQuery} [aArgs.query] An un-triggered gloda query to use.</span>
<a href="#l2.345"></a><span id="l2.345" class="difflineminus">-       *     Alternatively, if you already have a collection, you can pass that</span>
<a href="#l2.346"></a><span id="l2.346" class="difflineminus">-       *     instead as 'collection'.</span>
<a href="#l2.347"></a><span id="l2.347" class="difflineminus">-       * @param {GlodaCollection} [aArgs.collection] A gloda collection to</span>
<a href="#l2.348"></a><span id="l2.348" class="difflineminus">-       *     display.</span>
<a href="#l2.349"></a><span id="l2.349" class="difflineminus">-       * @param {GlodaConversation} [aArgs.conversation] A conversation whose</span>
<a href="#l2.350"></a><span id="l2.350" class="difflineminus">-       *     messages you want to display.</span>
<a href="#l2.351"></a><span id="l2.351" class="difflineminus">-       * @param {GlodaMessage} [aArgs.message] The message to select in the</span>
<a href="#l2.352"></a><span id="l2.352" class="difflineminus">-       *     conversation, if provided.</span>
<a href="#l2.353"></a><span id="l2.353" class="difflineminus">-       * @param aArgs.title The title to give to the tab.  If this is not user</span>
<a href="#l2.354"></a><span id="l2.354" class="difflineminus">-       *     content (a search string, a message subject, etc.), make sure you</span>
<a href="#l2.355"></a><span id="l2.355" class="difflineminus">-       *     are using a localized string.</span>
<a href="#l2.356"></a><span id="l2.356" class="difflineminus">-       *</span>
<a href="#l2.357"></a><span id="l2.357" class="difflineminus">-       * XXX This needs to handle opening in the background</span>
<a href="#l2.358"></a><span id="l2.358" class="difflineminus">-       */</span>
<a href="#l2.359"></a><span id="l2.359" class="difflineminus">-      openTab: function(aTab, aArgs) {</span>
<a href="#l2.360"></a><span id="l2.360" class="difflineminus">-        aTab.glodaSynView = new GlodaSyntheticView(aArgs);</span>
<a href="#l2.361"></a><span id="l2.361" class="difflineminus">-        aTab.title = aArgs.title;</span>
<a href="#l2.362"></a><span id="l2.362" class="difflineminus">-</span>
<a href="#l2.363"></a><span id="l2.363" class="difflineminus">-        this.openTab(aTab, false, new MessagePaneDisplayWidget());</span>
<a href="#l2.364"></a><span id="l2.364" class="difflineminus">-        aTab.folderDisplay.show(aTab.glodaSynView);</span>
<a href="#l2.365"></a><span id="l2.365" class="difflineminus">-        // XXX persist column states in preferences or session store or other</span>
<a href="#l2.366"></a><span id="l2.366" class="difflineminus">-        aTab.folderDisplay.setColumnStates(aTab.mode.desiredColumnStates);</span>
<a href="#l2.367"></a><span id="l2.367" class="difflineminus">-        aTab.folderDisplay.view.showThreaded = true;</span>
<a href="#l2.368"></a><span id="l2.368" class="difflineminus">-</span>
<a href="#l2.369"></a><span id="l2.369" class="difflineminus">-        let background = (&quot;background&quot; in aArgs) &amp;&amp; aArgs.background;</span>
<a href="#l2.370"></a><span id="l2.370" class="difflineminus">-        if (!background)</span>
<a href="#l2.371"></a><span id="l2.371" class="difflineminus">-          aTab.folderDisplay.makeActive();</span>
<a href="#l2.372"></a><span id="l2.372" class="difflineminus">-        if (&quot;message&quot; in aArgs) {</span>
<a href="#l2.373"></a><span id="l2.373" class="difflineminus">-          let hdr = aArgs.message.folderMessage;</span>
<a href="#l2.374"></a><span id="l2.374" class="difflineminus">-          if (hdr)</span>
<a href="#l2.375"></a><span id="l2.375" class="difflineminus">-            aTab.folderDisplay.selectMessage(hdr);</span>
<a href="#l2.376"></a><span id="l2.376" class="difflineminus">-        }</span>
<a href="#l2.377"></a><span id="l2.377" class="difflineminus">-      },</span>
<a href="#l2.378"></a><span id="l2.378" class="difflineminus">-      getBrowser: function(aTab) {</span>
<a href="#l2.379"></a><span id="l2.379" class="difflineminus">-        // If we are currently a thread summary, we want to select the multi</span>
<a href="#l2.380"></a><span id="l2.380" class="difflineminus">-        // message browser rather than the message pane.</span>
<a href="#l2.381"></a><span id="l2.381" class="difflineminus">-        return gMessageDisplay.singleMessageDisplay ?</span>
<a href="#l2.382"></a><span id="l2.382" class="difflineminus">-               document.getElementById(&quot;messagepane&quot;) :</span>
<a href="#l2.383"></a><span id="l2.383" class="difflineminus">-               document.getElementById(&quot;multimessage&quot;);</span>
<a href="#l2.384"></a><span id="l2.384" class="difflineminus">-      }</span>
<a href="#l2.385"></a><span id="l2.385" class="difflineminus">-    },</span>
<a href="#l2.386"></a><span id="l2.386" class="difflineminus">-  },</span>
<a href="#l2.387"></a><span id="l2.387" class="difflineminus">-</span>
<a href="#l2.388"></a><span id="l2.388" class="difflineminus">-  _getNumberOfRealAccounts : function() {</span>
<a href="#l2.389"></a><span id="l2.389" class="difflineminus">-    let mgr = Components.classes[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l2.390"></a><span id="l2.390" class="difflineminus">-                        .getService(Components.interfaces.nsIMsgAccountManager);</span>
<a href="#l2.391"></a><span id="l2.391" class="difflineminus">-    let accountCount = mgr.accounts.Count();</span>
<a href="#l2.392"></a><span id="l2.392" class="difflineminus">-    // If we have an account, we also always have a &quot;Local Folders&quot; account.</span>
<a href="#l2.393"></a><span id="l2.393" class="difflineminus">-    return accountCount &gt; 0 ? (accountCount - 1) : 0;</span>
<a href="#l2.394"></a><span id="l2.394" class="difflineminus">-  },</span>
<a href="#l2.395"></a><span id="l2.395" class="difflineminus">-</span>
<a href="#l2.396"></a><span id="l2.396" class="difflineminus">-  /**</span>
<a href="#l2.397"></a><span id="l2.397" class="difflineminus">-   * Common tab opening code shared by the various tab modes.</span>
<a href="#l2.398"></a><span id="l2.398" class="difflineminus">-   */</span>
<a href="#l2.399"></a><span id="l2.399" class="difflineminus">-  openTab: function(aTab, aIsFirstTab, aMessageDisplay) {</span>
<a href="#l2.400"></a><span id="l2.400" class="difflineminus">-    // Set the messagepane as the primary browser for content.</span>
<a href="#l2.401"></a><span id="l2.401" class="difflineminus">-    document.getElementById(&quot;messagepane&quot;).setAttribute(&quot;type&quot;,</span>
<a href="#l2.402"></a><span id="l2.402" class="difflineminus">-                                                        &quot;content-primary&quot;);</span>
<a href="#l2.403"></a><span id="l2.403" class="difflineminus">-</span>
<a href="#l2.404"></a><span id="l2.404" class="difflineminus">-    aTab.messageDisplay = aMessageDisplay;</span>
<a href="#l2.405"></a><span id="l2.405" class="difflineminus">-    aTab.folderDisplay = new FolderDisplayWidget(aTab, aTab.messageDisplay);</span>
<a href="#l2.406"></a><span id="l2.406" class="difflineminus">-    aTab.folderDisplay.msgWindow = msgWindow;</span>
<a href="#l2.407"></a><span id="l2.407" class="difflineminus">-    aTab.folderDisplay.tree = document.getElementById(&quot;threadTree&quot;);</span>
<a href="#l2.408"></a><span id="l2.408" class="difflineminus">-    aTab.folderDisplay.treeBox = aTab.folderDisplay.tree.boxObject.QueryInterface(</span>
<a href="#l2.409"></a><span id="l2.409" class="difflineminus">-                                   Components.interfaces.nsITreeBoxObject);</span>
<a href="#l2.410"></a><span id="l2.410" class="difflineminus">-</span>
<a href="#l2.411"></a><span id="l2.411" class="difflineminus">-    if (aIsFirstTab) {</span>
<a href="#l2.412"></a><span id="l2.412" class="difflineminus">-      aTab.folderDisplay.messenger = messenger;</span>
<a href="#l2.413"></a><span id="l2.413" class="difflineminus">-    }</span>
<a href="#l2.414"></a><span id="l2.414" class="difflineminus">-    else {</span>
<a href="#l2.415"></a><span id="l2.415" class="difflineminus">-      // Each tab gets its own messenger instance; this provides each tab with</span>
<a href="#l2.416"></a><span id="l2.416" class="difflineminus">-      // its own undo/redo stack and back/forward navigation history.</span>
<a href="#l2.417"></a><span id="l2.417" class="difflineminus">-      // If this is a foreground tab, folderDisplay.makeActive() is going to</span>
<a href="#l2.418"></a><span id="l2.418" class="difflineminus">-      // set it as the global messenger, so there's no need to do it here</span>
<a href="#l2.419"></a><span id="l2.419" class="difflineminus">-      let tabMessenger = Components.classes[&quot;@mozilla.org/messenger;1&quot;]</span>
<a href="#l2.420"></a><span id="l2.420" class="difflineminus">-                                   .createInstance(Components.interfaces.nsIMessenger);</span>
<a href="#l2.421"></a><span id="l2.421" class="difflineminus">-      tabMessenger.setWindow(window, msgWindow);</span>
<a href="#l2.422"></a><span id="l2.422" class="difflineminus">-      aTab.folderDisplay.messenger = tabMessenger;</span>
<a href="#l2.423"></a><span id="l2.423" class="difflineminus">-    }</span>
<a href="#l2.424"></a><span id="l2.424" class="difflineminus">-  },</span>
<a href="#l2.425"></a><span id="l2.425" class="difflineminus">-</span>
<a href="#l2.426"></a><span id="l2.426" class="difflineminus">-  closeTab: function(aTab) {</span>
<a href="#l2.427"></a><span id="l2.427" class="difflineminus">-    aTab.folderDisplay.close();</span>
<a href="#l2.428"></a><span id="l2.428" class="difflineminus">-  },</span>
<a href="#l2.429"></a><span id="l2.429" class="difflineminus">-</span>
<a href="#l2.430"></a><span id="l2.430" class="difflineminus">-  /**</span>
<a href="#l2.431"></a><span id="l2.431" class="difflineminus">-   * Save off the tab's currently focused element or window.</span>
<a href="#l2.432"></a><span id="l2.432" class="difflineminus">-   * - If the message pane or summary is currently focused, we'll save this as</span>
<a href="#l2.433"></a><span id="l2.433" class="difflineminus">-   *   our focused window. We won't try to save the focused element, as they'll</span>
<a href="#l2.434"></a><span id="l2.434" class="difflineminus">-   *   be rebuilt every time we switch panes and it'll be too hard for us to do</span>
<a href="#l2.435"></a><span id="l2.435" class="difflineminus">-   *   that.</span>
<a href="#l2.436"></a><span id="l2.436" class="difflineminus">-   * - If the thread tree or folder tree is focused, save that as the focused</span>
<a href="#l2.437"></a><span id="l2.437" class="difflineminus">-   *   element and the toplevel window as the focused window.</span>
<a href="#l2.438"></a><span id="l2.438" class="difflineminus">-   */</span>
<a href="#l2.439"></a><span id="l2.439" class="difflineminus">-  saveFocus: function mailTabType_saveFocus(aTab) {</span>
<a href="#l2.440"></a><span id="l2.440" class="difflineminus">-    let focusedWindow = document.commandDispatcher.focusedWindow.top;</span>
<a href="#l2.441"></a><span id="l2.441" class="difflineminus">-    if (focusedWindow == document.getElementById(&quot;messagepane&quot;).contentWindow ||</span>
<a href="#l2.442"></a><span id="l2.442" class="difflineminus">-        focusedWindow == document.getElementById(&quot;multimessage&quot;).contentWindow) {</span>
<a href="#l2.443"></a><span id="l2.443" class="difflineminus">-      aTab._focusedWindow = focusedWindow;</span>
<a href="#l2.444"></a><span id="l2.444" class="difflineminus">-      aTab._focusedElement = null;</span>
<a href="#l2.445"></a><span id="l2.445" class="difflineminus">-    }</span>
<a href="#l2.446"></a><span id="l2.446" class="difflineminus">-    else {</span>
<a href="#l2.447"></a><span id="l2.447" class="difflineminus">-      aTab._focusedWindow = window;</span>
<a href="#l2.448"></a><span id="l2.448" class="difflineminus">-</span>
<a href="#l2.449"></a><span id="l2.449" class="difflineminus">-      // Look for children as well. This logic is copied from the mail 3pane</span>
<a href="#l2.450"></a><span id="l2.450" class="difflineminus">-      // version of WhichPaneHasFocus().</span>
<a href="#l2.451"></a><span id="l2.451" class="difflineminus">-      let focusedElement = document.commandDispatcher.focusedElement;</span>
<a href="#l2.452"></a><span id="l2.452" class="difflineminus">-      let threadTree = document.getElementById(&quot;threadTree&quot;);</span>
<a href="#l2.453"></a><span id="l2.453" class="difflineminus">-      let folderTree = document.getElementById(&quot;folderTree&quot;);</span>
<a href="#l2.454"></a><span id="l2.454" class="difflineminus">-      while (focusedElement &amp;&amp; focusedElement != threadTree &amp;&amp;</span>
<a href="#l2.455"></a><span id="l2.455" class="difflineminus">-             focusedElement != folderTree)</span>
<a href="#l2.456"></a><span id="l2.456" class="difflineminus">-        focusedElement = focusedElement.parentNode;</span>
<a href="#l2.457"></a><span id="l2.457" class="difflineminus">-</span>
<a href="#l2.458"></a><span id="l2.458" class="difflineminus">-      // If we still have focusedElement at this point, it's either the thread</span>
<a href="#l2.459"></a><span id="l2.459" class="difflineminus">-      // tree or the folder tree, so we want to persist it.</span>
<a href="#l2.460"></a><span id="l2.460" class="difflineminus">-      aTab._focusedElement = focusedElement;</span>
<a href="#l2.461"></a><span id="l2.461" class="difflineminus">-    }</span>
<a href="#l2.462"></a><span id="l2.462" class="difflineminus">-  },</span>
<a href="#l2.463"></a><span id="l2.463" class="difflineminus">-</span>
<a href="#l2.464"></a><span id="l2.464" class="difflineminus">-  /**</span>
<a href="#l2.465"></a><span id="l2.465" class="difflineminus">-   * Restore the tab's focused element or window.</span>
<a href="#l2.466"></a><span id="l2.466" class="difflineminus">-   */</span>
<a href="#l2.467"></a><span id="l2.467" class="difflineminus">-  restoreFocus: function mailTabType_restoreFocus(aTab) {</span>
<a href="#l2.468"></a><span id="l2.468" class="difflineminus">-    // There seem to be issues with opening multiple messages at once, so allow</span>
<a href="#l2.469"></a><span id="l2.469" class="difflineminus">-    // things to stabilize a bit before proceeding</span>
<a href="#l2.470"></a><span id="l2.470" class="difflineminus">-    let reallyRestoreFocus = function mailTabType_reallyRestoreFocus(aTab) {</span>
<a href="#l2.471"></a><span id="l2.471" class="difflineminus">-      if (&quot;_focusedWindow&quot; in aTab &amp;&amp; aTab._focusedWindow) {</span>
<a href="#l2.472"></a><span id="l2.472" class="difflineminus">-        let windowWatcher = Components.classes[&quot;@mozilla.org/embedcomp/window-watcher;1&quot;]</span>
<a href="#l2.473"></a><span id="l2.473" class="difflineminus">-                              .getService(Components.interfaces.nsIWindowWatcher);</span>
<a href="#l2.474"></a><span id="l2.474" class="difflineminus">-        if (windowWatcher.activeWindow == window)</span>
<a href="#l2.475"></a><span id="l2.475" class="difflineminus">-          aTab._focusedWindow.focus();</span>
<a href="#l2.476"></a><span id="l2.476" class="difflineminus">-        else</span>
<a href="#l2.477"></a><span id="l2.477" class="difflineminus">-          // We can't focus() the window if it's in the background relative to</span>
<a href="#l2.478"></a><span id="l2.478" class="difflineminus">-          // other windows within this process, or it'll steal focus. Set the</span>
<a href="#l2.479"></a><span id="l2.479" class="difflineminus">-          // focused window instead, so that when this window receives focus</span>
<a href="#l2.480"></a><span id="l2.480" class="difflineminus">-          // again, we'll focus the right thing.</span>
<a href="#l2.481"></a><span id="l2.481" class="difflineminus">-          // XXX This should only be needed for 1.9.1</span>
<a href="#l2.482"></a><span id="l2.482" class="difflineminus">-          document.commandDispatcher.focusedWindow = aTab._focusedWindow;</span>
<a href="#l2.483"></a><span id="l2.483" class="difflineminus">-      }</span>
<a href="#l2.484"></a><span id="l2.484" class="difflineminus">-      if (&quot;_focusedElement&quot; in aTab &amp;&amp; aTab._focusedElement)</span>
<a href="#l2.485"></a><span id="l2.485" class="difflineminus">-        aTab._focusedElement.focus();</span>
<a href="#l2.486"></a><span id="l2.486" class="difflineminus">-      aTab._focusedWindow = aTab._focusedElement = null;</span>
<a href="#l2.487"></a><span id="l2.487" class="difflineminus">-    };</span>
<a href="#l2.488"></a><span id="l2.488" class="difflineminus">-</span>
<a href="#l2.489"></a><span id="l2.489" class="difflineminus">-    let self = this;</span>
<a href="#l2.490"></a><span id="l2.490" class="difflineminus">-    window.setTimeout(reallyRestoreFocus, 0, aTab);</span>
<a href="#l2.491"></a><span id="l2.491" class="difflineminus">-  },</span>
<a href="#l2.492"></a><span id="l2.492" class="difflineminus">-</span>
<a href="#l2.493"></a><span id="l2.493" class="difflineminus">-  saveTabState: function(aTab) {</span>
<a href="#l2.494"></a><span id="l2.494" class="difflineminus">-    // Now let other tabs have a primary browser if they want.</span>
<a href="#l2.495"></a><span id="l2.495" class="difflineminus">-    document.getElementById(&quot;messagepane&quot;).setAttribute(&quot;type&quot;,</span>
<a href="#l2.496"></a><span id="l2.496" class="difflineminus">-                                                        &quot;content-targetable&quot;);</span>
<a href="#l2.497"></a><span id="l2.497" class="difflineminus">-</span>
<a href="#l2.498"></a><span id="l2.498" class="difflineminus">-    this.saveFocus(aTab);</span>
<a href="#l2.499"></a><span id="l2.499" class="difflineminus">-    aTab.folderDisplay.makeInactive();</span>
<a href="#l2.500"></a><span id="l2.500" class="difflineminus">-  },</span>
<a href="#l2.501"></a><span id="l2.501" class="difflineminus">-</span>
<a href="#l2.502"></a><span id="l2.502" class="difflineminus">-  /**</span>
<a href="#l2.503"></a><span id="l2.503" class="difflineminus">-   * Some panes simply are illegal in certain views, and some panes are legal</span>
<a href="#l2.504"></a><span id="l2.504" class="difflineminus">-   *  but the user may have collapsed/hidden them.  If that was not enough, we</span>
<a href="#l2.505"></a><span id="l2.505" class="difflineminus">-   *  have three different layouts that are possible, each of which requires a</span>
<a href="#l2.506"></a><span id="l2.506" class="difflineminus">-   *  slightly different DOM configuration, and accordingly for us to poke at</span>
<a href="#l2.507"></a><span id="l2.507" class="difflineminus">-   *  different DOM nodes.  Things are made somewhat simpler by our decision</span>
<a href="#l2.508"></a><span id="l2.508" class="difflineminus">-   *  that all tabs share the same layout.</span>
<a href="#l2.509"></a><span id="l2.509" class="difflineminus">-   * This method takes the legal states and current display states and attempts</span>
<a href="#l2.510"></a><span id="l2.510" class="difflineminus">-   *  to apply the appropriate logic to make it all work out.  This method is</span>
<a href="#l2.511"></a><span id="l2.511" class="difflineminus">-   *  not in charge of figuring out or preserving display states.</span>
<a href="#l2.512"></a><span id="l2.512" class="difflineminus">-   *</span>
<a href="#l2.513"></a><span id="l2.513" class="difflineminus">-   * A brief primer on splitters and friends:</span>
<a href="#l2.514"></a><span id="l2.514" class="difflineminus">-   * - A collapsed splitter is not visible (and otherwise it is visible).</span>
<a href="#l2.515"></a><span id="l2.515" class="difflineminus">-   * - A collapsed node is not visible (and otherwise it is visible).</span>
<a href="#l2.516"></a><span id="l2.516" class="difflineminus">-   * - A splitter whose &quot;state&quot; is &quot;collapsed&quot; collapses the widget implied by</span>
<a href="#l2.517"></a><span id="l2.517" class="difflineminus">-   *    the value of the &quot;collapse&quot; attribute.  The splitter itself will be</span>
<a href="#l2.518"></a><span id="l2.518" class="difflineminus">-   *    visible unless &quot;collapsed&quot;.</span>
<a href="#l2.519"></a><span id="l2.519" class="difflineminus">-   *</span>
<a href="#l2.520"></a><span id="l2.520" class="difflineminus">-   * @param aLegalStates A dictionary where each key and value indicates whether</span>
<a href="#l2.521"></a><span id="l2.521" class="difflineminus">-   *     the pane in question (key) is legal to be displayed in this mode.  If</span>
<a href="#l2.522"></a><span id="l2.522" class="difflineminus">-   *     the value is true, then the pane is legal.  Omitted pane keys imply</span>
<a href="#l2.523"></a><span id="l2.523" class="difflineminus">-   *     that the pane is illegal.  Keys are:</span>
<a href="#l2.524"></a><span id="l2.524" class="difflineminus">-   *     - folder: The folder (tree) pane.</span>
<a href="#l2.525"></a><span id="l2.525" class="difflineminus">-   *     - thread: The thread pane.</span>
<a href="#l2.526"></a><span id="l2.526" class="difflineminus">-   *     - accountCentral: While it's in a deck with the thread pane, this</span>
<a href="#l2.527"></a><span id="l2.527" class="difflineminus">-   *        is distinct from the thread pane because some other things depend</span>
<a href="#l2.528"></a><span id="l2.528" class="difflineminus">-   *        on whether it's actually the thread pane we are showing.</span>
<a href="#l2.529"></a><span id="l2.529" class="difflineminus">-   *     - message: The message pane.  Required/assumed to be true for now.</span>
<a href="#l2.530"></a><span id="l2.530" class="difflineminus">-   * @param aVisibleStates A dictionary where each value indicates whether the</span>
<a href="#l2.531"></a><span id="l2.531" class="difflineminus">-   *     pane should be 'visible' (not collapsed).  Only panes that are governed</span>
<a href="#l2.532"></a><span id="l2.532" class="difflineminus">-   *     by splitters are options here.  Keys are:</span>
<a href="#l2.533"></a><span id="l2.533" class="difflineminus">-   *     - folder: The folder (tree) pane.</span>
<a href="#l2.534"></a><span id="l2.534" class="difflineminus">-   *     - message: The message pane.</span>
<a href="#l2.535"></a><span id="l2.535" class="difflineminus">-   */</span>
<a href="#l2.536"></a><span id="l2.536" class="difflineminus">-  _setPaneStates: function mailTabType_setPaneStates(aLegalStates,</span>
<a href="#l2.537"></a><span id="l2.537" class="difflineminus">-                                                     aVisibleStates) {</span>
<a href="#l2.538"></a><span id="l2.538" class="difflineminus">-    // The display deck hosts both the thread pane and account central.</span>
<a href="#l2.539"></a><span id="l2.539" class="difflineminus">-    let displayDeckLegal = aLegalStates.thread ||</span>
<a href="#l2.540"></a><span id="l2.540" class="difflineminus">-                           aLegalStates.accountCentral;</span>
<a href="#l2.541"></a><span id="l2.541" class="difflineminus">-</span>
<a href="#l2.542"></a><span id="l2.542" class="difflineminus">-    let layout = pref.getIntPref(&quot;mail.pane_config.dynamic&quot;);</span>
<a href="#l2.543"></a><span id="l2.543" class="difflineminus">-    if (layout == kWidePaneConfig)</span>
<a href="#l2.544"></a><span id="l2.544" class="difflineminus">-    {</span>
<a href="#l2.545"></a><span id="l2.545" class="difflineminus">-      // in the &quot;wide&quot; configuration, the #messengerBox is left holding the</span>
<a href="#l2.546"></a><span id="l2.546" class="difflineminus">-      //  folder pane and thread pane, and the message pane has migrated to be</span>
<a href="#l2.547"></a><span id="l2.547" class="difflineminus">-      //  its sibling (under #mailContent).</span>
<a href="#l2.548"></a><span id="l2.548" class="difflineminus">-      // Accordingly, if both the folder and thread panes are illegal, we</span>
<a href="#l2.549"></a><span id="l2.549" class="difflineminus">-      //  want to collapse the #messengerBox and make sure the #messagepanebox</span>
<a href="#l2.550"></a><span id="l2.550" class="difflineminus">-      //  fills up the screen.  (For example, when in &quot;message&quot; mode.)</span>
<a href="#l2.551"></a><span id="l2.551" class="difflineminus">-      let collapseMessengerBox = !aLegalStates.folder &amp;&amp; !displayDeckLegal;</span>
<a href="#l2.552"></a><span id="l2.552" class="difflineminus">-      document.getElementById(&quot;messengerBox&quot;).collapsed = collapseMessengerBox;</span>
<a href="#l2.553"></a><span id="l2.553" class="difflineminus">-      if (collapseMessengerBox)</span>
<a href="#l2.554"></a><span id="l2.554" class="difflineminus">-        document.getElementById(&quot;messagepanebox&quot;).flex = 1;</span>
<a href="#l2.555"></a><span id="l2.555" class="difflineminus">-    }</span>
<a href="#l2.556"></a><span id="l2.556" class="difflineminus">-</span>
<a href="#l2.557"></a><span id="l2.557" class="difflineminus">-    // -- folder pane</span>
<a href="#l2.558"></a><span id="l2.558" class="difflineminus">-    // collapse the splitter when not legal</span>
<a href="#l2.559"></a><span id="l2.559" class="difflineminus">-    document.getElementById(&quot;folderpane_splitter&quot;).collapsed =</span>
<a href="#l2.560"></a><span id="l2.560" class="difflineminus">-      !aLegalStates.folder;</span>
<a href="#l2.561"></a><span id="l2.561" class="difflineminus">-    // collapse the folder pane when not visible</span>
<a href="#l2.562"></a><span id="l2.562" class="difflineminus">-    document.getElementById(&quot;folderPaneBox&quot;).collapsed =</span>
<a href="#l2.563"></a><span id="l2.563" class="difflineminus">-      !aLegalStates.folder || !aVisibleStates.folder;</span>
<a href="#l2.564"></a><span id="l2.564" class="difflineminus">-    try {</span>
<a href="#l2.565"></a><span id="l2.565" class="difflineminus">-      // The folder-location-toolbar is like the folder pane.</span>
<a href="#l2.566"></a><span id="l2.566" class="difflineminus">-      document.getElementById(&quot;folder-location-container&quot;).collapsed =</span>
<a href="#l2.567"></a><span id="l2.567" class="difflineminus">-        !aLegalStates.folder || !aVisibleStates.folder;</span>
<a href="#l2.568"></a><span id="l2.568" class="difflineminus">-    } catch (ex) {}</span>
<a href="#l2.569"></a><span id="l2.569" class="difflineminus">-</span>
<a href="#l2.570"></a><span id="l2.570" class="difflineminus">-    // -- display deck (thread pane / account central)</span>
<a href="#l2.571"></a><span id="l2.571" class="difflineminus">-    // in a vertical view, the threadContentArea sits in the #threadPaneBox</span>
<a href="#l2.572"></a><span id="l2.572" class="difflineminus">-    //  next to the message pane and its splitter.</span>
<a href="#l2.573"></a><span id="l2.573" class="difflineminus">-    if (layout == kVerticalMailLayout)</span>
<a href="#l2.574"></a><span id="l2.574" class="difflineminus">-      document.getElementById(&quot;threadContentArea&quot;).collapsed =</span>
<a href="#l2.575"></a><span id="l2.575" class="difflineminus">-        !displayDeckLegal;</span>
<a href="#l2.576"></a><span id="l2.576" class="difflineminus">-    // whereas in the default view, the displayDeck is the one next to the</span>
<a href="#l2.577"></a><span id="l2.577" class="difflineminus">-    //  message pane and its splitter</span>
<a href="#l2.578"></a><span id="l2.578" class="difflineminus">-    else</span>
<a href="#l2.579"></a><span id="l2.579" class="difflineminus">-      document.getElementById(&quot;displayDeck&quot;).collapsed =</span>
<a href="#l2.580"></a><span id="l2.580" class="difflineminus">-        !displayDeckLegal;</span>
<a href="#l2.581"></a><span id="l2.581" class="difflineminus">-</span>
<a href="#l2.582"></a><span id="l2.582" class="difflineminus">-    // -- thread pane</span>
<a href="#l2.583"></a><span id="l2.583" class="difflineminus">-    // the threadpane-splitter collapses the message pane (arguably a misnomer),</span>
<a href="#l2.584"></a><span id="l2.584" class="difflineminus">-    //  but it only needs to exist when the thread-pane is legal</span>
<a href="#l2.585"></a><span id="l2.585" class="difflineminus">-    document.getElementById(&quot;threadpane-splitter&quot;).collapsed =</span>
<a href="#l2.586"></a><span id="l2.586" class="difflineminus">-      !aLegalStates.thread;</span>
<a href="#l2.587"></a><span id="l2.587" class="difflineminus">-    if (aLegalStates.thread &amp;&amp; aLegalStates.message)</span>
<a href="#l2.588"></a><span id="l2.588" class="difflineminus">-      document.getElementById(&quot;threadpane-splitter&quot;).setAttribute(&quot;state&quot;,</span>
<a href="#l2.589"></a><span id="l2.589" class="difflineminus">-        aVisibleStates.message ? &quot;open&quot; : &quot;collapsed&quot;);</span>
<a href="#l2.590"></a><span id="l2.590" class="difflineminus">-</span>
<a href="#l2.591"></a><span id="l2.591" class="difflineminus">-    // Some things do not make sense if the thread pane is not legal.</span>
<a href="#l2.592"></a><span id="l2.592" class="difflineminus">-    // (This is likely an example of something that should be using the command</span>
<a href="#l2.593"></a><span id="l2.593" class="difflineminus">-    //  mechanism to update the UI elements as to the state of what the user</span>
<a href="#l2.594"></a><span id="l2.594" class="difflineminus">-    //  is looking at, rather than home-brewing it in here.)</span>
<a href="#l2.595"></a><span id="l2.595" class="difflineminus">-    try {</span>
<a href="#l2.596"></a><span id="l2.596" class="difflineminus">-      // you can't quick-search if you don't have a collection of messages</span>
<a href="#l2.597"></a><span id="l2.597" class="difflineminus">-      document.getElementById(&quot;search-container&quot;).collapsed =</span>
<a href="#l2.598"></a><span id="l2.598" class="difflineminus">-        !aLegalStates.thread;</span>
<a href="#l2.599"></a><span id="l2.599" class="difflineminus">-    } catch (ex) {}</span>
<a href="#l2.600"></a><span id="l2.600" class="difflineminus">-    try {</span>
<a href="#l2.601"></a><span id="l2.601" class="difflineminus">-      // views only work on the thread pane; no thread pane, no views</span>
<a href="#l2.602"></a><span id="l2.602" class="difflineminus">-      document.getElementById(&quot;mailviews-container&quot;).collapsed =</span>
<a href="#l2.603"></a><span id="l2.603" class="difflineminus">-        !aLegalStates.thread;</span>
<a href="#l2.604"></a><span id="l2.604" class="difflineminus">-    } catch (ex) {}</span>
<a href="#l2.605"></a><span id="l2.605" class="difflineminus">-</span>
<a href="#l2.606"></a><span id="l2.606" class="difflineminus">-    // -- thread pane status bar helpers</span>
<a href="#l2.607"></a><span id="l2.607" class="difflineminus">-    document.getElementById(&quot;unreadMessageCount&quot;).hidden = !aLegalStates.thread;</span>
<a href="#l2.608"></a><span id="l2.608" class="difflineminus">-    document.getElementById(&quot;totalMessageCount&quot;).hidden = !aLegalStates.thread;</span>
<a href="#l2.609"></a><span id="l2.609" class="difflineminus">-</span>
<a href="#l2.610"></a><span id="l2.610" class="difflineminus">-    // -- message pane</span>
<a href="#l2.611"></a><span id="l2.611" class="difflineminus">-    document.getElementById(&quot;messagepanebox&quot;).collapsed =</span>
<a href="#l2.612"></a><span id="l2.612" class="difflineminus">-      !aLegalStates.message || !aVisibleStates.message;</span>
<a href="#l2.613"></a><span id="l2.613" class="difflineminus">-</span>
<a href="#l2.614"></a><span id="l2.614" class="difflineminus">-    // we are responsible for updating the keybinding; view_init takes care of</span>
<a href="#l2.615"></a><span id="l2.615" class="difflineminus">-    //  updating the menu item (on demand)</span>
<a href="#l2.616"></a><span id="l2.616" class="difflineminus">-    let messagePaneToggleKey = document.getElementById(&quot;key_toggleMessagePane&quot;);</span>
<a href="#l2.617"></a><span id="l2.617" class="difflineminus">-    if (aLegalStates.thread)</span>
<a href="#l2.618"></a><span id="l2.618" class="difflineminus">-      messagePaneToggleKey.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l2.619"></a><span id="l2.619" class="difflineminus">-    else</span>
<a href="#l2.620"></a><span id="l2.620" class="difflineminus">-      messagePaneToggleKey.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l2.621"></a><span id="l2.621" class="difflineminus">-  },</span>
<a href="#l2.622"></a><span id="l2.622" class="difflineminus">-</span>
<a href="#l2.623"></a><span id="l2.623" class="difflineminus">-  showTab: function(aTab) {</span>
<a href="#l2.624"></a><span id="l2.624" class="difflineminus">-    // Set the messagepane as the primary browser for content.</span>
<a href="#l2.625"></a><span id="l2.625" class="difflineminus">-    document.getElementById(&quot;messagepane&quot;).setAttribute(&quot;type&quot;,</span>
<a href="#l2.626"></a><span id="l2.626" class="difflineminus">-                                                        &quot;content-primary&quot;);</span>
<a href="#l2.627"></a><span id="l2.627" class="difflineminus">-</span>
<a href="#l2.628"></a><span id="l2.628" class="difflineminus">-    aTab.folderDisplay.makeActive();</span>
<a href="#l2.629"></a><span id="l2.629" class="difflineminus">-</span>
<a href="#l2.630"></a><span id="l2.630" class="difflineminus">-    // - restore folder pane/tree selection</span>
<a href="#l2.631"></a><span id="l2.631" class="difflineminus">-    if (aTab.folderDisplay.displayedFolder) {</span>
<a href="#l2.632"></a><span id="l2.632" class="difflineminus">-      // but don't generate any events while doing so!</span>
<a href="#l2.633"></a><span id="l2.633" class="difflineminus">-      gFolderTreeView.selection.selectEventsSuppressed = true;</span>
<a href="#l2.634"></a><span id="l2.634" class="difflineminus">-      try {</span>
<a href="#l2.635"></a><span id="l2.635" class="difflineminus">-        gFolderTreeView.selectFolder(aTab.folderDisplay.displayedFolder);</span>
<a href="#l2.636"></a><span id="l2.636" class="difflineminus">-      }</span>
<a href="#l2.637"></a><span id="l2.637" class="difflineminus">-      finally {</span>
<a href="#l2.638"></a><span id="l2.638" class="difflineminus">-        gIgnoreSyntheticFolderPaneSelectionChange = true;</span>
<a href="#l2.639"></a><span id="l2.639" class="difflineminus">-        gFolderTreeView.selection.selectEventsSuppressed = false;</span>
<a href="#l2.640"></a><span id="l2.640" class="difflineminus">-      }</span>
<a href="#l2.641"></a><span id="l2.641" class="difflineminus">-    }</span>
<a href="#l2.642"></a><span id="l2.642" class="difflineminus">-</span>
<a href="#l2.643"></a><span id="l2.643" class="difflineminus">-    // restore focus</span>
<a href="#l2.644"></a><span id="l2.644" class="difflineminus">-    this.restoreFocus(aTab);</span>
<a href="#l2.645"></a><span id="l2.645" class="difflineminus">-  },</span>
<a href="#l2.646"></a><span id="l2.646" class="difflineminus">-</span>
<a href="#l2.647"></a><span id="l2.647" class="difflineminus">-  //</span>
<a href="#l2.648"></a><span id="l2.648" class="difflineminus">-  // nsIController implementation</span>
<a href="#l2.649"></a><span id="l2.649" class="difflineminus">-  //</span>
<a href="#l2.650"></a><span id="l2.650" class="difflineminus">-  // We ignore the aTab parameter sent by tabmail when calling nsIController</span>
<a href="#l2.651"></a><span id="l2.651" class="difflineminus">-  // stuff and just delegate the call to a default controller by using it as</span>
<a href="#l2.652"></a><span id="l2.652" class="difflineminus">-  // our proto chain:</span>
<a href="#l2.653"></a><span id="l2.653" class="difflineminus">-  // - &quot;DefaultController&quot; is the default controller of messenger.xul</span>
<a href="#l2.654"></a><span id="l2.654" class="difflineminus">-  // - &quot;MessageWindowController&quot; is the default controller of messageWindow.xul</span>
<a href="#l2.655"></a><span id="l2.655" class="difflineminus">-  __proto__: &quot;DefaultController&quot; in window &amp;&amp; window.DefaultController ||</span>
<a href="#l2.656"></a><span id="l2.656" class="difflineminus">-             &quot;MessageWindowController&quot; in window &amp;&amp; window.MessageWindowController</span>
<a href="#l2.657"></a><span id="l2.657" class="difflineminus">-};</span>
<a href="#l2.658"></a><span id="l2.658" class="difflineminus">-</span>
<a href="#l2.659"></a><span id="l2.659" class="difflineminus">-</span>
<a href="#l2.660"></a><span id="l2.660"> function MsgOpenNewWindowForFolder(folderURI, msgKeyToSelect)</span>
<a href="#l2.661"></a><span id="l2.661"> {</span>
<a href="#l2.662"></a><span id="l2.662">   if (folderURI) {</span>
<a href="#l2.663"></a><span id="l2.663">     window.openDialog(&quot;chrome://messenger/content/&quot;, &quot;_blank&quot;,</span>
<a href="#l2.664"></a><span id="l2.664">                       &quot;chrome,all,dialog=no&quot;, folderURI, msgKeyToSelect);</span>
<a href="#l2.665"></a><span id="l2.665">     return;</span>
<a href="#l2.666"></a><span id="l2.666">   }</span>
<a href="#l2.667"></a><span id="l2.667"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/base/content/mailWindowOverlay.xul</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/base/content/mailWindowOverlay.xul</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -57,16 +57,17 @@</span>
<a href="#l3.4"></a><span id="l3.4">   %brandDTD;</span>
<a href="#l3.5"></a><span id="l3.5"> ]&gt;</span>
<a href="#l3.6"></a><span id="l3.6"> </span>
<a href="#l3.7"></a><span id="l3.7"> &lt;overlay xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;&gt;</span>
<a href="#l3.8"></a><span id="l3.8"> </span>
<a href="#l3.9"></a><span id="l3.9"> &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/mailCommands.js&quot;/&gt;</span>
<a href="#l3.10"></a><span id="l3.10"> &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/junkCommands.js&quot;/&gt;</span>
<a href="#l3.11"></a><span id="l3.11"> &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/mailWindowOverlay.js&quot;/&gt;</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+&lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/mailTabs.js&quot;/&gt;</span>
<a href="#l3.13"></a><span id="l3.13"> &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/messageDisplay.js&quot;/&gt;</span>
<a href="#l3.14"></a><span id="l3.14"> &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/folderDisplay.js&quot;/&gt;</span>
<a href="#l3.15"></a><span id="l3.15"> &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger-newsblog/content/newsblogOverlay.js&quot;/&gt;</span>
<a href="#l3.16"></a><span id="l3.16"> &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/mail-offline.js&quot;/&gt;</span>
<a href="#l3.17"></a><span id="l3.17"> &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://global/content/printUtils.js&quot;/&gt;</span>
<a href="#l3.18"></a><span id="l3.18"> &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/msgViewPickerOverlay.js&quot;/&gt;</span>
<a href="#l3.19"></a><span id="l3.19"> &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://global/content/viewZoomOverlay.js&quot;/&gt;</span>
<a href="#l3.20"></a><span id="l3.20"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/base/jar.mn</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/base/jar.mn</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -28,16 +28,17 @@ messenger.jar:</span>
<a href="#l4.4"></a><span id="l4.4">     content/messenger/msgViewNavigation.js          (content/msgViewNavigation.js)</span>
<a href="#l4.5"></a><span id="l4.5">     content/messenger/mailWidgets.xml               (content/mailWidgets.xml)</span>
<a href="#l4.6"></a><span id="l4.6">     content/messenger/editContactOverlay.js         (content/editContactOverlay.js)</span>
<a href="#l4.7"></a><span id="l4.7"> *   content/messenger/editContactOverlay.xul        (content/editContactOverlay.xul)</span>
<a href="#l4.8"></a><span id="l4.8">     content/messenger/msgMail3PaneWindow.js         (content/msgMail3PaneWindow.js)</span>
<a href="#l4.9"></a><span id="l4.9">     content/messenger/mail3PaneWindowCommands.js    (content/mail3PaneWindowCommands.js)</span>
<a href="#l4.10"></a><span id="l4.10"> *   content/messenger/mailCommands.js               (content/mailCommands.js)</span>
<a href="#l4.11"></a><span id="l4.11"> *   content/messenger/mailCore.js                   (content/mailCore.js)</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+    content/messenger/mailTabs.js                   (content/mailTabs.js)</span>
<a href="#l4.13"></a><span id="l4.13">     content/messenger/commandglue.js                (content/commandglue.js)</span>
<a href="#l4.14"></a><span id="l4.14">     content/messenger/widgetglue.js                 (content/widgetglue.js)</span>
<a href="#l4.15"></a><span id="l4.15"> *   content/messenger/SearchDialog.xul              (content/SearchDialog.xul)</span>
<a href="#l4.16"></a><span id="l4.16">     content/messenger/SearchDialog.js               (content/SearchDialog.js)</span>
<a href="#l4.17"></a><span id="l4.17"> *   content/messenger/ABSearchDialog.xul            (content/ABSearchDialog.xul)</span>
<a href="#l4.18"></a><span id="l4.18"> *   content/messenger/ABSearchDialog.js             (content/ABSearchDialog.js)</span>
<a href="#l4.19"></a><span id="l4.19"> *   content/messenger/FilterListDialog.xul          (content/FilterListDialog.xul)</span>
<a href="#l4.20"></a><span id="l4.20"> *   content/messenger/FilterListDialog.js           (content/FilterListDialog.js)</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

