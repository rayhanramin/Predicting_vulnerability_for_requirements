<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 6800:42371756f23485c943de0497a42e5d3ed6daabde</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 42371756f23485c943de0497a42e5d3ed6daabde" />
<meta property="og:url" content="/comm-central/rev/42371756f23485c943de0497a42e5d3ed6daabde" />
<meta property="og:description" content="Bug 575782 - Lightning 1.0 beta 2 does not work with non-ASCII characters in event names r=philipp" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 42371756f23485c943de0497a42e5d3ed6daabde 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/42371756f23485c943de0497a42e5d3ed6daabde">shortlog</a> |
<a href="/comm-central/log/42371756f23485c943de0497a42e5d3ed6daabde">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/42371756f23485c943de0497a42e5d3ed6daabde">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/42371756f23485c943de0497a42e5d3ed6daabde">files</a> |
changeset |
<a href="/comm-central/raw-rev/42371756f23485c943de0497a42e5d3ed6daabde">raw</a>  | <a href="/comm-central/archive/42371756f23485c943de0497a42e5d3ed6daabde.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=575782">Bug 575782</a> - Lightning 1.0 beta 2 does not work with non-ASCII characters in event names r=philipp
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#83;&#105;&#109;&#111;&#110;&#32;&#86;&#97;&#105;&#108;&#108;&#97;&#110;&#99;&#111;&#117;&#114;&#116;&#32;&#60;&#115;&#105;&#109;&#111;&#110;&#46;&#97;&#116;&#46;&#111;&#114;&#99;&#108;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 06 Dec 2010 13:22:34 -0500</td></tr>

<tr>
 <td>changeset 6800</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/42371756f23485c943de0497a42e5d3ed6daabde">42371756f23485c943de0497a42e5d3ed6daabde</a></td>
</tr>



<tr>
<td>parent 6799</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/ce7efebfdbdec7fc6b642edad815da4c33044906">ce7efebfdbdec7fc6b642edad815da4c33044906</a>
</td>
</tr>

<tr>
<td>child 6801</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/1dc9fb072bf4942570fe7fe6e05a5942d6c39f9c">1dc9fb072bf4942570fe7fe6e05a5942d6c39f9c</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=42371756f23485c943de0497a42e5d3ed6daabde">5215</a></td></tr>
<tr><td>push user</td><td>simon.at.orcl@gmail.com</td></tr>
<tr><td>push date</td><td class="date age">Mon, 06 Dec 2010 18:46:08 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@42371756f234 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=42371756f23485c943de0497a42e5d3ed6daabde">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=42371756f23485c943de0497a42e5d3ed6daabde&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=42371756f23485c943de0497a42e5d3ed6daabde&newProject=comm-central&newRevision=42371756f23485c943de0497a42e5d3ed6daabde&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=42371756f23485c943de0497a42e5d3ed6daabde&newProject=comm-central&newRevision=42371756f23485c943de0497a42e5d3ed6daabde&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=42371756f23485c943de0497a42e5d3ed6daabde&newProject=comm-central&newRevision=42371756f23485c943de0497a42e5d3ed6daabde&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28philipp%29&revcount=50">philipp</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=575782">575782</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=575782">Bug 575782</a> - Lightning 1.0 beta 2 does not work with non-ASCII characters in event names r=philipp</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/42371756f23485c943de0497a42e5d3ed6daabde/calendar/providers/caldav/calDavCalendar.js">calendar/providers/caldav/calDavCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/42371756f23485c943de0497a42e5d3ed6daabde/calendar/providers/caldav/calDavCalendar.js">file</a> |
<a href="/comm-central/annotate/42371756f23485c943de0497a42e5d3ed6daabde/calendar/providers/caldav/calDavCalendar.js">annotate</a> |
<a href="/comm-central/diff/42371756f23485c943de0497a42e5d3ed6daabde/calendar/providers/caldav/calDavCalendar.js">diff</a> |
<a href="/comm-central/comparison/42371756f23485c943de0497a42e5d3ed6daabde/calendar/providers/caldav/calDavCalendar.js">comparison</a> |
<a href="/comm-central/log/42371756f23485c943de0497a42e5d3ed6daabde/calendar/providers/caldav/calDavCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/42371756f23485c943de0497a42e5d3ed6daabde/calendar/providers/caldav/calDavRequestHandlers.js">calendar/providers/caldav/calDavRequestHandlers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/42371756f23485c943de0497a42e5d3ed6daabde/calendar/providers/caldav/calDavRequestHandlers.js">file</a> |
<a href="/comm-central/annotate/42371756f23485c943de0497a42e5d3ed6daabde/calendar/providers/caldav/calDavRequestHandlers.js">annotate</a> |
<a href="/comm-central/diff/42371756f23485c943de0497a42e5d3ed6daabde/calendar/providers/caldav/calDavRequestHandlers.js">diff</a> |
<a href="/comm-central/comparison/42371756f23485c943de0497a42e5d3ed6daabde/calendar/providers/caldav/calDavRequestHandlers.js">comparison</a> |
<a href="/comm-central/log/42371756f23485c943de0497a42e5d3ed6daabde/calendar/providers/caldav/calDavRequestHandlers.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/calendar/providers/caldav/calDavCalendar.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/calendar/providers/caldav/calDavCalendar.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -67,17 +67,17 @@ function calDavCalendar() {</span>
<a href="#l1.4"></a><span id="l1.4">     this.mItemInfoCache = {};</span>
<a href="#l1.5"></a><span id="l1.5">     this.mDisabled = false;</span>
<a href="#l1.6"></a><span id="l1.6">     this.mCalHomeSet = null;</span>
<a href="#l1.7"></a><span id="l1.7">     this.mInboxUrl = null;</span>
<a href="#l1.8"></a><span id="l1.8">     this.mOutboxUrl = null;</span>
<a href="#l1.9"></a><span id="l1.9">     this.mCalendarUserAddress = null;</span>
<a href="#l1.10"></a><span id="l1.10">     this.mPrincipalUrl = null;</span>
<a href="#l1.11"></a><span id="l1.11">     this.mSenderAddress = null;</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-    this.mHrefIndex = {};</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+    this.mPathIndex = {};</span>
<a href="#l1.14"></a><span id="l1.14">     this.mAuthScheme = null;</span>
<a href="#l1.15"></a><span id="l1.15">     this.mAuthRealm = null;</span>
<a href="#l1.16"></a><span id="l1.16">     this.mObserver = null;</span>
<a href="#l1.17"></a><span id="l1.17">     this.mFirstRefreshDone = false;</span>
<a href="#l1.18"></a><span id="l1.18">     this.mTargetCalendar = null;</span>
<a href="#l1.19"></a><span id="l1.19">     this.mQueuedQueries = [];</span>
<a href="#l1.20"></a><span id="l1.20">     this.mCtag = null;</span>
<a href="#l1.21"></a><span id="l1.21"> </span>
<a href="#l1.22"></a><span id="l1.22" class="difflineat">@@ -193,17 +193,17 @@ calDavCalendar.prototype = {</span>
<a href="#l1.23"></a><span id="l1.23">                 try {</span>
<a href="#l1.24"></a><span id="l1.24">                     this.mCtag = null;</span>
<a href="#l1.25"></a><span id="l1.25">                     this.mTargetCalendar.deleteMetaData(&quot;ctag&quot;);</span>
<a href="#l1.26"></a><span id="l1.26">                 } catch(e) {</span>
<a href="#l1.27"></a><span id="l1.27">                     cal.ERROR(e);</span>
<a href="#l1.28"></a><span id="l1.28">                 }</span>
<a href="#l1.29"></a><span id="l1.29">                 try {</span>
<a href="#l1.30"></a><span id="l1.30">                     this.mWebdavSyncToken = null;</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-                    this.mTargetCalendar.deleteMetaData(&quot;sync-token&quot;);</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+                    this.mTargetCalendar.deleteMetaData(&quot;webdav-sync-token&quot;);</span>
<a href="#l1.33"></a><span id="l1.33">                 } catch(e) {</span>
<a href="#l1.34"></a><span id="l1.34">                     cal.ERROR(e);</span>
<a href="#l1.35"></a><span id="l1.35">                 }</span>
<a href="#l1.36"></a><span id="l1.36"> </span>
<a href="#l1.37"></a><span id="l1.37">                 for (var itemId in this.mItemInfoCache) {</span>
<a href="#l1.38"></a><span id="l1.38">                     this.mTargetCalendar.deleteMetaData(itemId);</span>
<a href="#l1.39"></a><span id="l1.39">                     delete this.mItemInfoCache[itemId];</span>
<a href="#l1.40"></a><span id="l1.40">                 }</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineat">@@ -231,26 +231,26 @@ calDavCalendar.prototype = {</span>
<a href="#l1.42"></a><span id="l1.42">         this.mTargetCalendar.getAllMetaData({}, cacheIds, cacheValues);</span>
<a href="#l1.43"></a><span id="l1.43">         cacheIds = cacheIds.value;</span>
<a href="#l1.44"></a><span id="l1.44">         cacheValues = cacheValues.value;</span>
<a href="#l1.45"></a><span id="l1.45">         for (var count = 0; count &lt; cacheIds.length; count++) {</span>
<a href="#l1.46"></a><span id="l1.46">             var itemId = cacheIds[count];</span>
<a href="#l1.47"></a><span id="l1.47">             var itemData = cacheValues[count];</span>
<a href="#l1.48"></a><span id="l1.48">             if (itemId == &quot;ctag&quot;) {</span>
<a href="#l1.49"></a><span id="l1.49">                 this.mCtag = itemData;</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineminus">-            } else if (itemId == &quot;sync-token&quot;) {</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineplus">+            } else if (itemId == &quot;webdav-sync-token&quot;) {</span>
<a href="#l1.52"></a><span id="l1.52">                 this.mWebdavSyncToken = itemData;</span>
<a href="#l1.53"></a><span id="l1.53">             } else {</span>
<a href="#l1.54"></a><span id="l1.54">                 var itemDataArray = itemData.split(&quot;\u001A&quot;);</span>
<a href="#l1.55"></a><span id="l1.55">                 var etag = itemDataArray[0];</span>
<a href="#l1.56"></a><span id="l1.56">                 var resourcePath = itemDataArray[1];</span>
<a href="#l1.57"></a><span id="l1.57">                 var isInboxItem = itemDataArray[2];</span>
<a href="#l1.58"></a><span id="l1.58">                 if (itemDataArray.length == 3) {</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineminus">-                    this.mHrefIndex[resourcePath] = itemId;</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineminus">-                    var locationPath = decodeURIComponent(resourcePath)</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineplus">+                    this.mPathIndex[resourcePath] = itemId;</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineplus">+                    var locationPath = resourcePath</span>
<a href="#l1.63"></a><span id="l1.63">                         .substr(this.mLocationPath.length);</span>
<a href="#l1.64"></a><span id="l1.64">                     var item = { etag: etag,</span>
<a href="#l1.65"></a><span id="l1.65">                                  isNew: false,</span>
<a href="#l1.66"></a><span id="l1.66">                                  locationPath: locationPath,</span>
<a href="#l1.67"></a><span id="l1.67">                                  isInboxItem: (isInboxItem == &quot;true&quot;)};</span>
<a href="#l1.68"></a><span id="l1.68">                     this.mItemInfoCache[itemId] = item;</span>
<a href="#l1.69"></a><span id="l1.69">                 }</span>
<a href="#l1.70"></a><span id="l1.70">             }</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineat">@@ -376,27 +376,43 @@ calDavCalendar.prototype = {</span>
<a href="#l1.72"></a><span id="l1.72">     // a subsequent multiget needs to be sent to the server to retrieve</span>
<a href="#l1.73"></a><span id="l1.73">     // the calendar-data property.</span>
<a href="#l1.74"></a><span id="l1.74">     mHasWebdavSyncCalendarDataSupport: true,</span>
<a href="#l1.75"></a><span id="l1.75"> </span>
<a href="#l1.76"></a><span id="l1.76">     get authRealm() {</span>
<a href="#l1.77"></a><span id="l1.77">         return this.mAuthRealm;</span>
<a href="#l1.78"></a><span id="l1.78">     },</span>
<a href="#l1.79"></a><span id="l1.79"> </span>
<a href="#l1.80"></a><span id="l1.80" class="difflineplus">+    /**</span>
<a href="#l1.81"></a><span id="l1.81" class="difflineplus">+     * Builds a correctly encoded nsIURI based on the baseUri and the insert</span>
<a href="#l1.82"></a><span id="l1.82" class="difflineplus">+     * string. The returned uri is basically the baseURI + aInsertString</span>
<a href="#l1.83"></a><span id="l1.83" class="difflineplus">+     *</span>
<a href="#l1.84"></a><span id="l1.84" class="difflineplus">+     * @param aInsertString  String to append to the base uri, for example,</span>
<a href="#l1.85"></a><span id="l1.85" class="difflineplus">+     *                       when creating an event this would be the</span>
<a href="#l1.86"></a><span id="l1.86" class="difflineplus">+     *                       event file name (event.ics), if null, an empty</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineplus">+     *                       string is used.</span>
<a href="#l1.88"></a><span id="l1.88" class="difflineplus">+     * @param aBaseUri       base uri (nsIURI object), if null, this.calendarUri</span>
<a href="#l1.89"></a><span id="l1.89" class="difflineplus">+     *                       will be used.</span>
<a href="#l1.90"></a><span id="l1.90" class="difflineplus">+     */</span>
<a href="#l1.91"></a><span id="l1.91">     makeUri: function caldav_makeUri(aInsertString, aBaseUri) {</span>
<a href="#l1.92"></a><span id="l1.92">         let baseUri = aBaseUri || this.calendarUri;</span>
<a href="#l1.93"></a><span id="l1.93" class="difflineminus">-        let spec = baseUri.spec + (aInsertString || &quot;&quot;);</span>
<a href="#l1.94"></a><span id="l1.94" class="difflineminus">-        if (this.mUriParams) {</span>
<a href="#l1.95"></a><span id="l1.95" class="difflineminus">-            spec += this.mUriParams;</span>
<a href="#l1.96"></a><span id="l1.96" class="difflineminus">-        }</span>
<a href="#l1.97"></a><span id="l1.97" class="difflineminus">-        return makeURL(spec);</span>
<a href="#l1.98"></a><span id="l1.98" class="difflineplus">+        // Build a string containing the full path, decoded, so it looks like</span>
<a href="#l1.99"></a><span id="l1.99" class="difflineplus">+        // this:</span>
<a href="#l1.100"></a><span id="l1.100" class="difflineplus">+        // /some path/insert string.ics</span>
<a href="#l1.101"></a><span id="l1.101" class="difflineplus">+        let decodedPath = this.ensureDecodedPath(baseUri.path) + (aInsertString || &quot;&quot;);</span>
<a href="#l1.102"></a><span id="l1.102" class="difflineplus">+</span>
<a href="#l1.103"></a><span id="l1.103" class="difflineplus">+        // Build the nsIURI by specifying a string with a fully encoded path</span>
<a href="#l1.104"></a><span id="l1.104" class="difflineplus">+        // the end result will be something like this:</span>
<a href="#l1.105"></a><span id="l1.105" class="difflineplus">+        // http://caldav.example.com:8080/some%20path/insert%20string.ics</span>
<a href="#l1.106"></a><span id="l1.106" class="difflineplus">+        let url = cal.makeURL(baseUri.prePath + this.ensureEncodedPath(decodedPath) + (this.mUriParams || &quot;&quot;));</span>
<a href="#l1.107"></a><span id="l1.107" class="difflineplus">+        return url;</span>
<a href="#l1.108"></a><span id="l1.108">     },</span>
<a href="#l1.109"></a><span id="l1.109"> </span>
<a href="#l1.110"></a><span id="l1.110">     get mLocationPath() {</span>
<a href="#l1.111"></a><span id="l1.111" class="difflineminus">-        return decodeURIComponent(this.calendarUri.path);</span>
<a href="#l1.112"></a><span id="l1.112" class="difflineplus">+        return this.ensureDecodedPath(this.calendarUri.path);</span>
<a href="#l1.113"></a><span id="l1.113">     },</span>
<a href="#l1.114"></a><span id="l1.114"> </span>
<a href="#l1.115"></a><span id="l1.115">     getItemLocationPath: function caldav_getItemLocationPath(aItem) {</span>
<a href="#l1.116"></a><span id="l1.116">         if (aItem.id &amp;&amp;</span>
<a href="#l1.117"></a><span id="l1.117">             aItem.id in this.mItemInfoCache &amp;&amp;</span>
<a href="#l1.118"></a><span id="l1.118">             this.mItemInfoCache[aItem.id].locationPath) {</span>
<a href="#l1.119"></a><span id="l1.119">             // modifying items use the cached location path</span>
<a href="#l1.120"></a><span id="l1.120">             return this.mItemInfoCache[aItem.id].locationPath;</span>
<a href="#l1.121"></a><span id="l1.121" class="difflineat">@@ -468,17 +484,17 @@ calDavCalendar.prototype = {</span>
<a href="#l1.122"></a><span id="l1.122">         } else {</span>
<a href="#l1.123"></a><span id="l1.123">             this.getUpdatedItem(aItem, aListener);</span>
<a href="#l1.124"></a><span id="l1.124">         }</span>
<a href="#l1.125"></a><span id="l1.125"> </span>
<a href="#l1.126"></a><span id="l1.126">     },</span>
<a href="#l1.127"></a><span id="l1.127"> </span>
<a href="#l1.128"></a><span id="l1.128">     mItemInfoCache: null,</span>
<a href="#l1.129"></a><span id="l1.129"> </span>
<a href="#l1.130"></a><span id="l1.130" class="difflineminus">-    mHrefIndex: null,</span>
<a href="#l1.131"></a><span id="l1.131" class="difflineplus">+    mPathIndex: null,</span>
<a href="#l1.132"></a><span id="l1.132"> </span>
<a href="#l1.133"></a><span id="l1.133">     /**</span>
<a href="#l1.134"></a><span id="l1.134">      * addItem()</span>
<a href="#l1.135"></a><span id="l1.135">      * we actually use doAdoptItem()</span>
<a href="#l1.136"></a><span id="l1.136">      *</span>
<a href="#l1.137"></a><span id="l1.137">      * @param aItem       item to add</span>
<a href="#l1.138"></a><span id="l1.138">      * @param aListener   listener for method completion</span>
<a href="#l1.139"></a><span id="l1.139">      */</span>
<a href="#l1.140"></a><span id="l1.140" class="difflineat">@@ -769,18 +785,18 @@ calDavCalendar.prototype = {</span>
<a href="#l1.141"></a><span id="l1.141">                     if (thisCalendar.isCached) {</span>
<a href="#l1.142"></a><span id="l1.142">                         // the item is deleted in the storage calendar from calCachedCalendar</span>
<a href="#l1.143"></a><span id="l1.143">                         realListener.onOperationComplete(thisCalendar, status,</span>
<a href="#l1.144"></a><span id="l1.144">                                                          Components.interfaces.calIOperationListener.DELETE,</span>
<a href="#l1.145"></a><span id="l1.145">                                                          null, null);</span>
<a href="#l1.146"></a><span id="l1.146">                     } else {</span>
<a href="#l1.147"></a><span id="l1.147">                         thisCalendar.mTargetCalendar.deleteItem(aItem, aListener);</span>
<a href="#l1.148"></a><span id="l1.148">                     }</span>
<a href="#l1.149"></a><span id="l1.149" class="difflineminus">-                    let decodedHRef = decodeURIComponent(eventUri.path);</span>
<a href="#l1.150"></a><span id="l1.150" class="difflineminus">-                    delete thisCalendar.mHrefIndex[decodedHRef];</span>
<a href="#l1.151"></a><span id="l1.151" class="difflineplus">+                    let decodedPath = thisCalendar.ensureDecodedPath(eventUri.path);</span>
<a href="#l1.152"></a><span id="l1.152" class="difflineplus">+                    delete thisCalendar.mPathIndex[decodedPath];</span>
<a href="#l1.153"></a><span id="l1.153">                     delete thisCalendar.mItemInfoCache[aItem.id];</span>
<a href="#l1.154"></a><span id="l1.154">                     cal.LOG(&quot;CalDAV: Item deleted successfully from calendar&quot; +</span>
<a href="#l1.155"></a><span id="l1.155">                             thisCalendar.name);</span>
<a href="#l1.156"></a><span id="l1.156">                 }</span>
<a href="#l1.157"></a><span id="l1.157">             } else if (status == 412) {</span>
<a href="#l1.158"></a><span id="l1.158">                 // item has either been modified or deleted by someone else</span>
<a href="#l1.159"></a><span id="l1.159">                 // check to see which</span>
<a href="#l1.160"></a><span id="l1.160"> </span>
<a href="#l1.161"></a><span id="l1.161" class="difflineat">@@ -833,26 +849,25 @@ calDavCalendar.prototype = {</span>
<a href="#l1.162"></a><span id="l1.162">         httpchannel.requestMethod = &quot;DELETE&quot;;</span>
<a href="#l1.163"></a><span id="l1.163"> </span>
<a href="#l1.164"></a><span id="l1.164">         cal.sendHttpRequest(cal.createStreamLoader(), httpchannel, delListener);</span>
<a href="#l1.165"></a><span id="l1.165">     },</span>
<a href="#l1.166"></a><span id="l1.166"> </span>
<a href="#l1.167"></a><span id="l1.167">     /**</span>
<a href="#l1.168"></a><span id="l1.168">      * Add an item to the target calendar</span>
<a href="#l1.169"></a><span id="l1.169">      *</span>
<a href="#l1.170"></a><span id="l1.170" class="difflineminus">-     * @param href      Item href</span>
<a href="#l1.171"></a><span id="l1.171" class="difflineplus">+     * @param path      Item path MUST NOT BE ENCODED</span>
<a href="#l1.172"></a><span id="l1.172">      * @param calData   iCalendar string representation of the item</span>
<a href="#l1.173"></a><span id="l1.173">      * @param aUri      Base URI of the request</span>
<a href="#l1.174"></a><span id="l1.174">      * @param aListener Listener</span>
<a href="#l1.175"></a><span id="l1.175">      */</span>
<a href="#l1.176"></a><span id="l1.176" class="difflineminus">-    addTargetCalendarItem : function caldav_addTargetCalendarItem(href,calData,aUri, etag, aListener) {</span>
<a href="#l1.177"></a><span id="l1.177" class="difflineplus">+    addTargetCalendarItem : function caldav_addTargetCalendarItem(path,calData,aUri, etag, aListener) {</span>
<a href="#l1.178"></a><span id="l1.178">         let parser = Components.classes[&quot;@mozilla.org/calendar/ics-parser;1&quot;]</span>
<a href="#l1.179"></a><span id="l1.179">                                .createInstance(Components.interfaces.calIIcsParser);</span>
<a href="#l1.180"></a><span id="l1.180">         let uriPathComponentLength = aUri.path.split(&quot;/&quot;).length;</span>
<a href="#l1.181"></a><span id="l1.181" class="difflineminus">-        let resourcePath = this.ensurePath(href);</span>
<a href="#l1.182"></a><span id="l1.182">         try {</span>
<a href="#l1.183"></a><span id="l1.183">             parser.parseString(calData);</span>
<a href="#l1.184"></a><span id="l1.184">         } catch (e) {</span>
<a href="#l1.185"></a><span id="l1.185">             // Warn and continue.</span>
<a href="#l1.186"></a><span id="l1.186">             // TODO As soon as we have activity manager integration,</span>
<a href="#l1.187"></a><span id="l1.187">             // this should be replace with logic to notify that a</span>
<a href="#l1.188"></a><span id="l1.188">             // certain event failed.</span>
<a href="#l1.189"></a><span id="l1.189">             cal.WARN(&quot;Failed to parse item: &quot; + response.toXMLString());</span>
<a href="#l1.190"></a><span id="l1.190" class="difflineat">@@ -873,65 +888,64 @@ calDavCalendar.prototype = {</span>
<a href="#l1.191"></a><span id="l1.191">         if (!item) {</span>
<a href="#l1.192"></a><span id="l1.192">             cal.WARN(&quot;Failed to parse item: &quot; + calData);</span>
<a href="#l1.193"></a><span id="l1.193">             return;</span>
<a href="#l1.194"></a><span id="l1.194">         }</span>
<a href="#l1.195"></a><span id="l1.195"> </span>
<a href="#l1.196"></a><span id="l1.196">         item.calendar = this.superCalendar;</span>
<a href="#l1.197"></a><span id="l1.197">         if (isReply &amp;&amp; this.isInbox(aUri.spec)) {</span>
<a href="#l1.198"></a><span id="l1.198">             if (this.hasScheduling) {</span>
<a href="#l1.199"></a><span id="l1.199" class="difflineminus">-                this.processItipReply(item, resourcePath);</span>
<a href="#l1.200"></a><span id="l1.200" class="difflineplus">+                this.processItipReply(item, path);</span>
<a href="#l1.201"></a><span id="l1.201">             }</span>
<a href="#l1.202"></a><span id="l1.202">             cal.WARN(&quot;REPLY method but calendar does not support scheduling&quot;);</span>
<a href="#l1.203"></a><span id="l1.203">             return;</span>
<a href="#l1.204"></a><span id="l1.204">         }</span>
<a href="#l1.205"></a><span id="l1.205"> </span>
<a href="#l1.206"></a><span id="l1.206">         // Strip of the same number of components as the request</span>
<a href="#l1.207"></a><span id="l1.207">         // uri's path has. This way we make sure to handle servers</span>
<a href="#l1.208"></a><span id="l1.208" class="difflineminus">-        // that pass hrefs like /dav/user/Calendar while</span>
<a href="#l1.209"></a><span id="l1.209" class="difflineplus">+        // that pass paths like /dav/user/Calendar while</span>
<a href="#l1.210"></a><span id="l1.210">         // the request uri is like /dav/user@example.org/Calendar.</span>
<a href="#l1.211"></a><span id="l1.211" class="difflineminus">-        let resPathComponents = resourcePath.split(&quot;/&quot;);</span>
<a href="#l1.212"></a><span id="l1.212" class="difflineplus">+        let resPathComponents = path.split(&quot;/&quot;);</span>
<a href="#l1.213"></a><span id="l1.213">         resPathComponents.splice(0, uriPathComponentLength - 1);</span>
<a href="#l1.214"></a><span id="l1.214" class="difflineminus">-        let locationPath = decodeURIComponent(resPathComponents.join(&quot;/&quot;));</span>
<a href="#l1.215"></a><span id="l1.215" class="difflineplus">+        let locationPath = resPathComponents.join(&quot;/&quot;);</span>
<a href="#l1.216"></a><span id="l1.216">         let isInboxItem = this.isInbox(aUri.spec);</span>
<a href="#l1.217"></a><span id="l1.217"> </span>
<a href="#l1.218"></a><span id="l1.218" class="difflineminus">-        let hrefPath = this.ensurePath(href);</span>
<a href="#l1.219"></a><span id="l1.219" class="difflineminus">-        if (this.mHrefIndex[hrefPath] &amp;&amp;</span>
<a href="#l1.220"></a><span id="l1.220" class="difflineplus">+        if (this.mPathIndex[path] &amp;&amp;</span>
<a href="#l1.221"></a><span id="l1.221">             !this.mItemInfoCache[item.id]) {</span>
<a href="#l1.222"></a><span id="l1.222">             // If we get here it means a meeting has kept the same filename</span>
<a href="#l1.223"></a><span id="l1.223">             // but changed its uid, which can happen server side.</span>
<a href="#l1.224"></a><span id="l1.224">             // Delete the meeting before re-adding it</span>
<a href="#l1.225"></a><span id="l1.225" class="difflineminus">-            this.deleteTargetCalendarItem(hrefPath);</span>
<a href="#l1.226"></a><span id="l1.226" class="difflineplus">+            this.deleteTargetCalendarItem(path);</span>
<a href="#l1.227"></a><span id="l1.227">         }</span>
<a href="#l1.228"></a><span id="l1.228"> </span>
<a href="#l1.229"></a><span id="l1.229">         if (this.mItemInfoCache[item.id]) {</span>
<a href="#l1.230"></a><span id="l1.230">             this.mItemInfoCache[item.id].isNew = false;</span>
<a href="#l1.231"></a><span id="l1.231">         } else {</span>
<a href="#l1.232"></a><span id="l1.232">             this.mItemInfoCache[item.id] = { isNew: true };</span>
<a href="#l1.233"></a><span id="l1.233">         }</span>
<a href="#l1.234"></a><span id="l1.234">         this.mItemInfoCache[item.id].locationPath = locationPath;</span>
<a href="#l1.235"></a><span id="l1.235">         this.mItemInfoCache[item.id].isInboxItem = isInboxItem;</span>
<a href="#l1.236"></a><span id="l1.236"> </span>
<a href="#l1.237"></a><span id="l1.237" class="difflineminus">-        this.mHrefIndex[hrefPath] = item.id;</span>
<a href="#l1.238"></a><span id="l1.238" class="difflineplus">+        this.mPathIndex[path] = item.id;</span>
<a href="#l1.239"></a><span id="l1.239">         this.mItemInfoCache[item.id].etag = etag;</span>
<a href="#l1.240"></a><span id="l1.240">         if (this.mItemInfoCache[item.id].isNew) {</span>
<a href="#l1.241"></a><span id="l1.241">             this.mTargetCalendar.adoptItem(item, aListener);</span>
<a href="#l1.242"></a><span id="l1.242">         } else {</span>
<a href="#l1.243"></a><span id="l1.243">             this.mTargetCalendar.modifyItem(item, null, aListener);</span>
<a href="#l1.244"></a><span id="l1.244">         }</span>
<a href="#l1.245"></a><span id="l1.245"> </span>
<a href="#l1.246"></a><span id="l1.246">         if (this.isCached) {</span>
<a href="#l1.247"></a><span id="l1.247" class="difflineminus">-            this.setMetaData(item.id, resourcePath, etag, isInboxItem);</span>
<a href="#l1.248"></a><span id="l1.248" class="difflineplus">+            this.setMetaData(item.id, path, etag, isInboxItem);</span>
<a href="#l1.249"></a><span id="l1.249">         }</span>
<a href="#l1.250"></a><span id="l1.250">     },</span>
<a href="#l1.251"></a><span id="l1.251"> </span>
<a href="#l1.252"></a><span id="l1.252">     /**</span>
<a href="#l1.253"></a><span id="l1.253">      * Deletes an item from the target calendar</span>
<a href="#l1.254"></a><span id="l1.254">      *</span>
<a href="#l1.255"></a><span id="l1.255" class="difflineminus">-     * @param path Path of the item to delete</span>
<a href="#l1.256"></a><span id="l1.256" class="difflineplus">+     * @param path Path of the item to delete, must not be encoded</span>
<a href="#l1.257"></a><span id="l1.257">      */</span>
<a href="#l1.258"></a><span id="l1.258">     deleteTargetCalendarItem: function caldav_deleteTargetCalendarItem(path) {</span>
<a href="#l1.259"></a><span id="l1.259">         let foundItem;</span>
<a href="#l1.260"></a><span id="l1.260">         let isDeleted = false;</span>
<a href="#l1.261"></a><span id="l1.261">         let getItemListener = {</span>
<a href="#l1.262"></a><span id="l1.262">             onGetResult: function deleteLocalItem_getItem_onResult(aCalendar,</span>
<a href="#l1.263"></a><span id="l1.263">                                                      aStatus,</span>
<a href="#l1.264"></a><span id="l1.264">                                                      aItemType,</span>
<a href="#l1.265"></a><span id="l1.265" class="difflineat">@@ -939,27 +953,27 @@ calDavCalendar.prototype = {</span>
<a href="#l1.266"></a><span id="l1.266">                                                      aCount,</span>
<a href="#l1.267"></a><span id="l1.267">                                                      aItems) {</span>
<a href="#l1.268"></a><span id="l1.268"> </span>
<a href="#l1.269"></a><span id="l1.269">                 foundItem = aItems[0];</span>
<a href="#l1.270"></a><span id="l1.270">             },</span>
<a href="#l1.271"></a><span id="l1.271">             onOperationComplete: function deleteLocalItem_getItem_onOperationComplete() {}</span>
<a href="#l1.272"></a><span id="l1.272">         };</span>
<a href="#l1.273"></a><span id="l1.273"> </span>
<a href="#l1.274"></a><span id="l1.274" class="difflineminus">-        this.mTargetCalendar.getItem(this.mHrefIndex[path],</span>
<a href="#l1.275"></a><span id="l1.275" class="difflineplus">+        this.mTargetCalendar.getItem(this.mPathIndex[path],</span>
<a href="#l1.276"></a><span id="l1.276">                                      getItemListener);</span>
<a href="#l1.277"></a><span id="l1.277">         // Since the target calendar's operations are synchronous, we can</span>
<a href="#l1.278"></a><span id="l1.278">         // safely set variables from this function.</span>
<a href="#l1.279"></a><span id="l1.279">         if (foundItem) {</span>
<a href="#l1.280"></a><span id="l1.280">             let wasInboxItem = this.mItemInfoCache[foundItem.id].isInboxItem;</span>
<a href="#l1.281"></a><span id="l1.281">             if ((wasInboxItem &amp;&amp; this.isInbox(path)) ||</span>
<a href="#l1.282"></a><span id="l1.282">                 (wasInboxItem === false &amp;&amp; !this.isInbox(path))) {</span>
<a href="#l1.283"></a><span id="l1.283"> </span>
<a href="#l1.284"></a><span id="l1.284">                 cal.LOG(&quot;CalDAV: deleting item: &quot; + path + &quot;, uid: &quot; + foundItem.id);</span>
<a href="#l1.285"></a><span id="l1.285" class="difflineminus">-                delete this.mHrefIndex[path];</span>
<a href="#l1.286"></a><span id="l1.286" class="difflineplus">+                delete this.mPathIndex[path];</span>
<a href="#l1.287"></a><span id="l1.287">                 delete this.mItemInfoCache[foundItem.id];</span>
<a href="#l1.288"></a><span id="l1.288">                 this.mTargetCalendar.deleteItem(foundItem,</span>
<a href="#l1.289"></a><span id="l1.289">                                                 getItemListener);</span>
<a href="#l1.290"></a><span id="l1.290">                 isDeleted = true;</span>
<a href="#l1.291"></a><span id="l1.291">             }</span>
<a href="#l1.292"></a><span id="l1.292">         }</span>
<a href="#l1.293"></a><span id="l1.293">         return isDeleted;</span>
<a href="#l1.294"></a><span id="l1.294">     },</span>
<a href="#l1.295"></a><span id="l1.295" class="difflineat">@@ -1050,17 +1064,17 @@ calDavCalendar.prototype = {</span>
<a href="#l1.296"></a><span id="l1.296">                                          null,</span>
<a href="#l1.297"></a><span id="l1.297">                                          &quot;passed in null item&quot;);</span>
<a href="#l1.298"></a><span id="l1.298">             return;</span>
<a href="#l1.299"></a><span id="l1.299">         }</span>
<a href="#l1.300"></a><span id="l1.300"> </span>
<a href="#l1.301"></a><span id="l1.301">         let locationPath = this.getItemLocationPath(aItem);</span>
<a href="#l1.302"></a><span id="l1.302">         let itemUri = this.makeUri(locationPath);</span>
<a href="#l1.303"></a><span id="l1.303"> </span>
<a href="#l1.304"></a><span id="l1.304" class="difflineminus">-        let multiget = new multigetSyncHandler([itemUri.path],</span>
<a href="#l1.305"></a><span id="l1.305" class="difflineplus">+        let multiget = new multigetSyncHandler([this.ensureDecodedPath(itemUri.path)],</span>
<a href="#l1.306"></a><span id="l1.306">                                                this,</span>
<a href="#l1.307"></a><span id="l1.307">                                                this.makeUri(),</span>
<a href="#l1.308"></a><span id="l1.308">                                                null,</span>
<a href="#l1.309"></a><span id="l1.309">                                                aListener,</span>
<a href="#l1.310"></a><span id="l1.310">                                                aChangeLogListener);</span>
<a href="#l1.311"></a><span id="l1.311">         multiget.doMultiGet();</span>
<a href="#l1.312"></a><span id="l1.312">     },</span>
<a href="#l1.313"></a><span id="l1.313"> </span>
<a href="#l1.314"></a><span id="l1.314" class="difflineat">@@ -1654,18 +1668,17 @@ calDavCalendar.prototype = {</span>
<a href="#l1.315"></a><span id="l1.315">             } else if (thisCalendar.verboseLogging()) {</span>
<a href="#l1.316"></a><span id="l1.316">                 cal.LOG(&quot;CalDAV: recv: &quot; + str);</span>
<a href="#l1.317"></a><span id="l1.317">             }</span>
<a href="#l1.318"></a><span id="l1.318"> </span>
<a href="#l1.319"></a><span id="l1.319">             let multistatus = cal.safeNewXML(str);</span>
<a href="#l1.320"></a><span id="l1.320">             var pcs = multistatus..D::[&quot;principal-collection-set&quot;]..D::href;</span>
<a href="#l1.321"></a><span id="l1.321">             var nsList = [];</span>
<a href="#l1.322"></a><span id="l1.322">             for (var ns in pcs) {</span>
<a href="#l1.323"></a><span id="l1.323" class="difflineminus">-                var nsString = pcs[ns].toString();</span>
<a href="#l1.324"></a><span id="l1.324" class="difflineminus">-                var nsPath = thisCalendar.ensurePath(nsString);</span>
<a href="#l1.325"></a><span id="l1.325" class="difflineplus">+                var nsPath = thisCalendar.ensureDecodedPath(pcs[ns].toString());</span>
<a href="#l1.326"></a><span id="l1.326">                 nsList.push(nsPath);</span>
<a href="#l1.327"></a><span id="l1.327">             }</span>
<a href="#l1.328"></a><span id="l1.328"> </span>
<a href="#l1.329"></a><span id="l1.329">             thisCalendar.checkPrincipalsNameSpace(nsList, aChangeLogListener);</span>
<a href="#l1.330"></a><span id="l1.330">         };</span>
<a href="#l1.331"></a><span id="l1.331"> </span>
<a href="#l1.332"></a><span id="l1.332">         cal.sendHttpRequest(cal.createStreamLoader(), httpchannel, streamListener);</span>
<a href="#l1.333"></a><span id="l1.333">     },</span>
<a href="#l1.334"></a><span id="l1.334" class="difflineat">@@ -1696,17 +1709,17 @@ calDavCalendar.prototype = {</span>
<a href="#l1.335"></a><span id="l1.335">                 cal.LOG(&quot;CalDAV: principal namespace list empty, calendar &quot; +</span>
<a href="#l1.336"></a><span id="l1.336">                         this.name + &quot; doesn't support scheduling&quot;);</span>
<a href="#l1.337"></a><span id="l1.337">             }</span>
<a href="#l1.338"></a><span id="l1.338">             doesntSupportScheduling();</span>
<a href="#l1.339"></a><span id="l1.339">             return;</span>
<a href="#l1.340"></a><span id="l1.340">         }</span>
<a href="#l1.341"></a><span id="l1.341"> </span>
<a href="#l1.342"></a><span id="l1.342">         // Remove trailing slash, if its there</span>
<a href="#l1.343"></a><span id="l1.343" class="difflineminus">-        var homePath = this.mCalHomeSet.path.replace(/\/$/,&quot;&quot;);</span>
<a href="#l1.344"></a><span id="l1.344" class="difflineplus">+        var homePath = this.ensureEncodedPath(this.mCalHomeSet.spec.replace(/\/$/,&quot;&quot;));</span>
<a href="#l1.345"></a><span id="l1.345"> </span>
<a href="#l1.346"></a><span id="l1.346">         var C = new Namespace(&quot;C&quot;, &quot;urn:ietf:params:xml:ns:caldav&quot;);</span>
<a href="#l1.347"></a><span id="l1.347">         var D = new Namespace(&quot;D&quot;, &quot;DAV:&quot;);</span>
<a href="#l1.348"></a><span id="l1.348">         default xml namespace = C;</span>
<a href="#l1.349"></a><span id="l1.349"> </span>
<a href="#l1.350"></a><span id="l1.350">         var queryXml;</span>
<a href="#l1.351"></a><span id="l1.351">         var queryMethod;</span>
<a href="#l1.352"></a><span id="l1.352">         var queryDepth;</span>
<a href="#l1.353"></a><span id="l1.353" class="difflineat">@@ -1738,27 +1751,18 @@ calDavCalendar.prototype = {</span>
<a href="#l1.354"></a><span id="l1.354">                     &lt;C:schedule-outbox-URL/&gt;</span>
<a href="#l1.355"></a><span id="l1.355">                 &lt;/D:prop&gt;</span>
<a href="#l1.356"></a><span id="l1.356">             &lt;/D:principal-property-search&gt;;</span>
<a href="#l1.357"></a><span id="l1.357">             queryMethod = &quot;REPORT&quot;;</span>
<a href="#l1.358"></a><span id="l1.358">             queryDepth = 1;</span>
<a href="#l1.359"></a><span id="l1.359">         }</span>
<a href="#l1.360"></a><span id="l1.360"> </span>
<a href="#l1.361"></a><span id="l1.361">         // We want a trailing slash, ensure it.</span>
<a href="#l1.362"></a><span id="l1.362" class="difflineminus">-        let nsUri = this.calendarUri.clone();</span>
<a href="#l1.363"></a><span id="l1.363">         let nextNS = aNameSpaceList.pop().replace(/([^\/])$/, &quot;$1/&quot;);</span>
<a href="#l1.364"></a><span id="l1.364" class="difflineminus">-        let requestUri;</span>
<a href="#l1.365"></a><span id="l1.365" class="difflineminus">-        // nextNS could be either a spec or a path</span>
<a href="#l1.366"></a><span id="l1.366" class="difflineminus">-        if (nextNS.charAt(0) == &quot;/&quot;) {</span>
<a href="#l1.367"></a><span id="l1.367" class="difflineminus">-            nsUri.path = nextNS;</span>
<a href="#l1.368"></a><span id="l1.368" class="difflineminus">-            requestUri = this.makeUri(null, nsUri);</span>
<a href="#l1.369"></a><span id="l1.369" class="difflineminus">-        } else {</span>
<a href="#l1.370"></a><span id="l1.370" class="difflineminus">-            requestUri = makeURL(nextNS);</span>
<a href="#l1.371"></a><span id="l1.371" class="difflineminus">-        }</span>
<a href="#l1.372"></a><span id="l1.372" class="difflineminus">-</span>
<a href="#l1.373"></a><span id="l1.373" class="difflineplus">+        let requestUri = makeURL(this.calendarUri.prePath + this.ensureEncodedPath(nextNS));</span>
<a href="#l1.374"></a><span id="l1.374"> </span>
<a href="#l1.375"></a><span id="l1.375">         if (this.verboseLogging()) {</span>
<a href="#l1.376"></a><span id="l1.376">             cal.LOG(&quot;CalDAV: send: &quot; + queryMethod + &quot; &quot; + requestUri.spec + &quot;\n&quot; + queryXml);</span>
<a href="#l1.377"></a><span id="l1.377">         }</span>
<a href="#l1.378"></a><span id="l1.378"> </span>
<a href="#l1.379"></a><span id="l1.379">         let httpchannel = cal.prepHttpChannel(requestUri,</span>
<a href="#l1.380"></a><span id="l1.380">                                               queryXml,</span>
<a href="#l1.381"></a><span id="l1.381">                                               &quot;text/xml; charset=utf-8&quot;,</span>
<a href="#l1.382"></a><span id="l1.382" class="difflineat">@@ -1812,20 +1816,20 @@ calDavCalendar.prototype = {</span>
<a href="#l1.383"></a><span id="l1.383">                 }</span>
<a href="#l1.384"></a><span id="l1.384">                 for each (let addrHref in response..*::[&quot;calendar-user-address-set&quot;]..*::href) {</span>
<a href="#l1.385"></a><span id="l1.385">                     if (addrHref.toString().substr(0, 7).toLowerCase() == &quot;mailto:&quot;) {</span>
<a href="#l1.386"></a><span id="l1.386">                         thisCalendar.mCalendarUserAddress = addrHref.toString();</span>
<a href="#l1.387"></a><span id="l1.387">                     }</span>
<a href="#l1.388"></a><span id="l1.388">                 }</span>
<a href="#l1.389"></a><span id="l1.389">                 let ibUrl = thisCalendar.mUri.clone();</span>
<a href="#l1.390"></a><span id="l1.390">                 try {</span>
<a href="#l1.391"></a><span id="l1.391" class="difflineminus">-                    ibUrl.path = thisCalendar.ensurePath(response..*::[&quot;schedule-inbox-URL&quot;]..*::href[0].toString());</span>
<a href="#l1.392"></a><span id="l1.392" class="difflineplus">+                    ibUrl.path = thisCalendar.ensureDecodedPath(response..*::[&quot;schedule-inbox-URL&quot;]..*::href[0].toString());</span>
<a href="#l1.393"></a><span id="l1.393">                 } catch (ex) {</span>
<a href="#l1.394"></a><span id="l1.394">                     // most likely this is a Kerio server that omits the &quot;href&quot;</span>
<a href="#l1.395"></a><span id="l1.395" class="difflineminus">-                    ibUrl.path = thisCalendar.ensurePath(response..*::[&quot;schedule-inbox-URL&quot;].toString());</span>
<a href="#l1.396"></a><span id="l1.396" class="difflineplus">+                    ibUrl.path = thisCalendar.ensureDecodedPath(response..*::[&quot;schedule-inbox-URL&quot;].toString());</span>
<a href="#l1.397"></a><span id="l1.397">                 }</span>
<a href="#l1.398"></a><span id="l1.398"> </span>
<a href="#l1.399"></a><span id="l1.399">                 // Make sure the inbox uri has a / at the end, as we do with the</span>
<a href="#l1.400"></a><span id="l1.400">                 // calendarUri.</span>
<a href="#l1.401"></a><span id="l1.401">                 if (ibUrl.path.charAt(ibUrl.path.length - 1) != '/') {</span>
<a href="#l1.402"></a><span id="l1.402">                     ibUrl.path += &quot;/&quot;;</span>
<a href="#l1.403"></a><span id="l1.403">                 }</span>
<a href="#l1.404"></a><span id="l1.404"> </span>
<a href="#l1.405"></a><span id="l1.405" class="difflineat">@@ -1833,20 +1837,20 @@ calDavCalendar.prototype = {</span>
<a href="#l1.406"></a><span id="l1.406">                 if (thisCalendar.calendarUri.spec == ibUrl.spec) {</span>
<a href="#l1.407"></a><span id="l1.407">                     // If the inbox matches the calendar uri (i.e SOGo), then we</span>
<a href="#l1.408"></a><span id="l1.408">                     // don't need to poll the inbox.</span>
<a href="#l1.409"></a><span id="l1.409">                     thisCalendar.mShouldPollInbox = false;</span>
<a href="#l1.410"></a><span id="l1.410">                 }</span>
<a href="#l1.411"></a><span id="l1.411"> </span>
<a href="#l1.412"></a><span id="l1.412">                 let obUrl = thisCalendar.mUri.clone();</span>
<a href="#l1.413"></a><span id="l1.413">                 try {</span>
<a href="#l1.414"></a><span id="l1.414" class="difflineminus">-                    obUrl.path = thisCalendar.ensurePath(response..*::[&quot;schedule-outbox-URL&quot;]..*::href[0].toString());</span>
<a href="#l1.415"></a><span id="l1.415" class="difflineplus">+                    obUrl.path = thisCalendar.ensureDecodedPath(response..*::[&quot;schedule-outbox-URL&quot;]..*::href[0].toString());</span>
<a href="#l1.416"></a><span id="l1.416">                 } catch (ex) {</span>
<a href="#l1.417"></a><span id="l1.417">                     // most likely this is a Kerio server that omits the &quot;href&quot;</span>
<a href="#l1.418"></a><span id="l1.418" class="difflineminus">-                    obUrl.path = thisCalendar.ensurePath(response..*::[&quot;schedule-outbox-URL&quot;].toString());</span>
<a href="#l1.419"></a><span id="l1.419" class="difflineplus">+                    obUrl.path = thisCalendar.ensureDecodedPath(response..*::[&quot;schedule-outbox-URL&quot;].toString());</span>
<a href="#l1.420"></a><span id="l1.420">                 }</span>
<a href="#l1.421"></a><span id="l1.421"> </span>
<a href="#l1.422"></a><span id="l1.422">                 // Make sure the outbox uri has a / at the end, as we do with</span>
<a href="#l1.423"></a><span id="l1.423">                 // the calendarUri.</span>
<a href="#l1.424"></a><span id="l1.424">                 if (obUrl.path.charAt(obUrl.path.length - 1) != '/') {</span>
<a href="#l1.425"></a><span id="l1.425">                     obUrl.path += &quot;/&quot;;</span>
<a href="#l1.426"></a><span id="l1.426">                 }</span>
<a href="#l1.427"></a><span id="l1.427"> </span>
<a href="#l1.428"></a><span id="l1.428" class="difflineat">@@ -2137,24 +2141,70 @@ calDavCalendar.prototype = {</span>
<a href="#l1.429"></a><span id="l1.429">                         &quot; from freebusy query for &quot; + thisCalendar.name);</span>
<a href="#l1.430"></a><span id="l1.430">                 aListener.onResult(null, null);</span>
<a href="#l1.431"></a><span id="l1.431">             }</span>
<a href="#l1.432"></a><span id="l1.432">         };</span>
<a href="#l1.433"></a><span id="l1.433"> </span>
<a href="#l1.434"></a><span id="l1.434">         cal.sendHttpRequest(cal.createStreamLoader(), httpchannel, streamListener);</span>
<a href="#l1.435"></a><span id="l1.435">     },</span>
<a href="#l1.436"></a><span id="l1.436"> </span>
<a href="#l1.437"></a><span id="l1.437" class="difflineminus">-    ensurePath: function caldav_ensurePath(aString) {</span>
<a href="#l1.438"></a><span id="l1.438" class="difflineplus">+    /**</span>
<a href="#l1.439"></a><span id="l1.439" class="difflineplus">+     * Extract the path from the full spec, if the regexp failed, log</span>
<a href="#l1.440"></a><span id="l1.440" class="difflineplus">+     * warning and return unaltered path.</span>
<a href="#l1.441"></a><span id="l1.441" class="difflineplus">+     */</span>
<a href="#l1.442"></a><span id="l1.442" class="difflineplus">+    extractPathFromSpec : function caldav_extractPathFromSpec(aSpec) {</span>
<a href="#l1.443"></a><span id="l1.443" class="difflineplus">+        // The parsed array should look like this:</span>
<a href="#l1.444"></a><span id="l1.444" class="difflineplus">+        // a[0] = full string</span>
<a href="#l1.445"></a><span id="l1.445" class="difflineplus">+        // a[1] = scheme</span>
<a href="#l1.446"></a><span id="l1.446" class="difflineplus">+        // a[2] = everything between the scheme and the start of the path</span>
<a href="#l1.447"></a><span id="l1.447" class="difflineplus">+        // a[3] = extracted path</span>
<a href="#l1.448"></a><span id="l1.448" class="difflineplus">+        let a = aSpec.match(&quot;(https?)(://[^/]*)([^#?]*)&quot;);</span>
<a href="#l1.449"></a><span id="l1.449" class="difflineplus">+        if (a[3]) {</span>
<a href="#l1.450"></a><span id="l1.450" class="difflineplus">+          return a[3];</span>
<a href="#l1.451"></a><span id="l1.451" class="difflineplus">+        }</span>
<a href="#l1.452"></a><span id="l1.452" class="difflineplus">+        cal.WARN(&quot;CalDAV: Spec could not be parsed, returning as-is: &quot;+ aSpec);</span>
<a href="#l1.453"></a><span id="l1.453" class="difflineplus">+        return aSpec;</span>
<a href="#l1.454"></a><span id="l1.454" class="difflineplus">+    },</span>
<a href="#l1.455"></a><span id="l1.455" class="difflineplus">+    /**</span>
<a href="#l1.456"></a><span id="l1.456" class="difflineplus">+     * This is called to create an encoded path from a unencoded path OR</span>
<a href="#l1.457"></a><span id="l1.457" class="difflineplus">+     * encoded full url</span>
<a href="#l1.458"></a><span id="l1.458" class="difflineplus">+     *</span>
<a href="#l1.459"></a><span id="l1.459" class="difflineplus">+     * @param aString {string} un-encoded path OR encoded uri spec.</span>
<a href="#l1.460"></a><span id="l1.460" class="difflineplus">+     */</span>
<a href="#l1.461"></a><span id="l1.461" class="difflineplus">+    ensureEncodedPath: function caldav_ensureEncodedPath(aString) {</span>
<a href="#l1.462"></a><span id="l1.462">         if (aString.charAt(0) != &quot;/&quot;) {</span>
<a href="#l1.463"></a><span id="l1.463" class="difflineminus">-            var bogusUri = makeURL(aString);</span>
<a href="#l1.464"></a><span id="l1.464" class="difflineminus">-            return bogusUri.path;</span>
<a href="#l1.465"></a><span id="l1.465" class="difflineplus">+            aString = this.ensureDecodedPath(aString);</span>
<a href="#l1.466"></a><span id="l1.466">         }</span>
<a href="#l1.467"></a><span id="l1.467" class="difflineminus">-        return aString;</span>
<a href="#l1.468"></a><span id="l1.468" class="difflineplus">+        var uriComponents = aString.split(&quot;/&quot;);</span>
<a href="#l1.469"></a><span id="l1.469" class="difflineplus">+        uriComponents = uriComponents.map(encodeURIComponent);</span>
<a href="#l1.470"></a><span id="l1.470" class="difflineplus">+        return uriComponents.join(&quot;/&quot;);</span>
<a href="#l1.471"></a><span id="l1.471">     },</span>
<a href="#l1.472"></a><span id="l1.472"> </span>
<a href="#l1.473"></a><span id="l1.473" class="difflineplus">+    /**</span>
<a href="#l1.474"></a><span id="l1.474" class="difflineplus">+     * This is called to get a decoded path from an encoded path or uri spec.</span>
<a href="#l1.475"></a><span id="l1.475" class="difflineplus">+     *</span>
<a href="#l1.476"></a><span id="l1.476" class="difflineplus">+     * @param aString {string} Represents either a path</span>
<a href="#l1.477"></a><span id="l1.477" class="difflineplus">+     * or a full uri that needs to be decoded.</span>
<a href="#l1.478"></a><span id="l1.478" class="difflineplus">+     */</span>
<a href="#l1.479"></a><span id="l1.479" class="difflineplus">+    ensureDecodedPath: function caldav_ensureDecodedPath(aString) {</span>
<a href="#l1.480"></a><span id="l1.480" class="difflineplus">+        if (aString.charAt(0) != &quot;/&quot;) {</span>
<a href="#l1.481"></a><span id="l1.481" class="difflineplus">+            aString = this.extractPathFromSpec(aString);</span>
<a href="#l1.482"></a><span id="l1.482" class="difflineplus">+        }</span>
<a href="#l1.483"></a><span id="l1.483" class="difflineplus">+</span>
<a href="#l1.484"></a><span id="l1.484" class="difflineplus">+        var uriComponents = aString.split(&quot;/&quot;);</span>
<a href="#l1.485"></a><span id="l1.485" class="difflineplus">+        for (var i = 0 ; i &lt; uriComponents.length ; i++ ) {</span>
<a href="#l1.486"></a><span id="l1.486" class="difflineplus">+            try {</span>
<a href="#l1.487"></a><span id="l1.487" class="difflineplus">+                uriComponents[i] = decodeURIComponent(uriComponents[i]);</span>
<a href="#l1.488"></a><span id="l1.488" class="difflineplus">+            }</span>
<a href="#l1.489"></a><span id="l1.489" class="difflineplus">+            catch (e) {</span>
<a href="#l1.490"></a><span id="l1.490" class="difflineplus">+                cal.WARN(&quot;CalDAV: Exception decoding path &quot; + aString + &quot;, segment: &quot; + uriComponents[i]);</span>
<a href="#l1.491"></a><span id="l1.491" class="difflineplus">+            }</span>
<a href="#l1.492"></a><span id="l1.492" class="difflineplus">+        }</span>
<a href="#l1.493"></a><span id="l1.493" class="difflineplus">+        return uriComponents.join(&quot;/&quot;);</span>
<a href="#l1.494"></a><span id="l1.494" class="difflineplus">+    },</span>
<a href="#l1.495"></a><span id="l1.495">     isInbox: function caldav_isInbox(aString) {</span>
<a href="#l1.496"></a><span id="l1.496">         return ((this.hasScheduling || this.hasAutoScheduling) &amp;&amp; this.mInboxUrl &amp;&amp;</span>
<a href="#l1.497"></a><span id="l1.497">                 aString.indexOf(this.mInboxUrl.spec) == 0);</span>
<a href="#l1.498"></a><span id="l1.498">     },</span>
<a href="#l1.499"></a><span id="l1.499"> </span>
<a href="#l1.500"></a><span id="l1.500">     /**</span>
<a href="#l1.501"></a><span id="l1.501">      * Query contents of scheduling inbox</span>
<a href="#l1.502"></a><span id="l1.502">      *</span>
<a href="#l1.503"></a><span id="l1.503" class="difflineat">@@ -2218,17 +2268,17 @@ calDavCalendar.prototype = {</span>
<a href="#l1.504"></a><span id="l1.504">                                                                    aItemId,</span>
<a href="#l1.505"></a><span id="l1.505">                                                                    aDetail) {</span>
<a href="#l1.506"></a><span id="l1.506">             cal.LOG(&quot;CalDAV: status &quot; + aStatus + &quot; while processing iTIP REPLY &quot; +</span>
<a href="#l1.507"></a><span id="l1.507">                     &quot; for &quot; + thisCalendar.name);</span>
<a href="#l1.508"></a><span id="l1.508">             // don't delete the REPLY item from inbox unless modifying the master</span>
<a href="#l1.509"></a><span id="l1.509">             // item was successful</span>
<a href="#l1.510"></a><span id="l1.510">             if (aStatus == 0) { // aStatus undocumented; 0 seems to indicate no error</span>
<a href="#l1.511"></a><span id="l1.511">                 var delUri = thisCalendar.calendarUri.clone();</span>
<a href="#l1.512"></a><span id="l1.512" class="difflineminus">-                delUri.path = aPath;</span>
<a href="#l1.513"></a><span id="l1.513" class="difflineplus">+                delUri.path = thisCalendar.ensureEncodedPath(aPath);</span>
<a href="#l1.514"></a><span id="l1.514">                 thisCalendar.doDeleteItem(aItem, null, true, true, delUri);</span>
<a href="#l1.515"></a><span id="l1.515">             }</span>
<a href="#l1.516"></a><span id="l1.516">         };</span>
<a href="#l1.517"></a><span id="l1.517"> </span>
<a href="#l1.518"></a><span id="l1.518">         this.mTargetCalendar.getItem(aItem.id, getItemListener);</span>
<a href="#l1.519"></a><span id="l1.519">     },</span>
<a href="#l1.520"></a><span id="l1.520"> </span>
<a href="#l1.521"></a><span id="l1.521">     canNotify: function caldav_canNotify(aMethod, aItem) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/calendar/providers/caldav/calDavRequestHandlers.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/calendar/providers/caldav/calDavRequestHandlers.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -130,17 +130,17 @@ etagsHandler.prototype = {</span>
<a href="#l2.4"></a><span id="l2.4"> </span>
<a href="#l2.5"></a><span id="l2.5">         // Now that we are done, check which items need fetching.</span>
<a href="#l2.6"></a><span id="l2.6">         if (this.calendar.isCached) {</span>
<a href="#l2.7"></a><span id="l2.7">             this.calendar.superCalendar.startBatch();</span>
<a href="#l2.8"></a><span id="l2.8">         }</span>
<a href="#l2.9"></a><span id="l2.9"> </span>
<a href="#l2.10"></a><span id="l2.10">         let needsRefresh = false;</span>
<a href="#l2.11"></a><span id="l2.11">         try {</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-            for (let path in this.calendar.mHrefIndex) {</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+            for (let path in this.calendar.mPathIndex) {</span>
<a href="#l2.14"></a><span id="l2.14">                 if (path in this.itemsReported ||</span>
<a href="#l2.15"></a><span id="l2.15">                     path.substr(0, this.baseUri.length) == this.baseUri) {</span>
<a href="#l2.16"></a><span id="l2.16">                     // If the item is also on the server, check the next.</span>
<a href="#l2.17"></a><span id="l2.17">                     continue;</span>
<a href="#l2.18"></a><span id="l2.18">                 }</span>
<a href="#l2.19"></a><span id="l2.19">                 // If an item has been deleted from the server, delete it here too.</span>
<a href="#l2.20"></a><span id="l2.20">                 // Since the target calendar's operations are synchronous, we can</span>
<a href="#l2.21"></a><span id="l2.21">                 // safely set variables from this function.</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineat">@@ -152,24 +152,24 @@ etagsHandler.prototype = {</span>
<a href="#l2.23"></a><span id="l2.23">                                                                  aDetail,</span>
<a href="#l2.24"></a><span id="l2.24">                                                                  aCount,</span>
<a href="#l2.25"></a><span id="l2.25">                                                                  aItems) {</span>
<a href="#l2.26"></a><span id="l2.26">                         foundItem = aItems[0];</span>
<a href="#l2.27"></a><span id="l2.27">                     },</span>
<a href="#l2.28"></a><span id="l2.28">                     onOperationComplete: function etags_getItem_onOperationComplete() {}</span>
<a href="#l2.29"></a><span id="l2.29">                 };</span>
<a href="#l2.30"></a><span id="l2.30"> </span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-                this.calendar.mTargetCalendar.getItem(this.calendar.mHrefIndex[path],</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+                this.calendar.mTargetCalendar.getItem(this.calendar.mPathIndex[path],</span>
<a href="#l2.33"></a><span id="l2.33">                                                       getItemListener);</span>
<a href="#l2.34"></a><span id="l2.34">                 if (foundItem) {</span>
<a href="#l2.35"></a><span id="l2.35">                     let wasInboxItem = this.calendar.mItemInfoCache[foundItem.id].isInboxItem;</span>
<a href="#l2.36"></a><span id="l2.36">                     if ((wasInboxItem &amp;&amp; this.calendar.isInbox(this.baseUri.spec)) ||</span>
<a href="#l2.37"></a><span id="l2.37">                         (wasInboxItem === false &amp;&amp; !this.calendar.isInbox(this.baseUri.spec))) {</span>
<a href="#l2.38"></a><span id="l2.38">                         cal.LOG(&quot;Deleting local href: &quot; + path)</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineminus">-                        delete this.calendar.mHrefIndex[path];</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+                        delete this.calendar.mPathIndex[path];</span>
<a href="#l2.41"></a><span id="l2.41">                         this.calendar.mTargetCalendar.deleteItem(foundItem, null);</span>
<a href="#l2.42"></a><span id="l2.42">                         needsRefresh = true;</span>
<a href="#l2.43"></a><span id="l2.43">                     }</span>
<a href="#l2.44"></a><span id="l2.44">                 }</span>
<a href="#l2.45"></a><span id="l2.45">             }</span>
<a href="#l2.46"></a><span id="l2.46">         } finally {</span>
<a href="#l2.47"></a><span id="l2.47">             if (this.calendar.isCached) {</span>
<a href="#l2.48"></a><span id="l2.48">                 this.calendar.superCalendar.endBatch();</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineat">@@ -264,42 +264,38 @@ etagsHandler.prototype = {</span>
<a href="#l2.50"></a><span id="l2.50">         switch (aLocalName) {</span>
<a href="#l2.51"></a><span id="l2.51">             case &quot;response&quot;:</span>
<a href="#l2.52"></a><span id="l2.52">                 this.tag = null;</span>
<a href="#l2.53"></a><span id="l2.53">                 let r = this.currentResponse;</span>
<a href="#l2.54"></a><span id="l2.54">                 if (r.getetag &amp;&amp; r.getetag.length &amp;&amp;</span>
<a href="#l2.55"></a><span id="l2.55">                     r.href &amp;&amp; r.href.length &amp;&amp;</span>
<a href="#l2.56"></a><span id="l2.56">                     r.getcontenttype &amp;&amp; r.getcontenttype.length &amp;&amp;</span>
<a href="#l2.57"></a><span id="l2.57">                     !r.isCollection) {</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineminus">-                    let href;</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineplus">+</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineplus">+                    r.href = this.calendar.ensureDecodedPath(r.href);</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineplus">+</span>
<a href="#l2.62"></a><span id="l2.62">                     if (r.getcontenttype.substr(0, 14) == &quot;message/rfc822&quot;) {</span>
<a href="#l2.63"></a><span id="l2.63">                         // workaround for a Scalix bug which causes incorrect</span>
<a href="#l2.64"></a><span id="l2.64">                         // contenttype to be returned.</span>
<a href="#l2.65"></a><span id="l2.65">                         r.getcontenttype = &quot;text/calendar&quot;;</span>
<a href="#l2.66"></a><span id="l2.66">                     }</span>
<a href="#l2.67"></a><span id="l2.67">                     if (r.getcontenttype == &quot;text/vtodo&quot;) {</span>
<a href="#l2.68"></a><span id="l2.68">                         // workaround Kerio wierdness</span>
<a href="#l2.69"></a><span id="l2.69">                         r.getcontenttype = &quot;text/calendar&quot;;</span>
<a href="#l2.70"></a><span id="l2.70">                     }</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineplus">+</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineplus">+                    // Only handle calendar items</span>
<a href="#l2.73"></a><span id="l2.73">                     if (r.getcontenttype.substr(0,13) == &quot;text/calendar&quot;) {</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineminus">-                        // Only handle calendar items</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineminus">-                        if (this.skipIndex &lt; 0) {</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineminus">-                            href = this.calendar.ensurePath(r.href);</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineminus">-                            this.skipIndex = r.href.indexOf(href);</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineminus">-                        } else {</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineminus">-                            href = r.href.substr(this.skipIndex);</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineminus">-                        }</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineminus">-                        href = decodeURIComponent(href);</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineminus">-                        if (href &amp;&amp; href.length) {</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineminus">-                            this.itemsReported[href] = r.getetag;</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineplus">+                        if (r.href &amp;&amp; r.href.length) {</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineplus">+                            this.itemsReported[r.href] = r.getetag;</span>
<a href="#l2.86"></a><span id="l2.86"> </span>
<a href="#l2.87"></a><span id="l2.87" class="difflineminus">-                            let itemUid = this.calendar.mHrefIndex[href];</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineplus">+                            let itemUid = this.calendar.mPathIndex[r.href];</span>
<a href="#l2.89"></a><span id="l2.89">                             if (!itemUid ||</span>
<a href="#l2.90"></a><span id="l2.90">                                 r.getetag != this.calendar.mItemInfoCache[itemUid].etag) {</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineminus">-                                this.itemsNeedFetching.push(href);</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineplus">+                                this.itemsNeedFetching.push(r.href);</span>
<a href="#l2.93"></a><span id="l2.93">                             }</span>
<a href="#l2.94"></a><span id="l2.94">                         }</span>
<a href="#l2.95"></a><span id="l2.95">                     }</span>
<a href="#l2.96"></a><span id="l2.96">                 }</span>
<a href="#l2.97"></a><span id="l2.97">                 break;</span>
<a href="#l2.98"></a><span id="l2.98">             case &quot;href&quot;:</span>
<a href="#l2.99"></a><span id="l2.99">             case &quot;getetag&quot;:</span>
<a href="#l2.100"></a><span id="l2.100">             case &quot;getcontenttype&quot;:</span>
<a href="#l2.101"></a><span id="l2.101" class="difflineat">@@ -515,17 +511,17 @@ webDavSyncHandler.prototype = {</span>
<a href="#l2.102"></a><span id="l2.102">             }</span>
<a href="#l2.103"></a><span id="l2.103">             return;</span>
<a href="#l2.104"></a><span id="l2.104">         }</span>
<a href="#l2.105"></a><span id="l2.105"> </span>
<a href="#l2.106"></a><span id="l2.106">         if (this.calendar.mWebdavSyncToken == null) {</span>
<a href="#l2.107"></a><span id="l2.107">             // null token means reset or first refresh indicating we did</span>
<a href="#l2.108"></a><span id="l2.108">             // a full sync; remove local items that were not returned in this full</span>
<a href="#l2.109"></a><span id="l2.109">             // sync</span>
<a href="#l2.110"></a><span id="l2.110" class="difflineminus">-            for (let path in this.calendar.mHrefIndex) {</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineplus">+            for (let path in this.calendar.mPathIndex) {</span>
<a href="#l2.112"></a><span id="l2.112">                 if (!this.itemsReported[path] &amp;&amp;</span>
<a href="#l2.113"></a><span id="l2.113">                     path.substr(0, this.baseUri.path.length) == this.baseUri.path) {</span>
<a href="#l2.114"></a><span id="l2.114">                     this.calendar.deleteTargetCalendarItem(path);</span>
<a href="#l2.115"></a><span id="l2.115">                 }</span>
<a href="#l2.116"></a><span id="l2.116">             }</span>
<a href="#l2.117"></a><span id="l2.117">         }</span>
<a href="#l2.118"></a><span id="l2.118">         if (this.calendar.isCached) {</span>
<a href="#l2.119"></a><span id="l2.119">             this.calendar.superCalendar.endBatch();</span>
<a href="#l2.120"></a><span id="l2.120" class="difflineat">@@ -589,41 +585,41 @@ webDavSyncHandler.prototype = {</span>
<a href="#l2.121"></a><span id="l2.121">     endElement: function wH_endElement(aUri, aLocalName, aQName) {</span>
<a href="#l2.122"></a><span id="l2.122">         switch (aLocalName) {</span>
<a href="#l2.123"></a><span id="l2.123">             case &quot;response&quot;: // WebDAV Sync draft 3</span>
<a href="#l2.124"></a><span id="l2.124">             case &quot;sync-response&quot;: // WebDAV Sync draft 0,1,2</span>
<a href="#l2.125"></a><span id="l2.125">                 cal.processPendingEvent();</span>
<a href="#l2.126"></a><span id="l2.126">                 let r = this.currentResponse;</span>
<a href="#l2.127"></a><span id="l2.127">                 if (r.href &amp;&amp;</span>
<a href="#l2.128"></a><span id="l2.128">                     r.href.length) {</span>
<a href="#l2.129"></a><span id="l2.129" class="difflineminus">-                    r.href = decodeURIComponent(r.href);</span>
<a href="#l2.130"></a><span id="l2.130" class="difflineplus">+                    r.href = this.calendar.ensureDecodedPath(r.href);</span>
<a href="#l2.131"></a><span id="l2.131">                 }</span>
<a href="#l2.132"></a><span id="l2.132">                 // Deleted item</span>
<a href="#l2.133"></a><span id="l2.133">                 if (r.href &amp;&amp; r.href.length &amp;&amp;</span>
<a href="#l2.134"></a><span id="l2.134">                     r.status &amp;&amp;</span>
<a href="#l2.135"></a><span id="l2.135">                     r.status.length &amp;&amp;</span>
<a href="#l2.136"></a><span id="l2.136">                     r.status.indexOf(&quot; 404&quot;) &gt; 0) {</span>
<a href="#l2.137"></a><span id="l2.137" class="difflineminus">-                    if (this.calendar.mHrefIndex[r.href]) {</span>
<a href="#l2.138"></a><span id="l2.138" class="difflineplus">+                    if (this.calendar.mPathIndex[r.href]) {</span>
<a href="#l2.139"></a><span id="l2.139">                         this.changeCount++;</span>
<a href="#l2.140"></a><span id="l2.140">                         this.calendar.deleteTargetCalendarItem(r.href);</span>
<a href="#l2.141"></a><span id="l2.141">                     }</span>
<a href="#l2.142"></a><span id="l2.142">                     else {</span>
<a href="#l2.143"></a><span id="l2.143">                         cal.LOG(&quot;CalDAV: skipping unfound deleted item : &quot; + r.href);</span>
<a href="#l2.144"></a><span id="l2.144">                     }</span>
<a href="#l2.145"></a><span id="l2.145">                 // Only handle Created or Updated calendar items</span>
<a href="#l2.146"></a><span id="l2.146">                 } else if (r.getcontenttype &amp;&amp;</span>
<a href="#l2.147"></a><span id="l2.147">                            r.getcontenttype.substr(0,13) == &quot;text/calendar&quot; &amp;&amp;</span>
<a href="#l2.148"></a><span id="l2.148">                            r.getetag &amp;&amp; r.getetag.length &amp;&amp;</span>
<a href="#l2.149"></a><span id="l2.149">                            r.href &amp;&amp; r.href.length &amp;&amp;</span>
<a href="#l2.150"></a><span id="l2.150">                            (!r.status ||                 // Draft 3 does not require</span>
<a href="#l2.151"></a><span id="l2.151">                             r.status.length == 0 ||      // a status for created or updated items but</span>
<a href="#l2.152"></a><span id="l2.152">                             r.status.indexOf(&quot; 204&quot;) ||  // draft 0, 1 and 2 needed it so treat no status</span>
<a href="#l2.153"></a><span id="l2.153">                             r.status.indexOf(&quot; 201&quot;))) { // and status 201 and 204 the same</span>
<a href="#l2.154"></a><span id="l2.154">                     this.itemsReported[r.href] = r.getetag;</span>
<a href="#l2.155"></a><span id="l2.155" class="difflineminus">-                    let itemId = this.calendar.mHrefIndex[r.href];</span>
<a href="#l2.156"></a><span id="l2.156" class="difflineplus">+                    let itemId = this.calendar.mPathIndex[r.href];</span>
<a href="#l2.157"></a><span id="l2.157">                     let oldEtag = (itemId &amp;&amp; this.calendar.mItemInfoCache[itemId].etag);</span>
<a href="#l2.158"></a><span id="l2.158"> </span>
<a href="#l2.159"></a><span id="l2.159">                     if (!oldEtag || oldEtag != r.getetag) {</span>
<a href="#l2.160"></a><span id="l2.160">                         // Etag mismatch, getting new/updated item.</span>
<a href="#l2.161"></a><span id="l2.161">                         if (r.calendardata &amp;&amp; r.calendardata.length) {</span>
<a href="#l2.162"></a><span id="l2.162">                             this.changeCount++;</span>
<a href="#l2.163"></a><span id="l2.163">                             this.calendar.addTargetCalendarItem(r.href,</span>
<a href="#l2.164"></a><span id="l2.164">                                                                 r.calendardata,</span>
<a href="#l2.165"></a><span id="l2.165" class="difflineat">@@ -672,17 +668,18 @@ webDavSyncHandler.prototype = {</span>
<a href="#l2.166"></a><span id="l2.166">     processingInstruction: function wH_processingInstruction(aTarget, aData) { }</span>
<a href="#l2.167"></a><span id="l2.167"> };</span>
<a href="#l2.168"></a><span id="l2.168"> </span>
<a href="#l2.169"></a><span id="l2.169"> /**</span>
<a href="#l2.170"></a><span id="l2.170">  * This is a handler for the multiget request.</span>
<a href="#l2.171"></a><span id="l2.171">  * It uses the SAX parser to incrementally parse the items and compose the</span>
<a href="#l2.172"></a><span id="l2.172">  * resulting multiget.</span>
<a href="#l2.173"></a><span id="l2.173">  *</span>
<a href="#l2.174"></a><span id="l2.174" class="difflineminus">- * @param aItemsNeedFetching    The array of items to fetch</span>
<a href="#l2.175"></a><span id="l2.175" class="difflineplus">+ * @param aItemsNeedFetching    The array of items to fetch, this must be an</span>
<a href="#l2.176"></a><span id="l2.176" class="difflineplus">+ *                              array of un-encoded paths.</span>
<a href="#l2.177"></a><span id="l2.177">  * @param aCalendar             The (unwrapped) calendar this request belongs to</span>
<a href="#l2.178"></a><span id="l2.178">  * @param aBaseUri              The URI requested (i.e inbox or collection)</span>
<a href="#l2.179"></a><span id="l2.179">  * @param aNewSyncToken         (optional) new Sync token to set if operation successful</span>
<a href="#l2.180"></a><span id="l2.180">  * @param aListener             (optional) The listener to notify</span>
<a href="#l2.181"></a><span id="l2.181">  * @param aChangeLogListener    (optional) for cached calendars, the listener to</span>
<a href="#l2.182"></a><span id="l2.182">  *                                notify.</span>
<a href="#l2.183"></a><span id="l2.183">  */</span>
<a href="#l2.184"></a><span id="l2.184"> function multigetSyncHandler(aItemsNeedFetching, aCalendar, aBaseUri, aNewSyncToken, aListener, aChangeLogListener) {</span>
<a href="#l2.185"></a><span id="l2.185" class="difflineat">@@ -734,17 +731,19 @@ multigetSyncHandler.prototype = {</span>
<a href="#l2.186"></a><span id="l2.186">               &lt;D:getetag/&gt;</span>
<a href="#l2.187"></a><span id="l2.187">               &lt;calendar-data/&gt;</span>
<a href="#l2.188"></a><span id="l2.188">             &lt;/D:prop&gt;</span>
<a href="#l2.189"></a><span id="l2.189">           &lt;/calendar-multiget&gt;;</span>
<a href="#l2.190"></a><span id="l2.190"> </span>
<a href="#l2.191"></a><span id="l2.191">         let batchSize = cal.getPrefSafe(&quot;calendar.caldav.multigetBatchSize&quot;, 100);</span>
<a href="#l2.192"></a><span id="l2.192">         while (this.itemsNeedFetching.length &amp;&amp; batchSize &gt; 0) {</span>
<a href="#l2.193"></a><span id="l2.193">             batchSize --;</span>
<a href="#l2.194"></a><span id="l2.194" class="difflineminus">-            let locpath = this.itemsNeedFetching.pop();</span>
<a href="#l2.195"></a><span id="l2.195" class="difflineplus">+            // ensureEncodedPath extracts only the path component of the item and</span>
<a href="#l2.196"></a><span id="l2.196" class="difflineplus">+            // encodes it before it is sent to the server</span>
<a href="#l2.197"></a><span id="l2.197" class="difflineplus">+            let locpath = this.calendar.ensureEncodedPath(this.itemsNeedFetching.pop());</span>
<a href="#l2.198"></a><span id="l2.198">             queryXml.D::prop += &lt;D:href xmlns:D={D}&gt;{locpath}&lt;/D:href&gt;;</span>
<a href="#l2.199"></a><span id="l2.199">         }</span>
<a href="#l2.200"></a><span id="l2.200"> </span>
<a href="#l2.201"></a><span id="l2.201">         let multigetQueryString = xmlHeader + queryXml.toXMLString();</span>
<a href="#l2.202"></a><span id="l2.202"> </span>
<a href="#l2.203"></a><span id="l2.203">         let requestUri = this.calendar.makeUri(null, this.baseUri);</span>
<a href="#l2.204"></a><span id="l2.204">         if (this.calendar.verboseLogging()) {</span>
<a href="#l2.205"></a><span id="l2.205">             cal.LOG(&quot;CalDAV: send(&quot; + requestUri.spec + &quot;): &quot; + queryXml);</span>
<a href="#l2.206"></a><span id="l2.206" class="difflineat">@@ -911,50 +910,50 @@ multigetSyncHandler.prototype = {</span>
<a href="#l2.207"></a><span id="l2.207"> </span>
<a href="#l2.208"></a><span id="l2.208">     endElement: function mg_endElement(aUri, aLocalName, aQName) {</span>
<a href="#l2.209"></a><span id="l2.209">         switch (aLocalName) {</span>
<a href="#l2.210"></a><span id="l2.210">             case &quot;response&quot;:</span>
<a href="#l2.211"></a><span id="l2.211">                 cal.processPendingEvent();</span>
<a href="#l2.212"></a><span id="l2.212">                 let r = this.currentResponse;</span>
<a href="#l2.213"></a><span id="l2.213">                 if (r.href &amp;&amp;</span>
<a href="#l2.214"></a><span id="l2.214">                     r.href.length) {</span>
<a href="#l2.215"></a><span id="l2.215" class="difflineminus">-                    r.href = decodeURIComponent(r.href);</span>
<a href="#l2.216"></a><span id="l2.216" class="difflineplus">+                    r.href = this.calendar.ensureDecodedPath(r.href);</span>
<a href="#l2.217"></a><span id="l2.217">                 }</span>
<a href="#l2.218"></a><span id="l2.218">                 if (r.href &amp;&amp; r.href.length &amp;&amp;</span>
<a href="#l2.219"></a><span id="l2.219">                     r.status &amp;&amp;</span>
<a href="#l2.220"></a><span id="l2.220">                     r.status.length &amp;&amp;</span>
<a href="#l2.221"></a><span id="l2.221">                     r.status.indexOf(&quot; 404&quot;) &gt; 0) {</span>
<a href="#l2.222"></a><span id="l2.222" class="difflineminus">-                    if (this.calendar.mHrefIndex[r.href]) {</span>
<a href="#l2.223"></a><span id="l2.223" class="difflineplus">+                    if (this.calendar.mPathIndex[r.href]) {</span>
<a href="#l2.224"></a><span id="l2.224">                         this.changeCount++;</span>
<a href="#l2.225"></a><span id="l2.225">                         this.calendar.deleteTargetCalendarItem(r.href);</span>
<a href="#l2.226"></a><span id="l2.226">                     } else {</span>
<a href="#l2.227"></a><span id="l2.227">                         cal.LOG(&quot;CalDAV: skipping unfound deleted item : &quot; + r.href);</span>
<a href="#l2.228"></a><span id="l2.228">                     }</span>
<a href="#l2.229"></a><span id="l2.229">                 // Created or Updated item</span>
<a href="#l2.230"></a><span id="l2.230">                 } else if (r.getetag &amp;&amp; r.getetag.length &amp;&amp;</span>
<a href="#l2.231"></a><span id="l2.231">                            r.href &amp;&amp; r.href.length &amp;&amp;</span>
<a href="#l2.232"></a><span id="l2.232">                            r.calendardata &amp;&amp; r.calendardata.length) {</span>
<a href="#l2.233"></a><span id="l2.233">                     let oldEtag;</span>
<a href="#l2.234"></a><span id="l2.234" class="difflineminus">-                    let itemId = this.calendar.mHrefIndex[r.href];</span>
<a href="#l2.235"></a><span id="l2.235" class="difflineplus">+                    let itemId = this.calendar.mPathIndex[r.href];</span>
<a href="#l2.236"></a><span id="l2.236">                     if (itemId) {</span>
<a href="#l2.237"></a><span id="l2.237">                         oldEtag = this.calendar.mItemInfoCache[itemId].etag;</span>
<a href="#l2.238"></a><span id="l2.238">                     } else {</span>
<a href="#l2.239"></a><span id="l2.239">                         oldEtag = null;</span>
<a href="#l2.240"></a><span id="l2.240">                     }</span>
<a href="#l2.241"></a><span id="l2.241">                     if (!oldEtag || oldEtag != r.getetag) {</span>
<a href="#l2.242"></a><span id="l2.242">                         this.changeCount++;</span>
<a href="#l2.243"></a><span id="l2.243">                         this.calendar.addTargetCalendarItem(r.href,</span>
<a href="#l2.244"></a><span id="l2.244">                                                             r.calendardata,</span>
<a href="#l2.245"></a><span id="l2.245">                                                             this.baseUri,</span>
<a href="#l2.246"></a><span id="l2.246">                                                             r.getetag,</span>
<a href="#l2.247"></a><span id="l2.247">                                                             this.listener);</span>
<a href="#l2.248"></a><span id="l2.248">                     }</span>
<a href="#l2.249"></a><span id="l2.249">                 } else {</span>
<a href="#l2.250"></a><span id="l2.250">                     cal.WARN(&quot;CalDAV: Unexpected response, status: &quot; +</span>
<a href="#l2.251"></a><span id="l2.251" class="difflineminus">-                             r.status + &quot;, href: &quot; + r.href + &quot; calendar-data:&quot;);</span>
<a href="#l2.252"></a><span id="l2.252" class="difflineplus">+                             r.status + &quot;, href: &quot; + r.href + &quot; calendar-data:\n&quot; + r.calendardata);</span>
<a href="#l2.253"></a><span id="l2.253">                     this.unhandledErrors++;</span>
<a href="#l2.254"></a><span id="l2.254">                 }</span>
<a href="#l2.255"></a><span id="l2.255">                 break;</span>
<a href="#l2.256"></a><span id="l2.256">             case &quot;propstat&quot;:</span>
<a href="#l2.257"></a><span id="l2.257">                 this.isInPropStat=false;</span>
<a href="#l2.258"></a><span id="l2.258">                 break;</span>
<a href="#l2.259"></a><span id="l2.259">         }</span>
<a href="#l2.260"></a><span id="l2.260">         this.tag = null;</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

