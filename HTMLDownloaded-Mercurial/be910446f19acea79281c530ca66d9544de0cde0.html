<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 18898:be910446f19acea79281c530ca66d9544de0cde0</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ be910446f19acea79281c530ca66d9544de0cde0" />
<meta property="og:url" content="/comm-central/rev/be910446f19acea79281c530ca66d9544de0cde0" />
<meta property="og:description" content="Bug 1221637 - Remove for-each from chat/. r=clokep" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / be910446f19acea79281c530ca66d9544de0cde0 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/be910446f19acea79281c530ca66d9544de0cde0">shortlog</a> |
<a href="/comm-central/log/be910446f19acea79281c530ca66d9544de0cde0">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/be910446f19acea79281c530ca66d9544de0cde0">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/be910446f19acea79281c530ca66d9544de0cde0">files</a> |
changeset |
<a href="/comm-central/raw-rev/be910446f19acea79281c530ca66d9544de0cde0">raw</a>  | <a href="/comm-central/archive/be910446f19acea79281c530ca66d9544de0cde0.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1221637">Bug 1221637</a> - Remove for-each from chat/. r=clokep
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#84;&#111;&#111;&#114;&#117;&#32;&#70;&#117;&#106;&#105;&#115;&#97;&#119;&#97;&#32;&#60;&#97;&#114;&#97;&#105;&#95;&#97;&#64;&#109;&#97;&#99;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Sat, 23 Jan 2016 15:53:04 +0900</td></tr>

<tr>
 <td>changeset 18898</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/be910446f19acea79281c530ca66d9544de0cde0">be910446f19acea79281c530ca66d9544de0cde0</a></td>
</tr>



<tr>
<td>parent 18897</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/23e6e5079983da795356282446e47c956361530e">23e6e5079983da795356282446e47c956361530e</a>
</td>
</tr>

<tr>
<td>child 18899</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/1670cf3ca8999b6b3a204c2f805bdab6b7d7d261">1670cf3ca8999b6b3a204c2f805bdab6b7d7d261</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=be910446f19acea79281c530ca66d9544de0cde0">11584</a></td></tr>
<tr><td>push user</td><td>arai_a@mac.com</td></tr>
<tr><td>push date</td><td class="date age">Sun, 24 Jan 2016 08:54:37 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@be910446f19a [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=be910446f19acea79281c530ca66d9544de0cde0">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=be910446f19acea79281c530ca66d9544de0cde0&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=be910446f19acea79281c530ca66d9544de0cde0&newProject=comm-central&newRevision=be910446f19acea79281c530ca66d9544de0cde0&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=be910446f19acea79281c530ca66d9544de0cde0&newProject=comm-central&newRevision=be910446f19acea79281c530ca66d9544de0cde0&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=be910446f19acea79281c530ca66d9544de0cde0&newProject=comm-central&newRevision=be910446f19acea79281c530ca66d9544de0cde0&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28clokep%29&revcount=50">clokep</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1221637">1221637</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1221637">Bug 1221637</a> - Remove for-each from chat/. r=clokep</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/be910446f19acea79281c530ca66d9544de0cde0/chat/components/src/imAccounts.js">chat/components/src/imAccounts.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/be910446f19acea79281c530ca66d9544de0cde0/chat/components/src/imAccounts.js">file</a> |
<a href="/comm-central/annotate/be910446f19acea79281c530ca66d9544de0cde0/chat/components/src/imAccounts.js">annotate</a> |
<a href="/comm-central/diff/be910446f19acea79281c530ca66d9544de0cde0/chat/components/src/imAccounts.js">diff</a> |
<a href="/comm-central/comparison/be910446f19acea79281c530ca66d9544de0cde0/chat/components/src/imAccounts.js">comparison</a> |
<a href="/comm-central/log/be910446f19acea79281c530ca66d9544de0cde0/chat/components/src/imAccounts.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/be910446f19acea79281c530ca66d9544de0cde0/chat/components/src/imContacts.js">chat/components/src/imContacts.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/be910446f19acea79281c530ca66d9544de0cde0/chat/components/src/imContacts.js">file</a> |
<a href="/comm-central/annotate/be910446f19acea79281c530ca66d9544de0cde0/chat/components/src/imContacts.js">annotate</a> |
<a href="/comm-central/diff/be910446f19acea79281c530ca66d9544de0cde0/chat/components/src/imContacts.js">diff</a> |
<a href="/comm-central/comparison/be910446f19acea79281c530ca66d9544de0cde0/chat/components/src/imContacts.js">comparison</a> |
<a href="/comm-central/log/be910446f19acea79281c530ca66d9544de0cde0/chat/components/src/imContacts.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/be910446f19acea79281c530ca66d9544de0cde0/chat/components/src/imConversations.js">chat/components/src/imConversations.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/be910446f19acea79281c530ca66d9544de0cde0/chat/components/src/imConversations.js">file</a> |
<a href="/comm-central/annotate/be910446f19acea79281c530ca66d9544de0cde0/chat/components/src/imConversations.js">annotate</a> |
<a href="/comm-central/diff/be910446f19acea79281c530ca66d9544de0cde0/chat/components/src/imConversations.js">diff</a> |
<a href="/comm-central/comparison/be910446f19acea79281c530ca66d9544de0cde0/chat/components/src/imConversations.js">comparison</a> |
<a href="/comm-central/log/be910446f19acea79281c530ca66d9544de0cde0/chat/components/src/imConversations.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/be910446f19acea79281c530ca66d9544de0cde0/chat/components/src/imCore.js">chat/components/src/imCore.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/be910446f19acea79281c530ca66d9544de0cde0/chat/components/src/imCore.js">file</a> |
<a href="/comm-central/annotate/be910446f19acea79281c530ca66d9544de0cde0/chat/components/src/imCore.js">annotate</a> |
<a href="/comm-central/diff/be910446f19acea79281c530ca66d9544de0cde0/chat/components/src/imCore.js">diff</a> |
<a href="/comm-central/comparison/be910446f19acea79281c530ca66d9544de0cde0/chat/components/src/imCore.js">comparison</a> |
<a href="/comm-central/log/be910446f19acea79281c530ca66d9544de0cde0/chat/components/src/imCore.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/be910446f19acea79281c530ca66d9544de0cde0/chat/content/convbrowser.xml">chat/content/convbrowser.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/be910446f19acea79281c530ca66d9544de0cde0/chat/content/convbrowser.xml">file</a> |
<a href="/comm-central/annotate/be910446f19acea79281c530ca66d9544de0cde0/chat/content/convbrowser.xml">annotate</a> |
<a href="/comm-central/diff/be910446f19acea79281c530ca66d9544de0cde0/chat/content/convbrowser.xml">diff</a> |
<a href="/comm-central/comparison/be910446f19acea79281c530ca66d9544de0cde0/chat/content/convbrowser.xml">comparison</a> |
<a href="/comm-central/log/be910446f19acea79281c530ca66d9544de0cde0/chat/content/convbrowser.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/be910446f19acea79281c530ca66d9544de0cde0/chat/content/imtooltip.xml">chat/content/imtooltip.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/be910446f19acea79281c530ca66d9544de0cde0/chat/content/imtooltip.xml">file</a> |
<a href="/comm-central/annotate/be910446f19acea79281c530ca66d9544de0cde0/chat/content/imtooltip.xml">annotate</a> |
<a href="/comm-central/diff/be910446f19acea79281c530ca66d9544de0cde0/chat/content/imtooltip.xml">diff</a> |
<a href="/comm-central/comparison/be910446f19acea79281c530ca66d9544de0cde0/chat/content/imtooltip.xml">comparison</a> |
<a href="/comm-central/log/be910446f19acea79281c530ca66d9544de0cde0/chat/content/imtooltip.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/be910446f19acea79281c530ca66d9544de0cde0/chat/modules/imContentSink.jsm">chat/modules/imContentSink.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/be910446f19acea79281c530ca66d9544de0cde0/chat/modules/imContentSink.jsm">file</a> |
<a href="/comm-central/annotate/be910446f19acea79281c530ca66d9544de0cde0/chat/modules/imContentSink.jsm">annotate</a> |
<a href="/comm-central/diff/be910446f19acea79281c530ca66d9544de0cde0/chat/modules/imContentSink.jsm">diff</a> |
<a href="/comm-central/comparison/be910446f19acea79281c530ca66d9544de0cde0/chat/modules/imContentSink.jsm">comparison</a> |
<a href="/comm-central/log/be910446f19acea79281c530ca66d9544de0cde0/chat/modules/imContentSink.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/be910446f19acea79281c530ca66d9544de0cde0/chat/modules/imSmileys.jsm">chat/modules/imSmileys.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/be910446f19acea79281c530ca66d9544de0cde0/chat/modules/imSmileys.jsm">file</a> |
<a href="/comm-central/annotate/be910446f19acea79281c530ca66d9544de0cde0/chat/modules/imSmileys.jsm">annotate</a> |
<a href="/comm-central/diff/be910446f19acea79281c530ca66d9544de0cde0/chat/modules/imSmileys.jsm">diff</a> |
<a href="/comm-central/comparison/be910446f19acea79281c530ca66d9544de0cde0/chat/modules/imSmileys.jsm">comparison</a> |
<a href="/comm-central/log/be910446f19acea79281c530ca66d9544de0cde0/chat/modules/imSmileys.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/be910446f19acea79281c530ca66d9544de0cde0/chat/modules/imTextboxUtils.jsm">chat/modules/imTextboxUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/be910446f19acea79281c530ca66d9544de0cde0/chat/modules/imTextboxUtils.jsm">file</a> |
<a href="/comm-central/annotate/be910446f19acea79281c530ca66d9544de0cde0/chat/modules/imTextboxUtils.jsm">annotate</a> |
<a href="/comm-central/diff/be910446f19acea79281c530ca66d9544de0cde0/chat/modules/imTextboxUtils.jsm">diff</a> |
<a href="/comm-central/comparison/be910446f19acea79281c530ca66d9544de0cde0/chat/modules/imTextboxUtils.jsm">comparison</a> |
<a href="/comm-central/log/be910446f19acea79281c530ca66d9544de0cde0/chat/modules/imTextboxUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/be910446f19acea79281c530ca66d9544de0cde0/chat/modules/imXPCOMUtils.jsm">chat/modules/imXPCOMUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/be910446f19acea79281c530ca66d9544de0cde0/chat/modules/imXPCOMUtils.jsm">file</a> |
<a href="/comm-central/annotate/be910446f19acea79281c530ca66d9544de0cde0/chat/modules/imXPCOMUtils.jsm">annotate</a> |
<a href="/comm-central/diff/be910446f19acea79281c530ca66d9544de0cde0/chat/modules/imXPCOMUtils.jsm">diff</a> |
<a href="/comm-central/comparison/be910446f19acea79281c530ca66d9544de0cde0/chat/modules/imXPCOMUtils.jsm">comparison</a> |
<a href="/comm-central/log/be910446f19acea79281c530ca66d9544de0cde0/chat/modules/imXPCOMUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/be910446f19acea79281c530ca66d9544de0cde0/chat/modules/jsProtoHelper.jsm">chat/modules/jsProtoHelper.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/be910446f19acea79281c530ca66d9544de0cde0/chat/modules/jsProtoHelper.jsm">file</a> |
<a href="/comm-central/annotate/be910446f19acea79281c530ca66d9544de0cde0/chat/modules/jsProtoHelper.jsm">annotate</a> |
<a href="/comm-central/diff/be910446f19acea79281c530ca66d9544de0cde0/chat/modules/jsProtoHelper.jsm">diff</a> |
<a href="/comm-central/comparison/be910446f19acea79281c530ca66d9544de0cde0/chat/modules/jsProtoHelper.jsm">comparison</a> |
<a href="/comm-central/log/be910446f19acea79281c530ca66d9544de0cde0/chat/modules/jsProtoHelper.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/be910446f19acea79281c530ca66d9544de0cde0/chat/modules/test/test_filtering.js">chat/modules/test/test_filtering.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/be910446f19acea79281c530ca66d9544de0cde0/chat/modules/test/test_filtering.js">file</a> |
<a href="/comm-central/annotate/be910446f19acea79281c530ca66d9544de0cde0/chat/modules/test/test_filtering.js">annotate</a> |
<a href="/comm-central/diff/be910446f19acea79281c530ca66d9544de0cde0/chat/modules/test/test_filtering.js">diff</a> |
<a href="/comm-central/comparison/be910446f19acea79281c530ca66d9544de0cde0/chat/modules/test/test_filtering.js">comparison</a> |
<a href="/comm-central/log/be910446f19acea79281c530ca66d9544de0cde0/chat/modules/test/test_filtering.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/irc/irc.js">chat/protocols/irc/irc.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/irc/irc.js">file</a> |
<a href="/comm-central/annotate/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/irc/irc.js">annotate</a> |
<a href="/comm-central/diff/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/irc/irc.js">diff</a> |
<a href="/comm-central/comparison/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/irc/irc.js">comparison</a> |
<a href="/comm-central/log/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/irc/irc.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/irc/ircBase.jsm">chat/protocols/irc/ircBase.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/irc/ircBase.jsm">file</a> |
<a href="/comm-central/annotate/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/irc/ircBase.jsm">annotate</a> |
<a href="/comm-central/diff/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/irc/ircBase.jsm">diff</a> |
<a href="/comm-central/comparison/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/irc/ircBase.jsm">comparison</a> |
<a href="/comm-central/log/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/irc/ircBase.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/irc/ircCTCP.jsm">chat/protocols/irc/ircCTCP.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/irc/ircCTCP.jsm">file</a> |
<a href="/comm-central/annotate/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/irc/ircCTCP.jsm">annotate</a> |
<a href="/comm-central/diff/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/irc/ircCTCP.jsm">diff</a> |
<a href="/comm-central/comparison/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/irc/ircCTCP.jsm">comparison</a> |
<a href="/comm-central/log/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/irc/ircCTCP.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/irc/ircHandlers.jsm">chat/protocols/irc/ircHandlers.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/irc/ircHandlers.jsm">file</a> |
<a href="/comm-central/annotate/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/irc/ircHandlers.jsm">annotate</a> |
<a href="/comm-central/diff/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/irc/ircHandlers.jsm">diff</a> |
<a href="/comm-central/comparison/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/irc/ircHandlers.jsm">comparison</a> |
<a href="/comm-central/log/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/irc/ircHandlers.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/irc/ircISUPPORT.jsm">chat/protocols/irc/ircISUPPORT.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/irc/ircISUPPORT.jsm">file</a> |
<a href="/comm-central/annotate/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/irc/ircISUPPORT.jsm">annotate</a> |
<a href="/comm-central/diff/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/irc/ircISUPPORT.jsm">diff</a> |
<a href="/comm-central/comparison/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/irc/ircISUPPORT.jsm">comparison</a> |
<a href="/comm-central/log/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/irc/ircISUPPORT.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/irc/ircWatchMonitor.jsm">chat/protocols/irc/ircWatchMonitor.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/irc/ircWatchMonitor.jsm">file</a> |
<a href="/comm-central/annotate/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/irc/ircWatchMonitor.jsm">annotate</a> |
<a href="/comm-central/diff/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/irc/ircWatchMonitor.jsm">diff</a> |
<a href="/comm-central/comparison/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/irc/ircWatchMonitor.jsm">comparison</a> |
<a href="/comm-central/log/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/irc/ircWatchMonitor.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/irc/test/test_ircMessage.js">chat/protocols/irc/test/test_ircMessage.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/irc/test/test_ircMessage.js">file</a> |
<a href="/comm-central/annotate/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/irc/test/test_ircMessage.js">annotate</a> |
<a href="/comm-central/diff/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/irc/test/test_ircMessage.js">diff</a> |
<a href="/comm-central/comparison/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/irc/test/test_ircMessage.js">comparison</a> |
<a href="/comm-central/log/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/irc/test/test_ircMessage.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/twitter/twitter.js">chat/protocols/twitter/twitter.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/twitter/twitter.js">file</a> |
<a href="/comm-central/annotate/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/twitter/twitter.js">annotate</a> |
<a href="/comm-central/diff/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/twitter/twitter.js">diff</a> |
<a href="/comm-central/comparison/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/twitter/twitter.js">comparison</a> |
<a href="/comm-central/log/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/twitter/twitter.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/xmpp/xmpp-authmechs.jsm">chat/protocols/xmpp/xmpp-authmechs.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/xmpp/xmpp-authmechs.jsm">file</a> |
<a href="/comm-central/annotate/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/xmpp/xmpp-authmechs.jsm">annotate</a> |
<a href="/comm-central/diff/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/xmpp/xmpp-authmechs.jsm">diff</a> |
<a href="/comm-central/comparison/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/xmpp/xmpp-authmechs.jsm">comparison</a> |
<a href="/comm-central/log/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/xmpp/xmpp-authmechs.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/xmpp/xmpp-session.jsm">chat/protocols/xmpp/xmpp-session.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/xmpp/xmpp-session.jsm">file</a> |
<a href="/comm-central/annotate/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/xmpp/xmpp-session.jsm">annotate</a> |
<a href="/comm-central/diff/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/xmpp/xmpp-session.jsm">diff</a> |
<a href="/comm-central/comparison/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/xmpp/xmpp-session.jsm">comparison</a> |
<a href="/comm-central/log/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/xmpp/xmpp-session.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/xmpp/xmpp-xml.jsm">chat/protocols/xmpp/xmpp-xml.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/xmpp/xmpp-xml.jsm">file</a> |
<a href="/comm-central/annotate/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/xmpp/xmpp-xml.jsm">annotate</a> |
<a href="/comm-central/diff/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/xmpp/xmpp-xml.jsm">diff</a> |
<a href="/comm-central/comparison/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/xmpp/xmpp-xml.jsm">comparison</a> |
<a href="/comm-central/log/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/xmpp/xmpp-xml.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/xmpp/xmpp.jsm">chat/protocols/xmpp/xmpp.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/xmpp/xmpp.jsm">file</a> |
<a href="/comm-central/annotate/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/xmpp/xmpp.jsm">annotate</a> |
<a href="/comm-central/diff/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/xmpp/xmpp.jsm">diff</a> |
<a href="/comm-central/comparison/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/xmpp/xmpp.jsm">comparison</a> |
<a href="/comm-central/log/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/xmpp/xmpp.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/yahoo/test/test_yahooAccount.js">chat/protocols/yahoo/test/test_yahooAccount.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/yahoo/test/test_yahooAccount.js">file</a> |
<a href="/comm-central/annotate/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/yahoo/test/test_yahooAccount.js">annotate</a> |
<a href="/comm-central/diff/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/yahoo/test/test_yahooAccount.js">diff</a> |
<a href="/comm-central/comparison/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/yahoo/test/test_yahooAccount.js">comparison</a> |
<a href="/comm-central/log/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/yahoo/test/test_yahooAccount.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/yahoo/yahoo-session.jsm">chat/protocols/yahoo/yahoo-session.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/yahoo/yahoo-session.jsm">file</a> |
<a href="/comm-central/annotate/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/yahoo/yahoo-session.jsm">annotate</a> |
<a href="/comm-central/diff/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/yahoo/yahoo-session.jsm">diff</a> |
<a href="/comm-central/comparison/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/yahoo/yahoo-session.jsm">comparison</a> |
<a href="/comm-central/log/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/yahoo/yahoo-session.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/yahoo/yahoo.js">chat/protocols/yahoo/yahoo.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/yahoo/yahoo.js">file</a> |
<a href="/comm-central/annotate/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/yahoo/yahoo.js">annotate</a> |
<a href="/comm-central/diff/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/yahoo/yahoo.js">diff</a> |
<a href="/comm-central/comparison/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/yahoo/yahoo.js">comparison</a> |
<a href="/comm-central/log/be910446f19acea79281c530ca66d9544de0cde0/chat/protocols/yahoo/yahoo.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/chat/components/src/imAccounts.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/chat/components/src/imAccounts.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -236,17 +236,17 @@ imAccount.prototype = {</span>
<a href="#l1.4"></a><span id="l1.4">         this.firstConnectionState = Ci.imIAccount.FIRST_CONNECTION_OK;</span>
<a href="#l1.5"></a><span id="l1.5">       delete this.connectionStateMsg;</span>
<a href="#l1.6"></a><span id="l1.6"> </span>
<a href="#l1.7"></a><span id="l1.7">       if (this.canJoinChat &amp;&amp;</span>
<a href="#l1.8"></a><span id="l1.8">           this.prefBranch.prefHasUserValue(kPrefAccountAutoJoin)) {</span>
<a href="#l1.9"></a><span id="l1.9">         let autojoin = this.prefBranch.getComplexValue(</span>
<a href="#l1.10"></a><span id="l1.10">           kPrefAccountAutoJoin, Ci.nsISupportsString).data;</span>
<a href="#l1.11"></a><span id="l1.11">         if (autojoin) {</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-          for each (let room in autojoin.trim().split(/,\s*/)) {</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+          for (let room of autojoin.trim().split(/,\s*/)) {</span>
<a href="#l1.14"></a><span id="l1.14">             if (room)</span>
<a href="#l1.15"></a><span id="l1.15">               this.joinChat(this.getChatRoomDefaultFieldValues(room));</span>
<a href="#l1.16"></a><span id="l1.16">           }</span>
<a href="#l1.17"></a><span id="l1.17">         }</span>
<a href="#l1.18"></a><span id="l1.18">       }</span>
<a href="#l1.19"></a><span id="l1.19">     }</span>
<a href="#l1.20"></a><span id="l1.20">     else if (aTopic == &quot;account-disconnecting&quot;) {</span>
<a href="#l1.21"></a><span id="l1.21">       this.connectionState = Ci.imIAccount.STATE_DISCONNECTING;</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineat">@@ -512,17 +512,17 @@ imAccount.prototype = {</span>
<a href="#l1.23"></a><span id="l1.23">     let logins;</span>
<a href="#l1.24"></a><span id="l1.24">     try {</span>
<a href="#l1.25"></a><span id="l1.25">       logins = Services.logins.findLogins({}, passwordURI, null, passwordURI);</span>
<a href="#l1.26"></a><span id="l1.26">     } catch (e) {</span>
<a href="#l1.27"></a><span id="l1.27">       this._handleMasterPasswordException(e);</span>
<a href="#l1.28"></a><span id="l1.28">       return &quot;&quot;;</span>
<a href="#l1.29"></a><span id="l1.29">     }</span>
<a href="#l1.30"></a><span id="l1.30">     let normalizedName = this.normalizedName;</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-    for each (let login in logins) {</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+    for (let login of logins) {</span>
<a href="#l1.33"></a><span id="l1.33">       if (login.username == normalizedName) {</span>
<a href="#l1.34"></a><span id="l1.34">         this._password = login.password;</span>
<a href="#l1.35"></a><span id="l1.35">         if (this._connectionErrorReason == Ci.imIAccount.ERROR_MISSING_PASSWORD) {</span>
<a href="#l1.36"></a><span id="l1.36">           // We have found a password for an account marked as missing password,</span>
<a href="#l1.37"></a><span id="l1.37">           // re-check all others accounts missing a password. But first,</span>
<a href="#l1.38"></a><span id="l1.38">           // remove the error on our own account to avoid re-checking it.</span>
<a href="#l1.39"></a><span id="l1.39">           delete this._connectionErrorReason;</span>
<a href="#l1.40"></a><span id="l1.40">           gAccountsService._checkIfPasswordStillMissing();</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineat">@@ -550,17 +550,17 @@ imAccount.prototype = {</span>
<a href="#l1.42"></a><span id="l1.42">     let newLogin = Cc[&quot;@mozilla.org/login-manager/loginInfo;1&quot;]</span>
<a href="#l1.43"></a><span id="l1.43">                    .createInstance(Ci.nsILoginInfo);</span>
<a href="#l1.44"></a><span id="l1.44">     let passwordURI = &quot;im://&quot; + this.protocol.id;</span>
<a href="#l1.45"></a><span id="l1.45">     newLogin.init(passwordURI, null, passwordURI, this.normalizedName,</span>
<a href="#l1.46"></a><span id="l1.46">                   aPassword, &quot;&quot;, &quot;&quot;);</span>
<a href="#l1.47"></a><span id="l1.47">     try {</span>
<a href="#l1.48"></a><span id="l1.48">       let logins = Services.logins.findLogins({}, passwordURI, null, passwordURI);</span>
<a href="#l1.49"></a><span id="l1.49">       let saved = false;</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineminus">-      for each (let login in logins) {</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineplus">+      for (let login of logins) {</span>
<a href="#l1.52"></a><span id="l1.52">         if (newLogin.matches(login, true)) {</span>
<a href="#l1.53"></a><span id="l1.53">           if (aPassword)</span>
<a href="#l1.54"></a><span id="l1.54">             Services.logins.modifyLogin(login, newLogin);</span>
<a href="#l1.55"></a><span id="l1.55">           else</span>
<a href="#l1.56"></a><span id="l1.56">             Services.logins.removeLogin(login);</span>
<a href="#l1.57"></a><span id="l1.57">           saved = true;</span>
<a href="#l1.58"></a><span id="l1.58">           break;</span>
<a href="#l1.59"></a><span id="l1.59">         }</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineat">@@ -628,17 +628,17 @@ imAccount.prototype = {</span>
<a href="#l1.61"></a><span id="l1.61">   remove: function() {</span>
<a href="#l1.62"></a><span id="l1.62">     let login = Cc[&quot;@mozilla.org/login-manager/loginInfo;1&quot;]</span>
<a href="#l1.63"></a><span id="l1.63">                 .createInstance(Ci.nsILoginInfo);</span>
<a href="#l1.64"></a><span id="l1.64">     let passwordURI = &quot;im://&quot; + this.protocol.id;</span>
<a href="#l1.65"></a><span id="l1.65">     // Note: the normalizedName may not be exactly right if the</span>
<a href="#l1.66"></a><span id="l1.66">     // protocol plugin is missing.</span>
<a href="#l1.67"></a><span id="l1.67">     login.init(passwordURI, null, passwordURI, this.normalizedName, &quot;&quot;, &quot;&quot;, &quot;&quot;);</span>
<a href="#l1.68"></a><span id="l1.68">     let logins = Services.logins.findLogins({}, passwordURI, null, passwordURI);</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineminus">-    for each (let l in logins) {</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineplus">+    for (let l of logins) {</span>
<a href="#l1.71"></a><span id="l1.71">       if (login.matches(l, true)) {</span>
<a href="#l1.72"></a><span id="l1.72">         Services.logins.removeLogin(l);</span>
<a href="#l1.73"></a><span id="l1.73">         break;</span>
<a href="#l1.74"></a><span id="l1.74">       }</span>
<a href="#l1.75"></a><span id="l1.75">     }</span>
<a href="#l1.76"></a><span id="l1.76">     if (this.connected || this.connecting)</span>
<a href="#l1.77"></a><span id="l1.77">       this.disconnect();</span>
<a href="#l1.78"></a><span id="l1.78">     if (this.prplAccount)</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineat">@@ -838,17 +838,17 @@ AccountsService.prototype = {</span>
<a href="#l1.80"></a><span id="l1.80">   initAccounts: function() {</span>
<a href="#l1.81"></a><span id="l1.81">     this._initAutoLoginStatus();</span>
<a href="#l1.82"></a><span id="l1.82">     this._accounts = [];</span>
<a href="#l1.83"></a><span id="l1.83">     this._accountsById = {};</span>
<a href="#l1.84"></a><span id="l1.84">     gAccountsService = this;</span>
<a href="#l1.85"></a><span id="l1.85">     gConvertingOldPasswords =</span>
<a href="#l1.86"></a><span id="l1.86">       Services.prefs.getBoolPref(kPrefConvertOldPasswords);</span>
<a href="#l1.87"></a><span id="l1.87">     let accountList = this._accountList;</span>
<a href="#l1.88"></a><span id="l1.88" class="difflineminus">-    for each (let account in (accountList ? accountList.split(&quot;,&quot;) : [])) {</span>
<a href="#l1.89"></a><span id="l1.89" class="difflineplus">+    for (let account of (accountList ? accountList.split(&quot;,&quot;) : [])) {</span>
<a href="#l1.90"></a><span id="l1.90">       try {</span>
<a href="#l1.91"></a><span id="l1.91">         account.trim();</span>
<a href="#l1.92"></a><span id="l1.92">         if (!account)</span>
<a href="#l1.93"></a><span id="l1.93">           throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l1.94"></a><span id="l1.94">         new imAccount(account);</span>
<a href="#l1.95"></a><span id="l1.95">       } catch (e) {</span>
<a href="#l1.96"></a><span id="l1.96">         Cu.reportError(e);</span>
<a href="#l1.97"></a><span id="l1.97">         dump(e + &quot; &quot; + e.toSource() + &quot;\n&quot;);</span>
<a href="#l1.98"></a><span id="l1.98" class="difflineat">@@ -884,17 +884,17 @@ AccountsService.prototype = {</span>
<a href="#l1.99"></a><span id="l1.99">   get _accountList() { return Services.prefs.getCharPref(kPrefMessengerAccounts); },</span>
<a href="#l1.100"></a><span id="l1.100">   set _accountList(aNewList) {</span>
<a href="#l1.101"></a><span id="l1.101">     this._observingAccountListChange = false;</span>
<a href="#l1.102"></a><span id="l1.102">     Services.prefs.setCharPref(kPrefMessengerAccounts, aNewList);</span>
<a href="#l1.103"></a><span id="l1.103">     delete this._observingAccountListChange;</span>
<a href="#l1.104"></a><span id="l1.104">   },</span>
<a href="#l1.105"></a><span id="l1.105"> </span>
<a href="#l1.106"></a><span id="l1.106">   unInitAccounts: function() {</span>
<a href="#l1.107"></a><span id="l1.107" class="difflineminus">-    for each (let account in this._accounts)</span>
<a href="#l1.108"></a><span id="l1.108" class="difflineplus">+    for (let account of this._accounts)</span>
<a href="#l1.109"></a><span id="l1.109">       account.unInit();</span>
<a href="#l1.110"></a><span id="l1.110">     gAccountsService = null;</span>
<a href="#l1.111"></a><span id="l1.111">     delete this._accounts;</span>
<a href="#l1.112"></a><span id="l1.112">     delete this._accountsById;</span>
<a href="#l1.113"></a><span id="l1.113">     Services.prefs.removeObserver(kPrefMessengerAccounts, this._prefObserver);</span>
<a href="#l1.114"></a><span id="l1.114">     delete this._prefObserver;</span>
<a href="#l1.115"></a><span id="l1.115">   },</span>
<a href="#l1.116"></a><span id="l1.116"> </span>
<a href="#l1.117"></a><span id="l1.117" class="difflineat">@@ -983,17 +983,17 @@ AccountsService.prototype = {</span>
<a href="#l1.118"></a><span id="l1.118">     } catch (e) {</span>
<a href="#l1.119"></a><span id="l1.119">       // if we failed to get the last crash time, then keep the</span>
<a href="#l1.120"></a><span id="l1.120">       // AUTOLOGIN_CRASH value in mAutoLoginStatus and return.</span>
<a href="#l1.121"></a><span id="l1.121">       return;</span>
<a href="#l1.122"></a><span id="l1.122">     }</span>
<a href="#l1.123"></a><span id="l1.123">   },</span>
<a href="#l1.124"></a><span id="l1.124"> </span>
<a href="#l1.125"></a><span id="l1.125">   processAutoLogin: function() {</span>
<a href="#l1.126"></a><span id="l1.126" class="difflineminus">-    for each (let account in this._accounts)</span>
<a href="#l1.127"></a><span id="l1.127" class="difflineplus">+    for (let account of this._accounts)</span>
<a href="#l1.128"></a><span id="l1.128">       account.checkAutoLogin();</span>
<a href="#l1.129"></a><span id="l1.129"> </span>
<a href="#l1.130"></a><span id="l1.130">     // Make sure autologin is now enabled, so that we don't display a</span>
<a href="#l1.131"></a><span id="l1.131">     // message stating that it is disabled and asking the user if it</span>
<a href="#l1.132"></a><span id="l1.132">     // should be processed now.</span>
<a href="#l1.133"></a><span id="l1.133">     this.autoLoginStatus = Ci.imIAccountsService.AUTOLOGIN_ENABLED;</span>
<a href="#l1.134"></a><span id="l1.134"> </span>
<a href="#l1.135"></a><span id="l1.135">     // Notify observers so that any message stating that autologin is</span>
<a href="#l1.136"></a><span id="l1.136" class="difflineat">@@ -1003,17 +1003,17 @@ AccountsService.prototype = {</span>
<a href="#l1.137"></a><span id="l1.137"> </span>
<a href="#l1.138"></a><span id="l1.138">   _checkingIfPasswordStillMissing: false,</span>
<a href="#l1.139"></a><span id="l1.139">   _checkIfPasswordStillMissing: function() {</span>
<a href="#l1.140"></a><span id="l1.140">     // Avoid recursion.</span>
<a href="#l1.141"></a><span id="l1.141">     if (this._checkingIfPasswordStillMissing)</span>
<a href="#l1.142"></a><span id="l1.142">       return;</span>
<a href="#l1.143"></a><span id="l1.143"> </span>
<a href="#l1.144"></a><span id="l1.144">     this._checkingIfPasswordStillMissing = true;</span>
<a href="#l1.145"></a><span id="l1.145" class="difflineminus">-    for each (let account in this._accounts)</span>
<a href="#l1.146"></a><span id="l1.146" class="difflineplus">+    for (let account of this._accounts)</span>
<a href="#l1.147"></a><span id="l1.147">       account._checkIfPasswordStillMissing();</span>
<a href="#l1.148"></a><span id="l1.148">     delete this._checkingIfPasswordStillMissing;</span>
<a href="#l1.149"></a><span id="l1.149">   },</span>
<a href="#l1.150"></a><span id="l1.150"> </span>
<a href="#l1.151"></a><span id="l1.151">   getAccountById: function(aAccountId) {</span>
<a href="#l1.152"></a><span id="l1.152">     if (!aAccountId.startsWith(kAccountKeyPrefix))</span>
<a href="#l1.153"></a><span id="l1.153">       throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l1.154"></a><span id="l1.154"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/chat/components/src/imContacts.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/chat/components/src/imContacts.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -224,17 +224,17 @@ Tag.prototype = {</span>
<a href="#l2.4"></a><span id="l2.4">   addObserver: function(aObserver) {</span>
<a href="#l2.5"></a><span id="l2.5">     if (this._observers.indexOf(aObserver) == -1)</span>
<a href="#l2.6"></a><span id="l2.6">       this._observers.push(aObserver);</span>
<a href="#l2.7"></a><span id="l2.7">   },</span>
<a href="#l2.8"></a><span id="l2.8">   removeObserver: function(aObserver) {</span>
<a href="#l2.9"></a><span id="l2.9">     this._observers = this._observers.filter(o =&gt; o !== aObserver);</span>
<a href="#l2.10"></a><span id="l2.10">   },</span>
<a href="#l2.11"></a><span id="l2.11">   notifyObservers: function(aSubject, aTopic, aData) {</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-    for each (let observer in this._observers)</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+    for (let observer of this._observers)</span>
<a href="#l2.14"></a><span id="l2.14">       observer.observe(aSubject, aTopic, aData);</span>
<a href="#l2.15"></a><span id="l2.15">   },</span>
<a href="#l2.16"></a><span id="l2.16"> </span>
<a href="#l2.17"></a><span id="l2.17">   getInterfaces: function(countRef) {</span>
<a href="#l2.18"></a><span id="l2.18">     let interfaces = [Ci.nsIClassInfo, Ci.nsISupports, Ci.imITag];</span>
<a href="#l2.19"></a><span id="l2.19">     countRef.value = interfaces.length;</span>
<a href="#l2.20"></a><span id="l2.20">     return interfaces;</span>
<a href="#l2.21"></a><span id="l2.21">   },</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineat">@@ -251,17 +251,17 @@ var otherContactsTag = {</span>
<a href="#l2.23"></a><span id="l2.23">   _contactsInitialized: false,</span>
<a href="#l2.24"></a><span id="l2.24">   _saveHiddenTagsPref: function() {</span>
<a href="#l2.25"></a><span id="l2.25">     Services.prefs.setCharPref(this.hiddenTagsPref,</span>
<a href="#l2.26"></a><span id="l2.26">                                Object.keys(this._hiddenTags).join(&quot;,&quot;));</span>
<a href="#l2.27"></a><span id="l2.27">   },</span>
<a href="#l2.28"></a><span id="l2.28">   showTag: function(aTag) {</span>
<a href="#l2.29"></a><span id="l2.29">     let id = aTag.id;</span>
<a href="#l2.30"></a><span id="l2.30">     delete this._hiddenTags[id];</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-    for each (let contact in this._contacts)</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+    for (let contact of this._contacts)</span>
<a href="#l2.33"></a><span id="l2.33">       if (contact.getTags().some(t =&gt; t.id == id))</span>
<a href="#l2.34"></a><span id="l2.34">         this._removeContact(contact);</span>
<a href="#l2.35"></a><span id="l2.35"> </span>
<a href="#l2.36"></a><span id="l2.36">     aTag.notifyObservers(aTag, &quot;tag-shown&quot;, null);</span>
<a href="#l2.37"></a><span id="l2.37">     Services.obs.notifyObservers(aTag, &quot;tag-shown&quot;, null);</span>
<a href="#l2.38"></a><span id="l2.38">     this._saveHiddenTagsPref();</span>
<a href="#l2.39"></a><span id="l2.39">   },</span>
<a href="#l2.40"></a><span id="l2.40">   hideTag: function(aTag) {</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineat">@@ -272,17 +272,17 @@ var otherContactsTag = {</span>
<a href="#l2.42"></a><span id="l2.42">     if (this._contactsInitialized)</span>
<a href="#l2.43"></a><span id="l2.43">       this._hideTag(aTag);</span>
<a href="#l2.44"></a><span id="l2.44"> </span>
<a href="#l2.45"></a><span id="l2.45">     aTag.notifyObservers(aTag, &quot;tag-hidden&quot;, null);</span>
<a href="#l2.46"></a><span id="l2.46">     Services.obs.notifyObservers(aTag, &quot;tag-hidden&quot;, null);</span>
<a href="#l2.47"></a><span id="l2.47">     this._saveHiddenTagsPref();</span>
<a href="#l2.48"></a><span id="l2.48">   },</span>
<a href="#l2.49"></a><span id="l2.49">   _hideTag: function(aTag) {</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineminus">-    for each (let contact in aTag.getContacts())</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineplus">+    for (let contact of aTag.getContacts())</span>
<a href="#l2.52"></a><span id="l2.52">       if (!(contact.id in this._contacts) &amp;&amp;</span>
<a href="#l2.53"></a><span id="l2.53">           contact.getTags().every(t =&gt; t.id in this._hiddenTags))</span>
<a href="#l2.54"></a><span id="l2.54">         this._addContact(contact);</span>
<a href="#l2.55"></a><span id="l2.55">   },</span>
<a href="#l2.56"></a><span id="l2.56">   observe: function(aSubject, aTopic, aData) {</span>
<a href="#l2.57"></a><span id="l2.57">     aSubject.QueryInterface(Ci.imIContact);</span>
<a href="#l2.58"></a><span id="l2.58">     if (aTopic == &quot;contact-tag-removed&quot; || aTopic == &quot;contact-added&quot;) {</span>
<a href="#l2.59"></a><span id="l2.59">       if (!(aSubject.id in this._contacts) &amp;&amp;</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineat">@@ -296,17 +296,17 @@ var otherContactsTag = {</span>
<a href="#l2.61"></a><span id="l2.61">               !(parseInt(aData) in this._hiddenTags))))</span>
<a href="#l2.62"></a><span id="l2.62">       this._removeContact(aSubject);</span>
<a href="#l2.63"></a><span id="l2.63">   },</span>
<a href="#l2.64"></a><span id="l2.64"> </span>
<a href="#l2.65"></a><span id="l2.65">   _initHiddenTags: function() {</span>
<a href="#l2.66"></a><span id="l2.66">     let pref = Services.prefs.getCharPref(this.hiddenTagsPref);</span>
<a href="#l2.67"></a><span id="l2.67">     if (!pref)</span>
<a href="#l2.68"></a><span id="l2.68">       return;</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineminus">-    for each (let tagId in pref.split(&quot;,&quot;))</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineplus">+    for (let tagId of pref.split(&quot;,&quot;))</span>
<a href="#l2.71"></a><span id="l2.71">       this._hiddenTags[tagId] = TagsById[tagId];</span>
<a href="#l2.72"></a><span id="l2.72">   },</span>
<a href="#l2.73"></a><span id="l2.73">   _initContacts: function() {</span>
<a href="#l2.74"></a><span id="l2.74">     if (this._contactsInitialized)</span>
<a href="#l2.75"></a><span id="l2.75">       return;</span>
<a href="#l2.76"></a><span id="l2.76">     this._observers = [];</span>
<a href="#l2.77"></a><span id="l2.77">     this._observer = {</span>
<a href="#l2.78"></a><span id="l2.78">       self: this,</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineat">@@ -314,18 +314,19 @@ var otherContactsTag = {</span>
<a href="#l2.80"></a><span id="l2.80">         if (aTopic == &quot;contact-moved-in&quot; &amp;&amp; !(aSubject instanceof Contact))</span>
<a href="#l2.81"></a><span id="l2.81">           return;</span>
<a href="#l2.82"></a><span id="l2.82"> </span>
<a href="#l2.83"></a><span id="l2.83">         this.self.notifyObservers(aSubject, aTopic, aData);</span>
<a href="#l2.84"></a><span id="l2.84">       }</span>
<a href="#l2.85"></a><span id="l2.85">     };</span>
<a href="#l2.86"></a><span id="l2.86">     this._contacts = {};</span>
<a href="#l2.87"></a><span id="l2.87">     this._contactsInitialized = true;</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineminus">-    for each (let tag in this._hiddenTags)</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineminus">-      this._hideTag(tag);</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineplus">+    for (let id in this._hiddenTags) {</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineplus">+      let tag = this._hiddenTags[id];</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineplus">+    }</span>
<a href="#l2.93"></a><span id="l2.93">     Services.obs.addObserver(this, &quot;contact-tag-added&quot;, false);</span>
<a href="#l2.94"></a><span id="l2.94">     Services.obs.addObserver(this, &quot;contact-tag-removed&quot;, false);</span>
<a href="#l2.95"></a><span id="l2.95">     Services.obs.addObserver(this, &quot;contact-added&quot;, false);</span>
<a href="#l2.96"></a><span id="l2.96">     Services.obs.addObserver(this, &quot;contact-removed&quot;, false);</span>
<a href="#l2.97"></a><span id="l2.97">   },</span>
<a href="#l2.98"></a><span id="l2.98"> </span>
<a href="#l2.99"></a><span id="l2.99">   // imITag implementation</span>
<a href="#l2.100"></a><span id="l2.100">   get id() { return -1; },</span>
<a href="#l2.101"></a><span id="l2.101" class="difflineat">@@ -335,37 +336,37 @@ var otherContactsTag = {</span>
<a href="#l2.102"></a><span id="l2.102">     let contacts = Object.keys(this._contacts).map(id =&gt; this._contacts[id]);</span>
<a href="#l2.103"></a><span id="l2.103">     if (aContactCount)</span>
<a href="#l2.104"></a><span id="l2.104">       aContactCount.value = contacts.length;</span>
<a href="#l2.105"></a><span id="l2.105">     return contacts;</span>
<a href="#l2.106"></a><span id="l2.106">   },</span>
<a href="#l2.107"></a><span id="l2.107">   _addContact: function(aContact) {</span>
<a href="#l2.108"></a><span id="l2.108">     this._contacts[aContact.id] = aContact;</span>
<a href="#l2.109"></a><span id="l2.109">     this.notifyObservers(aContact, &quot;contact-moved-in&quot;);</span>
<a href="#l2.110"></a><span id="l2.110" class="difflineminus">-    for each (let observer in ContactsById[aContact.id]._observers)</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineplus">+    for (let observer of ContactsById[aContact.id]._observers)</span>
<a href="#l2.112"></a><span id="l2.112">       observer.observe(this, &quot;contact-moved-in&quot;, null);</span>
<a href="#l2.113"></a><span id="l2.113">     aContact.addObserver(this._observer);</span>
<a href="#l2.114"></a><span id="l2.114">   },</span>
<a href="#l2.115"></a><span id="l2.115">   _removeContact: function(aContact) {</span>
<a href="#l2.116"></a><span id="l2.116">     delete this._contacts[aContact.id];</span>
<a href="#l2.117"></a><span id="l2.117">     aContact.removeObserver(this._observer);</span>
<a href="#l2.118"></a><span id="l2.118">     this.notifyObservers(aContact, &quot;contact-moved-out&quot;);</span>
<a href="#l2.119"></a><span id="l2.119" class="difflineminus">-    for each (let observer in ContactsById[aContact.id]._observers)</span>
<a href="#l2.120"></a><span id="l2.120" class="difflineplus">+    for (let observer of ContactsById[aContact.id]._observers)</span>
<a href="#l2.121"></a><span id="l2.121">       observer.observe(this, &quot;contact-moved-out&quot;, null);</span>
<a href="#l2.122"></a><span id="l2.122">   },</span>
<a href="#l2.123"></a><span id="l2.123"> </span>
<a href="#l2.124"></a><span id="l2.124">   addObserver: function(aObserver) {</span>
<a href="#l2.125"></a><span id="l2.125">     if (this._observers.indexOf(aObserver) == -1)</span>
<a href="#l2.126"></a><span id="l2.126">       this._observers.push(aObserver);</span>
<a href="#l2.127"></a><span id="l2.127">   },</span>
<a href="#l2.128"></a><span id="l2.128">   removeObserver: function(aObserver) {</span>
<a href="#l2.129"></a><span id="l2.129">     this._observers = this._observers.filter(o =&gt; o !== aObserver);</span>
<a href="#l2.130"></a><span id="l2.130">   },</span>
<a href="#l2.131"></a><span id="l2.131">   notifyObservers: function(aSubject, aTopic, aData) {</span>
<a href="#l2.132"></a><span id="l2.132" class="difflineminus">-    for each (let observer in this._observers)</span>
<a href="#l2.133"></a><span id="l2.133" class="difflineplus">+    for (let observer of this._observers)</span>
<a href="#l2.134"></a><span id="l2.134">       observer.observe(aSubject, aTopic, aData);</span>
<a href="#l2.135"></a><span id="l2.135">   },</span>
<a href="#l2.136"></a><span id="l2.136"> </span>
<a href="#l2.137"></a><span id="l2.137">   getInterfaces: function(countRef) {</span>
<a href="#l2.138"></a><span id="l2.138">     let interfaces = [Ci.nsIClassInfo, Ci.nsISupports, Ci.nsIObserver, Ci.imITag];</span>
<a href="#l2.139"></a><span id="l2.139">     countRef.value = interfaces.length;</span>
<a href="#l2.140"></a><span id="l2.140">     return interfaces;</span>
<a href="#l2.141"></a><span id="l2.141">   },</span>
<a href="#l2.142"></a><span id="l2.142" class="difflineat">@@ -398,19 +399,20 @@ Contact.prototype = {</span>
<a href="#l2.143"></a><span id="l2.143">     let statement = DBConn.createStatement(&quot;UPDATE contacts SET alias = :alias WHERE id = :id&quot;);</span>
<a href="#l2.144"></a><span id="l2.144">     statement.params.alias = aNewAlias;</span>
<a href="#l2.145"></a><span id="l2.145">     statement.params.id = this._id;</span>
<a href="#l2.146"></a><span id="l2.146">     executeAsyncThenFinalize(statement);</span>
<a href="#l2.147"></a><span id="l2.147"> </span>
<a href="#l2.148"></a><span id="l2.148">     let oldDisplayName = this.displayName;</span>
<a href="#l2.149"></a><span id="l2.149">     this._alias = aNewAlias;</span>
<a href="#l2.150"></a><span id="l2.150">     this._notifyObservers(&quot;display-name-changed&quot;, oldDisplayName);</span>
<a href="#l2.151"></a><span id="l2.151" class="difflineminus">-    for each (let buddy in this._buddies)</span>
<a href="#l2.152"></a><span id="l2.152" class="difflineminus">-      for each (let accountBuddy in buddy._accounts)</span>
<a href="#l2.153"></a><span id="l2.153" class="difflineplus">+    for (let buddy of this._buddies) {</span>
<a href="#l2.154"></a><span id="l2.154" class="difflineplus">+      for (let accountBuddy of buddy._accounts)</span>
<a href="#l2.155"></a><span id="l2.155">         accountBuddy.serverAlias = aNewAlias;</span>
<a href="#l2.156"></a><span id="l2.156" class="difflineplus">+    }</span>
<a href="#l2.157"></a><span id="l2.157">     return aNewAlias;</span>
<a href="#l2.158"></a><span id="l2.158">   },</span>
<a href="#l2.159"></a><span id="l2.159">   _ensureNotDummy: function() {</span>
<a href="#l2.160"></a><span id="l2.160">     if (this._id &gt;= 0)</span>
<a href="#l2.161"></a><span id="l2.161">       return;</span>
<a href="#l2.162"></a><span id="l2.162"> </span>
<a href="#l2.163"></a><span id="l2.163">     // Create a real contact for this dummy contact</span>
<a href="#l2.164"></a><span id="l2.164">     let statement = DBConn.createStatement(&quot;INSERT INTO contacts DEFAULT VALUES&quot;);</span>
<a href="#l2.165"></a><span id="l2.165" class="difflineat">@@ -450,33 +452,33 @@ Contact.prototype = {</span>
<a href="#l2.166"></a><span id="l2.166">       executeAsyncThenFinalize(statement);</span>
<a href="#l2.167"></a><span id="l2.167">     }</span>
<a href="#l2.168"></a><span id="l2.168"> </span>
<a href="#l2.169"></a><span id="l2.169">     aTag = TagsById[aTag.id];</span>
<a href="#l2.170"></a><span id="l2.170">     this._tags.push(aTag);</span>
<a href="#l2.171"></a><span id="l2.171">     aTag._addContact(this);</span>
<a href="#l2.172"></a><span id="l2.172"> </span>
<a href="#l2.173"></a><span id="l2.173">     aTag.notifyObservers(this, &quot;contact-moved-in&quot;);</span>
<a href="#l2.174"></a><span id="l2.174" class="difflineminus">-    for each (let observer in this._observers)</span>
<a href="#l2.175"></a><span id="l2.175" class="difflineplus">+    for (let observer of this._observers)</span>
<a href="#l2.176"></a><span id="l2.176">       observer.observe(aTag, &quot;contact-moved-in&quot;, null);</span>
<a href="#l2.177"></a><span id="l2.177">     Services.obs.notifyObservers(this, &quot;contact-tag-added&quot;, aTag.id);</span>
<a href="#l2.178"></a><span id="l2.178">   },</span>
<a href="#l2.179"></a><span id="l2.179">   /* Remove a tag from the local tags of the contact. */</span>
<a href="#l2.180"></a><span id="l2.180">   _removeTag: function(aTag) {</span>
<a href="#l2.181"></a><span id="l2.181">     if (!this.hasTag(aTag) || this._isTagInherited(aTag))</span>
<a href="#l2.182"></a><span id="l2.182">       return;</span>
<a href="#l2.183"></a><span id="l2.183"> </span>
<a href="#l2.184"></a><span id="l2.184">     this._removeContactTagRow(aTag);</span>
<a href="#l2.185"></a><span id="l2.185"> </span>
<a href="#l2.186"></a><span id="l2.186">     this._tags = this._tags.filter(tag =&gt; tag.id != aTag.id);</span>
<a href="#l2.187"></a><span id="l2.187">     aTag = TagsById[aTag.id];</span>
<a href="#l2.188"></a><span id="l2.188">     aTag._removeContact(this);</span>
<a href="#l2.189"></a><span id="l2.189"> </span>
<a href="#l2.190"></a><span id="l2.190">     aTag.notifyObservers(this, &quot;contact-moved-out&quot;);</span>
<a href="#l2.191"></a><span id="l2.191" class="difflineminus">-    for each (let observer in this._observers)</span>
<a href="#l2.192"></a><span id="l2.192" class="difflineplus">+    for (let observer of this._observers)</span>
<a href="#l2.193"></a><span id="l2.193">       observer.observe(aTag, &quot;contact-moved-out&quot;, null);</span>
<a href="#l2.194"></a><span id="l2.194">     Services.obs.notifyObservers(this, &quot;contact-tag-removed&quot;, aTag.id);</span>
<a href="#l2.195"></a><span id="l2.195">   },</span>
<a href="#l2.196"></a><span id="l2.196">   _removeContactTagRow: function(aTag) {</span>
<a href="#l2.197"></a><span id="l2.197">     let statement = DBConn.createStatement(&quot;DELETE FROM contact_tag &quot; +</span>
<a href="#l2.198"></a><span id="l2.198">                                            &quot;WHERE contact_id = :contactId &quot; +</span>
<a href="#l2.199"></a><span id="l2.199">                                            &quot;AND tag_id = :tagId&quot;);</span>
<a href="#l2.200"></a><span id="l2.200">     statement.params.contactId = this.id;</span>
<a href="#l2.201"></a><span id="l2.201" class="difflineat">@@ -524,20 +526,21 @@ Contact.prototype = {</span>
<a href="#l2.202"></a><span id="l2.202">       this._moved(aTag, newTag);</span>
<a href="#l2.203"></a><span id="l2.203">     else {</span>
<a href="#l2.204"></a><span id="l2.204">       // If we are here, the old tag is not inherited from a buddy, so</span>
<a href="#l2.205"></a><span id="l2.205">       // just remove the local tag.</span>
<a href="#l2.206"></a><span id="l2.206">       this._removeTag(aTag);</span>
<a href="#l2.207"></a><span id="l2.207">     }</span>
<a href="#l2.208"></a><span id="l2.208">   },</span>
<a href="#l2.209"></a><span id="l2.209">   _isTagInherited: function(aTag) {</span>
<a href="#l2.210"></a><span id="l2.210" class="difflineminus">-    for each (let buddy in this._buddies)</span>
<a href="#l2.211"></a><span id="l2.211" class="difflineminus">-      for each (let accountBuddy in buddy._accounts)</span>
<a href="#l2.212"></a><span id="l2.212" class="difflineplus">+    for (let buddy of this._buddies) {</span>
<a href="#l2.213"></a><span id="l2.213" class="difflineplus">+      for (let accountBuddy of buddy._accounts)</span>
<a href="#l2.214"></a><span id="l2.214">         if (accountBuddy.tag.id == aTag.id)</span>
<a href="#l2.215"></a><span id="l2.215">           return true;</span>
<a href="#l2.216"></a><span id="l2.216" class="difflineplus">+    }</span>
<a href="#l2.217"></a><span id="l2.217">     return false;</span>
<a href="#l2.218"></a><span id="l2.218">   },</span>
<a href="#l2.219"></a><span id="l2.219">   _moved: function(aOldTag, aNewTag) {</span>
<a href="#l2.220"></a><span id="l2.220">     if (this._massMove)</span>
<a href="#l2.221"></a><span id="l2.221">       return;</span>
<a href="#l2.222"></a><span id="l2.222"> </span>
<a href="#l2.223"></a><span id="l2.223">     // Avoid xpconnect wrappers.</span>
<a href="#l2.224"></a><span id="l2.224">     aNewTag = aNewTag &amp;&amp; TagsById[aNewTag.id];</span>
<a href="#l2.225"></a><span id="l2.225" class="difflineat">@@ -561,23 +564,23 @@ Contact.prototype = {</span>
<a href="#l2.226"></a><span id="l2.226">       tags.push(aNewTag);</span>
<a href="#l2.227"></a><span id="l2.227">       aNewTag._addContact(this);</span>
<a href="#l2.228"></a><span id="l2.228">     }</span>
<a href="#l2.229"></a><span id="l2.229">     this._tags = tags;</span>
<a href="#l2.230"></a><span id="l2.230"> </span>
<a href="#l2.231"></a><span id="l2.231">     // Finally, notify of the changes.</span>
<a href="#l2.232"></a><span id="l2.232">     if (shouldRemove) {</span>
<a href="#l2.233"></a><span id="l2.233">       aOldTag.notifyObservers(this, &quot;contact-moved-out&quot;);</span>
<a href="#l2.234"></a><span id="l2.234" class="difflineminus">-      for each (let observer in this._observers)</span>
<a href="#l2.235"></a><span id="l2.235" class="difflineplus">+      for (let observer of this._observers)</span>
<a href="#l2.236"></a><span id="l2.236">         observer.observe(aOldTag, &quot;contact-moved-out&quot;, null);</span>
<a href="#l2.237"></a><span id="l2.237">       Services.obs.notifyObservers(this, &quot;contact-tag-removed&quot;, aOldTag.id);</span>
<a href="#l2.238"></a><span id="l2.238">     }</span>
<a href="#l2.239"></a><span id="l2.239">     if (shouldAdd) {</span>
<a href="#l2.240"></a><span id="l2.240">       aNewTag.notifyObservers(this, &quot;contact-moved-in&quot;);</span>
<a href="#l2.241"></a><span id="l2.241" class="difflineminus">-      for each (let observer in this._observers)</span>
<a href="#l2.242"></a><span id="l2.242" class="difflineplus">+      for (let observer of this._observers)</span>
<a href="#l2.243"></a><span id="l2.243">         observer.observe(aNewTag, &quot;contact-moved-in&quot;, null);</span>
<a href="#l2.244"></a><span id="l2.244">       Services.obs.notifyObservers(this, &quot;contact-tag-added&quot;, aNewTag.id);</span>
<a href="#l2.245"></a><span id="l2.245">     }</span>
<a href="#l2.246"></a><span id="l2.246">     Services.obs.notifyObservers(this, &quot;contact-moved&quot;, null);</span>
<a href="#l2.247"></a><span id="l2.247">   },</span>
<a href="#l2.248"></a><span id="l2.248"> </span>
<a href="#l2.249"></a><span id="l2.249">   getBuddies: function(aBuddyCount) {</span>
<a href="#l2.250"></a><span id="l2.250">     if (aBuddyCount)</span>
<a href="#l2.251"></a><span id="l2.251" class="difflineat">@@ -594,22 +597,22 @@ Contact.prototype = {</span>
<a href="#l2.252"></a><span id="l2.252">     // already removed contact.</span>
<a href="#l2.253"></a><span id="l2.253">     if (aContact.id == this.id || !(this.id in ContactsById))</span>
<a href="#l2.254"></a><span id="l2.254">       throw Components.results.NS_ERROR_INVALID_ARG;</span>
<a href="#l2.255"></a><span id="l2.255"> </span>
<a href="#l2.256"></a><span id="l2.256">     this._ensureNotDummy();</span>
<a href="#l2.257"></a><span id="l2.257">     let contact = ContactsById[aContact.id]; // remove XPConnect wrapper</span>
<a href="#l2.258"></a><span id="l2.258"> </span>
<a href="#l2.259"></a><span id="l2.259">     // Copy all the contact-only tags first, otherwise they would be lost.</span>
<a href="#l2.260"></a><span id="l2.260" class="difflineminus">-    for each (let tag in contact.getTags())</span>
<a href="#l2.261"></a><span id="l2.261" class="difflineplus">+    for (let tag of contact.getTags())</span>
<a href="#l2.262"></a><span id="l2.262">       if (!contact._isTagInherited(tag))</span>
<a href="#l2.263"></a><span id="l2.263">         this.addTag(tag);</span>
<a href="#l2.264"></a><span id="l2.264"> </span>
<a href="#l2.265"></a><span id="l2.265">     // Adopt each buddy. Removing the last one will delete the contact.</span>
<a href="#l2.266"></a><span id="l2.266" class="difflineminus">-    for each (let buddy in contact.getBuddies())</span>
<a href="#l2.267"></a><span id="l2.267" class="difflineplus">+    for (let buddy of contact.getBuddies())</span>
<a href="#l2.268"></a><span id="l2.268">       buddy.contact = this;</span>
<a href="#l2.269"></a><span id="l2.269">     this._updatePreferredBuddy();</span>
<a href="#l2.270"></a><span id="l2.270">   },</span>
<a href="#l2.271"></a><span id="l2.271">   moveBuddyBefore: function(aBuddy, aBeforeBuddy) {</span>
<a href="#l2.272"></a><span id="l2.272">     let buddy = BuddiesById[aBuddy.id]; // remove XPConnect wrapper</span>
<a href="#l2.273"></a><span id="l2.273">     let oldPosition = this._buddies.indexOf(buddy);</span>
<a href="#l2.274"></a><span id="l2.274">     if (oldPosition == -1)</span>
<a href="#l2.275"></a><span id="l2.275">       throw &quot;aBuddy isn't attached to this contact&quot;;</span>
<a href="#l2.276"></a><span id="l2.276" class="difflineat">@@ -645,17 +648,17 @@ Contact.prototype = {</span>
<a href="#l2.277"></a><span id="l2.277">         let statement =</span>
<a href="#l2.278"></a><span id="l2.278">           DBConn.createStatement(&quot;DELETE FROM contacts WHERE id = :id&quot;);</span>
<a href="#l2.279"></a><span id="l2.279">         statement.params.id = this._id;</span>
<a href="#l2.280"></a><span id="l2.280">         executeAsyncThenFinalize(statement);</span>
<a href="#l2.281"></a><span id="l2.281">       }</span>
<a href="#l2.282"></a><span id="l2.282">       this._notifyObservers(&quot;removed&quot;);</span>
<a href="#l2.283"></a><span id="l2.283">       delete ContactsById[this._id];</span>
<a href="#l2.284"></a><span id="l2.284"> </span>
<a href="#l2.285"></a><span id="l2.285" class="difflineminus">-      for each (let tag in this._tags)</span>
<a href="#l2.286"></a><span id="l2.286" class="difflineplus">+      for (let tag of this._tags)</span>
<a href="#l2.287"></a><span id="l2.287">         tag._removeContact(this);</span>
<a href="#l2.288"></a><span id="l2.288">       let statement =</span>
<a href="#l2.289"></a><span id="l2.289">         DBConn.createStatement(&quot;DELETE FROM contact_tag WHERE contact_id = :id&quot;);</span>
<a href="#l2.290"></a><span id="l2.290">       statement.params.id = this._id;</span>
<a href="#l2.291"></a><span id="l2.291">       executeAsyncThenFinalize(statement);</span>
<a href="#l2.292"></a><span id="l2.292"> </span>
<a href="#l2.293"></a><span id="l2.293">       delete this._tags;</span>
<a href="#l2.294"></a><span id="l2.294">       delete this._buddies;</span>
<a href="#l2.295"></a><span id="l2.295" class="difflineat">@@ -710,24 +713,24 @@ Contact.prototype = {</span>
<a href="#l2.296"></a><span id="l2.296">     let tags = buddy.contact.getTags();</span>
<a href="#l2.297"></a><span id="l2.297"> </span>
<a href="#l2.298"></a><span id="l2.298">     // Create a new dummy contact and use it for the detached buddy.</span>
<a href="#l2.299"></a><span id="l2.299">     buddy.contact = new Contact();</span>
<a href="#l2.300"></a><span id="l2.300">     buddy.contact._notifyObservers(&quot;added&quot;);</span>
<a href="#l2.301"></a><span id="l2.301"> </span>
<a href="#l2.302"></a><span id="l2.302">     // The first tag was inherited during the contact setter.</span>
<a href="#l2.303"></a><span id="l2.303">     // This will copy the remaining tags.</span>
<a href="#l2.304"></a><span id="l2.304" class="difflineminus">-    for each (let tag in tags)</span>
<a href="#l2.305"></a><span id="l2.305" class="difflineplus">+    for (let tag of tags)</span>
<a href="#l2.306"></a><span id="l2.306">       buddy.contact.addTag(tag);</span>
<a href="#l2.307"></a><span id="l2.307"> </span>
<a href="#l2.308"></a><span id="l2.308">     return buddy.contact;</span>
<a href="#l2.309"></a><span id="l2.309">   },</span>
<a href="#l2.310"></a><span id="l2.310">   remove: function() {</span>
<a href="#l2.311"></a><span id="l2.311">     this._massRemove = true;</span>
<a href="#l2.312"></a><span id="l2.312" class="difflineminus">-    for each (let buddy in this._buddies)</span>
<a href="#l2.313"></a><span id="l2.313" class="difflineplus">+    for (let buddy of this._buddies)</span>
<a href="#l2.314"></a><span id="l2.314">       buddy.remove();</span>
<a href="#l2.315"></a><span id="l2.315">   },</span>
<a href="#l2.316"></a><span id="l2.316"> </span>
<a href="#l2.317"></a><span id="l2.317">   // imIStatusInfo implementation</span>
<a href="#l2.318"></a><span id="l2.318">   _preferredBuddy: null,</span>
<a href="#l2.319"></a><span id="l2.319">   get preferredBuddy() {</span>
<a href="#l2.320"></a><span id="l2.320">     if (!this._preferredBuddy)</span>
<a href="#l2.321"></a><span id="l2.321">       this._updatePreferredBuddy();</span>
<a href="#l2.322"></a><span id="l2.322" class="difflineat">@@ -778,17 +781,17 @@ Contact.prototype = {</span>
<a href="#l2.323"></a><span id="l2.323">           this.preferredBuddy = aBuddy;</span>
<a href="#l2.324"></a><span id="l2.324">         return;</span>
<a href="#l2.325"></a><span id="l2.325">       }</span>
<a href="#l2.326"></a><span id="l2.326">     }</span>
<a href="#l2.327"></a><span id="l2.327"> </span>
<a href="#l2.328"></a><span id="l2.328">     let preferred;</span>
<a href="#l2.329"></a><span id="l2.329">     // |this._buddies| is ordered by user preference, so in case of</span>
<a href="#l2.330"></a><span id="l2.330">     // equal availability, keep the current value of |preferred|.</span>
<a href="#l2.331"></a><span id="l2.331" class="difflineminus">-    for each (let buddy in this._buddies) {</span>
<a href="#l2.332"></a><span id="l2.332" class="difflineplus">+    for (let buddy of this._buddies) {</span>
<a href="#l2.333"></a><span id="l2.333">       if (!preferred || preferred.statusType &lt; buddy.statusType ||</span>
<a href="#l2.334"></a><span id="l2.334">           (preferred.statusType == buddy.statusType &amp;&amp;</span>
<a href="#l2.335"></a><span id="l2.335">            preferred.availabilityDetails &lt; buddy.availabilityDetails))</span>
<a href="#l2.336"></a><span id="l2.336">         preferred = buddy;</span>
<a href="#l2.337"></a><span id="l2.337">     }</span>
<a href="#l2.338"></a><span id="l2.338">     if (preferred &amp;&amp; (!this._preferredBuddy ||</span>
<a href="#l2.339"></a><span id="l2.339">                       preferred.id != this._preferredBuddy.id))</span>
<a href="#l2.340"></a><span id="l2.340">       this.preferredBuddy = preferred;</span>
<a href="#l2.341"></a><span id="l2.341" class="difflineat">@@ -848,20 +851,20 @@ Contact.prototype = {</span>
<a href="#l2.342"></a><span id="l2.342">   removeObserver: function(aObserver) {</span>
<a href="#l2.343"></a><span id="l2.343">     if (!this.hasOwnProperty(&quot;_observers&quot;))</span>
<a href="#l2.344"></a><span id="l2.344">       return;</span>
<a href="#l2.345"></a><span id="l2.345"> </span>
<a href="#l2.346"></a><span id="l2.346">     this._observers = this._observers.filter(o =&gt; o !== aObserver);</span>
<a href="#l2.347"></a><span id="l2.347">   },</span>
<a href="#l2.348"></a><span id="l2.348">   // internal calls + calls from add-ons</span>
<a href="#l2.349"></a><span id="l2.349">   notifyObservers: function(aSubject, aTopic, aData) {</span>
<a href="#l2.350"></a><span id="l2.350" class="difflineminus">-    for each (let observer in this._observers)</span>
<a href="#l2.351"></a><span id="l2.351" class="difflineplus">+    for (let observer of this._observers)</span>
<a href="#l2.352"></a><span id="l2.352">       if (&quot;observe&quot; in observer) // avoid failing on destructed XBL bindings...</span>
<a href="#l2.353"></a><span id="l2.353">         observer.observe(aSubject, aTopic, aData);</span>
<a href="#l2.354"></a><span id="l2.354" class="difflineminus">-    for each (let tag in this._tags)</span>
<a href="#l2.355"></a><span id="l2.355" class="difflineplus">+    for (let tag of this._tags)</span>
<a href="#l2.356"></a><span id="l2.356">       tag.notifyObservers(aSubject, aTopic, aData);</span>
<a href="#l2.357"></a><span id="l2.357">     Services.obs.notifyObservers(aSubject, aTopic, aData);</span>
<a href="#l2.358"></a><span id="l2.358">   },</span>
<a href="#l2.359"></a><span id="l2.359">   _notifyObservers: function(aTopic, aData) {</span>
<a href="#l2.360"></a><span id="l2.360">     this.notifyObservers(this, &quot;contact-&quot; + aTopic, aData);</span>
<a href="#l2.361"></a><span id="l2.361">   },</span>
<a href="#l2.362"></a><span id="l2.362"> </span>
<a href="#l2.363"></a><span id="l2.363">   // This is called by the imIBuddy implementations.</span>
<a href="#l2.364"></a><span id="l2.364" class="difflineat">@@ -926,17 +929,17 @@ function Buddy(aId, aKey, aName, aSrvAli</span>
<a href="#l2.365"></a><span id="l2.365"> </span>
<a href="#l2.366"></a><span id="l2.366">   this._contact._buddies.push(this);</span>
<a href="#l2.367"></a><span id="l2.367"> </span>
<a href="#l2.368"></a><span id="l2.368">   BuddiesById[this._id] = this;</span>
<a href="#l2.369"></a><span id="l2.369"> }</span>
<a href="#l2.370"></a><span id="l2.370"> Buddy.prototype = {</span>
<a href="#l2.371"></a><span id="l2.371">   get id() { return this._id; },</span>
<a href="#l2.372"></a><span id="l2.372">   destroy: function() {</span>
<a href="#l2.373"></a><span id="l2.373" class="difflineminus">-    for each (let ab in this._accounts)</span>
<a href="#l2.374"></a><span id="l2.374" class="difflineplus">+    for (let ab of this._accounts)</span>
<a href="#l2.375"></a><span id="l2.375">       ab.unInit();</span>
<a href="#l2.376"></a><span id="l2.376">     delete this._accounts;</span>
<a href="#l2.377"></a><span id="l2.377">     delete this._observers;</span>
<a href="#l2.378"></a><span id="l2.378">     delete this._preferredAccount;</span>
<a href="#l2.379"></a><span id="l2.379">   },</span>
<a href="#l2.380"></a><span id="l2.380">   get protocol() { return this._accounts[0].account.protocol; },</span>
<a href="#l2.381"></a><span id="l2.381">   get userName() { return this._name; },</span>
<a href="#l2.382"></a><span id="l2.382">   get normalizedName() { return this._key; },</span>
<a href="#l2.383"></a><span id="l2.383" class="difflineat">@@ -949,33 +952,33 @@ Buddy.prototype = {</span>
<a href="#l2.384"></a><span id="l2.384"> </span>
<a href="#l2.385"></a><span id="l2.385">     this._notifyObservers(&quot;moved-out-of-contact&quot;);</span>
<a href="#l2.386"></a><span id="l2.386">     this._contact._removeBuddy(this);</span>
<a href="#l2.387"></a><span id="l2.387"> </span>
<a href="#l2.388"></a><span id="l2.388">     this._contact = aContact;</span>
<a href="#l2.389"></a><span id="l2.389">     this._contact._buddies.push(this);</span>
<a href="#l2.390"></a><span id="l2.390"> </span>
<a href="#l2.391"></a><span id="l2.391">     // Ensure all the inherited tags are in the new contact.</span>
<a href="#l2.392"></a><span id="l2.392" class="difflineminus">-    for each (let accountBuddy in this._accounts)</span>
<a href="#l2.393"></a><span id="l2.393" class="difflineplus">+    for (let accountBuddy of this._accounts)</span>
<a href="#l2.394"></a><span id="l2.394">       this._contact.addTag(TagsById[accountBuddy.tag.id], true);</span>
<a href="#l2.395"></a><span id="l2.395"> </span>
<a href="#l2.396"></a><span id="l2.396">     let statement =</span>
<a href="#l2.397"></a><span id="l2.397">       DBConn.createStatement(&quot;UPDATE buddies SET contact_id = :contactId, &quot; +</span>
<a href="#l2.398"></a><span id="l2.398">                              &quot;position = :position &quot; +</span>
<a href="#l2.399"></a><span id="l2.399">                              &quot;WHERE id = :buddyId&quot;);</span>
<a href="#l2.400"></a><span id="l2.400">     statement.params.contactId = aContact.id &gt; 0 ? aContact.id : 0;</span>
<a href="#l2.401"></a><span id="l2.401">     statement.params.position = aContact._buddies.length - 1;</span>
<a href="#l2.402"></a><span id="l2.402">     statement.params.buddyId = this.id;</span>
<a href="#l2.403"></a><span id="l2.403">     executeAsyncThenFinalize(statement);</span>
<a href="#l2.404"></a><span id="l2.404"> </span>
<a href="#l2.405"></a><span id="l2.405">     this._notifyObservers(&quot;moved-into-contact&quot;);</span>
<a href="#l2.406"></a><span id="l2.406">     return aContact;</span>
<a href="#l2.407"></a><span id="l2.407">   },</span>
<a href="#l2.408"></a><span id="l2.408">   _hasAccountBuddy: function(aAccountId, aTagId) {</span>
<a href="#l2.409"></a><span id="l2.409" class="difflineminus">-    for each (let ab in this._accounts) {</span>
<a href="#l2.410"></a><span id="l2.410" class="difflineplus">+    for (let ab of this._accounts) {</span>
<a href="#l2.411"></a><span id="l2.411">       if (ab.account.numericId == aAccountId &amp;&amp; ab.tag.id == aTagId)</span>
<a href="#l2.412"></a><span id="l2.412">         return true;</span>
<a href="#l2.413"></a><span id="l2.413">     }</span>
<a href="#l2.414"></a><span id="l2.414">     return false;</span>
<a href="#l2.415"></a><span id="l2.415">   },</span>
<a href="#l2.416"></a><span id="l2.416">   getAccountBuddies: function(aAccountBuddyCount) {</span>
<a href="#l2.417"></a><span id="l2.417">     if (aAccountBuddyCount)</span>
<a href="#l2.418"></a><span id="l2.418">       aAccountBuddyCount.value = this._accounts.length;</span>
<a href="#l2.419"></a><span id="l2.419" class="difflineat">@@ -991,17 +994,17 @@ Buddy.prototype = {</span>
<a href="#l2.420"></a><span id="l2.420">     }</span>
<a href="#l2.421"></a><span id="l2.421"> </span>
<a href="#l2.422"></a><span id="l2.422">     if (!this._preferredAccount)</span>
<a href="#l2.423"></a><span id="l2.423">       this._preferredAccount = aAccountBuddy;</span>
<a href="#l2.424"></a><span id="l2.424">   },</span>
<a href="#l2.425"></a><span id="l2.425">   get _empty() { return this._accounts.length == 0; },</span>
<a href="#l2.426"></a><span id="l2.426"> </span>
<a href="#l2.427"></a><span id="l2.427">   remove: function() {</span>
<a href="#l2.428"></a><span id="l2.428" class="difflineminus">-    for each (let account in this._accounts)</span>
<a href="#l2.429"></a><span id="l2.429" class="difflineplus">+    for (let account of this._accounts)</span>
<a href="#l2.430"></a><span id="l2.430">       account.remove();</span>
<a href="#l2.431"></a><span id="l2.431">   },</span>
<a href="#l2.432"></a><span id="l2.432"> </span>
<a href="#l2.433"></a><span id="l2.433">   // imIStatusInfo implementation</span>
<a href="#l2.434"></a><span id="l2.434">   _preferredAccount: null,</span>
<a href="#l2.435"></a><span id="l2.435">   get preferredAccountBuddy() { return this._preferredAccount; },</span>
<a href="#l2.436"></a><span id="l2.436">   _isPreferredAccount: function(aAccountBuddy) {</span>
<a href="#l2.437"></a><span id="l2.437">     if (aAccountBuddy.account.numericId != this._preferredAccount.account.numericId)</span>
<a href="#l2.438"></a><span id="l2.438" class="difflineat">@@ -1049,17 +1052,17 @@ Buddy.prototype = {</span>
<a href="#l2.439"></a><span id="l2.439">              aAccount.availabilityDetails &gt; this._availabilityDetails))</span>
<a href="#l2.440"></a><span id="l2.440">           this.preferredAccount = aAccount;</span>
<a href="#l2.441"></a><span id="l2.441">         return;</span>
<a href="#l2.442"></a><span id="l2.442">       }</span>
<a href="#l2.443"></a><span id="l2.443">     }</span>
<a href="#l2.444"></a><span id="l2.444"> </span>
<a href="#l2.445"></a><span id="l2.445">     let preferred;</span>
<a href="#l2.446"></a><span id="l2.446">     //TODO take into account the order of the account-manager list.</span>
<a href="#l2.447"></a><span id="l2.447" class="difflineminus">-    for each (let account in this._accounts) {</span>
<a href="#l2.448"></a><span id="l2.448" class="difflineplus">+    for (let account of this._accounts) {</span>
<a href="#l2.449"></a><span id="l2.449">       if (!preferred || preferred.statusType &lt; account.statusType ||</span>
<a href="#l2.450"></a><span id="l2.450">           (preferred.statusType == account.statusType &amp;&amp;</span>
<a href="#l2.451"></a><span id="l2.451">            preferred.availabilityDetails &lt; account.availabilityDetails))</span>
<a href="#l2.452"></a><span id="l2.452">         preferred = account;</span>
<a href="#l2.453"></a><span id="l2.453">     }</span>
<a href="#l2.454"></a><span id="l2.454">     if (!this._preferredAccount) {</span>
<a href="#l2.455"></a><span id="l2.455">       if (preferred)</span>
<a href="#l2.456"></a><span id="l2.456">         this.preferredAccount = preferred;</span>
<a href="#l2.457"></a><span id="l2.457" class="difflineat">@@ -1123,17 +1126,17 @@ Buddy.prototype = {</span>
<a href="#l2.458"></a><span id="l2.458">   removeObserver: function(aObserver) {</span>
<a href="#l2.459"></a><span id="l2.459">     if (!this._observers)</span>
<a href="#l2.460"></a><span id="l2.460">       return;</span>
<a href="#l2.461"></a><span id="l2.461">     this._observers = this._observers.filter(o =&gt; o !== aObserver);</span>
<a href="#l2.462"></a><span id="l2.462">   },</span>
<a href="#l2.463"></a><span id="l2.463">   // internal calls + calls from add-ons</span>
<a href="#l2.464"></a><span id="l2.464">   notifyObservers: function(aSubject, aTopic, aData) {</span>
<a href="#l2.465"></a><span id="l2.465">     try {</span>
<a href="#l2.466"></a><span id="l2.466" class="difflineminus">-      for each (let observer in this._observers)</span>
<a href="#l2.467"></a><span id="l2.467" class="difflineplus">+      for (let observer of this._observers)</span>
<a href="#l2.468"></a><span id="l2.468">         observer.observe(aSubject, aTopic, aData);</span>
<a href="#l2.469"></a><span id="l2.469">       this._contact._observe(aSubject, aTopic, aData);</span>
<a href="#l2.470"></a><span id="l2.470">     } catch (e) {</span>
<a href="#l2.471"></a><span id="l2.471">       Cu.reportError(e);</span>
<a href="#l2.472"></a><span id="l2.472">     }</span>
<a href="#l2.473"></a><span id="l2.473">   },</span>
<a href="#l2.474"></a><span id="l2.474">   _notifyObservers: function(aTopic, aData) {</span>
<a href="#l2.475"></a><span id="l2.475">     this.notifyObservers(this, &quot;buddy-&quot; + aTopic, aData);</span>
<a href="#l2.476"></a><span id="l2.476" class="difflineat">@@ -1306,18 +1309,20 @@ ContactsService.prototype = {</span>
<a href="#l2.477"></a><span id="l2.477">     }</span>
<a href="#l2.478"></a><span id="l2.478">     otherContactsTag._initHiddenTags();</span>
<a href="#l2.479"></a><span id="l2.479">   },</span>
<a href="#l2.480"></a><span id="l2.480">   unInitContacts: function() {</span>
<a href="#l2.481"></a><span id="l2.481">     Tags = [];</span>
<a href="#l2.482"></a><span id="l2.482">     TagsById = { };</span>
<a href="#l2.483"></a><span id="l2.483">     // Avoid shutdown leaks caused by references to native components</span>
<a href="#l2.484"></a><span id="l2.484">     // implementing prplIAccountBuddy.</span>
<a href="#l2.485"></a><span id="l2.485" class="difflineminus">-    for each (let buddy in BuddiesById)</span>
<a href="#l2.486"></a><span id="l2.486" class="difflineplus">+    for (let buddyId in BuddiesById) {</span>
<a href="#l2.487"></a><span id="l2.487" class="difflineplus">+      let buddy = BuddiesById[buddyId];</span>
<a href="#l2.488"></a><span id="l2.488">       buddy.destroy();</span>
<a href="#l2.489"></a><span id="l2.489" class="difflineplus">+    }</span>
<a href="#l2.490"></a><span id="l2.490">     BuddiesById = { };</span>
<a href="#l2.491"></a><span id="l2.491">     ContactsById = { };</span>
<a href="#l2.492"></a><span id="l2.492">   },</span>
<a href="#l2.493"></a><span id="l2.493"> </span>
<a href="#l2.494"></a><span id="l2.494">   getContactById: aId =&gt; ContactsById[aId],</span>
<a href="#l2.495"></a><span id="l2.495">   // Get an array of all existing contacts.</span>
<a href="#l2.496"></a><span id="l2.496">   getContacts: function(aContactCount) {</span>
<a href="#l2.497"></a><span id="l2.497">     let contacts = Object.keys(ContactsById)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/chat/components/src/imConversations.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/chat/components/src/imConversations.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -188,17 +188,17 @@ UIConversation.prototype = {</span>
<a href="#l3.4"></a><span id="l3.4">     this._notifyUnreadCountChanged();</span>
<a href="#l3.5"></a><span id="l3.5">   },</span>
<a href="#l3.6"></a><span id="l3.6">   _lastNotifiedUnreadCount: 0,</span>
<a href="#l3.7"></a><span id="l3.7">   _notifyUnreadCountChanged: function() {</span>
<a href="#l3.8"></a><span id="l3.8">     if (this._unreadIncomingMessageCount == this._lastNotifiedUnreadCount)</span>
<a href="#l3.9"></a><span id="l3.9">       return;</span>
<a href="#l3.10"></a><span id="l3.10"> </span>
<a href="#l3.11"></a><span id="l3.11">     this._lastNotifiedUnreadCount = this._unreadIncomingMessageCount;</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-    for each (let observer in this._observers)</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+    for (let observer of this._observers)</span>
<a href="#l3.14"></a><span id="l3.14">       observer.observe(this, &quot;unread-message-count-changed&quot;,</span>
<a href="#l3.15"></a><span id="l3.15">                        this._unreadIncomingMessageCount.toString());</span>
<a href="#l3.16"></a><span id="l3.16">   },</span>
<a href="#l3.17"></a><span id="l3.17">   getMessages: function(aMessageCount) {</span>
<a href="#l3.18"></a><span id="l3.18">     if (aMessageCount)</span>
<a href="#l3.19"></a><span id="l3.19">       aMessageCount.value = this._messages.length;</span>
<a href="#l3.20"></a><span id="l3.20">     return this._messages;</span>
<a href="#l3.21"></a><span id="l3.21">   },</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineat">@@ -377,29 +377,33 @@ UIConversation.prototype = {</span>
<a href="#l3.23"></a><span id="l3.23">       om = new OutgoingMessage(msg, this.target);</span>
<a href="#l3.24"></a><span id="l3.24">       this.notifyObservers(om, &quot;sending-message&quot;);</span>
<a href="#l3.25"></a><span id="l3.25">       if (om.cancelled)</span>
<a href="#l3.26"></a><span id="l3.26">         continue;</span>
<a href="#l3.27"></a><span id="l3.27">       this.target.sendMsg(om.message);</span>
<a href="#l3.28"></a><span id="l3.28">     }</span>
<a href="#l3.29"></a><span id="l3.29">   },</span>
<a href="#l3.30"></a><span id="l3.30">   unInit: function() {</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-    for each (let conv in this._prplConv)</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+    for (let id in this._prplConv) {</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+      let conv = this._prplConv[id];</span>
<a href="#l3.34"></a><span id="l3.34">       gConversationsService.forgetConversation(conv);</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+    }</span>
<a href="#l3.36"></a><span id="l3.36">     if (this._observedContact) {</span>
<a href="#l3.37"></a><span id="l3.37">       this._observedContact.removeObserver(this);</span>
<a href="#l3.38"></a><span id="l3.38">       delete this._observedContact;</span>
<a href="#l3.39"></a><span id="l3.39">     }</span>
<a href="#l3.40"></a><span id="l3.40">     this._prplConv = {}; // Prevent .close from failing.</span>
<a href="#l3.41"></a><span id="l3.41">     delete this._currentTargetId;</span>
<a href="#l3.42"></a><span id="l3.42">     this.notifyObservers(this, &quot;ui-conversation-destroyed&quot;);</span>
<a href="#l3.43"></a><span id="l3.43">   },</span>
<a href="#l3.44"></a><span id="l3.44">   close: function() {</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineminus">-    for each (let conv in this._prplConv)</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineplus">+    for (let id in this._prplConv) {</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineplus">+      let conv = this._prplConv[id];</span>
<a href="#l3.48"></a><span id="l3.48">       conv.close();</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineplus">+    }</span>
<a href="#l3.50"></a><span id="l3.50">     if (!this.hasOwnProperty(&quot;_currentTargetId&quot;))</span>
<a href="#l3.51"></a><span id="l3.51">       return;</span>
<a href="#l3.52"></a><span id="l3.52">     delete this._currentTargetId;</span>
<a href="#l3.53"></a><span id="l3.53">     this.notifyObservers(this, &quot;ui-conversation-closed&quot;);</span>
<a href="#l3.54"></a><span id="l3.54">     Services.obs.notifyObservers(this, &quot;ui-conversation-closed&quot;, null);</span>
<a href="#l3.55"></a><span id="l3.55">   },</span>
<a href="#l3.56"></a><span id="l3.56">   addObserver: function(aObserver) {</span>
<a href="#l3.57"></a><span id="l3.57">     if (this._observers.indexOf(aObserver) == -1)</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineat">@@ -420,17 +424,17 @@ UIConversation.prototype = {</span>
<a href="#l3.59"></a><span id="l3.59">       ++this._unreadMessageCount;</span>
<a href="#l3.60"></a><span id="l3.60">       if (aSubject.incoming &amp;&amp; !aSubject.system) {</span>
<a href="#l3.61"></a><span id="l3.61">         ++this._unreadIncomingMessageCount;</span>
<a href="#l3.62"></a><span id="l3.62">         if (!this.isChat || aSubject.containsNick)</span>
<a href="#l3.63"></a><span id="l3.63">           ++this._unreadTargetedMessageCount;</span>
<a href="#l3.64"></a><span id="l3.64">       }</span>
<a href="#l3.65"></a><span id="l3.65">     }</span>
<a href="#l3.66"></a><span id="l3.66"> </span>
<a href="#l3.67"></a><span id="l3.67" class="difflineminus">-    for each (let observer in this._observers) {</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineplus">+    for (let observer of this._observers) {</span>
<a href="#l3.69"></a><span id="l3.69">       if (!observer.observe &amp;&amp; this._observers.indexOf(observer) == -1)</span>
<a href="#l3.70"></a><span id="l3.70">         continue; // observer removed by a previous call to another observer.</span>
<a href="#l3.71"></a><span id="l3.71">       observer.observe(aSubject, aTopic, aData);</span>
<a href="#l3.72"></a><span id="l3.72">     }</span>
<a href="#l3.73"></a><span id="l3.73">     this._notifyUnreadCountChanged();</span>
<a href="#l3.74"></a><span id="l3.74"> </span>
<a href="#l3.75"></a><span id="l3.75">     if (aTopic == &quot;new-text&quot;) {</span>
<a href="#l3.76"></a><span id="l3.76">       Services.obs.notifyObservers(aSubject, aTopic, aData);</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineat">@@ -481,34 +485,36 @@ ConversationsService.prototype = {</span>
<a href="#l3.78"></a><span id="l3.78"> </span>
<a href="#l3.79"></a><span id="l3.79">   unInitConversations: function() {</span>
<a href="#l3.80"></a><span id="l3.80">     let UIConvs = this.getUIConversations();</span>
<a href="#l3.81"></a><span id="l3.81">     for (let UIConv of UIConvs)</span>
<a href="#l3.82"></a><span id="l3.82">       UIConv.unInit();</span>
<a href="#l3.83"></a><span id="l3.83">     delete this._uiConv;</span>
<a href="#l3.84"></a><span id="l3.84">     delete this._uiConvByContactId;</span>
<a href="#l3.85"></a><span id="l3.85">     // This should already be empty, but just to be sure...</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineminus">-    for each (let prplConv in this._prplConversations)</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineplus">+    for (let prplConv of this._prplConversations)</span>
<a href="#l3.88"></a><span id="l3.88">       prplConv.unInit();</span>
<a href="#l3.89"></a><span id="l3.89">     delete this._prplConversations;</span>
<a href="#l3.90"></a><span id="l3.90">     Services.obs.removeObserver(this, &quot;account-disconnecting&quot;);</span>
<a href="#l3.91"></a><span id="l3.91">     Services.obs.removeObserver(this, &quot;account-connected&quot;);</span>
<a href="#l3.92"></a><span id="l3.92">     Services.obs.removeObserver(this, &quot;account-buddy-added&quot;);</span>
<a href="#l3.93"></a><span id="l3.93">     Services.obs.removeObserver(this, &quot;account-buddy-removed&quot;);</span>
<a href="#l3.94"></a><span id="l3.94">   },</span>
<a href="#l3.95"></a><span id="l3.95"> </span>
<a href="#l3.96"></a><span id="l3.96">   observe: function(aSubject, aTopic, aData) {</span>
<a href="#l3.97"></a><span id="l3.97">     if (aTopic == &quot;account-connected&quot;) {</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineminus">-      for each (let conv in this._uiConv) {</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineplus">+      for (let id in this._uiConv) {</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineplus">+        let conv = this._uiConv[id];</span>
<a href="#l3.101"></a><span id="l3.101">         if (conv.account.id == aSubject.id)</span>
<a href="#l3.102"></a><span id="l3.102">           conv.connected();</span>
<a href="#l3.103"></a><span id="l3.103">       }</span>
<a href="#l3.104"></a><span id="l3.104">     }</span>
<a href="#l3.105"></a><span id="l3.105">     else if (aTopic == &quot;account-disconnecting&quot;) {</span>
<a href="#l3.106"></a><span id="l3.106" class="difflineminus">-      for each (let conv in this._uiConv) {</span>
<a href="#l3.107"></a><span id="l3.107" class="difflineplus">+      for (let id in this._uiConv) {</span>
<a href="#l3.108"></a><span id="l3.108" class="difflineplus">+        let conv = this._uiConv[id];</span>
<a href="#l3.109"></a><span id="l3.109">         if (conv.account.id == aSubject.id)</span>
<a href="#l3.110"></a><span id="l3.110">           conv.disconnecting();</span>
<a href="#l3.111"></a><span id="l3.111">       }</span>
<a href="#l3.112"></a><span id="l3.112">     }</span>
<a href="#l3.113"></a><span id="l3.113">     else if (aTopic == &quot;account-buddy-added&quot;) {</span>
<a href="#l3.114"></a><span id="l3.114">       let accountBuddy = aSubject;</span>
<a href="#l3.115"></a><span id="l3.115">       let prplConversation =</span>
<a href="#l3.116"></a><span id="l3.116">         this.getConversationByNameAndAccount(accountBuddy.normalizedName,</span>
<a href="#l3.117"></a><span id="l3.117" class="difflineat">@@ -629,17 +635,17 @@ ConversationsService.prototype = {</span>
<a href="#l3.118"></a><span id="l3.118">     throw &quot;Unknown conversation&quot;;</span>
<a href="#l3.119"></a><span id="l3.119">   },</span>
<a href="#l3.120"></a><span id="l3.120">   getUIConversationByContactId: function(aId) {</span>
<a href="#l3.121"></a><span id="l3.121">     return (aId in this._uiConvByContactId) ? this._uiConvByContactId[aId] : null;</span>
<a href="#l3.122"></a><span id="l3.122">   },</span>
<a href="#l3.123"></a><span id="l3.123"> </span>
<a href="#l3.124"></a><span id="l3.124">   getConversations: function() { return new nsSimpleEnumerator(this._prplConversations); },</span>
<a href="#l3.125"></a><span id="l3.125">   getConversationById: function(aId) {</span>
<a href="#l3.126"></a><span id="l3.126" class="difflineminus">-    for each (let conv in this._prplConversations)</span>
<a href="#l3.127"></a><span id="l3.127" class="difflineplus">+    for (let conv of this._prplConversations)</span>
<a href="#l3.128"></a><span id="l3.128">       if (conv.id == aId)</span>
<a href="#l3.129"></a><span id="l3.129">         return conv;</span>
<a href="#l3.130"></a><span id="l3.130">     return null;</span>
<a href="#l3.131"></a><span id="l3.131">   },</span>
<a href="#l3.132"></a><span id="l3.132">   getConversationByNameAndAccount: function(aName, aAccount, aIsChat) {</span>
<a href="#l3.133"></a><span id="l3.133">     let normalizedName = aAccount.normalize(aName);</span>
<a href="#l3.134"></a><span id="l3.134">     for (let conv of this._prplConversations) {</span>
<a href="#l3.135"></a><span id="l3.135">       if (aAccount.normalize(conv.name) == normalizedName &amp;&amp;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/chat/components/src/imCore.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/chat/components/src/imCore.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -229,17 +229,17 @@ UserStatus.prototype = {</span>
<a href="#l4.4"></a><span id="l4.4">   addObserver: function(aObserver) {</span>
<a href="#l4.5"></a><span id="l4.5">     if (this._observers.indexOf(aObserver) == -1)</span>
<a href="#l4.6"></a><span id="l4.6">       this._observers.push(aObserver);</span>
<a href="#l4.7"></a><span id="l4.7">   },</span>
<a href="#l4.8"></a><span id="l4.8">   removeObserver: function(aObserver) {</span>
<a href="#l4.9"></a><span id="l4.9">     this._observers = this._observers.filter(o =&gt; o !== aObserver);</span>
<a href="#l4.10"></a><span id="l4.10">   },</span>
<a href="#l4.11"></a><span id="l4.11">   _notifyObservers: function(aTopic, aData) {</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-    for each (let observer in this._observers)</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+    for (let observer of this._observers)</span>
<a href="#l4.14"></a><span id="l4.14">       observer.observe(this, aTopic, aData);</span>
<a href="#l4.15"></a><span id="l4.15">   }</span>
<a href="#l4.16"></a><span id="l4.16"> };</span>
<a href="#l4.17"></a><span id="l4.17"> </span>
<a href="#l4.18"></a><span id="l4.18"> var gCoreService;</span>
<a href="#l4.19"></a><span id="l4.19"> function CoreService() { gCoreService = this; }</span>
<a href="#l4.20"></a><span id="l4.20"> CoreService.prototype = {</span>
<a href="#l4.21"></a><span id="l4.21">   globalUserStatus: null,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/chat/content/convbrowser.xml</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/chat/content/convbrowser.xml</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -1180,23 +1180,23 @@</span>
<a href="#l5.4"></a><span id="l5.4">           // set the missing fields below (onStateChange).</span>
<a href="#l5.5"></a><span id="l5.5">           var fieldsToSwap = [&quot;_docShell&quot;, &quot;_fastFind&quot;, &quot;_contentWindow&quot;,</span>
<a href="#l5.6"></a><span id="l5.6">                               &quot;_webNavigation&quot;, &quot;_theme&quot;, &quot;_autoScrollEnabled&quot;,</span>
<a href="#l5.7"></a><span id="l5.7">                               &quot;_lastElement&quot;, &quot;_lastMessage&quot;, &quot;_lastMessageIsContext&quot;,</span>
<a href="#l5.8"></a><span id="l5.8">                               &quot;_firstNonContextElt&quot;];</span>
<a href="#l5.9"></a><span id="l5.9"> </span>
<a href="#l5.10"></a><span id="l5.10">           var ourFieldValues = {};</span>
<a href="#l5.11"></a><span id="l5.11">           var otherFieldValues = {};</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-          for each (var field in fieldsToSwap) {</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+          for (var field of fieldsToSwap) {</span>
<a href="#l5.14"></a><span id="l5.14">             ourFieldValues[field] = this[field];</span>
<a href="#l5.15"></a><span id="l5.15">             otherFieldValues[field] = aOtherBrowser[field];</span>
<a href="#l5.16"></a><span id="l5.16">           }</span>
<a href="#l5.17"></a><span id="l5.17">           this.QueryInterface(Components.interfaces.nsIFrameLoaderOwner)</span>
<a href="#l5.18"></a><span id="l5.18">               .swapFrameLoaders(aOtherBrowser);</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineminus">-          for each (var field in fieldsToSwap) {</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+          for (var field of fieldsToSwap) {</span>
<a href="#l5.21"></a><span id="l5.21">             this[field] = otherFieldValues[field];</span>
<a href="#l5.22"></a><span id="l5.22">             aOtherBrowser[field] = ourFieldValues[field];</span>
<a href="#l5.23"></a><span id="l5.23">           }</span>
<a href="#l5.24"></a><span id="l5.24"> </span>
<a href="#l5.25"></a><span id="l5.25">           this.initMagicCopy();</span>
<a href="#l5.26"></a><span id="l5.26">         ]]&gt;</span>
<a href="#l5.27"></a><span id="l5.27">         &lt;/body&gt;</span>
<a href="#l5.28"></a><span id="l5.28">       &lt;/method&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/chat/content/imtooltip.xml</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/chat/content/imtooltip.xml</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -296,17 +296,17 @@</span>
<a href="#l6.4"></a><span id="l6.4">            return true;</span>
<a href="#l6.5"></a><span id="l6.5"> </span>
<a href="#l6.6"></a><span id="l6.6">          let buddiesElt = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;,</span>
<a href="#l6.7"></a><span id="l6.7">                                                                   &quot;buddies&quot;);</span>
<a href="#l6.8"></a><span id="l6.8">          let sep = document.createElement(&quot;separator&quot;);</span>
<a href="#l6.9"></a><span id="l6.9">          sep.setAttribute(&quot;class&quot;, &quot;groove tooltipSeparator&quot;);</span>
<a href="#l6.10"></a><span id="l6.10">          buddiesElt.appendChild(sep);</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-         for each (let buddy in buddies) {</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+         for (let buddy of buddies) {</span>
<a href="#l6.14"></a><span id="l6.14">            let buddyElt = document.createElement(&quot;buddy&quot;);</span>
<a href="#l6.15"></a><span id="l6.15">            buddiesElt.appendChild(buddyElt);</span>
<a href="#l6.16"></a><span id="l6.16">            buddyElt.getBoundingClientRect(); // force binding attachment</span>
<a href="#l6.17"></a><span id="l6.17">            buddyElt.build(buddy, this);</span>
<a href="#l6.18"></a><span id="l6.18">          }</span>
<a href="#l6.19"></a><span id="l6.19"> </span>
<a href="#l6.20"></a><span id="l6.20">          return true;</span>
<a href="#l6.21"></a><span id="l6.21">        ]]&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/chat/modules/imContentSink.jsm</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/chat/modules/imContentSink.jsm</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -311,17 +311,17 @@ function cleanupNode(aNode, aRules, aTex</span>
<a href="#l7.4"></a><span id="l7.4">       //     For instance, adding an &lt;img&gt; tag for a smiley adds 2 nodes:</span>
<a href="#l7.5"></a><span id="l7.5">       //      - the img tag</span>
<a href="#l7.6"></a><span id="l7.6">       //      - the new text node after the img tag.</span>
<a href="#l7.7"></a><span id="l7.7"> </span>
<a href="#l7.8"></a><span id="l7.8">       // This is the number of nodes we need to process. If new nodes</span>
<a href="#l7.9"></a><span id="l7.9">       // are created, the next text modifier functions have more nodes</span>
<a href="#l7.10"></a><span id="l7.10">       // to process.</span>
<a href="#l7.11"></a><span id="l7.11">       let textNodeCount = 1;</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-      for each (let modifier in aTextModifiers)</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+      for (let modifier of aTextModifiers)</span>
<a href="#l7.14"></a><span id="l7.14">         for (let n = 0; n &lt; textNodeCount; ++n) {</span>
<a href="#l7.15"></a><span id="l7.15">           let textNode = aNode.childNodes[i + n];</span>
<a href="#l7.16"></a><span id="l7.16"> </span>
<a href="#l7.17"></a><span id="l7.17">           // If we are processing nodes created by one of the previous</span>
<a href="#l7.18"></a><span id="l7.18">           // text modifier function, some of the nodes are likely not</span>
<a href="#l7.19"></a><span id="l7.19">           // text node, skip them.</span>
<a href="#l7.20"></a><span id="l7.20">           if (!(textNode instanceof Components.interfaces.nsIDOMText))</span>
<a href="#l7.21"></a><span id="l7.21">             continue;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/chat/modules/imSmileys.jsm</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/chat/modules/imSmileys.jsm</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -84,18 +84,18 @@ function getTheme(aName)</span>
<a href="#l8.4"></a><span id="l8.4">                                           Components.interfaces.nsILoadInfo.SEC_NORMAL,</span>
<a href="#l8.5"></a><span id="l8.5">                                           Components.interfaces.nsIContentPolicy.TYPE_IMAGE);</span>
<a href="#l8.6"></a><span id="l8.6">     let stream = channel.open();</span>
<a href="#l8.7"></a><span id="l8.7">     let json = Components.classes[&quot;@mozilla.org/dom/json;1&quot;]</span>
<a href="#l8.8"></a><span id="l8.8">                          .createInstance(Components.interfaces.nsIJSON);</span>
<a href="#l8.9"></a><span id="l8.9">     theme.json = json.decodeFromStream(stream, stream.available());</span>
<a href="#l8.10"></a><span id="l8.10">     stream.close();</span>
<a href="#l8.11"></a><span id="l8.11">     theme.iconsHash = {};</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-    for each (let smiley in theme.json.smileys) {</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-      for each (let textCode in smiley.textCodes)</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+    for (let smiley of theme.json.smileys) {</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+      for (let textCode of smiley.textCodes)</span>
<a href="#l8.16"></a><span id="l8.16">         theme.iconsHash[textCode] = smiley;</span>
<a href="#l8.17"></a><span id="l8.17">     }</span>
<a href="#l8.18"></a><span id="l8.18">   } catch(e) {</span>
<a href="#l8.19"></a><span id="l8.19">     Components.utils.reportError(e);</span>
<a href="#l8.20"></a><span id="l8.20">   }</span>
<a href="#l8.21"></a><span id="l8.21">   return theme;</span>
<a href="#l8.22"></a><span id="l8.22"> }</span>
<a href="#l8.23"></a><span id="l8.23"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/chat/modules/imTextboxUtils.jsm</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/chat/modules/imTextboxUtils.jsm</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -42,27 +42,27 @@ var MessageFormat = {</span>
<a href="#l9.4"></a><span id="l9.4">     this._observedPrefs = [</span>
<a href="#l9.5"></a><span id="l9.5">       &quot;font.language.group&quot;,</span>
<a href="#l9.6"></a><span id="l9.6">       &quot;font.default.&quot; + langGroup,</span>
<a href="#l9.7"></a><span id="l9.7">       &quot;font.name.&quot; + fontGroup + &quot;.&quot; + langGroup,</span>
<a href="#l9.8"></a><span id="l9.8">       &quot;font.size.variable.&quot; + langGroup,</span>
<a href="#l9.9"></a><span id="l9.9">       &quot;browser.display.foreground_color&quot;,</span>
<a href="#l9.10"></a><span id="l9.10">       &quot;browser.display.use_system_colors&quot;</span>
<a href="#l9.11"></a><span id="l9.11">     ];</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-    for each (let name in this._observedPrefs)</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+    for (let name of this._observedPrefs)</span>
<a href="#l9.14"></a><span id="l9.14">       Services.prefs.addObserver(name, this, false);</span>
<a href="#l9.15"></a><span id="l9.15">   },</span>
<a href="#l9.16"></a><span id="l9.16">   unregisterObservers: function mf_unregisterObservers() {</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineminus">-    for each (let name in this._observedPrefs)</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+    for (let name of this._observedPrefs)</span>
<a href="#l9.19"></a><span id="l9.19">       Services.prefs.removeObserver(name, this);</span>
<a href="#l9.20"></a><span id="l9.20">     this._observedPrefs = [];</span>
<a href="#l9.21"></a><span id="l9.21">   },</span>
<a href="#l9.22"></a><span id="l9.22">   observe: function(aSubject, aTopic, aMsg) {</span>
<a href="#l9.23"></a><span id="l9.23">     this.getValues();</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineminus">-    for each (let textbox in this._textboxes)</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineplus">+    for (let textbox of this._textboxes)</span>
<a href="#l9.26"></a><span id="l9.26">       this.styleTextbox(textbox);</span>
<a href="#l9.27"></a><span id="l9.27">   },</span>
<a href="#l9.28"></a><span id="l9.28">   _getColor: function mf__getColor() {</span>
<a href="#l9.29"></a><span id="l9.29">     if (this._values.foregroundColorIsDefault || this._values.useSystemColor)</span>
<a href="#l9.30"></a><span id="l9.30">       return &quot;&quot;;</span>
<a href="#l9.31"></a><span id="l9.31">     return this._values.foregroundColor;</span>
<a href="#l9.32"></a><span id="l9.32">   },</span>
<a href="#l9.33"></a><span id="l9.33">   styleTextbox: function mf_styleTextbox(aTextbox) {</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineat">@@ -159,12 +159,12 @@ var TextboxSpellChecker = {</span>
<a href="#l9.35"></a><span id="l9.35">     if (index != -1)</span>
<a href="#l9.36"></a><span id="l9.36">       this._textboxes.splice(index, 1);</span>
<a href="#l9.37"></a><span id="l9.37"> </span>
<a href="#l9.38"></a><span id="l9.38">     if (!this._textboxes.length)</span>
<a href="#l9.39"></a><span id="l9.39">       Services.prefs.removeObserver(this._spellCheckPrefName, this);</span>
<a href="#l9.40"></a><span id="l9.40">   },</span>
<a href="#l9.41"></a><span id="l9.41">   observe: function tsc_observe(aSubject, aTopic, aMsg) {</span>
<a href="#l9.42"></a><span id="l9.42">     this.getValue();</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineminus">-    for each (let textbox in this._textboxes)</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineplus">+    for (let textbox of this._textboxes)</span>
<a href="#l9.45"></a><span id="l9.45">       this.applyValue(textbox);</span>
<a href="#l9.46"></a><span id="l9.46">   }</span>
<a href="#l9.47"></a><span id="l9.47"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/chat/modules/imXPCOMUtils.jsm</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/chat/modules/imXPCOMUtils.jsm</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -113,17 +113,17 @@ XPCOMUtils.defineLazyGetter(Cu.getGlobal</span>
<a href="#l10.4"></a><span id="l10.4">     QueryInterface: XPCOMUtils.generateQI([Ci.nsIObserver,</span>
<a href="#l10.5"></a><span id="l10.5">                                            Ci.nsISupportsWeakReference]),</span>
<a href="#l10.6"></a><span id="l10.6">   };</span>
<a href="#l10.7"></a><span id="l10.7"> </span>
<a href="#l10.8"></a><span id="l10.8">   // Add weak pref observer to see log level pref changes.</span>
<a href="#l10.9"></a><span id="l10.9">   Services.prefs.addObserver(kLogLevelPref, logLevels, true /* weak */);</span>
<a href="#l10.10"></a><span id="l10.10"> </span>
<a href="#l10.11"></a><span id="l10.11">   // Initialize with existing log level prefs.</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-  for each (let pref in Services.prefs.getChildList(kLogLevelPref)) {</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+  for (let pref of Services.prefs.getChildList(kLogLevelPref)) {</span>
<a href="#l10.14"></a><span id="l10.14">     if (Services.prefs.getPrefType(pref) == Services.prefs.PREF_INT)</span>
<a href="#l10.15"></a><span id="l10.15">       logLevels[&quot;level&quot; + pref.substr(kLogLevelPref.length)] = Services.prefs.getIntPref(pref);</span>
<a href="#l10.16"></a><span id="l10.16">   }</span>
<a href="#l10.17"></a><span id="l10.17"> </span>
<a href="#l10.18"></a><span id="l10.18">   // Let environment variables override prefs.</span>
<a href="#l10.19"></a><span id="l10.19">   Cc[&quot;@mozilla.org/process/environment;1&quot;]</span>
<a href="#l10.20"></a><span id="l10.20">     .getService(Ci.nsIEnvironment)</span>
<a href="#l10.21"></a><span id="l10.21">     .get(&quot;PRPL_LOG&quot;)</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineat">@@ -166,17 +166,17 @@ function executeSoon(aFunction)</span>
<a href="#l10.23"></a><span id="l10.23"> function ClassInfo(aInterfaces, aDescription = &quot;JS Proto Object&quot;)</span>
<a href="#l10.24"></a><span id="l10.24"> {</span>
<a href="#l10.25"></a><span id="l10.25">   if (!(this instanceof ClassInfo))</span>
<a href="#l10.26"></a><span id="l10.26">     return new ClassInfo(aInterfaces, aDescription);</span>
<a href="#l10.27"></a><span id="l10.27"> </span>
<a href="#l10.28"></a><span id="l10.28">   if (!Array.isArray(aInterfaces))</span>
<a href="#l10.29"></a><span id="l10.29">     aInterfaces = [aInterfaces];</span>
<a href="#l10.30"></a><span id="l10.30"> </span>
<a href="#l10.31"></a><span id="l10.31" class="difflineminus">-  for each (let i in aInterfaces)</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineplus">+  for (let i of aInterfaces)</span>
<a href="#l10.33"></a><span id="l10.33">     if (typeof i == &quot;string&quot; &amp;&amp; !(i in Ci))</span>
<a href="#l10.34"></a><span id="l10.34">       Services.console.logStringMessage(&quot;ClassInfo: unknown interface &quot; + i);</span>
<a href="#l10.35"></a><span id="l10.35"> </span>
<a href="#l10.36"></a><span id="l10.36">   this._interfaces =</span>
<a href="#l10.37"></a><span id="l10.37">     aInterfaces.map(i =&gt; typeof i == &quot;string&quot; ? Ci[i] : i);</span>
<a href="#l10.38"></a><span id="l10.38"> </span>
<a href="#l10.39"></a><span id="l10.39">   this.classDescription = aDescription;</span>
<a href="#l10.40"></a><span id="l10.40"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/chat/modules/jsProtoHelper.jsm</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/chat/modules/jsProtoHelper.jsm</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -168,17 +168,17 @@ var GenericAccountPrototype = {</span>
<a href="#l11.4"></a><span id="l11.4"> </span>
<a href="#l11.5"></a><span id="l11.5">     this._pendingBuddyRequests =</span>
<a href="#l11.6"></a><span id="l11.6">       this._pendingBuddyRequests.filter(r =&gt; r !== aRequest);</span>
<a href="#l11.7"></a><span id="l11.7">   },</span>
<a href="#l11.8"></a><span id="l11.8">   cancelPendingBuddyRequests: function() {</span>
<a href="#l11.9"></a><span id="l11.9">     if (!this._pendingBuddyRequests)</span>
<a href="#l11.10"></a><span id="l11.10">       return;</span>
<a href="#l11.11"></a><span id="l11.11"> </span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-    for each (let request in this._pendingBuddyRequests)</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+    for (let request of this._pendingBuddyRequests)</span>
<a href="#l11.14"></a><span id="l11.14">       request.cancel();</span>
<a href="#l11.15"></a><span id="l11.15">     delete this._pendingBuddyRequests;</span>
<a href="#l11.16"></a><span id="l11.16">   },</span>
<a href="#l11.17"></a><span id="l11.17"> </span>
<a href="#l11.18"></a><span id="l11.18">   requestBuddyInfo: function(aBuddyName) {},</span>
<a href="#l11.19"></a><span id="l11.19"> </span>
<a href="#l11.20"></a><span id="l11.20">   get canJoinChat() { return false; },</span>
<a href="#l11.21"></a><span id="l11.21">   getChatRoomFields: function() {</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineat">@@ -471,17 +471,17 @@ var GenericConversationPrototype = {</span>
<a href="#l11.23"></a><span id="l11.23">   addObserver: function(aObserver) {</span>
<a href="#l11.24"></a><span id="l11.24">     if (this._observers.indexOf(aObserver) == -1)</span>
<a href="#l11.25"></a><span id="l11.25">       this._observers.push(aObserver);</span>
<a href="#l11.26"></a><span id="l11.26">   },</span>
<a href="#l11.27"></a><span id="l11.27">   removeObserver: function(aObserver) {</span>
<a href="#l11.28"></a><span id="l11.28">     this._observers = this._observers.filter(o =&gt; o !== aObserver);</span>
<a href="#l11.29"></a><span id="l11.29">   },</span>
<a href="#l11.30"></a><span id="l11.30">   notifyObservers: function(aSubject, aTopic, aData) {</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineminus">-    for each (let observer in this._observers) {</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineplus">+    for (let observer of this._observers) {</span>
<a href="#l11.33"></a><span id="l11.33">       try {</span>
<a href="#l11.34"></a><span id="l11.34">         observer.observe(aSubject, aTopic, aData);</span>
<a href="#l11.35"></a><span id="l11.35">       } catch(e) {</span>
<a href="#l11.36"></a><span id="l11.36">         this.ERROR(e);</span>
<a href="#l11.37"></a><span id="l11.37">       }</span>
<a href="#l11.38"></a><span id="l11.38">     }</span>
<a href="#l11.39"></a><span id="l11.39">   },</span>
<a href="#l11.40"></a><span id="l11.40"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/chat/modules/test/test_filtering.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/chat/modules/test/test_filtering.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -25,63 +25,63 @@ function run_test() {</span>
<a href="#l12.4"></a><span id="l12.4"> // Sanity check: a string without HTML markup shouldn't be modified.</span>
<a href="#l12.5"></a><span id="l12.5"> function test_plainText() {</span>
<a href="#l12.6"></a><span id="l12.6">   const strings = [</span>
<a href="#l12.7"></a><span id="l12.7">     &quot;foo&quot;,</span>
<a href="#l12.8"></a><span id="l12.8">     &quot;foo  &quot;, // preserve trailing whitespace</span>
<a href="#l12.9"></a><span id="l12.9">     &quot;  foo&quot;, // preserve leading indent</span>
<a href="#l12.10"></a><span id="l12.10">     &quot;&amp;lt;html&amp;gt;&amp;amp;&quot; // keep escaped characters</span>
<a href="#l12.11"></a><span id="l12.11">   ];</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-  for each (let string in strings)</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+  for (let string of strings)</span>
<a href="#l12.14"></a><span id="l12.14">     do_check_eq(string, cleanupImMarkup(string));</span>
<a href="#l12.15"></a><span id="l12.15"> }</span>
<a href="#l12.16"></a><span id="l12.16"> </span>
<a href="#l12.17"></a><span id="l12.17"> function test_paragraphs() {</span>
<a href="#l12.18"></a><span id="l12.18">   const strings = [</span>
<a href="#l12.19"></a><span id="l12.19">     &quot;&lt;p&gt;foo&lt;/p&gt;&lt;p&gt;bar&lt;/p&gt;&quot;,</span>
<a href="#l12.20"></a><span id="l12.20">     &quot;&lt;p&gt;foo&lt;br&gt;bar&lt;/p&gt;&quot;,</span>
<a href="#l12.21"></a><span id="l12.21">     &quot;foo&lt;br&gt;bar&quot;</span>
<a href="#l12.22"></a><span id="l12.22">   ];</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineminus">-  for each (let string in strings)</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineplus">+  for (let string of strings)</span>
<a href="#l12.25"></a><span id="l12.25">     do_check_eq(string, cleanupImMarkup(string));</span>
<a href="#l12.26"></a><span id="l12.26"> }</span>
<a href="#l12.27"></a><span id="l12.27"> </span>
<a href="#l12.28"></a><span id="l12.28"> function test_stripScripts() {</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineminus">-  const strings = {</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineminus">-    &quot;&lt;script&gt;alert('hey')&lt;/script&gt;&quot;: &quot;&quot;,</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineminus">-    &quot;foo &lt;script&gt;alert('hey')&lt;/script&gt;&quot;: &quot;foo &quot;,</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineminus">-    &quot;&lt;p onclick=\&quot;alert('hey')\&quot;&gt;foo&lt;/p&gt;&quot;: &quot;&lt;p&gt;foo&lt;/p&gt;&quot;,</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineminus">-    &quot;&lt;p onmouseover=\&quot;alert('hey')\&quot;&gt;foo&lt;/p&gt;&quot;: &quot;&lt;p&gt;foo&lt;/p&gt;&quot;</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineminus">-  };</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineminus">-  for each (let [input, expectedOutput] in Iterator(strings))</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineplus">+  const strings = [</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineplus">+    [&quot;&lt;script&gt;alert('hey')&lt;/script&gt;&quot;, &quot;&quot;],</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineplus">+    [&quot;foo &lt;script&gt;alert('hey')&lt;/script&gt;&quot;, &quot;foo &quot;],</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineplus">+    [&quot;&lt;p onclick=\&quot;alert('hey')\&quot;&gt;foo&lt;/p&gt;&quot;, &quot;&lt;p&gt;foo&lt;/p&gt;&quot;],</span>
<a href="#l12.40"></a><span id="l12.40" class="difflineplus">+    [&quot;&lt;p onmouseover=\&quot;alert('hey')\&quot;&gt;foo&lt;/p&gt;&quot;, &quot;&lt;p&gt;foo&lt;/p&gt;&quot;],</span>
<a href="#l12.41"></a><span id="l12.41" class="difflineplus">+  ];</span>
<a href="#l12.42"></a><span id="l12.42" class="difflineplus">+  for (let [input, expectedOutput] of strings)</span>
<a href="#l12.43"></a><span id="l12.43">     do_check_eq(expectedOutput, cleanupImMarkup(input));</span>
<a href="#l12.44"></a><span id="l12.44"> }</span>
<a href="#l12.45"></a><span id="l12.45"> </span>
<a href="#l12.46"></a><span id="l12.46"> function test_links() {</span>
<a href="#l12.47"></a><span id="l12.47">   // http, https, ftp and mailto links should be preserved.</span>
<a href="#l12.48"></a><span id="l12.48">   const ok = [</span>
<a href="#l12.49"></a><span id="l12.49">     &quot;http://example.com/&quot;,</span>
<a href="#l12.50"></a><span id="l12.50">     &quot;https://example.com/&quot;,</span>
<a href="#l12.51"></a><span id="l12.51">     &quot;ftp://example.com/&quot;,</span>
<a href="#l12.52"></a><span id="l12.52">     &quot;mailto:foo@example.com&quot;</span>
<a href="#l12.53"></a><span id="l12.53">   ];</span>
<a href="#l12.54"></a><span id="l12.54" class="difflineminus">-  for each (let string in ok) {</span>
<a href="#l12.55"></a><span id="l12.55" class="difflineplus">+  for (let string of ok) {</span>
<a href="#l12.56"></a><span id="l12.56">     string = &quot;&lt;a href=\&quot;&quot; + string + &quot;\&quot;&gt;foo&lt;/a&gt;&quot;;</span>
<a href="#l12.57"></a><span id="l12.57">     do_check_eq(string, cleanupImMarkup(string));</span>
<a href="#l12.58"></a><span id="l12.58">   }</span>
<a href="#l12.59"></a><span id="l12.59"> </span>
<a href="#l12.60"></a><span id="l12.60">   // other links should be removed</span>
<a href="#l12.61"></a><span id="l12.61">   const bad = [</span>
<a href="#l12.62"></a><span id="l12.62">     &quot;chrome://global/content/&quot;,</span>
<a href="#l12.63"></a><span id="l12.63">     &quot;about:&quot;,</span>
<a href="#l12.64"></a><span id="l12.64">     &quot;about:blank&quot;,</span>
<a href="#l12.65"></a><span id="l12.65">     &quot;foo://bar/&quot;,</span>
<a href="#l12.66"></a><span id="l12.66">     &quot;&quot;</span>
<a href="#l12.67"></a><span id="l12.67">   ];</span>
<a href="#l12.68"></a><span id="l12.68" class="difflineminus">-  for each (let string in bad) {</span>
<a href="#l12.69"></a><span id="l12.69" class="difflineplus">+  for (let string of bad) {</span>
<a href="#l12.70"></a><span id="l12.70">     do_check_eq(&quot;&lt;a&gt;foo&lt;/a&gt;&quot;,</span>
<a href="#l12.71"></a><span id="l12.71">                 cleanupImMarkup(&quot;&lt;a href=\&quot;&quot; + string + &quot;\&quot;&gt;foo&lt;/a&gt;&quot;));</span>
<a href="#l12.72"></a><span id="l12.72">   }</span>
<a href="#l12.73"></a><span id="l12.73"> </span>
<a href="#l12.74"></a><span id="l12.74">   // keep link titles</span>
<a href="#l12.75"></a><span id="l12.75">   let string = &quot;&lt;a title=\&quot;foo bar\&quot;&gt;foo&lt;/a&gt;&quot;;</span>
<a href="#l12.76"></a><span id="l12.76">   do_check_eq(string, cleanupImMarkup(string));</span>
<a href="#l12.77"></a><span id="l12.77"> }</span>
<a href="#l12.78"></a><span id="l12.78" class="difflineat">@@ -95,18 +95,18 @@ function test_allModes() {</span>
<a href="#l12.79"></a><span id="l12.79">   do_check_eq(&quot;&lt;p&gt;foo&lt;/p&gt;&quot;, cleanupImMarkup(&quot;&lt;p class=\&quot;foobar\&quot;&gt;foo&lt;/p&gt;&quot;));</span>
<a href="#l12.80"></a><span id="l12.80"> }</span>
<a href="#l12.81"></a><span id="l12.81"> </span>
<a href="#l12.82"></a><span id="l12.82"> function test_strictMode() {</span>
<a href="#l12.83"></a><span id="l12.83">   Services.prefs.setIntPref(kModePref, kStrictMode);</span>
<a href="#l12.84"></a><span id="l12.84">   test_allModes();</span>
<a href="#l12.85"></a><span id="l12.85"> </span>
<a href="#l12.86"></a><span id="l12.86">   // check that basic formatting is stipped in strict mode.</span>
<a href="#l12.87"></a><span id="l12.87" class="difflineminus">-  for each (let tag in [&quot;div&quot;, &quot;em&quot;, &quot;strong&quot;, &quot;b&quot;, &quot;i&quot;, &quot;u&quot;, &quot;span&quot;, &quot;code&quot;,</span>
<a href="#l12.88"></a><span id="l12.88" class="difflineminus">-                        &quot;ul&quot;, &quot;li&quot;, &quot;ol&quot;, &quot;cite&quot;, &quot;blockquote&quot;])</span>
<a href="#l12.89"></a><span id="l12.89" class="difflineplus">+  for (let tag of [&quot;div&quot;, &quot;em&quot;, &quot;strong&quot;, &quot;b&quot;, &quot;i&quot;, &quot;u&quot;, &quot;span&quot;, &quot;code&quot;,</span>
<a href="#l12.90"></a><span id="l12.90" class="difflineplus">+                   &quot;ul&quot;, &quot;li&quot;, &quot;ol&quot;, &quot;cite&quot;, &quot;blockquote&quot;])</span>
<a href="#l12.91"></a><span id="l12.91">     do_check_eq(&quot;foo&quot;, cleanupImMarkup(&quot;&lt;&quot; + tag + &quot;&gt;foo&lt;/&quot; + tag + &quot;&gt;&quot;));</span>
<a href="#l12.92"></a><span id="l12.92"> </span>
<a href="#l12.93"></a><span id="l12.93">   // check that font settings are removed.</span>
<a href="#l12.94"></a><span id="l12.94">   do_check_eq(&quot;foo&quot;,</span>
<a href="#l12.95"></a><span id="l12.95">               cleanupImMarkup(&quot;&lt;font face=\&quot;Times\&quot; color=\&quot;pink\&quot;&gt;foo&lt;/font&gt;&quot;));</span>
<a href="#l12.96"></a><span id="l12.96">   do_check_eq(&quot;&lt;p&gt;foo&lt;/p&gt;&quot;,</span>
<a href="#l12.97"></a><span id="l12.97">               cleanupImMarkup(&quot;&lt;p style=\&quot;font-weight: bold;\&quot;&gt;foo&lt;/p&gt;&quot;));</span>
<a href="#l12.98"></a><span id="l12.98"> </span>
<a href="#l12.99"></a><span id="l12.99" class="difflineat">@@ -116,91 +116,91 @@ function test_strictMode() {</span>
<a href="#l12.100"></a><span id="l12.100">   run_next_test();</span>
<a href="#l12.101"></a><span id="l12.101"> }</span>
<a href="#l12.102"></a><span id="l12.102"> </span>
<a href="#l12.103"></a><span id="l12.103"> function test_standardMode() {</span>
<a href="#l12.104"></a><span id="l12.104">   Services.prefs.setIntPref(kModePref, kStandardMode);</span>
<a href="#l12.105"></a><span id="l12.105">   test_allModes();</span>
<a href="#l12.106"></a><span id="l12.106"> </span>
<a href="#l12.107"></a><span id="l12.107">   // check that basic formatting is kept in standard mode.</span>
<a href="#l12.108"></a><span id="l12.108" class="difflineminus">-  for each (let tag in [&quot;div&quot;, &quot;em&quot;, &quot;strong&quot;, &quot;b&quot;, &quot;i&quot;, &quot;u&quot;, &quot;span&quot;, &quot;code&quot;,</span>
<a href="#l12.109"></a><span id="l12.109" class="difflineminus">-                        &quot;ul&quot;, &quot;li&quot;, &quot;ol&quot;, &quot;cite&quot;, &quot;blockquote&quot;]) {</span>
<a href="#l12.110"></a><span id="l12.110" class="difflineplus">+  for (let tag of [&quot;div&quot;, &quot;em&quot;, &quot;strong&quot;, &quot;b&quot;, &quot;i&quot;, &quot;u&quot;, &quot;span&quot;, &quot;code&quot;,</span>
<a href="#l12.111"></a><span id="l12.111" class="difflineplus">+                   &quot;ul&quot;, &quot;li&quot;, &quot;ol&quot;, &quot;cite&quot;, &quot;blockquote&quot;]) {</span>
<a href="#l12.112"></a><span id="l12.112">     let string = &quot;&lt;&quot; + tag + &quot;&gt;foo&lt;/&quot; + tag + &quot;&gt;&quot;;</span>
<a href="#l12.113"></a><span id="l12.113">     do_check_eq(string, cleanupImMarkup(string));</span>
<a href="#l12.114"></a><span id="l12.114">   }</span>
<a href="#l12.115"></a><span id="l12.115"> </span>
<a href="#l12.116"></a><span id="l12.116">   // Keep special allowed classes.</span>
<a href="#l12.117"></a><span id="l12.117" class="difflineminus">-  for each (let className in [&quot;moz-txt-underscore&quot;, &quot;moz-txt-tag&quot;]) {</span>
<a href="#l12.118"></a><span id="l12.118" class="difflineplus">+  for (let className of [&quot;moz-txt-underscore&quot;, &quot;moz-txt-tag&quot;]) {</span>
<a href="#l12.119"></a><span id="l12.119">     let string = &quot;&lt;span class=\&quot;&quot; + className + &quot;\&quot;&gt;foo&lt;/span&gt;&quot;;</span>
<a href="#l12.120"></a><span id="l12.120">     do_check_eq(string, cleanupImMarkup(string));</span>
<a href="#l12.121"></a><span id="l12.121">   }</span>
<a href="#l12.122"></a><span id="l12.122"> </span>
<a href="#l12.123"></a><span id="l12.123">   // Remove font settings</span>
<a href="#l12.124"></a><span id="l12.124">   let string = &quot;&lt;font face=\&quot;Times\&quot; color=\&quot;pink\&quot; size=\&quot;3\&quot;&gt;foo&lt;/font&gt;&quot;;</span>
<a href="#l12.125"></a><span id="l12.125">   do_check_eq(&quot;foo&quot;, cleanupImMarkup(string));</span>
<a href="#l12.126"></a><span id="l12.126"> </span>
<a href="#l12.127"></a><span id="l12.127">   // Discard hr</span>
<a href="#l12.128"></a><span id="l12.128">   do_check_eq(&quot;foobar&quot;, cleanupImMarkup(&quot;foo&lt;hr&gt;bar&quot;));</span>
<a href="#l12.129"></a><span id="l12.129"> </span>
<a href="#l12.130"></a><span id="l12.130">   const okCSS = [</span>
<a href="#l12.131"></a><span id="l12.131">     &quot;font-style: italic&quot;,</span>
<a href="#l12.132"></a><span id="l12.132">     &quot;font-weight: bold&quot;</span>
<a href="#l12.133"></a><span id="l12.133">   ];</span>
<a href="#l12.134"></a><span id="l12.134" class="difflineminus">-  for each (let css in okCSS) {</span>
<a href="#l12.135"></a><span id="l12.135" class="difflineplus">+  for (let css of okCSS) {</span>
<a href="#l12.136"></a><span id="l12.136">     let string = &quot;&lt;span style=\&quot;&quot; + css + &quot;\&quot;&gt;foo&lt;/span&gt;&quot;;</span>
<a href="#l12.137"></a><span id="l12.137">     do_check_eq(string, cleanupImMarkup(string));</span>
<a href="#l12.138"></a><span id="l12.138">   }</span>
<a href="#l12.139"></a><span id="l12.139">   // text-decoration is a shorthand for several text-decoration properties.</span>
<a href="#l12.140"></a><span id="l12.140">   do_check_eq(&quot;&lt;span style=\&quot;text-decoration-line: underline;\&quot;&gt;foo&lt;/span&gt;&quot;,</span>
<a href="#l12.141"></a><span id="l12.141">               cleanupImMarkup(&quot;&lt;span style=\&quot;text-decoration: underline\&quot;&gt;foo&lt;/span&gt;&quot;));</span>
<a href="#l12.142"></a><span id="l12.142"> </span>
<a href="#l12.143"></a><span id="l12.143">   const badCSS = [</span>
<a href="#l12.144"></a><span id="l12.144">     &quot;color: pink;&quot;,</span>
<a href="#l12.145"></a><span id="l12.145">     &quot;font-family: Times&quot;,</span>
<a href="#l12.146"></a><span id="l12.146">     &quot;font-size: larger&quot;,</span>
<a href="#l12.147"></a><span id="l12.147">     &quot;-moz-binding: url('chrome://global/content/bindings/textbox.xml#textbox');&quot;,</span>
<a href="#l12.148"></a><span id="l12.148">     &quot;display: none&quot;,</span>
<a href="#l12.149"></a><span id="l12.149">     &quot;visibility: hidden&quot;</span>
<a href="#l12.150"></a><span id="l12.150">   ];</span>
<a href="#l12.151"></a><span id="l12.151" class="difflineminus">-  for each (let css in badCSS) {</span>
<a href="#l12.152"></a><span id="l12.152" class="difflineplus">+  for (let css of badCSS) {</span>
<a href="#l12.153"></a><span id="l12.153">     do_check_eq(&quot;&lt;span style=\&quot;\&quot;&gt;foo&lt;/span&gt;&quot;,</span>
<a href="#l12.154"></a><span id="l12.154">                 cleanupImMarkup(&quot;&lt;span style=\&quot;&quot; + css + &quot;\&quot;&gt;foo&lt;/span&gt;&quot;));</span>
<a href="#l12.155"></a><span id="l12.155">   }</span>
<a href="#l12.156"></a><span id="l12.156">   // The shorthand 'font' is decomposed to non-shorthand properties,</span>
<a href="#l12.157"></a><span id="l12.157">   // and not recomposed as some non-shorthand properties are filtered out.</span>
<a href="#l12.158"></a><span id="l12.158">   do_check_eq(&quot;&lt;span style=\&quot;font-style: normal; font-weight: normal;\&quot;&gt;foo&lt;/span&gt;&quot;,</span>
<a href="#l12.159"></a><span id="l12.159">               cleanupImMarkup(&quot;&lt;span style=\&quot;font: 15px normal\&quot;&gt;foo&lt;/span&gt;&quot;));</span>
<a href="#l12.160"></a><span id="l12.160"> </span>
<a href="#l12.161"></a><span id="l12.161">   run_next_test();</span>
<a href="#l12.162"></a><span id="l12.162"> }</span>
<a href="#l12.163"></a><span id="l12.163"> </span>
<a href="#l12.164"></a><span id="l12.164"> function test_permissiveMode() {</span>
<a href="#l12.165"></a><span id="l12.165">   Services.prefs.setIntPref(kModePref, kPermissiveMode);</span>
<a href="#l12.166"></a><span id="l12.166">   test_allModes();</span>
<a href="#l12.167"></a><span id="l12.167"> </span>
<a href="#l12.168"></a><span id="l12.168">   // Check that all formatting is kept in permissive mode.</span>
<a href="#l12.169"></a><span id="l12.169" class="difflineminus">-  for each (let tag in [&quot;div&quot;, &quot;em&quot;, &quot;strong&quot;, &quot;b&quot;, &quot;i&quot;, &quot;u&quot;, &quot;span&quot;, &quot;code&quot;,</span>
<a href="#l12.170"></a><span id="l12.170" class="difflineminus">-                        &quot;ul&quot;, &quot;li&quot;, &quot;ol&quot;, &quot;cite&quot;, &quot;blockquote&quot;]) {</span>
<a href="#l12.171"></a><span id="l12.171" class="difflineplus">+  for (let tag of [&quot;div&quot;, &quot;em&quot;, &quot;strong&quot;, &quot;b&quot;, &quot;i&quot;, &quot;u&quot;, &quot;span&quot;, &quot;code&quot;,</span>
<a href="#l12.172"></a><span id="l12.172" class="difflineplus">+                   &quot;ul&quot;, &quot;li&quot;, &quot;ol&quot;, &quot;cite&quot;, &quot;blockquote&quot;]) {</span>
<a href="#l12.173"></a><span id="l12.173">     let string = &quot;&lt;&quot; + tag + &quot;&gt;foo&lt;/&quot; + tag + &quot;&gt;&quot;;</span>
<a href="#l12.174"></a><span id="l12.174">     do_check_eq(string, cleanupImMarkup(string));</span>
<a href="#l12.175"></a><span id="l12.175">   }</span>
<a href="#l12.176"></a><span id="l12.176"> </span>
<a href="#l12.177"></a><span id="l12.177">   // Keep special allowed classes.</span>
<a href="#l12.178"></a><span id="l12.178" class="difflineminus">-  for each (let className in [&quot;moz-txt-underscore&quot;, &quot;moz-txt-tag&quot;]) {</span>
<a href="#l12.179"></a><span id="l12.179" class="difflineplus">+  for (let className of [&quot;moz-txt-underscore&quot;, &quot;moz-txt-tag&quot;]) {</span>
<a href="#l12.180"></a><span id="l12.180">     let string = &quot;&lt;span class=\&quot;&quot; + className + &quot;\&quot;&gt;foo&lt;/span&gt;&quot;;</span>
<a href="#l12.181"></a><span id="l12.181">     do_check_eq(string, cleanupImMarkup(string));</span>
<a href="#l12.182"></a><span id="l12.182">   }</span>
<a href="#l12.183"></a><span id="l12.183"> </span>
<a href="#l12.184"></a><span id="l12.184">   // Keep font settings</span>
<a href="#l12.185"></a><span id="l12.185">   const fontAttributes = [</span>
<a href="#l12.186"></a><span id="l12.186">     &quot;face=\&quot;Times\&quot;&quot;,</span>
<a href="#l12.187"></a><span id="l12.187">     &quot;color=\&quot;pink\&quot;&quot;,</span>
<a href="#l12.188"></a><span id="l12.188">     &quot;size=\&quot;3\&quot;&quot;</span>
<a href="#l12.189"></a><span id="l12.189">   ];</span>
<a href="#l12.190"></a><span id="l12.190" class="difflineminus">-  for each (let fontAttribute in fontAttributes) {</span>
<a href="#l12.191"></a><span id="l12.191" class="difflineplus">+  for (let fontAttribute of fontAttributes) {</span>
<a href="#l12.192"></a><span id="l12.192">     let string = &quot;&lt;font &quot; + fontAttribute + &quot;&gt;foo&lt;/font&gt;&quot;;</span>
<a href="#l12.193"></a><span id="l12.193">     do_check_eq(string, cleanupImMarkup(string));</span>
<a href="#l12.194"></a><span id="l12.194">   }</span>
<a href="#l12.195"></a><span id="l12.195"> </span>
<a href="#l12.196"></a><span id="l12.196">   // Allow hr</span>
<a href="#l12.197"></a><span id="l12.197">   let string = &quot;foo&lt;hr&gt;bar&quot;;</span>
<a href="#l12.198"></a><span id="l12.198">   do_check_eq(string, cleanupImMarkup(string));</span>
<a href="#l12.199"></a><span id="l12.199"> </span>
<a href="#l12.200"></a><span id="l12.200" class="difflineat">@@ -208,33 +208,33 @@ function test_permissiveMode() {</span>
<a href="#l12.201"></a><span id="l12.201">   const okCSS = [</span>
<a href="#l12.202"></a><span id="l12.202">     &quot;font-style: italic&quot;,</span>
<a href="#l12.203"></a><span id="l12.203">     &quot;font-weight: bold&quot;,</span>
<a href="#l12.204"></a><span id="l12.204">     &quot;text-decoration: underline&quot;,</span>
<a href="#l12.205"></a><span id="l12.205">     &quot;color: pink;&quot;,</span>
<a href="#l12.206"></a><span id="l12.206">     &quot;font-family: Times&quot;,</span>
<a href="#l12.207"></a><span id="l12.207">     &quot;font-size: larger&quot;</span>
<a href="#l12.208"></a><span id="l12.208">   ];</span>
<a href="#l12.209"></a><span id="l12.209" class="difflineminus">-  for each (let css in okCSS) {</span>
<a href="#l12.210"></a><span id="l12.210" class="difflineplus">+  for (let css of okCSS) {</span>
<a href="#l12.211"></a><span id="l12.211">     let string = &quot;&lt;span style=\&quot;&quot; + css + &quot;\&quot;&gt;foo&lt;/span&gt;&quot;;</span>
<a href="#l12.212"></a><span id="l12.212">     do_check_eq(string, cleanupImMarkup(string));</span>
<a href="#l12.213"></a><span id="l12.213">   }</span>
<a href="#l12.214"></a><span id="l12.214">   // The shorthand 'font' is decomposed to non-shorthand properties,</span>
<a href="#l12.215"></a><span id="l12.215">   // and not recomposed as some non-shorthand properties are filtered out.</span>
<a href="#l12.216"></a><span id="l12.216">   do_check_eq(&quot;&lt;span style=\&quot;font-family: normal; font-style: normal;&quot; +</span>
<a href="#l12.217"></a><span id="l12.217">               &quot; font-weight: normal; font-size: 15px;\&quot;&gt;foo&lt;/span&gt;&quot;,</span>
<a href="#l12.218"></a><span id="l12.218">               cleanupImMarkup(&quot;&lt;span style=\&quot;font: 15px normal\&quot;&gt;foo&lt;/span&gt;&quot;));</span>
<a href="#l12.219"></a><span id="l12.219"> </span>
<a href="#l12.220"></a><span id="l12.220">   // But still filter out dangerous CSS rules.</span>
<a href="#l12.221"></a><span id="l12.221">   const badCSS = [</span>
<a href="#l12.222"></a><span id="l12.222">     &quot;-moz-binding: url('chrome://global/content/bindings/textbox.xml#textbox');&quot;,</span>
<a href="#l12.223"></a><span id="l12.223">     &quot;display: none&quot;,</span>
<a href="#l12.224"></a><span id="l12.224">     &quot;visibility: hidden&quot;</span>
<a href="#l12.225"></a><span id="l12.225">   ];</span>
<a href="#l12.226"></a><span id="l12.226" class="difflineminus">-  for each (let css in badCSS) {</span>
<a href="#l12.227"></a><span id="l12.227" class="difflineplus">+  for (let css of badCSS) {</span>
<a href="#l12.228"></a><span id="l12.228">     do_check_eq(&quot;&lt;span style=\&quot;\&quot;&gt;foo&lt;/span&gt;&quot;,</span>
<a href="#l12.229"></a><span id="l12.229">                 cleanupImMarkup(&quot;&lt;span style=\&quot;&quot; + css + &quot;\&quot;&gt;foo&lt;/span&gt;&quot;));</span>
<a href="#l12.230"></a><span id="l12.230">   }</span>
<a href="#l12.231"></a><span id="l12.231"> </span>
<a href="#l12.232"></a><span id="l12.232">   run_next_test();</span>
<a href="#l12.233"></a><span id="l12.233"> }</span>
<a href="#l12.234"></a><span id="l12.234"> </span>
<a href="#l12.235"></a><span id="l12.235"> function test_addGlobalAllowedTag() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/chat/protocols/irc/irc.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/chat/protocols/irc/irc.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -137,17 +137,17 @@ function ircMessage(aData, aOrigin) {</span>
<a href="#l13.4"></a><span id="l13.4"> }</span>
<a href="#l13.5"></a><span id="l13.5"> </span>
<a href="#l13.6"></a><span id="l13.6"> // This handles a mode change string for both channels and participants. A mode</span>
<a href="#l13.7"></a><span id="l13.7"> // change string is of the form:</span>
<a href="#l13.8"></a><span id="l13.8"> //   aAddNewMode is true if modes are being added, false otherwise.</span>
<a href="#l13.9"></a><span id="l13.9"> //   aNewModes is an array of mode characters.</span>
<a href="#l13.10"></a><span id="l13.10"> function _setMode(aAddNewMode, aNewModes) {</span>
<a href="#l13.11"></a><span id="l13.11">   // Check each mode being added/removed.</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-  for each (let newMode in aNewModes) {</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+  for (let newMode of aNewModes) {</span>
<a href="#l13.14"></a><span id="l13.14">     let hasMode = this._modes.has(newMode);</span>
<a href="#l13.15"></a><span id="l13.15">     // If the mode is in the list of modes and we want to remove it.</span>
<a href="#l13.16"></a><span id="l13.16">     if (hasMode &amp;&amp; !aAddNewMode)</span>
<a href="#l13.17"></a><span id="l13.17">       this._modes.delete(newMode);</span>
<a href="#l13.18"></a><span id="l13.18">     // If the mode is not in the list of modes and we want to add it.</span>
<a href="#l13.19"></a><span id="l13.19">     else if (!hasMode &amp;&amp; aAddNewMode)</span>
<a href="#l13.20"></a><span id="l13.20">       this._modes.add(newMode);</span>
<a href="#l13.21"></a><span id="l13.21">   }</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineat">@@ -510,18 +510,20 @@ ircChannel.prototype = {</span>
<a href="#l13.23"></a><span id="l13.23">             aSetter);</span>
<a href="#l13.24"></a><span id="l13.24">     this.writeMessage(aSetter, msg, {system: true});</span>
<a href="#l13.25"></a><span id="l13.25"> </span>
<a href="#l13.26"></a><span id="l13.26">     this._receivedInitialMode = true;</span>
<a href="#l13.27"></a><span id="l13.27">   },</span>
<a href="#l13.28"></a><span id="l13.28"> </span>
<a href="#l13.29"></a><span id="l13.29">   setModesFromRestriction: function(aRestriction) {</span>
<a href="#l13.30"></a><span id="l13.30">     // First remove all types from the list of modes.</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineminus">-    for each (let mode in this._account.channelRestrictionToModeMap)</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineplus">+    for (let key in this._account.channelRestrictionToModeMap) {</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineplus">+      let mode = this._account.channelRestrictionToModeMap[key];</span>
<a href="#l13.34"></a><span id="l13.34">       this._modes.delete(mode);</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineplus">+    }</span>
<a href="#l13.36"></a><span id="l13.36"> </span>
<a href="#l13.37"></a><span id="l13.37">     // Add the new mode onto the list.</span>
<a href="#l13.38"></a><span id="l13.38">     if (aRestriction in this._account.channelRestrictionToModeMap) {</span>
<a href="#l13.39"></a><span id="l13.39">       let mode = this._account.channelRestrictionToModeMap[aRestriction];</span>
<a href="#l13.40"></a><span id="l13.40">       if (mode)</span>
<a href="#l13.41"></a><span id="l13.41">         this._modes.add(mode);</span>
<a href="#l13.42"></a><span id="l13.42">     }</span>
<a href="#l13.43"></a><span id="l13.43">   },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/chat/protocols/irc/ircBase.jsm</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/chat/protocols/irc/ircBase.jsm</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -64,21 +64,21 @@ function leftRoom(aAccount, aNicks, aCha</span>
<a href="#l14.4"></a><span id="l14.4">         return _(msgId2, aSource, reason);</span>
<a href="#l14.5"></a><span id="l14.5">       return _(msgId2, aNick, aSource, reason);</span>
<a href="#l14.6"></a><span id="l14.6">     }</span>
<a href="#l14.7"></a><span id="l14.7">     if (aYou)</span>
<a href="#l14.8"></a><span id="l14.8">       return _(msgId2, reason);</span>
<a href="#l14.9"></a><span id="l14.9">     return _(msgId2, aNick, reason);</span>
<a href="#l14.10"></a><span id="l14.10">   }</span>
<a href="#l14.11"></a><span id="l14.11"> </span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-  for each (let channelName in aChannels) {</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+  for (let channelName of aChannels) {</span>
<a href="#l14.14"></a><span id="l14.14">     if (!aAccount.conversations.has(channelName))</span>
<a href="#l14.15"></a><span id="l14.15">       continue; // Handle when we closed the window</span>
<a href="#l14.16"></a><span id="l14.16">     let conversation = aAccount.getConversation(channelName);</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineminus">-    for each (let nick in aNicks) {</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineplus">+    for (let nick of aNicks) {</span>
<a href="#l14.19"></a><span id="l14.19">       let msg;</span>
<a href="#l14.20"></a><span id="l14.20">       if (aAccount.normalize(nick) == aAccount.normalize(aAccount._nickname)) {</span>
<a href="#l14.21"></a><span id="l14.21">         msg = __(nick, true);</span>
<a href="#l14.22"></a><span id="l14.22">         // If the user left, mark the conversation as no longer being active.</span>
<a href="#l14.23"></a><span id="l14.23">         conversation.left = true;</span>
<a href="#l14.24"></a><span id="l14.24">       }</span>
<a href="#l14.25"></a><span id="l14.25">       else</span>
<a href="#l14.26"></a><span id="l14.26">         msg = __(nick);</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineat">@@ -692,17 +692,17 @@ var ircBase = {</span>
<a href="#l14.28"></a><span id="l14.28">       // :*1&lt;nick&gt; *( &quot; &quot; &lt;nick&gt; )&quot;</span>
<a href="#l14.29"></a><span id="l14.29">       // Set the status of the buddies based the lastest ISON response.</span>
<a href="#l14.30"></a><span id="l14.30">       let receivedBuddyNames = [];</span>
<a href="#l14.31"></a><span id="l14.31">       // The buddy names as returned by the server.</span>
<a href="#l14.32"></a><span id="l14.32">       if (aMessage.params.length &gt; 1)</span>
<a href="#l14.33"></a><span id="l14.33">         receivedBuddyNames = aMessage.params[1].trim().split(&quot; &quot;);</span>
<a href="#l14.34"></a><span id="l14.34"> </span>
<a href="#l14.35"></a><span id="l14.35">       // This was received in response to the last ISON message sent.</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineminus">-      for each (let buddyName in this.pendingIsOnQueue) {</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineplus">+      for (let buddyName of this.pendingIsOnQueue) {</span>
<a href="#l14.38"></a><span id="l14.38">         // If the buddy name is in the list returned from the server, they're</span>
<a href="#l14.39"></a><span id="l14.39">         // online.</span>
<a href="#l14.40"></a><span id="l14.40">         let status = (receivedBuddyNames.indexOf(buddyName) == -1) ?</span>
<a href="#l14.41"></a><span id="l14.41">                        Ci.imIStatusInfo.STATUS_OFFLINE :</span>
<a href="#l14.42"></a><span id="l14.42">                        Ci.imIStatusInfo.STATUS_AVAILABLE;</span>
<a href="#l14.43"></a><span id="l14.43"> </span>
<a href="#l14.44"></a><span id="l14.44">         // Set the status with no status message, only if the buddy actually</span>
<a href="#l14.45"></a><span id="l14.45">         // exists in the buddy list.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/chat/protocols/irc/ircCTCP.jsm</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/chat/protocols/irc/ircCTCP.jsm</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -88,17 +88,17 @@ function ctcpHandleMessage(aMessage) {</span>
<a href="#l15.4"></a><span id="l15.4">   if (otherMessage) {</span>
<a href="#l15.5"></a><span id="l15.5">     let message = aMessage;</span>
<a href="#l15.6"></a><span id="l15.6">     message.params.pop();</span>
<a href="#l15.7"></a><span id="l15.7">     message.params.push(otherMessage);</span>
<a href="#l15.8"></a><span id="l15.8">     ircHandlers.handleMessage(message);</span>
<a href="#l15.9"></a><span id="l15.9">   }</span>
<a href="#l15.10"></a><span id="l15.10"> </span>
<a href="#l15.11"></a><span id="l15.11">   // Loop over each raw CTCP message.</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-  for each (let message in ctcpMessages) {</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+  for (let message of ctcpMessages) {</span>
<a href="#l15.14"></a><span id="l15.14">     if (!ircHandlers.handleCTCPMessage(this, message)) {</span>
<a href="#l15.15"></a><span id="l15.15">       this.WARN(&quot;Unhandled CTCP message: &quot; + message.ctcp.rawMessage +</span>
<a href="#l15.16"></a><span id="l15.16">                 &quot;\nin IRC message: &quot; + message.rawMessage);</span>
<a href="#l15.17"></a><span id="l15.17">       // For unhandled CTCP message, respond with a NOTICE ERRMSG that echoes</span>
<a href="#l15.18"></a><span id="l15.18">       // back the original command.</span>
<a href="#l15.19"></a><span id="l15.19">       this.sendCTCPMessage(message.origin, true, &quot;ERRMSG&quot;,</span>
<a href="#l15.20"></a><span id="l15.20">                            [message.ctcp.rawMessage, &quot;:Unhandled CTCP command&quot;]);</span>
<a href="#l15.21"></a><span id="l15.21">     }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/chat/protocols/irc/ircHandlers.jsm</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/chat/protocols/irc/ircHandlers.jsm</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -101,17 +101,17 @@ var ircHandlers = {</span>
<a href="#l16.4"></a><span id="l16.4">   unregisterServicesHandler: function(aHandler) {</span>
<a href="#l16.5"></a><span id="l16.5">     this._servicesHandlers = this._unregisterHandler(this._servicesHandlers,</span>
<a href="#l16.6"></a><span id="l16.6">                                                      aHandler);</span>
<a href="#l16.7"></a><span id="l16.7">   },</span>
<a href="#l16.8"></a><span id="l16.8"> </span>
<a href="#l16.9"></a><span id="l16.9">   // Handle a message based on a set of handlers.</span>
<a href="#l16.10"></a><span id="l16.10">   _handleMessage: function(aHandlers, aAccount, aMessage, aCommand) {</span>
<a href="#l16.11"></a><span id="l16.11">     // Loop over each handler and run the command until one handles the message.</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-    for each (let handler in aHandlers) {</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+    for (let handler of aHandlers) {</span>
<a href="#l16.14"></a><span id="l16.14">       try {</span>
<a href="#l16.15"></a><span id="l16.15">         // Attempt to execute the command, by checking if the handler has the</span>
<a href="#l16.16"></a><span id="l16.16">         // command.</span>
<a href="#l16.17"></a><span id="l16.17">         // Parse the command with the JavaScript account object as &quot;this&quot;.</span>
<a href="#l16.18"></a><span id="l16.18">         if (handler.isEnabled.call(aAccount) &amp;&amp;</span>
<a href="#l16.19"></a><span id="l16.19">             Object.prototype.hasOwnProperty.call(handler.commands, aCommand) &amp;&amp;</span>
<a href="#l16.20"></a><span id="l16.20">             handler.commands[aCommand].call(aAccount, aMessage))</span>
<a href="#l16.21"></a><span id="l16.21">           return true;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/chat/protocols/irc/ircISUPPORT.jsm</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/chat/protocols/irc/ircISUPPORT.jsm</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -121,17 +121,17 @@ var isupportBase = {</span>
<a href="#l17.4"></a><span id="l17.4">     },</span>
<a href="#l17.5"></a><span id="l17.5">     &quot;CHANLIMIT&quot;: function(aMessage) {</span>
<a href="#l17.6"></a><span id="l17.6">       // CHANLIMIT=&lt;prefix&gt;:&lt;number&gt;[,&lt;prefix&gt;:&lt;number&gt;]*</span>
<a href="#l17.7"></a><span id="l17.7">       // Note that each &lt;prefix&gt; can actually contain multiple prefixes, this</span>
<a href="#l17.8"></a><span id="l17.8">       // means the sum of those prefixes is given.</span>
<a href="#l17.9"></a><span id="l17.9">       this.maxChannels = {};</span>
<a href="#l17.10"></a><span id="l17.10"> </span>
<a href="#l17.11"></a><span id="l17.11">       let pairs = aMessage.isupport.value.split(&quot;,&quot;);</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-      for each (let pair in pairs) {</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+      for (let pair of pairs) {</span>
<a href="#l17.14"></a><span id="l17.14">         let [prefix, num] = pair.split(&quot;:&quot;);</span>
<a href="#l17.15"></a><span id="l17.15">         this.maxChannels[prefix] = num;</span>
<a href="#l17.16"></a><span id="l17.16">       }</span>
<a href="#l17.17"></a><span id="l17.17">       return true;</span>
<a href="#l17.18"></a><span id="l17.18">     },</span>
<a href="#l17.19"></a><span id="l17.19">     &quot;CHANMODES&quot;: aMessage =&gt; false,</span>
<a href="#l17.20"></a><span id="l17.20">     &quot;CHANNELLEN&quot;: function(aMessage) {</span>
<a href="#l17.21"></a><span id="l17.21">       // CHANNELLEN=&lt;number&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/chat/protocols/irc/ircWatchMonitor.jsm</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/chat/protocols/irc/ircWatchMonitor.jsm</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -66,17 +66,17 @@ function trackBuddyWatch(aNicks) {</span>
<a href="#l18.4"></a><span id="l18.4">   this.watchLength = newWatchLength;</span>
<a href="#l18.5"></a><span id="l18.5"> </span>
<a href="#l18.6"></a><span id="l18.6">   // Watch away as well as online.</span>
<a href="#l18.7"></a><span id="l18.7">   let params = [];</span>
<a href="#l18.8"></a><span id="l18.8">   if (this.watchAwayEnabled)</span>
<a href="#l18.9"></a><span id="l18.9">     params.push(&quot;A&quot;);</span>
<a href="#l18.10"></a><span id="l18.10">   let maxLength = this.maxMessageLength - 2 -</span>
<a href="#l18.11"></a><span id="l18.11">                   this.countBytes(this.buildMessage(&quot;WATCH&quot;, params));</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-  for each (let nick in nicks) {</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+  for (let nick of nicks) {</span>
<a href="#l18.14"></a><span id="l18.14">     if (this.countBytes(params + &quot; &quot; + nick) &gt;= maxLength) {</span>
<a href="#l18.15"></a><span id="l18.15">       // If the message would be too long, first send this message.</span>
<a href="#l18.16"></a><span id="l18.16">       this.sendMessage(&quot;WATCH&quot;, params);</span>
<a href="#l18.17"></a><span id="l18.17">       // Reset for the next message.</span>
<a href="#l18.18"></a><span id="l18.18">       params = [];</span>
<a href="#l18.19"></a><span id="l18.19">       if (this.watchAwayEnabled)</span>
<a href="#l18.20"></a><span id="l18.20">         params.push(&quot;A&quot;);</span>
<a href="#l18.21"></a><span id="l18.21">     }</span>
<a href="#l18.22"></a><span id="l18.22" class="difflineat">@@ -317,17 +317,17 @@ function trackBuddyMonitor(aNicks) {</span>
<a href="#l18.23"></a><span id="l18.23">     // but that's not currently implemented, so just hope the server doesn't</span>
<a href="#l18.24"></a><span id="l18.24">     // enforce it's own limit.</span>
<a href="#l18.25"></a><span id="l18.25">   }</span>
<a href="#l18.26"></a><span id="l18.26">   this.monitorLength = newMonitorLength;</span>
<a href="#l18.27"></a><span id="l18.27"> </span>
<a href="#l18.28"></a><span id="l18.28">   let params = [];</span>
<a href="#l18.29"></a><span id="l18.29">   let maxLength = this.maxMessageLength - 2 -</span>
<a href="#l18.30"></a><span id="l18.30">                   this.countBytes(this.buildMessage(&quot;MONITOR&quot;, &quot;+&quot;));</span>
<a href="#l18.31"></a><span id="l18.31" class="difflineminus">-  for each (let nick in nicks) {</span>
<a href="#l18.32"></a><span id="l18.32" class="difflineplus">+  for (let nick of nicks) {</span>
<a href="#l18.33"></a><span id="l18.33">     if (this.countBytes(params + &quot; &quot; + nick) &gt;= maxLength) {</span>
<a href="#l18.34"></a><span id="l18.34">       // If the message would be too long, first send this message.</span>
<a href="#l18.35"></a><span id="l18.35">       this.sendMessage(&quot;MONITOR&quot;, [&quot;+&quot;, params.join(&quot;,&quot;)]);</span>
<a href="#l18.36"></a><span id="l18.36">       // Reset for the next message.</span>
<a href="#l18.37"></a><span id="l18.37">       params = [];</span>
<a href="#l18.38"></a><span id="l18.38">     }</span>
<a href="#l18.39"></a><span id="l18.39">     params.push(nick);</span>
<a href="#l18.40"></a><span id="l18.40">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/chat/protocols/irc/test/test_ircMessage.js</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/chat/protocols/irc/test/test_ircMessage.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -124,17 +124,17 @@ function run_test() {</span>
<a href="#l19.4"></a><span id="l19.4"> </span>
<a href="#l19.5"></a><span id="l19.5">   run_next_test();</span>
<a href="#l19.6"></a><span id="l19.6"> }</span>
<a href="#l19.7"></a><span id="l19.7"> </span>
<a href="#l19.8"></a><span id="l19.8"> /*</span>
<a href="#l19.9"></a><span id="l19.9">  * Test round tripping parsing and then rebuilding the messages from RFC 2812.</span>
<a href="#l19.10"></a><span id="l19.10">  */</span>
<a href="#l19.11"></a><span id="l19.11"> function testRFC2812Messages() {</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-  for each (let expectedStringMessage in testData) {</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+  for (let expectedStringMessage of testData) {</span>
<a href="#l19.14"></a><span id="l19.14">     // Pass in an empty default origin in order to check this below.</span>
<a href="#l19.15"></a><span id="l19.15">     let message = irc.ircMessage(expectedStringMessage, &quot;&quot;);</span>
<a href="#l19.16"></a><span id="l19.16"> </span>
<a href="#l19.17"></a><span id="l19.17">     let stringMessage =</span>
<a href="#l19.18"></a><span id="l19.18">       irc.ircAccount.prototype.buildMessage(message.command, message.params);</span>
<a href="#l19.19"></a><span id="l19.19"> </span>
<a href="#l19.20"></a><span id="l19.20">     // Let's do a little dance here...we don't rebuild the &quot;source&quot; of the</span>
<a href="#l19.21"></a><span id="l19.21">     // message (the server does that), so when comparing our output message, we</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/chat/protocols/twitter/twitter.js</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/chat/protocols/twitter/twitter.js</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -318,17 +318,17 @@ Conversation.prototype = {</span>
<a href="#l20.4"></a><span id="l20.4">           end: um.indices[1],</span>
<a href="#l20.5"></a><span id="l20.5">           str: &quot;@&quot; + um.screen_name,</span>
<a href="#l20.6"></a><span id="l20.6">           text: '@&lt;span class=&quot;ib-person&quot;&gt;' + um.screen_name + &quot;&lt;/span&gt;&quot;,</span>
<a href="#l20.7"></a><span id="l20.7">           title: um.name,</span>
<a href="#l20.8"></a><span id="l20.8">           href: &quot;https://twitter.com/&quot; + um.screen_name})));</span>
<a href="#l20.9"></a><span id="l20.9">       }</span>
<a href="#l20.10"></a><span id="l20.10">       entArray.sort((a, b) =&gt; a.start - b.start);</span>
<a href="#l20.11"></a><span id="l20.11">       let offset = 0;</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-      for each (let entity in entArray) {</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineplus">+      for (let entity of entArray) {</span>
<a href="#l20.14"></a><span id="l20.14">         let str = text.substring(offset + entity.start, offset + entity.end);</span>
<a href="#l20.15"></a><span id="l20.15">         if (str[0] == &quot;\uFF20&quot;) // ＠ - unicode character similar to @</span>
<a href="#l20.16"></a><span id="l20.16">           str = &quot;@&quot; + str.substring(1);</span>
<a href="#l20.17"></a><span id="l20.17">         if (str[0] == &quot;\uFF03&quot;) // ＃ - unicode character similar to #</span>
<a href="#l20.18"></a><span id="l20.18">           str = &quot;#&quot; + str.substring(1);</span>
<a href="#l20.19"></a><span id="l20.19">         if (str.toLowerCase() != entity.str.toLowerCase())</span>
<a href="#l20.20"></a><span id="l20.20">           continue;</span>
<a href="#l20.21"></a><span id="l20.21"> </span>
<a href="#l20.22"></a><span id="l20.22" class="difflineat">@@ -618,17 +618,17 @@ Account.prototype = {</span>
<a href="#l20.23"></a><span id="l20.23">         this.signAndSend(url, null, null, this.onTimelineReceived,</span>
<a href="#l20.24"></a><span id="l20.24">                          this.onTimelineError, this, null));</span>
<a href="#l20.25"></a><span id="l20.25">     }</span>
<a href="#l20.26"></a><span id="l20.26">   },</span>
<a href="#l20.27"></a><span id="l20.27"> </span>
<a href="#l20.28"></a><span id="l20.28">   get timeline() { return this._timeline || (this._timeline = new Conversation(this)); },</span>
<a href="#l20.29"></a><span id="l20.29">   displayMessages: function(aMessages) {</span>
<a href="#l20.30"></a><span id="l20.30">     let lastMsgId = this._lastMsgId;</span>
<a href="#l20.31"></a><span id="l20.31" class="difflineminus">-    for each (let tweet in aMessages) {</span>
<a href="#l20.32"></a><span id="l20.32" class="difflineplus">+    for (let tweet of aMessages) {</span>
<a href="#l20.33"></a><span id="l20.33">       if (!(&quot;user&quot; in tweet) || !(&quot;text&quot; in tweet) || !(&quot;id_str&quot; in tweet) ||</span>
<a href="#l20.34"></a><span id="l20.34">           this._knownMessageIds.has(tweet.id_str))</span>
<a href="#l20.35"></a><span id="l20.35">         continue;</span>
<a href="#l20.36"></a><span id="l20.36">       let id = tweet.id_str;</span>
<a href="#l20.37"></a><span id="l20.37">       // Update the last known message.</span>
<a href="#l20.38"></a><span id="l20.38">       // Compare the length of the ids first, and then the text.</span>
<a href="#l20.39"></a><span id="l20.39">       // This avoids converting tweet ids into rounded numbers.</span>
<a href="#l20.40"></a><span id="l20.40">       if (id.length &gt; lastMsgId.length ||</span>
<a href="#l20.41"></a><span id="l20.41" class="difflineat">@@ -737,33 +737,33 @@ Account.prototype = {</span>
<a href="#l20.42"></a><span id="l20.42">     this.gotDisconnected(Ci.prplIAccount.ERROR_NETWORK_ERROR, &quot;timeout&quot;);</span>
<a href="#l20.43"></a><span id="l20.43">   },</span>
<a href="#l20.44"></a><span id="l20.44">   onDataAvailable: function(aRequest) {</span>
<a href="#l20.45"></a><span id="l20.45">     this.resetStreamTimeout();</span>
<a href="#l20.46"></a><span id="l20.46">     let newText = this._pendingData + aRequest.target.response;</span>
<a href="#l20.47"></a><span id="l20.47">     this.DEBUG(&quot;Received data: &quot; + newText);</span>
<a href="#l20.48"></a><span id="l20.48">     let messages = newText.split(/\r\n?/);</span>
<a href="#l20.49"></a><span id="l20.49">     this._pendingData = messages.pop();</span>
<a href="#l20.50"></a><span id="l20.50" class="difflineminus">-    for each (let message in messages) {</span>
<a href="#l20.51"></a><span id="l20.51" class="difflineplus">+    for (let message of messages) {</span>
<a href="#l20.52"></a><span id="l20.52">       if (!message.trim())</span>
<a href="#l20.53"></a><span id="l20.53">         continue;</span>
<a href="#l20.54"></a><span id="l20.54">       let msg;</span>
<a href="#l20.55"></a><span id="l20.55">       try {</span>
<a href="#l20.56"></a><span id="l20.56">         msg = JSON.parse(message);</span>
<a href="#l20.57"></a><span id="l20.57">       } catch (e) {</span>
<a href="#l20.58"></a><span id="l20.58">         this.ERROR(e + &quot; while parsing &quot; + message);</span>
<a href="#l20.59"></a><span id="l20.59">         continue;</span>
<a href="#l20.60"></a><span id="l20.60">       }</span>
<a href="#l20.61"></a><span id="l20.61">       if (&quot;text&quot; in msg)</span>
<a href="#l20.62"></a><span id="l20.62">         this.displayMessages([msg]);</span>
<a href="#l20.63"></a><span id="l20.63">       else if (&quot;friends&quot; in msg) {</span>
<a href="#l20.64"></a><span id="l20.64">         // Filter out the IDs that info has already been received from (e.g. a</span>
<a href="#l20.65"></a><span id="l20.65">         // tweet has been received as part of the timeline request).</span>
<a href="#l20.66"></a><span id="l20.66">         let userInfoIds = new Set();</span>
<a href="#l20.67"></a><span id="l20.67" class="difflineminus">-        for each (let userInfo in this._userInfo)</span>
<a href="#l20.68"></a><span id="l20.68" class="difflineplus">+        for (let userInfo of this._userInfo.values())</span>
<a href="#l20.69"></a><span id="l20.69">           userInfoIds.add(userInfo.id_str);</span>
<a href="#l20.70"></a><span id="l20.70">         let ids = msg.friends.filter(</span>
<a href="#l20.71"></a><span id="l20.71">           aId =&gt; !userInfoIds.has(aId.toString()));</span>
<a href="#l20.72"></a><span id="l20.72"> </span>
<a href="#l20.73"></a><span id="l20.73">         while (ids.length) {</span>
<a href="#l20.74"></a><span id="l20.74">           // Take the first 100 elements, turn them into a comma separated list.</span>
<a href="#l20.75"></a><span id="l20.75">           this.signAndSend(&quot;1.1/users/lookup.json&quot;, null,</span>
<a href="#l20.76"></a><span id="l20.76">                            [[&quot;user_id&quot;, ids.slice(0, 99).join(&quot;,&quot;)]],</span>
<a href="#l20.77"></a><span id="l20.77" class="difflineat">@@ -947,17 +947,17 @@ Account.prototype = {</span>
<a href="#l20.78"></a><span id="l20.78">              this.name + &quot; -&gt; &quot; + aAuthResult.screen_name);</span>
<a href="#l20.79"></a><span id="l20.79">     this.__defineGetter__(&quot;name&quot;, () =&gt; aAuthResult.screen_name);</span>
<a href="#l20.80"></a><span id="l20.80">     return true;</span>
<a href="#l20.81"></a><span id="l20.81">   },</span>
<a href="#l20.82"></a><span id="l20.82"> </span>
<a href="#l20.83"></a><span id="l20.83">   cleanUp: function() {</span>
<a href="#l20.84"></a><span id="l20.84">     this.finishAuthorizationRequest();</span>
<a href="#l20.85"></a><span id="l20.85">     if (this._pendingRequests.length != 0) {</span>
<a href="#l20.86"></a><span id="l20.86" class="difflineminus">-      for each (let request in this._pendingRequests)</span>
<a href="#l20.87"></a><span id="l20.87" class="difflineplus">+      for (let request of this._pendingRequests)</span>
<a href="#l20.88"></a><span id="l20.88">         request.abort();</span>
<a href="#l20.89"></a><span id="l20.89">       delete this._pendingRequests;</span>
<a href="#l20.90"></a><span id="l20.90">     }</span>
<a href="#l20.91"></a><span id="l20.91">     if (this._streamTimeout) {</span>
<a href="#l20.92"></a><span id="l20.92">       clearTimeout(this._streamTimeout);</span>
<a href="#l20.93"></a><span id="l20.93">       delete this._streamTimeout;</span>
<a href="#l20.94"></a><span id="l20.94">       // Remove the preference observer that is added when the user stream is</span>
<a href="#l20.95"></a><span id="l20.95">       // opened. (This needs to be removed even if an error occurs, in which</span>
<a href="#l20.96"></a><span id="l20.96" class="difflineat">@@ -1084,17 +1084,17 @@ Account.prototype = {</span>
<a href="#l20.97"></a><span id="l20.97">     Services.obs.notifyObservers(new nsSimpleEnumerator(tooltipInfo),</span>
<a href="#l20.98"></a><span id="l20.98">                                  &quot;user-info-received&quot;, aBuddyName);</span>
<a href="#l20.99"></a><span id="l20.99">   },</span>
<a href="#l20.100"></a><span id="l20.100"> </span>
<a href="#l20.101"></a><span id="l20.101">   // Handle the full user info for each received friend. Set the user info and</span>
<a href="#l20.102"></a><span id="l20.102">   // create the participant.</span>
<a href="#l20.103"></a><span id="l20.103">   onLookupReceived: function(aData) {</span>
<a href="#l20.104"></a><span id="l20.104">     let users = JSON.parse(aData);</span>
<a href="#l20.105"></a><span id="l20.105" class="difflineminus">-    for each (let user in users) {</span>
<a href="#l20.106"></a><span id="l20.106" class="difflineplus">+    for (let user of users) {</span>
<a href="#l20.107"></a><span id="l20.107">       this.setUserInfo(user);</span>
<a href="#l20.108"></a><span id="l20.108">       this.timeline._ensureParticipantExists(user.screen_name);</span>
<a href="#l20.109"></a><span id="l20.109">     }</span>
<a href="#l20.110"></a><span id="l20.110">   },</span>
<a href="#l20.111"></a><span id="l20.111"> </span>
<a href="#l20.112"></a><span id="l20.112">   onConfigReceived: function(aData) {</span>
<a href="#l20.113"></a><span id="l20.113">     this.config = JSON.parse(aData);</span>
<a href="#l20.114"></a><span id="l20.114">   },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/chat/protocols/xmpp/xmpp-authmechs.jsm</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/chat/protocols/xmpp/xmpp-authmechs.jsm</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -84,17 +84,17 @@ DigestMD5Auth.prototype = {</span>
<a href="#l21.4"></a><span id="l21.4">       send: Stanza.node(&quot;auth&quot;, Stanza.NS.sasl, {mechanism: &quot;DIGEST-MD5&quot;})</span>
<a href="#l21.5"></a><span id="l21.5">     };</span>
<a href="#l21.6"></a><span id="l21.6">   },</span>
<a href="#l21.7"></a><span id="l21.7"> </span>
<a href="#l21.8"></a><span id="l21.8">   _generateResponse: function(aStanza) {</span>
<a href="#l21.9"></a><span id="l21.9">     let decoded = atob(aStanza.innerText.replace(/[^A-Za-z0-9\+\/\=]/g, &quot;&quot;));</span>
<a href="#l21.10"></a><span id="l21.10">     let data = {realm: &quot;&quot;};</span>
<a href="#l21.11"></a><span id="l21.11"> </span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-    for each (let elem in decoded.split(/, */)) {</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+    for (let elem of decoded.split(/, */)) {</span>
<a href="#l21.14"></a><span id="l21.14">       // Find the first = and use that to split the nonce from the value.</span>
<a href="#l21.15"></a><span id="l21.15">       let index = elem.indexOf(&quot;=&quot;);</span>
<a href="#l21.16"></a><span id="l21.16">       if (index == -1)</span>
<a href="#l21.17"></a><span id="l21.17">         throw &quot;Error decoding: &quot; + elem;</span>
<a href="#l21.18"></a><span id="l21.18"> </span>
<a href="#l21.19"></a><span id="l21.19">       // Remove leading and trailing single or double quote, and then remove \ escaping.</span>
<a href="#l21.20"></a><span id="l21.20">       data[elem.slice(0, index)] =</span>
<a href="#l21.21"></a><span id="l21.21">         elem.slice(index + 1).replace(/^[&quot;']|[&quot;']$/g, &quot;&quot;).replace(/\\(.)/g, &quot;$1&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/chat/protocols/xmpp/xmpp-session.jsm</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/chat/protocols/xmpp/xmpp-session.jsm</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -454,17 +454,17 @@ XMPPSession.prototype = {</span>
<a href="#l22.4"></a><span id="l22.4">         // Success!</span>
<a href="#l22.5"></a><span id="l22.5">         this._password = null;</span>
<a href="#l22.6"></a><span id="l22.6">         this.startSession();</span>
<a href="#l22.7"></a><span id="l22.7">         return;</span>
<a href="#l22.8"></a><span id="l22.8">       }</span>
<a href="#l22.9"></a><span id="l22.9"> </span>
<a href="#l22.10"></a><span id="l22.10">       let query = aStanza.getElement([&quot;query&quot;]);</span>
<a href="#l22.11"></a><span id="l22.11">       let values = {};</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-      for each (let c in query.children)</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineplus">+      for (let c of query.children)</span>
<a href="#l22.14"></a><span id="l22.14">         values[c.qName] = c.innerText;</span>
<a href="#l22.15"></a><span id="l22.15"> </span>
<a href="#l22.16"></a><span id="l22.16">       if (!(&quot;username&quot; in values) || !(&quot;resource&quot; in values)) {</span>
<a href="#l22.17"></a><span id="l22.17">         this._networkError(_(&quot;connection.error.incorrectResponse&quot;));</span>
<a href="#l22.18"></a><span id="l22.18">         return;</span>
<a href="#l22.19"></a><span id="l22.19">       }</span>
<a href="#l22.20"></a><span id="l22.20"> </span>
<a href="#l22.21"></a><span id="l22.21">       let children = [</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/chat/protocols/xmpp/xmpp-xml.jsm</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/chat/protocols/xmpp/xmpp-xml.jsm</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -230,17 +230,17 @@ XMLNode.prototype = {</span>
<a href="#l23.4"></a><span id="l23.4">      A query consists of an array of localNames. */</span>
<a href="#l23.5"></a><span id="l23.5">   getElements: function(aQuery) {</span>
<a href="#l23.6"></a><span id="l23.6">     if (aQuery.length == 0)</span>
<a href="#l23.7"></a><span id="l23.7">       return [this];</span>
<a href="#l23.8"></a><span id="l23.8"> </span>
<a href="#l23.9"></a><span id="l23.9">     let c = this.getChildren(aQuery[0]);</span>
<a href="#l23.10"></a><span id="l23.10">     let nq = aQuery.slice(1);</span>
<a href="#l23.11"></a><span id="l23.11">     let res = [];</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-    for each (let child in c) {</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineplus">+    for (let child of c) {</span>
<a href="#l23.14"></a><span id="l23.14">       let n = child.getElements(nq);</span>
<a href="#l23.15"></a><span id="l23.15">       res = res.concat(n);</span>
<a href="#l23.16"></a><span id="l23.16">     }</span>
<a href="#l23.17"></a><span id="l23.17"> </span>
<a href="#l23.18"></a><span id="l23.18">     return res;</span>
<a href="#l23.19"></a><span id="l23.19">   },</span>
<a href="#l23.20"></a><span id="l23.20"> </span>
<a href="#l23.21"></a><span id="l23.21">   /* Get immediate children by the node name */</span>
<a href="#l23.22"></a><span id="l23.22" class="difflineat">@@ -256,17 +256,17 @@ XMLNode.prototype = {</span>
<a href="#l23.23"></a><span id="l23.23">     return ns == this.uri || (Array.isArray(ns) &amp;&amp; ns.indexOf(this.uri) != -1);</span>
<a href="#l23.24"></a><span id="l23.24">   },</span>
<a href="#l23.25"></a><span id="l23.25"> </span>
<a href="#l23.26"></a><span id="l23.26">   /* Returns indented XML */</span>
<a href="#l23.27"></a><span id="l23.27">   convertToString: function(aIndent = &quot;&quot;) {</span>
<a href="#l23.28"></a><span id="l23.28">     let s =</span>
<a href="#l23.29"></a><span id="l23.29">       aIndent + &quot;&lt;&quot; + this.qName + this._getXmlns() + this._getAttributeText();</span>
<a href="#l23.30"></a><span id="l23.30">     let content = &quot;&quot;;</span>
<a href="#l23.31"></a><span id="l23.31" class="difflineminus">-    for each (let child in this.children)</span>
<a href="#l23.32"></a><span id="l23.32" class="difflineplus">+    for (let child of this.children)</span>
<a href="#l23.33"></a><span id="l23.33">       content += child.convertToString(aIndent + &quot; &quot;);</span>
<a href="#l23.34"></a><span id="l23.34">     return s + (content ? &quot;&gt;\n&quot; + content + aIndent + &quot;&lt;/&quot; + this.qName : &quot;/&quot;) + &quot;&gt;\n&quot;;</span>
<a href="#l23.35"></a><span id="l23.35">   },</span>
<a href="#l23.36"></a><span id="l23.36"> </span>
<a href="#l23.37"></a><span id="l23.37">   /* Returns the XML */</span>
<a href="#l23.38"></a><span id="l23.38">   getXML: function() {</span>
<a href="#l23.39"></a><span id="l23.39">     let s = &quot;&lt;&quot; + this.qName + this._getXmlns() + this._getAttributeText();</span>
<a href="#l23.40"></a><span id="l23.40">     let innerXML = this.innerXML;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/chat/protocols/xmpp/xmpp.jsm</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/chat/protocols/xmpp/xmpp.jsm</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -1994,17 +1994,17 @@ var XMPPAccountPrototype = {</span>
<a href="#l24.4"></a><span id="l24.4">             buddy._tag = Services.tags.createTag(tagName);</span>
<a href="#l24.5"></a><span id="l24.5">             Services.contacts.accountBuddyMoved(buddy, oldTag, buddy._tag);</span>
<a href="#l24.6"></a><span id="l24.6">           }</span>
<a href="#l24.7"></a><span id="l24.7">         }</span>
<a href="#l24.8"></a><span id="l24.8">       }</span>
<a href="#l24.9"></a><span id="l24.9">     }</span>
<a href="#l24.10"></a><span id="l24.10">     else {</span>
<a href="#l24.11"></a><span id="l24.11">       let tag;</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-      for each (let group in aItem.getChildren(&quot;group&quot;)) {</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineplus">+      for (let group of aItem.getChildren(&quot;group&quot;)) {</span>
<a href="#l24.14"></a><span id="l24.14">         let name = group.innerText;</span>
<a href="#l24.15"></a><span id="l24.15">         if (name) {</span>
<a href="#l24.16"></a><span id="l24.16">           tag = Services.tags.createTag(name);</span>
<a href="#l24.17"></a><span id="l24.17">           break; // TODO we should create an accountBuddy per group,</span>
<a href="#l24.18"></a><span id="l24.18">                  // but this._buddies would probably not like that...</span>
<a href="#l24.19"></a><span id="l24.19">         }</span>
<a href="#l24.20"></a><span id="l24.20">       }</span>
<a href="#l24.21"></a><span id="l24.21">       buddy = new this._accountBuddyConstructor(this, null,</span>
<a href="#l24.22"></a><span id="l24.22" class="difflineat">@@ -2045,23 +2045,23 @@ var XMPPAccountPrototype = {</span>
<a href="#l24.23"></a><span id="l24.23">   _forgetRosterItem: function(aJID) {</span>
<a href="#l24.24"></a><span id="l24.24">     Services.contacts.accountBuddyRemoved(this._buddies.get(aJID));</span>
<a href="#l24.25"></a><span id="l24.25">     this._buddies.delete(aJID);</span>
<a href="#l24.26"></a><span id="l24.26">   },</span>
<a href="#l24.27"></a><span id="l24.27"> </span>
<a href="#l24.28"></a><span id="l24.28">   /* When the roster is received */</span>
<a href="#l24.29"></a><span id="l24.29">   onRoster: function(aStanza) {</span>
<a href="#l24.30"></a><span id="l24.30">     // For the first element that is a roster stanza.</span>
<a href="#l24.31"></a><span id="l24.31" class="difflineminus">-    for each (let qe in aStanza.getChildren(&quot;query&quot;)) {</span>
<a href="#l24.32"></a><span id="l24.32" class="difflineplus">+    for (let qe of aStanza.getChildren(&quot;query&quot;)) {</span>
<a href="#l24.33"></a><span id="l24.33">       if (qe.uri != Stanza.NS.roster)</span>
<a href="#l24.34"></a><span id="l24.34">         continue;</span>
<a href="#l24.35"></a><span id="l24.35"> </span>
<a href="#l24.36"></a><span id="l24.36">       // Find all the roster items in the new message.</span>
<a href="#l24.37"></a><span id="l24.37">       let newRoster = new Set();</span>
<a href="#l24.38"></a><span id="l24.38" class="difflineminus">-      for each (let item in qe.getChildren(&quot;item&quot;)) {</span>
<a href="#l24.39"></a><span id="l24.39" class="difflineplus">+      for (let item of qe.getChildren(&quot;item&quot;)) {</span>
<a href="#l24.40"></a><span id="l24.40">         let jid = this._onRosterItem(item);</span>
<a href="#l24.41"></a><span id="l24.41">         if (jid)</span>
<a href="#l24.42"></a><span id="l24.42">           newRoster.add(jid);</span>
<a href="#l24.43"></a><span id="l24.43">       }</span>
<a href="#l24.44"></a><span id="l24.44">       // If an item was in the old roster, but not in the new, forget it.</span>
<a href="#l24.45"></a><span id="l24.45">       for (let jid of this._buddies.keys()) {</span>
<a href="#l24.46"></a><span id="l24.46">         if (!newRoster.has(jid))</span>
<a href="#l24.47"></a><span id="l24.47">           this._forgetRosterItem(jid);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/chat/protocols/yahoo/test/test_yahooAccount.js</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/chat/protocols/yahoo/test/test_yahooAccount.js</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -26,17 +26,17 @@ function test_cleanUsername()</span>
<a href="#l25.4"></a><span id="l25.4">     id: &quot;fake-proto&quot;,</span>
<a href="#l25.5"></a><span id="l25.5">     options: {</span>
<a href="#l25.6"></a><span id="l25.6">       local_charset: &quot;UTF-8&quot;</span>
<a href="#l25.7"></a><span id="l25.7">     },</span>
<a href="#l25.8"></a><span id="l25.8">     _getOptionDefault: function(aOption) { return this.options[aOption]; }</span>
<a href="#l25.9"></a><span id="l25.9">   };</span>
<a href="#l25.10"></a><span id="l25.10">   let fakeImAccount = {};</span>
<a href="#l25.11"></a><span id="l25.11"> </span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-  for each(let domain in domains) {</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineplus">+  for (let domain of domains) {</span>
<a href="#l25.14"></a><span id="l25.14">     fakeImAccount.name = userId + &quot;@&quot; + domain;</span>
<a href="#l25.15"></a><span id="l25.15">     let yahooAccount = new yahoo.YahooAccount(fakeProtocol, fakeImAccount);</span>
<a href="#l25.16"></a><span id="l25.16">     do_check_eq(userId, yahooAccount.cleanUsername);</span>
<a href="#l25.17"></a><span id="l25.17">   }</span>
<a href="#l25.18"></a><span id="l25.18">   run_next_test();</span>
<a href="#l25.19"></a><span id="l25.19"> }</span>
<a href="#l25.20"></a><span id="l25.20"> </span>
<a href="#l25.21"></a><span id="l25.21"> // Test the _fixFontSize() method and ensure that it correctly fixes font sizes</span>
<a href="#l25.22"></a><span id="l25.22" class="difflineat">@@ -84,15 +84,15 @@ function test_fixFontSize()</span>
<a href="#l25.23"></a><span id="l25.23">     writeMessage: function(aName, aMessage, aProperties) {</span>
<a href="#l25.24"></a><span id="l25.24">       do_check_eq(aMessage, messagePair[1]); // Compare to the good message.</span>
<a href="#l25.25"></a><span id="l25.25">     },</span>
<a href="#l25.26"></a><span id="l25.26">     updateTyping: function(aStatus, aName) { }</span>
<a href="#l25.27"></a><span id="l25.27">   };</span>
<a href="#l25.28"></a><span id="l25.28"> </span>
<a href="#l25.29"></a><span id="l25.29">   let yahooAccount = new yahoo.YahooAccount(fakeProtocol, fakeImAccount);</span>
<a href="#l25.30"></a><span id="l25.30">   yahooAccount._conversations.set(&quot;test-user&quot;, fakeConversation);</span>
<a href="#l25.31"></a><span id="l25.31" class="difflineminus">-  for each(let pair in testMessages) {</span>
<a href="#l25.32"></a><span id="l25.32" class="difflineplus">+  for (let pair of testMessages) {</span>
<a href="#l25.33"></a><span id="l25.33">     messagePair = pair;</span>
<a href="#l25.34"></a><span id="l25.34">     // Send in the badly formed message.</span>
<a href="#l25.35"></a><span id="l25.35">     yahooAccount.receiveMessage(&quot;test-user&quot;, messagePair[0]);</span>
<a href="#l25.36"></a><span id="l25.36">   }</span>
<a href="#l25.37"></a><span id="l25.37">   run_next_test();</span>
<a href="#l25.38"></a><span id="l25.38"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/chat/protocols/yahoo/yahoo-session.jsm</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/chat/protocols/yahoo/yahoo-session.jsm</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -436,17 +436,17 @@ YahooSession.prototype = {</span>
<a href="#l26.4"></a><span id="l26.4">     try {</span>
<a href="#l26.5"></a><span id="l26.5">       [packets, bytesHandled] = YahooPacket.extractPackets(aData);</span>
<a href="#l26.6"></a><span id="l26.6">     } catch(e) {</span>
<a href="#l26.7"></a><span id="l26.7">       this._account.ERROR(e);</span>
<a href="#l26.8"></a><span id="l26.8">       this.onSessionError(Ci.prplIAccount.NETWORK_ERROR, &quot;&quot;);</span>
<a href="#l26.9"></a><span id="l26.9">       return 0;</span>
<a href="#l26.10"></a><span id="l26.10">     }</span>
<a href="#l26.11"></a><span id="l26.11"> </span>
<a href="#l26.12"></a><span id="l26.12" class="difflineminus">-    for each (let packet in packets) {</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineplus">+    for (let packet of packets) {</span>
<a href="#l26.14"></a><span id="l26.14">       this._account.LOG(&quot;Received Packet:\n&quot; + packet.toString());</span>
<a href="#l26.15"></a><span id="l26.15">       if (YahooPacketHandler.hasOwnProperty(packet.service)) {</span>
<a href="#l26.16"></a><span id="l26.16">         try {</span>
<a href="#l26.17"></a><span id="l26.17">           YahooPacketHandler[packet.service].call(this._account, packet);</span>
<a href="#l26.18"></a><span id="l26.18">         } catch(e) {</span>
<a href="#l26.19"></a><span id="l26.19">           this._account.ERROR(e);</span>
<a href="#l26.20"></a><span id="l26.20">         }</span>
<a href="#l26.21"></a><span id="l26.21">       } else {</span>
<a href="#l26.22"></a><span id="l26.22" class="difflineat">@@ -694,17 +694,17 @@ YahooPacket.prototype = {</span>
<a href="#l26.23"></a><span id="l26.23">     };</span>
<a href="#l26.24"></a><span id="l26.24"> </span>
<a href="#l26.25"></a><span id="l26.25">     this.keyValuePairs.push(pair);</span>
<a href="#l26.26"></a><span id="l26.26">   },</span>
<a href="#l26.27"></a><span id="l26.27"> </span>
<a href="#l26.28"></a><span id="l26.28">   // Add multiple key/value pairs with the same key but different values</span>
<a href="#l26.29"></a><span id="l26.29">   // stored in an array.</span>
<a href="#l26.30"></a><span id="l26.30">   addValues: function(aKey, aValues) {</span>
<a href="#l26.31"></a><span id="l26.31" class="difflineminus">-    for each (let value in aValues)</span>
<a href="#l26.32"></a><span id="l26.32" class="difflineplus">+    for (let value of aValues)</span>
<a href="#l26.33"></a><span id="l26.33">       this.addValue(aKey, value);</span>
<a href="#l26.34"></a><span id="l26.34">   },</span>
<a href="#l26.35"></a><span id="l26.35"> </span>
<a href="#l26.36"></a><span id="l26.36">   // This method returns the first value found with the given key.</span>
<a href="#l26.37"></a><span id="l26.37">   getValue: function(aKey) {</span>
<a href="#l26.38"></a><span id="l26.38">     for (let i = 0; i &lt; this.keyValuePairs.length; ++i) {</span>
<a href="#l26.39"></a><span id="l26.39">       let pair = this.keyValuePairs[i];</span>
<a href="#l26.40"></a><span id="l26.40">       // The server handles keys as ASCII number values.</span>
<a href="#l26.41"></a><span id="l26.41" class="difflineat">@@ -814,17 +814,17 @@ YahooPacket.prototype = {</span>
<a href="#l26.42"></a><span id="l26.42">     // First, add packet header information.</span>
<a href="#l26.43"></a><span id="l26.43">     let s = &quot;Service: 0x&quot; + this.service.toString(16) + &quot;\n&quot;;</span>
<a href="#l26.44"></a><span id="l26.44">     s += &quot;Status: 0x&quot; + this.status.toString(16) + &quot;\n&quot;;</span>
<a href="#l26.45"></a><span id="l26.45">     s += &quot;Session ID: 0x&quot; + this.sessionId.toString(16);</span>
<a href="#l26.46"></a><span id="l26.46">     // Now we add the packet data, if there is some.</span>
<a href="#l26.47"></a><span id="l26.47">     if (this.keyValuePairs.length) {</span>
<a href="#l26.48"></a><span id="l26.48">       // Add two preceding newlines for space to make reading easier.</span>
<a href="#l26.49"></a><span id="l26.49">       s += &quot;\n\nPacket Key-Value Data:\n&quot;;</span>
<a href="#l26.50"></a><span id="l26.50" class="difflineminus">-      for each (let pair in this.keyValuePairs)</span>
<a href="#l26.51"></a><span id="l26.51" class="difflineplus">+      for (let pair of this.keyValuePairs)</span>
<a href="#l26.52"></a><span id="l26.52">         s += pair.key + &quot;:\t&quot; + pair.value + &quot;\n&quot;;</span>
<a href="#l26.53"></a><span id="l26.53">     }</span>
<a href="#l26.54"></a><span id="l26.54">     return s;</span>
<a href="#l26.55"></a><span id="l26.55">   }</span>
<a href="#l26.56"></a><span id="l26.56"> };</span>
<a href="#l26.57"></a><span id="l26.57"> YahooPacket.extractPackets = function(aData, aOnNetworkError) {</span>
<a href="#l26.58"></a><span id="l26.58">   let packets = [];</span>
<a href="#l26.59"></a><span id="l26.59">   let bytesHandled = 0;</span>
<a href="#l26.60"></a><span id="l26.60" class="difflineat">@@ -963,17 +963,17 @@ var YahooPacketHandler = {</span>
<a href="#l26.61"></a><span id="l26.61">    this.removeBuddy(buddy, false);</span>
<a href="#l26.62"></a><span id="l26.62">   },</span>
<a href="#l26.63"></a><span id="l26.63"> </span>
<a href="#l26.64"></a><span id="l26.64">   // Picture upload.</span>
<a href="#l26.65"></a><span id="l26.65">   0xc2: function(aPacket) {</span>
<a href="#l26.66"></a><span id="l26.66">     let onlineBuddies = this.getOnlineBuddies();</span>
<a href="#l26.67"></a><span id="l26.67">     // Send a notification to each online buddy that your icon has changed.</span>
<a href="#l26.68"></a><span id="l26.68">     // Those offline will automatically pick up the change when they log in.</span>
<a href="#l26.69"></a><span id="l26.69" class="difflineminus">-    for each (let buddy in onlineBuddies) {</span>
<a href="#l26.70"></a><span id="l26.70" class="difflineplus">+    for (let buddy of onlineBuddies) {</span>
<a href="#l26.71"></a><span id="l26.71">       let packet = new YahooPacket(kPacketType.AvatarUpdate, 0,</span>
<a href="#l26.72"></a><span id="l26.72">                                    this._session.sessionId);</span>
<a href="#l26.73"></a><span id="l26.73">       packet.addValue(3, buddy.userName);</span>
<a href="#l26.74"></a><span id="l26.74">       packet.addValue(213, 2); // A value of 2 means we are using an icon.</span>
<a href="#l26.75"></a><span id="l26.75">       this._session.sendPacket(packet);</span>
<a href="#l26.76"></a><span id="l26.76">     }</span>
<a href="#l26.77"></a><span id="l26.77">   },</span>
<a href="#l26.78"></a><span id="l26.78"> </span>
<a href="#l26.79"></a><span id="l26.79" class="difflineat">@@ -1064,17 +1064,17 @@ var YahooPacketHandler = {</span>
<a href="#l26.80"></a><span id="l26.80">       else if (key == 60) // Mobile status.</span>
<a href="#l26.81"></a><span id="l26.81">         this.setBuddyStatus(currentBuddyName, Ci.imIStatus.STATUS_MOBILE);</span>
<a href="#l26.82"></a><span id="l26.82">     }</span>
<a href="#l26.83"></a><span id="l26.83">   },</span>
<a href="#l26.84"></a><span id="l26.84"> </span>
<a href="#l26.85"></a><span id="l26.85">   // Friends and groups list.</span>
<a href="#l26.86"></a><span id="l26.86">   0xf1: function(aPacket) {</span>
<a href="#l26.87"></a><span id="l26.87">     let tagName = &quot;&quot;;</span>
<a href="#l26.88"></a><span id="l26.88" class="difflineminus">-    for each (let pair in aPacket.keyValuePairs) {</span>
<a href="#l26.89"></a><span id="l26.89" class="difflineplus">+    for (let pair of aPacket.keyValuePairs) {</span>
<a href="#l26.90"></a><span id="l26.90">       if (pair.key == &quot;65&quot;)</span>
<a href="#l26.91"></a><span id="l26.91">         tagName = pair.value;</span>
<a href="#l26.92"></a><span id="l26.92">       else if (pair.key == &quot;7&quot;) {</span>
<a href="#l26.93"></a><span id="l26.93">         let buddyName = pair.value;</span>
<a href="#l26.94"></a><span id="l26.94">         this.addBuddyFromServer(Services.tags.createTag(tagName), buddyName);</span>
<a href="#l26.95"></a><span id="l26.95">       }</span>
<a href="#l26.96"></a><span id="l26.96">     }</span>
<a href="#l26.97"></a><span id="l26.97">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/chat/protocols/yahoo/yahoo.js</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/chat/protocols/yahoo/yahoo.js</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -228,17 +228,17 @@ YahooAccount.prototype = {</span>
<a href="#l27.4"></a><span id="l27.4">   observe: function(aSubject, aTopic, aData) {</span>
<a href="#l27.5"></a><span id="l27.5">     if (aTopic == &quot;status-changed&quot;)</span>
<a href="#l27.6"></a><span id="l27.6">       this._session.setStatus(aSubject.statusType, aData);</span>
<a href="#l27.7"></a><span id="l27.7">     else if (aTopic == &quot;user-icon-changed&quot;)</span>
<a href="#l27.8"></a><span id="l27.8">       this._session.setProfileIcon(aData);</span>
<a href="#l27.9"></a><span id="l27.9">   },</span>
<a href="#l27.10"></a><span id="l27.10"> </span>
<a href="#l27.11"></a><span id="l27.11">   remove: function() {</span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-    for each(let conv in this._conversations)</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineplus">+    for (let conv of this._conversations.values())</span>
<a href="#l27.14"></a><span id="l27.14">       conv.close();</span>
<a href="#l27.15"></a><span id="l27.15">     delete this._conversations;</span>
<a href="#l27.16"></a><span id="l27.16">     for (let buddy of this._buddies)</span>
<a href="#l27.17"></a><span id="l27.17">       buddy[1].removeLocal(); // buddy[1] is the actual object.</span>
<a href="#l27.18"></a><span id="l27.18">   },</span>
<a href="#l27.19"></a><span id="l27.19"> </span>
<a href="#l27.20"></a><span id="l27.20">   unInit: function() {</span>
<a href="#l27.21"></a><span id="l27.21">     this.disconnect(true);</span>
<a href="#l27.22"></a><span id="l27.22" class="difflineat">@@ -260,17 +260,17 @@ YahooAccount.prototype = {</span>
<a href="#l27.23"></a><span id="l27.23">     // Do nothing if we wish to ignore invites.</span>
<a href="#l27.24"></a><span id="l27.24">     if (!Services.prefs.getIntPref(&quot;messenger.conversations.autoAcceptChatInvitations&quot;) ||</span>
<a href="#l27.25"></a><span id="l27.25">         this.getBool(&quot;ignore_invites&quot;))</span>
<a href="#l27.26"></a><span id="l27.26">       return;</span>
<a href="#l27.27"></a><span id="l27.27"> </span>
<a href="#l27.28"></a><span id="l27.28">     let conf = new YahooConference(this, aRoom, aOwner);</span>
<a href="#l27.29"></a><span id="l27.29">     this._conferences.set(aRoom, conf);</span>
<a href="#l27.30"></a><span id="l27.30"> </span>
<a href="#l27.31"></a><span id="l27.31" class="difflineminus">-    for each (let participant in aParticipants)</span>
<a href="#l27.32"></a><span id="l27.32" class="difflineplus">+    for (let participant of aParticipants)</span>
<a href="#l27.33"></a><span id="l27.33">       conf.addParticipant(participant);</span>
<a href="#l27.34"></a><span id="l27.34"> </span>
<a href="#l27.35"></a><span id="l27.35">     // Add ourselves to the conference room as well.</span>
<a href="#l27.36"></a><span id="l27.36">     conf.addParticipant(this.imAccount.name);</span>
<a href="#l27.37"></a><span id="l27.37"> </span>
<a href="#l27.38"></a><span id="l27.38">     this._session.acceptConferenceInvite(aOwner, aRoom,</span>
<a href="#l27.39"></a><span id="l27.39">                                          conf.getParticipantNames());</span>
<a href="#l27.40"></a><span id="l27.40">   },</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

