<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 6630:5f559a9ea61dc2ac68eb733c8993efbd0b8efabc</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 5f559a9ea61dc2ac68eb733c8993efbd0b8efabc" />
<meta property="og:url" content="/comm-central/rev/5f559a9ea61dc2ac68eb733c8993efbd0b8efabc" />
<meta property="og:description" content="Bug 608638 - Get rid of the Netscape 4.x profile migration, r=Standard8" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 5f559a9ea61dc2ac68eb733c8993efbd0b8efabc 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/5f559a9ea61dc2ac68eb733c8993efbd0b8efabc">shortlog</a> |
<a href="/comm-central/log/5f559a9ea61dc2ac68eb733c8993efbd0b8efabc">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/5f559a9ea61dc2ac68eb733c8993efbd0b8efabc">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/5f559a9ea61dc2ac68eb733c8993efbd0b8efabc">files</a> |
changeset |
<a href="/comm-central/raw-rev/5f559a9ea61dc2ac68eb733c8993efbd0b8efabc">raw</a>  | <a href="/comm-central/archive/5f559a9ea61dc2ac68eb733c8993efbd0b8efabc.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=608638">Bug 608638</a> - Get rid of the Netscape 4.x profile migration, r=Standard8
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#80;&#104;&#105;&#108;&#32;&#82;&#105;&#110;&#103;&#110;&#97;&#108;&#100;&#97;&#32;&#60;&#112;&#104;&#105;&#108;&#114;&#105;&#110;&#103;&#110;&#97;&#108;&#100;&#97;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Sun, 31 Oct 2010 21:02:40 -0700</td></tr>

<tr>
 <td>changeset 6630</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/5f559a9ea61dc2ac68eb733c8993efbd0b8efabc">5f559a9ea61dc2ac68eb733c8993efbd0b8efabc</a></td>
</tr>



<tr>
<td>parent 6629</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/712e1423558de04a3f9a2ecf9072cc540159212d">712e1423558de04a3f9a2ecf9072cc540159212d</a>
</td>
</tr>

<tr>
<td>child 6631</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/280c04fcaab13326e1a5a7b7bca4d6abedd74f77">280c04fcaab13326e1a5a7b7bca4d6abedd74f77</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=5f559a9ea61dc2ac68eb733c8993efbd0b8efabc">5102</a></td></tr>
<tr><td>push user</td><td>philringnalda@gmail.com</td></tr>
<tr><td>push date</td><td class="date age">Mon, 01 Nov 2010 23:20:24 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@5f559a9ea61d [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=5f559a9ea61dc2ac68eb733c8993efbd0b8efabc">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=5f559a9ea61dc2ac68eb733c8993efbd0b8efabc&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=5f559a9ea61dc2ac68eb733c8993efbd0b8efabc&newProject=comm-central&newRevision=712e1423558de04a3f9a2ecf9072cc540159212d&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=5f559a9ea61dc2ac68eb733c8993efbd0b8efabc&newProject=comm-central&newRevision=712e1423558de04a3f9a2ecf9072cc540159212d&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=5f559a9ea61dc2ac68eb733c8993efbd0b8efabc&newProject=comm-central&newRevision=712e1423558de04a3f9a2ecf9072cc540159212d&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28Standard8%29&revcount=50">Standard8</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=608638">608638</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=608638">Bug 608638</a> - Get rid of the Netscape 4.x profile migration, r=Standard8</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5f559a9ea61dc2ac68eb733c8993efbd0b8efabc/mail/app/profile/all-thunderbird.js">mail/app/profile/all-thunderbird.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5f559a9ea61dc2ac68eb733c8993efbd0b8efabc/mail/app/profile/all-thunderbird.js">file</a> |
<a href="/comm-central/annotate/5f559a9ea61dc2ac68eb733c8993efbd0b8efabc/mail/app/profile/all-thunderbird.js">annotate</a> |
<a href="/comm-central/diff/5f559a9ea61dc2ac68eb733c8993efbd0b8efabc/mail/app/profile/all-thunderbird.js">diff</a> |
<a href="/comm-central/comparison/5f559a9ea61dc2ac68eb733c8993efbd0b8efabc/mail/app/profile/all-thunderbird.js">comparison</a> |
<a href="/comm-central/log/5f559a9ea61dc2ac68eb733c8993efbd0b8efabc/mail/app/profile/all-thunderbird.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5f559a9ea61dc2ac68eb733c8993efbd0b8efabc/mail/components/build/nsMailComps.cpp">mail/components/build/nsMailComps.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5f559a9ea61dc2ac68eb733c8993efbd0b8efabc/mail/components/build/nsMailComps.cpp">file</a> |
<a href="/comm-central/annotate/5f559a9ea61dc2ac68eb733c8993efbd0b8efabc/mail/components/build/nsMailComps.cpp">annotate</a> |
<a href="/comm-central/diff/5f559a9ea61dc2ac68eb733c8993efbd0b8efabc/mail/components/build/nsMailComps.cpp">diff</a> |
<a href="/comm-central/comparison/5f559a9ea61dc2ac68eb733c8993efbd0b8efabc/mail/components/build/nsMailComps.cpp">comparison</a> |
<a href="/comm-central/log/5f559a9ea61dc2ac68eb733c8993efbd0b8efabc/mail/components/build/nsMailComps.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5f559a9ea61dc2ac68eb733c8993efbd0b8efabc/mail/components/migration/content/migration.xul">mail/components/migration/content/migration.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5f559a9ea61dc2ac68eb733c8993efbd0b8efabc/mail/components/migration/content/migration.xul">file</a> |
<a href="/comm-central/annotate/5f559a9ea61dc2ac68eb733c8993efbd0b8efabc/mail/components/migration/content/migration.xul">annotate</a> |
<a href="/comm-central/diff/5f559a9ea61dc2ac68eb733c8993efbd0b8efabc/mail/components/migration/content/migration.xul">diff</a> |
<a href="/comm-central/comparison/5f559a9ea61dc2ac68eb733c8993efbd0b8efabc/mail/components/migration/content/migration.xul">comparison</a> |
<a href="/comm-central/log/5f559a9ea61dc2ac68eb733c8993efbd0b8efabc/mail/components/migration/content/migration.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5f559a9ea61dc2ac68eb733c8993efbd0b8efabc/mail/components/migration/public/nsMailMigrationCID.h">mail/components/migration/public/nsMailMigrationCID.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5f559a9ea61dc2ac68eb733c8993efbd0b8efabc/mail/components/migration/public/nsMailMigrationCID.h">file</a> |
<a href="/comm-central/annotate/5f559a9ea61dc2ac68eb733c8993efbd0b8efabc/mail/components/migration/public/nsMailMigrationCID.h">annotate</a> |
<a href="/comm-central/diff/5f559a9ea61dc2ac68eb733c8993efbd0b8efabc/mail/components/migration/public/nsMailMigrationCID.h">diff</a> |
<a href="/comm-central/comparison/5f559a9ea61dc2ac68eb733c8993efbd0b8efabc/mail/components/migration/public/nsMailMigrationCID.h">comparison</a> |
<a href="/comm-central/log/5f559a9ea61dc2ac68eb733c8993efbd0b8efabc/mail/components/migration/public/nsMailMigrationCID.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5f559a9ea61dc2ac68eb733c8993efbd0b8efabc/mail/components/migration/src/Makefile.in">mail/components/migration/src/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5f559a9ea61dc2ac68eb733c8993efbd0b8efabc/mail/components/migration/src/Makefile.in">file</a> |
<a href="/comm-central/annotate/5f559a9ea61dc2ac68eb733c8993efbd0b8efabc/mail/components/migration/src/Makefile.in">annotate</a> |
<a href="/comm-central/diff/5f559a9ea61dc2ac68eb733c8993efbd0b8efabc/mail/components/migration/src/Makefile.in">diff</a> |
<a href="/comm-central/comparison/5f559a9ea61dc2ac68eb733c8993efbd0b8efabc/mail/components/migration/src/Makefile.in">comparison</a> |
<a href="/comm-central/log/5f559a9ea61dc2ac68eb733c8993efbd0b8efabc/mail/components/migration/src/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5f559a9ea61dc2ac68eb733c8993efbd0b8efabc/mail/components/migration/src/nsDogbertProfileMigrator.cpp">mail/components/migration/src/nsDogbertProfileMigrator.cpp</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/5f559a9ea61dc2ac68eb733c8993efbd0b8efabc/mail/components/migration/src/nsDogbertProfileMigrator.cpp">diff</a> |
<a href="/comm-central/comparison/5f559a9ea61dc2ac68eb733c8993efbd0b8efabc/mail/components/migration/src/nsDogbertProfileMigrator.cpp">comparison</a> |
<a href="/comm-central/log/5f559a9ea61dc2ac68eb733c8993efbd0b8efabc/mail/components/migration/src/nsDogbertProfileMigrator.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5f559a9ea61dc2ac68eb733c8993efbd0b8efabc/mail/components/migration/src/nsDogbertProfileMigrator.h">mail/components/migration/src/nsDogbertProfileMigrator.h</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/5f559a9ea61dc2ac68eb733c8993efbd0b8efabc/mail/components/migration/src/nsDogbertProfileMigrator.h">diff</a> |
<a href="/comm-central/comparison/5f559a9ea61dc2ac68eb733c8993efbd0b8efabc/mail/components/migration/src/nsDogbertProfileMigrator.h">comparison</a> |
<a href="/comm-central/log/5f559a9ea61dc2ac68eb733c8993efbd0b8efabc/mail/components/migration/src/nsDogbertProfileMigrator.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5f559a9ea61dc2ac68eb733c8993efbd0b8efabc/mail/components/migration/src/nsProfileMigrator.cpp">mail/components/migration/src/nsProfileMigrator.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5f559a9ea61dc2ac68eb733c8993efbd0b8efabc/mail/components/migration/src/nsProfileMigrator.cpp">file</a> |
<a href="/comm-central/annotate/5f559a9ea61dc2ac68eb733c8993efbd0b8efabc/mail/components/migration/src/nsProfileMigrator.cpp">annotate</a> |
<a href="/comm-central/diff/5f559a9ea61dc2ac68eb733c8993efbd0b8efabc/mail/components/migration/src/nsProfileMigrator.cpp">diff</a> |
<a href="/comm-central/comparison/5f559a9ea61dc2ac68eb733c8993efbd0b8efabc/mail/components/migration/src/nsProfileMigrator.cpp">comparison</a> |
<a href="/comm-central/log/5f559a9ea61dc2ac68eb733c8993efbd0b8efabc/mail/components/migration/src/nsProfileMigrator.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5f559a9ea61dc2ac68eb733c8993efbd0b8efabc/mail/locales/en-US/chrome/messenger/migration/migration.dtd">mail/locales/en-US/chrome/messenger/migration/migration.dtd</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5f559a9ea61dc2ac68eb733c8993efbd0b8efabc/mail/locales/en-US/chrome/messenger/migration/migration.dtd">file</a> |
<a href="/comm-central/annotate/5f559a9ea61dc2ac68eb733c8993efbd0b8efabc/mail/locales/en-US/chrome/messenger/migration/migration.dtd">annotate</a> |
<a href="/comm-central/diff/5f559a9ea61dc2ac68eb733c8993efbd0b8efabc/mail/locales/en-US/chrome/messenger/migration/migration.dtd">diff</a> |
<a href="/comm-central/comparison/5f559a9ea61dc2ac68eb733c8993efbd0b8efabc/mail/locales/en-US/chrome/messenger/migration/migration.dtd">comparison</a> |
<a href="/comm-central/log/5f559a9ea61dc2ac68eb733c8993efbd0b8efabc/mail/locales/en-US/chrome/messenger/migration/migration.dtd">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5f559a9ea61dc2ac68eb733c8993efbd0b8efabc/mail/locales/en-US/chrome/messenger/migration/migration.properties">mail/locales/en-US/chrome/messenger/migration/migration.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5f559a9ea61dc2ac68eb733c8993efbd0b8efabc/mail/locales/en-US/chrome/messenger/migration/migration.properties">file</a> |
<a href="/comm-central/annotate/5f559a9ea61dc2ac68eb733c8993efbd0b8efabc/mail/locales/en-US/chrome/messenger/migration/migration.properties">annotate</a> |
<a href="/comm-central/diff/5f559a9ea61dc2ac68eb733c8993efbd0b8efabc/mail/locales/en-US/chrome/messenger/migration/migration.properties">diff</a> |
<a href="/comm-central/comparison/5f559a9ea61dc2ac68eb733c8993efbd0b8efabc/mail/locales/en-US/chrome/messenger/migration/migration.properties">comparison</a> |
<a href="/comm-central/log/5f559a9ea61dc2ac68eb733c8993efbd0b8efabc/mail/locales/en-US/chrome/messenger/migration/migration.properties">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/app/profile/all-thunderbird.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/app/profile/all-thunderbird.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -356,17 +356,17 @@ pref(&quot;mail.signature_file&quot;,             </span>
<a href="#l1.4"></a><span id="l1.4"> pref(&quot;mail.directory&quot;,                  &quot;&quot;);</span>
<a href="#l1.5"></a><span id="l1.5"> pref(&quot;news.directory&quot;,                  &quot;&quot;);</span>
<a href="#l1.6"></a><span id="l1.6"> pref(&quot;spellchecker.dictionary&quot;, &quot;&quot;);</span>
<a href="#l1.7"></a><span id="l1.7"> // Dictionary download preference</span>
<a href="#l1.8"></a><span id="l1.8"> pref(&quot;spellchecker.dictionaries.download.url&quot;, &quot;https://addons.mozilla.org/%LOCALE%/%APP%/dictionaries/&quot;);</span>
<a href="#l1.9"></a><span id="l1.9"> </span>
<a href="#l1.10"></a><span id="l1.10"> // profile.force.migration can be used to bypass the migration wizard, forcing migration from a particular</span>
<a href="#l1.11"></a><span id="l1.11"> // mail application without any user intervention. Possible values are: </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-// dogbert (4.x), seamonkey (mozilla suite), eudora, oexpress, outlook. </span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+// seamonkey (mozilla suite), eudora, oexpress, outlook.</span>
<a href="#l1.14"></a><span id="l1.14"> pref(&quot;profile.force.migration&quot;, &quot;&quot;);</span>
<a href="#l1.15"></a><span id="l1.15"> </span>
<a href="#l1.16"></a><span id="l1.16"> // prefs to control the mail alert notification</span>
<a href="#l1.17"></a><span id="l1.17"> pref(&quot;alerts.slideIncrementTime&quot;, 50);</span>
<a href="#l1.18"></a><span id="l1.18"> pref(&quot;alerts.totalOpenTime&quot;, 3000);</span>
<a href="#l1.19"></a><span id="l1.19"> </span>
<a href="#l1.20"></a><span id="l1.20"> // analyze urls in mail messages for scams</span>
<a href="#l1.21"></a><span id="l1.21"> pref(&quot;mail.phishing.detection.enabled&quot;, true);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/components/build/nsMailComps.cpp</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/components/build/nsMailComps.cpp</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -37,37 +37,29 @@</span>
<a href="#l2.4"></a><span id="l2.4">  *</span>
<a href="#l2.5"></a><span id="l2.5">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l2.6"></a><span id="l2.6"> </span>
<a href="#l2.7"></a><span id="l2.7"> #include &quot;mozilla/ModuleUtils.h&quot;</span>
<a href="#l2.8"></a><span id="l2.8"> #include &quot;nsMailMigrationCID.h&quot;</span>
<a href="#l2.9"></a><span id="l2.9"> #include &quot;nsProfileMigrator.h&quot;</span>
<a href="#l2.10"></a><span id="l2.10"> #include &quot;nsSeamonkeyProfileMigrator.h&quot;</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-#if !defined(XP_BEOS)</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-#include &quot;nsDogbertProfileMigrator.h&quot;</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-#endif</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineminus">-</span>
<a href="#l2.16"></a><span id="l2.16"> #ifndef MOZ_PLACES</span>
<a href="#l2.17"></a><span id="l2.17"> #include &quot;nsDocShellCID.h&quot;</span>
<a href="#l2.18"></a><span id="l2.18"> #include &quot;history.h&quot;</span>
<a href="#l2.19"></a><span id="l2.19"> </span>
<a href="#l2.20"></a><span id="l2.20"> using namespace mozilla;</span>
<a href="#l2.21"></a><span id="l2.21"> </span>
<a href="#l2.22"></a><span id="l2.22"> NS_GENERIC_FACTORY_SINGLETON_CONSTRUCTOR(History, History::GetSingleton)</span>
<a href="#l2.23"></a><span id="l2.23"> </span>
<a href="#l2.24"></a><span id="l2.24"> #endif</span>
<a href="#l2.25"></a><span id="l2.25"> </span>
<a href="#l2.26"></a><span id="l2.26"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsProfileMigrator)</span>
<a href="#l2.27"></a><span id="l2.27"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsSeamonkeyProfileMigrator)</span>
<a href="#l2.28"></a><span id="l2.28"> </span>
<a href="#l2.29"></a><span id="l2.29" class="difflineminus">-#if !defined(XP_BEOS)</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineminus">-NS_GENERIC_FACTORY_CONSTRUCTOR(nsDogbertProfileMigrator)</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-#endif</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineminus">-</span>
<a href="#l2.33"></a><span id="l2.33"> #ifdef XP_WIN32</span>
<a href="#l2.34"></a><span id="l2.34"> </span>
<a href="#l2.35"></a><span id="l2.35"> #include &quot;nsOEProfileMigrator.h&quot;</span>
<a href="#l2.36"></a><span id="l2.36"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsOEProfileMigrator)</span>
<a href="#l2.37"></a><span id="l2.37"> </span>
<a href="#l2.38"></a><span id="l2.38"> #include &quot;nsOutlookProfileMigrator.h&quot;</span>
<a href="#l2.39"></a><span id="l2.39"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsOutlookProfileMigrator)</span>
<a href="#l2.40"></a><span id="l2.40"> </span>
<a href="#l2.41"></a><span id="l2.41" class="difflineat">@@ -90,19 +82,16 @@ NS_GENERIC_FACTORY_CONSTRUCTOR(nsMailMac</span>
<a href="#l2.42"></a><span id="l2.42"> </span>
<a href="#l2.43"></a><span id="l2.43"> #if defined(XP_WIN32) &amp;&amp; (MOZ_WINSDK_TARGETVER &gt;= MOZ_NTDDI_LONGHORN)</span>
<a href="#l2.44"></a><span id="l2.44"> #include &quot;nsMailWinSearchHelper.h&quot;</span>
<a href="#l2.45"></a><span id="l2.45"> NS_GENERIC_FACTORY_CONSTRUCTOR_INIT(nsMailWinSearchHelper, Init)</span>
<a href="#l2.46"></a><span id="l2.46"> #endif</span>
<a href="#l2.47"></a><span id="l2.47"> </span>
<a href="#l2.48"></a><span id="l2.48"> NS_DEFINE_NAMED_CID(NS_THUNDERBIRD_PROFILEIMPORT_CID);</span>
<a href="#l2.49"></a><span id="l2.49"> NS_DEFINE_NAMED_CID(NS_SEAMONKEYPROFILEMIGRATOR_CID);</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineminus">-#ifndef XP_BEOS</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineminus">-NS_DEFINE_NAMED_CID(NS_DOGBERTPROFILEMIGRATOR_CID);</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineminus">-#endif</span>
<a href="#l2.53"></a><span id="l2.53"> </span>
<a href="#l2.54"></a><span id="l2.54"> #ifdef XP_WIN32</span>
<a href="#l2.55"></a><span id="l2.55"> NS_DEFINE_NAMED_CID(NS_OEXPRESSPROFILEMIGRATOR_CID);</span>
<a href="#l2.56"></a><span id="l2.56"> NS_DEFINE_NAMED_CID(NS_OUTLOOKPROFILEMIGRATOR_CID);</span>
<a href="#l2.57"></a><span id="l2.57"> NS_DEFINE_NAMED_CID(NS_MAILWININTEGRATION_CID);</span>
<a href="#l2.58"></a><span id="l2.58"> #if MOZ_WINSDK_TARGETVER &gt;= MOZ_NTDDI_LONGHORN</span>
<a href="#l2.59"></a><span id="l2.59"> NS_DEFINE_NAMED_CID(NS_MAILWINSEARCHHELPER_CID);</span>
<a href="#l2.60"></a><span id="l2.60"> #endif // MOZ_WINSDK_TARGETVER &gt;= MOZ_NTDDI_LONGHORN</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineat">@@ -122,19 +111,16 @@ NS_DEFINE_NAMED_CID(NS_MAILMACINTEGRATIO</span>
<a href="#l2.62"></a><span id="l2.62"> </span>
<a href="#l2.63"></a><span id="l2.63"> #ifndef MOZ_PLACES</span>
<a href="#l2.64"></a><span id="l2.64"> NS_DEFINE_NAMED_CID(NS_HISTORYSERVICE_CID);</span>
<a href="#l2.65"></a><span id="l2.65"> #endif</span>
<a href="#l2.66"></a><span id="l2.66"> </span>
<a href="#l2.67"></a><span id="l2.67"> const mozilla::Module::CIDEntry kMailCIDs[] = {</span>
<a href="#l2.68"></a><span id="l2.68">   { &amp;kNS_THUNDERBIRD_PROFILEIMPORT_CID, false, NULL, nsProfileMigratorConstructor },</span>
<a href="#l2.69"></a><span id="l2.69">   { &amp;kNS_SEAMONKEYPROFILEMIGRATOR_CID, false, NULL, nsSeamonkeyProfileMigratorConstructor },</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineminus">-#if !defined(XP_BEOS)</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineminus">-  { &amp;kNS_DOGBERTPROFILEMIGRATOR_CID, false, NULL, nsDogbertProfileMigratorConstructor },</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineminus">-#endif</span>
<a href="#l2.73"></a><span id="l2.73"> #ifdef XP_WIN32</span>
<a href="#l2.74"></a><span id="l2.74">   { &amp;kNS_OEXPRESSPROFILEMIGRATOR_CID, false, NULL, nsOEProfileMigratorConstructor },</span>
<a href="#l2.75"></a><span id="l2.75">   { &amp;kNS_OUTLOOKPROFILEMIGRATOR_CID, false, NULL, nsOutlookProfileMigratorConstructor },</span>
<a href="#l2.76"></a><span id="l2.76">   { &amp;kNS_MAILWININTEGRATION_CID, false, NULL, nsWindowsShellServiceConstructor },</span>
<a href="#l2.77"></a><span id="l2.77"> #if MOZ_WINSDK_TARGETVER &gt;= MOZ_NTDDI_LONGHORN</span>
<a href="#l2.78"></a><span id="l2.78">   { &amp;kNS_MAILWINSEARCHHELPER_CID, false, NULL, nsMailWinSearchHelperConstructor },</span>
<a href="#l2.79"></a><span id="l2.79"> #endif // MOZ_WINSDK_TARGETVER &gt;= MOZ_NTDDI_LONGHORN</span>
<a href="#l2.80"></a><span id="l2.80"> #endif // !XP_WIN32</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineat">@@ -151,19 +137,16 @@ const mozilla::Module::CIDEntry kMailCID</span>
<a href="#l2.82"></a><span id="l2.82">   { &amp;kNS_HISTORYSERVICE_CID, false, NULL, HistoryConstructor },</span>
<a href="#l2.83"></a><span id="l2.83"> #endif</span>
<a href="#l2.84"></a><span id="l2.84">   { NULL }</span>
<a href="#l2.85"></a><span id="l2.85"> };</span>
<a href="#l2.86"></a><span id="l2.86"> </span>
<a href="#l2.87"></a><span id="l2.87"> const mozilla::Module::ContractIDEntry kMailContracts[] = {</span>
<a href="#l2.88"></a><span id="l2.88">   { NS_PROFILEMIGRATOR_CONTRACTID, &amp;kNS_THUNDERBIRD_PROFILEIMPORT_CID },</span>
<a href="#l2.89"></a><span id="l2.89">   { NS_MAILPROFILEMIGRATOR_CONTRACTID_PREFIX &quot;seamonkey&quot;, &amp;kNS_SEAMONKEYPROFILEMIGRATOR_CID },</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineminus">-#if !defined(XP_BEOS)</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineminus">-  { NS_MAILPROFILEMIGRATOR_CONTRACTID_PREFIX &quot;dogbert&quot;, &amp;kNS_DOGBERTPROFILEMIGRATOR_CID },</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineminus">-#endif</span>
<a href="#l2.93"></a><span id="l2.93"> #ifdef XP_WIN32</span>
<a href="#l2.94"></a><span id="l2.94">   { NS_MAILPROFILEMIGRATOR_CONTRACTID_PREFIX &quot;oexpress&quot;, &amp;kNS_OEXPRESSPROFILEMIGRATOR_CID },</span>
<a href="#l2.95"></a><span id="l2.95">   { NS_MAILPROFILEMIGRATOR_CONTRACTID_PREFIX &quot;outlook&quot;, &amp;kNS_OUTLOOKPROFILEMIGRATOR_CID },</span>
<a href="#l2.96"></a><span id="l2.96">   { &quot;@mozilla.org/mail/shell-service;1&quot;, &amp;kNS_MAILWININTEGRATION_CID },</span>
<a href="#l2.97"></a><span id="l2.97"> #if MOZ_WINSDK_TARGETVER &gt;= MOZ_NTDDI_LONGHORN</span>
<a href="#l2.98"></a><span id="l2.98">   { &quot;@mozilla.org/mail/windows-search-helper;1&quot;, &amp;kNS_MAILWINSEARCHHELPER_CID },</span>
<a href="#l2.99"></a><span id="l2.99"> #endif // MOZ_WINSDK_TARGETVER &gt;= MOZ_NTDDI_LONGHORN</span>
<a href="#l2.100"></a><span id="l2.100"> #endif // !XP_WIN32</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/components/migration/content/migration.xul</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/components/migration/content/migration.xul</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -67,18 +67,16 @@</span>
<a href="#l3.4"></a><span id="l3.4">       &lt;radio id=&quot;seamonkey&quot; label=&quot;&amp;importFromSeamonkey2.label;&quot;</span>
<a href="#l3.5"></a><span id="l3.5">              accesskey=&quot;&amp;importFromSeamonkey2.accesskey;&quot;/&gt;</span>
<a href="#l3.6"></a><span id="l3.6"> </span>
<a href="#l3.7"></a><span id="l3.7"> #ifdef XP_WIN</span>
<a href="#l3.8"></a><span id="l3.8">       &lt;radio id=&quot;oexpress&quot;  label=&quot;&amp;importFromOExpress.label;&quot;  accesskey=&quot;&amp;importFromOExpress.accesskey;&quot;/&gt;</span>
<a href="#l3.9"></a><span id="l3.9">       &lt;radio id=&quot;outlook&quot;   label=&quot;&amp;importFromOutlook.label;&quot;   accesskey=&quot;&amp;importFromOutlook.accesskey;&quot;/&gt;</span>
<a href="#l3.10"></a><span id="l3.10"> #endif</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-      &lt;radio id=&quot;dogbert&quot;   label=&quot;&amp;importFromNetscape4.label;&quot; accesskey=&quot;&amp;importFromNetscape4.accesskey;&quot;/&gt;</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-</span>
<a href="#l3.14"></a><span id="l3.14"> #ifdef XP_UNIX</span>
<a href="#l3.15"></a><span id="l3.15"> #ifdef XP_MACOSX</span>
<a href="#l3.16"></a><span id="l3.16">       &lt;radio id=&quot;eudora&quot;    label=&quot;&amp;importFromEudora.label;&quot;    accesskey=&quot;&amp;importFromEudora.accesskey;&quot;/&gt;</span>
<a href="#l3.17"></a><span id="l3.17"> #endif</span>
<a href="#l3.18"></a><span id="l3.18"> #endif</span>
<a href="#l3.19"></a><span id="l3.19"> </span>
<a href="#l3.20"></a><span id="l3.20"> #ifdef XP_WIN</span>
<a href="#l3.21"></a><span id="l3.21">       &lt;radio id=&quot;eudora&quot;    label=&quot;&amp;importFromEudora.label;&quot;    accesskey=&quot;&amp;importFromEudora.accesskey;&quot;/&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/components/migration/public/nsMailMigrationCID.h</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/components/migration/public/nsMailMigrationCID.h</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -4,13 +4,10 @@</span>
<a href="#l4.4"></a><span id="l4.4"> { 0x62c6e1f9, 0x3dc3, 0x4b68, { 0x9c, 0x39, 0xad, 0x2f, 0x6d, 0x47, 0x1a, 0xc0 } }</span>
<a href="#l4.5"></a><span id="l4.5"> </span>
<a href="#l4.6"></a><span id="l4.6"> #define NS_OEXPRESSPROFILEMIGRATOR_CID \</span>
<a href="#l4.7"></a><span id="l4.7"> { 0xbc1db696, 0x7065, 0x46ad, { 0x87, 0x8f, 0xfd, 0x77, 0x41, 0x4e, 0x69, 0xef } }</span>
<a href="#l4.8"></a><span id="l4.8"> </span>
<a href="#l4.9"></a><span id="l4.9"> #define NS_OUTLOOKPROFILEMIGRATOR_CID \</span>
<a href="#l4.10"></a><span id="l4.10"> { 0x910b6453, 0x719, 0x41e8, { 0xa4, 0xc9, 0x3, 0x19, 0xbb, 0x34, 0xc8, 0xff } }</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-#define NS_DOGBERTPROFILEMIGRATOR_CID \</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-{ 0x765d7884, 0x3644, 0x43bd, { 0xba, 0x86, 0x9b, 0x2c, 0x50, 0xa2, 0x2a, 0x56 } }</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-</span>
<a href="#l4.15"></a><span id="l4.15"> #define NS_EUDORAPROFILEMIGRATOR_CID \</span>
<a href="#l4.16"></a><span id="l4.16"> { 0x91622bdc, 0x3c73, 0x4474, { 0x85, 0x4, 0xac, 0xda, 0x4f, 0x1e, 0xd0, 0x68 } }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/components/migration/src/Makefile.in</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/components/migration/src/Makefile.in</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -18,20 +18,16 @@ endif</span>
<a href="#l5.4"></a><span id="l5.4"> </span>
<a href="#l5.5"></a><span id="l5.5"> CPPSRCS = \</span>
<a href="#l5.6"></a><span id="l5.6"> 	nsProfileMigrator.cpp \</span>
<a href="#l5.7"></a><span id="l5.7"> 	nsMailProfileMigratorUtils.cpp \</span>
<a href="#l5.8"></a><span id="l5.8"> 	nsNetscapeProfileMigratorBase.cpp \</span>
<a href="#l5.9"></a><span id="l5.9"> 	nsSeamonkeyProfileMigrator.cpp \</span>
<a href="#l5.10"></a><span id="l5.10"> 	$(NULL)</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-ifneq ($(OS_ARCH),BeOS)</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-CPPSRCS += nsDogbertProfileMigrator.cpp</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineminus">-endif</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineminus">-</span>
<a href="#l5.16"></a><span id="l5.16"> ifeq ($(OS_ARCH),WINNT)</span>
<a href="#l5.17"></a><span id="l5.17"> CPPSRCS += \</span>
<a href="#l5.18"></a><span id="l5.18"> 	nsProfileMigratorBase.cpp \</span>
<a href="#l5.19"></a><span id="l5.19"> 	nsOEProfileMigrator.cpp \</span>
<a href="#l5.20"></a><span id="l5.20"> 	nsOutlookProfileMigrator.cpp \</span>
<a href="#l5.21"></a><span id="l5.21"> 	nsEudoraProfileMigrator.cpp \</span>
<a href="#l5.22"></a><span id="l5.22"> 	$(NULL)</span>
<a href="#l5.23"></a><span id="l5.23"> endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1">deleted file mode 100644</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineminus">--- a/mail/components/migration/src/nsDogbertProfileMigrator.cpp</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineplus">+++ /dev/null</span>
<a href="#l6.4"></a><span id="l6.4" class="difflineat">@@ -1,2087 +0,0 @@</span>
<a href="#l6.5"></a><span id="l6.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l6.6"></a><span id="l6.6" class="difflineminus">-/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l6.7"></a><span id="l6.7" class="difflineminus">- * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l6.8"></a><span id="l6.8" class="difflineminus">- *</span>
<a href="#l6.9"></a><span id="l6.9" class="difflineminus">- * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l6.10"></a><span id="l6.10" class="difflineminus">- * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l6.11"></a><span id="l6.11" class="difflineminus">- * the License. You may obtain a copy of the License at</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">- * http://www.mozilla.org/MPL/</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">- *</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">- * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineminus">- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineminus">- * for the specific language governing rights and limitations under the</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineminus">- * License.</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineminus">- *</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineminus">- * The Original Code is The Mail Profile Migrator.</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineminus">- *</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineminus">- * The Initial Developer of the Original Code is Scott MacGregor</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineminus">- * Portions created by the Initial Developer are Copyright (C) 2004</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineminus">- * the Initial Developer. All Rights Reserved.</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineminus">- *</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineminus">- * Contributor(s):</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineminus">- *  Scott MacGregor &lt;mscott@mozilla.org&gt;</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineminus">- *</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineminus">- * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineminus">- * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineminus">- * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">- * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineminus">- * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineminus">- * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineminus">- * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineminus">- * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineminus">- * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineminus">- * the provisions above, a recipient may use your version of this file under</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineminus">- * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineminus">- *</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineminus">- * ***** END LICENSE BLOCK ***** */</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineminus">-</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineminus">-// this file is mostly a copy of nsPrefMigration.cpp.</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineminus">-</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineminus">-#include &quot;nsMailProfileMigratorUtils.h&quot;</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineminus">-#include &quot;nsDirectoryServiceDefs.h&quot;</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineminus">-#include &quot;nsIPrefService.h&quot;</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineminus">-#include &quot;nsISupportsPrimitives.h&quot;</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineminus">-#include &quot;nsNetUtil.h&quot;</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineminus">-#include &quot;nsDogbertProfileMigrator.h&quot;</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineminus">-#include &quot;nsIRelativeFilePref.h&quot;</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineminus">-#include &quot;nsAppDirectoryServiceDefs.h&quot;</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineminus">-#include &quot;prprf.h&quot;</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineminus">-#include &quot;prmem.h&quot;</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineminus">-#include &quot;prenv.h&quot;</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineminus">-#include &quot;NSReg.h&quot;</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineminus">-#include &quot;msgCore.h&quot;</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineminus">-#include &quot;nsDirectoryServiceUtils.h&quot;</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineminus">-#include &lt;limits.h&gt;</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineminus">-</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineminus">-// lots of includes required for the nsPrefMigration.cpp code that we copied:</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineminus">-#include &quot;nsICharsetConverterManager.h&quot;</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineminus">-#include &quot;nsIPlatformCharset.h&quot;</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineminus">-</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineminus">-#define MIGRATION_PROPERTIES_URL &quot;chrome://messenger/locale/migration/migration.properties&quot;</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineminus">-</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineminus">-#ifndef MAXPATHLEN</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineminus">-#ifdef PATH_MAX</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineminus">-#define MAXPATHLEN PATH_MAX</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineminus">-#elif defined(_MAX_PATH)</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineminus">-#define MAXPATHLEN _MAX_PATH</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineminus">-#elif defined(CCHMAXPATH)</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineminus">-#define MAXPATHLEN CCHMAXPATH</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineminus">-#else</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineminus">-#define MAXPATHLEN 1024</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineminus">-#endif</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineminus">-#endif</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineminus">-</span>
<a href="#l6.78"></a><span id="l6.78" class="difflineminus">-#if defined(XP_UNIX) &amp;&amp; !defined(XP_MACOSX)</span>
<a href="#l6.79"></a><span id="l6.79" class="difflineminus">-#define PREF_FILE_NAME_IN_4x      &quot;preferences.js&quot;</span>
<a href="#l6.80"></a><span id="l6.80" class="difflineminus">-#define IMAP_MAIL_FILTER_FILE_NAME_IN_4x &quot;mailrule&quot;</span>
<a href="#l6.81"></a><span id="l6.81" class="difflineminus">-#define POP_MAIL_FILTER_FILE_NAME_IN_4x &quot;mailrule&quot;</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineminus">-#define MAIL_SUMMARY_SUFFIX_IN_4x &quot;.summary&quot;</span>
<a href="#l6.83"></a><span id="l6.83" class="difflineminus">-#define NEWS_SUMMARY_SUFFIX_IN_4x &quot;.snm&quot;</span>
<a href="#l6.84"></a><span id="l6.84" class="difflineminus">-#define NEWSRC_PREFIX_IN_4x &quot;.newsrc-&quot;</span>
<a href="#l6.85"></a><span id="l6.85" class="difflineminus">-#define SNEWSRC_PREFIX_IN_4x &quot;.snewsrc-&quot;</span>
<a href="#l6.86"></a><span id="l6.86" class="difflineminus">-#define POPSTATE_FILE_IN_4x &quot;popstate&quot;</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineminus">-#define PSM_CERT7_DB &quot;cert7.db&quot;</span>
<a href="#l6.88"></a><span id="l6.88" class="difflineminus">-#define PSM_KEY3_DB &quot;key3.db&quot;</span>
<a href="#l6.89"></a><span id="l6.89" class="difflineminus">-#define PSM_SECMODULE_DB &quot;secmodule.db&quot;</span>
<a href="#l6.90"></a><span id="l6.90" class="difflineminus">-#define HOME_ENVIRONMENT_VARIABLE         &quot;HOME&quot;</span>
<a href="#l6.91"></a><span id="l6.91" class="difflineminus">-#define PROFILE_HOME_ENVIRONMENT_VARIABLE &quot;PROFILE_HOME&quot;</span>
<a href="#l6.92"></a><span id="l6.92" class="difflineminus">-#define DEFAULT_UNIX_PROFILE_NAME         &quot;default&quot;</span>
<a href="#l6.93"></a><span id="l6.93" class="difflineminus">-#elif defined(XP_MACOSX)</span>
<a href="#l6.94"></a><span id="l6.94" class="difflineminus">-#define OLDREG_NAME               &quot;Netscape Registry&quot;</span>
<a href="#l6.95"></a><span id="l6.95" class="difflineminus">-#define OLDREG_DIR                NS_MAC_PREFS_DIR</span>
<a href="#l6.96"></a><span id="l6.96" class="difflineminus">-#define PREF_FILE_NAME_IN_4x      &quot;Netscape Preferences&quot;</span>
<a href="#l6.97"></a><span id="l6.97" class="difflineminus">-#define MAC_RULES_FILE_ENDING_STRING_IN_4X &quot; Rules&quot;</span>
<a href="#l6.98"></a><span id="l6.98" class="difflineminus">-#define IMAP_MAIL_FILTER_FILE_NAME_IN_4x &quot;&lt;hostname&gt; Rules&quot;</span>
<a href="#l6.99"></a><span id="l6.99" class="difflineminus">-#define POP_MAIL_FILTER_FILE_NAME_IN_4x &quot;Filter Rules&quot;</span>
<a href="#l6.100"></a><span id="l6.100" class="difflineminus">-#define MAIL_SUMMARY_SUFFIX_IN_4x &quot;.snm&quot;</span>
<a href="#l6.101"></a><span id="l6.101" class="difflineminus">-#define NEWS_SUMMARY_SUFFIX_IN_4x &quot;.snm&quot;</span>
<a href="#l6.102"></a><span id="l6.102" class="difflineminus">-#define POPSTATE_FILE_IN_4x &quot;Pop State&quot;</span>
<a href="#l6.103"></a><span id="l6.103" class="difflineminus">-#define SECURITY_PATH &quot;Security&quot;</span>
<a href="#l6.104"></a><span id="l6.104" class="difflineminus">-#define PSM_CERT7_DB &quot;Certificates7&quot;</span>
<a href="#l6.105"></a><span id="l6.105" class="difflineminus">-#define PSM_KEY3_DB &quot;Key Database3&quot;</span>
<a href="#l6.106"></a><span id="l6.106" class="difflineminus">-#define PSM_SECMODULE_DB &quot;Security Modules&quot;</span>
<a href="#l6.107"></a><span id="l6.107" class="difflineminus">-#else /* XP_WIN || XP_OS2 */</span>
<a href="#l6.108"></a><span id="l6.108" class="difflineminus">-#define PREF_FILE_NAME_IN_4x      &quot;prefs.js&quot;</span>
<a href="#l6.109"></a><span id="l6.109" class="difflineminus">-#define IMAP_MAIL_FILTER_FILE_NAME_IN_4x &quot;rules.dat&quot;</span>
<a href="#l6.110"></a><span id="l6.110" class="difflineminus">-#define POP_MAIL_FILTER_FILE_NAME_IN_4x &quot;rules.dat&quot;</span>
<a href="#l6.111"></a><span id="l6.111" class="difflineminus">-#define MAIL_SUMMARY_SUFFIX_IN_4x &quot;.snm&quot;</span>
<a href="#l6.112"></a><span id="l6.112" class="difflineminus">-#define NEWS_SUMMARY_SUFFIX_IN_4x &quot;.snm&quot;</span>
<a href="#l6.113"></a><span id="l6.113" class="difflineminus">-#define OLDREG_NAME               &quot;nsreg.dat&quot;</span>
<a href="#l6.114"></a><span id="l6.114" class="difflineminus">-#ifdef XP_WIN</span>
<a href="#l6.115"></a><span id="l6.115" class="difflineminus">-#define OLDREG_DIR                NS_WIN_WINDOWS_DIR</span>
<a href="#l6.116"></a><span id="l6.116" class="difflineminus">-#else</span>
<a href="#l6.117"></a><span id="l6.117" class="difflineminus">-#define OLDREG_DIR                NS_OS2_DIR</span>
<a href="#l6.118"></a><span id="l6.118" class="difflineminus">-#endif</span>
<a href="#l6.119"></a><span id="l6.119" class="difflineminus">-// purposely not defined, since it was in the right place</span>
<a href="#l6.120"></a><span id="l6.120" class="difflineminus">-// and with the right name in 4.x</span>
<a href="#l6.121"></a><span id="l6.121" class="difflineminus">-//#define POPSTATE_FILE_IN_4x &quot;popstate.dat&quot;</span>
<a href="#l6.122"></a><span id="l6.122" class="difflineminus">-#define PSM_CERT7_DB &quot;cert7.db&quot;</span>
<a href="#l6.123"></a><span id="l6.123" class="difflineminus">-#define PSM_KEY3_DB &quot;key3.db&quot;</span>
<a href="#l6.124"></a><span id="l6.124" class="difflineminus">-#define PSM_SECMODULE_DB &quot;secmod.db&quot;</span>
<a href="#l6.125"></a><span id="l6.125" class="difflineminus">-#endif /* XP_UNIX */</span>
<a href="#l6.126"></a><span id="l6.126" class="difflineminus">-</span>
<a href="#l6.127"></a><span id="l6.127" class="difflineminus">-#define SUMMARY_SUFFIX_IN_5x &quot;.msf&quot;</span>
<a href="#l6.128"></a><span id="l6.128" class="difflineminus">-#define IMAP_MAIL_FILTER_FILE_NAME_IN_5x &quot;rules.dat&quot;</span>
<a href="#l6.129"></a><span id="l6.129" class="difflineminus">-#define POP_MAIL_FILTER_FILE_NAME_IN_5x &quot;rules.dat&quot;</span>
<a href="#l6.130"></a><span id="l6.130" class="difflineminus">-#define POPSTATE_FILE_IN_5x	&quot;popstate.dat&quot;</span>
<a href="#l6.131"></a><span id="l6.131" class="difflineminus">-</span>
<a href="#l6.132"></a><span id="l6.132" class="difflineminus">-// only UNIX had movemail in 4.x</span>
<a href="#l6.133"></a><span id="l6.133" class="difflineminus">-#if defined(XP_UNIX) &amp;&amp; !defined(XP_MACOSX)</span>
<a href="#l6.134"></a><span id="l6.134" class="difflineminus">-#define HAVE_MOVEMAIL 1</span>
<a href="#l6.135"></a><span id="l6.135" class="difflineminus">-#endif /* XP_UNIX */</span>
<a href="#l6.136"></a><span id="l6.136" class="difflineminus">-</span>
<a href="#l6.137"></a><span id="l6.137" class="difflineminus">-#define PREMIGRATION_PREFIX &quot;premigration.&quot;</span>
<a href="#l6.138"></a><span id="l6.138" class="difflineminus">-#define PREF_FILE_HEADER_STRING &quot;# Mozilla User Preferences    &quot;</span>
<a href="#l6.139"></a><span id="l6.139" class="difflineminus">-#define MAX_PREF_LEN 1024</span>
<a href="#l6.140"></a><span id="l6.140" class="difflineminus">-</span>
<a href="#l6.141"></a><span id="l6.141" class="difflineminus">-// this is for the hidden preference setting in mozilla/modules/libpref/src/init/mailnews.js</span>
<a href="#l6.142"></a><span id="l6.142" class="difflineminus">-// pref(&quot;mail.migration.copyMailFiles&quot;, true);</span>
<a href="#l6.143"></a><span id="l6.143" class="difflineminus">-//</span>
<a href="#l6.144"></a><span id="l6.144" class="difflineminus">-// see bugzilla bug 80035 (http://bugzilla.mozilla.org/show_bug.cgi?id=80035)</span>
<a href="#l6.145"></a><span id="l6.145" class="difflineminus">-//</span>
<a href="#l6.146"></a><span id="l6.146" class="difflineminus">-// the default value for this setting is true which means when migrating from</span>
<a href="#l6.147"></a><span id="l6.147" class="difflineminus">-// Netscape 4.x, mozilla will copy all the contents of Local Folders and Imap</span>
<a href="#l6.148"></a><span id="l6.148" class="difflineminus">-// Folder to the newly created subfolders of migrated mozilla profile</span>
<a href="#l6.149"></a><span id="l6.149" class="difflineminus">-// when this value is set to false, mozilla will not copy these contents and</span>
<a href="#l6.150"></a><span id="l6.150" class="difflineminus">-// still share them with Netscape 4.x</span>
<a href="#l6.151"></a><span id="l6.151" class="difflineminus">-//</span>
<a href="#l6.152"></a><span id="l6.152" class="difflineminus">-// Advantages of forbidding copy operation:</span>
<a href="#l6.153"></a><span id="l6.153" class="difflineminus">-//     reduce the disk usage</span>
<a href="#l6.154"></a><span id="l6.154" class="difflineminus">-//     quick migration</span>
<a href="#l6.155"></a><span id="l6.155" class="difflineminus">-// Disadvantage of forbidding copy operation:</span>
<a href="#l6.156"></a><span id="l6.156" class="difflineminus">-//     without perfect lock mechamism, there is possibility of data corruption</span>
<a href="#l6.157"></a><span id="l6.157" class="difflineminus">-//     when Netscape 4.x and mozilla run at the same time and access the same</span>
<a href="#l6.158"></a><span id="l6.158" class="difflineminus">-//     mail file at the same time</span>
<a href="#l6.159"></a><span id="l6.159" class="difflineminus">-#define PREF_MIGRATION_MODE_FOR_MAIL &quot;mail.migration.copyMailFiles&quot;</span>
<a href="#l6.160"></a><span id="l6.160" class="difflineminus">-#define PREF_MAIL_DIRECTORY &quot;mail.directory&quot;</span>
<a href="#l6.161"></a><span id="l6.161" class="difflineminus">-#define PREF_NEWS_DIRECTORY &quot;news.directory&quot;</span>
<a href="#l6.162"></a><span id="l6.162" class="difflineminus">-#define PREF_MAIL_IMAP_ROOT_DIR &quot;mail.imap.root_dir&quot;</span>
<a href="#l6.163"></a><span id="l6.163" class="difflineminus">-#define PREF_NETWORK_HOSTS_POP_SERVER &quot;network.hosts.pop_server&quot;</span>
<a href="#l6.164"></a><span id="l6.164" class="difflineminus">-#define PREF_4X_NETWORK_HOSTS_IMAP_SERVER &quot;network.hosts.imap_servers&quot;</span>
<a href="#l6.165"></a><span id="l6.165" class="difflineminus">-#define PREF_MAIL_SERVER_TYPE	&quot;mail.server_type&quot;</span>
<a href="#l6.166"></a><span id="l6.166" class="difflineminus">-#define PREF_BROWSER_CACHE_DIRECTORY &quot;browser.cache.directory&quot;</span>
<a href="#l6.167"></a><span id="l6.167" class="difflineminus">-#define POP_4X_MAIL_TYPE 0</span>
<a href="#l6.168"></a><span id="l6.168" class="difflineminus">-#define IMAP_4X_MAIL_TYPE 1</span>
<a href="#l6.169"></a><span id="l6.169" class="difflineminus">-#ifdef HAVE_MOVEMAIL</span>
<a href="#l6.170"></a><span id="l6.170" class="difflineminus">-#define MOVEMAIL_4X_MAIL_TYPE 2</span>
<a href="#l6.171"></a><span id="l6.171" class="difflineminus">-#define NEW_MOVEMAIL_DIR_NAME &quot;movemail&quot;</span>
<a href="#l6.172"></a><span id="l6.172" class="difflineminus">-#endif /* HAVE_MOVEMAIL */</span>
<a href="#l6.173"></a><span id="l6.173" class="difflineminus">-</span>
<a href="#l6.174"></a><span id="l6.174" class="difflineminus">-#if defined(XP_UNIX) &amp;&amp; !defined(XP_MACOSX)</span>
<a href="#l6.175"></a><span id="l6.175" class="difflineminus">-/* a 4.x profile on UNIX is rooted at something like</span>
<a href="#l6.176"></a><span id="l6.176" class="difflineminus">- * &quot;/u/sspitzer/.netscape&quot;</span>
<a href="#l6.177"></a><span id="l6.177" class="difflineminus">- * profile + OLD_MAIL_DIR_NAME = &quot;/u/sspitzer/.netscape/../nsmail&quot; = &quot;/u/sspitzer/nsmail&quot;</span>
<a href="#l6.178"></a><span id="l6.178" class="difflineminus">- * profile + OLD_NEWS_DIR_NAME = &quot;/u/sspitzer/.netscape/xover-cache&quot;</span>
<a href="#l6.179"></a><span id="l6.179" class="difflineminus">- * profile + OLD_IMAPMAIL_DIR_NAME = &quot;/u/sspitzer/.netscape/../ns_imap&quot; = &quot;/u/sspitzer/ns_imap&quot;</span>
<a href="#l6.180"></a><span id="l6.180" class="difflineminus">- * which is as good as we're going to get for defaults on UNIX.</span>
<a href="#l6.181"></a><span id="l6.181" class="difflineminus">- */</span>
<a href="#l6.182"></a><span id="l6.182" class="difflineminus">-#define OLD_MAIL_DIR_NAME &quot;/../nsmail&quot;</span>
<a href="#l6.183"></a><span id="l6.183" class="difflineminus">-#define OLD_NEWS_DIR_NAME &quot;/xover-cache&quot;</span>
<a href="#l6.184"></a><span id="l6.184" class="difflineminus">-#define OLD_IMAPMAIL_DIR_NAME &quot;/../ns_imap&quot;</span>
<a href="#l6.185"></a><span id="l6.185" class="difflineminus">-#else</span>
<a href="#l6.186"></a><span id="l6.186" class="difflineminus">-#define OLD_MAIL_DIR_NAME &quot;Mail&quot;</span>
<a href="#l6.187"></a><span id="l6.187" class="difflineminus">-#define OLD_NEWS_DIR_NAME &quot;News&quot;</span>
<a href="#l6.188"></a><span id="l6.188" class="difflineminus">-#define OLD_IMAPMAIL_DIR_NAME &quot;ImapMail&quot;</span>
<a href="#l6.189"></a><span id="l6.189" class="difflineminus">-#endif /* XP_UNIX */</span>
<a href="#l6.190"></a><span id="l6.190" class="difflineminus">-</span>
<a href="#l6.191"></a><span id="l6.191" class="difflineminus">-#define NEW_MAIL_DIR_NAME &quot;Mail&quot;</span>
<a href="#l6.192"></a><span id="l6.192" class="difflineminus">-#define NEW_NEWS_DIR_NAME &quot;News&quot;</span>
<a href="#l6.193"></a><span id="l6.193" class="difflineminus">-#define NEW_IMAPMAIL_DIR_NAME &quot;ImapMail&quot;</span>
<a href="#l6.194"></a><span id="l6.194" class="difflineminus">-#define NEW_LOCAL_MAIL_DIR_NAME &quot;Local Folders&quot;</span>
<a href="#l6.195"></a><span id="l6.195" class="difflineminus">-</span>
<a href="#l6.196"></a><span id="l6.196" class="difflineminus">-#define NEW_DIR_SUFFIX &quot;5&quot;</span>
<a href="#l6.197"></a><span id="l6.197" class="difflineminus">-#define PREF_FILE_NAME_IN_5x &quot;prefs.js&quot;</span>
<a href="#l6.198"></a><span id="l6.198" class="difflineminus">-</span>
<a href="#l6.199"></a><span id="l6.199" class="difflineminus">-static PRBool nsCStringEndsWith(nsCString&amp; name, const char *ending);</span>
<a href="#l6.200"></a><span id="l6.200" class="difflineminus">-</span>
<a href="#l6.201"></a><span id="l6.201" class="difflineminus">-#ifdef NEED_TO_COPY_AND_RENAME_NEWSRC_FILES</span>
<a href="#l6.202"></a><span id="l6.202" class="difflineminus">-static PRBool nsCStringStartsWith(nsCString&amp; name, const char *starting);</span>
<a href="#l6.203"></a><span id="l6.203" class="difflineminus">-#endif</span>
<a href="#l6.204"></a><span id="l6.204" class="difflineminus">-</span>
<a href="#l6.205"></a><span id="l6.205" class="difflineminus">-///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l6.206"></a><span id="l6.206" class="difflineminus">-// nsDogbertProfileMigrator</span>
<a href="#l6.207"></a><span id="l6.207" class="difflineminus">-struct PrefBranchStruct {</span>
<a href="#l6.208"></a><span id="l6.208" class="difflineminus">-  char*         prefName;</span>
<a href="#l6.209"></a><span id="l6.209" class="difflineminus">-  PRInt32       type;</span>
<a href="#l6.210"></a><span id="l6.210" class="difflineminus">-  union {</span>
<a href="#l6.211"></a><span id="l6.211" class="difflineminus">-    char*       stringValue;</span>
<a href="#l6.212"></a><span id="l6.212" class="difflineminus">-    PRInt32     intValue;</span>
<a href="#l6.213"></a><span id="l6.213" class="difflineminus">-    PRBool      boolValue;</span>
<a href="#l6.214"></a><span id="l6.214" class="difflineminus">-    PRUnichar*  wstringValue;</span>
<a href="#l6.215"></a><span id="l6.215" class="difflineminus">-  };</span>
<a href="#l6.216"></a><span id="l6.216" class="difflineminus">-};</span>
<a href="#l6.217"></a><span id="l6.217" class="difflineminus">-</span>
<a href="#l6.218"></a><span id="l6.218" class="difflineminus">-NS_IMPL_ISUPPORTS2(nsDogbertProfileMigrator, nsIMailProfileMigrator, nsITimerCallback)</span>
<a href="#l6.219"></a><span id="l6.219" class="difflineminus">-</span>
<a href="#l6.220"></a><span id="l6.220" class="difflineminus">-</span>
<a href="#l6.221"></a><span id="l6.221" class="difflineminus">-nsDogbertProfileMigrator::nsDogbertProfileMigrator()</span>
<a href="#l6.222"></a><span id="l6.222" class="difflineminus">-{</span>
<a href="#l6.223"></a><span id="l6.223" class="difflineminus">-}</span>
<a href="#l6.224"></a><span id="l6.224" class="difflineminus">-</span>
<a href="#l6.225"></a><span id="l6.225" class="difflineminus">-nsDogbertProfileMigrator::~nsDogbertProfileMigrator()</span>
<a href="#l6.226"></a><span id="l6.226" class="difflineminus">-{</span>
<a href="#l6.227"></a><span id="l6.227" class="difflineminus">-}</span>
<a href="#l6.228"></a><span id="l6.228" class="difflineminus">-</span>
<a href="#l6.229"></a><span id="l6.229" class="difflineminus">-///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l6.230"></a><span id="l6.230" class="difflineminus">-// nsIMailProfileMigrator</span>
<a href="#l6.231"></a><span id="l6.231" class="difflineminus">-</span>
<a href="#l6.232"></a><span id="l6.232" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l6.233"></a><span id="l6.233" class="difflineminus">-nsDogbertProfileMigrator::Migrate(PRUint16 aItems, nsIProfileStartup* aStartup, const PRUnichar* aProfile)</span>
<a href="#l6.234"></a><span id="l6.234" class="difflineminus">-{</span>
<a href="#l6.235"></a><span id="l6.235" class="difflineminus">-  nsresult rv = NS_OK;</span>
<a href="#l6.236"></a><span id="l6.236" class="difflineminus">-</span>
<a href="#l6.237"></a><span id="l6.237" class="difflineminus">-  if (!mTargetProfile) {</span>
<a href="#l6.238"></a><span id="l6.238" class="difflineminus">-    GetProfilePath(aStartup, mTargetProfile);</span>
<a href="#l6.239"></a><span id="l6.239" class="difflineminus">-    if (!mTargetProfile) return NS_ERROR_FAILURE;</span>
<a href="#l6.240"></a><span id="l6.240" class="difflineminus">-  }</span>
<a href="#l6.241"></a><span id="l6.241" class="difflineminus">-  if (!mSourceProfile)</span>
<a href="#l6.242"></a><span id="l6.242" class="difflineminus">-    GetSourceProfile(aProfile);</span>
<a href="#l6.243"></a><span id="l6.243" class="difflineminus">-</span>
<a href="#l6.244"></a><span id="l6.244" class="difflineminus">-  NOTIFY_OBSERVERS(MIGRATION_STARTED, nsnull);</span>
<a href="#l6.245"></a><span id="l6.245" class="difflineminus">-</span>
<a href="#l6.246"></a><span id="l6.246" class="difflineminus">-  rv = CopyPreferences();</span>
<a href="#l6.247"></a><span id="l6.247" class="difflineminus">-  return rv;</span>
<a href="#l6.248"></a><span id="l6.248" class="difflineminus">-}</span>
<a href="#l6.249"></a><span id="l6.249" class="difflineminus">-</span>
<a href="#l6.250"></a><span id="l6.250" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l6.251"></a><span id="l6.251" class="difflineminus">-nsDogbertProfileMigrator::GetMigrateData(const PRUnichar* aProfile,</span>
<a href="#l6.252"></a><span id="l6.252" class="difflineminus">-                                           PRBool aReplace,</span>
<a href="#l6.253"></a><span id="l6.253" class="difflineminus">-                                           PRUint16* aResult)</span>
<a href="#l6.254"></a><span id="l6.254" class="difflineminus">-{</span>
<a href="#l6.255"></a><span id="l6.255" class="difflineminus">-  // add some extra migration fields for things we also migrate</span>
<a href="#l6.256"></a><span id="l6.256" class="difflineminus">-  *aResult |= nsIMailProfileMigrator::ACCOUNT_SETTINGS</span>
<a href="#l6.257"></a><span id="l6.257" class="difflineminus">-           | nsIMailProfileMigrator::MAILDATA</span>
<a href="#l6.258"></a><span id="l6.258" class="difflineminus">-           | nsIMailProfileMigrator::NEWSDATA</span>
<a href="#l6.259"></a><span id="l6.259" class="difflineminus">-           | nsIMailProfileMigrator::ADDRESSBOOK_DATA;</span>
<a href="#l6.260"></a><span id="l6.260" class="difflineminus">-</span>
<a href="#l6.261"></a><span id="l6.261" class="difflineminus">-  return NS_OK;</span>
<a href="#l6.262"></a><span id="l6.262" class="difflineminus">-}</span>
<a href="#l6.263"></a><span id="l6.263" class="difflineminus">-</span>
<a href="#l6.264"></a><span id="l6.264" class="difflineminus">-#if defined(XP_WIN) || defined(XP_OS2) || defined(XP_MACOSX)</span>
<a href="#l6.265"></a><span id="l6.265" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l6.266"></a><span id="l6.266" class="difflineminus">-nsDogbertProfileMigrator::GetSourceProfiles(nsIArray** aResult)</span>
<a href="#l6.267"></a><span id="l6.267" class="difflineminus">-{</span>
<a href="#l6.268"></a><span id="l6.268" class="difflineminus">-  if (!mProfiles) {</span>
<a href="#l6.269"></a><span id="l6.269" class="difflineminus">-    nsresult rv;</span>
<a href="#l6.270"></a><span id="l6.270" class="difflineminus">-</span>
<a href="#l6.271"></a><span id="l6.271" class="difflineminus">-    mProfiles = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l6.272"></a><span id="l6.272" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.273"></a><span id="l6.273" class="difflineminus">-</span>
<a href="#l6.274"></a><span id="l6.274" class="difflineminus">-    nsCOMPtr&lt;nsIFile&gt; regFile;</span>
<a href="#l6.275"></a><span id="l6.275" class="difflineminus">-    rv = NS_GetSpecialDirectory(OLDREG_DIR, getter_AddRefs(regFile));</span>
<a href="#l6.276"></a><span id="l6.276" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.277"></a><span id="l6.277" class="difflineminus">-    regFile-&gt;AppendNative(NS_LITERAL_CSTRING(OLDREG_NAME));</span>
<a href="#l6.278"></a><span id="l6.278" class="difflineminus">-</span>
<a href="#l6.279"></a><span id="l6.279" class="difflineminus">-    nsCAutoString path;</span>
<a href="#l6.280"></a><span id="l6.280" class="difflineminus">-    rv = regFile-&gt;GetNativePath(path);</span>
<a href="#l6.281"></a><span id="l6.281" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.282"></a><span id="l6.282" class="difflineminus">-</span>
<a href="#l6.283"></a><span id="l6.283" class="difflineminus">-    if (NR_StartupRegistry())</span>
<a href="#l6.284"></a><span id="l6.284" class="difflineminus">-      return NS_ERROR_FAILURE;</span>
<a href="#l6.285"></a><span id="l6.285" class="difflineminus">-</span>
<a href="#l6.286"></a><span id="l6.286" class="difflineminus">-    HREG reg = nsnull;</span>
<a href="#l6.287"></a><span id="l6.287" class="difflineminus">-    REGENUM enumstate = 0;</span>
<a href="#l6.288"></a><span id="l6.288" class="difflineminus">-</span>
<a href="#l6.289"></a><span id="l6.289" class="difflineminus">-    if (NR_RegOpen(path.get(), &amp;reg)) {</span>
<a href="#l6.290"></a><span id="l6.290" class="difflineminus">-      NR_ShutdownRegistry();</span>
<a href="#l6.291"></a><span id="l6.291" class="difflineminus">-      return NS_ERROR_FAILURE;</span>
<a href="#l6.292"></a><span id="l6.292" class="difflineminus">-    }</span>
<a href="#l6.293"></a><span id="l6.293" class="difflineminus">-</span>
<a href="#l6.294"></a><span id="l6.294" class="difflineminus">-    char profileName[MAXREGNAMELEN];</span>
<a href="#l6.295"></a><span id="l6.295" class="difflineminus">-    while (!NR_RegEnumSubkeys(reg, ROOTKEY_USERS, &amp;enumstate,</span>
<a href="#l6.296"></a><span id="l6.296" class="difflineminus">-                              profileName, MAXREGNAMELEN, REGENUM_CHILDREN)) {</span>
<a href="#l6.297"></a><span id="l6.297" class="difflineminus">-      nsCOMPtr&lt;nsISupportsString&gt; nameString</span>
<a href="#l6.298"></a><span id="l6.298" class="difflineminus">-        (do_CreateInstance(&quot;@mozilla.org/supports-string;1&quot;));</span>
<a href="#l6.299"></a><span id="l6.299" class="difflineminus">-      if (nameString) {</span>
<a href="#l6.300"></a><span id="l6.300" class="difflineminus">-        nameString-&gt;SetData(NS_ConvertUTF8toUTF16(profileName));</span>
<a href="#l6.301"></a><span id="l6.301" class="difflineminus">-        mProfiles-&gt;AppendElement(nameString, PR_FALSE);</span>
<a href="#l6.302"></a><span id="l6.302" class="difflineminus">-      }</span>
<a href="#l6.303"></a><span id="l6.303" class="difflineminus">-    }</span>
<a href="#l6.304"></a><span id="l6.304" class="difflineminus">-  }</span>
<a href="#l6.305"></a><span id="l6.305" class="difflineminus">-</span>
<a href="#l6.306"></a><span id="l6.306" class="difflineminus">-  NS_IF_ADDREF(*aResult = mProfiles);</span>
<a href="#l6.307"></a><span id="l6.307" class="difflineminus">-  return NS_OK;</span>
<a href="#l6.308"></a><span id="l6.308" class="difflineminus">-}</span>
<a href="#l6.309"></a><span id="l6.309" class="difflineminus">-#else // XP_UNIX</span>
<a href="#l6.310"></a><span id="l6.310" class="difflineminus">-</span>
<a href="#l6.311"></a><span id="l6.311" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l6.312"></a><span id="l6.312" class="difflineminus">-nsDogbertProfileMigrator::GetSourceProfiles(nsIArray** aResult)</span>
<a href="#l6.313"></a><span id="l6.313" class="difflineminus">-{</span>
<a href="#l6.314"></a><span id="l6.314" class="difflineminus">-  nsresult rv;</span>
<a href="#l6.315"></a><span id="l6.315" class="difflineminus">-  const char* profileDir  = PR_GetEnv(PROFILE_HOME_ENVIRONMENT_VARIABLE);</span>
<a href="#l6.316"></a><span id="l6.316" class="difflineminus">-</span>
<a href="#l6.317"></a><span id="l6.317" class="difflineminus">-  if (!profileDir) {</span>
<a href="#l6.318"></a><span id="l6.318" class="difflineminus">-    profileDir = PR_GetEnv(HOME_ENVIRONMENT_VARIABLE);</span>
<a href="#l6.319"></a><span id="l6.319" class="difflineminus">-  }</span>
<a href="#l6.320"></a><span id="l6.320" class="difflineminus">-  if (!profileDir) return NS_ERROR_FAILURE;</span>
<a href="#l6.321"></a><span id="l6.321" class="difflineminus">-</span>
<a href="#l6.322"></a><span id="l6.322" class="difflineminus">-  nsCAutoString profilePath(profileDir);</span>
<a href="#l6.323"></a><span id="l6.323" class="difflineminus">-  profilePath += &quot;/.netscape&quot;;</span>
<a href="#l6.324"></a><span id="l6.324" class="difflineminus">-</span>
<a href="#l6.325"></a><span id="l6.325" class="difflineminus">-  nsCOMPtr&lt;nsILocalFile&gt; profileFile;</span>
<a href="#l6.326"></a><span id="l6.326" class="difflineminus">-  rv = NS_NewNativeLocalFile(profilePath, PR_TRUE, getter_AddRefs(profileFile));</span>
<a href="#l6.327"></a><span id="l6.327" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.328"></a><span id="l6.328" class="difflineminus">-</span>
<a href="#l6.329"></a><span id="l6.329" class="difflineminus">-  nsCOMPtr&lt;nsIFile&gt; prefFile;</span>
<a href="#l6.330"></a><span id="l6.330" class="difflineminus">-  rv = profileFile-&gt;Clone(getter_AddRefs(prefFile));</span>
<a href="#l6.331"></a><span id="l6.331" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.332"></a><span id="l6.332" class="difflineminus">-</span>
<a href="#l6.333"></a><span id="l6.333" class="difflineminus">-  prefFile-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;preferences.js&quot;));</span>
<a href="#l6.334"></a><span id="l6.334" class="difflineminus">-</span>
<a href="#l6.335"></a><span id="l6.335" class="difflineminus">-  PRBool exists;</span>
<a href="#l6.336"></a><span id="l6.336" class="difflineminus">-  rv = prefFile-&gt;Exists(&amp;exists);</span>
<a href="#l6.337"></a><span id="l6.337" class="difflineminus">-  if (NS_FAILED(rv) || !exists) {</span>
<a href="#l6.338"></a><span id="l6.338" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l6.339"></a><span id="l6.339" class="difflineminus">-  }</span>
<a href="#l6.340"></a><span id="l6.340" class="difflineminus">-</span>
<a href="#l6.341"></a><span id="l6.341" class="difflineminus">-  mSourceProfile = profileFile;</span>
<a href="#l6.342"></a><span id="l6.342" class="difflineminus">-</span>
<a href="#l6.343"></a><span id="l6.343" class="difflineminus">-  mProfiles = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l6.344"></a><span id="l6.344" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.345"></a><span id="l6.345" class="difflineminus">-</span>
<a href="#l6.346"></a><span id="l6.346" class="difflineminus">-  nsCOMPtr&lt;nsISupportsString&gt; nameString</span>
<a href="#l6.347"></a><span id="l6.347" class="difflineminus">-    (do_CreateInstance(&quot;@mozilla.org/supports-string;1&quot;));</span>
<a href="#l6.348"></a><span id="l6.348" class="difflineminus">-  if (!nameString) return NS_ERROR_FAILURE;</span>
<a href="#l6.349"></a><span id="l6.349" class="difflineminus">-</span>
<a href="#l6.350"></a><span id="l6.350" class="difflineminus">-  nameString-&gt;SetData(NS_LITERAL_STRING(&quot;Netscape 4.x&quot;));</span>
<a href="#l6.351"></a><span id="l6.351" class="difflineminus">-  mProfiles-&gt;AppendElement(nameString, PR_FALSE);</span>
<a href="#l6.352"></a><span id="l6.352" class="difflineminus">-  NS_ADDREF(*aResult = mProfiles);</span>
<a href="#l6.353"></a><span id="l6.353" class="difflineminus">-  return NS_OK;</span>
<a href="#l6.354"></a><span id="l6.354" class="difflineminus">-}</span>
<a href="#l6.355"></a><span id="l6.355" class="difflineminus">-</span>
<a href="#l6.356"></a><span id="l6.356" class="difflineminus">-#endif // GetSourceProfiles</span>
<a href="#l6.357"></a><span id="l6.357" class="difflineminus">-</span>
<a href="#l6.358"></a><span id="l6.358" class="difflineminus">-// on win/mac/os2, NS4x uses a registry to determine profile locations</span>
<a href="#l6.359"></a><span id="l6.359" class="difflineminus">-#if defined(XP_WIN) || defined(XP_MACOSX) || defined(XP_OS2)</span>
<a href="#l6.360"></a><span id="l6.360" class="difflineminus">-void nsDogbertProfileMigrator::GetSourceProfile(const PRUnichar* aProfile)</span>
<a href="#l6.361"></a><span id="l6.361" class="difflineminus">-{</span>
<a href="#l6.362"></a><span id="l6.362" class="difflineminus">-  nsresult rv;</span>
<a href="#l6.363"></a><span id="l6.363" class="difflineminus">-</span>
<a href="#l6.364"></a><span id="l6.364" class="difflineminus">-  nsCOMPtr&lt;nsIFile&gt; regFile;</span>
<a href="#l6.365"></a><span id="l6.365" class="difflineminus">-  rv = NS_GetSpecialDirectory(OLDREG_DIR, getter_AddRefs(regFile));</span>
<a href="#l6.366"></a><span id="l6.366" class="difflineminus">-  if (NS_FAILED(rv)) return;</span>
<a href="#l6.367"></a><span id="l6.367" class="difflineminus">-</span>
<a href="#l6.368"></a><span id="l6.368" class="difflineminus">-  regFile-&gt;AppendNative(NS_LITERAL_CSTRING(OLDREG_NAME));</span>
<a href="#l6.369"></a><span id="l6.369" class="difflineminus">-</span>
<a href="#l6.370"></a><span id="l6.370" class="difflineminus">-  nsCAutoString path;</span>
<a href="#l6.371"></a><span id="l6.371" class="difflineminus">-  rv = regFile-&gt;GetNativePath(path);</span>
<a href="#l6.372"></a><span id="l6.372" class="difflineminus">-  if (NS_FAILED(rv)) return;</span>
<a href="#l6.373"></a><span id="l6.373" class="difflineminus">-</span>
<a href="#l6.374"></a><span id="l6.374" class="difflineminus">-  if (NR_StartupRegistry())</span>
<a href="#l6.375"></a><span id="l6.375" class="difflineminus">-    return;</span>
<a href="#l6.376"></a><span id="l6.376" class="difflineminus">-</span>
<a href="#l6.377"></a><span id="l6.377" class="difflineminus">-  HREG reg = nsnull;</span>
<a href="#l6.378"></a><span id="l6.378" class="difflineminus">-  RKEY profile = nsnull;</span>
<a href="#l6.379"></a><span id="l6.379" class="difflineminus">-</span>
<a href="#l6.380"></a><span id="l6.380" class="difflineminus">-  if (NR_RegOpen(path.get(), &amp;reg))</span>
<a href="#l6.381"></a><span id="l6.381" class="difflineminus">-    goto cleanup;</span>
<a href="#l6.382"></a><span id="l6.382" class="difflineminus">-</span>
<a href="#l6.383"></a><span id="l6.383" class="difflineminus">-  {</span>
<a href="#l6.384"></a><span id="l6.384" class="difflineminus">-    // on macos, registry entries are UTF8 encoded</span>
<a href="#l6.385"></a><span id="l6.385" class="difflineminus">-    NS_ConvertUTF16toUTF8 profileName(aProfile);</span>
<a href="#l6.386"></a><span id="l6.386" class="difflineminus">-</span>
<a href="#l6.387"></a><span id="l6.387" class="difflineminus">-    if (NR_RegGetKey(reg, ROOTKEY_USERS, profileName.get(), &amp;profile))</span>
<a href="#l6.388"></a><span id="l6.388" class="difflineminus">-      goto cleanup;</span>
<a href="#l6.389"></a><span id="l6.389" class="difflineminus">-  }</span>
<a href="#l6.390"></a><span id="l6.390" class="difflineminus">-</span>
<a href="#l6.391"></a><span id="l6.391" class="difflineminus">-  char profilePath[MAXPATHLEN];</span>
<a href="#l6.392"></a><span id="l6.392" class="difflineminus">-  if (NR_RegGetEntryString(reg, profile, &quot;ProfileLocation&quot;, profilePath, MAXPATHLEN))</span>
<a href="#l6.393"></a><span id="l6.393" class="difflineminus">-    goto cleanup;</span>
<a href="#l6.394"></a><span id="l6.394" class="difflineminus">-</span>
<a href="#l6.395"></a><span id="l6.395" class="difflineminus">-  mSourceProfile = do_CreateInstance(&quot;@mozilla.org/file/local;1&quot;);</span>
<a href="#l6.396"></a><span id="l6.396" class="difflineminus">-  if (!mSourceProfile) goto cleanup;</span>
<a href="#l6.397"></a><span id="l6.397" class="difflineminus">-</span>
<a href="#l6.398"></a><span id="l6.398" class="difflineminus">-  {</span>
<a href="#l6.399"></a><span id="l6.399" class="difflineminus">-    // the string is UTF8 encoded, which forces us to do some strange string-do</span>
<a href="#l6.400"></a><span id="l6.400" class="difflineminus">-    rv = mSourceProfile-&gt;InitWithPath(NS_ConvertUTF8toUTF16(profilePath));</span>
<a href="#l6.401"></a><span id="l6.401" class="difflineminus">-  }</span>
<a href="#l6.402"></a><span id="l6.402" class="difflineminus">-</span>
<a href="#l6.403"></a><span id="l6.403" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l6.404"></a><span id="l6.404" class="difflineminus">-    mSourceProfile = nsnull;</span>
<a href="#l6.405"></a><span id="l6.405" class="difflineminus">-</span>
<a href="#l6.406"></a><span id="l6.406" class="difflineminus">-cleanup:</span>
<a href="#l6.407"></a><span id="l6.407" class="difflineminus">-  if (reg)</span>
<a href="#l6.408"></a><span id="l6.408" class="difflineminus">-    NR_RegClose(reg);</span>
<a href="#l6.409"></a><span id="l6.409" class="difflineminus">-  NR_ShutdownRegistry();</span>
<a href="#l6.410"></a><span id="l6.410" class="difflineminus">-}</span>
<a href="#l6.411"></a><span id="l6.411" class="difflineminus">-#else</span>
<a href="#l6.412"></a><span id="l6.412" class="difflineminus">-</span>
<a href="#l6.413"></a><span id="l6.413" class="difflineminus">-void</span>
<a href="#l6.414"></a><span id="l6.414" class="difflineminus">-nsDogbertProfileMigrator::GetSourceProfile(const PRUnichar* aProfile)</span>
<a href="#l6.415"></a><span id="l6.415" class="difflineminus">-{</span>
<a href="#l6.416"></a><span id="l6.416" class="difflineminus">-  // if GetSourceProfiles didn't do its magic, we're screwed</span>
<a href="#l6.417"></a><span id="l6.417" class="difflineminus">-}</span>
<a href="#l6.418"></a><span id="l6.418" class="difflineminus">-</span>
<a href="#l6.419"></a><span id="l6.419" class="difflineminus">-#endif</span>
<a href="#l6.420"></a><span id="l6.420" class="difflineminus">-</span>
<a href="#l6.421"></a><span id="l6.421" class="difflineminus">-</span>
<a href="#l6.422"></a><span id="l6.422" class="difflineminus">-nsresult nsDogbertProfileMigrator::CopyPreferences()</span>
<a href="#l6.423"></a><span id="l6.423" class="difflineminus">-{</span>
<a href="#l6.424"></a><span id="l6.424" class="difflineminus">-  // Load the source pref file</span>
<a href="#l6.425"></a><span id="l6.425" class="difflineminus">-</span>
<a href="#l6.426"></a><span id="l6.426" class="difflineminus">-  nsresult rv;</span>
<a href="#l6.427"></a><span id="l6.427" class="difflineminus">-  mPrefs = do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l6.428"></a><span id="l6.428" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.429"></a><span id="l6.429" class="difflineminus">-</span>
<a href="#l6.430"></a><span id="l6.430" class="difflineminus">-  nsCAutoString oldProfDirStr;</span>
<a href="#l6.431"></a><span id="l6.431" class="difflineminus">-  nsCAutoString newProfDirStr;</span>
<a href="#l6.432"></a><span id="l6.432" class="difflineminus">-</span>
<a href="#l6.433"></a><span id="l6.433" class="difflineminus">-  nsCOMPtr&lt;nsILocalFile&gt; sourceProfile = do_QueryInterface(mSourceProfile);</span>
<a href="#l6.434"></a><span id="l6.434" class="difflineminus">-  nsCOMPtr&lt;nsILocalFile&gt; targetProfile = do_QueryInterface(mTargetProfile);</span>
<a href="#l6.435"></a><span id="l6.435" class="difflineminus">-</span>
<a href="#l6.436"></a><span id="l6.436" class="difflineminus">-  sourceProfile-&gt;GetPersistentDescriptor(oldProfDirStr);</span>
<a href="#l6.437"></a><span id="l6.437" class="difflineminus">-  targetProfile-&gt;GetPersistentDescriptor(newProfDirStr);</span>
<a href="#l6.438"></a><span id="l6.438" class="difflineminus">-</span>
<a href="#l6.439"></a><span id="l6.439" class="difflineminus">-  nsAutoString index;</span>
<a href="#l6.440"></a><span id="l6.440" class="difflineminus">-  index.AppendInt(nsIMailProfileMigrator::MAILDATA);</span>
<a href="#l6.441"></a><span id="l6.441" class="difflineminus">-  NOTIFY_OBSERVERS(MIGRATION_ITEMBEFOREMIGRATE, index.get());</span>
<a href="#l6.442"></a><span id="l6.442" class="difflineminus">-</span>
<a href="#l6.443"></a><span id="l6.443" class="difflineminus">-  ProcessPrefsCallback(oldProfDirStr.get(), newProfDirStr.get());</span>
<a href="#l6.444"></a><span id="l6.444" class="difflineminus">-</span>
<a href="#l6.445"></a><span id="l6.445" class="difflineminus">-  // Generate the max progress value now that we know all of the files we need to copy</span>
<a href="#l6.446"></a><span id="l6.446" class="difflineminus">-  PRUint32 count = mFileCopyTransactions.Length();</span>
<a href="#l6.447"></a><span id="l6.447" class="difflineminus">-  for (PRUint32 i = 0; i &lt; count; ++i)</span>
<a href="#l6.448"></a><span id="l6.448" class="difflineminus">-  {</span>
<a href="#l6.449"></a><span id="l6.449" class="difflineminus">-    fileTransactionEntry fileTransaction = mFileCopyTransactions.ElementAt(i);</span>
<a href="#l6.450"></a><span id="l6.450" class="difflineminus">-    PRInt64 fileSize;</span>
<a href="#l6.451"></a><span id="l6.451" class="difflineminus">-    fileTransaction.srcFile-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l6.452"></a><span id="l6.452" class="difflineminus">-    LL_ADD(mMaxProgress, mMaxProgress, fileSize);</span>
<a href="#l6.453"></a><span id="l6.453" class="difflineminus">-  }</span>
<a href="#l6.454"></a><span id="l6.454" class="difflineminus">-</span>
<a href="#l6.455"></a><span id="l6.455" class="difflineminus">-  CopyNextFolder();</span>
<a href="#l6.456"></a><span id="l6.456" class="difflineminus">-  return NS_OK;</span>
<a href="#l6.457"></a><span id="l6.457" class="difflineminus">-}</span>
<a href="#l6.458"></a><span id="l6.458" class="difflineminus">-</span>
<a href="#l6.459"></a><span id="l6.459" class="difflineminus">-/*--------------------------------------------------------------------------</span>
<a href="#l6.460"></a><span id="l6.460" class="difflineminus">- * ProcessPrefsCallback is the primary funtion for the class nsPrefMigration.</span>
<a href="#l6.461"></a><span id="l6.461" class="difflineminus">- *</span>
<a href="#l6.462"></a><span id="l6.462" class="difflineminus">- * Called by: The Profile Manager (nsProfile.cpp)</span>
<a href="#l6.463"></a><span id="l6.463" class="difflineminus">- * INPUT: The specific profile path (prefPath) and the 5.0 installed path</span>
<a href="#l6.464"></a><span id="l6.464" class="difflineminus">- * OUTPUT: The modified 5.0 prefs files</span>
<a href="#l6.465"></a><span id="l6.465" class="difflineminus">- * RETURN: Success or a failure code</span>
<a href="#l6.466"></a><span id="l6.466" class="difflineminus">- *</span>
<a href="#l6.467"></a><span id="l6.467" class="difflineminus">- *-------------------------------------------------------------------------*/</span>
<a href="#l6.468"></a><span id="l6.468" class="difflineminus">-nsresult</span>
<a href="#l6.469"></a><span id="l6.469" class="difflineminus">-nsDogbertProfileMigrator::ProcessPrefsCallback(const char* oldProfilePathStr, const char * newProfilePathStr)</span>
<a href="#l6.470"></a><span id="l6.470" class="difflineminus">-{</span>
<a href="#l6.471"></a><span id="l6.471" class="difflineminus">-  nsresult rv;</span>
<a href="#l6.472"></a><span id="l6.472" class="difflineminus">-</span>
<a href="#l6.473"></a><span id="l6.473" class="difflineminus">-  nsCOMPtr&lt;nsILocalFile&gt; oldProfilePath;</span>
<a href="#l6.474"></a><span id="l6.474" class="difflineminus">-  nsCOMPtr&lt;nsILocalFile&gt; newProfilePath;</span>
<a href="#l6.475"></a><span id="l6.475" class="difflineminus">-  nsCOMPtr&lt;nsILocalFile&gt; oldPOPMailPath;</span>
<a href="#l6.476"></a><span id="l6.476" class="difflineminus">-  nsCOMPtr&lt;nsILocalFile&gt; newPOPMailPath;</span>
<a href="#l6.477"></a><span id="l6.477" class="difflineminus">-  nsCOMPtr&lt;nsILocalFile&gt; oldIMAPMailPath;</span>
<a href="#l6.478"></a><span id="l6.478" class="difflineminus">-  nsCOMPtr&lt;nsILocalFile&gt; newIMAPMailPath;</span>
<a href="#l6.479"></a><span id="l6.479" class="difflineminus">-  nsCOMPtr&lt;nsILocalFile&gt; oldIMAPLocalMailPath;</span>
<a href="#l6.480"></a><span id="l6.480" class="difflineminus">-  nsCOMPtr&lt;nsILocalFile&gt; newIMAPLocalMailPath;</span>
<a href="#l6.481"></a><span id="l6.481" class="difflineminus">-  nsCOMPtr&lt;nsILocalFile&gt; oldNewsPath;</span>
<a href="#l6.482"></a><span id="l6.482" class="difflineminus">-  nsCOMPtr&lt;nsILocalFile&gt; newNewsPath;</span>
<a href="#l6.483"></a><span id="l6.483" class="difflineminus">-  nsCOMPtr&lt;nsILocalFile&gt; newPrefsFile;</span>
<a href="#l6.484"></a><span id="l6.484" class="difflineminus">-#ifdef HAVE_MOVEMAIL</span>
<a href="#l6.485"></a><span id="l6.485" class="difflineminus">-  nsCOMPtr&lt;nsILocalFile&gt; oldMOVEMAILMailPath;</span>
<a href="#l6.486"></a><span id="l6.486" class="difflineminus">-  nsCOMPtr&lt;nsILocalFile&gt; newMOVEMAILMailPath;</span>
<a href="#l6.487"></a><span id="l6.487" class="difflineminus">-#endif /* HAVE_MOVEMAIL */</span>
<a href="#l6.488"></a><span id="l6.488" class="difflineminus">-  PRBool exists                  = PR_FALSE,</span>
<a href="#l6.489"></a><span id="l6.489" class="difflineminus">-         enoughSpace             = PR_TRUE,</span>
<a href="#l6.490"></a><span id="l6.490" class="difflineminus">-         localMailDriveDefault   = PR_FALSE,</span>
<a href="#l6.491"></a><span id="l6.491" class="difflineminus">-         summaryMailDriveDefault = PR_FALSE,</span>
<a href="#l6.492"></a><span id="l6.492" class="difflineminus">-         newsDriveDefault        = PR_FALSE,</span>
<a href="#l6.493"></a><span id="l6.493" class="difflineminus">-         copyMailFileInMigration = PR_TRUE;</span>
<a href="#l6.494"></a><span id="l6.494" class="difflineminus">-</span>
<a href="#l6.495"></a><span id="l6.495" class="difflineminus">-  nsCOMPtr &lt;nsILocalFile&gt; localMailFile;</span>
<a href="#l6.496"></a><span id="l6.496" class="difflineminus">-  nsCOMPtr &lt;nsILocalFile&gt; summaryMailFile;</span>
<a href="#l6.497"></a><span id="l6.497" class="difflineminus">-  nsCOMPtr &lt;nsILocalFile&gt; newsFile;</span>
<a href="#l6.498"></a><span id="l6.498" class="difflineminus">-  nsCOMPtr &lt;nsILocalFile&gt; oldProfileFile;</span>
<a href="#l6.499"></a><span id="l6.499" class="difflineminus">-  nsCOMPtr &lt;nsILocalFile&gt; newProfileFile;</span>
<a href="#l6.500"></a><span id="l6.500" class="difflineminus">-</span>
<a href="#l6.501"></a><span id="l6.501" class="difflineminus">-  PRInt32 serverType = POP_4X_MAIL_TYPE;</span>
<a href="#l6.502"></a><span id="l6.502" class="difflineminus">-  char *popServerName = nsnull;</span>
<a href="#l6.503"></a><span id="l6.503" class="difflineminus">-</span>
<a href="#l6.504"></a><span id="l6.504" class="difflineminus">-  PRUint32          totalRequired = 0;</span>
<a href="#l6.505"></a><span id="l6.505" class="difflineminus">-</span>
<a href="#l6.506"></a><span id="l6.506" class="difflineminus">-</span>
<a href="#l6.507"></a><span id="l6.507" class="difflineminus">-  PRInt64  localMailDrive   = LL_Zero(),</span>
<a href="#l6.508"></a><span id="l6.508" class="difflineminus">-           summaryMailDrive = LL_Zero(),</span>
<a href="#l6.509"></a><span id="l6.509" class="difflineminus">-           newsDrive        = LL_Zero(),</span>
<a href="#l6.510"></a><span id="l6.510" class="difflineminus">-    totalSummaryFileSize = LL_Zero(),</span>
<a href="#l6.511"></a><span id="l6.511" class="difflineminus">-    profileDrive     = LL_Zero(),</span>
<a href="#l6.512"></a><span id="l6.512" class="difflineminus">-           totalLocalMailSize = LL_Zero(),</span>
<a href="#l6.513"></a><span id="l6.513" class="difflineminus">-    totalNewsSize = LL_Zero(),</span>
<a href="#l6.514"></a><span id="l6.514" class="difflineminus">-           totalProfileSize = LL_Zero();</span>
<a href="#l6.515"></a><span id="l6.515" class="difflineminus">-</span>
<a href="#l6.516"></a><span id="l6.516" class="difflineminus">-  PRInt64  DriveID[MAX_DRIVES];</span>
<a href="#l6.517"></a><span id="l6.517" class="difflineminus">-  PRUint32 SpaceRequired[MAX_DRIVES];</span>
<a href="#l6.518"></a><span id="l6.518" class="difflineminus">-</span>
<a href="#l6.519"></a><span id="l6.519" class="difflineminus">-#if defined(NS_DEBUG)</span>
<a href="#l6.520"></a><span id="l6.520" class="difflineminus">-  printf(&quot;*Entered Actual Migration routine*\n&quot;);</span>
<a href="#l6.521"></a><span id="l6.521" class="difflineminus">-#endif</span>
<a href="#l6.522"></a><span id="l6.522" class="difflineminus">-</span>
<a href="#l6.523"></a><span id="l6.523" class="difflineminus">-  nsCOMPtr&lt;nsIPrefService&gt; prefService = do_QueryInterface(mPrefs, &amp;rv);</span>
<a href="#l6.524"></a><span id="l6.524" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.525"></a><span id="l6.525" class="difflineminus">-</span>
<a href="#l6.526"></a><span id="l6.526" class="difflineminus">-  for (int i=0; i &lt; MAX_DRIVES; i++)</span>
<a href="#l6.527"></a><span id="l6.527" class="difflineminus">-  {</span>
<a href="#l6.528"></a><span id="l6.528" class="difflineminus">-    DriveID[i] = LL_Zero();</span>
<a href="#l6.529"></a><span id="l6.529" class="difflineminus">-    SpaceRequired[i] = 0;</span>
<a href="#l6.530"></a><span id="l6.530" class="difflineminus">-  }</span>
<a href="#l6.531"></a><span id="l6.531" class="difflineminus">-</span>
<a href="#l6.532"></a><span id="l6.532" class="difflineminus">-  oldProfilePath = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l6.533"></a><span id="l6.533" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.534"></a><span id="l6.534" class="difflineminus">-  newProfilePath = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l6.535"></a><span id="l6.535" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.536"></a><span id="l6.536" class="difflineminus">-</span>
<a href="#l6.537"></a><span id="l6.537" class="difflineminus">-  rv = ConvertPersistentStringToFile(oldProfilePathStr, oldProfilePath);</span>
<a href="#l6.538"></a><span id="l6.538" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.539"></a><span id="l6.539" class="difflineminus">-  rv = ConvertPersistentStringToFile(newProfilePathStr, newProfilePath);</span>
<a href="#l6.540"></a><span id="l6.540" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.541"></a><span id="l6.541" class="difflineminus">-</span>
<a href="#l6.542"></a><span id="l6.542" class="difflineminus">-  oldProfileFile = oldProfilePath;</span>
<a href="#l6.543"></a><span id="l6.543" class="difflineminus">-  newProfileFile = newProfilePath;</span>
<a href="#l6.544"></a><span id="l6.544" class="difflineminus">-</span>
<a href="#l6.545"></a><span id="l6.545" class="difflineminus">-  /* initialize prefs with the old prefs.js file (which is a copy of the 4.x preferences file) */</span>
<a href="#l6.546"></a><span id="l6.546" class="difflineminus">-  nsCOMPtr&lt;nsILocalFile&gt; PrefsFile4x = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l6.547"></a><span id="l6.547" class="difflineminus">-</span>
<a href="#l6.548"></a><span id="l6.548" class="difflineminus">-  rv = PrefsFile4x-&gt;InitWithFile(oldProfilePath);</span>
<a href="#l6.549"></a><span id="l6.549" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.550"></a><span id="l6.550" class="difflineminus">-</span>
<a href="#l6.551"></a><span id="l6.551" class="difflineminus">-  rv = PrefsFile4x-&gt;AppendNative(NS_LITERAL_CSTRING(PREF_FILE_NAME_IN_4x));</span>
<a href="#l6.552"></a><span id="l6.552" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.553"></a><span id="l6.553" class="difflineminus">-</span>
<a href="#l6.554"></a><span id="l6.554" class="difflineminus">-  nsCOMPtr&lt;nsIFile&gt; systemTempDir;</span>
<a href="#l6.555"></a><span id="l6.555" class="difflineminus">-  rv = NS_GetSpecialDirectory(NS_OS_TEMP_DIR, getter_AddRefs(systemTempDir));</span>
<a href="#l6.556"></a><span id="l6.556" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.557"></a><span id="l6.557" class="difflineminus">-</span>
<a href="#l6.558"></a><span id="l6.558" class="difflineminus">-  systemTempDir-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;migrate&quot;));</span>
<a href="#l6.559"></a><span id="l6.559" class="difflineminus">-</span>
<a href="#l6.560"></a><span id="l6.560" class="difflineminus">-  //Create a unique directory in the system temp dir based on the name of the 4.x prefs file</span>
<a href="#l6.561"></a><span id="l6.561" class="difflineminus">-  rv = systemTempDir-&gt;CreateUnique(nsIFile::DIRECTORY_TYPE, 0700);</span>
<a href="#l6.562"></a><span id="l6.562" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.563"></a><span id="l6.563" class="difflineminus">-</span>
<a href="#l6.564"></a><span id="l6.564" class="difflineminus">-  rv = PrefsFile4x-&gt;CopyToNative(systemTempDir, NS_LITERAL_CSTRING(PREF_FILE_NAME_IN_4x));</span>
<a href="#l6.565"></a><span id="l6.565" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.566"></a><span id="l6.566" class="difflineminus">-</span>
<a href="#l6.567"></a><span id="l6.567" class="difflineminus">-  nsCOMPtr&lt;nsIFile&gt; cloneFile;</span>
<a href="#l6.568"></a><span id="l6.568" class="difflineminus">-  rv = systemTempDir-&gt;Clone(getter_AddRefs(cloneFile));</span>
<a href="#l6.569"></a><span id="l6.569" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.570"></a><span id="l6.570" class="difflineminus">-</span>
<a href="#l6.571"></a><span id="l6.571" class="difflineminus">-  m_prefsFile = do_QueryInterface(cloneFile, &amp;rv);</span>
<a href="#l6.572"></a><span id="l6.572" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.573"></a><span id="l6.573" class="difflineminus">-</span>
<a href="#l6.574"></a><span id="l6.574" class="difflineminus">-  rv = m_prefsFile-&gt;AppendNative(NS_LITERAL_CSTRING(PREF_FILE_NAME_IN_4x));</span>
<a href="#l6.575"></a><span id="l6.575" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.576"></a><span id="l6.576" class="difflineminus">-</span>
<a href="#l6.577"></a><span id="l6.577" class="difflineminus">-  //Clear the prefs in case a previous set was read in.</span>
<a href="#l6.578"></a><span id="l6.578" class="difflineminus">-  prefService-&gt;ResetPrefs();</span>
<a href="#l6.579"></a><span id="l6.579" class="difflineminus">-</span>
<a href="#l6.580"></a><span id="l6.580" class="difflineminus">-  //Now read the prefs from the prefs file in the system directory</span>
<a href="#l6.581"></a><span id="l6.581" class="difflineminus">-  prefService-&gt;ReadUserPrefs(m_prefsFile);</span>
<a href="#l6.582"></a><span id="l6.582" class="difflineminus">-</span>
<a href="#l6.583"></a><span id="l6.583" class="difflineminus">-  // Start computing the sizes required for migration</span>
<a href="#l6.584"></a><span id="l6.584" class="difflineminus">-  //</span>
<a href="#l6.585"></a><span id="l6.585" class="difflineminus">-  rv = GetSizes(oldProfileFile, PR_FALSE, &amp;totalProfileSize);</span>
<a href="#l6.586"></a><span id="l6.586" class="difflineminus">-  newProfileFile-&gt;GetDiskSpaceAvailable(&amp;profileDrive);</span>
<a href="#l6.587"></a><span id="l6.587" class="difflineminus">-</span>
<a href="#l6.588"></a><span id="l6.588" class="difflineminus">-  rv = mPrefs-&gt;GetIntPref(PREF_MAIL_SERVER_TYPE, &amp;serverType);</span>
<a href="#l6.589"></a><span id="l6.589" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.590"></a><span id="l6.590" class="difflineminus">-</span>
<a href="#l6.591"></a><span id="l6.591" class="difflineminus">-  // get the migration mode for mail</span>
<a href="#l6.592"></a><span id="l6.592" class="difflineminus">-  rv = mPrefs-&gt;GetBoolPref(PREF_MIGRATION_MODE_FOR_MAIL, &amp;copyMailFileInMigration);</span>
<a href="#l6.593"></a><span id="l6.593" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l6.594"></a><span id="l6.594" class="difflineminus">-    return rv;</span>
<a href="#l6.595"></a><span id="l6.595" class="difflineminus">-</span>
<a href="#l6.596"></a><span id="l6.596" class="difflineminus">-  if (serverType == POP_4X_MAIL_TYPE) {</span>
<a href="#l6.597"></a><span id="l6.597" class="difflineminus">-    summaryMailDriveDefault = PR_TRUE; //summary files are only used in IMAP so just set it to true here.</span>
<a href="#l6.598"></a><span id="l6.598" class="difflineminus">-    summaryMailDrive = profileDrive;   //just set the drive for summary files to be the same as the new profile</span>
<a href="#l6.599"></a><span id="l6.599" class="difflineminus">-</span>
<a href="#l6.600"></a><span id="l6.600" class="difflineminus">-    rv = GetDirFromPref(oldProfilePath,newProfilePath,NEW_MAIL_DIR_NAME, PREF_MAIL_DIRECTORY,</span>
<a href="#l6.601"></a><span id="l6.601" class="difflineminus">-                        getter_AddRefs(newPOPMailPath), getter_AddRefs(oldPOPMailPath));</span>
<a href="#l6.602"></a><span id="l6.602" class="difflineminus">-    if (NS_FAILED(rv)) {</span>
<a href="#l6.603"></a><span id="l6.603" class="difflineminus">-      rv = DetermineOldPath(oldProfilePath, OLD_MAIL_DIR_NAME, &quot;mailDirName&quot;, oldPOPMailPath);</span>
<a href="#l6.604"></a><span id="l6.604" class="difflineminus">-      if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.605"></a><span id="l6.605" class="difflineminus">-</span>
<a href="#l6.606"></a><span id="l6.606" class="difflineminus">-      rv = SetPremigratedFilePref(PREF_MAIL_DIRECTORY, oldPOPMailPath);</span>
<a href="#l6.607"></a><span id="l6.607" class="difflineminus">-      if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.608"></a><span id="l6.608" class="difflineminus">-</span>
<a href="#l6.609"></a><span id="l6.609" class="difflineminus">-      newPOPMailPath-&gt;InitWithFile(newProfilePath);</span>
<a href="#l6.610"></a><span id="l6.610" class="difflineminus">-      if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.611"></a><span id="l6.611" class="difflineminus">-</span>
<a href="#l6.612"></a><span id="l6.612" class="difflineminus">-      localMailDriveDefault = PR_TRUE;</span>
<a href="#l6.613"></a><span id="l6.613" class="difflineminus">-    }</span>
<a href="#l6.614"></a><span id="l6.614" class="difflineminus">-    localMailFile = oldPOPMailPath;</span>
<a href="#l6.615"></a><span id="l6.615" class="difflineminus">-    rv = GetSizes(localMailFile, PR_TRUE, &amp;totalLocalMailSize);</span>
<a href="#l6.616"></a><span id="l6.616" class="difflineminus">-    localMailFile-&gt;GetDiskSpaceAvailable(&amp;localMailDrive);</span>
<a href="#l6.617"></a><span id="l6.617" class="difflineminus">-  }</span>
<a href="#l6.618"></a><span id="l6.618" class="difflineminus">-  else if(serverType == IMAP_4X_MAIL_TYPE) {</span>
<a href="#l6.619"></a><span id="l6.619" class="difflineminus">-    /* First get the actual 4.x &quot;Local Mail&quot; files location */</span>
<a href="#l6.620"></a><span id="l6.620" class="difflineminus">-    rv = GetDirFromPref(oldProfilePath,newProfilePath, NEW_MAIL_DIR_NAME, PREF_MAIL_DIRECTORY,</span>
<a href="#l6.621"></a><span id="l6.621" class="difflineminus">-                        getter_AddRefs(newIMAPLocalMailPath), getter_AddRefs(oldIMAPLocalMailPath));</span>
<a href="#l6.622"></a><span id="l6.622" class="difflineminus">-    if (NS_FAILED(rv)) {</span>
<a href="#l6.623"></a><span id="l6.623" class="difflineminus">-      rv = DetermineOldPath(oldProfilePath, OLD_MAIL_DIR_NAME, &quot;mailDirName&quot;, oldIMAPLocalMailPath);</span>
<a href="#l6.624"></a><span id="l6.624" class="difflineminus">-      if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.625"></a><span id="l6.625" class="difflineminus">-</span>
<a href="#l6.626"></a><span id="l6.626" class="difflineminus">-      rv = SetPremigratedFilePref(PREF_MAIL_DIRECTORY, oldIMAPLocalMailPath);</span>
<a href="#l6.627"></a><span id="l6.627" class="difflineminus">-      if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.628"></a><span id="l6.628" class="difflineminus">-</span>
<a href="#l6.629"></a><span id="l6.629" class="difflineminus">-      rv = newIMAPLocalMailPath-&gt;InitWithFile(newProfilePath);</span>
<a href="#l6.630"></a><span id="l6.630" class="difflineminus">-      if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.631"></a><span id="l6.631" class="difflineminus">-</span>
<a href="#l6.632"></a><span id="l6.632" class="difflineminus">-      localMailDriveDefault = PR_TRUE;</span>
<a href="#l6.633"></a><span id="l6.633" class="difflineminus">-    }</span>
<a href="#l6.634"></a><span id="l6.634" class="difflineminus">-</span>
<a href="#l6.635"></a><span id="l6.635" class="difflineminus">-    localMailFile = oldIMAPLocalMailPath;</span>
<a href="#l6.636"></a><span id="l6.636" class="difflineminus">-    rv = GetSizes(localMailFile, PR_TRUE, &amp;totalLocalMailSize);</span>
<a href="#l6.637"></a><span id="l6.637" class="difflineminus">-    localMailFile-&gt;GetDiskSpaceAvailable(&amp;localMailDrive);</span>
<a href="#l6.638"></a><span id="l6.638" class="difflineminus">-</span>
<a href="#l6.639"></a><span id="l6.639" class="difflineminus">-    /* Next get IMAP mail summary files location */</span>
<a href="#l6.640"></a><span id="l6.640" class="difflineminus">-    rv = GetDirFromPref(oldProfilePath,newProfilePath, NEW_IMAPMAIL_DIR_NAME, PREF_MAIL_IMAP_ROOT_DIR,</span>
<a href="#l6.641"></a><span id="l6.641" class="difflineminus">-                        getter_AddRefs(newIMAPMailPath), getter_AddRefs(oldIMAPMailPath));</span>
<a href="#l6.642"></a><span id="l6.642" class="difflineminus">-    if (NS_FAILED(rv)) {</span>
<a href="#l6.643"></a><span id="l6.643" class="difflineminus">-      rv = oldIMAPMailPath-&gt;InitWithFile(oldProfilePath);</span>
<a href="#l6.644"></a><span id="l6.644" class="difflineminus">-      if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.645"></a><span id="l6.645" class="difflineminus">-</span>
<a href="#l6.646"></a><span id="l6.646" class="difflineminus">-      /* we didn't over localize &quot;ImapMail&quot; in 4.x, so this is all we have to do */</span>
<a href="#l6.647"></a><span id="l6.647" class="difflineminus">-      rv = oldIMAPMailPath-&gt;AppendNative(NS_LITERAL_CSTRING(OLD_IMAPMAIL_DIR_NAME));</span>
<a href="#l6.648"></a><span id="l6.648" class="difflineminus">-      if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.649"></a><span id="l6.649" class="difflineminus">-</span>
<a href="#l6.650"></a><span id="l6.650" class="difflineminus">-      rv = SetPremigratedFilePref(PREF_MAIL_IMAP_ROOT_DIR, oldIMAPMailPath);</span>
<a href="#l6.651"></a><span id="l6.651" class="difflineminus">-      if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.652"></a><span id="l6.652" class="difflineminus">-</span>
<a href="#l6.653"></a><span id="l6.653" class="difflineminus">-      rv = newIMAPMailPath-&gt;InitWithFile(newProfilePath);</span>
<a href="#l6.654"></a><span id="l6.654" class="difflineminus">-      if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.655"></a><span id="l6.655" class="difflineminus">-</span>
<a href="#l6.656"></a><span id="l6.656" class="difflineminus">-      summaryMailDriveDefault = PR_TRUE;</span>
<a href="#l6.657"></a><span id="l6.657" class="difflineminus">-    }</span>
<a href="#l6.658"></a><span id="l6.658" class="difflineminus">-</span>
<a href="#l6.659"></a><span id="l6.659" class="difflineminus">-    summaryMailFile = oldIMAPMailPath;</span>
<a href="#l6.660"></a><span id="l6.660" class="difflineminus">-    rv = GetSizes(summaryMailFile, PR_TRUE, &amp;totalSummaryFileSize);</span>
<a href="#l6.661"></a><span id="l6.661" class="difflineminus">-    summaryMailFile-&gt;GetDiskSpaceAvailable(&amp;summaryMailDrive);</span>
<a href="#l6.662"></a><span id="l6.662" class="difflineminus">-  }</span>
<a href="#l6.663"></a><span id="l6.663" class="difflineminus">-</span>
<a href="#l6.664"></a><span id="l6.664" class="difflineminus">-#ifdef HAVE_MOVEMAIL</span>
<a href="#l6.665"></a><span id="l6.665" class="difflineminus">-  else if (serverType == MOVEMAIL_4X_MAIL_TYPE) {</span>
<a href="#l6.666"></a><span id="l6.666" class="difflineminus">-</span>
<a href="#l6.667"></a><span id="l6.667" class="difflineminus">-    summaryMailDriveDefault = PR_TRUE;</span>
<a href="#l6.668"></a><span id="l6.668" class="difflineminus">-    summaryMailDrive = profileDrive;</span>
<a href="#l6.669"></a><span id="l6.669" class="difflineminus">-</span>
<a href="#l6.670"></a><span id="l6.670" class="difflineminus">-    rv = GetDirFromPref(oldProfilePath,newProfilePath,NEW_MAIL_DIR_NAME, PREF_MAIL_DIRECTORY,</span>
<a href="#l6.671"></a><span id="l6.671" class="difflineminus">-                        getter_AddRefs(newMOVEMAILMailPath), getter_AddRefs(oldMOVEMAILMailPath));</span>
<a href="#l6.672"></a><span id="l6.672" class="difflineminus">-    if (NS_FAILED(rv)) {</span>
<a href="#l6.673"></a><span id="l6.673" class="difflineminus">-      rv = oldMOVEMAILMailPath-&gt;InitWithFile(oldProfilePath);</span>
<a href="#l6.674"></a><span id="l6.674" class="difflineminus">-      if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.675"></a><span id="l6.675" class="difflineminus">-</span>
<a href="#l6.676"></a><span id="l6.676" class="difflineminus">-      /* we didn't over localize this in 4.x, so this is all we have to do */</span>
<a href="#l6.677"></a><span id="l6.677" class="difflineminus">-      rv = oldMOVEMAILMailPath-&gt;AppendNative(NS_LITERAL_CSTRING(OLD_MAIL_DIR_NAME));</span>
<a href="#l6.678"></a><span id="l6.678" class="difflineminus">-      if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.679"></a><span id="l6.679" class="difflineminus">-</span>
<a href="#l6.680"></a><span id="l6.680" class="difflineminus">-      rv = SetPremigratedFilePref(PREF_MAIL_DIRECTORY, oldMOVEMAILMailPath);</span>
<a href="#l6.681"></a><span id="l6.681" class="difflineminus">-      if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.682"></a><span id="l6.682" class="difflineminus">-</span>
<a href="#l6.683"></a><span id="l6.683" class="difflineminus">-      rv = newMOVEMAILMailPath-&gt;InitWithFile(newProfilePath);</span>
<a href="#l6.684"></a><span id="l6.684" class="difflineminus">-      if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.685"></a><span id="l6.685" class="difflineminus">-</span>
<a href="#l6.686"></a><span id="l6.686" class="difflineminus">-      localMailDriveDefault = PR_TRUE;</span>
<a href="#l6.687"></a><span id="l6.687" class="difflineminus">-    }</span>
<a href="#l6.688"></a><span id="l6.688" class="difflineminus">-    localMailFile = oldMOVEMAILMailPath;</span>
<a href="#l6.689"></a><span id="l6.689" class="difflineminus">-    rv = GetSizes(localMailFile, PR_TRUE, &amp;totalLocalMailSize);</span>
<a href="#l6.690"></a><span id="l6.690" class="difflineminus">-</span>
<a href="#l6.691"></a><span id="l6.691" class="difflineminus">-    localMailFile-&gt;GetDiskSpaceAvailable(&amp;localMailDrive);</span>
<a href="#l6.692"></a><span id="l6.692" class="difflineminus">-</span>
<a href="#l6.693"></a><span id="l6.693" class="difflineminus">-  }</span>
<a href="#l6.694"></a><span id="l6.694" class="difflineminus">-#endif //HAVE_MOVEMAIL</span>
<a href="#l6.695"></a><span id="l6.695" class="difflineminus">-</span>
<a href="#l6.696"></a><span id="l6.696" class="difflineminus">-    ////////////////////////////////////////////////////////////////////////////</span>
<a href="#l6.697"></a><span id="l6.697" class="difflineminus">-    // Now get the NEWS disk space requirements for migration.</span>
<a href="#l6.698"></a><span id="l6.698" class="difflineminus">-    ////////////////////////////////////////////////////////////////////////////</span>
<a href="#l6.699"></a><span id="l6.699" class="difflineminus">-    rv = GetDirFromPref(oldProfilePath,newProfilePath, NEW_NEWS_DIR_NAME, PREF_NEWS_DIRECTORY,</span>
<a href="#l6.700"></a><span id="l6.700" class="difflineminus">-                        getter_AddRefs(newNewsPath), getter_AddRefs(oldNewsPath));</span>
<a href="#l6.701"></a><span id="l6.701" class="difflineminus">-    if (NS_FAILED(rv)) {</span>
<a href="#l6.702"></a><span id="l6.702" class="difflineminus">-      rv = DetermineOldPath(oldProfilePath, OLD_NEWS_DIR_NAME, &quot;newsDirName&quot;, oldNewsPath);</span>
<a href="#l6.703"></a><span id="l6.703" class="difflineminus">-      if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.704"></a><span id="l6.704" class="difflineminus">-</span>
<a href="#l6.705"></a><span id="l6.705" class="difflineminus">-      rv = SetPremigratedFilePref(PREF_NEWS_DIRECTORY, oldNewsPath);</span>
<a href="#l6.706"></a><span id="l6.706" class="difflineminus">-      if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.707"></a><span id="l6.707" class="difflineminus">-</span>
<a href="#l6.708"></a><span id="l6.708" class="difflineminus">-      rv = newNewsPath-&gt;InitWithFile(newProfilePath);</span>
<a href="#l6.709"></a><span id="l6.709" class="difflineminus">-      if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.710"></a><span id="l6.710" class="difflineminus">-</span>
<a href="#l6.711"></a><span id="l6.711" class="difflineminus">-      newsDriveDefault = PR_TRUE;</span>
<a href="#l6.712"></a><span id="l6.712" class="difflineminus">-    }</span>
<a href="#l6.713"></a><span id="l6.713" class="difflineminus">-    rv = GetSizes(oldNewsPath, PR_TRUE, &amp;totalNewsSize);</span>
<a href="#l6.714"></a><span id="l6.714" class="difflineminus">-    oldNewsPath-&gt;GetDiskSpaceAvailable(&amp;newsDrive);</span>
<a href="#l6.715"></a><span id="l6.715" class="difflineminus">-</span>
<a href="#l6.716"></a><span id="l6.716" class="difflineminus">-    //</span>
<a href="#l6.717"></a><span id="l6.717" class="difflineminus">-    // Compute the space needed to migrate the profile</span>
<a href="#l6.718"></a><span id="l6.718" class="difflineminus">-    //</span>
<a href="#l6.719"></a><span id="l6.719" class="difflineminus">-    if(newsDriveDefault &amp;&amp; localMailDriveDefault &amp;&amp; summaryMailDriveDefault) // DEFAULT: All on the same drive</span>
<a href="#l6.720"></a><span id="l6.720" class="difflineminus">-    {</span>
<a href="#l6.721"></a><span id="l6.721" class="difflineminus">-      totalRequired = totalNewsSize + totalLocalMailSize + totalSummaryFileSize + totalProfileSize;</span>
<a href="#l6.722"></a><span id="l6.722" class="difflineminus">-      rv = ComputeSpaceRequirements(DriveID, SpaceRequired, profileDrive, totalRequired);</span>
<a href="#l6.723"></a><span id="l6.723" class="difflineminus">-      if (NS_FAILED(rv))</span>
<a href="#l6.724"></a><span id="l6.724" class="difflineminus">-        enoughSpace = PR_FALSE;</span>
<a href="#l6.725"></a><span id="l6.725" class="difflineminus">-    }</span>
<a href="#l6.726"></a><span id="l6.726" class="difflineminus">-    else</span>
<a href="#l6.727"></a><span id="l6.727" class="difflineminus">-    {</span>
<a href="#l6.728"></a><span id="l6.728" class="difflineminus">-      rv = ComputeSpaceRequirements(DriveID, SpaceRequired, profileDrive, totalProfileSize);</span>
<a href="#l6.729"></a><span id="l6.729" class="difflineminus">-      if (NS_FAILED(rv))</span>
<a href="#l6.730"></a><span id="l6.730" class="difflineminus">-        enoughSpace = PR_FALSE;</span>
<a href="#l6.731"></a><span id="l6.731" class="difflineminus">-      rv = ComputeSpaceRequirements(DriveID, SpaceRequired, localMailDrive, totalLocalMailSize);</span>
<a href="#l6.732"></a><span id="l6.732" class="difflineminus">-      if (NS_FAILED(rv))</span>
<a href="#l6.733"></a><span id="l6.733" class="difflineminus">-        enoughSpace = PR_FALSE;</span>
<a href="#l6.734"></a><span id="l6.734" class="difflineminus">-      rv = ComputeSpaceRequirements(DriveID, SpaceRequired, summaryMailDrive, totalSummaryFileSize);</span>
<a href="#l6.735"></a><span id="l6.735" class="difflineminus">-      if (NS_FAILED(rv))</span>
<a href="#l6.736"></a><span id="l6.736" class="difflineminus">-        enoughSpace = PR_FALSE;</span>
<a href="#l6.737"></a><span id="l6.737" class="difflineminus">-      rv = ComputeSpaceRequirements(DriveID, SpaceRequired, newsDrive, totalNewsSize);</span>
<a href="#l6.738"></a><span id="l6.738" class="difflineminus">-      if (NS_FAILED(rv))</span>
<a href="#l6.739"></a><span id="l6.739" class="difflineminus">-        enoughSpace = PR_FALSE;</span>
<a href="#l6.740"></a><span id="l6.740" class="difflineminus">-    }</span>
<a href="#l6.741"></a><span id="l6.741" class="difflineminus">-</span>
<a href="#l6.742"></a><span id="l6.742" class="difflineminus">-    // do something if not enough space</span>
<a href="#l6.743"></a><span id="l6.743" class="difflineminus">-</span>
<a href="#l6.744"></a><span id="l6.744" class="difflineminus">-  ////////////////////////////////////////////////////////////////////////////</span>
<a href="#l6.745"></a><span id="l6.745" class="difflineminus">-  // If we reached this point, there is enough room to do a migration.</span>
<a href="#l6.746"></a><span id="l6.746" class="difflineminus">-  // Start creating directories and setting new pref values.</span>
<a href="#l6.747"></a><span id="l6.747" class="difflineminus">-  ////////////////////////////////////////////////////////////////////////////</span>
<a href="#l6.748"></a><span id="l6.748" class="difflineminus">-</span>
<a href="#l6.749"></a><span id="l6.749" class="difflineminus">-  /* Create the new profile tree for 5.x */</span>
<a href="#l6.750"></a><span id="l6.750" class="difflineminus">-  rv = CreateNewUser5Tree(oldProfilePath, newProfilePath);</span>
<a href="#l6.751"></a><span id="l6.751" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.752"></a><span id="l6.752" class="difflineminus">-</span>
<a href="#l6.753"></a><span id="l6.753" class="difflineminus">-</span>
<a href="#l6.754"></a><span id="l6.754" class="difflineminus">-  if (serverType == POP_4X_MAIL_TYPE) {</span>
<a href="#l6.755"></a><span id="l6.755" class="difflineminus">-</span>
<a href="#l6.756"></a><span id="l6.756" class="difflineminus">-    rv = newPOPMailPath-&gt;Exists(&amp;exists);</span>
<a href="#l6.757"></a><span id="l6.757" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.758"></a><span id="l6.758" class="difflineminus">-    if (!exists)  {</span>
<a href="#l6.759"></a><span id="l6.759" class="difflineminus">-      rv = newPOPMailPath-&gt;Create(nsIFile::DIRECTORY_TYPE, 0700);</span>
<a href="#l6.760"></a><span id="l6.760" class="difflineminus">-      if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.761"></a><span id="l6.761" class="difflineminus">-    }</span>
<a href="#l6.762"></a><span id="l6.762" class="difflineminus">-</span>
<a href="#l6.763"></a><span id="l6.763" class="difflineminus">-    rv = newPOPMailPath-&gt;AppendNative(NS_LITERAL_CSTRING(NEW_MAIL_DIR_NAME));</span>
<a href="#l6.764"></a><span id="l6.764" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.765"></a><span id="l6.765" class="difflineminus">-</span>
<a href="#l6.766"></a><span id="l6.766" class="difflineminus">-    rv = newPOPMailPath-&gt;Exists(&amp;exists);</span>
<a href="#l6.767"></a><span id="l6.767" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.768"></a><span id="l6.768" class="difflineminus">-    if (!exists)  {</span>
<a href="#l6.769"></a><span id="l6.769" class="difflineminus">-      rv = newPOPMailPath-&gt;Create(nsIFile::DIRECTORY_TYPE, 0700);</span>
<a href="#l6.770"></a><span id="l6.770" class="difflineminus">-      if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.771"></a><span id="l6.771" class="difflineminus">-    }</span>
<a href="#l6.772"></a><span id="l6.772" class="difflineminus">-</span>
<a href="#l6.773"></a><span id="l6.773" class="difflineminus">-    rv = mPrefs-&gt;SetComplexValue(PREF_MAIL_DIRECTORY, NS_GET_IID(nsILocalFile), newPOPMailPath);</span>
<a href="#l6.774"></a><span id="l6.774" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.775"></a><span id="l6.775" class="difflineminus">-</span>
<a href="#l6.776"></a><span id="l6.776" class="difflineminus">-    mPrefs-&gt;GetCharPref(PREF_NETWORK_HOSTS_POP_SERVER, &amp;popServerName);</span>
<a href="#l6.777"></a><span id="l6.777" class="difflineminus">-</span>
<a href="#l6.778"></a><span id="l6.778" class="difflineminus">-    nsCAutoString popServerNamewithoutPort(popServerName);</span>
<a href="#l6.779"></a><span id="l6.779" class="difflineminus">-    PRInt32 colonPos = popServerNamewithoutPort.FindChar(':');</span>
<a href="#l6.780"></a><span id="l6.780" class="difflineminus">-</span>
<a href="#l6.781"></a><span id="l6.781" class="difflineminus">-    if (colonPos != -1 ) {</span>
<a href="#l6.782"></a><span id="l6.782" class="difflineminus">-      popServerNamewithoutPort.SetLength(colonPos);</span>
<a href="#l6.783"></a><span id="l6.783" class="difflineminus">-      rv = newPOPMailPath-&gt;AppendNative(popServerNamewithoutPort);</span>
<a href="#l6.784"></a><span id="l6.784" class="difflineminus">-    }</span>
<a href="#l6.785"></a><span id="l6.785" class="difflineminus">-    else</span>
<a href="#l6.786"></a><span id="l6.786" class="difflineminus">-      rv = newPOPMailPath-&gt;AppendNative(nsDependentCString(popServerName));</span>
<a href="#l6.787"></a><span id="l6.787" class="difflineminus">-</span>
<a href="#l6.788"></a><span id="l6.788" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.789"></a><span id="l6.789" class="difflineminus">-</span>
<a href="#l6.790"></a><span id="l6.790" class="difflineminus">-    rv = newPOPMailPath-&gt;Exists(&amp;exists);</span>
<a href="#l6.791"></a><span id="l6.791" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.792"></a><span id="l6.792" class="difflineminus">-    if (!exists)  {</span>
<a href="#l6.793"></a><span id="l6.793" class="difflineminus">-      rv = newPOPMailPath-&gt;Create(nsIFile::DIRECTORY_TYPE, 0700);</span>
<a href="#l6.794"></a><span id="l6.794" class="difflineminus">-      if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.795"></a><span id="l6.795" class="difflineminus">-    }</span>
<a href="#l6.796"></a><span id="l6.796" class="difflineminus">-  }</span>
<a href="#l6.797"></a><span id="l6.797" class="difflineminus">-  else if (serverType == IMAP_4X_MAIL_TYPE) {</span>
<a href="#l6.798"></a><span id="l6.798" class="difflineminus">-   if( copyMailFileInMigration )  // copy mail files in migration</span>
<a href="#l6.799"></a><span id="l6.799" class="difflineminus">-   {</span>
<a href="#l6.800"></a><span id="l6.800" class="difflineminus">-     rv = newIMAPLocalMailPath-&gt;Exists(&amp;exists);</span>
<a href="#l6.801"></a><span id="l6.801" class="difflineminus">-     if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.802"></a><span id="l6.802" class="difflineminus">-     if (!exists)  {</span>
<a href="#l6.803"></a><span id="l6.803" class="difflineminus">-        rv = newIMAPLocalMailPath-&gt;Create(nsIFile::DIRECTORY_TYPE, 0700);</span>
<a href="#l6.804"></a><span id="l6.804" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.805"></a><span id="l6.805" class="difflineminus">-     }</span>
<a href="#l6.806"></a><span id="l6.806" class="difflineminus">-</span>
<a href="#l6.807"></a><span id="l6.807" class="difflineminus">-    rv = newIMAPLocalMailPath-&gt;AppendNative(NS_LITERAL_CSTRING(NEW_MAIL_DIR_NAME));</span>
<a href="#l6.808"></a><span id="l6.808" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.809"></a><span id="l6.809" class="difflineminus">-</span>
<a href="#l6.810"></a><span id="l6.810" class="difflineminus">-    /* Now create the new &quot;Mail/Local Folders&quot; directory */</span>
<a href="#l6.811"></a><span id="l6.811" class="difflineminus">-    rv = newIMAPLocalMailPath-&gt;Exists(&amp;exists);</span>
<a href="#l6.812"></a><span id="l6.812" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.813"></a><span id="l6.813" class="difflineminus">-    if (!exists)  {</span>
<a href="#l6.814"></a><span id="l6.814" class="difflineminus">-      newIMAPLocalMailPath-&gt;Create(nsIFile::DIRECTORY_TYPE, 0700);</span>
<a href="#l6.815"></a><span id="l6.815" class="difflineminus">-    }</span>
<a href="#l6.816"></a><span id="l6.816" class="difflineminus">-</span>
<a href="#l6.817"></a><span id="l6.817" class="difflineminus">-    rv = mPrefs-&gt;SetComplexValue(PREF_MAIL_DIRECTORY, NS_GET_IID(nsILocalFile), newIMAPLocalMailPath);</span>
<a href="#l6.818"></a><span id="l6.818" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.819"></a><span id="l6.819" class="difflineminus">-</span>
<a href="#l6.820"></a><span id="l6.820" class="difflineminus">-    rv = newIMAPLocalMailPath-&gt;AppendNative(NS_LITERAL_CSTRING(NEW_LOCAL_MAIL_DIR_NAME));</span>
<a href="#l6.821"></a><span id="l6.821" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.822"></a><span id="l6.822" class="difflineminus">-    rv = newIMAPLocalMailPath-&gt;Exists(&amp;exists);</span>
<a href="#l6.823"></a><span id="l6.823" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.824"></a><span id="l6.824" class="difflineminus">-    if (!exists)  {</span>
<a href="#l6.825"></a><span id="l6.825" class="difflineminus">-      rv = newIMAPLocalMailPath-&gt;Create(nsIFile::DIRECTORY_TYPE, 0700);</span>
<a href="#l6.826"></a><span id="l6.826" class="difflineminus">-      if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.827"></a><span id="l6.827" class="difflineminus">-    }</span>
<a href="#l6.828"></a><span id="l6.828" class="difflineminus">-</span>
<a href="#l6.829"></a><span id="l6.829" class="difflineminus">-    /* Now deal with the IMAP mail summary file location */</span>
<a href="#l6.830"></a><span id="l6.830" class="difflineminus">-    rv = newIMAPMailPath-&gt;Exists(&amp;exists);</span>
<a href="#l6.831"></a><span id="l6.831" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.832"></a><span id="l6.832" class="difflineminus">-    if (!exists)  {</span>
<a href="#l6.833"></a><span id="l6.833" class="difflineminus">-      rv = newIMAPMailPath-&gt;Create(nsIFile::DIRECTORY_TYPE, 0700);</span>
<a href="#l6.834"></a><span id="l6.834" class="difflineminus">-      if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.835"></a><span id="l6.835" class="difflineminus">-    }</span>
<a href="#l6.836"></a><span id="l6.836" class="difflineminus">-</span>
<a href="#l6.837"></a><span id="l6.837" class="difflineminus">-    rv = newIMAPMailPath-&gt;AppendNative(NS_LITERAL_CSTRING(NEW_IMAPMAIL_DIR_NAME));</span>
<a href="#l6.838"></a><span id="l6.838" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.839"></a><span id="l6.839" class="difflineminus">-</span>
<a href="#l6.840"></a><span id="l6.840" class="difflineminus">-    rv = newIMAPMailPath-&gt;Exists(&amp;exists);</span>
<a href="#l6.841"></a><span id="l6.841" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.842"></a><span id="l6.842" class="difflineminus">-    if (!exists)  {</span>
<a href="#l6.843"></a><span id="l6.843" class="difflineminus">-      rv = newIMAPMailPath-&gt;Create(nsIFile::DIRECTORY_TYPE, 0700);</span>
<a href="#l6.844"></a><span id="l6.844" class="difflineminus">-      if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.845"></a><span id="l6.845" class="difflineminus">-    }</span>
<a href="#l6.846"></a><span id="l6.846" class="difflineminus">-</span>
<a href="#l6.847"></a><span id="l6.847" class="difflineminus">-    {</span>
<a href="#l6.848"></a><span id="l6.848" class="difflineminus">-      rv = mPrefs-&gt;SetComplexValue(PREF_MAIL_IMAP_ROOT_DIR, NS_GET_IID(nsILocalFile), newIMAPMailPath);</span>
<a href="#l6.849"></a><span id="l6.849" class="difflineminus">-      if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.850"></a><span id="l6.850" class="difflineminus">-    }</span>
<a href="#l6.851"></a><span id="l6.851" class="difflineminus">-   }</span>
<a href="#l6.852"></a><span id="l6.852" class="difflineminus">-   else</span>
<a href="#l6.853"></a><span id="l6.853" class="difflineminus">-   {</span>
<a href="#l6.854"></a><span id="l6.854" class="difflineminus">-      rv = mPrefs-&gt;SetComplexValue(PREF_MAIL_DIRECTORY, NS_GET_IID(nsILocalFile), oldIMAPLocalMailPath);</span>
<a href="#l6.855"></a><span id="l6.855" class="difflineminus">-      if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.856"></a><span id="l6.856" class="difflineminus">-      rv = mPrefs-&gt;SetComplexValue(PREF_MAIL_IMAP_ROOT_DIR, NS_GET_IID(nsILocalFile), oldIMAPMailPath);</span>
<a href="#l6.857"></a><span id="l6.857" class="difflineminus">-      if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.858"></a><span id="l6.858" class="difflineminus">-   }</span>
<a href="#l6.859"></a><span id="l6.859" class="difflineminus">-  }</span>
<a href="#l6.860"></a><span id="l6.860" class="difflineminus">-</span>
<a href="#l6.861"></a><span id="l6.861" class="difflineminus">-#ifdef HAVE_MOVEMAIL</span>
<a href="#l6.862"></a><span id="l6.862" class="difflineminus">-  else if (serverType == MOVEMAIL_4X_MAIL_TYPE) {</span>
<a href="#l6.863"></a><span id="l6.863" class="difflineminus">-</span>
<a href="#l6.864"></a><span id="l6.864" class="difflineminus">-    rv = newMOVEMAILMailPath-&gt;Exists(&amp;exists);</span>
<a href="#l6.865"></a><span id="l6.865" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.866"></a><span id="l6.866" class="difflineminus">-    if (!exists)  {</span>
<a href="#l6.867"></a><span id="l6.867" class="difflineminus">-      rv = newMOVEMAILMailPath-&gt;Create(nsIFile::DIRECTORY_TYPE, 0700);</span>
<a href="#l6.868"></a><span id="l6.868" class="difflineminus">-      if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.869"></a><span id="l6.869" class="difflineminus">-    }</span>
<a href="#l6.870"></a><span id="l6.870" class="difflineminus">-</span>
<a href="#l6.871"></a><span id="l6.871" class="difflineminus">-    rv = newMOVEMAILMailPath-&gt;AppendNative(NS_LITERAL_CSTRING(NEW_MAIL_DIR_NAME));</span>
<a href="#l6.872"></a><span id="l6.872" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.873"></a><span id="l6.873" class="difflineminus">-</span>
<a href="#l6.874"></a><span id="l6.874" class="difflineminus">-    rv = newMOVEMAILMailPath-&gt;Exists(&amp;exists);</span>
<a href="#l6.875"></a><span id="l6.875" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.876"></a><span id="l6.876" class="difflineminus">-    if (!exists)  {</span>
<a href="#l6.877"></a><span id="l6.877" class="difflineminus">-      rv = newMOVEMAILMailPath-&gt;Create(nsIFile::DIRECTORY_TYPE, 0700);</span>
<a href="#l6.878"></a><span id="l6.878" class="difflineminus">-      if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.879"></a><span id="l6.879" class="difflineminus">-    }</span>
<a href="#l6.880"></a><span id="l6.880" class="difflineminus">-</span>
<a href="#l6.881"></a><span id="l6.881" class="difflineminus">-    rv = mPrefs-&gt;SetComplexValue(PREF_MAIL_DIRECTORY, NS_GET_IID(nsILocalFile), newMOVEMAILMailPath);</span>
<a href="#l6.882"></a><span id="l6.882" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.883"></a><span id="l6.883" class="difflineminus">-</span>
<a href="#l6.884"></a><span id="l6.884" class="difflineminus">-    rv = newMOVEMAILMailPath-&gt;AppendNative(NS_LITERAL_CSTRING(NEW_MOVEMAIL_DIR_NAME));</span>
<a href="#l6.885"></a><span id="l6.885" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.886"></a><span id="l6.886" class="difflineminus">-</span>
<a href="#l6.887"></a><span id="l6.887" class="difflineminus">-    rv = newMOVEMAILMailPath-&gt;Exists(&amp;exists);</span>
<a href="#l6.888"></a><span id="l6.888" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.889"></a><span id="l6.889" class="difflineminus">-    if (!exists)  {</span>
<a href="#l6.890"></a><span id="l6.890" class="difflineminus">-      rv = newMOVEMAILMailPath-&gt;Create(nsIFile::DIRECTORY_TYPE, 0700);</span>
<a href="#l6.891"></a><span id="l6.891" class="difflineminus">-      if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.892"></a><span id="l6.892" class="difflineminus">-    }</span>
<a href="#l6.893"></a><span id="l6.893" class="difflineminus">-    rv = NS_OK;</span>
<a href="#l6.894"></a><span id="l6.894" class="difflineminus">-  }</span>
<a href="#l6.895"></a><span id="l6.895" class="difflineminus">-#endif /* HAVE_MOVEMAIL */</span>
<a href="#l6.896"></a><span id="l6.896" class="difflineminus">-  else {</span>
<a href="#l6.897"></a><span id="l6.897" class="difflineminus">-    NS_ERROR(&quot;failure, didn't recognize your mail server type.&quot;);</span>
<a href="#l6.898"></a><span id="l6.898" class="difflineminus">-    return NS_ERROR_UNEXPECTED;</span>
<a href="#l6.899"></a><span id="l6.899" class="difflineminus">-  }</span>
<a href="#l6.900"></a><span id="l6.900" class="difflineminus">-</span>
<a href="#l6.901"></a><span id="l6.901" class="difflineminus">-  ////////////////////////////////////////////////////////////////////////////</span>
<a href="#l6.902"></a><span id="l6.902" class="difflineminus">-  // Set all the appropriate NEWS prefs.</span>
<a href="#l6.903"></a><span id="l6.903" class="difflineminus">-  ////////////////////////////////////////////////////////////////////////////</span>
<a href="#l6.904"></a><span id="l6.904" class="difflineminus">-</span>
<a href="#l6.905"></a><span id="l6.905" class="difflineminus">-  rv = newNewsPath-&gt;Exists(&amp;exists);</span>
<a href="#l6.906"></a><span id="l6.906" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.907"></a><span id="l6.907" class="difflineminus">-  if (!exists)  {</span>
<a href="#l6.908"></a><span id="l6.908" class="difflineminus">-    rv = newNewsPath-&gt;Create(nsIFile::DIRECTORY_TYPE, 0700);</span>
<a href="#l6.909"></a><span id="l6.909" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.910"></a><span id="l6.910" class="difflineminus">-  }</span>
<a href="#l6.911"></a><span id="l6.911" class="difflineminus">-</span>
<a href="#l6.912"></a><span id="l6.912" class="difflineminus">-  rv = newNewsPath-&gt;AppendNative(NS_LITERAL_CSTRING(NEW_NEWS_DIR_NAME));</span>
<a href="#l6.913"></a><span id="l6.913" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.914"></a><span id="l6.914" class="difflineminus">-</span>
<a href="#l6.915"></a><span id="l6.915" class="difflineminus">-  rv = newNewsPath-&gt;Exists(&amp;exists);</span>
<a href="#l6.916"></a><span id="l6.916" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.917"></a><span id="l6.917" class="difflineminus">-  if (!exists)  {</span>
<a href="#l6.918"></a><span id="l6.918" class="difflineminus">-    rv = newNewsPath-&gt;Create(nsIFile::DIRECTORY_TYPE, 0700);</span>
<a href="#l6.919"></a><span id="l6.919" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.920"></a><span id="l6.920" class="difflineminus">-  }</span>
<a href="#l6.921"></a><span id="l6.921" class="difflineminus">-</span>
<a href="#l6.922"></a><span id="l6.922" class="difflineminus">-  rv = mPrefs-&gt;SetComplexValue(PREF_NEWS_DIRECTORY, NS_GET_IID(nsILocalFile), newNewsPath);</span>
<a href="#l6.923"></a><span id="l6.923" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.924"></a><span id="l6.924" class="difflineminus">-</span>
<a href="#l6.925"></a><span id="l6.925" class="difflineminus">-  PRBool needToRenameFilterFiles;</span>
<a href="#l6.926"></a><span id="l6.926" class="difflineminus">-  if (PL_strcmp(IMAP_MAIL_FILTER_FILE_NAME_IN_4x,IMAP_MAIL_FILTER_FILE_NAME_IN_5x)) {</span>
<a href="#l6.927"></a><span id="l6.927" class="difflineminus">-#ifdef IMAP_MAIL_FILTER_FILE_NAME_FORMAT_IN_4x</span>
<a href="#l6.928"></a><span id="l6.928" class="difflineminus">-    // if we defined a format, the filter files don't live in the host directories</span>
<a href="#l6.929"></a><span id="l6.929" class="difflineminus">-    // (mac does this.)  we'll take care of those filter files later, in DoSpecialUpdates()</span>
<a href="#l6.930"></a><span id="l6.930" class="difflineminus">-    needToRenameFilterFiles = PR_FALSE;</span>
<a href="#l6.931"></a><span id="l6.931" class="difflineminus">-#else</span>
<a href="#l6.932"></a><span id="l6.932" class="difflineminus">-    needToRenameFilterFiles = PR_TRUE;</span>
<a href="#l6.933"></a><span id="l6.933" class="difflineminus">-#endif /* IMAP_MAIL_FILTER_FILE_NAME_FORMAT_IN_4x */</span>
<a href="#l6.934"></a><span id="l6.934" class="difflineminus">-  }</span>
<a href="#l6.935"></a><span id="l6.935" class="difflineminus">-  else {</span>
<a href="#l6.936"></a><span id="l6.936" class="difflineminus">-    // if the name was the same in 4x as in 5x, no need to rename it</span>
<a href="#l6.937"></a><span id="l6.937" class="difflineminus">-    needToRenameFilterFiles = PR_FALSE;</span>
<a href="#l6.938"></a><span id="l6.938" class="difflineminus">-  }</span>
<a href="#l6.939"></a><span id="l6.939" class="difflineminus">-</span>
<a href="#l6.940"></a><span id="l6.940" class="difflineminus">-  // just copy what we need</span>
<a href="#l6.941"></a><span id="l6.941" class="difflineminus">-#ifdef XP_MACOSX</span>
<a href="#l6.942"></a><span id="l6.942" class="difflineminus">-  rv = DoTheCopy(oldProfilePath, newProfilePath, SECURITY_PATH, PR_TRUE);</span>
<a href="#l6.943"></a><span id="l6.943" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.944"></a><span id="l6.944" class="difflineminus">-#else</span>
<a href="#l6.945"></a><span id="l6.945" class="difflineminus">-  rv = DoTheCopy(oldProfilePath, newProfilePath, PSM_CERT7_DB);</span>
<a href="#l6.946"></a><span id="l6.946" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.947"></a><span id="l6.947" class="difflineminus">-  rv = DoTheCopy(oldProfilePath, newProfilePath, PSM_KEY3_DB);</span>
<a href="#l6.948"></a><span id="l6.948" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.949"></a><span id="l6.949" class="difflineminus">-  rv = DoTheCopy(oldProfilePath, newProfilePath, PSM_SECMODULE_DB);</span>
<a href="#l6.950"></a><span id="l6.950" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.951"></a><span id="l6.951" class="difflineminus">-#endif /* XP_MACOSX */</span>
<a href="#l6.952"></a><span id="l6.952" class="difflineminus">-</span>
<a href="#l6.953"></a><span id="l6.953" class="difflineminus">-#ifdef XP_MACOSX</span>
<a href="#l6.954"></a><span id="l6.954" class="difflineminus">-  // Copy the Mac filter rule files which sits at the top level dir of a 4.x profile.</span>
<a href="#l6.955"></a><span id="l6.955" class="difflineminus">-  if(serverType == IMAP_4X_MAIL_TYPE) {</span>
<a href="#l6.956"></a><span id="l6.956" class="difflineminus">-    rv = CopyFilesByPattern(oldProfilePath, newProfilePath, MAC_RULES_FILE_ENDING_STRING_IN_4X);</span>
<a href="#l6.957"></a><span id="l6.957" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l6.958"></a><span id="l6.958" class="difflineminus">-  }</span>
<a href="#l6.959"></a><span id="l6.959" class="difflineminus">-#endif</span>
<a href="#l6.960"></a><span id="l6.960" class="difflineminus">-</span>
<a href="#l6.961"></a><span id="l6.961" class="difflineminus">-  rv = DoTheCopy(oldNewsPath, newNewsPath, PR_TRUE);</span>
<a href="#l6.962"></a><span id="l6.962" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.963"></a><span id="l6.963" class="difflineminus">-</span>
<a href="#l6.964"></a><span id="l6.964" class="difflineminus">-#ifdef NEED_TO_COPY_AND_RENAME_NEWSRC_FILES</span>
<a href="#l6.965"></a><span id="l6.965" class="difflineminus">-  /* in 4.x, the newsrc files were in $HOME.  Now that we can have multiple</span>
<a href="#l6.966"></a><span id="l6.966" class="difflineminus">-   * profiles in 5.x, with the same user, this won't fly.</span>
<a href="#l6.967"></a><span id="l6.967" class="difflineminus">-   * when they migrate, we need to copy from $HOME/.newsrc-&lt;host&gt; to</span>
<a href="#l6.968"></a><span id="l6.968" class="difflineminus">-   * ~/.mozilla/&lt;profile&gt;/News/newsrc-&lt;host&gt;</span>
<a href="#l6.969"></a><span id="l6.969" class="difflineminus">-   */</span>
<a href="#l6.970"></a><span id="l6.970" class="difflineminus">-  rv = CopyAndRenameNewsrcFiles(newNewsPath);</span>
<a href="#l6.971"></a><span id="l6.971" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.972"></a><span id="l6.972" class="difflineminus">-#endif /* NEED_TO_COPY_AND_RENAME_NEWSRC_FILES */</span>
<a href="#l6.973"></a><span id="l6.973" class="difflineminus">-</span>
<a href="#l6.974"></a><span id="l6.974" class="difflineminus">-  if (serverType == IMAP_4X_MAIL_TYPE) {</span>
<a href="#l6.975"></a><span id="l6.975" class="difflineminus">-    if( copyMailFileInMigration )  // copy mail files in migration</span>
<a href="#l6.976"></a><span id="l6.976" class="difflineminus">-    {</span>
<a href="#l6.977"></a><span id="l6.977" class="difflineminus">-    rv = DoTheCopyAndRename(oldIMAPMailPath, newIMAPMailPath, PR_TRUE, needToRenameFilterFiles, IMAP_MAIL_FILTER_FILE_NAME_IN_4x, IMAP_MAIL_FILTER_FILE_NAME_IN_5x);</span>
<a href="#l6.978"></a><span id="l6.978" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.979"></a><span id="l6.979" class="difflineminus">-    rv = DoTheCopyAndRename(oldIMAPLocalMailPath, newIMAPLocalMailPath, PR_TRUE, needToRenameFilterFiles,IMAP_MAIL_FILTER_FILE_NAME_IN_4x,IMAP_MAIL_FILTER_FILE_NAME_IN_5x);</span>
<a href="#l6.980"></a><span id="l6.980" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.981"></a><span id="l6.981" class="difflineminus">-    }</span>
<a href="#l6.982"></a><span id="l6.982" class="difflineminus">-    else  // Copy &amp; Rename filter files</span>
<a href="#l6.983"></a><span id="l6.983" class="difflineminus">-    {</span>
<a href="#l6.984"></a><span id="l6.984" class="difflineminus">-      // IMAP path</span>
<a href="#l6.985"></a><span id="l6.985" class="difflineminus">-      // don't care if this fails</span>
<a href="#l6.986"></a><span id="l6.986" class="difflineminus">-      (void)DoTheCopyAndRename(oldIMAPMailPath, PR_TRUE, IMAP_MAIL_FILTER_FILE_NAME_IN_4x, IMAP_MAIL_FILTER_FILE_NAME_IN_5x);</span>
<a href="#l6.987"></a><span id="l6.987" class="difflineminus">-</span>
<a href="#l6.988"></a><span id="l6.988" class="difflineminus">-      // Local Folders path</span>
<a href="#l6.989"></a><span id="l6.989" class="difflineminus">-      // don't care if this fails</span>
<a href="#l6.990"></a><span id="l6.990" class="difflineminus">-      (void)DoTheCopyAndRename(oldIMAPLocalMailPath, PR_TRUE, IMAP_MAIL_FILTER_FILE_NAME_IN_4x, IMAP_MAIL_FILTER_FILE_NAME_IN_5x);</span>
<a href="#l6.991"></a><span id="l6.991" class="difflineminus">-    }</span>
<a href="#l6.992"></a><span id="l6.992" class="difflineminus">-  }</span>
<a href="#l6.993"></a><span id="l6.993" class="difflineminus">-  else if (serverType == POP_4X_MAIL_TYPE) {</span>
<a href="#l6.994"></a><span id="l6.994" class="difflineminus">-    // fix for bug #202010</span>
<a href="#l6.995"></a><span id="l6.995" class="difflineminus">-    // copy over the pop filter and popstate files now</span>
<a href="#l6.996"></a><span id="l6.996" class="difflineminus">-    // and later, in DoSpecialUpdates()</span>
<a href="#l6.997"></a><span id="l6.997" class="difflineminus">-    // we'll move and rename them</span>
<a href="#l6.998"></a><span id="l6.998" class="difflineminus">-#ifdef POP_MAIL_FILTER_FILE_NAME_IN_4x</span>
<a href="#l6.999"></a><span id="l6.999" class="difflineminus">-    rv = DoTheCopy(oldProfilePath, newProfilePath, POP_MAIL_FILTER_FILE_NAME_IN_4x);</span>
<a href="#l6.1000"></a><span id="l6.1000" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.1001"></a><span id="l6.1001" class="difflineminus">-#endif</span>
<a href="#l6.1002"></a><span id="l6.1002" class="difflineminus">-</span>
<a href="#l6.1003"></a><span id="l6.1003" class="difflineminus">-#ifdef POPSTATE_FILE_IN_4x</span>
<a href="#l6.1004"></a><span id="l6.1004" class="difflineminus">-    rv = DoTheCopy(oldProfilePath, newProfilePath, POPSTATE_FILE_IN_4x);</span>
<a href="#l6.1005"></a><span id="l6.1005" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.1006"></a><span id="l6.1006" class="difflineminus">-#endif</span>
<a href="#l6.1007"></a><span id="l6.1007" class="difflineminus">-</span>
<a href="#l6.1008"></a><span id="l6.1008" class="difflineminus">-    rv = DoTheCopy(oldPOPMailPath, newPOPMailPath, PR_TRUE);</span>
<a href="#l6.1009"></a><span id="l6.1009" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.1010"></a><span id="l6.1010" class="difflineminus">-  }</span>
<a href="#l6.1011"></a><span id="l6.1011" class="difflineminus">-#ifdef HAVE_MOVEMAIL</span>
<a href="#l6.1012"></a><span id="l6.1012" class="difflineminus">-  else if (serverType == MOVEMAIL_4X_MAIL_TYPE) {</span>
<a href="#l6.1013"></a><span id="l6.1013" class="difflineminus">-    // in 4.x, the movemail filter name was the same as the pop filter name</span>
<a href="#l6.1014"></a><span id="l6.1014" class="difflineminus">-    // copy over the filter file now</span>
<a href="#l6.1015"></a><span id="l6.1015" class="difflineminus">-    // and later, in DoSpecialUpdates()</span>
<a href="#l6.1016"></a><span id="l6.1016" class="difflineminus">-    // we'll move and rename them</span>
<a href="#l6.1017"></a><span id="l6.1017" class="difflineminus">-    rv = DoTheCopy(oldProfilePath, newProfilePath, POP_MAIL_FILTER_FILE_NAME_IN_4x);</span>
<a href="#l6.1018"></a><span id="l6.1018" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.1019"></a><span id="l6.1019" class="difflineminus">-</span>
<a href="#l6.1020"></a><span id="l6.1020" class="difflineminus">-    rv = DoTheCopy(oldMOVEMAILMailPath, newMOVEMAILMailPath, PR_TRUE);</span>
<a href="#l6.1021"></a><span id="l6.1021" class="difflineminus">-  }</span>
<a href="#l6.1022"></a><span id="l6.1022" class="difflineminus">-#endif /* HAVE_MOVEMAIL */</span>
<a href="#l6.1023"></a><span id="l6.1023" class="difflineminus">-  else {</span>
<a href="#l6.1024"></a><span id="l6.1024" class="difflineminus">-    NS_ERROR(&quot;unknown mail server type!&quot;);</span>
<a href="#l6.1025"></a><span id="l6.1025" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l6.1026"></a><span id="l6.1026" class="difflineminus">-  }</span>
<a href="#l6.1027"></a><span id="l6.1027" class="difflineminus">-</span>
<a href="#l6.1028"></a><span id="l6.1028" class="difflineminus">-  // Don't inherit the 4.x cache file location for mozilla!</span>
<a href="#l6.1029"></a><span id="l6.1029" class="difflineminus">-  // The cache pref later gets set with a default in nsAppRunner::InitCachePrefs().</span>
<a href="#l6.1030"></a><span id="l6.1030" class="difflineminus">-  mPrefs-&gt;ClearUserPref(PREF_BROWSER_CACHE_DIRECTORY);</span>
<a href="#l6.1031"></a><span id="l6.1031" class="difflineminus">-</span>
<a href="#l6.1032"></a><span id="l6.1032" class="difflineminus">-  rv = DoSpecialUpdates(newProfilePath);</span>
<a href="#l6.1033"></a><span id="l6.1033" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.1034"></a><span id="l6.1034" class="difflineminus">-    PR_FREEIF(popServerName);</span>
<a href="#l6.1035"></a><span id="l6.1035" class="difflineminus">-</span>
<a href="#l6.1036"></a><span id="l6.1036" class="difflineminus">-  nsCString path;</span>
<a href="#l6.1037"></a><span id="l6.1037" class="difflineminus">-</span>
<a href="#l6.1038"></a><span id="l6.1038" class="difflineminus">-  newProfilePath-&gt;GetNativePath(path);</span>
<a href="#l6.1039"></a><span id="l6.1039" class="difflineminus">-  NS_NewNativeLocalFile(path, PR_TRUE, getter_AddRefs(newPrefsFile));</span>
<a href="#l6.1040"></a><span id="l6.1040" class="difflineminus">-</span>
<a href="#l6.1041"></a><span id="l6.1041" class="difflineminus">-  rv = newPrefsFile-&gt;AppendNative(NS_LITERAL_CSTRING(PREF_FILE_NAME_IN_5x));</span>
<a href="#l6.1042"></a><span id="l6.1042" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.1043"></a><span id="l6.1043" class="difflineminus">-</span>
<a href="#l6.1044"></a><span id="l6.1044" class="difflineminus">-  rv = prefService-&gt;SavePrefFile(newPrefsFile);</span>
<a href="#l6.1045"></a><span id="l6.1045" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.1046"></a><span id="l6.1046" class="difflineminus">-  rv = prefService-&gt;ResetPrefs();</span>
<a href="#l6.1047"></a><span id="l6.1047" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.1048"></a><span id="l6.1048" class="difflineminus">-</span>
<a href="#l6.1049"></a><span id="l6.1049" class="difflineminus">-  PRBool flagExists = PR_FALSE;</span>
<a href="#l6.1050"></a><span id="l6.1050" class="difflineminus">-  m_prefsFile-&gt;Exists(&amp;flagExists); //Delete the prefs.js file in the temp directory.</span>
<a href="#l6.1051"></a><span id="l6.1051" class="difflineminus">-  if (flagExists)</span>
<a href="#l6.1052"></a><span id="l6.1052" class="difflineminus">-    m_prefsFile-&gt;Remove(PR_FALSE);</span>
<a href="#l6.1053"></a><span id="l6.1053" class="difflineminus">-</span>
<a href="#l6.1054"></a><span id="l6.1054" class="difflineminus">-  systemTempDir-&gt;Exists(&amp;flagExists); //Delete the unique dir in the system temp dir.</span>
<a href="#l6.1055"></a><span id="l6.1055" class="difflineminus">-  if (flagExists)</span>
<a href="#l6.1056"></a><span id="l6.1056" class="difflineminus">-    systemTempDir-&gt;Remove(PR_FALSE);</span>
<a href="#l6.1057"></a><span id="l6.1057" class="difflineminus">-</span>
<a href="#l6.1058"></a><span id="l6.1058" class="difflineminus">-  return rv;</span>
<a href="#l6.1059"></a><span id="l6.1059" class="difflineminus">-}</span>
<a href="#l6.1060"></a><span id="l6.1060" class="difflineminus">-</span>
<a href="#l6.1061"></a><span id="l6.1061" class="difflineminus">-nsresult nsDogbertProfileMigrator::CreateNewUser5Tree(nsILocalFile * oldProfilePath, nsILocalFile * newProfilePath)</span>
<a href="#l6.1062"></a><span id="l6.1062" class="difflineminus">-{</span>
<a href="#l6.1063"></a><span id="l6.1063" class="difflineminus">-  nsresult rv;</span>
<a href="#l6.1064"></a><span id="l6.1064" class="difflineminus">-  PRBool exists;</span>
<a href="#l6.1065"></a><span id="l6.1065" class="difflineminus">-</span>
<a href="#l6.1066"></a><span id="l6.1066" class="difflineminus">-  NS_ASSERTION(*PREF_FILE_NAME_IN_4x, &quot;don't know how to migrate your platform&quot;);</span>
<a href="#l6.1067"></a><span id="l6.1067" class="difflineminus">-  if (!*PREF_FILE_NAME_IN_4x) {</span>
<a href="#l6.1068"></a><span id="l6.1068" class="difflineminus">-    return NS_ERROR_UNEXPECTED;</span>
<a href="#l6.1069"></a><span id="l6.1069" class="difflineminus">-  }</span>
<a href="#l6.1070"></a><span id="l6.1070" class="difflineminus">-</span>
<a href="#l6.1071"></a><span id="l6.1071" class="difflineminus">-  /* Copy the old prefs file to the new profile directory for modification and reading.</span>
<a href="#l6.1072"></a><span id="l6.1072" class="difflineminus">-     after copying it, rename it to pref.js, the 5.x pref file name on all platforms */</span>
<a href="#l6.1073"></a><span id="l6.1073" class="difflineminus">-  nsCOMPtr&lt;nsILocalFile&gt; oldPrefsFile = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l6.1074"></a><span id="l6.1074" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.1075"></a><span id="l6.1075" class="difflineminus">-</span>
<a href="#l6.1076"></a><span id="l6.1076" class="difflineminus">-  rv = oldPrefsFile-&gt;InitWithFile(oldProfilePath);</span>
<a href="#l6.1077"></a><span id="l6.1077" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.1078"></a><span id="l6.1078" class="difflineminus">-</span>
<a href="#l6.1079"></a><span id="l6.1079" class="difflineminus">-  rv = oldPrefsFile-&gt;AppendNative(NS_LITERAL_CSTRING(PREF_FILE_NAME_IN_4x));</span>
<a href="#l6.1080"></a><span id="l6.1080" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.1081"></a><span id="l6.1081" class="difflineminus">-</span>
<a href="#l6.1082"></a><span id="l6.1082" class="difflineminus">-  /* the new prefs file */</span>
<a href="#l6.1083"></a><span id="l6.1083" class="difflineminus">-  nsCOMPtr&lt;nsILocalFile&gt; newPrefsFile  = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l6.1084"></a><span id="l6.1084" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.1085"></a><span id="l6.1085" class="difflineminus">-</span>
<a href="#l6.1086"></a><span id="l6.1086" class="difflineminus">-  rv = newPrefsFile-&gt;InitWithFile(newProfilePath);</span>
<a href="#l6.1087"></a><span id="l6.1087" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.1088"></a><span id="l6.1088" class="difflineminus">-</span>
<a href="#l6.1089"></a><span id="l6.1089" class="difflineminus">-  rv = newPrefsFile-&gt;Exists(&amp;exists);</span>
<a href="#l6.1090"></a><span id="l6.1090" class="difflineminus">-  if (!exists)</span>
<a href="#l6.1091"></a><span id="l6.1091" class="difflineminus">-    rv = newPrefsFile-&gt;Create(nsIFile::DIRECTORY_TYPE, 0700);</span>
<a href="#l6.1092"></a><span id="l6.1092" class="difflineminus">-</span>
<a href="#l6.1093"></a><span id="l6.1093" class="difflineminus">-  rv = oldPrefsFile-&gt;CopyTo(newPrefsFile, EmptyString());</span>
<a href="#l6.1094"></a><span id="l6.1094" class="difflineminus">-  NS_ASSERTION(NS_SUCCEEDED(rv),&quot;failed to copy prefs file&quot;);</span>
<a href="#l6.1095"></a><span id="l6.1095" class="difflineminus">-</span>
<a href="#l6.1096"></a><span id="l6.1096" class="difflineminus">-  rv = newPrefsFile-&gt;AppendNative(NS_LITERAL_CSTRING(PREF_FILE_NAME_IN_4x));</span>
<a href="#l6.1097"></a><span id="l6.1097" class="difflineminus">-  rv = newPrefsFile-&gt;MoveTo(nsnull, NS_LITERAL_STRING(PREF_FILE_NAME_IN_5x));</span>
<a href="#l6.1098"></a><span id="l6.1098" class="difflineminus">-</span>
<a href="#l6.1099"></a><span id="l6.1099" class="difflineminus">-  return NS_OK;</span>
<a href="#l6.1100"></a><span id="l6.1100" class="difflineminus">-}</span>
<a href="#l6.1101"></a><span id="l6.1101" class="difflineminus">-</span>
<a href="#l6.1102"></a><span id="l6.1102" class="difflineminus">-#ifdef NEED_TO_COPY_AND_RENAME_NEWSRC_FILES</span>
<a href="#l6.1103"></a><span id="l6.1103" class="difflineminus">-nsresult nsDogbertProfileMigrator::CopyAndRenameNewsrcFiles(nsILocalFile * newPathFile)</span>
<a href="#l6.1104"></a><span id="l6.1104" class="difflineminus">-{</span>
<a href="#l6.1105"></a><span id="l6.1105" class="difflineminus">-  nsresult rv;</span>
<a href="#l6.1106"></a><span id="l6.1106" class="difflineminus">-  nsCOMPtr &lt;nsILocalFile&gt; oldPathFile;</span>
<a href="#l6.1107"></a><span id="l6.1107" class="difflineminus">-  nsCAutoString fileOrDirNameStr;</span>
<a href="#l6.1108"></a><span id="l6.1108" class="difflineminus">-</span>
<a href="#l6.1109"></a><span id="l6.1109" class="difflineminus">-  rv = GetPremigratedFilePref(PREF_NEWS_DIRECTORY, getter_AddRefs(oldPathFile));</span>
<a href="#l6.1110"></a><span id="l6.1110" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.1111"></a><span id="l6.1111" class="difflineminus">-</span>
<a href="#l6.1112"></a><span id="l6.1112" class="difflineminus">-  nsCOMPtr&lt;nsISimpleEnumerator&gt; directoryEnumerator;</span>
<a href="#l6.1113"></a><span id="l6.1113" class="difflineminus">-  rv = oldPathFile-&gt;GetDirectoryEntries(getter_AddRefs(directoryEnumerator));</span>
<a href="#l6.1114"></a><span id="l6.1114" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.1115"></a><span id="l6.1115" class="difflineminus">-</span>
<a href="#l6.1116"></a><span id="l6.1116" class="difflineminus">-  PRBool hasMore;</span>
<a href="#l6.1117"></a><span id="l6.1117" class="difflineminus">-  directoryEnumerator-&gt;HasMoreElements(&amp;hasMore);</span>
<a href="#l6.1118"></a><span id="l6.1118" class="difflineminus">-  while (hasMore &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l6.1119"></a><span id="l6.1119" class="difflineminus">-  {</span>
<a href="#l6.1120"></a><span id="l6.1120" class="difflineminus">-    nsCOMPtr&lt;nsISupports&gt; aSupport;</span>
<a href="#l6.1121"></a><span id="l6.1121" class="difflineminus">-    rv = directoryEnumerator-&gt;GetNext(getter_AddRefs(aSupport));</span>
<a href="#l6.1122"></a><span id="l6.1122" class="difflineminus">-    nsCOMPtr&lt;nsIFile&gt; currentFile(do_QueryInterface(aSupport, &amp;rv));</span>
<a href="#l6.1123"></a><span id="l6.1123" class="difflineminus">-    nsCOMPtr&lt;nsILocalFile&gt; curLocalFile = do_QueryInterface(currentFile);</span>
<a href="#l6.1124"></a><span id="l6.1124" class="difflineminus">-</span>
<a href="#l6.1125"></a><span id="l6.1125" class="difflineminus">-    currentFile-&gt;GetNativeLeafName(fileOrDirNameStr);</span>
<a href="#l6.1126"></a><span id="l6.1126" class="difflineminus">-</span>
<a href="#l6.1127"></a><span id="l6.1127" class="difflineminus">-    if (nsCStringStartsWith(fileOrDirNameStr, NEWSRC_PREFIX_IN_4x) || nsCStringStartsWith(fileOrDirNameStr, SNEWSRC_PREFIX_IN_4x)) {</span>
<a href="#l6.1128"></a><span id="l6.1128" class="difflineminus">-        rv = currentFile-&gt;CopyTo(newPathFile, EmptyString());</span>
<a href="#l6.1129"></a><span id="l6.1129" class="difflineminus">-        NS_ASSERTION(NS_SUCCEEDED(rv),&quot;failed to copy news file&quot;);</span>
<a href="#l6.1130"></a><span id="l6.1130" class="difflineminus">-</span>
<a href="#l6.1131"></a><span id="l6.1131" class="difflineminus">-        nsCOMPtr &lt;nsIFile&gt; newFile;</span>
<a href="#l6.1132"></a><span id="l6.1132" class="difflineminus">-        newPathFile-&gt;Clone(getter_AddRefs(newFile));</span>
<a href="#l6.1133"></a><span id="l6.1133" class="difflineminus">-        if (newFile)</span>
<a href="#l6.1134"></a><span id="l6.1134" class="difflineminus">-        {</span>
<a href="#l6.1135"></a><span id="l6.1135" class="difflineminus">-          newFile-&gt;AppendNative(fileOrDirNameStr);</span>
<a href="#l6.1136"></a><span id="l6.1136" class="difflineminus">-          fileOrDirNameStr.Cut(0, 1);</span>
<a href="#l6.1137"></a><span id="l6.1137" class="difflineminus">-          newFile-&gt;MoveToNative(nsnull, fileOrDirNameStr); /* rename .newsrc-news to newsrc-news, no need to keep it hidden anymore */</span>
<a href="#l6.1138"></a><span id="l6.1138" class="difflineminus">-</span>
<a href="#l6.1139"></a><span id="l6.1139" class="difflineminus">-        }</span>
<a href="#l6.1140"></a><span id="l6.1140" class="difflineminus">-    }</span>
<a href="#l6.1141"></a><span id="l6.1141" class="difflineminus">-  }</span>
<a href="#l6.1142"></a><span id="l6.1142" class="difflineminus">-</span>
<a href="#l6.1143"></a><span id="l6.1143" class="difflineminus">-  return NS_OK;</span>
<a href="#l6.1144"></a><span id="l6.1144" class="difflineminus">-}</span>
<a href="#l6.1145"></a><span id="l6.1145" class="difflineminus">-#endif /* NEED_TO_COPY_AND_RENAME_NEWSRC_FILES */</span>
<a href="#l6.1146"></a><span id="l6.1146" class="difflineminus">-</span>
<a href="#l6.1147"></a><span id="l6.1147" class="difflineminus">-</span>
<a href="#l6.1148"></a><span id="l6.1148" class="difflineminus">-/*-------------------------------------------------------------------------</span>
<a href="#l6.1149"></a><span id="l6.1149" class="difflineminus">- * DoTheCopyAndRename copies the files listed in oldPath to newPath</span>
<a href="#l6.1150"></a><span id="l6.1150" class="difflineminus">- *                    and renames files, if necessary</span>
<a href="#l6.1151"></a><span id="l6.1151" class="difflineminus">- *</span>
<a href="#l6.1152"></a><span id="l6.1152" class="difflineminus">- * INPUT: oldPath - The old profile path plus the specific data type</span>
<a href="#l6.1153"></a><span id="l6.1153" class="difflineminus">- *                  (e.g. mail or news)</span>
<a href="#l6.1154"></a><span id="l6.1154" class="difflineminus">- *        newPath - The new profile path plus the specific data type</span>
<a href="#l6.1155"></a><span id="l6.1155" class="difflineminus">- *</span>
<a href="#l6.1156"></a><span id="l6.1156" class="difflineminus">- *        readSubdirs</span>
<a href="#l6.1157"></a><span id="l6.1157" class="difflineminus">- *</span>
<a href="#l6.1158"></a><span id="l6.1158" class="difflineminus">- *        needToRenameFiles - do we need to search for files named oldFile</span>
<a href="#l6.1159"></a><span id="l6.1159" class="difflineminus">- *                            and rename them to newFile</span>
<a href="#l6.1160"></a><span id="l6.1160" class="difflineminus">- *</span>
<a href="#l6.1161"></a><span id="l6.1161" class="difflineminus">- *        oldFile           - old file name (used for renaming)</span>
<a href="#l6.1162"></a><span id="l6.1162" class="difflineminus">- *</span>
<a href="#l6.1163"></a><span id="l6.1163" class="difflineminus">- *        newFile           - new file name (used for renaming)</span>
<a href="#l6.1164"></a><span id="l6.1164" class="difflineminus">- *</span>
<a href="#l6.1165"></a><span id="l6.1165" class="difflineminus">- * RETURNS: NS_OK if successful</span>
<a href="#l6.1166"></a><span id="l6.1166" class="difflineminus">- *          NS_ERROR_FAILURE if failed</span>
<a href="#l6.1167"></a><span id="l6.1167" class="difflineminus">- *</span>
<a href="#l6.1168"></a><span id="l6.1168" class="difflineminus">- *--------------------------------------------------------------------------*/</span>
<a href="#l6.1169"></a><span id="l6.1169" class="difflineminus">-nsresult nsDogbertProfileMigrator::DoTheCopyAndRename(nsIFile * oldPathFile, nsIFile *newPathFile, PRBool readSubdirs, PRBool needToRenameFiles, const char *oldName, const char *newName)</span>
<a href="#l6.1170"></a><span id="l6.1170" class="difflineminus">-{</span>
<a href="#l6.1171"></a><span id="l6.1171" class="difflineminus">-  nsresult rv;</span>
<a href="#l6.1172"></a><span id="l6.1172" class="difflineminus">-  nsCAutoString fileOrDirNameStr;</span>
<a href="#l6.1173"></a><span id="l6.1173" class="difflineminus">-</span>
<a href="#l6.1174"></a><span id="l6.1174" class="difflineminus">-  nsCOMPtr&lt;nsISimpleEnumerator&gt; directoryEnumerator;</span>
<a href="#l6.1175"></a><span id="l6.1175" class="difflineminus">-  rv = oldPathFile-&gt;GetDirectoryEntries(getter_AddRefs(directoryEnumerator));</span>
<a href="#l6.1176"></a><span id="l6.1176" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.1177"></a><span id="l6.1177" class="difflineminus">-</span>
<a href="#l6.1178"></a><span id="l6.1178" class="difflineminus">-  PRBool hasMore;</span>
<a href="#l6.1179"></a><span id="l6.1179" class="difflineminus">-  directoryEnumerator-&gt;HasMoreElements(&amp;hasMore);</span>
<a href="#l6.1180"></a><span id="l6.1180" class="difflineminus">-  while (hasMore &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l6.1181"></a><span id="l6.1181" class="difflineminus">-  {</span>
<a href="#l6.1182"></a><span id="l6.1182" class="difflineminus">-    nsCOMPtr&lt;nsISupports&gt; aSupport;</span>
<a href="#l6.1183"></a><span id="l6.1183" class="difflineminus">-    rv = directoryEnumerator-&gt;GetNext(getter_AddRefs(aSupport));</span>
<a href="#l6.1184"></a><span id="l6.1184" class="difflineminus">-    nsCOMPtr&lt;nsIFile&gt; currentFile(do_QueryInterface(aSupport, &amp;rv));</span>
<a href="#l6.1185"></a><span id="l6.1185" class="difflineminus">-    nsCOMPtr&lt;nsILocalFile&gt; curLocalFile = do_QueryInterface(currentFile);</span>
<a href="#l6.1186"></a><span id="l6.1186" class="difflineminus">-</span>
<a href="#l6.1187"></a><span id="l6.1187" class="difflineminus">-    currentFile-&gt;GetNativeLeafName(fileOrDirNameStr);</span>
<a href="#l6.1188"></a><span id="l6.1188" class="difflineminus">-</span>
<a href="#l6.1189"></a><span id="l6.1189" class="difflineminus">-    if (nsCStringEndsWith(fileOrDirNameStr, MAIL_SUMMARY_SUFFIX_IN_4x) || nsCStringEndsWith(fileOrDirNameStr, NEWS_SUMMARY_SUFFIX_IN_4x) ||</span>
<a href="#l6.1190"></a><span id="l6.1190" class="difflineminus">-          nsCStringEndsWith(fileOrDirNameStr, SUMMARY_SUFFIX_IN_5x)) /* Don't copy the summary files */</span>
<a href="#l6.1191"></a><span id="l6.1191" class="difflineminus">-      continue;</span>
<a href="#l6.1192"></a><span id="l6.1192" class="difflineminus">-    else</span>
<a href="#l6.1193"></a><span id="l6.1193" class="difflineminus">-    {</span>
<a href="#l6.1194"></a><span id="l6.1194" class="difflineminus">-      PRBool isDirectory = PR_FALSE;</span>
<a href="#l6.1195"></a><span id="l6.1195" class="difflineminus">-      currentFile-&gt;IsDirectory(&amp;isDirectory);</span>
<a href="#l6.1196"></a><span id="l6.1196" class="difflineminus">-      if (isDirectory)</span>
<a href="#l6.1197"></a><span id="l6.1197" class="difflineminus">-      {</span>
<a href="#l6.1198"></a><span id="l6.1198" class="difflineminus">-        if(readSubdirs)</span>
<a href="#l6.1199"></a><span id="l6.1199" class="difflineminus">-        {</span>
<a href="#l6.1200"></a><span id="l6.1200" class="difflineminus">-          nsCOMPtr&lt;nsIFile&gt; newPathExtended;</span>
<a href="#l6.1201"></a><span id="l6.1201" class="difflineminus">-          rv = newPathFile-&gt;Clone(getter_AddRefs(newPathExtended));</span>
<a href="#l6.1202"></a><span id="l6.1202" class="difflineminus">-          NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.1203"></a><span id="l6.1203" class="difflineminus">-          rv = newPathExtended-&gt;AppendNative(fileOrDirNameStr);</span>
<a href="#l6.1204"></a><span id="l6.1204" class="difflineminus">-          rv = newPathExtended-&gt;Create(nsIFile::DIRECTORY_TYPE, 0700);</span>
<a href="#l6.1205"></a><span id="l6.1205" class="difflineminus">-</span>
<a href="#l6.1206"></a><span id="l6.1206" class="difflineminus">-          DoTheCopyAndRename(curLocalFile, newPathExtended, PR_TRUE, needToRenameFiles, oldName, newName); /* re-enter the DoTheCopyAndRename function */</span>
<a href="#l6.1207"></a><span id="l6.1207" class="difflineminus">-        }</span>
<a href="#l6.1208"></a><span id="l6.1208" class="difflineminus">-        else</span>
<a href="#l6.1209"></a><span id="l6.1209" class="difflineminus">-          continue;</span>
<a href="#l6.1210"></a><span id="l6.1210" class="difflineminus">-      }</span>
<a href="#l6.1211"></a><span id="l6.1211" class="difflineminus">-      else {</span>
<a href="#l6.1212"></a><span id="l6.1212" class="difflineminus">-        // copy the file</span>
<a href="#l6.1213"></a><span id="l6.1213" class="difflineminus">-        if (fileOrDirNameStr.Equals(oldName))</span>
<a href="#l6.1214"></a><span id="l6.1214" class="difflineminus">-          AddFileCopyToList(curLocalFile, newPathFile, newName);</span>
<a href="#l6.1215"></a><span id="l6.1215" class="difflineminus">-        else</span>
<a href="#l6.1216"></a><span id="l6.1216" class="difflineminus">-          AddFileCopyToList(curLocalFile, newPathFile, &quot;&quot;);</span>
<a href="#l6.1217"></a><span id="l6.1217" class="difflineminus">-      }</span>
<a href="#l6.1218"></a><span id="l6.1218" class="difflineminus">-    }</span>
<a href="#l6.1219"></a><span id="l6.1219" class="difflineminus">-  }</span>
<a href="#l6.1220"></a><span id="l6.1220" class="difflineminus">-</span>
<a href="#l6.1221"></a><span id="l6.1221" class="difflineminus">-  return NS_OK;</span>
<a href="#l6.1222"></a><span id="l6.1222" class="difflineminus">-}</span>
<a href="#l6.1223"></a><span id="l6.1223" class="difflineminus">-</span>
<a href="#l6.1224"></a><span id="l6.1224" class="difflineminus">-/*-------------------------------------------------------------------------</span>
<a href="#l6.1225"></a><span id="l6.1225" class="difflineminus">- * DoTheCopyAndRename copies and renames files</span>
<a href="#l6.1226"></a><span id="l6.1226" class="difflineminus">- *</span>
<a href="#l6.1227"></a><span id="l6.1227" class="difflineminus">- * INPUT: aPath - the path</span>
<a href="#l6.1228"></a><span id="l6.1228" class="difflineminus">- *</span>
<a href="#l6.1229"></a><span id="l6.1229" class="difflineminus">- *        aReadSubdirs - if sub directories should be handled</span>
<a href="#l6.1230"></a><span id="l6.1230" class="difflineminus">- *</span>
<a href="#l6.1231"></a><span id="l6.1231" class="difflineminus">- *        aOldFile - old file name (used for renaming)</span>
<a href="#l6.1232"></a><span id="l6.1232" class="difflineminus">- *</span>
<a href="#l6.1233"></a><span id="l6.1233" class="difflineminus">- *        aNewFile - new file name (used for renaming)</span>
<a href="#l6.1234"></a><span id="l6.1234" class="difflineminus">- *</span>
<a href="#l6.1235"></a><span id="l6.1235" class="difflineminus">- * RETURNS: NS_OK if successful</span>
<a href="#l6.1236"></a><span id="l6.1236" class="difflineminus">- *          NS_ERROR_FAILURE if failed</span>
<a href="#l6.1237"></a><span id="l6.1237" class="difflineminus">- *</span>
<a href="#l6.1238"></a><span id="l6.1238" class="difflineminus">- *--------------------------------------------------------------------------*/</span>
<a href="#l6.1239"></a><span id="l6.1239" class="difflineminus">-nsresult nsDogbertProfileMigrator::DoTheCopyAndRename(nsIFile * aPathFile, PRBool aReadSubdirs, const char *aOldName, const char *aNewName)</span>
<a href="#l6.1240"></a><span id="l6.1240" class="difflineminus">-{</span>
<a href="#l6.1241"></a><span id="l6.1241" class="difflineminus">-  if( !aOldName || !aNewName || !strcmp(aOldName, aNewName) )</span>
<a href="#l6.1242"></a><span id="l6.1242" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l6.1243"></a><span id="l6.1243" class="difflineminus">-</span>
<a href="#l6.1244"></a><span id="l6.1244" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; file;</span>
<a href="#l6.1245"></a><span id="l6.1245" class="difflineminus">-  nsresult rv = aPathFile-&gt;Clone(getter_AddRefs(file));</span>
<a href="#l6.1246"></a><span id="l6.1246" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.1247"></a><span id="l6.1247" class="difflineminus">-  file-&gt;AppendNative(nsDependentCString(aOldName));</span>
<a href="#l6.1248"></a><span id="l6.1248" class="difflineminus">-</span>
<a href="#l6.1249"></a><span id="l6.1249" class="difflineminus">-  nsCOMPtr&lt;nsISimpleEnumerator&gt; directoryEnumerator;</span>
<a href="#l6.1250"></a><span id="l6.1250" class="difflineminus">-  rv = aPathFile-&gt;GetDirectoryEntries(getter_AddRefs(directoryEnumerator));</span>
<a href="#l6.1251"></a><span id="l6.1251" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.1252"></a><span id="l6.1252" class="difflineminus">-</span>
<a href="#l6.1253"></a><span id="l6.1253" class="difflineminus">-  PRBool hasMore;</span>
<a href="#l6.1254"></a><span id="l6.1254" class="difflineminus">-  directoryEnumerator-&gt;HasMoreElements(&amp;hasMore);</span>
<a href="#l6.1255"></a><span id="l6.1255" class="difflineminus">-  while (hasMore &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l6.1256"></a><span id="l6.1256" class="difflineminus">-  {</span>
<a href="#l6.1257"></a><span id="l6.1257" class="difflineminus">-    nsCOMPtr&lt;nsISupports&gt; aSupport;</span>
<a href="#l6.1258"></a><span id="l6.1258" class="difflineminus">-    rv = directoryEnumerator-&gt;GetNext(getter_AddRefs(aSupport));</span>
<a href="#l6.1259"></a><span id="l6.1259" class="difflineminus">-    nsCOMPtr&lt;nsILocalFile&gt; currentFile(do_QueryInterface(aSupport, &amp;rv));</span>
<a href="#l6.1260"></a><span id="l6.1260" class="difflineminus">-    // Handle sub folders</span>
<a href="#l6.1261"></a><span id="l6.1261" class="difflineminus">-    PRBool isDirectory = PR_FALSE;</span>
<a href="#l6.1262"></a><span id="l6.1262" class="difflineminus">-    currentFile-&gt;IsDirectory(&amp;isDirectory);</span>
<a href="#l6.1263"></a><span id="l6.1263" class="difflineminus">-    if (isDirectory)</span>
<a href="#l6.1264"></a><span id="l6.1264" class="difflineminus">-    {</span>
<a href="#l6.1265"></a><span id="l6.1265" class="difflineminus">-      if( aReadSubdirs )</span>
<a href="#l6.1266"></a><span id="l6.1266" class="difflineminus">-      {</span>
<a href="#l6.1267"></a><span id="l6.1267" class="difflineminus">-        nsCOMPtr&lt;nsIFile&gt;fileOrDirName;</span>
<a href="#l6.1268"></a><span id="l6.1268" class="difflineminus">-        currentFile-&gt;Clone(getter_AddRefs(fileOrDirName));</span>
<a href="#l6.1269"></a><span id="l6.1269" class="difflineminus">-        DoTheCopyAndRename(fileOrDirName, aReadSubdirs, aOldName, aNewName); /* re-enter the DoTheCopyAndRename function */</span>
<a href="#l6.1270"></a><span id="l6.1270" class="difflineminus">-      }</span>
<a href="#l6.1271"></a><span id="l6.1271" class="difflineminus">-      else</span>
<a href="#l6.1272"></a><span id="l6.1272" class="difflineminus">-        continue;</span>
<a href="#l6.1273"></a><span id="l6.1273" class="difflineminus">-    }</span>
<a href="#l6.1274"></a><span id="l6.1274" class="difflineminus">-  }</span>
<a href="#l6.1275"></a><span id="l6.1275" class="difflineminus">-</span>
<a href="#l6.1276"></a><span id="l6.1276" class="difflineminus">-  nsAutoString newName = NS_ConvertUTF8toUTF16(aNewName);</span>
<a href="#l6.1277"></a><span id="l6.1277" class="difflineminus">-  file-&gt;CopyTo(aPathFile, newName);</span>
<a href="#l6.1278"></a><span id="l6.1278" class="difflineminus">-</span>
<a href="#l6.1279"></a><span id="l6.1279" class="difflineminus">-  return NS_OK;</span>
<a href="#l6.1280"></a><span id="l6.1280" class="difflineminus">-}</span>
<a href="#l6.1281"></a><span id="l6.1281" class="difflineminus">-</span>
<a href="#l6.1282"></a><span id="l6.1282" class="difflineminus">-nsresult nsDogbertProfileMigrator::CopyFilesByPattern(nsILocalFile * oldPathFile, nsILocalFile * newPathFile, const char *pattern)</span>
<a href="#l6.1283"></a><span id="l6.1283" class="difflineminus">-{</span>
<a href="#l6.1284"></a><span id="l6.1284" class="difflineminus">-  nsCOMPtr&lt;nsISimpleEnumerator&gt; directoryEnumerator;</span>
<a href="#l6.1285"></a><span id="l6.1285" class="difflineminus">-  nsresult rv = oldPathFile-&gt;GetDirectoryEntries(getter_AddRefs(directoryEnumerator));</span>
<a href="#l6.1286"></a><span id="l6.1286" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.1287"></a><span id="l6.1287" class="difflineminus">-</span>
<a href="#l6.1288"></a><span id="l6.1288" class="difflineminus">-  PRBool hasMore;</span>
<a href="#l6.1289"></a><span id="l6.1289" class="difflineminus">-  directoryEnumerator-&gt;HasMoreElements(&amp;hasMore);</span>
<a href="#l6.1290"></a><span id="l6.1290" class="difflineminus">-  while (hasMore &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l6.1291"></a><span id="l6.1291" class="difflineminus">-  {</span>
<a href="#l6.1292"></a><span id="l6.1292" class="difflineminus">-    nsCOMPtr&lt;nsISupports&gt; aSupport;</span>
<a href="#l6.1293"></a><span id="l6.1293" class="difflineminus">-    rv = directoryEnumerator-&gt;GetNext(getter_AddRefs(aSupport));</span>
<a href="#l6.1294"></a><span id="l6.1294" class="difflineminus">-    nsCOMPtr&lt;nsILocalFile&gt; currentFile(do_QueryInterface(aSupport, &amp;rv));</span>
<a href="#l6.1295"></a><span id="l6.1295" class="difflineminus">-</span>
<a href="#l6.1296"></a><span id="l6.1296" class="difflineminus">-    PRBool isDirectory = PR_FALSE;</span>
<a href="#l6.1297"></a><span id="l6.1297" class="difflineminus">-    currentFile-&gt;IsDirectory(&amp;isDirectory);</span>
<a href="#l6.1298"></a><span id="l6.1298" class="difflineminus">-    if (isDirectory)</span>
<a href="#l6.1299"></a><span id="l6.1299" class="difflineminus">-      continue;</span>
<a href="#l6.1300"></a><span id="l6.1300" class="difflineminus">-</span>
<a href="#l6.1301"></a><span id="l6.1301" class="difflineminus">-    nsCAutoString fileOrDirNameStr;</span>
<a href="#l6.1302"></a><span id="l6.1302" class="difflineminus">-    currentFile-&gt;GetNativeLeafName(fileOrDirNameStr);</span>
<a href="#l6.1303"></a><span id="l6.1303" class="difflineminus">-    if (!nsCStringEndsWith(fileOrDirNameStr, pattern))</span>
<a href="#l6.1304"></a><span id="l6.1304" class="difflineminus">-      continue;</span>
<a href="#l6.1305"></a><span id="l6.1305" class="difflineminus">-</span>
<a href="#l6.1306"></a><span id="l6.1306" class="difflineminus">-</span>
<a href="#l6.1307"></a><span id="l6.1307" class="difflineminus">-    AddFileCopyToList(currentFile, newPathFile, &quot;&quot;);</span>
<a href="#l6.1308"></a><span id="l6.1308" class="difflineminus">-  }</span>
<a href="#l6.1309"></a><span id="l6.1309" class="difflineminus">-</span>
<a href="#l6.1310"></a><span id="l6.1310" class="difflineminus">-  return NS_OK;</span>
<a href="#l6.1311"></a><span id="l6.1311" class="difflineminus">-}</span>
<a href="#l6.1312"></a><span id="l6.1312" class="difflineminus">-</span>
<a href="#l6.1313"></a><span id="l6.1313" class="difflineminus">-nsresult nsDogbertProfileMigrator::AddFileCopyToList(nsIFile * aOldPath, nsIFile * aNewPath, const char * newName)</span>
<a href="#l6.1314"></a><span id="l6.1314" class="difflineminus">-{</span>
<a href="#l6.1315"></a><span id="l6.1315" class="difflineminus">-  fileTransactionEntry fileEntry;</span>
<a href="#l6.1316"></a><span id="l6.1316" class="difflineminus">-  fileEntry.srcFile = do_QueryInterface(aOldPath);</span>
<a href="#l6.1317"></a><span id="l6.1317" class="difflineminus">-  fileEntry.destFile = do_QueryInterface(aNewPath);</span>
<a href="#l6.1318"></a><span id="l6.1318" class="difflineminus">-  fileEntry.newName = NS_ConvertUTF8toUTF16(newName);</span>
<a href="#l6.1319"></a><span id="l6.1319" class="difflineminus">-  mFileCopyTransactions.AppendElement(fileEntry);</span>
<a href="#l6.1320"></a><span id="l6.1320" class="difflineminus">-  return NS_OK;</span>
<a href="#l6.1321"></a><span id="l6.1321" class="difflineminus">-}</span>
<a href="#l6.1322"></a><span id="l6.1322" class="difflineminus">-</span>
<a href="#l6.1323"></a><span id="l6.1323" class="difflineminus">-nsresult nsDogbertProfileMigrator::DoTheCopy(nsIFile * oldPath, nsIFile * newPath, PRBool readSubdirs)</span>
<a href="#l6.1324"></a><span id="l6.1324" class="difflineminus">-{</span>
<a href="#l6.1325"></a><span id="l6.1325" class="difflineminus">-  return DoTheCopyAndRename(oldPath, newPath, readSubdirs, PR_FALSE, &quot;&quot;, &quot;&quot;);</span>
<a href="#l6.1326"></a><span id="l6.1326" class="difflineminus">-}</span>
<a href="#l6.1327"></a><span id="l6.1327" class="difflineminus">-</span>
<a href="#l6.1328"></a><span id="l6.1328" class="difflineminus">-nsresult nsDogbertProfileMigrator::DoTheCopy(nsILocalFile * oldPath, nsILocalFile * newPath, const char *fileOrDirName, PRBool isDirectory)</span>
<a href="#l6.1329"></a><span id="l6.1329" class="difflineminus">-{</span>
<a href="#l6.1330"></a><span id="l6.1330" class="difflineminus">-  nsresult rv;</span>
<a href="#l6.1331"></a><span id="l6.1331" class="difflineminus">-</span>
<a href="#l6.1332"></a><span id="l6.1332" class="difflineminus">-  if (isDirectory)</span>
<a href="#l6.1333"></a><span id="l6.1333" class="difflineminus">-  {</span>
<a href="#l6.1334"></a><span id="l6.1334" class="difflineminus">-    nsCOMPtr&lt;nsIFile&gt; oldSubPath;</span>
<a href="#l6.1335"></a><span id="l6.1335" class="difflineminus">-</span>
<a href="#l6.1336"></a><span id="l6.1336" class="difflineminus">-    oldPath-&gt;Clone(getter_AddRefs(oldSubPath));</span>
<a href="#l6.1337"></a><span id="l6.1337" class="difflineminus">-    rv = oldSubPath-&gt;AppendNative(nsDependentCString(fileOrDirName));</span>
<a href="#l6.1338"></a><span id="l6.1338" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.1339"></a><span id="l6.1339" class="difflineminus">-    PRBool exist;</span>
<a href="#l6.1340"></a><span id="l6.1340" class="difflineminus">-    rv = oldSubPath-&gt;Exists(&amp;exist);</span>
<a href="#l6.1341"></a><span id="l6.1341" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.1342"></a><span id="l6.1342" class="difflineminus">-    if (!exist)</span>
<a href="#l6.1343"></a><span id="l6.1343" class="difflineminus">-    {</span>
<a href="#l6.1344"></a><span id="l6.1344" class="difflineminus">-      rv = oldSubPath-&gt;Create(nsIFile::DIRECTORY_TYPE, 0700);</span>
<a href="#l6.1345"></a><span id="l6.1345" class="difflineminus">-      if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.1346"></a><span id="l6.1346" class="difflineminus">-    }</span>
<a href="#l6.1347"></a><span id="l6.1347" class="difflineminus">-</span>
<a href="#l6.1348"></a><span id="l6.1348" class="difflineminus">-    nsCOMPtr&lt;nsILocalFile&gt; newSubPath = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l6.1349"></a><span id="l6.1349" class="difflineminus">-    newSubPath-&gt;InitWithFile(newPath);</span>
<a href="#l6.1350"></a><span id="l6.1350" class="difflineminus">-</span>
<a href="#l6.1351"></a><span id="l6.1351" class="difflineminus">-    rv = newSubPath-&gt;AppendNative(nsDependentCString(fileOrDirName));</span>
<a href="#l6.1352"></a><span id="l6.1352" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.1353"></a><span id="l6.1353" class="difflineminus">-    rv = newSubPath-&gt;Exists(&amp;exist);</span>
<a href="#l6.1354"></a><span id="l6.1354" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.1355"></a><span id="l6.1355" class="difflineminus">-    if (!exist)</span>
<a href="#l6.1356"></a><span id="l6.1356" class="difflineminus">-    {</span>
<a href="#l6.1357"></a><span id="l6.1357" class="difflineminus">-      rv = newSubPath-&gt;Create(nsIFile::DIRECTORY_TYPE, 0700);</span>
<a href="#l6.1358"></a><span id="l6.1358" class="difflineminus">-      if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.1359"></a><span id="l6.1359" class="difflineminus">-    }</span>
<a href="#l6.1360"></a><span id="l6.1360" class="difflineminus">-</span>
<a href="#l6.1361"></a><span id="l6.1361" class="difflineminus">-    DoTheCopy(oldSubPath, newSubPath, PR_TRUE);</span>
<a href="#l6.1362"></a><span id="l6.1362" class="difflineminus">-  }</span>
<a href="#l6.1363"></a><span id="l6.1363" class="difflineminus">-  else</span>
<a href="#l6.1364"></a><span id="l6.1364" class="difflineminus">-  {</span>
<a href="#l6.1365"></a><span id="l6.1365" class="difflineminus">-    nsCOMPtr&lt;nsILocalFile&gt; file = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l6.1366"></a><span id="l6.1366" class="difflineminus">-    file-&gt;InitWithFile(oldPath);</span>
<a href="#l6.1367"></a><span id="l6.1367" class="difflineminus">-    rv = file-&gt;AppendNative(nsDependentCString(fileOrDirName));</span>
<a href="#l6.1368"></a><span id="l6.1368" class="difflineminus">-    if( NS_FAILED(rv) ) return rv;</span>
<a href="#l6.1369"></a><span id="l6.1369" class="difflineminus">-    PRBool exist;</span>
<a href="#l6.1370"></a><span id="l6.1370" class="difflineminus">-    rv = file-&gt;Exists(&amp;exist);</span>
<a href="#l6.1371"></a><span id="l6.1371" class="difflineminus">-    if( NS_FAILED(rv) ) return rv;</span>
<a href="#l6.1372"></a><span id="l6.1372" class="difflineminus">-    if( exist) {</span>
<a href="#l6.1373"></a><span id="l6.1373" class="difflineminus">-      AddFileCopyToList(oldPath, newPath, &quot;&quot;);</span>
<a href="#l6.1374"></a><span id="l6.1374" class="difflineminus">-    }</span>
<a href="#l6.1375"></a><span id="l6.1375" class="difflineminus">-  }</span>
<a href="#l6.1376"></a><span id="l6.1376" class="difflineminus">-</span>
<a href="#l6.1377"></a><span id="l6.1377" class="difflineminus">-  return rv;</span>
<a href="#l6.1378"></a><span id="l6.1378" class="difflineminus">-}</span>
<a href="#l6.1379"></a><span id="l6.1379" class="difflineminus">-</span>
<a href="#l6.1380"></a><span id="l6.1380" class="difflineminus">-</span>
<a href="#l6.1381"></a><span id="l6.1381" class="difflineminus">-/*----------------------------------------------------------------------------</span>
<a href="#l6.1382"></a><span id="l6.1382" class="difflineminus">- * DoSpecialUpdates updates is a routine that does some miscellaneous updates</span>
<a href="#l6.1383"></a><span id="l6.1383" class="difflineminus">- * like renaming certain files, etc.</span>
<a href="#l6.1384"></a><span id="l6.1384" class="difflineminus">- *--------------------------------------------------------------------------*/</span>
<a href="#l6.1385"></a><span id="l6.1385" class="difflineminus">-nsresult nsDogbertProfileMigrator::DoSpecialUpdates(nsILocalFile  * profilePath)</span>
<a href="#l6.1386"></a><span id="l6.1386" class="difflineminus">-{</span>
<a href="#l6.1387"></a><span id="l6.1387" class="difflineminus">-  nsresult rv;</span>
<a href="#l6.1388"></a><span id="l6.1388" class="difflineminus">-  PRInt32 serverType;</span>
<a href="#l6.1389"></a><span id="l6.1389" class="difflineminus">-  nsCOMPtr &lt;nsILocalFile&gt; prefFile = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l6.1390"></a><span id="l6.1390" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.1391"></a><span id="l6.1391" class="difflineminus">-  prefFile-&gt;InitWithFile(profilePath);</span>
<a href="#l6.1392"></a><span id="l6.1392" class="difflineminus">-  prefFile-&gt;AppendNative(NS_LITERAL_CSTRING(PREF_FILE_NAME_IN_5x));</span>
<a href="#l6.1393"></a><span id="l6.1393" class="difflineminus">-</span>
<a href="#l6.1394"></a><span id="l6.1394" class="difflineminus">-  nsCOMPtr &lt;nsIOutputStream&gt; fsStream;</span>
<a href="#l6.1395"></a><span id="l6.1395" class="difflineminus">-  rv = NS_NewLocalFileOutputStream(getter_AddRefs(fsStream), prefFile, PR_WRONLY | PR_APPEND | PR_CREATE_FILE, 0660);</span>
<a href="#l6.1396"></a><span id="l6.1396" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.1397"></a><span id="l6.1397" class="difflineminus">-</span>
<a href="#l6.1398"></a><span id="l6.1398" class="difflineminus">-  /* Need to add a string to the top of the prefs.js file to prevent it</span>
<a href="#l6.1399"></a><span id="l6.1399" class="difflineminus">-   * from being loaded as a standard javascript file which would be a</span>
<a href="#l6.1400"></a><span id="l6.1400" class="difflineminus">-   * security hole.</span>
<a href="#l6.1401"></a><span id="l6.1401" class="difflineminus">-   */</span>
<a href="#l6.1402"></a><span id="l6.1402" class="difflineminus">-  PRUint32 bytesWritten;</span>
<a href="#l6.1403"></a><span id="l6.1403" class="difflineminus">-  nsCAutoString headerLine(PREF_FILE_HEADER_STRING MSG_LINEBREAK);</span>
<a href="#l6.1404"></a><span id="l6.1404" class="difflineminus">-  fsStream-&gt;Write(headerLine.get(), headerLine.Length(), &amp;bytesWritten) ;</span>
<a href="#l6.1405"></a><span id="l6.1405" class="difflineminus">-  fsStream-&gt;Close();</span>
<a href="#l6.1406"></a><span id="l6.1406" class="difflineminus">-</span>
<a href="#l6.1407"></a><span id="l6.1407" class="difflineminus">-  /* Create the new mail directory from the setting in prefs.js or a default */</span>
<a href="#l6.1408"></a><span id="l6.1408" class="difflineminus">-  rv = mPrefs-&gt;GetIntPref(PREF_MAIL_SERVER_TYPE, &amp;serverType);</span>
<a href="#l6.1409"></a><span id="l6.1409" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.1410"></a><span id="l6.1410" class="difflineminus">-  if (serverType == POP_4X_MAIL_TYPE) {</span>
<a href="#l6.1411"></a><span id="l6.1411" class="difflineminus">-	rv = RenameAndMove4xPopFilterFile(profilePath);</span>
<a href="#l6.1412"></a><span id="l6.1412" class="difflineminus">-  	if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.1413"></a><span id="l6.1413" class="difflineminus">-</span>
<a href="#l6.1414"></a><span id="l6.1414" class="difflineminus">-	rv = RenameAndMove4xPopStateFile(profilePath);</span>
<a href="#l6.1415"></a><span id="l6.1415" class="difflineminus">-  	if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.1416"></a><span id="l6.1416" class="difflineminus">-  }</span>
<a href="#l6.1417"></a><span id="l6.1417" class="difflineminus">-#ifdef IMAP_MAIL_FILTER_FILE_NAME_FORMAT_IN_4x</span>
<a href="#l6.1418"></a><span id="l6.1418" class="difflineminus">-  else if (serverType == IMAP_4X_MAIL_TYPE) {</span>
<a href="#l6.1419"></a><span id="l6.1419" class="difflineminus">-  	rv = RenameAndMove4xImapFilterFiles(profilePath);</span>
<a href="#l6.1420"></a><span id="l6.1420" class="difflineminus">-	if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.1421"></a><span id="l6.1421" class="difflineminus">-  }</span>
<a href="#l6.1422"></a><span id="l6.1422" class="difflineminus">-#endif /* IMAP_MAIL_FILTER_FILE_NAME_FORMAT_IN_4x */</span>
<a href="#l6.1423"></a><span id="l6.1423" class="difflineminus">-</span>
<a href="#l6.1424"></a><span id="l6.1424" class="difflineminus">-  return rv;</span>
<a href="#l6.1425"></a><span id="l6.1425" class="difflineminus">-}</span>
<a href="#l6.1426"></a><span id="l6.1426" class="difflineminus">-</span>
<a href="#l6.1427"></a><span id="l6.1427" class="difflineminus">-nsresult nsDogbertProfileMigrator::RenameAndMove4xPopFilterFile(nsILocalFile * profilePath)</span>
<a href="#l6.1428"></a><span id="l6.1428" class="difflineminus">-{</span>
<a href="#l6.1429"></a><span id="l6.1429" class="difflineminus">-  return RenameAndMove4xPopFile(profilePath, POP_MAIL_FILTER_FILE_NAME_IN_4x, POP_MAIL_FILTER_FILE_NAME_IN_5x);</span>
<a href="#l6.1430"></a><span id="l6.1430" class="difflineminus">-}</span>
<a href="#l6.1431"></a><span id="l6.1431" class="difflineminus">-</span>
<a href="#l6.1432"></a><span id="l6.1432" class="difflineminus">-nsresult nsDogbertProfileMigrator::RenameAndMove4xPopStateFile(nsILocalFile * profilePath)</span>
<a href="#l6.1433"></a><span id="l6.1433" class="difflineminus">-{</span>
<a href="#l6.1434"></a><span id="l6.1434" class="difflineminus">-#ifdef POPSTATE_FILE_IN_4x</span>
<a href="#l6.1435"></a><span id="l6.1435" class="difflineminus">-  return RenameAndMove4xPopFile(profilePath, POPSTATE_FILE_IN_4x, POPSTATE_FILE_IN_5x);</span>
<a href="#l6.1436"></a><span id="l6.1436" class="difflineminus">-#else</span>
<a href="#l6.1437"></a><span id="l6.1437" class="difflineminus">-  // on windows, popstate.dat was in Users\&lt;profile&gt;\MAIL\popstate.dat</span>
<a href="#l6.1438"></a><span id="l6.1438" class="difflineminus">-  // which is the right place, unlike linux and mac.</span>
<a href="#l6.1439"></a><span id="l6.1439" class="difflineminus">-  // so, when we migrate Users\&lt;profile&gt;\Mail to Users50\&lt;profile&gt;\Mail\&lt;hostname&gt;</span>
<a href="#l6.1440"></a><span id="l6.1440" class="difflineminus">-  // it just works</span>
<a href="#l6.1441"></a><span id="l6.1441" class="difflineminus">-  return NS_OK;</span>
<a href="#l6.1442"></a><span id="l6.1442" class="difflineminus">-#endif /* POPSTATE_FILE_IN_4x */</span>
<a href="#l6.1443"></a><span id="l6.1443" class="difflineminus">-}</span>
<a href="#l6.1444"></a><span id="l6.1444" class="difflineminus">-</span>
<a href="#l6.1445"></a><span id="l6.1445" class="difflineminus">-nsresult nsDogbertProfileMigrator::RenameAndMove4xPopFile(nsILocalFile * profilePath, const char *fileNameIn4x, const char *fileNameIn5x)</span>
<a href="#l6.1446"></a><span id="l6.1446" class="difflineminus">-{</span>
<a href="#l6.1447"></a><span id="l6.1447" class="difflineminus">-  nsresult rv;</span>
<a href="#l6.1448"></a><span id="l6.1448" class="difflineminus">-  nsCOMPtr &lt;nsILocalFile&gt; file = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l6.1449"></a><span id="l6.1449" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.1450"></a><span id="l6.1450" class="difflineminus">-  file-&gt;InitWithFile(profilePath);</span>
<a href="#l6.1451"></a><span id="l6.1451" class="difflineminus">-</span>
<a href="#l6.1452"></a><span id="l6.1452" class="difflineminus">-  // we assume the 4.x pop files live at &lt;profile&gt;/&lt;fileNameIn4x&gt;</span>
<a href="#l6.1453"></a><span id="l6.1453" class="difflineminus">-  file-&gt;AppendNative(nsDependentCString(fileNameIn4x));</span>
<a href="#l6.1454"></a><span id="l6.1454" class="difflineminus">-</span>
<a href="#l6.1455"></a><span id="l6.1455" class="difflineminus">-  // figure out where the 4.x pop mail directory got copied to</span>
<a href="#l6.1456"></a><span id="l6.1456" class="difflineminus">-  char *popServerName = nsnull;</span>
<a href="#l6.1457"></a><span id="l6.1457" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; migratedPopDirectory;</span>
<a href="#l6.1458"></a><span id="l6.1458" class="difflineminus">-  profilePath-&gt;Clone(getter_AddRefs(migratedPopDirectory));</span>
<a href="#l6.1459"></a><span id="l6.1459" class="difflineminus">-  migratedPopDirectory-&gt;AppendNative(NS_LITERAL_CSTRING(NEW_MAIL_DIR_NAME));</span>
<a href="#l6.1460"></a><span id="l6.1460" class="difflineminus">-  mPrefs-&gt;GetCharPref(PREF_NETWORK_HOSTS_POP_SERVER, &amp;popServerName);</span>
<a href="#l6.1461"></a><span id="l6.1461" class="difflineminus">-  migratedPopDirectory-&gt;AppendNative(nsDependentCString(popServerName));</span>
<a href="#l6.1462"></a><span id="l6.1462" class="difflineminus">-  PR_FREEIF(popServerName);</span>
<a href="#l6.1463"></a><span id="l6.1463" class="difflineminus">-</span>
<a href="#l6.1464"></a><span id="l6.1464" class="difflineminus">-  // copy the 4.x file from &lt;profile&gt;/&lt;fileNameIn4x&gt; to the &lt;profile&gt;/Mail/&lt;hostname&gt;/&lt;fileNameIn4x&gt;</span>
<a href="#l6.1465"></a><span id="l6.1465" class="difflineminus">-  rv = file-&gt;CopyTo(migratedPopDirectory, EmptyString());</span>
<a href="#l6.1466"></a><span id="l6.1466" class="difflineminus">-  NS_ASSERTION(NS_SUCCEEDED(rv),&quot;failed to copy pop file&quot;);</span>
<a href="#l6.1467"></a><span id="l6.1467" class="difflineminus">-</span>
<a href="#l6.1468"></a><span id="l6.1468" class="difflineminus">-  // XXX todo, delete the old file</span>
<a href="#l6.1469"></a><span id="l6.1469" class="difflineminus">-  // we are leaving it behind</span>
<a href="#l6.1470"></a><span id="l6.1470" class="difflineminus">-</span>
<a href="#l6.1471"></a><span id="l6.1471" class="difflineminus">-  // make migratedPopDirectory point the the copied filter file,</span>
<a href="#l6.1472"></a><span id="l6.1472" class="difflineminus">-  // &lt;profile&gt;/Mail/&lt;hostname&gt;/&lt;fileNameIn4x&gt;</span>
<a href="#l6.1473"></a><span id="l6.1473" class="difflineminus">-  migratedPopDirectory-&gt;AppendNative(nsDependentCString(fileNameIn4x));</span>
<a href="#l6.1474"></a><span id="l6.1474" class="difflineminus">-</span>
<a href="#l6.1475"></a><span id="l6.1475" class="difflineminus">-  // rename &lt;profile&gt;/Mail/&lt;hostname&gt;/&lt;fileNameIn4x&gt;to &lt;profile&gt;/Mail/&lt;hostname&gt;/&lt;fileNameIn5x&gt;, if necessary</span>
<a href="#l6.1476"></a><span id="l6.1476" class="difflineminus">-  if (PL_strcmp(fileNameIn4x,fileNameIn5x))</span>
<a href="#l6.1477"></a><span id="l6.1477" class="difflineminus">-	  migratedPopDirectory-&gt;MoveToNative(nsnull, nsDependentCString(fileNameIn5x));</span>
<a href="#l6.1478"></a><span id="l6.1478" class="difflineminus">-</span>
<a href="#l6.1479"></a><span id="l6.1479" class="difflineminus">-  return NS_OK;</span>
<a href="#l6.1480"></a><span id="l6.1480" class="difflineminus">-}</span>
<a href="#l6.1481"></a><span id="l6.1481" class="difflineminus">-</span>
<a href="#l6.1482"></a><span id="l6.1482" class="difflineminus">-</span>
<a href="#l6.1483"></a><span id="l6.1483" class="difflineminus">-#ifdef IMAP_MAIL_FILTER_FILE_NAME_FORMAT_IN_4x</span>
<a href="#l6.1484"></a><span id="l6.1484" class="difflineminus">-#define BUFFER_LEN	128</span>
<a href="#l6.1485"></a><span id="l6.1485" class="difflineminus">-nsresult nsDogbertProfileMigrator::RenameAndMove4xImapFilterFile(nsILocalFile * profilePath, const char *hostname)</span>
<a href="#l6.1486"></a><span id="l6.1486" class="difflineminus">-{</span>
<a href="#l6.1487"></a><span id="l6.1487" class="difflineminus">-  char imapFilterFileName[BUFFER_LEN];</span>
<a href="#l6.1488"></a><span id="l6.1488" class="difflineminus">-</span>
<a href="#l6.1489"></a><span id="l6.1489" class="difflineminus">-  // the 4.x imap filter file lives in &quot;&lt;profile&gt;/&lt;hostname&gt; Rules&quot;</span>
<a href="#l6.1490"></a><span id="l6.1490" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; file;</span>
<a href="#l6.1491"></a><span id="l6.1491" class="difflineminus">-  nsresult rv = profilePath-&gt;Clone(getter_AddRefs(file));</span>
<a href="#l6.1492"></a><span id="l6.1492" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.1493"></a><span id="l6.1493" class="difflineminus">-</span>
<a href="#l6.1494"></a><span id="l6.1494" class="difflineminus">-  PR_snprintf(imapFilterFileName, BUFFER_LEN, IMAP_MAIL_FILTER_FILE_NAME_FORMAT_IN_4x, hostname);</span>
<a href="#l6.1495"></a><span id="l6.1495" class="difflineminus">-  file-&gt;AppendNative(nsDependentCString(imapFilterFileName));</span>
<a href="#l6.1496"></a><span id="l6.1496" class="difflineminus">-</span>
<a href="#l6.1497"></a><span id="l6.1497" class="difflineminus">-  PRBool exists = PR_FALSE;</span>
<a href="#l6.1498"></a><span id="l6.1498" class="difflineminus">-  file-&gt;Exists(&amp;exists);</span>
<a href="#l6.1499"></a><span id="l6.1499" class="difflineminus">-  // if that file didn't exist, because they didn't use filters for that server, return now</span>
<a href="#l6.1500"></a><span id="l6.1500" class="difflineminus">-  if (!exists) return NS_OK;</span>
<a href="#l6.1501"></a><span id="l6.1501" class="difflineminus">-</span>
<a href="#l6.1502"></a><span id="l6.1502" class="difflineminus">-  // figure out where the 4.x pop mail directory got copied to</span>
<a href="#l6.1503"></a><span id="l6.1503" class="difflineminus">-  nsCOMPtr &lt;nsILocalFile&gt; migratedImapDirectory = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l6.1504"></a><span id="l6.1504" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.1505"></a><span id="l6.1505" class="difflineminus">-  migratedImapDirectory-&gt;InitWithFile(profilePath);</span>
<a href="#l6.1506"></a><span id="l6.1506" class="difflineminus">-  migratedImapDirectory-&gt;AppendNative(NS_LITERAL_CSTRING(NEW_IMAPMAIL_DIR_NAME));</span>
<a href="#l6.1507"></a><span id="l6.1507" class="difflineminus">-  migratedImapDirectory-&gt;AppendNative(nsDependentCString(hostname));</span>
<a href="#l6.1508"></a><span id="l6.1508" class="difflineminus">-</span>
<a href="#l6.1509"></a><span id="l6.1509" class="difflineminus">-  // copy the 4.x file from &quot;&lt;profile&gt;/&lt;hostname&gt; Rules&quot; to &lt;profile&gt;/ImapMail/&lt;hostname&gt;/</span>
<a href="#l6.1510"></a><span id="l6.1510" class="difflineminus">-  rv = file-&gt;CopyTo(migratedImapDirectory, EmptyString());</span>
<a href="#l6.1511"></a><span id="l6.1511" class="difflineminus">-  NS_ASSERTION(NS_SUCCEEDED(rv),&quot;failed to copy imap file&quot;);</span>
<a href="#l6.1512"></a><span id="l6.1512" class="difflineminus">-</span>
<a href="#l6.1513"></a><span id="l6.1513" class="difflineminus">-  // make migratedPopDirectory point the the copied filter file,</span>
<a href="#l6.1514"></a><span id="l6.1514" class="difflineminus">-  // &quot;&lt;profile&gt;/ImapMail/&lt;hostname&gt;/&lt;hostname&gt; Rules&quot;</span>
<a href="#l6.1515"></a><span id="l6.1515" class="difflineminus">-  migratedImapDirectory-&gt;AppendNative(nsDependentCString(imapFilterFileName));</span>
<a href="#l6.1516"></a><span id="l6.1516" class="difflineminus">-</span>
<a href="#l6.1517"></a><span id="l6.1517" class="difflineminus">-  // rename &quot;&lt;profile&gt;/ImapMail/&lt;hostname&gt;/&lt;hostname&gt; Rules&quot; to  &quot;&lt;profile&gt;/ImapMail/&lt;hostname&gt;/rules.dat&quot;</span>
<a href="#l6.1518"></a><span id="l6.1518" class="difflineminus">-  migratedImapDirectory-&gt;MoveTo(nsnull, NS_LITERAL_STRING(IMAP_MAIL_FILTER_FILE_NAME_IN_5x));</span>
<a href="#l6.1519"></a><span id="l6.1519" class="difflineminus">-</span>
<a href="#l6.1520"></a><span id="l6.1520" class="difflineminus">-  return NS_OK;</span>
<a href="#l6.1521"></a><span id="l6.1521" class="difflineminus">-}</span>
<a href="#l6.1522"></a><span id="l6.1522" class="difflineminus">-</span>
<a href="#l6.1523"></a><span id="l6.1523" class="difflineminus">-nsresult nsDogbertProfileMigrator::RenameAndMove4xImapFilterFiles(nsILocalFile * profilePath)</span>
<a href="#l6.1524"></a><span id="l6.1524" class="difflineminus">-{</span>
<a href="#l6.1525"></a><span id="l6.1525" class="difflineminus">-  nsresult rv;</span>
<a href="#l6.1526"></a><span id="l6.1526" class="difflineminus">-  nsCString hostList;</span>
<a href="#l6.1527"></a><span id="l6.1527" class="difflineminus">-</span>
<a href="#l6.1528"></a><span id="l6.1528" class="difflineminus">-  rv = mPrefs-&gt;GetCharPref(PREF_4X_NETWORK_HOSTS_IMAP_SERVER, getter_Copies(hostList));</span>
<a href="#l6.1529"></a><span id="l6.1529" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.1530"></a><span id="l6.1530" class="difflineminus">-</span>
<a href="#l6.1531"></a><span id="l6.1531" class="difflineminus">-  if (hostList.IsEmpty()) return NS_OK;</span>
<a href="#l6.1532"></a><span id="l6.1532" class="difflineminus">-</span>
<a href="#l6.1533"></a><span id="l6.1533" class="difflineminus">-  char *token = nsnull;</span>
<a href="#l6.1534"></a><span id="l6.1534" class="difflineminus">-  char *rest = hostList.BeginWriting();</span>
<a href="#l6.1535"></a><span id="l6.1535" class="difflineminus">-  nsCAutoString str;</span>
<a href="#l6.1536"></a><span id="l6.1536" class="difflineminus">-  token = NS_strtok(&quot;,&quot;, &amp;rest);</span>
<a href="#l6.1537"></a><span id="l6.1537" class="difflineminus">-  while (token &amp;&amp; *token) {</span>
<a href="#l6.1538"></a><span id="l6.1538" class="difflineminus">-    str = token;</span>
<a href="#l6.1539"></a><span id="l6.1539" class="difflineminus">-    str.StripWhitespace();</span>
<a href="#l6.1540"></a><span id="l6.1540" class="difflineminus">-</span>
<a href="#l6.1541"></a><span id="l6.1541" class="difflineminus">-    if (!str.IsEmpty()) {</span>
<a href="#l6.1542"></a><span id="l6.1542" class="difflineminus">-      // str is the hostname</span>
<a href="#l6.1543"></a><span id="l6.1543" class="difflineminus">-      rv = RenameAndMove4xImapFilterFile(profilePath, str.get());</span>
<a href="#l6.1544"></a><span id="l6.1544" class="difflineminus">-      if  (NS_FAILED(rv)) {</span>
<a href="#l6.1545"></a><span id="l6.1545" class="difflineminus">-        // failed to migrate.  bail.</span>
<a href="#l6.1546"></a><span id="l6.1546" class="difflineminus">-        return rv;</span>
<a href="#l6.1547"></a><span id="l6.1547" class="difflineminus">-      }</span>
<a href="#l6.1548"></a><span id="l6.1548" class="difflineminus">-    }</span>
<a href="#l6.1549"></a><span id="l6.1549" class="difflineminus">-    token = NS_strtok(&quot;,&quot;, &amp;rest);</span>
<a href="#l6.1550"></a><span id="l6.1550" class="difflineminus">-  }</span>
<a href="#l6.1551"></a><span id="l6.1551" class="difflineminus">-  return NS_OK;</span>
<a href="#l6.1552"></a><span id="l6.1552" class="difflineminus">-}</span>
<a href="#l6.1553"></a><span id="l6.1553" class="difflineminus">-#endif /* IMAP_MAIL_FILTER_FILE_NAME_FORMAT_IN_4x */</span>
<a href="#l6.1554"></a><span id="l6.1554" class="difflineminus">-</span>
<a href="#l6.1555"></a><span id="l6.1555" class="difflineminus">-nsresult</span>
<a href="#l6.1556"></a><span id="l6.1556" class="difflineminus">-nsDogbertProfileMigrator::Rename4xFileAfterMigration(nsIFile * profilePath, const char *oldFileName, const char *newFileName)</span>
<a href="#l6.1557"></a><span id="l6.1557" class="difflineminus">-{</span>
<a href="#l6.1558"></a><span id="l6.1558" class="difflineminus">-  // if they are the same, don't bother to rename the file.</span>
<a href="#l6.1559"></a><span id="l6.1559" class="difflineminus">-  if (PL_strcmp(oldFileName, newFileName) == 0)</span>
<a href="#l6.1560"></a><span id="l6.1560" class="difflineminus">-    return NS_OK;</span>
<a href="#l6.1561"></a><span id="l6.1561" class="difflineminus">-</span>
<a href="#l6.1562"></a><span id="l6.1562" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; file;</span>
<a href="#l6.1563"></a><span id="l6.1563" class="difflineminus">-  nsresult rv = profilePath-&gt;Clone(getter_AddRefs(file));</span>
<a href="#l6.1564"></a><span id="l6.1564" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.1565"></a><span id="l6.1565" class="difflineminus">-</span>
<a href="#l6.1566"></a><span id="l6.1566" class="difflineminus">-  file-&gt;AppendNative(nsDependentCString(oldFileName));</span>
<a href="#l6.1567"></a><span id="l6.1567" class="difflineminus">-  PRBool exists = PR_FALSE;</span>
<a href="#l6.1568"></a><span id="l6.1568" class="difflineminus">-  file-&gt;Exists(&amp;exists);</span>
<a href="#l6.1569"></a><span id="l6.1569" class="difflineminus">-  // make sure it exists before you try to rename it</span>
<a href="#l6.1570"></a><span id="l6.1570" class="difflineminus">-  if (exists)</span>
<a href="#l6.1571"></a><span id="l6.1571" class="difflineminus">-    rv = file-&gt;MoveToNative(nsnull, nsDependentCString(newFileName));</span>
<a href="#l6.1572"></a><span id="l6.1572" class="difflineminus">-</span>
<a href="#l6.1573"></a><span id="l6.1573" class="difflineminus">-  return rv;</span>
<a href="#l6.1574"></a><span id="l6.1574" class="difflineminus">-}</span>
<a href="#l6.1575"></a><span id="l6.1575" class="difflineminus">-</span>
<a href="#l6.1576"></a><span id="l6.1576" class="difflineminus">-#ifdef NEED_TO_COPY_AND_RENAME_NEWSRC_FILES</span>
<a href="#l6.1577"></a><span id="l6.1577" class="difflineminus">-nsresult nsDogbertProfileMigrator::GetPremigratedFilePref(const char *pref_name, nsILocalFile **path)</span>
<a href="#l6.1578"></a><span id="l6.1578" class="difflineminus">-{</span>
<a href="#l6.1579"></a><span id="l6.1579" class="difflineminus">-  if (!pref_name) return NS_ERROR_FAILURE;</span>
<a href="#l6.1580"></a><span id="l6.1580" class="difflineminus">-  char premigration_pref[MAX_PREF_LEN];</span>
<a href="#l6.1581"></a><span id="l6.1581" class="difflineminus">-  PR_snprintf(premigration_pref,MAX_PREF_LEN,&quot;%s%s&quot;,PREMIGRATION_PREFIX,pref_name);</span>
<a href="#l6.1582"></a><span id="l6.1582" class="difflineminus">-</span>
<a href="#l6.1583"></a><span id="l6.1583" class="difflineminus">-  return mPrefs-&gt;GetComplexValue((const char *)premigration_pref, NS_GET_IID(nsILocalFile), (void **) path);</span>
<a href="#l6.1584"></a><span id="l6.1584" class="difflineminus">-}</span>
<a href="#l6.1585"></a><span id="l6.1585" class="difflineminus">-</span>
<a href="#l6.1586"></a><span id="l6.1586" class="difflineminus">-#endif /* NEED_TO_COPY_AND_RENAME_NEWSRC_FILES */</span>
<a href="#l6.1587"></a><span id="l6.1587" class="difflineminus">-</span>
<a href="#l6.1588"></a><span id="l6.1588" class="difflineminus">-nsresult nsDogbertProfileMigrator::DetermineOldPath(nsILocalFile *profilePath, const char *oldPathName, const char *oldPathEntityName, nsILocalFile *oldPath)</span>
<a href="#l6.1589"></a><span id="l6.1589" class="difflineminus">-{</span>
<a href="#l6.1590"></a><span id="l6.1590" class="difflineminus">-  nsresult rv;</span>
<a href="#l6.1591"></a><span id="l6.1591" class="difflineminus">-</span>
<a href="#l6.1592"></a><span id="l6.1592" class="difflineminus">-  /* set oldLocalFile to profilePath.  need to convert nsILocalFile-&gt;nsILocalFile */</span>
<a href="#l6.1593"></a><span id="l6.1593" class="difflineminus">-  nsCOMPtr&lt;nsILocalFile&gt; oldLocalFile = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l6.1594"></a><span id="l6.1594" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.1595"></a><span id="l6.1595" class="difflineminus">-        oldLocalFile-&gt;InitWithFile(profilePath);</span>
<a href="#l6.1596"></a><span id="l6.1596" class="difflineminus">-</span>
<a href="#l6.1597"></a><span id="l6.1597" class="difflineminus">-  /* get the string bundle, and get the appropriate localized string out of it */</span>
<a href="#l6.1598"></a><span id="l6.1598" class="difflineminus">-  nsCOMPtr&lt;nsIStringBundleService&gt; bundleService = do_GetService(NS_STRINGBUNDLE_CONTRACTID, &amp;rv);</span>
<a href="#l6.1599"></a><span id="l6.1599" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.1600"></a><span id="l6.1600" class="difflineminus">-</span>
<a href="#l6.1601"></a><span id="l6.1601" class="difflineminus">-  nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l6.1602"></a><span id="l6.1602" class="difflineminus">-  rv = bundleService-&gt;CreateBundle(MIGRATION_PROPERTIES_URL, getter_AddRefs(bundle));</span>
<a href="#l6.1603"></a><span id="l6.1603" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.1604"></a><span id="l6.1604" class="difflineminus">-</span>
<a href="#l6.1605"></a><span id="l6.1605" class="difflineminus">-  nsString localizedDirName;</span>
<a href="#l6.1606"></a><span id="l6.1606" class="difflineminus">-  NS_ConvertASCIItoUTF16 entityName(oldPathEntityName);</span>
<a href="#l6.1607"></a><span id="l6.1607" class="difflineminus">-  rv = bundle-&gt;GetStringFromName(entityName.get(), getter_Copies(localizedDirName));</span>
<a href="#l6.1608"></a><span id="l6.1608" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.1609"></a><span id="l6.1609" class="difflineminus">-</span>
<a href="#l6.1610"></a><span id="l6.1610" class="difflineminus">-  rv = oldLocalFile-&gt;AppendRelativePath(localizedDirName);</span>
<a href="#l6.1611"></a><span id="l6.1611" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.1612"></a><span id="l6.1612" class="difflineminus">-</span>
<a href="#l6.1613"></a><span id="l6.1613" class="difflineminus">-  PRBool exists = PR_FALSE;</span>
<a href="#l6.1614"></a><span id="l6.1614" class="difflineminus">-  rv = oldLocalFile-&gt;Exists(&amp;exists);</span>
<a href="#l6.1615"></a><span id="l6.1615" class="difflineminus">-  if (!exists) {</span>
<a href="#l6.1616"></a><span id="l6.1616" class="difflineminus">-    /* if the localized name doesn't exist, use the english name */</span>
<a href="#l6.1617"></a><span id="l6.1617" class="difflineminus">-    rv = oldPath-&gt;InitWithFile(profilePath);</span>
<a href="#l6.1618"></a><span id="l6.1618" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.1619"></a><span id="l6.1619" class="difflineminus">-</span>
<a href="#l6.1620"></a><span id="l6.1620" class="difflineminus">-    rv = oldPath-&gt;AppendNative(nsDependentCString(oldPathName));</span>
<a href="#l6.1621"></a><span id="l6.1621" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.1622"></a><span id="l6.1622" class="difflineminus">-</span>
<a href="#l6.1623"></a><span id="l6.1623" class="difflineminus">-    return NS_OK;</span>
<a href="#l6.1624"></a><span id="l6.1624" class="difflineminus">-  }</span>
<a href="#l6.1625"></a><span id="l6.1625" class="difflineminus">-</span>
<a href="#l6.1626"></a><span id="l6.1626" class="difflineminus">-  /* at this point, the folder with the localized name exists, so use it */</span>
<a href="#l6.1627"></a><span id="l6.1627" class="difflineminus">-  nsCAutoString persistentDescriptor;</span>
<a href="#l6.1628"></a><span id="l6.1628" class="difflineminus">-  rv = oldLocalFile-&gt;GetPersistentDescriptor(persistentDescriptor);</span>
<a href="#l6.1629"></a><span id="l6.1629" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.1630"></a><span id="l6.1630" class="difflineminus">-  return oldPath-&gt;SetPersistentDescriptor(persistentDescriptor);</span>
<a href="#l6.1631"></a><span id="l6.1631" class="difflineminus">-}</span>
<a href="#l6.1632"></a><span id="l6.1632" class="difflineminus">-</span>
<a href="#l6.1633"></a><span id="l6.1633" class="difflineminus">-nsresult nsDogbertProfileMigrator::ConvertPersistentStringToFile(const char *str, nsILocalFile *path)</span>
<a href="#l6.1634"></a><span id="l6.1634" class="difflineminus">-{</span>
<a href="#l6.1635"></a><span id="l6.1635" class="difflineminus">-  nsresult rv;</span>
<a href="#l6.1636"></a><span id="l6.1636" class="difflineminus">-  if (!str || !path) return NS_ERROR_NULL_POINTER;</span>
<a href="#l6.1637"></a><span id="l6.1637" class="difflineminus">-</span>
<a href="#l6.1638"></a><span id="l6.1638" class="difflineminus">-  rv = path-&gt;SetPersistentDescriptor(nsDependentCString(str));</span>
<a href="#l6.1639"></a><span id="l6.1639" class="difflineminus">-  return rv;</span>
<a href="#l6.1640"></a><span id="l6.1640" class="difflineminus">-}</span>
<a href="#l6.1641"></a><span id="l6.1641" class="difflineminus">-</span>
<a href="#l6.1642"></a><span id="l6.1642" class="difflineminus">-/*---------------------------------------------------------------------------------</span>
<a href="#l6.1643"></a><span id="l6.1643" class="difflineminus">- * GetSizes reads the 4.x files in the profile tree and accumulates their sizes</span>
<a href="#l6.1644"></a><span id="l6.1644" class="difflineminus">- *--------------------------------------------------------------------------------*/</span>
<a href="#l6.1645"></a><span id="l6.1645" class="difflineminus">-</span>
<a href="#l6.1646"></a><span id="l6.1646" class="difflineminus">-nsresult nsDogbertProfileMigrator::GetSizes(nsILocalFile *inputPath, PRBool readSubdirs, PRInt64 *sizeTotal)</span>
<a href="#l6.1647"></a><span id="l6.1647" class="difflineminus">-{</span>
<a href="#l6.1648"></a><span id="l6.1648" class="difflineminus">-  nsCAutoString folderName;</span>
<a href="#l6.1649"></a><span id="l6.1649" class="difflineminus">-</span>
<a href="#l6.1650"></a><span id="l6.1650" class="difflineminus">-  nsCOMPtr&lt;nsISimpleEnumerator&gt; directoryEnumerator;</span>
<a href="#l6.1651"></a><span id="l6.1651" class="difflineminus">-  nsresult rv = inputPath-&gt;GetDirectoryEntries(getter_AddRefs(directoryEnumerator));</span>
<a href="#l6.1652"></a><span id="l6.1652" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.1653"></a><span id="l6.1653" class="difflineminus">-</span>
<a href="#l6.1654"></a><span id="l6.1654" class="difflineminus">-  PRBool hasMore;</span>
<a href="#l6.1655"></a><span id="l6.1655" class="difflineminus">-  directoryEnumerator-&gt;HasMoreElements(&amp;hasMore);</span>
<a href="#l6.1656"></a><span id="l6.1656" class="difflineminus">-  while (hasMore &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l6.1657"></a><span id="l6.1657" class="difflineminus">-  {</span>
<a href="#l6.1658"></a><span id="l6.1658" class="difflineminus">-    nsCOMPtr&lt;nsISupports&gt; aSupport;</span>
<a href="#l6.1659"></a><span id="l6.1659" class="difflineminus">-    rv = directoryEnumerator-&gt;GetNext(getter_AddRefs(aSupport));</span>
<a href="#l6.1660"></a><span id="l6.1660" class="difflineminus">-    nsCOMPtr&lt;nsILocalFile&gt; currentFile(do_QueryInterface(aSupport, &amp;rv));</span>
<a href="#l6.1661"></a><span id="l6.1661" class="difflineminus">-    // Handle sub folders</span>
<a href="#l6.1662"></a><span id="l6.1662" class="difflineminus">-    PRBool isDirectory = PR_FALSE;</span>
<a href="#l6.1663"></a><span id="l6.1663" class="difflineminus">-    currentFile-&gt;GetNativeLeafName(folderName);</span>
<a href="#l6.1664"></a><span id="l6.1664" class="difflineminus">-    if (nsCStringEndsWith(folderName, MAIL_SUMMARY_SUFFIX_IN_4x) || nsCStringEndsWith(folderName, NEWS_SUMMARY_SUFFIX_IN_4x) || nsCStringEndsWith(folderName, SUMMARY_SUFFIX_IN_5x)) /* Don't copy the summary files */</span>
<a href="#l6.1665"></a><span id="l6.1665" class="difflineminus">-      continue;</span>
<a href="#l6.1666"></a><span id="l6.1666" class="difflineminus">-    else</span>
<a href="#l6.1667"></a><span id="l6.1667" class="difflineminus">-    {</span>
<a href="#l6.1668"></a><span id="l6.1668" class="difflineminus">-      currentFile-&gt;IsDirectory(&amp;isDirectory);</span>
<a href="#l6.1669"></a><span id="l6.1669" class="difflineminus">-    if (isDirectory)</span>
<a href="#l6.1670"></a><span id="l6.1670" class="difflineminus">-</span>
<a href="#l6.1671"></a><span id="l6.1671" class="difflineminus">-      {</span>
<a href="#l6.1672"></a><span id="l6.1672" class="difflineminus">-        if(readSubdirs)</span>
<a href="#l6.1673"></a><span id="l6.1673" class="difflineminus">-        {</span>
<a href="#l6.1674"></a><span id="l6.1674" class="difflineminus">-          GetSizes(currentFile, PR_TRUE, sizeTotal); /* re-enter the GetSizes function */</span>
<a href="#l6.1675"></a><span id="l6.1675" class="difflineminus">-        }</span>
<a href="#l6.1676"></a><span id="l6.1676" class="difflineminus">-        else</span>
<a href="#l6.1677"></a><span id="l6.1677" class="difflineminus">-          continue;</span>
<a href="#l6.1678"></a><span id="l6.1678" class="difflineminus">-      }</span>
<a href="#l6.1679"></a><span id="l6.1679" class="difflineminus">-      else</span>
<a href="#l6.1680"></a><span id="l6.1680" class="difflineminus">-      {</span>
<a href="#l6.1681"></a><span id="l6.1681" class="difflineminus">-        PRInt64 fileSize;</span>
<a href="#l6.1682"></a><span id="l6.1682" class="difflineminus">-        currentFile-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l6.1683"></a><span id="l6.1683" class="difflineminus">-        *sizeTotal += fileSize;</span>
<a href="#l6.1684"></a><span id="l6.1684" class="difflineminus">-</span>
<a href="#l6.1685"></a><span id="l6.1685" class="difflineminus">-      }</span>
<a href="#l6.1686"></a><span id="l6.1686" class="difflineminus">-    }</span>
<a href="#l6.1687"></a><span id="l6.1687" class="difflineminus">-  }</span>
<a href="#l6.1688"></a><span id="l6.1688" class="difflineminus">-</span>
<a href="#l6.1689"></a><span id="l6.1689" class="difflineminus">-  return NS_OK;</span>
<a href="#l6.1690"></a><span id="l6.1690" class="difflineminus">-}</span>
<a href="#l6.1691"></a><span id="l6.1691" class="difflineminus">-</span>
<a href="#l6.1692"></a><span id="l6.1692" class="difflineminus">-/*---------------------------------------------------------------------------------</span>
<a href="#l6.1693"></a><span id="l6.1693" class="difflineminus">- * GetDirFromPref gets a directory based on a preference set in the 4.x</span>
<a href="#l6.1694"></a><span id="l6.1694" class="difflineminus">- * preferences file, adds a 5 and resets the preference.</span>
<a href="#l6.1695"></a><span id="l6.1695" class="difflineminus">- *</span>
<a href="#l6.1696"></a><span id="l6.1696" class="difflineminus">- * INPUT:</span>
<a href="#l6.1697"></a><span id="l6.1697" class="difflineminus">- *         oldProfilePath - the path to the old 4.x profile directory.</span>
<a href="#l6.1698"></a><span id="l6.1698" class="difflineminus">- *                          currently only used by UNIX</span>
<a href="#l6.1699"></a><span id="l6.1699" class="difflineminus">- *</span>
<a href="#l6.1700"></a><span id="l6.1700" class="difflineminus">- *         newProfilePath - the path to the 5.0 profile directory</span>
<a href="#l6.1701"></a><span id="l6.1701" class="difflineminus">- *                          currently only used by UNIX</span>
<a href="#l6.1702"></a><span id="l6.1702" class="difflineminus">- *</span>
<a href="#l6.1703"></a><span id="l6.1703" class="difflineminus">- *         newDirName     - the leaf name of the directory in the 5.0 world that corresponds to</span>
<a href="#l6.1704"></a><span id="l6.1704" class="difflineminus">- *                          this pref.  Examples:  &quot;Mail&quot;, &quot;ImapMail&quot;, &quot;News&quot;.</span>
<a href="#l6.1705"></a><span id="l6.1705" class="difflineminus">- *                          only used on UNIX.</span>
<a href="#l6.1706"></a><span id="l6.1706" class="difflineminus">- *</span>
<a href="#l6.1707"></a><span id="l6.1707" class="difflineminus">- *         pref - the pref in the &quot;dot&quot; format (e.g. mail.directory)</span>
<a href="#l6.1708"></a><span id="l6.1708" class="difflineminus">- *</span>
<a href="#l6.1709"></a><span id="l6.1709" class="difflineminus">- * OUTPUT: newPath - The old path with a 5 added (on mac and windows)</span>
<a href="#l6.1710"></a><span id="l6.1710" class="difflineminus">- *                   the newProfilePath + &quot;/&quot; + newDirName (on UNIX)</span>
<a href="#l6.1711"></a><span id="l6.1711" class="difflineminus">- *         oldPath - The old path from the pref (if any)</span>
<a href="#l6.1712"></a><span id="l6.1712" class="difflineminus">- *</span>
<a href="#l6.1713"></a><span id="l6.1713" class="difflineminus">- *</span>
<a href="#l6.1714"></a><span id="l6.1714" class="difflineminus">- * RETURNS: NS_OK if the pref was successfully pulled from the prefs file</span>
<a href="#l6.1715"></a><span id="l6.1715" class="difflineminus">- *</span>
<a href="#l6.1716"></a><span id="l6.1716" class="difflineminus">- *--------------------------------------------------------------------------------*/</span>
<a href="#l6.1717"></a><span id="l6.1717" class="difflineminus">-nsresult</span>
<a href="#l6.1718"></a><span id="l6.1718" class="difflineminus">-nsDogbertProfileMigrator::GetDirFromPref(nsILocalFile * oldProfilePath, nsILocalFile * newProfilePath, const char *newDirName, const char* pref, nsILocalFile** newPath, nsILocalFile** oldPath)</span>
<a href="#l6.1719"></a><span id="l6.1719" class="difflineminus">-{</span>
<a href="#l6.1720"></a><span id="l6.1720" class="difflineminus">-  nsresult rv;</span>
<a href="#l6.1721"></a><span id="l6.1721" class="difflineminus">-</span>
<a href="#l6.1722"></a><span id="l6.1722" class="difflineminus">-  if (!oldProfilePath || !newProfilePath || !newDirName || !pref || !newPath || !oldPath)</span>
<a href="#l6.1723"></a><span id="l6.1723" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l6.1724"></a><span id="l6.1724" class="difflineminus">-</span>
<a href="#l6.1725"></a><span id="l6.1725" class="difflineminus">-  nsCOMPtr &lt;nsILocalFile&gt; oldPrefPath;</span>
<a href="#l6.1726"></a><span id="l6.1726" class="difflineminus">-  nsCOMPtr &lt;nsILocalFile&gt; newPathFile;</span>
<a href="#l6.1727"></a><span id="l6.1727" class="difflineminus">-  nsCOMPtr &lt;nsILocalFile&gt; oldPathFile;</span>
<a href="#l6.1728"></a><span id="l6.1728" class="difflineminus">-  nsCString oldPrefPathStr;</span>
<a href="#l6.1729"></a><span id="l6.1729" class="difflineminus">-  rv = mPrefs-&gt;GetCharPref(pref, getter_Copies(oldPrefPathStr));</span>
<a href="#l6.1730"></a><span id="l6.1730" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.1731"></a><span id="l6.1731" class="difflineminus">-</span>
<a href="#l6.1732"></a><span id="l6.1732" class="difflineminus">-  // the default on the mac was &quot;&quot;.  doing GetFileXPref on that would return</span>
<a href="#l6.1733"></a><span id="l6.1733" class="difflineminus">-  // the current working directory, like viewer_debug.  yikes!</span>
<a href="#l6.1734"></a><span id="l6.1734" class="difflineminus">-  if (oldPrefPathStr.IsEmpty())</span>
<a href="#l6.1735"></a><span id="l6.1735" class="difflineminus">-    rv = NS_ERROR_FAILURE;</span>
<a href="#l6.1736"></a><span id="l6.1736" class="difflineminus">-</span>
<a href="#l6.1737"></a><span id="l6.1737" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.1738"></a><span id="l6.1738" class="difflineminus">-</span>
<a href="#l6.1739"></a><span id="l6.1739" class="difflineminus">-  rv = mPrefs-&gt;GetComplexValue(pref, NS_GET_IID(nsILocalFile), getter_AddRefs(oldPathFile));</span>
<a href="#l6.1740"></a><span id="l6.1740" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.1741"></a><span id="l6.1741" class="difflineminus">-</span>
<a href="#l6.1742"></a><span id="l6.1742" class="difflineminus">-#ifdef XP_UNIX</span>
<a href="#l6.1743"></a><span id="l6.1743" class="difflineminus">-	// what if they don't want to go to &lt;profile&gt;/&lt;newDirName&gt;?</span>
<a href="#l6.1744"></a><span id="l6.1744" class="difflineminus">-	// what if unix users want &quot;mail.directory&quot; + &quot;5&quot; (like &quot;~/ns_imap5&quot;)</span>
<a href="#l6.1745"></a><span id="l6.1745" class="difflineminus">-	// or &quot;mail.imap.root_dir&quot; + &quot;5&quot; (like &quot;~/nsmail5&quot;)?</span>
<a href="#l6.1746"></a><span id="l6.1746" class="difflineminus">-	// should we let them?  no.  let's migrate them to</span>
<a href="#l6.1747"></a><span id="l6.1747" class="difflineminus">-	// &lt;profile&gt;/Mail and &lt;profile&gt;/ImapMail</span>
<a href="#l6.1748"></a><span id="l6.1748" class="difflineminus">-	// let's make all three platforms the same.</span>
<a href="#l6.1749"></a><span id="l6.1749" class="difflineminus">-	if (PR_TRUE) {</span>
<a href="#l6.1750"></a><span id="l6.1750" class="difflineminus">-#else</span>
<a href="#l6.1751"></a><span id="l6.1751" class="difflineminus">-	nsCOMPtr &lt;nsIFile&gt; oldPrefPathParent;</span>
<a href="#l6.1752"></a><span id="l6.1752" class="difflineminus">-	rv = oldPrefPath-&gt;GetParent(getter_AddRefs(oldPrefPathParent));</span>
<a href="#l6.1753"></a><span id="l6.1753" class="difflineminus">-	if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.1754"></a><span id="l6.1754" class="difflineminus">-</span>
<a href="#l6.1755"></a><span id="l6.1755" class="difflineminus">-	// if the pref pointed to the default directory</span>
<a href="#l6.1756"></a><span id="l6.1756" class="difflineminus">-	// treat it as if the pref wasn't set</span>
<a href="#l6.1757"></a><span id="l6.1757" class="difflineminus">-	// this way it will get migrated as the user expects</span>
<a href="#l6.1758"></a><span id="l6.1758" class="difflineminus">-	PRBool pathsMatch;</span>
<a href="#l6.1759"></a><span id="l6.1759" class="difflineminus">-	rv = oldProfilePath-&gt;Equals(oldPrefPathParent, &amp;pathsMatch);</span>
<a href="#l6.1760"></a><span id="l6.1760" class="difflineminus">-        newPathFile = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l6.1761"></a><span id="l6.1761" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.1762"></a><span id="l6.1762" class="difflineminus">-	if (NS_SUCCEEDED(rv) &amp;&amp; pathsMatch)</span>
<a href="#l6.1763"></a><span id="l6.1763" class="difflineminus">-        {</span>
<a href="#l6.1764"></a><span id="l6.1764" class="difflineminus">-</span>
<a href="#l6.1765"></a><span id="l6.1765" class="difflineminus">-#endif /* XP_UNIX */</span>
<a href="#l6.1766"></a><span id="l6.1766" class="difflineminus">-          newPathFile-&gt;InitWithFile(newProfilePath);</span>
<a href="#l6.1767"></a><span id="l6.1767" class="difflineminus">-	}</span>
<a href="#l6.1768"></a><span id="l6.1768" class="difflineminus">-	else</span>
<a href="#l6.1769"></a><span id="l6.1769" class="difflineminus">-        {</span>
<a href="#l6.1770"></a><span id="l6.1770" class="difflineminus">-          nsCAutoString leafname;</span>
<a href="#l6.1771"></a><span id="l6.1771" class="difflineminus">-          newPathFile-&gt;InitWithFile(oldPathFile);</span>
<a href="#l6.1772"></a><span id="l6.1772" class="difflineminus">-          rv = newPathFile-&gt;GetNativeLeafName(leafname);</span>
<a href="#l6.1773"></a><span id="l6.1773" class="difflineminus">-          if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.1774"></a><span id="l6.1774" class="difflineminus">-          leafname.Append(NS_LITERAL_CSTRING(NEW_DIR_SUFFIX));</span>
<a href="#l6.1775"></a><span id="l6.1775" class="difflineminus">-          rv = newPathFile-&gt;SetNativeLeafName(leafname);</span>
<a href="#l6.1776"></a><span id="l6.1776" class="difflineminus">-          if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.1777"></a><span id="l6.1777" class="difflineminus">-	}</span>
<a href="#l6.1778"></a><span id="l6.1778" class="difflineminus">-</span>
<a href="#l6.1779"></a><span id="l6.1779" class="difflineminus">-  rv = SetPremigratedFilePref(pref, oldPathFile);</span>
<a href="#l6.1780"></a><span id="l6.1780" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.1781"></a><span id="l6.1781" class="difflineminus">-</span>
<a href="#l6.1782"></a><span id="l6.1782" class="difflineminus">-#ifdef XP_UNIX</span>
<a href="#l6.1783"></a><span id="l6.1783" class="difflineminus">-  /* on UNIX, we kept the newsrc files in &quot;news.directory&quot;, (which was usually ~)</span>
<a href="#l6.1784"></a><span id="l6.1784" class="difflineminus">-   * and the summary files in ~/.netscape/xover-cache</span>
<a href="#l6.1785"></a><span id="l6.1785" class="difflineminus">-   * oldPath should point to ~/.netscape/xover-cache, not &quot;news.directory&quot;</span>
<a href="#l6.1786"></a><span id="l6.1786" class="difflineminus">-   * but we want to save the old &quot;news.directory&quot; in &quot;premigration.news.directory&quot;</span>
<a href="#l6.1787"></a><span id="l6.1787" class="difflineminus">-   * later, again for UNIX only,</span>
<a href="#l6.1788"></a><span id="l6.1788" class="difflineminus">-   * we will copy the .newsrc files (from &quot;news.directory&quot;) into the new &lt;profile&gt;/News directory.</span>
<a href="#l6.1789"></a><span id="l6.1789" class="difflineminus">-   * isn't this fun?</span>
<a href="#l6.1790"></a><span id="l6.1790" class="difflineminus">-   */</span>
<a href="#l6.1791"></a><span id="l6.1791" class="difflineminus">-  if (PL_strcmp(PREF_NEWS_DIRECTORY, pref) == 0) {</span>
<a href="#l6.1792"></a><span id="l6.1792" class="difflineminus">-    rv = oldProfilePath-&gt;AppendNative(NS_LITERAL_CSTRING(OLD_NEWS_DIR_NAME));</span>
<a href="#l6.1793"></a><span id="l6.1793" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.1794"></a><span id="l6.1794" class="difflineminus">-  }</span>
<a href="#l6.1795"></a><span id="l6.1795" class="difflineminus">-#endif /* XP_UNIX */</span>
<a href="#l6.1796"></a><span id="l6.1796" class="difflineminus">-  NS_IF_ADDREF(*newPath = newPathFile);</span>
<a href="#l6.1797"></a><span id="l6.1797" class="difflineminus">-  NS_IF_ADDREF(*oldPath = oldPathFile);</span>
<a href="#l6.1798"></a><span id="l6.1798" class="difflineminus">-  return rv;</span>
<a href="#l6.1799"></a><span id="l6.1799" class="difflineminus">-}</span>
<a href="#l6.1800"></a><span id="l6.1800" class="difflineminus">-</span>
<a href="#l6.1801"></a><span id="l6.1801" class="difflineminus">-nsresult nsDogbertProfileMigrator::SetPremigratedFilePref(const char *pref_name, nsILocalFile *pathFile)</span>
<a href="#l6.1802"></a><span id="l6.1802" class="difflineminus">-{</span>
<a href="#l6.1803"></a><span id="l6.1803" class="difflineminus">-  nsresult rv;</span>
<a href="#l6.1804"></a><span id="l6.1804" class="difflineminus">-</span>
<a href="#l6.1805"></a><span id="l6.1805" class="difflineminus">-  if (!pref_name) return NS_ERROR_FAILURE;</span>
<a href="#l6.1806"></a><span id="l6.1806" class="difflineminus">-</span>
<a href="#l6.1807"></a><span id="l6.1807" class="difflineminus">-  // save off the old pref, prefixed with &quot;premigration&quot;</span>
<a href="#l6.1808"></a><span id="l6.1808" class="difflineminus">-  // for example, we need the old &quot;mail.directory&quot; pref when</span>
<a href="#l6.1809"></a><span id="l6.1809" class="difflineminus">-  // migrating the copies and folder prefs in nsMsgAccountManager.cpp</span>
<a href="#l6.1810"></a><span id="l6.1810" class="difflineminus">-  //</span>
<a href="#l6.1811"></a><span id="l6.1811" class="difflineminus">-  // note we do this for all platforms.</span>
<a href="#l6.1812"></a><span id="l6.1812" class="difflineminus">-  char premigration_pref[MAX_PREF_LEN];</span>
<a href="#l6.1813"></a><span id="l6.1813" class="difflineminus">-  PR_snprintf(premigration_pref,MAX_PREF_LEN,&quot;%s%s&quot;,PREMIGRATION_PREFIX,pref_name);</span>
<a href="#l6.1814"></a><span id="l6.1814" class="difflineminus">-</span>
<a href="#l6.1815"></a><span id="l6.1815" class="difflineminus">-</span>
<a href="#l6.1816"></a><span id="l6.1816" class="difflineminus">-  PRBool exists = PR_FALSE;</span>
<a href="#l6.1817"></a><span id="l6.1817" class="difflineminus">-  pathFile-&gt;Exists(&amp;exists);</span>
<a href="#l6.1818"></a><span id="l6.1818" class="difflineminus">-</span>
<a href="#l6.1819"></a><span id="l6.1819" class="difflineminus">-  NS_ASSERTION(exists, &quot;the path does not exist.  see bug #55444&quot;);</span>
<a href="#l6.1820"></a><span id="l6.1820" class="difflineminus">-  if (!exists) return NS_OK;</span>
<a href="#l6.1821"></a><span id="l6.1821" class="difflineminus">-</span>
<a href="#l6.1822"></a><span id="l6.1822" class="difflineminus">-  rv = mPrefs-&gt;SetComplexValue((const char *)premigration_pref, NS_GET_IID(nsILocalFile), pathFile);</span>
<a href="#l6.1823"></a><span id="l6.1823" class="difflineminus">-	return rv;</span>
<a href="#l6.1824"></a><span id="l6.1824" class="difflineminus">-}</span>
<a href="#l6.1825"></a><span id="l6.1825" class="difflineminus">-</span>
<a href="#l6.1826"></a><span id="l6.1826" class="difflineminus">-nsresult nsDogbertProfileMigrator::ComputeSpaceRequirements(PRInt64 DriveArray[MAX_DRIVES],</span>
<a href="#l6.1827"></a><span id="l6.1827" class="difflineminus">-                                          PRUint32 SpaceReqArray[MAX_DRIVES],</span>
<a href="#l6.1828"></a><span id="l6.1828" class="difflineminus">-                                          PRInt64 Drive,</span>
<a href="#l6.1829"></a><span id="l6.1829" class="difflineminus">-                                          PRUint32 SpaceNeeded)</span>
<a href="#l6.1830"></a><span id="l6.1830" class="difflineminus">-{</span>
<a href="#l6.1831"></a><span id="l6.1831" class="difflineminus">-  int i=0;</span>
<a href="#l6.1832"></a><span id="l6.1832" class="difflineminus">-  PRFloat64 temp;</span>
<a href="#l6.1833"></a><span id="l6.1833" class="difflineminus">-</span>
<a href="#l6.1834"></a><span id="l6.1834" class="difflineminus">-  while(LL_NE(DriveArray[i],LL_Zero()) &amp;&amp; LL_NE(DriveArray[i], Drive) &amp;&amp; i &lt; MAX_DRIVES)</span>
<a href="#l6.1835"></a><span id="l6.1835" class="difflineminus">-    i++;</span>
<a href="#l6.1836"></a><span id="l6.1836" class="difflineminus">-</span>
<a href="#l6.1837"></a><span id="l6.1837" class="difflineminus">-  if (LL_EQ(DriveArray[i], LL_Zero()))</span>
<a href="#l6.1838"></a><span id="l6.1838" class="difflineminus">-  {</span>
<a href="#l6.1839"></a><span id="l6.1839" class="difflineminus">-    DriveArray[i] = Drive;</span>
<a href="#l6.1840"></a><span id="l6.1840" class="difflineminus">-    SpaceReqArray[i] += SpaceNeeded;</span>
<a href="#l6.1841"></a><span id="l6.1841" class="difflineminus">-  }</span>
<a href="#l6.1842"></a><span id="l6.1842" class="difflineminus">-  else if (LL_EQ(DriveArray[i], Drive))</span>
<a href="#l6.1843"></a><span id="l6.1843" class="difflineminus">-    SpaceReqArray[i] += SpaceNeeded;</span>
<a href="#l6.1844"></a><span id="l6.1844" class="difflineminus">-  else</span>
<a href="#l6.1845"></a><span id="l6.1845" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l6.1846"></a><span id="l6.1846" class="difflineminus">-</span>
<a href="#l6.1847"></a><span id="l6.1847" class="difflineminus">-  LL_L2F(temp, DriveArray[i]);</span>
<a href="#l6.1848"></a><span id="l6.1848" class="difflineminus">-  if (SpaceReqArray[i] &gt; temp)</span>
<a href="#l6.1849"></a><span id="l6.1849" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l6.1850"></a><span id="l6.1850" class="difflineminus">-</span>
<a href="#l6.1851"></a><span id="l6.1851" class="difflineminus">-  return NS_OK;</span>
<a href="#l6.1852"></a><span id="l6.1852" class="difflineminus">-}</span>
<a href="#l6.1853"></a><span id="l6.1853" class="difflineminus">-</span>
<a href="#l6.1854"></a><span id="l6.1854" class="difflineminus">-static PRBool</span>
<a href="#l6.1855"></a><span id="l6.1855" class="difflineminus">-nsCStringEndsWith(nsCString&amp; name, const char *ending)</span>
<a href="#l6.1856"></a><span id="l6.1856" class="difflineminus">-{</span>
<a href="#l6.1857"></a><span id="l6.1857" class="difflineminus">-  if (!ending || name.IsEmpty())</span>
<a href="#l6.1858"></a><span id="l6.1858" class="difflineminus">-    return PR_FALSE;</span>
<a href="#l6.1859"></a><span id="l6.1859" class="difflineminus">-</span>
<a href="#l6.1860"></a><span id="l6.1860" class="difflineminus">-  return StringTail(name, PL_strlen(ending)).Equals(nsDependentCString(ending));</span>
<a href="#l6.1861"></a><span id="l6.1861" class="difflineminus">-}</span>
<a href="#l6.1862"></a><span id="l6.1862" class="difflineminus">-</span>
<a href="#l6.1863"></a><span id="l6.1863" class="difflineminus">-#ifdef NEED_TO_COPY_AND_RENAME_NEWSRC_FILES</span>
<a href="#l6.1864"></a><span id="l6.1864" class="difflineminus">-static PRBool</span>
<a href="#l6.1865"></a><span id="l6.1865" class="difflineminus">-nsCStringStartsWith(nsCString&amp; name, const char *starting)</span>
<a href="#l6.1866"></a><span id="l6.1866" class="difflineminus">-{</span>
<a href="#l6.1867"></a><span id="l6.1867" class="difflineminus">-  if (!starting || name.IsEmpty())</span>
<a href="#l6.1868"></a><span id="l6.1868" class="difflineminus">-    return PR_FALSE;</span>
<a href="#l6.1869"></a><span id="l6.1869" class="difflineminus">-</span>
<a href="#l6.1870"></a><span id="l6.1870" class="difflineminus">-  return StringHead(name, PL_strlen(starting)).Equals(nsDependentCString(starting));</span>
<a href="#l6.1871"></a><span id="l6.1871" class="difflineminus">-}</span>
<a href="#l6.1872"></a><span id="l6.1872" class="difflineminus">-#endif</span>
<a href="#l6.1873"></a><span id="l6.1873" class="difflineminus">-</span>
<a href="#l6.1874"></a><span id="l6.1874" class="difflineminus">-////////////////////////////////////////////////////////////////////////</span>
<a href="#l6.1875"></a><span id="l6.1875" class="difflineminus">-// nsPrefConverter</span>
<a href="#l6.1876"></a><span id="l6.1876" class="difflineminus">-////////////////////////////////////////////////////////////////////////</span>
<a href="#l6.1877"></a><span id="l6.1877" class="difflineminus">-</span>
<a href="#l6.1878"></a><span id="l6.1878" class="difflineminus">-/*</span>
<a href="#l6.1879"></a><span id="l6.1879" class="difflineminus">-  these are the prefs we know we need to convert to utf8.</span>
<a href="#l6.1880"></a><span id="l6.1880" class="difflineminus">-  we'll also be converting:</span>
<a href="#l6.1881"></a><span id="l6.1881" class="difflineminus">-</span>
<a href="#l6.1882"></a><span id="l6.1882" class="difflineminus">-  Please make sure that any pref that contains native characters</span>
<a href="#l6.1883"></a><span id="l6.1883" class="difflineminus">-  in it's value is not included in this list as we do not want to</span>
<a href="#l6.1884"></a><span id="l6.1884" class="difflineminus">-  convert them into UTF-8 format. Prefs are being get and set in a</span>
<a href="#l6.1885"></a><span id="l6.1885" class="difflineminus">-  unicode format (FileXPref) now and there is no need for</span>
<a href="#l6.1886"></a><span id="l6.1886" class="difflineminus">-  conversion of those prefs.</span>
<a href="#l6.1887"></a><span id="l6.1887" class="difflineminus">-</span>
<a href="#l6.1888"></a><span id="l6.1888" class="difflineminus">- &quot;ldap_2.server.*.description&quot;</span>
<a href="#l6.1889"></a><span id="l6.1889" class="difflineminus">- &quot;intl.font*.fixed_font&quot;</span>
<a href="#l6.1890"></a><span id="l6.1890" class="difflineminus">- &quot;intl.font*.prop_font&quot;</span>
<a href="#l6.1891"></a><span id="l6.1891" class="difflineminus">- &quot;mail.identity.vcard.*&quot;</span>
<a href="#l6.1892"></a><span id="l6.1892" class="difflineminus">- */</span>
<a href="#l6.1893"></a><span id="l6.1893" class="difflineminus">-</span>
<a href="#l6.1894"></a><span id="l6.1894" class="difflineminus">-static const char *prefsToConvert[] = {</span>
<a href="#l6.1895"></a><span id="l6.1895" class="difflineminus">-      &quot;li.server.ldap.userbase&quot;,</span>
<a href="#l6.1896"></a><span id="l6.1896" class="difflineminus">-      &quot;mail.identity.organization&quot;,</span>
<a href="#l6.1897"></a><span id="l6.1897" class="difflineminus">-      &quot;mail.identity.username&quot;,</span>
<a href="#l6.1898"></a><span id="l6.1898" class="difflineminus">-      nsnull</span>
<a href="#l6.1899"></a><span id="l6.1899" class="difflineminus">-};</span>
<a href="#l6.1900"></a><span id="l6.1900" class="difflineminus">-</span>
<a href="#l6.1901"></a><span id="l6.1901" class="difflineminus">-nsPrefConverter::~nsPrefConverter()</span>
<a href="#l6.1902"></a><span id="l6.1902" class="difflineminus">-{}</span>
<a href="#l6.1903"></a><span id="l6.1903" class="difflineminus">-</span>
<a href="#l6.1904"></a><span id="l6.1904" class="difflineminus">-</span>
<a href="#l6.1905"></a><span id="l6.1905" class="difflineminus">-nsPrefConverter::nsPrefConverter()</span>
<a href="#l6.1906"></a><span id="l6.1906" class="difflineminus">-{}</span>
<a href="#l6.1907"></a><span id="l6.1907" class="difflineminus">-</span>
<a href="#l6.1908"></a><span id="l6.1908" class="difflineminus">-// Apply a charset conversion from the given charset to UTF-8 for the input C string.</span>
<a href="#l6.1909"></a><span id="l6.1909" class="difflineminus">-static nsresult ConvertStringToUTF8(const char* aCharset, const char* inString, char** outString)</span>
<a href="#l6.1910"></a><span id="l6.1910" class="difflineminus">-{</span>
<a href="#l6.1911"></a><span id="l6.1911" class="difflineminus">-  if (nsnull == outString)</span>
<a href="#l6.1912"></a><span id="l6.1912" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l6.1913"></a><span id="l6.1913" class="difflineminus">-</span>
<a href="#l6.1914"></a><span id="l6.1914" class="difflineminus">-  nsresult rv;</span>
<a href="#l6.1915"></a><span id="l6.1915" class="difflineminus">-  // convert result to unicode</span>
<a href="#l6.1916"></a><span id="l6.1916" class="difflineminus">-  nsCOMPtr&lt;nsICharsetConverterManager&gt; ccm = do_GetService(NS_CHARSETCONVERTERMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l6.1917"></a><span id="l6.1917" class="difflineminus">-</span>
<a href="#l6.1918"></a><span id="l6.1918" class="difflineminus">-  if(NS_SUCCEEDED(rv)) {</span>
<a href="#l6.1919"></a><span id="l6.1919" class="difflineminus">-    nsCOMPtr &lt;nsIUnicodeDecoder&gt; decoder; // this may be cached</span>
<a href="#l6.1920"></a><span id="l6.1920" class="difflineminus">-</span>
<a href="#l6.1921"></a><span id="l6.1921" class="difflineminus">-    rv = ccm-&gt;GetUnicodeDecoderRaw(aCharset, getter_AddRefs(decoder));</span>
<a href="#l6.1922"></a><span id="l6.1922" class="difflineminus">-    if(NS_SUCCEEDED(rv) &amp;&amp; decoder) {</span>
<a href="#l6.1923"></a><span id="l6.1923" class="difflineminus">-      PRInt32 uniLength = 0;</span>
<a href="#l6.1924"></a><span id="l6.1924" class="difflineminus">-      PRInt32 srcLength = strlen(inString);</span>
<a href="#l6.1925"></a><span id="l6.1925" class="difflineminus">-      rv = decoder-&gt;GetMaxLength(inString, srcLength, &amp;uniLength);</span>
<a href="#l6.1926"></a><span id="l6.1926" class="difflineminus">-      if (NS_SUCCEEDED(rv)) {</span>
<a href="#l6.1927"></a><span id="l6.1927" class="difflineminus">-        PRUnichar *unichars = new PRUnichar [uniLength];</span>
<a href="#l6.1928"></a><span id="l6.1928" class="difflineminus">-</span>
<a href="#l6.1929"></a><span id="l6.1929" class="difflineminus">-        if (nsnull != unichars) {</span>
<a href="#l6.1930"></a><span id="l6.1930" class="difflineminus">-          // convert to unicode</span>
<a href="#l6.1931"></a><span id="l6.1931" class="difflineminus">-          rv = decoder-&gt;Convert(inString, &amp;srcLength, unichars, &amp;uniLength);</span>
<a href="#l6.1932"></a><span id="l6.1932" class="difflineminus">-          if (NS_SUCCEEDED(rv)) {</span>
<a href="#l6.1933"></a><span id="l6.1933" class="difflineminus">-            nsAutoString aString;</span>
<a href="#l6.1934"></a><span id="l6.1934" class="difflineminus">-            aString.Assign(unichars, uniLength);</span>
<a href="#l6.1935"></a><span id="l6.1935" class="difflineminus">-            // convert to UTF-8</span>
<a href="#l6.1936"></a><span id="l6.1936" class="difflineminus">-            *outString = ToNewUTF8String(aString);</span>
<a href="#l6.1937"></a><span id="l6.1937" class="difflineminus">-          }</span>
<a href="#l6.1938"></a><span id="l6.1938" class="difflineminus">-          delete [] unichars;</span>
<a href="#l6.1939"></a><span id="l6.1939" class="difflineminus">-        }</span>
<a href="#l6.1940"></a><span id="l6.1940" class="difflineminus">-        else {</span>
<a href="#l6.1941"></a><span id="l6.1941" class="difflineminus">-          rv = NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l6.1942"></a><span id="l6.1942" class="difflineminus">-        }</span>
<a href="#l6.1943"></a><span id="l6.1943" class="difflineminus">-      }</span>
<a href="#l6.1944"></a><span id="l6.1944" class="difflineminus">-    }</span>
<a href="#l6.1945"></a><span id="l6.1945" class="difflineminus">-  }</span>
<a href="#l6.1946"></a><span id="l6.1946" class="difflineminus">-</span>
<a href="#l6.1947"></a><span id="l6.1947" class="difflineminus">-  return rv;</span>
<a href="#l6.1948"></a><span id="l6.1948" class="difflineminus">-}</span>
<a href="#l6.1949"></a><span id="l6.1949" class="difflineminus">-</span>
<a href="#l6.1950"></a><span id="l6.1950" class="difflineminus">-nsresult ConvertPrefToUTF8(const char *prefname, nsIPrefBranch *prefs, const char* charSet)</span>
<a href="#l6.1951"></a><span id="l6.1951" class="difflineminus">-{</span>
<a href="#l6.1952"></a><span id="l6.1952" class="difflineminus">-  nsresult rv;</span>
<a href="#l6.1953"></a><span id="l6.1953" class="difflineminus">-</span>
<a href="#l6.1954"></a><span id="l6.1954" class="difflineminus">-  if (!prefname || !prefs) return NS_ERROR_FAILURE;</span>
<a href="#l6.1955"></a><span id="l6.1955" class="difflineminus">-  nsCString prefval;</span>
<a href="#l6.1956"></a><span id="l6.1956" class="difflineminus">-</span>
<a href="#l6.1957"></a><span id="l6.1957" class="difflineminus">-  rv = prefs-&gt;GetCharPref(prefname, getter_Copies(prefval));</span>
<a href="#l6.1958"></a><span id="l6.1958" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.1959"></a><span id="l6.1959" class="difflineminus">-</span>
<a href="#l6.1960"></a><span id="l6.1960" class="difflineminus">-  if (prefval.IsEmpty())</span>
<a href="#l6.1961"></a><span id="l6.1961" class="difflineminus">-    return NS_OK;</span>
<a href="#l6.1962"></a><span id="l6.1962" class="difflineminus">-</span>
<a href="#l6.1963"></a><span id="l6.1963" class="difflineminus">-  nsCString outval;</span>
<a href="#l6.1964"></a><span id="l6.1964" class="difflineminus">-  rv = ConvertStringToUTF8(charSet, prefval.get(), getter_Copies(outval));</span>
<a href="#l6.1965"></a><span id="l6.1965" class="difflineminus">-  // only set the pref if the conversion worked, and it convert to something non null</span>
<a href="#l6.1966"></a><span id="l6.1966" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; !outval.IsEmpty())</span>
<a href="#l6.1967"></a><span id="l6.1967" class="difflineminus">-    rv = prefs-&gt;SetCharPref(prefname, outval.get());</span>
<a href="#l6.1968"></a><span id="l6.1968" class="difflineminus">-  return NS_OK;</span>
<a href="#l6.1969"></a><span id="l6.1969" class="difflineminus">-}</span>
<a href="#l6.1970"></a><span id="l6.1970" class="difflineminus">-</span>
<a href="#l6.1971"></a><span id="l6.1971" class="difflineminus">-static PRBool charEndsWith(const char *str, const char *endStr)</span>
<a href="#l6.1972"></a><span id="l6.1972" class="difflineminus">-{</span>
<a href="#l6.1973"></a><span id="l6.1973" class="difflineminus">-  PRUint32 endStrLen = PL_strlen(endStr);</span>
<a href="#l6.1974"></a><span id="l6.1974" class="difflineminus">-  PRUint32 strLen = PL_strlen(str);</span>
<a href="#l6.1975"></a><span id="l6.1975" class="difflineminus">-</span>
<a href="#l6.1976"></a><span id="l6.1976" class="difflineminus">-  if (strLen &lt; endStrLen) return PR_FALSE;</span>
<a href="#l6.1977"></a><span id="l6.1977" class="difflineminus">-</span>
<a href="#l6.1978"></a><span id="l6.1978" class="difflineminus">-  PRUint32 pos = strLen - endStrLen;</span>
<a href="#l6.1979"></a><span id="l6.1979" class="difflineminus">-  if (PL_strncmp(str + pos, endStr, endStrLen) == 0)</span>
<a href="#l6.1980"></a><span id="l6.1980" class="difflineminus">-    return PR_TRUE;</span>
<a href="#l6.1981"></a><span id="l6.1981" class="difflineminus">-  else</span>
<a href="#l6.1982"></a><span id="l6.1982" class="difflineminus">-    return PR_FALSE;</span>
<a href="#l6.1983"></a><span id="l6.1983" class="difflineminus">-}</span>
<a href="#l6.1984"></a><span id="l6.1984" class="difflineminus">-</span>
<a href="#l6.1985"></a><span id="l6.1985" class="difflineminus">-static void getFontPrefs(nsIPrefBranch *prefs, nsCStringArray *data)</span>
<a href="#l6.1986"></a><span id="l6.1986" class="difflineminus">-{</span>
<a href="#l6.1987"></a><span id="l6.1987" class="difflineminus">-  PRUint32 count, i;</span>
<a href="#l6.1988"></a><span id="l6.1988" class="difflineminus">-  char** childPrefs;</span>
<a href="#l6.1989"></a><span id="l6.1989" class="difflineminus">-  prefs-&gt;GetChildList(&quot;intl.font&quot;, &amp;count, &amp;childPrefs);</span>
<a href="#l6.1990"></a><span id="l6.1990" class="difflineminus">-</span>
<a href="#l6.1991"></a><span id="l6.1991" class="difflineminus">-  for (i = 0; i &lt; count; ++i)</span>
<a href="#l6.1992"></a><span id="l6.1992" class="difflineminus">-  {</span>
<a href="#l6.1993"></a><span id="l6.1993" class="difflineminus">-    if (charEndsWith(childPrefs[i], &quot;.fixed_font&quot;) || charEndsWith(childPrefs[i], &quot;.prop_font&quot;))</span>
<a href="#l6.1994"></a><span id="l6.1994" class="difflineminus">-      data-&gt;AppendCString(nsDependentCString(childPrefs[i]));</span>
<a href="#l6.1995"></a><span id="l6.1995" class="difflineminus">-  }</span>
<a href="#l6.1996"></a><span id="l6.1996" class="difflineminus">-</span>
<a href="#l6.1997"></a><span id="l6.1997" class="difflineminus">-  NS_FREE_XPCOM_ALLOCATED_POINTER_ARRAY(count, childPrefs);</span>
<a href="#l6.1998"></a><span id="l6.1998" class="difflineminus">-}</span>
<a href="#l6.1999"></a><span id="l6.1999" class="difflineminus">-</span>
<a href="#l6.2000"></a><span id="l6.2000" class="difflineminus">-static void getLdapPrefs(nsIPrefBranch *prefs, nsCStringArray *data)</span>
<a href="#l6.2001"></a><span id="l6.2001" class="difflineminus">-{</span>
<a href="#l6.2002"></a><span id="l6.2002" class="difflineminus">-  PRUint32 count, i;</span>
<a href="#l6.2003"></a><span id="l6.2003" class="difflineminus">-  char** childPrefs;</span>
<a href="#l6.2004"></a><span id="l6.2004" class="difflineminus">-  prefs-&gt;GetChildList(&quot;ldap_2.servers&quot;, &amp;count, &amp;childPrefs);</span>
<a href="#l6.2005"></a><span id="l6.2005" class="difflineminus">-</span>
<a href="#l6.2006"></a><span id="l6.2006" class="difflineminus">-  for (i = 0; i &lt; count; ++i)</span>
<a href="#l6.2007"></a><span id="l6.2007" class="difflineminus">-  {</span>
<a href="#l6.2008"></a><span id="l6.2008" class="difflineminus">-    // we only want to convert &quot;ldap_2.servers.*.description&quot;</span>
<a href="#l6.2009"></a><span id="l6.2009" class="difflineminus">-    if (charEndsWith(childPrefs[i], &quot;.description&quot;))</span>
<a href="#l6.2010"></a><span id="l6.2010" class="difflineminus">-      data-&gt;AppendCString(nsDependentCString(childPrefs[i]));</span>
<a href="#l6.2011"></a><span id="l6.2011" class="difflineminus">-  }</span>
<a href="#l6.2012"></a><span id="l6.2012" class="difflineminus">-</span>
<a href="#l6.2013"></a><span id="l6.2013" class="difflineminus">-  NS_FREE_XPCOM_ALLOCATED_POINTER_ARRAY(count, childPrefs);</span>
<a href="#l6.2014"></a><span id="l6.2014" class="difflineminus">-}</span>
<a href="#l6.2015"></a><span id="l6.2015" class="difflineminus">-</span>
<a href="#l6.2016"></a><span id="l6.2016" class="difflineminus">-static void getVCardPrefs(nsIPrefBranch *prefs, nsCStringArray *data)</span>
<a href="#l6.2017"></a><span id="l6.2017" class="difflineminus">-{</span>
<a href="#l6.2018"></a><span id="l6.2018" class="difflineminus">-  PRUint32 count, i;</span>
<a href="#l6.2019"></a><span id="l6.2019" class="difflineminus">-  char** childPrefs;</span>
<a href="#l6.2020"></a><span id="l6.2020" class="difflineminus">-  prefs-&gt;GetChildList(&quot;mail.identity.vcard&quot;, &amp;count, &amp;childPrefs);</span>
<a href="#l6.2021"></a><span id="l6.2021" class="difflineminus">-</span>
<a href="#l6.2022"></a><span id="l6.2022" class="difflineminus">-  // the 4.x vCard prefs might need converting</span>
<a href="#l6.2023"></a><span id="l6.2023" class="difflineminus">-  for (i = 0; i &lt; count; ++i)</span>
<a href="#l6.2024"></a><span id="l6.2024" class="difflineminus">-    data-&gt;AppendCString(nsDependentCString(childPrefs[i]));</span>
<a href="#l6.2025"></a><span id="l6.2025" class="difflineminus">-</span>
<a href="#l6.2026"></a><span id="l6.2026" class="difflineminus">-  NS_FREE_XPCOM_ALLOCATED_POINTER_ARRAY(count, childPrefs);</span>
<a href="#l6.2027"></a><span id="l6.2027" class="difflineminus">-}</span>
<a href="#l6.2028"></a><span id="l6.2028" class="difflineminus">-</span>
<a href="#l6.2029"></a><span id="l6.2029" class="difflineminus">-typedef struct {</span>
<a href="#l6.2030"></a><span id="l6.2030" class="difflineminus">-    nsIPrefBranch *prefs;</span>
<a href="#l6.2031"></a><span id="l6.2031" class="difflineminus">-    const char* charSet;</span>
<a href="#l6.2032"></a><span id="l6.2032" class="difflineminus">-} PrefEnumerationClosure;</span>
<a href="#l6.2033"></a><span id="l6.2033" class="difflineminus">-</span>
<a href="#l6.2034"></a><span id="l6.2034" class="difflineminus">-PRBool convertPref(nsCString &amp;aElement, void *aData)</span>
<a href="#l6.2035"></a><span id="l6.2035" class="difflineminus">-{</span>
<a href="#l6.2036"></a><span id="l6.2036" class="difflineminus">-  PrefEnumerationClosure *closure;</span>
<a href="#l6.2037"></a><span id="l6.2037" class="difflineminus">-  closure = (PrefEnumerationClosure *)aData;</span>
<a href="#l6.2038"></a><span id="l6.2038" class="difflineminus">-</span>
<a href="#l6.2039"></a><span id="l6.2039" class="difflineminus">-  ConvertPrefToUTF8(aElement.get(), closure-&gt;prefs, closure-&gt;charSet);</span>
<a href="#l6.2040"></a><span id="l6.2040" class="difflineminus">-  return PR_TRUE;</span>
<a href="#l6.2041"></a><span id="l6.2041" class="difflineminus">-}</span>
<a href="#l6.2042"></a><span id="l6.2042" class="difflineminus">-</span>
<a href="#l6.2043"></a><span id="l6.2043" class="difflineminus">-nsresult nsPrefConverter::ConvertPrefsToUTF8()</span>
<a href="#l6.2044"></a><span id="l6.2044" class="difflineminus">-{</span>
<a href="#l6.2045"></a><span id="l6.2045" class="difflineminus">-  nsresult rv;</span>
<a href="#l6.2046"></a><span id="l6.2046" class="difflineminus">-</span>
<a href="#l6.2047"></a><span id="l6.2047" class="difflineminus">-  nsCStringArray prefsToMigrate;</span>
<a href="#l6.2048"></a><span id="l6.2048" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; prefs(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l6.2049"></a><span id="l6.2049" class="difflineminus">-</span>
<a href="#l6.2050"></a><span id="l6.2050" class="difflineminus">-  if(NS_FAILED(rv)) return rv;</span>
<a href="#l6.2051"></a><span id="l6.2051" class="difflineminus">-</span>
<a href="#l6.2052"></a><span id="l6.2052" class="difflineminus">-  nsCAutoString charSet;</span>
<a href="#l6.2053"></a><span id="l6.2053" class="difflineminus">-  rv = GetPlatformCharset(charSet);</span>
<a href="#l6.2054"></a><span id="l6.2054" class="difflineminus">-</span>
<a href="#l6.2055"></a><span id="l6.2055" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.2056"></a><span id="l6.2056" class="difflineminus">-</span>
<a href="#l6.2057"></a><span id="l6.2057" class="difflineminus">-  for (PRUint32 i = 0; prefsToConvert[i]; i++) {</span>
<a href="#l6.2058"></a><span id="l6.2058" class="difflineminus">-    nsCString prefnameStr( prefsToConvert[i] );</span>
<a href="#l6.2059"></a><span id="l6.2059" class="difflineminus">-    prefsToMigrate.AppendCString(prefnameStr);</span>
<a href="#l6.2060"></a><span id="l6.2060" class="difflineminus">-  }</span>
<a href="#l6.2061"></a><span id="l6.2061" class="difflineminus">-</span>
<a href="#l6.2062"></a><span id="l6.2062" class="difflineminus">-  getFontPrefs(prefs, &amp;prefsToMigrate);</span>
<a href="#l6.2063"></a><span id="l6.2063" class="difflineminus">-  getLdapPrefs(prefs, &amp;prefsToMigrate);</span>
<a href="#l6.2064"></a><span id="l6.2064" class="difflineminus">-  getVCardPrefs(prefs, &amp;prefsToMigrate);</span>
<a href="#l6.2065"></a><span id="l6.2065" class="difflineminus">-</span>
<a href="#l6.2066"></a><span id="l6.2066" class="difflineminus">-  PrefEnumerationClosure closure;</span>
<a href="#l6.2067"></a><span id="l6.2067" class="difflineminus">-</span>
<a href="#l6.2068"></a><span id="l6.2068" class="difflineminus">-  closure.prefs = prefs;</span>
<a href="#l6.2069"></a><span id="l6.2069" class="difflineminus">-  closure.charSet = charSet.get();</span>
<a href="#l6.2070"></a><span id="l6.2070" class="difflineminus">-</span>
<a href="#l6.2071"></a><span id="l6.2071" class="difflineminus">-  prefsToMigrate.EnumerateForwards((nsCStringArrayEnumFunc)convertPref, (void *)(&amp;closure));</span>
<a href="#l6.2072"></a><span id="l6.2072" class="difflineminus">-</span>
<a href="#l6.2073"></a><span id="l6.2073" class="difflineminus">-  rv = prefs-&gt;SetBoolPref(&quot;prefs.converted-to-utf8&quot;,PR_TRUE);</span>
<a href="#l6.2074"></a><span id="l6.2074" class="difflineminus">-  return NS_OK;</span>
<a href="#l6.2075"></a><span id="l6.2075" class="difflineminus">-}</span>
<a href="#l6.2076"></a><span id="l6.2076" class="difflineminus">-</span>
<a href="#l6.2077"></a><span id="l6.2077" class="difflineminus">-// A wrapper function to call the interface to get a platform file charset.</span>
<a href="#l6.2078"></a><span id="l6.2078" class="difflineminus">-nsresult</span>
<a href="#l6.2079"></a><span id="l6.2079" class="difflineminus">-nsPrefConverter::GetPlatformCharset(nsCString&amp; aCharset)</span>
<a href="#l6.2080"></a><span id="l6.2080" class="difflineminus">-{</span>
<a href="#l6.2081"></a><span id="l6.2081" class="difflineminus">-  nsresult rv;</span>
<a href="#l6.2082"></a><span id="l6.2082" class="difflineminus">-</span>
<a href="#l6.2083"></a><span id="l6.2083" class="difflineminus">-  // we may cache it since the platform charset will not change through application life</span>
<a href="#l6.2084"></a><span id="l6.2084" class="difflineminus">-  nsCOMPtr &lt;nsIPlatformCharset&gt; platformCharset = do_GetService(NS_PLATFORMCHARSET_CONTRACTID, &amp;rv);</span>
<a href="#l6.2085"></a><span id="l6.2085" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; platformCharset)</span>
<a href="#l6.2086"></a><span id="l6.2086" class="difflineminus">-   rv = platformCharset-&gt;GetCharset(kPlatformCharsetSel_4xPrefsJS, aCharset);</span>
<a href="#l6.2087"></a><span id="l6.2087" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l6.2088"></a><span id="l6.2088" class="difflineminus">-   aCharset.Assign(NS_LITERAL_CSTRING(&quot;ISO-8859-1&quot;));  // use ISO-8859-1 in case of any error</span>
<a href="#l6.2089"></a><span id="l6.2089" class="difflineminus">-</span>
<a href="#l6.2090"></a><span id="l6.2090" class="difflineminus">-  return rv;</span>
<a href="#l6.2091"></a><span id="l6.2091" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1">deleted file mode 100644</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineminus">--- a/mail/components/migration/src/nsDogbertProfileMigrator.h</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineplus">+++ /dev/null</span>
<a href="#l7.4"></a><span id="l7.4" class="difflineat">@@ -1,170 +0,0 @@</span>
<a href="#l7.5"></a><span id="l7.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l7.6"></a><span id="l7.6" class="difflineminus">-/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l7.7"></a><span id="l7.7" class="difflineminus">- * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l7.8"></a><span id="l7.8" class="difflineminus">- *</span>
<a href="#l7.9"></a><span id="l7.9" class="difflineminus">- * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l7.10"></a><span id="l7.10" class="difflineminus">- * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l7.11"></a><span id="l7.11" class="difflineminus">- * the License. You may obtain a copy of the License at</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">- * http://www.mozilla.org/MPL/</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">- *</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineminus">- * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineminus">- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineminus">- * for the specific language governing rights and limitations under the</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineminus">- * License.</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineminus">- *</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineminus">- * The Original Code is The Communicator 4.x Mail Migrator Code</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineminus">- *</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineminus">- * The Initial Developer of the Original Code is Scott MacGregor.</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineminus">- * Portions created by the Initial Developer are Copyright (C) 2004</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineminus">- * the Initial Developer. All Rights Reserved.</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineminus">- *</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineminus">- * Contributor(s):</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineminus">- *  Scott MacGregor &lt;mscott@mozilla.org&gt;</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineminus">- *</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineminus">- * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineminus">- * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineminus">- * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">- * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineminus">- * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineminus">- * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineminus">- * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineminus">- * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineminus">- * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineminus">- * the provisions above, a recipient may use your version of this file under</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineminus">- * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineminus">- *</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineminus">- * ***** END LICENSE BLOCK ***** */</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineminus">-</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineminus">-#ifndef dogbertprofilemigrator___h___</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineminus">-#define dogbertprofilemigrator___h___</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineminus">-</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineminus">-#include &quot;nsIMailProfileMigrator.h&quot;</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineminus">-#include &quot;nsILocalFile.h&quot;</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineminus">-#include &quot;nsIMutableArray.h&quot;</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineminus">-#include &quot;nsNetscapeProfileMigratorBase.h&quot;</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineminus">-</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineminus">-#include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineminus">-</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineminus">-class nsIFile;</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineminus">-</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineminus">-// ripped off from nsPrefMigration, warts and all</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineminus">-</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineminus">-#define MIGRATION_SUCCESS    0</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineminus">-#define MIGRATION_RETRY      1</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineminus">-#define MIGRATION_CANCEL     2</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineminus">-#define MIGRATION_CREATE_NEW 3</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineminus">-</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineminus">-#define MAX_DRIVES 4</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineminus">-</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineminus">-//Interfaces Needed</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineminus">-</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineminus">-#ifdef XP_MACOSX</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineminus">-#define IMAP_MAIL_FILTER_FILE_NAME_FORMAT_IN_4x &quot;%s Rules&quot; </span>
<a href="#l7.67"></a><span id="l7.67" class="difflineminus">-#endif</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineminus">-</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineminus">-#if defined(XP_UNIX) &amp;&amp; !defined(XP_MACOSX)</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineminus">-#define NEED_TO_COPY_AND_RENAME_NEWSRC_FILES</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineminus">-#endif</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineminus">-</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineminus">-class nsPrefConverter</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineminus">-{</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineminus">-public:</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineminus">-  nsPrefConverter();</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineminus">-  virtual ~nsPrefConverter();</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineminus">-  nsresult ConvertPrefsToUTF8();</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineminus">-  nsresult GetPlatformCharset(nsCString&amp; aCharset);</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineminus">-};</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineminus">-</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineminus">-class nsDogbertProfileMigrator :   public nsNetscapeProfileMigratorBase</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineminus">-{</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineminus">-public:</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineminus">-  NS_DECL_ISUPPORTS</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineminus">-</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineminus">-  nsDogbertProfileMigrator();</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineminus">-  virtual ~nsDogbertProfileMigrator();</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineminus">-</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineminus">-  // nsIMailProfileMigrator methods</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineminus">-  NS_IMETHOD Migrate(PRUint16 aItems, nsIProfileStartup* aStartup,</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineminus">-                        const PRUnichar* aProfile);</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineminus">-  NS_IMETHOD GetMigrateData(const PRUnichar* aProfile, PRBool aReplace,</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineminus">-                            PRUint16* aResult);</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineminus">-  NS_IMETHOD GetSourceProfiles(nsIArray** aResult);</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineminus">-</span>
<a href="#l7.97"></a><span id="l7.97" class="difflineminus">-protected:</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineminus">-  void GetSourceProfile(const PRUnichar* aProfile);</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineminus">-</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineminus">-  nsresult CopyPreferences();</span>
<a href="#l7.101"></a><span id="l7.101" class="difflineminus">-</span>
<a href="#l7.102"></a><span id="l7.102" class="difflineminus">-private:</span>
<a href="#l7.103"></a><span id="l7.103" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; mProfiles;</span>
<a href="#l7.104"></a><span id="l7.104" class="difflineminus">-</span>
<a href="#l7.105"></a><span id="l7.105" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; mPrefs;</span>
<a href="#l7.106"></a><span id="l7.106" class="difflineminus">-  nsCOMPtr&lt;nsILocalFile&gt; m_prefsFile;</span>
<a href="#l7.107"></a><span id="l7.107" class="difflineminus">-protected:</span>
<a href="#l7.108"></a><span id="l7.108" class="difflineminus">-  nsresult ProcessPrefsCallback(const char* oldProfilePathStr, const char * newProfilePathStr);</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineminus">-  nsresult ConvertPersistentStringToFile(const char *str, nsILocalFile *path);</span>
<a href="#l7.110"></a><span id="l7.110" class="difflineminus">-  nsresult CreateNewUser5Tree(nsILocalFile* oldProfilePath, </span>
<a href="#l7.111"></a><span id="l7.111" class="difflineminus">-                              nsILocalFile* newProfilePath);</span>
<a href="#l7.112"></a><span id="l7.112" class="difflineminus">-</span>
<a href="#l7.113"></a><span id="l7.113" class="difflineminus">-  nsresult GetDirFromPref(nsILocalFile* oldProfilePath,</span>
<a href="#l7.114"></a><span id="l7.114" class="difflineminus">-                          nsILocalFile* newProfilePath, </span>
<a href="#l7.115"></a><span id="l7.115" class="difflineminus">-                          const char* newDirName,</span>
<a href="#l7.116"></a><span id="l7.116" class="difflineminus">-                          const char* pref, </span>
<a href="#l7.117"></a><span id="l7.117" class="difflineminus">-                          nsILocalFile** newPath, </span>
<a href="#l7.118"></a><span id="l7.118" class="difflineminus">-                          nsILocalFile** oldPath);</span>
<a href="#l7.119"></a><span id="l7.119" class="difflineminus">-</span>
<a href="#l7.120"></a><span id="l7.120" class="difflineminus">-  nsresult GetSizes(nsILocalFile *inputPath,</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineminus">-                    PRBool readSubdirs,</span>
<a href="#l7.122"></a><span id="l7.122" class="difflineminus">-                    PRInt64* sizeTotal);</span>
<a href="#l7.123"></a><span id="l7.123" class="difflineminus">-</span>
<a href="#l7.124"></a><span id="l7.124" class="difflineminus">-  nsresult ComputeSpaceRequirements(PRInt64 DriveArray[], </span>
<a href="#l7.125"></a><span id="l7.125" class="difflineminus">-                                    PRUint32 SpaceReqArray[], </span>
<a href="#l7.126"></a><span id="l7.126" class="difflineminus">-                                    PRInt64 Drive, </span>
<a href="#l7.127"></a><span id="l7.127" class="difflineminus">-                                    PRUint32 SpaceNeeded);</span>
<a href="#l7.128"></a><span id="l7.128" class="difflineminus">-</span>
<a href="#l7.129"></a><span id="l7.129" class="difflineminus">-  nsresult DoTheCopy(nsIFile *oldPath, </span>
<a href="#l7.130"></a><span id="l7.130" class="difflineminus">-                     nsIFile *newPath,</span>
<a href="#l7.131"></a><span id="l7.131" class="difflineminus">-                     PRBool readSubdirs); </span>
<a href="#l7.132"></a><span id="l7.132" class="difflineminus">-  nsresult DoTheCopy(nsILocalFile *oldPath,</span>
<a href="#l7.133"></a><span id="l7.133" class="difflineminus">-                     nsILocalFile *newPath,</span>
<a href="#l7.134"></a><span id="l7.134" class="difflineminus">-                     const char *fileOrDirName,</span>
<a href="#l7.135"></a><span id="l7.135" class="difflineminus">-                     PRBool isDirectory = PR_FALSE);</span>
<a href="#l7.136"></a><span id="l7.136" class="difflineminus">-</span>
<a href="#l7.137"></a><span id="l7.137" class="difflineminus">-  nsresult DoTheCopyAndRename(nsIFile *oldPath, </span>
<a href="#l7.138"></a><span id="l7.138" class="difflineminus">-                          nsIFile *newPath,</span>
<a href="#l7.139"></a><span id="l7.139" class="difflineminus">-                          PRBool readSubdirs,</span>
<a href="#l7.140"></a><span id="l7.140" class="difflineminus">-                          PRBool needToRenameFiles,</span>
<a href="#l7.141"></a><span id="l7.141" class="difflineminus">-                          const char *oldName,</span>
<a href="#l7.142"></a><span id="l7.142" class="difflineminus">-                          const char *newName); </span>
<a href="#l7.143"></a><span id="l7.143" class="difflineminus">-  nsresult DoTheCopyAndRename(nsIFile *aPath, </span>
<a href="#l7.144"></a><span id="l7.144" class="difflineminus">-                          PRBool aReadSubdirs,</span>
<a href="#l7.145"></a><span id="l7.145" class="difflineminus">-                          const char *aOldName,</span>
<a href="#l7.146"></a><span id="l7.146" class="difflineminus">-                          const char *aNewName);</span>
<a href="#l7.147"></a><span id="l7.147" class="difflineminus">-  nsresult CopyFilesByPattern(nsILocalFile * oldPath,</span>
<a href="#l7.148"></a><span id="l7.148" class="difflineminus">-                          nsILocalFile * newPath,</span>
<a href="#l7.149"></a><span id="l7.149" class="difflineminus">-                          const char *pattern);</span>
<a href="#l7.150"></a><span id="l7.150" class="difflineminus">-</span>
<a href="#l7.151"></a><span id="l7.151" class="difflineminus">-  nsresult AddFileCopyToList(nsIFile * aOldPath, nsIFile * aNewPath, const char * newFileName);</span>
<a href="#l7.152"></a><span id="l7.152" class="difflineminus">-</span>
<a href="#l7.153"></a><span id="l7.153" class="difflineminus">-#ifdef NEED_TO_COPY_AND_RENAME_NEWSRC_FILES</span>
<a href="#l7.154"></a><span id="l7.154" class="difflineminus">-  nsresult CopyAndRenameNewsrcFiles(nsILocalFile *newPath);</span>
<a href="#l7.155"></a><span id="l7.155" class="difflineminus">-#endif /* NEED_TO_COPY_AND_RENAME_NEWSRC_FILES */</span>
<a href="#l7.156"></a><span id="l7.156" class="difflineminus">-</span>
<a href="#l7.157"></a><span id="l7.157" class="difflineminus">-  nsresult DoSpecialUpdates(nsILocalFile * profilePath);</span>
<a href="#l7.158"></a><span id="l7.158" class="difflineminus">-  nsresult Rename4xFileAfterMigration(nsIFile *profilePath, const char *oldFileName, const char *newFileName);</span>
<a href="#l7.159"></a><span id="l7.159" class="difflineminus">-#ifdef IMAP_MAIL_FILTER_FILE_NAME_FORMAT_IN_4x</span>
<a href="#l7.160"></a><span id="l7.160" class="difflineminus">-  nsresult RenameAndMove4xImapFilterFile(nsILocalFile *profilePath, const char *hostname);</span>
<a href="#l7.161"></a><span id="l7.161" class="difflineminus">-  nsresult RenameAndMove4xImapFilterFiles(nsILocalFile *profilePath);</span>
<a href="#l7.162"></a><span id="l7.162" class="difflineminus">-#endif /* IMAP_MAIL_FILTER_FILE_NAME_FORMAT_IN_4x */</span>
<a href="#l7.163"></a><span id="l7.163" class="difflineminus">-  nsresult RenameAndMove4xPopStateFile(nsILocalFile *profilePath);</span>
<a href="#l7.164"></a><span id="l7.164" class="difflineminus">-  nsresult RenameAndMove4xPopFilterFile(nsILocalFile *profilePath);</span>
<a href="#l7.165"></a><span id="l7.165" class="difflineminus">-  nsresult RenameAndMove4xPopFile(nsILocalFile * profilePath, const char *fileNameIn4x, const char *fileNameIn5x);</span>
<a href="#l7.166"></a><span id="l7.166" class="difflineminus">-  </span>
<a href="#l7.167"></a><span id="l7.167" class="difflineminus">-  nsresult DetermineOldPath(nsILocalFile *profilePath, const char *oldPathName, const char *oldPathEntityName, nsILocalFile *oldPath);</span>
<a href="#l7.168"></a><span id="l7.168" class="difflineminus">-  nsresult SetPremigratedFilePref(const char *pref_name, nsILocalFile *filePath);</span>
<a href="#l7.169"></a><span id="l7.169" class="difflineminus">-#ifdef NEED_TO_COPY_AND_RENAME_NEWSRC_FILES</span>
<a href="#l7.170"></a><span id="l7.170" class="difflineminus">-  nsresult GetPremigratedFilePref(const char *pref_name, nsILocalFile **filePath);</span>
<a href="#l7.171"></a><span id="l7.171" class="difflineminus">-#endif /* NEED_TO_COPY_AND_RENAME_NEWSRC_FILES */</span>
<a href="#l7.172"></a><span id="l7.172" class="difflineminus">-};</span>
<a href="#l7.173"></a><span id="l7.173" class="difflineminus">-</span>
<a href="#l7.174"></a><span id="l7.174" class="difflineminus">-#endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mail/components/migration/src/nsProfileMigrator.cpp</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mail/components/migration/src/nsProfileMigrator.cpp</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -111,17 +111,16 @@ nsProfileMigrator::Migrate(nsIProfileSta</span>
<a href="#l8.4"></a><span id="l8.4"> #ifdef XP_WIN</span>
<a href="#l8.5"></a><span id="l8.5"> typedef struct {</span>
<a href="#l8.6"></a><span id="l8.6">   WORD wLanguage;</span>
<a href="#l8.7"></a><span id="l8.7">   WORD wCodePage;</span>
<a href="#l8.8"></a><span id="l8.8"> } LANGANDCODEPAGE;</span>
<a href="#l8.9"></a><span id="l8.9"> </span>
<a href="#l8.10"></a><span id="l8.10"> #define INTERNAL_NAME_THUNDERBIRD     &quot;Thunderbird&quot;</span>
<a href="#l8.11"></a><span id="l8.11"> #define INTERNAL_NAME_SEAMONKEY       &quot;Mozilla&quot;</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-#define INTERNAL_NAME_DOGBERT         &quot;Netscape Messenger&quot;</span>
<a href="#l8.13"></a><span id="l8.13"> #endif</span>
<a href="#l8.14"></a><span id="l8.14"> </span>
<a href="#l8.15"></a><span id="l8.15"> nsresult</span>
<a href="#l8.16"></a><span id="l8.16"> nsProfileMigrator::GetDefaultMailMigratorKey(nsACString&amp; aKey, nsCOMPtr&lt;nsIMailProfileMigrator&gt;&amp; mailMigrator)</span>
<a href="#l8.17"></a><span id="l8.17"> {</span>
<a href="#l8.18"></a><span id="l8.18">   // look up the value of profile.force.migration in case we are supposed to force migration using a particular</span>
<a href="#l8.19"></a><span id="l8.19">   // migrator....</span>
<a href="#l8.20"></a><span id="l8.20">   nsresult rv = NS_OK;</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineat">@@ -155,17 +154,16 @@ nsProfileMigrator::GetDefaultMailMigrato</span>
<a href="#l8.22"></a><span id="l8.22">     return NS_OK;</span>
<a href="#l8.23"></a><span id="l8.23">   }</span>
<a href="#l8.24"></a><span id="l8.24"> </span>
<a href="#l8.25"></a><span id="l8.25">   #define MAX_SOURCE_LENGTH 10</span>
<a href="#l8.26"></a><span id="l8.26">   const char sources[][MAX_SOURCE_LENGTH] = {</span>
<a href="#l8.27"></a><span id="l8.27">     &quot;seamonkey&quot;,</span>
<a href="#l8.28"></a><span id="l8.28">     &quot;oexpress&quot;,</span>
<a href="#l8.29"></a><span id="l8.29">     &quot;outlook&quot;,</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineminus">-    &quot;dogbert&quot;,</span>
<a href="#l8.31"></a><span id="l8.31">     &quot;eudora&quot;,</span>
<a href="#l8.32"></a><span id="l8.32">     &quot;&quot;</span>
<a href="#l8.33"></a><span id="l8.33">   };</span>
<a href="#l8.34"></a><span id="l8.34">   for (PRUint32 i = 0; sources[i][0]; ++i)</span>
<a href="#l8.35"></a><span id="l8.35">   {</span>
<a href="#l8.36"></a><span id="l8.36">     migratorID = migratorPrefix;</span>
<a href="#l8.37"></a><span id="l8.37">     migratorID.Append(sources[i]);</span>
<a href="#l8.38"></a><span id="l8.38">     mailMigrator = do_CreateInstance(migratorID.get());</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/migration/migration.dtd</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/migration/migration.dtd</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -3,18 +3,16 @@</span>
<a href="#l9.4"></a><span id="l9.4"> </span>
<a href="#l9.5"></a><span id="l9.5"> &lt;!ENTITY importFromWin.label            &quot;Import Options, Account Settings, Address Book, Filters and other data from:&quot;&gt;</span>
<a href="#l9.6"></a><span id="l9.6"> &lt;!ENTITY importFromNonWin.label         &quot;Import Preferences, Account Settings, Address Book, Filters, and other data from:&quot;&gt;</span>
<a href="#l9.7"></a><span id="l9.7"> </span>
<a href="#l9.8"></a><span id="l9.8"> &lt;!ENTITY importFromNothing.label        &quot;Don't import anything&quot;&gt;</span>
<a href="#l9.9"></a><span id="l9.9"> &lt;!ENTITY importFromNothing.accesskey    &quot;D&quot;&gt;</span>
<a href="#l9.10"></a><span id="l9.10"> &lt;!ENTITY importFromSeamonkey2.label     &quot;Netscape 6, 7, Mozilla 1.x or SeaMonkey&quot;&gt;</span>
<a href="#l9.11"></a><span id="l9.11"> &lt;!ENTITY importFromSeamonkey2.accesskey &quot;s&quot;&gt;</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-&lt;!ENTITY importFromNetscape4.label      &quot;Netscape 4.x&quot;&gt;</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-&lt;!ENTITY importFromNetscape4.accesskey  &quot;4&quot;&gt;</span>
<a href="#l9.14"></a><span id="l9.14"> &lt;!ENTITY importFromOExpress.label       &quot;Outlook Express&quot;&gt;</span>
<a href="#l9.15"></a><span id="l9.15"> &lt;!ENTITY importFromOExpress.accesskey   &quot;u&quot;&gt;</span>
<a href="#l9.16"></a><span id="l9.16"> &lt;!ENTITY importFromOutlook.label        &quot;Outlook&quot;&gt;</span>
<a href="#l9.17"></a><span id="l9.17"> &lt;!ENTITY importFromOutlook.accesskey    &quot;O&quot;&gt;</span>
<a href="#l9.18"></a><span id="l9.18"> &lt;!ENTITY importFromEudora.label         &quot;Eudora&quot;&gt;</span>
<a href="#l9.19"></a><span id="l9.19"> &lt;!ENTITY importFromEudora.accesskey     &quot;E&quot;&gt;</span>
<a href="#l9.20"></a><span id="l9.20"> </span>
<a href="#l9.21"></a><span id="l9.21"> &lt;!ENTITY importSource.title             &quot;Import Settings and Mail Folders&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/migration/migration.properties</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/migration/migration.properties</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -1,51 +1,34 @@</span>
<a href="#l10.4"></a><span id="l10.4"> profileName_format=%S %S</span>
<a href="#l10.5"></a><span id="l10.5"> </span>
<a href="#l10.6"></a><span id="l10.6"> # Browser Specific</span>
<a href="#l10.7"></a><span id="l10.7"> sourceNameSeamonkey=Netscape 6/7/Mozilla</span>
<a href="#l10.8"></a><span id="l10.8" class="difflineminus">-sourceNameDogbert=Netscape 4</span>
<a href="#l10.9"></a><span id="l10.9"> sourceNameOExpress=Outlook Express</span>
<a href="#l10.10"></a><span id="l10.10"> sourceNameOutlook=Outlook</span>
<a href="#l10.11"></a><span id="l10.11"> </span>
<a href="#l10.12"></a><span id="l10.12"> # Import Sources</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-1_dogbert=Preferences</span>
<a href="#l10.14"></a><span id="l10.14"> 1_seamonkey=Preferences</span>
<a href="#l10.15"></a><span id="l10.15"> </span>
<a href="#l10.16"></a><span id="l10.16" class="difflineminus">-2_dogbert=Account Settings</span>
<a href="#l10.17"></a><span id="l10.17"> 2_seamonkey=Account Settings</span>
<a href="#l10.18"></a><span id="l10.18"> 2_oexpress=Account Settings</span>
<a href="#l10.19"></a><span id="l10.19"> 2_outlook=Account Settings</span>
<a href="#l10.20"></a><span id="l10.20"> 2_eudora=Account Settings</span>
<a href="#l10.21"></a><span id="l10.21"> </span>
<a href="#l10.22"></a><span id="l10.22" class="difflineminus">-4_dogbert=Address Books</span>
<a href="#l10.23"></a><span id="l10.23"> 4_seamonkey=Address Books</span>
<a href="#l10.24"></a><span id="l10.24"> 4_oexpress=Address Book</span>
<a href="#l10.25"></a><span id="l10.25"> 4_outlook=Address Book</span>
<a href="#l10.26"></a><span id="l10.26"> 4_eudora=Address Books</span>
<a href="#l10.27"></a><span id="l10.27"> </span>
<a href="#l10.28"></a><span id="l10.28" class="difflineminus">-8_dogbert=Junk Mail Training</span>
<a href="#l10.29"></a><span id="l10.29"> 8_seamonkey=Junk Mail Training</span>
<a href="#l10.30"></a><span id="l10.30"> </span>
<a href="#l10.31"></a><span id="l10.31" class="difflineminus">-16_dogbert=Saved Passwords</span>
<a href="#l10.32"></a><span id="l10.32"> 16_seamonkey=Saved Passwords</span>
<a href="#l10.33"></a><span id="l10.33"> </span>
<a href="#l10.34"></a><span id="l10.34" class="difflineminus">-32_dogbert=Other Data</span>
<a href="#l10.35"></a><span id="l10.35"> 32_seamonkey=Other Data</span>
<a href="#l10.36"></a><span id="l10.36"> </span>
<a href="#l10.37"></a><span id="l10.37" class="difflineminus">-64_dogbert=Newsgroup Folders</span>
<a href="#l10.38"></a><span id="l10.38"> 64_seamonkey=Newsgroup Folders</span>
<a href="#l10.39"></a><span id="l10.39"> </span>
<a href="#l10.40"></a><span id="l10.40" class="difflineminus">-128_dogbert=Mail Folders</span>
<a href="#l10.41"></a><span id="l10.41"> 128_seamonkey=Mail Folders</span>
<a href="#l10.42"></a><span id="l10.42"> 128_oexpress=Mail Folders</span>
<a href="#l10.43"></a><span id="l10.43"> 128_outlook=Mail Folders</span>
<a href="#l10.44"></a><span id="l10.44"> 128_eudora=Mail Folders</span>
<a href="#l10.45"></a><span id="l10.45"> </span>
<a href="#l10.46"></a><span id="l10.46"> 256_eudora=Filters</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineminus">-</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineminus">-# mailDirName needs to be set to the same value as in 4.x</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineminus">-# see bug #55449</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineminus">-mailDirName=Mail</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineminus">-</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineminus">-# newsDirName needs to be set to the same value as in 4.x</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineminus">-# see bug #55449</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineminus">-newsDirName=News</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

