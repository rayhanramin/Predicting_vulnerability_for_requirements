<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 30073:6aa2a15cefb79b8d48306d05f1eb11b11495a358</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 6aa2a15cefb79b8d48306d05f1eb11b11495a358" />
<meta property="og:url" content="/comm-central/rev/6aa2a15cefb79b8d48306d05f1eb11b11495a358" />
<meta property="og:description" content="Bug 1650041 - In ABView, call QueryInterface on objects passed through the observer service. r=pmorris" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 6aa2a15cefb79b8d48306d05f1eb11b11495a358 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/6aa2a15cefb79b8d48306d05f1eb11b11495a358">shortlog</a> |
<a href="/comm-central/log/6aa2a15cefb79b8d48306d05f1eb11b11495a358">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/6aa2a15cefb79b8d48306d05f1eb11b11495a358">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/6aa2a15cefb79b8d48306d05f1eb11b11495a358">files</a> |
changeset |
<a href="/comm-central/raw-rev/6aa2a15cefb79b8d48306d05f1eb11b11495a358">raw</a>  | <a href="/comm-central/archive/6aa2a15cefb79b8d48306d05f1eb11b11495a358.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1650041">Bug 1650041</a> - In ABView, call QueryInterface on objects passed through the observer service. r=pmorris
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#71;&#101;&#111;&#102;&#102;&#32;&#76;&#97;&#110;&#107;&#111;&#119;&#32;&#60;&#103;&#101;&#111;&#102;&#102;&#64;&#100;&#97;&#114;&#107;&#116;&#114;&#111;&#106;&#97;&#110;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 06 Jul 2020 22:33:43 +0000</td></tr>

<tr>
 <td>changeset 30073</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/6aa2a15cefb79b8d48306d05f1eb11b11495a358">6aa2a15cefb79b8d48306d05f1eb11b11495a358</a></td>
</tr>



<tr>
<td>parent 30072</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/3e06df46ec0300b09c3c4bc35004b9306aca4063">3e06df46ec0300b09c3c4bc35004b9306aca4063</a>
</td>
</tr>

<tr>
<td>child 30074</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/6ddc057f6870a3c44f16e780dab539598c3d519e">6ddc057f6870a3c44f16e780dab539598c3d519e</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=6aa2a15cefb79b8d48306d05f1eb11b11495a358">17680</a></td></tr>
<tr><td>push user</td><td>geoff@darktrojan.net</td></tr>
<tr><td>push date</td><td class="date age">Tue, 07 Jul 2020 03:58:58 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@6c471c28d027 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=6c471c28d0273fecc880fc1260b876045eb3792a">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=6c471c28d0273fecc880fc1260b876045eb3792a&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=6c471c28d0273fecc880fc1260b876045eb3792a&newProject=comm-central&newRevision=3e06df46ec0300b09c3c4bc35004b9306aca4063&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=6c471c28d0273fecc880fc1260b876045eb3792a&newProject=comm-central&newRevision=3e06df46ec0300b09c3c4bc35004b9306aca4063&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=6c471c28d0273fecc880fc1260b876045eb3792a&newProject=comm-central&newRevision=3e06df46ec0300b09c3c4bc35004b9306aca4063&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28pmorris%29&revcount=50">pmorris</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1650041">1650041</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1650041">Bug 1650041</a> - In ABView, call QueryInterface on objects passed through the observer service. r=pmorris

Objects that we get from the observer service are nsISupports. We can't guarantee the properties
we want to use on them are there without QueryInterface. In most cases they are because we're just
passing JS objects around, but that isn't always the case.

Plus I found a bug where the code expects an nsIAbCard but actually gets an nsIAbDirectory.

Differential Revision: <a href="https://phabricator.services.mozilla.com/D81983">https://phabricator.services.mozilla.com/D81983</a></div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6aa2a15cefb79b8d48306d05f1eb11b11495a358/mailnews/addrbook/content/abView.js">mailnews/addrbook/content/abView.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6aa2a15cefb79b8d48306d05f1eb11b11495a358/mailnews/addrbook/content/abView.js">file</a> |
<a href="/comm-central/annotate/6aa2a15cefb79b8d48306d05f1eb11b11495a358/mailnews/addrbook/content/abView.js">annotate</a> |
<a href="/comm-central/diff/6aa2a15cefb79b8d48306d05f1eb11b11495a358/mailnews/addrbook/content/abView.js">diff</a> |
<a href="/comm-central/comparison/6aa2a15cefb79b8d48306d05f1eb11b11495a358/mailnews/addrbook/content/abView.js">comparison</a> |
<a href="/comm-central/log/6aa2a15cefb79b8d48306d05f1eb11b11495a358/mailnews/addrbook/content/abView.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6aa2a15cefb79b8d48306d05f1eb11b11495a358/mailnews/addrbook/jsaddrbook/AddrBookDirectory.jsm">mailnews/addrbook/jsaddrbook/AddrBookDirectory.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6aa2a15cefb79b8d48306d05f1eb11b11495a358/mailnews/addrbook/jsaddrbook/AddrBookDirectory.jsm">file</a> |
<a href="/comm-central/annotate/6aa2a15cefb79b8d48306d05f1eb11b11495a358/mailnews/addrbook/jsaddrbook/AddrBookDirectory.jsm">annotate</a> |
<a href="/comm-central/diff/6aa2a15cefb79b8d48306d05f1eb11b11495a358/mailnews/addrbook/jsaddrbook/AddrBookDirectory.jsm">diff</a> |
<a href="/comm-central/comparison/6aa2a15cefb79b8d48306d05f1eb11b11495a358/mailnews/addrbook/jsaddrbook/AddrBookDirectory.jsm">comparison</a> |
<a href="/comm-central/log/6aa2a15cefb79b8d48306d05f1eb11b11495a358/mailnews/addrbook/jsaddrbook/AddrBookDirectory.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6aa2a15cefb79b8d48306d05f1eb11b11495a358/mailnews/addrbook/jsaddrbook/AddrBookMailingList.jsm">mailnews/addrbook/jsaddrbook/AddrBookMailingList.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6aa2a15cefb79b8d48306d05f1eb11b11495a358/mailnews/addrbook/jsaddrbook/AddrBookMailingList.jsm">file</a> |
<a href="/comm-central/annotate/6aa2a15cefb79b8d48306d05f1eb11b11495a358/mailnews/addrbook/jsaddrbook/AddrBookMailingList.jsm">annotate</a> |
<a href="/comm-central/diff/6aa2a15cefb79b8d48306d05f1eb11b11495a358/mailnews/addrbook/jsaddrbook/AddrBookMailingList.jsm">diff</a> |
<a href="/comm-central/comparison/6aa2a15cefb79b8d48306d05f1eb11b11495a358/mailnews/addrbook/jsaddrbook/AddrBookMailingList.jsm">comparison</a> |
<a href="/comm-central/log/6aa2a15cefb79b8d48306d05f1eb11b11495a358/mailnews/addrbook/jsaddrbook/AddrBookMailingList.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6aa2a15cefb79b8d48306d05f1eb11b11495a358/mailnews/addrbook/test/unit/test_jsaddrbook.js">mailnews/addrbook/test/unit/test_jsaddrbook.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6aa2a15cefb79b8d48306d05f1eb11b11495a358/mailnews/addrbook/test/unit/test_jsaddrbook.js">file</a> |
<a href="/comm-central/annotate/6aa2a15cefb79b8d48306d05f1eb11b11495a358/mailnews/addrbook/test/unit/test_jsaddrbook.js">annotate</a> |
<a href="/comm-central/diff/6aa2a15cefb79b8d48306d05f1eb11b11495a358/mailnews/addrbook/test/unit/test_jsaddrbook.js">diff</a> |
<a href="/comm-central/comparison/6aa2a15cefb79b8d48306d05f1eb11b11495a358/mailnews/addrbook/test/unit/test_jsaddrbook.js">comparison</a> |
<a href="/comm-central/log/6aa2a15cefb79b8d48306d05f1eb11b11495a358/mailnews/addrbook/test/unit/test_jsaddrbook.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/addrbook/content/abView.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/addrbook/content/abView.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -142,16 +142,17 @@ ABView.prototype = {</span>
<a href="#l1.4"></a><span id="l1.4"> </span>
<a href="#l1.5"></a><span id="l1.5">   observe(subject, topic, data) {</span>
<a href="#l1.6"></a><span id="l1.6">     if (this.directory &amp;&amp; data &amp;&amp; this.directory.UID != data) {</span>
<a href="#l1.7"></a><span id="l1.7">       return;</span>
<a href="#l1.8"></a><span id="l1.8">     }</span>
<a href="#l1.9"></a><span id="l1.9"> </span>
<a href="#l1.10"></a><span id="l1.10">     switch (topic) {</span>
<a href="#l1.11"></a><span id="l1.11">       case &quot;addrbook-directory-invalidated&quot;:</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+        subject.QueryInterface(Ci.nsIAbDirectory);</span>
<a href="#l1.13"></a><span id="l1.13">         if (subject == this.directory) {</span>
<a href="#l1.14"></a><span id="l1.14">           this._rowMap.length = 0;</span>
<a href="#l1.15"></a><span id="l1.15">           for (let card of this.directory.childCards) {</span>
<a href="#l1.16"></a><span id="l1.16">             this._rowMap.push(new abViewCard(card));</span>
<a href="#l1.17"></a><span id="l1.17">           }</span>
<a href="#l1.18"></a><span id="l1.18">           this.sortBy(this.sortColumn, this.sortDirection, true);</span>
<a href="#l1.19"></a><span id="l1.19">           if (this.listener) {</span>
<a href="#l1.20"></a><span id="l1.20">             this.listener.onCountChanged(this.rowCount);</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineat">@@ -159,16 +160,17 @@ ABView.prototype = {</span>
<a href="#l1.22"></a><span id="l1.22">         }</span>
<a href="#l1.23"></a><span id="l1.23">         break;</span>
<a href="#l1.24"></a><span id="l1.24">       case &quot;addrbook-list-member-added&quot;:</span>
<a href="#l1.25"></a><span id="l1.25">         if (!this.directory) {</span>
<a href="#l1.26"></a><span id="l1.26">           break;</span>
<a href="#l1.27"></a><span id="l1.27">         }</span>
<a href="#l1.28"></a><span id="l1.28">       // Falls through.</span>
<a href="#l1.29"></a><span id="l1.29">       case &quot;addrbook-contact-created&quot;:</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineplus">+        subject.QueryInterface(Ci.nsIAbCard);</span>
<a href="#l1.31"></a><span id="l1.31">         let viewCard = new abViewCard(subject);</span>
<a href="#l1.32"></a><span id="l1.32">         let sortText = viewCard.getText(this.sortColumn);</span>
<a href="#l1.33"></a><span id="l1.33">         let addIndex = null;</span>
<a href="#l1.34"></a><span id="l1.34">         for (let i = 0; addIndex === null &amp;&amp; i &lt; this._rowMap.length; i++) {</span>
<a href="#l1.35"></a><span id="l1.35">           let comparison = this.collator.compare(</span>
<a href="#l1.36"></a><span id="l1.36">             sortText,</span>
<a href="#l1.37"></a><span id="l1.37">             this._rowMap[i].getText(this.sortColumn)</span>
<a href="#l1.38"></a><span id="l1.38">           );</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineat">@@ -186,41 +188,53 @@ ABView.prototype = {</span>
<a href="#l1.40"></a><span id="l1.40">         if (this.tree) {</span>
<a href="#l1.41"></a><span id="l1.41">           this.tree.rowCountChanged(addIndex, 1);</span>
<a href="#l1.42"></a><span id="l1.42">         }</span>
<a href="#l1.43"></a><span id="l1.43">         if (this.listener) {</span>
<a href="#l1.44"></a><span id="l1.44">           this.listener.onCountChanged(this.rowCount);</span>
<a href="#l1.45"></a><span id="l1.45">         }</span>
<a href="#l1.46"></a><span id="l1.46">         break;</span>
<a href="#l1.47"></a><span id="l1.47"> </span>
<a href="#l1.48"></a><span id="l1.48" class="difflineminus">-      case &quot;addrbook-list-updated&quot;:</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineminus">-        if (!this.directory) {</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineminus">-          break;</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineplus">+      case &quot;addrbook-list-updated&quot;: {</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineplus">+        let parentDir = this.directory;</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineplus">+        if (!parentDir) {</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineplus">+          parentDir = MailServices.ab.getDirectoryFromUID(data);</span>
<a href="#l1.55"></a><span id="l1.55">         }</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineplus">+        // `subject` is an nsIAbDirectory, make it the matching card instead.</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineplus">+        subject.QueryInterface(Ci.nsIAbDirectory);</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineplus">+        for (let card of parentDir.childCards) {</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineplus">+          if (card.UID == subject.UID) {</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineplus">+            subject = card;</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineplus">+            break;</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineplus">+          }</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineplus">+        }</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineplus">+      }</span>
<a href="#l1.65"></a><span id="l1.65">       // Falls through.</span>
<a href="#l1.66"></a><span id="l1.66">       case &quot;addrbook-contact-updated&quot;: {</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineplus">+        subject.QueryInterface(Ci.nsIAbCard);</span>
<a href="#l1.68"></a><span id="l1.68">         let needsSort = false;</span>
<a href="#l1.69"></a><span id="l1.69">         for (let i = this._rowMap.length - 1; i &gt;= 0; i--) {</span>
<a href="#l1.70"></a><span id="l1.70">           if (this._rowMap[i].card.equals(subject)) {</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineminus">-            this._rowMap[i]._getTextCache = {};</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineplus">+            this._rowMap.splice(i, 1, new abViewCard(subject));</span>
<a href="#l1.73"></a><span id="l1.73">             needsSort = true;</span>
<a href="#l1.74"></a><span id="l1.74">           }</span>
<a href="#l1.75"></a><span id="l1.75">         }</span>
<a href="#l1.76"></a><span id="l1.76">         if (needsSort) {</span>
<a href="#l1.77"></a><span id="l1.77">           this.sortBy(this.sortColumn, this.sortDirection, true);</span>
<a href="#l1.78"></a><span id="l1.78">         }</span>
<a href="#l1.79"></a><span id="l1.79">         break;</span>
<a href="#l1.80"></a><span id="l1.80">       }</span>
<a href="#l1.81"></a><span id="l1.81"> </span>
<a href="#l1.82"></a><span id="l1.82">       case &quot;addrbook-list-member-removed&quot;:</span>
<a href="#l1.83"></a><span id="l1.83">         if (!this.directory) {</span>
<a href="#l1.84"></a><span id="l1.84">           break;</span>
<a href="#l1.85"></a><span id="l1.85">         }</span>
<a href="#l1.86"></a><span id="l1.86">       // Falls through.</span>
<a href="#l1.87"></a><span id="l1.87">       case &quot;addrbook-contact-deleted&quot;:</span>
<a href="#l1.88"></a><span id="l1.88" class="difflineplus">+        subject.QueryInterface(Ci.nsIAbCard);</span>
<a href="#l1.89"></a><span id="l1.89">         for (let i = this._rowMap.length - 1; i &gt;= 0; i--) {</span>
<a href="#l1.90"></a><span id="l1.90">           if (this._rowMap[i].card.equals(subject)) {</span>
<a href="#l1.91"></a><span id="l1.91">             this._rowMap.splice(i, 1);</span>
<a href="#l1.92"></a><span id="l1.92">             if (this.tree) {</span>
<a href="#l1.93"></a><span id="l1.93">               this.tree.rowCountChanged(i, -1);</span>
<a href="#l1.94"></a><span id="l1.94">             }</span>
<a href="#l1.95"></a><span id="l1.95">           }</span>
<a href="#l1.96"></a><span id="l1.96">         }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/addrbook/jsaddrbook/AddrBookDirectory.jsm</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/addrbook/jsaddrbook/AddrBookDirectory.jsm</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -902,17 +902,22 @@ class AddrBookDirectory {</span>
<a href="#l2.4"></a><span id="l2.4">         MailServices.ab.notifyItemPropertyChanged(</span>
<a href="#l2.5"></a><span id="l2.5">           card,</span>
<a href="#l2.6"></a><span id="l2.6">           name,</span>
<a href="#l2.7"></a><span id="l2.7">           oldValue,</span>
<a href="#l2.8"></a><span id="l2.8">           newValue</span>
<a href="#l2.9"></a><span id="l2.9">         );</span>
<a href="#l2.10"></a><span id="l2.10">       }</span>
<a href="#l2.11"></a><span id="l2.11">     }</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-    Services.obs.notifyObservers(card, &quot;addrbook-contact-updated&quot;, this.UID);</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+    // Send the card as it is in this directory, not as passed to this function.</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+    Services.obs.notifyObservers(</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+      this._getCard({ uid: card.UID }),</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+      &quot;addrbook-contact-updated&quot;,</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+      this.UID</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+    );</span>
<a href="#l2.19"></a><span id="l2.19">   }</span>
<a href="#l2.20"></a><span id="l2.20">   deleteCards(cards) {</span>
<a href="#l2.21"></a><span id="l2.21">     if (cards === null) {</span>
<a href="#l2.22"></a><span id="l2.22">       throw Components.Exception(&quot;&quot;, Cr.NS_ERROR_INVALID_POINTER);</span>
<a href="#l2.23"></a><span id="l2.23">     }</span>
<a href="#l2.24"></a><span id="l2.24"> </span>
<a href="#l2.25"></a><span id="l2.25">     let deleteCardStatement = this._dbConnection.createStatement(</span>
<a href="#l2.26"></a><span id="l2.26">       &quot;DELETE FROM cards WHERE uid = :uid&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/addrbook/jsaddrbook/AddrBookMailingList.jsm</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/addrbook/jsaddrbook/AddrBookMailingList.jsm</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -194,17 +194,21 @@ AddrBookMailingList.prototype = {</span>
<a href="#l3.4"></a><span id="l3.4">             throw new Components.Exception(</span>
<a href="#l3.5"></a><span id="l3.5">               &quot;Invalid mailing list name&quot;,</span>
<a href="#l3.6"></a><span id="l3.6">               Cr.NS_ERROR_ILLEGAL_VALUE</span>
<a href="#l3.7"></a><span id="l3.7">             );</span>
<a href="#l3.8"></a><span id="l3.8">           }</span>
<a href="#l3.9"></a><span id="l3.9">         }</span>
<a href="#l3.10"></a><span id="l3.10"> </span>
<a href="#l3.11"></a><span id="l3.11">         self._parent._saveList(self);</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-        Services.obs.notifyObservers(this, &quot;addrbook-list-updated&quot;);</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+        Services.obs.notifyObservers(</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+          this,</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+          &quot;addrbook-list-updated&quot;,</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+          self._parent.UID</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+        );</span>
<a href="#l3.18"></a><span id="l3.18">       },</span>
<a href="#l3.19"></a><span id="l3.19">     };</span>
<a href="#l3.20"></a><span id="l3.20">   },</span>
<a href="#l3.21"></a><span id="l3.21">   get asCard() {</span>
<a href="#l3.22"></a><span id="l3.22">     let self = this;</span>
<a href="#l3.23"></a><span id="l3.23">     return {</span>
<a href="#l3.24"></a><span id="l3.24">       QueryInterface: ChromeUtils.generateQI([Ci.nsIAbCard]),</span>
<a href="#l3.25"></a><span id="l3.25">       classID: Components.ID(&quot;{1143991d-31cd-4ea6-9c97-c587d990d724}&quot;),</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_jsaddrbook.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_jsaddrbook.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -308,17 +308,17 @@ add_task(async function createMailingLis</span>
<a href="#l4.4"></a><span id="l4.4"> });</span>
<a href="#l4.5"></a><span id="l4.5"> </span>
<a href="#l4.6"></a><span id="l4.6"> add_task(async function editMailingList() {</span>
<a href="#l4.7"></a><span id="l4.7">   list.dirName = &quot;updated list&quot;;</span>
<a href="#l4.8"></a><span id="l4.8">   list.editMailListToDatabase(null);</span>
<a href="#l4.9"></a><span id="l4.9">   observer.checkEvents(</span>
<a href="#l4.10"></a><span id="l4.10">     [&quot;onItemPropertyChanged&quot;, list, &quot;DirName&quot;, undefined, &quot;updated list&quot;],</span>
<a href="#l4.11"></a><span id="l4.11">     [&quot;onItemPropertyChanged&quot;, list, &quot;DirName&quot;, undefined, &quot;updated list&quot;], // Seriously?</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-    [&quot;addrbook-list-updated&quot;, list, null]</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+    [&quot;addrbook-list-updated&quot;, list, book.UID]</span>
<a href="#l4.14"></a><span id="l4.14">   );</span>
<a href="#l4.15"></a><span id="l4.15">   equal(&quot;updated list&quot;, list.dirName);</span>
<a href="#l4.16"></a><span id="l4.16"> });</span>
<a href="#l4.17"></a><span id="l4.17"> </span>
<a href="#l4.18"></a><span id="l4.18"> add_task(async function addMailingListMember() {</span>
<a href="#l4.19"></a><span id="l4.19">   list.addCard(contact);</span>
<a href="#l4.20"></a><span id="l4.20">   observer.checkEvents(</span>
<a href="#l4.21"></a><span id="l4.21">     [&quot;onItemPropertyChanged&quot;, contact, null, null, null],</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:32Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

