<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 25817:5fa6fd01e5553af4b5057829ee4de26eec271ae7</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 5fa6fd01e5553af4b5057829ee4de26eec271ae7" />
<meta property="og:url" content="/comm-central/rev/5fa6fd01e5553af4b5057829ee4de26eec271ae7" />
<meta property="og:description" content="Bug 453908 - Replace direct rdf-service calls in C++ with folder-lookup-service calls. r=aceman DONTBUILD" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 5fa6fd01e5553af4b5057829ee4de26eec271ae7 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/5fa6fd01e5553af4b5057829ee4de26eec271ae7">shortlog</a> |
<a href="/comm-central/log/5fa6fd01e5553af4b5057829ee4de26eec271ae7">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/5fa6fd01e5553af4b5057829ee4de26eec271ae7">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/5fa6fd01e5553af4b5057829ee4de26eec271ae7">files</a> |
changeset |
<a href="/comm-central/raw-rev/5fa6fd01e5553af4b5057829ee4de26eec271ae7">raw</a>  | <a href="/comm-central/archive/5fa6fd01e5553af4b5057829ee4de26eec271ae7.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=453908">Bug 453908</a> - Replace direct rdf-service calls in C++ with folder-lookup-service calls. r=aceman DONTBUILD
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#66;&#101;&#110;&#32;&#67;&#97;&#109;&#112;&#98;&#101;&#108;&#108;&#32;&#60;&#98;&#101;&#110;&#99;&#64;&#116;&#104;&#117;&#110;&#100;&#101;&#114;&#98;&#105;&#114;&#100;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 22 Jan 2019 17:54:28 +1300</td></tr>

<tr>
 <td>changeset 25817</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/5fa6fd01e5553af4b5057829ee4de26eec271ae7">5fa6fd01e5553af4b5057829ee4de26eec271ae7</a></td>
</tr>



<tr>
<td>parent 25816</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/6798eb6964aa7d4b173512bda471c0d2b88c0361">6798eb6964aa7d4b173512bda471c0d2b88c0361</a>
</td>
</tr>

<tr>
<td>child 25818</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/852ae2446bee3a9809ecadb98cf967a54ad5108a">852ae2446bee3a9809ecadb98cf967a54ad5108a</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=5fa6fd01e5553af4b5057829ee4de26eec271ae7">15490</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Mon, 11 Feb 2019 09:57:45 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@5fa6fd01e555 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=5fa6fd01e5553af4b5057829ee4de26eec271ae7">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=5fa6fd01e5553af4b5057829ee4de26eec271ae7&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=5fa6fd01e5553af4b5057829ee4de26eec271ae7&newProject=comm-central&newRevision=5fa6fd01e5553af4b5057829ee4de26eec271ae7&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=5fa6fd01e5553af4b5057829ee4de26eec271ae7&newProject=comm-central&newRevision=5fa6fd01e5553af4b5057829ee4de26eec271ae7&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=5fa6fd01e5553af4b5057829ee4de26eec271ae7&newProject=comm-central&newRevision=5fa6fd01e5553af4b5057829ee4de26eec271ae7&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28aceman%29&revcount=50">aceman</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=453908">453908</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=453908">Bug 453908</a> - Replace direct rdf-service calls in C++ with folder-lookup-service calls. r=aceman DONTBUILD</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mail/components/migration/src/nsNetscapeProfileMigratorBase.cpp">mail/components/migration/src/nsNetscapeProfileMigratorBase.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mail/components/migration/src/nsNetscapeProfileMigratorBase.cpp">file</a> |
<a href="/comm-central/annotate/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mail/components/migration/src/nsNetscapeProfileMigratorBase.cpp">annotate</a> |
<a href="/comm-central/diff/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mail/components/migration/src/nsNetscapeProfileMigratorBase.cpp">diff</a> |
<a href="/comm-central/comparison/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mail/components/migration/src/nsNetscapeProfileMigratorBase.cpp">comparison</a> |
<a href="/comm-central/log/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mail/components/migration/src/nsNetscapeProfileMigratorBase.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/base/search/src/nsMsgFilterService.cpp">mailnews/base/search/src/nsMsgFilterService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/base/search/src/nsMsgFilterService.cpp">file</a> |
<a href="/comm-central/annotate/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/base/search/src/nsMsgFilterService.cpp">annotate</a> |
<a href="/comm-central/diff/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/base/search/src/nsMsgFilterService.cpp">diff</a> |
<a href="/comm-central/comparison/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/base/search/src/nsMsgFilterService.cpp">comparison</a> |
<a href="/comm-central/log/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/base/search/src/nsMsgFilterService.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/base/src/nsMessenger.cpp">mailnews/base/src/nsMessenger.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/base/src/nsMessenger.cpp">file</a> |
<a href="/comm-central/annotate/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/base/src/nsMessenger.cpp">annotate</a> |
<a href="/comm-central/diff/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/base/src/nsMessenger.cpp">diff</a> |
<a href="/comm-central/comparison/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/base/src/nsMessenger.cpp">comparison</a> |
<a href="/comm-central/log/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/base/src/nsMessenger.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/base/src/nsMsgAccountManager.cpp">mailnews/base/src/nsMsgAccountManager.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/base/src/nsMsgAccountManager.cpp">file</a> |
<a href="/comm-central/annotate/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/base/src/nsMsgAccountManager.cpp">annotate</a> |
<a href="/comm-central/diff/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/base/src/nsMsgAccountManager.cpp">diff</a> |
<a href="/comm-central/comparison/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/base/src/nsMsgAccountManager.cpp">comparison</a> |
<a href="/comm-central/log/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/base/src/nsMsgAccountManager.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/base/src/nsMsgAccountManager.h">mailnews/base/src/nsMsgAccountManager.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/base/src/nsMsgAccountManager.h">file</a> |
<a href="/comm-central/annotate/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/base/src/nsMsgAccountManager.h">annotate</a> |
<a href="/comm-central/diff/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/base/src/nsMsgAccountManager.h">diff</a> |
<a href="/comm-central/comparison/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/base/src/nsMsgAccountManager.h">comparison</a> |
<a href="/comm-central/log/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/base/src/nsMsgAccountManager.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/base/src/nsSpamSettings.cpp">mailnews/base/src/nsSpamSettings.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/base/src/nsSpamSettings.cpp">file</a> |
<a href="/comm-central/annotate/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/base/src/nsSpamSettings.cpp">annotate</a> |
<a href="/comm-central/diff/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/base/src/nsSpamSettings.cpp">diff</a> |
<a href="/comm-central/comparison/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/base/src/nsSpamSettings.cpp">comparison</a> |
<a href="/comm-central/log/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/base/src/nsSpamSettings.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/base/util/nsMsgDBFolder.cpp">mailnews/base/util/nsMsgDBFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/base/util/nsMsgDBFolder.cpp">file</a> |
<a href="/comm-central/annotate/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/base/util/nsMsgDBFolder.cpp">annotate</a> |
<a href="/comm-central/diff/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/base/util/nsMsgDBFolder.cpp">diff</a> |
<a href="/comm-central/comparison/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/base/util/nsMsgDBFolder.cpp">comparison</a> |
<a href="/comm-central/log/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/base/util/nsMsgDBFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/base/util/nsMsgIdentity.cpp">mailnews/base/util/nsMsgIdentity.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/base/util/nsMsgIdentity.cpp">file</a> |
<a href="/comm-central/annotate/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/base/util/nsMsgIdentity.cpp">annotate</a> |
<a href="/comm-central/diff/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/base/util/nsMsgIdentity.cpp">diff</a> |
<a href="/comm-central/comparison/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/base/util/nsMsgIdentity.cpp">comparison</a> |
<a href="/comm-central/log/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/base/util/nsMsgIdentity.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/base/util/nsMsgIncomingServer.cpp">mailnews/base/util/nsMsgIncomingServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/base/util/nsMsgIncomingServer.cpp">file</a> |
<a href="/comm-central/annotate/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/base/util/nsMsgIncomingServer.cpp">annotate</a> |
<a href="/comm-central/diff/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/base/util/nsMsgIncomingServer.cpp">diff</a> |
<a href="/comm-central/comparison/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/base/util/nsMsgIncomingServer.cpp">comparison</a> |
<a href="/comm-central/log/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/base/util/nsMsgIncomingServer.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/base/util/nsMsgUtils.cpp">mailnews/base/util/nsMsgUtils.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/base/util/nsMsgUtils.cpp">file</a> |
<a href="/comm-central/annotate/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/base/util/nsMsgUtils.cpp">annotate</a> |
<a href="/comm-central/diff/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/base/util/nsMsgUtils.cpp">diff</a> |
<a href="/comm-central/comparison/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/base/util/nsMsgUtils.cpp">comparison</a> |
<a href="/comm-central/log/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/base/util/nsMsgUtils.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/compose/src/nsMsgCompose.cpp">mailnews/compose/src/nsMsgCompose.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/compose/src/nsMsgCompose.cpp">file</a> |
<a href="/comm-central/annotate/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/compose/src/nsMsgCompose.cpp">annotate</a> |
<a href="/comm-central/diff/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/compose/src/nsMsgCompose.cpp">diff</a> |
<a href="/comm-central/comparison/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/compose/src/nsMsgCompose.cpp">comparison</a> |
<a href="/comm-central/log/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/compose/src/nsMsgCompose.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/compose/src/nsMsgCompose.h">mailnews/compose/src/nsMsgCompose.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/compose/src/nsMsgCompose.h">file</a> |
<a href="/comm-central/annotate/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/compose/src/nsMsgCompose.h">annotate</a> |
<a href="/comm-central/diff/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/compose/src/nsMsgCompose.h">diff</a> |
<a href="/comm-central/comparison/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/compose/src/nsMsgCompose.h">comparison</a> |
<a href="/comm-central/log/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/compose/src/nsMsgCompose.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/compose/src/nsMsgCopy.cpp">mailnews/compose/src/nsMsgCopy.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/compose/src/nsMsgCopy.cpp">file</a> |
<a href="/comm-central/annotate/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/compose/src/nsMsgCopy.cpp">annotate</a> |
<a href="/comm-central/diff/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/compose/src/nsMsgCopy.cpp">diff</a> |
<a href="/comm-central/comparison/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/compose/src/nsMsgCopy.cpp">comparison</a> |
<a href="/comm-central/log/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/compose/src/nsMsgCopy.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/compose/src/nsMsgSend.cpp">mailnews/compose/src/nsMsgSend.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/compose/src/nsMsgSend.cpp">file</a> |
<a href="/comm-central/annotate/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/compose/src/nsMsgSend.cpp">annotate</a> |
<a href="/comm-central/diff/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/compose/src/nsMsgSend.cpp">diff</a> |
<a href="/comm-central/comparison/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/compose/src/nsMsgSend.cpp">comparison</a> |
<a href="/comm-central/log/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/compose/src/nsMsgSend.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/imap/src/nsImapIncomingServer.cpp">mailnews/imap/src/nsImapIncomingServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/imap/src/nsImapIncomingServer.cpp">file</a> |
<a href="/comm-central/annotate/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/imap/src/nsImapIncomingServer.cpp">annotate</a> |
<a href="/comm-central/diff/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/imap/src/nsImapIncomingServer.cpp">diff</a> |
<a href="/comm-central/comparison/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/imap/src/nsImapIncomingServer.cpp">comparison</a> |
<a href="/comm-central/log/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/imap/src/nsImapIncomingServer.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/imap/src/nsImapIncomingServer.h">mailnews/imap/src/nsImapIncomingServer.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/imap/src/nsImapIncomingServer.h">file</a> |
<a href="/comm-central/annotate/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/imap/src/nsImapIncomingServer.h">annotate</a> |
<a href="/comm-central/diff/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/imap/src/nsImapIncomingServer.h">diff</a> |
<a href="/comm-central/comparison/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/imap/src/nsImapIncomingServer.h">comparison</a> |
<a href="/comm-central/log/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/imap/src/nsImapIncomingServer.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/imap/src/nsImapMailFolder.cpp">mailnews/imap/src/nsImapMailFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/imap/src/nsImapMailFolder.cpp">file</a> |
<a href="/comm-central/annotate/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/imap/src/nsImapMailFolder.cpp">annotate</a> |
<a href="/comm-central/diff/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/imap/src/nsImapMailFolder.cpp">diff</a> |
<a href="/comm-central/comparison/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/imap/src/nsImapMailFolder.cpp">comparison</a> |
<a href="/comm-central/log/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/imap/src/nsImapMailFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/imap/src/nsImapOfflineSync.cpp">mailnews/imap/src/nsImapOfflineSync.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/imap/src/nsImapOfflineSync.cpp">file</a> |
<a href="/comm-central/annotate/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/imap/src/nsImapOfflineSync.cpp">annotate</a> |
<a href="/comm-central/diff/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/imap/src/nsImapOfflineSync.cpp">diff</a> |
<a href="/comm-central/comparison/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/imap/src/nsImapOfflineSync.cpp">comparison</a> |
<a href="/comm-central/log/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/imap/src/nsImapOfflineSync.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/imap/src/nsImapService.cpp">mailnews/imap/src/nsImapService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/imap/src/nsImapService.cpp">file</a> |
<a href="/comm-central/annotate/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/imap/src/nsImapService.cpp">annotate</a> |
<a href="/comm-central/diff/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/imap/src/nsImapService.cpp">diff</a> |
<a href="/comm-central/comparison/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/imap/src/nsImapService.cpp">comparison</a> |
<a href="/comm-central/log/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/imap/src/nsImapService.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/local/src/nsLocalMailFolder.cpp">mailnews/local/src/nsLocalMailFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/local/src/nsLocalMailFolder.cpp">file</a> |
<a href="/comm-central/annotate/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/local/src/nsLocalMailFolder.cpp">annotate</a> |
<a href="/comm-central/diff/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/local/src/nsLocalMailFolder.cpp">diff</a> |
<a href="/comm-central/comparison/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/local/src/nsLocalMailFolder.cpp">comparison</a> |
<a href="/comm-central/log/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/local/src/nsLocalMailFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/local/src/nsMailboxService.cpp">mailnews/local/src/nsMailboxService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/local/src/nsMailboxService.cpp">file</a> |
<a href="/comm-central/annotate/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/local/src/nsMailboxService.cpp">annotate</a> |
<a href="/comm-central/diff/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/local/src/nsMailboxService.cpp">diff</a> |
<a href="/comm-central/comparison/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/local/src/nsMailboxService.cpp">comparison</a> |
<a href="/comm-central/log/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/local/src/nsMailboxService.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/local/src/nsParseMailbox.cpp">mailnews/local/src/nsParseMailbox.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/local/src/nsParseMailbox.cpp">file</a> |
<a href="/comm-central/annotate/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/local/src/nsParseMailbox.cpp">annotate</a> |
<a href="/comm-central/diff/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/local/src/nsParseMailbox.cpp">diff</a> |
<a href="/comm-central/comparison/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/local/src/nsParseMailbox.cpp">comparison</a> |
<a href="/comm-central/log/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/local/src/nsParseMailbox.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/local/src/nsPop3Service.cpp">mailnews/local/src/nsPop3Service.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/local/src/nsPop3Service.cpp">file</a> |
<a href="/comm-central/annotate/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/local/src/nsPop3Service.cpp">annotate</a> |
<a href="/comm-central/diff/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/local/src/nsPop3Service.cpp">diff</a> |
<a href="/comm-central/comparison/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/local/src/nsPop3Service.cpp">comparison</a> |
<a href="/comm-central/log/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/local/src/nsPop3Service.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/news/src/nsNewsFolder.cpp">mailnews/news/src/nsNewsFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/news/src/nsNewsFolder.cpp">file</a> |
<a href="/comm-central/annotate/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/news/src/nsNewsFolder.cpp">annotate</a> |
<a href="/comm-central/diff/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/news/src/nsNewsFolder.cpp">diff</a> |
<a href="/comm-central/comparison/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/news/src/nsNewsFolder.cpp">comparison</a> |
<a href="/comm-central/log/5fa6fd01e5553af4b5057829ee4de26eec271ae7/mailnews/news/src/nsNewsFolder.cpp">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/components/migration/src/nsNetscapeProfileMigratorBase.cpp</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/components/migration/src/nsNetscapeProfileMigratorBase.cpp</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -5,17 +5,16 @@</span>
<a href="#l1.4"></a><span id="l1.4"> </span>
<a href="#l1.5"></a><span id="l1.5"> #include &quot;nsAppDirectoryServiceDefs.h&quot;</span>
<a href="#l1.6"></a><span id="l1.6"> #include &quot;nsIFile.h&quot;</span>
<a href="#l1.7"></a><span id="l1.7"> #include &quot;nsIInputStream.h&quot;</span>
<a href="#l1.8"></a><span id="l1.8"> #include &quot;nsILineInputStream.h&quot;</span>
<a href="#l1.9"></a><span id="l1.9"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l1.10"></a><span id="l1.10"> #include &quot;nsIPrefLocalizedString.h&quot;</span>
<a href="#l1.11"></a><span id="l1.11"> #include &quot;nsIPrefService.h&quot;</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-#include &quot;nsIRDFService.h&quot;</span>
<a href="#l1.13"></a><span id="l1.13"> #include &quot;nsIServiceManager.h&quot;</span>
<a href="#l1.14"></a><span id="l1.14"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l1.15"></a><span id="l1.15"> #include &quot;nsISupportsPrimitives.h&quot;</span>
<a href="#l1.16"></a><span id="l1.16"> #include &quot;nsIURL.h&quot;</span>
<a href="#l1.17"></a><span id="l1.17"> #include &quot;nsNetscapeProfileMigratorBase.h&quot;</span>
<a href="#l1.18"></a><span id="l1.18"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l1.19"></a><span id="l1.19"> #include &quot;prtime.h&quot;</span>
<a href="#l1.20"></a><span id="l1.20"> #include &quot;prprf.h&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgFilterService.cpp</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgFilterService.cpp</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -17,17 +17,16 @@</span>
<a href="#l2.4"></a><span id="l2.4"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l2.5"></a><span id="l2.5"> #include &quot;nsIMsgSearchNotify.h&quot;</span>
<a href="#l2.6"></a><span id="l2.6"> #include &quot;nsIUrlListener.h&quot;</span>
<a href="#l2.7"></a><span id="l2.7"> #include &quot;nsIMsgCopyServiceListener.h&quot;</span>
<a href="#l2.8"></a><span id="l2.8"> #include &quot;nsIMsgLocalMailFolder.h&quot;</span>
<a href="#l2.9"></a><span id="l2.9"> #include &quot;nsIMsgDatabase.h&quot;</span>
<a href="#l2.10"></a><span id="l2.10"> #include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l2.11"></a><span id="l2.11"> #include &quot;nsIDBFolderInfo.h&quot;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-#include &quot;nsIRDFService.h&quot;</span>
<a href="#l2.13"></a><span id="l2.13"> #include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l2.14"></a><span id="l2.14"> #include &quot;nsIMsgCopyService.h&quot;</span>
<a href="#l2.15"></a><span id="l2.15"> #include &quot;nsIInputStream.h&quot;</span>
<a href="#l2.16"></a><span id="l2.16"> #include &quot;nsIOutputStream.h&quot;</span>
<a href="#l2.17"></a><span id="l2.17"> #include &quot;nsISafeOutputStream.h&quot;</span>
<a href="#l2.18"></a><span id="l2.18"> #include &quot;nsIMsgComposeService.h&quot;</span>
<a href="#l2.19"></a><span id="l2.19"> #include &quot;nsMsgCompCID.h&quot;</span>
<a href="#l2.20"></a><span id="l2.20"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineat">@@ -609,23 +608,19 @@ nsresult nsMsgFilterAfterTheFact::ApplyF</span>
<a href="#l2.22"></a><span id="l2.22">         MOZ_FALLTHROUGH;</span>
<a href="#l2.23"></a><span id="l2.23">       case nsMsgFilterAction::CopyToFolder:</span>
<a href="#l2.24"></a><span id="l2.24">       {</span>
<a href="#l2.25"></a><span id="l2.25">         nsCString uri;</span>
<a href="#l2.26"></a><span id="l2.26">         curFolder-&gt;GetURI(uri);</span>
<a href="#l2.27"></a><span id="l2.27">         if (!actionTargetFolderUri.IsEmpty() &amp;&amp;</span>
<a href="#l2.28"></a><span id="l2.28">             !uri.Equals(actionTargetFolderUri))</span>
<a href="#l2.29"></a><span id="l2.29">         {</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineminus">-          nsCOMPtr&lt;nsIRDFService&gt; rdf = do_GetService(&quot;@mozilla.org/rdf/rdf-service;1&quot;,&amp;rv);</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-          nsCOMPtr&lt;nsIRDFResource&gt; res;</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineminus">-          rv = rdf-&gt;GetResource(actionTargetFolderUri, getter_AddRefs(res));</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineminus">-          CONTINUE_IF_FAILURE(rv, &quot;Could not get resource for action folder&quot;);</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineminus">-</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineminus">-          nsCOMPtr&lt;nsIMsgFolder&gt; destIFolder(do_QueryInterface(res, &amp;rv));</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineminus">-          CONTINUE_IF_FAILURE(rv, &quot;Could not QI resource to folder&quot;);</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+          nsCOMPtr&lt;nsIMsgFolder&gt; destIFolder;</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+          rv = GetOrCreateFolder(actionTargetFolderUri, getter_AddRefs(destIFolder));</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+          CONTINUE_IF_FAILURE(rv, &quot;Could not get action folder&quot;);</span>
<a href="#l2.40"></a><span id="l2.40"> </span>
<a href="#l2.41"></a><span id="l2.41">           bool canFileMessages = true;</span>
<a href="#l2.42"></a><span id="l2.42">           nsCOMPtr&lt;nsIMsgFolder&gt; parentFolder;</span>
<a href="#l2.43"></a><span id="l2.43">           destIFolder-&gt;GetParent(getter_AddRefs(parentFolder));</span>
<a href="#l2.44"></a><span id="l2.44">           if (parentFolder)</span>
<a href="#l2.45"></a><span id="l2.45">             destIFolder-&gt;GetCanFileMessages(&amp;canFileMessages);</span>
<a href="#l2.46"></a><span id="l2.46">           if (!parentFolder || !canFileMessages)</span>
<a href="#l2.47"></a><span id="l2.47">           {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/base/src/nsMessenger.cpp</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/base/src/nsMessenger.cpp</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -25,21 +25,16 @@</span>
<a href="#l3.4"></a><span id="l3.4"> #include &quot;nsIURL.h&quot;</span>
<a href="#l3.5"></a><span id="l3.5"> #include &quot;nsIPrompt.h&quot;</span>
<a href="#l3.6"></a><span id="l3.6"> #include &quot;nsIStreamListener.h&quot;</span>
<a href="#l3.7"></a><span id="l3.7"> #include &quot;nsIStreamConverterService.h&quot;</span>
<a href="#l3.8"></a><span id="l3.8"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l3.9"></a><span id="l3.9"> #include &quot;nsIFileURL.h&quot;</span>
<a href="#l3.10"></a><span id="l3.10"> #include &quot;nsIMIMEInfo.h&quot;</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-// rdf</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-#include &quot;nsIRDFResource.h&quot;</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-#include &quot;nsIRDFService.h&quot;</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">-#include &quot;nsRDFCID.h&quot;</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineminus">-</span>
<a href="#l3.17"></a><span id="l3.17"> // gecko</span>
<a href="#l3.18"></a><span id="l3.18"> #include &quot;nsLayoutCID.h&quot;</span>
<a href="#l3.19"></a><span id="l3.19"> #include &quot;nsIContentViewer.h&quot;</span>
<a href="#l3.20"></a><span id="l3.20"> </span>
<a href="#l3.21"></a><span id="l3.21"> // embedding</span>
<a href="#l3.22"></a><span id="l3.22"> #ifdef NS_PRINTING</span>
<a href="#l3.23"></a><span id="l3.23"> #include &quot;nsIWebBrowserPrint.h&quot;</span>
<a href="#l3.24"></a><span id="l3.24"> #include &quot;nsMsgPrintEngine.h&quot;</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineat">@@ -59,17 +54,16 @@</span>
<a href="#l3.26"></a><span id="l3.26"> #include &quot;nsIMsgAccountManager.h&quot;</span>
<a href="#l3.27"></a><span id="l3.27"> #include &quot;nsIMsgMailSession.h&quot;</span>
<a href="#l3.28"></a><span id="l3.28"> #include &quot;nsIMailboxUrl.h&quot;</span>
<a href="#l3.29"></a><span id="l3.29"> #include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l3.30"></a><span id="l3.30"> #include &quot;nsMsgMessageFlags.h&quot;</span>
<a href="#l3.31"></a><span id="l3.31"> #include &quot;nsIMsgIncomingServer.h&quot;</span>
<a href="#l3.32"></a><span id="l3.32"> </span>
<a href="#l3.33"></a><span id="l3.33"> #include &quot;nsIMsgMessageService.h&quot;</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineminus">-#include &quot;nsMsgRDFUtils.h&quot;</span>
<a href="#l3.35"></a><span id="l3.35"> </span>
<a href="#l3.36"></a><span id="l3.36"> #include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l3.37"></a><span id="l3.37"> #include &quot;nsIMimeMiscStatus.h&quot;</span>
<a href="#l3.38"></a><span id="l3.38"> // compose</span>
<a href="#l3.39"></a><span id="l3.39"> #include &quot;nsMsgCompCID.h&quot;</span>
<a href="#l3.40"></a><span id="l3.40"> #include &quot;nsNativeCharsetUtils.h&quot;</span>
<a href="#l3.41"></a><span id="l3.41"> </span>
<a href="#l3.42"></a><span id="l3.42"> // draft/folders/sendlater/etc</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineat">@@ -91,18 +85,16 @@</span>
<a href="#l3.44"></a><span id="l3.44"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l3.45"></a><span id="l3.45"> #include &quot;nsCExternalHandlerService.h&quot;</span>
<a href="#l3.46"></a><span id="l3.46"> #include &quot;nsIExternalProtocolService.h&quot;</span>
<a href="#l3.47"></a><span id="l3.47"> #include &quot;nsIMIMEService.h&quot;</span>
<a href="#l3.48"></a><span id="l3.48"> #include &quot;nsITransfer.h&quot;</span>
<a href="#l3.49"></a><span id="l3.49"> </span>
<a href="#l3.50"></a><span id="l3.50"> #include &quot;nsILinkHandler.h&quot;</span>
<a href="#l3.51"></a><span id="l3.51"> </span>
<a href="#l3.52"></a><span id="l3.52" class="difflineminus">-static NS_DEFINE_CID(kRDFServiceCID,  NS_RDFSERVICE_CID);</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineminus">-</span>
<a href="#l3.54"></a><span id="l3.54"> #define MESSENGER_SAVE_DIR_PREF_NAME &quot;messenger.save.dir&quot;</span>
<a href="#l3.55"></a><span id="l3.55"> #define MIMETYPE_DELETED    &quot;text/x-moz-deleted&quot;</span>
<a href="#l3.56"></a><span id="l3.56"> #define ATTACHMENT_PERMISSION 00664</span>
<a href="#l3.57"></a><span id="l3.57"> </span>
<a href="#l3.58"></a><span id="l3.58"> //</span>
<a href="#l3.59"></a><span id="l3.59"> // Convert an nsString buffer to plain text...</span>
<a href="#l3.60"></a><span id="l3.60"> //</span>
<a href="#l3.61"></a><span id="l3.61"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineat">@@ -1670,23 +1662,18 @@ NS_IMETHODIMP</span>
<a href="#l3.63"></a><span id="l3.63"> nsSaveMsgListener::OnStopRunningUrl(nsIURI *url, nsresult exitCode)</span>
<a href="#l3.64"></a><span id="l3.64"> {</span>
<a href="#l3.65"></a><span id="l3.65">   nsresult rv = exitCode;</span>
<a href="#l3.66"></a><span id="l3.66">   mUrlHasStopped = true;</span>
<a href="#l3.67"></a><span id="l3.67"> </span>
<a href="#l3.68"></a><span id="l3.68">   // ** save as template goes here</span>
<a href="#l3.69"></a><span id="l3.69">   if (!m_templateUri.IsEmpty())</span>
<a href="#l3.70"></a><span id="l3.70">   {</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineminus">-    nsCOMPtr&lt;nsIRDFService&gt; rdf(do_GetService(kRDFServiceCID, &amp;rv));</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineminus">-    if (NS_FAILED(rv)) goto done;</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineminus">-    nsCOMPtr&lt;nsIRDFResource&gt; res;</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineminus">-    rv = rdf-&gt;GetResource(m_templateUri, getter_AddRefs(res));</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineminus">-    if (NS_FAILED(rv)) goto done;</span>
<a href="#l3.76"></a><span id="l3.76">     nsCOMPtr&lt;nsIMsgFolder&gt; templateFolder;</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineminus">-    templateFolder = do_QueryInterface(res, &amp;rv);</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineplus">+    rv = GetOrCreateFolder(m_templateUri, getter_AddRefs(templateFolder));</span>
<a href="#l3.79"></a><span id="l3.79">     if (NS_FAILED(rv)) goto done;</span>
<a href="#l3.80"></a><span id="l3.80">     nsCOMPtr&lt;nsIMsgCopyService&gt; copyService = do_GetService(NS_MSGCOPYSERVICE_CONTRACTID);</span>
<a href="#l3.81"></a><span id="l3.81">     if (copyService)</span>
<a href="#l3.82"></a><span id="l3.82">     {</span>
<a href="#l3.83"></a><span id="l3.83">       nsCOMPtr&lt;nsIFile&gt; clone;</span>
<a href="#l3.84"></a><span id="l3.84">       m_file-&gt;Clone(getter_AddRefs(clone));</span>
<a href="#l3.85"></a><span id="l3.85">       rv = copyService-&gt;CopyFileMessage(clone, templateFolder, nullptr,</span>
<a href="#l3.86"></a><span id="l3.86">                                         true, nsMsgMessageFlags::Read,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/base/src/nsMsgAccountManager.cpp</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgAccountManager.cpp</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -1422,94 +1422,81 @@ nsMsgAccountManager::ReactivateAccounts(</span>
<a href="#l4.4"></a><span id="l4.4"> // correct special folder flags set, e.g, the Sent folder has</span>
<a href="#l4.5"></a><span id="l4.5"> // the sent flag set.</span>
<a href="#l4.6"></a><span id="l4.6"> //</span>
<a href="#l4.7"></a><span id="l4.7"> // it also goes through all the spam settings for each account</span>
<a href="#l4.8"></a><span id="l4.8"> // and makes sure the folder flags are set there, too</span>
<a href="#l4.9"></a><span id="l4.9"> NS_IMETHODIMP</span>
<a href="#l4.10"></a><span id="l4.10"> nsMsgAccountManager::SetSpecialFolders()</span>
<a href="#l4.11"></a><span id="l4.11"> {</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-  nsresult rv;</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-  nsCOMPtr&lt;nsIRDFService&gt; rdf = do_GetService(&quot;@mozilla.org/rdf/rdf-service;1&quot;, &amp;rv);</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineminus">-</span>
<a href="#l4.16"></a><span id="l4.16">   nsCOMPtr&lt;nsIArray&gt; identities;</span>
<a href="#l4.17"></a><span id="l4.17">   GetAllIdentities(getter_AddRefs(identities));</span>
<a href="#l4.18"></a><span id="l4.18"> </span>
<a href="#l4.19"></a><span id="l4.19">   uint32_t idCount = 0;</span>
<a href="#l4.20"></a><span id="l4.20">   identities-&gt;GetLength(&amp;idCount);</span>
<a href="#l4.21"></a><span id="l4.21"> </span>
<a href="#l4.22"></a><span id="l4.22">   uint32_t id;</span>
<a href="#l4.23"></a><span id="l4.23">   nsCString identityKey;</span>
<a href="#l4.24"></a><span id="l4.24"> </span>
<a href="#l4.25"></a><span id="l4.25">   for (id = 0; id &lt; idCount; id++)</span>
<a href="#l4.26"></a><span id="l4.26">   {</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineplus">+    nsresult rv;</span>
<a href="#l4.28"></a><span id="l4.28">     nsCOMPtr&lt;nsIMsgIdentity&gt; thisIdentity(do_QueryElementAt(identities, id, &amp;rv));</span>
<a href="#l4.29"></a><span id="l4.29">     if (NS_FAILED(rv))</span>
<a href="#l4.30"></a><span id="l4.30">       continue;</span>
<a href="#l4.31"></a><span id="l4.31"> </span>
<a href="#l4.32"></a><span id="l4.32">     if (NS_SUCCEEDED(rv) &amp;&amp; thisIdentity)</span>
<a href="#l4.33"></a><span id="l4.33">     {</span>
<a href="#l4.34"></a><span id="l4.34">       nsCString folderUri;</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineminus">-      nsCOMPtr&lt;nsIRDFResource&gt; res;</span>
<a href="#l4.36"></a><span id="l4.36">       nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+</span>
<a href="#l4.38"></a><span id="l4.38">       thisIdentity-&gt;GetFccFolder(folderUri);</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineminus">-      if (!folderUri.IsEmpty() &amp;&amp; NS_SUCCEEDED(rdf-&gt;GetResource(folderUri, getter_AddRefs(res))))</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+      if (!folderUri.IsEmpty() &amp;&amp;</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+          NS_SUCCEEDED(GetOrCreateFolder(folderUri, getter_AddRefs(folder))))</span>
<a href="#l4.42"></a><span id="l4.42">       {</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineminus">-        folder = do_QueryInterface(res, &amp;rv);</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+        nsCOMPtr &lt;nsIMsgFolder&gt; parent;</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+        rv = folder-&gt;GetParent(getter_AddRefs(parent));</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineplus">+        if (NS_SUCCEEDED(rv) &amp;&amp; parent)</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineplus">+          rv = folder-&gt;SetFlag(nsMsgFolderFlags::SentMail);</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineplus">+      }</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineplus">+</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineplus">+      thisIdentity-&gt;GetDraftFolder(folderUri);</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineplus">+      if (!folderUri.IsEmpty() &amp;&amp;</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineplus">+          NS_SUCCEEDED(GetOrCreateFolder(folderUri, getter_AddRefs(folder))))</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineplus">+      {</span>
<a href="#l4.54"></a><span id="l4.54">         nsCOMPtr &lt;nsIMsgFolder&gt; parent;</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineminus">-        if (folder &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineminus">-        {</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineminus">-          rv = folder-&gt;GetParent(getter_AddRefs(parent));</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineminus">-          if (NS_SUCCEEDED(rv) &amp;&amp; parent)</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineminus">-            rv = folder-&gt;SetFlag(nsMsgFolderFlags::SentMail);</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineminus">-        }</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineplus">+        rv = folder-&gt;GetParent(getter_AddRefs(parent));</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineplus">+        if (NS_SUCCEEDED(rv) &amp;&amp; parent)</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineplus">+          rv = folder-&gt;SetFlag(nsMsgFolderFlags::Drafts);</span>
<a href="#l4.64"></a><span id="l4.64">       }</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineminus">-      thisIdentity-&gt;GetDraftFolder(folderUri);</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineminus">-      if (!folderUri.IsEmpty() &amp;&amp; NS_SUCCEEDED(rdf-&gt;GetResource(folderUri, getter_AddRefs(res))))</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineplus">+</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineplus">+      thisIdentity-&gt;GetArchiveFolder(folderUri);</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineplus">+      if (!folderUri.IsEmpty() &amp;&amp;</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineplus">+          NS_SUCCEEDED(GetOrCreateFolder(folderUri, getter_AddRefs(folder))))</span>
<a href="#l4.71"></a><span id="l4.71">       {</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineminus">-        folder = do_QueryInterface(res, &amp;rv);</span>
<a href="#l4.73"></a><span id="l4.73">         nsCOMPtr &lt;nsIMsgFolder&gt; parent;</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineminus">-        if (folder &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineminus">-        {</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineminus">-          rv = folder-&gt;GetParent(getter_AddRefs(parent));</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineminus">-          if (NS_SUCCEEDED(rv) &amp;&amp; parent)</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineminus">-            rv = folder-&gt;SetFlag(nsMsgFolderFlags::Drafts);</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineplus">+        rv = folder-&gt;GetParent(getter_AddRefs(parent));</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineplus">+        if (NS_SUCCEEDED(rv) &amp;&amp; parent) {</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineplus">+          bool archiveEnabled;</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineplus">+          thisIdentity-&gt;GetArchiveEnabled(&amp;archiveEnabled);</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineplus">+          if (archiveEnabled)</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineplus">+            rv = folder-&gt;SetFlag(nsMsgFolderFlags::Archive);</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineplus">+          else</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineplus">+            rv = folder-&gt;ClearFlag(nsMsgFolderFlags::Archive);</span>
<a href="#l4.87"></a><span id="l4.87">         }</span>
<a href="#l4.88"></a><span id="l4.88">       }</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineminus">-      thisIdentity-&gt;GetArchiveFolder(folderUri);</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineminus">-      if (!folderUri.IsEmpty() &amp;&amp; NS_SUCCEEDED(rdf-&gt;GetResource(folderUri, getter_AddRefs(res))))</span>
<a href="#l4.91"></a><span id="l4.91" class="difflineplus">+</span>
<a href="#l4.92"></a><span id="l4.92" class="difflineplus">+      thisIdentity-&gt;GetStationeryFolder(folderUri);</span>
<a href="#l4.93"></a><span id="l4.93" class="difflineplus">+      if (!folderUri.IsEmpty() &amp;&amp;</span>
<a href="#l4.94"></a><span id="l4.94" class="difflineplus">+          NS_SUCCEEDED(GetOrCreateFolder(folderUri, getter_AddRefs(folder))))</span>
<a href="#l4.95"></a><span id="l4.95">       {</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineminus">-        folder = do_QueryInterface(res, &amp;rv);</span>
<a href="#l4.97"></a><span id="l4.97">         nsCOMPtr &lt;nsIMsgFolder&gt; parent;</span>
<a href="#l4.98"></a><span id="l4.98" class="difflineminus">-        if (folder &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineminus">-        {</span>
<a href="#l4.100"></a><span id="l4.100" class="difflineminus">-          rv = folder-&gt;GetParent(getter_AddRefs(parent));</span>
<a href="#l4.101"></a><span id="l4.101" class="difflineminus">-          if (NS_SUCCEEDED(rv) &amp;&amp; parent)</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineminus">-          {</span>
<a href="#l4.103"></a><span id="l4.103" class="difflineminus">-            bool archiveEnabled;</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineminus">-            thisIdentity-&gt;GetArchiveEnabled(&amp;archiveEnabled);</span>
<a href="#l4.105"></a><span id="l4.105" class="difflineminus">-            if (archiveEnabled)</span>
<a href="#l4.106"></a><span id="l4.106" class="difflineminus">-              rv = folder-&gt;SetFlag(nsMsgFolderFlags::Archive);</span>
<a href="#l4.107"></a><span id="l4.107" class="difflineminus">-            else</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineminus">-              rv = folder-&gt;ClearFlag(nsMsgFolderFlags::Archive);</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineminus">-          }</span>
<a href="#l4.110"></a><span id="l4.110" class="difflineminus">-        }</span>
<a href="#l4.111"></a><span id="l4.111" class="difflineminus">-      }</span>
<a href="#l4.112"></a><span id="l4.112" class="difflineminus">-      thisIdentity-&gt;GetStationeryFolder(folderUri);</span>
<a href="#l4.113"></a><span id="l4.113" class="difflineminus">-      if (!folderUri.IsEmpty() &amp;&amp; NS_SUCCEEDED(rdf-&gt;GetResource(folderUri, getter_AddRefs(res))))</span>
<a href="#l4.114"></a><span id="l4.114" class="difflineminus">-      {</span>
<a href="#l4.115"></a><span id="l4.115" class="difflineminus">-        folder = do_QueryInterface(res, &amp;rv);</span>
<a href="#l4.116"></a><span id="l4.116" class="difflineminus">-        if (folder &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l4.117"></a><span id="l4.117" class="difflineminus">-        {</span>
<a href="#l4.118"></a><span id="l4.118" class="difflineminus">-          nsCOMPtr &lt;nsIMsgFolder&gt; parent;</span>
<a href="#l4.119"></a><span id="l4.119" class="difflineminus">-          rv = folder-&gt;GetParent(getter_AddRefs(parent));</span>
<a href="#l4.120"></a><span id="l4.120" class="difflineminus">-          if (NS_SUCCEEDED(rv) &amp;&amp; parent) // only set flag if folder is real</span>
<a href="#l4.121"></a><span id="l4.121" class="difflineminus">-            rv = folder-&gt;SetFlag(nsMsgFolderFlags::Templates);</span>
<a href="#l4.122"></a><span id="l4.122" class="difflineminus">-        }</span>
<a href="#l4.123"></a><span id="l4.123" class="difflineplus">+        rv = folder-&gt;GetParent(getter_AddRefs(parent));</span>
<a href="#l4.124"></a><span id="l4.124" class="difflineplus">+        if (NS_SUCCEEDED(rv) &amp;&amp; parent)</span>
<a href="#l4.125"></a><span id="l4.125" class="difflineplus">+          folder-&gt;SetFlag(nsMsgFolderFlags::Templates);</span>
<a href="#l4.126"></a><span id="l4.126">       }</span>
<a href="#l4.127"></a><span id="l4.127">     }</span>
<a href="#l4.128"></a><span id="l4.128">   }</span>
<a href="#l4.129"></a><span id="l4.129"> </span>
<a href="#l4.130"></a><span id="l4.130">   // XXX todo</span>
<a href="#l4.131"></a><span id="l4.131">   // get all servers</span>
<a href="#l4.132"></a><span id="l4.132">   // get all spam settings for each server</span>
<a href="#l4.133"></a><span id="l4.133">   // set the JUNK folder flag on the spam folders, right?</span>
<a href="#l4.134"></a><span id="l4.134" class="difflineat">@@ -2934,22 +2921,18 @@ NS_IMETHODIMP nsMsgAccountManager::LoadV</span>
<a href="#l4.135"></a><span id="l4.135">      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.136"></a><span id="l4.136"> </span>
<a href="#l4.137"></a><span id="l4.137">      rv = fileStream-&gt;Init(file,  PR_RDONLY, 0664, false);</span>
<a href="#l4.138"></a><span id="l4.138">      nsCOMPtr &lt;nsILineInputStream&gt; lineInputStream(do_QueryInterface(fileStream));</span>
<a href="#l4.139"></a><span id="l4.139"> </span>
<a href="#l4.140"></a><span id="l4.140">     bool isMore = true;</span>
<a href="#l4.141"></a><span id="l4.141">     nsAutoCString buffer;</span>
<a href="#l4.142"></a><span id="l4.142">     int32_t version = -1;</span>
<a href="#l4.143"></a><span id="l4.143" class="difflineminus">-    nsCOMPtr &lt;nsIMsgFolder&gt; virtualFolder;</span>
<a href="#l4.144"></a><span id="l4.144" class="difflineminus">-    nsCOMPtr &lt;nsIDBFolderInfo&gt; dbFolderInfo;</span>
<a href="#l4.145"></a><span id="l4.145" class="difflineminus">-    nsCOMPtr&lt;nsIRDFResource&gt; resource;</span>
<a href="#l4.146"></a><span id="l4.146" class="difflineminus">-    nsCOMPtr&lt;nsIRDFService&gt; rdf(do_GetService(&quot;@mozilla.org/rdf/rdf-service;1&quot;, &amp;rv));</span>
<a href="#l4.147"></a><span id="l4.147" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.148"></a><span id="l4.148" class="difflineminus">-    nsCOMPtr&lt;nsIArray&gt; allFolders;</span>
<a href="#l4.149"></a><span id="l4.149" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFolder&gt; virtualFolder;</span>
<a href="#l4.150"></a><span id="l4.150" class="difflineplus">+    nsCOMPtr&lt;nsIDBFolderInfo&gt; dbFolderInfo;</span>
<a href="#l4.151"></a><span id="l4.151"> </span>
<a href="#l4.152"></a><span id="l4.152">     while (isMore &amp;&amp;</span>
<a href="#l4.153"></a><span id="l4.153">            NS_SUCCEEDED(lineInputStream-&gt;ReadLine(buffer, &amp;isMore)))</span>
<a href="#l4.154"></a><span id="l4.154">     {</span>
<a href="#l4.155"></a><span id="l4.155">       if (!buffer.IsEmpty())</span>
<a href="#l4.156"></a><span id="l4.156">       {</span>
<a href="#l4.157"></a><span id="l4.157">         if (version == -1)</span>
<a href="#l4.158"></a><span id="l4.158">         {</span>
<a href="#l4.159"></a><span id="l4.159" class="difflineat">@@ -2958,85 +2941,80 @@ NS_IMETHODIMP nsMsgAccountManager::LoadV</span>
<a href="#l4.160"></a><span id="l4.160">           version = buffer.ToInteger(&amp;irv);</span>
<a href="#l4.161"></a><span id="l4.161">           continue;</span>
<a href="#l4.162"></a><span id="l4.162">         }</span>
<a href="#l4.163"></a><span id="l4.163">         if (StringBeginsWith(buffer, NS_LITERAL_CSTRING(&quot;uri=&quot;)))</span>
<a href="#l4.164"></a><span id="l4.164">         {</span>
<a href="#l4.165"></a><span id="l4.165">           buffer.Cut(0, 4);</span>
<a href="#l4.166"></a><span id="l4.166">           dbFolderInfo = nullptr;</span>
<a href="#l4.167"></a><span id="l4.167"> </span>
<a href="#l4.168"></a><span id="l4.168" class="difflineminus">-          rv = rdf-&gt;GetResource(buffer, getter_AddRefs(resource));</span>
<a href="#l4.169"></a><span id="l4.169" class="difflineplus">+          rv = GetOrCreateFolder(buffer, getter_AddRefs(virtualFolder));</span>
<a href="#l4.170"></a><span id="l4.170">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.171"></a><span id="l4.171"> </span>
<a href="#l4.172"></a><span id="l4.172" class="difflineminus">-          virtualFolder = do_QueryInterface(resource);</span>
<a href="#l4.173"></a><span id="l4.173" class="difflineminus">-          if (!virtualFolder)</span>
<a href="#l4.174"></a><span id="l4.174" class="difflineminus">-            NS_WARNING(&quot;Failed to QI virtual folder, is this leftover from an optional account type?&quot;);</span>
<a href="#l4.175"></a><span id="l4.175" class="difflineminus">-          else</span>
<a href="#l4.176"></a><span id="l4.176" class="difflineplus">+          nsCOMPtr&lt;nsIMsgFolder&gt; grandParent;</span>
<a href="#l4.177"></a><span id="l4.177" class="difflineplus">+          nsCOMPtr&lt;nsIMsgFolder&gt; oldParent;</span>
<a href="#l4.178"></a><span id="l4.178" class="difflineplus">+          nsCOMPtr&lt;nsIMsgFolder&gt; parentFolder;</span>
<a href="#l4.179"></a><span id="l4.179" class="difflineplus">+          bool isServer;</span>
<a href="#l4.180"></a><span id="l4.180" class="difflineplus">+          // This loop handles creating virtual folders without an existing</span>
<a href="#l4.181"></a><span id="l4.181" class="difflineplus">+          // parent.</span>
<a href="#l4.182"></a><span id="l4.182" class="difflineplus">+          do</span>
<a href="#l4.183"></a><span id="l4.183">           {</span>
<a href="#l4.184"></a><span id="l4.184" class="difflineminus">-            nsCOMPtr &lt;nsIMsgFolder&gt; grandParent;</span>
<a href="#l4.185"></a><span id="l4.185" class="difflineminus">-            nsCOMPtr &lt;nsIMsgFolder&gt; oldParent;</span>
<a href="#l4.186"></a><span id="l4.186" class="difflineminus">-            nsCOMPtr &lt;nsIMsgFolder&gt; parentFolder;</span>
<a href="#l4.187"></a><span id="l4.187" class="difflineminus">-            bool isServer;</span>
<a href="#l4.188"></a><span id="l4.188" class="difflineminus">-            do</span>
<a href="#l4.189"></a><span id="l4.189" class="difflineminus">-            {</span>
<a href="#l4.190"></a><span id="l4.190" class="difflineminus">-              // need to add the folder as a sub-folder of its parent.</span>
<a href="#l4.191"></a><span id="l4.191" class="difflineminus">-              int32_t lastSlash = buffer.RFindChar('/');</span>
<a href="#l4.192"></a><span id="l4.192" class="difflineminus">-              if (lastSlash == kNotFound)</span>
<a href="#l4.193"></a><span id="l4.193" class="difflineminus">-                break;</span>
<a href="#l4.194"></a><span id="l4.194" class="difflineminus">-              nsDependentCSubstring parentUri(buffer, 0, lastSlash);</span>
<a href="#l4.195"></a><span id="l4.195" class="difflineminus">-              // hold a reference so it won't get deleted before it's parented.</span>
<a href="#l4.196"></a><span id="l4.196" class="difflineminus">-              oldParent = parentFolder;</span>
<a href="#l4.197"></a><span id="l4.197" class="difflineminus">-</span>
<a href="#l4.198"></a><span id="l4.198" class="difflineminus">-              rdf-&gt;GetResource(parentUri, getter_AddRefs(resource));</span>
<a href="#l4.199"></a><span id="l4.199" class="difflineminus">-              parentFolder = do_QueryInterface(resource);</span>
<a href="#l4.200"></a><span id="l4.200" class="difflineminus">-              if (parentFolder)</span>
<a href="#l4.201"></a><span id="l4.201" class="difflineminus">-              {</span>
<a href="#l4.202"></a><span id="l4.202" class="difflineminus">-                nsAutoString currentFolderNameStr;</span>
<a href="#l4.203"></a><span id="l4.203" class="difflineminus">-                nsAutoCString currentFolderNameCStr;</span>
<a href="#l4.204"></a><span id="l4.204" class="difflineminus">-                MsgUnescapeString(nsCString(Substring(buffer, lastSlash + 1, buffer.Length())), 0, currentFolderNameCStr);</span>
<a href="#l4.205"></a><span id="l4.205" class="difflineminus">-                CopyUTF8toUTF16(currentFolderNameCStr, currentFolderNameStr);</span>
<a href="#l4.206"></a><span id="l4.206" class="difflineminus">-                nsCOMPtr &lt;nsIMsgFolder&gt; childFolder;</span>
<a href="#l4.207"></a><span id="l4.207" class="difflineminus">-                nsCOMPtr &lt;nsIMsgDatabase&gt; db;</span>
<a href="#l4.208"></a><span id="l4.208" class="difflineminus">-                // force db to get created.</span>
<a href="#l4.209"></a><span id="l4.209" class="difflineminus">-                virtualFolder-&gt;SetParent(parentFolder);</span>
<a href="#l4.210"></a><span id="l4.210" class="difflineminus">-                rv = virtualFolder-&gt;GetMsgDatabase(getter_AddRefs(db));</span>
<a href="#l4.211"></a><span id="l4.211" class="difflineminus">-                if (rv == NS_MSG_ERROR_FOLDER_SUMMARY_MISSING)</span>
<a href="#l4.212"></a><span id="l4.212" class="difflineminus">-                  msgDBService-&gt;CreateNewDB(virtualFolder, getter_AddRefs(db));</span>
<a href="#l4.213"></a><span id="l4.213" class="difflineminus">-                if (db)</span>
<a href="#l4.214"></a><span id="l4.214" class="difflineminus">-                  rv = db-&gt;GetDBFolderInfo(getter_AddRefs(dbFolderInfo));</span>
<a href="#l4.215"></a><span id="l4.215" class="difflineminus">-                else</span>
<a href="#l4.216"></a><span id="l4.216" class="difflineminus">-                  break;</span>
<a href="#l4.217"></a><span id="l4.217" class="difflineminus">-</span>
<a href="#l4.218"></a><span id="l4.218" class="difflineminus">-                parentFolder-&gt;AddSubfolder(currentFolderNameStr, getter_AddRefs(childFolder));</span>
<a href="#l4.219"></a><span id="l4.219" class="difflineminus">-                virtualFolder-&gt;SetFlag(nsMsgFolderFlags::Virtual);</span>
<a href="#l4.220"></a><span id="l4.220" class="difflineminus">-                if (childFolder)</span>
<a href="#l4.221"></a><span id="l4.221" class="difflineminus">-                  parentFolder-&gt;NotifyItemAdded(childFolder);</span>
<a href="#l4.222"></a><span id="l4.222" class="difflineminus">-                // here we make sure if our parent is rooted - if not, we're</span>
<a href="#l4.223"></a><span id="l4.223" class="difflineminus">-                // going to loop and add our parent as a child of its grandparent</span>
<a href="#l4.224"></a><span id="l4.224" class="difflineminus">-                // and repeat until we get to the server, or a folder that</span>
<a href="#l4.225"></a><span id="l4.225" class="difflineminus">-                // has its parent set.</span>
<a href="#l4.226"></a><span id="l4.226" class="difflineminus">-                parentFolder-&gt;GetParent(getter_AddRefs(grandParent));</span>
<a href="#l4.227"></a><span id="l4.227" class="difflineminus">-                parentFolder-&gt;GetIsServer(&amp;isServer);</span>
<a href="#l4.228"></a><span id="l4.228" class="difflineminus">-                buffer.SetLength(lastSlash);</span>
<a href="#l4.229"></a><span id="l4.229" class="difflineminus">-              }</span>
<a href="#l4.230"></a><span id="l4.230" class="difflineminus">-              else</span>
<a href="#l4.231"></a><span id="l4.231" class="difflineminus">-                break;</span>
<a href="#l4.232"></a><span id="l4.232" class="difflineminus">-            } while (!grandParent &amp;&amp; !isServer);</span>
<a href="#l4.233"></a><span id="l4.233" class="difflineminus">-          }</span>
<a href="#l4.234"></a><span id="l4.234" class="difflineplus">+            // need to add the folder as a sub-folder of its parent.</span>
<a href="#l4.235"></a><span id="l4.235" class="difflineplus">+            int32_t lastSlash = buffer.RFindChar('/');</span>
<a href="#l4.236"></a><span id="l4.236" class="difflineplus">+            if (lastSlash == kNotFound)</span>
<a href="#l4.237"></a><span id="l4.237" class="difflineplus">+              break;</span>
<a href="#l4.238"></a><span id="l4.238" class="difflineplus">+            nsDependentCSubstring parentUri(buffer, 0, lastSlash);</span>
<a href="#l4.239"></a><span id="l4.239" class="difflineplus">+            // hold a reference so it won't get deleted before it's parented.</span>
<a href="#l4.240"></a><span id="l4.240" class="difflineplus">+            oldParent = parentFolder;</span>
<a href="#l4.241"></a><span id="l4.241" class="difflineplus">+</span>
<a href="#l4.242"></a><span id="l4.242" class="difflineplus">+            rv = GetOrCreateFolder(parentUri, getter_AddRefs(parentFolder));</span>
<a href="#l4.243"></a><span id="l4.243" class="difflineplus">+            NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.244"></a><span id="l4.244" class="difflineplus">+</span>
<a href="#l4.245"></a><span id="l4.245" class="difflineplus">+            nsAutoString currentFolderNameStr;</span>
<a href="#l4.246"></a><span id="l4.246" class="difflineplus">+            nsAutoCString currentFolderNameCStr;</span>
<a href="#l4.247"></a><span id="l4.247" class="difflineplus">+            MsgUnescapeString(nsCString(Substring(buffer, lastSlash + 1, buffer.Length())), 0, currentFolderNameCStr);</span>
<a href="#l4.248"></a><span id="l4.248" class="difflineplus">+            CopyUTF8toUTF16(currentFolderNameCStr, currentFolderNameStr);</span>
<a href="#l4.249"></a><span id="l4.249" class="difflineplus">+            nsCOMPtr&lt;nsIMsgFolder&gt; childFolder;</span>
<a href="#l4.250"></a><span id="l4.250" class="difflineplus">+            nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l4.251"></a><span id="l4.251" class="difflineplus">+            // force db to get created.</span>
<a href="#l4.252"></a><span id="l4.252" class="difflineplus">+            // XXX TODO: is this SetParent() right? Won't it screw up if virtual</span>
<a href="#l4.253"></a><span id="l4.253" class="difflineplus">+            // folder is nested &gt;2 deep? Leave for now, but revisit when getting</span>
<a href="#l4.254"></a><span id="l4.254" class="difflineplus">+            // rid of dangling folders (BenC).</span>
<a href="#l4.255"></a><span id="l4.255" class="difflineplus">+            virtualFolder-&gt;SetParent(parentFolder);</span>
<a href="#l4.256"></a><span id="l4.256" class="difflineplus">+            rv = virtualFolder-&gt;GetMsgDatabase(getter_AddRefs(db));</span>
<a href="#l4.257"></a><span id="l4.257" class="difflineplus">+            if (rv == NS_MSG_ERROR_FOLDER_SUMMARY_MISSING)</span>
<a href="#l4.258"></a><span id="l4.258" class="difflineplus">+              msgDBService-&gt;CreateNewDB(virtualFolder, getter_AddRefs(db));</span>
<a href="#l4.259"></a><span id="l4.259" class="difflineplus">+            if (db)</span>
<a href="#l4.260"></a><span id="l4.260" class="difflineplus">+              rv = db-&gt;GetDBFolderInfo(getter_AddRefs(dbFolderInfo));</span>
<a href="#l4.261"></a><span id="l4.261" class="difflineplus">+            else</span>
<a href="#l4.262"></a><span id="l4.262" class="difflineplus">+              break;</span>
<a href="#l4.263"></a><span id="l4.263" class="difflineplus">+</span>
<a href="#l4.264"></a><span id="l4.264" class="difflineplus">+            parentFolder-&gt;AddSubfolder(currentFolderNameStr, getter_AddRefs(childFolder));</span>
<a href="#l4.265"></a><span id="l4.265" class="difflineplus">+            virtualFolder-&gt;SetFlag(nsMsgFolderFlags::Virtual);</span>
<a href="#l4.266"></a><span id="l4.266" class="difflineplus">+            if (childFolder)</span>
<a href="#l4.267"></a><span id="l4.267" class="difflineplus">+              parentFolder-&gt;NotifyItemAdded(childFolder);</span>
<a href="#l4.268"></a><span id="l4.268" class="difflineplus">+            // here we make sure if our parent is rooted - if not, we're</span>
<a href="#l4.269"></a><span id="l4.269" class="difflineplus">+            // going to loop and add our parent as a child of its grandparent</span>
<a href="#l4.270"></a><span id="l4.270" class="difflineplus">+            // and repeat until we get to the server, or a folder that</span>
<a href="#l4.271"></a><span id="l4.271" class="difflineplus">+            // has its parent set.</span>
<a href="#l4.272"></a><span id="l4.272" class="difflineplus">+            parentFolder-&gt;GetParent(getter_AddRefs(grandParent));</span>
<a href="#l4.273"></a><span id="l4.273" class="difflineplus">+            parentFolder-&gt;GetIsServer(&amp;isServer);</span>
<a href="#l4.274"></a><span id="l4.274" class="difflineplus">+            buffer.SetLength(lastSlash);</span>
<a href="#l4.275"></a><span id="l4.275" class="difflineplus">+          } while (!grandParent &amp;&amp; !isServer);</span>
<a href="#l4.276"></a><span id="l4.276">         }</span>
<a href="#l4.277"></a><span id="l4.277">         else if (dbFolderInfo &amp;&amp; StringBeginsWith(buffer, NS_LITERAL_CSTRING(&quot;scope=&quot;)))</span>
<a href="#l4.278"></a><span id="l4.278">         {</span>
<a href="#l4.279"></a><span id="l4.279">           buffer.Cut(0, 6);</span>
<a href="#l4.280"></a><span id="l4.280">           // if this is a cross folder virtual folder, we have a list of folders uris,</span>
<a href="#l4.281"></a><span id="l4.281">           // and we have to add a pending listener for each of them.</span>
<a href="#l4.282"></a><span id="l4.282">           if (!buffer.IsEmpty())</span>
<a href="#l4.283"></a><span id="l4.283">           {</span>
<a href="#l4.284"></a><span id="l4.284" class="difflineminus">-            ParseAndVerifyVirtualFolderScope(buffer, rdf);</span>
<a href="#l4.285"></a><span id="l4.285" class="difflineplus">+            ParseAndVerifyVirtualFolderScope(buffer);</span>
<a href="#l4.286"></a><span id="l4.286">             dbFolderInfo-&gt;SetCharProperty(kSearchFolderUriProp, buffer);</span>
<a href="#l4.287"></a><span id="l4.287" class="difflineminus">-            AddVFListenersForVF(virtualFolder, buffer, rdf, msgDBService);</span>
<a href="#l4.288"></a><span id="l4.288" class="difflineplus">+            AddVFListenersForVF(virtualFolder, buffer, msgDBService);</span>
<a href="#l4.289"></a><span id="l4.289">           }</span>
<a href="#l4.290"></a><span id="l4.290">         }</span>
<a href="#l4.291"></a><span id="l4.291">         else if (dbFolderInfo &amp;&amp; StringBeginsWith(buffer, NS_LITERAL_CSTRING(&quot;terms=&quot;)))</span>
<a href="#l4.292"></a><span id="l4.292">         {</span>
<a href="#l4.293"></a><span id="l4.293">           buffer.Cut(0, 6);</span>
<a href="#l4.294"></a><span id="l4.294">           dbFolderInfo-&gt;SetCharProperty(&quot;searchStr&quot;, buffer);</span>
<a href="#l4.295"></a><span id="l4.295">         }</span>
<a href="#l4.296"></a><span id="l4.296">         else if (dbFolderInfo &amp;&amp; StringBeginsWith(buffer, NS_LITERAL_CSTRING(&quot;searchOnline=&quot;)))</span>
<a href="#l4.297"></a><span id="l4.297" class="difflineat">@@ -3090,39 +3068,38 @@ NS_IMETHODIMP nsMsgAccountManager::SaveV</span>
<a href="#l4.298"></a><span id="l4.298">                                              getter_AddRefs(virtualFolders));</span>
<a href="#l4.299"></a><span id="l4.299">         if (NS_FAILED(rv)) {</span>
<a href="#l4.300"></a><span id="l4.300">           continue;</span>
<a href="#l4.301"></a><span id="l4.301">         }</span>
<a href="#l4.302"></a><span id="l4.302">         uint32_t vfCount;</span>
<a href="#l4.303"></a><span id="l4.303">         virtualFolders-&gt;GetLength(&amp;vfCount);</span>
<a href="#l4.304"></a><span id="l4.304">         for (uint32_t folderIndex = 0; folderIndex &lt; vfCount; folderIndex++)</span>
<a href="#l4.305"></a><span id="l4.305">         {</span>
<a href="#l4.306"></a><span id="l4.306" class="difflineminus">-          nsCOMPtr &lt;nsIRDFResource&gt; folderRes (do_QueryElementAt(virtualFolders, folderIndex));</span>
<a href="#l4.307"></a><span id="l4.307" class="difflineminus">-          nsCOMPtr &lt;nsIMsgFolder&gt; msgFolder = do_QueryInterface(folderRes);</span>
<a href="#l4.308"></a><span id="l4.308" class="difflineminus">-          const char *uri;</span>
<a href="#l4.309"></a><span id="l4.309" class="difflineminus">-          nsCOMPtr &lt;nsIMsgDatabase&gt; db;</span>
<a href="#l4.310"></a><span id="l4.310" class="difflineminus">-          nsCOMPtr &lt;nsIDBFolderInfo&gt; dbFolderInfo;</span>
<a href="#l4.311"></a><span id="l4.311" class="difflineplus">+          nsCOMPtr&lt;nsIMsgFolder&gt; msgFolder(do_QueryElementAt(virtualFolders, folderIndex));</span>
<a href="#l4.312"></a><span id="l4.312" class="difflineplus">+          nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l4.313"></a><span id="l4.313" class="difflineplus">+          nsCOMPtr&lt;nsIDBFolderInfo&gt; dbFolderInfo;</span>
<a href="#l4.314"></a><span id="l4.314">           rv = msgFolder-&gt;GetDBFolderInfoAndDB(getter_AddRefs(dbFolderInfo), getter_AddRefs(db)); // force db to get created.</span>
<a href="#l4.315"></a><span id="l4.315">           if (dbFolderInfo)</span>
<a href="#l4.316"></a><span id="l4.316">           {</span>
<a href="#l4.317"></a><span id="l4.317">             nsCString srchFolderUri;</span>
<a href="#l4.318"></a><span id="l4.318">             nsCString searchTerms;</span>
<a href="#l4.319"></a><span id="l4.319">             nsCString regexScope;</span>
<a href="#l4.320"></a><span id="l4.320">             nsCString vfFolderFlag;</span>
<a href="#l4.321"></a><span id="l4.321">             bool searchOnline = false;</span>
<a href="#l4.322"></a><span id="l4.322">             dbFolderInfo-&gt;GetBooleanProperty(&quot;searchOnline&quot;, false, &amp;searchOnline);</span>
<a href="#l4.323"></a><span id="l4.323">             dbFolderInfo-&gt;GetCharProperty(kSearchFolderUriProp, srchFolderUri);</span>
<a href="#l4.324"></a><span id="l4.324">             dbFolderInfo-&gt;GetCharProperty(&quot;searchStr&quot;, searchTerms);</span>
<a href="#l4.325"></a><span id="l4.325">             // logically searchFolderFlag is an int, but since we want to</span>
<a href="#l4.326"></a><span id="l4.326">             // write out a string, get it as a string.</span>
<a href="#l4.327"></a><span id="l4.327">             dbFolderInfo-&gt;GetCharProperty(SEARCH_FOLDER_FLAG, vfFolderFlag);</span>
<a href="#l4.328"></a><span id="l4.328" class="difflineminus">-            folderRes-&gt;GetValueConst(&amp;uri);</span>
<a href="#l4.329"></a><span id="l4.329" class="difflineplus">+            nsCString uri;</span>
<a href="#l4.330"></a><span id="l4.330" class="difflineplus">+            msgFolder-&gt;GetURI(uri);</span>
<a href="#l4.331"></a><span id="l4.331">             if (!srchFolderUri.IsEmpty() &amp;&amp; !searchTerms.IsEmpty())</span>
<a href="#l4.332"></a><span id="l4.332">             {</span>
<a href="#l4.333"></a><span id="l4.333" class="difflineminus">-              WriteLineToOutputStream(&quot;uri=&quot;, uri, outStream);</span>
<a href="#l4.334"></a><span id="l4.334" class="difflineplus">+              WriteLineToOutputStream(&quot;uri=&quot;, uri.get(), outStream);</span>
<a href="#l4.335"></a><span id="l4.335">               if (!vfFolderFlag.IsEmpty())</span>
<a href="#l4.336"></a><span id="l4.336">                 WriteLineToOutputStream(SEARCH_FOLDER_FLAG&quot;=&quot;, vfFolderFlag.get(), outStream);</span>
<a href="#l4.337"></a><span id="l4.337">               WriteLineToOutputStream(&quot;scope=&quot;, srchFolderUri.get(), outStream);</span>
<a href="#l4.338"></a><span id="l4.338">               WriteLineToOutputStream(&quot;terms=&quot;, searchTerms.get(), outStream);</span>
<a href="#l4.339"></a><span id="l4.339">               WriteLineToOutputStream(&quot;searchOnline=&quot;, searchOnline ? &quot;true&quot; : &quot;false&quot;, outStream);</span>
<a href="#l4.340"></a><span id="l4.340">             }</span>
<a href="#l4.341"></a><span id="l4.341">           }</span>
<a href="#l4.342"></a><span id="l4.342">         }</span>
<a href="#l4.343"></a><span id="l4.343" class="difflineat">@@ -3151,63 +3128,58 @@ nsresult nsMsgAccountManager::WriteLineT</span>
<a href="#l4.344"></a><span id="l4.344"> }</span>
<a href="#l4.345"></a><span id="l4.345"> </span>
<a href="#l4.346"></a><span id="l4.346"> /**</span>
<a href="#l4.347"></a><span id="l4.347">  * Parse the '|' separated folder uri string into individual folders, verify</span>
<a href="#l4.348"></a><span id="l4.348">  * that the folders are real. If we were to add things like wildcards, we</span>
<a href="#l4.349"></a><span id="l4.349">  * could implement the expansion into real folders here.</span>
<a href="#l4.350"></a><span id="l4.350">  *</span>
<a href="#l4.351"></a><span id="l4.351">  * @param buffer On input, list of folder uri's, on output, verified list.</span>
<a href="#l4.352"></a><span id="l4.352" class="difflineminus">- * @param rdf rdf service</span>
<a href="#l4.353"></a><span id="l4.353">  */</span>
<a href="#l4.354"></a><span id="l4.354" class="difflineminus">-void nsMsgAccountManager::ParseAndVerifyVirtualFolderScope(nsCString &amp;buffer,</span>
<a href="#l4.355"></a><span id="l4.355" class="difflineminus">-                                                           nsIRDFService *rdf)</span>
<a href="#l4.356"></a><span id="l4.356" class="difflineplus">+void nsMsgAccountManager::ParseAndVerifyVirtualFolderScope(nsCString &amp;buffer)</span>
<a href="#l4.357"></a><span id="l4.357"> {</span>
<a href="#l4.358"></a><span id="l4.358">   nsCString verifiedFolders;</span>
<a href="#l4.359"></a><span id="l4.359">   nsTArray&lt;nsCString&gt; folderUris;</span>
<a href="#l4.360"></a><span id="l4.360">   ParseString(buffer, '|', folderUris);</span>
<a href="#l4.361"></a><span id="l4.361" class="difflineminus">-  nsCOMPtr &lt;nsIRDFResource&gt; resource;</span>
<a href="#l4.362"></a><span id="l4.362">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l4.363"></a><span id="l4.363">   nsCOMPtr&lt;nsIMsgFolder&gt; parent;</span>
<a href="#l4.364"></a><span id="l4.364"> </span>
<a href="#l4.365"></a><span id="l4.365">   for (uint32_t i = 0; i &lt; folderUris.Length(); i++)</span>
<a href="#l4.366"></a><span id="l4.366">   {</span>
<a href="#l4.367"></a><span id="l4.367" class="difflineminus">-    rdf-&gt;GetResource(folderUris[i], getter_AddRefs(resource));</span>
<a href="#l4.368"></a><span id="l4.368" class="difflineminus">-    nsCOMPtr &lt;nsIMsgFolder&gt; realFolder = do_QueryInterface(resource);</span>
<a href="#l4.369"></a><span id="l4.369" class="difflineminus">-    if (!realFolder)</span>
<a href="#l4.370"></a><span id="l4.370" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFolder&gt; realFolder;</span>
<a href="#l4.371"></a><span id="l4.371" class="difflineplus">+    nsresult rv = GetOrCreateFolder(folderUris[i], getter_AddRefs(realFolder));</span>
<a href="#l4.372"></a><span id="l4.372" class="difflineplus">+    if (!NS_SUCCEEDED(rv)) {</span>
<a href="#l4.373"></a><span id="l4.373">       continue;</span>
<a href="#l4.374"></a><span id="l4.374" class="difflineplus">+    }</span>
<a href="#l4.375"></a><span id="l4.375">     realFolder-&gt;GetParent(getter_AddRefs(parent));</span>
<a href="#l4.376"></a><span id="l4.376">     if (!parent)</span>
<a href="#l4.377"></a><span id="l4.377">       continue;</span>
<a href="#l4.378"></a><span id="l4.378">     realFolder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l4.379"></a><span id="l4.379">     if (!server)</span>
<a href="#l4.380"></a><span id="l4.380">       continue;</span>
<a href="#l4.381"></a><span id="l4.381">     if (!verifiedFolders.IsEmpty())</span>
<a href="#l4.382"></a><span id="l4.382">       verifiedFolders.Append('|');</span>
<a href="#l4.383"></a><span id="l4.383">     verifiedFolders.Append(folderUris[i]);</span>
<a href="#l4.384"></a><span id="l4.384">   }</span>
<a href="#l4.385"></a><span id="l4.385">   buffer.Assign(verifiedFolders);</span>
<a href="#l4.386"></a><span id="l4.386"> }</span>
<a href="#l4.387"></a><span id="l4.387"> </span>
<a href="#l4.388"></a><span id="l4.388"> // This conveniently works to add a single folder as well.</span>
<a href="#l4.389"></a><span id="l4.389"> nsresult nsMsgAccountManager::AddVFListenersForVF(nsIMsgFolder *virtualFolder,</span>
<a href="#l4.390"></a><span id="l4.390">                                                   const nsCString&amp; srchFolderUris,</span>
<a href="#l4.391"></a><span id="l4.391" class="difflineminus">-                                                  nsIRDFService *rdf,</span>
<a href="#l4.392"></a><span id="l4.392">                                                   nsIMsgDBService *msgDBService)</span>
<a href="#l4.393"></a><span id="l4.393"> {</span>
<a href="#l4.394"></a><span id="l4.394">   nsTArray&lt;nsCString&gt; folderUris;</span>
<a href="#l4.395"></a><span id="l4.395">   ParseString(srchFolderUris, '|', folderUris);</span>
<a href="#l4.396"></a><span id="l4.396" class="difflineminus">-  nsCOMPtr &lt;nsIRDFResource&gt; resource;</span>
<a href="#l4.397"></a><span id="l4.397"> </span>
<a href="#l4.398"></a><span id="l4.398">   for (uint32_t i = 0; i &lt; folderUris.Length(); i++)</span>
<a href="#l4.399"></a><span id="l4.399">   {</span>
<a href="#l4.400"></a><span id="l4.400" class="difflineminus">-    rdf-&gt;GetResource(folderUris[i], getter_AddRefs(resource));</span>
<a href="#l4.401"></a><span id="l4.401" class="difflineminus">-    nsCOMPtr &lt;nsIMsgFolder&gt; realFolder = do_QueryInterface(resource);</span>
<a href="#l4.402"></a><span id="l4.402" class="difflineminus">-    if (!realFolder)</span>
<a href="#l4.403"></a><span id="l4.403" class="difflineminus">-      continue;</span>
<a href="#l4.404"></a><span id="l4.404" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFolder&gt; realFolder;</span>
<a href="#l4.405"></a><span id="l4.405" class="difflineplus">+    nsresult rv = GetOrCreateFolder(folderUris[i], getter_AddRefs(realFolder));</span>
<a href="#l4.406"></a><span id="l4.406" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.407"></a><span id="l4.407">     RefPtr&lt;VirtualFolderChangeListener&gt; dbListener = new VirtualFolderChangeListener();</span>
<a href="#l4.408"></a><span id="l4.408">     NS_ENSURE_TRUE(dbListener, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l4.409"></a><span id="l4.409">     dbListener-&gt;m_virtualFolder = virtualFolder;</span>
<a href="#l4.410"></a><span id="l4.410">     dbListener-&gt;m_folderWatching = realFolder;</span>
<a href="#l4.411"></a><span id="l4.411">     if (NS_FAILED(dbListener-&gt;Init()))</span>
<a href="#l4.412"></a><span id="l4.412">     {</span>
<a href="#l4.413"></a><span id="l4.413">       dbListener = nullptr;</span>
<a href="#l4.414"></a><span id="l4.414">       continue;</span>
<a href="#l4.415"></a><span id="l4.415" class="difflineat">@@ -3394,18 +3366,17 @@ NS_IMETHODIMP nsMsgAccountManager::OnIte</span>
<a href="#l4.416"></a><span id="l4.416">     if (msgDBService)</span>
<a href="#l4.417"></a><span id="l4.417">     {</span>
<a href="#l4.418"></a><span id="l4.418">       nsCOMPtr &lt;nsIMsgDatabase&gt; virtDatabase;</span>
<a href="#l4.419"></a><span id="l4.419">       nsCOMPtr &lt;nsIDBFolderInfo&gt; dbFolderInfo;</span>
<a href="#l4.420"></a><span id="l4.420">       rv = folder-&gt;GetDBFolderInfoAndDB(getter_AddRefs(dbFolderInfo), getter_AddRefs(virtDatabase));</span>
<a href="#l4.421"></a><span id="l4.421">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.422"></a><span id="l4.422">       nsCString srchFolderUri;</span>
<a href="#l4.423"></a><span id="l4.423">       dbFolderInfo-&gt;GetCharProperty(kSearchFolderUriProp, srchFolderUri);</span>
<a href="#l4.424"></a><span id="l4.424" class="difflineminus">-      nsCOMPtr&lt;nsIRDFService&gt; rdf(do_GetService(&quot;@mozilla.org/rdf/rdf-service;1&quot;, &amp;rv));</span>
<a href="#l4.425"></a><span id="l4.425" class="difflineminus">-      AddVFListenersForVF(folder, srchFolderUri, rdf, msgDBService);</span>
<a href="#l4.426"></a><span id="l4.426" class="difflineplus">+      AddVFListenersForVF(folder, srchFolderUri, msgDBService);</span>
<a href="#l4.427"></a><span id="l4.427">     }</span>
<a href="#l4.428"></a><span id="l4.428">     rv = SaveVirtualFolders();</span>
<a href="#l4.429"></a><span id="l4.429">   }</span>
<a href="#l4.430"></a><span id="l4.430">   return rv;</span>
<a href="#l4.431"></a><span id="l4.431"> }</span>
<a href="#l4.432"></a><span id="l4.432"> </span>
<a href="#l4.433"></a><span id="l4.433"> NS_IMETHODIMP nsMsgAccountManager::OnItemRemoved(nsIMsgFolder *parentItem, nsISupports *item)</span>
<a href="#l4.434"></a><span id="l4.434"> {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/base/src/nsMsgAccountManager.h</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgAccountManager.h</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -181,21 +181,19 @@ private:</span>
<a href="#l5.4"></a><span id="l5.4">                               const nsACString&amp; type,</span>
<a href="#l5.5"></a><span id="l5.5">                               int32_t port,</span>
<a href="#l5.6"></a><span id="l5.6">                               bool aRealFlag,</span>
<a href="#l5.7"></a><span id="l5.7">                               nsIMsgIncomingServer** aResult);</span>
<a href="#l5.8"></a><span id="l5.8"> </span>
<a href="#l5.9"></a><span id="l5.9">   // handle virtual folders</span>
<a href="#l5.10"></a><span id="l5.10">   static nsresult GetVirtualFoldersFile(nsCOMPtr&lt;nsIFile&gt;&amp; file);</span>
<a href="#l5.11"></a><span id="l5.11">   static nsresult WriteLineToOutputStream(const char *prefix, const char * line, nsIOutputStream *outputStream);</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-  void     ParseAndVerifyVirtualFolderScope(nsCString &amp;buffer,</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-                                            nsIRDFService *rdf);</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+  void ParseAndVerifyVirtualFolderScope(nsCString &amp;buffer);</span>
<a href="#l5.15"></a><span id="l5.15">   nsresult AddVFListenersForVF(nsIMsgFolder *virtualFolder,</span>
<a href="#l5.16"></a><span id="l5.16">                                const nsCString&amp; srchFolderUris,</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineminus">-                               nsIRDFService *rdf,</span>
<a href="#l5.18"></a><span id="l5.18">                                nsIMsgDBService *msgDBService);</span>
<a href="#l5.19"></a><span id="l5.19"> </span>
<a href="#l5.20"></a><span id="l5.20">   nsresult RemoveVFListenerForVF(nsIMsgFolder *virtualFolder,</span>
<a href="#l5.21"></a><span id="l5.21">                                  nsIMsgFolder *folder);</span>
<a href="#l5.22"></a><span id="l5.22"> </span>
<a href="#l5.23"></a><span id="l5.23">   void getUniqueAccountKey(nsCString&amp; aResult);</span>
<a href="#l5.24"></a><span id="l5.24"> </span>
<a href="#l5.25"></a><span id="l5.25">   // Scan the preferences to find a unique server key</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/base/src/nsSpamSettings.cpp</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/base/src/nsSpamSettings.cpp</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -9,18 +9,16 @@</span>
<a href="#l6.4"></a><span id="l6.4"> #include &quot;prmem.h&quot;</span>
<a href="#l6.5"></a><span id="l6.5"> #include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l6.6"></a><span id="l6.6"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l6.7"></a><span id="l6.7"> #include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l6.8"></a><span id="l6.8"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l6.9"></a><span id="l6.9"> #include &quot;nsMsgFolderFlags.h&quot;</span>
<a href="#l6.10"></a><span id="l6.10"> #include &quot;nsImapCore.h&quot;</span>
<a href="#l6.11"></a><span id="l6.11"> #include &quot;nsIImapIncomingServer.h&quot;</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-#include &quot;nsIRDFService.h&quot;</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-#include &quot;nsIRDFResource.h&quot;</span>
<a href="#l6.14"></a><span id="l6.14"> #include &quot;nsAppDirectoryServiceDefs.h&quot;</span>
<a href="#l6.15"></a><span id="l6.15"> #include &quot;nsIPrefService.h&quot;</span>
<a href="#l6.16"></a><span id="l6.16"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l6.17"></a><span id="l6.17"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l6.18"></a><span id="l6.18"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l6.19"></a><span id="l6.19"> #include &quot;mozilla/mailnews/MimeHeaderParser.h&quot;</span>
<a href="#l6.20"></a><span id="l6.20"> #include &quot;nsIArray.h&quot;</span>
<a href="#l6.21"></a><span id="l6.21"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineat">@@ -500,38 +498,31 @@ NS_IMETHODIMP nsSpamSettings::GetSpamFol</span>
<a href="#l6.23"></a><span id="l6.23"> </span>
<a href="#l6.24"></a><span id="l6.24">   if (mMoveTargetMode == nsISpamSettings::MOVE_TARGET_MODE_FOLDER)</span>
<a href="#l6.25"></a><span id="l6.25">     return GetActionTargetFolder(aSpamFolderURI);</span>
<a href="#l6.26"></a><span id="l6.26"> </span>
<a href="#l6.27"></a><span id="l6.27">   // if the mode is nsISpamSettings::MOVE_TARGET_MODE_ACCOUNT</span>
<a href="#l6.28"></a><span id="l6.28">   // the spam folder URI = account uri + &quot;/Junk&quot;</span>
<a href="#l6.29"></a><span id="l6.29">   nsCString folderURI;</span>
<a href="#l6.30"></a><span id="l6.30">   nsresult rv = GetActionTargetAccount(getter_Copies(folderURI));</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.33"></a><span id="l6.33"> </span>
<a href="#l6.34"></a><span id="l6.34">   // we might be trying to get the old spam folder uri</span>
<a href="#l6.35"></a><span id="l6.35">   // in order to clear the flag</span>
<a href="#l6.36"></a><span id="l6.36">   // if we didn't have one, bail out.</span>
<a href="#l6.37"></a><span id="l6.37">   if (folderURI.IsEmpty())</span>
<a href="#l6.38"></a><span id="l6.38">     return NS_OK;</span>
<a href="#l6.39"></a><span id="l6.39"> </span>
<a href="#l6.40"></a><span id="l6.40" class="difflineminus">-  nsCOMPtr&lt;nsIRDFService&gt; rdf(do_GetService(&quot;@mozilla.org/rdf/rdf-service;1&quot;, &amp;rv));</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineminus">-</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineminus">-  nsCOMPtr&lt;nsIRDFResource&gt; folderResource;</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineminus">-  rv = rdf-&gt;GetResource(folderURI, getter_AddRefs(folderResource));</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineplus">+  rv = GetOrCreateFolder(folderURI, getter_AddRefs(folder));</span>
<a href="#l6.47"></a><span id="l6.47">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.48"></a><span id="l6.48"> </span>
<a href="#l6.49"></a><span id="l6.49" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFolder&gt; folder = do_QueryInterface(folderResource);</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineminus">-  if (!folder)</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineminus">-    return NS_ERROR_UNEXPECTED;</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineminus">-</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineminus">-  nsCOMPtr &lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineplus">+  nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l6.55"></a><span id="l6.55">   rv = folder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.58"></a><span id="l6.58"> </span>
<a href="#l6.59"></a><span id="l6.59">   // see nsMsgFolder::SetPrettyName() for where the pretty name is set.</span>
<a href="#l6.60"></a><span id="l6.60"> </span>
<a href="#l6.61"></a><span id="l6.61">   // Check for an existing junk folder - this will do a case-insensitive</span>
<a href="#l6.62"></a><span id="l6.62">   // search by URI - if we find a junk folder, use its URI.</span>
<a href="#l6.63"></a><span id="l6.63">   nsCOMPtr&lt;nsIMsgFolder&gt; junkFolder;</span>
<a href="#l6.64"></a><span id="l6.64">   folderURI.AppendLiteral(&quot;/Junk&quot;);</span>
<a href="#l6.65"></a><span id="l6.65">   if (NS_SUCCEEDED(server-&gt;GetMsgFolderFromURI(nullptr, folderURI,</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineat">@@ -774,18 +765,16 @@ NS_IMETHODIMP nsSpamSettings::OnStopRunn</span>
<a href="#l6.67"></a><span id="l6.67"> </span>
<a href="#l6.68"></a><span id="l6.68">   if (junkFolderURI.IsEmpty())</span>
<a href="#l6.69"></a><span id="l6.69">     return NS_ERROR_UNEXPECTED;</span>
<a href="#l6.70"></a><span id="l6.70"> </span>
<a href="#l6.71"></a><span id="l6.71">   // when we get here, the folder should exist.</span>
<a href="#l6.72"></a><span id="l6.72">   nsCOMPtr &lt;nsIMsgFolder&gt; junkFolder;</span>
<a href="#l6.73"></a><span id="l6.73">   rv = GetExistingFolder(junkFolderURI, getter_AddRefs(junkFolder));</span>
<a href="#l6.74"></a><span id="l6.74">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineminus">-  if (!junkFolder)</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineminus">-    return NS_ERROR_UNEXPECTED;</span>
<a href="#l6.77"></a><span id="l6.77"> </span>
<a href="#l6.78"></a><span id="l6.78">   rv = junkFolder-&gt;SetFlag(nsMsgFolderFlags::Junk);</span>
<a href="#l6.79"></a><span id="l6.79">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l6.80"></a><span id="l6.80">   return rv;</span>
<a href="#l6.81"></a><span id="l6.81"> }</span>
<a href="#l6.82"></a><span id="l6.82"> </span>
<a href="#l6.83"></a><span id="l6.83"> NS_IMETHODIMP nsSpamSettings::CheckWhiteList(nsIMsgDBHdr *aMsgHdr, bool *aResult)</span>
<a href="#l6.84"></a><span id="l6.84"> {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/base/util/nsMsgDBFolder.cpp</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgDBFolder.cpp</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -4,17 +4,16 @@</span>
<a href="#l7.4"></a><span id="l7.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l7.5"></a><span id="l7.5"> </span>
<a href="#l7.6"></a><span id="l7.6"> #include &quot;msgCore.h&quot;</span>
<a href="#l7.7"></a><span id="l7.7"> #include &quot;nsUnicharUtils.h&quot;</span>
<a href="#l7.8"></a><span id="l7.8"> #include &quot;nsMsgDBFolder.h&quot;</span>
<a href="#l7.9"></a><span id="l7.9"> #include &quot;nsMsgFolderFlags.h&quot;</span>
<a href="#l7.10"></a><span id="l7.10"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l7.11"></a><span id="l7.11"> #include &quot;nsIPrefService.h&quot;</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-#include &quot;nsRDFCID.h&quot;</span>
<a href="#l7.13"></a><span id="l7.13"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l7.14"></a><span id="l7.14"> #include &quot;nsIMsgFolderCache.h&quot;</span>
<a href="#l7.15"></a><span id="l7.15"> #include &quot;nsIMsgFolderCacheElement.h&quot;</span>
<a href="#l7.16"></a><span id="l7.16"> #include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l7.17"></a><span id="l7.17"> #include &quot;nsIMsgMailNewsUrl.h&quot;</span>
<a href="#l7.18"></a><span id="l7.18"> #include &quot;nsMsgDatabase.h&quot;</span>
<a href="#l7.19"></a><span id="l7.19"> #include &quot;nsIMsgAccountManager.h&quot;</span>
<a href="#l7.20"></a><span id="l7.20"> #include &quot;nsISeekableStream.h&quot;</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineat">@@ -29,17 +28,16 @@</span>
<a href="#l7.22"></a><span id="l7.22"> #include &quot;nsIInterfaceRequestorUtils.h&quot;</span>
<a href="#l7.23"></a><span id="l7.23"> #include &quot;nsCollationCID.h&quot;</span>
<a href="#l7.24"></a><span id="l7.24"> #include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l7.25"></a><span id="l7.25"> #include &quot;nsIAbCard.h&quot;</span>
<a href="#l7.26"></a><span id="l7.26"> #include &quot;nsIAbDirectory.h&quot;</span>
<a href="#l7.27"></a><span id="l7.27"> #include &quot;nsISpamSettings.h&quot;</span>
<a href="#l7.28"></a><span id="l7.28"> #include &quot;nsIMsgFilterPlugin.h&quot;</span>
<a href="#l7.29"></a><span id="l7.29"> #include &quot;nsIMsgMailSession.h&quot;</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineminus">-#include &quot;nsIRDFService.h&quot;</span>
<a href="#l7.31"></a><span id="l7.31"> #include &quot;nsTextFormatter.h&quot;</span>
<a href="#l7.32"></a><span id="l7.32"> #include &quot;nsMsgDBCID.h&quot;</span>
<a href="#l7.33"></a><span id="l7.33"> #include &quot;nsReadLine.h&quot;</span>
<a href="#l7.34"></a><span id="l7.34"> #include &quot;nsLayoutCID.h&quot;</span>
<a href="#l7.35"></a><span id="l7.35"> #include &quot;nsIParserUtils.h&quot;</span>
<a href="#l7.36"></a><span id="l7.36"> #include &quot;nsIDocumentEncoder.h&quot;</span>
<a href="#l7.37"></a><span id="l7.37"> #include &quot;nsMsgI18N.h&quot;</span>
<a href="#l7.38"></a><span id="l7.38"> #include &quot;nsIMIMEHeaderParam.h&quot;</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineat">@@ -78,18 +76,16 @@ static PRTime gtimeOfLastPurgeCheck;  //</span>
<a href="#l7.40"></a><span id="l7.40"> #define PREF_MAIL_PURGE_THRESHOLD &quot;mail.purge_threshhold&quot;</span>
<a href="#l7.41"></a><span id="l7.41"> #define PREF_MAIL_PURGE_THRESHOLD_MB &quot;mail.purge_threshhold_mb&quot;</span>
<a href="#l7.42"></a><span id="l7.42"> #define PREF_MAIL_PURGE_MIGRATED &quot;mail.purge_threshold_migrated&quot;</span>
<a href="#l7.43"></a><span id="l7.43"> #define PREF_MAIL_PURGE_ASK &quot;mail.purge.ask&quot;</span>
<a href="#l7.44"></a><span id="l7.44"> #define PREF_MAIL_WARN_FILTER_CHANGED &quot;mail.warn_filter_changed&quot;</span>
<a href="#l7.45"></a><span id="l7.45"> </span>
<a href="#l7.46"></a><span id="l7.46"> const char *kUseServerRetentionProp = &quot;useServerRetention&quot;;</span>
<a href="#l7.47"></a><span id="l7.47"> </span>
<a href="#l7.48"></a><span id="l7.48" class="difflineminus">-static NS_DEFINE_CID(kRDFServiceCID, NS_RDFSERVICE_CID);</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineminus">-</span>
<a href="#l7.50"></a><span id="l7.50"> nsICollation * nsMsgDBFolder::gCollationKeyGenerator = nullptr;</span>
<a href="#l7.51"></a><span id="l7.51"> </span>
<a href="#l7.52"></a><span id="l7.52"> nsString nsMsgDBFolder::kLocalizedInboxName;</span>
<a href="#l7.53"></a><span id="l7.53"> nsString nsMsgDBFolder::kLocalizedTrashName;</span>
<a href="#l7.54"></a><span id="l7.54"> nsString nsMsgDBFolder::kLocalizedSentName;</span>
<a href="#l7.55"></a><span id="l7.55"> nsString nsMsgDBFolder::kLocalizedDraftsName;</span>
<a href="#l7.56"></a><span id="l7.56"> nsString nsMsgDBFolder::kLocalizedTemplatesName;</span>
<a href="#l7.57"></a><span id="l7.57"> nsString nsMsgDBFolder::kLocalizedUnsentName;</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineat">@@ -2999,39 +2995,23 @@ NS_IMETHODIMP</span>
<a href="#l7.59"></a><span id="l7.59"> nsMsgDBFolder::GetSubFolders(nsISimpleEnumerator **aResult)</span>
<a href="#l7.60"></a><span id="l7.60"> {</span>
<a href="#l7.61"></a><span id="l7.61">   return aResult ? NS_NewArrayEnumerator(aResult, mSubFolders, NS_GET_IID(nsIMsgFolder)) : NS_ERROR_NULL_POINTER;</span>
<a href="#l7.62"></a><span id="l7.62"> }</span>
<a href="#l7.63"></a><span id="l7.63"> </span>
<a href="#l7.64"></a><span id="l7.64"> NS_IMETHODIMP</span>
<a href="#l7.65"></a><span id="l7.65"> nsMsgDBFolder::FindSubFolder(const nsACString&amp; aEscapedSubFolderName, nsIMsgFolder **aFolder)</span>
<a href="#l7.66"></a><span id="l7.66"> {</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineminus">-  nsresult rv = NS_OK;</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineminus">-  nsCOMPtr&lt;nsIRDFService&gt; rdf(do_GetService(kRDFServiceCID, &amp;rv));</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineminus">-</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineminus">-    return rv;</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineminus">-</span>
<a href="#l7.73"></a><span id="l7.73">   // XXX use necko here</span>
<a href="#l7.74"></a><span id="l7.74">   nsAutoCString uri;</span>
<a href="#l7.75"></a><span id="l7.75">   uri.Append(mURI);</span>
<a href="#l7.76"></a><span id="l7.76">   uri.Append('/');</span>
<a href="#l7.77"></a><span id="l7.77">   uri.Append(aEscapedSubFolderName);</span>
<a href="#l7.78"></a><span id="l7.78"> </span>
<a href="#l7.79"></a><span id="l7.79" class="difflineminus">-  nsCOMPtr&lt;nsIRDFResource&gt; res;</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineminus">-  rv = rdf-&gt;GetResource(uri, getter_AddRefs(res));</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineminus">-    return rv;</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineminus">-</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineminus">-  nsCOMPtr&lt;nsIMsgFolder&gt; folder(do_QueryInterface(res, &amp;rv));</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineminus">-    return rv;</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineminus">-</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineminus">-  folder.forget(aFolder);</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineminus">-  return NS_OK;</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineplus">+  return GetOrCreateFolder(uri, aFolder);</span>
<a href="#l7.91"></a><span id="l7.91"> }</span>
<a href="#l7.92"></a><span id="l7.92"> </span>
<a href="#l7.93"></a><span id="l7.93"> NS_IMETHODIMP</span>
<a href="#l7.94"></a><span id="l7.94"> nsMsgDBFolder::GetHasSubFolders(bool *_retval)</span>
<a href="#l7.95"></a><span id="l7.95"> {</span>
<a href="#l7.96"></a><span id="l7.96">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l7.97"></a><span id="l7.97">   *_retval = mSubFolders.Count() &gt; 0;</span>
<a href="#l7.98"></a><span id="l7.98">   return NS_OK;</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineat">@@ -3738,18 +3718,16 @@ NS_IMETHODIMP nsMsgDBFolder::CreateSubfo</span>
<a href="#l7.100"></a><span id="l7.100"> </span>
<a href="#l7.101"></a><span id="l7.101"> NS_IMETHODIMP nsMsgDBFolder::AddSubfolder(const nsAString&amp; name,</span>
<a href="#l7.102"></a><span id="l7.102">                                           nsIMsgFolder** child)</span>
<a href="#l7.103"></a><span id="l7.103"> {</span>
<a href="#l7.104"></a><span id="l7.104">   NS_ENSURE_ARG_POINTER(child);</span>
<a href="#l7.105"></a><span id="l7.105"> </span>
<a href="#l7.106"></a><span id="l7.106">   int32_t flags = 0;</span>
<a href="#l7.107"></a><span id="l7.107">   nsresult rv;</span>
<a href="#l7.108"></a><span id="l7.108" class="difflineminus">-  nsCOMPtr&lt;nsIRDFService&gt; rdf = do_GetService(&quot;@mozilla.org/rdf/rdf-service;1&quot;, &amp;rv);</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l7.110"></a><span id="l7.110"> </span>
<a href="#l7.111"></a><span id="l7.111">   nsAutoCString uri(mURI);</span>
<a href="#l7.112"></a><span id="l7.112">   uri.Append('/');</span>
<a href="#l7.113"></a><span id="l7.113"> </span>
<a href="#l7.114"></a><span id="l7.114">   // URI should use UTF-8</span>
<a href="#l7.115"></a><span id="l7.115">   // (see RFC2396 Uniform Resource Identifiers (URI): Generic Syntax)</span>
<a href="#l7.116"></a><span id="l7.116">   nsAutoCString escapedName;</span>
<a href="#l7.117"></a><span id="l7.117">   rv = NS_MsgEscapeEncodeURLPath(name, escapedName);</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineat">@@ -3785,24 +3763,19 @@ NS_IMETHODIMP nsMsgDBFolder::AddSubfolde</span>
<a href="#l7.119"></a><span id="l7.119">   else</span>
<a href="#l7.120"></a><span id="l7.120">     uri += escapedName.get();</span>
<a href="#l7.121"></a><span id="l7.121"> </span>
<a href="#l7.122"></a><span id="l7.122">   nsCOMPtr &lt;nsIMsgFolder&gt; msgFolder;</span>
<a href="#l7.123"></a><span id="l7.123">   rv = GetChildWithURI(uri, false/*deep*/, true /*case Insensitive*/, getter_AddRefs(msgFolder));</span>
<a href="#l7.124"></a><span id="l7.124">   if (NS_SUCCEEDED(rv) &amp;&amp; msgFolder)</span>
<a href="#l7.125"></a><span id="l7.125">     return NS_MSG_FOLDER_EXISTS;</span>
<a href="#l7.126"></a><span id="l7.126"> </span>
<a href="#l7.127"></a><span id="l7.127" class="difflineminus">-  nsCOMPtr&lt;nsIRDFResource&gt; res;</span>
<a href="#l7.128"></a><span id="l7.128" class="difflineminus">-  rv = rdf-&gt;GetResource(uri, getter_AddRefs(res));</span>
<a href="#l7.129"></a><span id="l7.129" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l7.130"></a><span id="l7.130" class="difflineminus">-    return rv;</span>
<a href="#l7.131"></a><span id="l7.131" class="difflineminus">-</span>
<a href="#l7.132"></a><span id="l7.132" class="difflineminus">-  nsCOMPtr&lt;nsIMsgFolder&gt; folder(do_QueryInterface(res, &amp;rv));</span>
<a href="#l7.133"></a><span id="l7.133" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l7.134"></a><span id="l7.134" class="difflineminus">-    return rv;</span>
<a href="#l7.135"></a><span id="l7.135" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l7.136"></a><span id="l7.136" class="difflineplus">+  rv = GetOrCreateFolder(uri, getter_AddRefs(folder));</span>
<a href="#l7.137"></a><span id="l7.137" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.138"></a><span id="l7.138"> </span>
<a href="#l7.139"></a><span id="l7.139">   folder-&gt;GetFlags((uint32_t *)&amp;flags);</span>
<a href="#l7.140"></a><span id="l7.140">   flags |= nsMsgFolderFlags::Mail;</span>
<a href="#l7.141"></a><span id="l7.141">   folder-&gt;SetParent(this);</span>
<a href="#l7.142"></a><span id="l7.142"> </span>
<a href="#l7.143"></a><span id="l7.143">   bool isServer;</span>
<a href="#l7.144"></a><span id="l7.144">   rv = GetIsServer(&amp;isServer);</span>
<a href="#l7.145"></a><span id="l7.145"> </span>
<a href="#l7.146"></a><span id="l7.146" class="difflineat">@@ -4485,17 +4458,17 @@ NS_IMETHODIMP nsMsgDBFolder::GetFoldersW</span>
<a href="#l7.147"></a><span id="l7.147">   array.forget(aResult);</span>
<a href="#l7.148"></a><span id="l7.148">   return NS_OK;</span>
<a href="#l7.149"></a><span id="l7.149"> }</span>
<a href="#l7.150"></a><span id="l7.150"> </span>
<a href="#l7.151"></a><span id="l7.151"> NS_IMETHODIMP nsMsgDBFolder::ListFoldersWithFlags(uint32_t aFlags, nsIMutableArray* aFolders)</span>
<a href="#l7.152"></a><span id="l7.152"> {</span>
<a href="#l7.153"></a><span id="l7.153">   NS_ENSURE_ARG_POINTER(aFolders);</span>
<a href="#l7.154"></a><span id="l7.154">   if ((mFlags &amp; aFlags) == aFlags)</span>
<a href="#l7.155"></a><span id="l7.155" class="difflineminus">-    aFolders-&gt;AppendElement(static_cast&lt;nsRDFResource*&gt;(this));</span>
<a href="#l7.156"></a><span id="l7.156" class="difflineplus">+    aFolders-&gt;AppendElement(static_cast&lt;nsIMsgFolder*&gt;(this));</span>
<a href="#l7.157"></a><span id="l7.157"> </span>
<a href="#l7.158"></a><span id="l7.158">   nsCOMPtr&lt;nsISimpleEnumerator&gt; dummy;</span>
<a href="#l7.159"></a><span id="l7.159">   GetSubFolders(getter_AddRefs(dummy)); // initialize mSubFolders</span>
<a href="#l7.160"></a><span id="l7.160"> </span>
<a href="#l7.161"></a><span id="l7.161">   int32_t count = mSubFolders.Count();</span>
<a href="#l7.162"></a><span id="l7.162">   for (int32_t i = 0; i &lt; count; ++i)</span>
<a href="#l7.163"></a><span id="l7.163">     mSubFolders[i]-&gt;ListFoldersWithFlags(aFlags, aFolders);</span>
<a href="#l7.164"></a><span id="l7.164"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/base/util/nsMsgIdentity.cpp</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgIdentity.cpp</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -3,33 +3,29 @@</span>
<a href="#l8.4"></a><span id="l8.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l8.5"></a><span id="l8.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l8.6"></a><span id="l8.6"> </span>
<a href="#l8.7"></a><span id="l8.7"> #include &quot;msgCore.h&quot; // for pre-compiled headers</span>
<a href="#l8.8"></a><span id="l8.8"> #include &quot;nsMsgIdentity.h&quot;</span>
<a href="#l8.9"></a><span id="l8.9"> #include &quot;nsIPrefService.h&quot;</span>
<a href="#l8.10"></a><span id="l8.10"> #include &quot;nsString.h&quot;</span>
<a href="#l8.11"></a><span id="l8.11"> #include &quot;nsMsgCompCID.h&quot;</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-#include &quot;nsIRDFService.h&quot;</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-#include &quot;nsIRDFResource.h&quot;</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineminus">-#include &quot;nsRDFCID.h&quot;</span>
<a href="#l8.15"></a><span id="l8.15"> #include &quot;nsMsgFolderFlags.h&quot;</span>
<a href="#l8.16"></a><span id="l8.16"> #include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l8.17"></a><span id="l8.17"> #include &quot;nsIMsgIncomingServer.h&quot;</span>
<a href="#l8.18"></a><span id="l8.18"> #include &quot;nsIMsgAccountManager.h&quot;</span>
<a href="#l8.19"></a><span id="l8.19"> #include &quot;mozilla/mailnews/MimeHeaderParser.h&quot;</span>
<a href="#l8.20"></a><span id="l8.20"> #include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l8.21"></a><span id="l8.21"> #include &quot;prprf.h&quot;</span>
<a href="#l8.22"></a><span id="l8.22"> #include &quot;nsISupportsPrimitives.h&quot;</span>
<a href="#l8.23"></a><span id="l8.23"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l8.24"></a><span id="l8.24"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l8.25"></a><span id="l8.25"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l8.26"></a><span id="l8.26"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l8.27"></a><span id="l8.27"> </span>
<a href="#l8.28"></a><span id="l8.28" class="difflineminus">-static NS_DEFINE_CID(kRDFServiceCID, NS_RDFSERVICE_CID);</span>
<a href="#l8.29"></a><span id="l8.29"> </span>
<a href="#l8.30"></a><span id="l8.30"> #define REL_FILE_PREF_SUFFIX &quot;-rel&quot;</span>
<a href="#l8.31"></a><span id="l8.31"> </span>
<a href="#l8.32"></a><span id="l8.32"> NS_IMPL_ISUPPORTS(nsMsgIdentity,</span>
<a href="#l8.33"></a><span id="l8.33">                    nsIMsgIdentity)</span>
<a href="#l8.34"></a><span id="l8.34"> </span>
<a href="#l8.35"></a><span id="l8.35"> /*</span>
<a href="#l8.36"></a><span id="l8.36">  * accessors for pulling values directly out of preferences</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineat">@@ -280,44 +276,35 @@ nsresult</span>
<a href="#l8.38"></a><span id="l8.38"> nsMsgIdentity::getFolderPref(const char *prefname, nsCString&amp; retval,</span>
<a href="#l8.39"></a><span id="l8.39">                              const char *folderName, uint32_t folderflag)</span>
<a href="#l8.40"></a><span id="l8.40"> {</span>
<a href="#l8.41"></a><span id="l8.41">   if (!mPrefBranch)</span>
<a href="#l8.42"></a><span id="l8.42">     return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l8.43"></a><span id="l8.43"> </span>
<a href="#l8.44"></a><span id="l8.44">   nsresult rv = mPrefBranch-&gt;GetCharPref(prefname, retval);</span>
<a href="#l8.45"></a><span id="l8.45">   if (NS_SUCCEEDED(rv) &amp;&amp; !retval.IsEmpty()) {</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineminus">-    // get the corresponding RDF resource</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineminus">-    // RDF will create the folder resource if it doesn't already exist</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineminus">-    nsCOMPtr&lt;nsIRDFService&gt; rdf(do_GetService(kRDFServiceCID, &amp;rv));</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineminus">-    nsCOMPtr&lt;nsIRDFResource&gt; resource;</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineminus">-    rdf-&gt;GetResource(retval, getter_AddRefs(resource));</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineminus">-</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineminus">-    nsCOMPtr &lt;nsIMsgFolder&gt; folderResource = do_QueryInterface(resource);</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineminus">-    if (folderResource)</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineplus">+    rv = GetOrCreateFolder(retval, getter_AddRefs(folder));</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineplus">+    nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineplus">+    // Make sure that folder hierarchy is built so that legitimate parent-child relationship is established.</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineplus">+    folder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineplus">+    if (server)</span>
<a href="#l8.62"></a><span id="l8.62">     {</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineminus">-      // don't check validity of folder - caller will handle creating it</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineminus">-      nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineminus">-      //make sure that folder hierarchy is built so that legitimate parent-child relationship is established</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineminus">-      folderResource-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineminus">-      if (server)</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineplus">+      nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineplus">+      nsCOMPtr&lt;nsIMsgFolder&gt; deferredToRootFolder;</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineplus">+      server-&gt;GetRootFolder(getter_AddRefs(rootFolder));</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineplus">+      server-&gt;GetRootMsgFolder(getter_AddRefs(deferredToRootFolder));</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineplus">+      // check if we're using a deferred account - if not, use the uri;</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineplus">+      // otherwise, fall through to code that will fix this pref.</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineplus">+      if (rootFolder == deferredToRootFolder)</span>
<a href="#l8.75"></a><span id="l8.75">       {</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineminus">-        nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineminus">-        nsCOMPtr&lt;nsIMsgFolder&gt; deferredToRootFolder;</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineminus">-        server-&gt;GetRootFolder(getter_AddRefs(rootFolder));</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineminus">-        server-&gt;GetRootMsgFolder(getter_AddRefs(deferredToRootFolder));</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineminus">-        // check if we're using a deferred account - if not, use the uri;</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineminus">-        // otherwise, fall through to code that will fix this pref.</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineminus">-        if (rootFolder == deferredToRootFolder)</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineminus">-        {</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineminus">-          nsCOMPtr &lt;nsIMsgFolder&gt; msgFolder;</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineminus">-          rv = server-&gt;GetMsgFolderFromURI(folderResource, retval, getter_AddRefs(msgFolder));</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineminus">-          return NS_SUCCEEDED(rv) ? msgFolder-&gt;GetURI(retval) : rv;</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineminus">-        }</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineplus">+        nsCOMPtr&lt;nsIMsgFolder&gt; msgFolder;</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineplus">+        rv = server-&gt;GetMsgFolderFromURI(folder, retval, getter_AddRefs(msgFolder));</span>
<a href="#l8.90"></a><span id="l8.90" class="difflineplus">+        return NS_SUCCEEDED(rv) ? msgFolder-&gt;GetURI(retval) : rv;</span>
<a href="#l8.91"></a><span id="l8.91">       }</span>
<a href="#l8.92"></a><span id="l8.92">     }</span>
<a href="#l8.93"></a><span id="l8.93">   }</span>
<a href="#l8.94"></a><span id="l8.94"> </span>
<a href="#l8.95"></a><span id="l8.95">   // if the server doesn't exist, fall back to the default pref.</span>
<a href="#l8.96"></a><span id="l8.96">   rv = mDefPrefBranch-&gt;GetCharPref(prefname, retval);</span>
<a href="#l8.97"></a><span id="l8.97">   if (NS_SUCCEEDED(rv) &amp;&amp; !retval.IsEmpty())</span>
<a href="#l8.98"></a><span id="l8.98">     return setFolderPref(prefname, retval, folderflag);</span>
<a href="#l8.99"></a><span id="l8.99" class="difflineat">@@ -364,19 +351,17 @@ nsMsgIdentity::getFolderPref(const char </span>
<a href="#l8.100"></a><span id="l8.100"> nsresult</span>
<a href="#l8.101"></a><span id="l8.101"> nsMsgIdentity::setFolderPref(const char *prefname, const nsACString&amp; value, uint32_t folderflag)</span>
<a href="#l8.102"></a><span id="l8.102"> {</span>
<a href="#l8.103"></a><span id="l8.103">   if (!mPrefBranch)</span>
<a href="#l8.104"></a><span id="l8.104">     return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l8.105"></a><span id="l8.105"> </span>
<a href="#l8.106"></a><span id="l8.106">   nsCString oldpref;</span>
<a href="#l8.107"></a><span id="l8.107">   nsresult rv;</span>
<a href="#l8.108"></a><span id="l8.108" class="difflineminus">-  nsCOMPtr&lt;nsIRDFResource&gt; res;</span>
<a href="#l8.109"></a><span id="l8.109">   nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l8.110"></a><span id="l8.110" class="difflineminus">-  nsCOMPtr&lt;nsIRDFService&gt; rdf(do_GetService(kRDFServiceCID, &amp;rv));</span>
<a href="#l8.111"></a><span id="l8.111"> </span>
<a href="#l8.112"></a><span id="l8.112">   if (folderflag == nsMsgFolderFlags::SentMail)</span>
<a href="#l8.113"></a><span id="l8.113">   {</span>
<a href="#l8.114"></a><span id="l8.114">     // Clear the temporary return receipt filter so that the new filter</span>
<a href="#l8.115"></a><span id="l8.115">     // rule can be recreated (by ConfigureTemporaryFilters()).</span>
<a href="#l8.116"></a><span id="l8.116">     nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l8.117"></a><span id="l8.117">       do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l8.118"></a><span id="l8.118">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l8.119"></a><span id="l8.119" class="difflineat">@@ -393,36 +378,29 @@ nsMsgIdentity::setFolderPref(const char </span>
<a href="#l8.120"></a><span id="l8.120">         server-&gt;ClearTemporaryReturnReceiptsFilter(); // okay to fail; no need to check for return code</span>
<a href="#l8.121"></a><span id="l8.121">     }</span>
<a href="#l8.122"></a><span id="l8.122">   }</span>
<a href="#l8.123"></a><span id="l8.123"> </span>
<a href="#l8.124"></a><span id="l8.124">   // get the old folder, and clear the special folder flag on it</span>
<a href="#l8.125"></a><span id="l8.125">   rv = mPrefBranch-&gt;GetCharPref(prefname, oldpref);</span>
<a href="#l8.126"></a><span id="l8.126">   if (NS_SUCCEEDED(rv) &amp;&amp; !oldpref.IsEmpty())</span>
<a href="#l8.127"></a><span id="l8.127">   {</span>
<a href="#l8.128"></a><span id="l8.128" class="difflineminus">-    rv = rdf-&gt;GetResource(oldpref, getter_AddRefs(res));</span>
<a href="#l8.129"></a><span id="l8.129" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; res)</span>
<a href="#l8.130"></a><span id="l8.130" class="difflineminus">-    {</span>
<a href="#l8.131"></a><span id="l8.131" class="difflineminus">-      folder = do_QueryInterface(res, &amp;rv);</span>
<a href="#l8.132"></a><span id="l8.132" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l8.133"></a><span id="l8.133" class="difflineminus">-        rv = folder-&gt;ClearFlag(folderflag);</span>
<a href="#l8.134"></a><span id="l8.134" class="difflineplus">+    rv = GetOrCreateFolder(oldpref, getter_AddRefs(folder));</span>
<a href="#l8.135"></a><span id="l8.135" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l8.136"></a><span id="l8.136" class="difflineplus">+      rv = folder-&gt;ClearFlag(folderflag);</span>
<a href="#l8.137"></a><span id="l8.137">     }</span>
<a href="#l8.138"></a><span id="l8.138">   }</span>
<a href="#l8.139"></a><span id="l8.139"> </span>
<a href="#l8.140"></a><span id="l8.140">   // set the new folder, and set the special folder flags on it</span>
<a href="#l8.141"></a><span id="l8.141">   rv = SetCharAttribute(prefname, value);</span>
<a href="#l8.142"></a><span id="l8.142">   if (NS_SUCCEEDED(rv) &amp;&amp; !value.IsEmpty())</span>
<a href="#l8.143"></a><span id="l8.143">   {</span>
<a href="#l8.144"></a><span id="l8.144" class="difflineminus">-    rv = rdf-&gt;GetResource(value, getter_AddRefs(res));</span>
<a href="#l8.145"></a><span id="l8.145" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; res)</span>
<a href="#l8.146"></a><span id="l8.146" class="difflineminus">-    {</span>
<a href="#l8.147"></a><span id="l8.147" class="difflineminus">-      folder = do_QueryInterface(res, &amp;rv);</span>
<a href="#l8.148"></a><span id="l8.148" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l8.149"></a><span id="l8.149" class="difflineminus">-        rv = folder-&gt;SetFlag(folderflag);</span>
<a href="#l8.150"></a><span id="l8.150" class="difflineminus">-    }</span>
<a href="#l8.151"></a><span id="l8.151" class="difflineplus">+    rv = GetOrCreateFolder(value, getter_AddRefs(folder));</span>
<a href="#l8.152"></a><span id="l8.152" class="difflineplus">+    if (NS_SUCCEEDED(rv))</span>
<a href="#l8.153"></a><span id="l8.153" class="difflineplus">+      rv = folder-&gt;SetFlag(folderflag);</span>
<a href="#l8.154"></a><span id="l8.154">   }</span>
<a href="#l8.155"></a><span id="l8.155">   return rv;</span>
<a href="#l8.156"></a><span id="l8.156"> }</span>
<a href="#l8.157"></a><span id="l8.157"> </span>
<a href="#l8.158"></a><span id="l8.158"> NS_IMETHODIMP nsMsgIdentity::SetUnicharAttribute(const char *aName, const nsAString&amp; val)</span>
<a href="#l8.159"></a><span id="l8.159"> {</span>
<a href="#l8.160"></a><span id="l8.160">   if (!mPrefBranch)</span>
<a href="#l8.161"></a><span id="l8.161">     return NS_ERROR_NOT_INITIALIZED;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/base/util/nsMsgIncomingServer.cpp</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgIncomingServer.cpp</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -393,30 +393,19 @@ nsMsgIncomingServer::CreateLocalFolder(c</span>
<a href="#l9.4"></a><span id="l9.4"> nsresult</span>
<a href="#l9.5"></a><span id="l9.5"> nsMsgIncomingServer::CreateRootFolder()</span>
<a href="#l9.6"></a><span id="l9.6"> {</span>
<a href="#l9.7"></a><span id="l9.7">   nsresult rv;</span>
<a href="#l9.8"></a><span id="l9.8">   // get the URI from the incoming server</span>
<a href="#l9.9"></a><span id="l9.9">   nsCString serverUri;</span>
<a href="#l9.10"></a><span id="l9.10">   rv = GetServerURI(serverUri);</span>
<a href="#l9.11"></a><span id="l9.11">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-  nsCOMPtr&lt;nsIRDFService&gt; rdf = do_GetService(&quot;@mozilla.org/rdf/rdf-service;1&quot;, &amp;rv);</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+  rv = GetOrCreateFolder(serverUri, getter_AddRefs(m_rootFolder));</span>
<a href="#l9.15"></a><span id="l9.15">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineminus">-</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineminus">-  // get the corresponding RDF resource</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineminus">-  // RDF will create the server resource if it doesn't already exist</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineminus">-  nsCOMPtr&lt;nsIRDFResource&gt; serverResource;</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineminus">-  rv = rdf-&gt;GetResource(serverUri, getter_AddRefs(serverResource));</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineminus">-</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineminus">-  // make incoming server know about its root server folder so we</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineminus">-  // can find sub-folders given an incoming server.</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineminus">-  m_rootFolder = do_QueryInterface(serverResource, &amp;rv);</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineminus">-  return rv;</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.28"></a><span id="l9.28"> }</span>
<a href="#l9.29"></a><span id="l9.29"> </span>
<a href="#l9.30"></a><span id="l9.30"> NS_IMETHODIMP</span>
<a href="#l9.31"></a><span id="l9.31"> nsMsgIncomingServer::GetBoolValue(const char *prefname,</span>
<a href="#l9.32"></a><span id="l9.32">                                  bool *val)</span>
<a href="#l9.33"></a><span id="l9.33"> {</span>
<a href="#l9.34"></a><span id="l9.34">   if (!mPrefBranch)</span>
<a href="#l9.35"></a><span id="l9.35">     return NS_ERROR_NOT_INITIALIZED;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/base/util/nsMsgUtils.cpp</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgUtils.cpp</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -21,17 +21,16 @@</span>
<a href="#l10.4"></a><span id="l10.4"> #include &quot;nsMsgImapCID.h&quot;</span>
<a href="#l10.5"></a><span id="l10.5"> #include &quot;nsMsgI18N.h&quot;</span>
<a href="#l10.6"></a><span id="l10.6"> #include &quot;nsNativeCharsetUtils.h&quot;</span>
<a href="#l10.7"></a><span id="l10.7"> #include &quot;nsCharTraits.h&quot;</span>
<a href="#l10.8"></a><span id="l10.8"> #include &quot;prprf.h&quot;</span>
<a href="#l10.9"></a><span id="l10.9"> #include &quot;prmem.h&quot;</span>
<a href="#l10.10"></a><span id="l10.10"> #include &quot;nsNetCID.h&quot;</span>
<a href="#l10.11"></a><span id="l10.11"> #include &quot;nsIIOService.h&quot;</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-#include &quot;nsIRDFService.h&quot;</span>
<a href="#l10.13"></a><span id="l10.13"> #include &quot;nsIMimeConverter.h&quot;</span>
<a href="#l10.14"></a><span id="l10.14"> #include &quot;nsMsgMimeCID.h&quot;</span>
<a href="#l10.15"></a><span id="l10.15"> #include &quot;nsIPrefService.h&quot;</span>
<a href="#l10.16"></a><span id="l10.16"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l10.17"></a><span id="l10.17"> #include &quot;nsISupportsPrimitives.h&quot;</span>
<a href="#l10.18"></a><span id="l10.18"> #include &quot;nsIPrefLocalizedString.h&quot;</span>
<a href="#l10.19"></a><span id="l10.19"> #include &quot;nsIRelativeFilePref.h&quot;</span>
<a href="#l10.20"></a><span id="l10.20"> #include &quot;mozilla/nsRelativeFilePref.h&quot;</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineat">@@ -868,38 +867,31 @@ nsresult IsRFC822HeaderFieldName(const c</span>
<a href="#l10.22"></a><span id="l10.22">   return NS_OK;</span>
<a href="#l10.23"></a><span id="l10.23"> }</span>
<a href="#l10.24"></a><span id="l10.24"> </span>
<a href="#l10.25"></a><span id="l10.25"> // Warning, currently this routine only works for the Junk Folder</span>
<a href="#l10.26"></a><span id="l10.26"> nsresult</span>
<a href="#l10.27"></a><span id="l10.27"> GetOrCreateJunkFolder(const nsACString &amp;aURI, nsIUrlListener *aListener)</span>
<a href="#l10.28"></a><span id="l10.28"> {</span>
<a href="#l10.29"></a><span id="l10.29">   nsresult rv;</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineminus">-  nsCOMPtr &lt;nsIRDFService&gt; rdf = do_GetService(&quot;@mozilla.org/rdf/rdf-service;1&quot;, &amp;rv);</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.32"></a><span id="l10.32"> </span>
<a href="#l10.33"></a><span id="l10.33" class="difflineminus">-  // get the corresponding RDF resource</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineminus">-  // RDF will create the folder resource if it doesn't already exist</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineminus">-  nsCOMPtr&lt;nsIRDFResource&gt; resource;</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineminus">-  rv = rdf-&gt;GetResource(aURI, getter_AddRefs(resource));</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineminus">-</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineminus">-  nsCOMPtr&lt;nsIMsgFolder&gt; folderResource = do_QueryInterface(resource, &amp;rv);</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineplus">+  rv = GetOrCreateFolder(aURI, getter_AddRefs(folder));</span>
<a href="#l10.42"></a><span id="l10.42">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.43"></a><span id="l10.43"> </span>
<a href="#l10.44"></a><span id="l10.44">   // don't check validity of folder - caller will handle creating it</span>
<a href="#l10.45"></a><span id="l10.45">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l10.46"></a><span id="l10.46">   // make sure that folder hierarchy is built so that legitimate parent-child relationship is established</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineminus">-  rv = folderResource-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineplus">+  rv = folder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l10.49"></a><span id="l10.49">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.50"></a><span id="l10.50">   if (!server)</span>
<a href="#l10.51"></a><span id="l10.51">     return NS_ERROR_UNEXPECTED;</span>
<a href="#l10.52"></a><span id="l10.52"> </span>
<a href="#l10.53"></a><span id="l10.53">   nsCOMPtr &lt;nsIMsgFolder&gt; msgFolder;</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineminus">-  rv = server-&gt;GetMsgFolderFromURI(folderResource, aURI, getter_AddRefs(msgFolder));</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineplus">+  rv = server-&gt;GetMsgFolderFromURI(folder, aURI, getter_AddRefs(msgFolder));</span>
<a href="#l10.56"></a><span id="l10.56">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.57"></a><span id="l10.57"> </span>
<a href="#l10.58"></a><span id="l10.58">   nsCOMPtr &lt;nsIMsgFolder&gt; parent;</span>
<a href="#l10.59"></a><span id="l10.59">   rv = msgFolder-&gt;GetParent(getter_AddRefs(parent));</span>
<a href="#l10.60"></a><span id="l10.60">   if (NS_FAILED(rv) || !parent)</span>
<a href="#l10.61"></a><span id="l10.61">   {</span>
<a href="#l10.62"></a><span id="l10.62">     nsCOMPtr &lt;nsIFile&gt; folderPath;</span>
<a href="#l10.63"></a><span id="l10.63">     // for local folders, path is to the berkeley mailbox.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgCompose.cpp</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgCompose.cpp</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -23,18 +23,16 @@</span>
<a href="#l11.4"></a><span id="l11.4"> #include &quot;nsICharsetConverterManager.h&quot;</span>
<a href="#l11.5"></a><span id="l11.5"> #include &quot;nsTextFormatter.h&quot;</span>
<a href="#l11.6"></a><span id="l11.6"> #include &quot;nsIPlaintextEditor.h&quot;</span>
<a href="#l11.7"></a><span id="l11.7"> #include &quot;nsIHTMLEditor.h&quot;</span>
<a href="#l11.8"></a><span id="l11.8"> #include &quot;nsIEditor.h&quot;</span>
<a href="#l11.9"></a><span id="l11.9"> #include &quot;plstr.h&quot;</span>
<a href="#l11.10"></a><span id="l11.10"> #include &quot;prmem.h&quot;</span>
<a href="#l11.11"></a><span id="l11.11"> #include &quot;nsIDocShell.h&quot;</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-#include &quot;nsIRDFService.h&quot;</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-#include &quot;nsRDFCID.h&quot;</span>
<a href="#l11.14"></a><span id="l11.14"> #include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l11.15"></a><span id="l11.15"> #include &quot;nsIAbMDBDirectory.h&quot;</span>
<a href="#l11.16"></a><span id="l11.16"> #include &quot;nsCExternalHandlerService.h&quot;</span>
<a href="#l11.17"></a><span id="l11.17"> #include &quot;nsIMIMEService.h&quot;</span>
<a href="#l11.18"></a><span id="l11.18"> #include &quot;nsIDocShellTreeItem.h&quot;</span>
<a href="#l11.19"></a><span id="l11.19"> #include &quot;nsIDocShellTreeOwner.h&quot;</span>
<a href="#l11.20"></a><span id="l11.20"> #include &quot;nsIWindowMediator.h&quot;</span>
<a href="#l11.21"></a><span id="l11.21"> #include &quot;nsIURL.h&quot;</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineat">@@ -3384,24 +3382,18 @@ NS_IMETHODIMP nsMsgCompose::RememberQueu</span>
<a href="#l11.23"></a><span id="l11.23">   nsMsgKey msgKey;</span>
<a href="#l11.24"></a><span id="l11.24">   if (mMsgSend)</span>
<a href="#l11.25"></a><span id="l11.25">   {</span>
<a href="#l11.26"></a><span id="l11.26">     mMsgSend-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l11.27"></a><span id="l11.27">     nsCString identityKey;</span>
<a href="#l11.28"></a><span id="l11.28"> </span>
<a href="#l11.29"></a><span id="l11.29">     m_identity-&gt;GetKey(identityKey);</span>
<a href="#l11.30"></a><span id="l11.30"> </span>
<a href="#l11.31"></a><span id="l11.31" class="difflineminus">-    nsCOMPtr&lt;nsIRDFService&gt; rdfService(do_GetService(&quot;@mozilla.org/rdf/rdf-service;1&quot;, &amp;rv));</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineminus">-</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineminus">-    nsCOMPtr &lt;nsIRDFResource&gt; resource;</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineminus">-    rv = rdfService-&gt;GetResource(m_folderName, getter_AddRefs(resource));</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineminus">-</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineminus">-    nsCOMPtr&lt;nsIMsgFolder&gt; folder(do_QueryInterface(resource, &amp;rv));</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineplus">+    rv = GetOrCreateFolder(m_folderName, getter_AddRefs(folder));</span>
<a href="#l11.41"></a><span id="l11.41">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.42"></a><span id="l11.42"> </span>
<a href="#l11.43"></a><span id="l11.43">     nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l11.44"></a><span id="l11.44">     rv = folder-&gt;GetMessageHeader(msgKey, getter_AddRefs(msgHdr));</span>
<a href="#l11.45"></a><span id="l11.45">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.46"></a><span id="l11.46"> </span>
<a href="#l11.47"></a><span id="l11.47">     uint32_t pseudoHdrProp = 0;</span>
<a href="#l11.48"></a><span id="l11.48">     msgHdr-&gt;GetUint32Property(&quot;pseudoHdr&quot;, &amp;pseudoHdrProp);</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineat">@@ -3832,33 +3824,22 @@ nsMsgComposeSendListener::OnStopCopy(nsr</span>
<a href="#l11.50"></a><span id="l11.50">   }</span>
<a href="#l11.51"></a><span id="l11.51"> </span>
<a href="#l11.52"></a><span id="l11.52">   return rv;</span>
<a href="#l11.53"></a><span id="l11.53"> }</span>
<a href="#l11.54"></a><span id="l11.54"> </span>
<a href="#l11.55"></a><span id="l11.55"> nsresult</span>
<a href="#l11.56"></a><span id="l11.56"> nsMsgComposeSendListener::GetMsgFolder(nsIMsgCompose *compObj, nsIMsgFolder **msgFolder)</span>
<a href="#l11.57"></a><span id="l11.57"> {</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineminus">-  nsresult rv;</span>
<a href="#l11.59"></a><span id="l11.59">   nsCString folderUri;</span>
<a href="#l11.60"></a><span id="l11.60"> </span>
<a href="#l11.61"></a><span id="l11.61" class="difflineminus">-  rv = compObj-&gt;GetSavedFolderURI(getter_Copies(folderUri));</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineminus">-</span>
<a href="#l11.64"></a><span id="l11.64" class="difflineminus">-  nsCOMPtr&lt;nsIRDFService&gt; rdfService (do_GetService(&quot;@mozilla.org/rdf/rdf-service;1&quot;, &amp;rv));</span>
<a href="#l11.65"></a><span id="l11.65" class="difflineplus">+  nsresult rv = compObj-&gt;GetSavedFolderURI(getter_Copies(folderUri));</span>
<a href="#l11.66"></a><span id="l11.66">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.67"></a><span id="l11.67"> </span>
<a href="#l11.68"></a><span id="l11.68" class="difflineminus">-  nsCOMPtr &lt;nsIRDFResource&gt; resource;</span>
<a href="#l11.69"></a><span id="l11.69" class="difflineminus">-  rv = rdfService-&gt;GetResource(folderUri, getter_AddRefs(resource));</span>
<a href="#l11.70"></a><span id="l11.70" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineminus">-</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineminus">-  nsCOMPtr&lt;nsIMsgFolder&gt; folder = do_QueryInterface(resource, &amp;rv);</span>
<a href="#l11.73"></a><span id="l11.73" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.74"></a><span id="l11.74" class="difflineminus">-  folder.forget(msgFolder);</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineminus">-  return rv;</span>
<a href="#l11.76"></a><span id="l11.76" class="difflineplus">+  return GetOrCreateFolder(folderUri, msgFolder);</span>
<a href="#l11.77"></a><span id="l11.77"> }</span>
<a href="#l11.78"></a><span id="l11.78"> </span>
<a href="#l11.79"></a><span id="l11.79"> nsresult</span>
<a href="#l11.80"></a><span id="l11.80"> nsMsgComposeSendListener::RemoveDraftOrTemplate(nsIMsgCompose *compObj, nsCString msgURI, bool isSaveTemplate)</span>
<a href="#l11.81"></a><span id="l11.81"> {</span>
<a href="#l11.82"></a><span id="l11.82">   nsresult rv;</span>
<a href="#l11.83"></a><span id="l11.83">   nsCOMPtr&lt;nsIMsgFolder&gt; msgFolder;</span>
<a href="#l11.84"></a><span id="l11.84">   nsCOMPtr&lt;nsIMsgDBHdr&gt; msgDBHdr;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgCompose.h</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgCompose.h</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -21,17 +21,16 @@</span>
<a href="#l12.4"></a><span id="l12.4"> #include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l12.5"></a><span id="l12.5"> #include &quot;mozIDOMWindow.h&quot;</span>
<a href="#l12.6"></a><span id="l12.6"> #include &quot;mozilla/dom/Element.h&quot;</span>
<a href="#l12.7"></a><span id="l12.7"> </span>
<a href="#l12.8"></a><span id="l12.8"> // Forward declares</span>
<a href="#l12.9"></a><span id="l12.9"> class QuotingOutputStreamListener;</span>
<a href="#l12.10"></a><span id="l12.10"> class nsMsgComposeSendListener;</span>
<a href="#l12.11"></a><span id="l12.11"> class nsIEditor;</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-class nsIRDFService;</span>
<a href="#l12.13"></a><span id="l12.13"> class nsIArray;</span>
<a href="#l12.14"></a><span id="l12.14"> struct nsMsgMailList;</span>
<a href="#l12.15"></a><span id="l12.15"> </span>
<a href="#l12.16"></a><span id="l12.16"> class nsMsgCompose : public nsIMsgCompose, public nsSupportsWeakReference</span>
<a href="#l12.17"></a><span id="l12.17"> {</span>
<a href="#l12.18"></a><span id="l12.18">  public:</span>
<a href="#l12.19"></a><span id="l12.19"> </span>
<a href="#l12.20"></a><span id="l12.20">   nsMsgCompose();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgCopy.cpp</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgCopy.cpp</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -8,37 +8,32 @@</span>
<a href="#l13.4"></a><span id="l13.4"> #include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l13.5"></a><span id="l13.5"> #include &quot;nsMsgFolderFlags.h&quot;</span>
<a href="#l13.6"></a><span id="l13.6"> #include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l13.7"></a><span id="l13.7"> #include &quot;nsIMsgAccountManager.h&quot;</span>
<a href="#l13.8"></a><span id="l13.8"> #include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l13.9"></a><span id="l13.9"> #include &quot;nsIMsgIncomingServer.h&quot;</span>
<a href="#l13.10"></a><span id="l13.10"> #include &quot;nsIMsgProtocolInfo.h&quot;</span>
<a href="#l13.11"></a><span id="l13.11"> #include &quot;nsISupports.h&quot;</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-#include &quot;nsIRDFService.h&quot;</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-#include &quot;nsIRDFResource.h&quot;</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineminus">-#include &quot;nsRDFCID.h&quot;</span>
<a href="#l13.15"></a><span id="l13.15"> #include &quot;nsIURL.h&quot;</span>
<a href="#l13.16"></a><span id="l13.16"> #include &quot;nsNetCID.h&quot;</span>
<a href="#l13.17"></a><span id="l13.17"> #include &quot;nsMsgCompUtils.h&quot;</span>
<a href="#l13.18"></a><span id="l13.18"> #include &quot;prcmon.h&quot;</span>
<a href="#l13.19"></a><span id="l13.19"> #include &quot;nsIMsgImapMailFolder.h&quot;</span>
<a href="#l13.20"></a><span id="l13.20"> #include &quot;nsThreadUtils.h&quot;</span>
<a href="#l13.21"></a><span id="l13.21"> #include &quot;nsIMsgWindow.h&quot;</span>
<a href="#l13.22"></a><span id="l13.22"> #include &quot;nsIMsgProgress.h&quot;</span>
<a href="#l13.23"></a><span id="l13.23"> #include &quot;nsComposeStrings.h&quot;</span>
<a href="#l13.24"></a><span id="l13.24"> #include &quot;prmem.h&quot;</span>
<a href="#l13.25"></a><span id="l13.25"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l13.26"></a><span id="l13.26"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l13.27"></a><span id="l13.27"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l13.28"></a><span id="l13.28"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l13.29"></a><span id="l13.29"> #include &quot;nsIURIMutator.h&quot;</span>
<a href="#l13.30"></a><span id="l13.30"> </span>
<a href="#l13.31"></a><span id="l13.31" class="difflineminus">-static NS_DEFINE_CID(kRDFServiceCID, NS_RDFSERVICE_CID);</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineminus">-</span>
<a href="#l13.33"></a><span id="l13.33"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l13.34"></a><span id="l13.34"> // This is the listener class for the copy operation. We have to create this class</span>
<a href="#l13.35"></a><span id="l13.35"> // to listen for message copy completion and eventually notify the caller</span>
<a href="#l13.36"></a><span id="l13.36"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l13.37"></a><span id="l13.37"> NS_IMPL_ISUPPORTS(CopyListener, nsIMsgCopyServiceListener)</span>
<a href="#l13.38"></a><span id="l13.38"> </span>
<a href="#l13.39"></a><span id="l13.39"> CopyListener::CopyListener(void)</span>
<a href="#l13.40"></a><span id="l13.40"> {</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineat">@@ -415,40 +410,25 @@ LocateMessageFolder(nsIMsgIdentity   *us</span>
<a href="#l13.42"></a><span id="l13.42">   *msgFolder = nullptr;</span>
<a href="#l13.43"></a><span id="l13.43"> </span>
<a href="#l13.44"></a><span id="l13.44">   if (!aFolderURI || !*aFolderURI)</span>
<a href="#l13.45"></a><span id="l13.45">     return NS_ERROR_INVALID_ARG;</span>
<a href="#l13.46"></a><span id="l13.46"> </span>
<a href="#l13.47"></a><span id="l13.47">   // as long as it doesn't start with anyfolder://</span>
<a href="#l13.48"></a><span id="l13.48">   if (PL_strncasecmp(ANY_SERVER, aFolderURI, strlen(aFolderURI)) != 0)</span>
<a href="#l13.49"></a><span id="l13.49">   {</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineminus">-    nsCOMPtr&lt;nsIRDFService&gt; rdf(do_GetService(kRDFServiceCID, &amp;rv));</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l13.52"></a><span id="l13.52" class="difflineminus">-</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineminus">-    // get the corresponding RDF resource</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineminus">-    // RDF will create the folder resource if it doesn't already exist</span>
<a href="#l13.55"></a><span id="l13.55" class="difflineminus">-    nsCOMPtr&lt;nsIRDFResource&gt; resource;</span>
<a href="#l13.56"></a><span id="l13.56" class="difflineminus">-    rv = rdf-&gt;GetResource(nsDependentCString(aFolderURI), getter_AddRefs(resource));</span>
<a href="#l13.57"></a><span id="l13.57" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l13.58"></a><span id="l13.58" class="difflineminus">-</span>
<a href="#l13.59"></a><span id="l13.59" class="difflineminus">-    nsCOMPtr &lt;nsIMsgFolder&gt; folderResource;</span>
<a href="#l13.60"></a><span id="l13.60" class="difflineminus">-    folderResource = do_QueryInterface(resource, &amp;rv);</span>
<a href="#l13.61"></a><span id="l13.61" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; folderResource)</span>
<a href="#l13.62"></a><span id="l13.62" class="difflineminus">-    {</span>
<a href="#l13.63"></a><span id="l13.63" class="difflineminus">-      // don't check validity of folder - caller will handle creating it</span>
<a href="#l13.64"></a><span id="l13.64" class="difflineminus">-      nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l13.65"></a><span id="l13.65" class="difflineminus">-      //make sure that folder hierarchy is built so that legitimate parent-child relationship is established</span>
<a href="#l13.66"></a><span id="l13.66" class="difflineminus">-      rv = folderResource-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l13.67"></a><span id="l13.67" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l13.68"></a><span id="l13.68" class="difflineminus">-      return server-&gt;GetMsgFolderFromURI(folderResource, nsDependentCString(aFolderURI), msgFolder);</span>
<a href="#l13.69"></a><span id="l13.69" class="difflineminus">-    }</span>
<a href="#l13.70"></a><span id="l13.70" class="difflineminus">-    else</span>
<a href="#l13.71"></a><span id="l13.71" class="difflineminus">-    {</span>
<a href="#l13.72"></a><span id="l13.72" class="difflineminus">-      return NS_ERROR_FAILURE;</span>
<a href="#l13.73"></a><span id="l13.73" class="difflineminus">-    }</span>
<a href="#l13.74"></a><span id="l13.74" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l13.75"></a><span id="l13.75" class="difflineplus">+    rv = GetOrCreateFolder(nsDependentCString(aFolderURI), getter_AddRefs(folder));</span>
<a href="#l13.76"></a><span id="l13.76" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.77"></a><span id="l13.77" class="difflineplus">+    // Don't check validity of folder - caller will handle creating it.</span>
<a href="#l13.78"></a><span id="l13.78" class="difflineplus">+    nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l13.79"></a><span id="l13.79" class="difflineplus">+    // make sure that folder hierarchy is built so that legitimate parent-child relationship is established.</span>
<a href="#l13.80"></a><span id="l13.80" class="difflineplus">+    rv = folder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l13.81"></a><span id="l13.81" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.82"></a><span id="l13.82" class="difflineplus">+    return server-&gt;GetMsgFolderFromURI(folder, nsDependentCString(aFolderURI), msgFolder);</span>
<a href="#l13.83"></a><span id="l13.83">   }</span>
<a href="#l13.84"></a><span id="l13.84">   else</span>
<a href="#l13.85"></a><span id="l13.85">   {</span>
<a href="#l13.86"></a><span id="l13.86">     uint32_t                  cnt = 0;</span>
<a href="#l13.87"></a><span id="l13.87">     uint32_t                  i;</span>
<a href="#l13.88"></a><span id="l13.88"> </span>
<a href="#l13.89"></a><span id="l13.89">     if (!userIdentity)</span>
<a href="#l13.90"></a><span id="l13.90">       return NS_ERROR_INVALID_ARG;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgSend.cpp</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgSend.cpp</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -49,18 +49,16 @@</span>
<a href="#l14.4"></a><span id="l14.4"> #include &quot;nsIDocumentEncoder.h&quot;    // for editor output flags</span>
<a href="#l14.5"></a><span id="l14.5"> #include &quot;nsILoadGroup.h&quot;</span>
<a href="#l14.6"></a><span id="l14.6"> #include &quot;nsMsgSendReport.h&quot;</span>
<a href="#l14.7"></a><span id="l14.7"> #include &quot;nsNetCID.h&quot;</span>
<a href="#l14.8"></a><span id="l14.8"> #include &quot;nsError.h&quot;</span>
<a href="#l14.9"></a><span id="l14.9"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l14.10"></a><span id="l14.10"> #include &quot;nsIMsgMdnGenerator.h&quot;</span>
<a href="#l14.11"></a><span id="l14.11"> #include &quot;nsISmtpServer.h&quot;</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-#include &quot;nsIRDFService.h&quot;</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineminus">-#include &quot;nsRDFCID.h&quot;</span>
<a href="#l14.14"></a><span id="l14.14"> #include &quot;nsIMsgAccountManager.h&quot;</span>
<a href="#l14.15"></a><span id="l14.15"> #include &quot;nsNativeCharsetUtils.h&quot;</span>
<a href="#l14.16"></a><span id="l14.16"> #include &quot;nsIAbCard.h&quot;</span>
<a href="#l14.17"></a><span id="l14.17"> #include &quot;nsIMsgAttachment.h&quot;</span>
<a href="#l14.18"></a><span id="l14.18"> #include &quot;nsIMsgProgress.h&quot;</span>
<a href="#l14.19"></a><span id="l14.19"> #include &quot;nsIMsgMessageService.h&quot;</span>
<a href="#l14.20"></a><span id="l14.20"> #include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l14.21"></a><span id="l14.21"> #include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineat">@@ -83,18 +81,16 @@</span>
<a href="#l14.23"></a><span id="l14.23"> #include &quot;mozilla/Preferences.h&quot;</span>
<a href="#l14.24"></a><span id="l14.24"> #include &quot;nsIURIMutator.h&quot;</span>
<a href="#l14.25"></a><span id="l14.25"> #include &quot;nsINSSErrorsService.h&quot;</span>
<a href="#l14.26"></a><span id="l14.26"> </span>
<a href="#l14.27"></a><span id="l14.27"> using namespace mozilla;</span>
<a href="#l14.28"></a><span id="l14.28"> using namespace mozilla::dom;</span>
<a href="#l14.29"></a><span id="l14.29"> using namespace mozilla::mailnews;</span>
<a href="#l14.30"></a><span id="l14.30"> </span>
<a href="#l14.31"></a><span id="l14.31" class="difflineminus">-static NS_DEFINE_CID(kRDFServiceCID, NS_RDFSERVICE_CID);</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineminus">-</span>
<a href="#l14.33"></a><span id="l14.33"> #define PREF_MAIL_SEND_STRUCT &quot;mail.send_struct&quot;</span>
<a href="#l14.34"></a><span id="l14.34"> #define PREF_MAIL_STRICTLY_MIME &quot;mail.strictly_mime&quot;</span>
<a href="#l14.35"></a><span id="l14.35"> #define PREF_MAIL_MESSAGE_WARNING_SIZE &quot;mailnews.message_warning_size&quot;</span>
<a href="#l14.36"></a><span id="l14.36"> #define PREF_MAIL_COLLECT_EMAIL_ADDRESS_OUTGOING &quot;mail.collect_email_address_outgoing&quot;</span>
<a href="#l14.37"></a><span id="l14.37"> </span>
<a href="#l14.38"></a><span id="l14.38"> #define ATTR_MOZ_DO_NOT_SEND &quot;moz-do-not-send&quot;</span>
<a href="#l14.39"></a><span id="l14.39"> </span>
<a href="#l14.40"></a><span id="l14.40"> enum  { kDefaultMode = (PR_WRONLY | PR_CREATE_FILE | PR_TRUNCATE) };</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineat">@@ -3579,30 +3575,21 @@ nsMsgComposeAndSend::DeliverAsNewsExit(n</span>
<a href="#l14.42"></a><span id="l14.42"> {</span>
<a href="#l14.43"></a><span id="l14.43">   DoDeliveryExitProcessing(aUrl, aExitCode, mSendMailAlso);</span>
<a href="#l14.44"></a><span id="l14.44">   return NS_OK;</span>
<a href="#l14.45"></a><span id="l14.45"> }</span>
<a href="#l14.46"></a><span id="l14.46"> </span>
<a href="#l14.47"></a><span id="l14.47"> nsresult</span>
<a href="#l14.48"></a><span id="l14.48"> nsMsgComposeAndSend::GetIncomingServer(const char *folderURL, nsIMsgIncomingServer **aServer)</span>
<a href="#l14.49"></a><span id="l14.49"> {</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineminus">-  nsresult rv;</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineminus">-  nsCOMPtr&lt;nsIRDFService&gt; rdf(do_GetService(&quot;@mozilla.org/rdf/rdf-service;1&quot;, &amp;rv));</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineminus">-    return rv;</span>
<a href="#l14.54"></a><span id="l14.54" class="difflineminus">-</span>
<a href="#l14.55"></a><span id="l14.55" class="difflineminus">-  nsCOMPtr&lt;nsIRDFResource&gt; resource;</span>
<a href="#l14.56"></a><span id="l14.56" class="difflineminus">-  rv = rdf-&gt;GetResource(nsDependentCString(folderURL), getter_AddRefs(resource));</span>
<a href="#l14.57"></a><span id="l14.57" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l14.58"></a><span id="l14.58" class="difflineminus">-    return rv;</span>
<a href="#l14.59"></a><span id="l14.59" class="difflineminus">-</span>
<a href="#l14.60"></a><span id="l14.60">   nsCOMPtr &lt;nsIMsgFolder&gt; thisFolder;</span>
<a href="#l14.61"></a><span id="l14.61" class="difflineminus">-  thisFolder = do_QueryInterface(resource, &amp;rv);</span>
<a href="#l14.62"></a><span id="l14.62" class="difflineminus">-  if (NS_FAILED(rv) || !thisFolder)</span>
<a href="#l14.63"></a><span id="l14.63" class="difflineminus">-    return rv;</span>
<a href="#l14.64"></a><span id="l14.64" class="difflineplus">+</span>
<a href="#l14.65"></a><span id="l14.65" class="difflineplus">+  nsresult rv = GetOrCreateFolder(nsDependentCString(folderURL),</span>
<a href="#l14.66"></a><span id="l14.66" class="difflineplus">+    getter_AddRefs(thisFolder));</span>
<a href="#l14.67"></a><span id="l14.67" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.68"></a><span id="l14.68"> </span>
<a href="#l14.69"></a><span id="l14.69">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l14.70"></a><span id="l14.70">   rv = thisFolder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l14.71"></a><span id="l14.71">   if (NS_FAILED(rv))</span>
<a href="#l14.72"></a><span id="l14.72">     return rv;</span>
<a href="#l14.73"></a><span id="l14.73">   if (!server)</span>
<a href="#l14.74"></a><span id="l14.74">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l14.75"></a><span id="l14.75"> </span>
<a href="#l14.76"></a><span id="l14.76" class="difflineat">@@ -4450,25 +4437,23 @@ nsMsgComposeAndSend::MimeDoFCC(nsIFile  </span>
<a href="#l14.77"></a><span id="l14.77">   status = MessageFolderIsLocal(mUserIdentity, mode, tmpUri.get(), &amp;folderIsLocal);</span>
<a href="#l14.78"></a><span id="l14.78">   if (NS_FAILED(status))</span>
<a href="#l14.79"></a><span id="l14.79">     goto FAIL;</span>
<a href="#l14.80"></a><span id="l14.80"> </span>
<a href="#l14.81"></a><span id="l14.81">   // Tell the user we are copying the message...</span>
<a href="#l14.82"></a><span id="l14.82">   mComposeBundle-&gt;GetStringFromName(&quot;copyMessageStart&quot;, msg);</span>
<a href="#l14.83"></a><span id="l14.83">   if (!msg.IsEmpty())</span>
<a href="#l14.84"></a><span id="l14.84">   {</span>
<a href="#l14.85"></a><span id="l14.85" class="difflineminus">-    nsCOMPtr&lt;nsIRDFService&gt; rdfService = do_GetService(kRDFServiceCID);</span>
<a href="#l14.86"></a><span id="l14.86" class="difflineminus">-    if (rdfService)</span>
<a href="#l14.87"></a><span id="l14.87" class="difflineminus">-    {</span>
<a href="#l14.88"></a><span id="l14.88" class="difflineminus">-      nsCOMPtr&lt;nsIRDFResource&gt; res;</span>
<a href="#l14.89"></a><span id="l14.89" class="difflineminus">-      rdfService-&gt;GetResource(tmpUri, getter_AddRefs(res));</span>
<a href="#l14.90"></a><span id="l14.90" class="difflineminus">-      nsCOMPtr&lt;nsIMsgFolder&gt; folder = do_QueryInterface(res);</span>
<a href="#l14.91"></a><span id="l14.91" class="difflineminus">-      if (folder)</span>
<a href="#l14.92"></a><span id="l14.92" class="difflineminus">-        folder-&gt;GetName(mSavedToFolderName);</span>
<a href="#l14.93"></a><span id="l14.93" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l14.94"></a><span id="l14.94" class="difflineplus">+    rv = GetOrCreateFolder(tmpUri, getter_AddRefs(folder));</span>
<a href="#l14.95"></a><span id="l14.95" class="difflineplus">+    if (NS_FAILED(rv)) {</span>
<a href="#l14.96"></a><span id="l14.96" class="difflineplus">+      status = rv;</span>
<a href="#l14.97"></a><span id="l14.97" class="difflineplus">+      goto FAIL;</span>
<a href="#l14.98"></a><span id="l14.98">     }</span>
<a href="#l14.99"></a><span id="l14.99" class="difflineplus">+    folder-&gt;GetName(mSavedToFolderName);</span>
<a href="#l14.100"></a><span id="l14.100">     if (!mSavedToFolderName.IsEmpty())</span>
<a href="#l14.101"></a><span id="l14.101">       nsTextFormatter::ssprintf(printfString, msg.get(),</span>
<a href="#l14.102"></a><span id="l14.102">                                 mSavedToFolderName.get());</span>
<a href="#l14.103"></a><span id="l14.103">     else</span>
<a href="#l14.104"></a><span id="l14.104">       nsTextFormatter::ssprintf(printfString, msg.get(), &quot;?&quot;);</span>
<a href="#l14.105"></a><span id="l14.105">     SetStatusMessage(printfString);</span>
<a href="#l14.106"></a><span id="l14.106">   }</span>
<a href="#l14.107"></a><span id="l14.107"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/imap/src/nsImapIncomingServer.cpp</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapIncomingServer.cpp</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -19,18 +19,16 @@</span>
<a href="#l15.4"></a><span id="l15.4"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l15.5"></a><span id="l15.5"> #include &quot;nsIPrefService.h&quot;</span>
<a href="#l15.6"></a><span id="l15.6"> #include &quot;nsMsgFolderFlags.h&quot;</span>
<a href="#l15.7"></a><span id="l15.7"> #include &quot;prmem.h&quot;</span>
<a href="#l15.8"></a><span id="l15.8"> #include &quot;plstr.h&quot;</span>
<a href="#l15.9"></a><span id="l15.9"> #include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l15.10"></a><span id="l15.10"> #include &quot;nsIMsgWindow.h&quot;</span>
<a href="#l15.11"></a><span id="l15.11"> #include &quot;nsImapMailFolder.h&quot;</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-#include &quot;nsIRDFService.h&quot;</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineminus">-#include &quot;nsRDFCID.h&quot;</span>
<a href="#l15.14"></a><span id="l15.14"> #include &quot;nsIMsgMailNewsUrl.h&quot;</span>
<a href="#l15.15"></a><span id="l15.15"> #include &quot;nsIImapService.h&quot;</span>
<a href="#l15.16"></a><span id="l15.16"> #include &quot;nsMsgI18N.h&quot;</span>
<a href="#l15.17"></a><span id="l15.17"> #include &quot;nsIImapMockChannel.h&quot;</span>
<a href="#l15.18"></a><span id="l15.18"> // for the memory cache...</span>
<a href="#l15.19"></a><span id="l15.19"> #include &quot;nsICacheEntry.h&quot;</span>
<a href="#l15.20"></a><span id="l15.20"> #include &quot;nsImapUrl.h&quot;</span>
<a href="#l15.21"></a><span id="l15.21"> #include &quot;nsIMsgProtocolInfo.h&quot;</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineat">@@ -46,17 +44,16 @@</span>
<a href="#l15.23"></a><span id="l15.23"> </span>
<a href="#l15.24"></a><span id="l15.24"> using namespace mozilla;</span>
<a href="#l15.25"></a><span id="l15.25"> </span>
<a href="#l15.26"></a><span id="l15.26"> // Despite its name, this contains a folder path, for example INBOX/Trash.</span>
<a href="#l15.27"></a><span id="l15.27"> #define PREF_TRASH_FOLDER_PATH &quot;trash_folder_name&quot;</span>
<a href="#l15.28"></a><span id="l15.28"> #define DEFAULT_TRASH_FOLDER_PATH &quot;Trash&quot;  // XXX Is this a useful default?</span>
<a href="#l15.29"></a><span id="l15.29"> </span>
<a href="#l15.30"></a><span id="l15.30"> static NS_DEFINE_CID(kImapProtocolCID, NS_IMAPPROTOCOL_CID);</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineminus">-static NS_DEFINE_CID(kRDFServiceCID, NS_RDFSERVICE_CID);</span>
<a href="#l15.32"></a><span id="l15.32"> static NS_DEFINE_CID(kSubscribableServerCID, NS_SUBSCRIBABLESERVER_CID);</span>
<a href="#l15.33"></a><span id="l15.33"> static NS_DEFINE_CID(kCImapHostSessionListCID, NS_IIMAPHOSTSESSIONLIST_CID);</span>
<a href="#l15.34"></a><span id="l15.34"> </span>
<a href="#l15.35"></a><span id="l15.35"> NS_IMPL_ADDREF_INHERITED(nsImapIncomingServer, nsMsgIncomingServer)</span>
<a href="#l15.36"></a><span id="l15.36"> NS_IMPL_RELEASE_INHERITED(nsImapIncomingServer, nsMsgIncomingServer)</span>
<a href="#l15.37"></a><span id="l15.37"> </span>
<a href="#l15.38"></a><span id="l15.38"> NS_INTERFACE_MAP_BEGIN(nsImapIncomingServer)</span>
<a href="#l15.39"></a><span id="l15.39">   NS_INTERFACE_MAP_ENTRY(nsIImapServerSink)</span>
<a href="#l15.40"></a><span id="l15.40" class="difflineat">@@ -1292,26 +1289,17 @@ nsresult nsImapIncomingServer::GetFolder</span>
<a href="#l15.41"></a><span id="l15.41">   {</span>
<a href="#l15.42"></a><span id="l15.42">     nsCString uri;</span>
<a href="#l15.43"></a><span id="l15.43">     rv = rootFolder-&gt;GetURI(uri);</span>
<a href="#l15.44"></a><span id="l15.44">     if (NS_SUCCEEDED(rv) &amp;&amp; !uri.IsEmpty())</span>
<a href="#l15.45"></a><span id="l15.45">     {</span>
<a href="#l15.46"></a><span id="l15.46">       nsAutoCString uriString(uri);</span>
<a href="#l15.47"></a><span id="l15.47">       uriString.Append('/');</span>
<a href="#l15.48"></a><span id="l15.48">       uriString.Append(name);</span>
<a href="#l15.49"></a><span id="l15.49" class="difflineminus">-      nsCOMPtr&lt;nsIRDFService&gt; rdf(do_GetService(kRDFServiceCID, &amp;rv));</span>
<a href="#l15.50"></a><span id="l15.50" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.51"></a><span id="l15.51" class="difflineminus">-      nsCOMPtr&lt;nsIRDFResource&gt; res;</span>
<a href="#l15.52"></a><span id="l15.52" class="difflineminus">-      rv = rdf-&gt;GetResource(uriString, getter_AddRefs(res));</span>
<a href="#l15.53"></a><span id="l15.53" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l15.54"></a><span id="l15.54" class="difflineminus">-      {</span>
<a href="#l15.55"></a><span id="l15.55" class="difflineminus">-        nsCOMPtr&lt;nsIMsgFolder&gt; folder(do_QueryInterface(res, &amp;rv));</span>
<a href="#l15.56"></a><span id="l15.56" class="difflineminus">-        if (NS_SUCCEEDED(rv) &amp;&amp; folder)</span>
<a href="#l15.57"></a><span id="l15.57" class="difflineminus">-          folder.forget(pFolder);</span>
<a href="#l15.58"></a><span id="l15.58" class="difflineminus">-      }</span>
<a href="#l15.59"></a><span id="l15.59" class="difflineplus">+      rv = GetOrCreateFolder(uriString, pFolder);</span>
<a href="#l15.60"></a><span id="l15.60">     }</span>
<a href="#l15.61"></a><span id="l15.61">   }</span>
<a href="#l15.62"></a><span id="l15.62">   return rv;</span>
<a href="#l15.63"></a><span id="l15.63"> }</span>
<a href="#l15.64"></a><span id="l15.64"> </span>
<a href="#l15.65"></a><span id="l15.65"> NS_IMETHODIMP  nsImapIncomingServer::OnlineFolderDelete(const nsACString&amp; aFolderName)</span>
<a href="#l15.66"></a><span id="l15.66"> {</span>
<a href="#l15.67"></a><span id="l15.67">   return NS_OK;</span>
<a href="#l15.68"></a><span id="l15.68" class="difflineat">@@ -1435,73 +1423,69 @@ NS_IMETHODIMP nsImapIncomingServer::Disc</span>
<a href="#l15.69"></a><span id="l15.69">   {</span>
<a href="#l15.70"></a><span id="l15.70">     // GetResource() may return a node which is not in the folder</span>
<a href="#l15.71"></a><span id="l15.71">     // tree hierarchy but in the rdf cache in case of the non-existing default</span>
<a href="#l15.72"></a><span id="l15.72">     // Sent, Drafts, and Templates folders. The resource will be eventually</span>
<a href="#l15.73"></a><span id="l15.73">     // released when the rdf service shuts down. When we create the default</span>
<a href="#l15.74"></a><span id="l15.74">     // folders later on in the imap server, the subsequent GetResource() of the</span>
<a href="#l15.75"></a><span id="l15.75">     // same uri will get us the cached rdf resource which should have the folder</span>
<a href="#l15.76"></a><span id="l15.76">     // flag set appropriately.</span>
<a href="#l15.77"></a><span id="l15.77" class="difflineminus">-    nsCOMPtr&lt;nsIRDFService&gt; rdf(do_GetService(&quot;@mozilla.org/rdf/rdf-service;1&quot;,</span>
<a href="#l15.78"></a><span id="l15.78" class="difflineminus">-                                              &amp;rv));</span>
<a href="#l15.79"></a><span id="l15.79" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.80"></a><span id="l15.80"> </span>
<a href="#l15.81"></a><span id="l15.81">     nsCOMPtr&lt;nsIMsgAccountManager&gt; accountMgr = do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l15.82"></a><span id="l15.82">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.83"></a><span id="l15.83"> </span>
<a href="#l15.84"></a><span id="l15.84">     nsCOMPtr&lt;nsIMsgIdentity&gt; identity;</span>
<a href="#l15.85"></a><span id="l15.85">     rv = accountMgr-&gt;GetFirstIdentityForServer(this, getter_AddRefs(identity));</span>
<a href="#l15.86"></a><span id="l15.86">     if (NS_SUCCEEDED(rv) &amp;&amp; identity)</span>
<a href="#l15.87"></a><span id="l15.87">     {</span>
<a href="#l15.88"></a><span id="l15.88">       nsCString folderUri;</span>
<a href="#l15.89"></a><span id="l15.89">       identity-&gt;GetFccFolder(folderUri);</span>
<a href="#l15.90"></a><span id="l15.90">       nsCString existingUri;</span>
<a href="#l15.91"></a><span id="l15.91"> </span>
<a href="#l15.92"></a><span id="l15.92" class="difflineminus">-      if (CheckSpecialFolder(rdf, folderUri, nsMsgFolderFlags::SentMail,</span>
<a href="#l15.93"></a><span id="l15.93" class="difflineplus">+      if (CheckSpecialFolder(folderUri, nsMsgFolderFlags::SentMail,</span>
<a href="#l15.94"></a><span id="l15.94">                              existingUri))</span>
<a href="#l15.95"></a><span id="l15.95">       {</span>
<a href="#l15.96"></a><span id="l15.96">         identity-&gt;SetFccFolder(existingUri);</span>
<a href="#l15.97"></a><span id="l15.97">         identity-&gt;SetFccFolderPickerMode(NS_LITERAL_CSTRING(&quot;1&quot;));</span>
<a href="#l15.98"></a><span id="l15.98">       }</span>
<a href="#l15.99"></a><span id="l15.99">       identity-&gt;GetDraftFolder(folderUri);</span>
<a href="#l15.100"></a><span id="l15.100" class="difflineminus">-      if (CheckSpecialFolder(rdf, folderUri, nsMsgFolderFlags::Drafts,</span>
<a href="#l15.101"></a><span id="l15.101" class="difflineplus">+      if (CheckSpecialFolder(folderUri, nsMsgFolderFlags::Drafts,</span>
<a href="#l15.102"></a><span id="l15.102">                              existingUri))</span>
<a href="#l15.103"></a><span id="l15.103">       {</span>
<a href="#l15.104"></a><span id="l15.104">         identity-&gt;SetDraftFolder(existingUri);</span>
<a href="#l15.105"></a><span id="l15.105">         identity-&gt;SetDraftsFolderPickerMode(NS_LITERAL_CSTRING(&quot;1&quot;));</span>
<a href="#l15.106"></a><span id="l15.106">       }</span>
<a href="#l15.107"></a><span id="l15.107">       bool archiveEnabled;</span>
<a href="#l15.108"></a><span id="l15.108">       identity-&gt;GetArchiveEnabled(&amp;archiveEnabled);</span>
<a href="#l15.109"></a><span id="l15.109">       if (archiveEnabled)</span>
<a href="#l15.110"></a><span id="l15.110">       {</span>
<a href="#l15.111"></a><span id="l15.111">         identity-&gt;GetArchiveFolder(folderUri);</span>
<a href="#l15.112"></a><span id="l15.112" class="difflineminus">-        if (CheckSpecialFolder(rdf, folderUri, nsMsgFolderFlags::Archive,</span>
<a href="#l15.113"></a><span id="l15.113" class="difflineplus">+        if (CheckSpecialFolder(folderUri, nsMsgFolderFlags::Archive,</span>
<a href="#l15.114"></a><span id="l15.114">                                existingUri))</span>
<a href="#l15.115"></a><span id="l15.115">         {</span>
<a href="#l15.116"></a><span id="l15.116">           identity-&gt;SetArchiveFolder(existingUri);</span>
<a href="#l15.117"></a><span id="l15.117">           identity-&gt;SetArchivesFolderPickerMode(NS_LITERAL_CSTRING(&quot;1&quot;));</span>
<a href="#l15.118"></a><span id="l15.118">         }</span>
<a href="#l15.119"></a><span id="l15.119">       }</span>
<a href="#l15.120"></a><span id="l15.120">       identity-&gt;GetStationeryFolder(folderUri);</span>
<a href="#l15.121"></a><span id="l15.121" class="difflineminus">-      nsCOMPtr&lt;nsIRDFResource&gt; res;</span>
<a href="#l15.122"></a><span id="l15.122" class="difflineminus">-      if (!folderUri.IsEmpty() &amp;&amp; NS_SUCCEEDED(rdf-&gt;GetResource(folderUri, getter_AddRefs(res))))</span>
<a href="#l15.123"></a><span id="l15.123" class="difflineminus">-      {</span>
<a href="#l15.124"></a><span id="l15.124" class="difflineminus">-        nsCOMPtr&lt;nsIMsgFolder&gt; folder(do_QueryInterface(res, &amp;rv));</span>
<a href="#l15.125"></a><span id="l15.125" class="difflineplus">+      if (!folderUri.IsEmpty()) {</span>
<a href="#l15.126"></a><span id="l15.126" class="difflineplus">+        nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l15.127"></a><span id="l15.127" class="difflineplus">+        rv = GetOrCreateFolder(folderUri, getter_AddRefs(folder));</span>
<a href="#l15.128"></a><span id="l15.128">         if (NS_SUCCEEDED(rv))</span>
<a href="#l15.129"></a><span id="l15.129">           rv = folder-&gt;SetFlag(nsMsgFolderFlags::Templates);</span>
<a href="#l15.130"></a><span id="l15.130">       }</span>
<a href="#l15.131"></a><span id="l15.131">     }</span>
<a href="#l15.132"></a><span id="l15.132"> </span>
<a href="#l15.133"></a><span id="l15.133">     nsCOMPtr&lt;nsISpamSettings&gt; spamSettings;</span>
<a href="#l15.134"></a><span id="l15.134">     rv = GetSpamSettings(getter_AddRefs(spamSettings));</span>
<a href="#l15.135"></a><span id="l15.135">     if (NS_SUCCEEDED(rv) &amp;&amp; spamSettings)</span>
<a href="#l15.136"></a><span id="l15.136">     {</span>
<a href="#l15.137"></a><span id="l15.137">       nsCString spamFolderUri, existingUri;</span>
<a href="#l15.138"></a><span id="l15.138">       spamSettings-&gt;GetSpamFolderURI(getter_Copies(spamFolderUri));</span>
<a href="#l15.139"></a><span id="l15.139" class="difflineminus">-      if (CheckSpecialFolder(rdf, spamFolderUri, nsMsgFolderFlags::Junk,</span>
<a href="#l15.140"></a><span id="l15.140" class="difflineplus">+      if (CheckSpecialFolder(spamFolderUri, nsMsgFolderFlags::Junk,</span>
<a href="#l15.141"></a><span id="l15.141">                              existingUri))</span>
<a href="#l15.142"></a><span id="l15.142">       {</span>
<a href="#l15.143"></a><span id="l15.143">         // This only sets the cached values in the spam settings object.</span>
<a href="#l15.144"></a><span id="l15.144">         spamSettings-&gt;SetActionTargetFolder(existingUri.get());</span>
<a href="#l15.145"></a><span id="l15.145">         spamSettings-&gt;SetMoveTargetMode(nsISpamSettings::MOVE_TARGET_MODE_FOLDER);</span>
<a href="#l15.146"></a><span id="l15.146">         // Set the preferences too so that the values persist.</span>
<a href="#l15.147"></a><span id="l15.147">         SetCharValue(&quot;spamActionTargetFolder&quot;, existingUri);</span>
<a href="#l15.148"></a><span id="l15.148">         SetIntValue(&quot;moveTargetMode&quot;, nsISpamSettings::MOVE_TARGET_MODE_FOLDER);</span>
<a href="#l15.149"></a><span id="l15.149" class="difflineat">@@ -1631,50 +1615,45 @@ NS_IMETHODIMP nsImapIncomingServer::Disc</span>
<a href="#l15.150"></a><span id="l15.150"> </span>
<a href="#l15.151"></a><span id="l15.151"> // Check if the special folder corresponding to the uri exists. If not, check</span>
<a href="#l15.152"></a><span id="l15.152"> // if there already exists a folder with the special folder flag (the server may</span>
<a href="#l15.153"></a><span id="l15.153"> // have told us about a folder to use through XLIST). If so, return the uri of</span>
<a href="#l15.154"></a><span id="l15.154"> // the existing special folder. If not, set the special flag on the folder so</span>
<a href="#l15.155"></a><span id="l15.155"> // it will be there if and when the folder is created.</span>
<a href="#l15.156"></a><span id="l15.156"> // Return true if we found an existing special folder different than</span>
<a href="#l15.157"></a><span id="l15.157"> // the one specified in prefs, and the one specified by prefs doesn't exist.</span>
<a href="#l15.158"></a><span id="l15.158" class="difflineminus">-bool nsImapIncomingServer::CheckSpecialFolder(nsIRDFService *rdf,</span>
<a href="#l15.159"></a><span id="l15.159" class="difflineminus">-                                                nsCString &amp;folderUri,</span>
<a href="#l15.160"></a><span id="l15.160" class="difflineminus">-                                                uint32_t folderFlag,</span>
<a href="#l15.161"></a><span id="l15.161" class="difflineminus">-                                                nsCString &amp;existingUri)</span>
<a href="#l15.162"></a><span id="l15.162" class="difflineplus">+bool nsImapIncomingServer::CheckSpecialFolder(nsCString &amp;folderUri,</span>
<a href="#l15.163"></a><span id="l15.163" class="difflineplus">+                                              uint32_t folderFlag,</span>
<a href="#l15.164"></a><span id="l15.164" class="difflineplus">+                                              nsCString &amp;existingUri)</span>
<a href="#l15.165"></a><span id="l15.165"> {</span>
<a href="#l15.166"></a><span id="l15.166" class="difflineminus">-  nsCOMPtr&lt;nsIRDFResource&gt; res;</span>
<a href="#l15.167"></a><span id="l15.167">   nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l15.168"></a><span id="l15.168">   nsCOMPtr&lt;nsIMsgFolder&gt; rootMsgFolder;</span>
<a href="#l15.169"></a><span id="l15.169">   nsresult rv = GetRootFolder(getter_AddRefs(rootMsgFolder));</span>
<a href="#l15.170"></a><span id="l15.170">   NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l15.171"></a><span id="l15.171">   nsCOMPtr&lt;nsIMsgFolder&gt; existingFolder;</span>
<a href="#l15.172"></a><span id="l15.172">   rootMsgFolder-&gt;GetFolderWithFlags(folderFlag, getter_AddRefs(existingFolder));</span>
<a href="#l15.173"></a><span id="l15.173"> </span>
<a href="#l15.174"></a><span id="l15.174" class="difflineminus">-  if (!folderUri.IsEmpty() &amp;&amp; NS_SUCCEEDED(rdf-&gt;GetResource(folderUri, getter_AddRefs(res))))</span>
<a href="#l15.175"></a><span id="l15.175" class="difflineplus">+  if (!folderUri.IsEmpty() &amp;&amp;</span>
<a href="#l15.176"></a><span id="l15.176" class="difflineplus">+    NS_SUCCEEDED(GetOrCreateFolder(folderUri, getter_AddRefs(folder))))</span>
<a href="#l15.177"></a><span id="l15.177">   {</span>
<a href="#l15.178"></a><span id="l15.178" class="difflineminus">-    folder = do_QueryInterface(res, &amp;rv);</span>
<a href="#l15.179"></a><span id="l15.179" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l15.180"></a><span id="l15.180" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFolder&gt; parent;</span>
<a href="#l15.181"></a><span id="l15.181" class="difflineplus">+    folder-&gt;GetParent(getter_AddRefs(parent));</span>
<a href="#l15.182"></a><span id="l15.182" class="difflineplus">+    if (parent)</span>
<a href="#l15.183"></a><span id="l15.183">     {</span>
<a href="#l15.184"></a><span id="l15.184" class="difflineminus">-      nsCOMPtr&lt;nsIMsgFolder&gt; parent;</span>
<a href="#l15.185"></a><span id="l15.185" class="difflineminus">-      folder-&gt;GetParent(getter_AddRefs(parent));</span>
<a href="#l15.186"></a><span id="l15.186" class="difflineminus">-      if (parent)</span>
<a href="#l15.187"></a><span id="l15.187" class="difflineminus">-      {</span>
<a href="#l15.188"></a><span id="l15.188" class="difflineminus">-        existingFolder = nullptr;</span>
<a href="#l15.189"></a><span id="l15.189" class="difflineminus">-      }</span>
<a href="#l15.190"></a><span id="l15.190" class="difflineminus">-      if (!existingFolder)</span>
<a href="#l15.191"></a><span id="l15.191" class="difflineminus">-      {</span>
<a href="#l15.192"></a><span id="l15.192" class="difflineminus">-        folder-&gt;SetFlag(folderFlag);</span>
<a href="#l15.193"></a><span id="l15.193" class="difflineminus">-      }</span>
<a href="#l15.194"></a><span id="l15.194" class="difflineminus">-</span>
<a href="#l15.195"></a><span id="l15.195" class="difflineminus">-      nsString folderName;</span>
<a href="#l15.196"></a><span id="l15.196" class="difflineminus">-      folder-&gt;GetPrettyName(folderName);</span>
<a href="#l15.197"></a><span id="l15.197" class="difflineminus">-      // this will set the localized name based on the folder flag.</span>
<a href="#l15.198"></a><span id="l15.198" class="difflineminus">-      folder-&gt;SetPrettyName(folderName);</span>
<a href="#l15.199"></a><span id="l15.199" class="difflineplus">+      existingFolder = nullptr;</span>
<a href="#l15.200"></a><span id="l15.200" class="difflineplus">+    }</span>
<a href="#l15.201"></a><span id="l15.201" class="difflineplus">+    if (!existingFolder)</span>
<a href="#l15.202"></a><span id="l15.202" class="difflineplus">+    {</span>
<a href="#l15.203"></a><span id="l15.203" class="difflineplus">+      folder-&gt;SetFlag(folderFlag);</span>
<a href="#l15.204"></a><span id="l15.204">     }</span>
<a href="#l15.205"></a><span id="l15.205" class="difflineplus">+</span>
<a href="#l15.206"></a><span id="l15.206" class="difflineplus">+    nsString folderName;</span>
<a href="#l15.207"></a><span id="l15.207" class="difflineplus">+    folder-&gt;GetPrettyName(folderName);</span>
<a href="#l15.208"></a><span id="l15.208" class="difflineplus">+    // this will set the localized name based on the folder flag.</span>
<a href="#l15.209"></a><span id="l15.209" class="difflineplus">+    folder-&gt;SetPrettyName(folderName);</span>
<a href="#l15.210"></a><span id="l15.210">   }</span>
<a href="#l15.211"></a><span id="l15.211"> </span>
<a href="#l15.212"></a><span id="l15.212">   if (existingFolder)</span>
<a href="#l15.213"></a><span id="l15.213">   {</span>
<a href="#l15.214"></a><span id="l15.214">     existingFolder-&gt;GetURI(existingUri);</span>
<a href="#l15.215"></a><span id="l15.215">     return true;</span>
<a href="#l15.216"></a><span id="l15.216">   }</span>
<a href="#l15.217"></a><span id="l15.217"> </span>
<a href="#l15.218"></a><span id="l15.218" class="difflineat">@@ -3269,34 +3248,27 @@ nsImapIncomingServer::GetMsgFolderFromUR</span>
<a href="#l15.219"></a><span id="l15.219">     rv = GetExistingMsgFolder(aURI, folderUriWithNamespace,</span>
<a href="#l15.220"></a><span id="l15.220">                               namespacePrefixAdded, true,</span>
<a href="#l15.221"></a><span id="l15.221">                               getter_AddRefs(msgFolder));</span>
<a href="#l15.222"></a><span id="l15.222"> </span>
<a href="#l15.223"></a><span id="l15.223">   if (NS_FAILED(rv) || !msgFolder) {</span>
<a href="#l15.224"></a><span id="l15.224">     // we didn't find the folder so we will have to create a new one.</span>
<a href="#l15.225"></a><span id="l15.225">     if (namespacePrefixAdded)</span>
<a href="#l15.226"></a><span id="l15.226">     {</span>
<a href="#l15.227"></a><span id="l15.227" class="difflineminus">-      nsCOMPtr &lt;nsIRDFService&gt; rdf = do_GetService(&quot;@mozilla.org/rdf/rdf-service;1&quot;, &amp;rv);</span>
<a href="#l15.228"></a><span id="l15.228" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l15.229"></a><span id="l15.229" class="difflineminus">-</span>
<a href="#l15.230"></a><span id="l15.230" class="difflineminus">-      nsCOMPtr&lt;nsIRDFResource&gt; resource;</span>
<a href="#l15.231"></a><span id="l15.231" class="difflineminus">-      rv = rdf-&gt;GetResource(folderUriWithNamespace, getter_AddRefs(resource));</span>
<a href="#l15.232"></a><span id="l15.232" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l15.233"></a><span id="l15.233" class="difflineminus">-</span>
<a href="#l15.234"></a><span id="l15.234" class="difflineminus">-      nsCOMPtr &lt;nsIMsgFolder&gt; folderResource;</span>
<a href="#l15.235"></a><span id="l15.235" class="difflineminus">-      folderResource = do_QueryInterface(resource, &amp;rv);</span>
<a href="#l15.236"></a><span id="l15.236" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l15.237"></a><span id="l15.237" class="difflineminus">-      msgFolder = folderResource;</span>
<a href="#l15.238"></a><span id="l15.238" class="difflineplus">+      nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l15.239"></a><span id="l15.239" class="difflineplus">+      rv = GetOrCreateFolder(folderUriWithNamespace, getter_AddRefs(folder));</span>
<a href="#l15.240"></a><span id="l15.240" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.241"></a><span id="l15.241" class="difflineplus">+      msgFolder = folder;</span>
<a href="#l15.242"></a><span id="l15.242">     }</span>
<a href="#l15.243"></a><span id="l15.243">     else</span>
<a href="#l15.244"></a><span id="l15.244">       msgFolder = aFolderResource;</span>
<a href="#l15.245"></a><span id="l15.245">   }</span>
<a href="#l15.246"></a><span id="l15.246"> </span>
<a href="#l15.247"></a><span id="l15.247">   msgFolder.forget(aFolder);</span>
<a href="#l15.248"></a><span id="l15.248" class="difflineminus">-  return NS_OK;</span>
<a href="#l15.249"></a><span id="l15.249" class="difflineplus">+  return (aFolder ? NS_OK : NS_ERROR_FAILURE);</span>
<a href="#l15.250"></a><span id="l15.250"> }</span>
<a href="#l15.251"></a><span id="l15.251"> </span>
<a href="#l15.252"></a><span id="l15.252"> nsresult</span>
<a href="#l15.253"></a><span id="l15.253"> nsImapIncomingServer::GetExistingMsgFolder(const nsACString&amp; aURI,</span>
<a href="#l15.254"></a><span id="l15.254">                                            nsACString&amp; aFolderUriWithNamespace,</span>
<a href="#l15.255"></a><span id="l15.255">                                            bool&amp; aNamespacePrefixAdded,</span>
<a href="#l15.256"></a><span id="l15.256">                                            bool aCaseInsensitive,</span>
<a href="#l15.257"></a><span id="l15.257">                                            nsIMsgFolder **aFolder)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/imap/src/nsImapIncomingServer.h</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapIncomingServer.h</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -14,17 +14,16 @@</span>
<a href="#l16.4"></a><span id="l16.4"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l16.5"></a><span id="l16.5"> #include &quot;nsISubscribableServer.h&quot;</span>
<a href="#l16.6"></a><span id="l16.6"> #include &quot;nsIUrlListener.h&quot;</span>
<a href="#l16.7"></a><span id="l16.7"> #include &quot;nsIMsgImapMailFolder.h&quot;</span>
<a href="#l16.8"></a><span id="l16.8"> #include &quot;nsCOMArray.h&quot;</span>
<a href="#l16.9"></a><span id="l16.9"> #include &quot;nsTArray.h&quot;</span>
<a href="#l16.10"></a><span id="l16.10"> #include &quot;mozilla/Mutex.h&quot;</span>
<a href="#l16.11"></a><span id="l16.11"> </span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-class nsIRDFService;</span>
<a href="#l16.13"></a><span id="l16.13"> </span>
<a href="#l16.14"></a><span id="l16.14"> /* get some implementation from nsMsgIncomingServer */</span>
<a href="#l16.15"></a><span id="l16.15"> class nsImapIncomingServer : public nsMsgIncomingServer,</span>
<a href="#l16.16"></a><span id="l16.16">                              public nsIImapIncomingServer,</span>
<a href="#l16.17"></a><span id="l16.17">                              public nsIImapServerSink,</span>
<a href="#l16.18"></a><span id="l16.18">                              public nsISubscribableServer,</span>
<a href="#l16.19"></a><span id="l16.19">                              public nsIUrlListener</span>
<a href="#l16.20"></a><span id="l16.20"> {</span>
<a href="#l16.21"></a><span id="l16.21" class="difflineat">@@ -94,18 +93,18 @@ private:</span>
<a href="#l16.22"></a><span id="l16.22">                              nsIImapProtocol** aImapConnection);</span>
<a href="#l16.23"></a><span id="l16.23">   nsresult CreateProtocolInstance(nsIImapProtocol ** aImapConnection);</span>
<a href="#l16.24"></a><span id="l16.24">   nsresult CreateHostSpecificPrefName(const char *prefPrefix, nsAutoCString &amp;prefName);</span>
<a href="#l16.25"></a><span id="l16.25"> </span>
<a href="#l16.26"></a><span id="l16.26">   nsresult DoomUrlIfChannelHasError(nsIImapUrl *aImapUrl, bool *urlDoomed);</span>
<a href="#l16.27"></a><span id="l16.27">   bool ConnectionTimeOut(nsIImapProtocol* aImapConnection);</span>
<a href="#l16.28"></a><span id="l16.28">   nsresult GetFormattedStringFromName(const nsAString&amp; aValue, const char* aName, nsAString&amp; aResult);</span>
<a href="#l16.29"></a><span id="l16.29">   nsresult GetPrefForServerAttribute(const char *prefSuffix, bool *prefValue);</span>
<a href="#l16.30"></a><span id="l16.30" class="difflineminus">-  bool CheckSpecialFolder(nsIRDFService *rdf, nsCString &amp;folderUri,</span>
<a href="#l16.31"></a><span id="l16.31" class="difflineminus">-                            uint32_t folderFlag, nsCString &amp;existingUri);</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineplus">+  bool CheckSpecialFolder(nsCString &amp;folderUri,</span>
<a href="#l16.33"></a><span id="l16.33" class="difflineplus">+                          uint32_t folderFlag, nsCString &amp;existingUri);</span>
<a href="#l16.34"></a><span id="l16.34"> </span>
<a href="#l16.35"></a><span id="l16.35">   nsCOMArray&lt;nsIImapProtocol&gt; m_connectionCache;</span>
<a href="#l16.36"></a><span id="l16.36">   nsCOMArray&lt;nsIImapUrl&gt; m_urlQueue;</span>
<a href="#l16.37"></a><span id="l16.37">   nsCOMPtr&lt;nsIStringBundle&gt;m_stringBundle;</span>
<a href="#l16.38"></a><span id="l16.38">   nsCOMArray&lt;nsIMsgFolder&gt; m_subscribeFolders; // used to keep folder resources around while subscribe UI is up.</span>
<a href="#l16.39"></a><span id="l16.39">   nsCOMArray&lt;nsIMsgImapMailFolder&gt; m_foldersToStat; // folders to check for new mail with Status</span>
<a href="#l16.40"></a><span id="l16.40">   nsTArray&lt;nsISupports*&gt; m_urlConsumers;</span>
<a href="#l16.41"></a><span id="l16.41">   eIMAPCapabilityFlags m_capability;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -8,18 +8,16 @@</span>
<a href="#l17.4"></a><span id="l17.4"> #include &quot;prmem.h&quot;</span>
<a href="#l17.5"></a><span id="l17.5"> #include &quot;nsMsgImapCID.h&quot;</span>
<a href="#l17.6"></a><span id="l17.6"> #include &quot;nsImapMailFolder.h&quot;</span>
<a href="#l17.7"></a><span id="l17.7"> #include &quot;nsIImapService.h&quot;</span>
<a href="#l17.8"></a><span id="l17.8"> #include &quot;nsIFile.h&quot;</span>
<a href="#l17.9"></a><span id="l17.9"> #include &quot;nsIUrlListener.h&quot;</span>
<a href="#l17.10"></a><span id="l17.10"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l17.11"></a><span id="l17.11"> #include &quot;nsAutoPtr.h&quot;</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-#include &quot;nsIRDFService.h&quot;</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineminus">-#include &quot;nsRDFCID.h&quot;</span>
<a href="#l17.14"></a><span id="l17.14"> #include &quot;nsMsgDBCID.h&quot;</span>
<a href="#l17.15"></a><span id="l17.15"> #include &quot;nsMsgFolderFlags.h&quot;</span>
<a href="#l17.16"></a><span id="l17.16"> #include &quot;nsISeekableStream.h&quot;</span>
<a href="#l17.17"></a><span id="l17.17"> #include &quot;nsThreadUtils.h&quot;</span>
<a href="#l17.18"></a><span id="l17.18"> #include &quot;nsIImapUrl.h&quot;</span>
<a href="#l17.19"></a><span id="l17.19"> #include &quot;nsImapUtils.h&quot;</span>
<a href="#l17.20"></a><span id="l17.20"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l17.21"></a><span id="l17.21"> #include &quot;nsIMsgMailSession.h&quot;</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineat">@@ -88,17 +86,16 @@</span>
<a href="#l17.23"></a><span id="l17.23"> #include &quot;nsStringEnumerator.h&quot;</span>
<a href="#l17.24"></a><span id="l17.24"> #include &quot;nsIMsgStatusFeedback.h&quot;</span>
<a href="#l17.25"></a><span id="l17.25"> #include &quot;nsMsgLineBuffer.h&quot;</span>
<a href="#l17.26"></a><span id="l17.26"> #include &quot;mozilla/Logging.h&quot;</span>
<a href="#l17.27"></a><span id="l17.27"> #include &quot;mozilla/Attributes.h&quot;</span>
<a href="#l17.28"></a><span id="l17.28"> #include &quot;nsStringStream.h&quot;</span>
<a href="#l17.29"></a><span id="l17.29"> #include &quot;nsIStreamListener.h&quot;</span>
<a href="#l17.30"></a><span id="l17.30"> </span>
<a href="#l17.31"></a><span id="l17.31" class="difflineminus">-static NS_DEFINE_CID(kRDFServiceCID, NS_RDFSERVICE_CID);</span>
<a href="#l17.32"></a><span id="l17.32"> static NS_DEFINE_CID(kParseMailMsgStateCID, NS_PARSEMAILMSGSTATE_CID);</span>
<a href="#l17.33"></a><span id="l17.33"> static NS_DEFINE_CID(kCImapHostSessionList, NS_IIMAPHOSTSESSIONLIST_CID);</span>
<a href="#l17.34"></a><span id="l17.34"> </span>
<a href="#l17.35"></a><span id="l17.35"> extern mozilla::LazyLogModule gAutoSyncLog; // defined in nsAutoSyncManager.cpp</span>
<a href="#l17.36"></a><span id="l17.36"> extern mozilla::LazyLogModule IMAP;         // defined in nsImapProtocol.cpp</span>
<a href="#l17.37"></a><span id="l17.37"> extern mozilla::LazyLogModule IMAP_CS;      // For CONDSTORE, defined in nsImapProtocol.cpp</span>
<a href="#l17.38"></a><span id="l17.38"> mozilla::LazyLogModule IMAP_KW(&quot;IMAP_KW&quot;);  // for logging keyword (tag) processing</span>
<a href="#l17.39"></a><span id="l17.39"> </span>
<a href="#l17.40"></a><span id="l17.40" class="difflineat">@@ -258,18 +255,16 @@ nsresult nsImapMailFolder::CreateChildFr</span>
<a href="#l17.41"></a><span id="l17.41"> }</span>
<a href="#l17.42"></a><span id="l17.42"> </span>
<a href="#l17.43"></a><span id="l17.43"> NS_IMETHODIMP nsImapMailFolder::AddSubfolder(const nsAString&amp; aName, nsIMsgFolder** aChild)</span>
<a href="#l17.44"></a><span id="l17.44"> {</span>
<a href="#l17.45"></a><span id="l17.45">   NS_ENSURE_ARG_POINTER(aChild);</span>
<a href="#l17.46"></a><span id="l17.46"> </span>
<a href="#l17.47"></a><span id="l17.47">   int32_t flags = 0;</span>
<a href="#l17.48"></a><span id="l17.48">   nsresult rv;</span>
<a href="#l17.49"></a><span id="l17.49" class="difflineminus">-  nsCOMPtr&lt;nsIRDFService&gt; rdf = do_GetService(&quot;@mozilla.org/rdf/rdf-service;1&quot;, &amp;rv);</span>
<a href="#l17.50"></a><span id="l17.50" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l17.51"></a><span id="l17.51"> </span>
<a href="#l17.52"></a><span id="l17.52">   nsAutoCString uri(mURI);</span>
<a href="#l17.53"></a><span id="l17.53">   uri.Append('/');</span>
<a href="#l17.54"></a><span id="l17.54"> </span>
<a href="#l17.55"></a><span id="l17.55">   // If AddSubFolder starts getting called for folders other than virtual folders,</span>
<a href="#l17.56"></a><span id="l17.56">   // we'll have to do convert those names to modified utf-7. For now, the account manager code</span>
<a href="#l17.57"></a><span id="l17.57">   // that loads the virtual folders for each account, expects utf8 not modified utf-7.</span>
<a href="#l17.58"></a><span id="l17.58">   nsAutoCString escapedName;</span>
<a href="#l17.59"></a><span id="l17.59" class="difflineat">@@ -278,23 +273,19 @@ NS_IMETHODIMP nsImapMailFolder::AddSubfo</span>
<a href="#l17.60"></a><span id="l17.60"> </span>
<a href="#l17.61"></a><span id="l17.61">   uri += escapedName.get();</span>
<a href="#l17.62"></a><span id="l17.62"> </span>
<a href="#l17.63"></a><span id="l17.63">   nsCOMPtr &lt;nsIMsgFolder&gt; msgFolder;</span>
<a href="#l17.64"></a><span id="l17.64">   rv = GetChildWithURI(uri, false/*deep*/, true /*case Insensitive*/, getter_AddRefs(msgFolder));</span>
<a href="#l17.65"></a><span id="l17.65">   if (NS_SUCCEEDED(rv) &amp;&amp; msgFolder)</span>
<a href="#l17.66"></a><span id="l17.66">     return NS_MSG_FOLDER_EXISTS;</span>
<a href="#l17.67"></a><span id="l17.67"> </span>
<a href="#l17.68"></a><span id="l17.68" class="difflineminus">-  nsCOMPtr&lt;nsIRDFResource&gt; res;</span>
<a href="#l17.69"></a><span id="l17.69" class="difflineminus">-  rv = rdf-&gt;GetResource(uri, getter_AddRefs(res));</span>
<a href="#l17.70"></a><span id="l17.70" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l17.71"></a><span id="l17.71" class="difflineminus">-    return rv;</span>
<a href="#l17.72"></a><span id="l17.72" class="difflineminus">-</span>
<a href="#l17.73"></a><span id="l17.73" class="difflineminus">-  nsCOMPtr&lt;nsIMsgFolder&gt; folder(do_QueryInterface(res, &amp;rv));</span>
<a href="#l17.74"></a><span id="l17.74" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.75"></a><span id="l17.75" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l17.76"></a><span id="l17.76" class="difflineplus">+  rv = GetOrCreateFolder(uri, getter_AddRefs(folder));</span>
<a href="#l17.77"></a><span id="l17.77" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, NS_ERROR_FAILURE);</span>
<a href="#l17.78"></a><span id="l17.78"> </span>
<a href="#l17.79"></a><span id="l17.79">   nsCOMPtr &lt;nsIFile&gt; path;</span>
<a href="#l17.80"></a><span id="l17.80">   rv = CreateDirectoryForFolder(getter_AddRefs(path));</span>
<a href="#l17.81"></a><span id="l17.81">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.82"></a><span id="l17.82"> </span>
<a href="#l17.83"></a><span id="l17.83">   folder-&gt;GetFlags((uint32_t *)&amp;flags);</span>
<a href="#l17.84"></a><span id="l17.84"> </span>
<a href="#l17.85"></a><span id="l17.85">   flags |= nsMsgFolderFlags::Mail;</span>
<a href="#l17.86"></a><span id="l17.86" class="difflineat">@@ -326,18 +317,16 @@ NS_IMETHODIMP nsImapMailFolder::AddSubfo</span>
<a href="#l17.87"></a><span id="l17.87">   return rv;</span>
<a href="#l17.88"></a><span id="l17.88"> }</span>
<a href="#l17.89"></a><span id="l17.89"> </span>
<a href="#l17.90"></a><span id="l17.90"> nsresult nsImapMailFolder::AddSubfolderWithPath(nsAString&amp; name, nsIFile *dbPath,</span>
<a href="#l17.91"></a><span id="l17.91">                                              nsIMsgFolder **child, bool brandNew)</span>
<a href="#l17.92"></a><span id="l17.92"> {</span>
<a href="#l17.93"></a><span id="l17.93">   NS_ENSURE_ARG_POINTER(child);</span>
<a href="#l17.94"></a><span id="l17.94">   nsresult rv;</span>
<a href="#l17.95"></a><span id="l17.95" class="difflineminus">-  nsCOMPtr&lt;nsIRDFService&gt; rdf(do_GetService(kRDFServiceCID, &amp;rv));</span>
<a href="#l17.96"></a><span id="l17.96" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.97"></a><span id="l17.97"> </span>
<a href="#l17.98"></a><span id="l17.98">   nsAutoCString uri(mURI);</span>
<a href="#l17.99"></a><span id="l17.99">   uri.Append('/');</span>
<a href="#l17.100"></a><span id="l17.100">   AppendUTF16toUTF8(name, uri);</span>
<a href="#l17.101"></a><span id="l17.101"> </span>
<a href="#l17.102"></a><span id="l17.102">   bool isServer;</span>
<a href="#l17.103"></a><span id="l17.103">   rv = GetIsServer(&amp;isServer);</span>
<a href="#l17.104"></a><span id="l17.104">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.105"></a><span id="l17.105" class="difflineat">@@ -345,22 +334,18 @@ nsresult nsImapMailFolder::AddSubfolderW</span>
<a href="#l17.106"></a><span id="l17.106">   bool isInbox = isServer &amp;&amp; name.LowerCaseEqualsLiteral(&quot;inbox&quot;);</span>
<a href="#l17.107"></a><span id="l17.107"> </span>
<a href="#l17.108"></a><span id="l17.108">   //will make sure mSubFolders does not have duplicates because of bogus msf files.</span>
<a href="#l17.109"></a><span id="l17.109">   nsCOMPtr &lt;nsIMsgFolder&gt; msgFolder;</span>
<a href="#l17.110"></a><span id="l17.110">   rv = GetChildWithURI(uri, false/*deep*/, isInbox /*case Insensitive*/, getter_AddRefs(msgFolder));</span>
<a href="#l17.111"></a><span id="l17.111">   if (NS_SUCCEEDED(rv) &amp;&amp; msgFolder)</span>
<a href="#l17.112"></a><span id="l17.112">     return NS_MSG_FOLDER_EXISTS;</span>
<a href="#l17.113"></a><span id="l17.113"> </span>
<a href="#l17.114"></a><span id="l17.114" class="difflineminus">-  nsCOMPtr&lt;nsIRDFResource&gt; res;</span>
<a href="#l17.115"></a><span id="l17.115" class="difflineminus">-  rv = rdf-&gt;GetResource(uri, getter_AddRefs(res));</span>
<a href="#l17.116"></a><span id="l17.116" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l17.117"></a><span id="l17.117" class="difflineminus">-    return rv;</span>
<a href="#l17.118"></a><span id="l17.118" class="difflineminus">-</span>
<a href="#l17.119"></a><span id="l17.119" class="difflineminus">-  nsCOMPtr&lt;nsIMsgFolder&gt; folder(do_QueryInterface(res, &amp;rv));</span>
<a href="#l17.120"></a><span id="l17.120" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l17.121"></a><span id="l17.121" class="difflineplus">+  rv = GetOrCreateFolder(uri, getter_AddRefs(folder));</span>
<a href="#l17.122"></a><span id="l17.122">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.123"></a><span id="l17.123"> </span>
<a href="#l17.124"></a><span id="l17.124">   folder-&gt;SetFilePath(dbPath);</span>
<a href="#l17.125"></a><span id="l17.125">   nsCOMPtr&lt;nsIMsgImapMailFolder&gt; imapFolder = do_QueryInterface(folder, &amp;rv);</span>
<a href="#l17.126"></a><span id="l17.126">   mozilla::Unused &lt;&lt; imapFolder;</span>
<a href="#l17.127"></a><span id="l17.127">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.128"></a><span id="l17.128"> </span>
<a href="#l17.129"></a><span id="l17.129">   uint32_t flags = 0;</span>
<a href="#l17.130"></a><span id="l17.130" class="difflineat">@@ -872,37 +857,33 @@ NS_IMETHODIMP nsImapMailFolder::CreateCl</span>
<a href="#l17.131"></a><span id="l17.131">   NS_ConvertASCIItoUTF16 leafName(folderName);</span>
<a href="#l17.132"></a><span id="l17.132">   nsAutoString folderNameStr;</span>
<a href="#l17.133"></a><span id="l17.133">   nsAutoString parentName = leafName;</span>
<a href="#l17.134"></a><span id="l17.134">   // use RFind, because folder can start with a delimiter and</span>
<a href="#l17.135"></a><span id="l17.135">   // not be a leaf folder.</span>
<a href="#l17.136"></a><span id="l17.136">   int32_t folderStart = leafName.RFindChar('/');</span>
<a href="#l17.137"></a><span id="l17.137">   if (folderStart &gt; 0)</span>
<a href="#l17.138"></a><span id="l17.138">   {</span>
<a href="#l17.139"></a><span id="l17.139" class="difflineminus">-    nsCOMPtr&lt;nsIRDFService&gt; rdf(do_GetService(kRDFServiceCID, &amp;rv));</span>
<a href="#l17.140"></a><span id="l17.140" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.141"></a><span id="l17.141" class="difflineminus">-    nsCOMPtr&lt;nsIRDFResource&gt; res;</span>
<a href="#l17.142"></a><span id="l17.142" class="difflineminus">-    nsCOMPtr&lt;nsIMsgImapMailFolder&gt; parentFolder;</span>
<a href="#l17.143"></a><span id="l17.143" class="difflineplus">+    nsCOMPtr&lt;nsIMsgImapMailFolder&gt; imapFolder;</span>
<a href="#l17.144"></a><span id="l17.144">     nsAutoCString uri (mURI);</span>
<a href="#l17.145"></a><span id="l17.145">     leafName.Assign(Substring(parentName, folderStart + 1));</span>
<a href="#l17.146"></a><span id="l17.146">     parentName.SetLength(folderStart);</span>
<a href="#l17.147"></a><span id="l17.147"> </span>
<a href="#l17.148"></a><span id="l17.148">     rv = CreateDirectoryForFolder(getter_AddRefs(path));</span>
<a href="#l17.149"></a><span id="l17.149" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l17.150"></a><span id="l17.150" class="difflineminus">-      return rv;</span>
<a href="#l17.151"></a><span id="l17.151" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.152"></a><span id="l17.152">     uri.Append('/');</span>
<a href="#l17.153"></a><span id="l17.153">     uri.Append(NS_LossyConvertUTF16toASCII(parentName));</span>
<a href="#l17.154"></a><span id="l17.154" class="difflineminus">-    rv = rdf-&gt;GetResource(uri, getter_AddRefs(res));</span>
<a href="#l17.155"></a><span id="l17.155" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l17.156"></a><span id="l17.156" class="difflineminus">-      return rv;</span>
<a href="#l17.157"></a><span id="l17.157" class="difflineminus">-    parentFolder = do_QueryInterface(res, &amp;rv);</span>
<a href="#l17.158"></a><span id="l17.158" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l17.159"></a><span id="l17.159" class="difflineplus">+    rv = GetOrCreateFolder(uri, getter_AddRefs(folder));</span>
<a href="#l17.160"></a><span id="l17.160" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.161"></a><span id="l17.161" class="difflineplus">+    imapFolder = do_QueryInterface(folder, &amp;rv);</span>
<a href="#l17.162"></a><span id="l17.162">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.163"></a><span id="l17.163">     nsAutoCString leafnameC;</span>
<a href="#l17.164"></a><span id="l17.164">     LossyCopyUTF16toASCII(leafName, leafnameC);</span>
<a href="#l17.165"></a><span id="l17.165" class="difflineminus">-    return parentFolder-&gt;CreateClientSubfolderInfo(leafnameC, hierarchyDelimiter,flags, suppressNotification);</span>
<a href="#l17.166"></a><span id="l17.166" class="difflineplus">+    return imapFolder-&gt;CreateClientSubfolderInfo(leafnameC, hierarchyDelimiter,flags, suppressNotification);</span>
<a href="#l17.167"></a><span id="l17.167">   }</span>
<a href="#l17.168"></a><span id="l17.168"> </span>
<a href="#l17.169"></a><span id="l17.169">   // if we get here, it's really a leaf, and &quot;this&quot; is the parent.</span>
<a href="#l17.170"></a><span id="l17.170">   folderNameStr = leafName;</span>
<a href="#l17.171"></a><span id="l17.171"> </span>
<a href="#l17.172"></a><span id="l17.172">   // Create an empty database for this mail folder, set its name from the user</span>
<a href="#l17.173"></a><span id="l17.173">   nsCOMPtr&lt;nsIMsgDatabase&gt; mailDBFactory;</span>
<a href="#l17.174"></a><span id="l17.174">   nsCOMPtr&lt;nsIMsgFolder&gt; child;</span>
<a href="#l17.175"></a><span id="l17.175" class="difflineat">@@ -1042,24 +1023,18 @@ NS_IMETHODIMP nsImapMailFolder::CreateSt</span>
<a href="#l17.176"></a><span id="l17.176">     int32_t leafPos = folderName.RFindChar('/');</span>
<a href="#l17.177"></a><span id="l17.177">     nsAutoCString parentName(folderName);</span>
<a href="#l17.178"></a><span id="l17.178"> </span>
<a href="#l17.179"></a><span id="l17.179">     if (leafPos &gt; 0)</span>
<a href="#l17.180"></a><span id="l17.180">     {</span>
<a href="#l17.181"></a><span id="l17.181">       // If there is a hierarchy, there is a parent.</span>
<a href="#l17.182"></a><span id="l17.182">       // Don't strip off slash if it's the first character</span>
<a href="#l17.183"></a><span id="l17.183">       parentName.SetLength(leafPos);</span>
<a href="#l17.184"></a><span id="l17.184" class="difflineminus">-      // get the corresponding RDF resource</span>
<a href="#l17.185"></a><span id="l17.185" class="difflineminus">-      // RDF will create the folder resource if it doesn't already exist</span>
<a href="#l17.186"></a><span id="l17.186" class="difflineminus">-      nsCOMPtr&lt;nsIRDFService&gt; rdf(do_GetService(kRDFServiceCID, &amp;rv));</span>
<a href="#l17.187"></a><span id="l17.187" class="difflineplus">+      rv = GetOrCreateFolder(parentName, getter_AddRefs(msgParent));</span>
<a href="#l17.188"></a><span id="l17.188">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.189"></a><span id="l17.189" class="difflineminus">-      nsCOMPtr&lt;nsIRDFResource&gt; resource;</span>
<a href="#l17.190"></a><span id="l17.190" class="difflineminus">-      rv = rdf-&gt;GetResource(parentName, getter_AddRefs(resource));</span>
<a href="#l17.191"></a><span id="l17.191" class="difflineminus">-      if (NS_FAILED(rv)) return rv;</span>
<a href="#l17.192"></a><span id="l17.192" class="difflineminus">-      msgParent = do_QueryInterface(resource, &amp;rv);</span>
<a href="#l17.193"></a><span id="l17.193">     }</span>
<a href="#l17.194"></a><span id="l17.194">   }</span>
<a href="#l17.195"></a><span id="l17.195">   if (msgParent)</span>
<a href="#l17.196"></a><span id="l17.196">   {</span>
<a href="#l17.197"></a><span id="l17.197">     nsString folderName;</span>
<a href="#l17.198"></a><span id="l17.198">     GetName(folderName);</span>
<a href="#l17.199"></a><span id="l17.199">     nsresult rv;</span>
<a href="#l17.200"></a><span id="l17.200">     nsCOMPtr&lt;nsIImapService&gt; imapService = do_GetService(NS_IMAPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l17.201"></a><span id="l17.201" class="difflineat">@@ -2135,17 +2110,16 @@ nsresult nsImapMailFolder::MarkMessagesI</span>
<a href="#l17.202"></a><span id="l17.202"> </span>
<a href="#l17.203"></a><span id="l17.203"> NS_IMETHODIMP nsImapMailFolder::DeleteMessages(nsIArray *messages,</span>
<a href="#l17.204"></a><span id="l17.204">                                                nsIMsgWindow *msgWindow,</span>
<a href="#l17.205"></a><span id="l17.205">                                                bool deleteStorage, bool isMove,</span>
<a href="#l17.206"></a><span id="l17.206">                                                nsIMsgCopyServiceListener* listener,</span>
<a href="#l17.207"></a><span id="l17.207">                                                bool allowUndo)</span>
<a href="#l17.208"></a><span id="l17.208"> {</span>
<a href="#l17.209"></a><span id="l17.209">   // *** jt - assuming delete is move to the trash folder for now</span>
<a href="#l17.210"></a><span id="l17.210" class="difflineminus">-  nsCOMPtr&lt;nsIRDFResource&gt; res;</span>
<a href="#l17.211"></a><span id="l17.211">   nsAutoCString uri;</span>
<a href="#l17.212"></a><span id="l17.212">   bool deleteImmediatelyNoTrash = false;</span>
<a href="#l17.213"></a><span id="l17.213">   nsAutoCString messageIds;</span>
<a href="#l17.214"></a><span id="l17.214">   nsTArray&lt;nsMsgKey&gt; srcKeyArray;</span>
<a href="#l17.215"></a><span id="l17.215">   bool deleteMsgs = true;  //used for toggling delete status - default is true</span>
<a href="#l17.216"></a><span id="l17.216">   nsMsgImapDeleteModel deleteModel = nsMsgImapDeleteModels::MoveToTrash;</span>
<a href="#l17.217"></a><span id="l17.217">   imapMessageFlagsType messageFlags = kImapMsgDeletedFlag;</span>
<a href="#l17.218"></a><span id="l17.218"> </span>
<a href="#l17.219"></a><span id="l17.219" class="difflineat">@@ -4098,26 +4072,19 @@ nsresult nsImapMailFolder::MoveIncorpora</span>
<a href="#l17.220"></a><span id="l17.220">                                                    nsIMsgDatabase *sourceDB,</span>
<a href="#l17.221"></a><span id="l17.221">                                                    const nsACString&amp; destFolderUri,</span>
<a href="#l17.222"></a><span id="l17.222">                                                    nsIMsgFilter *filter,</span>
<a href="#l17.223"></a><span id="l17.223">                                                    nsIMsgWindow *msgWindow)</span>
<a href="#l17.224"></a><span id="l17.224"> {</span>
<a href="#l17.225"></a><span id="l17.225">   nsresult rv;</span>
<a href="#l17.226"></a><span id="l17.226">   if (m_moveCoalescer)</span>
<a href="#l17.227"></a><span id="l17.227">   {</span>
<a href="#l17.228"></a><span id="l17.228" class="difflineminus">-    nsCOMPtr&lt;nsIRDFService&gt; rdf(do_GetService(kRDFServiceCID, &amp;rv));</span>
<a href="#l17.229"></a><span id="l17.229" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFolder&gt; destIFolder;</span>
<a href="#l17.230"></a><span id="l17.230" class="difflineplus">+    rv = GetOrCreateFolder(destFolderUri, getter_AddRefs(destIFolder));</span>
<a href="#l17.231"></a><span id="l17.231">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.232"></a><span id="l17.232" class="difflineminus">-    nsCOMPtr&lt;nsIRDFResource&gt; res;</span>
<a href="#l17.233"></a><span id="l17.233" class="difflineminus">-    rv = rdf-&gt;GetResource(destFolderUri, getter_AddRefs(res));</span>
<a href="#l17.234"></a><span id="l17.234" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l17.235"></a><span id="l17.235" class="difflineminus">-      return rv;</span>
<a href="#l17.236"></a><span id="l17.236" class="difflineminus">-</span>
<a href="#l17.237"></a><span id="l17.237" class="difflineminus">-    nsCOMPtr&lt;nsIMsgFolder&gt; destIFolder(do_QueryInterface(res, &amp;rv));</span>
<a href="#l17.238"></a><span id="l17.238" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l17.239"></a><span id="l17.239" class="difflineminus">-      return rv;</span>
<a href="#l17.240"></a><span id="l17.240"> </span>
<a href="#l17.241"></a><span id="l17.241">     if (destIFolder)</span>
<a href="#l17.242"></a><span id="l17.242">     {</span>
<a href="#l17.243"></a><span id="l17.243">       // check if the destination is a real folder (by checking for null parent)</span>
<a href="#l17.244"></a><span id="l17.244">       // and if it can file messages (e.g., servers or news folders can't file messages).</span>
<a href="#l17.245"></a><span id="l17.245">       // Or read only imap folders...</span>
<a href="#l17.246"></a><span id="l17.246">       bool canFileMessages = true;</span>
<a href="#l17.247"></a><span id="l17.247">       nsCOMPtr&lt;nsIMsgFolder&gt; parentFolder;</span>
<a href="#l17.248"></a><span id="l17.248" class="difflineat">@@ -6910,76 +6877,59 @@ nsresult nsImapMailFolder::GetClearedOri</span>
<a href="#l17.249"></a><span id="l17.249">   nsCOMPtr&lt;nsIMsgOfflineImapOperation&gt; returnOp;</span>
<a href="#l17.250"></a><span id="l17.250">   nsOfflineImapOperationType opType;</span>
<a href="#l17.251"></a><span id="l17.251">   op-&gt;GetOperation(&amp;opType);</span>
<a href="#l17.252"></a><span id="l17.252">   NS_ASSERTION(opType &amp; nsIMsgOfflineImapOperation::kMoveResult, &quot;not an offline move op&quot;);</span>
<a href="#l17.253"></a><span id="l17.253"> </span>
<a href="#l17.254"></a><span id="l17.254">   nsCString sourceFolderURI;</span>
<a href="#l17.255"></a><span id="l17.255">   op-&gt;GetSourceFolderURI(getter_Copies(sourceFolderURI));</span>
<a href="#l17.256"></a><span id="l17.256"> </span>
<a href="#l17.257"></a><span id="l17.257" class="difflineminus">-  nsCOMPtr&lt;nsIRDFResource&gt; res;</span>
<a href="#l17.258"></a><span id="l17.258">   nsresult rv;</span>
<a href="#l17.259"></a><span id="l17.259" class="difflineminus">-  nsCOMPtr&lt;nsIRDFService&gt; rdf(do_GetService(kRDFServiceCID, &amp;rv));</span>
<a href="#l17.260"></a><span id="l17.260" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; sourceFolder;</span>
<a href="#l17.261"></a><span id="l17.261" class="difflineplus">+  rv = GetOrCreateFolder(sourceFolderURI, getter_AddRefs(sourceFolder));</span>
<a href="#l17.262"></a><span id="l17.262">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.263"></a><span id="l17.263" class="difflineminus">-  rv = rdf-&gt;GetResource(sourceFolderURI, getter_AddRefs(res));</span>
<a href="#l17.264"></a><span id="l17.264" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l17.265"></a><span id="l17.265" class="difflineminus">-  {</span>
<a href="#l17.266"></a><span id="l17.266" class="difflineminus">-    nsCOMPtr&lt;nsIMsgFolder&gt; sourceFolder(do_QueryInterface(res, &amp;rv));</span>
<a href="#l17.267"></a><span id="l17.267" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; sourceFolder)</span>
<a href="#l17.268"></a><span id="l17.268" class="difflineminus">-    {</span>
<a href="#l17.269"></a><span id="l17.269" class="difflineminus">-      if (sourceFolder)</span>
<a href="#l17.270"></a><span id="l17.270" class="difflineminus">-      {</span>
<a href="#l17.271"></a><span id="l17.271" class="difflineminus">-        nsCOMPtr &lt;nsIDBFolderInfo&gt; folderInfo;</span>
<a href="#l17.272"></a><span id="l17.272" class="difflineminus">-        sourceFolder-&gt;GetDBFolderInfoAndDB(getter_AddRefs(folderInfo), originalDB);</span>
<a href="#l17.273"></a><span id="l17.273" class="difflineminus">-        if (*originalDB)</span>
<a href="#l17.274"></a><span id="l17.274" class="difflineminus">-        {</span>
<a href="#l17.275"></a><span id="l17.275" class="difflineminus">-          nsMsgKey originalKey;</span>
<a href="#l17.276"></a><span id="l17.276" class="difflineminus">-          op-&gt;GetMessageKey(&amp;originalKey);</span>
<a href="#l17.277"></a><span id="l17.277" class="difflineminus">-          rv = (*originalDB)-&gt;GetOfflineOpForKey(originalKey, false, getter_AddRefs(returnOp));</span>
<a href="#l17.278"></a><span id="l17.278" class="difflineminus">-          if (NS_SUCCEEDED(rv) &amp;&amp; returnOp)</span>
<a href="#l17.279"></a><span id="l17.279" class="difflineminus">-          {</span>
<a href="#l17.280"></a><span id="l17.280" class="difflineminus">-            nsCString moveDestination;</span>
<a href="#l17.281"></a><span id="l17.281" class="difflineminus">-            nsCString thisFolderURI;</span>
<a href="#l17.282"></a><span id="l17.282" class="difflineminus">-            GetURI(thisFolderURI);</span>
<a href="#l17.283"></a><span id="l17.283" class="difflineminus">-            returnOp-&gt;GetDestinationFolderURI(getter_Copies(moveDestination));</span>
<a href="#l17.284"></a><span id="l17.284" class="difflineminus">-            if (moveDestination.Equals(thisFolderURI))</span>
<a href="#l17.285"></a><span id="l17.285" class="difflineminus">-              returnOp-&gt;ClearOperation(nsIMsgOfflineImapOperation::kMoveResult);</span>
<a href="#l17.286"></a><span id="l17.286" class="difflineminus">-          }</span>
<a href="#l17.287"></a><span id="l17.287" class="difflineminus">-        }</span>
<a href="#l17.288"></a><span id="l17.288" class="difflineminus">-      }</span>
<a href="#l17.289"></a><span id="l17.289" class="difflineplus">+</span>
<a href="#l17.290"></a><span id="l17.290" class="difflineplus">+  nsCOMPtr&lt;nsIDBFolderInfo&gt; folderInfo;</span>
<a href="#l17.291"></a><span id="l17.291" class="difflineplus">+  sourceFolder-&gt;GetDBFolderInfoAndDB(getter_AddRefs(folderInfo), originalDB);</span>
<a href="#l17.292"></a><span id="l17.292" class="difflineplus">+  if (*originalDB)</span>
<a href="#l17.293"></a><span id="l17.293" class="difflineplus">+  {</span>
<a href="#l17.294"></a><span id="l17.294" class="difflineplus">+    nsMsgKey originalKey;</span>
<a href="#l17.295"></a><span id="l17.295" class="difflineplus">+    op-&gt;GetMessageKey(&amp;originalKey);</span>
<a href="#l17.296"></a><span id="l17.296" class="difflineplus">+    rv = (*originalDB)-&gt;GetOfflineOpForKey(originalKey, false, getter_AddRefs(returnOp));</span>
<a href="#l17.297"></a><span id="l17.297" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; returnOp)</span>
<a href="#l17.298"></a><span id="l17.298" class="difflineplus">+    {</span>
<a href="#l17.299"></a><span id="l17.299" class="difflineplus">+      nsCString moveDestination;</span>
<a href="#l17.300"></a><span id="l17.300" class="difflineplus">+      nsCString thisFolderURI;</span>
<a href="#l17.301"></a><span id="l17.301" class="difflineplus">+      GetURI(thisFolderURI);</span>
<a href="#l17.302"></a><span id="l17.302" class="difflineplus">+      returnOp-&gt;GetDestinationFolderURI(getter_Copies(moveDestination));</span>
<a href="#l17.303"></a><span id="l17.303" class="difflineplus">+      if (moveDestination.Equals(thisFolderURI))</span>
<a href="#l17.304"></a><span id="l17.304" class="difflineplus">+        returnOp-&gt;ClearOperation(nsIMsgOfflineImapOperation::kMoveResult);</span>
<a href="#l17.305"></a><span id="l17.305">     }</span>
<a href="#l17.306"></a><span id="l17.306">   }</span>
<a href="#l17.307"></a><span id="l17.307">   returnOp.forget(originalOp);</span>
<a href="#l17.308"></a><span id="l17.308">   return rv;</span>
<a href="#l17.309"></a><span id="l17.309"> }</span>
<a href="#l17.310"></a><span id="l17.310"> </span>
<a href="#l17.311"></a><span id="l17.311"> nsresult nsImapMailFolder::GetOriginalOp(nsIMsgOfflineImapOperation *op, nsIMsgOfflineImapOperation **originalOp, nsIMsgDatabase **originalDB)</span>
<a href="#l17.312"></a><span id="l17.312"> {</span>
<a href="#l17.313"></a><span id="l17.313">   nsCOMPtr&lt;nsIMsgOfflineImapOperation&gt; returnOp;</span>
<a href="#l17.314"></a><span id="l17.314">   nsCString sourceFolderURI;</span>
<a href="#l17.315"></a><span id="l17.315">   op-&gt;GetSourceFolderURI(getter_Copies(sourceFolderURI));</span>
<a href="#l17.316"></a><span id="l17.316"> </span>
<a href="#l17.317"></a><span id="l17.317" class="difflineminus">-  nsCOMPtr&lt;nsIRDFResource&gt; res;</span>
<a href="#l17.318"></a><span id="l17.318">   nsresult rv;</span>
<a href="#l17.319"></a><span id="l17.319" class="difflineminus">-</span>
<a href="#l17.320"></a><span id="l17.320" class="difflineminus">-  nsCOMPtr&lt;nsIRDFService&gt; rdf(do_GetService(kRDFServiceCID, &amp;rv));</span>
<a href="#l17.321"></a><span id="l17.321" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; sourceFolder;</span>
<a href="#l17.322"></a><span id="l17.322" class="difflineplus">+  rv = GetOrCreateFolder(sourceFolderURI, getter_AddRefs(sourceFolder));</span>
<a href="#l17.323"></a><span id="l17.323">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.324"></a><span id="l17.324" class="difflineminus">-  rv = rdf-&gt;GetResource(sourceFolderURI, getter_AddRefs(res));</span>
<a href="#l17.325"></a><span id="l17.325" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l17.326"></a><span id="l17.326" class="difflineminus">-  {</span>
<a href="#l17.327"></a><span id="l17.327" class="difflineminus">-    nsCOMPtr&lt;nsIMsgFolder&gt; sourceFolder(do_QueryInterface(res, &amp;rv));</span>
<a href="#l17.328"></a><span id="l17.328" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.329"></a><span id="l17.329" class="difflineminus">-    nsCOMPtr &lt;nsIDBFolderInfo&gt; folderInfo;</span>
<a href="#l17.330"></a><span id="l17.330" class="difflineminus">-    sourceFolder-&gt;GetDBFolderInfoAndDB(getter_AddRefs(folderInfo), originalDB);</span>
<a href="#l17.331"></a><span id="l17.331" class="difflineminus">-    if (*originalDB)</span>
<a href="#l17.332"></a><span id="l17.332" class="difflineminus">-    {</span>
<a href="#l17.333"></a><span id="l17.333" class="difflineminus">-      nsMsgKey originalKey;</span>
<a href="#l17.334"></a><span id="l17.334" class="difflineminus">-      op-&gt;GetMessageKey(&amp;originalKey);</span>
<a href="#l17.335"></a><span id="l17.335" class="difflineminus">-      rv = (*originalDB)-&gt;GetOfflineOpForKey(originalKey, false, getter_AddRefs(returnOp));</span>
<a href="#l17.336"></a><span id="l17.336" class="difflineminus">-    }</span>
<a href="#l17.337"></a><span id="l17.337" class="difflineplus">+  nsCOMPtr&lt;nsIDBFolderInfo&gt; folderInfo;</span>
<a href="#l17.338"></a><span id="l17.338" class="difflineplus">+  sourceFolder-&gt;GetDBFolderInfoAndDB(getter_AddRefs(folderInfo), originalDB);</span>
<a href="#l17.339"></a><span id="l17.339" class="difflineplus">+  if (*originalDB)</span>
<a href="#l17.340"></a><span id="l17.340" class="difflineplus">+  {</span>
<a href="#l17.341"></a><span id="l17.341" class="difflineplus">+    nsMsgKey originalKey;</span>
<a href="#l17.342"></a><span id="l17.342" class="difflineplus">+    op-&gt;GetMessageKey(&amp;originalKey);</span>
<a href="#l17.343"></a><span id="l17.343" class="difflineplus">+    rv = (*originalDB)-&gt;GetOfflineOpForKey(originalKey, false, getter_AddRefs(returnOp));</span>
<a href="#l17.344"></a><span id="l17.344">   }</span>
<a href="#l17.345"></a><span id="l17.345">   returnOp.forget(originalOp);</span>
<a href="#l17.346"></a><span id="l17.346">   return rv;</span>
<a href="#l17.347"></a><span id="l17.347"> }</span>
<a href="#l17.348"></a><span id="l17.348"> </span>
<a href="#l17.349"></a><span id="l17.349"> nsresult nsImapMailFolder::CopyOfflineMsgBody(nsIMsgFolder *srcFolder,</span>
<a href="#l17.350"></a><span id="l17.350">                                               nsIMsgDBHdr *destHdr,</span>
<a href="#l17.351"></a><span id="l17.351">                                               nsIMsgDBHdr *origHdr,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/imap/src/nsImapOfflineSync.cpp</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapOfflineSync.cpp</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -4,35 +4,30 @@</span>
<a href="#l18.4"></a><span id="l18.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l18.5"></a><span id="l18.5"> </span>
<a href="#l18.6"></a><span id="l18.6"> #include &quot;msgCore.h&quot;</span>
<a href="#l18.7"></a><span id="l18.7"> #include &quot;netCore.h&quot;</span>
<a href="#l18.8"></a><span id="l18.8"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l18.9"></a><span id="l18.9"> #include &quot;nsImapOfflineSync.h&quot;</span>
<a href="#l18.10"></a><span id="l18.10"> #include &quot;nsImapMailFolder.h&quot;</span>
<a href="#l18.11"></a><span id="l18.11"> #include &quot;nsMsgFolderFlags.h&quot;</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-#include &quot;nsIRDFService.h&quot;</span>
<a href="#l18.13"></a><span id="l18.13"> #include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineminus">-#include &quot;nsRDFCID.h&quot;</span>
<a href="#l18.15"></a><span id="l18.15"> #include &quot;nsIMsgMailNewsUrl.h&quot;</span>
<a href="#l18.16"></a><span id="l18.16"> #include &quot;nsIMsgAccountManager.h&quot;</span>
<a href="#l18.17"></a><span id="l18.17"> #include &quot;nsINntpIncomingServer.h&quot;</span>
<a href="#l18.18"></a><span id="l18.18"> #include &quot;nsDirectoryServiceDefs.h&quot;</span>
<a href="#l18.19"></a><span id="l18.19"> #include &quot;nsISeekableStream.h&quot;</span>
<a href="#l18.20"></a><span id="l18.20"> #include &quot;nsIMsgCopyService.h&quot;</span>
<a href="#l18.21"></a><span id="l18.21"> #include &quot;nsImapProtocol.h&quot;</span>
<a href="#l18.22"></a><span id="l18.22"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l18.23"></a><span id="l18.23"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l18.24"></a><span id="l18.24"> #include &quot;nsIAutoSyncManager.h&quot;</span>
<a href="#l18.25"></a><span id="l18.25"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l18.26"></a><span id="l18.26"> #include &quot;mozilla/Unused.h&quot;</span>
<a href="#l18.27"></a><span id="l18.27"> </span>
<a href="#l18.28"></a><span id="l18.28" class="difflineminus">-</span>
<a href="#l18.29"></a><span id="l18.29" class="difflineminus">-static NS_DEFINE_CID(kRDFServiceCID, NS_RDFSERVICE_CID);</span>
<a href="#l18.30"></a><span id="l18.30" class="difflineminus">-</span>
<a href="#l18.31"></a><span id="l18.31"> NS_IMPL_ISUPPORTS(nsImapOfflineSync, nsIUrlListener, nsIMsgCopyServiceListener, nsIDBChangeListener)</span>
<a href="#l18.32"></a><span id="l18.32"> </span>
<a href="#l18.33"></a><span id="l18.33"> nsImapOfflineSync::nsImapOfflineSync(nsIMsgWindow *window, nsIUrlListener *listener, nsIMsgFolder *singleFolderOnly, bool isPseudoOffline)</span>
<a href="#l18.34"></a><span id="l18.34"> {</span>
<a href="#l18.35"></a><span id="l18.35">   m_singleFolderToUpdate = singleFolderOnly;</span>
<a href="#l18.36"></a><span id="l18.36">   m_window = window;</span>
<a href="#l18.37"></a><span id="l18.37">   // not the perfect place for this, but I think it will work.</span>
<a href="#l18.38"></a><span id="l18.38">   if (m_window)</span>
<a href="#l18.39"></a><span id="l18.39" class="difflineat">@@ -402,29 +397,22 @@ nsImapOfflineSync::ProcessAppendMsgOpera</span>
<a href="#l18.40"></a><span id="l18.40">   if (NS_WARN_IF(NS_FAILED(rv) || !outputStream))</span>
<a href="#l18.41"></a><span id="l18.41">     return;</span>
<a href="#l18.42"></a><span id="l18.42"> </span>
<a href="#l18.43"></a><span id="l18.43">   // We break out of the loop to get to the clean-up code.</span>
<a href="#l18.44"></a><span id="l18.44">   bool setPlayingBack = false;</span>
<a href="#l18.45"></a><span id="l18.45">   do {</span>
<a href="#l18.46"></a><span id="l18.46">     nsCString moveDestination;</span>
<a href="#l18.47"></a><span id="l18.47">     currentOp-&gt;GetDestinationFolderURI(getter_Copies(moveDestination));</span>
<a href="#l18.48"></a><span id="l18.48" class="difflineminus">-    nsCOMPtr&lt;nsIRDFService&gt; rdf(do_GetService(kRDFServiceCID, &amp;rv));</span>
<a href="#l18.49"></a><span id="l18.49" class="difflineplus">+</span>
<a href="#l18.50"></a><span id="l18.50" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFolder&gt; destFolder;</span>
<a href="#l18.51"></a><span id="l18.51" class="difflineplus">+    rv = GetOrCreateFolder(moveDestination, getter_AddRefs(destFolder));</span>
<a href="#l18.52"></a><span id="l18.52">     if (NS_WARN_IF(NS_FAILED(rv)))</span>
<a href="#l18.53"></a><span id="l18.53">       break;</span>
<a href="#l18.54"></a><span id="l18.54"> </span>
<a href="#l18.55"></a><span id="l18.55" class="difflineminus">-    nsCOMPtr&lt;nsIRDFResource&gt; res;</span>
<a href="#l18.56"></a><span id="l18.56" class="difflineminus">-    rv = rdf-&gt;GetResource(moveDestination, getter_AddRefs(res));</span>
<a href="#l18.57"></a><span id="l18.57" class="difflineminus">-    if (NS_WARN_IF(NS_FAILED(rv)))</span>
<a href="#l18.58"></a><span id="l18.58" class="difflineminus">-      break;</span>
<a href="#l18.59"></a><span id="l18.59" class="difflineminus">-</span>
<a href="#l18.60"></a><span id="l18.60" class="difflineminus">-    nsCOMPtr&lt;nsIMsgFolder&gt; destFolder(do_QueryInterface(res, &amp;rv));</span>
<a href="#l18.61"></a><span id="l18.61" class="difflineminus">-    if (NS_WARN_IF(!(NS_SUCCEEDED(rv) &amp;&amp; destFolder)))</span>
<a href="#l18.62"></a><span id="l18.62" class="difflineminus">-      break;</span>
<a href="#l18.63"></a><span id="l18.63" class="difflineminus">-</span>
<a href="#l18.64"></a><span id="l18.64">     nsCOMPtr &lt;nsIInputStream&gt; offlineStoreInputStream;</span>
<a href="#l18.65"></a><span id="l18.65">     bool reusable;</span>
<a href="#l18.66"></a><span id="l18.66">     rv = destFolder-&gt;GetMsgInputStream(mailHdr, &amp;reusable,</span>
<a href="#l18.67"></a><span id="l18.67">                                        getter_AddRefs(offlineStoreInputStream));</span>
<a href="#l18.68"></a><span id="l18.68">     if (NS_WARN_IF((NS_FAILED(rv) || !offlineStoreInputStream)))</span>
<a href="#l18.69"></a><span id="l18.69">       break;</span>
<a href="#l18.70"></a><span id="l18.70"> </span>
<a href="#l18.71"></a><span id="l18.71">     nsCOMPtr&lt;nsISeekableStream&gt; seekStream = do_QueryInterface(offlineStoreInputStream);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/imap/src/nsImapService.cpp</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapService.cpp</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -16,18 +16,16 @@</span>
<a href="#l19.4"></a><span id="l19.4"> #include &quot;nsIImapIncomingServer.h&quot;</span>
<a href="#l19.5"></a><span id="l19.5"> #include &quot;nsIImapMailFolderSink.h&quot;</span>
<a href="#l19.6"></a><span id="l19.6"> #include &quot;nsIImapMessageSink.h&quot;</span>
<a href="#l19.7"></a><span id="l19.7"> #include &quot;nsIImapServerSink.h&quot;</span>
<a href="#l19.8"></a><span id="l19.8"> #include &quot;nsIImapMockChannel.h&quot;</span>
<a href="#l19.9"></a><span id="l19.9"> #include &quot;nsImapUtils.h&quot;</span>
<a href="#l19.10"></a><span id="l19.10"> #include &quot;nsIMAPNamespace.h&quot;</span>
<a href="#l19.11"></a><span id="l19.11"> #include &quot;nsIDocShell.h&quot;</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-#include &quot;nsIRDFService.h&quot;</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineminus">-#include &quot;nsRDFCID.h&quot;</span>
<a href="#l19.14"></a><span id="l19.14"> #include &quot;nsIProgressEventSink.h&quot;</span>
<a href="#l19.15"></a><span id="l19.15"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l19.16"></a><span id="l19.16"> #include &quot;nsIPrefService.h&quot;</span>
<a href="#l19.17"></a><span id="l19.17"> #include &quot;nsILoadGroup.h&quot;</span>
<a href="#l19.18"></a><span id="l19.18"> #include &quot;nsIMsgAccountManager.h&quot;</span>
<a href="#l19.19"></a><span id="l19.19"> #include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l19.20"></a><span id="l19.20"> #include &quot;nsMsgFolderFlags.h&quot;</span>
<a href="#l19.21"></a><span id="l19.21"> #include &quot;nsMailDirServiceDefs.h&quot;</span>
<a href="#l19.22"></a><span id="l19.22" class="difflineat">@@ -871,28 +869,20 @@ nsresult nsImapService::DecomposeImapURI</span>
<a href="#l19.23"></a><span id="l19.23">   NS_ENSURE_ARG_POINTER(aFolder);</span>
<a href="#l19.24"></a><span id="l19.24">   NS_ENSURE_ARG_POINTER(aMsgKey);</span>
<a href="#l19.25"></a><span id="l19.25"> </span>
<a href="#l19.26"></a><span id="l19.26">   nsAutoCString folderURI;</span>
<a href="#l19.27"></a><span id="l19.27">   nsresult rv = nsParseImapMessageURI(PromiseFlatCString(aMessageURI).get(),</span>
<a href="#l19.28"></a><span id="l19.28">                                       folderURI, aMsgKey, nullptr);</span>
<a href="#l19.29"></a><span id="l19.29">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.30"></a><span id="l19.30"> </span>
<a href="#l19.31"></a><span id="l19.31" class="difflineminus">-  nsCOMPtr &lt;nsIRDFService&gt; rdf = do_GetService(&quot;@mozilla.org/rdf/rdf-service;1&quot;,&amp;rv);</span>
<a href="#l19.32"></a><span id="l19.32" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.33"></a><span id="l19.33" class="difflineminus">-</span>
<a href="#l19.34"></a><span id="l19.34" class="difflineminus">-  nsCOMPtr&lt;nsIRDFResource&gt; res;</span>
<a href="#l19.35"></a><span id="l19.35" class="difflineminus">-  rv = rdf-&gt;GetResource(folderURI, getter_AddRefs(res));</span>
<a href="#l19.36"></a><span id="l19.36" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l19.37"></a><span id="l19.37" class="difflineplus">+  rv = GetOrCreateFolder(folderURI, aFolder);</span>
<a href="#l19.38"></a><span id="l19.38">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.39"></a><span id="l19.39"> </span>
<a href="#l19.40"></a><span id="l19.40" class="difflineminus">-  nsCOMPtr&lt;nsIMsgFolder&gt; msgFolder = do_QueryInterface(res);</span>
<a href="#l19.41"></a><span id="l19.41" class="difflineminus">-  NS_ENSURE_TRUE(msgFolder, NS_ERROR_FAILURE);</span>
<a href="#l19.42"></a><span id="l19.42" class="difflineminus">-</span>
<a href="#l19.43"></a><span id="l19.43" class="difflineminus">-  msgFolder.forget(aFolder);</span>
<a href="#l19.44"></a><span id="l19.44" class="difflineminus">-</span>
<a href="#l19.45"></a><span id="l19.45">   return NS_OK;</span>
<a href="#l19.46"></a><span id="l19.46"> }</span>
<a href="#l19.47"></a><span id="l19.47"> </span>
<a href="#l19.48"></a><span id="l19.48"> NS_IMETHODIMP nsImapService::SaveMessageToDisk(const char *aMessageURI,</span>
<a href="#l19.49"></a><span id="l19.49">                                                nsIFile *aFile,</span>
<a href="#l19.50"></a><span id="l19.50">                                                bool aAddDummyEnvelope,</span>
<a href="#l19.51"></a><span id="l19.51">                                                nsIUrlListener *aUrlListener,</span>
<a href="#l19.52"></a><span id="l19.52">                                                nsIURI **aURL,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/local/src/nsLocalMailFolder.cpp</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/local/src/nsLocalMailFolder.cpp</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -16,17 +16,16 @@</span>
<a href="#l20.4"></a><span id="l20.4"> #include &quot;prprf.h&quot;</span>
<a href="#l20.5"></a><span id="l20.5"> #include &quot;prmem.h&quot;</span>
<a href="#l20.6"></a><span id="l20.6"> #include &quot;nsIArray.h&quot;</span>
<a href="#l20.7"></a><span id="l20.7"> #include &quot;nsITransactionManager.h&quot;</span>
<a href="#l20.8"></a><span id="l20.8"> #include &quot;nsParseMailbox.h&quot;</span>
<a href="#l20.9"></a><span id="l20.9"> #include &quot;nsIMsgAccountManager.h&quot;</span>
<a href="#l20.10"></a><span id="l20.10"> #include &quot;nsIMsgWindow.h&quot;</span>
<a href="#l20.11"></a><span id="l20.11"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-#include &quot;nsIRDFService.h&quot;</span>
<a href="#l20.13"></a><span id="l20.13"> #include &quot;nsMsgDBCID.h&quot;</span>
<a href="#l20.14"></a><span id="l20.14"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l20.15"></a><span id="l20.15"> #include &quot;nsLocalUtils.h&quot;</span>
<a href="#l20.16"></a><span id="l20.16"> #include &quot;nsIPop3IncomingServer.h&quot;</span>
<a href="#l20.17"></a><span id="l20.17"> #include &quot;nsILocalMailIncomingServer.h&quot;</span>
<a href="#l20.18"></a><span id="l20.18"> #include &quot;nsIMsgIncomingServer.h&quot;</span>
<a href="#l20.19"></a><span id="l20.19"> #include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l20.20"></a><span id="l20.20"> #include &quot;nsMsgLocalCID.h&quot;</span>
<a href="#l20.21"></a><span id="l20.21" class="difflineat">@@ -476,43 +475,34 @@ NS_IMETHODIMP nsMsgLocalMailFolder::GetF</span>
<a href="#l20.22"></a><span id="l20.22"> </span>
<a href="#l20.23"></a><span id="l20.23">   aUrl.Replace(0, strlen(&quot;file:&quot;), &quot;mailbox:&quot;);</span>
<a href="#l20.24"></a><span id="l20.24"> </span>
<a href="#l20.25"></a><span id="l20.25">   return NS_OK;</span>
<a href="#l20.26"></a><span id="l20.26"> }</span>
<a href="#l20.27"></a><span id="l20.27"> </span>
<a href="#l20.28"></a><span id="l20.28"> NS_IMETHODIMP nsMsgLocalMailFolder::CreateStorageIfMissing(nsIUrlListener* aUrlListener)</span>
<a href="#l20.29"></a><span id="l20.29"> {</span>
<a href="#l20.30"></a><span id="l20.30" class="difflineminus">-  nsresult rv;</span>
<a href="#l20.31"></a><span id="l20.31" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l20.32"></a><span id="l20.32">   nsCOMPtr&lt;nsIMsgFolder&gt; msgParent;</span>
<a href="#l20.33"></a><span id="l20.33">   GetParent(getter_AddRefs(msgParent));</span>
<a href="#l20.34"></a><span id="l20.34"> </span>
<a href="#l20.35"></a><span id="l20.35">   // parent is probably not set because *this* was probably created by rdf</span>
<a href="#l20.36"></a><span id="l20.36">   // and not by folder discovery. So, we have to compute the parent.</span>
<a href="#l20.37"></a><span id="l20.37">   if (!msgParent)</span>
<a href="#l20.38"></a><span id="l20.38">   {</span>
<a href="#l20.39"></a><span id="l20.39">     nsAutoCString folderName(mURI);</span>
<a href="#l20.40"></a><span id="l20.40">     nsAutoCString uri;</span>
<a href="#l20.41"></a><span id="l20.41">     int32_t leafPos = folderName.RFindChar('/');</span>
<a href="#l20.42"></a><span id="l20.42">     nsAutoCString parentName(folderName);</span>
<a href="#l20.43"></a><span id="l20.43">     if (leafPos &gt; 0)</span>
<a href="#l20.44"></a><span id="l20.44">     {</span>
<a href="#l20.45"></a><span id="l20.45">       // If there is a hierarchy, there is a parent.</span>
<a href="#l20.46"></a><span id="l20.46">       // Don't strip off slash if it's the first character</span>
<a href="#l20.47"></a><span id="l20.47">       parentName.SetLength(leafPos);</span>
<a href="#l20.48"></a><span id="l20.48" class="difflineminus">-      // get the corresponding RDF resource</span>
<a href="#l20.49"></a><span id="l20.49" class="difflineminus">-      // RDF will create the folder resource if it doesn't already exist</span>
<a href="#l20.50"></a><span id="l20.50" class="difflineminus">-      nsCOMPtr&lt;nsIRDFService&gt; rdf = do_GetService(&quot;@mozilla.org/rdf/rdf-service;1&quot;, &amp;rv);</span>
<a href="#l20.51"></a><span id="l20.51" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l20.52"></a><span id="l20.52" class="difflineminus">-</span>
<a href="#l20.53"></a><span id="l20.53" class="difflineminus">-      nsCOMPtr&lt;nsIRDFResource&gt; resource;</span>
<a href="#l20.54"></a><span id="l20.54" class="difflineminus">-      rv = rdf-&gt;GetResource(parentName, getter_AddRefs(resource));</span>
<a href="#l20.55"></a><span id="l20.55" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l20.56"></a><span id="l20.56" class="difflineminus">-</span>
<a href="#l20.57"></a><span id="l20.57" class="difflineminus">-      msgParent = do_QueryInterface(resource, &amp;rv);</span>
<a href="#l20.58"></a><span id="l20.58" class="difflineplus">+      rv = GetOrCreateFolder(parentName, getter_AddRefs(msgParent));</span>
<a href="#l20.59"></a><span id="l20.59">       NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l20.60"></a><span id="l20.60">     }</span>
<a href="#l20.61"></a><span id="l20.61">   }</span>
<a href="#l20.62"></a><span id="l20.62"> </span>
<a href="#l20.63"></a><span id="l20.63">   if (msgParent)</span>
<a href="#l20.64"></a><span id="l20.64">   {</span>
<a href="#l20.65"></a><span id="l20.65">     nsString folderName;</span>
<a href="#l20.66"></a><span id="l20.66">     GetName(folderName);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mailnews/local/src/nsMailboxService.cpp</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mailnews/local/src/nsMailboxService.cpp</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -22,17 +22,16 @@</span>
<a href="#l21.4"></a><span id="l21.4"> #include &quot;nsNativeCharsetUtils.h&quot;</span>
<a href="#l21.5"></a><span id="l21.5"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l21.6"></a><span id="l21.6"> #include &quot;nsIWebNavigation.h&quot;</span>
<a href="#l21.7"></a><span id="l21.7"> #include &quot;prprf.h&quot;</span>
<a href="#l21.8"></a><span id="l21.8"> #include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l21.9"></a><span id="l21.9"> #include &quot;nsIFileURL.h&quot;</span>
<a href="#l21.10"></a><span id="l21.10"> #include &quot;mozilla/RefPtr.h&quot;</span>
<a href="#l21.11"></a><span id="l21.11"> #include &quot;nsDocShellLoadState.h&quot;</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-#include &quot;nsIRDFService.h&quot;</span>
<a href="#l21.13"></a><span id="l21.13"> #include &quot;nsContentUtils.h&quot;</span>
<a href="#l21.14"></a><span id="l21.14"> </span>
<a href="#l21.15"></a><span id="l21.15"> nsMailboxService::nsMailboxService()</span>
<a href="#l21.16"></a><span id="l21.16"> {</span>
<a href="#l21.17"></a><span id="l21.17">     mPrintingOperation = false;</span>
<a href="#l21.18"></a><span id="l21.18"> }</span>
<a href="#l21.19"></a><span id="l21.19"> </span>
<a href="#l21.20"></a><span id="l21.20"> nsMailboxService::~nsMailboxService()</span>
<a href="#l21.21"></a><span id="l21.21" class="difflineat">@@ -646,27 +645,17 @@ nsMailboxService::DecomposeMailboxURI(co</span>
<a href="#l21.22"></a><span id="l21.22">   NS_ENSURE_ARG_POINTER(aFolder);</span>
<a href="#l21.23"></a><span id="l21.23">   NS_ENSURE_ARG_POINTER(aMsgKey);</span>
<a href="#l21.24"></a><span id="l21.24"> </span>
<a href="#l21.25"></a><span id="l21.25">   nsresult rv = NS_OK;</span>
<a href="#l21.26"></a><span id="l21.26">   nsAutoCString folderURI;</span>
<a href="#l21.27"></a><span id="l21.27">   rv = nsParseLocalMessageURI(aMessageURI, folderURI, aMsgKey);</span>
<a href="#l21.28"></a><span id="l21.28">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l21.29"></a><span id="l21.29"> </span>
<a href="#l21.30"></a><span id="l21.30" class="difflineminus">-  nsCOMPtr &lt;nsIRDFService&gt; rdf = do_GetService(&quot;@mozilla.org/rdf/rdf-service;1&quot;,&amp;rv);</span>
<a href="#l21.31"></a><span id="l21.31" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l21.32"></a><span id="l21.32" class="difflineminus">-</span>
<a href="#l21.33"></a><span id="l21.33" class="difflineminus">-  nsCOMPtr&lt;nsIRDFResource&gt; res;</span>
<a href="#l21.34"></a><span id="l21.34" class="difflineminus">-  rv = rdf-&gt;GetResource(folderURI, getter_AddRefs(res));</span>
<a href="#l21.35"></a><span id="l21.35" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l21.36"></a><span id="l21.36" class="difflineminus">-</span>
<a href="#l21.37"></a><span id="l21.37" class="difflineminus">-  rv = res-&gt;QueryInterface(NS_GET_IID(nsIMsgFolder), (void **) aFolder);</span>
<a href="#l21.38"></a><span id="l21.38" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l21.39"></a><span id="l21.39" class="difflineminus">-</span>
<a href="#l21.40"></a><span id="l21.40" class="difflineminus">-  return NS_OK;</span>
<a href="#l21.41"></a><span id="l21.41" class="difflineplus">+  return GetOrCreateFolder(folderURI, aFolder);</span>
<a href="#l21.42"></a><span id="l21.42"> }</span>
<a href="#l21.43"></a><span id="l21.43"> </span>
<a href="#l21.44"></a><span id="l21.44"> NS_IMETHODIMP</span>
<a href="#l21.45"></a><span id="l21.45"> nsMailboxService::MessageURIToMsgHdr(const char *uri, nsIMsgDBHdr **_retval)</span>
<a href="#l21.46"></a><span id="l21.46"> {</span>
<a href="#l21.47"></a><span id="l21.47">   NS_ENSURE_ARG_POINTER(uri);</span>
<a href="#l21.48"></a><span id="l21.48">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l21.49"></a><span id="l21.49"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mailnews/local/src/nsParseMailbox.cpp</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mailnews/local/src/nsParseMailbox.cpp</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -21,18 +21,16 @@</span>
<a href="#l22.4"></a><span id="l22.4"> #include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l22.5"></a><span id="l22.5"> #include &quot;nsIMsgFolderNotificationService.h&quot;</span>
<a href="#l22.6"></a><span id="l22.6"> #include &quot;nsIMsgMailNewsUrl.h&quot;</span>
<a href="#l22.7"></a><span id="l22.7"> #include &quot;nsIMsgFilter.h&quot;</span>
<a href="#l22.8"></a><span id="l22.8"> #include &quot;nsIMsgFilterPlugin.h&quot;</span>
<a href="#l22.9"></a><span id="l22.9"> #include &quot;nsIMsgFilterHitNotify.h&quot;</span>
<a href="#l22.10"></a><span id="l22.10"> #include &quot;nsIIOService.h&quot;</span>
<a href="#l22.11"></a><span id="l22.11"> #include &quot;nsNetCID.h&quot;</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-#include &quot;nsRDFCID.h&quot;</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineminus">-#include &quot;nsIRDFService.h&quot;</span>
<a href="#l22.14"></a><span id="l22.14"> #include &quot;nsMsgI18N.h&quot;</span>
<a href="#l22.15"></a><span id="l22.15"> #include &quot;nsAppDirectoryServiceDefs.h&quot;</span>
<a href="#l22.16"></a><span id="l22.16"> #include &quot;nsIMsgLocalMailFolder.h&quot;</span>
<a href="#l22.17"></a><span id="l22.17"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l22.18"></a><span id="l22.18"> #include &quot;prprf.h&quot;</span>
<a href="#l22.19"></a><span id="l22.19"> #include &quot;prmem.h&quot;</span>
<a href="#l22.20"></a><span id="l22.20"> #include &quot;nsMsgSearchCore.h&quot;</span>
<a href="#l22.21"></a><span id="l22.21"> #include &quot;nsMailHeaders.h&quot;</span>
<a href="#l22.22"></a><span id="l22.22" class="difflineat">@@ -49,18 +47,16 @@</span>
<a href="#l22.23"></a><span id="l22.23"> #include &quot;nsIMsgFilterCustomAction.h&quot;</span>
<a href="#l22.24"></a><span id="l22.24"> #include &lt;ctype.h&gt;</span>
<a href="#l22.25"></a><span id="l22.25"> #include &quot;nsIMsgPluggableStore.h&quot;</span>
<a href="#l22.26"></a><span id="l22.26"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l22.27"></a><span id="l22.27"> #include &quot;nsQueryObject.h&quot;</span>
<a href="#l22.28"></a><span id="l22.28"> #include &quot;nsIOutputStream.h&quot;</span>
<a href="#l22.29"></a><span id="l22.29"> #include &quot;mozilla/Attributes.h&quot;</span>
<a href="#l22.30"></a><span id="l22.30"> </span>
<a href="#l22.31"></a><span id="l22.31" class="difflineminus">-static NS_DEFINE_CID(kRDFServiceCID, NS_RDFSERVICE_CID);</span>
<a href="#l22.32"></a><span id="l22.32" class="difflineminus">-</span>
<a href="#l22.33"></a><span id="l22.33"> /* the following macros actually implement addref, release and query interface for our component. */</span>
<a href="#l22.34"></a><span id="l22.34"> NS_IMPL_ISUPPORTS_INHERITED(nsMsgMailboxParser,</span>
<a href="#l22.35"></a><span id="l22.35">                              nsParseMailMessageState,</span>
<a href="#l22.36"></a><span id="l22.36">                              nsIStreamListener,</span>
<a href="#l22.37"></a><span id="l22.37">                              nsIRequestObserver)</span>
<a href="#l22.38"></a><span id="l22.38"> </span>
<a href="#l22.39"></a><span id="l22.39"> // Whenever data arrives from the connection, core netlib notifices the protocol by calling</span>
<a href="#l22.40"></a><span id="l22.40"> // OnDataAvailable. We then read and process the incoming data from the input stream.</span>
<a href="#l22.41"></a><span id="l22.41" class="difflineat">@@ -2018,27 +2014,20 @@ NS_IMETHODIMP nsParseNewMailState::Apply</span>
<a href="#l22.42"></a><span id="l22.42"> </span>
<a href="#l22.43"></a><span id="l22.43">         // FALLTHROUGH</span>
<a href="#l22.44"></a><span id="l22.44">         MOZ_FALLTHROUGH;</span>
<a href="#l22.45"></a><span id="l22.45">       case nsMsgFilterAction::MoveToFolder:</span>
<a href="#l22.46"></a><span id="l22.46">         // if moving to a different file, do it.</span>
<a href="#l22.47"></a><span id="l22.47">         if (actionTargetFolderUri.get() &amp;&amp; !m_inboxUri.Equals(actionTargetFolderUri,</span>
<a href="#l22.48"></a><span id="l22.48">                                                               nsCaseInsensitiveCStringComparator()))</span>
<a href="#l22.49"></a><span id="l22.49">         {</span>
<a href="#l22.50"></a><span id="l22.50" class="difflineminus">-          nsresult err;</span>
<a href="#l22.51"></a><span id="l22.51" class="difflineminus">-          nsCOMPtr&lt;nsIRDFService&gt; rdf(do_GetService(kRDFServiceCID, &amp;err));</span>
<a href="#l22.52"></a><span id="l22.52" class="difflineplus">+          nsCOMPtr&lt;nsIMsgFolder&gt; destIFolder;</span>
<a href="#l22.53"></a><span id="l22.53" class="difflineplus">+          nsresult err = GetOrCreateFolder(actionTargetFolderUri,</span>
<a href="#l22.54"></a><span id="l22.54" class="difflineplus">+            getter_AddRefs(destIFolder));</span>
<a href="#l22.55"></a><span id="l22.55">           NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l22.56"></a><span id="l22.56" class="difflineminus">-          nsCOMPtr&lt;nsIRDFResource&gt; res;</span>
<a href="#l22.57"></a><span id="l22.57" class="difflineminus">-          err = rdf-&gt;GetResource(actionTargetFolderUri, getter_AddRefs(res));</span>
<a href="#l22.58"></a><span id="l22.58" class="difflineminus">-          if (NS_FAILED(err))</span>
<a href="#l22.59"></a><span id="l22.59" class="difflineminus">-            return err;</span>
<a href="#l22.60"></a><span id="l22.60" class="difflineminus">-</span>
<a href="#l22.61"></a><span id="l22.61" class="difflineminus">-          nsCOMPtr&lt;nsIMsgFolder&gt; destIFolder(do_QueryInterface(res, &amp;err));</span>
<a href="#l22.62"></a><span id="l22.62" class="difflineminus">-          if (NS_FAILED(err))</span>
<a href="#l22.63"></a><span id="l22.63" class="difflineminus">-            return err;</span>
<a href="#l22.64"></a><span id="l22.64">           bool msgMoved = false;</span>
<a href="#l22.65"></a><span id="l22.65">           // If we're moving to an imap folder, or this message has already</span>
<a href="#l22.66"></a><span id="l22.66">           // has a pending copy action, use the imap coalescer so that</span>
<a href="#l22.67"></a><span id="l22.67">           // we won't truncate the inbox before the copy fires.</span>
<a href="#l22.68"></a><span id="l22.68">           if (m_msgCopiedByFilter ||</span>
<a href="#l22.69"></a><span id="l22.69">               StringBeginsWith(actionTargetFolderUri, NS_LITERAL_CSTRING(&quot;imap:&quot;)))</span>
<a href="#l22.70"></a><span id="l22.70">           {</span>
<a href="#l22.71"></a><span id="l22.71">             if (!m_moveCoalescer)</span>
<a href="#l22.72"></a><span id="l22.72" class="difflineat">@@ -2080,24 +2069,23 @@ NS_IMETHODIMP nsParseNewMailState::Apply</span>
<a href="#l22.73"></a><span id="l22.73">           {</span>
<a href="#l22.74"></a><span id="l22.74">             nsCOMPtr&lt;nsIMutableArray&gt; messageArray(do_CreateInstance(NS_ARRAY_CONTRACTID));</span>
<a href="#l22.75"></a><span id="l22.75">             messageArray-&gt;AppendElement(msgHdr);</span>
<a href="#l22.76"></a><span id="l22.76"> </span>
<a href="#l22.77"></a><span id="l22.77">             nsCOMPtr&lt;nsIMsgFolder&gt; dstFolder;</span>
<a href="#l22.78"></a><span id="l22.78">             nsCOMPtr&lt;nsIMsgCopyService&gt; copyService;</span>
<a href="#l22.79"></a><span id="l22.79">             rv = GetExistingFolder(actionTargetFolderUri,</span>
<a href="#l22.80"></a><span id="l22.80">                                    getter_AddRefs(dstFolder));</span>
<a href="#l22.81"></a><span id="l22.81" class="difflineminus">-            if (NS_SUCCEEDED(rv)) {</span>
<a href="#l22.82"></a><span id="l22.82" class="difflineminus">-              copyService = do_GetService(NS_MSGCOPYSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l22.83"></a><span id="l22.83" class="difflineminus">-            }</span>
<a href="#l22.84"></a><span id="l22.84" class="difflineminus">-            else {</span>
<a href="#l22.85"></a><span id="l22.85" class="difflineplus">+            if (NS_FAILED(rv)) {</span>
<a href="#l22.86"></a><span id="l22.86">               // Let's show a more specific warning.</span>
<a href="#l22.87"></a><span id="l22.87">               NS_WARNING(&quot;Target Folder does not exist.&quot;);</span>
<a href="#l22.88"></a><span id="l22.88">               return rv;</span>
<a href="#l22.89"></a><span id="l22.89">             }</span>
<a href="#l22.90"></a><span id="l22.90" class="difflineplus">+</span>
<a href="#l22.91"></a><span id="l22.91" class="difflineplus">+            copyService = do_GetService(NS_MSGCOPYSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l22.92"></a><span id="l22.92">             if (NS_SUCCEEDED(rv))</span>
<a href="#l22.93"></a><span id="l22.93">               rv = copyService-&gt;CopyMessages(m_downloadFolder, messageArray, dstFolder,</span>
<a href="#l22.94"></a><span id="l22.94">                                              false, nullptr, msgWindow, false);</span>
<a href="#l22.95"></a><span id="l22.95"> </span>
<a href="#l22.96"></a><span id="l22.96">             if (NS_FAILED(rv)) {</span>
<a href="#l22.97"></a><span id="l22.97">               // XXX: Invoke MSG_LOG_TO_CONSOLE once bug 1135265 lands.</span>
<a href="#l22.98"></a><span id="l22.98">               if (loggingEnabled)</span>
<a href="#l22.99"></a><span id="l22.99">                 (void) filter-&gt;LogRuleHitFail(filterAction, msgHdr, rv, &quot;Copy failed&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mailnews/local/src/nsPop3Service.cpp</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mailnews/local/src/nsPop3Service.cpp</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -13,18 +13,16 @@</span>
<a href="#l23.4"></a><span id="l23.4"> #include &quot;nsPop3Sink.h&quot;</span>
<a href="#l23.5"></a><span id="l23.5"> #include &quot;nsPop3Protocol.h&quot;</span>
<a href="#l23.6"></a><span id="l23.6"> #include &quot;nsMsgLocalCID.h&quot;</span>
<a href="#l23.7"></a><span id="l23.7"> #include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l23.8"></a><span id="l23.8"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l23.9"></a><span id="l23.9"> #include &quot;nsIMsgWindow.h&quot;</span>
<a href="#l23.10"></a><span id="l23.10"> #include &quot;nsINetUtil.h&quot;</span>
<a href="#l23.11"></a><span id="l23.11"> </span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-#include &quot;nsIRDFService.h&quot;</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineminus">-#include &quot;nsRDFCID.h&quot;</span>
<a href="#l23.14"></a><span id="l23.14"> #include &quot;nsMailDirServiceDefs.h&quot;</span>
<a href="#l23.15"></a><span id="l23.15"> #include &quot;prprf.h&quot;</span>
<a href="#l23.16"></a><span id="l23.16"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l23.17"></a><span id="l23.17"> #include &quot;nsIMsgAccountManager.h&quot;</span>
<a href="#l23.18"></a><span id="l23.18"> #include &quot;nsIMsgAccount.h&quot;</span>
<a href="#l23.19"></a><span id="l23.19"> #include &quot;nsLocalMailFolder.h&quot;</span>
<a href="#l23.20"></a><span id="l23.20"> #include &quot;nsIMailboxUrl.h&quot;</span>
<a href="#l23.21"></a><span id="l23.21"> #include &quot;nsIPrompt.h&quot;</span>
<a href="#l23.22"></a><span id="l23.22" class="difflineat">@@ -32,17 +30,16 @@</span>
<a href="#l23.23"></a><span id="l23.23"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l23.24"></a><span id="l23.24"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l23.25"></a><span id="l23.25"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l23.26"></a><span id="l23.26"> </span>
<a href="#l23.27"></a><span id="l23.27"> #define PREF_MAIL_ROOT_POP3 &quot;mail.root.pop3&quot;        // old - for backward compatibility only</span>
<a href="#l23.28"></a><span id="l23.28"> #define PREF_MAIL_ROOT_POP3_REL &quot;mail.root.pop3-rel&quot;</span>
<a href="#l23.29"></a><span id="l23.29"> </span>
<a href="#l23.30"></a><span id="l23.30"> static NS_DEFINE_CID(kPop3UrlCID, NS_POP3URL_CID);</span>
<a href="#l23.31"></a><span id="l23.31" class="difflineminus">-static NS_DEFINE_CID(kRDFServiceCID, NS_RDFSERVICE_CID);</span>
<a href="#l23.32"></a><span id="l23.32"> </span>
<a href="#l23.33"></a><span id="l23.33"> nsPop3Service::nsPop3Service()</span>
<a href="#l23.34"></a><span id="l23.34"> {</span>
<a href="#l23.35"></a><span id="l23.35"> }</span>
<a href="#l23.36"></a><span id="l23.36"> </span>
<a href="#l23.37"></a><span id="l23.37"> nsPop3Service::~nsPop3Service()</span>
<a href="#l23.38"></a><span id="l23.38"> {}</span>
<a href="#l23.39"></a><span id="l23.39"> </span>
<a href="#l23.40"></a><span id="l23.40" class="difflineat">@@ -311,33 +308,27 @@ NS_IMETHODIMP nsPop3Service::GetProtocol</span>
<a href="#l23.41"></a><span id="l23.41"> NS_IMETHODIMP nsPop3Service::NewURI(const nsACString &amp;aSpec,</span>
<a href="#l23.42"></a><span id="l23.42">                                     const char *aOriginCharset, // ignored</span>
<a href="#l23.43"></a><span id="l23.43">                                     nsIURI *aBaseURI,</span>
<a href="#l23.44"></a><span id="l23.44">                                     nsIURI **_retval)</span>
<a href="#l23.45"></a><span id="l23.45"> {</span>
<a href="#l23.46"></a><span id="l23.46">     NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l23.47"></a><span id="l23.47"> </span>
<a href="#l23.48"></a><span id="l23.48">     nsAutoCString folderUri(aSpec);</span>
<a href="#l23.49"></a><span id="l23.49" class="difflineminus">-    nsCOMPtr&lt;nsIRDFResource&gt; resource;</span>
<a href="#l23.50"></a><span id="l23.50">     int32_t offset = folderUri.FindChar('?');</span>
<a href="#l23.51"></a><span id="l23.51">     if (offset != kNotFound)</span>
<a href="#l23.52"></a><span id="l23.52">       folderUri.SetLength(offset);</span>
<a href="#l23.53"></a><span id="l23.53"> </span>
<a href="#l23.54"></a><span id="l23.54">     const char *uidl = PL_strstr(nsCString(aSpec).get(), &quot;uidl=&quot;);</span>
<a href="#l23.55"></a><span id="l23.55">     NS_ENSURE_TRUE(uidl, NS_ERROR_FAILURE);</span>
<a href="#l23.56"></a><span id="l23.56"> </span>
<a href="#l23.57"></a><span id="l23.57">     nsresult rv;</span>
<a href="#l23.58"></a><span id="l23.58"> </span>
<a href="#l23.59"></a><span id="l23.59" class="difflineminus">-    nsCOMPtr&lt;nsIRDFService&gt; rdfService(do_GetService(kRDFServiceCID, &amp;rv));</span>
<a href="#l23.60"></a><span id="l23.60" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.61"></a><span id="l23.61" class="difflineminus">-</span>
<a href="#l23.62"></a><span id="l23.62" class="difflineminus">-    rv = rdfService-&gt;GetResource(folderUri, getter_AddRefs(resource));</span>
<a href="#l23.63"></a><span id="l23.63" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.64"></a><span id="l23.64" class="difflineminus">-</span>
<a href="#l23.65"></a><span id="l23.65" class="difflineminus">-    nsCOMPtr&lt;nsIMsgFolder&gt; folder = do_QueryInterface(resource, &amp;rv);</span>
<a href="#l23.66"></a><span id="l23.66" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l23.67"></a><span id="l23.67" class="difflineplus">+    rv = GetOrCreateFolder(folderUri, getter_AddRefs(folder));</span>
<a href="#l23.68"></a><span id="l23.68">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.69"></a><span id="l23.69"> </span>
<a href="#l23.70"></a><span id="l23.70">     nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l23.71"></a><span id="l23.71"> </span>
<a href="#l23.72"></a><span id="l23.72">     nsLocalFolderScanState folderScanState;</span>
<a href="#l23.73"></a><span id="l23.73">     nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localFolder = do_QueryInterface(folder);</span>
<a href="#l23.74"></a><span id="l23.74">     nsCOMPtr&lt;nsIMailboxUrl&gt; mailboxUrl = do_QueryInterface(aBaseURI);</span>
<a href="#l23.75"></a><span id="l23.75"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mailnews/news/src/nsNewsFolder.cpp</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mailnews/news/src/nsNewsFolder.cpp</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -16,18 +16,16 @@</span>
<a href="#l24.4"></a><span id="l24.4"> #include &quot;prprf.h&quot;</span>
<a href="#l24.5"></a><span id="l24.5"> #include &quot;prsystem.h&quot;</span>
<a href="#l24.6"></a><span id="l24.6"> #include &quot;nsIArray.h&quot;</span>
<a href="#l24.7"></a><span id="l24.7"> #include &quot;nsTArray.h&quot;</span>
<a href="#l24.8"></a><span id="l24.8"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l24.9"></a><span id="l24.9"> #include &quot;nsINntpService.h&quot;</span>
<a href="#l24.10"></a><span id="l24.10"> #include &quot;nsIMsgFilterService.h&quot;</span>
<a href="#l24.11"></a><span id="l24.11"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-#include &quot;nsIRDFService.h&quot;</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineminus">-#include &quot;nsRDFCID.h&quot;</span>
<a href="#l24.14"></a><span id="l24.14"> #include &quot;nsMsgDBCID.h&quot;</span>
<a href="#l24.15"></a><span id="l24.15"> #include &quot;nsMsgNewsCID.h&quot;</span>
<a href="#l24.16"></a><span id="l24.16"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l24.17"></a><span id="l24.17"> #include &quot;nsNewsUtils.h&quot;</span>
<a href="#l24.18"></a><span id="l24.18"> </span>
<a href="#l24.19"></a><span id="l24.19"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l24.20"></a><span id="l24.20"> #include &quot;nsIMsgIncomingServer.h&quot;</span>
<a href="#l24.21"></a><span id="l24.21"> #include &quot;nsINntpIncomingServer.h&quot;</span>
<a href="#l24.22"></a><span id="l24.22" class="difflineat">@@ -56,22 +54,16 @@</span>
<a href="#l24.23"></a><span id="l24.23"> #include &quot;nsILoginManager.h&quot;</span>
<a href="#l24.24"></a><span id="l24.24"> #include &quot;nsEmbedCID.h&quot;</span>
<a href="#l24.25"></a><span id="l24.25"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l24.26"></a><span id="l24.26"> #include &quot;nsAutoPtr.h&quot;</span>
<a href="#l24.27"></a><span id="l24.27"> #include &quot;nsIInputStream.h&quot;</span>
<a href="#l24.28"></a><span id="l24.28"> #include &quot;nsMemory.h&quot;</span>
<a href="#l24.29"></a><span id="l24.29"> #include &quot;nsIURIMutator.h&quot;</span>
<a href="#l24.30"></a><span id="l24.30"> </span>
<a href="#l24.31"></a><span id="l24.31" class="difflineminus">-static NS_DEFINE_CID(kRDFServiceCID, NS_RDFSERVICE_CID);</span>
<a href="#l24.32"></a><span id="l24.32" class="difflineminus">-</span>
<a href="#l24.33"></a><span id="l24.33" class="difflineminus">-// ###tw  This really ought to be the most</span>
<a href="#l24.34"></a><span id="l24.34" class="difflineminus">-// efficient file reading size for the current</span>
<a href="#l24.35"></a><span id="l24.35" class="difflineminus">-// operating system.</span>
<a href="#l24.36"></a><span id="l24.36" class="difflineminus">-#define NEWSRC_FILE_BUFFER_SIZE 1024</span>
<a href="#l24.37"></a><span id="l24.37"> </span>
<a href="#l24.38"></a><span id="l24.38"> #define kNewsSortOffset 9000</span>
<a href="#l24.39"></a><span id="l24.39"> </span>
<a href="#l24.40"></a><span id="l24.40"> #define NEWS_SCHEME &quot;news:&quot;</span>
<a href="#l24.41"></a><span id="l24.41"> #define SNEWS_SCHEME &quot;snews:&quot;</span>
<a href="#l24.42"></a><span id="l24.42"> </span>
<a href="#l24.43"></a><span id="l24.43"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l24.44"></a><span id="l24.44"> </span>
<a href="#l24.45"></a><span id="l24.45" class="difflineat">@@ -136,18 +128,16 @@ nsMsgNewsFolder::CreateSubFolders(nsIFil</span>
<a href="#l24.46"></a><span id="l24.46"> }</span>
<a href="#l24.47"></a><span id="l24.47"> </span>
<a href="#l24.48"></a><span id="l24.48"> NS_IMETHODIMP</span>
<a href="#l24.49"></a><span id="l24.49"> nsMsgNewsFolder::AddNewsgroup(const nsACString &amp;name, const nsACString&amp; setStr,</span>
<a href="#l24.50"></a><span id="l24.50">                               nsIMsgFolder **child)</span>
<a href="#l24.51"></a><span id="l24.51"> {</span>
<a href="#l24.52"></a><span id="l24.52">   NS_ENSURE_ARG_POINTER(child);</span>
<a href="#l24.53"></a><span id="l24.53">   nsresult rv;</span>
<a href="#l24.54"></a><span id="l24.54" class="difflineminus">-  nsCOMPtr &lt;nsIRDFService&gt; rdf = do_GetService(kRDFServiceCID, &amp;rv);</span>
<a href="#l24.55"></a><span id="l24.55" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.56"></a><span id="l24.56"> </span>
<a href="#l24.57"></a><span id="l24.57">   nsCOMPtr &lt;nsINntpIncomingServer&gt; nntpServer;</span>
<a href="#l24.58"></a><span id="l24.58">   rv = GetNntpServer(getter_AddRefs(nntpServer));</span>
<a href="#l24.59"></a><span id="l24.59">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l24.60"></a><span id="l24.60"> </span>
<a href="#l24.61"></a><span id="l24.61">   nsAutoCString uri(mURI);</span>
<a href="#l24.62"></a><span id="l24.62">   uri.Append('/');</span>
<a href="#l24.63"></a><span id="l24.63">   // URI should use UTF-8</span>
<a href="#l24.64"></a><span id="l24.64" class="difflineat">@@ -160,25 +150,22 @@ nsMsgNewsFolder::AddNewsgroup(const nsAC</span>
<a href="#l24.65"></a><span id="l24.65">   rv = NS_MsgEscapeEncodeURLPath(nameUtf16, escapedName);</span>
<a href="#l24.66"></a><span id="l24.66">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l24.67"></a><span id="l24.67"> </span>
<a href="#l24.68"></a><span id="l24.68">   rv = nntpServer-&gt;AddNewsgroup(nameUtf16);</span>
<a href="#l24.69"></a><span id="l24.69">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l24.70"></a><span id="l24.70"> </span>
<a href="#l24.71"></a><span id="l24.71">   uri.Append(escapedName);</span>
<a href="#l24.72"></a><span id="l24.72"> </span>
<a href="#l24.73"></a><span id="l24.73" class="difflineminus">-  nsCOMPtr&lt;nsIRDFResource&gt; res;</span>
<a href="#l24.74"></a><span id="l24.74" class="difflineminus">-  rv = rdf-&gt;GetResource(uri, getter_AddRefs(res));</span>
<a href="#l24.75"></a><span id="l24.75" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l24.76"></a><span id="l24.76" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l24.77"></a><span id="l24.77" class="difflineplus">+  rv = GetOrCreateFolder(uri, getter_AddRefs(folder));</span>
<a href="#l24.78"></a><span id="l24.78" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.79"></a><span id="l24.79"> </span>
<a href="#l24.80"></a><span id="l24.80" class="difflineminus">-  nsCOMPtr&lt;nsIMsgFolder&gt; folder(do_QueryInterface(res, &amp;rv));</span>
<a href="#l24.81"></a><span id="l24.81" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l24.82"></a><span id="l24.82" class="difflineminus">-</span>
<a href="#l24.83"></a><span id="l24.83" class="difflineminus">-  nsCOMPtr&lt;nsIMsgNewsFolder&gt; newsFolder(do_QueryInterface(res, &amp;rv));</span>
<a href="#l24.84"></a><span id="l24.84" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l24.85"></a><span id="l24.85" class="difflineplus">+  nsCOMPtr&lt;nsIMsgNewsFolder&gt; newsFolder(do_QueryInterface(folder, &amp;rv));</span>
<a href="#l24.86"></a><span id="l24.86" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.87"></a><span id="l24.87"> </span>
<a href="#l24.88"></a><span id="l24.88">   // cache this for when we open the db</span>
<a href="#l24.89"></a><span id="l24.89">   rv = newsFolder-&gt;SetReadSetFromStr(setStr);</span>
<a href="#l24.90"></a><span id="l24.90"> </span>
<a href="#l24.91"></a><span id="l24.91">   rv = folder-&gt;SetParent(this);</span>
<a href="#l24.92"></a><span id="l24.92">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l24.93"></a><span id="l24.93"> </span>
<a href="#l24.94"></a><span id="l24.94">   // this what shows up in the UI</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:32Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

