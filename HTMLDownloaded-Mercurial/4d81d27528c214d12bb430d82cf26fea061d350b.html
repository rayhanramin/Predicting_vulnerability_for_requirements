<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 11683:4d81d27528c214d12bb430d82cf26fea061d350b</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 4d81d27528c214d12bb430d82cf26fea061d350b" />
<meta property="og:url" content="/comm-central/rev/4d81d27528c214d12bb430d82cf26fea061d350b" />
<meta property="og:description" content="Part of Bug 820377 - Deal with removing of EnumerateForwards/Backwards from nsISupportsArray - Replace mailnews accounts interface uses for nsISupportsArray with nsIArray. r=mconley,sr=Neil" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 4d81d27528c214d12bb430d82cf26fea061d350b 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/4d81d27528c214d12bb430d82cf26fea061d350b">shortlog</a> |
<a href="/comm-central/log/4d81d27528c214d12bb430d82cf26fea061d350b">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/4d81d27528c214d12bb430d82cf26fea061d350b">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/4d81d27528c214d12bb430d82cf26fea061d350b">files</a> |
changeset |
<a href="/comm-central/raw-rev/4d81d27528c214d12bb430d82cf26fea061d350b">raw</a>  | <a href="/comm-central/archive/4d81d27528c214d12bb430d82cf26fea061d350b.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
Part of <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=820377">Bug 820377</a> - Deal with removing of EnumerateForwards/Backwards from nsISupportsArray - Replace mailnews accounts interface uses for nsISupportsArray with nsIArray. r=mconley,sr=Neil
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#77;&#97;&#114;&#107;&#32;&#66;&#97;&#110;&#110;&#101;&#114;&#32;&#60;&#98;&#117;&#103;&#122;&#105;&#108;&#108;&#97;&#64;&#115;&#116;&#97;&#110;&#100;&#97;&#114;&#100;&#56;&#46;&#112;&#108;&#117;&#115;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 12 Dec 2012 23:42:26 +0000</td></tr>

<tr>
 <td>changeset 11683</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/4d81d27528c214d12bb430d82cf26fea061d350b">4d81d27528c214d12bb430d82cf26fea061d350b</a></td>
</tr>



<tr>
<td>parent 11682</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/2426db03c517e4e4168f601a24809ffcfdc8a5aa">2426db03c517e4e4168f601a24809ffcfdc8a5aa</a>
</td>
</tr>

<tr>
<td>child 11684</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/2a6deae6e55d0483f5cc67d261ec1b208c15ebb6">2a6deae6e55d0483f5cc67d261ec1b208c15ebb6</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=4d81d27528c214d12bb430d82cf26fea061d350b">8708</a></td></tr>
<tr><td>push user</td><td>bugzilla@standard8.plus.com</td></tr>
<tr><td>push date</td><td class="date age">Wed, 12 Dec 2012 23:44:35 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@2a6deae6e55d [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=2a6deae6e55d0483f5cc67d261ec1b208c15ebb6">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=2a6deae6e55d0483f5cc67d261ec1b208c15ebb6&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=2a6deae6e55d0483f5cc67d261ec1b208c15ebb6&newProject=comm-central&newRevision=4d81d27528c214d12bb430d82cf26fea061d350b&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=2a6deae6e55d0483f5cc67d261ec1b208c15ebb6&newProject=comm-central&newRevision=4d81d27528c214d12bb430d82cf26fea061d350b&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=2a6deae6e55d0483f5cc67d261ec1b208c15ebb6&newProject=comm-central&newRevision=4d81d27528c214d12bb430d82cf26fea061d350b&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mconley%29&revcount=50">mconley</a>, <a href="/comm-central/log?rev=reviewer%28Neil%29&revcount=50">Neil</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=820377">820377</a></td></tr>




</table></div>

<div class="page_body description">Part of <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=820377">Bug 820377</a> - Deal with removing of EnumerateForwards/Backwards from nsISupportsArray - Replace mailnews accounts interface uses for nsISupportsArray with nsIArray. r=mconley,sr=Neil</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4d81d27528c214d12bb430d82cf26fea061d350b/mail/base/content/mail3PaneWindowCommands.js">mail/base/content/mail3PaneWindowCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4d81d27528c214d12bb430d82cf26fea061d350b/mail/base/content/mail3PaneWindowCommands.js">file</a> |
<a href="/comm-central/annotate/4d81d27528c214d12bb430d82cf26fea061d350b/mail/base/content/mail3PaneWindowCommands.js">annotate</a> |
<a href="/comm-central/diff/4d81d27528c214d12bb430d82cf26fea061d350b/mail/base/content/mail3PaneWindowCommands.js">diff</a> |
<a href="/comm-central/comparison/4d81d27528c214d12bb430d82cf26fea061d350b/mail/base/content/mail3PaneWindowCommands.js">comparison</a> |
<a href="/comm-central/log/4d81d27528c214d12bb430d82cf26fea061d350b/mail/base/content/mail3PaneWindowCommands.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4d81d27528c214d12bb430d82cf26fea061d350b/mail/base/content/mailTabs.js">mail/base/content/mailTabs.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4d81d27528c214d12bb430d82cf26fea061d350b/mail/base/content/mailTabs.js">file</a> |
<a href="/comm-central/annotate/4d81d27528c214d12bb430d82cf26fea061d350b/mail/base/content/mailTabs.js">annotate</a> |
<a href="/comm-central/diff/4d81d27528c214d12bb430d82cf26fea061d350b/mail/base/content/mailTabs.js">diff</a> |
<a href="/comm-central/comparison/4d81d27528c214d12bb430d82cf26fea061d350b/mail/base/content/mailTabs.js">comparison</a> |
<a href="/comm-central/log/4d81d27528c214d12bb430d82cf26fea061d350b/mail/base/content/mailTabs.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4d81d27528c214d12bb430d82cf26fea061d350b/mail/base/modules/mailInstrumentation.js">mail/base/modules/mailInstrumentation.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4d81d27528c214d12bb430d82cf26fea061d350b/mail/base/modules/mailInstrumentation.js">file</a> |
<a href="/comm-central/annotate/4d81d27528c214d12bb430d82cf26fea061d350b/mail/base/modules/mailInstrumentation.js">annotate</a> |
<a href="/comm-central/diff/4d81d27528c214d12bb430d82cf26fea061d350b/mail/base/modules/mailInstrumentation.js">diff</a> |
<a href="/comm-central/comparison/4d81d27528c214d12bb430d82cf26fea061d350b/mail/base/modules/mailInstrumentation.js">comparison</a> |
<a href="/comm-central/log/4d81d27528c214d12bb430d82cf26fea061d350b/mail/base/modules/mailInstrumentation.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4d81d27528c214d12bb430d82cf26fea061d350b/mail/base/modules/mailMigrator.js">mail/base/modules/mailMigrator.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4d81d27528c214d12bb430d82cf26fea061d350b/mail/base/modules/mailMigrator.js">file</a> |
<a href="/comm-central/annotate/4d81d27528c214d12bb430d82cf26fea061d350b/mail/base/modules/mailMigrator.js">annotate</a> |
<a href="/comm-central/diff/4d81d27528c214d12bb430d82cf26fea061d350b/mail/base/modules/mailMigrator.js">diff</a> |
<a href="/comm-central/comparison/4d81d27528c214d12bb430d82cf26fea061d350b/mail/base/modules/mailMigrator.js">comparison</a> |
<a href="/comm-central/log/4d81d27528c214d12bb430d82cf26fea061d350b/mail/base/modules/mailMigrator.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4d81d27528c214d12bb430d82cf26fea061d350b/mail/extensions/smime/content/msgCompSMIMEOverlay.js">mail/extensions/smime/content/msgCompSMIMEOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4d81d27528c214d12bb430d82cf26fea061d350b/mail/extensions/smime/content/msgCompSMIMEOverlay.js">file</a> |
<a href="/comm-central/annotate/4d81d27528c214d12bb430d82cf26fea061d350b/mail/extensions/smime/content/msgCompSMIMEOverlay.js">annotate</a> |
<a href="/comm-central/diff/4d81d27528c214d12bb430d82cf26fea061d350b/mail/extensions/smime/content/msgCompSMIMEOverlay.js">diff</a> |
<a href="/comm-central/comparison/4d81d27528c214d12bb430d82cf26fea061d350b/mail/extensions/smime/content/msgCompSMIMEOverlay.js">comparison</a> |
<a href="/comm-central/log/4d81d27528c214d12bb430d82cf26fea061d350b/mail/extensions/smime/content/msgCompSMIMEOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4d81d27528c214d12bb430d82cf26fea061d350b/mail/test/mozmill/folder-display/test-folder-names-in-favorite-mode.js">mail/test/mozmill/folder-display/test-folder-names-in-favorite-mode.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4d81d27528c214d12bb430d82cf26fea061d350b/mail/test/mozmill/folder-display/test-folder-names-in-favorite-mode.js">file</a> |
<a href="/comm-central/annotate/4d81d27528c214d12bb430d82cf26fea061d350b/mail/test/mozmill/folder-display/test-folder-names-in-favorite-mode.js">annotate</a> |
<a href="/comm-central/diff/4d81d27528c214d12bb430d82cf26fea061d350b/mail/test/mozmill/folder-display/test-folder-names-in-favorite-mode.js">diff</a> |
<a href="/comm-central/comparison/4d81d27528c214d12bb430d82cf26fea061d350b/mail/test/mozmill/folder-display/test-folder-names-in-favorite-mode.js">comparison</a> |
<a href="/comm-central/log/4d81d27528c214d12bb430d82cf26fea061d350b/mail/test/mozmill/folder-display/test-folder-names-in-favorite-mode.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4d81d27528c214d12bb430d82cf26fea061d350b/mail/test/mozmill/multiple-identities/test-display-names.js">mail/test/mozmill/multiple-identities/test-display-names.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4d81d27528c214d12bb430d82cf26fea061d350b/mail/test/mozmill/multiple-identities/test-display-names.js">file</a> |
<a href="/comm-central/annotate/4d81d27528c214d12bb430d82cf26fea061d350b/mail/test/mozmill/multiple-identities/test-display-names.js">annotate</a> |
<a href="/comm-central/diff/4d81d27528c214d12bb430d82cf26fea061d350b/mail/test/mozmill/multiple-identities/test-display-names.js">diff</a> |
<a href="/comm-central/comparison/4d81d27528c214d12bb430d82cf26fea061d350b/mail/test/mozmill/multiple-identities/test-display-names.js">comparison</a> |
<a href="/comm-central/log/4d81d27528c214d12bb430d82cf26fea061d350b/mail/test/mozmill/multiple-identities/test-display-names.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/prefs/content/AccountWizard.js">mailnews/base/prefs/content/AccountWizard.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/prefs/content/AccountWizard.js">file</a> |
<a href="/comm-central/annotate/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/prefs/content/AccountWizard.js">annotate</a> |
<a href="/comm-central/diff/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/prefs/content/AccountWizard.js">diff</a> |
<a href="/comm-central/comparison/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/prefs/content/AccountWizard.js">comparison</a> |
<a href="/comm-central/log/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/prefs/content/AccountWizard.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/prefs/content/accountUtils.js">mailnews/base/prefs/content/accountUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/prefs/content/accountUtils.js">file</a> |
<a href="/comm-central/annotate/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/prefs/content/accountUtils.js">annotate</a> |
<a href="/comm-central/diff/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/prefs/content/accountUtils.js">diff</a> |
<a href="/comm-central/comparison/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/prefs/content/accountUtils.js">comparison</a> |
<a href="/comm-central/log/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/prefs/content/accountUtils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/prefs/content/accountcreation/fetchConfig.js">mailnews/base/prefs/content/accountcreation/fetchConfig.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/prefs/content/accountcreation/fetchConfig.js">file</a> |
<a href="/comm-central/annotate/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/prefs/content/accountcreation/fetchConfig.js">annotate</a> |
<a href="/comm-central/diff/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/prefs/content/accountcreation/fetchConfig.js">diff</a> |
<a href="/comm-central/comparison/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/prefs/content/accountcreation/fetchConfig.js">comparison</a> |
<a href="/comm-central/log/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/prefs/content/accountcreation/fetchConfig.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/public/nsIMsgAccountManager.idl">mailnews/base/public/nsIMsgAccountManager.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/public/nsIMsgAccountManager.idl">file</a> |
<a href="/comm-central/annotate/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/public/nsIMsgAccountManager.idl">annotate</a> |
<a href="/comm-central/diff/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/public/nsIMsgAccountManager.idl">diff</a> |
<a href="/comm-central/comparison/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/public/nsIMsgAccountManager.idl">comparison</a> |
<a href="/comm-central/log/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/public/nsIMsgAccountManager.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/src/nsMsgAccountManager.cpp">mailnews/base/src/nsMsgAccountManager.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/src/nsMsgAccountManager.cpp">file</a> |
<a href="/comm-central/annotate/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/src/nsMsgAccountManager.cpp">annotate</a> |
<a href="/comm-central/diff/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/src/nsMsgAccountManager.cpp">diff</a> |
<a href="/comm-central/comparison/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/src/nsMsgAccountManager.cpp">comparison</a> |
<a href="/comm-central/log/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/src/nsMsgAccountManager.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/src/nsMsgAccountManager.h">mailnews/base/src/nsMsgAccountManager.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/src/nsMsgAccountManager.h">file</a> |
<a href="/comm-central/annotate/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/src/nsMsgAccountManager.h">annotate</a> |
<a href="/comm-central/diff/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/src/nsMsgAccountManager.h">diff</a> |
<a href="/comm-central/comparison/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/src/nsMsgAccountManager.h">comparison</a> |
<a href="/comm-central/log/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/src/nsMsgAccountManager.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/src/nsSpamSettings.cpp">mailnews/base/src/nsSpamSettings.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/src/nsSpamSettings.cpp">file</a> |
<a href="/comm-central/annotate/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/src/nsSpamSettings.cpp">annotate</a> |
<a href="/comm-central/diff/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/src/nsSpamSettings.cpp">diff</a> |
<a href="/comm-central/comparison/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/src/nsSpamSettings.cpp">comparison</a> |
<a href="/comm-central/log/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/src/nsSpamSettings.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/test/unit/test_accountMgr.js">mailnews/base/test/unit/test_accountMgr.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/test/unit/test_accountMgr.js">file</a> |
<a href="/comm-central/annotate/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/test/unit/test_accountMgr.js">annotate</a> |
<a href="/comm-central/diff/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/test/unit/test_accountMgr.js">diff</a> |
<a href="/comm-central/comparison/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/test/unit/test_accountMgr.js">comparison</a> |
<a href="/comm-central/log/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/test/unit/test_accountMgr.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/test/unit/test_accountMgrCustomTypes.js">mailnews/base/test/unit/test_accountMgrCustomTypes.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/test/unit/test_accountMgrCustomTypes.js">file</a> |
<a href="/comm-central/annotate/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/test/unit/test_accountMgrCustomTypes.js">annotate</a> |
<a href="/comm-central/diff/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/test/unit/test_accountMgrCustomTypes.js">diff</a> |
<a href="/comm-central/comparison/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/test/unit/test_accountMgrCustomTypes.js">comparison</a> |
<a href="/comm-central/log/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/test/unit/test_accountMgrCustomTypes.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/test/unit/test_acctRepair.js">mailnews/base/test/unit/test_acctRepair.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/test/unit/test_acctRepair.js">file</a> |
<a href="/comm-central/annotate/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/test/unit/test_acctRepair.js">annotate</a> |
<a href="/comm-central/diff/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/test/unit/test_acctRepair.js">diff</a> |
<a href="/comm-central/comparison/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/test/unit/test_acctRepair.js">comparison</a> |
<a href="/comm-central/log/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/test/unit/test_acctRepair.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/test/unit/test_fix_deferred_accounts.js">mailnews/base/test/unit/test_fix_deferred_accounts.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/test/unit/test_fix_deferred_accounts.js">file</a> |
<a href="/comm-central/annotate/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/test/unit/test_fix_deferred_accounts.js">annotate</a> |
<a href="/comm-central/diff/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/test/unit/test_fix_deferred_accounts.js">diff</a> |
<a href="/comm-central/comparison/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/test/unit/test_fix_deferred_accounts.js">comparison</a> |
<a href="/comm-central/log/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/test/unit/test_fix_deferred_accounts.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/test/unit/test_nsIMsgFolder.js">mailnews/base/test/unit/test_nsIMsgFolder.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/test/unit/test_nsIMsgFolder.js">file</a> |
<a href="/comm-central/annotate/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/test/unit/test_nsIMsgFolder.js">annotate</a> |
<a href="/comm-central/diff/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/test/unit/test_nsIMsgFolder.js">diff</a> |
<a href="/comm-central/comparison/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/test/unit/test_nsIMsgFolder.js">comparison</a> |
<a href="/comm-central/log/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/test/unit/test_nsIMsgFolder.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/util/nsMsgIdentity.cpp">mailnews/base/util/nsMsgIdentity.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/util/nsMsgIdentity.cpp">file</a> |
<a href="/comm-central/annotate/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/util/nsMsgIdentity.cpp">annotate</a> |
<a href="/comm-central/diff/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/util/nsMsgIdentity.cpp">diff</a> |
<a href="/comm-central/comparison/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/util/nsMsgIdentity.cpp">comparison</a> |
<a href="/comm-central/log/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/base/util/nsMsgIdentity.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/compose/src/nsMsgCopy.cpp">mailnews/compose/src/nsMsgCopy.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/compose/src/nsMsgCopy.cpp">file</a> |
<a href="/comm-central/annotate/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/compose/src/nsMsgCopy.cpp">annotate</a> |
<a href="/comm-central/diff/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/compose/src/nsMsgCopy.cpp">diff</a> |
<a href="/comm-central/comparison/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/compose/src/nsMsgCopy.cpp">comparison</a> |
<a href="/comm-central/log/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/compose/src/nsMsgCopy.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/compose/src/nsMsgSendLater.cpp">mailnews/compose/src/nsMsgSendLater.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/compose/src/nsMsgSendLater.cpp">file</a> |
<a href="/comm-central/annotate/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/compose/src/nsMsgSendLater.cpp">annotate</a> |
<a href="/comm-central/diff/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/compose/src/nsMsgSendLater.cpp">diff</a> |
<a href="/comm-central/comparison/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/compose/src/nsMsgSendLater.cpp">comparison</a> |
<a href="/comm-central/log/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/compose/src/nsMsgSendLater.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/imap/src/nsAutoSyncManager.cpp">mailnews/imap/src/nsAutoSyncManager.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/imap/src/nsAutoSyncManager.cpp">file</a> |
<a href="/comm-central/annotate/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/imap/src/nsAutoSyncManager.cpp">annotate</a> |
<a href="/comm-central/diff/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/imap/src/nsAutoSyncManager.cpp">diff</a> |
<a href="/comm-central/comparison/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/imap/src/nsAutoSyncManager.cpp">comparison</a> |
<a href="/comm-central/log/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/imap/src/nsAutoSyncManager.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/import/test/unit/resources/import_helper.js">mailnews/import/test/unit/resources/import_helper.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/import/test/unit/resources/import_helper.js">file</a> |
<a href="/comm-central/annotate/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/import/test/unit/resources/import_helper.js">annotate</a> |
<a href="/comm-central/diff/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/import/test/unit/resources/import_helper.js">diff</a> |
<a href="/comm-central/comparison/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/import/test/unit/resources/import_helper.js">comparison</a> |
<a href="/comm-central/log/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/import/test/unit/resources/import_helper.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/local/test/unit/test_nsIMsgLocalMailFolder.js">mailnews/local/test/unit/test_nsIMsgLocalMailFolder.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/local/test/unit/test_nsIMsgLocalMailFolder.js">file</a> |
<a href="/comm-central/annotate/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/local/test/unit/test_nsIMsgLocalMailFolder.js">annotate</a> |
<a href="/comm-central/diff/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/local/test/unit/test_nsIMsgLocalMailFolder.js">diff</a> |
<a href="/comm-central/comparison/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/local/test/unit/test_nsIMsgLocalMailFolder.js">comparison</a> |
<a href="/comm-central/log/4d81d27528c214d12bb430d82cf26fea061d350b/mailnews/local/test/unit/test_nsIMsgLocalMailFolder.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4d81d27528c214d12bb430d82cf26fea061d350b/suite/mailnews/tabmail.js">suite/mailnews/tabmail.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4d81d27528c214d12bb430d82cf26fea061d350b/suite/mailnews/tabmail.js">file</a> |
<a href="/comm-central/annotate/4d81d27528c214d12bb430d82cf26fea061d350b/suite/mailnews/tabmail.js">annotate</a> |
<a href="/comm-central/diff/4d81d27528c214d12bb430d82cf26fea061d350b/suite/mailnews/tabmail.js">diff</a> |
<a href="/comm-central/comparison/4d81d27528c214d12bb430d82cf26fea061d350b/suite/mailnews/tabmail.js">comparison</a> |
<a href="/comm-central/log/4d81d27528c214d12bb430d82cf26fea061d350b/suite/mailnews/tabmail.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/base/content/mail3PaneWindowCommands.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/base/content/mail3PaneWindowCommands.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -378,19 +378,17 @@ var DefaultController =</span>
<a href="#l1.4"></a><span id="l1.4">       case &quot;cmd_recalculateJunkScore&quot;:</span>
<a href="#l1.5"></a><span id="l1.5">         // We're going to take a conservative position here, because we really</span>
<a href="#l1.6"></a><span id="l1.6">         // don't want people running junk controls on folders that are not</span>
<a href="#l1.7"></a><span id="l1.7">         // enabled for junk. The junk type picks up possible dummy message headers,</span>
<a href="#l1.8"></a><span id="l1.8">         // while the runJunkControls will prevent running on XF virtual folders.</span>
<a href="#l1.9"></a><span id="l1.9">         return gFolderDisplay.getCommandStatus(nsMsgViewCommandType.junk) &amp;&amp;</span>
<a href="#l1.10"></a><span id="l1.10">                gFolderDisplay.getCommandStatus(nsMsgViewCommandType.runJunkControls);</span>
<a href="#l1.11"></a><span id="l1.11">       case &quot;cmd_displayMsgFilters&quot;:</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-        let mgr = Components.classes[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-                            .getService(Components.interfaces.nsIMsgAccountManager);</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-        return mgr.accounts.Count() &gt; 0;</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+        return MailServices.accounts.accounts.length &gt; 0;</span>
<a href="#l1.16"></a><span id="l1.16">       case &quot;cmd_applyFilters&quot;:</span>
<a href="#l1.17"></a><span id="l1.17">         return gFolderDisplay.getCommandStatus(nsMsgViewCommandType.applyFilters);</span>
<a href="#l1.18"></a><span id="l1.18">       case &quot;cmd_runJunkControls&quot;:</span>
<a href="#l1.19"></a><span id="l1.19">         return gFolderDisplay.getCommandStatus(nsMsgViewCommandType.runJunkControls);</span>
<a href="#l1.20"></a><span id="l1.20">       case &quot;cmd_deleteJunk&quot;:</span>
<a href="#l1.21"></a><span id="l1.21">         return gFolderDisplay.getCommandStatus(nsMsgViewCommandType.deleteJunk);</span>
<a href="#l1.22"></a><span id="l1.22">       case &quot;button_mark&quot;:</span>
<a href="#l1.23"></a><span id="l1.23">       case &quot;cmd_tag&quot;:</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineat">@@ -447,17 +445,17 @@ var DefaultController =</span>
<a href="#l1.25"></a><span id="l1.25">         // always allow searching in the message</span>
<a href="#l1.26"></a><span id="l1.26">         if (document.getElementById(&quot;tabmail&quot;).selectedTab.mode.name == &quot;message&quot;)</span>
<a href="#l1.27"></a><span id="l1.27">           return true;</span>
<a href="#l1.28"></a><span id="l1.28"> </span>
<a href="#l1.29"></a><span id="l1.29">         // Otherwise, only allow searching if we're showing the message pane</span>
<a href="#l1.30"></a><span id="l1.30">         // and have more than one message selected.</span>
<a href="#l1.31"></a><span id="l1.31">         return (!IsMessagePaneCollapsed() &amp;&amp; (GetNumSelectedMessages() == 1));</span>
<a href="#l1.32"></a><span id="l1.32">       case &quot;cmd_search&quot;:</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineminus">-        return (MailServices.accounts.accounts.Count() &gt; 0);</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+        return MailServices.accounts.accounts.length &gt; 0;</span>
<a href="#l1.35"></a><span id="l1.35">       case &quot;cmd_selectAll&quot;:</span>
<a href="#l1.36"></a><span id="l1.36">       case &quot;cmd_selectFlagged&quot;:</span>
<a href="#l1.37"></a><span id="l1.37">         return !!gDBView;</span>
<a href="#l1.38"></a><span id="l1.38">       // these are enabled on when we are in threaded mode</span>
<a href="#l1.39"></a><span id="l1.39">       case &quot;cmd_selectThread&quot;:</span>
<a href="#l1.40"></a><span id="l1.40">         if (GetNumSelectedMessages() &lt;= 0) return false;</span>
<a href="#l1.41"></a><span id="l1.41">       case &quot;cmd_expandAllThreads&quot;:</span>
<a href="#l1.42"></a><span id="l1.42">       case &quot;cmd_collapseAllThreads&quot;:</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/base/content/mailTabs.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/base/content/mailTabs.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -441,19 +441,17 @@ let mailTabType = {</span>
<a href="#l2.4"></a><span id="l2.4">         return gMessageDisplay.singleMessageDisplay ?</span>
<a href="#l2.5"></a><span id="l2.5">                document.getElementById(&quot;messagepane&quot;) :</span>
<a href="#l2.6"></a><span id="l2.6">                document.getElementById(&quot;multimessage&quot;);</span>
<a href="#l2.7"></a><span id="l2.7">       }</span>
<a href="#l2.8"></a><span id="l2.8">     },</span>
<a href="#l2.9"></a><span id="l2.9">   },</span>
<a href="#l2.10"></a><span id="l2.10"> </span>
<a href="#l2.11"></a><span id="l2.11">   _getNumberOfRealAccounts : function() {</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-    let mgr = Components.classes[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-                        .getService(Components.interfaces.nsIMsgAccountManager);</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-    let accountCount = mgr.accounts.Count();</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+    let accountCount = MailServices.accounts.accounts.length;</span>
<a href="#l2.16"></a><span id="l2.16">     // If we have an account, we also always have a &quot;Local Folders&quot; account.</span>
<a href="#l2.17"></a><span id="l2.17">     return accountCount &gt; 0 ? (accountCount - 1) : 0;</span>
<a href="#l2.18"></a><span id="l2.18">   },</span>
<a href="#l2.19"></a><span id="l2.19"> </span>
<a href="#l2.20"></a><span id="l2.20">   /**</span>
<a href="#l2.21"></a><span id="l2.21">    * Common tab opening code shared by the various tab modes.</span>
<a href="#l2.22"></a><span id="l2.22">    */</span>
<a href="#l2.23"></a><span id="l2.23">   openTab: function(aTab, aIsFirstTab, aMessageDisplay, aFolderPaneVisible) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/base/modules/mailInstrumentation.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/base/modules/mailInstrumentation.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -183,17 +183,17 @@ var mailInstrumentationManager =</span>
<a href="#l3.4"></a><span id="l3.4">   /**</span>
<a href="#l3.5"></a><span id="l3.5">    * This is called to initialize the instrumentation.</span>
<a href="#l3.6"></a><span id="l3.6">    */</span>
<a href="#l3.7"></a><span id="l3.7">   init: function minst_init() {</span>
<a href="#l3.8"></a><span id="l3.8">     // If we're done with instrumentation, or this is not a first run,</span>
<a href="#l3.9"></a><span id="l3.9">     // we should just return immediately.</span>
<a href="#l3.10"></a><span id="l3.10">     if (!Services.prefs.getBoolPref(&quot;mail.instrumentation.askUser&quot;))</span>
<a href="#l3.11"></a><span id="l3.11">       return;</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-    if (MailServices.accounts.accounts.Count() &gt; 0)</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+    if (MailServices.accounts.accounts.length &gt; 0)</span>
<a href="#l3.14"></a><span id="l3.14">       return;</span>
<a href="#l3.15"></a><span id="l3.15"> </span>
<a href="#l3.16"></a><span id="l3.16">     this._loadState();</span>
<a href="#l3.17"></a><span id="l3.17">     Services.obs.addObserver(this, &quot;mail:composeSendSucceeded&quot;, false);</span>
<a href="#l3.18"></a><span id="l3.18">     Services.obs.addObserver(this, &quot;mail:setAsDefault&quot;, false);</span>
<a href="#l3.19"></a><span id="l3.19">     Services.prefs.addObserver(&quot;mail.accountmanager.accounts&quot;,</span>
<a href="#l3.20"></a><span id="l3.20">                                this._accountsChanged, false);</span>
<a href="#l3.21"></a><span id="l3.21">     Services.prefs.addObserver(&quot;mail.instrumentation.userOptedIn&quot;,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/base/modules/mailMigrator.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/base/modules/mailMigrator.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -257,17 +257,17 @@ var MailMigrator = {</span>
<a href="#l4.4"></a><span id="l4.4">             }</span>
<a href="#l4.5"></a><span id="l4.5">           }</span>
<a href="#l4.6"></a><span id="l4.6">         }.bind(this);</span>
<a href="#l4.7"></a><span id="l4.7"> </span>
<a href="#l4.8"></a><span id="l4.8">         addButtonToEnd(&quot;mail-bar3&quot;, &quot;button-appmenu&quot;);</span>
<a href="#l4.9"></a><span id="l4.9">         addButtonToEnd(&quot;chat-toobar&quot;, &quot;button-chat-appmenu&quot;);</span>
<a href="#l4.10"></a><span id="l4.10"> </span>
<a href="#l4.11"></a><span id="l4.11">         if (Services.prefs.getBoolPref(&quot;mail.main_menu.collapse_by_default&quot;)</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-            &amp;&amp; MailServices.accounts.accounts.Count() == 0) {</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+            &amp;&amp; MailServices.accounts.accounts.length == 0) {</span>
<a href="#l4.14"></a><span id="l4.14">           let menuResource = this._rdf.GetResource(MESSENGER_DOCURL +</span>
<a href="#l4.15"></a><span id="l4.15">                                                    &quot;mail-toolbar-menubar2&quot;);</span>
<a href="#l4.16"></a><span id="l4.16">           if (menuResource !== null) {</span>
<a href="#l4.17"></a><span id="l4.17">             let autohideResource = this._rdf.GetResource(&quot;autohide&quot;);</span>
<a href="#l4.18"></a><span id="l4.18">             dirty = true;</span>
<a href="#l4.19"></a><span id="l4.19">             this._setPersist(menuResource, autohideResource, &quot;true&quot;);</span>
<a href="#l4.20"></a><span id="l4.20">           }</span>
<a href="#l4.21"></a><span id="l4.21">         }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/extensions/smime/content/msgCompSMIMEOverlay.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/extensions/smime/content/msgCompSMIMEOverlay.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -103,18 +103,18 @@ function smimeComposeOnUnload()</span>
<a href="#l5.4"></a><span id="l5.4"> // stub routine to make our call to MsgAccountManager work correctly</span>
<a href="#l5.5"></a><span id="l5.5"> function GetSelectedFolderURI()</span>
<a href="#l5.6"></a><span id="l5.6"> {</span>
<a href="#l5.7"></a><span id="l5.7">   return;</span>
<a href="#l5.8"></a><span id="l5.8"> }</span>
<a href="#l5.9"></a><span id="l5.9"> </span>
<a href="#l5.10"></a><span id="l5.10"> function GetServer(uri)</span>
<a href="#l5.11"></a><span id="l5.11"> {</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-  var servers = gAccountManager.GetServersForIdentity(gCurrentIdentity);</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-  return servers.QueryElementAt(0, Components.interfaces.nsIMsgIncomingServer);</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+  let servers = gAccountManager.getServersForIdentity(gCurrentIdentity);</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+  return servers.queryElementAt(0, Components.interfaces.nsIMsgIncomingServer);</span>
<a href="#l5.16"></a><span id="l5.16"> }</span>
<a href="#l5.17"></a><span id="l5.17"> </span>
<a href="#l5.18"></a><span id="l5.18"> function showNeedSetupInfo()</span>
<a href="#l5.19"></a><span id="l5.19"> {</span>
<a href="#l5.20"></a><span id="l5.20">   let compSmimeBundle = document.getElementById(&quot;bundle_comp_smime&quot;);</span>
<a href="#l5.21"></a><span id="l5.21">   let brandBundle = document.getElementById(&quot;bundle_brand&quot;);</span>
<a href="#l5.22"></a><span id="l5.22">   if (!compSmimeBundle || !brandBundle)</span>
<a href="#l5.23"></a><span id="l5.23">     return;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-folder-names-in-favorite-mode.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-folder-names-in-favorite-mode.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -3,18 +3,18 @@ var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l6.4"></a><span id="l6.4"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;];</span>
<a href="#l6.5"></a><span id="l6.5"> </span>
<a href="#l6.6"></a><span id="l6.6"> function setupModule(module) {</span>
<a href="#l6.7"></a><span id="l6.7">   let fdh = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l6.8"></a><span id="l6.8">   fdh.installInto(module);</span>
<a href="#l6.9"></a><span id="l6.9"> };</span>
<a href="#l6.10"></a><span id="l6.10"> </span>
<a href="#l6.11"></a><span id="l6.11"> function test_folder_names_in_favorite_pane_view_mode() {</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-  let acc1 = MailServices.accounts.accounts.QueryElementAt(0, Ci.nsIMsgAccount);</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-  let acc2 = MailServices.accounts.accounts.QueryElementAt(1, Ci.nsIMsgAccount);</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+  let acc1 = MailServices.accounts.accounts.queryElementAt(0, Ci.nsIMsgAccount);</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+  let acc2 = MailServices.accounts.accounts.queryElementAt(1, Ci.nsIMsgAccount);</span>
<a href="#l6.16"></a><span id="l6.16">   let rootFolder1 = acc1.incomingServer.rootFolder;</span>
<a href="#l6.17"></a><span id="l6.17">   let rootFolder2 = acc2.incomingServer.rootFolder;</span>
<a href="#l6.18"></a><span id="l6.18"> </span>
<a href="#l6.19"></a><span id="l6.19">   rootFolder1.createSubfolder(&quot;uniqueName&quot;, null);</span>
<a href="#l6.20"></a><span id="l6.20">   rootFolder1.createSubfolder(&quot;duplicatedName&quot;, null);</span>
<a href="#l6.21"></a><span id="l6.21">   rootFolder2.createSubfolder(&quot;duplicatedName&quot;, null);</span>
<a href="#l6.22"></a><span id="l6.22">   rootFolder2.getFolderWithFlags(Ci.nsMsgFolderFlags.Inbox).createSubfolder(&quot;duplicatedName&quot;, null);</span>
<a href="#l6.23"></a><span id="l6.23"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mail/test/mozmill/multiple-identities/test-display-names.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mail/test/mozmill/multiple-identities/test-display-names.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -29,18 +29,18 @@ function setupModule(module) {</span>
<a href="#l7.4"></a><span id="l7.4">   abh.installInto(module);</span>
<a href="#l7.5"></a><span id="l7.5"> </span>
<a href="#l7.6"></a><span id="l7.6">   acctMgr = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l7.7"></a><span id="l7.7">               .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l7.8"></a><span id="l7.8">   localAccount = acctMgr.FindAccountForServer(acctMgr.localFoldersServer);</span>
<a href="#l7.9"></a><span id="l7.9"> </span>
<a href="#l7.10"></a><span id="l7.10">   // We need to make sure we have only one identity:</span>
<a href="#l7.11"></a><span id="l7.11">   // 1) Delete all accounts except for Local Folders</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-  for (let i = acctMgr.accounts.Count()-1; i &gt;= 0; i--) {</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-    let account = acctMgr.accounts.QueryElementAt(i, Ci.nsIMsgAccount);</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+  for (let i = acctMgr.accounts.length - 1; i &gt;= 0; i--) {</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+    let account = acctMgr.accounts.queryElementAt(i, Ci.nsIMsgAccount);</span>
<a href="#l7.16"></a><span id="l7.16">     if (account != localAccount)</span>
<a href="#l7.17"></a><span id="l7.17">       acctMgr.removeAccount(account);</span>
<a href="#l7.18"></a><span id="l7.18">   }</span>
<a href="#l7.19"></a><span id="l7.19"> </span>
<a href="#l7.20"></a><span id="l7.20">   // 2) Delete all identities except for one</span>
<a href="#l7.21"></a><span id="l7.21">   for (let i = localAccount.identities.length - 1; i &gt;= 0; i--) {</span>
<a href="#l7.22"></a><span id="l7.22">     let identity = localAccount.identities.queryElementAt(i, Ci.nsIMsgIdentity);</span>
<a href="#l7.23"></a><span id="l7.23">     if (identity.email != myEmail)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/base/prefs/content/AccountWizard.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/base/prefs/content/AccountWizard.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -45,17 +45,17 @@ var contentWindow;</span>
<a href="#l8.4"></a><span id="l8.4"> var gPageData;</span>
<a href="#l8.5"></a><span id="l8.5"> var smtpService = Components.classes[&quot;@mozilla.org/messengercompose/smtp;1&quot;].getService(Components.interfaces.nsISmtpService);</span>
<a href="#l8.6"></a><span id="l8.6"> var am = Components.classes[&quot;@mozilla.org/messenger/account-manager;1&quot;].getService(Components.interfaces.nsIMsgAccountManager);</span>
<a href="#l8.7"></a><span id="l8.7"> var gPrefs = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;].getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l8.8"></a><span id="l8.8"> var gMailSession = Components.classes[&quot;@mozilla.org/messenger/services/session;1&quot;].getService(Components.interfaces.nsIMsgMailSession);</span>
<a href="#l8.9"></a><span id="l8.9"> var accounts = am.accounts;</span>
<a href="#l8.10"></a><span id="l8.10"> </span>
<a href="#l8.11"></a><span id="l8.11"> //accountCount indicates presence or absense of accounts</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-var accountCount = accounts.Count();</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+var accountCount = accounts.length;</span>
<a href="#l8.14"></a><span id="l8.14"> </span>
<a href="#l8.15"></a><span id="l8.15"> var nsIMsgIdentity = Components.interfaces.nsIMsgIdentity;</span>
<a href="#l8.16"></a><span id="l8.16"> var nsIMsgIncomingServer = Components.interfaces.nsIMsgIncomingServer;</span>
<a href="#l8.17"></a><span id="l8.17"> var gPrefsBundle, gMessengerBundle;</span>
<a href="#l8.18"></a><span id="l8.18"> var promptService = Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;].getService();</span>
<a href="#l8.19"></a><span id="l8.19"> promptService = promptService.QueryInterface(Components.interfaces.nsIPromptService);</span>
<a href="#l8.20"></a><span id="l8.20"> </span>
<a href="#l8.21"></a><span id="l8.21"> // the current nsIMsgAccount</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/base/prefs/content/accountUtils.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/base/prefs/content/accountUtils.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -8,21 +8,21 @@ Components.utils.import(&quot;resource:///mod</span>
<a href="#l9.4"></a><span id="l9.4"> </span>
<a href="#l9.5"></a><span id="l9.5"> var gAnyValidIdentity = false; //If there are no valid identities for any account</span>
<a href="#l9.6"></a><span id="l9.6"> // returns the first account with an invalid server or identity</span>
<a href="#l9.7"></a><span id="l9.7"> </span>
<a href="#l9.8"></a><span id="l9.8"> var gNewAccountToLoad = null;   // used to load new messages if we come from the mail3pane</span>
<a href="#l9.9"></a><span id="l9.9"> </span>
<a href="#l9.10"></a><span id="l9.10"> function getInvalidAccounts(accounts)</span>
<a href="#l9.11"></a><span id="l9.11"> {</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-    var numAccounts = accounts.Count();</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-    var invalidAccounts = new Array;</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineminus">-    var numIdentities = 0;</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineminus">-    for (var i=0; i&lt;numAccounts; i++) {</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineminus">-        var account = accounts.QueryElementAt(i, Components.interfaces.nsIMsgAccount);</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+    let numAccounts = accounts.length;</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+    let invalidAccounts = new Array;</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineplus">+    let numIdentities = 0;</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineplus">+    for (let i = 0; i &lt; numAccounts; i++) {</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineplus">+        let account = accounts.queryElementAt(i, Components.interfaces.nsIMsgAccount);</span>
<a href="#l9.22"></a><span id="l9.22">         try {</span>
<a href="#l9.23"></a><span id="l9.23">             if (!account.incomingServer.valid) {</span>
<a href="#l9.24"></a><span id="l9.24">                 invalidAccounts[invalidAccounts.length] = account;</span>
<a href="#l9.25"></a><span id="l9.25">                 // skip to the next account</span>
<a href="#l9.26"></a><span id="l9.26">                 continue;</span>
<a href="#l9.27"></a><span id="l9.27">             }</span>
<a href="#l9.28"></a><span id="l9.28">         } catch (ex) {</span>
<a href="#l9.29"></a><span id="l9.29">             // this account is busted, just keep going</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineat">@@ -88,17 +88,17 @@ function verifyAccounts(wizardCallback, </span>
<a href="#l9.31"></a><span id="l9.31">         // migrate quoting preferences from global to per account. This function returns</span>
<a href="#l9.32"></a><span id="l9.32">         // true if it had to migrate, which we will use to mean this is a just migrated</span>
<a href="#l9.33"></a><span id="l9.33">         // or new profile</span>
<a href="#l9.34"></a><span id="l9.34">         var newProfile = migrateGlobalQuotingPrefs(MailServices.accounts.allIdentities);</span>
<a href="#l9.35"></a><span id="l9.35"> </span>
<a href="#l9.36"></a><span id="l9.36">         var accounts = MailServices.accounts.accounts;</span>
<a href="#l9.37"></a><span id="l9.37"> </span>
<a href="#l9.38"></a><span id="l9.38">         // as long as we have some accounts, we're fine.</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineminus">-        var accountCount = accounts.Count();</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineplus">+        var accountCount = accounts.length;</span>
<a href="#l9.41"></a><span id="l9.41">         var invalidAccounts = getInvalidAccounts(accounts);</span>
<a href="#l9.42"></a><span id="l9.42">         if (invalidAccounts.length &gt; 0 &amp;&amp; invalidAccounts.length == accountCount) {</span>
<a href="#l9.43"></a><span id="l9.43">             prefillAccount = invalidAccounts[0];</span>
<a href="#l9.44"></a><span id="l9.44">         }</span>
<a href="#l9.45"></a><span id="l9.45"> </span>
<a href="#l9.46"></a><span id="l9.46">         // if there are no accounts, or all accounts are &quot;invalid&quot;</span>
<a href="#l9.47"></a><span id="l9.47">         // then kick off the account migration. Or if this is a new (to Mozilla) profile.</span>
<a href="#l9.48"></a><span id="l9.48">         // MCD can set up accounts without the profile being used yet</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/base/prefs/content/accountcreation/fetchConfig.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/base/prefs/content/accountcreation/fetchConfig.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -114,17 +114,17 @@ function fetchConfigFromDB(domain, succe</span>
<a href="#l10.4"></a><span id="l10.4"> </span>
<a href="#l10.5"></a><span id="l10.5">   // If we don't specify a place to put the domain, put it at the end.</span>
<a href="#l10.6"></a><span id="l10.6">   if (url.indexOf(&quot;{{domain}}&quot;) == -1)</span>
<a href="#l10.7"></a><span id="l10.7">     url = url + domain;</span>
<a href="#l10.8"></a><span id="l10.8">   else</span>
<a href="#l10.9"></a><span id="l10.9">     url = url.replace(&quot;{{domain}}&quot;, domain);</span>
<a href="#l10.10"></a><span id="l10.10">   var accountManager = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l10.11"></a><span id="l10.11">                        .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-  url = url.replace(&quot;{{accounts}}&quot;, accountManager.accounts.Count());</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+  url = url.replace(&quot;{{accounts}}&quot;, accountManager.accounts.length);</span>
<a href="#l10.14"></a><span id="l10.14"> </span>
<a href="#l10.15"></a><span id="l10.15">   if (!url.length)</span>
<a href="#l10.16"></a><span id="l10.16">     return errorCallback(&quot;no fetch url set&quot;);</span>
<a href="#l10.17"></a><span id="l10.17">   let fetch = new FetchHTTP(url, null, false,</span>
<a href="#l10.18"></a><span id="l10.18">                             function(result)</span>
<a href="#l10.19"></a><span id="l10.19">                             {</span>
<a href="#l10.20"></a><span id="l10.20">                               successCallback(readFromXML(result));</span>
<a href="#l10.21"></a><span id="l10.21">                             },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/base/public/nsIMsgAccountManager.idl</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/base/public/nsIMsgAccountManager.idl</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -9,17 +9,17 @@</span>
<a href="#l11.4"></a><span id="l11.4"> #include &quot;nsIMsgIncomingServer.idl&quot;</span>
<a href="#l11.5"></a><span id="l11.5"> #include &quot;nsIIncomingServerListener.idl&quot;</span>
<a href="#l11.6"></a><span id="l11.6"> #include &quot;nsIMsgFolder.idl&quot;</span>
<a href="#l11.7"></a><span id="l11.7"> </span>
<a href="#l11.8"></a><span id="l11.8"> interface nsISupportsArray;</span>
<a href="#l11.9"></a><span id="l11.9"> interface nsIMsgFolderCache;</span>
<a href="#l11.10"></a><span id="l11.10"> interface nsIFolderListener;</span>
<a href="#l11.11"></a><span id="l11.11"> </span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-[scriptable, uuid(b00a0e76-9b64-420c-b717-7196b18ff503)]</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+[scriptable, uuid(0eb25b3d-56bf-4d87-9b1d-c4a8466391f3)]</span>
<a href="#l11.14"></a><span id="l11.14"> interface nsIMsgAccountManager : nsISupports {</span>
<a href="#l11.15"></a><span id="l11.15"> </span>
<a href="#l11.16"></a><span id="l11.16">   nsIMsgAccount createAccount();</span>
<a href="#l11.17"></a><span id="l11.17">   /*</span>
<a href="#l11.18"></a><span id="l11.18">    * Return the account with the provided key, or null if none found.</span>
<a href="#l11.19"></a><span id="l11.19">    */</span>
<a href="#l11.20"></a><span id="l11.20">   nsIMsgAccount getAccount(in ACString key);</span>
<a href="#l11.21"></a><span id="l11.21">     </span>
<a href="#l11.22"></a><span id="l11.22" class="difflineat">@@ -71,17 +71,17 @@ interface nsIMsgAccountManager : nsISupp</span>
<a href="#l11.23"></a><span id="l11.23">    * account already in the account manager */</span>
<a href="#l11.24"></a><span id="l11.24">   attribute nsIMsgAccount defaultAccount;</span>
<a href="#l11.25"></a><span id="l11.25"> </span>
<a href="#l11.26"></a><span id="l11.26">   /**</span>
<a href="#l11.27"></a><span id="l11.27">    * Ordered list of all accounts, by the order they are in the prefs.</span>
<a href="#l11.28"></a><span id="l11.28">    * Accounts with hidden servers are not returned.</span>
<a href="#l11.29"></a><span id="l11.29">    * array of nsIMsgAccount</span>
<a href="#l11.30"></a><span id="l11.30">    */</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineminus">-  readonly attribute nsISupportsArray accounts;</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineplus">+  readonly attribute nsIArray accounts;</span>
<a href="#l11.33"></a><span id="l11.33"> </span>
<a href="#l11.34"></a><span id="l11.34">   /* list of all identities in all accounts</span>
<a href="#l11.35"></a><span id="l11.35">    * array of nsIMsgIdentity</span>
<a href="#l11.36"></a><span id="l11.36">    */</span>
<a href="#l11.37"></a><span id="l11.37">   readonly attribute nsIArray allIdentities;</span>
<a href="#l11.38"></a><span id="l11.38"> </span>
<a href="#l11.39"></a><span id="l11.39">   /* list of all servers in all accounts, except for hidden and IM servers</span>
<a href="#l11.40"></a><span id="l11.40">    * array of nsIMsgIncomingServer</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineat">@@ -145,17 +145,17 @@ interface nsIMsgAccountManager : nsISupp</span>
<a href="#l11.42"></a><span id="l11.42">    * given a server, return the first identity in accounts that have this server</span>
<a href="#l11.43"></a><span id="l11.43">    */</span>
<a href="#l11.44"></a><span id="l11.44">   nsIMsgIdentity getFirstIdentityForServer(in nsIMsgIncomingServer server);</span>
<a href="#l11.45"></a><span id="l11.45"> </span>
<a href="#l11.46"></a><span id="l11.46">   /* given an identity, return all servers in accounts that have</span>
<a href="#l11.47"></a><span id="l11.47">    * this identity</span>
<a href="#l11.48"></a><span id="l11.48">    * returns an array of nsIMsgIncomingServer</span>
<a href="#l11.49"></a><span id="l11.49">    */</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineminus">-  nsISupportsArray GetServersForIdentity(in nsIMsgIdentity identity);</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineplus">+  nsIArray getServersForIdentity(in nsIMsgIdentity identity);</span>
<a href="#l11.52"></a><span id="l11.52"> </span>
<a href="#l11.53"></a><span id="l11.53">   /* there is a special server &quot;Local Folders&quot; that is guaranteed to exist.</span>
<a href="#l11.54"></a><span id="l11.54">    * this will allow you to get */</span>
<a href="#l11.55"></a><span id="l11.55">   attribute nsIMsgIncomingServer localFoldersServer;</span>
<a href="#l11.56"></a><span id="l11.56"> </span>
<a href="#l11.57"></a><span id="l11.57">   // Create the account for that special server.</span>
<a href="#l11.58"></a><span id="l11.58">   void createLocalMailAccount();</span>
<a href="#l11.59"></a><span id="l11.59">   </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/base/src/nsMsgAccountManager.cpp</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgAccountManager.cpp</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -104,38 +104,16 @@ struct findServerEntry {</span>
<a href="#l12.4"></a><span id="l12.4">       username(aUserName),</span>
<a href="#l12.5"></a><span id="l12.5">       type(aType),</span>
<a href="#l12.6"></a><span id="l12.6">       port(aPort),</span>
<a href="#l12.7"></a><span id="l12.7">       useRealSetting(aUseRealSetting),</span>
<a href="#l12.8"></a><span id="l12.8">       server(nullptr)</span>
<a href="#l12.9"></a><span id="l12.9">     {}</span>
<a href="#l12.10"></a><span id="l12.10"> };</span>
<a href="#l12.11"></a><span id="l12.11"> </span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-typedef struct _findServerByKeyEntry {</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineminus">-  nsCString key;</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineminus">-  int32_t index;</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineminus">-} findServerByKeyEntry;</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineminus">-</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineminus">-// use this to search for all servers that match &quot;server&quot; and</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineminus">-// put all identities in &quot;identities&quot;</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineminus">-typedef struct _findIdentitiesByServerEntry {</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineminus">-  nsISupportsArray *identities;</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineminus">-  nsIMsgIncomingServer *server;</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineminus">-} findIdentitiesByServerEntry;</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineminus">-</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineminus">-typedef struct _findServersByIdentityEntry {</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineminus">-  nsISupportsArray *servers;</span>
<a href="#l12.26"></a><span id="l12.26" class="difflineminus">-  nsIMsgIdentity *identity;</span>
<a href="#l12.27"></a><span id="l12.27" class="difflineminus">-} findServersByIdentityEntry;</span>
<a href="#l12.28"></a><span id="l12.28" class="difflineminus">-</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineminus">-typedef struct _findAccountByKeyEntry {</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineminus">-  nsCString  key;</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineminus">-  nsIMsgAccount* account;</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineminus">-} findAccountByKeyEntry;</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineminus">-</span>
<a href="#l12.34"></a><span id="l12.34"> static PLDHashOperator</span>
<a href="#l12.35"></a><span id="l12.35"> hashCleanupDeferral(nsCStringHashKey::KeyType aKey,</span>
<a href="#l12.36"></a><span id="l12.36">                     nsCOMPtr&lt;nsIMsgIncomingServer&gt;&amp; aServer, void* aClosure);</span>
<a href="#l12.37"></a><span id="l12.37"> </span>
<a href="#l12.38"></a><span id="l12.38"> NS_IMPL_THREADSAFE_ISUPPORTS5(nsMsgAccountManager,</span>
<a href="#l12.39"></a><span id="l12.39">                               nsIMsgAccountManager,</span>
<a href="#l12.40"></a><span id="l12.40">                               nsIObserver,</span>
<a href="#l12.41"></a><span id="l12.41">                               nsISupportsWeakReference,</span>
<a href="#l12.42"></a><span id="l12.42" class="difflineat">@@ -176,19 +154,16 @@ nsresult nsMsgAccountManager::Init()</span>
<a href="#l12.43"></a><span id="l12.43">   nsresult rv;</span>
<a href="#l12.44"></a><span id="l12.44"> </span>
<a href="#l12.45"></a><span id="l12.45">   m_prefs = do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l12.46"></a><span id="l12.46">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.47"></a><span id="l12.47"> </span>
<a href="#l12.48"></a><span id="l12.48">   m_identities.Init();</span>
<a href="#l12.49"></a><span id="l12.49">   m_incomingServers.Init();</span>
<a href="#l12.50"></a><span id="l12.50"> </span>
<a href="#l12.51"></a><span id="l12.51" class="difflineminus">-  rv = NS_NewISupportsArray(getter_AddRefs(m_accounts));</span>
<a href="#l12.52"></a><span id="l12.52" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.53"></a><span id="l12.53" class="difflineminus">-</span>
<a href="#l12.54"></a><span id="l12.54">   rv = NS_NewISupportsArray(getter_AddRefs(mFolderListeners));</span>
<a href="#l12.55"></a><span id="l12.55"> </span>
<a href="#l12.56"></a><span id="l12.56">   nsCOMPtr&lt;nsIObserverService&gt; observerService =</span>
<a href="#l12.57"></a><span id="l12.57">            mozilla::services::GetObserverService();</span>
<a href="#l12.58"></a><span id="l12.58">   if (NS_SUCCEEDED(rv) &amp;&amp; observerService)</span>
<a href="#l12.59"></a><span id="l12.59">   {</span>
<a href="#l12.60"></a><span id="l12.60">     observerService-&gt;AddObserver(this, NS_XPCOM_SHUTDOWN_OBSERVER_ID, true);</span>
<a href="#l12.61"></a><span id="l12.61">     observerService-&gt;AddObserver(this, &quot;quit-application-granted&quot; , true);</span>
<a href="#l12.62"></a><span id="l12.62" class="difflineat">@@ -298,18 +273,17 @@ NS_IMETHODIMP nsMsgAccountManager::Obser</span>
<a href="#l12.63"></a><span id="l12.63">     Shutdown();</span>
<a href="#l12.64"></a><span id="l12.64">     return NS_OK;</span>
<a href="#l12.65"></a><span id="l12.65">   }</span>
<a href="#l12.66"></a><span id="l12.66"> </span>
<a href="#l12.67"></a><span id="l12.67">  return NS_OK;</span>
<a href="#l12.68"></a><span id="l12.68"> }</span>
<a href="#l12.69"></a><span id="l12.69"> </span>
<a href="#l12.70"></a><span id="l12.70"> void</span>
<a href="#l12.71"></a><span id="l12.71" class="difflineminus">-nsMsgAccountManager::getUniqueAccountKey(nsISupportsArray *accounts,</span>
<a href="#l12.72"></a><span id="l12.72" class="difflineminus">-                                         nsCString&amp; aResult)</span>
<a href="#l12.73"></a><span id="l12.73" class="difflineplus">+nsMsgAccountManager::getUniqueAccountKey(nsCString&amp; aResult)</span>
<a href="#l12.74"></a><span id="l12.74"> {</span>
<a href="#l12.75"></a><span id="l12.75">   int32_t lastKey = 0;</span>
<a href="#l12.76"></a><span id="l12.76">   nsresult rv;</span>
<a href="#l12.77"></a><span id="l12.77">   nsCOMPtr&lt;nsIPrefService&gt; prefservice(do_GetService(NS_PREFSERVICE_CONTRACTID,</span>
<a href="#l12.78"></a><span id="l12.78">                                        &amp;rv));</span>
<a href="#l12.79"></a><span id="l12.79">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l12.80"></a><span id="l12.80">     nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch;</span>
<a href="#l12.81"></a><span id="l12.81">     prefservice-&gt;GetBranch(&quot;&quot;, getter_AddRefs(prefBranch));</span>
<a href="#l12.82"></a><span id="l12.82" class="difflineat">@@ -349,26 +323,23 @@ nsMsgAccountManager::getUniqueAccountKey</span>
<a href="#l12.83"></a><span id="l12.83">     // Use next available key and store the value in the pref.</span>
<a href="#l12.84"></a><span id="l12.84">     aResult.Assign(ACCOUNT_PREFIX);</span>
<a href="#l12.85"></a><span id="l12.85">     aResult.AppendInt(++lastKey);</span>
<a href="#l12.86"></a><span id="l12.86">     rv = prefBranch-&gt;SetIntPref(&quot;mail.account.lastKey&quot;, lastKey);</span>
<a href="#l12.87"></a><span id="l12.87">   } else {</span>
<a href="#l12.88"></a><span id="l12.88">     // If pref service is not working, try to find a free accountX key</span>
<a href="#l12.89"></a><span id="l12.89">     // by checking which keys exist.</span>
<a href="#l12.90"></a><span id="l12.90">     int32_t i = 1;</span>
<a href="#l12.91"></a><span id="l12.91" class="difflineminus">-    findAccountByKeyEntry findEntry;</span>
<a href="#l12.92"></a><span id="l12.92" class="difflineminus">-    findEntry.account = nullptr;</span>
<a href="#l12.93"></a><span id="l12.93" class="difflineplus">+    nsCOMPtr&lt;nsIMsgAccount&gt; account;</span>
<a href="#l12.94"></a><span id="l12.94"> </span>
<a href="#l12.95"></a><span id="l12.95">     do {</span>
<a href="#l12.96"></a><span id="l12.96" class="difflineminus">-      findEntry.account = nullptr;</span>
<a href="#l12.97"></a><span id="l12.97">       aResult = ACCOUNT_PREFIX;</span>
<a href="#l12.98"></a><span id="l12.98">       aResult.AppendInt(i++);</span>
<a href="#l12.99"></a><span id="l12.99" class="difflineminus">-      findEntry.key = aResult.get();</span>
<a href="#l12.100"></a><span id="l12.100" class="difflineminus">-      accounts-&gt;EnumerateForwards(findAccountByKey, (void *)&amp;findEntry);</span>
<a href="#l12.101"></a><span id="l12.101" class="difflineminus">-    } while (findEntry.account);</span>
<a href="#l12.102"></a><span id="l12.102" class="difflineplus">+      GetAccount(aResult, getter_AddRefs(account));</span>
<a href="#l12.103"></a><span id="l12.103" class="difflineplus">+    } while (account);</span>
<a href="#l12.104"></a><span id="l12.104">   }</span>
<a href="#l12.105"></a><span id="l12.105"> }</span>
<a href="#l12.106"></a><span id="l12.106"> </span>
<a href="#l12.107"></a><span id="l12.107"> void</span>
<a href="#l12.108"></a><span id="l12.108"> nsMsgAccountManager::GetUniqueServerKey(nsACString&amp; aResult)</span>
<a href="#l12.109"></a><span id="l12.109"> {</span>
<a href="#l12.110"></a><span id="l12.110">   nsAutoCString prefResult;</span>
<a href="#l12.111"></a><span id="l12.111">   bool usePrefsScan = true;</span>
<a href="#l12.112"></a><span id="l12.112" class="difflineat">@@ -690,23 +661,23 @@ nsMsgAccountManager::removeListenerFromF</span>
<a href="#l12.113"></a><span id="l12.113"> </span>
<a href="#l12.114"></a><span id="l12.114"> NS_IMETHODIMP</span>
<a href="#l12.115"></a><span id="l12.115"> nsMsgAccountManager::RemoveAccount(nsIMsgAccount *aAccount)</span>
<a href="#l12.116"></a><span id="l12.116"> {</span>
<a href="#l12.117"></a><span id="l12.117">   NS_ENSURE_ARG_POINTER(aAccount);</span>
<a href="#l12.118"></a><span id="l12.118">   nsresult rv = LoadAccounts();</span>
<a href="#l12.119"></a><span id="l12.119">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.120"></a><span id="l12.120"> </span>
<a href="#l12.121"></a><span id="l12.121" class="difflineminus">-  bool accountRemoved = NS_SUCCEEDED(m_accounts-&gt;RemoveElement(aAccount));</span>
<a href="#l12.122"></a><span id="l12.122" class="difflineplus">+  bool accountRemoved = m_accounts.RemoveElement(aAccount);</span>
<a href="#l12.123"></a><span id="l12.123"> </span>
<a href="#l12.124"></a><span id="l12.124">   rv  = OutputAccountsPref();</span>
<a href="#l12.125"></a><span id="l12.125">   // If we couldn't write out the pref, restore the account.</span>
<a href="#l12.126"></a><span id="l12.126">   if (NS_FAILED(rv) &amp;&amp; accountRemoved)</span>
<a href="#l12.127"></a><span id="l12.127">   {</span>
<a href="#l12.128"></a><span id="l12.128" class="difflineminus">-    m_accounts-&gt;AppendElement(aAccount);</span>
<a href="#l12.129"></a><span id="l12.129" class="difflineplus">+    m_accounts.AppendElement(aAccount);</span>
<a href="#l12.130"></a><span id="l12.130">     return rv;</span>
<a href="#l12.131"></a><span id="l12.131">   }</span>
<a href="#l12.132"></a><span id="l12.132"> </span>
<a href="#l12.133"></a><span id="l12.133">   // if it's the default, clear the default account</span>
<a href="#l12.134"></a><span id="l12.134">   if (m_defaultAccount.get() == aAccount)</span>
<a href="#l12.135"></a><span id="l12.135">     SetDefaultAccount(nullptr);</span>
<a href="#l12.136"></a><span id="l12.136"> </span>
<a href="#l12.137"></a><span id="l12.137">   // XXX - need to figure out if this is the last time this server is</span>
<a href="#l12.138"></a><span id="l12.138" class="difflineat">@@ -728,63 +699,49 @@ nsMsgAccountManager::RemoveAccount(nsIMs</span>
<a href="#l12.139"></a><span id="l12.139">       nsCOMPtr&lt;nsIMsgIdentity&gt; identity( do_QueryElementAt(identityArray, i, &amp;rv));</span>
<a href="#l12.140"></a><span id="l12.140">       bool identityStillUsed = false;</span>
<a href="#l12.141"></a><span id="l12.141">       // for each identity, see if any existing account still uses it,</span>
<a href="#l12.142"></a><span id="l12.142">       // and if not, clear it.</span>
<a href="#l12.143"></a><span id="l12.143">       // Note that we are also searching here accounts with missing servers from</span>
<a href="#l12.144"></a><span id="l12.144">       //  unloaded extension types.</span>
<a href="#l12.145"></a><span id="l12.145">       if (NS_SUCCEEDED(rv))</span>
<a href="#l12.146"></a><span id="l12.146">       {</span>
<a href="#l12.147"></a><span id="l12.147" class="difflineminus">-        uint32_t numAccounts;</span>
<a href="#l12.148"></a><span id="l12.148" class="difflineminus">-        m_accounts-&gt;Count(&amp;numAccounts);</span>
<a href="#l12.149"></a><span id="l12.149">         uint32_t index;</span>
<a href="#l12.150"></a><span id="l12.150" class="difflineminus">-        for (index = 0; index &lt; numAccounts &amp;&amp; !identityStillUsed; index++)</span>
<a href="#l12.151"></a><span id="l12.151" class="difflineplus">+        for (index = 0; index &lt; m_accounts.Length() &amp;&amp; !identityStillUsed; index++)</span>
<a href="#l12.152"></a><span id="l12.152">         {</span>
<a href="#l12.153"></a><span id="l12.153" class="difflineminus">-          nsCOMPtr&lt;nsIMsgAccount&gt; existingAccount;</span>
<a href="#l12.154"></a><span id="l12.154" class="difflineminus">-          rv = m_accounts-&gt;QueryElementAt(index, NS_GET_IID(nsIMsgAccount),</span>
<a href="#l12.155"></a><span id="l12.155" class="difflineminus">-                                          (void **)getter_AddRefs(existingAccount));</span>
<a href="#l12.156"></a><span id="l12.156" class="difflineminus">-          if (NS_SUCCEEDED(rv))</span>
<a href="#l12.157"></a><span id="l12.157" class="difflineplus">+          nsCOMPtr&lt;nsIArray&gt; existingIdentitiesArray;</span>
<a href="#l12.158"></a><span id="l12.158" class="difflineplus">+</span>
<a href="#l12.159"></a><span id="l12.159" class="difflineplus">+          rv = m_accounts[index]-&gt;GetIdentities(getter_AddRefs(existingIdentitiesArray));</span>
<a href="#l12.160"></a><span id="l12.160" class="difflineplus">+          uint32_t pos;</span>
<a href="#l12.161"></a><span id="l12.161" class="difflineplus">+          if (NS_SUCCEEDED(existingIdentitiesArray-&gt;IndexOf(0, identity, &amp;pos)))</span>
<a href="#l12.162"></a><span id="l12.162">           {</span>
<a href="#l12.163"></a><span id="l12.163" class="difflineminus">-            nsCOMPtr&lt;nsIArray&gt; existingIdentitiesArray;</span>
<a href="#l12.164"></a><span id="l12.164" class="difflineminus">-</span>
<a href="#l12.165"></a><span id="l12.165" class="difflineminus">-            rv = existingAccount-&gt;GetIdentities(getter_AddRefs(existingIdentitiesArray));</span>
<a href="#l12.166"></a><span id="l12.166" class="difflineminus">-            uint32_t pos;</span>
<a href="#l12.167"></a><span id="l12.167" class="difflineminus">-            if (NS_SUCCEEDED(existingIdentitiesArray-&gt;IndexOf(0, identity, &amp;pos)))</span>
<a href="#l12.168"></a><span id="l12.168" class="difflineminus">-            {</span>
<a href="#l12.169"></a><span id="l12.169" class="difflineminus">-              identityStillUsed = true;</span>
<a href="#l12.170"></a><span id="l12.170" class="difflineminus">-              break;</span>
<a href="#l12.171"></a><span id="l12.171" class="difflineminus">-            }</span>
<a href="#l12.172"></a><span id="l12.172" class="difflineplus">+            identityStillUsed = true;</span>
<a href="#l12.173"></a><span id="l12.173" class="difflineplus">+            break;</span>
<a href="#l12.174"></a><span id="l12.174">           }</span>
<a href="#l12.175"></a><span id="l12.175">         }</span>
<a href="#l12.176"></a><span id="l12.176">       }</span>
<a href="#l12.177"></a><span id="l12.177">       // clear out all identity information if no other account uses it.</span>
<a href="#l12.178"></a><span id="l12.178">       if (!identityStillUsed)</span>
<a href="#l12.179"></a><span id="l12.179">         identity-&gt;ClearAllValues();</span>
<a href="#l12.180"></a><span id="l12.180">     }</span>
<a href="#l12.181"></a><span id="l12.181">   }</span>
<a href="#l12.182"></a><span id="l12.182"> </span>
<a href="#l12.183"></a><span id="l12.183">   aAccount-&gt;ClearAllValues();</span>
<a href="#l12.184"></a><span id="l12.184">   return NS_OK;</span>
<a href="#l12.185"></a><span id="l12.185"> }</span>
<a href="#l12.186"></a><span id="l12.186"> </span>
<a href="#l12.187"></a><span id="l12.187"> nsresult</span>
<a href="#l12.188"></a><span id="l12.188"> nsMsgAccountManager::OutputAccountsPref()</span>
<a href="#l12.189"></a><span id="l12.189"> {</span>
<a href="#l12.190"></a><span id="l12.190" class="difflineminus">-  nsresult rv = NS_OK;</span>
<a href="#l12.191"></a><span id="l12.191" class="difflineminus">-</span>
<a href="#l12.192"></a><span id="l12.192" class="difflineminus">-  uint32_t numAccounts;</span>
<a href="#l12.193"></a><span id="l12.193" class="difflineminus">-  m_accounts-&gt;Count(&amp;numAccounts);</span>
<a href="#l12.194"></a><span id="l12.194">   nsCString accountKey;</span>
<a href="#l12.195"></a><span id="l12.195">   mAccountKeyList.Truncate();</span>
<a href="#l12.196"></a><span id="l12.196"> </span>
<a href="#l12.197"></a><span id="l12.197" class="difflineminus">-  for (uint32_t index = 0; index &lt; numAccounts; index++)</span>
<a href="#l12.198"></a><span id="l12.198" class="difflineplus">+  for (uint32_t index = 0; index &lt; m_accounts.Length(); index++)</span>
<a href="#l12.199"></a><span id="l12.199">   {</span>
<a href="#l12.200"></a><span id="l12.200" class="difflineminus">-    nsCOMPtr&lt;nsIMsgAccount&gt; account = do_QueryElementAt(m_accounts, index, &amp;rv);</span>
<a href="#l12.201"></a><span id="l12.201" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.202"></a><span id="l12.202" class="difflineminus">-    account-&gt;GetKey(accountKey);</span>
<a href="#l12.203"></a><span id="l12.203" class="difflineplus">+    m_accounts[index]-&gt;GetKey(accountKey);</span>
<a href="#l12.204"></a><span id="l12.204">     if (index)</span>
<a href="#l12.205"></a><span id="l12.205">       mAccountKeyList.Append(ACCOUNT_DELIMITER);</span>
<a href="#l12.206"></a><span id="l12.206">     mAccountKeyList.Append(accountKey);</span>
<a href="#l12.207"></a><span id="l12.207">   }</span>
<a href="#l12.208"></a><span id="l12.208">   return m_prefs-&gt;SetCharPref(PREF_MAIL_ACCOUNTMANAGER_ACCOUNTS,</span>
<a href="#l12.209"></a><span id="l12.209">                                 mAccountKeyList.get());</span>
<a href="#l12.210"></a><span id="l12.210"> }</span>
<a href="#l12.211"></a><span id="l12.211"> </span>
<a href="#l12.212"></a><span id="l12.212" class="difflineat">@@ -792,57 +749,55 @@ nsMsgAccountManager::OutputAccountsPref(</span>
<a href="#l12.213"></a><span id="l12.213"> NS_IMETHODIMP</span>
<a href="#l12.214"></a><span id="l12.214"> nsMsgAccountManager::GetDefaultAccount(nsIMsgAccount **aDefaultAccount)</span>
<a href="#l12.215"></a><span id="l12.215"> {</span>
<a href="#l12.216"></a><span id="l12.216">   NS_ENSURE_ARG_POINTER(aDefaultAccount);</span>
<a href="#l12.217"></a><span id="l12.217"> </span>
<a href="#l12.218"></a><span id="l12.218">   nsresult rv = LoadAccounts();</span>
<a href="#l12.219"></a><span id="l12.219">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.220"></a><span id="l12.220"> </span>
<a href="#l12.221"></a><span id="l12.221" class="difflineminus">-  uint32_t count;</span>
<a href="#l12.222"></a><span id="l12.222">   if (!m_defaultAccount) {</span>
<a href="#l12.223"></a><span id="l12.223" class="difflineminus">-    m_accounts-&gt;Count(&amp;count);</span>
<a href="#l12.224"></a><span id="l12.224" class="difflineplus">+    uint32_t count = m_accounts.Length();</span>
<a href="#l12.225"></a><span id="l12.225">     if (!count) {</span>
<a href="#l12.226"></a><span id="l12.226">       *aDefaultAccount = nullptr;</span>
<a href="#l12.227"></a><span id="l12.227">       return NS_ERROR_FAILURE;</span>
<a href="#l12.228"></a><span id="l12.228">     }</span>
<a href="#l12.229"></a><span id="l12.229"> </span>
<a href="#l12.230"></a><span id="l12.230">     nsCString defaultKey;</span>
<a href="#l12.231"></a><span id="l12.231">     rv = m_prefs-&gt;GetCharPref(PREF_MAIL_ACCOUNTMANAGER_DEFAULTACCOUNT, getter_Copies(defaultKey));</span>
<a href="#l12.232"></a><span id="l12.232"> </span>
<a href="#l12.233"></a><span id="l12.233">     if (NS_SUCCEEDED(rv))</span>
<a href="#l12.234"></a><span id="l12.234">       GetAccount(defaultKey, getter_AddRefs(m_defaultAccount));</span>
<a href="#l12.235"></a><span id="l12.235"> </span>
<a href="#l12.236"></a><span id="l12.236">     if (!m_defaultAccount) {</span>
<a href="#l12.237"></a><span id="l12.237">       nsCOMPtr&lt;nsIMsgAccount&gt; firstAccount;</span>
<a href="#l12.238"></a><span id="l12.238">       uint32_t index;</span>
<a href="#l12.239"></a><span id="l12.239">       bool foundValidDefaultAccount = false;</span>
<a href="#l12.240"></a><span id="l12.240">       for (index = 0; index &lt; count; index++) {</span>
<a href="#l12.241"></a><span id="l12.241" class="difflineminus">-        nsCOMPtr&lt;nsIMsgAccount&gt; account( do_QueryElementAt(m_accounts, index, &amp;rv));</span>
<a href="#l12.242"></a><span id="l12.242" class="difflineminus">-        if (NS_SUCCEEDED(rv)) {</span>
<a href="#l12.243"></a><span id="l12.243" class="difflineminus">-          // get incoming server</span>
<a href="#l12.244"></a><span id="l12.244" class="difflineminus">-          nsCOMPtr &lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l12.245"></a><span id="l12.245" class="difflineminus">-          // server could be null if created by an unloaded extension</span>
<a href="#l12.246"></a><span id="l12.246" class="difflineminus">-          (void) account-&gt;GetIncomingServer(getter_AddRefs(server));</span>
<a href="#l12.247"></a><span id="l12.247" class="difflineminus">-</span>
<a href="#l12.248"></a><span id="l12.248" class="difflineminus">-          bool canBeDefaultServer = false;</span>
<a href="#l12.249"></a><span id="l12.249" class="difflineminus">-          if (server)</span>
<a href="#l12.250"></a><span id="l12.250" class="difflineminus">-          {</span>
<a href="#l12.251"></a><span id="l12.251" class="difflineminus">-            server-&gt;GetCanBeDefaultServer(&amp;canBeDefaultServer);</span>
<a href="#l12.252"></a><span id="l12.252" class="difflineminus">-            if (!firstAccount)</span>
<a href="#l12.253"></a><span id="l12.253" class="difflineminus">-              firstAccount = account;</span>
<a href="#l12.254"></a><span id="l12.254" class="difflineminus">-          }</span>
<a href="#l12.255"></a><span id="l12.255" class="difflineminus">-</span>
<a href="#l12.256"></a><span id="l12.256" class="difflineminus">-          // if this can serve as default server, set it as default and</span>
<a href="#l12.257"></a><span id="l12.257" class="difflineminus">-          // break outof the loop.</span>
<a href="#l12.258"></a><span id="l12.258" class="difflineminus">-          if (canBeDefaultServer) {</span>
<a href="#l12.259"></a><span id="l12.259" class="difflineminus">-            SetDefaultAccount(account);</span>
<a href="#l12.260"></a><span id="l12.260" class="difflineminus">-            foundValidDefaultAccount = true;</span>
<a href="#l12.261"></a><span id="l12.261" class="difflineminus">-            break;</span>
<a href="#l12.262"></a><span id="l12.262" class="difflineminus">-          }</span>
<a href="#l12.263"></a><span id="l12.263" class="difflineplus">+        nsCOMPtr&lt;nsIMsgAccount&gt; account(m_accounts[index]);</span>
<a href="#l12.264"></a><span id="l12.264" class="difflineplus">+</span>
<a href="#l12.265"></a><span id="l12.265" class="difflineplus">+        // get incoming server</span>
<a href="#l12.266"></a><span id="l12.266" class="difflineplus">+        nsCOMPtr &lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l12.267"></a><span id="l12.267" class="difflineplus">+        // server could be null if created by an unloaded extension</span>
<a href="#l12.268"></a><span id="l12.268" class="difflineplus">+        (void) account-&gt;GetIncomingServer(getter_AddRefs(server));</span>
<a href="#l12.269"></a><span id="l12.269" class="difflineplus">+</span>
<a href="#l12.270"></a><span id="l12.270" class="difflineplus">+        bool canBeDefaultServer = false;</span>
<a href="#l12.271"></a><span id="l12.271" class="difflineplus">+        if (server)</span>
<a href="#l12.272"></a><span id="l12.272" class="difflineplus">+        {</span>
<a href="#l12.273"></a><span id="l12.273" class="difflineplus">+          server-&gt;GetCanBeDefaultServer(&amp;canBeDefaultServer);</span>
<a href="#l12.274"></a><span id="l12.274" class="difflineplus">+          if (!firstAccount)</span>
<a href="#l12.275"></a><span id="l12.275" class="difflineplus">+            firstAccount = account;</span>
<a href="#l12.276"></a><span id="l12.276" class="difflineplus">+        }</span>
<a href="#l12.277"></a><span id="l12.277" class="difflineplus">+</span>
<a href="#l12.278"></a><span id="l12.278" class="difflineplus">+        // if this can serve as default server, set it as default and</span>
<a href="#l12.279"></a><span id="l12.279" class="difflineplus">+        // break outof the loop.</span>
<a href="#l12.280"></a><span id="l12.280" class="difflineplus">+        if (canBeDefaultServer) {</span>
<a href="#l12.281"></a><span id="l12.281" class="difflineplus">+          SetDefaultAccount(account);</span>
<a href="#l12.282"></a><span id="l12.282" class="difflineplus">+          foundValidDefaultAccount = true;</span>
<a href="#l12.283"></a><span id="l12.283" class="difflineplus">+          break;</span>
<a href="#l12.284"></a><span id="l12.284">         }</span>
<a href="#l12.285"></a><span id="l12.285">       }</span>
<a href="#l12.286"></a><span id="l12.286"> </span>
<a href="#l12.287"></a><span id="l12.287">       if (!foundValidDefaultAccount) {</span>
<a href="#l12.288"></a><span id="l12.288">         // get the first account and use it.</span>
<a href="#l12.289"></a><span id="l12.289">         // we need to fix this scenario.</span>
<a href="#l12.290"></a><span id="l12.290">         NS_WARNING(&quot;No valid default account found, just using first (FIXME)&quot;);</span>
<a href="#l12.291"></a><span id="l12.291">         SetDefaultAccount(firstAccount);</span>
<a href="#l12.292"></a><span id="l12.292" class="difflineat">@@ -1128,71 +1083,58 @@ hashCloseCachedConnections(nsCStringHash</span>
<a href="#l12.293"></a><span id="l12.293"> static PLDHashOperator</span>
<a href="#l12.294"></a><span id="l12.294"> hashShutdown(nsCStringHashKey::KeyType aKey, nsCOMPtr&lt;nsIMsgIncomingServer&gt;&amp; aServer, void* aClosure)</span>
<a href="#l12.295"></a><span id="l12.295"> {</span>
<a href="#l12.296"></a><span id="l12.296">   if (aServer)</span>
<a href="#l12.297"></a><span id="l12.297">     aServer-&gt;Shutdown();</span>
<a href="#l12.298"></a><span id="l12.298">   return PL_DHASH_NEXT;</span>
<a href="#l12.299"></a><span id="l12.299"> }</span>
<a href="#l12.300"></a><span id="l12.300"> </span>
<a href="#l12.301"></a><span id="l12.301" class="difflineminus">-/* readonly attribute nsISupportsArray accounts; */</span>
<a href="#l12.302"></a><span id="l12.302"> NS_IMETHODIMP</span>
<a href="#l12.303"></a><span id="l12.303" class="difflineminus">-nsMsgAccountManager::GetAccounts(nsISupportsArray **_retval)</span>
<a href="#l12.304"></a><span id="l12.304" class="difflineplus">+nsMsgAccountManager::GetAccounts(nsIArray **_retval)</span>
<a href="#l12.305"></a><span id="l12.305"> {</span>
<a href="#l12.306"></a><span id="l12.306" class="difflineminus">-  nsresult rv;</span>
<a href="#l12.307"></a><span id="l12.307" class="difflineminus">-  rv = LoadAccounts();</span>
<a href="#l12.308"></a><span id="l12.308" class="difflineplus">+  nsresult rv = LoadAccounts();</span>
<a href="#l12.309"></a><span id="l12.309">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.310"></a><span id="l12.310"> </span>
<a href="#l12.311"></a><span id="l12.311" class="difflineminus">-  nsCOMPtr&lt;nsISupportsArray&gt; accounts;</span>
<a href="#l12.312"></a><span id="l12.312" class="difflineminus">-  NS_NewISupportsArray(getter_AddRefs(accounts));</span>
<a href="#l12.313"></a><span id="l12.313" class="difflineminus">-  uint32_t numAccounts;</span>
<a href="#l12.314"></a><span id="l12.314" class="difflineminus">-  m_accounts-&gt;Count(&amp;numAccounts);</span>
<a href="#l12.315"></a><span id="l12.315" class="difflineminus">-  for (uint32_t index = 0; index &lt; numAccounts; index++)</span>
<a href="#l12.316"></a><span id="l12.316" class="difflineplus">+  nsCOMPtr&lt;nsIMutableArray&gt; accounts(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l12.317"></a><span id="l12.317" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.318"></a><span id="l12.318" class="difflineplus">+</span>
<a href="#l12.319"></a><span id="l12.319" class="difflineplus">+  for (uint32_t index = 0; index &lt; m_accounts.Length(); index++)</span>
<a href="#l12.320"></a><span id="l12.320">   {</span>
<a href="#l12.321"></a><span id="l12.321" class="difflineminus">-    nsCOMPtr&lt;nsIMsgAccount&gt; existingAccount = do_QueryElementAt(m_accounts, index, &amp;rv);</span>
<a href="#l12.322"></a><span id="l12.322" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.323"></a><span id="l12.323" class="difflineplus">+    nsCOMPtr&lt;nsIMsgAccount&gt; existingAccount(m_accounts[index]);</span>
<a href="#l12.324"></a><span id="l12.324">     nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l12.325"></a><span id="l12.325">     existingAccount-&gt;GetIncomingServer(getter_AddRefs(server));</span>
<a href="#l12.326"></a><span id="l12.326">     if (!server)</span>
<a href="#l12.327"></a><span id="l12.327">       continue;</span>
<a href="#l12.328"></a><span id="l12.328">     if (server)</span>
<a href="#l12.329"></a><span id="l12.329">     {</span>
<a href="#l12.330"></a><span id="l12.330">       bool hidden = false;</span>
<a href="#l12.331"></a><span id="l12.331">       server-&gt;GetHidden(&amp;hidden);</span>
<a href="#l12.332"></a><span id="l12.332">       if (hidden)</span>
<a href="#l12.333"></a><span id="l12.333">         continue;</span>
<a href="#l12.334"></a><span id="l12.334">     }</span>
<a href="#l12.335"></a><span id="l12.335" class="difflineminus">-    nsCOMPtr&lt;nsISupports&gt; accountsSupport = do_QueryInterface(existingAccount);</span>
<a href="#l12.336"></a><span id="l12.336" class="difflineminus">-    accounts-&gt;AppendElement(accountsSupport);</span>
<a href="#l12.337"></a><span id="l12.337" class="difflineplus">+    accounts-&gt;AppendElement(existingAccount, false);</span>
<a href="#l12.338"></a><span id="l12.338">   }</span>
<a href="#l12.339"></a><span id="l12.339" class="difflineminus">-  accounts.swap(*_retval);</span>
<a href="#l12.340"></a><span id="l12.340" class="difflineplus">+  NS_IF_ADDREF(*_retval = accounts);</span>
<a href="#l12.341"></a><span id="l12.341">   return NS_OK;</span>
<a href="#l12.342"></a><span id="l12.342"> }</span>
<a href="#l12.343"></a><span id="l12.343"> </span>
<a href="#l12.344"></a><span id="l12.344"> NS_IMETHODIMP</span>
<a href="#l12.345"></a><span id="l12.345"> nsMsgAccountManager::GetAllIdentities(nsIArray **_retval)</span>
<a href="#l12.346"></a><span id="l12.346"> {</span>
<a href="#l12.347"></a><span id="l12.347">   nsresult rv = LoadAccounts();</span>
<a href="#l12.348"></a><span id="l12.348">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.349"></a><span id="l12.349"> </span>
<a href="#l12.350"></a><span id="l12.350">   nsCOMPtr&lt;nsIMutableArray&gt; result(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l12.351"></a><span id="l12.351">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.352"></a><span id="l12.352"> </span>
<a href="#l12.353"></a><span id="l12.353" class="difflineminus">-  uint32_t count;</span>
<a href="#l12.354"></a><span id="l12.354" class="difflineminus">-  rv = m_accounts-&gt;Count(&amp;count);</span>
<a href="#l12.355"></a><span id="l12.355" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.356"></a><span id="l12.356" class="difflineminus">-</span>
<a href="#l12.357"></a><span id="l12.357">   nsCOMPtr&lt;nsIArray&gt; identities;</span>
<a href="#l12.358"></a><span id="l12.358"> </span>
<a href="#l12.359"></a><span id="l12.359" class="difflineminus">-  for (uint32_t i = 0; i &lt; count; ++i) {</span>
<a href="#l12.360"></a><span id="l12.360" class="difflineminus">-    nsCOMPtr&lt;nsIMsgAccount&gt; account = do_QueryElementAt(m_accounts, i, &amp;rv);</span>
<a href="#l12.361"></a><span id="l12.361" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l12.362"></a><span id="l12.362" class="difflineminus">-      continue;</span>
<a href="#l12.363"></a><span id="l12.363" class="difflineminus">-</span>
<a href="#l12.364"></a><span id="l12.364" class="difflineminus">-    rv = account-&gt;GetIdentities(getter_AddRefs(identities));</span>
<a href="#l12.365"></a><span id="l12.365" class="difflineplus">+  for (uint32_t i = 0; i &lt; m_accounts.Length(); ++i) {</span>
<a href="#l12.366"></a><span id="l12.366" class="difflineplus">+    rv = m_accounts[i]-&gt;GetIdentities(getter_AddRefs(identities));</span>
<a href="#l12.367"></a><span id="l12.367">     if (NS_FAILED(rv))</span>
<a href="#l12.368"></a><span id="l12.368">       continue;</span>
<a href="#l12.369"></a><span id="l12.369"> </span>
<a href="#l12.370"></a><span id="l12.370">     uint32_t idCount;</span>
<a href="#l12.371"></a><span id="l12.371">     rv = identities-&gt;GetLength(&amp;idCount);</span>
<a href="#l12.372"></a><span id="l12.372">     if (NS_FAILED(rv))</span>
<a href="#l12.373"></a><span id="l12.373">       continue;</span>
<a href="#l12.374"></a><span id="l12.374"> </span>
<a href="#l12.375"></a><span id="l12.375" class="difflineat">@@ -1439,23 +1381,20 @@ nsMsgAccountManager::LoadAccounts()</span>
<a href="#l12.376"></a><span id="l12.376">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l12.377"></a><span id="l12.377"> </span>
<a href="#l12.378"></a><span id="l12.378">     serverKeyPref += &quot;.server&quot;;</span>
<a href="#l12.379"></a><span id="l12.379">     nsCString serverKey;</span>
<a href="#l12.380"></a><span id="l12.380">     rv = m_prefs-&gt;GetCharPref(serverKeyPref.get(), getter_Copies(serverKey));</span>
<a href="#l12.381"></a><span id="l12.381">     if (NS_FAILED(rv))</span>
<a href="#l12.382"></a><span id="l12.382">       continue;</span>
<a href="#l12.383"></a><span id="l12.383"> </span>
<a href="#l12.384"></a><span id="l12.384" class="difflineminus">-    findAccountByKeyEntry entry;</span>
<a href="#l12.385"></a><span id="l12.385" class="difflineminus">-    entry.key = serverKey;</span>
<a href="#l12.386"></a><span id="l12.386" class="difflineminus">-    entry.account = nullptr;</span>
<a href="#l12.387"></a><span id="l12.387" class="difflineminus">-</span>
<a href="#l12.388"></a><span id="l12.388" class="difflineminus">-    m_accounts-&gt;EnumerateForwards(findAccountByServerKey, (void *)&amp;entry);</span>
<a href="#l12.389"></a><span id="l12.389" class="difflineplus">+    nsCOMPtr&lt;nsIMsgAccount&gt; serverAccount;</span>
<a href="#l12.390"></a><span id="l12.390" class="difflineplus">+    findAccountByServerKey(serverKey, getter_AddRefs(serverAccount));</span>
<a href="#l12.391"></a><span id="l12.391">     // If we have an existing account with the same server, ignore this account</span>
<a href="#l12.392"></a><span id="l12.392" class="difflineminus">-    if (entry.account)</span>
<a href="#l12.393"></a><span id="l12.393" class="difflineplus">+    if (serverAccount)</span>
<a href="#l12.394"></a><span id="l12.394">       continue;</span>
<a href="#l12.395"></a><span id="l12.395"> </span>
<a href="#l12.396"></a><span id="l12.396">     if (NS_FAILED(createKeyedAccount(accountsArray[i],</span>
<a href="#l12.397"></a><span id="l12.397">                                      getter_AddRefs(account))) || !account)</span>
<a href="#l12.398"></a><span id="l12.398">     {</span>
<a href="#l12.399"></a><span id="l12.399">       NS_WARNING(&quot;unexpected entry in account list; prefs corrupt?&quot;);</span>
<a href="#l12.400"></a><span id="l12.400">       continue;</span>
<a href="#l12.401"></a><span id="l12.401">     }</span>
<a href="#l12.402"></a><span id="l12.402" class="difflineat">@@ -1506,25 +1445,23 @@ nsMsgAccountManager::LoadAccounts()</span>
<a href="#l12.403"></a><span id="l12.403">       PRTime2Seconds(PR_Now(), &amp;nowSeconds);</span>
<a href="#l12.404"></a><span id="l12.404">       if ((int32_t)nowSeconds &lt; timeUnavailable + secondsToLeave)</span>
<a href="#l12.405"></a><span id="l12.405">         deleteAccount = false;</span>
<a href="#l12.406"></a><span id="l12.406">     }</span>
<a href="#l12.407"></a><span id="l12.407"> </span>
<a href="#l12.408"></a><span id="l12.408">     if (deleteAccount)</span>
<a href="#l12.409"></a><span id="l12.409">     {</span>
<a href="#l12.410"></a><span id="l12.410">       dupAccounts.AppendObject(account);</span>
<a href="#l12.411"></a><span id="l12.411" class="difflineminus">-      m_accounts-&gt;RemoveElement(account);</span>
<a href="#l12.412"></a><span id="l12.412" class="difflineplus">+      m_accounts.RemoveElement(account);</span>
<a href="#l12.413"></a><span id="l12.413">     }</span>
<a href="#l12.414"></a><span id="l12.414">   }</span>
<a href="#l12.415"></a><span id="l12.415"> </span>
<a href="#l12.416"></a><span id="l12.416" class="difflineminus">-  uint32_t numAccounts;</span>
<a href="#l12.417"></a><span id="l12.417" class="difflineminus">-  m_accounts-&gt;Count(&amp;numAccounts);</span>
<a href="#l12.418"></a><span id="l12.418">   // Check if we removed one or more of the accounts in the pref string.</span>
<a href="#l12.419"></a><span id="l12.419">   // If so, rewrite the pref string.</span>
<a href="#l12.420"></a><span id="l12.420" class="difflineminus">-  if (accountsArray.Length() != numAccounts)</span>
<a href="#l12.421"></a><span id="l12.421" class="difflineplus">+  if (accountsArray.Length() != m_accounts.Length())</span>
<a href="#l12.422"></a><span id="l12.422">     OutputAccountsPref();</span>
<a href="#l12.423"></a><span id="l12.423"> </span>
<a href="#l12.424"></a><span id="l12.424">   int32_t cnt = dupAccounts.Count();</span>
<a href="#l12.425"></a><span id="l12.425">   nsCOMPtr&lt;nsIMsgAccount&gt; dupAccount;</span>
<a href="#l12.426"></a><span id="l12.426"> </span>
<a href="#l12.427"></a><span id="l12.427">   // Go through the accounts seeing if any existing server is deferred to</span>
<a href="#l12.428"></a><span id="l12.428">   // an account we removed. If so, fix the deferral. Then clean up the prefs</span>
<a href="#l12.429"></a><span id="l12.429">   // for the removed account.</span>
<a href="#l12.430"></a><span id="l12.430" class="difflineat">@@ -1548,28 +1485,25 @@ nsMsgAccountManager::LoadAccounts()</span>
<a href="#l12.431"></a><span id="l12.431"> </span>
<a href="#l12.432"></a><span id="l12.432">   // Make sure we have an account that points at the local folders server</span>
<a href="#l12.433"></a><span id="l12.433">   nsCString localFoldersServerKey;</span>
<a href="#l12.434"></a><span id="l12.434">   rv = m_prefs-&gt;GetCharPref(PREF_MAIL_ACCOUNTMANAGER_LOCALFOLDERSSERVER,</span>
<a href="#l12.435"></a><span id="l12.435">                             getter_Copies(localFoldersServerKey));</span>
<a href="#l12.436"></a><span id="l12.436"> </span>
<a href="#l12.437"></a><span id="l12.437">   if (!localFoldersServerKey.IsEmpty())</span>
<a href="#l12.438"></a><span id="l12.438">   {</span>
<a href="#l12.439"></a><span id="l12.439" class="difflineminus">-    findAccountByKeyEntry entry;</span>
<a href="#l12.440"></a><span id="l12.440" class="difflineminus">-    entry.key = localFoldersServerKey;</span>
<a href="#l12.441"></a><span id="l12.441" class="difflineminus">-    entry.account = nullptr;</span>
<a href="#l12.442"></a><span id="l12.442" class="difflineminus">-</span>
<a href="#l12.443"></a><span id="l12.443">     nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l12.444"></a><span id="l12.444">     rv = GetIncomingServer(localFoldersServerKey, getter_AddRefs(server));</span>
<a href="#l12.445"></a><span id="l12.445">     if (server)</span>
<a href="#l12.446"></a><span id="l12.446">     {</span>
<a href="#l12.447"></a><span id="l12.447" class="difflineminus">-      m_accounts-&gt;EnumerateForwards(findAccountByServerKey, (void *)&amp;entry);</span>
<a href="#l12.448"></a><span id="l12.448" class="difflineplus">+      nsCOMPtr&lt;nsIMsgAccount&gt; localFoldersAccount;</span>
<a href="#l12.449"></a><span id="l12.449" class="difflineplus">+      findAccountByServerKey(localFoldersServerKey, getter_AddRefs(localFoldersAccount));</span>
<a href="#l12.450"></a><span id="l12.450">       // If we don't have an existing account pointing at the local folders</span>
<a href="#l12.451"></a><span id="l12.451">       // server, we're going to add one.</span>
<a href="#l12.452"></a><span id="l12.452" class="difflineminus">-      if (!entry.account)</span>
<a href="#l12.453"></a><span id="l12.453" class="difflineplus">+      if (!localFoldersAccount)</span>
<a href="#l12.454"></a><span id="l12.454">       {</span>
<a href="#l12.455"></a><span id="l12.455">         nsCOMPtr&lt;nsIMsgAccount&gt; account;</span>
<a href="#l12.456"></a><span id="l12.456">         (void) CreateAccount(getter_AddRefs(account));</span>
<a href="#l12.457"></a><span id="l12.457">         if (account)</span>
<a href="#l12.458"></a><span id="l12.458">           account-&gt;SetIncomingServer(server);</span>
<a href="#l12.459"></a><span id="l12.459">       }</span>
<a href="#l12.460"></a><span id="l12.460">     }</span>
<a href="#l12.461"></a><span id="l12.461">   }</span>
<a href="#l12.462"></a><span id="l12.462" class="difflineat">@@ -1680,17 +1614,17 @@ nsMsgAccountManager::UnloadAccounts()</span>
<a href="#l12.463"></a><span id="l12.463"> {</span>
<a href="#l12.464"></a><span id="l12.464">   // release the default account</span>
<a href="#l12.465"></a><span id="l12.465">   kDefaultServerAtom = nullptr;</span>
<a href="#l12.466"></a><span id="l12.466">   mFolderFlagAtom = nullptr;</span>
<a href="#l12.467"></a><span id="l12.467"> </span>
<a href="#l12.468"></a><span id="l12.468">   m_defaultAccount=nullptr;</span>
<a href="#l12.469"></a><span id="l12.469">   m_incomingServers.Enumerate(hashUnloadServer, this);</span>
<a href="#l12.470"></a><span id="l12.470"> </span>
<a href="#l12.471"></a><span id="l12.471" class="difflineminus">-  m_accounts-&gt;Clear();          // will release all elements</span>
<a href="#l12.472"></a><span id="l12.472" class="difflineplus">+  m_accounts.Clear();          // will release all elements</span>
<a href="#l12.473"></a><span id="l12.473">   m_identities.Clear();</span>
<a href="#l12.474"></a><span id="l12.474">   m_incomingServers.Clear();</span>
<a href="#l12.475"></a><span id="l12.475">   mAccountKeyList.Truncate();</span>
<a href="#l12.476"></a><span id="l12.476">   SetLastServerFound(nullptr, EmptyCString(), EmptyCString(), 0, EmptyCString());</span>
<a href="#l12.477"></a><span id="l12.477"> </span>
<a href="#l12.478"></a><span id="l12.478">   if (m_accountsLoaded)</span>
<a href="#l12.479"></a><span id="l12.479">   {</span>
<a href="#l12.480"></a><span id="l12.480">     nsCOMPtr&lt;nsIMsgMailSession&gt; mailSession =</span>
<a href="#l12.481"></a><span id="l12.481" class="difflineat">@@ -1745,18 +1679,17 @@ nsMsgAccountManager::createKeyedAccount(</span>
<a href="#l12.482"></a><span id="l12.482"> {</span>
<a href="#l12.483"></a><span id="l12.483"> </span>
<a href="#l12.484"></a><span id="l12.484">   nsresult rv;</span>
<a href="#l12.485"></a><span id="l12.485">   nsCOMPtr&lt;nsIMsgAccount&gt; account = do_CreateInstance(kMsgAccountCID, &amp;rv);</span>
<a href="#l12.486"></a><span id="l12.486">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.487"></a><span id="l12.487"> </span>
<a href="#l12.488"></a><span id="l12.488">   account-&gt;SetKey(key);</span>
<a href="#l12.489"></a><span id="l12.489"> </span>
<a href="#l12.490"></a><span id="l12.490" class="difflineminus">-  // add to internal nsISupportsArray</span>
<a href="#l12.491"></a><span id="l12.491" class="difflineminus">-  m_accounts-&gt;AppendElement(static_cast&lt;nsISupports*&gt;(account));</span>
<a href="#l12.492"></a><span id="l12.492" class="difflineplus">+  m_accounts.AppendElement(account);</span>
<a href="#l12.493"></a><span id="l12.493"> </span>
<a href="#l12.494"></a><span id="l12.494">   // add to string list</span>
<a href="#l12.495"></a><span id="l12.495">   if (mAccountKeyList.IsEmpty())</span>
<a href="#l12.496"></a><span id="l12.496">     mAccountKeyList = key;</span>
<a href="#l12.497"></a><span id="l12.497">   else {</span>
<a href="#l12.498"></a><span id="l12.498">     mAccountKeyList.Append(',');</span>
<a href="#l12.499"></a><span id="l12.499">     mAccountKeyList.Append(key);</span>
<a href="#l12.500"></a><span id="l12.500">   }</span>
<a href="#l12.501"></a><span id="l12.501" class="difflineat">@@ -1767,111 +1700,80 @@ nsMsgAccountManager::createKeyedAccount(</span>
<a href="#l12.502"></a><span id="l12.502"> }</span>
<a href="#l12.503"></a><span id="l12.503"> </span>
<a href="#l12.504"></a><span id="l12.504"> NS_IMETHODIMP</span>
<a href="#l12.505"></a><span id="l12.505"> nsMsgAccountManager::CreateAccount(nsIMsgAccount **_retval)</span>
<a href="#l12.506"></a><span id="l12.506"> {</span>
<a href="#l12.507"></a><span id="l12.507">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l12.508"></a><span id="l12.508"> </span>
<a href="#l12.509"></a><span id="l12.509">   nsAutoCString key;</span>
<a href="#l12.510"></a><span id="l12.510" class="difflineminus">-  getUniqueAccountKey(m_accounts, key);</span>
<a href="#l12.511"></a><span id="l12.511" class="difflineplus">+  getUniqueAccountKey(key);</span>
<a href="#l12.512"></a><span id="l12.512"> </span>
<a href="#l12.513"></a><span id="l12.513">   return createKeyedAccount(key, _retval);</span>
<a href="#l12.514"></a><span id="l12.514"> }</span>
<a href="#l12.515"></a><span id="l12.515"> </span>
<a href="#l12.516"></a><span id="l12.516"> NS_IMETHODIMP</span>
<a href="#l12.517"></a><span id="l12.517" class="difflineminus">-nsMsgAccountManager::GetAccount(const nsACString&amp; key, nsIMsgAccount **_retval)</span>
<a href="#l12.518"></a><span id="l12.518" class="difflineplus">+nsMsgAccountManager::GetAccount(const nsACString&amp; aKey, nsIMsgAccount **aAccount)</span>
<a href="#l12.519"></a><span id="l12.519"> {</span>
<a href="#l12.520"></a><span id="l12.520" class="difflineminus">-  NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l12.521"></a><span id="l12.521" class="difflineminus">-</span>
<a href="#l12.522"></a><span id="l12.522" class="difflineminus">-  findAccountByKeyEntry findEntry;</span>
<a href="#l12.523"></a><span id="l12.523" class="difflineminus">-  findEntry.key = key;</span>
<a href="#l12.524"></a><span id="l12.524" class="difflineminus">-  findEntry.account = nullptr;</span>
<a href="#l12.525"></a><span id="l12.525" class="difflineminus">-</span>
<a href="#l12.526"></a><span id="l12.526" class="difflineminus">-  m_accounts-&gt;EnumerateForwards(findAccountByKey, (void *)&amp;findEntry);</span>
<a href="#l12.527"></a><span id="l12.527" class="difflineminus">-</span>
<a href="#l12.528"></a><span id="l12.528" class="difflineminus">-  if (findEntry.account)</span>
<a href="#l12.529"></a><span id="l12.529" class="difflineminus">-    NS_ADDREF(*_retval = findEntry.account);</span>
<a href="#l12.530"></a><span id="l12.530" class="difflineminus">-  else</span>
<a href="#l12.531"></a><span id="l12.531" class="difflineminus">-    *_retval = nullptr;</span>
<a href="#l12.532"></a><span id="l12.532" class="difflineminus">-</span>
<a href="#l12.533"></a><span id="l12.533" class="difflineminus">-  // not found, create on demand</span>
<a href="#l12.534"></a><span id="l12.534" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aAccount);</span>
<a href="#l12.535"></a><span id="l12.535" class="difflineplus">+  *aAccount = nullptr;</span>
<a href="#l12.536"></a><span id="l12.536" class="difflineplus">+</span>
<a href="#l12.537"></a><span id="l12.537" class="difflineplus">+  for (uint32_t i = 0; i &lt; m_accounts.Length(); ++i)</span>
<a href="#l12.538"></a><span id="l12.538" class="difflineplus">+  {</span>
<a href="#l12.539"></a><span id="l12.539" class="difflineplus">+    nsCOMPtr&lt;nsIMsgAccount&gt; account(m_accounts[i]);</span>
<a href="#l12.540"></a><span id="l12.540" class="difflineplus">+    nsCString key;</span>
<a href="#l12.541"></a><span id="l12.541" class="difflineplus">+    account-&gt;GetKey(key);</span>
<a href="#l12.542"></a><span id="l12.542" class="difflineplus">+    if (key.Equals(aKey))</span>
<a href="#l12.543"></a><span id="l12.543" class="difflineplus">+    {</span>
<a href="#l12.544"></a><span id="l12.544" class="difflineplus">+      account.swap(*aAccount);</span>
<a href="#l12.545"></a><span id="l12.545" class="difflineplus">+      break;</span>
<a href="#l12.546"></a><span id="l12.546" class="difflineplus">+    }</span>
<a href="#l12.547"></a><span id="l12.547" class="difflineplus">+  }</span>
<a href="#l12.548"></a><span id="l12.548" class="difflineplus">+</span>
<a href="#l12.549"></a><span id="l12.549" class="difflineplus">+  // If not found, create on demand.</span>
<a href="#l12.550"></a><span id="l12.550">   return NS_OK;</span>
<a href="#l12.551"></a><span id="l12.551"> }</span>
<a href="#l12.552"></a><span id="l12.552"> </span>
<a href="#l12.553"></a><span id="l12.553"> NS_IMETHODIMP</span>
<a href="#l12.554"></a><span id="l12.554"> nsMsgAccountManager::FindServerIndex(nsIMsgIncomingServer* server, int32_t* result)</span>
<a href="#l12.555"></a><span id="l12.555"> {</span>
<a href="#l12.556"></a><span id="l12.556">   NS_ENSURE_ARG_POINTER(server);</span>
<a href="#l12.557"></a><span id="l12.557">   NS_ENSURE_ARG_POINTER(result);</span>
<a href="#l12.558"></a><span id="l12.558"> </span>
<a href="#l12.559"></a><span id="l12.559">   nsCString key;</span>
<a href="#l12.560"></a><span id="l12.560">   nsresult rv = server-&gt;GetKey(key);</span>
<a href="#l12.561"></a><span id="l12.561">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.562"></a><span id="l12.562"> </span>
<a href="#l12.563"></a><span id="l12.563" class="difflineminus">-  findServerByKeyEntry findEntry;</span>
<a href="#l12.564"></a><span id="l12.564" class="difflineminus">-  findEntry.key = key;</span>
<a href="#l12.565"></a><span id="l12.565" class="difflineminus">-  findEntry.index = -1;</span>
<a href="#l12.566"></a><span id="l12.566" class="difflineminus">-</span>
<a href="#l12.567"></a><span id="l12.567">   // do this by account because the account list is in order</span>
<a href="#l12.568"></a><span id="l12.568" class="difflineminus">-  m_accounts-&gt;EnumerateForwards(findServerIndexByServer, (void *)&amp;findEntry);</span>
<a href="#l12.569"></a><span id="l12.569" class="difflineminus">-</span>
<a href="#l12.570"></a><span id="l12.570" class="difflineminus">-  // even if the search failed, we can return index.</span>
<a href="#l12.571"></a><span id="l12.571" class="difflineminus">-  // this means that all servers not in the array return an index higher</span>
<a href="#l12.572"></a><span id="l12.572" class="difflineminus">-  // than all &quot;registered&quot; servers</span>
<a href="#l12.573"></a><span id="l12.573" class="difflineminus">-  *result = findEntry.index;</span>
<a href="#l12.574"></a><span id="l12.574" class="difflineplus">+  uint32_t i;</span>
<a href="#l12.575"></a><span id="l12.575" class="difflineplus">+  for (i = 0; i &lt; m_accounts.Length(); ++i)</span>
<a href="#l12.576"></a><span id="l12.576" class="difflineplus">+  {</span>
<a href="#l12.577"></a><span id="l12.577" class="difflineplus">+    nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l12.578"></a><span id="l12.578" class="difflineplus">+    rv = m_accounts[i]-&gt;GetIncomingServer(getter_AddRefs(server));</span>
<a href="#l12.579"></a><span id="l12.579" class="difflineplus">+    if (!server || NS_FAILED(rv))</span>
<a href="#l12.580"></a><span id="l12.580" class="difflineplus">+      continue;</span>
<a href="#l12.581"></a><span id="l12.581" class="difflineplus">+</span>
<a href="#l12.582"></a><span id="l12.582" class="difflineplus">+    nsCString serverKey;</span>
<a href="#l12.583"></a><span id="l12.583" class="difflineplus">+    rv = server-&gt;GetKey(serverKey);</span>
<a href="#l12.584"></a><span id="l12.584" class="difflineplus">+    if (NS_FAILED(rv))</span>
<a href="#l12.585"></a><span id="l12.585" class="difflineplus">+      continue;</span>
<a href="#l12.586"></a><span id="l12.586" class="difflineplus">+</span>
<a href="#l12.587"></a><span id="l12.587" class="difflineplus">+    // stop when found,</span>
<a href="#l12.588"></a><span id="l12.588" class="difflineplus">+    // index will be set to the current index</span>
<a href="#l12.589"></a><span id="l12.589" class="difflineplus">+    if (serverKey.Equals(key))</span>
<a href="#l12.590"></a><span id="l12.590" class="difflineplus">+      break;</span>
<a href="#l12.591"></a><span id="l12.591" class="difflineplus">+  }</span>
<a href="#l12.592"></a><span id="l12.592" class="difflineplus">+</span>
<a href="#l12.593"></a><span id="l12.593" class="difflineplus">+  // Even if the search failed, we can return index.</span>
<a href="#l12.594"></a><span id="l12.594" class="difflineplus">+  // This means that all servers not in the array return an index higher</span>
<a href="#l12.595"></a><span id="l12.595" class="difflineplus">+  // than all &quot;registered&quot; servers.</span>
<a href="#l12.596"></a><span id="l12.596" class="difflineplus">+  *result = i;</span>
<a href="#l12.597"></a><span id="l12.597">   return NS_OK;</span>
<a href="#l12.598"></a><span id="l12.598"> }</span>
<a href="#l12.599"></a><span id="l12.599"> </span>
<a href="#l12.600"></a><span id="l12.600" class="difflineminus">-bool</span>
<a href="#l12.601"></a><span id="l12.601" class="difflineminus">-nsMsgAccountManager::findServerIndexByServer(nsISupports *element, void *aData)</span>
<a href="#l12.602"></a><span id="l12.602" class="difflineminus">-{</span>
<a href="#l12.603"></a><span id="l12.603" class="difflineminus">-  nsresult rv;</span>
<a href="#l12.604"></a><span id="l12.604" class="difflineminus">-</span>
<a href="#l12.605"></a><span id="l12.605" class="difflineminus">-  nsCOMPtr&lt;nsIMsgAccount&gt; account = do_QueryInterface(element);</span>
<a href="#l12.606"></a><span id="l12.606" class="difflineminus">-  findServerByKeyEntry *entry = (findServerByKeyEntry*) aData;</span>
<a href="#l12.607"></a><span id="l12.607" class="difflineminus">-</span>
<a href="#l12.608"></a><span id="l12.608" class="difflineminus">-  // increment the index;</span>
<a href="#l12.609"></a><span id="l12.609" class="difflineminus">-  entry-&gt;index++;</span>
<a href="#l12.610"></a><span id="l12.610" class="difflineminus">-</span>
<a href="#l12.611"></a><span id="l12.611" class="difflineminus">-  nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l12.612"></a><span id="l12.612" class="difflineminus">-  rv = account-&gt;GetIncomingServer(getter_AddRefs(server));</span>
<a href="#l12.613"></a><span id="l12.613" class="difflineminus">-  if (!server || NS_FAILED(rv))</span>
<a href="#l12.614"></a><span id="l12.614" class="difflineminus">-    return true;</span>
<a href="#l12.615"></a><span id="l12.615" class="difflineminus">-</span>
<a href="#l12.616"></a><span id="l12.616" class="difflineminus">-  nsCString key;</span>
<a href="#l12.617"></a><span id="l12.617" class="difflineminus">-  rv = server-&gt;GetKey(key);</span>
<a href="#l12.618"></a><span id="l12.618" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l12.619"></a><span id="l12.619" class="difflineminus">-    return true;</span>
<a href="#l12.620"></a><span id="l12.620" class="difflineminus">-</span>
<a href="#l12.621"></a><span id="l12.621" class="difflineminus">-  // stop when found,</span>
<a href="#l12.622"></a><span id="l12.622" class="difflineminus">-  // index will be set to the current index</span>
<a href="#l12.623"></a><span id="l12.623" class="difflineminus">-  return !key.Equals(entry-&gt;key);</span>
<a href="#l12.624"></a><span id="l12.624" class="difflineminus">-}</span>
<a href="#l12.625"></a><span id="l12.625" class="difflineminus">-</span>
<a href="#l12.626"></a><span id="l12.626" class="difflineminus">-bool</span>
<a href="#l12.627"></a><span id="l12.627" class="difflineminus">-nsMsgAccountManager::findAccountByKey(nsISupports* element, void *aData)</span>
<a href="#l12.628"></a><span id="l12.628" class="difflineminus">-{</span>
<a href="#l12.629"></a><span id="l12.629" class="difflineminus">-  nsresult rv;</span>
<a href="#l12.630"></a><span id="l12.630" class="difflineminus">-  nsCOMPtr&lt;nsIMsgAccount&gt; account = do_QueryInterface(element, &amp;rv);</span>
<a href="#l12.631"></a><span id="l12.631" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l12.632"></a><span id="l12.632" class="difflineminus">-    return true;</span>
<a href="#l12.633"></a><span id="l12.633" class="difflineminus">-</span>
<a href="#l12.634"></a><span id="l12.634" class="difflineminus">-  findAccountByKeyEntry *entry = (findAccountByKeyEntry*) aData;</span>
<a href="#l12.635"></a><span id="l12.635" class="difflineminus">-</span>
<a href="#l12.636"></a><span id="l12.636" class="difflineminus">-  nsCString key;</span>
<a href="#l12.637"></a><span id="l12.637" class="difflineminus">-  account-&gt;GetKey(key);</span>
<a href="#l12.638"></a><span id="l12.638" class="difflineminus">-  if (key.Equals(entry-&gt;key))</span>
<a href="#l12.639"></a><span id="l12.639" class="difflineminus">-  {</span>
<a href="#l12.640"></a><span id="l12.640" class="difflineminus">-    entry-&gt;account = account;</span>
<a href="#l12.641"></a><span id="l12.641" class="difflineminus">-    return false;        // stop when found</span>
<a href="#l12.642"></a><span id="l12.642" class="difflineminus">-  }</span>
<a href="#l12.643"></a><span id="l12.643" class="difflineminus">-  return true;</span>
<a href="#l12.644"></a><span id="l12.644" class="difflineminus">-}</span>
<a href="#l12.645"></a><span id="l12.645" class="difflineminus">-</span>
<a href="#l12.646"></a><span id="l12.646"> NS_IMETHODIMP nsMsgAccountManager::AddIncomingServerListener(nsIIncomingServerListener *serverListener)</span>
<a href="#l12.647"></a><span id="l12.647"> {</span>
<a href="#l12.648"></a><span id="l12.648">   m_incomingServerListeners.AppendObject(serverListener);</span>
<a href="#l12.649"></a><span id="l12.649">   return NS_OK;</span>
<a href="#l12.650"></a><span id="l12.650"> }</span>
<a href="#l12.651"></a><span id="l12.651"> </span>
<a href="#l12.652"></a><span id="l12.652"> NS_IMETHODIMP nsMsgAccountManager::RemoveIncomingServerListener(nsIIncomingServerListener *serverListener)</span>
<a href="#l12.653"></a><span id="l12.653"> {</span>
<a href="#l12.654"></a><span id="l12.654" class="difflineat">@@ -2022,43 +1924,41 @@ nsMsgAccountManager::FindRealServer(cons</span>
<a href="#l12.655"></a><span id="l12.655">                                     int32_t port,</span>
<a href="#l12.656"></a><span id="l12.656">                                     nsIMsgIncomingServer** aResult)</span>
<a href="#l12.657"></a><span id="l12.657"> {</span>
<a href="#l12.658"></a><span id="l12.658">   *aResult = nullptr;</span>
<a href="#l12.659"></a><span id="l12.659">   findServerInternal(username, hostname, type, port, true, aResult);</span>
<a href="#l12.660"></a><span id="l12.660">   return NS_OK;</span>
<a href="#l12.661"></a><span id="l12.661"> }</span>
<a href="#l12.662"></a><span id="l12.662"> </span>
<a href="#l12.663"></a><span id="l12.663" class="difflineminus">-bool</span>
<a href="#l12.664"></a><span id="l12.664" class="difflineminus">-nsMsgAccountManager::findAccountByServerKey(nsISupports *element,</span>
<a href="#l12.665"></a><span id="l12.665" class="difflineminus">-                                          void *aData)</span>
<a href="#l12.666"></a><span id="l12.666" class="difflineplus">+void</span>
<a href="#l12.667"></a><span id="l12.667" class="difflineplus">+nsMsgAccountManager::findAccountByServerKey(const nsCString &amp;aKey,</span>
<a href="#l12.668"></a><span id="l12.668" class="difflineplus">+                                            nsIMsgAccount **aResult)</span>
<a href="#l12.669"></a><span id="l12.669"> {</span>
<a href="#l12.670"></a><span id="l12.670" class="difflineminus">-  nsresult rv;</span>
<a href="#l12.671"></a><span id="l12.671" class="difflineminus">-  findAccountByKeyEntry *entry = (findAccountByKeyEntry*)aData;</span>
<a href="#l12.672"></a><span id="l12.672" class="difflineminus">-  nsCOMPtr&lt;nsIMsgAccount&gt; account = do_QueryInterface(element, &amp;rv);</span>
<a href="#l12.673"></a><span id="l12.673" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l12.674"></a><span id="l12.674" class="difflineminus">-    return true;</span>
<a href="#l12.675"></a><span id="l12.675" class="difflineminus">-</span>
<a href="#l12.676"></a><span id="l12.676" class="difflineminus">-  nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l12.677"></a><span id="l12.677" class="difflineminus">-  rv = account-&gt;GetIncomingServer(getter_AddRefs(server));</span>
<a href="#l12.678"></a><span id="l12.678" class="difflineminus">-  if (!server || NS_FAILED(rv))</span>
<a href="#l12.679"></a><span id="l12.679" class="difflineminus">-    return true;</span>
<a href="#l12.680"></a><span id="l12.680" class="difflineminus">-</span>
<a href="#l12.681"></a><span id="l12.681" class="difflineminus">-  nsCString key;</span>
<a href="#l12.682"></a><span id="l12.682" class="difflineminus">-  rv = server-&gt;GetKey(key);</span>
<a href="#l12.683"></a><span id="l12.683" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l12.684"></a><span id="l12.684" class="difflineminus">-    return true;</span>
<a href="#l12.685"></a><span id="l12.685" class="difflineminus">-</span>
<a href="#l12.686"></a><span id="l12.686" class="difflineminus">-  // if the keys are equal, the servers are equal</span>
<a href="#l12.687"></a><span id="l12.687" class="difflineminus">-  if (key.Equals(entry-&gt;key))</span>
<a href="#l12.688"></a><span id="l12.688" class="difflineplus">+  *aResult = nullptr;</span>
<a href="#l12.689"></a><span id="l12.689" class="difflineplus">+</span>
<a href="#l12.690"></a><span id="l12.690" class="difflineplus">+  for (uint32_t i = 0; i &lt; m_accounts.Length(); ++i)</span>
<a href="#l12.691"></a><span id="l12.691">   {</span>
<a href="#l12.692"></a><span id="l12.692" class="difflineminus">-    entry-&gt;account = account;</span>
<a href="#l12.693"></a><span id="l12.693" class="difflineminus">-    return false; // stop on first found account</span>
<a href="#l12.694"></a><span id="l12.694" class="difflineplus">+    nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l12.695"></a><span id="l12.695" class="difflineplus">+    nsresult rv = m_accounts[i]-&gt;GetIncomingServer(getter_AddRefs(server));</span>
<a href="#l12.696"></a><span id="l12.696" class="difflineplus">+    if (!server || NS_FAILED(rv))</span>
<a href="#l12.697"></a><span id="l12.697" class="difflineplus">+      continue;</span>
<a href="#l12.698"></a><span id="l12.698" class="difflineplus">+</span>
<a href="#l12.699"></a><span id="l12.699" class="difflineplus">+    nsCString key;</span>
<a href="#l12.700"></a><span id="l12.700" class="difflineplus">+    rv = server-&gt;GetKey(key);</span>
<a href="#l12.701"></a><span id="l12.701" class="difflineplus">+    if (NS_FAILED(rv))</span>
<a href="#l12.702"></a><span id="l12.702" class="difflineplus">+      continue;</span>
<a href="#l12.703"></a><span id="l12.703" class="difflineplus">+</span>
<a href="#l12.704"></a><span id="l12.704" class="difflineplus">+    // if the keys are equal, the servers are equal</span>
<a href="#l12.705"></a><span id="l12.705" class="difflineplus">+    if (key.Equals(aKey))</span>
<a href="#l12.706"></a><span id="l12.706" class="difflineplus">+    {</span>
<a href="#l12.707"></a><span id="l12.707" class="difflineplus">+      NS_ADDREF(*aResult = m_accounts[i]);</span>
<a href="#l12.708"></a><span id="l12.708" class="difflineplus">+      break; // stop on first found account</span>
<a href="#l12.709"></a><span id="l12.709" class="difflineplus">+    }</span>
<a href="#l12.710"></a><span id="l12.710">   }</span>
<a href="#l12.711"></a><span id="l12.711" class="difflineminus">-  return true;</span>
<a href="#l12.712"></a><span id="l12.712"> }</span>
<a href="#l12.713"></a><span id="l12.713"> </span>
<a href="#l12.714"></a><span id="l12.714"> NS_IMETHODIMP</span>
<a href="#l12.715"></a><span id="l12.715"> nsMsgAccountManager::FindAccountForServer(nsIMsgIncomingServer *server,</span>
<a href="#l12.716"></a><span id="l12.716">                                             nsIMsgAccount **aResult)</span>
<a href="#l12.717"></a><span id="l12.717"> {</span>
<a href="#l12.718"></a><span id="l12.718">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l12.719"></a><span id="l12.719"> </span>
<a href="#l12.720"></a><span id="l12.720" class="difflineat">@@ -2069,24 +1969,17 @@ nsMsgAccountManager::FindAccountForServe</span>
<a href="#l12.721"></a><span id="l12.721">   }</span>
<a href="#l12.722"></a><span id="l12.722"> </span>
<a href="#l12.723"></a><span id="l12.723">   nsresult rv;</span>
<a href="#l12.724"></a><span id="l12.724"> </span>
<a href="#l12.725"></a><span id="l12.725">   nsCString key;</span>
<a href="#l12.726"></a><span id="l12.726">   rv = server-&gt;GetKey(key);</span>
<a href="#l12.727"></a><span id="l12.727">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.728"></a><span id="l12.728"> </span>
<a href="#l12.729"></a><span id="l12.729" class="difflineminus">-  findAccountByKeyEntry entry;</span>
<a href="#l12.730"></a><span id="l12.730" class="difflineminus">-  entry.key = key;</span>
<a href="#l12.731"></a><span id="l12.731" class="difflineminus">-  entry.account = nullptr;</span>
<a href="#l12.732"></a><span id="l12.732" class="difflineminus">-</span>
<a href="#l12.733"></a><span id="l12.733" class="difflineminus">-  m_accounts-&gt;EnumerateForwards(findAccountByServerKey, (void *)&amp;entry);</span>
<a href="#l12.734"></a><span id="l12.734" class="difflineminus">-</span>
<a href="#l12.735"></a><span id="l12.735" class="difflineminus">-  if (entry.account)</span>
<a href="#l12.736"></a><span id="l12.736" class="difflineminus">-    NS_ADDREF(*aResult = entry.account);</span>
<a href="#l12.737"></a><span id="l12.737" class="difflineplus">+  findAccountByServerKey(key, aResult);</span>
<a href="#l12.738"></a><span id="l12.738">   return NS_OK;</span>
<a href="#l12.739"></a><span id="l12.739"> }</span>
<a href="#l12.740"></a><span id="l12.740"> </span>
<a href="#l12.741"></a><span id="l12.741"> // find matching server by user+host+type+port.</span>
<a href="#l12.742"></a><span id="l12.742"> PLDHashOperator</span>
<a href="#l12.743"></a><span id="l12.743"> nsMsgAccountManager::findServerUrl(nsCStringHashKey::KeyType key,</span>
<a href="#l12.744"></a><span id="l12.744">                                    nsCOMPtr&lt;nsIMsgIncomingServer&gt;&amp; server,</span>
<a href="#l12.745"></a><span id="l12.745">                                    void *data)</span>
<a href="#l12.746"></a><span id="l12.746" class="difflineat">@@ -2174,29 +2067,23 @@ nsMsgAccountManager::GetIdentitiesForSer</span>
<a href="#l12.747"></a><span id="l12.747">   NS_ENSURE_ARG_POINTER(server);</span>
<a href="#l12.748"></a><span id="l12.748">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l12.749"></a><span id="l12.749">   nsresult rv = LoadAccounts();</span>
<a href="#l12.750"></a><span id="l12.750">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.751"></a><span id="l12.751"> </span>
<a href="#l12.752"></a><span id="l12.752">   nsCOMPtr&lt;nsIMutableArray&gt; identities(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l12.753"></a><span id="l12.753">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.754"></a><span id="l12.754"> </span>
<a href="#l12.755"></a><span id="l12.755" class="difflineminus">-  uint32_t length;</span>
<a href="#l12.756"></a><span id="l12.756" class="difflineminus">-  rv = m_accounts-&gt;Count(&amp;length);</span>
<a href="#l12.757"></a><span id="l12.757" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.758"></a><span id="l12.758" class="difflineminus">-</span>
<a href="#l12.759"></a><span id="l12.759">   nsAutoCString serverKey;</span>
<a href="#l12.760"></a><span id="l12.760">   rv = server-&gt;GetKey(serverKey);</span>
<a href="#l12.761"></a><span id="l12.761">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.762"></a><span id="l12.762"> </span>
<a href="#l12.763"></a><span id="l12.763" class="difflineminus">-  for (uint32_t i = 0; i &lt; length; ++i)</span>
<a href="#l12.764"></a><span id="l12.764" class="difflineplus">+  for (uint32_t i = 0; i &lt; m_accounts.Length(); ++i)</span>
<a href="#l12.765"></a><span id="l12.765">   {</span>
<a href="#l12.766"></a><span id="l12.766" class="difflineminus">-    nsCOMPtr&lt;nsIMsgAccount&gt; account(do_QueryElementAt(m_accounts, i, &amp;rv));</span>
<a href="#l12.767"></a><span id="l12.767" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l12.768"></a><span id="l12.768" class="difflineminus">-      continue;</span>
<a href="#l12.769"></a><span id="l12.769" class="difflineplus">+    nsCOMPtr&lt;nsIMsgAccount&gt; account(m_accounts[i]);</span>
<a href="#l12.770"></a><span id="l12.770"> </span>
<a href="#l12.771"></a><span id="l12.771">     nsCOMPtr&lt;nsIMsgIncomingServer&gt; thisServer;</span>
<a href="#l12.772"></a><span id="l12.772">     rv = account-&gt;GetIncomingServer(getter_AddRefs(thisServer));</span>
<a href="#l12.773"></a><span id="l12.773">     if (NS_FAILED(rv))</span>
<a href="#l12.774"></a><span id="l12.774">       continue;</span>
<a href="#l12.775"></a><span id="l12.775"> </span>
<a href="#l12.776"></a><span id="l12.776">     nsAutoCString thisServerKey;</span>
<a href="#l12.777"></a><span id="l12.777">     rv = thisServer-&gt;GetKey(thisServerKey);</span>
<a href="#l12.778"></a><span id="l12.778" class="difflineat">@@ -2221,79 +2108,64 @@ nsMsgAccountManager::GetIdentitiesForSer</span>
<a href="#l12.779"></a><span id="l12.779">     }</span>
<a href="#l12.780"></a><span id="l12.780">   }</span>
<a href="#l12.781"></a><span id="l12.781"> </span>
<a href="#l12.782"></a><span id="l12.782">   identities.forget(_retval);</span>
<a href="#l12.783"></a><span id="l12.783">   return NS_OK;</span>
<a href="#l12.784"></a><span id="l12.784"> }</span>
<a href="#l12.785"></a><span id="l12.785"> </span>
<a href="#l12.786"></a><span id="l12.786"> NS_IMETHODIMP</span>
<a href="#l12.787"></a><span id="l12.787" class="difflineminus">-nsMsgAccountManager::GetServersForIdentity(nsIMsgIdentity *identity,</span>
<a href="#l12.788"></a><span id="l12.788" class="difflineminus">-                                           nsISupportsArray **_retval)</span>
<a href="#l12.789"></a><span id="l12.789" class="difflineplus">+nsMsgAccountManager::GetServersForIdentity(nsIMsgIdentity *aIdentity,</span>
<a href="#l12.790"></a><span id="l12.790" class="difflineplus">+                                           nsIArray **_retval)</span>
<a href="#l12.791"></a><span id="l12.791"> {</span>
<a href="#l12.792"></a><span id="l12.792" class="difflineminus">-  NS_ENSURE_ARG_POINTER(identity);</span>
<a href="#l12.793"></a><span id="l12.793" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aIdentity);</span>
<a href="#l12.794"></a><span id="l12.794"> </span>
<a href="#l12.795"></a><span id="l12.795">   nsresult rv;</span>
<a href="#l12.796"></a><span id="l12.796">   rv = LoadAccounts();</span>
<a href="#l12.797"></a><span id="l12.797">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.798"></a><span id="l12.798"> </span>
<a href="#l12.799"></a><span id="l12.799" class="difflineminus">-  nsCOMPtr&lt;nsISupportsArray&gt; servers;</span>
<a href="#l12.800"></a><span id="l12.800" class="difflineminus">-  rv = NS_NewISupportsArray(getter_AddRefs(servers));</span>
<a href="#l12.801"></a><span id="l12.801" class="difflineplus">+  nsCOMPtr&lt;nsIMutableArray&gt; servers(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l12.802"></a><span id="l12.802">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.803"></a><span id="l12.803"> </span>
<a href="#l12.804"></a><span id="l12.804" class="difflineminus">-  findServersByIdentityEntry serverInfo;</span>
<a href="#l12.805"></a><span id="l12.805" class="difflineminus">-  serverInfo.identity = identity;</span>
<a href="#l12.806"></a><span id="l12.806" class="difflineminus">-  serverInfo.servers = servers;</span>
<a href="#l12.807"></a><span id="l12.807" class="difflineminus">-</span>
<a href="#l12.808"></a><span id="l12.808" class="difflineminus">-  m_accounts-&gt;EnumerateForwards(findServersForIdentity,</span>
<a href="#l12.809"></a><span id="l12.809" class="difflineminus">-                                (void *)&amp;serverInfo);</span>
<a href="#l12.810"></a><span id="l12.810" class="difflineminus">-  servers.swap(*_retval);</span>
<a href="#l12.811"></a><span id="l12.811" class="difflineminus">-  return NS_OK;</span>
<a href="#l12.812"></a><span id="l12.812" class="difflineminus">-}</span>
<a href="#l12.813"></a><span id="l12.813" class="difflineminus">-</span>
<a href="#l12.814"></a><span id="l12.814" class="difflineminus">-bool</span>
<a href="#l12.815"></a><span id="l12.815" class="difflineminus">-nsMsgAccountManager::findServersForIdentity(nsISupports *element, void *aData)</span>
<a href="#l12.816"></a><span id="l12.816" class="difflineminus">-{</span>
<a href="#l12.817"></a><span id="l12.817" class="difflineminus">-  nsresult rv;</span>
<a href="#l12.818"></a><span id="l12.818" class="difflineminus">-  nsCOMPtr&lt;nsIMsgAccount&gt; account = do_QueryInterface(element, &amp;rv);</span>
<a href="#l12.819"></a><span id="l12.819" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l12.820"></a><span id="l12.820" class="difflineminus">-    return true;</span>
<a href="#l12.821"></a><span id="l12.821" class="difflineminus">-</span>
<a href="#l12.822"></a><span id="l12.822" class="difflineminus">-  findServersByIdentityEntry *entry = (findServersByIdentityEntry*)aData;</span>
<a href="#l12.823"></a><span id="l12.823" class="difflineminus">-</span>
<a href="#l12.824"></a><span id="l12.824" class="difflineminus">-  nsCOMPtr&lt;nsIArray&gt; identities;</span>
<a href="#l12.825"></a><span id="l12.825" class="difflineminus">-  account-&gt;GetIdentities(getter_AddRefs(identities));</span>
<a href="#l12.826"></a><span id="l12.826" class="difflineminus">-</span>
<a href="#l12.827"></a><span id="l12.827" class="difflineminus">-  uint32_t idCount=0;</span>
<a href="#l12.828"></a><span id="l12.828" class="difflineminus">-  identities-&gt;GetLength(&amp;idCount);</span>
<a href="#l12.829"></a><span id="l12.829" class="difflineminus">-</span>
<a href="#l12.830"></a><span id="l12.830" class="difflineminus">-  uint32_t id;</span>
<a href="#l12.831"></a><span id="l12.831" class="difflineminus">-  nsCString identityKey;</span>
<a href="#l12.832"></a><span id="l12.832" class="difflineminus">-  rv = entry-&gt;identity-&gt;GetKey(identityKey);</span>
<a href="#l12.833"></a><span id="l12.833" class="difflineminus">-  for (id = 0; id &lt; idCount; id++)</span>
<a href="#l12.834"></a><span id="l12.834" class="difflineplus">+  for (uint32_t i = 0; i &lt; m_accounts.Length(); ++i)</span>
<a href="#l12.835"></a><span id="l12.835">   {</span>
<a href="#l12.836"></a><span id="l12.836" class="difflineminus">-    nsCOMPtr&lt;nsIMsgIdentity&gt; thisIdentity( do_QueryElementAt(identities, id, &amp;rv));</span>
<a href="#l12.837"></a><span id="l12.837" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l12.838"></a><span id="l12.838" class="difflineplus">+    nsCOMPtr&lt;nsIArray&gt; identities;</span>
<a href="#l12.839"></a><span id="l12.839" class="difflineplus">+    if (NS_FAILED(m_accounts[i]-&gt;GetIdentities(getter_AddRefs(identities))))</span>
<a href="#l12.840"></a><span id="l12.840" class="difflineplus">+      continue;</span>
<a href="#l12.841"></a><span id="l12.841" class="difflineplus">+</span>
<a href="#l12.842"></a><span id="l12.842" class="difflineplus">+    uint32_t idCount = 0;</span>
<a href="#l12.843"></a><span id="l12.843" class="difflineplus">+    if (NS_FAILED(identities-&gt;GetLength(&amp;idCount)))</span>
<a href="#l12.844"></a><span id="l12.844" class="difflineplus">+      continue;</span>
<a href="#l12.845"></a><span id="l12.845" class="difflineplus">+</span>
<a href="#l12.846"></a><span id="l12.846" class="difflineplus">+    uint32_t id;</span>
<a href="#l12.847"></a><span id="l12.847" class="difflineplus">+    nsCString identityKey;</span>
<a href="#l12.848"></a><span id="l12.848" class="difflineplus">+    rv = aIdentity-&gt;GetKey(identityKey);</span>
<a href="#l12.849"></a><span id="l12.849" class="difflineplus">+    for (id = 0; id &lt; idCount; id++)</span>
<a href="#l12.850"></a><span id="l12.850">     {</span>
<a href="#l12.851"></a><span id="l12.851" class="difflineminus">-      nsCString thisIdentityKey;</span>
<a href="#l12.852"></a><span id="l12.852" class="difflineminus">-      rv = thisIdentity-&gt;GetKey(thisIdentityKey);</span>
<a href="#l12.853"></a><span id="l12.853" class="difflineminus">-</span>
<a href="#l12.854"></a><span id="l12.854" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; identityKey.Equals(thisIdentityKey))</span>
<a href="#l12.855"></a><span id="l12.855" class="difflineplus">+      nsCOMPtr&lt;nsIMsgIdentity&gt; thisIdentity(do_QueryElementAt(identities, id, &amp;rv));</span>
<a href="#l12.856"></a><span id="l12.856" class="difflineplus">+      if (NS_SUCCEEDED(rv))</span>
<a href="#l12.857"></a><span id="l12.857">       {</span>
<a href="#l12.858"></a><span id="l12.858" class="difflineminus">-        nsCOMPtr&lt;nsIMsgIncomingServer&gt; thisServer;</span>
<a href="#l12.859"></a><span id="l12.859" class="difflineminus">-        rv = account-&gt;GetIncomingServer(getter_AddRefs(thisServer));</span>
<a href="#l12.860"></a><span id="l12.860" class="difflineminus">-        if (thisServer &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l12.861"></a><span id="l12.861" class="difflineplus">+        nsCString thisIdentityKey;</span>
<a href="#l12.862"></a><span id="l12.862" class="difflineplus">+        rv = thisIdentity-&gt;GetKey(thisIdentityKey);</span>
<a href="#l12.863"></a><span id="l12.863" class="difflineplus">+</span>
<a href="#l12.864"></a><span id="l12.864" class="difflineplus">+        if (NS_SUCCEEDED(rv) &amp;&amp; identityKey.Equals(thisIdentityKey))</span>
<a href="#l12.865"></a><span id="l12.865">         {</span>
<a href="#l12.866"></a><span id="l12.866" class="difflineminus">-          entry-&gt;servers-&gt;AppendElement(thisServer);</span>
<a href="#l12.867"></a><span id="l12.867" class="difflineminus">-          break;</span>
<a href="#l12.868"></a><span id="l12.868" class="difflineplus">+          nsCOMPtr&lt;nsIMsgIncomingServer&gt; thisServer;</span>
<a href="#l12.869"></a><span id="l12.869" class="difflineplus">+          rv = m_accounts[i]-&gt;GetIncomingServer(getter_AddRefs(thisServer));</span>
<a href="#l12.870"></a><span id="l12.870" class="difflineplus">+          if (thisServer &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l12.871"></a><span id="l12.871" class="difflineplus">+          {</span>
<a href="#l12.872"></a><span id="l12.872" class="difflineplus">+            servers-&gt;AppendElement(thisServer, false);</span>
<a href="#l12.873"></a><span id="l12.873" class="difflineplus">+            break;</span>
<a href="#l12.874"></a><span id="l12.874" class="difflineplus">+          }</span>
<a href="#l12.875"></a><span id="l12.875">         }</span>
<a href="#l12.876"></a><span id="l12.876">       }</span>
<a href="#l12.877"></a><span id="l12.877">     }</span>
<a href="#l12.878"></a><span id="l12.878">   }</span>
<a href="#l12.879"></a><span id="l12.879" class="difflineminus">-  return true;</span>
<a href="#l12.880"></a><span id="l12.880" class="difflineplus">+  servers.forget(_retval);</span>
<a href="#l12.881"></a><span id="l12.881" class="difflineplus">+  return NS_OK;</span>
<a href="#l12.882"></a><span id="l12.882"> }</span>
<a href="#l12.883"></a><span id="l12.883"> </span>
<a href="#l12.884"></a><span id="l12.884"> static PLDHashOperator</span>
<a href="#l12.885"></a><span id="l12.885"> hashAddListener(nsCStringHashKey::KeyType aKey, nsCOMPtr&lt;nsIMsgIncomingServer&gt;&amp; aServer, void* aClosure)</span>
<a href="#l12.886"></a><span id="l12.886"> {</span>
<a href="#l12.887"></a><span id="l12.887">   nsIFolderListener* listener = (nsIFolderListener *) aClosure;</span>
<a href="#l12.888"></a><span id="l12.888">   nsresult rv;</span>
<a href="#l12.889"></a><span id="l12.889">   nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/base/src/nsMsgAccountManager.h</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgAccountManager.h</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -86,17 +86,17 @@ public:</span>
<a href="#l13.4"></a><span id="l13.4">   void LogoutOfServer(nsIMsgIncomingServer *aServer);</span>
<a href="#l13.5"></a><span id="l13.5"> </span>
<a href="#l13.6"></a><span id="l13.6"> private:</span>
<a href="#l13.7"></a><span id="l13.7"> </span>
<a href="#l13.8"></a><span id="l13.8">   bool m_accountsLoaded;</span>
<a href="#l13.9"></a><span id="l13.9">   nsCOMPtr &lt;nsIMsgFolderCache&gt; m_msgFolderCache;</span>
<a href="#l13.10"></a><span id="l13.10">   nsCOMPtr&lt;nsIAtom&gt; kDefaultServerAtom;</span>
<a href="#l13.11"></a><span id="l13.11">   nsCOMPtr&lt;nsIAtom&gt; mFolderFlagAtom;</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-  nsCOMPtr&lt;nsISupportsArray&gt; m_accounts;</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+  nsTArray&lt;nsCOMPtr&lt;nsIMsgAccount&gt;&gt; m_accounts;</span>
<a href="#l13.14"></a><span id="l13.14">   nsInterfaceHashtable&lt;nsCStringHashKey, nsIMsgIdentity&gt; m_identities;</span>
<a href="#l13.15"></a><span id="l13.15">   nsInterfaceHashtable&lt;nsCStringHashKey, nsIMsgIncomingServer&gt; m_incomingServers;</span>
<a href="#l13.16"></a><span id="l13.16">   nsCOMPtr&lt;nsIMsgAccount&gt; m_defaultAccount;</span>
<a href="#l13.17"></a><span id="l13.17">   nsCOMArray&lt;nsIIncomingServerListener&gt; m_incomingServerListeners;</span>
<a href="#l13.18"></a><span id="l13.18">   nsTObserverArray&lt;nsRefPtr&lt;VirtualFolderChangeListener&gt; &gt; m_virtualFolderListeners;</span>
<a href="#l13.19"></a><span id="l13.19">   nsCOMPtr&lt;nsIMsgFolder&gt; m_folderDoingEmptyTrash;</span>
<a href="#l13.20"></a><span id="l13.20">   nsCOMPtr&lt;nsIMsgFolder&gt; m_folderDoingCleanupInbox;</span>
<a href="#l13.21"></a><span id="l13.21">   bool m_emptyTrashInProgress;</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineat">@@ -156,21 +156,18 @@ private:</span>
<a href="#l13.23"></a><span id="l13.23">   //</span>
<a href="#l13.24"></a><span id="l13.24">   // account enumerators</span>
<a href="#l13.25"></a><span id="l13.25">   // (&quot;element&quot; is always an account)</span>
<a href="#l13.26"></a><span id="l13.26">   //</span>
<a href="#l13.27"></a><span id="l13.27"> </span>
<a href="#l13.28"></a><span id="l13.28">   // find the servers that correspond to the given identity</span>
<a href="#l13.29"></a><span id="l13.29">   static bool findServersForIdentity (nsISupports *element, void *aData);</span>
<a href="#l13.30"></a><span id="l13.30"> </span>
<a href="#l13.31"></a><span id="l13.31" class="difflineminus">-  static bool findServerIndexByServer(nsISupports *element, void *aData);</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineminus">-  // find the account with the given key</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineminus">-  static bool findAccountByKey (nsISupports *element, void *aData);</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineminus">-</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineminus">-  static bool findAccountByServerKey (nsISupports *element, void *aData);</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineplus">+  void findAccountByServerKey(const nsCString &amp;aKey,</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineplus">+                              nsIMsgAccount **aResult);</span>
<a href="#l13.38"></a><span id="l13.38"> </span>
<a href="#l13.39"></a><span id="l13.39">   //</span>
<a href="#l13.40"></a><span id="l13.40">   // server enumerators</span>
<a href="#l13.41"></a><span id="l13.41">   // (&quot;element&quot; is always a server)</span>
<a href="#l13.42"></a><span id="l13.42">   //</span>
<a href="#l13.43"></a><span id="l13.43"> </span>
<a href="#l13.44"></a><span id="l13.44">   // find the server given by {username, hostname, port, type}</span>
<a href="#l13.45"></a><span id="l13.45">   static PLDHashOperator findServerUrl(nsCStringHashKey::KeyType aKey,</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineat">@@ -197,19 +194,17 @@ private:</span>
<a href="#l13.47"></a><span id="l13.47">   nsresult AddVFListenersForVF(nsIMsgFolder *virtualFolder,</span>
<a href="#l13.48"></a><span id="l13.48">                                const nsCString&amp; srchFolderUris,</span>
<a href="#l13.49"></a><span id="l13.49">                                nsIRDFService *rdf,</span>
<a href="#l13.50"></a><span id="l13.50">                                nsIMsgDBService *msgDBService);</span>
<a href="#l13.51"></a><span id="l13.51"> </span>
<a href="#l13.52"></a><span id="l13.52">   nsresult RemoveVFListenerForVF(nsIMsgFolder *virtualFolder,</span>
<a href="#l13.53"></a><span id="l13.53">                                  nsIMsgFolder *folder);</span>
<a href="#l13.54"></a><span id="l13.54"> </span>
<a href="#l13.55"></a><span id="l13.55" class="difflineminus">-  static void getUniqueAccountKey(nsISupportsArray *accounts,</span>
<a href="#l13.56"></a><span id="l13.56" class="difflineminus">-                                  nsCString&amp; aResult);</span>
<a href="#l13.57"></a><span id="l13.57" class="difflineminus">-</span>
<a href="#l13.58"></a><span id="l13.58" class="difflineplus">+  void getUniqueAccountKey(nsCString&amp; aResult);</span>
<a href="#l13.59"></a><span id="l13.59"> </span>
<a href="#l13.60"></a><span id="l13.60">   // Scan the preferences to find a unique server key</span>
<a href="#l13.61"></a><span id="l13.61">   void GetUniqueServerKey(nsACString&amp; aResult);</span>
<a href="#l13.62"></a><span id="l13.62"> </span>
<a href="#l13.63"></a><span id="l13.63">   nsresult RemoveFolderFromSmartFolder(nsIMsgFolder *aFolder,</span>
<a href="#l13.64"></a><span id="l13.64">                                        uint32_t flagsChanged);</span>
<a href="#l13.65"></a><span id="l13.65"> </span>
<a href="#l13.66"></a><span id="l13.66">   nsresult SetSendLaterUriPref(nsIMsgIncomingServer *server);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/base/src/nsSpamSettings.cpp</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/base/src/nsSpamSettings.cpp</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -363,22 +363,22 @@ NS_IMETHODIMP nsSpamSettings::Initialize</span>
<a href="#l14.4"></a><span id="l14.4"> </span>
<a href="#l14.5"></a><span id="l14.5">     nsAutoCString accountKey;</span>
<a href="#l14.6"></a><span id="l14.6">     if (account) </span>
<a href="#l14.7"></a><span id="l14.7">       account-&gt;GetKey(accountKey);</span>
<a href="#l14.8"></a><span id="l14.8"> </span>
<a href="#l14.9"></a><span id="l14.9">     // Loop through all accounts, adding emails from this account, as well as</span>
<a href="#l14.10"></a><span id="l14.10">     // from any accounts that defer to this account.</span>
<a href="#l14.11"></a><span id="l14.11">     mEmails.Clear();</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-    nsCOMPtr&lt;nsISupportsArray&gt; accounts;</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+    nsCOMPtr&lt;nsIArray&gt; accounts;</span>
<a href="#l14.14"></a><span id="l14.14">     rv = accountManager-&gt;GetAccounts(getter_AddRefs(accounts));</span>
<a href="#l14.15"></a><span id="l14.15">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.16"></a><span id="l14.16">     uint32_t accountCount = 0;</span>
<a href="#l14.17"></a><span id="l14.17">     if (account &amp;&amp; accounts) // no sense scanning accounts if we've nothing to match</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineminus">-      accounts-&gt;Count(&amp;accountCount);</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineplus">+      accounts-&gt;GetLength(&amp;accountCount);</span>
<a href="#l14.20"></a><span id="l14.20"> </span>
<a href="#l14.21"></a><span id="l14.21">     for (uint32_t i = 0; i &lt; accountCount; i++)</span>
<a href="#l14.22"></a><span id="l14.22">     {</span>
<a href="#l14.23"></a><span id="l14.23">       nsCOMPtr&lt;nsIMsgAccount&gt; loopAccount(do_QueryElementAt(accounts, i));</span>
<a href="#l14.24"></a><span id="l14.24">       if (!loopAccount)</span>
<a href="#l14.25"></a><span id="l14.25">         continue;</span>
<a href="#l14.26"></a><span id="l14.26">       nsAutoCString loopAccountKey;</span>
<a href="#l14.27"></a><span id="l14.27">       loopAccount-&gt;GetKey(loopAccountKey);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/base/test/unit/test_accountMgr.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_accountMgr.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -49,17 +49,17 @@ function run_test()</span>
<a href="#l15.4"></a><span id="l15.4">   Services.prefs.setCharPref(&quot;mail.accountmanager.accounts&quot;,</span>
<a href="#l15.5"></a><span id="l15.5">                              &quot;account1,account2,account4,account5,account5,account6&quot;);</span>
<a href="#l15.6"></a><span id="l15.6">   // Set the default account to one we're going to get rid of. The account</span>
<a href="#l15.7"></a><span id="l15.7">   //  manager should recover relatively gracefully.</span>
<a href="#l15.8"></a><span id="l15.8">   Services.prefs.setCharPref(&quot;mail.accountmanager.defaultaccount&quot;,</span>
<a href="#l15.9"></a><span id="l15.9">                              &quot;account6&quot;);</span>
<a href="#l15.10"></a><span id="l15.10"> </span>
<a href="#l15.11"></a><span id="l15.11">   // This will force the load of the accounts setup above.</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-  do_check_eq(am.accounts.Count(), 3);</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+  do_check_eq(am.accounts.length, 3);</span>
<a href="#l15.14"></a><span id="l15.14">   do_check_eq(Services.prefs.getCharPref(&quot;mail.accountmanager.accounts&quot;),</span>
<a href="#l15.15"></a><span id="l15.15">               &quot;account1,account4,account5&quot;);</span>
<a href="#l15.16"></a><span id="l15.16">   let server5 = am.getIncomingServer(&quot;server5&quot;)</span>
<a href="#l15.17"></a><span id="l15.17">                   .QueryInterface(Ci.nsIPop3IncomingServer);</span>
<a href="#l15.18"></a><span id="l15.18">   do_check_eq(server5.deferredToAccount, &quot;account1&quot;);</span>
<a href="#l15.19"></a><span id="l15.19"> </span>
<a href="#l15.20"></a><span id="l15.20">   // Just make sure this doesn't throw an exception, because we did remove the</span>
<a href="#l15.21"></a><span id="l15.21">   // default account.</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineat">@@ -71,17 +71,17 @@ function run_test()</span>
<a href="#l15.23"></a><span id="l15.23">   let server = am.getIncomingServer(&quot;server4&quot;);</span>
<a href="#l15.24"></a><span id="l15.24"> </span>
<a href="#l15.25"></a><span id="l15.25">   // We need to get the root folder to read from the folder cache</span>
<a href="#l15.26"></a><span id="l15.26">   // before it gets removed or else we'll assert, because we're</span>
<a href="#l15.27"></a><span id="l15.27">   // not completely initialized...</span>
<a href="#l15.28"></a><span id="l15.28">   let flags = server.rootFolder.flags;</span>
<a href="#l15.29"></a><span id="l15.29"> </span>
<a href="#l15.30"></a><span id="l15.30">   am.removeAccount(am.FindAccountForServer(server));</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineminus">-  do_check_eq(am.accounts.Count(), 2);</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineplus">+  do_check_eq(am.accounts.length, 2);</span>
<a href="#l15.33"></a><span id="l15.33">   do_check_eq(Services.prefs.getCharPref(&quot;mail.accountmanager.accounts&quot;),</span>
<a href="#l15.34"></a><span id="l15.34">               &quot;account1,account5&quot;);</span>
<a href="#l15.35"></a><span id="l15.35">   // make sure cleaning up duplicate accounts didn't hork accounts</span>
<a href="#l15.36"></a><span id="l15.36">   do_check_eq(Services.prefs.getCharPref(&quot;mail.account.account1.server&quot;),</span>
<a href="#l15.37"></a><span id="l15.37">               &quot;server1&quot;);</span>
<a href="#l15.38"></a><span id="l15.38">   do_check_eq(Services.prefs.getCharPref(&quot;mail.account.account5.server&quot;),</span>
<a href="#l15.39"></a><span id="l15.39">               &quot;server5&quot;);</span>
<a href="#l15.40"></a><span id="l15.40"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/base/test/unit/test_accountMgrCustomTypes.js</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_accountMgrCustomTypes.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -32,17 +32,17 @@ function run_test()</span>
<a href="#l16.4"></a><span id="l16.4">   Services.prefs.setIntPref(&quot;mail.server.server2.secondsToLeaveUnavailable&quot;, 2);</span>
<a href="#l16.5"></a><span id="l16.5"> </span>
<a href="#l16.6"></a><span id="l16.6">   Services.prefs.setCharPref(&quot;mail.accountmanager.accounts&quot;,</span>
<a href="#l16.7"></a><span id="l16.7">                              &quot;account1,account2&quot;);</span>
<a href="#l16.8"></a><span id="l16.8">   Services.prefs.setCharPref(&quot;mail.accountmanager.defaultaccount&quot;, &quot;account1&quot;);</span>
<a href="#l16.9"></a><span id="l16.9"> </span>
<a href="#l16.10"></a><span id="l16.10">   // This will force the load of the accounts setup above.</span>
<a href="#l16.11"></a><span id="l16.11">   // We don't see the invalid account</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-  do_check_eq(MailServices.accounts.accounts.Count(), 1);</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+  do_check_eq(MailServices.accounts.accounts.length, 1);</span>
<a href="#l16.14"></a><span id="l16.14"> </span>
<a href="#l16.15"></a><span id="l16.15">   // but it is really there</span>
<a href="#l16.16"></a><span id="l16.16">   do_check_eq(Services.prefs.getCharPref(&quot;mail.accountmanager.accounts&quot;),</span>
<a href="#l16.17"></a><span id="l16.17">               &quot;account1,account2&quot;);</span>
<a href="#l16.18"></a><span id="l16.18"> </span>
<a href="#l16.19"></a><span id="l16.19">   // add a new account (so that we can check if this clobbers the existing</span>
<a href="#l16.20"></a><span id="l16.20">   //  inactive account or its server)</span>
<a href="#l16.21"></a><span id="l16.21">   let newAccount = MailServices.accounts.createAccount();</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineat">@@ -51,34 +51,34 @@ function run_test()</span>
<a href="#l16.23"></a><span id="l16.23">   newAccount.defaultIdentity = newIdentity;</span>
<a href="#l16.24"></a><span id="l16.24">   newAccount.incomingServer =</span>
<a href="#l16.25"></a><span id="l16.25">     MailServices.accounts.createIncomingServer(&quot;somename&quot;, &quot;somehost.example.com&quot;, &quot;pop3&quot;);</span>
<a href="#l16.26"></a><span id="l16.26"> </span>
<a href="#l16.27"></a><span id="l16.27">   // no collisions with the inactive account</span>
<a href="#l16.28"></a><span id="l16.28">   do_check_neq(newIdentity.key, &quot;id2&quot;);</span>
<a href="#l16.29"></a><span id="l16.29">   do_check_neq(newAccount.incomingServer.key, &quot;server2&quot;);</span>
<a href="#l16.30"></a><span id="l16.30">   do_check_neq(newAccount.key, &quot;account2&quot;);</span>
<a href="#l16.31"></a><span id="l16.31" class="difflineminus">-  do_check_eq(MailServices.accounts.accounts.Count(), 2);</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineplus">+  do_check_eq(MailServices.accounts.accounts.length, 2);</span>
<a href="#l16.33"></a><span id="l16.33"> </span>
<a href="#l16.34"></a><span id="l16.34">   MailServices.accounts.UnloadAccounts();</span>
<a href="#l16.35"></a><span id="l16.35"> </span>
<a href="#l16.36"></a><span id="l16.36">   // set the unavailable account to a valid type, and watch it appear.</span>
<a href="#l16.37"></a><span id="l16.37">   Services.prefs.setCharPref(&quot;mail.server.server2.type&quot;, &quot;pop3&quot;);</span>
<a href="#l16.38"></a><span id="l16.38" class="difflineminus">-  do_check_eq(MailServices.accounts.accounts.Count(), 3);</span>
<a href="#l16.39"></a><span id="l16.39" class="difflineplus">+  do_check_eq(MailServices.accounts.accounts.length, 3);</span>
<a href="#l16.40"></a><span id="l16.40"> </span>
<a href="#l16.41"></a><span id="l16.41">   // make it bad again, and reload it to restart the timeout before delete</span>
<a href="#l16.42"></a><span id="l16.42">   MailServices.accounts.UnloadAccounts();</span>
<a href="#l16.43"></a><span id="l16.43">   Services.prefs.setCharPref(&quot;mail.server.server2.type&quot;, &quot;invalid&quot;);</span>
<a href="#l16.44"></a><span id="l16.44" class="difflineminus">-  do_check_eq(MailServices.accounts.accounts.Count(), 2);</span>
<a href="#l16.45"></a><span id="l16.45" class="difflineplus">+  do_check_eq(MailServices.accounts.accounts.length, 2);</span>
<a href="#l16.46"></a><span id="l16.46">   MailServices.accounts.UnloadAccounts();</span>
<a href="#l16.47"></a><span id="l16.47"> </span>
<a href="#l16.48"></a><span id="l16.48">   // now let the bad type timeout, and watch it magically disappear!</span>
<a href="#l16.49"></a><span id="l16.49">   do_test_pending();</span>
<a href="#l16.50"></a><span id="l16.50">   do_timeout(3000, function () {</span>
<a href="#l16.51"></a><span id="l16.51" class="difflineminus">-    do_check_eq(MailServices.accounts.accounts.Count(), 2);</span>
<a href="#l16.52"></a><span id="l16.52" class="difflineplus">+    do_check_eq(MailServices.accounts.accounts.length, 2);</span>
<a href="#l16.53"></a><span id="l16.53"> </span>
<a href="#l16.54"></a><span id="l16.54">     // it is now gone</span>
<a href="#l16.55"></a><span id="l16.55">     do_check_eq(Services.prefs.getCharPref(&quot;mail.accountmanager.accounts&quot;),</span>
<a href="#l16.56"></a><span id="l16.56">                 &quot;account1,&quot; + newAccount.key);</span>
<a href="#l16.57"></a><span id="l16.57"> </span>
<a href="#l16.58"></a><span id="l16.58">     do_test_finished();</span>
<a href="#l16.59"></a><span id="l16.59">   });</span>
<a href="#l16.60"></a><span id="l16.60"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/base/test/unit/test_acctRepair.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_acctRepair.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -31,16 +31,16 @@ function run_test()</span>
<a href="#l17.4"></a><span id="l17.4"> </span>
<a href="#l17.5"></a><span id="l17.5">   Services.prefs.setCharPref(&quot;mail.accountmanager.accounts&quot;, &quot;account6&quot;);</span>
<a href="#l17.6"></a><span id="l17.6">   Services.prefs.setCharPref(&quot;mail.accountmanager.defaultaccount&quot;,</span>
<a href="#l17.7"></a><span id="l17.7">                              &quot;account6&quot;);</span>
<a href="#l17.8"></a><span id="l17.8">   Services.prefs.setCharPref(&quot;mail.accountmanager.localfoldersserver&quot;,</span>
<a href="#l17.9"></a><span id="l17.9">                              &quot;server1&quot;);</span>
<a href="#l17.10"></a><span id="l17.10">   // This will force the load of the accounts setup above.</span>
<a href="#l17.11"></a><span id="l17.11">   // We should have created an account for the local folders.</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-  do_check_eq(am.accounts.Count(), 2);</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+  do_check_eq(am.accounts.length, 2);</span>
<a href="#l17.14"></a><span id="l17.14">   do_check_eq(Services.prefs.getCharPref(&quot;mail.accountmanager.accounts&quot;),</span>
<a href="#l17.15"></a><span id="l17.15">               &quot;account6,account7&quot;);</span>
<a href="#l17.16"></a><span id="l17.16">   do_check_eq(Services.prefs.getCharPref(&quot;mail.account.account7.server&quot;),</span>
<a href="#l17.17"></a><span id="l17.17">               &quot;server1&quot;);</span>
<a href="#l17.18"></a><span id="l17.18">   let server5 = am.getIncomingServer(&quot;server5&quot;).QueryInterface(Ci.nsIPop3IncomingServer);</span>
<a href="#l17.19"></a><span id="l17.19">   do_check_eq(server5.deferredToAccount, &quot;account7&quot;);</span>
<a href="#l17.20"></a><span id="l17.20"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/base/test/unit/test_fix_deferred_accounts.js</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_fix_deferred_accounts.js</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -41,16 +41,16 @@ function run_test()</span>
<a href="#l18.4"></a><span id="l18.4">   Services.prefs.setCharPref(&quot;mail.accountmanager.accounts&quot;,</span>
<a href="#l18.5"></a><span id="l18.5">                              &quot;account1,account2,account4,account5&quot;);</span>
<a href="#l18.6"></a><span id="l18.6">   // Set the default account to one we're going to get rid of. The account manager</span>
<a href="#l18.7"></a><span id="l18.7">   // should recover relatively gracefully.</span>
<a href="#l18.8"></a><span id="l18.8">   Services.prefs.setCharPref(&quot;mail.accountmanager.defaultaccount&quot;,</span>
<a href="#l18.9"></a><span id="l18.9">                              &quot;account1&quot;);</span>
<a href="#l18.10"></a><span id="l18.10"> </span>
<a href="#l18.11"></a><span id="l18.11">   // This will force the load of the accounts setup above.</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-  do_check_eq(am.accounts.Count(), 3); // hidden account not included</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+  do_check_eq(am.accounts.length, 3); // hidden account not included</span>
<a href="#l18.14"></a><span id="l18.14">   let server4 = am.getAccount(&quot;account4&quot;).incomingServer</span>
<a href="#l18.15"></a><span id="l18.15">                   .QueryInterface(Ci.nsIPop3IncomingServer);</span>
<a href="#l18.16"></a><span id="l18.16">   do_check_eq(server4.deferredToAccount, &quot;account1&quot;);</span>
<a href="#l18.17"></a><span id="l18.17">   let server5 = am.getAccount(&quot;account5&quot;).incomingServer</span>
<a href="#l18.18"></a><span id="l18.18">                   .QueryInterface(Ci.nsIPop3IncomingServer);</span>
<a href="#l18.19"></a><span id="l18.19">   do_check_eq(server5.deferredToAccount, &quot;account1&quot;);</span>
<a href="#l18.20"></a><span id="l18.20"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/base/test/unit/test_nsIMsgFolder.js</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_nsIMsgFolder.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -6,18 +6,17 @@</span>
<a href="#l19.4"></a><span id="l19.4"> function run_test() {</span>
<a href="#l19.5"></a><span id="l19.5">   var acctMgr = Components.classes[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l19.6"></a><span id="l19.6">                           .getService(Components.interfaces.nsIMsgAccountManager);</span>
<a href="#l19.7"></a><span id="l19.7"> </span>
<a href="#l19.8"></a><span id="l19.8">   // Create a local mail account (we need this first)</span>
<a href="#l19.9"></a><span id="l19.9">   acctMgr.createLocalMailAccount();</span>
<a href="#l19.10"></a><span id="l19.10"> </span>
<a href="#l19.11"></a><span id="l19.11">   // Get the account</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-  var account = acctMgr.accounts.GetElementAt(0)</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineminus">-                       .QueryInterface(Components.interfaces.nsIMsgAccount);</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineplus">+  var account = acctMgr.accounts.queryElementAt(0, Components.interfaces.nsIMsgAccount);</span>
<a href="#l19.15"></a><span id="l19.15"> </span>
<a href="#l19.16"></a><span id="l19.16">   // Get the root folder</span>
<a href="#l19.17"></a><span id="l19.17">   var root = account.incomingServer.rootFolder;</span>
<a href="#l19.18"></a><span id="l19.18"> </span>
<a href="#l19.19"></a><span id="l19.19">   // Add a sub folder to ensure that we have some folders created</span>
<a href="#l19.20"></a><span id="l19.20">   root.createSubfolder(&quot;folder1&quot;, null);</span>
<a href="#l19.21"></a><span id="l19.21"> </span>
<a href="#l19.22"></a><span id="l19.22">   // Test - getChildNamed</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/base/util/nsMsgIdentity.cpp</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgIdentity.cpp</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -17,16 +17,17 @@</span>
<a href="#l20.4"></a><span id="l20.4"> #include &quot;nsIMsgAccountManager.h&quot;</span>
<a href="#l20.5"></a><span id="l20.5"> #include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l20.6"></a><span id="l20.6"> #include &quot;prprf.h&quot;</span>
<a href="#l20.7"></a><span id="l20.7"> #include &quot;nsISupportsObsolete.h&quot;</span>
<a href="#l20.8"></a><span id="l20.8"> #include &quot;nsISupportsPrimitives.h&quot;</span>
<a href="#l20.9"></a><span id="l20.9"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l20.10"></a><span id="l20.10"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l20.11"></a><span id="l20.11"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineplus">+#include &quot;nsArrayUtils.h&quot;</span>
<a href="#l20.13"></a><span id="l20.13"> </span>
<a href="#l20.14"></a><span id="l20.14"> static NS_DEFINE_CID(kRDFServiceCID, NS_RDFSERVICE_CID);</span>
<a href="#l20.15"></a><span id="l20.15"> </span>
<a href="#l20.16"></a><span id="l20.16"> #define REL_FILE_PREF_SUFFIX &quot;-rel&quot;</span>
<a href="#l20.17"></a><span id="l20.17"> </span>
<a href="#l20.18"></a><span id="l20.18"> NS_IMPL_THREADSAFE_ISUPPORTS1(nsMsgIdentity,</span>
<a href="#l20.19"></a><span id="l20.19">                    nsIMsgIdentity)</span>
<a href="#l20.20"></a><span id="l20.20"> </span>
<a href="#l20.21"></a><span id="l20.21" class="difflineat">@@ -305,17 +306,17 @@ nsMsgIdentity::getFolderPref(const char </span>
<a href="#l20.22"></a><span id="l20.22">     return setFolderPref(prefname, retval, folderflag);</span>
<a href="#l20.23"></a><span id="l20.23"> </span>
<a href="#l20.24"></a><span id="l20.24">   // here I think we need to create a uri for the folder on the</span>
<a href="#l20.25"></a><span id="l20.25">   // default server for this identity.</span>
<a href="#l20.26"></a><span id="l20.26">   nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l20.27"></a><span id="l20.27">   do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l20.28"></a><span id="l20.28">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l20.29"></a><span id="l20.29"> </span>
<a href="#l20.30"></a><span id="l20.30" class="difflineminus">-  nsCOMPtr&lt;nsISupportsArray&gt; servers;</span>
<a href="#l20.31"></a><span id="l20.31" class="difflineplus">+  nsCOMPtr&lt;nsIArray&gt; servers;</span>
<a href="#l20.32"></a><span id="l20.32">   rv = accountManager-&gt;GetServersForIdentity(this, getter_AddRefs(servers));</span>
<a href="#l20.33"></a><span id="l20.33">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l20.34"></a><span id="l20.34">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server(do_QueryElementAt(servers, 0, &amp;rv));</span>
<a href="#l20.35"></a><span id="l20.35">   if (NS_SUCCEEDED(rv))</span>
<a href="#l20.36"></a><span id="l20.36">   {</span>
<a href="#l20.37"></a><span id="l20.37">     bool defaultToServer;</span>
<a href="#l20.38"></a><span id="l20.38">     server-&gt;GetDefaultCopiesAndFoldersPrefsToServer(&amp;defaultToServer);</span>
<a href="#l20.39"></a><span id="l20.39">     // if we should default to special folders on the server,</span>
<a href="#l20.40"></a><span id="l20.40" class="difflineat">@@ -358,21 +359,21 @@ nsMsgIdentity::setFolderPref(const char </span>
<a href="#l20.41"></a><span id="l20.41">   if (folderflag == nsMsgFolderFlags::SentMail)</span>
<a href="#l20.42"></a><span id="l20.42">   {</span>
<a href="#l20.43"></a><span id="l20.43">     // Clear the temporary return receipt filter so that the new filter</span>
<a href="#l20.44"></a><span id="l20.44">     // rule can be recreated (by ConfigureTemporaryFilters()).</span>
<a href="#l20.45"></a><span id="l20.45">     nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l20.46"></a><span id="l20.46">       do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l20.47"></a><span id="l20.47">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l20.48"></a><span id="l20.48"> </span>
<a href="#l20.49"></a><span id="l20.49" class="difflineminus">-    nsCOMPtr&lt;nsISupportsArray&gt; servers;</span>
<a href="#l20.50"></a><span id="l20.50" class="difflineplus">+    nsCOMPtr&lt;nsIArray&gt; servers;</span>
<a href="#l20.51"></a><span id="l20.51">     rv = accountManager-&gt;GetServersForIdentity(this, getter_AddRefs(servers));</span>
<a href="#l20.52"></a><span id="l20.52">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l20.53"></a><span id="l20.53">     uint32_t cnt = 0;</span>
<a href="#l20.54"></a><span id="l20.54" class="difflineminus">-    servers-&gt;Count(&amp;cnt);</span>
<a href="#l20.55"></a><span id="l20.55" class="difflineplus">+    servers-&gt;GetLength(&amp;cnt);</span>
<a href="#l20.56"></a><span id="l20.56">     if (cnt &gt; 0)</span>
<a href="#l20.57"></a><span id="l20.57">     {</span>
<a href="#l20.58"></a><span id="l20.58">       nsCOMPtr&lt;nsIMsgIncomingServer&gt; server(do_QueryElementAt(servers, 0, &amp;rv));</span>
<a href="#l20.59"></a><span id="l20.59">       if (NS_SUCCEEDED(rv))</span>
<a href="#l20.60"></a><span id="l20.60">         server-&gt;ClearTemporaryReturnReceiptsFilter(); // okay to fail; no need to check for return code</span>
<a href="#l20.61"></a><span id="l20.61">     }</span>
<a href="#l20.62"></a><span id="l20.62">   }</span>
<a href="#l20.63"></a><span id="l20.63"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgCopy.cpp</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgCopy.cpp</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -5,17 +5,16 @@</span>
<a href="#l21.4"></a><span id="l21.4"> #include &quot;nsMsgCopy.h&quot;</span>
<a href="#l21.5"></a><span id="l21.5"> </span>
<a href="#l21.6"></a><span id="l21.6"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l21.7"></a><span id="l21.7"> #include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l21.8"></a><span id="l21.8"> #include &quot;nsMsgFolderFlags.h&quot;</span>
<a href="#l21.9"></a><span id="l21.9"> #include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l21.10"></a><span id="l21.10"> #include &quot;nsIMsgAccountManager.h&quot;</span>
<a href="#l21.11"></a><span id="l21.11"> #include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-#include &quot;nsISupportsArray.h&quot;</span>
<a href="#l21.13"></a><span id="l21.13"> #include &quot;nsIMsgIncomingServer.h&quot;</span>
<a href="#l21.14"></a><span id="l21.14"> #include &quot;nsISupports.h&quot;</span>
<a href="#l21.15"></a><span id="l21.15"> #include &quot;nsIRDFService.h&quot;</span>
<a href="#l21.16"></a><span id="l21.16"> #include &quot;nsIRDFResource.h&quot;</span>
<a href="#l21.17"></a><span id="l21.17"> #include &quot;nsRDFCID.h&quot;</span>
<a href="#l21.18"></a><span id="l21.18"> #include &quot;nsIURL.h&quot;</span>
<a href="#l21.19"></a><span id="l21.19"> #include &quot;nsNetCID.h&quot;</span>
<a href="#l21.20"></a><span id="l21.20"> #include &quot;nsMsgCompUtils.h&quot;</span>
<a href="#l21.21"></a><span id="l21.21" class="difflineat">@@ -24,16 +23,17 @@</span>
<a href="#l21.22"></a><span id="l21.22"> #include &quot;nsThreadUtils.h&quot;</span>
<a href="#l21.23"></a><span id="l21.23"> #include &quot;nsIMsgWindow.h&quot;</span>
<a href="#l21.24"></a><span id="l21.24"> #include &quot;nsIMsgProgress.h&quot;</span>
<a href="#l21.25"></a><span id="l21.25"> #include &quot;nsComposeStrings.h&quot;</span>
<a href="#l21.26"></a><span id="l21.26"> #include &quot;prmem.h&quot;</span>
<a href="#l21.27"></a><span id="l21.27"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l21.28"></a><span id="l21.28"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l21.29"></a><span id="l21.29"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l21.30"></a><span id="l21.30" class="difflineplus">+#include &quot;nsArrayUtils.h&quot;</span>
<a href="#l21.31"></a><span id="l21.31"> </span>
<a href="#l21.32"></a><span id="l21.32"> static NS_DEFINE_CID(kRDFServiceCID, NS_RDFSERVICE_CID);</span>
<a href="#l21.33"></a><span id="l21.33"> </span>
<a href="#l21.34"></a><span id="l21.34"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l21.35"></a><span id="l21.35"> // This is the listener class for the copy operation. We have to create this class</span>
<a href="#l21.36"></a><span id="l21.36"> // to listen for message copy completion and eventually notify the caller</span>
<a href="#l21.37"></a><span id="l21.37"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l21.38"></a><span id="l21.38"> NS_IMPL_THREADSAFE_ADDREF(CopyListener)</span>
<a href="#l21.39"></a><span id="l21.39" class="difflineat">@@ -445,24 +445,24 @@ LocateMessageFolder(nsIMsgIdentity   *us</span>
<a href="#l21.40"></a><span id="l21.40">     if (!userIdentity)</span>
<a href="#l21.41"></a><span id="l21.41">       return NS_ERROR_INVALID_ARG;</span>
<a href="#l21.42"></a><span id="l21.42"> </span>
<a href="#l21.43"></a><span id="l21.43">     // get the account manager</span>
<a href="#l21.44"></a><span id="l21.44">     nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l21.45"></a><span id="l21.45">              do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l21.46"></a><span id="l21.46">     if (NS_FAILED(rv)) return rv;</span>
<a href="#l21.47"></a><span id="l21.47"> </span>
<a href="#l21.48"></a><span id="l21.48" class="difflineminus">-    // if anyfolder will do, go look for one.</span>
<a href="#l21.49"></a><span id="l21.49" class="difflineminus">-    nsCOMPtr&lt;nsISupportsArray&gt; retval;</span>
<a href="#l21.50"></a><span id="l21.50" class="difflineplus">+    // If any folder will do, go look for one.</span>
<a href="#l21.51"></a><span id="l21.51" class="difflineplus">+    nsCOMPtr&lt;nsIArray&gt; retval;</span>
<a href="#l21.52"></a><span id="l21.52">     accountManager-&gt;GetServersForIdentity(userIdentity, getter_AddRefs(retval));</span>
<a href="#l21.53"></a><span id="l21.53">     if (!retval) return NS_ERROR_FAILURE;</span>
<a href="#l21.54"></a><span id="l21.54"> </span>
<a href="#l21.55"></a><span id="l21.55">     // Ok, we have to look through the servers and try to find the server that</span>
<a href="#l21.56"></a><span id="l21.56">     // has a valid folder of the type that interests us...</span>
<a href="#l21.57"></a><span id="l21.57" class="difflineminus">-    rv = retval-&gt;Count(&amp;cnt);</span>
<a href="#l21.58"></a><span id="l21.58" class="difflineplus">+    rv = retval-&gt;GetLength(&amp;cnt);</span>
<a href="#l21.59"></a><span id="l21.59">     if (NS_FAILED(rv)) return rv;</span>
<a href="#l21.60"></a><span id="l21.60"> </span>
<a href="#l21.61"></a><span id="l21.61">     for (i=0; i&lt;cnt; i++) {</span>
<a href="#l21.62"></a><span id="l21.62">       // Now that we have the server...we need to get the named message folder</span>
<a href="#l21.63"></a><span id="l21.63">       nsCOMPtr&lt;nsIMsgIncomingServer&gt; inServer;</span>
<a href="#l21.64"></a><span id="l21.64"> </span>
<a href="#l21.65"></a><span id="l21.65">       inServer = do_QueryElementAt(retval, i, &amp;rv);</span>
<a href="#l21.66"></a><span id="l21.66">       if(NS_FAILED(rv) || (!inServer))</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgSendLater.cpp</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgSendLater.cpp</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -701,22 +701,22 @@ nsMsgSendLater::HasUnsentMessages(nsIMsg</span>
<a href="#l22.4"></a><span id="l22.4"> {</span>
<a href="#l22.5"></a><span id="l22.5">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l22.6"></a><span id="l22.6">   nsresult rv;</span>
<a href="#l22.7"></a><span id="l22.7"> </span>
<a href="#l22.8"></a><span id="l22.8">   nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l22.9"></a><span id="l22.9">     do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l22.10"></a><span id="l22.10">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.11"></a><span id="l22.11"> </span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-  nsCOMPtr&lt;nsISupportsArray&gt; accounts;</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineplus">+  nsCOMPtr&lt;nsIArray&gt; accounts;</span>
<a href="#l22.14"></a><span id="l22.14">   accountManager-&gt;GetAccounts(getter_AddRefs(accounts));</span>
<a href="#l22.15"></a><span id="l22.15">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.16"></a><span id="l22.16"> </span>
<a href="#l22.17"></a><span id="l22.17">   uint32_t cnt = 0;</span>
<a href="#l22.18"></a><span id="l22.18" class="difflineminus">-  rv = accounts-&gt;Count(&amp;cnt);</span>
<a href="#l22.19"></a><span id="l22.19" class="difflineplus">+  rv = accounts-&gt;GetLength(&amp;cnt);</span>
<a href="#l22.20"></a><span id="l22.20">   if (cnt == 0) {</span>
<a href="#l22.21"></a><span id="l22.21">     *aResult = false;</span>
<a href="#l22.22"></a><span id="l22.22">     return NS_OK; // no account set up -&gt; no unsent messages</span>
<a href="#l22.23"></a><span id="l22.23">   }</span>
<a href="#l22.24"></a><span id="l22.24"> </span>
<a href="#l22.25"></a><span id="l22.25">   // XXX This code should be set up for multiple unsent folders, however we</span>
<a href="#l22.26"></a><span id="l22.26">   // don't support that at the moment, so for now just assume one folder.</span>
<a href="#l22.27"></a><span id="l22.27">   if (!mMessageFolder)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mailnews/imap/src/nsAutoSyncManager.cpp</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mailnews/imap/src/nsAutoSyncManager.cpp</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -18,16 +18,17 @@</span>
<a href="#l23.4"></a><span id="l23.4"> #include &quot;nsIMsgMailSession.h&quot;</span>
<a href="#l23.5"></a><span id="l23.5"> #include &quot;nsMsgFolderFlags.h&quot;</span>
<a href="#l23.6"></a><span id="l23.6"> #include &quot;nsImapIncomingServer.h&quot;</span>
<a href="#l23.7"></a><span id="l23.7"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l23.8"></a><span id="l23.8"> #include &quot;nsIIOService.h&quot;</span>
<a href="#l23.9"></a><span id="l23.9"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l23.10"></a><span id="l23.10"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l23.11"></a><span id="l23.11"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineplus">+#include &quot;nsArrayUtils.h&quot;</span>
<a href="#l23.13"></a><span id="l23.13"> </span>
<a href="#l23.14"></a><span id="l23.14"> NS_IMPL_ISUPPORTS1(nsDefaultAutoSyncMsgStrategy, nsIAutoSyncMsgStrategy)</span>
<a href="#l23.15"></a><span id="l23.15"> </span>
<a href="#l23.16"></a><span id="l23.16"> const char* kAppIdleNotification = &quot;mail:appIdle&quot;;</span>
<a href="#l23.17"></a><span id="l23.17"> const char* kStartupDoneNotification = &quot;mail-startup-done&quot;;</span>
<a href="#l23.18"></a><span id="l23.18"> PRLogModuleInfo *gAutoSyncLog;</span>
<a href="#l23.19"></a><span id="l23.19"> </span>
<a href="#l23.20"></a><span id="l23.20"> // recommended size of each group of messages per download</span>
<a href="#l23.21"></a><span id="l23.21" class="difflineat">@@ -736,22 +737,22 @@ nsresult nsAutoSyncManager::AutoUpdateFo</span>
<a href="#l23.22"></a><span id="l23.22"> {</span>
<a href="#l23.23"></a><span id="l23.23">   nsresult rv;</span>
<a href="#l23.24"></a><span id="l23.24"> </span>
<a href="#l23.25"></a><span id="l23.25">   // iterate through each imap account and update offline folders automatically</span>
<a href="#l23.26"></a><span id="l23.26"> </span>
<a href="#l23.27"></a><span id="l23.27">   nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager = do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l23.28"></a><span id="l23.28">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l23.29"></a><span id="l23.29"> </span>
<a href="#l23.30"></a><span id="l23.30" class="difflineminus">-  nsCOMPtr&lt;nsISupportsArray&gt; accounts;</span>
<a href="#l23.31"></a><span id="l23.31" class="difflineplus">+  nsCOMPtr&lt;nsIArray&gt; accounts;</span>
<a href="#l23.32"></a><span id="l23.32">   rv = accountManager-&gt;GetAccounts(getter_AddRefs(accounts));</span>
<a href="#l23.33"></a><span id="l23.33">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l23.34"></a><span id="l23.34"> </span>
<a href="#l23.35"></a><span id="l23.35">   uint32_t accountCount;</span>
<a href="#l23.36"></a><span id="l23.36" class="difflineminus">-  accounts-&gt;Count(&amp;accountCount);</span>
<a href="#l23.37"></a><span id="l23.37" class="difflineplus">+  accounts-&gt;GetLength(&amp;accountCount);</span>
<a href="#l23.38"></a><span id="l23.38"> </span>
<a href="#l23.39"></a><span id="l23.39">   for (uint32_t i = 0; i &lt; accountCount; ++i) </span>
<a href="#l23.40"></a><span id="l23.40">   {</span>
<a href="#l23.41"></a><span id="l23.41">     nsCOMPtr&lt;nsIMsgAccount&gt; account(do_QueryElementAt(accounts, i, &amp;rv));</span>
<a href="#l23.42"></a><span id="l23.42">     if (!account)</span>
<a href="#l23.43"></a><span id="l23.43">       continue;</span>
<a href="#l23.44"></a><span id="l23.44"> </span>
<a href="#l23.45"></a><span id="l23.45">     nsCOMPtr&lt;nsIMsgIncomingServer&gt; incomingServer;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mailnews/import/test/unit/resources/import_helper.js</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mailnews/import/test/unit/resources/import_helper.js</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -427,18 +427,18 @@ SettingsImportHelper.prototype =</span>
<a href="#l24.4"></a><span id="l24.4">       do_check_eq(true, this.mInterface.AutoLocate({}, {}));</span>
<a href="#l24.5"></a><span id="l24.5">     do_check_eq(true, this.mInterface.Import({}));</span>
<a href="#l24.6"></a><span id="l24.6">     this.checkResults();</span>
<a href="#l24.7"></a><span id="l24.7">   },</span>
<a href="#l24.8"></a><span id="l24.8"> </span>
<a href="#l24.9"></a><span id="l24.9">   _ensureNoAccounts: function() {</span>
<a href="#l24.10"></a><span id="l24.10">     let accounts = MailServices.accounts.accounts;</span>
<a href="#l24.11"></a><span id="l24.11"> </span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-    for (let i = 0; i &lt; accounts.Count(); i++) {</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineminus">-      let account = accounts.QueryElementAt(i, Ci.nsIMsgAccount);</span>
<a href="#l24.14"></a><span id="l24.14" class="difflineplus">+    for (let i = 0; i &lt; accounts.length; i++) {</span>
<a href="#l24.15"></a><span id="l24.15" class="difflineplus">+      let account = accounts.queryElementAt(i, Ci.nsIMsgAccount);</span>
<a href="#l24.16"></a><span id="l24.16">       MailServices.accounts.removeAccount(account);</span>
<a href="#l24.17"></a><span id="l24.17">     }</span>
<a href="#l24.18"></a><span id="l24.18">   },</span>
<a href="#l24.19"></a><span id="l24.19"> </span>
<a href="#l24.20"></a><span id="l24.20">   _checkSmtpServer: function(expected, actual) {</span>
<a href="#l24.21"></a><span id="l24.21">     do_check_eq(expected.port, actual.port);</span>
<a href="#l24.22"></a><span id="l24.22">     do_check_eq(expected.username, actual.username);</span>
<a href="#l24.23"></a><span id="l24.23">     do_check_eq(expected.authMethod, actual.authMethod);</span>
<a href="#l24.24"></a><span id="l24.24" class="difflineat">@@ -499,18 +499,18 @@ SettingsImportHelper.prototype =</span>
<a href="#l24.25"></a><span id="l24.25">       return (expectedAccount.incomingServer.type == account.incomingServer.type &amp;&amp;</span>
<a href="#l24.26"></a><span id="l24.26">               expectedAccount.incomingServer.username == account.incomingServer.username &amp;&amp;</span>
<a href="#l24.27"></a><span id="l24.27">               expectedAccount.incomingServer.hostName == account.incomingServer.hostName);</span>
<a href="#l24.28"></a><span id="l24.28">     });</span>
<a href="#l24.29"></a><span id="l24.29">   },</span>
<a href="#l24.30"></a><span id="l24.30"> </span>
<a href="#l24.31"></a><span id="l24.31">   checkResults: function() {</span>
<a href="#l24.32"></a><span id="l24.32">     accounts = MailServices.accounts.accounts;</span>
<a href="#l24.33"></a><span id="l24.33" class="difflineminus">-    for (let i = 0; i &lt; accounts.Count() - 1; i++) {</span>
<a href="#l24.34"></a><span id="l24.34" class="difflineminus">-      let actualAccount = accounts.QueryElementAt(i, Ci.nsIMsgAccount);</span>
<a href="#l24.35"></a><span id="l24.35" class="difflineplus">+    for (let i = 0; i &lt; accounts.length - 1; i++) {</span>
<a href="#l24.36"></a><span id="l24.36" class="difflineplus">+      let actualAccount = accounts.queryElementAt(i, Ci.nsIMsgAccount);</span>
<a href="#l24.37"></a><span id="l24.37">       if (this._isLocalMailAccount(actualAccount))</span>
<a href="#l24.38"></a><span id="l24.38">         continue;</span>
<a href="#l24.39"></a><span id="l24.39">       let expectedAccounts = this._findExpectedAccount(actualAccount);</span>
<a href="#l24.40"></a><span id="l24.40">       do_check_neq(null, expectedAccounts);</span>
<a href="#l24.41"></a><span id="l24.41">       do_check_eq(1, expectedAccounts.length);</span>
<a href="#l24.42"></a><span id="l24.42">       this._checkAccount(expectedAccounts[0], actualAccount);</span>
<a href="#l24.43"></a><span id="l24.43">     }</span>
<a href="#l24.44"></a><span id="l24.44">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mailnews/local/test/unit/test_nsIMsgLocalMailFolder.js</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mailnews/local/test/unit/test_nsIMsgLocalMailFolder.js</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -8,18 +8,17 @@ load(&quot;../../../resources/messageGenerato</span>
<a href="#l25.4"></a><span id="l25.4"> function run_test() {</span>
<a href="#l25.5"></a><span id="l25.5">   var acctMgr = Components.classes[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l25.6"></a><span id="l25.6">                           .getService(Components.interfaces.nsIMsgAccountManager);</span>
<a href="#l25.7"></a><span id="l25.7"> </span>
<a href="#l25.8"></a><span id="l25.8">   // Create a local mail account (we need this first)</span>
<a href="#l25.9"></a><span id="l25.9">   acctMgr.createLocalMailAccount();</span>
<a href="#l25.10"></a><span id="l25.10"> </span>
<a href="#l25.11"></a><span id="l25.11">   // Get the account</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-  var account = acctMgr.accounts.GetElementAt(0)</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineminus">-                       .QueryInterface(Components.interfaces.nsIMsgAccount);</span>
<a href="#l25.14"></a><span id="l25.14" class="difflineplus">+  var account = acctMgr.accounts.queryElementAt(0, Components.interfaces.nsIMsgAccount);</span>
<a href="#l25.15"></a><span id="l25.15"> </span>
<a href="#l25.16"></a><span id="l25.16">   // Get the root folder</span>
<a href="#l25.17"></a><span id="l25.17">   var root = account.incomingServer.rootFolder.QueryInterface(Ci.nsIMsgLocalMailFolder);</span>
<a href="#l25.18"></a><span id="l25.18"> </span>
<a href="#l25.19"></a><span id="l25.19">   // Give it a poke so that the directories all exist</span>
<a href="#l25.20"></a><span id="l25.20">   root.subFolders;</span>
<a href="#l25.21"></a><span id="l25.21"> </span>
<a href="#l25.22"></a><span id="l25.22">   // Test - num/hasSubFolders</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/suite/mailnews/tabmail.js</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/suite/mailnews/tabmail.js</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -394,17 +394,17 @@ var gMailNewsTabsType =</span>
<a href="#l26.4"></a><span id="l26.4">     aTabInfo.searchInput = GetSearchInput().value;</span>
<a href="#l26.5"></a><span id="l26.5">   },</span>
<a href="#l26.6"></a><span id="l26.6"> </span>
<a href="#l26.7"></a><span id="l26.7">   onTitleChanged: function(aTabInfo, aTabNode)</span>
<a href="#l26.8"></a><span id="l26.8">   {</span>
<a href="#l26.9"></a><span id="l26.9">     // If we have an account, we also always have a &quot;Local Folders&quot; account,</span>
<a href="#l26.10"></a><span id="l26.10">     let accountCount = Components.classes[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l26.11"></a><span id="l26.11">                                  .getService(Components.interfaces.nsIMsgAccountManager)</span>
<a href="#l26.12"></a><span id="l26.12" class="difflineminus">-                                 .accounts.Count();</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineplus">+                                 .accounts.length;</span>
<a href="#l26.14"></a><span id="l26.14">     let multipleRealAccounts = accountCount &gt; 2;</span>
<a href="#l26.15"></a><span id="l26.15"> </span>
<a href="#l26.16"></a><span id="l26.16">     // clear out specific tab data now, because we might need to return early</span>
<a href="#l26.17"></a><span id="l26.17">     aTabNode.removeAttribute(&quot;SpecialFolder&quot;);</span>
<a href="#l26.18"></a><span id="l26.18">     aTabNode.removeAttribute(&quot;ServerType&quot;);</span>
<a href="#l26.19"></a><span id="l26.19">     aTabNode.removeAttribute(&quot;IsServer&quot;);</span>
<a href="#l26.20"></a><span id="l26.20">     aTabNode.removeAttribute(&quot;IsSecure&quot;);</span>
<a href="#l26.21"></a><span id="l26.21">     aTabNode.removeAttribute(&quot;NewMessages&quot;);</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

