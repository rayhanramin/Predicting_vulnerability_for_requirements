<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 28587:7ed85c4ae6bf85b278c73cbced91bb829a0c93fa</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 7ed85c4ae6bf85b278c73cbced91bb829a0c93fa" />
<meta property="og:url" content="/comm-central/rev/7ed85c4ae6bf85b278c73cbced91bb829a0c93fa" />
<meta property="og:description" content="Bug 1226362 - Use HTML Drag and Drop API in Messenger. r=mkmelin" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 7ed85c4ae6bf85b278c73cbced91bb829a0c93fa 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/7ed85c4ae6bf85b278c73cbced91bb829a0c93fa">shortlog</a> |
<a href="/comm-central/log/7ed85c4ae6bf85b278c73cbced91bb829a0c93fa">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/7ed85c4ae6bf85b278c73cbced91bb829a0c93fa">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/7ed85c4ae6bf85b278c73cbced91bb829a0c93fa">files</a> |
changeset |
<a href="/comm-central/raw-rev/7ed85c4ae6bf85b278c73cbced91bb829a0c93fa">raw</a>  | <a href="/comm-central/archive/7ed85c4ae6bf85b278c73cbced91bb829a0c93fa.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1226362">Bug 1226362</a> - Use HTML Drag and Drop API in Messenger. r=mkmelin
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#75;&#104;&#117;&#115;&#104;&#105;&#108;&#32;&#77;&#105;&#115;&#116;&#114;&#121;&#32;&#60;&#107;&#104;&#117;&#115;&#104;&#105;&#108;&#51;&#50;&#52;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Sat, 25 Jan 2020 16:10:25 +0200</td></tr>

<tr>
 <td>changeset 28587</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/7ed85c4ae6bf85b278c73cbced91bb829a0c93fa">7ed85c4ae6bf85b278c73cbced91bb829a0c93fa</a></td>
</tr>



<tr>
<td>parent 28586</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/3b281b9a0b409202fd555893700881cfc1e65ce4">3b281b9a0b409202fd555893700881cfc1e65ce4</a>
</td>
</tr>

<tr>
<td>child 28588</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/4e33fd9bc7b6cb8a04c50c1993b8e3f9184b0b9b">4e33fd9bc7b6cb8a04c50c1993b8e3f9184b0b9b</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=7ed85c4ae6bf85b278c73cbced91bb829a0c93fa">16944</a></td></tr>
<tr><td>push user</td><td>mkmelin@iki.fi</td></tr>
<tr><td>push date</td><td class="date age">Sat, 25 Jan 2020 17:25:22 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@4e33fd9bc7b6 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=4e33fd9bc7b6cb8a04c50c1993b8e3f9184b0b9b">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=4e33fd9bc7b6cb8a04c50c1993b8e3f9184b0b9b&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=4e33fd9bc7b6cb8a04c50c1993b8e3f9184b0b9b&newProject=comm-central&newRevision=7ed85c4ae6bf85b278c73cbced91bb829a0c93fa&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=4e33fd9bc7b6cb8a04c50c1993b8e3f9184b0b9b&newProject=comm-central&newRevision=7ed85c4ae6bf85b278c73cbced91bb829a0c93fa&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=4e33fd9bc7b6cb8a04c50c1993b8e3f9184b0b9b&newProject=comm-central&newRevision=7ed85c4ae6bf85b278c73cbced91bb829a0c93fa&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mkmelin%29&revcount=50">mkmelin</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1226362">1226362</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1226362">Bug 1226362</a> - Use HTML Drag and Drop API in Messenger. r=mkmelin</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7ed85c4ae6bf85b278c73cbced91bb829a0c93fa/mail/base/content/mailCore.js">mail/base/content/mailCore.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7ed85c4ae6bf85b278c73cbced91bb829a0c93fa/mail/base/content/mailCore.js">file</a> |
<a href="/comm-central/annotate/7ed85c4ae6bf85b278c73cbced91bb829a0c93fa/mail/base/content/mailCore.js">annotate</a> |
<a href="/comm-central/diff/7ed85c4ae6bf85b278c73cbced91bb829a0c93fa/mail/base/content/mailCore.js">diff</a> |
<a href="/comm-central/comparison/7ed85c4ae6bf85b278c73cbced91bb829a0c93fa/mail/base/content/mailCore.js">comparison</a> |
<a href="/comm-central/log/7ed85c4ae6bf85b278c73cbced91bb829a0c93fa/mail/base/content/mailCore.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7ed85c4ae6bf85b278c73cbced91bb829a0c93fa/mail/base/content/messageWindow.js">mail/base/content/messageWindow.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7ed85c4ae6bf85b278c73cbced91bb829a0c93fa/mail/base/content/messageWindow.js">file</a> |
<a href="/comm-central/annotate/7ed85c4ae6bf85b278c73cbced91bb829a0c93fa/mail/base/content/messageWindow.js">annotate</a> |
<a href="/comm-central/diff/7ed85c4ae6bf85b278c73cbced91bb829a0c93fa/mail/base/content/messageWindow.js">diff</a> |
<a href="/comm-central/comparison/7ed85c4ae6bf85b278c73cbced91bb829a0c93fa/mail/base/content/messageWindow.js">comparison</a> |
<a href="/comm-central/log/7ed85c4ae6bf85b278c73cbced91bb829a0c93fa/mail/base/content/messageWindow.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7ed85c4ae6bf85b278c73cbced91bb829a0c93fa/mail/base/content/messageWindow.xhtml">mail/base/content/messageWindow.xhtml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7ed85c4ae6bf85b278c73cbced91bb829a0c93fa/mail/base/content/messageWindow.xhtml">file</a> |
<a href="/comm-central/annotate/7ed85c4ae6bf85b278c73cbced91bb829a0c93fa/mail/base/content/messageWindow.xhtml">annotate</a> |
<a href="/comm-central/diff/7ed85c4ae6bf85b278c73cbced91bb829a0c93fa/mail/base/content/messageWindow.xhtml">diff</a> |
<a href="/comm-central/comparison/7ed85c4ae6bf85b278c73cbced91bb829a0c93fa/mail/base/content/messageWindow.xhtml">comparison</a> |
<a href="/comm-central/log/7ed85c4ae6bf85b278c73cbced91bb829a0c93fa/mail/base/content/messageWindow.xhtml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7ed85c4ae6bf85b278c73cbced91bb829a0c93fa/mail/base/content/messenger.xhtml">mail/base/content/messenger.xhtml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7ed85c4ae6bf85b278c73cbced91bb829a0c93fa/mail/base/content/messenger.xhtml">file</a> |
<a href="/comm-central/annotate/7ed85c4ae6bf85b278c73cbced91bb829a0c93fa/mail/base/content/messenger.xhtml">annotate</a> |
<a href="/comm-central/diff/7ed85c4ae6bf85b278c73cbced91bb829a0c93fa/mail/base/content/messenger.xhtml">diff</a> |
<a href="/comm-central/comparison/7ed85c4ae6bf85b278c73cbced91bb829a0c93fa/mail/base/content/messenger.xhtml">comparison</a> |
<a href="/comm-central/log/7ed85c4ae6bf85b278c73cbced91bb829a0c93fa/mail/base/content/messenger.xhtml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7ed85c4ae6bf85b278c73cbced91bb829a0c93fa/mail/base/content/msgAttachmentView.inc.xhtml">mail/base/content/msgAttachmentView.inc.xhtml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7ed85c4ae6bf85b278c73cbced91bb829a0c93fa/mail/base/content/msgAttachmentView.inc.xhtml">file</a> |
<a href="/comm-central/annotate/7ed85c4ae6bf85b278c73cbced91bb829a0c93fa/mail/base/content/msgAttachmentView.inc.xhtml">annotate</a> |
<a href="/comm-central/diff/7ed85c4ae6bf85b278c73cbced91bb829a0c93fa/mail/base/content/msgAttachmentView.inc.xhtml">diff</a> |
<a href="/comm-central/comparison/7ed85c4ae6bf85b278c73cbced91bb829a0c93fa/mail/base/content/msgAttachmentView.inc.xhtml">comparison</a> |
<a href="/comm-central/log/7ed85c4ae6bf85b278c73cbced91bb829a0c93fa/mail/base/content/msgAttachmentView.inc.xhtml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7ed85c4ae6bf85b278c73cbced91bb829a0c93fa/mail/base/content/msgHdrView.js">mail/base/content/msgHdrView.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7ed85c4ae6bf85b278c73cbced91bb829a0c93fa/mail/base/content/msgHdrView.js">file</a> |
<a href="/comm-central/annotate/7ed85c4ae6bf85b278c73cbced91bb829a0c93fa/mail/base/content/msgHdrView.js">annotate</a> |
<a href="/comm-central/diff/7ed85c4ae6bf85b278c73cbced91bb829a0c93fa/mail/base/content/msgHdrView.js">diff</a> |
<a href="/comm-central/comparison/7ed85c4ae6bf85b278c73cbced91bb829a0c93fa/mail/base/content/msgHdrView.js">comparison</a> |
<a href="/comm-central/log/7ed85c4ae6bf85b278c73cbced91bb829a0c93fa/mail/base/content/msgHdrView.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7ed85c4ae6bf85b278c73cbced91bb829a0c93fa/mail/components/compose/content/MsgComposeCommands.js">mail/components/compose/content/MsgComposeCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7ed85c4ae6bf85b278c73cbced91bb829a0c93fa/mail/components/compose/content/MsgComposeCommands.js">file</a> |
<a href="/comm-central/annotate/7ed85c4ae6bf85b278c73cbced91bb829a0c93fa/mail/components/compose/content/MsgComposeCommands.js">annotate</a> |
<a href="/comm-central/diff/7ed85c4ae6bf85b278c73cbced91bb829a0c93fa/mail/components/compose/content/MsgComposeCommands.js">diff</a> |
<a href="/comm-central/comparison/7ed85c4ae6bf85b278c73cbced91bb829a0c93fa/mail/components/compose/content/MsgComposeCommands.js">comparison</a> |
<a href="/comm-central/log/7ed85c4ae6bf85b278c73cbced91bb829a0c93fa/mail/components/compose/content/MsgComposeCommands.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7ed85c4ae6bf85b278c73cbced91bb829a0c93fa/mail/components/compose/content/messengercompose.xhtml">mail/components/compose/content/messengercompose.xhtml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7ed85c4ae6bf85b278c73cbced91bb829a0c93fa/mail/components/compose/content/messengercompose.xhtml">file</a> |
<a href="/comm-central/annotate/7ed85c4ae6bf85b278c73cbced91bb829a0c93fa/mail/components/compose/content/messengercompose.xhtml">annotate</a> |
<a href="/comm-central/diff/7ed85c4ae6bf85b278c73cbced91bb829a0c93fa/mail/components/compose/content/messengercompose.xhtml">diff</a> |
<a href="/comm-central/comparison/7ed85c4ae6bf85b278c73cbced91bb829a0c93fa/mail/components/compose/content/messengercompose.xhtml">comparison</a> |
<a href="/comm-central/log/7ed85c4ae6bf85b278c73cbced91bb829a0c93fa/mail/components/compose/content/messengercompose.xhtml">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/base/content/mailCore.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/base/content/mailCore.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -849,68 +849,77 @@ function SanitizeAttachmentDisplayName(a</span>
<a href="#l1.4"></a><span id="l1.4">   let displayName = aAttachment.name.trim().replace(/\s+/g, &quot; &quot;);</span>
<a href="#l1.5"></a><span id="l1.5">   if (AppConstants.platform == &quot;win&quot;) {</span>
<a href="#l1.6"></a><span id="l1.6">     displayName = displayName.replace(/[ \.]+$/, &quot;&quot;);</span>
<a href="#l1.7"></a><span id="l1.7">   }</span>
<a href="#l1.8"></a><span id="l1.8">   return displayName.replace(/(.)\1{9,}/g, &quot;$1…$1&quot;);</span>
<a href="#l1.9"></a><span id="l1.9"> }</span>
<a href="#l1.10"></a><span id="l1.10"> </span>
<a href="#l1.11"></a><span id="l1.11"> /**</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">- * Create a TransferData object for a message attachment, either from the</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">- * message reader or the composer.</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+ * Appends a dataTransferItem to the associated event for message attachments,</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+ * either from the message reader or the composer.</span>
<a href="#l1.16"></a><span id="l1.16">  *</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineminus">- * @param aAttachment the attachment object</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineminus">- * @return the TransferData</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+ * @param {Event} event - The associated event.</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+ * @param {nsIMsgAttachment[]} attachments - The attachments to setup</span>
<a href="#l1.21"></a><span id="l1.21">  */</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineminus">-function CreateAttachmentTransferData(aAttachment) {</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineplus">+function setupDataTransfer(event, attachments) {</span>
<a href="#l1.24"></a><span id="l1.24">   // For now, disallow drag-and-drop on cloud attachments. In the future, we</span>
<a href="#l1.25"></a><span id="l1.25">   // should allow this.</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineminus">-  if (</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineminus">-    aAttachment.contentType == &quot;text/x-moz-deleted&quot; ||</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineminus">-    aAttachment.sendViaCloud</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineminus">-  ) {</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineminus">-    return null;</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-  }</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+  let index = 0;</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+  for (let attachment of attachments) {</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+    if (</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineplus">+      attachment.contentType == &quot;text/x-moz-deleted&quot; ||</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineplus">+      attachment.sendViaCloud</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineplus">+    ) {</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineplus">+      return;</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineplus">+    }</span>
<a href="#l1.40"></a><span id="l1.40"> </span>
<a href="#l1.41"></a><span id="l1.41" class="difflineminus">-  var name = aAttachment.name || aAttachment.displayName;</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineplus">+    let name = attachment.name || attachment.displayName;</span>
<a href="#l1.43"></a><span id="l1.43"> </span>
<a href="#l1.44"></a><span id="l1.44" class="difflineminus">-  var data = new TransferData();</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineminus">-  if (aAttachment.url &amp;&amp; name) {</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineplus">+    if (!attachment.url || !name) {</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineplus">+      continue;</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineplus">+    }</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineplus">+</span>
<a href="#l1.50"></a><span id="l1.50">     // Only add type/filename info for non-file URLs that don't already</span>
<a href="#l1.51"></a><span id="l1.51">     // have it.</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineminus">-    var info;</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineminus">-    if (/(^file:|&amp;filename=)/.test(aAttachment.url)) {</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineminus">-      info = aAttachment.url;</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineplus">+    let info;</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineplus">+    if (/(^file:|&amp;filename=)/.test(attachment.url)) {</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineplus">+      info = attachment.url;</span>
<a href="#l1.58"></a><span id="l1.58">     } else {</span>
<a href="#l1.59"></a><span id="l1.59">       info =</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineminus">-        aAttachment.url +</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineplus">+        attachment.url +</span>
<a href="#l1.62"></a><span id="l1.62">         &quot;&amp;type=&quot; +</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineminus">-        aAttachment.contentType +</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineplus">+        attachment.contentType +</span>
<a href="#l1.65"></a><span id="l1.65">         &quot;&amp;filename=&quot; +</span>
<a href="#l1.66"></a><span id="l1.66">         encodeURIComponent(name);</span>
<a href="#l1.67"></a><span id="l1.67">     }</span>
<a href="#l1.68"></a><span id="l1.68"> </span>
<a href="#l1.69"></a><span id="l1.69" class="difflineminus">-    data.addDataForFlavour(</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineplus">+    event.dataTransfer.mozSetDataAt(</span>
<a href="#l1.71"></a><span id="l1.71">       &quot;text/x-moz-url&quot;,</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineminus">-      info + &quot;\n&quot; + name + &quot;\n&quot; + aAttachment.size</span>
<a href="#l1.73"></a><span id="l1.73" class="difflineplus">+      info + &quot;\n&quot; + name + &quot;\n&quot; + attachment.size,</span>
<a href="#l1.74"></a><span id="l1.74" class="difflineplus">+      index</span>
<a href="#l1.75"></a><span id="l1.75">     );</span>
<a href="#l1.76"></a><span id="l1.76" class="difflineminus">-    data.addDataForFlavour(&quot;text/x-moz-url-data&quot;, aAttachment.url);</span>
<a href="#l1.77"></a><span id="l1.77" class="difflineminus">-    data.addDataForFlavour(&quot;text/x-moz-url-desc&quot;, name);</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineminus">-    data.addDataForFlavour(</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineplus">+    event.dataTransfer.mozSetDataAt(</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineplus">+      &quot;text/x-moz-url-data&quot;,</span>
<a href="#l1.81"></a><span id="l1.81" class="difflineplus">+      attachment.url,</span>
<a href="#l1.82"></a><span id="l1.82" class="difflineplus">+      index</span>
<a href="#l1.83"></a><span id="l1.83" class="difflineplus">+    );</span>
<a href="#l1.84"></a><span id="l1.84" class="difflineplus">+    event.dataTransfer.mozSetDataAt(&quot;text/x-moz-url-desc&quot;, name, index);</span>
<a href="#l1.85"></a><span id="l1.85" class="difflineplus">+    event.dataTransfer.mozSetDataAt(</span>
<a href="#l1.86"></a><span id="l1.86">       &quot;application/x-moz-file-promise-url&quot;,</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineminus">-      aAttachment.url</span>
<a href="#l1.88"></a><span id="l1.88" class="difflineplus">+      attachment.url,</span>
<a href="#l1.89"></a><span id="l1.89" class="difflineplus">+      index</span>
<a href="#l1.90"></a><span id="l1.90">     );</span>
<a href="#l1.91"></a><span id="l1.91" class="difflineminus">-    data.addDataForFlavour(</span>
<a href="#l1.92"></a><span id="l1.92" class="difflineplus">+    event.dataTransfer.mozSetDataAt(</span>
<a href="#l1.93"></a><span id="l1.93">       &quot;application/x-moz-file-promise&quot;,</span>
<a href="#l1.94"></a><span id="l1.94">       new nsFlavorDataProvider(),</span>
<a href="#l1.95"></a><span id="l1.95" class="difflineminus">-      0,</span>
<a href="#l1.96"></a><span id="l1.96" class="difflineminus">-      Ci.nsISupports</span>
<a href="#l1.97"></a><span id="l1.97" class="difflineplus">+      index</span>
<a href="#l1.98"></a><span id="l1.98">     );</span>
<a href="#l1.99"></a><span id="l1.99" class="difflineplus">+    index++;</span>
<a href="#l1.100"></a><span id="l1.100">   }</span>
<a href="#l1.101"></a><span id="l1.101" class="difflineminus">-  return data;</span>
<a href="#l1.102"></a><span id="l1.102"> }</span>
<a href="#l1.103"></a><span id="l1.103"> </span>
<a href="#l1.104"></a><span id="l1.104"> function nsFlavorDataProvider() {}</span>
<a href="#l1.105"></a><span id="l1.105"> </span>
<a href="#l1.106"></a><span id="l1.106"> nsFlavorDataProvider.prototype = {</span>
<a href="#l1.107"></a><span id="l1.107">   QueryInterface: ChromeUtils.generateQI([&quot;nsIFlavorDataProvider&quot;]),</span>
<a href="#l1.108"></a><span id="l1.108"> </span>
<a href="#l1.109"></a><span id="l1.109">   getFlavorData(aTransferable, aFlavor, aData) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/base/content/messageWindow.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/base/content/messageWindow.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -14,17 +14,16 @@</span>
<a href="#l2.4"></a><span id="l2.4"> /* import-globals-from mail-offline.js */</span>
<a href="#l2.5"></a><span id="l2.5"> /* import-globals-from mailCommands.js */</span>
<a href="#l2.6"></a><span id="l2.6"> /* import-globals-from mailCore.js */</span>
<a href="#l2.7"></a><span id="l2.7"> /* import-globals-from mailWindow.js */</span>
<a href="#l2.8"></a><span id="l2.8"> /* import-globals-from mailWindowOverlay.js */</span>
<a href="#l2.9"></a><span id="l2.9"> /* import-globals-from messageDisplay.js */</span>
<a href="#l2.10"></a><span id="l2.10"> /* import-globals-from msgHdrView.js */</span>
<a href="#l2.11"></a><span id="l2.11"> /* import-globals-from msgViewNavigation.js */</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-/* import-globals-from nsDragAndDrop.js */</span>
<a href="#l2.13"></a><span id="l2.13"> /* import-globals-from phishingDetector.js */</span>
<a href="#l2.14"></a><span id="l2.14"> /* import-globals-from toolbarIconColor.js */</span>
<a href="#l2.15"></a><span id="l2.15"> /* globals PanelUI */</span>
<a href="#l2.16"></a><span id="l2.16"> </span>
<a href="#l2.17"></a><span id="l2.17"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l2.18"></a><span id="l2.18"> var { MailUtils } = ChromeUtils.import(&quot;resource:///modules/MailUtils.jsm&quot;);</span>
<a href="#l2.19"></a><span id="l2.19"> var { AppConstants } = ChromeUtils.import(</span>
<a href="#l2.20"></a><span id="l2.20">   &quot;resource://gre/modules/AppConstants.jsm&quot;</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineat">@@ -313,54 +312,55 @@ StandaloneMessageDisplayWidget.prototype</span>
<a href="#l2.22"></a><span id="l2.22">     ) {</span>
<a href="#l2.23"></a><span id="l2.23">       window.close();</span>
<a href="#l2.24"></a><span id="l2.24">       return true;</span>
<a href="#l2.25"></a><span id="l2.25">     }</span>
<a href="#l2.26"></a><span id="l2.26">     return false;</span>
<a href="#l2.27"></a><span id="l2.27">   },</span>
<a href="#l2.28"></a><span id="l2.28"> };</span>
<a href="#l2.29"></a><span id="l2.29"> </span>
<a href="#l2.30"></a><span id="l2.30" class="difflineminus">-var messagepaneObserver = {</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-  canHandleMultipleItems: false,</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineminus">-</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineminus">-  onDrop(aEvent, aData, aDragSession) {</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineminus">-    var sourceUri = aData.data;</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+let messagepaneObserver = {</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+  onDrop(event) {</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+    let dragSession = Cc[&quot;@mozilla.org/widget/dragservice;1&quot;]</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+      .getService(Ci.nsIDragService)</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+      .getCurrentSession();</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+    if (!this.canDrop(event, dragSession)) {</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+      return;</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineplus">+    }</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineplus">+    let sourceUri = event.dataTransfer.getData(&quot;text/x-moz-message&quot;);</span>
<a href="#l2.44"></a><span id="l2.44">     if (</span>
<a href="#l2.45"></a><span id="l2.45">       !gFolderDisplay.selectedMessage ||</span>
<a href="#l2.46"></a><span id="l2.46">       sourceUri != gFolderDisplay.selectedMessageUris[0]</span>
<a href="#l2.47"></a><span id="l2.47">     ) {</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineminus">-      var msgHdr = messenger.msgHdrFromURI(sourceUri);</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineminus">-      let originGlobal = aDragSession.sourceNode.ownerDocument.defaultValue;</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineplus">+      let msgHdr = messenger.msgHdrFromURI(sourceUri);</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineplus">+      let originGlobal = dragSession.sourceNode.ownerGlobal;</span>
<a href="#l2.52"></a><span id="l2.52">       gFolderDisplay.cloneView(originGlobal.gFolderDisplay.view);</span>
<a href="#l2.53"></a><span id="l2.53">       gFolderDisplay.selectMessage(msgHdr);</span>
<a href="#l2.54"></a><span id="l2.54">     }</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineplus">+    event.stopPropagation();</span>
<a href="#l2.56"></a><span id="l2.56">   },</span>
<a href="#l2.57"></a><span id="l2.57"> </span>
<a href="#l2.58"></a><span id="l2.58" class="difflineminus">-  onDragOver(aEvent, aFlavour, aDragSession) {</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineminus">-    var messagepanebox = document.getElementById(&quot;messagepanebox&quot;);</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineplus">+  onDragOver(event) {</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineplus">+    let messagepanebox = document.getElementById(&quot;messagepanebox&quot;);</span>
<a href="#l2.62"></a><span id="l2.62">     messagepanebox.setAttribute(&quot;dragover&quot;, &quot;true&quot;);</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineplus">+    event.stopPropagation();</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineplus">+    event.preventDefault();</span>
<a href="#l2.65"></a><span id="l2.65">   },</span>
<a href="#l2.66"></a><span id="l2.66"> </span>
<a href="#l2.67"></a><span id="l2.67" class="difflineminus">-  onDragExit(aEvent, aDragSession) {</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineminus">-    var messagepanebox = document.getElementById(&quot;messagepanebox&quot;);</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineplus">+  onDragExit(event) {</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineplus">+    let messagepanebox = document.getElementById(&quot;messagepanebox&quot;);</span>
<a href="#l2.71"></a><span id="l2.71">     messagepanebox.removeAttribute(&quot;dragover&quot;);</span>
<a href="#l2.72"></a><span id="l2.72">   },</span>
<a href="#l2.73"></a><span id="l2.73"> </span>
<a href="#l2.74"></a><span id="l2.74" class="difflineminus">-  canDrop(aEvent, aDragSession) {</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineplus">+  canDrop(event, dragSession) {</span>
<a href="#l2.76"></a><span id="l2.76">     // allow drop from mail:3pane window only - 4xp</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineminus">-    var doc = aDragSession.sourceNode.ownerDocument;</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineminus">-    var elem = doc.getElementById(&quot;messengerWindow&quot;);</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineplus">+    let doc = dragSession.sourceNode.ownerDocument;</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineplus">+    let elem = doc.getElementById(&quot;messengerWindow&quot;);</span>
<a href="#l2.81"></a><span id="l2.81">     return elem &amp;&amp; elem.getAttribute(&quot;windowtype&quot;) == &quot;mail:3pane&quot;;</span>
<a href="#l2.82"></a><span id="l2.82">   },</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineminus">-</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineminus">-  getSupportedFlavours() {</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineminus">-    var flavourSet = new FlavourSet();</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineminus">-    flavourSet.appendFlavour(&quot;text/x-moz-message&quot;);</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineminus">-    return flavourSet;</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineminus">-  },</span>
<a href="#l2.89"></a><span id="l2.89"> };</span>
<a href="#l2.90"></a><span id="l2.90"> </span>
<a href="#l2.91"></a><span id="l2.91"> function UpdateStatusMessageCounts() {</span>
<a href="#l2.92"></a><span id="l2.92">   // hook for extra toolbar items</span>
<a href="#l2.93"></a><span id="l2.93">   Services.obs.notifyObservers(window, &quot;mail:updateStandAloneMessageCounts&quot;);</span>
<a href="#l2.94"></a><span id="l2.94"> }</span>
<a href="#l2.95"></a><span id="l2.95"> </span>
<a href="#l2.96"></a><span id="l2.96"> // we won't show the window until the onload() handler is finished</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/base/content/messageWindow.xhtml</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/base/content/messageWindow.xhtml</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -92,17 +92,16 @@</span>
<a href="#l3.4"></a><span id="l3.4">   &lt;script src=&quot;chrome://messenger/content/mailWindow.js&quot;/&gt;</span>
<a href="#l3.5"></a><span id="l3.5">   &lt;script src=&quot;chrome://messenger/content/messageWindow.js&quot;/&gt;</span>
<a href="#l3.6"></a><span id="l3.6">   &lt;script src=&quot;chrome://messenger/content/accountUtils.js&quot;/&gt;</span>
<a href="#l3.7"></a><span id="l3.7">   &lt;script src=&quot;chrome://global/content/contentAreaUtils.js&quot;/&gt;</span>
<a href="#l3.8"></a><span id="l3.8">   &lt;script src=&quot;chrome://messenger/content/nsContextMenu.js&quot;/&gt;</span>
<a href="#l3.9"></a><span id="l3.9">   &lt;script src=&quot;chrome://messenger/content/mailContextMenus.js&quot;/&gt;</span>
<a href="#l3.10"></a><span id="l3.10">   &lt;script src=&quot;chrome://messenger/content/phishingDetector.js&quot;/&gt;</span>
<a href="#l3.11"></a><span id="l3.11">   &lt;script src=&quot;chrome://communicator/content/contentAreaClick.js&quot;/&gt;</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-  &lt;script src=&quot;chrome://global/content/nsDragAndDrop.js&quot;/&gt;</span>
<a href="#l3.13"></a><span id="l3.13">   &lt;script src=&quot;chrome://messenger/content/msgViewNavigation.js&quot;/&gt;</span>
<a href="#l3.14"></a><span id="l3.14">   &lt;script src=&quot;chrome://messenger/content/editContactPanel.js&quot;/&gt;</span>
<a href="#l3.15"></a><span id="l3.15">   &lt;script src=&quot;chrome://messenger/content/toolbarIconColor.js&quot;/&gt;</span>
<a href="#l3.16"></a><span id="l3.16">   &lt;script src=&quot;chrome://messenger/content/msgHdrView.js&quot;/&gt;</span>
<a href="#l3.17"></a><span id="l3.17">   &lt;script src=&quot;chrome://messenger-smime/content/msgHdrViewSMIMEOverlay.js&quot;/&gt;</span>
<a href="#l3.18"></a><span id="l3.18">   &lt;script src=&quot;chrome://messenger-smime/content/msgReadSMIMEOverlay.js&quot;/&gt;</span>
<a href="#l3.19"></a><span id="l3.19"> #ifdef MOZ_OPENPGP</span>
<a href="#l3.20"></a><span id="l3.20">   &lt;script src=&quot;chrome://openpgp/content/BondOpenPGP.jsm&quot;/&gt;</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineat">@@ -209,19 +208,19 @@</span>
<a href="#l3.22"></a><span id="l3.22"> #include mainMailToolbox.inc.xhtml</span>
<a href="#l3.23"></a><span id="l3.23"> </span>
<a href="#l3.24"></a><span id="l3.24">   &lt;tooltip id=&quot;aHTMLTooltip&quot; page=&quot;true&quot;/&gt;</span>
<a href="#l3.25"></a><span id="l3.25"> </span>
<a href="#l3.26"></a><span id="l3.26">   &lt;!-- msg header view --&gt;</span>
<a href="#l3.27"></a><span id="l3.27">   &lt;!-- a convenience box for ease of extension overlaying --&gt;</span>
<a href="#l3.28"></a><span id="l3.28">   &lt;hbox id=&quot;messagepaneboxwrapper&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l3.29"></a><span id="l3.29">     &lt;vbox id=&quot;messagepanebox&quot; flex=&quot;3&quot;</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineminus">-          ondragover=&quot;nsDragAndDrop.dragOver(event, messagepaneObserver);&quot;</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-          ondrop=&quot;nsDragAndDrop.drop(event, messagepaneObserver);&quot;</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineminus">-          ondragexit=&quot;nsDragAndDrop.dragExit(event, messagepaneObserver);&quot;&gt;</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+          ondragover=&quot;messagepaneObserver.onDragOver(event);&quot;</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+          ondrop=&quot;messagepaneObserver.onDrop(event);&quot;</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+          ondragexit=&quot;messagepaneObserver.onDragExit(event);&quot;&gt;</span>
<a href="#l3.36"></a><span id="l3.36"> </span>
<a href="#l3.37"></a><span id="l3.37">       &lt;hbox id=&quot;msgHeaderView&quot; collapsed=&quot;true&quot; class=&quot;main-header-area&quot;&gt;</span>
<a href="#l3.38"></a><span id="l3.38"> #include msgHdrView.inc.xhtml</span>
<a href="#l3.39"></a><span id="l3.39">       &lt;/hbox&gt;</span>
<a href="#l3.40"></a><span id="l3.40">       &lt;!-- The msgNotificationBar appears on top of the message and displays</span>
<a href="#l3.41"></a><span id="l3.41">            information like: junk, mdn, remote content and phishing warnings --&gt;</span>
<a href="#l3.42"></a><span id="l3.42">       &lt;hbox id=&quot;mail-notification-top&quot;&gt;</span>
<a href="#l3.43"></a><span id="l3.43">         &lt;!-- notificationbox will be added here lazily. --&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/base/content/messenger.xhtml</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/base/content/messenger.xhtml</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -120,22 +120,20 @@</span>
<a href="#l4.4"></a><span id="l4.4"> &lt;script src=&quot;chrome://messenger/content/mail3PaneWindowCommands.js&quot;/&gt;</span>
<a href="#l4.5"></a><span id="l4.5"> &lt;script src=&quot;chrome://global/content/contentAreaUtils.js&quot;/&gt;</span>
<a href="#l4.6"></a><span id="l4.6"> &lt;script src=&quot;chrome://messenger/content/nsContextMenu.js&quot;/&gt;</span>
<a href="#l4.7"></a><span id="l4.7"> &lt;script src=&quot;chrome://messenger/content/mailContextMenus.js&quot;/&gt;</span>
<a href="#l4.8"></a><span id="l4.8"> &lt;script src=&quot;chrome://messenger/content/accountUtils.js&quot;/&gt;</span>
<a href="#l4.9"></a><span id="l4.9"> &lt;script src=&quot;chrome://messenger/content/folderPane.js&quot;/&gt;</span>
<a href="#l4.10"></a><span id="l4.10"> &lt;script src=&quot;chrome://messenger/content/phishingDetector.js&quot;/&gt;</span>
<a href="#l4.11"></a><span id="l4.11"> &lt;script src=&quot;chrome://communicator/content/contentAreaClick.js&quot;/&gt;</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-&lt;script src=&quot;chrome://global/content/nsDragAndDrop.js&quot;/&gt;</span>
<a href="#l4.13"></a><span id="l4.13"> &lt;script src=&quot;chrome://messenger/content/editContactPanel.js&quot;/&gt;</span>
<a href="#l4.14"></a><span id="l4.14"> &lt;script src=&quot;chrome://messenger/content/toolbarIconColor.js&quot;/&gt;</span>
<a href="#l4.15"></a><span id="l4.15"> &lt;script src=&quot;chrome://messenger/content/jsTreeView.js&quot;/&gt;</span>
<a href="#l4.16"></a><span id="l4.16"> &lt;script src=&quot;chrome://messenger/content/msgHdrView.js&quot;/&gt;</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineminus">-&lt;script src=&quot;chrome://global/content/nsDragAndDrop.js&quot;/&gt;</span>
<a href="#l4.18"></a><span id="l4.18"> &lt;script src=&quot;chrome://messenger-smime/content/msgHdrViewSMIMEOverlay.js&quot;/&gt;</span>
<a href="#l4.19"></a><span id="l4.19"> &lt;script src=&quot;chrome://messenger-smime/content/msgReadSMIMEOverlay.js&quot;/&gt;</span>
<a href="#l4.20"></a><span id="l4.20"> #ifdef MOZ_OPENPGP</span>
<a href="#l4.21"></a><span id="l4.21"> &lt;script src=&quot;chrome://openpgp/content/BondOpenPGP.jsm&quot;/&gt;</span>
<a href="#l4.22"></a><span id="l4.22"> &lt;script src=&quot;chrome://openpgp/content/ui/enigmailMessengerOverlay.js&quot;/&gt;</span>
<a href="#l4.23"></a><span id="l4.23"> &lt;script src=&quot;chrome://openpgp/content/ui/enigmailMsgHdrViewOverlay.js&quot;/&gt;</span>
<a href="#l4.24"></a><span id="l4.24"> #endif</span>
<a href="#l4.25"></a><span id="l4.25"> &lt;script src=&quot;chrome://messenger/content/chat/chat-messenger.js&quot;/&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/base/content/msgAttachmentView.inc.xhtml</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/base/content/msgAttachmentView.inc.xhtml</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -14,17 +14,17 @@</span>
<a href="#l5.4"></a><span id="l5.4">                           &lt;hbox align=&quot;center&quot; id=&quot;attachmentInfo&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l5.5"></a><span id="l5.5">                             &lt;image id=&quot;attachmentIcon&quot;/&gt;</span>
<a href="#l5.6"></a><span id="l5.6">                             &lt;label id=&quot;attachmentCount&quot;/&gt;</span>
<a href="#l5.7"></a><span id="l5.7">                             &lt;label id=&quot;attachmentName&quot; crop=&quot;center&quot; flex=&quot;1&quot;</span>
<a href="#l5.8"></a><span id="l5.8">                                    role=&quot;button&quot;</span>
<a href="#l5.9"></a><span id="l5.9">                                    tooltiptext=&quot;&amp;openAttachment.tooltip;&quot;</span>
<a href="#l5.10"></a><span id="l5.10">                                    tooltiptextopen=&quot;&amp;openAttachment.tooltip;&quot;</span>
<a href="#l5.11"></a><span id="l5.11">                                    onclick=&quot;OpenAttachmentFromBar(event);&quot;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-                                   ondragstart=&quot;nsDragAndDrop.startDrag(event, attachmentNameDNDObserver);&quot;/&gt;</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+                                   ondragstart=&quot;attachmentNameDNDObserver.onDragStart(event);&quot;/&gt;</span>
<a href="#l5.14"></a><span id="l5.14">                             &lt;label id=&quot;attachmentSize&quot;/&gt;</span>
<a href="#l5.15"></a><span id="l5.15">                           &lt;/hbox&gt;</span>
<a href="#l5.16"></a><span id="l5.16">                           &lt;!-- Use a very large flex value here so that attachmentCount doesn't take</span>
<a href="#l5.17"></a><span id="l5.17">                                up more space than necessary, but still crops itself if there's not</span>
<a href="#l5.18"></a><span id="l5.18">                                enough space. --&gt;</span>
<a href="#l5.19"></a><span id="l5.19">                           &lt;spacer flex=&quot;9999&quot;/&gt;</span>
<a href="#l5.20"></a><span id="l5.20"> </span>
<a href="#l5.21"></a><span id="l5.21">                           &lt;vbox id=&quot;attachment-view-toolbox&quot; class=&quot;inline-toolbox&quot;&gt;</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineat">@@ -97,11 +97,10 @@</span>
<a href="#l5.23"></a><span id="l5.23">                         &lt;hbox class=&quot;attachments-container&quot;&gt;</span>
<a href="#l5.24"></a><span id="l5.24">                           &lt;richlistbox is=&quot;attachment-list&quot; id=&quot;attachmentList&quot;</span>
<a href="#l5.25"></a><span id="l5.25">                                        class=&quot;attachmentList&quot;</span>
<a href="#l5.26"></a><span id="l5.26">                                        orient=&quot;horizontal&quot;</span>
<a href="#l5.27"></a><span id="l5.27">                                        seltype=&quot;multiple&quot;</span>
<a href="#l5.28"></a><span id="l5.28">                                        context=&quot;attachmentListContext&quot;</span>
<a href="#l5.29"></a><span id="l5.29">                                        itemcontext=&quot;attachmentItemContext&quot;</span>
<a href="#l5.30"></a><span id="l5.30">                                        role=&quot;listbox&quot;</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineminus">-                                       ondragstart=&quot;nsDragAndDrop.startDrag(event, attachmentListDNDObserver);&quot;</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineminus">-                                       ondragover=&quot;nsDragAndDrop.dragOver(event, attachmentListDNDObserver);&quot;/&gt;</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineplus">+                                       ondragstart=&quot;attachmentListDNDObserver.onDragStart(event);&quot;/&gt;</span>
<a href="#l5.34"></a><span id="l5.34">                         &lt;/hbox&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/base/content/msgHdrView.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/base/content/msgHdrView.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -6,17 +6,16 @@</span>
<a href="#l6.4"></a><span id="l6.4">  * Functions related to displaying the headers for a selected message in the</span>
<a href="#l6.5"></a><span id="l6.5">  * message pane.</span>
<a href="#l6.6"></a><span id="l6.6">  */</span>
<a href="#l6.7"></a><span id="l6.7"> </span>
<a href="#l6.8"></a><span id="l6.8"> /* import-globals-from editContactPanel.js */</span>
<a href="#l6.9"></a><span id="l6.9"> /* import-globals-from folderDisplay.js */</span>
<a href="#l6.10"></a><span id="l6.10"> /* import-globals-from mailWindow.js */</span>
<a href="#l6.11"></a><span id="l6.11"> /* import-globals-from messageDisplay.js */</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-/* import-globals-from nsDragAndDrop.js */</span>
<a href="#l6.13"></a><span id="l6.13"> /* global Enigmail */</span>
<a href="#l6.14"></a><span id="l6.14"> </span>
<a href="#l6.15"></a><span id="l6.15"> var { XPCOMUtils } = ChromeUtils.import(</span>
<a href="#l6.16"></a><span id="l6.16">   &quot;resource://gre/modules/XPCOMUtils.jsm&quot;</span>
<a href="#l6.17"></a><span id="l6.17"> );</span>
<a href="#l6.18"></a><span id="l6.18"> var { MailConstants } = ChromeUtils.import(</span>
<a href="#l6.19"></a><span id="l6.19">   &quot;resource:///modules/MailConstants.jsm&quot;</span>
<a href="#l6.20"></a><span id="l6.20"> );</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineat">@@ -3379,39 +3378,35 @@ function ClearAttachmentList() {</span>
<a href="#l6.22"></a><span id="l6.22">   var list = document.getElementById(&quot;attachmentList&quot;);</span>
<a href="#l6.23"></a><span id="l6.23">   list.clearSelection();</span>
<a href="#l6.24"></a><span id="l6.24"> </span>
<a href="#l6.25"></a><span id="l6.25">   while (list.hasChildNodes()) {</span>
<a href="#l6.26"></a><span id="l6.26">     list.lastChild.remove();</span>
<a href="#l6.27"></a><span id="l6.27">   }</span>
<a href="#l6.28"></a><span id="l6.28"> }</span>
<a href="#l6.29"></a><span id="l6.29"> </span>
<a href="#l6.30"></a><span id="l6.30" class="difflineminus">-var attachmentListDNDObserver = {</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-  onDragStart(aEvent, aAttachmentData, aDragAction) {</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineminus">-    let target = aEvent.target;</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineminus">-</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+let attachmentListDNDObserver = {</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+  onDragStart(event) {</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineplus">+    let target = event.target;</span>
<a href="#l6.37"></a><span id="l6.37">     if (target.localName == &quot;richlistitem&quot;) {</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineminus">-      let selection = target.parentNode.selectedItems;</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineminus">-      aAttachmentData.data = new TransferDataSet();</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineminus">-      for (let item of selection) {</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineminus">-        let transferData = CreateAttachmentTransferData(item.attachment);</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineminus">-        if (transferData) {</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineminus">-          aAttachmentData.data.push(transferData);</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineminus">-        }</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineplus">+      let attachments = [];</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineplus">+      for (let item of target.parentNode.selectedItems) {</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineplus">+        attachments.push(item.attachment);</span>
<a href="#l6.48"></a><span id="l6.48">       }</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineplus">+      setupDataTransfer(event, attachments);</span>
<a href="#l6.50"></a><span id="l6.50">     }</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineplus">+    event.stopPropagation();</span>
<a href="#l6.52"></a><span id="l6.52">   },</span>
<a href="#l6.53"></a><span id="l6.53"> };</span>
<a href="#l6.54"></a><span id="l6.54"> </span>
<a href="#l6.55"></a><span id="l6.55" class="difflineminus">-var attachmentNameDNDObserver = {</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineminus">-  onDragStart(aEvent, aAttachmentData, aDragAction) {</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineminus">-    var attachmentList = document.getElementById(&quot;attachmentList&quot;);</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineminus">-    aAttachmentData.data = CreateAttachmentTransferData(</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineminus">-      attachmentList.getItemAtIndex(0).attachment</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineminus">-    );</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineplus">+let attachmentNameDNDObserver = {</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineplus">+  onDragStart(event) {</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineplus">+    let attachmentList = document.getElementById(&quot;attachmentList&quot;);</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineplus">+    setupDataTransfer(event, [attachmentList.getItemAtIndex(0).attachment]);</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineplus">+    event.stopPropagation();</span>
<a href="#l6.66"></a><span id="l6.66">   },</span>
<a href="#l6.67"></a><span id="l6.67"> };</span>
<a href="#l6.68"></a><span id="l6.68"> </span>
<a href="#l6.69"></a><span id="l6.69"> /**</span>
<a href="#l6.70"></a><span id="l6.70">  * CopyWebsiteAddress takes the website address title button, extracts</span>
<a href="#l6.71"></a><span id="l6.71">  * the website address we stored in there and copies it to the clipboard</span>
<a href="#l6.72"></a><span id="l6.72">  */</span>
<a href="#l6.73"></a><span id="l6.73"> function CopyWebsiteAddress(websiteAddressNode) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mail/components/compose/content/MsgComposeCommands.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mail/components/compose/content/MsgComposeCommands.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -6034,20 +6034,16 @@ function attachmentBucketOnKeyPress(aEve</span>
<a href="#l7.4"></a><span id="l7.4">     // We can get away with hardcoding the access key modifier key as aEvent.altKey</span>
<a href="#l7.5"></a><span id="l7.5">     // because it's ALT for Windows and Linux.</span>
<a href="#l7.6"></a><span id="l7.6">     if (aEvent.key == attachmentsAccessKey &amp;&amp; aEvent.altKey) {</span>
<a href="#l7.7"></a><span id="l7.7">       goDoCommand(&quot;cmd_toggleAttachmentPane&quot;);</span>
<a href="#l7.8"></a><span id="l7.8">     }</span>
<a href="#l7.9"></a><span id="l7.9">   }</span>
<a href="#l7.10"></a><span id="l7.10"> }</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-function attachmentBucketOnDragStart(aEvent) {</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-  nsDragAndDrop.startDrag(aEvent, attachmentBucketDNDObserver);</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineminus">-}</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineminus">-</span>
<a href="#l7.16"></a><span id="l7.16"> function attachmentBucketOnClick(aEvent) {</span>
<a href="#l7.17"></a><span id="l7.17">   // Handle click on attachment pane whitespace:</span>
<a href="#l7.18"></a><span id="l7.18">   // - With selected attachments, clear selection first.</span>
<a href="#l7.19"></a><span id="l7.19">   // - Otherwise, e.g. on a plain empty bucket, show 'Attach File(s)' dialog.</span>
<a href="#l7.20"></a><span id="l7.20">   if (attachmentsSelectedCount() == 0) {</span>
<a href="#l7.21"></a><span id="l7.21">     let boundTarget = aEvent.originalTarget;</span>
<a href="#l7.22"></a><span id="l7.22">     if (</span>
<a href="#l7.23"></a><span id="l7.23">       aEvent.button == 0 &amp;&amp;</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineat">@@ -6526,72 +6522,75 @@ function fromKeyPress(event) {</span>
<a href="#l7.25"></a><span id="l7.25"> </span>
<a href="#l7.26"></a><span id="l7.26"> function subjectKeyPress(event) {</span>
<a href="#l7.27"></a><span id="l7.27">   gSubjectChanged = true;</span>
<a href="#l7.28"></a><span id="l7.28">   if (event.keyCode == KeyEvent.DOM_VK_RETURN) {</span>
<a href="#l7.29"></a><span id="l7.29">     SetMsgBodyFrameFocus();</span>
<a href="#l7.30"></a><span id="l7.30">   }</span>
<a href="#l7.31"></a><span id="l7.31"> }</span>
<a href="#l7.32"></a><span id="l7.32"> </span>
<a href="#l7.33"></a><span id="l7.33" class="difflineplus">+// content types supported in the envelopeDragObserver.</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+let flavours = [</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineplus">+  &quot;text/x-moz-address&quot;,</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+  &quot;text/x-moz-message&quot;,</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+  &quot;application/x-moz-file&quot;,</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineplus">+  &quot;text/x-moz-url&quot;,</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineplus">+];</span>
<a href="#l7.40"></a><span id="l7.40"> // we can drag and drop addresses, files, messages and urls into the compose envelope</span>
<a href="#l7.41"></a><span id="l7.41"> var envelopeDragObserver = {</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineminus">-  canHandleMultipleItems: true,</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineminus">-</span>
<a href="#l7.44"></a><span id="l7.44">   /**</span>
<a href="#l7.45"></a><span id="l7.45">    * Adjust the drop target when dragging from the attachment bucket onto itself</span>
<a href="#l7.46"></a><span id="l7.46">    * by picking the nearest possible insertion point (generally, between two</span>
<a href="#l7.47"></a><span id="l7.47">    * list items).</span>
<a href="#l7.48"></a><span id="l7.48">    *</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineminus">-   * @param aEvent the drag-and-drop event being performed</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineminus">-   * @return {attachmentitem|string} the adjusted drop target:</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineminus">-   *                                 - an attachmentitem node for inserting</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineminus">-   *                                   *before*</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineminus">-   *                                 - &quot;none&quot; if this isn't a valid insertion point</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineminus">-   *                                 - &quot;afterLastItem&quot; for appending at the</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineminus">-   *                                   bottom of the list.</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineplus">+   * @param {Event} event - The drag-and-drop event being performed.</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineplus">+   * @return {attachmentitem|string} - the adjusted drop target:</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineplus">+   *   - an attachmentitem node for inserting *before*</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineplus">+   *   - &quot;none&quot; if this isn't a valid insertion point</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineplus">+   *   - &quot;afterLastItem&quot; for appending at the bottom of the list.</span>
<a href="#l7.61"></a><span id="l7.61">    */</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineminus">-  _adjustDropTarget(aEvent) {</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineminus">-    let target = aEvent.target;</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineplus">+  _adjustDropTarget(event) {</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineplus">+    let target = event.target;</span>
<a href="#l7.66"></a><span id="l7.66">     let bucket = document.getElementById(&quot;attachmentBucket&quot;);</span>
<a href="#l7.67"></a><span id="l7.67"> </span>
<a href="#l7.68"></a><span id="l7.68">     if (target == bucket) {</span>
<a href="#l7.69"></a><span id="l7.69">       // Dragging or dropping at top/bottom border of the listbox</span>
<a href="#l7.70"></a><span id="l7.70">       if (</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineminus">-        (aEvent.screenY - target.screenY) /</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineplus">+        (event.screenY - target.screenY) /</span>
<a href="#l7.73"></a><span id="l7.73">           target.getBoundingClientRect().height &lt;</span>
<a href="#l7.74"></a><span id="l7.74">         0.5</span>
<a href="#l7.75"></a><span id="l7.75">       ) {</span>
<a href="#l7.76"></a><span id="l7.76">         target = bucket.firstElementChild;</span>
<a href="#l7.77"></a><span id="l7.77">       } else {</span>
<a href="#l7.78"></a><span id="l7.78">         target = bucket.lastElementChild;</span>
<a href="#l7.79"></a><span id="l7.79">       }</span>
<a href="#l7.80"></a><span id="l7.80">       // We'll check below if this is a valid target.</span>
<a href="#l7.81"></a><span id="l7.81">     } else if (target.id == &quot;attachmentBucketCount&quot;) {</span>
<a href="#l7.82"></a><span id="l7.82">       // Dragging or dropping at top border of the listbox.</span>
<a href="#l7.83"></a><span id="l7.83">       // Allow bottom half of attachment list header as extended drop target</span>
<a href="#l7.84"></a><span id="l7.84">       // for top of list, because otherwise it would be too small.</span>
<a href="#l7.85"></a><span id="l7.85">       if (</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineminus">-        (aEvent.screenY - target.screenY) /</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineplus">+        (event.screenY - target.screenY) /</span>
<a href="#l7.88"></a><span id="l7.88">           target.getBoundingClientRect().height &gt;=</span>
<a href="#l7.89"></a><span id="l7.89">         0.5</span>
<a href="#l7.90"></a><span id="l7.90">       ) {</span>
<a href="#l7.91"></a><span id="l7.91">         target = bucket.firstElementChild;</span>
<a href="#l7.92"></a><span id="l7.92">         // We'll check below if this is a valid target.</span>
<a href="#l7.93"></a><span id="l7.93">       } else {</span>
<a href="#l7.94"></a><span id="l7.94">         // Top half of attachment list header: sorry, can't drop here.</span>
<a href="#l7.95"></a><span id="l7.95">         return &quot;none&quot;;</span>
<a href="#l7.96"></a><span id="l7.96">       }</span>
<a href="#l7.97"></a><span id="l7.97">     }</span>
<a href="#l7.98"></a><span id="l7.98"> </span>
<a href="#l7.99"></a><span id="l7.99">     // Target is an attachmentitem.</span>
<a href="#l7.100"></a><span id="l7.100">     if (target.matches(&quot;richlistitem.attachmentItem&quot;)) {</span>
<a href="#l7.101"></a><span id="l7.101">       // If we're dragging/dropping in bottom half of attachmentitem,</span>
<a href="#l7.102"></a><span id="l7.102">       // adjust target to target.nextElementSibling (to show dropmarker above that).</span>
<a href="#l7.103"></a><span id="l7.103">       if (</span>
<a href="#l7.104"></a><span id="l7.104" class="difflineminus">-        (aEvent.screenY - target.screenY) /</span>
<a href="#l7.105"></a><span id="l7.105" class="difflineplus">+        (event.screenY - target.screenY) /</span>
<a href="#l7.106"></a><span id="l7.106">           target.getBoundingClientRect().height &gt;=</span>
<a href="#l7.107"></a><span id="l7.107">         0.5</span>
<a href="#l7.108"></a><span id="l7.108">       ) {</span>
<a href="#l7.109"></a><span id="l7.109">         target = target.nextElementSibling;</span>
<a href="#l7.110"></a><span id="l7.110"> </span>
<a href="#l7.111"></a><span id="l7.111">         // If there's no target.nextElementSibling, we're dragging/dropping</span>
<a href="#l7.112"></a><span id="l7.112">         // to the bottom of the list.</span>
<a href="#l7.113"></a><span id="l7.113">         if (!target) {</span>
<a href="#l7.114"></a><span id="l7.114" class="difflineat">@@ -6647,25 +6646,29 @@ var envelopeDragObserver = {</span>
<a href="#l7.115"></a><span id="l7.115">     let oldDropMarkerItem = document</span>
<a href="#l7.116"></a><span id="l7.116">       .getElementById(&quot;attachmentBucket&quot;)</span>
<a href="#l7.117"></a><span id="l7.117">       .querySelector(&quot;richlistitem.attachmentItem[dropOn]&quot;);</span>
<a href="#l7.118"></a><span id="l7.118">     if (oldDropMarkerItem) {</span>
<a href="#l7.119"></a><span id="l7.119">       oldDropMarkerItem.removeAttribute(&quot;dropOn&quot;);</span>
<a href="#l7.120"></a><span id="l7.120">     }</span>
<a href="#l7.121"></a><span id="l7.121">   },</span>
<a href="#l7.122"></a><span id="l7.122"> </span>
<a href="#l7.123"></a><span id="l7.123" class="difflineminus">-  onDrop(aEvent, aData, aDragSession) {</span>
<a href="#l7.124"></a><span id="l7.124" class="difflineplus">+  // eslint-disable-next-line complexity</span>
<a href="#l7.125"></a><span id="l7.125" class="difflineplus">+  onDrop(event) {</span>
<a href="#l7.126"></a><span id="l7.126">     let bucket = document.getElementById(&quot;attachmentBucket&quot;);</span>
<a href="#l7.127"></a><span id="l7.127" class="difflineminus">-    let dragSourceNode = aDragSession.sourceNode;</span>
<a href="#l7.128"></a><span id="l7.128" class="difflineplus">+    let dragSession = Cc[&quot;@mozilla.org/widget/dragservice;1&quot;]</span>
<a href="#l7.129"></a><span id="l7.129" class="difflineplus">+      .getService(Ci.nsIDragService)</span>
<a href="#l7.130"></a><span id="l7.130" class="difflineplus">+      .getCurrentSession();</span>
<a href="#l7.131"></a><span id="l7.131" class="difflineplus">+    let dragSourceNode = dragSession.sourceNode;</span>
<a href="#l7.132"></a><span id="l7.132">     if (dragSourceNode &amp;&amp; dragSourceNode.parentNode == bucket) {</span>
<a href="#l7.133"></a><span id="l7.133">       // We dragged from the attachment pane onto itself, so instead of</span>
<a href="#l7.134"></a><span id="l7.134">       // attaching a new object, we're just reordering them.</span>
<a href="#l7.135"></a><span id="l7.135"> </span>
<a href="#l7.136"></a><span id="l7.136">       // Adjust the drop target according to mouse position on list (items).</span>
<a href="#l7.137"></a><span id="l7.137" class="difflineminus">-      let target = this._adjustDropTarget(aEvent);</span>
<a href="#l7.138"></a><span id="l7.138" class="difflineplus">+      let target = this._adjustDropTarget(event);</span>
<a href="#l7.139"></a><span id="l7.139"> </span>
<a href="#l7.140"></a><span id="l7.140">       // Get a non-live, sorted list of selected attachment list items.</span>
<a href="#l7.141"></a><span id="l7.141">       let selItems = attachmentsSelectionGetSortedArray();</span>
<a href="#l7.142"></a><span id="l7.142">       // Keep track of the item we had focused originally. Deselect it though,</span>
<a href="#l7.143"></a><span id="l7.143">       // since listbox gets confused if you move its focused item around.</span>
<a href="#l7.144"></a><span id="l7.144">       let focus = bucket.currentItem;</span>
<a href="#l7.145"></a><span id="l7.145">       bucket.currentItem = null;</span>
<a href="#l7.146"></a><span id="l7.146"> </span>
<a href="#l7.147"></a><span id="l7.147" class="difflineat">@@ -6727,185 +6730,182 @@ var envelopeDragObserver = {</span>
<a href="#l7.148"></a><span id="l7.148">         }</span>
<a href="#l7.149"></a><span id="l7.149">       }</span>
<a href="#l7.150"></a><span id="l7.150"> </span>
<a href="#l7.151"></a><span id="l7.151">       bucket.currentItem = focus;</span>
<a href="#l7.152"></a><span id="l7.152">       this._hideDropMarker();</span>
<a href="#l7.153"></a><span id="l7.153">       return;</span>
<a href="#l7.154"></a><span id="l7.154">     }</span>
<a href="#l7.155"></a><span id="l7.155"> </span>
<a href="#l7.156"></a><span id="l7.156" class="difflineminus">-    let dataList = aData.dataList;</span>
<a href="#l7.157"></a><span id="l7.157">     let attachments = [];</span>
<a href="#l7.158"></a><span id="l7.158" class="difflineminus">-</span>
<a href="#l7.159"></a><span id="l7.159" class="difflineminus">-    for (let dataListObj of dataList) {</span>
<a href="#l7.160"></a><span id="l7.160" class="difflineminus">-      let item = dataListObj.first;</span>
<a href="#l7.161"></a><span id="l7.161" class="difflineminus">-      let rawData = item.data;</span>
<a href="#l7.162"></a><span id="l7.162" class="difflineplus">+    let dt = event.dataTransfer;</span>
<a href="#l7.163"></a><span id="l7.163" class="difflineplus">+    let dataList = [];</span>
<a href="#l7.164"></a><span id="l7.164" class="difflineplus">+    for (let i = 0; i &lt; dt.mozItemCount; i++) {</span>
<a href="#l7.165"></a><span id="l7.165" class="difflineplus">+      let types = Array.from(dt.mozTypesAt(i));</span>
<a href="#l7.166"></a><span id="l7.166" class="difflineplus">+      for (let flavour of flavours) {</span>
<a href="#l7.167"></a><span id="l7.167" class="difflineplus">+        if (types.includes(flavour)) {</span>
<a href="#l7.168"></a><span id="l7.168" class="difflineplus">+          let data = dt.mozGetDataAt(flavour, i);</span>
<a href="#l7.169"></a><span id="l7.169" class="difflineplus">+          if (data) {</span>
<a href="#l7.170"></a><span id="l7.170" class="difflineplus">+            dataList.push({ data, flavour });</span>
<a href="#l7.171"></a><span id="l7.171" class="difflineplus">+          }</span>
<a href="#l7.172"></a><span id="l7.172" class="difflineplus">+          break;</span>
<a href="#l7.173"></a><span id="l7.173" class="difflineplus">+        }</span>
<a href="#l7.174"></a><span id="l7.174" class="difflineplus">+      }</span>
<a href="#l7.175"></a><span id="l7.175" class="difflineplus">+    }</span>
<a href="#l7.176"></a><span id="l7.176" class="difflineplus">+</span>
<a href="#l7.177"></a><span id="l7.177" class="difflineplus">+    for (let { data, flavour } of dataList) {</span>
<a href="#l7.178"></a><span id="l7.178">       let isValidAttachment = false;</span>
<a href="#l7.179"></a><span id="l7.179">       let prettyName;</span>
<a href="#l7.180"></a><span id="l7.180">       let size;</span>
<a href="#l7.181"></a><span id="l7.181"> </span>
<a href="#l7.182"></a><span id="l7.182">       // We could be dropping an attachment of various flavours OR an address;</span>
<a href="#l7.183"></a><span id="l7.183">       // check and do the right thing.</span>
<a href="#l7.184"></a><span id="l7.184" class="difflineminus">-      // Note that case blocks {...} are recommended to avoid redeclaration errors</span>
<a href="#l7.185"></a><span id="l7.185" class="difflineminus">-      // when using 'let'.</span>
<a href="#l7.186"></a><span id="l7.186" class="difflineminus">-      switch (item.flavour.contentType) {</span>
<a href="#l7.187"></a><span id="l7.187" class="difflineplus">+      switch (flavour) {</span>
<a href="#l7.188"></a><span id="l7.188">         // Process attachments.</span>
<a href="#l7.189"></a><span id="l7.189">         case &quot;application/x-moz-file&quot;: {</span>
<a href="#l7.190"></a><span id="l7.190" class="difflineminus">-          let fileHandler = Services.io</span>
<a href="#l7.191"></a><span id="l7.191" class="difflineminus">-            .getProtocolHandler(&quot;file&quot;)</span>
<a href="#l7.192"></a><span id="l7.192" class="difflineminus">-            .QueryInterface(Ci.nsIFileProtocolHandler);</span>
<a href="#l7.193"></a><span id="l7.193" class="difflineminus">-          if (!rawData.exists() || !rawData.isReadable()) {</span>
<a href="#l7.194"></a><span id="l7.194" class="difflineminus">-            // For some reason we couldn't read the file just dragged. Permission problem?</span>
<a href="#l7.195"></a><span id="l7.195" class="difflineminus">-            Cu.reportError(</span>
<a href="#l7.196"></a><span id="l7.196" class="difflineminus">-              &quot;Couldn't access the dragged file &quot; + rawData.leafName</span>
<a href="#l7.197"></a><span id="l7.197" class="difflineminus">-            );</span>
<a href="#l7.198"></a><span id="l7.198" class="difflineminus">-            break;</span>
<a href="#l7.199"></a><span id="l7.199" class="difflineplus">+          if (data instanceof Ci.nsIFile) {</span>
<a href="#l7.200"></a><span id="l7.200" class="difflineplus">+            size = data.fileSize;</span>
<a href="#l7.201"></a><span id="l7.201">           }</span>
<a href="#l7.202"></a><span id="l7.202" class="difflineminus">-</span>
<a href="#l7.203"></a><span id="l7.203">           try {</span>
<a href="#l7.204"></a><span id="l7.204" class="difflineminus">-            size = rawData.fileSize;</span>
<a href="#l7.205"></a><span id="l7.205" class="difflineminus">-            rawData = fileHandler.getURLSpecFromFile(rawData);</span>
<a href="#l7.206"></a><span id="l7.206" class="difflineplus">+            data = Services.io</span>
<a href="#l7.207"></a><span id="l7.207" class="difflineplus">+              .getProtocolHandler(&quot;file&quot;)</span>
<a href="#l7.208"></a><span id="l7.208" class="difflineplus">+              .QueryInterface(Ci.nsIFileProtocolHandler)</span>
<a href="#l7.209"></a><span id="l7.209" class="difflineplus">+              .getURLSpecFromFile(data);</span>
<a href="#l7.210"></a><span id="l7.210">             isValidAttachment = true;</span>
<a href="#l7.211"></a><span id="l7.211">           } catch (e) {</span>
<a href="#l7.212"></a><span id="l7.212">             Cu.reportError(</span>
<a href="#l7.213"></a><span id="l7.213" class="difflineminus">-              &quot;Couldn't process the dragged file &quot; + rawData.leafName + &quot;:&quot; + e</span>
<a href="#l7.214"></a><span id="l7.214" class="difflineplus">+              &quot;Couldn't process the dragged file &quot; + data.leafName + &quot;:&quot; + e</span>
<a href="#l7.215"></a><span id="l7.215">             );</span>
<a href="#l7.216"></a><span id="l7.216">           }</span>
<a href="#l7.217"></a><span id="l7.217">           break;</span>
<a href="#l7.218"></a><span id="l7.218">         }</span>
<a href="#l7.219"></a><span id="l7.219"> </span>
<a href="#l7.220"></a><span id="l7.220">         case &quot;text/x-moz-message&quot;: {</span>
<a href="#l7.221"></a><span id="l7.221">           isValidAttachment = true;</span>
<a href="#l7.222"></a><span id="l7.222">           let msgHdr = gMessenger</span>
<a href="#l7.223"></a><span id="l7.223" class="difflineminus">-            .messageServiceFromURI(rawData)</span>
<a href="#l7.224"></a><span id="l7.224" class="difflineminus">-            .messageURIToMsgHdr(rawData);</span>
<a href="#l7.225"></a><span id="l7.225" class="difflineplus">+            .messageServiceFromURI(data)</span>
<a href="#l7.226"></a><span id="l7.226" class="difflineplus">+            .messageURIToMsgHdr(data);</span>
<a href="#l7.227"></a><span id="l7.227">           prettyName = msgHdr.mime2DecodedSubject + &quot;.eml&quot;;</span>
<a href="#l7.228"></a><span id="l7.228">           size = msgHdr.messageSize;</span>
<a href="#l7.229"></a><span id="l7.229">           break;</span>
<a href="#l7.230"></a><span id="l7.230">         }</span>
<a href="#l7.231"></a><span id="l7.231"> </span>
<a href="#l7.232"></a><span id="l7.232">         case &quot;text/x-moz-url&quot;: {</span>
<a href="#l7.233"></a><span id="l7.233" class="difflineminus">-          let pieces = rawData.split(&quot;\n&quot;);</span>
<a href="#l7.234"></a><span id="l7.234" class="difflineminus">-          rawData = pieces[0];</span>
<a href="#l7.235"></a><span id="l7.235" class="difflineplus">+          let pieces = data.split(&quot;\n&quot;);</span>
<a href="#l7.236"></a><span id="l7.236" class="difflineplus">+          data = pieces[0];</span>
<a href="#l7.237"></a><span id="l7.237">           if (pieces.length &gt; 1) {</span>
<a href="#l7.238"></a><span id="l7.238">             prettyName = pieces[1];</span>
<a href="#l7.239"></a><span id="l7.239">           }</span>
<a href="#l7.240"></a><span id="l7.240">           if (pieces.length &gt; 2) {</span>
<a href="#l7.241"></a><span id="l7.241">             size = parseInt(pieces[2]);</span>
<a href="#l7.242"></a><span id="l7.242">           }</span>
<a href="#l7.243"></a><span id="l7.243"> </span>
<a href="#l7.244"></a><span id="l7.244">           // If this is a URL (or selected text), check if it's a valid URL</span>
<a href="#l7.245"></a><span id="l7.245">           // by checking if we can extract a scheme using Services.io.</span>
<a href="#l7.246"></a><span id="l7.246">           // Don't attach invalid or mailto: URLs.</span>
<a href="#l7.247"></a><span id="l7.247">           try {</span>
<a href="#l7.248"></a><span id="l7.248" class="difflineminus">-            let scheme = Services.io.extractScheme(rawData);</span>
<a href="#l7.249"></a><span id="l7.249" class="difflineplus">+            let scheme = Services.io.extractScheme(data);</span>
<a href="#l7.250"></a><span id="l7.250">             if (scheme != &quot;mailto&quot;) {</span>
<a href="#l7.251"></a><span id="l7.251">               isValidAttachment = true;</span>
<a href="#l7.252"></a><span id="l7.252">             }</span>
<a href="#l7.253"></a><span id="l7.253">           } catch (ex) {}</span>
<a href="#l7.254"></a><span id="l7.254">           break;</span>
<a href="#l7.255"></a><span id="l7.255">         }</span>
<a href="#l7.256"></a><span id="l7.256"> </span>
<a href="#l7.257"></a><span id="l7.257">         // Process address: Drop it into recipient field.</span>
<a href="#l7.258"></a><span id="l7.258">         case &quot;text/x-moz-address&quot;: {</span>
<a href="#l7.259"></a><span id="l7.259" class="difflineminus">-          if (rawData) {</span>
<a href="#l7.260"></a><span id="l7.260" class="difflineminus">-            DropRecipient(aEvent.target, rawData);</span>
<a href="#l7.261"></a><span id="l7.261" class="difflineminus">-</span>
<a href="#l7.262"></a><span id="l7.262" class="difflineminus">-            // Since we are now using ondrop (eDrop) instead of previously using</span>
<a href="#l7.263"></a><span id="l7.263" class="difflineminus">-            // ondragdrop (eLegacyDragDrop), we must prevent the default</span>
<a href="#l7.264"></a><span id="l7.264" class="difflineminus">-            // which is dropping the address text into the widget.</span>
<a href="#l7.265"></a><span id="l7.265" class="difflineminus">-            // Note that stopPropagation() is called by our caller in</span>
<a href="#l7.266"></a><span id="l7.266" class="difflineminus">-            // nsDragAndDrop.js.</span>
<a href="#l7.267"></a><span id="l7.267" class="difflineminus">-            aEvent.preventDefault();</span>
<a href="#l7.268"></a><span id="l7.268" class="difflineminus">-          }</span>
<a href="#l7.269"></a><span id="l7.269" class="difflineplus">+          DropRecipient(event.target, data);</span>
<a href="#l7.270"></a><span id="l7.270" class="difflineplus">+</span>
<a href="#l7.271"></a><span id="l7.271" class="difflineplus">+          // Since we are now using ondrop (eDrop) instead of previously using</span>
<a href="#l7.272"></a><span id="l7.272" class="difflineplus">+          // ondragdrop (eLegacyDragDrop), we must prevent the default</span>
<a href="#l7.273"></a><span id="l7.273" class="difflineplus">+          // which is dropping the address text into the widget.</span>
<a href="#l7.274"></a><span id="l7.274" class="difflineplus">+          event.preventDefault();</span>
<a href="#l7.275"></a><span id="l7.275">           break;</span>
<a href="#l7.276"></a><span id="l7.276">         }</span>
<a href="#l7.277"></a><span id="l7.277">       }</span>
<a href="#l7.278"></a><span id="l7.278"> </span>
<a href="#l7.279"></a><span id="l7.279">       // Create the attachment and add it to attachments array.</span>
<a href="#l7.280"></a><span id="l7.280">       if (isValidAttachment) {</span>
<a href="#l7.281"></a><span id="l7.281">         let attachment = Cc[</span>
<a href="#l7.282"></a><span id="l7.282">           &quot;@mozilla.org/messengercompose/attachment;1&quot;</span>
<a href="#l7.283"></a><span id="l7.283">         ].createInstance(Ci.nsIMsgAttachment);</span>
<a href="#l7.284"></a><span id="l7.284" class="difflineminus">-        attachment.url = rawData;</span>
<a href="#l7.285"></a><span id="l7.285" class="difflineplus">+        attachment.url = data;</span>
<a href="#l7.286"></a><span id="l7.286">         attachment.name = prettyName;</span>
<a href="#l7.287"></a><span id="l7.287"> </span>
<a href="#l7.288"></a><span id="l7.288">         if (size !== undefined) {</span>
<a href="#l7.289"></a><span id="l7.289">           attachment.size = size;</span>
<a href="#l7.290"></a><span id="l7.290">         }</span>
<a href="#l7.291"></a><span id="l7.291"> </span>
<a href="#l7.292"></a><span id="l7.292">         attachments.push(attachment);</span>
<a href="#l7.293"></a><span id="l7.293">       }</span>
<a href="#l7.294"></a><span id="l7.294">     }</span>
<a href="#l7.295"></a><span id="l7.295"> </span>
<a href="#l7.296"></a><span id="l7.296">     // Add attachments if any.</span>
<a href="#l7.297"></a><span id="l7.297">     if (attachments.length &gt; 0) {</span>
<a href="#l7.298"></a><span id="l7.298">       AddAttachments(attachments);</span>
<a href="#l7.299"></a><span id="l7.299">     }</span>
<a href="#l7.300"></a><span id="l7.300"> </span>
<a href="#l7.301"></a><span id="l7.301">     bucket.focus();</span>
<a href="#l7.302"></a><span id="l7.302" class="difflineplus">+    event.stopPropagation();</span>
<a href="#l7.303"></a><span id="l7.303">   },</span>
<a href="#l7.304"></a><span id="l7.304"> </span>
<a href="#l7.305"></a><span id="l7.305" class="difflineminus">-  onDragOver(aEvent, aFlavour, aDragSession) {</span>
<a href="#l7.306"></a><span id="l7.306" class="difflineplus">+  onDragOver(event) {</span>
<a href="#l7.307"></a><span id="l7.307" class="difflineplus">+    let dragSession = Cc[&quot;@mozilla.org/widget/dragservice;1&quot;]</span>
<a href="#l7.308"></a><span id="l7.308" class="difflineplus">+      .getService(Ci.nsIDragService)</span>
<a href="#l7.309"></a><span id="l7.309" class="difflineplus">+      .getCurrentSession();</span>
<a href="#l7.310"></a><span id="l7.310">     let bucket = document.getElementById(&quot;attachmentBucket&quot;);</span>
<a href="#l7.311"></a><span id="l7.311" class="difflineminus">-    let dragSourceNode = aDragSession.sourceNode;</span>
<a href="#l7.312"></a><span id="l7.312" class="difflineplus">+    let dragSourceNode = dragSession.sourceNode;</span>
<a href="#l7.313"></a><span id="l7.313">     if (dragSourceNode &amp;&amp; dragSourceNode.parentNode == bucket) {</span>
<a href="#l7.314"></a><span id="l7.314">       // If we're dragging from the attachment bucket onto itself, we need to</span>
<a href="#l7.315"></a><span id="l7.315">       // show a drop marker.</span>
<a href="#l7.316"></a><span id="l7.316"> </span>
<a href="#l7.317"></a><span id="l7.317" class="difflineminus">-      let target = this._adjustDropTarget(aEvent);</span>
<a href="#l7.318"></a><span id="l7.318" class="difflineplus">+      let target = this._adjustDropTarget(event);</span>
<a href="#l7.319"></a><span id="l7.319"> </span>
<a href="#l7.320"></a><span id="l7.320">       if (</span>
<a href="#l7.321"></a><span id="l7.321">         (target.matches &amp;&amp; target.matches(&quot;richlistitem.attachmentItem&quot;)) ||</span>
<a href="#l7.322"></a><span id="l7.322">         target == &quot;afterLastItem&quot;</span>
<a href="#l7.323"></a><span id="l7.323">       ) {</span>
<a href="#l7.324"></a><span id="l7.324">         // Adjusted target is an attachment list item; show dropmarker.</span>
<a href="#l7.325"></a><span id="l7.325">         this._showDropMarker(target);</span>
<a href="#l7.326"></a><span id="l7.326">       } else {</span>
<a href="#l7.327"></a><span id="l7.327">         // target == &quot;none&quot;, target is not a listItem, or no target:</span>
<a href="#l7.328"></a><span id="l7.328">         // Indicate that we can't drop here.</span>
<a href="#l7.329"></a><span id="l7.329">         this._hideDropMarker();</span>
<a href="#l7.330"></a><span id="l7.330" class="difflineminus">-        aEvent.dataTransfer.dropEffect = &quot;none&quot;;</span>
<a href="#l7.331"></a><span id="l7.331" class="difflineplus">+        event.dataTransfer.dropEffect = &quot;none&quot;;</span>
<a href="#l7.332"></a><span id="l7.332">       }</span>
<a href="#l7.333"></a><span id="l7.333">       return;</span>
<a href="#l7.334"></a><span id="l7.334">     }</span>
<a href="#l7.335"></a><span id="l7.335"> </span>
<a href="#l7.336"></a><span id="l7.336" class="difflineminus">-    if (aFlavour.contentType != &quot;text/x-moz-address&quot;) {</span>
<a href="#l7.337"></a><span id="l7.337" class="difflineminus">-      // Make sure the attachment pane is visible during drag over.</span>
<a href="#l7.338"></a><span id="l7.338" class="difflineminus">-      toggleAttachmentPane(&quot;show&quot;);</span>
<a href="#l7.339"></a><span id="l7.339" class="difflineminus">-    } else {</span>
<a href="#l7.340"></a><span id="l7.340" class="difflineminus">-      DragAddressOverTargetControl(aEvent);</span>
<a href="#l7.341"></a><span id="l7.341" class="difflineplus">+    for (let flavour of flavours) {</span>
<a href="#l7.342"></a><span id="l7.342" class="difflineplus">+      if (dragSession.isDataFlavorSupported(flavour)) {</span>
<a href="#l7.343"></a><span id="l7.343" class="difflineplus">+        if (flavour != &quot;text/x-moz-address&quot;) {</span>
<a href="#l7.344"></a><span id="l7.344" class="difflineplus">+          // Make sure the attachment pane is visible during drag over.</span>
<a href="#l7.345"></a><span id="l7.345" class="difflineplus">+          toggleAttachmentPane(&quot;show&quot;);</span>
<a href="#l7.346"></a><span id="l7.346" class="difflineplus">+        } else {</span>
<a href="#l7.347"></a><span id="l7.347" class="difflineplus">+          DragAddressOverTargetControl(event);</span>
<a href="#l7.348"></a><span id="l7.348" class="difflineplus">+        }</span>
<a href="#l7.349"></a><span id="l7.349" class="difflineplus">+        event.stopPropagation();</span>
<a href="#l7.350"></a><span id="l7.350" class="difflineplus">+        event.preventDefault();</span>
<a href="#l7.351"></a><span id="l7.351" class="difflineplus">+        break;</span>
<a href="#l7.352"></a><span id="l7.352" class="difflineplus">+      }</span>
<a href="#l7.353"></a><span id="l7.353">     }</span>
<a href="#l7.354"></a><span id="l7.354">   },</span>
<a href="#l7.355"></a><span id="l7.355"> </span>
<a href="#l7.356"></a><span id="l7.356" class="difflineminus">-  onDragExit(aEvent, aDragSession) {</span>
<a href="#l7.357"></a><span id="l7.357" class="difflineplus">+  onDragExit(event) {</span>
<a href="#l7.358"></a><span id="l7.358">     this._hideDropMarker();</span>
<a href="#l7.359"></a><span id="l7.359">   },</span>
<a href="#l7.360"></a><span id="l7.360" class="difflineminus">-</span>
<a href="#l7.361"></a><span id="l7.361" class="difflineminus">-  getSupportedFlavours() {</span>
<a href="#l7.362"></a><span id="l7.362" class="difflineminus">-    let flavourSet = new FlavourSet();</span>
<a href="#l7.363"></a><span id="l7.363" class="difflineminus">-    // Prefer &quot;text/x-moz-address&quot;, so when an address from the address book</span>
<a href="#l7.364"></a><span id="l7.364" class="difflineminus">-    // is dragged, this flavour is tested first. Otherwise the attachment</span>
<a href="#l7.365"></a><span id="l7.365" class="difflineminus">-    // bucket would open since the addresses also carry the</span>
<a href="#l7.366"></a><span id="l7.366" class="difflineminus">-    // &quot;application/x-moz-file&quot; flavour.</span>
<a href="#l7.367"></a><span id="l7.367" class="difflineminus">-    flavourSet.appendFlavour(&quot;text/x-moz-address&quot;);</span>
<a href="#l7.368"></a><span id="l7.368" class="difflineminus">-    flavourSet.appendFlavour(&quot;text/x-moz-message&quot;);</span>
<a href="#l7.369"></a><span id="l7.369" class="difflineminus">-    flavourSet.appendFlavour(&quot;application/x-moz-file&quot;, &quot;nsIFile&quot;);</span>
<a href="#l7.370"></a><span id="l7.370" class="difflineminus">-    flavourSet.appendFlavour(&quot;text/x-moz-url&quot;);</span>
<a href="#l7.371"></a><span id="l7.371" class="difflineminus">-    return flavourSet;</span>
<a href="#l7.372"></a><span id="l7.372" class="difflineminus">-  },</span>
<a href="#l7.373"></a><span id="l7.373"> };</span>
<a href="#l7.374"></a><span id="l7.374"> </span>
<a href="#l7.375"></a><span id="l7.375" class="difflineminus">-var attachmentBucketDNDObserver = {</span>
<a href="#l7.376"></a><span id="l7.376" class="difflineminus">-  onDragStart(aEvent, aAttachmentData, aDragAction) {</span>
<a href="#l7.377"></a><span id="l7.377" class="difflineminus">-    var target = aEvent.target;</span>
<a href="#l7.378"></a><span id="l7.378" class="difflineminus">-</span>
<a href="#l7.379"></a><span id="l7.379" class="difflineplus">+let attachmentBucketDNDObserver = {</span>
<a href="#l7.380"></a><span id="l7.380" class="difflineplus">+  onDragStart(event) {</span>
<a href="#l7.381"></a><span id="l7.381" class="difflineplus">+    let target = event.target;</span>
<a href="#l7.382"></a><span id="l7.382">     if (target.matches(&quot;richlistitem.attachmentItem&quot;)) {</span>
<a href="#l7.383"></a><span id="l7.383" class="difflineminus">-      aAttachmentData.data = CreateAttachmentTransferData(target.attachment);</span>
<a href="#l7.384"></a><span id="l7.384" class="difflineminus">-    }</span>
<a href="#l7.385"></a><span id="l7.385" class="difflineplus">+      setupDataTransfer(event, [target.attachment]);</span>
<a href="#l7.386"></a><span id="l7.386" class="difflineplus">+    }</span>
<a href="#l7.387"></a><span id="l7.387" class="difflineplus">+    event.stopPropagation();</span>
<a href="#l7.388"></a><span id="l7.388">   },</span>
<a href="#l7.389"></a><span id="l7.389"> };</span>
<a href="#l7.390"></a><span id="l7.390"> </span>
<a href="#l7.391"></a><span id="l7.391"> function DisplaySaveFolderDlg(folderURI) {</span>
<a href="#l7.392"></a><span id="l7.392">   try {</span>
<a href="#l7.393"></a><span id="l7.393">     var showDialog = gCurrentIdentity.showSaveMsgDlg;</span>
<a href="#l7.394"></a><span id="l7.394">   } catch (e) {</span>
<a href="#l7.395"></a><span id="l7.395">     return;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mail/components/compose/content/messengercompose.xhtml</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mail/components/compose/content/messengercompose.xhtml</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -75,17 +75,16 @@</span>
<a href="#l8.4"></a><span id="l8.4"> &lt;script src=&quot;chrome://messenger/content/messengercompose/MsgComposeCommands.js&quot;/&gt;</span>
<a href="#l8.5"></a><span id="l8.5"> &lt;script src=&quot;chrome://messenger/content/messengercompose/bigFileObserver.js&quot;/&gt;</span>
<a href="#l8.6"></a><span id="l8.6"> &lt;script src=&quot;chrome://messenger/content/messengercompose/cloudAttachmentLinkManager.js&quot;/&gt;</span>
<a href="#l8.7"></a><span id="l8.7"> &lt;script src=&quot;chrome://messenger/content/messenger-customization.js&quot;/&gt;</span>
<a href="#l8.8"></a><span id="l8.8"> &lt;script src=&quot;chrome://messenger/content/customizable-toolbar.js&quot;/&gt;</span>
<a href="#l8.9"></a><span id="l8.9"> </span>
<a href="#l8.10"></a><span id="l8.10"> &lt;!-- drag and drop --&gt;</span>
<a href="#l8.11"></a><span id="l8.11"> &lt;script src=&quot;chrome://messenger/content/addressbook/abDragDrop.js&quot;/&gt;</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-&lt;script src=&quot;chrome://global/content/nsDragAndDrop.js&quot;/&gt;</span>
<a href="#l8.13"></a><span id="l8.13"> </span>
<a href="#l8.14"></a><span id="l8.14"> &lt;!-- move needed functions into a single js file --&gt;</span>
<a href="#l8.15"></a><span id="l8.15"> &lt;script src=&quot;chrome://messenger/content/messengercompose/addressingWidgetOverlay.js&quot;/&gt;</span>
<a href="#l8.16"></a><span id="l8.16"> &lt;script src=&quot;chrome://global/content/contentAreaUtils.js&quot;/&gt;</span>
<a href="#l8.17"></a><span id="l8.17"> &lt;script src=&quot;chrome://messenger/content/viewZoomOverlay.js&quot;/&gt;</span>
<a href="#l8.18"></a><span id="l8.18"> #ifdef XP_MACOSX</span>
<a href="#l8.19"></a><span id="l8.19"> &lt;script src=&quot;chrome://global/content/macWindowMenu.js&quot;/&gt;</span>
<a href="#l8.20"></a><span id="l8.20"> #endif</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineat">@@ -1801,19 +1800,19 @@</span>
<a href="#l8.22"></a><span id="l8.22">                oncommand=&quot;toggleAddressPicker();&quot;/&gt;</span>
<a href="#l8.23"></a><span id="l8.23"> </span>
<a href="#l8.24"></a><span id="l8.24">     &lt;toolbarbutton is=&quot;toolbarbutton-menu-button&quot; id=&quot;button-attach&quot;</span>
<a href="#l8.25"></a><span id="l8.25">                    type=&quot;menu-button&quot;</span>
<a href="#l8.26"></a><span id="l8.26">                    class=&quot;toolbarbutton-1&quot;</span>
<a href="#l8.27"></a><span id="l8.27">                    label=&quot;&amp;attachButton.label;&quot;</span>
<a href="#l8.28"></a><span id="l8.28">                    tooltiptext=&quot;&amp;attachButton.tooltip2;&quot;</span>
<a href="#l8.29"></a><span id="l8.29">                    command=&quot;cmd_attachFile&quot;</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineminus">-                   ondragover=&quot;nsDragAndDrop.dragOver(event, envelopeDragObserver);&quot;</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-                   ondrop=&quot;nsDragAndDrop.drop(event, envelopeDragObserver);&quot;</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineminus">-                   ondragexit=&quot;nsDragAndDrop.dragExit(event, envelopeDragObserver);&quot;&gt;</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineplus">+                   ondragover=&quot;envelopeDragObserver.onDragOver(event);&quot;</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+                   ondrop=&quot;envelopeDragObserver.onDrop(event);&quot;</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineplus">+                   ondragexit=&quot;envelopeDragObserver.onDragExit(event);&quot;&gt;</span>
<a href="#l8.36"></a><span id="l8.36">       &lt;menupopup id=&quot;button-attachPopup&quot; onpopupshowing=&quot;updateAttachmentItems();&quot;&gt;</span>
<a href="#l8.37"></a><span id="l8.37">         &lt;menuitem id=&quot;button-attachPopup_attachFileItem&quot;</span>
<a href="#l8.38"></a><span id="l8.38">                   label=&quot;&amp;attachFileCmd.label;&quot;</span>
<a href="#l8.39"></a><span id="l8.39">                   accesskey=&quot;&amp;attachFileCmd.accesskey;&quot;</span>
<a href="#l8.40"></a><span id="l8.40">                   command=&quot;cmd_attachFile&quot;/&gt;</span>
<a href="#l8.41"></a><span id="l8.41">         &lt;menu id=&quot;button-attachPopup_attachCloudMenu&quot;</span>
<a href="#l8.42"></a><span id="l8.42">               label=&quot;&amp;attachCloudCmd.label;&quot;</span>
<a href="#l8.43"></a><span id="l8.43">               accesskey=&quot;&amp;attachCloudCmd.accesskey;&quot;</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineat">@@ -2005,19 +2004,19 @@</span>
<a href="#l8.45"></a><span id="l8.45">     &lt;splitter id=&quot;sidebar-splitter&quot; hidden=&quot;true&quot;/&gt;</span>
<a href="#l8.46"></a><span id="l8.46"> </span>
<a href="#l8.47"></a><span id="l8.47">     &lt;vbox id=&quot;headers-parent&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l8.48"></a><span id="l8.48">     &lt;toolbox id=&quot;headers-box&quot; class=&quot;toolbox-top&quot; mode=&quot;icons&quot;&gt;</span>
<a href="#l8.49"></a><span id="l8.49">     &lt;toolbar is=&quot;customizable-toolbar&quot; id=&quot;MsgHeadersToolbar&quot;</span>
<a href="#l8.50"></a><span id="l8.50">              persist=&quot;collapsed&quot;</span>
<a href="#l8.51"></a><span id="l8.51">              flex=&quot;1&quot;</span>
<a href="#l8.52"></a><span id="l8.52">              customizable=&quot;true&quot; nowindowdrag=&quot;true&quot;</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineminus">-             ondragover=&quot;nsDragAndDrop.dragOver(event, envelopeDragObserver);&quot;</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineminus">-             ondrop=&quot;nsDragAndDrop.drop(event, envelopeDragObserver);&quot;</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineminus">-             ondragexit=&quot;nsDragAndDrop.dragExit(event, envelopeDragObserver);&quot;&gt;</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineplus">+             ondragover=&quot;envelopeDragObserver.onDragOver(event);&quot;</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineplus">+             ondrop=&quot;envelopeDragObserver.onDrop(event);&quot;</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineplus">+             ondragexit=&quot;envelopeDragObserver.onDragExit(event);&quot;&gt;</span>
<a href="#l8.59"></a><span id="l8.59">       &lt;hbox id=&quot;msgheaderstoolbar-box&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l8.60"></a><span id="l8.60">         &lt;vbox flex=&quot;1&quot; id=&quot;addresses-box&quot;&gt;</span>
<a href="#l8.61"></a><span id="l8.61">           &lt;hbox id=&quot;top-gradient-box&quot; class=&quot;address-identity-recipient&quot;&gt;</span>
<a href="#l8.62"></a><span id="l8.62">             &lt;hbox class=&quot;aw-firstColBox&quot;/&gt;</span>
<a href="#l8.63"></a><span id="l8.63">             &lt;hbox id=&quot;identityLabel-box&quot; align=&quot;center&quot;</span>
<a href="#l8.64"></a><span id="l8.64">                   pack=&quot;end&quot; style=&quot;&amp;headersSpace2.style;&quot;&gt;</span>
<a href="#l8.65"></a><span id="l8.65">               &lt;label id=&quot;identityLabel&quot; value=&quot;&amp;fromAddr2.label;&quot;</span>
<a href="#l8.66"></a><span id="l8.66">                      accesskey=&quot;&amp;fromAddr.accesskey;&quot; control=&quot;msgIdentity&quot;/&gt;</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineat">@@ -2345,17 +2344,17 @@</span>
<a href="#l8.68"></a><span id="l8.68">                        flex=&quot;1&quot;</span>
<a href="#l8.69"></a><span id="l8.69">                        height=&quot;0&quot;</span>
<a href="#l8.70"></a><span id="l8.70">                        role=&quot;listbox&quot;</span>
<a href="#l8.71"></a><span id="l8.71">                        context=&quot;msgComposeAttachmentListContext&quot;</span>
<a href="#l8.72"></a><span id="l8.72">                        itemcontext=&quot;msgComposeAttachmentItemContext&quot;</span>
<a href="#l8.73"></a><span id="l8.73">                        onclick=&quot;attachmentBucketOnClick(event);&quot;</span>
<a href="#l8.74"></a><span id="l8.74">                        onkeypress=&quot;attachmentBucketOnKeyPress(event);&quot;</span>
<a href="#l8.75"></a><span id="l8.75">                        onselect=&quot;attachmentBucketOnSelect();&quot;</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineminus">-                       ondragstart=&quot;attachmentBucketOnDragStart(event);&quot;</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineplus">+                       ondragstart=&quot;attachmentBucketDNDObserver.onDragStart(event);&quot;</span>
<a href="#l8.78"></a><span id="l8.78">                        onblur=&quot;attachmentBucketOnBlur();&quot;/&gt;</span>
<a href="#l8.79"></a><span id="l8.79">         &lt;/vbox&gt;</span>
<a href="#l8.80"></a><span id="l8.80">         &lt;vbox id=&quot;attachments-placeholder-box&quot;</span>
<a href="#l8.81"></a><span id="l8.81">               hidden=&quot;true&quot;</span>
<a href="#l8.82"></a><span id="l8.82">               tooltiptext=&quot;&quot;</span>
<a href="#l8.83"></a><span id="l8.83">               onclick=&quot;goDoCommand('cmd_toggleAttachmentPane')&quot;/&gt;</span>
<a href="#l8.84"></a><span id="l8.84">       &lt;/hbox&gt;</span>
<a href="#l8.85"></a><span id="l8.85">     &lt;/toolbar&gt;</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:32Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

